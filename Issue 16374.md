# Issue 16374: Upgrade R to version 3.1

Issue created by migration from https://trac.sagemath.org/ticket/16611

Original creator: charpent

Original creation time: 2014-07-03 17:24:18

Keywords: r-project

As said before, R users need to use an up-to-date version of R if they want to be able to get support from R-help. Furthermore, some packages are no longer usable under R<3.1. Hence this request.

Link to the upstream source : [http://cran.r-project.org/src/base/R-3/R-3.1.0.tar.gz](http://cran.r-project.org/src/base/R-3/R-3.1.0.tar.gz)


---

Comment by charpent created at 2014-07-03 18:28:40

This first branch passes make and make ptestlong with "all tests passed".

Note : This has been done on Debian amd64. Since this package has arm, OS/X and cygwin specific parts, it should be checked on these three platform.


---

Comment by charpent created at 2014-07-03 18:30:24

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2014-07-03 19:16:07

Hi,

I have an error as the tarball is `R-3.1.0.tar.gz` and Sage is looking for `r-3.1.0.tar.gz`. As Unix is case sensitive I do not see how you can get it working on Debian!? Renaming the upstream tarball as `r-3.1.0.tar.gz` works fine for me.

You introduced trailing whitespaces in the file `src/sage/interfaces/r.py`. Please remove them.

Vincent


---

Comment by vdelecroix created at 2014-07-03 19:16:07

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2014-07-03 20:05:28

Not sure why the changes in the doctests.  Shouldn't that command still work, perhaps with a minor tweak?  Not that it really matters so much, but I hope it isn't a symptom of something else.


---

Comment by git created at 2014-07-03 20:10:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-03 20:16:50

Replying to [comment:5 kcrisman]:
> Not sure why the changes in the doctests.  Shouldn't that command still work, perhaps with a minor tweak?  Not that it really matters so much, but I hope it isn't a symptom of something else.

The examples used the R function "print.anova", which is no longer available, at least for this example. It's a symptom of changes in R.

BTW : patches suggested by V. Delecroix ==> needs_review.


---

Comment by charpent created at 2014-07-03 20:16:50

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-07-06 00:14:07

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2014-07-06 00:14:07

Patches look good. I guess the source tarball is incorrect (capital-R). Please fix.


---

Comment by git created at 2014-07-06 09:38:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-06 09:43:09

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2014-07-06 09:43:09

This should do.

Upstream tarball is indeed capital-R... I monkeyed my way in other spkg-src files to create something that *should* do the right thing, but was unable to find a specification of what spkg-src should do and not do, ans where in the tree it should work...

Status ==> needs_review.


---

Comment by vbraun created at 2014-07-06 17:54:41

The spkg-src file doesn't have any strict rules. Let me ask again, is it ok to have the tarball filename with a capital R? The tarball in the description has a capital R. If thats wrong then you need to provide a tarball with the correct name.


---

Comment by vbraun created at 2014-07-06 17:54:46

Changing status from needs_review to needs_info.


---

Comment by charpent created at 2014-07-06 18:22:57

As far as I know, the name of the tarball  has no relevance as far as R compilation/setting up is concerned. in other words, R compilation takes place in a tree, whose name in the file system is irrelevant.

My incertitude has been with *Sage's* conventions : the tarballs present in $SAGE_ROOT are mostly .bz2, and it seems that their name *must* be lowercase-only. At least, that's what implies [http://www.sagemath.org/doc/developer/packaging.html](http://www.sagemath.org/doc/developer/packaging.html). The submitted spkg-src implements what reading other spkg-src files in the current Sage distribution : if necessary, download the upstream tarball, repackage t as .tar.bz2 and name the resultant tarball in lowercase-only.

Is that clearer ?


---

Comment by charpent created at 2014-07-06 18:22:57

Changing status from needs_info to needs_review.


---

Comment by vbraun created at 2014-07-07 00:18:36

There is no `spkg-src` in the branch. Its a way of documenting the steps to create a new tarball, and is never run automatically.

In any case, that shouldn't be needed here. Source tarballs can be `.tar.gz` and `.tar.bz2`. Bzip2 is better compressed but its better to stay with upstream if upstream only offers a `.tar.gz`. Of course if they have any other scheme then it needs repacking.


---

Comment by vbraun created at 2014-07-07 00:22:49

The tarball must match whats in `checksums.ini` including case and bz2 vs gz extension. Current branch doesn't work.


---

Comment by vbraun created at 2014-07-07 00:22:49

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2014-07-07 00:24:48

I.e. if you put the R tarball into your upstream/ folder and run `sage -f r` then it needs to work. On a case-sensitive filesystem.


---

Comment by git created at 2014-07-07 04:32:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-07 04:36:58

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2014-07-07 04:36:58

- re-switched to .tar.gz tarball
- re-modified spkg-src (and addad it to git (ahem...))
- re-checked that ./sage -f r in $SAGE_ROOT works.


---

Comment by vbraun created at 2014-07-07 04:43:53

Are you on OSX? Not case sensitive files system?

The tarball case still does not match the checksums.ini case. Does not work.


---

Comment by charpent created at 2014-07-07 05:07:21

Replying to [comment:20 vbraun]:
> Are you on OSX? Not case sensitive files system?

I'm on Debian (testing), on an ext4 filesystem.

> The tarball case still does not match the checksums.ini case. Does not work.

I do not understand what sage-fix-spkg-checksums does : look at what I get :

charpent`@`asus16-ec:/usr/local/sage-6.3.beta5$ cat build/pkgs/r/checksums.ini 
tarball=r-VERSION.tar.gz
sha1=a9d13932c739cc12667c6a17fabd9361624a1708
md5=a1ee52446bee81820409661e6d114ab1
cksum=3701745191

The "tarball" name looks suspicious. Where did I goof ?

*Edit :* BTW, when I re-run ./sage -sh sage-fix-spkg-checksums, I get the same result, and git does not see it as modified.


---

Comment by vbraun created at 2014-07-07 05:13:48

sage-fix-spkg-checksum rewrites the checksum only, the tarball name is human input.

Either lower-case the tarball (as with the current version) or change checksum.ini (not sure if the latter works, but should).

Delete all wrong-case r-3.1.0 tarballs (except the one you really want) from upstream/ before testing..


---

Comment by charpent created at 2014-07-07 05:36:18

Replying to [comment:22 vbraun]:
> sage-fix-spkg-checksum rewrites the checksum only, the tarball name is human input.
> 
> Either lower-case the tarball (as with the current version) or change checksum.ini (not sure if the latter works, but should).

I hand-edited it, the re-updated checksums : forced reinstallation is under way (seems to work).

> Delete all wrong-case r-3.1.0 tarballs (except the one you really want) from upstream/ before testing..

I have none.

A commit should follow soon (a couple of minutes...).

*EDIT* : re-generating the checksum *wiped out my manual edit*. I'll re-edit and re-force installation (without re-generating checksum...)


---

Comment by git created at 2014-07-07 05:52:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2014-07-07 06:01:45

It seems that, at least for *this* package, sage-fix-pkg-checksums creates the wrong "tarball=" line in checksum.ini

The 0f89d3e... commit has a hand-edited checksum.ini.

Should we open a ticket against sage-fix-pkg-checksums ?


---

Comment by vbraun created at 2014-07-07 12:16:05

IMHO the easiest solution is to lower-case the tarball. Which would then also match the name of the package. There are various annoyances with how we handle tarball names.


---

Comment by charpent created at 2014-07-07 18:06:50

Replying to [comment:26 vbraun]:
> IMHO the easiest solution is to lower-case the tarball. Which would then also match the name of the package. There are various annoyances with how we handle tarball names.

I agree. And that's the current situation of the latest branch.

Nevertheless, I'd like to understand why sage-fix-pkg-checksum (mis)behaves as it does. I'll have a look (but nor very soon, I'm afraid).

*EDIT* : sage-fix-pkg-checksum *HAS* a nice bug.
I tried :

charpent`@`asus16-ec:/usr/local/sage-6.3.beta5$ for i in $(find build/pkgs/ -name checksums.ini) ; do grep tarball $i ; done

and got (modulo newlines) :

tarball=zlib-VERSION.tar.bz2
tarball=zeromq-VERSION.tar.gz
tarball=libpng-VERSION.tar.gz
tarball=database_stein_watkins-VERSION.tar.bz2
tarball=pexpect-VERSION.tar.bz2
tarball=gf2x-VERSION.tar.bz2
tarball=gd-VERSION.tar.bz2
tarball=mpmath-VERSION.tar.gz
tarball=gap_packages-VERSION.tar.bz2
tarball=git_trac-VERSION.tar.bz2
tarball=pyparsing-VERSION.tar.gz
tarball=libm4ri-VERSION.tar.bz2
tarball=flint-VERSION.tar.gz
tarball=sage_mode-VERSION.tar.bz2
tarball=topcom-VERSION.tar.bz2
tarball=eclib-VERSION.tar.bz2
tarball=libm4rie-VERSION.tar.bz2
tarball=libfplll-VERSION.tar.bz2
tarball=Cython-VERSION.tar.gz
tarball=cvxopt-VERSION.tar.bz2
tarball=cryptominisat-VERSION.tar.gz
tarball=dot2tex-VERSION.tar.bz2
tarball=mercurial-VERSION.tar.bz2
tarball=cddlib-VERSION.tar.bz2
tarball=sagetex-VERSION.tar.bz2
tarball=polybori-VERSION.tar.bz2
tarball=elliptic_curves-VERSION.tar.bz2
tarball=gsl-VERSION.tar.bz2
tarball=ratpoints-VERSION.tar.bz2
tarball=pkgconfig-VERSION.tar.gz
tarball=gap-VERSION.tar.bz2
tarball=database_stein_watkins_mini-VERSION.tar.bz2
tarball=libgap-VERSION.tar.gz
tarball=atlas-VERSION.tar.bz2
tarball=symmetrica-VERSION.tar.bz2
tarball=networkx-VERSION.tar.gz
tarball=numpy-VERSION.tar.gz
tarball=ppl-VERSION.tar.bz2
tarball=Pillow-VERSION.tar.gz
tarball=sympow-VERSION.tar.bz2
tarball=termcap-VERSION.tar.bz2
tarball=mpir-VERSION.tar.bz2
tarball=jinja2-VERSION.tar.bz2
tarball=git-VERSION.tar.bz2
tarball=sqlalchemy-VERSION.tar.bz2
tarball=pkgconf-VERSION.tar.bz2
tarball=rpy2-VERSION.tar.gz
tarball=mpfr-VERSION.tar.bz2
tarball=ipython-VERSION.tar.gz
tarball=boost_cropped-VERSION.tar.bz2
tarball=linbox-VERSION.tar.bz2
tarball=d3js-VERSION.tar.gz
tarball=autotools-VERSION.tar.bz2
tarball=jmol-VERSION.tar.bz2
tarball=database_gap-VERSION.tar.bz2
tarball=freetype-VERSION.tar.bz2
tarball=conway_polynomials-VERSION.tar.bz2
tarball=scipy-VERSION.tar.gz
tarball=r-3.1.0.tar.gz
tarball=configure-VERSION.tar.gz
tarball=gmp-VERSION.tar.bz2
tarball=libogg-VERSION.tar.gz
tarball=cephes-VERSION.tar.bz2
tarball=readline-VERSION.tar.bz2
tarball=singular-VERSION.tar.bz2
tarball=glpk-VERSION.tar.bz2
tarball=gdmodule-VERSION.tar.bz2
tarball=sqlite-VERSION.tar.bz2
tarball=sagenb-VERSION.tar
tarball=rubiks-VERSION.tar.bz2
tarball=ecm-VERSION.tar.bz2
tarball=pyzmq-VERSION.tar.gz
tarball=polytopes_db-VERSION.tar.bz2
tarball=tachyon-VERSION.tar.bz2
tarball=pygments-VERSION.tar.bz2
tarball=pari_galdata-VERSION.tar.bz2
tarball=pari_seadata_small-VERSION.tar.bz2
tarball=libtheora-VERSION.tar.bz2
tarball=database_cremona_ellcurve-VERSION.tar.bz2
tarball=matplotlib-VERSION.tar.gz
tarball=zn_poly-VERSION.tar.bz2
tarball=gfan-VERSION.tar.bz2
tarball=bzip2-VERSION.tar.gz
tarball=docutils-VERSION.tar.bz2
tarball=pari-VERSION.tar.bz2
tarball=patch-VERSION.tar.bz2
tarball=iml-VERSION.tar.bz2
tarball=scons-VERSION.tar.bz2
tarball=maxima-VERSION.tar.bz2
tarball=cliquer-VERSION.tar.bz2
tarball=ecl-VERSION.tar.bz2
tarball=boehm_gc-VERSION.tar.bz2
tarball=mcqd-VERSION.tar.bz2
tarball=ncurses-VERSION.tar.bz2
tarball=fflas_ffpack-VERSION.tar.bz2
tarball=database_symbolic_data-VERSION.tar.bz2
tarball=graphs-VERSION.tar.bz2
tarball=flintqs-VERSION.tar.bz2
tarball=iconv-VERSION.tar.bz2
tarball=lrcalc-VERSION.tar.gz
tarball=ntl-VERSION.tar.bz2
tarball=genus2reduction-VERSION.tar.bz2
tarball=gcc-VERSION.tar.bz2
tarball=palp-VERSION.tar.bz2
tarball=tornado-VERSION.tar.gz
tarball=pycrypto-VERSION.tar.gz
tarball=lcalc-VERSION.tar.bz2
tarball=mpc-VERSION.tar.gz
tarball=sphinx-VERSION.tar.bz2
tarball=mpfi-VERSION.tar.bz2
tarball=dateutil-VERSION.tar.gz
tarball=openssl-VERSION.tar.gz
tarball=setuptools-VERSION.tar.gz
tarball=python-VERSION.tar.gz
tarball=sympy-VERSION.tar.gz
tarball=givaro-VERSION.tar.bz2
tarball=pynac-VERSION.tar.bz2
tarball=six-VERSION.tar.gz

Yikes ! All my checksums.ini have been munched !

I have to have a look at the recent history of sage-fix-pkg-checksums to know what was the culprit. But I do not know how to use git to find it. ISTR to have read to use "git" bissect" for this. But git's online help is not very illuminating, to say the least...

Or should I file a new ticket ? I *think* it is easy to fix.


---

Comment by vbraun created at 2014-07-08 03:40:51

IMHO our strategic goal ought to get rid of the current tarball handling, beautifying sage-fix-pkg-checksums is pretty low on my list of priorities.

This ticket needs a lower-case r tarball.


---

Comment by vbraun created at 2014-07-08 18:52:01

Resolution: fixed
