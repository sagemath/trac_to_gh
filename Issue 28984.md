# Issue 28984: fast vector partition algorithm

Issue created by migration from https://trac.sagemath.org/ticket/29221

Original creator: @denissunko

Original creation time: 2020-02-19 16:11:10

CC:  tscrim

Keywords: vector partitions

New Python implementation of Brent Yorgey's fast vector partition algorithm

Some time ago Brent Yorgey published a very efficient algorithm for vector partitions in Haskell, see Brent Yorgey, Generating Multiset Partitions,        The Monad Reader, Issue 8, September 2007, p. 5. at https://wiki.haskell.org/The_Monad.Reader/Previous_issues.

I have translated it into Python for my own use, also some time ago. Now I have decided to contribute it to Sage if possible. I have rewritten the source completely following Sage guidelines as best I could, also found some bugs, and ran a number of examples against both the Sage VectorPartitions() implementation and the original Haskell code by Yorgey. As far as I can see it works as it should, usual disclaimers apply.

Examples:


```
            # the older the computer, the more impressive the example:
            sage: %time fastvparts = fast_vector_partitions([6,6,6])
            CPU times: user 17 s, sys: 136 ms, total: 17.1 s
            Wall time: 17.1 s
            sage: %time vparts = list(VectorPartitions([6,6,6]))
            CPU times: user 4min 16s, sys: 319 ms, total: 4min 16s
            Wall time: 4min 16s
            sage: vparts == fastvparts[::-1]
            True
            sage: fast_vector_partitions([1,2,3], min = [0,1,1])
            [[[1, 2, 3]],
             [[0, 2, 3], [1, 0, 0]],
             [[0, 2, 2], [1, 0, 1]],
             [[0, 2, 1], [1, 0, 2]],
             [[0, 2, 0], [1, 0, 3]],
             [[0, 1, 3], [1, 1, 0]],
             [[0, 1, 2], [1, 1, 1]],
             [[0, 1, 1], [1, 1, 2]],
             [[0, 1, 1], [0, 1, 2], [1, 0, 0]],
             [[0, 1, 1], [0, 1, 1], [1, 0, 1]]]
            sage: fast_vector_partitions([5,7,6], min = [1,3,2])==
            ....: list(VectorPartitions([5,7,6], min = [1,3,2]))[::-1]
            True
```


I will commit as soon as I can.

Cheers,

Denis


---

Comment by git created at 2020-02-20 11:40:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @denissunko created at 2020-02-20 12:00:21

The code works as advertised, but for some reason I cannot get my local version of Sage to see it. No matter how much I run ./sage -br and make, it keeps complaining that the name "fast_vector_partitions" is undefined. I can see that something has happened in the build, because the file fast_vector_partitions.py has migrated from ./src/sage/combinat where I put it to the other locations, and a .pyc file has appeared:


```
$ find . -name "*fast_vector_partitions.*"
./src/build/lib.linux-x86_64-3.7/sage/combinat/fast_vector_partitions.py
./src/sage/combinat/fast_vector_partitions.py
./local/lib/python3.7/site-packages/sage/combinat/fast_vector_partitions.py
./local/lib/python3.7/site-packages/sage/combinat/__pycache__/fast_vector_partitions.cpython-37.pyc
```


However, no luck with the interpreter. I hope this can be sorted out quickly.

Please help,

Denis


---

Comment by @denissunko created at 2020-02-20 12:03:55

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-02-20 16:48:35

(1) You need to add

```
sage: from sage.combinat.fast_vector_partitions import fast_vector_partitions
```

as the first line of your doctests.

(2) every function in your file must have doctests

(3) Besides, your documentation is not formatted correctly. Please read 

https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings

carefully and fix your file according to our documentation style.


---

Comment by @denissunko created at 2020-02-20 18:00:04

Thank you, everything works now.

Here comes the next attempt to get past the patchbots.

Denis


---

Comment by git created at 2020-02-20 18:02:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-02-20 18:28:47

(0) at the top of the file, you do not need to indent inside ALGORITHM: and AUTHORS:

(1) `EXAMPLES:` should be `EXAMPLES::`

and then the doctest inside the EXAMPLES block should be indented by 4 spaces

(general rule is that something ending with :: should contain indented text)

(2) `.. NOTE::` and `.. WARNING::` should be at the same indentation as the text before

(3) remove the "uncomment if..." lines


---

Comment by chapoton created at 2020-02-20 18:47:33

your `dickson_le` can be written in one line

```
all(x <= y for x, y in zip(v, w))
```


similarly, `vector_minus` is
`[x - y for x, y in zip(v,w)]`


---

Comment by @denissunko created at 2020-02-20 20:47:54

Thank you very much, this was helpful. It is difficult to get the fine points right.

With your one-liner, I don't need to import the operator module any more.

Here comes the hopefully-last commit before review.


---

Comment by git created at 2020-02-20 20:49:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-02-20 21:01:44

It is going to take more rounds, I think. I hope you will not be discouraged.

you should just remove `dickson_le` which is used only once (replace its only use by the one-line code)

and the same for vector_minus

same for vector_clip, which is [min(x,y) for x,y in zip(v, w)]

same for vector_unit, also used only once

also remove all the for-debugging-only code.


---

Comment by @denissunko created at 2020-02-20 21:32:16

ok here comes

last before I turn in

not discouraged

poor patchbots


---

Comment by git created at 2020-02-20 21:33:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-02-21 07:53:17

(0) INPUT: and OUTPUT: should be followed by an empty line (as always for lines ending with : or ::)

(1) the content of NOTE:: and WARNING:: should be indented by 4

(2) Do not use # inside the documentation, you can write

```
+    EXAMPLES:
+
+    The older the computer, the more impressive the comparison::
+
+        sage: from sage.combinat.fast_vector_partitions import fast_vector_partitions
```


(3) I would suggest to make your procedure return an iterator (using "yield")

(4) you should insert your new file in the documentation (for example by adding a line in `src/doc/en/reference/combinat/module_list.rst`. And then compile the doc (make doc) and look at the generated html file.


---

Comment by tscrim created at 2020-02-21 09:05:56

Is there some easy way to flip the ordering and have it iterate starting with the largest in lex? Although I guess in many ways it is nice to have another algorithm that iterates starting from the lex smallest...


---

Comment by chapoton created at 2020-02-21 12:36:13

Typo in "decompostion"

In vector_halve, you could use

```
for i, vv in enumerate(v):
```

to take care of the indexing variable i


---

Comment by @denissunko created at 2020-02-21 16:56:35

Documentation builds correctly, so I am ready for the next iteration. Thanks again for all the help, I don't think I could have done without it.

I have decided against enumerate() because I think it is better to be explicit with i += 1 for such a small snippet.

I cannot do yield, sorry. My time for real-time work on this is almost up, so what's done this weekend is done, as far as I am concerned, until June at least. Having said that, I would be happy to play with somebody else's contribution. The author list is open, after all.

From a more general point of view, I think that the time may come when this code can be merged with the VectorPartitions() code, which has some very classy (ha!) features, e.g. vparts = VectorPartitions(...) returns an iterator which can be subscripted: vparts[0], vparts[1], and then reused, vparts[0] again. I don't know how to do that. However, at this time, I think it would be prudent to release this code in isolation for some reasonable period first.

I don't think flipping the order is at all easy with this algorithm, but feel free to look up Yorgey's paper and contradict me. As far as I can see, his whole idea is to produce a partition on each and every cycle of the recursion, so it is natural to start with the one sure thing, v=v. Splitting and re-splitting it one gets them all, but obviously the natural order here is downwards.

There is a deep reason why "sniffing beyond the edges" is disastrously inefficient in vector spaces. Say we have a sphere of radius R in d-dimensional space, and another with a smaller radius r=R-D inside it. How much volume is there in the surface shell of thickness D? Evidently it is

 ~ R<sup>d</sup> - (R-D)<sup>d</sup> = R<sup>d</sup> [1 - (1-D/R)<sup>d</sup>] --> R<sup>d</sup> (!!!) when d>>1, because (1-D/R)<1.

In other words, the shell of thickness D=1 (integer point case) dominates the volume of the sphere, no matter how big R is, when the dimension d of the space is large. Any inefficiency, no matter how marginal along a direction, D/R << 1, will end up dominating the calculation.

(deep breath) here comes the push...


---

Comment by git created at 2020-02-21 16:58:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @denissunko created at 2020-02-22 06:24:39

Some patchbots are failing because of reasons unrelated to my code, at least it seems so to me.

The failed reports are the same as the green ones where they refer to fast_vector_partitions.py.

In these reports doctests are timing out on unrelated packages, but all checkmarks are green.

This being the first time I am contributing, I don't know what to expect now.

Please advise,

Denis


---

Comment by chapoton created at 2020-02-22 07:27:13

yes, some patchbots are known to be broken. If one patchbot is green and the other fails for obviously unrelated reasons, then that's good enough.

This ticket is starting to look very good, but still is not perfect. If you stop working on it, the risk is that nobody else will care, and you will find the ticket in the same state when you come back in 6 months.

(0) the lines in the INPUT: and OUTPUT: blocks should not have final dots.

(1) making iterators would be really better.


---

Comment by @denissunko created at 2020-02-22 10:41:12

You don't have to tell me, look at ticket #27139 - 13 months for one line.

(0) no problem

(1) the problem is, I really don't know how to do yield. I've tried a few times and only got grief. I understand it may be better to defer evaluation, especially with combinatorially exploding outputs, but unless it can be done quickly (read: you tell me how) I am afraid it will go to the back burner starting Monday. It's not that I don't want to do it, it's just how it is with my time.

I did try to replace return with yield just to see what will happen, and I just get errors. It is recursive twice over, so I am really reluctant to go up yield creek with no paddle, as it were.

Any pointer appreciated. I will do the dotless push a little later, have to run now.


---

Comment by chapoton created at 2020-02-22 12:04:41

I propose to make myself a review commit, trying to convert to iterator, if you agree.


---

Comment by @denissunko created at 2020-02-22 13:00:09

Please do, I look forward to learning a bit about yield, only in that case you must put yourself on the authors' list, I insist.

Does that mean I do the dotless iteration now, or wait?


---

Comment by chapoton created at 2020-02-22 13:23:53

as you want, tell me when I can


---

Comment by chapoton created at 2020-02-22 13:35:07

I will do both the "dot removal" and the "yield conversion"


---

Comment by chapoton created at 2020-02-22 13:57:14

Here is the new branch, with iterators.

Beware that this is now on top of the latest develop release of sage, 9.1.beta5. If you pull the branch, it may trigger a large scale recompilation of sage, if you were using 9.0 for example.

I have changed the doctests to much smaller cases. Our doctests are not here to display the power of the methods, but should be short and quick cases to check that the code works. Each doctests is not supposed to last more than 1s.

`@`tscrim, do you see something else to be done ?
----
New commits:


---

Comment by @denissunko created at 2020-02-22 14:36:22

I have looked at the code and it is beautiful, thank you so much.

I can't do anything with it right now because I want to pull/recompile first as you said, with my more-typewriter-than-computer it will take some time I suppose. Then I will put your name in the authors' list ("conversion to iterators and shorter doctests and doc tweaks") if you won't.

Cheers,

Denis


---

Comment by @denissunko created at 2020-02-22 16:21:53

This was quicker than I thought.

Yes, it works (fantastic).

Here comes the push.


---

Comment by git created at 2020-02-22 16:22:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-22 21:58:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-23 06:25:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-02-23 06:34:00

It is better to do `enumerate` that the `i += 1` as it is both faster and more explicit in linking `i` to the position of `vv`.

Also, I think I will also push a reviewer change. What would you think if I port this over to Cython? Since this is suppose to be fast and it seems well-poised to be done at a lower level, I feel like that is more natural.


---

Comment by @denissunko created at 2020-02-23 08:09:31

I agree about enumerate, here is the push. The [6,6,6] case is 5-10% faster, amazing. Also Cython is a great idea.

Sorry about the docstring, I did not know I could mess up a single line in so many ways. Still not sure the utf-8 line will work as advertised.


---

Comment by git created at 2020-02-23 08:10:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-02-26 20:04:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @denissunko created at 2020-03-01 09:59:11

I notice some test pending with 16/17 commits, but not any of the above codes. What is supposed to happen next?


---

Comment by git created at 2020-03-06 00:11:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-06 00:15:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-03-06 00:18:11

Okay, I finally got around to giving this a good optimization with Cython. With your branch:

```
sage: from sage.combinat.fast_vector_partitions import fast_vector_partitions
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 3.13 s, sys: 48.3 ms, total: 3.18 s
Wall time: 3.17 s
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 3.2 s, sys: 64.1 ms, total: 3.26 s
Wall time: 3.26 s
```

versus with my changes:

```
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 1.46 s, sys: 52 ms, total: 1.51 s
Wall time: 1.51 s
sage: %time fastvparts = list(fast_vector_partitions([6,6,6]))
CPU times: user 1.28 s, sys: 36.1 ms, total: 1.31 s
Wall time: 1.31 s
```

The next step would be using actual fixed length C arrays (instead of lists) with `memcpy`. At this point, it practically becomes a standalone C library. Anyways, I am happy with the current results. So if you agree with my changes, then this is a positive review. (Note that `cdef` do not need doctests.)


---

Comment by @denissunko created at 2020-03-06 07:52:45

Thank you very much.

Of course I agree, code unseen.

I am nowhere near my computer now, but plan one final push today or tomorrow:
- add your name to author list ("Cython optimizations and doc tweaks"),
- add a doc tweak ("as the vector grows" -> "as the vector is parsed"), reflects the code better.

Please feel free to do this yourself, if you agree.


---

Comment by @denissunko created at 2020-03-06 21:14:34

Here comes the push.

In addition to the above, I have:

- escaped the dots in author's initials, otherwise the rst parser interpreted them as nested lists;
- replaced one stray ``min`` with ``min_val``;
- replaced ``len(a) >= len(b)`` with ``len(b) >= len(a)`` in the vector_sub docstring,
  because it seems that one must not go beyond the end of b (but maybe I misunderstood).

I have not touched the code at all, so I hope a positive review is still within reach.

I thank both coauthors again, the code is much better than before and I have learned a lot.


---

Comment by git created at 2020-03-06 21:14:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-03-06 23:13:03

Thank you. Your changes look good to me. Frédéric, if you have any objections, feel free to revert the positive review.


---

Comment by tscrim created at 2020-03-06 23:13:03

Changing status from needs_review to positive_review.


---

Comment by @denissunko created at 2020-03-07 08:19:19

A summary of timings for the [6, 6, 6] case (my machine at work, floored seconds):

(`VectorPartitions`) 129 > (initial version) 8 > (iterators) 7 > (pyx) 5 > (cython opt.) 2


---

Comment by vbraun created at 2020-03-10 23:27:23

Resolution: fixed
