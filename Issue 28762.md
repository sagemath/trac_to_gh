# Issue 28762: qepcad interface is broken with python3

Issue created by migration from https://trac.sagemath.org/ticket/28999

Original creator: mmarco

Original creation time: 2020-01-13 10:17:15

CC:  jdemeyer tscrim chapoton embray

qepcad interface is based on text strings. Since the switch to python 3, we get bytes object instead, which breaks the interface:


```
sage: from sage.interfaces.qepcad import qepcad_formula
sage: var('x,y')
(x, y)
sage: form = qepcad_formula.exists(y,x^2+y^2==0)
sage: qepcad(form)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-4-4d5778df350d> in <module>()
----> 1 qepcad(form)

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in qepcad(formula, assume, interact, solution, vars, **kwargs)
   1636     else:
   1637         qe.go()
-> 1638         qe.go()
   1639         qe.go()
   1640         if solution is None:

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in __call__(self, *args)
   1416                              "interactive commands not handled")
   1417 
-> 1418         return self._parent._function_call(self._name, args)
   1419 
   1420 

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in _function_call(self, name, args)
   1324         if pre_phase != post_phase:
   1325             if post_phase == 'EXITED' and name != 'quit':
-> 1326                 return self.answer()
   1327             return AsciiArtString("QEPCAD object has moved to phase '%s'"%post_phase)
   1328 

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in answer(self)
   1123             {'x + 1 = 0', 'x + 1 >= 0', 'x - 1 <= 0', 'x - 1 = 0', 'x = 0'}
   1124         """
-> 1125         return AsciiArtString(self._parse_answer_stats()[0])
   1126 
   1127     def final_stats(self):

/home/mmarco/sage/local/lib/python3.7/site-packages/sage/interfaces/qepcad.py in _parse_answer_stats(self)
   1091             raise ValueError("QEPCAD is not finished yet")
   1092         final = self._qex.expect().before
-> 1093         match = re.search('\nAn equivalent quantifier-free formula:(.*)\n=+  The End  =+\r\n\r\n(.*)$', final, re.DOTALL)
   1094 
   1095         if match:

/home/mmarco/sage/local/lib/python3.7/re.py in search(pattern, string, flags)
    181     """Scan through string looking for a match to the pattern, returning
    182     a Match object, or None if no match was found."""
--> 183     return _compile(pattern, flags).search(string)
    184 
    185 def sub(pattern, repl, string, count=0, flags=0):

TypeError: cannot use a string pattern on a bytes-like object

```



---

Comment by mmarco created at 2020-01-13 12:54:05

Changing status from new to needs_review.


---

Comment by mmarco created at 2020-01-13 12:54:05

New commits:


---

Comment by mmarco created at 2020-01-13 12:54:05

Changing keywords from "" to "interfaces".


---

Comment by tscrim created at 2020-01-13 16:46:05

Changing type from PLEASE CHANGE to defect.


---

Comment by tscrim created at 2020-01-13 16:46:05

Did you also check this on Python2? If so, then you can set a positive review.


---

Comment by tscrim created at 2020-01-13 16:51:43

If it doesn't work, you can try the `bytes_to_str` helper function. cc-ing Erik since he also knows a lot about making these work.


---

Comment by mmarco created at 2020-01-13 18:31:43

Replying to [comment:5 tscrim]:
> Did you also check this on Python2? If so, then you can set a positive review.

No. I didn't. 

Do we need to ensure compaitibility with python2 now that we have made the switch to python3?


---

Comment by tscrim created at 2020-01-13 18:40:50

Replying to [comment:7 mmarco]:
> Replying to [comment:5 tscrim]:
> > Did you also check this on Python2? If so, then you can set a positive review.
> 
> No. I didn't. 
> 
> Do we need to ensure compaitibility with python2 now that we have made the switch to python3?

We are still officially supporting Python2 in the next release AFAIK from the sage-devel thread. Although since this is a more specialized case, it might be okay to not worry about it...


---

Comment by embray created at 2020-01-14 11:13:46

Replying to [comment:8 tscrim]:
> Replying to [comment:7 mmarco]:
> > Replying to [comment:5 tscrim]:
> > > Did you also check this on Python2? If so, then you can set a positive review.
> > 
> > No. I didn't. 
> > 
> > Do we need to ensure compaitibility with python2 now that we have made the switch to python3?
> 
> We are still officially supporting Python2 in the next release AFAIK from the sage-devel thread. Although since this is a more specialized case, it might be okay to not worry about it...

IIUC that question is still unresolved, but it would be best to try to preserve Python 2 compatibility for now, yes.


---

Comment by embray created at 2020-01-14 11:14:14

Changing status from needs_review to needs_work.


---

Comment by embray created at 2020-01-14 11:20:31

Anyways, as Travis says, it's better to go through the interface carefully and ensure that any place that reads bytes directly from pexpect runs `bytes_to_str` over them before passing them to code that is intended to operate on strings.

I'm going to install qepcad and see if I can run the tests for it and what comes up...


---

Comment by git created at 2020-01-14 13:24:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2020-01-16 11:36:16

I think it would be clearer are more consistent with some of the other code to write this like:


```
final = bytes_to_str(self._qex.expect().before)
```



---

Comment by embray created at 2020-01-16 16:46:50

Changing keywords from "interfaces" to "interfaces py3".


---

Comment by embray created at 2020-01-16 16:46:50

Here, try this--this fixes all the doctests for `sage.interfaces.qepcad` on Python 3.
----
New commits:


---

Comment by embray created at 2020-01-16 16:46:50

Changing status from needs_work to needs_review.


---

Comment by mmarco created at 2020-01-20 12:37:57

The last commit by embray works fine for me.

Are you ok with a positive review?


---

Comment by tscrim created at 2020-01-20 13:43:31

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-01-20 13:43:31

Yep, positive review.


---

Comment by vbraun created at 2020-01-22 20:43:56

Resolution: fixed
