# Issue 26804: Remove deprecated code in sage.misc.cython

Issue created by migration from https://trac.sagemath.org/ticket/27041

Original creator: jdemeyer

Original creation time: 2019-01-11 10:45:01

Remove code deprecated in #24105.


---

Comment by jdemeyer created at 2019-01-11 11:19:02

New commits:


---

Comment by jdemeyer created at 2019-01-11 11:19:02

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-01-11 15:45:43

(For the record: the 4 tickets have been closed for Sage 8.1 released in July 2017)


---

Comment by vdelecroix created at 2019-01-11 15:45:43

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2019-01-11 15:45:49

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2019-01-13 21:27:37

Replying to [comment:7 vdelecroix]:
> (For the record: the 4 tickets have been closed for Sage 8.1 released in July 2017)

Not quite. #24105 is from Sage 8.2


---

Comment by vdelecroix created at 2019-01-15 12:50:25

Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > (For the record: the 4 tickets have been closed for Sage 8.1 released in July 2017)
> 
> Not quite. #24105 is from Sage 8.2

Which is bad as it was released 05/06/18... One year deprecation implies 5 more months.


---

Comment by jdemeyer created at 2019-01-15 13:03:38

Replying to [comment:10 vdelecroix]:
> Which is bad as it was released 05/06/18... One year deprecation implies 5 more months.

No, we are both wrong :-) 

#22805 is from Sage 8.0

#22698, #23855, #24105 are from Sage 8.1

So this should be fine.


---

Comment by embray created at 2019-01-15 14:07:47

Maybe not for this ticket, but there's a patch in Debian related to this that I think would be worth incorporating into Sage somehow:


```diff
Description: Additional changes to work with the Debian package of singular
 We search for a specific SOVERSION of libsingular-Singular, to allow us to
 runtime-Depend on libsingular4 and not libsingular4-dev.
Author: Tobias Hansen <thansen@debian.org>
Author: Ximin Luo <infinity0@debian.org>
Forwarded: not-needed
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/sage/src/sage/interfaces/singular.py
+++ b/sage/src/sage/interfaces/singular.py
@@ -2264,7 +2264,7 @@
     node_names.clear()

     import os
-    singular_docdir = os.environ['SINGULARPATH']+"/../info/"
+    singular_docdir = "/usr/share/doc/singular/"

     new_node = re.compile(r"File: singular\.hlp,  Node: ([^,]*),.*")
     new_lookup = re.compile(r"\* ([^:]*):*([^.]*)\..*")
--- a/sage/src/sage/misc/cython.py
+++ b/sage/src/sage/misc/cython.py
@@ -323,6 +323,11 @@
     args = ['-w','-O2'] + args
     libdirs = cblas_library_dirs

+    # Add Singular directories to includes
+    if "singular" in s or "pynac" in s:
+        import pkgconfig
+        inc.extend(sorted(set(pkgconfig.parse("Singular")["include_dirs"])))
+
     # Add cysignals directory to includes
     for path in sys.path:
         cysignals_path = os.path.join(path, "cysignals")
--- a/sage/src/sage/env.py
+++ b/sage/src/sage/env.py
@@ -187,7 +187,7 @@
     else:
         extension = "so"
     # library name changed from libsingular to libSingular btw 3.x and 4.x
-    SINGULAR_SO = SAGE_LOCAL+"/lib/libSingular."+extension
+    SINGULAR_SO = "/usr/lib/%s/libsingular-Singular-4.1.1.so" % sysconfig.get_config_var('MULTIARCH')

 _add_variable_or_fallback('SINGULAR_SO', SINGULAR_SO)

--- a/sage/src/sage/misc/compat.py
+++ b/sage/src/sage/misc/compat.py
@@ -87,7 +87,7 @@
     EXAMPLES::

         sage: from sage.misc.compat import find_library
-        sage: find_library('Singular')
+        sage: find_library('singular-Singular')
         '...Singular...'

     """
```


I think that this demonstrates that there needs to be a better way to customize where sage looks for bits of Singular (the library, as well as its docs and include files).


---

Comment by embray created at 2019-01-15 14:08:09

Hooray for getting rid of cruft.


---

Comment by embray created at 2019-01-15 14:08:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-25 15:26:41

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-01-25 15:26:41


```
sage -t --long src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 412, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/mnt/disk/home/release/.sage/temp/volker/30915/dir_Gy_O0N/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
File "src/sage/tests/cmdline.py", line 417, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/mnt/disk/home/release/.sage/temp/volker/30915/dir_Gy_O0N/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
1 item had failures:
   2 of 251 in sage.tests.cmdline.test_executable
    [250 tests, 2 failures, 41.71 s]
----------------------------------------------------------------------
sage -t --long src/sage/tests/cmdline.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 41.8 seconds
```



---

Comment by jdemeyer created at 2019-01-25 15:36:06

That error doesn't seem related to this ticket at all.


---

Comment by jdemeyer created at 2019-01-25 15:36:06

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2019-01-27 10:50:32

Resolution: fixed
