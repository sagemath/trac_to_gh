# Issue 22397: Fix bug with pAutomorphicForms for weights larger than two

Issue created by migration from https://trac.sagemath.org/ticket/22634

Original creator: mmasdeu

Original creation time: 2017-03-17 17:21:48

CC:  roed

Keywords: Bruhat Tits, Harmonic Cocycles, Overconvergent

The following code illustrates the bug:


```
sage: X = BruhatTitsQuotient(7,2)
sage: H = X.harmonic_cocycles(4,20)
sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)
sage: f = A.lift(H.basis()[0]).modular_form(method='moments')
sage: T.<g> = Qq(7^2,20)
sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()
sage: (c*x + d)^4 * f(x) == f((a*x + b)/(c*x + d)) # Should return True
False
```


The problem arose because of the way distributions work, which get normalized even when the user wishes they weren't. I propose a fix to this.


---

Comment by mmasdeu created at 2017-03-17 17:27:59

New commits:


---

Comment by mmasdeu created at 2017-03-17 17:27:59

Changing status from new to needs_review.


---

Comment by pgraef created at 2017-03-23 10:15:23

Changing status from needs_review to needs_work.


---

Comment by pgraef created at 2017-03-23 10:15:23

The bug still seems to occur in other cases, for example here


```
sage: X = BruhatTitsQuotient(7,2)
sage: H = X.harmonic_cocycles(4,20)
sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)
sage: f = A.lift(H.basis()[1]).modular_form(method='moments')
sage: T.<x> = Qq(7^2,20)
sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(7,20)).list()
sage: (c*x + d)^4 * f(x) - f((a*x + b)/(c*x + d))
(6*x + 3) + (6*x + 5)*7 + (x + 6)*7^2 + (2*x + 3)*7^3 + (3*x + 2)*7^4 + (6*x + 4)*7^5 + (x + 3)*7^6 + (4*x + 6)*7^7 + (5*x + 1)*7^8 + (6*x + 1)*7^9 + (3*x + 5)*7^10 + (x + 2)*7^11 + (5*x + 2)*7^12 + (5*x + 6)*7^13 + (4*x + 4)*7^14 + 5*7^15 + (4*x + 4)*7^16 + O(7^17)
```


or here


```
sage: X = BruhatTitsQuotient(3,5)
sage: H = X.harmonic_cocycles(4,20)
sage: A = X.padic_automorphic_forms(4,20,overconvergent=True)
sage: f = A.lift(H.basis()[0]).modular_form(method='moments')
sage: T.<x> = Qq(3^2,20)
sage: a,b,c,d = X.embed_quaternion(X.get_units_of_order()[1]).change_ring(Qp(3,20)).list()
sage: (c*x + d)^4 * f(x) - f((a*x + b)/(c*x + d))
3^3 + (x + 2)*3^5 + 2*x*3^6 + (x + 1)*3^7 + 2*3^8 + (x + 2)*3^9 + (2*x + 1)*3^10 + (2*x + 2)*3^12 + (x + 2)*3^14 + 2*x*3^15 + x*3^16 + O(3^17)
```


I tried to track down the problem, but didn't suceed. When evaluating the lift of the harmonic cocycle on random matrices, I just noticed that the values for the higher moments seem to be wrong.


---

Comment by git created at 2017-03-31 14:53:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2017-03-31 14:54:53

I tracked the error. I was trying to be extra careful in the lifting step and it turns out that it's not needed. The old code did not have this "functionality" and that's why it worked!


---

Comment by mmasdeu created at 2017-03-31 14:56:12

Changing status from needs_work to needs_review.


---

Comment by pgraef created at 2017-04-07 12:13:11

Changing status from needs_review to positive_review.


---

Comment by pgraef created at 2017-04-07 12:13:11

Works exactly as it should, everything looks perfect!


---

Comment by vbraun created at 2017-04-08 17:12:59

Resolution: fixed
