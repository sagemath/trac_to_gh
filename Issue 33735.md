# Issue 33735: Another error in height_difference_bound

Issue created by migration from https://trac.sagemath.org/ticket/33972

Original creator: @guojing0

Original creation time: 2022-06-10 11:51:29

CC:  bhutz @enderwannabe

Keywords: gsoc2022

Similiar to #33971, the height of a polynomial is not the max of the heights of the coefficients. However, it is computing `h(g_i)` as the max of the heights of the coefficients of `g_i`.


```
for k in range(N + 1):
    CoeffPolys = (CR.gen(k) ** D).lift(I)
    h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])
    maxh = max(maxh, h)
```



---

Comment by bhutz created at 2022-06-10 16:12:20

It may makes sense to first implement a height function for polynomials and then use that height function in height_difference_bound


---

Comment by @guojing0 created at 2022-07-05 14:39:43

New commits:


---

Comment by @guojing0 created at 2022-07-05 14:43:17

Changing status from new to needs_review.


---

Comment by @guojing0 created at 2022-07-08 07:37:53

Update with latest code from polynomial height.
----
New commits:


---

Comment by @guojing0 created at 2022-07-08 07:42:42

Only failure (with actual return value `2.9957322...`):


```
sage: P.<x,y> = ProjectiveSpace(QQ, 1)
sage: f = DynamicalSystem([5*x^2 + 3*x*y , y^2 + 3*x^2])
sage: f.height_difference_bound(prec=100)
5.3375380797013179737224159274
```



---

Comment by bhutz created at 2022-07-11 13:51:43

This change is wrong:

```
-        CR = f.domain().coordinate_ring()
-        I = CR.ideal(f.defining_polynomials())
-        maxh = 0
-        for k in range(N + 1):
-            CoeffPolys = (CR.gen(k) ** D).lift(I)
-            h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])
-            maxh = max(maxh, h)
-        L = R((N + 1) * binomial(N + D - d, D - d)).log() + maxh
+        L = R((N + 1) * binomial(N + D - d, D - d)).log() + f.global_height(prec)
```


The error of the existing code is the line

```
h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])
```

What is wrong is that it is taking the height of g to be the max of the height of its coefficients. You still need to take maxh to be the max of the heights of the CoeffPolys, but the correction is to use the new height code (#34060) to compute the heights of each g.


---

Comment by bhutz created at 2022-07-11 13:51:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-07-12 12:47:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-13 11:00:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @guojing0 created at 2022-07-13 11:01:32

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-07-13 13:51:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2022-07-26 15:08:28

This looks fine at this point. The difference in the examples is because of correcting the height of the ``g'' polynomials. They are monomials in these examples, so have (logarithmic) height 0 rather than the height of the coefficient.

So I'll mark this positive modulo any issues that show up when the dependency gets merged.


---

Comment by bhutz created at 2022-07-26 15:08:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-08-05 20:32:36


```
**********************************************************************
File "src/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 2116, in sage.dynamics.arithmetic_dynamics.projective_ds.?.height_difference_bound
Failed example:
    f.height_difference_bound()
Expected:
    11.0020998412042
Got:
    10.3089526606443
**********************************************************************
File "src/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 2128, in sage.dynamics.arithmetic_dynamics.projective_ds.?.height_difference_bound
Failed example:
    f.height_difference_bound()
Expected:
    11.0020998412042
Got:
    11.3683039374269

q^CKilling test src/sage/dynamics/arithmetic_dynamics/projective_ds.py
----------------------------------------------------------------------
Doctests interrupted: 0/1 files tested
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2022-08-05 20:32:36

Changing status from positive_review to needs_work.


---

Comment by bhutz created at 2022-08-10 17:36:52

I'm also getting these errors on a clean branch. The first one is in the example

```
            sage: P.<x,y,z> = ProjectiveSpace(ZZ, 2)
            sage: f = DynamicalSystem_projective([4*x^2 + 100*y^2, 210*x*y, 10000*z^2])
            sage: f.height_difference_bound()
            11.0020998412042
            sage: f.normalize_coordinates()
            sage: f.height_difference_bound()
            10.3089526606443
```

It doesn't make sense to keep .normalize in here anymore as the height of the polynomials is independent of the normalization. The 10.308... is the correct value. So condense this example down to a single (correct) value.

The second failure is just the wrong value.


---

Comment by @guojing0 created at 2022-08-11 08:14:48

Build and pass all tests on the new branch based on the latest `develop` branch.
----
New commits:


---

Comment by @guojing0 created at 2022-08-11 08:14:48

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2022-08-11 18:04:42

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2022-08-11 18:04:42

This looks fine and the tests pass for me.

In the future it's better to edit the existing ticket to fix the issues rather than create a whole new branch that erases the history.


---

Comment by vbraun created at 2022-08-30 19:04:55

Resolution: fixed
