# Issue 33735: Another error in height_difference_bound

archive/issues_033735.json:
```json
{
    "body": "CC:  @bhutz @enderwannabe\n\nKeywords: gsoc2022\n\nSimiliar to #33971, the height of a polynomial is not the max of the heights of the coefficients. However, it is computing `h(g_i)` as the max of the heights of the coefficients of `g_i`.\n\n```\nfor k in range(N + 1):\n    CoeffPolys = (CR.gen(k) ** D).lift(I)\n    h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])\n    maxh = max(maxh, h)\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/33972\n\n",
    "created_at": "2022-06-10T11:51:29Z",
    "labels": [
        "component: dynamics",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Another error in height_difference_bound",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33735",
    "user": "https://github.com/guojing0"
}
```
CC:  @bhutz @enderwannabe

Keywords: gsoc2022

Similiar to #33971, the height of a polynomial is not the max of the heights of the coefficients. However, it is computing `h(g_i)` as the max of the heights of the coefficients of `g_i`.

```
for k in range(N + 1):
    CoeffPolys = (CR.gen(k) ** D).lift(I)
    h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])
    maxh = max(maxh, h)
```

Issue created by migration from https://trac.sagemath.org/ticket/33972





---

archive/issue_comments_479234.json:
```json
{
    "body": "It may makes sense to first implement a height function for polynomials and then use that height function in height_difference_bound",
    "created_at": "2022-06-10T16:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479234",
    "user": "https://github.com/bhutz"
}
```

It may makes sense to first implement a height function for polynomials and then use that height function in height_difference_bound



---

archive/issue_comments_479235.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-07-05T14:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479235",
    "user": "https://github.com/guojing0"
}
```

New commits:



---

archive/issue_comments_479236.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-05T14:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479236",
    "user": "https://github.com/guojing0"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_479237.json:
```json
{
    "body": "Update with latest code from polynomial height.\n\n---\nNew commits:",
    "created_at": "2022-07-08T07:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479237",
    "user": "https://github.com/guojing0"
}
```

Update with latest code from polynomial height.

---
New commits:



---

archive/issue_comments_479238.json:
```json
{
    "body": "Only failure (with actual return value `2.9957322...`):\n\n```\nsage: P.<x,y> = ProjectiveSpace(QQ, 1)\nsage: f = DynamicalSystem([5*x^2 + 3*x*y , y^2 + 3*x^2])\nsage: f.height_difference_bound(prec=100)\n5.3375380797013179737224159274\n```",
    "created_at": "2022-07-08T07:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479238",
    "user": "https://github.com/guojing0"
}
```

Only failure (with actual return value `2.9957322...`):

```
sage: P.<x,y> = ProjectiveSpace(QQ, 1)
sage: f = DynamicalSystem([5*x^2 + 3*x*y , y^2 + 3*x^2])
sage: f.height_difference_bound(prec=100)
5.3375380797013179737224159274
```



---

archive/issue_comments_479239.json:
```json
{
    "body": "This change is wrong:\n\n```\n-        CR = f.domain().coordinate_ring()\n-        I = CR.ideal(f.defining_polynomials())\n-        maxh = 0\n-        for k in range(N + 1):\n-            CoeffPolys = (CR.gen(k) ** D).lift(I)\n-            h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])\n-            maxh = max(maxh, h)\n-        L = R((N + 1) * binomial(N + D - d, D - d)).log() + maxh\n+        L = R((N + 1) * binomial(N + D - d, D - d)).log() + f.global_height(prec)\n```\n\nThe error of the existing code is the line\n\n```\nh = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])\n```\nWhat is wrong is that it is taking the height of g to be the max of the height of its coefficients. You still need to take maxh to be the max of the heights of the CoeffPolys, but the correction is to use the new height code (#34060) to compute the heights of each g.",
    "created_at": "2022-07-11T13:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479239",
    "user": "https://github.com/bhutz"
}
```

This change is wrong:

```
-        CR = f.domain().coordinate_ring()
-        I = CR.ideal(f.defining_polynomials())
-        maxh = 0
-        for k in range(N + 1):
-            CoeffPolys = (CR.gen(k) ** D).lift(I)
-            h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])
-            maxh = max(maxh, h)
-        L = R((N + 1) * binomial(N + D - d, D - d)).log() + maxh
+        L = R((N + 1) * binomial(N + D - d, D - d)).log() + f.global_height(prec)
```

The error of the existing code is the line

```
h = max([c.global_height(prec) for g in CoeffPolys for c in (g).coefficients()])
```
What is wrong is that it is taking the height of g to be the max of the height of its coefficients. You still need to take maxh to be the max of the heights of the CoeffPolys, but the correction is to use the new height code (#34060) to compute the heights of each g.



---

archive/issue_comments_479240.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-07-11T13:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479240",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_479241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-12T12:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479241",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479242.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-13T11:00:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479242",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_479243.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-07-13T11:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479243",
    "user": "https://github.com/guojing0"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_479244.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-13T13:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479244",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479245.json:
```json
{
    "body": "This looks fine at this point. The difference in the examples is because of correcting the height of the ``g'' polynomials. They are monomials in these examples, so have (logarithmic) height 0 rather than the height of the coefficient.\n\nSo I'll mark this positive modulo any issues that show up when the dependency gets merged.",
    "created_at": "2022-07-26T15:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479245",
    "user": "https://github.com/bhutz"
}
```

This looks fine at this point. The difference in the examples is because of correcting the height of the ``g'' polynomials. They are monomials in these examples, so have (logarithmic) height 0 rather than the height of the coefficient.

So I'll mark this positive modulo any issues that show up when the dependency gets merged.



---

archive/issue_comments_479246.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-26T15:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479246",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479247.json:
```json
{
    "body": "```\n**********************************************************************\nFile \"src/sage/dynamics/arithmetic_dynamics/projective_ds.py\", line 2116, in sage.dynamics.arithmetic_dynamics.projective_ds.?.height_difference_bound\nFailed example:\n    f.height_difference_bound()\nExpected:\n    11.0020998412042\nGot:\n    10.3089526606443\n**********************************************************************\nFile \"src/sage/dynamics/arithmetic_dynamics/projective_ds.py\", line 2128, in sage.dynamics.arithmetic_dynamics.projective_ds.?.height_difference_bound\nFailed example:\n    f.height_difference_bound()\nExpected:\n    11.0020998412042\nGot:\n    11.3683039374269\n\nq^CKilling test src/sage/dynamics/arithmetic_dynamics/projective_ds.py\n----------------------------------------------------------------------\nDoctests interrupted: 0/1 files tested\n----------------------------------------------------------------------\n```",
    "created_at": "2022-08-05T20:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479247",
    "user": "https://github.com/vbraun"
}
```

```
**********************************************************************
File "src/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 2116, in sage.dynamics.arithmetic_dynamics.projective_ds.?.height_difference_bound
Failed example:
    f.height_difference_bound()
Expected:
    11.0020998412042
Got:
    10.3089526606443
**********************************************************************
File "src/sage/dynamics/arithmetic_dynamics/projective_ds.py", line 2128, in sage.dynamics.arithmetic_dynamics.projective_ds.?.height_difference_bound
Failed example:
    f.height_difference_bound()
Expected:
    11.0020998412042
Got:
    11.3683039374269

q^CKilling test src/sage/dynamics/arithmetic_dynamics/projective_ds.py
----------------------------------------------------------------------
Doctests interrupted: 0/1 files tested
----------------------------------------------------------------------
```



---

archive/issue_comments_479248.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-08-05T20:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479248",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_479249.json:
```json
{
    "body": "I'm also getting these errors on a clean branch. The first one is in the example\n\n```\n            sage: P.<x,y,z> = ProjectiveSpace(ZZ, 2)\n            sage: f = DynamicalSystem_projective([4*x^2 + 100*y^2, 210*x*y, 10000*z^2])\n            sage: f.height_difference_bound()\n            11.0020998412042\n            sage: f.normalize_coordinates()\n            sage: f.height_difference_bound()\n            10.3089526606443\n```\nIt doesn't make sense to keep .normalize in here anymore as the height of the polynomials is independent of the normalization. The 10.308... is the correct value. So condense this example down to a single (correct) value.\n\nThe second failure is just the wrong value.",
    "created_at": "2022-08-10T17:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479249",
    "user": "https://github.com/bhutz"
}
```

I'm also getting these errors on a clean branch. The first one is in the example

```
            sage: P.<x,y,z> = ProjectiveSpace(ZZ, 2)
            sage: f = DynamicalSystem_projective([4*x^2 + 100*y^2, 210*x*y, 10000*z^2])
            sage: f.height_difference_bound()
            11.0020998412042
            sage: f.normalize_coordinates()
            sage: f.height_difference_bound()
            10.3089526606443
```
It doesn't make sense to keep .normalize in here anymore as the height of the polynomials is independent of the normalization. The 10.308... is the correct value. So condense this example down to a single (correct) value.

The second failure is just the wrong value.



---

archive/issue_comments_479250.json:
```json
{
    "body": "Build and pass all tests on the new branch based on the latest `develop` branch.\n\n---\nNew commits:",
    "created_at": "2022-08-11T08:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479250",
    "user": "https://github.com/guojing0"
}
```

Build and pass all tests on the new branch based on the latest `develop` branch.

---
New commits:



---

archive/issue_comments_479251.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-11T08:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479251",
    "user": "https://github.com/guojing0"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_479252.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-11T18:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479252",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479253.json:
```json
{
    "body": "This looks fine and the tests pass for me.\n\nIn the future it's better to edit the existing ticket to fix the issues rather than create a whole new branch that erases the history.",
    "created_at": "2022-08-11T18:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479253",
    "user": "https://github.com/bhutz"
}
```

This looks fine and the tests pass for me.

In the future it's better to edit the existing ticket to fix the issues rather than create a whole new branch that erases the history.



---

archive/issue_comments_479254.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-30T19:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33735#issuecomment-479254",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_088981.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-08-30T19:04:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33735",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33735#event-88981"
}
```
