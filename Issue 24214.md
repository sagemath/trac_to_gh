# Issue 24214: Polyhedron.get_integral_point

Issue created by migration from Trac.

Original creator: mcbell

Original creation time: 2017-12-30 21:36:39

CC:  vdelecroix tmonteil mkoeppe




---

Comment by mcbell created at 2017-12-30 21:51:24

Changing keywords from "" to "Polyhedron, integral_points".


---

Comment by mcbell created at 2017-12-30 21:51:24

Changing status from new to needs_review.


---

Comment by mcbell created at 2017-12-30 21:51:24

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mcbell created at 2017-12-30 21:51:24

Changing component from PLEASE CHANGE to geometry.


---

Comment by vdelecroix created at 2017-12-30 21:54:49

Mark,

As we discussed in Warwick, this method is rather unnatural (integer points are not naturally indexed) and is not needed for random sampling. To my mind, it would make more sense to have a new method `.random_integral_point` implemented along the same lines.


---

Comment by mcbell created at 2017-12-30 22:19:45

Sure, that would be a simple enough thing to change - should I open a new ticket?


---

Comment by vdelecroix created at 2017-12-30 22:55:38

Replying to [comment:4 mcbell]:
> Sure, that would be a simple enough thing to change - should I open a new ticket?

Though, I do not think I was right: e.g. integral points are naturally indexed for the lexicographical ordering. In the description, you claim to follow the ordering of `integral_points`. Is it always lexicographic? I could not find any mention of ordering in the documentation. Note in particular that `integral_points` claims to have two implementations

```
Uses either the naive algorithm (iterate over a rectangular
bounding box) or triangulation + Smith form.
```

The ordering is independent of the method?

BTW, your branch `u/mcbell/polyhedron_get_integral_point` does not exist. Is that normal?

About `get_integral_point` vs `random_integral_point` you are free to do whatever you want with your ticket :-)


---

Comment by git created at 2017-12-30 23:45:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mcbell created at 2017-12-31 00:02:23

Replying to [comment:5 vdelecroix]:

Thanks for the great comments. I think I've now managed to push my branch onto trac so you should be able to see the code.

> Though, I do not think I was right: e.g. integral points are naturally indexed for the lexicographical ordering. In the description, you claim to follow the ordering of `integral_points`. Is it always lexicographic? I could not find any mention of ordering in the documentation. Note in particular that `integral_points` claims to have two implementations
> {{{
> Uses either the naive algorithm (iterate over a rectangular
> bounding box) or triangulation + Smith form.
> }}}
> The ordering is independent of the method?
Ah, you are correct, you are not guaranteed to get lexicographical ordering when the triangulation method is used. In part this is caused by the fact that the points that are found in the different triangles are just merged together using a set. Perhaps L5288 of src/sage/geometrypolyhedron/base.py should become "return tuple(sorted(points))" to make the method deterministic. So the correct thing to say is that this method returns

```
sorted(self.integral_points())[index]
```

I've updated the docstring and above explanation to reflect this.

My new suggestion, which is in the latest commits, is to also add a Polyhedron.random_integral_point() method that just uses the snippet I posted originally.


---

Comment by vdelecroix created at 2017-12-31 10:09:18

Concerning, `P.integral_points()`, I think that it should even be an iterator (as most things in Python3). Hence I am against sorting. If the user needs a sorted list, she can just apply a sort on the result.

For polytopes "with small interior", I believe that it is much faster to compute the set of points first and then do random sampling (while keeping the list in some cache). But let us keep that for later on.

For more concrete comments: when the polytope has no integral points the method `random_integral_point` should raise an `EmptySetError` (from `sage.categories.sets_cat`). And in both methods, the error have to be doctested. It should look like

```
sage: my_polytope_without_integral_points.random_integral_point()
Traceback (most recent call last):
...
EmptySetError: error-message
```

(you can have a look around in the code)


---

Comment by git created at 2017-12-31 12:11:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-12-31 12:42:37

For random sampling you should not use the directly the `random` module but

```
sage: from sage.misc.randstate import current_randstate
sage: random = current_randstate().python_random()
sage: random.randint(0,5)
0
sage: random.randint(0,5)
5
```

The reason is that Sage has to take care of a lot of random generators coming from different libraries (Python, gmp, GAP, PARI/GP, etc). All of them are initialized through a unique function `set_random_seed`. As a consequence, all the generators has to be taken from the `current_randstate`.

You can compare

```
sage: set_random_seed(5); [current_randstate().python_random().randint(0,10) for _ in range(5)]
[0, 5, 2, 3, 5]
sage: set_random_seed(5); [current_randstate().python_random().randint(0,10) for _ in range(5)]
[0, 5, 2, 3, 5]
```

versus

```
sage: import random
sage: set_random_seed(5); [random.randint(0,10) for _ in range(5)]
[9, 8, 3, 8, 2]
sage: set_random_seed(5); [random.randint(0,10) for _ in range(5)]
[9, 6, 1, 8, 5]
```



---

Comment by git created at 2017-12-31 13:32:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-12-31 13:57:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-12-31 14:36:03

For consistency, could you make the output of `get_integral_point` an immutable vector

```
sage: P = polytopes.icosahedron()
sage: P.integral_points()[0].is_mutable()
False
sage: P.get_integral_point(0).is_mutable()
True
```

(Just use the method `.set_immutable()` of vectors.)


---

Comment by vdelecroix created at 2017-12-31 14:47:16

Why do you consider the inequality `[-lower] + [0] * i + [1] + [0] * (D - i - 1)`. Shouldn't this be redundant?

I believe that it would be faster to just add one equality at a time (we can possibly speed that up later on). Namely, I would rather keep the polyhedron `self` intersected with `extra_eqns` along the loop. In pseudo code

```
P = self
for i in {0, ..., dimension-1}:
    P_left = P intersection left_guess
    count_left = P_left.count()
    if count_left < index:
        P = P_left
    else:
        P = P intersection right_guess
        index -= count_left
```



---

Comment by mcbell created at 2017-12-31 15:40:36

Replying to [comment:15 vdelecroix]:
> Why do you consider the inequality `[-lower] + [0] * i + [1] + [0] * (D - i - 1)`. Shouldn't this be redundant?
So this was needed precisely because of the fact that previously found inequalities were not added to the polyhedron.

> I believe that it would be faster to just add one equality at a time (we can possibly speed that up later on). Namely, I would rather keep the polyhedron `self` intersected with `extra_eqns` along the loop. In pseudo code
> {{{
> P = self
> for i in {0, ..., dimension-1}:
>     P_left = P intersection left_guess
>     count_left = P_left.count()
>     if count_left < index:
>         P = P_left
>     else:
>         P = P intersection right_guess
>         index -= count_left
> }}}
Sure, that would probably be even faster since the polyhedron will become smaller as the process goes on. I've just finished a new version based on your pseudo-code which repeatedly defines P as the intersection of P with a halfspace. Although of course it includes a while loop to keep doing the subdivisions on the x_i coordinate until it is uniquely determined.


---

Comment by git created at 2017-12-31 15:40:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-01-01 13:35:54

With the current code, you might construct and intersect polyhedra on different base ring. Instead of `Polyhedron(XXX)` it would be better to use

```
S = self.parent()
S(ieqs=[[guess-1] + [0] * i + [-1] + [0] * (D - i - 1)])
```



---

Comment by git created at 2018-01-01 14:36:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-01-02 15:53:44

Apparently, there is a problem with the last commit

```
sage -t --long src/sage/geometry/polyhedron/base.py
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 5332, in sage.geometry.polyhedron.base.Polyhedron_base.get_integral_point
Failed example:
    P.get_integral_point(1)
Expected:
    (0, 0)
Got:
    (0, -1)
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 5340, in sage.geometry.polyhedron.base.Polyhedron_base.get_integral_point
Failed example:
    [Q.get_integral_point(i) for i in range(Q.integral_points_count())] == sorted(Q.integral_points())
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 5408, in sage.geometry.polyhedron.base.Polyhedron_base.random_integral_point
Failed example:
    P.random_integral_point() in P.integral_points()
Expected:
    True
Got:
    False
**********************************************************************
```

The reason is that the syntax is different (I was wrong in [This is the Trac macro *comment:19* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:19-macro))

```
sage: P = Polyhedron(ieqs=[This is the Trac macro *0,1,0,0* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0,1,0,0-macro))
sage: P
A 3-dimensional polyhedron in QQ^3 defined as the convex hull of 1 vertex, 1 ray, 2 lines
sage: PP
Polyhedra in QQ^3
sage: PP(ieqs=[This is the Trac macro *0,1,0,0* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0,1,0,0-macro))   # this is wrong
A 0-dimensional polyhedron in QQ^3 defined as the convex hull of 1 vertex
sage: Vrep = None
sage: Hrep = [This is the Trac macro *[0,1,0,0* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[0,1,0,0-macro), []]
sage: PP(Vrep, Hrep)  # this is right
A 3-dimensional polyhedron in QQ^3 defined as the convex hull of 1 vertex, 1 ray, 2 lines
```



---

Comment by git created at 2018-01-02 16:13:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-01-02 17:34:06

In the description, I would rather use `"Return the ``index``-th integral point."` as `sorted(self.integral_points())[index]` is not very readable. Though you can use the code in the paragraph description below, and more importantly (as you already did) in the examples.

On the other hand, the OUTPUT section is intended to describe the output type (and is not mandatory). As your function is simple enough, I would just remove it. You can merge the paragraph describing the method and the one from the OUTPUT.

After that, I think the branch is good enough for a first version!


---

Comment by git created at 2018-01-02 17:48:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-02 18:54:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-05 01:11:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-01-05 13:12:02

Can you doctest the fact that `**kwds` are passed (for example you can pass a wrong keyword)?


---

Comment by git created at 2018-01-05 16:23:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-01-06 21:07:42

typo in the doc: `it bisects the the upper`


---

Comment by git created at 2018-01-06 21:51:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-01-08 21:08:06

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2018-01-08 21:08:06

let it go


---

Comment by vbraun created at 2018-01-13 19:18:30


```
sage -t --long --warn-long 78.8 src/sage/geometry/polyhedron/base.py
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 5369, in sage.geometry.polyhedron.base.Polyhedron_base.get_integral_point
Failed example:
    Q.get_integral_point(0, explicit_enumeration_threshold=0, triangulation='cddlib')
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.base.Polyhedron_base.get_integral_point[7]>", line 1, in <module>
        Q.get_integral_point(Integer(0), explicit_enumeration_threshold=Integer(0), triangulation='cddlib')
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.py", line 5386, in get_integral_point
        if not 0 <= index < self.integral_points_count(**kwds):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base_QQ.py", line 218, in integral_points_count
        **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/latte.py", line 150, in count
        raise PackageNotFoundError('latte_int')
    PackageNotFoundError: the package 'latte_int' was not found. You can install it by running 'sage -i latte_int' in a shell
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 5371, in sage.geometry.polyhedron.base.Polyhedron_base.get_integral_point
Failed example:
    Q.get_integral_point(0, explicit_enumeration_threshold=0, triangulation='cddlib', foo=True)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: ...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.base.Polyhedron_base.get_integral_point[8]>", line 1, in <module>
        Q.get_integral_point(Integer(0), explicit_enumeration_threshold=Integer(0), triangulation='cddlib', foo=True)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.py", line 5386, in get_integral_point
        if not 0 <= index < self.integral_points_count(**kwds):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base_QQ.py", line 218, in integral_points_count
        **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/latte.py", line 150, in count
        raise PackageNotFoundError('latte_int')
    PackageNotFoundError: the package 'latte_int' was not found. You can install it by running 'sage -i latte_int' in a shell
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 5443, in sage.geometry.polyhedron.base.Polyhedron_base.random_integral_point
Failed example:
    P.random_integral_point(explicit_enumeration_threshold=0, triangulation='cddlib')  # random
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.base.Polyhedron_base.random_integral_point[3]>", line 1, in <module>
        P.random_integral_point(explicit_enumeration_threshold=Integer(0), triangulation='cddlib')  # random
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.py", line 5470, in random_integral_point
        return self.get_integral_point(current_randstate().python_random().randint(0, count-1), **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.py", line 5386, in get_integral_point
        if not 0 <= index < self.integral_points_count(**kwds):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base_QQ.py", line 218, in integral_points_count
        **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/latte.py", line 150, in count
        raise PackageNotFoundError('latte_int')
    PackageNotFoundError: the package 'latte_int' was not found. You can install it by running 'sage -i latte_int' in a shell
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 5445, in sage.geometry.polyhedron.base.Polyhedron_base.random_integral_point
Failed example:
    P.random_integral_point(explicit_enumeration_threshold=0, triangulation='cddlib', foo=7)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: ...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 517, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 920, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.base.Polyhedron_base.random_integral_point[4]>", line 1, in <module>
        P.random_integral_point(explicit_enumeration_threshold=Integer(0), triangulation='cddlib', foo=Integer(7))
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.py", line 5470, in random_integral_point
        return self.get_integral_point(current_randstate().python_random().randint(0, count-1), **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.py", line 5386, in get_integral_point
        if not 0 <= index < self.integral_points_count(**kwds):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base_QQ.py", line 218, in integral_points_count
        **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/interfaces/latte.py", line 150, in count
        raise PackageNotFoundError('latte_int')
    PackageNotFoundError: the package 'latte_int' was not found. You can install it by running 'sage -i latte_int' in a shell
**********************************************************************
2 items had failures:
   2 of  12 in sage.geometry.polyhedron.base.Polyhedron_base.get_integral_point
   2 of  10 in sage.geometry.polyhedron.base.Polyhedron_base.random_integral_point
    [998 tests, 4 failures, 55.73 s]
```



---

Comment by vbraun created at 2018-01-13 19:18:30

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-01-13 22:25:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mcbell created at 2018-01-15 12:29:08

I think this updated version should have the doctests that require latte_int flagged correctly. However to test this I had to go into my install of sage and manually delete /build/pkgs/latte_int and ./local/bin/count. Is there an easier way to (temporarily) uninstall an optional sage package?


---

Comment by tscrim created at 2018-01-15 15:47:33

Right now there is not, but Erik Bray (embray) is currently working on developing this. IIRC he has a post on sage-devel within the past month or so about the progress of this.


---

Comment by tscrim created at 2018-01-15 15:47:33

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-01-18 18:09:14

Resolution: fixed
