# Issue 13766: Fix memory allocation in distances all pairs

archive/issues_013766.json:
```json
{
    "body": "Assignee: jason, ncohen, rlm\n\nCC:  @nathanncohen\n\nWith patch #13875, we have fixed some memory allocation issues. However, some problems are remaining when working on large graphs instances (e.g., 450000 nodes).\nThis patch solves some (if not all) issues.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13970\n\n",
    "created_at": "2013-01-18T21:44:07Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "Fix memory allocation in distances all pairs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13766",
    "user": "https://github.com/dcoudert"
}
```
Assignee: jason, ncohen, rlm

CC:  @nathanncohen

With patch #13875, we have fixed some memory allocation issues. However, some problems are remaining when working on large graphs instances (e.g., 450000 nodes).
This patch solves some (if not all) issues.

Issue created by migration from https://trac.sagemath.org/ticket/13970





---

archive/issue_comments_170595.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-18T21:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170595",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_170596.json:
```json
{
    "body": "My computer should have large enough memory, but:\n\n```\nsage: G = graphs.RandomBarabasiAlbert(46341,2)\nsage: G.distances_distribution()\n---------------------------------------------------------------------------\nOverflowError                             Traceback (most recent call last)\n\n/path-to-sage/sage-5.6.rc0/devel/sage-myclone/<ipython console> in <module>()\n\n/path-to-sage/sage-5.6.rc0/local/lib/python2.7/site-packages/sage/graphs/distances_all_pairs.so in sage.graphs.distances_all_pairs.distances_distribution (sage/graphs/distances_all_pairs.c:7485)()\n\nOverflowError: value too large to convert to int\n```",
    "created_at": "2013-01-18T22:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170596",
    "user": "https://github.com/dcoudert"
}
```

My computer should have large enough memory, but:

```
sage: G = graphs.RandomBarabasiAlbert(46341,2)
sage: G.distances_distribution()
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)

/path-to-sage/sage-5.6.rc0/devel/sage-myclone/<ipython console> in <module>()

/path-to-sage/sage-5.6.rc0/local/lib/python2.7/site-packages/sage/graphs/distances_all_pairs.so in sage.graphs.distances_all_pairs.distances_distribution (sage/graphs/distances_all_pairs.c:7485)()

OverflowError: value too large to convert to int
```



---

archive/issue_comments_170597.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-19T13:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170597",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_170598.json:
```json
{
    "body": "Helloooooooooooo !!!\n\nWell, this patch changes nothing to the result, and removing those `*` divides the memory usage by 4 on my computer, so... Why not ? `:-D`\n\nThaaaaaaaaanks !\n\nNathann",
    "created_at": "2013-01-19T13:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170598",
    "user": "https://github.com/nathanncohen"
}
```

Helloooooooooooo !!!

Well, this patch changes nothing to the result, and removing those `*` divides the memory usage by 4 on my computer, so... Why not ? `:-D`

Thaaaaaaaaanks !

Nathann



---

archive/issue_comments_170599.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-01-20T00:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170599",
    "user": "https://github.com/dcoudert"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_170600.json:
```json
{
    "body": "I have found extra problems in `distances_distribution` and `wiener_index` due to overflows of int. This is now fixed. I'm now able to compute the distances distribution on graphs with 65534 vertices (ok, it takes some time... but it works).\n\nHowever, the function fails for graphs with 65535 vertices. This is due to the `init_short_digraph` method, but I don't know how to patch this.\n\nCan you check this new version.\n\nThanks",
    "created_at": "2013-01-20T00:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170600",
    "user": "https://github.com/dcoudert"
}
```

I have found extra problems in `distances_distribution` and `wiener_index` due to overflows of int. This is now fixed. I'm now able to compute the distances distribution on graphs with 65534 vertices (ok, it takes some time... but it works).

However, the function fails for graphs with 65535 vertices. This is due to the `init_short_digraph` method, but I don't know how to patch this.

Can you check this new version.

Thanks



---

archive/issue_comments_170601.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-20T00:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170601",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_170602.json:
```json
{
    "body": "Hello !\n\n- `sizeof(unsigned anything)` *is* equal to `sizeof(anything)`\n- `for i in range(n):` is totally equivalent to `for 0<= i<n` (http://www.steinertriples.fr/ncohen/a.png)\n- was there a problem with the variable `s` that you remove, even when it is defined as an `uint64_t` ? In the worst situation, `s` could be equal to something around `n^3`, so as `n` is at most `2^16`, this should be sufficient.\n\nNathann",
    "created_at": "2013-01-20T09:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170602",
    "user": "https://github.com/nathanncohen"
}
```

Hello !

- `sizeof(unsigned anything)` *is* equal to `sizeof(anything)`
- `for i in range(n):` is totally equivalent to `for 0<= i<n` (http://www.steinertriples.fr/ncohen/a.png)
- was there a problem with the variable `s` that you remove, even when it is defined as an `uint64_t` ? In the worst situation, `s` could be equal to something around `n^3`, so as `n` is at most `2^16`, this should be sufficient.

Nathann



---

archive/issue_comments_170603.json:
```json
{
    "body": "By the way, what do you mean by \"the function fails\". Does it raise an exception, or is the result that it returns wrong ?\n\nNathann",
    "created_at": "2013-01-20T09:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170603",
    "user": "https://github.com/nathanncohen"
}
```

By the way, what do you mean by "the function fails". Does it raise an exception, or is the result that it returns wrong ?

Nathann



---

archive/issue_comments_170604.json:
```json
{
    "body": "Nathann,\n\n> - `sizeof(unsigned anything)` *is* equal to `sizeof(anything)`\n\n\nSure, but it is better to be consistent: easier to read.\n\n> - `for i in range(n):` is totally equivalent to `for 0<= i<n` (http://www.steinertriples.fr/ncohen/a.png)\n\n\nOK, I can change that\n\n> - was there a problem with the variable `s` that you remove, even when it is defined as an `uint64_t` ? In the worst situation, `s` could be equal to something around `n^3`, so as `n` is at most `2^16`, this should be sufficient.\n\n\nThis is sufficient. I have just been lazy. I will include the type.\n\n> By the way, what do you mean by \"the function fails\". Does it raise an exception, or is the result that it returns wrong ?\n\n\nWith 65534 nodes, the `init_short_digraph` method takes a few seconds. With 65535 nodes, I had to kill the process (after > 1 hour). I don't know yet whats going on. I have to investigate further with some print statements...",
    "created_at": "2013-01-20T09:43:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170604",
    "user": "https://github.com/dcoudert"
}
```

Nathann,

> - `sizeof(unsigned anything)` *is* equal to `sizeof(anything)`


Sure, but it is better to be consistent: easier to read.

> - `for i in range(n):` is totally equivalent to `for 0<= i<n` (http://www.steinertriples.fr/ncohen/a.png)


OK, I can change that

> - was there a problem with the variable `s` that you remove, even when it is defined as an `uint64_t` ? In the worst situation, `s` could be equal to something around `n^3`, so as `n` is at most `2^16`, this should be sufficient.


This is sufficient. I have just been lazy. I will include the type.

> By the way, what do you mean by "the function fails". Does it raise an exception, or is the result that it returns wrong ?


With 65534 nodes, the `init_short_digraph` method takes a few seconds. With 65535 nodes, I had to kill the process (after > 1 hour). I don't know yet whats going on. I have to investigate further with some print statements...



---

archive/issue_comments_170605.json:
```json
{
    "body": "> With 65534 nodes, the `init_short_digraph` method takes a few seconds. With 65535 nodes, I had to kill the process (after > 1 hour). I don't know yet whats going on. I have to investigate further with some print statements...\n\n\nAHahaha. Yeah. I know why : infinite loop `:-P`\nBecause of something like that :\n\n```\ncdef unsigned short i\nfor 0<= i <2^16:\n    pass\n```\n\nAnd of course the loop never ends, for adding 1 to 2^16-1 makes it equal to 0.\n\nShould raise an exception, though `:-P`\n\nNathan",
    "created_at": "2013-01-20T09:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170605",
    "user": "https://github.com/nathanncohen"
}
```

> With 65534 nodes, the `init_short_digraph` method takes a few seconds. With 65535 nodes, I had to kill the process (after > 1 hour). I don't know yet whats going on. I have to investigate further with some print statements...


AHahaha. Yeah. I know why : infinite loop `:-P`
Because of something like that :

```
cdef unsigned short i
for 0<= i <2^16:
    pass
```

And of course the loop never ends, for adding 1 to 2^16-1 makes it equal to 0.

Should raise an exception, though `:-P`

Nathan



---

archive/issue_comments_170606.json:
```json
{
    "body": "Yep. It's because the first test is\n\n```\n    if G.order() > g.n:\n\traise ValueError(\"This structure can handle at most \"+str(<int> g.n)+\" vertices !\")\n```\n\nAnd later there is a\n\n```\n    for i in range(1,g.n+1):\n\tg.neighbors[i] = g.neighbors[i-1] + <int> (cg.out_degree(vertices[i-1]) if isdigraph else G.degree(vertices[i-1]))\n```\n\nActually, using an integer instead of a unsigned short would be sufficient to handle graphs with exactly `2^16` vertices, but I personally believe that the first test should be changed to `if G.order() >= g.n:`. Unless we have a very very very specific reason for creating grap with `2^16` vertices `:-P`\n\nNathann",
    "created_at": "2013-01-20T09:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170606",
    "user": "https://github.com/nathanncohen"
}
```

Yep. It's because the first test is

```
    if G.order() > g.n:
	raise ValueError("This structure can handle at most "+str(<int> g.n)+" vertices !")
```

And later there is a

```
    for i in range(1,g.n+1):
	g.neighbors[i] = g.neighbors[i-1] + <int> (cg.out_degree(vertices[i-1]) if isdigraph else G.degree(vertices[i-1]))
```

Actually, using an integer instead of a unsigned short would be sufficient to handle graphs with exactly `2^16` vertices, but I personally believe that the first test should be changed to `if G.order() >= g.n:`. Unless we have a very very very specific reason for creating grap with `2^16` vertices `:-P`

Nathann



---

archive/issue_comments_170607.json:
```json
{
    "body": "Attachment [trac_13970.patch](tarball://root/attachments/some-uuid/ticket13970/trac_13970.patch) by @dcoudert created at 2013-01-20 12:57:18\n\nI solved the issue using int instead of ushort for indexes inside the `init_short_digraph` method. I can now do:\n\n```\nsage: G = graphs.RandomBarabasiAlbert(65535,2)\nsage: G.distances_distribution()\n{1: 131066/2147385345, 2: 680474/715795115, 3: 6950033/715795115, 4: 152193754/2147385345, 5: 5581714/20451289, 6: 908791864/2147385345, 7: 86464963/429477069, 8: 8886494/429477069, 9: 539641/2147385345, 10: 244/2147385345}\n```\n\nSo now it is working as expected/documented !",
    "created_at": "2013-01-20T12:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170607",
    "user": "https://github.com/dcoudert"
}
```

Attachment [trac_13970.patch](tarball://root/attachments/some-uuid/ticket13970/trac_13970.patch) by @dcoudert created at 2013-01-20 12:57:18

I solved the issue using int instead of ushort for indexes inside the `init_short_digraph` method. I can now do:

```
sage: G = graphs.RandomBarabasiAlbert(65535,2)
sage: G.distances_distribution()
{1: 131066/2147385345, 2: 680474/715795115, 3: 6950033/715795115, 4: 152193754/2147385345, 5: 5581714/20451289, 6: 908791864/2147385345, 7: 86464963/429477069, 8: 8886494/429477069, 9: 539641/2147385345, 10: 244/2147385345}
```

So now it is working as expected/documented !



---

archive/issue_comments_170608.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-20T16:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170608",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_170609.json:
```json
{
    "body": "Well, that works too... But it's not a good time when you are looking for a bug in your code to finally find out that the loop itself is infinite, not what happens inside `:-P`\n\nNathann",
    "created_at": "2013-01-20T16:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170609",
    "user": "https://github.com/nathanncohen"
}
```

Well, that works too... But it's not a good time when you are looking for a bug in your code to finally find out that the loop itself is infinite, not what happens inside `:-P`

Nathann



---

archive/issue_comments_170610.json:
```json
{
    "body": "Thanks for the review. I suspect very little users will go to such large graphs, but at least it is consistent.",
    "created_at": "2013-01-20T16:45:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170610",
    "user": "https://github.com/dcoudert"
}
```

Thanks for the review. I suspect very little users will go to such large graphs, but at least it is consistent.



---

archive/issue_comments_170611.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-21T21:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13766#issuecomment-170611",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_039229.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-21T21:10:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13766",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13766#event-39229"
}
```
