# Issue 13766: Fix memory allocation in distances all pairs

Issue created by migration from Trac.

Original creator: dcoudert

Original creation time: 2013-01-18 21:44:07

Assignee: jason, ncohen, rlm

CC:  ncohen

With patch #13875, we have fixed some memory allocation issues. However, some problems are remaining when working on large graphs instances (e.g., 450000 nodes).
This patch solves some (if not all) issues.


---

Comment by dcoudert created at 2013-01-18 21:48:02

Changing status from new to needs_review.


---

Comment by dcoudert created at 2013-01-18 22:06:09

My computer should have large enough memory, but:

```
sage: G = graphs.RandomBarabasiAlbert(46341,2)
sage: G.distances_distribution()
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)

/path-to-sage/sage-5.6.rc0/devel/sage-myclone/<ipython console> in <module>()

/path-to-sage/sage-5.6.rc0/local/lib/python2.7/site-packages/sage/graphs/distances_all_pairs.so in sage.graphs.distances_all_pairs.distances_distribution (sage/graphs/distances_all_pairs.c:7485)()

OverflowError: value too large to convert to int
```



---

Comment by ncohen created at 2013-01-19 13:45:14

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2013-01-19 13:45:14

Helloooooooooooo !!!

Well, this patch changes nothing to the result, and removing those `*` divides the memory usage by 4 on my computer, so... Why not ? `:-D`

Thaaaaaaaaanks !

Nathann


---

Comment by dcoudert created at 2013-01-20 00:56:09

Changing status from positive_review to needs_work.


---

Comment by dcoudert created at 2013-01-20 00:56:09

I have found extra problems in `distances_distribution` and `wiener_index` due to overflows of int. This is now fixed. I'm now able to compute the distances distribution on graphs with 65534 vertices (ok, it takes some time... but it works).

However, the function fails for graphs with 65535 vertices. This is due to the `init_short_digraph` method, but I don't know how to patch this.

Can you check this new version.

Thanks


---

Comment by dcoudert created at 2013-01-20 00:58:02

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2013-01-20 09:21:09

Hello !

- `sizeof(unsigned anything)` *is* equal to `sizeof(anything)`
- `for i in range(n):` is totally equivalent to `for 0<= i<n` (http://www.steinertriples.fr/ncohen/a.png)
- was there a problem with the variable `s` that you remove, even when it is defined as an `uint64_t` ? In the worst situation, `s` could be equal to something around `n^3`, so as `n` is at most `2^16`, this should be sufficient.

Nathann


---

Comment by ncohen created at 2013-01-20 09:22:02

By the way, what do you mean by "the function fails". Does it raise an exception, or is the result that it returns wrong ?

Nathann


---

Comment by dcoudert created at 2013-01-20 09:43:09

Nathann,

> - `sizeof(unsigned anything)` *is* equal to `sizeof(anything)`

Sure, but it is better to be consistent: easier to read.

> - `for i in range(n):` is totally equivalent to `for 0<= i<n` (http://www.steinertriples.fr/ncohen/a.png)

OK, I can change that

> - was there a problem with the variable `s` that you remove, even when it is defined as an `uint64_t` ? In the worst situation, `s` could be equal to something around `n^3`, so as `n` is at most `2^16`, this should be sufficient.

This is sufficient. I have just been lazy. I will include the type.

> By the way, what do you mean by "the function fails". Does it raise an exception, or is the result that it returns wrong ?

With 65534 nodes, the `init_short_digraph` method takes a few seconds. With 65535 nodes, I had to kill the process (after > 1 hour). I don't know yet whats going on. I have to investigate further with some print statements...


---

Comment by ncohen created at 2013-01-20 09:45:56

> With 65534 nodes, the `init_short_digraph` method takes a few seconds. With 65535 nodes, I had to kill the process (after > 1 hour). I don't know yet whats going on. I have to investigate further with some print statements...

AHahaha. Yeah. I know why : infinite loop `:-P`
Because of something like that :

```
cdef unsigned short i
for 0<= i <2^16:
    pass
```


And of course the loop never ends, for adding 1 to 2^16-1 makes it equal to 0.

Should raise an exception, though `:-P`

Nathan


---

Comment by ncohen created at 2013-01-20 09:51:56

Yep. It's because the first test is

```
    if G.order() > g.n:
	raise ValueError("This structure can handle at most "+str(<int> g.n)+" vertices !")
```


And later there is a

```
    for i in range(1,g.n+1):
	g.neighbors[i] = g.neighbors[i-1] + <int> (cg.out_degree(vertices[i-1]) if isdigraph else G.degree(vertices[i-1]))
```


Actually, using an integer instead of a unsigned short would be sufficient to handle graphs with exactly `2^16` vertices, but I personally believe that the first test should be changed to `if G.order() >= g.n:`. Unless we have a very very very specific reason for creating grap with `2^16` vertices `:-P`

Nathann


---

Attachment

I solved the issue using int instead of ushort for indexes inside the `init_short_digraph` method. I can now do:

```
sage: G = graphs.RandomBarabasiAlbert(65535,2)
sage: G.distances_distribution()
{1: 131066/2147385345, 2: 680474/715795115, 3: 6950033/715795115, 4: 152193754/2147385345, 5: 5581714/20451289, 6: 908791864/2147385345, 7: 86464963/429477069, 8: 8886494/429477069, 9: 539641/2147385345, 10: 244/2147385345}
```


So now it is working as expected/documented !


---

Comment by ncohen created at 2013-01-20 16:42:47

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2013-01-20 16:42:47

Well, that works too... But it's not a good time when you are looking for a bug in your code to finally find out that the loop itself is infinite, not what happens inside `:-P`

Nathann


---

Comment by dcoudert created at 2013-01-20 16:45:36

Thanks for the review. I suspect very little users will go to such large graphs, but at least it is consistent.


---

Comment by jdemeyer created at 2013-01-21 21:10:03

Resolution: fixed
