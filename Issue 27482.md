# Issue 27482: Preparser for file.sage: treat "from __future__ import ..." properly

Issue created by migration from https://trac.sagemath.org/ticket/27719

Original creator: jhpalmieri

Original creation time: 2019-04-25 02:55:59

If a file `file.sage` has a line `from __future__ import ...`, the preparser should put it at the top of the file [where it needs to be](https://docs.python.org/2/reference/simple_stmts.html#future).


---

Comment by jhpalmieri created at 2019-04-25 03:28:55

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-04-25 03:28:55

New commits:


---

Comment by git created at 2019-04-25 03:32:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-04-25 05:09:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by nbruin created at 2019-04-25 05:15:02

- I think in principle a "from __future__ import" directive CAN use parentheses and thus cover multiple lines (I guess they could escape newlines as well to cover multiple lines). I think that's sufficiently rare that we can afford to miss the case, but perhaps we should document that we don't deal with it.

 - It would be quite a bit more efficient if we use a regexp that we can apply on the string as a whole, so that we can avoid splitting the file into lines and concatenating it later. We can then split the string on the index where the statement was found and do surgery that way. Then we only incur string manipulation overhead when we encounter a `__future__`.

 - If we're going to stick with splitting, then do the reordering manipulations on the list of lines and later assemble the string via a `"\n".join(list of lines)`. That's O(n) rather than the O(n^2) you get from repeatedly adding strings.


---

Comment by git created at 2019-04-25 15:58:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-04-25 16:00:19

Here is a different version which searches the whole string instead of splitting, and it does some crude error-checking looking for multi-line `from __future__ import ...` statements. If it finds them, it raises an error. I don't know how to do anything more sophisticated without actually parsing the Python code in the file, and that seems like overkill.


---

Comment by nbruin created at 2019-04-27 02:25:11

Made a tiny update: appending a few items to a list should be quite cheap (extra room should be available). The pythonic way of joining strings together is via "join" (it's faster; not that it matters here)

Let's see what the patchbots say. The previous reports had some failures (perhaps spurious). Otherwise: I'm OK with your changes. If you're OK with mine you can set it to positive on my behalf.
----
New commits:


---

Comment by jhpalmieri created at 2019-04-27 16:46:10

I see the same patchbot doctest errors here as on several other tickets, so they look spurious.


---

Comment by jhpalmieri created at 2019-04-27 16:46:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-04-29 11:50:48

Resolution: fixed


---

Comment by embray created at 2019-06-07 18:33:48

Whew, this looks fine, but we really need to replace this code with a real parser... :(
