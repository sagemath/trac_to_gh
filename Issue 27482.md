# Issue 27482: Preparser for file.sage: treat "from __future__ import ..." properly

archive/issues_027482.json:
```json
{
    "body": "If a file `file.sage` has a line `from __future__ import ...`, the preparser should put it at the top of the file [where it needs to be](https://docs.python.org/2/reference/simple_stmts.html#future).\n\nIssue created by migration from https://trac.sagemath.org/ticket/27719\n\n",
    "created_at": "2019-04-25T02:55:59Z",
    "labels": [
        "misc",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Preparser for file.sage: treat \"from __future__ import ...\" properly",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27482",
    "user": "@jhpalmieri"
}
```
If a file `file.sage` has a line `from __future__ import ...`, the preparser should put it at the top of the file [where it needs to be](https://docs.python.org/2/reference/simple_stmts.html#future).

Issue created by migration from https://trac.sagemath.org/ticket/27719





---

archive/issue_comments_387500.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-25T03:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387500",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_387501.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-04-25T03:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387501",
    "user": "@jhpalmieri"
}
```

New commits:



---

archive/issue_comments_387502.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-25T03:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387502",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_387503.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-25T05:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387503",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_387504.json:
```json
{
    "body": "- I think in principle a \"from __future__ import\" directive CAN use parentheses and thus cover multiple lines (I guess they could escape newlines as well to cover multiple lines). I think that's sufficiently rare that we can afford to miss the case, but perhaps we should document that we don't deal with it.\n\n  - It would be quite a bit more efficient if we use a regexp that we can apply on the string as a whole, so that we can avoid splitting the file into lines and concatenating it later. We can then split the string on the index where the statement was found and do surgery that way. Then we only incur string manipulation overhead when we encounter a `__future__`.\n\n  - If we're going to stick with splitting, then do the reordering manipulations on the list of lines and later assemble the string via a `\"\\n\".join(list of lines)`. That's O(n) rather than the O(n^2) you get from repeatedly adding strings.",
    "created_at": "2019-04-25T05:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387504",
    "user": "@nbruin"
}
```

- I think in principle a "from __future__ import" directive CAN use parentheses and thus cover multiple lines (I guess they could escape newlines as well to cover multiple lines). I think that's sufficiently rare that we can afford to miss the case, but perhaps we should document that we don't deal with it.

  - It would be quite a bit more efficient if we use a regexp that we can apply on the string as a whole, so that we can avoid splitting the file into lines and concatenating it later. We can then split the string on the index where the statement was found and do surgery that way. Then we only incur string manipulation overhead when we encounter a `__future__`.

  - If we're going to stick with splitting, then do the reordering manipulations on the list of lines and later assemble the string via a `"\n".join(list of lines)`. That's O(n) rather than the O(n^2) you get from repeatedly adding strings.



---

archive/issue_comments_387505.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-25T15:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387505",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_387506.json:
```json
{
    "body": "Here is a different version which searches the whole string instead of splitting, and it does some crude error-checking looking for multi-line `from __future__ import ...` statements. If it finds them, it raises an error. I don't know how to do anything more sophisticated without actually parsing the Python code in the file, and that seems like overkill.",
    "created_at": "2019-04-25T16:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387506",
    "user": "@jhpalmieri"
}
```

Here is a different version which searches the whole string instead of splitting, and it does some crude error-checking looking for multi-line `from __future__ import ...` statements. If it finds them, it raises an error. I don't know how to do anything more sophisticated without actually parsing the Python code in the file, and that seems like overkill.



---

archive/issue_comments_387507.json:
```json
{
    "body": "Made a tiny update: appending a few items to a list should be quite cheap (extra room should be available). The pythonic way of joining strings together is via \"join\" (it's faster; not that it matters here)\n\nLet's see what the patchbots say. The previous reports had some failures (perhaps spurious). Otherwise: I'm OK with your changes. If you're OK with mine you can set it to positive on my behalf.\n----\nNew commits:",
    "created_at": "2019-04-27T02:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387507",
    "user": "@nbruin"
}
```

Made a tiny update: appending a few items to a list should be quite cheap (extra room should be available). The pythonic way of joining strings together is via "join" (it's faster; not that it matters here)

Let's see what the patchbots say. The previous reports had some failures (perhaps spurious). Otherwise: I'm OK with your changes. If you're OK with mine you can set it to positive on my behalf.
----
New commits:



---

archive/issue_comments_387508.json:
```json
{
    "body": "I see the same patchbot doctest errors here as on several other tickets, so they look spurious.",
    "created_at": "2019-04-27T16:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387508",
    "user": "@jhpalmieri"
}
```

I see the same patchbot doctest errors here as on several other tickets, so they look spurious.



---

archive/issue_comments_387509.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-27T16:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387509",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_387510.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-29T11:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387510",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_387511.json:
```json
{
    "body": "Whew, this looks fine, but we really need to replace this code with a real parser... :(",
    "created_at": "2019-06-07T18:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27482",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27482#issuecomment-387511",
    "user": "@embray"
}
```

Whew, this looks fine, but we really need to replace this code with a real parser... :(
