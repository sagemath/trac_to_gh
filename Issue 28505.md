# Issue 28505: sage-python incremental build breakage

Issue created by migration from https://trac.sagemath.org/ticket/28742

Original creator: vbraun

Original creation time: 2019-11-15 09:33:28

CC:  jhpalmieri

The `sage` target in src/Makefile can be called if the previous build was incomplete, in particular if six has not been installed. But our setup.py implicitly depends on six:

```
[sagelib-9.0.beta5] cd . && export                                    \
[sagelib-9.0.beta5]     SAGE_ROOT=/doesnotexist                               \
[sagelib-9.0.beta5]     SAGE_SRC=/doesnotexist                                \
[sagelib-9.0.beta5]     SAGE_SRC_ROOT=/doesnotexist                           \
[sagelib-9.0.beta5]     SAGE_DOC_SRC=/doesnotexist                            \
[sagelib-9.0.beta5]     SAGE_BUILD_DIR=/doesnotexist                          \
[sagelib-9.0.beta5]     SAGE_PKGS=/var/lib/buildbot/slave/sage_git/build/build/pkgs                \
[sagelib-9.0.beta5] && sage-python -u setup.py --no-user-cfg build install
[sagelib-9.0.beta5] /var/lib/buildbot/slave/sage_git/build/src/bin/sage-env: line 130: cd: /doesnotexist: No such file or directory
[sagelib-9.0.beta5] Warning: overwriting SAGE_ROOT environment variable:
[sagelib-9.0.beta5] Old SAGE_ROOT=/doesnotexist
[sagelib-9.0.beta5] New SAGE_ROOT=
[sagelib-9.0.beta5] Traceback (most recent call last):
[sagelib-9.0.beta5]   File "setup.py", line 22, in <module>
[sagelib-9.0.beta5]     import fpickle_setup
[sagelib-9.0.beta5]   File "/var/lib/buildbot/slave/sage_git/build/src/fpickle_setup.py", line 8, in <module>
[sagelib-9.0.beta5]     from six.moves import copyreg
[sagelib-9.0.beta5] ModuleNotFoundError: No module named 'six'
[sagelib-9.0.beta5] Makefile:33: recipe for target 'sage' failed
[sagelib-9.0.beta5] make[4]: *** [sage] Error 1
[sagelib-9.0.beta5] make[4]: Leaving directory '/var/lib/buildbot/slave/sage_git/build/src'
```



---

Comment by jhpalmieri created at 2019-11-15 18:19:54

`six` is a dependency for `sagelib`, so how does this happen?


---

Comment by strogdon created at 2019-11-18 01:00:24

I see this now, incremental build from 9.0.beta5 -> 9.0.beta6.

```
[sagelib-9.0.beta6] Traceback (most recent call last):
[sagelib-9.0.beta6]   File "setup.py", line 22, in <module>
[sagelib-9.0.beta6]     import fpickle_setup
[sagelib-9.0.beta6]   File "/64bitdev/storage/sage-git_develop/sage/src/fpickle_setup.py", line 8, in <module>
[sagelib-9.0.beta6]     from six.moves import copyreg
[sagelib-9.0.beta6] ModuleNotFoundError: No module named 'six'
[sagelib-9.0.beta6] make[4]: *** [Makefile:33: sage] Error 1
[sagelib-9.0.beta6] make[4]: Leaving directory '/64bitdev/storage/sage-git_develop/sage/src'
```

I looks like `six` is only installed for `python2.7`


---

Comment by jhpalmieri created at 2019-11-18 01:12:15

Silly question: is this an incremental build which was originally based on Python 2, now trying to use Python 3?


---

Comment by strogdon created at 2019-11-18 01:25:06

Replying to [comment:3 jhpalmieri]:
> Silly question: is this an incremental build which was originally based on Python 2, now trying to use Python 3?
The original build was with Python 2. The failure resulted from

```
git pull
make
```

So I presume it's still Python 2.


---

Comment by strogdon created at 2019-11-18 01:30:31

But maybe with `9.0.beta6` Python 3 is the default.


---

Comment by strogdon created at 2019-11-18 01:49:35

Yes, the post has now appeared on `sage-release`. Python 3 is the default.


---

Comment by jhpalmieri created at 2019-11-18 02:36:18

If the Python version switches in the middle of an incremental upgrade, that's not very graceful, but it will certainly cause problems. Is that what's going on? What does `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` say?


---

Comment by strogdon created at 2019-11-18 03:02:37

Replying to [comment:7 jhpalmieri]:
> If the Python version switches in the middle of an incremental upgrade, that's not very graceful, but it will certainly cause problems. Is that what's going on? What does `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` say?
From sage folder

```
make distclean
make
```

seemed to fix things here. I'm not anxious to continue with Python 2 and with the above Python 3 is being used. It seems a bit severe but perhaps what's needed.


---

Comment by jhpalmieri created at 2019-11-18 03:05:46

I just did a test with similar results: started a Python 2 build with 9.0.beta5, then did `git trac pull develop` and started `make`. Then `./sage --sh -c 'echo $SAGE_PYTHON_VERSION'` reported `3`, which is only going to lead to problems. This is due to #28660, I guess.


---

Comment by jhpalmieri created at 2019-11-18 03:08:02

I just posted this on #28660: in the case of building with Python 2, then merging this ticket and trying to an incremental upgrade, "we should detect the version mismatch and either keep using Python 2 or abort the make process, telling the user what the issue is."


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2020-08-30 19:19:09

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-08-30 19:19:09

This is likely outdated after the removal of python 2 support


---

Comment by jhpalmieri created at 2020-08-31 02:18:47

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-09-16 15:12:02

Resolution: invalid
