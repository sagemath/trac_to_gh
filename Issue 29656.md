# Issue 29656: Another speedup of hypergeometric trace formula

Issue created by migration from https://trac.sagemath.org/ticket/29893

Original creator: kedlaya

Original creation time: 2020-06-18 13:53:31

CC:  roed edgarcosta

Keywords: hypergeometric trace formula

It seems that in earlier tickets meant to speed up the computation of the hypergeometric trace formula (especially #28902), the optimization of using symmetry in the trace formula for `p**f` when `f>1` did not get applied fully. Here we address this.

The status quo:

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp
sage: H = Hyp(cyclotomic=([4,2,2],[3,3]))
sage: time H.padic_H_value(next_prime(4096), 2, 1337)
CPU times: user 47.9 s, sys: 456 ms, total: 48.4 s
Wall time: 48.4 s
-5526
```

This is already beating Magma (v2.24-9):

```
> H := HypergeometricData([4,2,2],[3,3]);
> time HypergeometricTrace(H, 1/1337, 4099^2);
-5526
Time: 84.140
```

But there is still room for improvement. (Restart Sage to suppress cacheing.)

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp
sage: H = Hyp(cyclotomic=([4,2,2],[3,3]))
sage: time H.padic_H_value(next_prime(4096), 2, 1337)
CPU times: user 32.9 s, sys: 1.1 s, total: 34 s
Wall time: 34 s
-5526
```



---

Comment by chapoton created at 2020-06-18 19:05:44

needs review ?
----
New commits:


---

Comment by git created at 2020-06-19 03:49:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2020-06-19 03:55:52

I thought of another improvement: since we only implement parameter values in Q, I can consolidate from `q-1` to `p-1` terms in `hgm_coeffs`. This speeds things up some more:

```
sage: from sage.modular.hypergeometric_motive import HypergeometricData as Hyp
sage: H = Hyp(cyclotomic=([4,2,2],[3,3]))
sage: time H.padic_H_value(next_prime(4096), 2, 1337)
CPU times: user 24 s, sys: 255 ms, total: 24.3 s
Wall time: 24.3 s
-5526
```

As a bonus, cacheing this result takes much less memory.

Let me sleep on this a bit before putting this up for review, to see if I'm missing another easy trick.


---

Comment by chapoton created at 2020-06-19 09:32:55

patchbot complains about a little code style detail :

```
+src/sage/modular/hypergeometric_motive.py:1101:28: E701 multiple statements on one line (colon)
+src/sage/modular/hypergeometric_motive.py:1229:30: E701 multiple statements on one line (colon)
```

so please break those two lines to make it happier


---

Comment by git created at 2020-06-19 13:57:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2020-06-22 12:31:45

needs review now ?


---

Comment by kedlaya created at 2020-06-23 00:09:48

Changing status from new to needs_review.


---

Comment by kedlaya created at 2020-06-23 00:09:48

Let's go ahead and advance this to the review stage. Apparently there is some room for improvement on the side of computing the p-adic Gamma function, but that can be a separate ticket later.


---

Comment by chapoton created at 2020-06-23 06:55:08

ok, let it be


---

Comment by chapoton created at 2020-06-23 06:55:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-06-27 10:16:26

Merge conflict


---

Comment by vbraun created at 2020-06-27 10:16:26

Changing status from positive_review to needs_work.


---

Comment by kedlaya created at 2020-06-27 15:40:14

My fault, I should have merged #29778 into this branch. Rebase coming up...


---

Comment by kedlaya created at 2020-06-27 15:40:54

New commits:


---

Comment by kedlaya created at 2020-06-27 15:40:54

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2020-06-27 17:34:28

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-06-27 17:34:28

ok, green bot, and back to positive


---

Comment by vbraun created at 2020-07-08 19:34:05

Resolution: fixed
