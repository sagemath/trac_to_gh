# Issue 18009: remove __hash__ from SageObject

Issue created by migration from https://trac.sagemath.org/ticket/18246

Original creator: vdelecroix

Original creation time: 2015-04-18 10:44:24

CC:  ncohen




---

Comment by vdelecroix created at 2015-04-18 11:00:21

New commits:


---

Comment by ncohen created at 2015-04-18 12:31:18


```
sage: hash(SageObject())
8751828132417
```


I am fixing it.


---

Comment by ncohen created at 2015-04-18 12:34:59

As expected everything breaks. What do we do?


---

Comment by git created at 2015-04-18 12:35:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-18 12:56:16

You should raise a `TypeError` if you want to raise something. Otherwise it breaks too much stuff (in particular `cached_method`, `cached_function`)


---

Comment by ncohen created at 2015-04-18 12:59:54

`TypeError` ? Well, why not...


---

Comment by git created at 2015-04-18 13:01:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-04-18 13:26:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-18 13:27:38

Most of the time, it is very easy to fix. But I had to implement a lot

```
def __hash__(self):
    return id(self)
```

which I guess is close from the default Python implementation.


---

Comment by git created at 2015-08-12 15:59:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-12 16:02:23

Let us see how much patchbot is happy...


---

Comment by git created at 2015-08-12 17:17:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-12 17:17:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-12 17:18:12

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-08-12 18:50:34

lgtm but seems to have some test failures on the patchbot


---

Comment by vdelecroix created at 2015-08-12 18:51:32

Yep. Some object have random hash because it relies on their `id`... will fix that soonly.


---

Comment by git created at 2015-08-12 18:53:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-08-12 20:12:58

The failing doctest in `bibd.py` is a separate issue, see #19020 (but I was not able to reproduce it!).


---

Comment by vbraun created at 2015-08-12 21:58:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-08-13 08:17:10

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-08-13 08:17:10

http://build.sagemath.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/49/steps/shell_4/logs/stdio


---

Comment by git created at 2015-08-13 10:25:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-08-13 10:26:40


```
def __hash__(self):
    return id(self)
```

was a very bad idea of mine.

It is now as clean as possible... I hope.


---

Comment by vdelecroix created at 2015-08-13 10:26:40

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-08-13 12:37:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-08-13 16:40:04

Oups. I duplicated `sage.misc.fast_method.WithEqualityById`...


---

Comment by vdelecroix created at 2015-08-13 16:40:04

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-08-13 17:27:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-08-13 17:30:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-13 17:31:22

I used `WithEqualityById` instead. But the place `misc.fast_methods` does not look very appropriate for it.


---

Comment by vdelecroix created at 2015-08-13 17:31:22

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-08-13 17:32:16

the name `misc.fast_methods` does not look very appropriate *for a module*.


---

Comment by git created at 2015-08-13 19:04:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-14 09:16:14

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by vdelecroix created at 2015-08-14 09:16:47

rebased on sage-6.9.beta2 + fix one failing doctest


---

Comment by git created at 2015-08-14 11:26:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-08-14 17:12:03

green light :-)


---

Comment by vbraun created at 2015-08-14 22:39:24

Resolution: fixed


---

Comment by vbraun created at 2015-08-20 20:34:43

Resolution changed from fixed to 


---

Comment by vbraun created at 2015-08-20 20:34:43

Changing status from closed to new.


---

Comment by vbraun created at 2015-08-20 20:34:43

Fails on ARM

```
sage -t --long src/sage/combinat/rigged_configurations/rigged_configurations.py
**********************************************************************
File "src/sage/combinat/rigged_configurations/rigged_configurations.py", line 252, in sage.combinat.rigged_configurations.rigged_configurations.RiggedConfigurations
Failed example:
    RC.list()
Expected:
    [
    <BLANKLINE>
                                             0[ ]0
    (/)  (/)      (/)      -1[ ]-1  -1[ ]-1
                                             -1[ ]-1
    (/)  -1[ ]-1  0[ ]0    0[ ]0    1[ ]1    -1[ ]-1
    <BLANKLINE>
    (/)  (/)      -1[ ]-1  (/)      -1[ ]-1  0[ ]0
       ,        ,        ,        ,        ,
    ]
Got:
    [
    <BLANKLINE>
                                             0[ ]0  
    (/)  (/)      -1[ ]-1  -1[ ]-1  (/)             
                                             -1[ ]-1
    (/)  -1[ ]-1  0[ ]0    1[ ]1    0[ ]0    -1[ ]-1
    <BLANKLINE>
    (/)  (/)      (/)      -1[ ]-1  -1[ ]-1  0[ ]0  
       ,        ,        ,        ,        ,        
    ]
**********************************************************************
1 item had failures:
   1 of  38 in sage.combinat.rigged_configurations.rigged_configurations.RiggedConfigurations
    [239 tests, 1 failure, 250.36 s]
```



---

Comment by vbraun created at 2015-08-20 20:35:58

Last 10 new commits:


---

Comment by tscrim created at 2015-08-20 21:56:26

I actually don't like these changes:

```diff
-class VectorPartitions(Parent, UniqueRepresentation):
+class VectorPartitions(UniqueRepresentation, Parent):
```

Why does `UniqueRepresentation` have to come before `Parent`? If this how things must be, then we should create a class `URParent` (or a better name), use that all over Sage to avoid this issue. (FYI: Before this ticket, there are 107 classes which use `UR, Parent` and 107 which use `Parent, UR`.)

Also can someone explain to me why are `RiggedConfigurations` now showing machine dependent iteration order?


---

Comment by nbruin created at 2015-08-20 23:47:15

Replying to [comment:39 tscrim]:
> I actually don't like these changes:
> {{{#!diff
> -class VectorPartitions(Parent, UniqueRepresentation):
> +class VectorPartitions(UniqueRepresentation, Parent):
> }}}
> Why does `UniqueRepresentation` have to come before `Parent`?

Because `UniqueRepresentation` provides a hash that is fast and appropriate and `Parent` doesn't:

```
sage: Parent.__hash__
<slot wrapper '__hash__' of 'sage.structure.category_object.CategoryObject' objects>
sage: UniqueRepresentation.__hash__
<slot wrapper '__hash__' of 'sage.misc.fast_methods.WithEqualityById' objects>
```

In order to get the MRO right, `UniqueRepresentation` needs to appear before Parent:

```
sage: class A(UniqueRepresentation, Parent): pass
sage: A.__hash__
<slot wrapper '__hash__' of 'sage.misc.fast_methods.WithEqualityById' objects>
sage: class B(Parent, UniqueRepresentation): pass
sage: B.__hash__
<slot wrapper '__hash__' of 'sage.structure.category_object.CategoryObject' objects>
```


Once all default hashes have been deleted and no classes in the MRO of Parent offer a hash function, the order doesn't matter. Until then, `UniqueRepresentation` has to come first.

> Also can someone explain to me why are `RiggedConfigurations` now showing machine dependent iteration order?

The code is hard to follow, but in general, if enumeration somewhere involves a set or a dictionary, then results depend heavily on the hash used and the order in which the dictionary was constructed. I'd expect that a changed hash causes things to be enumerated in a different order (because a set or dict is storing its entries in a different order somewhere)


---

Comment by vdelecroix created at 2015-09-04 00:21:41

Changing status from new to needs_review.


---

Comment by nbruin created at 2015-09-04 06:35:01

Changing status from needs_review to positive_review.


---

Comment by nbruin created at 2015-09-04 06:35:01

Looks good, tests pass, very desirable change. Thanks!


---

Comment by vbraun created at 2015-09-04 23:52:18

Resolution: fixed


---

Comment by vbraun created at 2015-09-06 21:01:44

Resolution changed from fixed to 


---

Comment by vbraun created at 2015-09-06 21:01:44

Changing status from closed to new.


---

Comment by vbraun created at 2015-09-06 21:01:44

More random test failures:

```
sage -t --long src/sage/combinat/rigged_configurations/rigged_configurations.py
**********************************************************************
File "src/sage/combinat/rigged_configurations/rigged_configurations.py", line 252, in sage.combinat.rigged_configurations.rigged_configurations.RiggedConfigurations
Failed example:
    RC.list()
Expected:
    [
    <BLANKLINE>
                                             0[ ]0
    (/)  (/)      (/)      -1[ ]-1  -1[ ]-1
                                             -1[ ]-1
    (/)  -1[ ]-1  0[ ]0    0[ ]0    1[ ]1    -1[ ]-1
    <BLANKLINE>
    (/)  (/)      -1[ ]-1  (/)      -1[ ]-1  0[ ]0
       ,        ,        ,        ,        ,
    ]
Got:
    [
    <BLANKLINE>
                                             0[ ]0  
    (/)  (/)      -1[ ]-1  -1[ ]-1  (/)             
                                             -1[ ]-1
    (/)  -1[ ]-1  0[ ]0    1[ ]1    0[ ]0    -1[ ]-1
    <BLANKLINE>
    (/)  (/)      (/)      -1[ ]-1  -1[ ]-1  0[ ]0  
       ,        ,        ,        ,        ,        
    ]
**********************************************************************
1 item had failures:
   1 of  38 in sage.combinat.rigged_configurations.rigged_configurations.RiggedConfigurations
    [239 tests, 1 failure, 99.45 s]
```



---

Comment by git created at 2015-09-06 21:49:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-06 21:49:59

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-09-06 21:50:06

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-09-06 21:50:25

Hoping this is the only failure...


---

Comment by vbraun created at 2015-09-07 17:12:51

Resolution: fixed
