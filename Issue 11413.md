# Issue 11413: Make deprecated_function_alias print the whole module path when it differs from the original

Issue created by migration from https://trac.sagemath.org/ticket/11585

Original creator: defeo

Original creation time: 2011-07-11 05:38:20

Assignee: jason

CC:  hivert

Keywords: deprecation

Currently


```
sage: from sage.misc.misc import deprecated_function_alias
sage: a = deprecated_function_alias(sqrt, "Version ?")
sage: a(5)
...
DeprecationWarning: (Since Version ?) a is deprecated. Please use sqrt instead.
sqrt(5)
```


which is misleading because the user would expect to find `sqrt` in the same module as `a`.

With this patch


```
sage: from sage.misc.misc import deprecated_function_alias
sage: a = deprecated_function_alias(sqrt, "Version ?")
sage: a(5)
...
DeprecationWarning: (Since Version ?) a is deprecated. Please use sage.functions.other.sqrt instead.
sqrt(5)
```


There's no change in deprecating methods.


---

Attachment


---

Comment by defeo created at 2011-07-11 17:06:04

Changing status from new to needs_review.


---

Comment by rbeezer created at 2011-07-11 20:24:31

Looks good.  Passes long tests on 4.7.1.alpha3.  I've cc'ed Florent Hivert in case he wants to add anything.  I've also added an "Apply" section to the description for the release manager.

Two minor formatting items need attention.


Line 2287: `Trac #11585::`

You need a blank line after the double-colon to make the verbatim text format properly.

You can test documentation via  `sage -docbuild reference html` after a fresh build (`sage -b`) and then viewing the resulting HTML file.


Line 2299:


```
if module is None: module_name = '__main__'
else: module_name = module.__name__
```


should be formatted as


```
if module is None:
    module_name = '__main__'
else:
    module_name = module.__name__
```


See http://www.sagemath.org/doc/developer/conventions.html

which references:  http://www.python.org/dev/peps/pep-0008/

(look shortly after "Compound statements")


---

Comment by rbeezer created at 2011-07-11 20:24:31

Changing status from needs_review to needs_work.


---

Comment by defeo created at 2011-07-11 20:59:58

Changing status from needs_work to needs_review.


---

Attachment

Modified as requested by rbeezer. Apply second patch only (sorry for the mispelling in the first patch).


---

Comment by rbeezer created at 2011-07-11 21:37:02

Luca,

Looks good - thanks for the improvement.

I am going to switch this to positive review, but Florent Hivert should feel free to get in on this just in case he sees something.

Rob


---

Comment by rbeezer created at 2011-07-11 21:37:02

Changing status from needs_review to positive_review.


---

Comment by hivert created at 2011-07-13 08:33:08

I've no particular comments concerning this patch. We should start to actually remove deprecated things from sage, but this is another problem. Ready to go.

Florent


---

Comment by jdemeyer created at 2011-07-28 10:56:17

This needs to be rebased to sage-4.7.1.rc1


---

Comment by jdemeyer created at 2011-07-28 10:56:17

Changing status from positive_review to needs_work.


---

Comment by defeo created at 2011-07-28 23:57:15

Rebased against rc1


---

Comment by defeo created at 2011-07-28 23:58:06

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by hivert created at 2011-07-29 07:19:20

Changing status from needs_review to positive_review.


---

Comment by hivert created at 2011-07-29 07:19:20

If you just rebased the patch, you are allowed to put a positive review yourself. Anyway, I made a short re-review and found it Ok.

Florent


---

Comment by jdemeyer created at 2011-08-03 14:38:15

Resolution: fixed


---

Comment by jdemeyer created at 2011-08-17 12:31:59

This patch greatly increases the Sage startup time.  On `sage.math.washington.edu`, before the patch it is roughly 1.4s and after the patch 2.2s.


---

Comment by jdemeyer created at 2011-08-17 12:31:59

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-08-17 12:31:59

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-08-17 12:32:57

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-08-17 12:33:07

Changing status from needs_review to needs_work.


---

Comment by defeo created at 2011-08-17 21:58:44

Ouch! This single line is responsible for it:


```
module = inspect.getmodule(inspect.stack()[1][0])
```


In fact, there's about 40 calls to `deprecated_function_alias` in 4.7.1.rc2; on my laptop:


```
sage: import inspect
sage: timeit('inspect.stack()[1][0]')
25 loops, best of 3: 18.4 ms per loop
```


The fact is, I don't know how to obtain the name of the module where the call to `deprecated_function_alias` happened without inspecting the stack. Any ideas?


---

Comment by hivert created at 2012-03-15 12:05:23

> The fact is, I don't know how to obtain the name of the module where the call to `deprecated_function_alias` happened without inspecting the stack. Any ideas?

I don't have to investigate further now but I think you don't need the full stack but only the top of it. Using 

```
inspect.getframeinfo(sys._getframe(1),1)
```

should be much faster...


---

Comment by hivert created at 2012-03-15 13:25:37

Here is what I think is a good solution `inspect.currentframe(1)` does the
same as `inspect.stack()[1][0]` only 400 time faster:

```
sage: import inspect
sage: inspect.getmodule(inspect.stack()[1][0]) == inspect.getmodule(inspect.currentframe(1))
True
sage: timeit('inspect.getmodule(inspect.stack()[1][0])')
25 loops, best of 3: 15.6 ms per loop
sage: timeit('inspect.getmodule(inspect.currentframe(1))')
625 loops, best of 3: 40.7 Âµs per loop
```

I'm updating the patch accordingly.

Florent


---

Comment by hivert created at 2012-03-15 13:25:37

Remove assignee jason.


---

Comment by hivert created at 2012-03-15 13:39:18

Unfortunately, the problem is not with the stack:

Before any patch:

```
sage.all: 0.987 (None)
```

After the rc1 patch

```
sage.all: 1.805 (None)
```

After the rc2 patch

```
sage.all: 1.692 (None)
```

It's better but still too much.

Florent


---

Comment by hivert created at 2012-03-15 14:00:35

Got it !!! We don't need the module but only its name. One can get it using the filename of the code which is currently executed. Here is the diff

```diff
diff --git a/sage/misc/misc.py b/sage/misc/misc.py
--- a/sage/misc/misc.py
+++ b/sage/misc/misc.py
@@ -2387,11 +2387,10 @@ def deprecated_function_alias(func, vers
      - Florent Hivert (2009-11-23), with the help of Mike Hansen.
      - Luca De Feo (2011-07-11), printing the full module path when different from old path
     """
-    module = inspect.getmodule(inspect.currentframe(1))
-    if module is None:
+    module_name = inspect.getmodulename(
+        inspect.currentframe(1).f_code.co_filename)
+    if module_name is None:
         module_name = '__main__'
-    else:
-        module_name = module.__name__
     return DeprecatedFunctionAlias(func, version, module_name)
```


The new startup time is ok !

```
sage.all: 0.962 (None)
```


Please review.

Florent


---

Attachment


---

Comment by hivert created at 2012-03-15 14:03:39

Changing status from needs_work to needs_review.


---

Comment by hivert created at 2012-03-15 14:03:53

Set assignee to hivert.


---

Comment by defeo created at 2012-03-16 00:17:27

Thanks for sorting this out, Florent.

I tried it: it solves the startup issue and all tests pass. Can I give positive review, or shall we ask someone else to review it?

Luca


---

Comment by hivert created at 2012-03-16 07:53:28

> I tried it: it solves the startup issue and all tests pass. Can I give positive review, or shall we ask someone else to review it?

Sure you can. Your code has already been reviewed twice so it is Ok to go. Given that, only my change has to be reviewed, it could be done by person which is not me. I think you are the perfect person to do that. So please set the positive review if you think my change is Ok.


---

Comment by defeo created at 2012-03-16 09:27:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-23 15:19:12

Resolution: fixed
