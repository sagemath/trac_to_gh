# Issue 12108: Incorrect kernel of integer matrix (IML bug?)

archive/issues_012108.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  @williamstein @JohnCremona @nbruin\n\nKeywords: IML kernel 76\n\nThis bug happens with matrices with 76 columns (but not 75) whose entries are random integers -1 or 1. The actual entries matter, but the following random choice is quite reliable at triggering it:\n\n```\nsage: M = matrix(ZZ, 10,76,lambda i,j: randrange(-1,3,2))                                                                                                                                                        \nsage: M.right_kernel().basis()[-1].is_zero()\nTrue\n```\n\nNote that a basis vector of the null space should never be zero, so the correct output is always ``False``.\n\nFor reference, here is a 6 x 76 matrix that triggers the bug:\n\n```\nM = matrix(ZZ, \n[(1, -1, -1, -1, 1, 1), (-1, -1, 1, -1, 1, -1), (1, 1, 1, -1, 1, -1), \n (-1, 1, 1, 1, -1, -1), (1, -1, 1, -1, -1, -1), (1, -1, 1, 1, 1, 1), \n (-1, -1, 1, -1, 1, -1), (-1, 1, -1, -1, -1, -1), (1, -1, 1, 1, -1, -1), \n (-1, 1, -1, 1, 1, 1), (1, -1, -1, -1, -1, 1), (1, -1, 1, 1, -1, -1), \n (-1, -1, -1, -1, 1, -1), (1, 1, -1, 1, -1, 1), (-1, 1, -1, 1, 1, -1),\n (1, -1, 1, 1, 1, 1), (-1, -1, 1, 1, -1, -1), (1, -1, 1, 1, -1, -1), \n (1, -1, 1, 1, -1, 1), (-1, -1, 1, -1, -1, 1), (1, -1, -1, 1, -1, -1), \n (1, -1, 1, 1, 1, -1), (-1, 1, 1, -1, 1, -1), (1, -1, -1, 1, -1, -1), \n (-1, -1, 1, -1, -1, -1), (1, 1, -1, 1, 1, -1), (1, 1, -1, 1, 1, -1), \n (1, 1, 1, -1, 1, -1), (-1, 1, -1, -1, 1, -1), (-1, -1, -1, 1, -1, 1),\n (1, -1, -1, 1, 1, -1), (-1, 1, 1, -1, 1, 1), (-1, 1, 1, 1, 1, -1), \n (1, -1, -1, 1, -1, -1), (-1, 1, 1, -1, 1, -1), (-1, 1, -1, -1, 1, 1),\n (-1, 1, -1, -1, 1, -1), (-1, 1, -1, 1, -1, -1), (-1, -1, 1, -1, -1, -1),\n (-1, -1, 1, 1, -1, -1), (1, -1, -1, 1, 1, -1), (1, -1, 1, -1, -1, 1), \n (-1, 1, 1, -1, -1, 1), (-1, -1, -1, 1, -1, -1), (-1, 1, 1, 1, 1, 1),  \n (-1, 1, 1, 1, -1, -1), (-1, 1, 1, 1, -1, -1), (1, -1, -1, 1, -1, 1), \n (1, 1, -1, -1, -1, 1), (-1, 1, -1, -1, 1, -1), (-1, -1, 1, 1, 1, 1), \n (-1, -1, -1, 1, 1, 1), (1, -1, 1, 1, -1, 1), (1, -1, 1, 1, 1, 1), \n (1, -1, 1, 1, -1, -1), (1, -1, -1, -1, -1, 1), (1, -1, -1, 1, -1, 1),\n (-1, 1, -1, 1, -1, -1), (1, -1, -1, 1, 1, -1), (1, -1, 1, -1, -1, 1),\n (-1, -1, -1, 1, -1, 1), (-1, -1, 1, -1, -1, 1), (1, 1, -1, -1, -1, -1),\n (1, 1, 1, 1, -1, -1), (1, 1, -1, 1, 1, -1), (-1, -1, 1, 1, -1, 1), \n (1, 1, 1, 1, 1, 1), (-1, 1, 1, 1, 1, 1), (1, 1, 1, -1, 1, 1), \n (1, 1, 1, 1, -1, 1), (1, -1, -1, 1, 1, -1), (1, -1, -1, -1, -1, -1), \n (1, 1, 1, -1, -1, 1), (-1, 1, -1, 1, 1, 1), (1, 1, 1, -1, -1, -1), \n (1, -1, 1, 1, 1, 1)]\n).transpose()\n```\n\nThe bug comes from `algorithm='padic'`, using Pari gives the correct result::\n\n```\nsage: matrix(ZZ,M)._right_kernel_matrix(algorithm='padic')  # bad  \n('computed-iml-int', 76 x 76 dense matrix over Integer Ring)\nsage: matrix(ZZ,M)._right_kernel_matrix(algorithm='pari')  # good\n('computed-pari-int', 70 x 76 dense matrix over Integer Ring)\n```\n\nConclusion: this seems to be an IML bug with threshold matrix size 76.\n\nNote that Pari is actually faster than IML for this particular matrix:\n\n```\nsage: timeit(\"matrix(ZZ,M)._right_kernel_matrix(algorithm='padic')\")\n5 loops, best of 3: 495 ms per loop\nsage: timeit(\"matrix(ZZ,M)._right_kernel_matrix(algorithm='pari')\")                          \n25 loops, best of 3: 30.9 ms per loop\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12280\n\n",
    "created_at": "2012-01-09T00:35:53Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Incorrect kernel of integer matrix (IML bug?)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12108",
    "user": "https://github.com/vbraun"
}
```
Assignee: jason, was

CC:  @williamstein @JohnCremona @nbruin

Keywords: IML kernel 76

This bug happens with matrices with 76 columns (but not 75) whose entries are random integers -1 or 1. The actual entries matter, but the following random choice is quite reliable at triggering it:

```
sage: M = matrix(ZZ, 10,76,lambda i,j: randrange(-1,3,2))                                                                                                                                                        
sage: M.right_kernel().basis()[-1].is_zero()
True
```

Note that a basis vector of the null space should never be zero, so the correct output is always ``False``.

For reference, here is a 6 x 76 matrix that triggers the bug:

```
M = matrix(ZZ, 
[(1, -1, -1, -1, 1, 1), (-1, -1, 1, -1, 1, -1), (1, 1, 1, -1, 1, -1), 
 (-1, 1, 1, 1, -1, -1), (1, -1, 1, -1, -1, -1), (1, -1, 1, 1, 1, 1), 
 (-1, -1, 1, -1, 1, -1), (-1, 1, -1, -1, -1, -1), (1, -1, 1, 1, -1, -1), 
 (-1, 1, -1, 1, 1, 1), (1, -1, -1, -1, -1, 1), (1, -1, 1, 1, -1, -1), 
 (-1, -1, -1, -1, 1, -1), (1, 1, -1, 1, -1, 1), (-1, 1, -1, 1, 1, -1),
 (1, -1, 1, 1, 1, 1), (-1, -1, 1, 1, -1, -1), (1, -1, 1, 1, -1, -1), 
 (1, -1, 1, 1, -1, 1), (-1, -1, 1, -1, -1, 1), (1, -1, -1, 1, -1, -1), 
 (1, -1, 1, 1, 1, -1), (-1, 1, 1, -1, 1, -1), (1, -1, -1, 1, -1, -1), 
 (-1, -1, 1, -1, -1, -1), (1, 1, -1, 1, 1, -1), (1, 1, -1, 1, 1, -1), 
 (1, 1, 1, -1, 1, -1), (-1, 1, -1, -1, 1, -1), (-1, -1, -1, 1, -1, 1),
 (1, -1, -1, 1, 1, -1), (-1, 1, 1, -1, 1, 1), (-1, 1, 1, 1, 1, -1), 
 (1, -1, -1, 1, -1, -1), (-1, 1, 1, -1, 1, -1), (-1, 1, -1, -1, 1, 1),
 (-1, 1, -1, -1, 1, -1), (-1, 1, -1, 1, -1, -1), (-1, -1, 1, -1, -1, -1),
 (-1, -1, 1, 1, -1, -1), (1, -1, -1, 1, 1, -1), (1, -1, 1, -1, -1, 1), 
 (-1, 1, 1, -1, -1, 1), (-1, -1, -1, 1, -1, -1), (-1, 1, 1, 1, 1, 1),  
 (-1, 1, 1, 1, -1, -1), (-1, 1, 1, 1, -1, -1), (1, -1, -1, 1, -1, 1), 
 (1, 1, -1, -1, -1, 1), (-1, 1, -1, -1, 1, -1), (-1, -1, 1, 1, 1, 1), 
 (-1, -1, -1, 1, 1, 1), (1, -1, 1, 1, -1, 1), (1, -1, 1, 1, 1, 1), 
 (1, -1, 1, 1, -1, -1), (1, -1, -1, -1, -1, 1), (1, -1, -1, 1, -1, 1),
 (-1, 1, -1, 1, -1, -1), (1, -1, -1, 1, 1, -1), (1, -1, 1, -1, -1, 1),
 (-1, -1, -1, 1, -1, 1), (-1, -1, 1, -1, -1, 1), (1, 1, -1, -1, -1, -1),
 (1, 1, 1, 1, -1, -1), (1, 1, -1, 1, 1, -1), (-1, -1, 1, 1, -1, 1), 
 (1, 1, 1, 1, 1, 1), (-1, 1, 1, 1, 1, 1), (1, 1, 1, -1, 1, 1), 
 (1, 1, 1, 1, -1, 1), (1, -1, -1, 1, 1, -1), (1, -1, -1, -1, -1, -1), 
 (1, 1, 1, -1, -1, 1), (-1, 1, -1, 1, 1, 1), (1, 1, 1, -1, -1, -1), 
 (1, -1, 1, 1, 1, 1)]
).transpose()
```

The bug comes from `algorithm='padic'`, using Pari gives the correct result::

```
sage: matrix(ZZ,M)._right_kernel_matrix(algorithm='padic')  # bad  
('computed-iml-int', 76 x 76 dense matrix over Integer Ring)
sage: matrix(ZZ,M)._right_kernel_matrix(algorithm='pari')  # good
('computed-pari-int', 70 x 76 dense matrix over Integer Ring)
```

Conclusion: this seems to be an IML bug with threshold matrix size 76.

Note that Pari is actually faster than IML for this particular matrix:

```
sage: timeit("matrix(ZZ,M)._right_kernel_matrix(algorithm='padic')")
5 loops, best of 3: 495 ms per loop
sage: timeit("matrix(ZZ,M)._right_kernel_matrix(algorithm='pari')")                          
25 loops, best of 3: 30.9 ms per loop
```


Issue created by migration from https://trac.sagemath.org/ticket/12280





---

archive/issue_comments_140126.json:
```json
{
    "body": "I built a new iml-1.0.3 spkg but it does not fix the issue.",
    "created_at": "2012-01-09T01:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140126",
    "user": "https://github.com/vbraun"
}
```

I built a new iml-1.0.3 spkg but it does not fix the issue.



---

archive/issue_comments_140127.json:
```json
{
    "body": "Changing keywords from \"IML kernel 76\" to \"saturation\".",
    "created_at": "2012-01-09T01:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140127",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "IML kernel 76" to "saturation".



---

archive/issue_comments_140128.json:
```json
{
    "body": "I was off-track; IML computes the correct kernel but Sage then returns its saturation. It turns out that computing the saturation introduces the extra null vectors\n\n```\nsage: K = M._rational_kernel_iml().transpose();  K\n70 x 76 dense matrix over Integer Ring (type 'print K.str()' to see all of the entries)\nsage: K.saturation()\n76 x 76 dense matrix over Integer Ring\nsage: K.saturation().row(71).is_zero()\nTrue\n```\n",
    "created_at": "2012-01-09T01:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140128",
    "user": "https://github.com/vbraun"
}
```

I was off-track; IML computes the correct kernel but Sage then returns its saturation. It turns out that computing the saturation introduces the extra null vectors

```
sage: K = M._rational_kernel_iml().transpose();  K
70 x 76 dense matrix over Integer Ring (type 'print K.str()' to see all of the entries)
sage: K.saturation()
76 x 76 dense matrix over Integer Ring
sage: K.saturation().row(71).is_zero()
True
```




---

archive/issue_comments_140129.json:
```json
{
    "body": "Changing keywords from \"saturation\" to \"hnf echelon_form\".",
    "created_at": "2012-01-09T03:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140129",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "saturation" to "hnf echelon_form".



---

archive/issue_comments_140130.json:
```json
{
    "body": "75 is the cutoff where the hnf computation switches from ``algorithm='pari'`` to `algorithm='padic'``. The latter does not always chop off zero rows:\n\n```\nsage: m = matrix([(-2, 1, 9, 2, -8, 1, -3, -1, -4, -1), \n...               (5, -2, 0, 1, 0, 4, -1, 1, -2, 0),\n...               (-11, 3, 1, 0, -3, -2, -1, -11, 2, -2), \n...               (-1, 1, -1, -2, 1, -1, -1, -1, -1, 7), \n...               (-2, -1, -1, 1, 1, -2, 1, 0, 2, -4)]).stack(\n...               200 * identity_matrix(ZZ, 10))\nsage: matrix(ZZ,m).hermite_form(algorithm='padic', include_zero_rows=False)\n[  1   0   2   0  13   5   1 166  72  69]\n[  0   1   1   0  20   4  15 195  65 190]\n[  0   0   4   0  24   5  23  22  51 123]\n[  0   0   0   1  23   7  20 105  60 151]\n[  0   0   0   0  40   4   0  80  36  68]\n[  0   0   0   0   0  10   0 100 190 170]\n[  0   0   0   0   0   0  25   0 100 150]\n[  0   0   0   0   0   0   0 200   0   0]\n[  0   0   0   0   0   0   0   0 200   0]\n[  0   0   0   0   0   0   0   0   0 200]\n[  0   0   0   0   0   0   0   0   0   0]\n[  0   0   0   0   0   0   0   0   0   0]\n[  0   0   0   0   0   0   0   0   0   0]\n[  0   0   0   0   0   0   0   0   0   0]\n[  0   0   0   0   0   0   0   0   0   0]\n```\n",
    "created_at": "2012-01-09T03:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140130",
    "user": "https://github.com/vbraun"
}
```

75 is the cutoff where the hnf computation switches from ``algorithm='pari'`` to `algorithm='padic'``. The latter does not always chop off zero rows:

```
sage: m = matrix([(-2, 1, 9, 2, -8, 1, -3, -1, -4, -1), 
...               (5, -2, 0, 1, 0, 4, -1, 1, -2, 0),
...               (-11, 3, 1, 0, -3, -2, -1, -11, 2, -2), 
...               (-1, 1, -1, -2, 1, -1, -1, -1, -1, 7), 
...               (-2, -1, -1, 1, 1, -2, 1, 0, 2, -4)]).stack(
...               200 * identity_matrix(ZZ, 10))
sage: matrix(ZZ,m).hermite_form(algorithm='padic', include_zero_rows=False)
[  1   0   2   0  13   5   1 166  72  69]
[  0   1   1   0  20   4  15 195  65 190]
[  0   0   4   0  24   5  23  22  51 123]
[  0   0   0   1  23   7  20 105  60 151]
[  0   0   0   0  40   4   0  80  36  68]
[  0   0   0   0   0  10   0 100 190 170]
[  0   0   0   0   0   0  25   0 100 150]
[  0   0   0   0   0   0   0 200   0   0]
[  0   0   0   0   0   0   0   0 200   0]
[  0   0   0   0   0   0   0   0   0 200]
[  0   0   0   0   0   0   0   0   0   0]
[  0   0   0   0   0   0   0   0   0   0]
[  0   0   0   0   0   0   0   0   0   0]
[  0   0   0   0   0   0   0   0   0   0]
[  0   0   0   0   0   0   0   0   0   0]
```




---

archive/issue_comments_140131.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2012-01-23T22:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140131",
    "user": "https://github.com/vbraun"
}
```

Changing priority from major to critical.



---

archive/issue_comments_140132.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-23T22:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140132",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_140133.json:
```json
{
    "body": "The actual cause is that there was a fallback to pari in case of an ill-conditioned matrix (which this one turns out to be), but we did not pass `include_zero_rows=False` in this case. This is fixed in the patch.\n\nWhile adding doctests, I noted that pari with `flag=4, include_zero_rows=False` also gives an incorrect result. The patch also disables this combination, the follow-up ticket #12346 will deal with this and re-enable it once this issue is fixed upstream.",
    "created_at": "2012-01-23T22:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140133",
    "user": "https://github.com/vbraun"
}
```

The actual cause is that there was a fallback to pari in case of an ill-conditioned matrix (which this one turns out to be), but we did not pass `include_zero_rows=False` in this case. This is fixed in the patch.

While adding doctests, I noted that pari with `flag=4, include_zero_rows=False` also gives an incorrect result. The patch also disables this combination, the follow-up ticket #12346 will deal with this and re-enable it once this issue is fixed upstream.



---

archive/issue_comments_140134.json:
```json
{
    "body": "NOTE: I will give this a positive review once the test suite runs and the four run-on sentences are fixed.",
    "created_at": "2012-02-21T07:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140134",
    "user": "https://github.com/williamstein"
}
```

NOTE: I will give this a positive review once the test suite runs and the four run-on sentences are fixed.



---

archive/issue_comments_140135.json:
```json
{
    "body": "Attachment [trac_12280_padic_hnf_without_zero_rows.patch](tarball://root/attachments/some-uuid/ticket12280/trac_12280_padic_hnf_without_zero_rows.patch) by @vbraun created at 2012-02-21 07:48:28\n\nUpdated patch",
    "created_at": "2012-02-21T07:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140135",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_12280_padic_hnf_without_zero_rows.patch](tarball://root/attachments/some-uuid/ticket12280/trac_12280_padic_hnf_without_zero_rows.patch) by @vbraun created at 2012-02-21 07:48:28

Updated patch



---

archive/issue_comments_140136.json:
```json
{
    "body": "The updated patch fixes the (really short) run-on sentences.",
    "created_at": "2012-02-21T07:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140136",
    "user": "https://github.com/vbraun"
}
```

The updated patch fixes the (really short) run-on sentences.



---

archive/issue_comments_140137.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-21T08:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140137",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_140138.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-02-27T11:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12108#issuecomment-140138",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_012123.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2012-02-27T11:22:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12108",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12108#event-12123"
}
```
