# Issue 15767: Update notebook to utilize pure javascript JSmol for default live 3-D

Issue created by migration from Trac.

Original creator: gutow

Original creation time: 2014-03-24 00:57:04

CC:  kcrisman novoselt strogdon jason chapoton

Keywords: Jmol 3D 3-D

The notebook needs updates to utilize a pure javascript version of Jmol by default for live 3-D.

Jmol is cross compiled to java and javascript.  Because so many browser/OS combinations now actively try to avoid using java applets, it is necessary to have a pure javascript alternative.  This solution provides all the functionality of Jmol, but as expected since javascript is interpreted rather than bytecode ("~3/4" of the way to compiled) the performance when interacting with the plot is slower.  

This first implementation removes the user tools that appear to the right of the 3-D plot as they need to be rewritten as well.  In this first implementation it is not possible to choose to use the java applet instead. 

One added feature is a "load 3-D live" check box that can be used to make a worksheet load 3-D plots live when the worksheet is opened.  For worksheets with a single interact or only 1-2 plots this should be OK.

*This requires installation of an updated Jmol.spkg.  See ticket [16003](http://trac.sagemath.org/ticket/16003).


---

Comment by gutow created at 2014-03-24 01:08:49

Changing component from PLEASE CHANGE to notebook.


---

Comment by gutow created at 2014-03-24 01:32:34

Set assignee to gutow.


---

Comment by gutow created at 2014-03-24 01:54:04

Changing status from new to needs_review.


---

Comment by gutow created at 2014-03-25 00:50:28

I'm not sure it has to do with this or something broken in my jquery.form.min.js installation, but I can no longer rename worksheets.  Does anybody else seeing this or have an idea how this could have anything to do with the changes in this ticket?


---

Comment by gutow created at 2014-03-25 01:21:36

Replying to [comment:9 gutow]:
> I'm not sure it has to do with this or something broken in my jquery.form.min.js installation, but I can no longer rename worksheets.  Does anybody else seeing this or have an idea how this could have anything to do with the changes in this ticket?

I think I've found it.  This may be painful.  The newer jquery seems to be killing stuff in jquery-ui-1.8.11.custom.js.  I will look for a version that is compatible with the newer jquery.


---

Comment by gutow created at 2014-03-25 01:33:15

jquery-ui is definitely out-of-date.  The 1.8.11 release is from 2011.  Does anybody know what selections need to be made to get the theme for the notebook to look right? I think to get everything working will require updating to the latest 1.10.4.


---

Comment by novoselt created at 2014-03-25 17:41:20

First of all, thanks for all your work on this, Jonathan!

And perhaps Jason can provide some insight in jquery problems?


---

Comment by jason created at 2014-03-25 17:44:40

See my message to sage-devel: https://groups.google.com/d/msg/sage-devel/8zS6qofxxwk/K5LcLsCWBeMJ for the configuration we use in the cell server with jquery-ui 1.10.something.


---

Comment by jason created at 2014-03-25 17:49:03

https://github.com/sagemath/sagecell/blob/master/static/jquery-ui/css/sagecell/jquery-ui-1.10.2.custom.min.css, 
which points to 
[this theme](http://jqueryui.com/themeroller/?ffDefault=Verdana%2CArial%2Csans-serif&fwDefault=normal&fsDefault=1.1em&cornerRadius=4px&bgColorHeader=cccccc&bgTextureHeader=highlight_soft&bgImgOpacityHeader=75&borderColorHeader=aaaaaa&fcHeader=222222&iconColorHeader=222222&bgColorContent=f3f3f3&bgTextureContent=flat&bgImgOpacityContent=0&borderColorContent=dddddd&fcContent=362b36&iconColorContent=222222&bgColorDefault=99bbff&bgTextureDefault=highlight_hard&bgImgOpacityDefault=60&borderColorDefault=cccccc&fcDefault=111111&iconColorDefault=777777&bgColorHover=99bbff&bgTextureHover=highlight_hard&bgImgOpacityHover=90&borderColorHover=888888&fcHover=111111&iconColorHover=222222&bgColorActive=ffc53d&bgTextureActive=highlight_hard&bgImgOpacityActive=60&borderColorActive=a85700&fcActive=000000&iconColorActive=000000&bgColorHighlight=fbf9ee&bgTextureHighlight=glass&bgImgOpacityHighlight=55&borderColorHighlight=fcefa1&fcHighlight=363636&iconColorHighlight=2e83ff&bgColorError=fef1ec&bgTextureError=highlight_hard&bgImgOpacityError=95&borderColorError=cd0a0a&fcError=cd0a0a&iconColorError=cd0a0a&bgColorOverlay=aaaaaa&bgTextureOverlay=flat&bgImgOpacityOverlay=0&opacityOverlay=30&bgColorShadow=aaaaaa&bgTextureShadow=flat&bgImgOpacityShadow=0&opacityShadow=30&thicknessShadow=8px&offsetTopShadow=-8px&offsetLeftShadow=-8px&cornerRadiusShadow=8px&ctl=themeroller)


---

Comment by gutow created at 2014-04-05 02:07:03

Replying to [comment:15 gutow]:
With Jason's directions for building the theme and a little tweaking, I believe I have everything working again along with the javascript 3-D. As a bonus we now how little icons to click on for adding compute and rich-text cells, so forgetful people like me do not have to remember which key-click combinations to use.  The real reason for the icons is that I could not get the key combinations to work:)


---

Comment by gutow created at 2014-04-07 01:12:43

Changing status from needs_review to needs_work.


---

Comment by gutow created at 2014-04-07 01:12:43

Some jquery-ui image paths broken (probably issue of symlinks)...


---

Comment by kcrisman created at 2014-04-08 01:40:49

Hey, just a quick question as I hopefully will be able to get testing this soon - can the 'load 3-D live" checkbox work just as well with jmol as with jsmol?  Also, I presume it will be evident once I finally get it going, but how does one get the Jmol instead of jsmol (say, locally, so that things are snappier)?


---

Comment by kcrisman created at 2014-04-08 02:08:19

> Some jquery-ui image paths broken (probably issue of symlinks)...
Is this fixed in https://github.com/gutow/sagenb/commit/7aacbfa3957f237edbea448d492f7c2b7d34cec2 ?


---

Comment by kcrisman created at 2014-04-08 02:12:33

I think that creating a new branch inside sagenb is now not possible with the new layout (not directly git-related).  One has to even figure out where sagenb lives... annoying.  So to test this one really needs a new sagenb spkg to download, or create one.  Harrumph.


---

Comment by strogdon created at 2014-04-08 03:52:33

Unless I've missed something it would seem that a new sagenb spkg is needed. The problem is the upstream sagenb-0.10.8.2 tarball is a tarball of tarballs. And it is the sagenb sub-tarball that has to be modified. Now I was able to generate patches that could be applied directly to the `local/lib/python2.7/site-packages/sagenb-0.10.8.2-py2.7.egg` folder by cloning `https://github.com/gutow/sagenb`. It seems that there are a couple more commits needed than listed above. But generating these patches is a lot of work! I'm able to see the icons and to turn on 3-D which is very, very slow. However, I see no way to evaluate an individual cell.


---

Comment by kcrisman created at 2014-04-08 15:08:18

Actually, ppurka has a good solution for this at [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/B7PpXa2VFQs).   At least I assume it works - I can't check right this second.

```
$ cd ~/sagenb/sagenb
$ rm flask_version
$ mv ../flask_version .
$ cd ~/sage/local/lib/python/site-packages/sagenb-0.10.8.2-py2.7.egg
$ mv sagenb{,-0.10.8.2}
$ ln -s ~/sagenb/sagenb .
```



---

Comment by gutow created at 2014-04-08 15:35:31

I'm updating the instructions above to include a fix that leaves the sagenb egg unchanged and allows you to work with multiple notebook development repositories.

To answer another question above the very latest commit to the repository does include the path fixes for jquery-ui images.


---

Comment by gutow created at 2014-04-08 15:45:01

At this point I have not got the option to run the java applet working cleanly.  I can do it by manually screwing with things, but I am still working on it. I have not figured out how to modify the templates so that it will not use java applets without the user specifically requesting it.  Because of how evil certain browsers/OS combinations have got about using java applets, we do not want that to ever be the default, even though it is better.

Replying to [comment:18 kcrisman]:
> Hey, just a quick question as I hopefully will be able to get testing this soon - can the 'load 3-D live" checkbox work just as well with jmol as with jsmol?  Also, I presume it will be evident once I finally get it going, but how does one get the Jmol instead of jsmol (say, locally, so that things are snappier)?


---

Comment by kcrisman created at 2014-04-09 01:38:04

Replying to [comment:26 gutow]:
> At this point I have not got the option to run the java applet working cleanly.  I can do it by manually screwing with things, but I am still working on it. I have not figured out how to modify the templates so that it will not use java applets without the user specifically requesting it.  Because of how evil certain browsers/OS combinations have got about using java applets, we do not want that to ever be the default, even though it is better.

Well, for instance, could one just hack into Sage itself... after all, one would want to [be able to set viewer=](http://www.sagemath.org/doc/reference/plot3d/sage/plot/plot3d/base.html#sage.plot.plot3d.base.Graphics3d.show) whatever, including both jsmol and jmol.  What happens with `viewer='jmol'` with your branch?  (I'm trying to set it up but this is an incredibly busy week on campus for me, so I'm not sure how much progress I'll make.)  At the least, one would want to just be able to add this to plots to get the Java.  

In fact, 

```
sage: from sage.plot.plot3d.base import SHOW_DEFAULTS
sage: SHOW_DEFAULTS['viewer'] = 'jmol'
```

should be possible then.  But I don't know whether that would tie in with your changes thus far.


---

Comment by gutow created at 2014-04-10 01:10:23

Changing status from needs_work to needs_review.


---

Comment by gutow created at 2014-04-10 01:10:23

All seems to work on my test server.  I need some reviewers testers now.


---

Comment by kcrisman created at 2014-04-10 03:22:52

I think it should be

```
$ln -s <path to the sagenb directory inside your new repository> sagenb 
```

not

```
$ln -s sagenb <path to the sagenb directory inside your new repository> 
```

am I right?


---

Comment by kcrisman created at 2014-04-10 03:41:12

Okay, I got it working.  Preliminary thoughts:
 * Snappier than advertised.  But SO SLOW with lots of points; a sparse vector field or basic plot is not so horrible.  Of course, so was the Java version...
 * The load 3d live button is precisely what the doctor ordered.
 * Is it possible that inside interacts the load 3d live button doesn't work (that is, interacts are always live?)  Or is it possible that you can only turn that button on, but not off (counter the expectation when clicking it)?  I observed some unusual behavior, but maybe it was just something dumb I did.
 * How do you turn a plot "off" if there are too many open?  (Or is that not a problem like it was with the sleeping Java applets?)
 * I see no way to get the things I used to with right-click (like stereo glasses, color, axes, whatever).  Does jsmol just not have that?
 * The icon for activating the plot is ... not obvious.  I still really find the auto-disable piece annoying, and I know that some people have just hacked that away, though I also know I won't convince you otherwise ;-)
 * Please remove the icons for new cells.  They are cute, and probably an improvement in some ways, but it should really be orthogonal to this issue.  There's enough moving parts to think about as it is.  **Especially** since the blue bars have been the way to make new cells for many years!  That's a pretty big change.
 * I figure out what strogdon is talking about.  Try activating a jsmol, and then move it around a bit, and then try clicking in a cell *without* clicking alllll the way on the right to "lose focus" from the jsmol.  (This is a problem anyway, of having to go all the way to the right to scroll - not limited to jsmol, though, threejs in the cell server has this problem as well.)  You won't be able to, at least often not; you have to somehow get off focus and there is some timing delay.
 * I also haven't tried all the zillions of options out there for 3d plots to see if it still obeys them all, but presumably if it's pretty similar to jmol it will do fine.
 * Does it require WebGL turned on?  I think not, but I'm not sure.

Hope this helps!  Actually, it's fairly comparable to the current setup, so probably we could get it in sooner rather than later.  Especially if you have any thoughts on the "viewer" thing - to me, this would be by far the easiest way to switch back and forth between functionality.

Once this has been tested enough and the "right" commits used, I think that you can just do a pull request to sagenb on github with your branch for this.  Yay!  Thanks for what is clearly very good hard work.


---

Comment by gutow created at 2014-04-11 02:18:57

Replying to [comment:31 kcrisman]:
> Okay, I got it working.  Preliminary thoughts:
>  * Snappier than advertised.  But SO SLOW with lots of points; a sparse vector field or basic plot is not so horrible.  Of course, so was the Java version...
>  * The load 3d live button is precisely what the doctor ordered.
Thought this is what people were asking for.
>  * Is it possible that inside interacts the load 3d live button doesn't work (that is, interacts are always live?)  Or is it possible that you can only turn that button on, but not off (counter the expectation when clicking it)?  I observed some unusual behavior, but maybe it was just something dumb I did.
I believe I wrote the code so that if that box is checked all Jmol/JSmols will load live.  If it is not checked they should not load live.  I am not aware of anything interacts do that should force a live load.
>  * How do you turn a plot "off" if there are too many open?  (Or is that not a problem like it was with the sleeping Java applets?)
Turning them off is presently not possible.  For the javascript version (JSmol) I do not think it will matter as long as you do not have the ones you are not interacting with doing things that require continuous computations like spinning or running an animation (something Jmol/JSmol can do, but Sage presently does not generate the input for).
>  * I see no way to get the things I used to with right-click (like stereo glasses, color, axes, whatever).  Does jsmol just not have that?
Right-click still brings up a menu.  For the time being I've left the default Jmol menu as it provides access to some file writing features.  You were not able to get it?  I'll look into that.
>  * The icon for activating the plot is ... not obvious.  I still really find the auto-disable piece annoying, and I know that some people have just hacked that away, though I also know I won't convince you otherwise ;-)
It is just the default image (a standard stock "play" icon) stored in the JSmol tree.  If we can come up with something better it can be replaced.
>  * Please remove the icons for new cells.  They are cute, and probably an improvement in some ways, but it should really be orthogonal to this issue.  There's enough moving parts to think about as it is.  **Especially** since the blue bars have been the way to make new cells for many years!  That's a pretty big change.
I agree that it would be nice to separate this "big" change in the interface out.  Unfortunately, I really could not get the old key+click actions to work with the new jquery that is required to support JSmol.  Unless somebody else can make it work without breaking JSmol these icons are going to be part of this change.  I'm open to suggestions on exactly how things should look, but built it using the standard jquery-ui tools that are part of sagenb.
>  * I figure out what strogdon is talking about.  Try activating a jsmol, and then move it around a bit, and then try clicking in a cell *without* clicking alllll the way on the right to "lose focus" from the jsmol.  (This is a problem anyway, of having to go all the way to the right to scroll - not limited to jsmol, though, threejs in the cell server has this problem as well.)  You won't be able to, at least often not; you have to somehow get off focus and there is some timing delay.
I'll play with this.  Haven't noticed it, at least not anymore than most GUI based software.
>  * I also haven't tried all the zillions of options out there for 3d plots to see if it still obeys them all, but presumably if it's pretty similar to jmol it will do fine.
If it worked in Jmol it works in JSmol as JSmol is just just cross compiled to javascript.  There have been some minor oddities, but the demands of the X-ray crystallography users are much more severe than what is usually being done here.  I think Bob Hanson and the others working on the conversion between Java and Javascript have found most of problems by now.  The chemistry community has been replacing java applet only versions with this for 9-12 months now.
>  * Does it require WebGL turned on?  I think not, but I'm not sure.
I have set it up to use HTML5 only.  WebGL support exists, but has problems with transparency and other such things.
> 
> Hope this helps!  Actually, it's fairly comparable to the current setup, so probably we could get it in sooner rather than later.  Especially if you have any thoughts on the "viewer" thing - to me, this would be by far the easiest way to switch back and forth between functionality.
I'll keep working on this.  I think if I can get it working cleanly in the GUI, it will be easy to couple it to the viewer option.
> 
> Once this has been tested enough and the "right" commits used, I think that you can just do a pull request to sagenb on github with your branch for this.  Yay!  Thanks for what is clearly very good hard work.


---

Comment by kcrisman created at 2014-04-11 03:50:37

> >  * The load 3d live button is precisely what the doctor ordered.
> Thought this is what people were asking for.
Yes, absolutely!
> >  * I see no way to get the things I used to with right-click (like stereo glasses, color, axes, whatever).  Does jsmol just not have that?
> Right-click still brings up a menu.  For the time being I've left the default Jmol menu as it provides access to some file writing features.  You were not able to get it?  I'll look into that.
Yeah.  This is on Safari 5, granted, but still... actually, it doesn't work on FF either.  I don't know why, other right-clicking seems to be working fine on this computer still.
> >  * The icon for activating the plot is ... not obvious.  I still really find the auto-disable piece annoying, and I know that some people have just hacked that away, though I also know I won't convince you otherwise ;-)
> It is just the default image (a standard stock "play" icon) stored in the JSmol tree.  If we can come up with something better it can be replaced.
I think that a word of some kind would be helpful.  The image doesn't say much to me, while your previous "live image" or whatever made it very clear.  Not everyone will mouse over that icon.
> >  * Please remove the icons for new cells.  They are cute, and probably an improvement in some ways, but it should really be orthogonal to this issue.  There's enough moving parts to think about as it is.  **Especially** since the blue bars have been the way to make new cells for many years!  That's a pretty big change.
> I agree that it would be nice to separate this "big" change in the interface out.  Unfortunately, I really could not get the old key+click actions to work with the new jquery that is required to support JSmol.  Unless somebody else can make it work without breaking JSmol these icons are going to be part of this change.  I'm open to suggestions on exactly how things should look, but built it using the standard jquery-ui tools that are part of sagenb.
Huh, that is weird.  When I start actually reviewing the code changes I'll try to think about that.
> > Hope this helps!  Actually, it's fairly comparable to the current setup, so probably we could get it in sooner rather than later.  Especially if you have any thoughts on the "viewer" thing - to me, this would be by far the easiest way to switch back and forth between functionality.
> I'll keep working on this.  I think if I can get it working cleanly in the GUI, it will be easy to couple it to the viewer option.
That would be very good, providing all available options.


---

Comment by gutow created at 2014-04-12 14:50:47

Replying to [comment:33 kcrisman]:

> > >  * I see no way to get the things I used to with right-click (like stereo glasses, color, axes, whatever).  Does jsmol just not have that?
> > Right-click still brings up a menu.  For the time being I've left the default Jmol menu as it provides access to some file writing features.  You were not able to get it?  I'll look into that.
Found the problem, but it's going to be a toughy...relates to the load order of the various js files.  It appears a function in jquery clobbers a JSmol function or vice-versa if we switch the load order of the two.  I can either get the right-click JSmol menu working or dialogs in Sagenb.  I'm consulting with the Jmol/JSmol community on this.
> > >  * The icon for activating the plot is ... not obvious.  I still really find the auto-disable piece annoying, and I know that some people have just hacked that away, though I also know I won't convince you otherwise ;-)
> > It is just the default image (a standard stock "play" icon) stored in the JSmol tree.  If we can come up with something better it can be replaced.
> I think that a word of some kind would be helpful.  The image doesn't say much to me, while your previous "live image" or whatever made it very clear.  Not everyone will mouse over that icon.
Actually, I think the text pops up if you mouse over the whole image.  But I see your point.  The idea was to make it "youtube-like".


---

Comment by gutow created at 2014-04-12 14:50:47

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2014-04-13 01:55:51

> > > >  * I see no way to get the things I used to with right-click (like stereo glasses, color, axes, whatever).  Does jsmol just not have that?
> > > Right-click still brings up a menu.  For the time being I've left the default Jmol menu as it provides access to some file writing features.  You were not able to get it?  I'll look into that.
> Found the problem, but it's going to be a toughy...relates to the load order of the various js files.  It appears a function in jquery clobbers a JSmol function or vice-versa if we switch the load order of the two.  I can either get the right-click JSmol menu working or dialogs in Sagenb.  I'm consulting with the Jmol/JSmol community on this.
Hmm, so the functions happen to be named the same thing?

----

Okay, I think that if we can fix the following in one way or another, and it otherwise it seems to handle things well, we can probably move to this:
 * Fix the clobbered function you mention above.
 * Fix or somehow make the icon here more obvious:
  > Actually, I think the text pops up if you mouse over the whole image.  But I see your point.  The idea was to make it "youtube-like".
 * Find some resolution to the new versus old ways to get new cells, ideally using the old clicking syntax (else a major change in interface).
 * Getting `viewer` to work with this so we can provide jmol or jsmol.

I know dealing with these is a lot harder than it seems to me, so hopefully we can find something good.  I'm going to also look into the shift-click thing for a minute in the hopes I get lucky...

Random request: In [this commit](https://github.com/gutow/sagenb/commit/bea6f2d4323ec1915e7d481e127700f969fea76c) it would be helpful to know which of this truly huge commit is just adding the new jquery, and what is something for Sage.  There are occasional changes I couldn't figure out if they were not important or if they were quite important, and it is kind of a bomb, by necessity.  So any hints on what to focus on there would be very helpful.


---

Comment by kcrisman created at 2014-04-13 02:29:48

>  * Find some resolution to the new versus old ways to get new cells, ideally using the old clicking syntax (else a major change in 
So it seems that this was just some custom thing written [way back when](http://code.google.com/p/sagenb/source/browse/sagenb/data/jquery/plugins/extendedclick/jquery.event.extendedclick.js?name=0.8.13&r=78ea2b9e6ad10632ea438d25c43ded861f64dcc2).

Currently this stuff is in [sagenb/data/jquery/plugins/extendedclick](https://github.com/sagemath/sagenb/tree/master/sagenb/data/jquery/plugins/extendedclick).  In fact, it seems to still be there after the update as well, and it's still loaded in base.html.  So maybe we can just update it for the new jquery after all...

In fact, Jason has a [github repo](https://github.com/jasongrout/jquery-extended-click/commits/master) for this!  At the time he updated for a new jquery too.  I did try editing things back in Safari's Firebug equivalent, but any clicking at all - even in the compute cells - yielded

```
TypeError: 'undefined' is not an object (evaluating 'introspect[id].before_replacing_word')
```

from line 23 of master.js.  Not sure if this is related.  Anyway, I would be very surprised if one couldn't fix this but I couldn't get the web inspector to allow me to change any of the js files, very annoying.

Or, we could perhaps use [this jquery plugin](https://github.com/jeresig/jquery.hotkeys) or [this javascript thing](http://www.openjs.com/scripts/events/keyboard_shortcuts/) instead?  [This link](http://stackoverflow.com/questions/9377046/jquery-trigger-ctrl-click) seems less robust but could work too...


---

Comment by gutow created at 2014-04-14 01:52:41

Random request: In ​this commit it would be helpful to know which of this truly huge commit is just adding the new jquery, and what is something for Sage. There are occasional changes I couldn't figure out if they were not important or if they were quite important, and it is kind of a bomb, by necessity. So any hints on what to focus on there would be very helpful. 
----
I couldn't seem to update the commit message without redoing the commit.  So here's the answer.  That commit is just replacing all the old jquery and jquery-ui files.  Nothing Sage related.  I wonder if we should start handling things like that as upstream packages? A ticket in itself?

Still testing, but believe I have solved the dialog/JSmol popup conflict.  There is an alternative JSmol package to avoid these kinds of problems...

Still no luck on getting the cntl-click stuff to work. I suspect it simply will require a careful rewrite of the old code.  I'm not convinced that is a good use of anybody's time as we have a functional (and for novices more usable) alternative.


---

Comment by novoselt created at 2014-04-14 06:17:24

Just to clarify - the problems are only with the mouse use for cells, keyboard commands like Ctrl+Enter, Alt+Enter etc. are still functional, correct?


---

Comment by kcrisman created at 2014-04-14 15:18:53

> Still no luck on getting the cntl-click stuff to work. I suspect it simply will require a careful rewrite of the old code. I'm not convinced that is a good use of anybody's time as we have a functional (and for novices more usable) alternative.
But it's backwards-incompatible, and requires rewriting of the help pages, and so forth.  (The page that is linked to "Help" in the notebook.)
> Just to clarify - the problems are only with the mouse use for cells, keyboard commands like Ctrl+Enter, Alt+Enter etc. are still functional, correct?
Yes, they appear to.  But I don't think there is a way to get a text cell without the mouse - or is there?  Also, sometimes one might not want to evaluate the current cell before inserting a new cell - and how would one get a new cell at the _top_ of the page?  Things to consider.


---

Comment by gutow created at 2014-04-17 23:57:49

OK.  I think I've fixed the following with the latest commit:
* Restored legacy click and shift-click behavior for adding cells to worksheets.  This no longer uses the old code but is modern jquery.  I have not taken out the old code because I believe it is used for keyboard key combinations as well.  Can somebody double check me on this.  If I'm wrong we can take it out.
* Fixed the conflict between the dialog boxes and the Jmol/JSmol popup menu.

Still to do:
* Change icons/wording so making JSmol live is more obvious.
* See if I can fix defaults to use wire images during rotation for faster response.
* Should I add back the link to help for the 3D viewer?

Can anybody explain in more detail what the strange behavior with the "load live" checkbox was?  Karl-Dieter, Thanks for spotting this.


---

Comment by strogdon created at 2014-04-18 21:11:30

There are certain situations, and I haven't been able to isolate the sequence of things, where I'm unable to evaluate a cell - both with the mouse and from the keyboard. At these times I'm also unable to rename the worksheet. When renaming the worksheet does work the `Rename worksheet` dialog box is partially "covered" by any graphics image in the worksheet. And by moving the dialog box around (this requires a little work) it can be made to disappear "behind" a graphics image leaving the worksheet in a "frozen" state.


---

Comment by gutow created at 2014-04-19 00:59:18

Replying to [comment:41 strogdon]:
> There are certain situations, and I haven't been able to isolate the sequence of things, where I'm unable to evaluate a cell - both with the mouse and from the keyboard. At these times I'm also unable to rename the worksheet.
I am not seeing this.  I'm going to need more help reproducing this. 
> When renaming the worksheet does work the `Rename worksheet` dialog box is partially "covered" by any graphics image in the worksheet. And by moving the dialog box around (this requires a little work) it can be made to disappear "behind" a graphics image leaving the worksheet in a "frozen" state.
Thanks.  Got it.  Had a problem with z-index settings.  I will include this fix in my next commit.


---

Comment by kcrisman created at 2014-04-19 13:03:46

I was planning to get to this yesterday but other things intervened.   So not having tried the latest commits (and it sounds like others are still coming), I think that only the icons/wording change is 100% necessary, as the js was faster with normal `plot_points` than I thought (still not horrible but okay), though that was not exhaustive testing.

However, if you have any way to attack the "viewer" issue to allow jmols that would be really useful.


---

Comment by gutow created at 2014-04-20 01:46:30

Replying to [comment:41 strogdon]:
> There are certain situations, and I haven't been able to isolate the sequence of things, where I'm unable to evaluate a cell - both with the mouse and from the keyboard. At these times I'm also unable to rename the worksheet. 
Does this problem only occur when using interacts?  I found an interact that has controls below where the applet is drawn and am seeing some funny things about who gets the click.  I've also seen an issue with interacts not moving out of the way to show the evaluate button.  That is probably a css issue that is separate from Jmol/JSmol.


---

Comment by gutow created at 2014-04-21 01:24:37

Note to testers.  You may want to update the Jmol installation spkg #16003, because I have updated to the latest stable Jmol/JSmol and updated the popup menu to include file and image save/download from within the active 3-D view.


---

Comment by gutow created at 2014-04-21 02:02:07

Latest commit includes fixes to hidden rename dialog, some click on image to activate instructions and some speed improvements.

There is definitely a problem with interacts that have controls below the active 3-D image.  I am presently stumped as to what is going on.  Any clues from what people are seeing would be welcome.


---

Comment by strogdon created at 2014-04-21 03:09:48

Replying to [comment:44 gutow]:
> Replying to [comment:41 strogdon]:
> > There are certain situations, and I haven't been able to isolate the sequence of things, where I'm unable to evaluate a cell - both with the mouse and from the keyboard. At these times I'm also unable to rename the worksheet. 
> Does this problem only occur when using interacts?  I found an interact that has controls below where the applet is drawn and am seeing some funny things about who gets the click.  I've also seen an issue with interacts not moving out of the way to show the evaluate button.  That is probably a css issue that is separate from Jmol/JSmol.
This issue from my end is not associated with using interacts. I haven't isolated the exact sequence to reproduce it. But I have seen it on two occasions. Now I'm testing on top of the develop branch. So there could be some irregularity in switching to my testing branch that includes the newer jmol.


---

Comment by strogdon created at 2014-04-23 18:38:21

Replying to [comment:47 strogdon]:
> Replying to [comment:44 gutow]:
> > Replying to [comment:41 strogdon]:
> > > There are certain situations, and I haven't been able to isolate the sequence of things, where I'm unable to evaluate a cell - both with the mouse and from the keyboard. At these times I'm also unable to rename the worksheet. 
> > Does this problem only occur when using interacts?  I found an interact that has controls below where the applet is drawn and am seeing some funny things about who gets the click.  I've also seen an issue with interacts not moving out of the way to show the evaluate button.  That is probably a css issue that is separate from Jmol/JSmol.
> This issue from my end is not associated with using interacts. I haven't isolated the exact sequence to reproduce it. But I have seen it on two occasions. Now I'm testing on top of the develop branch. So there could be some irregularity in switching to my testing branch that includes the newer jmol.
This appears to be a problem on my end and not with the code. It's a consequence of how I was moving things to deal with the sagenb symlink when I changed branches for testing. If I remember to create a new symlink each time I change branches then I don't seem to observe the problem.


---

Comment by strogdon created at 2014-04-25 19:05:22

There appears to be a general problem with the Chromium browser. When I click to make the 3D image live I get a dialog box with

```
JSmolCore.js: synchronous binary file transfer is required but not available
```

Then after clicking `OK` to remove the dialog box the 3D image disappears with no live jmol image. There is a `JSmol` icon at the lower right where the image should appear and right-clicking does produce the menu, but there is no image. The dialog box only appears once. Subsequent clicks to make other 3D images live produce no live jmols - the `JSmol` icon being all that's present.


---

Comment by gutow created at 2014-04-25 20:46:25

This is a general problem with all Webkit browsers operating on localhost.  This is because they will not allow any connections to network servers.  Since webkit browsers cannot handle binary files in javascript, JSmol sends it to a server to convert to base64 encoded ascii.  For testing I've been using the server that Bob Hanson has set up for the Jmol community.  Ideally, we should include something in the notebook that can handle these .php requests.  When I set up real servers I change the address of the php call and use the Apache that I proxy my Sage server behind.  I simply do not test locally in Webkit browsers.  I do all local testing in Firefox and then set up a beta server on the network to double check Webkit browsers and when I'm feeling like a masochist IE (I'm so fed up with IE, I usually just ignore it).

Replying to [comment:49 strogdon]:
> There appears to be a general problem with the Chromium browser. When I click to make the 3D image live I get a dialog box with
> {{{
> JSmolCore.js: synchronous binary file transfer is required but not available
> }}}
> Then after clicking `OK` to remove the dialog box the 3D image disappears with no live jmol image. There is a `JSmol` icon at the lower right where the image should appear and right-clicking does produce the menu, but there is no image. The dialog box only appears once. Subsequent clicks to make other 3D images live produce no live jmols - the `JSmol` icon being all that's present.


---

Comment by kcrisman created at 2014-04-29 03:10:58

> up with IE, I usually just ignore it).
Apparently even the [US and UK governments now want us to ignore it](http://www.cnet.com/news/stop-using-ie-until-bug-is-fixed-says-us/).


----

Re: Webkit: But ... does that mean Chrome and Safari can't do this right?  Or is the version/fork of WK that Chrome uses not susceptible?  I just got this going, won't have time to actually test it tonight, but just asking.


---

Comment by gutow created at 2014-04-29 15:17:28

Replying to [comment:51 kcrisman]: 
> Re: Webkit: But ... does that mean Chrome and Safari can't do this right?  Or is the version/fork of WK that Chrome uses not susceptible?  I just got this going, won't have time to actually test it tonight, but just asking.

No, the webkit browsers work when things are set up on a real webserver.  Then the javascript can send stuff to a different server for conversion.  As I said, it would be nice to embed the conversion in the Notebook server, but since any realistic server will be proxied behind something like Apache that can handle the existing .php script it is probably better to just put that on the server and change the path for the .php script to point to the local Apache server and not the Jmol community server.  Should an item be added to the administrative settings page of the notebook?


---

Comment by gutow created at 2014-04-29 15:20:36

The issue with the JSmol catching clicks for things below the active 3-D canvas has been fixed.  This is an upstream bug, so I am trying to get it pushed through the upstream Jmol releases, rather than have to include a patch.  Hopefully, this will only take a few days.


---

Comment by kcrisman created at 2014-04-29 15:37:50

> > Re: Webkit: But ... does that mean Chrome and Safari can't do this right?  Or is the version/fork of WK that Chrome uses not susceptible?  I just got this going, won't have time to actually test it tonight, but just asking.
> 
> No, the webkit browsers work when things are set up on a real webserver.  Then the javascript can send stuff to a different server for conversion.  As I said, it would be nice to embed the conversion in the Notebook server, but since any realistic server will be proxied behind something like Apache that can handle the existing .php script it is probably better to just put that on the server and change the path for the .php script to point to the local Apache server and not the Jmol community server.  Should an item be added to the administrative settings page of the notebook?
What I meant was that many people (including myself) use the notebook locally on localhost.  That is just a standard use case.  I *also* use it remotely on a "real webserver", but a lot of times I'm just trying something and want to do it on my own computer.  Are you saying that JSmol doesn't work in this case unless you are using Firefox?  That would be pretty unfortunate, especially since Chrome has such domination in terms of browser share now.

That said, switching between this branch and the "usual" one has caused some horrible problem with my Sage (probably my own error somewhere) so I can't test this yet, even though I thought I had it set up last night :(


---

Comment by kcrisman created at 2014-04-29 17:42:40

> > > > There are certain situations, and I haven't been able to isolate the sequence of things, where I'm unable to evaluate a cell - both with the mouse and from the keyboard. At these times I'm also unable to rename the worksheet. 
> > > Does this problem only occur when using interacts?  I found an interact that has controls below where the applet is drawn and am seeing some funny things about who gets the click.  I've also seen an issue with interacts not moving out of the way to show the evaluate button.  That is probably a css issue that is separate from Jmol/JSmol.
> > This issue from my end is not associated with using interacts. I haven't isolated the exact sequence to reproduce it. But I have seen it on two occasions. Now I'm testing on top of the develop branch. So there could be some irregularity in switching to my testing branch that includes the newer jmol.
> This appears to be a problem on my end and not with the code. It's a consequence of how I was moving things to deal with the sagenb symlink when I changed branches for testing. If I remember to create a new symlink each time I change branches then I don't seem to observe the problem.
I am now having the same problem you are, and presumably for the same reason (I had to recompile Sage).  I did recreate the symlink, though, and so I'm not sure why this isn't working right.  How exactly did you fix this, strogdon?

----

Other comments:
 * Bar for new cells occurs TWICE between cells now - once with your little icons, and once above that.  (Though that may be an artifact of something else I did.)
 * Bar color seems to have changed, and of course it's thicker.

----

I definitely am in the right version of sagenb - switched back and forth a couple times.  The evaluate button is gone and shift-enter does not work properly in the latest version of yours.  Weirdly, it did work before, so I assume something in the most recent one broke it?  But it presumably works for you, so I wonder what I did wrong... again, presumably similar to what strogdon did wrong before, but I'm stumped.


---

Comment by strogdon created at 2014-04-29 18:41:21

Replying to [comment:55 kcrisman]:
> > > > > There are certain situations, and I haven't been able to isolate the sequence of things, where I'm unable to evaluate a cell - both with the mouse and from the keyboard. At these times I'm also unable to rename the worksheet. 
> > > > Does this problem only occur when using interacts?  I found an interact that has controls below where the applet is drawn and am seeing some funny things about who gets the click.  I've also seen an issue with interacts not moving out of the way to show the evaluate button.  That is probably a css issue that is separate from Jmol/JSmol.
> > > This issue from my end is not associated with using interacts. I haven't isolated the exact sequence to reproduce it. But I have seen it on two occasions. Now I'm testing on top of the develop branch. So there could be some irregularity in switching to my testing branch that includes the newer jmol.
> > This appears to be a problem on my end and not with the code. It's a consequence of how I was moving things to deal with the sagenb symlink when I changed branches for testing. If I remember to create a new symlink each time I change branches then I don't seem to observe the problem.
> I am now having the same problem you are, and presumably for the same reason (I had to recompile Sage).  I did recreate the symlink, though, and so I'm not sure why this isn't working right.  How exactly did you fix this, strogdon?
> 
Well, it could have been coincidental. The last time I checked things were OK. When I change to my sagenb testing branch I have to remove and recreate the sagenb symlink and then type *make* to make sure the new jmol is used. It seemed also that the notebook caches things which occasionally gave aberrant behavior? Closing and restarting the notebook seemed to fix that. Switching back to the develop branch never seemed to be a problem. And yes, I did something that forced a *make distclean && make* - though I can't remember what it was.


---

Comment by strogdon created at 2014-04-30 18:54:40

I'm trying to recall what had given me issues when testing this ticket that prompted a rebuilding of Sage. It was perhaps that I was testing on top of the develop branch and not on top of the master. Doing

`./sage -dev checkout --ticket 16003`

may have been the problem, although I'm not sure. Anyway, to test on top of the develop branch I now do the following and as long as I recreate the sagenb symlink I haven't had a problem testing and then switching back to the develop branch:

* git branch testingbranch
* git checkout testingbranch
* git fetch trac u/gutow/ticket/16003
* git merge FETCH_HEAD

This creates testingbranch, changes to that branch and adds ticket #16003 on top of it, i.e. git log gives:


```
commit 55a76eb8ca5199d0db37a4a55267396be503ad2e
Merge: 2001f33 a89ac4b
Author: Steven Trogdon 
Date:   Thu Apr 24 19:46:43 2014 -0500

    Merge branch 'u/gutow/ticket/16003' of trac.sagemath.org:sage into jmol_javascript

commit 2001f33f54528f942ec7ff63eddeba890a9ba274
Author: Volker Braun <vbraun.name`@`gmail.com>
Date:   Wed Apr 23 00:03:12 2014 +0200

    Updated Sage version to 6.2.rc0
```


Then after (re)creating the sagenb symlink and typing make, I'm ready to test after the make completes.


---

Comment by kcrisman created at 2014-08-11 08:54:21

See also comment:54:ticket:12212 .


---

Comment by kcrisman created at 2014-08-20 17:29:46

> The issue with the JSmol catching clicks for things below the active 3-D canvas has been fixed.  This is an upstream bug, so I am trying to get it pushed through the upstream Jmol releases, rather than have to include a patch.  Hopefully, this will only take a few days.
Given comment:24:ticket:16003, it seems like Jmol has had some changes since then - is that fix in there as well?  Then maybe we can take care of #12212 and these two in one fell swoop.

But first I'm going to look at https://github.com/sagemath/sagenb/pull/204, even if that means slightly updating the commits here.  Making things easier for development is good.


---

Comment by kcrisman created at 2014-08-21 16:49:06

> > The issue with the JSmol catching clicks for things below the active 3-D canvas has been fixed.  This is an upstream bug, so I am trying to get it pushed through the upstream Jmol releases, rather than have to include a patch.  Hopefully, this will only take a few days.
> Given comment:24:ticket:16003, it seems like Jmol has had some changes since then - is that fix in there as well?  Then maybe we can take care of #12212 and these two in one fell swoop.
> 
> But first I'm going to look at https://github.com/sagemath/sagenb/pull/204, even if that means slightly updating the commits here.  Making things easier for development is good.
This will need slight rebase due to that, indeed.

More to the point, though, I would like to see this get in Sage, but there is just too much to look at all at once.  I recommend splitting into the following pieces.
* Whatever is needed in terms of reorganization so that #16003 (possibly with an even more updated jmol) can get in, since it breaks such plots in the notebook.  It seems like https://github.com/gutow/sagenb/commit/c730aa4cf563c51e7f1f8ca92899bf515d365030 is probably most of what is needed for that - is that correct?  I don't believe this commit "commits" us to javascript quite yet.  (Probably we don't even need to remove a lot of those scripts either, we could just not use them...)
* Update jquery in notebook and whatever changes need to happen with that.  Several of the commits here are definitely cherry-pickable for that, I think.  (This can include the live-3d checkbox, very useful.)
* Enable/switch to js from java plots.

Otherwise I think there are just too many moving parts to do this without breaking something important somewhere...

But I am "commit"ted to doing what I can on this - which should be a fair amount in the next few weeks, if Jonathan or others can help me identify what needs to happen to put this into practice.


---

Comment by kcrisman created at 2014-08-22 17:48:40

> I recommend splitting into the following pieces.
Updated:
> Whatever is needed in terms of reorganization so that #16003 (possibly with an even more updated jmol) can get in, since it breaks such plots in the notebook.

* It turned out I needed everything from the first two commits except the stuff specifically about the live 3d checkbox.  But jmols work again with all of that.  I think they are even js jmols...

* Second (or third), live 3d checkbox.

> Update jquery in notebook and whatever changes need to happen with that.

* Still needed.

> Enable/switch to js from java plots.

* Or more precisely, enable possibility of both by preference. This may end up being hard.


---

Comment by kcrisman created at 2014-08-25 16:26:47

> > > Re: Webkit: But ... does that mean Chrome and Safari can't do this right?  Or is 
> > No, the webkit browsers work when things are set up on a real webserver.  Then the 
> What I meant was that many people (including myself) use the notebook locally on localhost.  That is just a standard use case.  I *also* use it remotely on a "real webserver", but a lot of times I'm just trying something and want to do it on my own computer.  Are you saying that JSmol doesn't work in this case unless you are using Firefox?  That would be pretty unfortunate, especially since Chrome has such domination in terms of browser share now.

Yeah, I can confirm that at least the initial two commits have the following behavior on localhost (the way MOST users will interact with the notebook in their personal installations):
 * Safari 5 (old) seems to work fine
 * FF 31 seems to be ok
 * Chrome 34ish has the behavior strogdon reported.
This would be really tragic because I think we're really close here.  I don't want to tell people "just don't use Chrome" since it has a large market share and has a much better reputation for compliance with standards than the also-large IE.


---

Comment by kcrisman created at 2014-08-25 19:05:08

Update: I was able to make some progress with restoring the "usual" add new cell behavior without using the new icon things, thanks to Jonathan's hunting down the `e.shiftKey` business.  I think adding icons is good but needs to be part of a different thing - just getting this all working is a big enough job without thinking about how they should fit into the scheme, what icons are 'obvious enough' (this is the problem with the default Jsmol activation icon).

But I do have to say that even though there aren't as many options for the Jsmols because of the removal of the widgets, maybe one doesn't need to have both right away.   They "feel" like Jmols.  So maybe we just go straight to JS because even if it's a little slower than the Java, it isn't that bad for simple plots and Java was pretty slow for the complex ones also - and this actually works.


----

Another thing I can't figure out is why finding the right place to right-click to get the menus (in this case default) is like finding a place to take blood on someone at the hospital with really thin veins.  It's possible commit c3659b35 will help with this.


---

Comment by kcrisman created at 2014-08-26 01:24:38

Okay, actual status - on Mac:
 * Safari works fine.  (But don't have Safari > 5 on this machine.)
 * FF works nice, but the popup menu just won't appear.  (Might be a mistake I made.)
 * Chrome won't show, but the popup menu _does_ appear.

I have put an updated version of this at https://github.com/kcrisman/sagenb/tree/jsmol though the only substantive difference with Jonathan's branch are:
 * Fixed very small bug introduced for viewing documentation
 * Commented out widget code rather than deleted it
 * Did not add new icons etc.
so one can still use either branch for testing, and I can easily make a pull request once it's set.

Hopefully I kept as many of his commits as possible as well.  Now that I know that *any* click on a Jsmol will activate it, that's not even that bad to necessarily need the message - I thought one had to click precisely on the little mysterious icon, which would indeed be confusing.

So needs testing by someone other than me again - but Jonathan would be a great tester now!  strogdon or chapoton or Andrey or someone perhaps can do so... though this is probably the worst time of year for it!

Finally, from [the Jmol wiki](http://wiki.jmol.org/index.php/Jmol_JavaScript_Object):
> Reading binary files in some browsers and saving images and Jmol states in all browsers do require a server-side PHP script.
Not being able to save either is a bummer.  I'm going to look into this php file thingie a little bit.


---

Comment by kcrisman created at 2014-08-26 01:52:28

> Finally, from [the Jmol wiki](http://wiki.jmol.org/index.php/Jmol_JavaScript_Object):
> > Reading binary files in some browsers and saving images and Jmol states in all browsers do require a server-side PHP script.
> Not being able to save either is a bummer.  I'm going to look into this php file thingie a little bit.

This is so not my area of expertise... I think we'd have to assume someone has php on their box to do this, and I don't think we need to add _another_ upstream dependency to Sage!  Macs would come with this built in, though, maybe most Linux boxes as well?

Anyway, see [here](https://twistedmatrix.com/documents/14.0.0/web/howto/using-twistedweb.html#serving-php-perl-cgi) for how to get twisted to do this - well a very bare-bones thing, and see also possibility of [this problem](http://stackoverflow.com/questions/14541813/python-twisted-render-php).


---

Comment by vbraun created at 2014-09-21 20:56:39

To serve the jsmol files (and thus work with the chrome sandbox forbidding direct filesystem access) you just have to add 

```
    self.add_static_path('/java/jsmol', os.path.join(os.environ["SAGE_ROOT"],"local","share","jsmol"))
```

to `flask_version/base.py` in the notebook right under the corresponding jmol line. Files will then be at http://localhost/java/jsmol/

Saving files back from the browser requires a simple http POST handler, see http://flask.pocoo.org/docs/0.10/patterns/fileuploads/ for an example.


---

Comment by kcrisman created at 2014-09-22 13:30:39

Oh, that would be nice.


---

Comment by vbraun created at 2014-10-05 14:37:44

Github pull request: https://github.com/sagemath/sagenb/pull/241


---

Comment by strogdon created at 2014-10-06 02:56:41

I haven't tested extensively but things seem to now work here with firefox and chromium using oracle plugin; although it is slower that the old jmol. But that's to be expected.


---

Comment by strogdon created at 2014-10-06 15:56:35

With Chromium when I click to make a 3-D image live I see lots of, I suppose chatter, in the terminal from which the notebook is spawned

```
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] DEBUG in worksheet [/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-packages/sagenb-0.10.8.3-py2.7.egg/sagenb/flask_version/worksheet.py:673]:
[HTTPChannel,1,127.0.0.1] JSmol call:  getRawDataFromDatabase
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] DEBUG in worksheet [/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-packages/sagenb-0.10.8.3-py2.7.egg/sagenb/flask_version/worksheet.py:674]:
[HTTPChannel,1,127.0.0.1] JSmol query: http://localhost:8080/home/admin/28/cells/12/sage0-size400.jmol
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] DEBUG in worksheet [/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-packages/sagenb-0.10.8.3-py2.7.egg/sagenb/flask_version/worksheet.py:673]:
[HTTPChannel,1,127.0.0.1] JSmol call:  getRawDataFromDatabase
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] DEBUG in worksheet [/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-packages/sagenb-0.10.8.3-py2.7.egg/sagenb/flask_version/worksheet.py:674]:
[HTTPChannel,1,127.0.0.1] JSmol query: http://localhost:8080/home/admin/28/cells/12/sage0-size400-391049111.jmol.zip
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] DEBUG in worksheet [/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-packages/sagenb-0.10.8.3-py2.7.egg/sagenb/flask_version/worksheet.py:673]:
[HTTPChannel,1,127.0.0.1] JSmol call:  getRawDataFromDatabase
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
[HTTPChannel,1,127.0.0.1] DEBUG in worksheet [/64bitdev/storage/sage-git_develop/sage/local/lib/python2.7/site-packages/sagenb-0.10.8.3-py2.7.egg/sagenb/flask_version/worksheet.py:674]:
[HTTPChannel,1,127.0.0.1] JSmol query: http://localhost:8080/home/admin/28/cells/12/sage0-size400-391049111.jmol.zip
[HTTPChannel,1,127.0.0.1] --------------------------------------------------------------------------------
```

that comes from these lines in `flask_version/worksheet.py`

```
    current_app.logger.debug('JSmol call:  %s', call)
    current_app.logger.debug('JSmol query: %s', query)
```



---

Comment by vbraun created at 2014-10-06 16:11:37

I'm intentionally logging the calls as DEBUG since its quite possible that jsmol might choke on the interaction with the jsmol base64 relay. I don't know who enabled DEBUG-level logging by default, but that certainly wasn't me.


---

Comment by kcrisman created at 2014-10-07 14:04:13

Currently traveling with a heavy workload, but this sounds great and I will test it next week.


---

Attachment

patch to fix custom menu and resizing of 3-D display


---

Comment by gutow created at 2014-10-16 01:26:37

patch to allow user to choose Java instead of javascript for 3-D viewing


---

Attachment

Because I cannot push to Volker's repository at https://github.com/vbraun/sagenb.git and have not created a public clone repository of that I am attaching two patches that fix the broken custom right-click menu, applet resizing and allows the user to choose to use Java instead of javascript for 3-D viewing. See above.

With the present version of JSmol/Jmol java applets always launch live.  I have pushed a patch upstream that should show up soon that will allow java applets to behave the same as the javascript version.  We should not wait for the upstream fix as it is minor. 

I also think we should still fix things so that the right-click hint is text above the live applet.

I think we are basically ready to go on this ticket and #17020.  We need a reviewer.


---

Comment by gutow created at 2014-10-16 01:33:18

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-10-16 13:07:49

> With the present version of JSmol/Jmol java applets always launch live.  I have pushed a patch upstream that should show up soon that will allow java applets to behave the same as the javascript version.  We should not wait for the upstream fix as it is minor. 
Perhaps you can open a new ticket for that when it comes out.
> I also think we should still fix things so that the right-click hint is text above the live applet.
On this ticket?
> I think we are basically ready to go on this ticket and #17020.  We need a reviewer.
I will try my best to work on this the remainder of this week!


---

Attachment

Here is a simple patch the makes puts up a text hing to use the right click menu when the applet is live.


---

Comment by gutow created at 2014-10-17 01:26:18

Boy my typing was broken above.  The patch provides a text hint to use the right-click menu when the applet is live to get options.  We could open another ticket for that, but it is a two line patch so I think we can include it here.  Try it.


---

Comment by gutow created at 2014-10-17 01:28:30

Replying to [comment:82 kcrisman]:
> > With the present version of JSmol/Jmol java applets always launch live.  I have pushed a patch upstream that should show up soon that will allow java applets to behave the same as the javascript version.  We should not wait for the upstream fix as it is minor. 
> Perhaps you can open a new ticket for that when it comes out.
I think that is the right approach.


---

Comment by vbraun created at 2014-10-17 10:22:57

I've given you access to https://github.com/vbraun/sagenb.git, can you push your patches there?


---

Comment by gutow created at 2014-10-17 13:28:04

Replying to [comment:86 vbraun]:
> I've given you access to https://github.com/vbraun/sagenb.git, can you push your patches there?

I will try to do it this evening (~15 hrs from now).


---

Comment by kcrisman created at 2014-10-17 16:33:18

The patches look fine (still need to test, trying to do that before lunch!).  A few comments/questions:
 * I don't like how you reorganized base.html, because it's harder to read the properties of the elements now.  
 * I like your catch of the `gettext` for Typeset, assuming that is indeed translated in the localizations (it's not in message.pot, but that's probably ok).  
 * You also removed a &nbsp; near there as well, and didn't put one in for the Java enabling.  Maybe that should stay.
 * `onchange="3D_use_java_check(this.checked);"` looks nice, except there is no such function in `sagenb/data/sage/js/notebook_lib.js `, unlike for `pretty_print_check` and `live_3D_check`.  Does it need to be added there?  If not and things still work, then that line should be removed.


---

Comment by kcrisman created at 2014-10-17 17:02:13

Testing - more impressions, now from the main stuff.
 * In right-click menu, Jmol version is still 14.0.13 - presumably still hard-coded.
 * Sometimes the help message "Right-click to get options menu." appears twice.  I can't figure out how to reproduce it reliably, though.
 * The "make new cell interface" icons look much better than before, but it is STILL a different color from before and a different cell height.  In particular, the commit https://github.com/vbraun/sagenb/commit/8fe8371b93112d29a4096307d5807d736c41e415 breaks it, and https://github.com/vbraun/sagenb/commit/f9760a8635a63511731e340046711b1a7288de1c "fixes" it but not really.
 * Shift-click is still broken, because Volker just took your commits but didn't fix them.  See https://github.com/kcrisman/sagenb/commit/4fe29c8f7ab6ae5a44bf9a51872b3008ee4d18a2 for a commit that (perhaps with minor modifications) fix this - I think I actually got it from Jonathan but perhaps modified it, that was a while ago now.
 * The new cell bar, when it is _above_ a text area, does not have the icons.  In such cases, it also does not work.  
 * In addition (and this is very, very minor), the very final new cell bar is not indented (presumably it is in a different div or something).

Please do check out what I did to keep behavior as close to the legacy as possible.  Hopefully it will be pretty easy for one of you to just import 'correct' behavior.  It would have been easier to have not touched that stuff at all, but I know that ship has sailed.  Also, if we need to move discussion to github that is fine, I'm putting it here because I know everyone is reading this :)


---

Comment by kcrisman created at 2014-10-17 17:05:17

>  * The new cell bar, when it is _below_ a text area, does not have the icons.
 * There isn't the "evaluate" box any more either!  Edit: for reasons I cannot search out now, it _does_ appear in Chrome and FF.  ???
 * Shift-Enter does not appear to work to evaluate cells.  So... how does one evaluate a cell?  (This is old-Safari-specific, apparently, but not great.)
All this needs to be fixed.

Other things noticed.
 * Resizing works, though it's kind of hard to "let go" of the resizing.
 * Hard to tell whether I'm using Java other than the click box.  I do eventually get messages about allowing applets but don't know  if it's happening.
 * In Firefox and Chrome I managed to get a cell to evaluate, but then got the immensely cryptic

```
/Users/.../sage/local/lib/python2.7/site-packages/IPy\
thon/core/formatters.py:239: FormatterWarning: Exception in text/plain
formatter: should never launch viewer in embedded mode
  FormatterWarning,
None
```

   and no plot.  However, if I evaluate an _interact_ cell, then all is well!  (Edit: maybe this is residual from the whole base64 thing?)
 * In FF, right-clicking for the menu doesn't work, though it did in Safari.  It _does_ work in FF for the Java applet, not the js one.


---

Comment by kcrisman created at 2014-10-17 17:27:11

Also, don't forget to fix the thing inadvertently introduced in sagenb/data/sage/js/master.js

```
 $(document)
.on('click','.introspection, .docstring, .click-message, #worksheet_cell_list', function (e) {
```

needs to have the commas removed, more precisely it should look like

```
        $(document)
            .on('click','#worksheet_cell_list .introspection .docstring .click-message', function (e) {
```

or thereabouts.

Edit: perhaps this explains Volker's commit https://github.com/vbraun/sagenb/commit/062a76a622b9ff788843548c8fd1e8cc2ce6a4e5


---

Comment by kcrisman created at 2014-10-17 17:50:25

The formatter warning is due to https://github.com/ipython/ipython/pull/4745/ but I don't know how that interacts with getting the jsmols to show up.  Conceivably related is https://github.com/ipython/ipython/issues/5369/ with its fix https://github.com/ipython/ipython/pull/5452

Edit: the problem is with the default of showing.  Compare:

```
var('y')
show(plot3d(x^2+y^2,(x,-1,1),(y,-1,1)))
```

which works, and 

```
var('y')
plot3d(x^2+y^2,(x,-1,1),(y,-1,1))
```

which doesn't.  So something is going wrong in that default.

Edit 2: Haha, the problem in fact is even with TWO dimensional plots!   So something is going wrong with 

```
gfx = GraphicsFile(filename, mime_type=’image/png’)
gfx.launch_viewer()
```

and/or the "display hook", whatever that is, or something else in `.show()`.


---

Comment by kcrisman created at 2014-10-17 18:26:11

The evaluate button not showing up appears to be related to the wrong css rule being chosen at https://github.com/sagemath/sagenb/blob/master/sass/src/main.scss#L865 - it should be eval_button_active but isn't.  I can't figure this out yet; even when I change to make the button show up in the web inspector, I still can't get it to evaluate.


---

Comment by vbraun created at 2014-10-17 18:31:04

Calling `GraphicsFile.launch_viewer` is only for commandline use.


---

Comment by kcrisman created at 2014-10-17 18:35:02

> Calling `GraphicsFile.launch_viewer` is only for commandline use.
I believe you, but at any rate something is going wrong.  Do you get things to show up without `show(...)`?


---

Comment by vbraun created at 2014-10-17 18:37:49

Yes, can reproduce. Its fallout from the IPython notebook, will fix it at #17170


---

Comment by kcrisman created at 2014-10-17 18:44:31

> Yes, can reproduce. Its fallout from the IPython notebook, will fix it at #17170
As suspected, thanks.  The other big thing is then figuring out what the heck is going wrong with my Safari - it is an older one that github doesn't like, true, but our javascript hasn't changed that much!   The other things hopefully can be fixed fairly easily for the new cell logic.


---

Comment by kcrisman created at 2014-10-17 19:25:33

> As suspected, thanks.  The other big thing is then figuring out what the heck is going wrong with my Safari - it is an older one that github doesn't like, true, but our javascript hasn't changed that much!  
I must be going crazy, because now it is working again.  ???


---

Comment by kcrisman created at 2014-10-17 19:31:16

>  * Shift-click is still broken, because Volker just took your commits but didn't fix them.  See https://github.com/kcrisman/sagenb/commit/4fe29c8f7ab6ae5a44bf9a51872b3008ee4d18a2 for a commit that (perhaps with minor modifications) fix this - I think I actually got it from Jonathan but perhaps modified it, that was a while ago now.
Now all of a sudden this is working after all, which makes sense because https://github.com/vbraun/sagenb/commit/f9760a8635a63511731e340046711b1a7288de1c is there.
>  * The new cell bar, when it is _above_ a text area, does not have the icons.  In such cases, it also does not work.  
I think this is probably due to not having changed sagenb/data/sage/html/notebook/text_cell.html in the relevant commits https://github.com/vbraun/sagenb/commit/8fe8371b93112d29a4096307d5807d736c41e415 and https://github.com/vbraun/sagenb/commit/2757d2c6b488feeae2a3f97fffdd09f7ffe5ef01  Naturally, one would also have to do the thing to fix shift-click in that spot as well.


---

Comment by gutow created at 2014-10-18 00:55:07

I pushed my three patches to the repository, so those should no longer need to be manually installed.
I am looking into Karl-Dieter's problems.  I hadn't doubled checked the back compatible stuff.


---

Comment by gutow created at 2014-10-18 01:16:35

Testing in my version, which is now synced to Volker's repository:
1. shift-click works everywhere in FF and chromium (linux chrome)
1. cntrl-click works everywhere in FF and chromium
1. clicking on the two new cell icons works everywhere in FF and chromium
1. right-click JSmol popup works in FF and chromium
1. right-click Jmol popup works in FF, cannot test chromium as it does not support java plugin anymore.
1. The evaluate button always shows up for me.  Occasionally, I have seen issues with interacts covering the evaluate button, but it reappears after clicking around.  I have not been able to reproduce it reliably.

Although I have a lot of Macs, I do not think I have an old enough safari to reproduce the "old" problems on.  For the above items I am not seeing problems so am unable to do anything to fix them.  Please verify which ones are still problems.


---

Comment by gutow created at 2014-10-18 01:21:03

Replying to [comment:88 kcrisman]:
>  * `onchange="3D_use_java_check(this.checked);"` looks nice, except there is no such function in `sagenb/data/sage/js/notebook_lib.js `, unlike for `pretty_print_check` and `live_3D_check`.  Does it need to be added there?  If not and things still work, then that line should be removed.

The function is now in jmol_lib.js.  I did not put it in the notebook_lib.js because this function does not need to talk to the server.  Since the choice to use java needs to be decided in realtime by the user because of how browser and computer dependent it is, the setting is not a sticky.


---

Comment by kcrisman created at 2014-10-18 12:55:37

> Testing in my version, which is now synced to Volker's repository:
Thanks for this!
> Although I have a lot of Macs, I do not think I have an old enough safari to reproduce the "old" problems on.  For the above items I am not seeing problems so am unable to do anything to fix them.  Please verify which ones are still problems.
Can you confirm that the things that work above for you on FF/Chromium also work for some version >= 6 of Safari?  I think that is what you are saying.


---

Comment by kcrisman created at 2014-10-18 13:05:14

Let me try to summarize what probably still remains, assuming I also have luck with the most up-to-date repo when I can get to this Mondayish. These are obviously fairly minor compared to the display hook thing (thanks for fixing that so quickly!), but they worked in my branch.
 * &nbsp; removal (or rather, _un_removal)
 * hardcoded Jmol version is still 14.0.13
 * The new cell bar, when it is above a text area, does not work and has no icons.  It should also have the custom ctrl/shift-click code from other patches added to it.
 * The new cell bar is not quite at the right indentation level (div?) at the very end of the worksheet
 * Color of new cell bar should go back.
 * The js in comment:91 should be fixed so that it only applies to the pop out introspection.  You can check this by clicking the "pop to own window" and it won't do what it is supposed to.
By the way, what is ctrl-click supposed to do on a new cell bar?  I must have forgotten this feature!


---

Comment by gutow created at 2014-10-18 13:18:09

Replying to [comment:105 kcrisman]:
> Let me try to summarize what probably still remains, assuming I also have luck with the most up-to-date repo when I can get to this Mondayish. These are obviously fairly minor compared to the display hook thing (thanks for fixing that so quickly!), but they worked in my branch.
>  * &nbsp; removal (or rather, _un_removal)
This is just for layout with the checkboxes.  I didn't find having it missing making an obvious layout difference, but we can put it back in.
>  * hardcoded Jmol version is still 14.0.13
I will have to dig into Jmol for this.  It is supposed to pick up the version, which can be shown to be correct in the console by selecting the "State".  This is an upstream bug, although I might be able to patch it here.
>  * The new cell bar, when it is above a text area, does not work and has no icons.  It should also have the custom ctrl/shift-click code from other patches added to it.
Now I understand. We need to add a new cell bar above new rich text boxes.  I completely missed that.
>  * The new cell bar is not quite at the right indentation level (div?) at the very end of the worksheet
hmmm, I'll look at that.
>  * Color of new cell bar should go back.
Are you saying the highlighting doesn't disappear when you stop hovering over the new cell bar?  That may be a browser bug.  I will look at it again.
>  * The js in comment:91 should be fixed so that it only applies to the pop out introspection.  You can check this by clicking the "pop to own window" and it won't do what it is supposed to.
Not sure what the "pop to own window" is.  I know we used to have a link for that, but it should be gone along with all the fancier controls, they still need rewriting.
> By the way, what is ctrl-click supposed to do on a new cell bar?  I must have forgotten this feature!
shift-click = new rich text cell
cntrl-click = new calculation cell


---

Comment by kcrisman created at 2014-10-19 00:17:18

> >  * The new cell bar, when it is above a text area, does not work and has no icons.  It should also have the custom ctrl/shift-click code from other patches added to it.
> Now I understand. We need to add a new cell bar above new rich text boxes.  I completely missed that.
Ok.  I should point out that there IS a new cell bar, but it doesn't have the icons and doesn't do anything if you click on it.  Try a worksheet with some already-existing text cells and some computation cells, and you'll see what I mean when you hover in various places.
> >  * Color of new cell bar should go back.
> Are you saying the highlighting doesn't disappear when you stop hovering over the new cell bar?  That may be a browser bug.  I will look at it again.
No, I mean that you *changed the color* of the bars for some reason.  See my previous comments.  If you look at my branch you can see I remove your mysterious change to `cyan` and put it back to the usual color.
> >  * The js in comment:91 should be fixed so that it only applies to the pop out introspection.  You can check this by clicking the "pop to own window" and it won't do what it is supposed to.
> Not sure what the "pop to own window" is.  I know we used to have a link for that, but it should be gone along with all the fancier controls, they still need rewriting.
Nothing to do with jmol.  If you do `binomial?` or something like that, you will see the "introspection" documentation; there should be a link to click to "pop out" that into a separate window, and there are a few subtle things about that that don't work if you don't change that.  Look at the specific code I'm talking about - you changed it when you updated to modern jQuery, but unfortunately put in commas that didn't belong.  Just take my code :-)
> > By the way, what is ctrl-click supposed to do on a new cell bar?  I must have forgotten this feature!
> shift-click = new rich text cell
> cntrl-click = new calculation cell
Huh.  Doesn't also just plain old clicking (no other keys) make a new calculation cell?  Or maybe I'm misunderstanding something here.


---

Comment by gutow created at 2014-10-19 02:41:03

Replying to [comment:107 kcrisman]:
> Ok.  I should point out that there IS a new cell bar, but it doesn't have the icons and doesn't do anything if you click on it.  
Yep, it didn't do anything because it had the old non-jquery compatible code in it.  I have a fix for that and will commit it before the end of the weekend.  I can also tell you that the end of sheet new cell bar is indented differently because it is not part of the worksheet cell list.  It has the same indentation as rich text cells.  If it is really bothersome, I can place the icons over a little, but we do not want that cell to be part of the cell list.

While working on this I also realized there is no way to delete rich text cells.  Any thoughts on whether that is something we want?  If so, it should be its own ticket.
> No, I mean that you *changed the color* of the bars for some reason.  See my previous comments.  If you look at my branch you can see I remove your mysterious change to `cyan` and put it back to the usual color.
hmm, I'm not sure why I changed it.  Maybe I couldn't find the right color.  We certainly can pull it from your branch.
> Nothing to do with jmol.  If you do `binomial?` or something like that, you will see the "introspection" documentation; there should be a link to click to "pop out" that into a separate window, and there are a few subtle things about that that don't work if you don't change that.  Look at the specific code I'm talking about - you changed it when you updated to modern jQuery, but unfortunately put in commas that didn't belong.  Just take my code :-)
OK, I'm not sure why that comma is there either.
> Huh.  Doesn't also just plain old clicking (no other keys) make a new calculation cell?  Or maybe I'm misunderstanding something here.
Looking at the code any click other than shift-click creates a new compute cell.  This kind of confusion is why I like the little icons.:)


---

Comment by gutow created at 2014-10-19 20:51:01

Pushed following fixes to Volker's git repository:
Reverted new cell div hover color to old color
Added &nbsp; before text of display control checkboxes
Made add cell work before above rich text cells
Removed commas that were messing up jquery binding to certain items

Test and let me know what else you find...


---

Comment by gutow created at 2014-10-19 22:28:59

Replying to [comment:105 kcrisman]:

>  * hardcoded Jmol version is still 14.0.13
This is a bug in 14.2.4.  It appears to be fixed in 14.2.7.  We can make a new spkg.  Doesn't look like the static image for java fix is in 14.2.7 yet, so we will have to wait on that.


---

Comment by gutow created at 2014-10-19 23:07:01

Pushed a commit to #17020 that should fix the version number issue in the popup menus, independent of Jmol/JSmol version.


---

Comment by kcrisman created at 2014-10-20 12:38:58

> Yep, it didn't do anything because it had the old non-jquery compatible code in it.  I have a fix for that and will commit it before the end of the weekend.  
Great, I'll look at that today.
> I can also tell you that the end of sheet new cell bar is indented differently because it is not part of the worksheet cell list.  It has the same indentation as rich text cells.  If it is really bothersome, I can place the icons over a little, but we do not want that cell to be part of the cell list.
Got it, that makes sense.
> While working on this I also realized there is no way to delete rich text cells.  Any thoughts on whether that is something we want?  If so, it should be its own ticket.
Hmm, you can't _delete_ them, it's true, but save+quit+open actually gets rid of such cells if they are empty, due to the way sagenb handles that internally, no worries.

Looks like you got the other stuff on my list (or explained it).  I would personally not worry about waiting for the static image for java fix if the js version is the default...


---

Comment by kcrisman created at 2014-10-20 14:41:03

I'm going to continue discussion on the [pull request](https://github.com/sagemath/sagenb/pull/241) since we are so close now.


---

Comment by kcrisman created at 2014-10-20 20:03:50

I think we really need more reviewers now at the pull request.  

On a likely related note, I _think_ the following is due to the changes here.  Any ideas?

> * If you make a standard 2d plot like `plot(1-x,(x,0,1))`, evaluate, and then go back to _that same cell_ and change it to something else like `plot(1-x^2,(x,0,1))`, the graphic changes.  But:
> * Try doing a Jsmol, and then try changing *that* notebook cell and re-evaluating.  If you don't have the "Load 3D Live" checkbox clicked, you'll think you changed it - but you didn't!  As soon as you make it live, it's the exact same one as before.  If you have the live checkbox clicked (this refers to #16004, for those who come new to this) then this is quite obvious.
> 
> If it helps, the filenames are definitely changing:
> {{{
> $ ls .sage/sage_notebook.sagenb/home/admin/264/cells/82
> sage0-size500-155928955.jmol.zip	sage0-size500.jmol
> $ ls .sage/sage_notebook.sagenb/home/admin/264/cells/82
> sage0-size500-938371752.jmol.zip	sage0-size500.jmol
> $ ls .sage/sage_notebook.sagenb/home/admin/264/cells/82
> sage0-size500-522166844.jmol.zip	sage0-size500.jmol
> $ ls .sage/sage_notebook.sagenb/home/admin/264/cells/82
> sage0-size500-996347389.jmol.zip	sage0-size500.jmol
> }}}
> but I suspect that something is _not_ being overwritten somewhere.


---

Comment by gutow created at 2014-10-20 20:40:48

No ideas on the above, since I do not see the problem in my build.  I am running the latest commits, but am not sure from the discussions on the pull list if you have some other commits from different branches.


---

Comment by gutow created at 2014-10-20 20:43:39

Replying to [comment:115 kcrisman]:
> On a likely related note, I _think_ the following is due to the changes here.  Any ideas?

> > but I suspect that something is _not_ being overwritten somewhere.
Is it possible you are running into overzealous caching? The change in file name should fix that.  Is the file name changing in the html on your page?  If not your browser is not updating the page.


---

Comment by gutow created at 2014-10-20 21:06:26

Ha! I just got it to happen...Now if I can only figure out what I did!


---

Comment by gutow created at 2014-10-20 21:14:46

OK, I'm almost sure it is a caching issue.  I think we are being bitten by something I've wanted to rewrite for a while.  In addition to the data file, Sage writes a custom Jmol script to launch the display.  I think we could avoid using it, but I've tried to change as little as possible to maintain backwards compatibility.  Anyway, I don't think this is a new bug.  The script is not given a unique name, so we are picking up the one from the cache.  I will see if the simple fix of providing a unique name will work.  Ultimately that script file should go and we should just make a ".jmol" file.


---

Comment by kcrisman created at 2014-10-21 02:41:05

> OK, I'm almost sure it is a caching issue. 
I just tried this as well and I think I agree with you.  But it's completely pervasive for me, even interacts are now no longer working properly.   I get it now consistently in Safari, FF, but _not_ Chrome.  At least, not on the js, though on the java it seems to still happen.  (Clearing cache in Chrome is particularly annoying with the Java because it also logs me out of Sage as you have to clear plugins _and_ cookies together, can't only clear plugins.)
> Anyway, I don't think this is a new bug.  
Perhaps, but I think I would have noticed this if it was common before.  I can't get it to _not_ happen in FF and Safari right now :(
> The script is not given a unique name, so we are picking up the one from the cache.  I will see if the simple fix of providing a unique name will work.
Well, that would be nice.  Sometimes programming even does have nice solutions - let's hope.  Thanks very much for looking into this.


---

Comment by kcrisman created at 2014-10-21 12:46:48

More info.   Clicking on the js console gives

```
FileManager opening 1 http://localhost:8080/home/admin/302/cells/1/sage0-size500.jmol
FileManager opening 3 http://localhost:8080/home/admin/302/cells/1/sage0-size500-184635879.jmol.zip|SCRIPT
FileManager opening 1 http://localhost:8080/home/admin/302/cells/1/sage0-size500-184635879.jmol.zip
The Resolver thinks Xyz
reading 10 atoms
ModelSet: haveSymmetry:false haveUnitcells:false haveFractionalCoord:false
1 model in this collection. Use getProperty "modelInfo" or getProperty "auxiliaryInfo" to inspect them.
Default Van der Waals type for model set to Babel
10 atoms created
ModelSet: autobonding; use autobond=false to not generate bonds automatically
no data
pmesh obj_729730 "obj_729730.pmesh";
reading isosurface data from http://localhost:8080/home/admin/302/cells/1/sage0-size500-184635879.jmol.zip|obj_729730.pmesh
FileManager opening 3 http://localhost:8080/home/admin/302/cells/1/sage0-size500-184635879.jmol.zip|obj_729730.pmesh
FileManager opening 1 http://localhost:8080/home/admin/302/cells/1/sage0-size500-184635879.jmol.zip
```

But 

```
$ cd .sage/sage_notebook.sagenb/home/admin/302/cells/1
$ ls
sage0-size500-508165167.jmol.zip	sage0-size500.jmol
```

So the old 1846... isn't even in the directory!  Is it in the `.jmol` file?  What role does that file even play?

----

Another thing I'm noticing is that, in the past, I thought one could only discard changes since the last cell evaluation, which sort of automatically saved.  But for some reason now "discard changes" seems to discard ALL changes since the last save.  I can't see now how any of this could be responsible for that, but I am going to have to confirm that this is either prior behavior (which I don't buy) or unrelated (which I hope).


---

Comment by kcrisman created at 2014-10-21 12:51:06

> Another thing I'm noticing is that, in the past, I thought one could only discard changes since the last cell evaluation, which sort of automatically saved.  But for some reason now "discard changes" seems to discard ALL changes since the last save.  I can't see now how any of this could be responsible for that, but I am going to have to confirm that this is either prior behavior (which I don't buy) or unrelated (which I hope).
Yikes, this is actual behavior.  I mean, it's consistent, but scary without autosave... I don't know how I ever didn't notice this before.  Save often!


---

Comment by kcrisman created at 2014-10-21 13:56:05

Jonathan, try this.

```diff
diff --git a/sagenb/notebook/cell.py b/sagenb/notebook/cell.py
index 7c322c9..d0ce526 100755
--- a/sagenb/notebook/cell.py
+++ b/sagenb/notebook/cell.py
`@``@` -2350,7 +2350,7 `@``@` class Cell(Cell_generic):
             <div id="loadJmol" style="display:none;">{id}</div>
             <div id="sage_jmol_size_{id}" style="display:none;">{size}</div>
             <div id="sage_jmol_img_{id}" style="display:none;">{image_name}.png?{timestamp}</div>
-            <div id="sage_jmol_script_{id}" style="display:none;">{filename}</div>
+            <div id="sage_jmol_script_{id}" style="display:none;">{filename}?{timestamp}</div>
             <div id="sage_jmol_server_url_{id}" style="display:none;">{callback}</div>
             <div id="sage_jmol_status_{id}" style="display:none;">notActivated</div>
         </div>
```


I think that the source of this is [this commit](https://github.com/vbraun/sagenb/commit/c1d9aa3dc88bcb75547993607127c89fd03f0a19) where the `?time.time()` was inadvertently removed in an otherwise-useful refactoring.


---

Comment by kcrisman created at 2014-10-21 14:11:21

> Jonathan, try this.
Yeah, this simple change back to your original code intent reliably fixes the problem for me (undoing it causes the problem again).

Aagh!  But it seems to break Chrome for some reason.

```
Error connecting to server: /home/admin/302/jsmol?call=getRawDataFromDatabase&database=_&query=http%3A%2F%2Flocalhost%3A8080%2Fhome%2Fadmin%2F302%2Fcells%2F1%2Fsage0-size500.jmol%3F1413900723.07&encoding=base64
```

and an error message logged

```
exceptions.IOError: [Errno 2] No such file or directory: u'/Users/.../.sage/sage_notebook.sagenb/home/admin/302/cells/1/sage0-size500.jmol1413900723.07
```

So maybe you are right and we have to actually change the name of the script as such.  But I don't want to do that in the Sage library for 3d graphics any more, so I'll try to figure out if we can dynamically do it in the file `cell.py`.


---

Comment by kcrisman created at 2014-10-21 15:16:32

Okay, _this_ much more hackish code does seem to work properly, including dealing with reloading pages with old files, etc.

```diff

diff --git a/sagenb/notebook/cell.py b/sagenb/notebook/cell.py
index 7c322c9..20ea9c1 100755
--- a/sagenb/notebook/cell.py
+++ b/sagenb/notebook/cell.py
`@``@` -2333,8 +2333,8 `@``@` class Cell(Cell_generic):
         #
         # So we need to prepend the worksheet URL, in order
         # for the zip to be accessed correctly.
+        jmol_name = os.path.join(self.directory(), F)
         if self.worksheet().docbrowser():
-            jmol_name = os.path.join(self.directory(), F)
             with open(jmol_name, 'r') as f:
                 jmol_script = f.read()
             jmol_script = jmol_script.replace(
`@``@` -2343,8 +2343,12 `@``@` class Cell(Cell_generic):
             with open(jmol_name, 'w') as f:
                 f.write(jmol_script)
 
+        F_time = F.replace('.jmol','-{}time.jmol'.format( time.time() ))
+        jmol_name_time = os.path.join(self.directory(), F_time)
+        shutil.copy2(jmol_name, jmol_name_time)
+
         image_name = os.path.join(self.url_to_self(),'.jmol_images',F)
-        script_name = os.path.join(self.url_to_self(), F)
+        script_name = os.path.join(self.url_to_self(), F_time)
         return textwrap.dedent("""
         <div id="sage_jmol_{id}" class="3DPlotDiv">
             <div id="loadJmol" style="display:none;">{id}</div>
`@``@` -2423,6 +2427,8 `@``@` class Cell(Cell_generic):
                 pass # obj data
             elif F.endswith('.svg'):
                 images.append('<embed src="%s" type="image/svg+xml" name="emap">' % url)
+            elif F.endswith('time.jmol'):
+                pass
             elif F.endswith('.jmol'):
                 images.append(self._jmol_files_html(F))
                 jmolimagebase = F
```

But I'd much rather hear that there is a way to make Chrome like the `?` syntax for the script and not just the graphic.


---

Comment by kcrisman created at 2014-10-21 16:48:40

Here is at least one piece of the problem, in the file `sagenb/flask_version/worksheet.py`:

```
filename = match.group('filename')
filename = secure_filename(filename) # never trust input
```

This removes the ? without the rest.

Interestingly, one reason this happens at all is because only Chrome goes through this URI

```
`@`worksheet_command('jsmol')
def worksheet_jsmol_data(worksheet):
```

as far as I can tell.  I have no idea why the others don't.

Anyhow, maybe this updated version of the first diff would work.

```diff

diff --git a/sagenb/flask_version/worksheet.py b/sagenb/flask_version/worksheet.py
index 40c3d54..fd0dcf2 100644
--- a/sagenb/flask_version/worksheet.py
+++ b/sagenb/flask_version/worksheet.py
`@``@` -695,6 +695,7 `@``@` def worksheet_jsmol_data(worksheet):
             return current_app.message(_('Invalid JSmol query: ' + query))
         cell_id = match.group('cell_id')
         filename = match.group('filename')
+        filename = filename.rsplit('?',1)[0] # appended query is only for cache busting
         filename = secure_filename(filename)   # never trust input
         filename = os.path.join(worksheet.cells_directory(), cell_id, filename)
         with open(filename, 'r') as f:
diff --git a/sagenb/notebook/cell.py b/sagenb/notebook/cell.py
index 7c322c9..d0ce526 100755
--- a/sagenb/notebook/cell.py
+++ b/sagenb/notebook/cell.py
`@``@` -2350,7 +2350,7 `@``@` class Cell(Cell_generic):
             <div id="loadJmol" style="display:none;">{id}</div>
             <div id="sage_jmol_size_{id}" style="display:none;">{size}</div>
             <div id="sage_jmol_img_{id}" style="display:none;">{image_name}.png?{timestamp}</div>
-            <div id="sage_jmol_script_{id}" style="display:none;">{filename}</div>
+            <div id="sage_jmol_script_{id}" style="display:none;">{filename}?{timestamp}</div>
             <div id="sage_jmol_server_url_{id}" style="display:none;">{callback}</div>
             <div id="sage_jmol_status_{id}" style="display:none;">notActivated</div>
         </div>
```

Try one or all of these out.


---

Comment by kcrisman created at 2014-10-21 16:55:48

For positive review, I think here is what we still need.
* Positive review for #17020
* Positive review for #17170, thought this is somewhat orthogonal
* Merging my minor css change stuff at https://github.com/vbraun/sagenb/pull/1
* Some fix to this last cache busting issue

Then I think we need to really push it into a new package for upstream so that it can be tested _thoroughly_.  Depending on where Volker is in the release process, maybe the first beta of the next one, or in the current beta series.


---

Comment by gutow created at 2014-10-21 17:51:32

(+1) This last patch works for me on FF/linux and is reasonably simple.
> Anyhow, maybe this updated version of the first diff would work.
> {{{
> #!diff
> 
> diff --git a/sagenb/flask_version/worksheet.py b/sagenb/flask_version/worksheet.py
> index 40c3d54..fd0dcf2 100644
> --- a/sagenb/flask_version/worksheet.py
> +++ b/sagenb/flask_version/worksheet.py
> `@``@` -695,6 +695,7 `@``@` def worksheet_jsmol_data(worksheet):
>              return current_app.message(_('Invalid JSmol query: ' + query))
>          cell_id = match.group('cell_id')
>          filename = match.group('filename')
> +        filename = filename.rsplit('?',1)[0] # appended query is only for cache busting
>          filename = secure_filename(filename)   # never trust input
>          filename = os.path.join(worksheet.cells_directory(), cell_id, filename)
>          with open(filename, 'r') as f:
> diff --git a/sagenb/notebook/cell.py b/sagenb/notebook/cell.py
> index 7c322c9..d0ce526 100755
> --- a/sagenb/notebook/cell.py
> +++ b/sagenb/notebook/cell.py
> `@``@` -2350,7 +2350,7 `@``@` class Cell(Cell_generic):
>              <div id="loadJmol" style="display:none;">{id}</div>
>              <div id="sage_jmol_size_{id}" style="display:none;">{size}</div>
>              <div id="sage_jmol_img_{id}" style="display:none;">{image_name}.png?{timestamp}</div>
> -            <div id="sage_jmol_script_{id}" style="display:none;">{filename}</div>
> +            <div id="sage_jmol_script_{id}" style="display:none;">{filename}?{timestamp}</div>
>              <div id="sage_jmol_server_url_{id}" style="display:none;">{callback}</div>
>              <div id="sage_jmol_status_{id}" style="display:none;">notActivated</div>
>          </div>
> }}}


---

Comment by kcrisman created at 2014-10-21 17:55:50

> (+1) This last patch works for me on FF/linux and is reasonably simple.
Okay, that is good.  I'll try to push something along these lines tonight.

If you can take a look at the CSS change stuff and possibly merge that in, then we are quite close.


---

Comment by kcrisman created at 2014-10-22 13:40:25

I ended up making a mess of the commit history but merged both of these things in this morning.  So shortly we should merge them to sagenb, and then try to make a package for this ticket - assuming #16911 gets in first, which it definitely should.


---

Comment by gutow created at 2014-10-23 01:02:58

OK, I'm now synced with the new_jmol repository and everything looks OK.  Are we at the positive review stage? I think I checked carefully that all of Karl-Dieter's css changes went into both the scss and the css.


---

Comment by kcrisman created at 2014-10-23 01:11:11

Yeah, I can't think of anything else.  All your browsers work nicely?

In that case, I will merge that WHOLE pull request, with all its ugly extra commits, and then ask ppurka if we can get a new sagenb package.  (I haven't really checked into how to do that yet.)   It would wait until after #16911 but then hopefully we can get a nice good period of testing in with whatever beta it gets merged into.

Thanks in advance for all your very good work on this; to ask a chemist to write tons of javascript and html for mathematics is a bit above the call of duty :)


---

Comment by kcrisman created at 2014-10-23 02:17:11

Needs a package of course, so 'needs work'.


---

Comment by kcrisman created at 2014-10-23 02:17:11

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2014-10-27 20:35:53

New commits:


---

Comment by kcrisman created at 2014-10-27 20:43:13

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-10-27 20:43:13

Ready to try out!


---

Comment by vbraun created at 2014-10-28 14:17:45

Fixed the obvious conflict with #16911
----
New commits:


---

Comment by kcrisman created at 2014-10-28 14:23:49

> Fixed the obvious conflict with #16911
Oh, duh.  I'll also mention that in the instructions, why I didn't think about this who knows...


---

Comment by strogdon created at 2014-10-28 18:57:01

Aside from the "annoying" DEBUG/JSmol stuff that's dumped to the spawning terminal when one clicks on a 3-D image from Chromium, this looks really slick. I don't know of all the corner cases to test but from what I see, it has my thumbs up!


---

Comment by kcrisman created at 2014-10-28 19:06:29

> Aside from the "annoying" DEBUG/JSmol stuff that's dumped to the spawning terminal when one clicks on a 3-D image from Chromium, 
As Volker pointed out in comment:75, the level is not due to anyone here... though probably it could be removed.  What is interesting is that it does verify that only Chrome/Chromium actually use that branch, for reasons I cannot fathom.

> this looks really slick. I don't know of all the corner cases to test but from what I see, it has my thumbs up!
Awesome!

(Does the worksheet revision history work properly for you now as well?  You may need to hard remove some cache for that to work, depending.)


---

Comment by strogdon created at 2014-10-28 20:17:23

Replying to [comment:140 kcrisman]:
> 
> (Does the worksheet revision history work properly for you now as well?  You may need to hard remove some cache for that to work, depending.)

Yes, this does work here. I hadn't noticed that feature.


---

Comment by kcrisman created at 2014-10-28 20:43:09

> > (Does the worksheet revision history work properly for you now as well?  You may need to hard remove some cache for that to work, depending.)
> 
> Yes, this does work here. I hadn't noticed that feature.
Good.  You hadn't noticed it because it has been broken for years - and for a very stupid reason, really almost a trivial one.


---

Comment by kcrisman created at 2014-10-28 20:46:09

Volker, Jonathan - what else do you think we need for positive review?  I think we've had quite a bit of independent looking at it.  Andrey has promised to test once it's in beta as well...


---

Comment by kcrisman created at 2014-10-28 20:49:29

Aargh, mangled Andrey's name... don't know how that happened.


---

Comment by vbraun created at 2014-10-28 21:02:28

looks good to me.


---

Comment by kcrisman created at 2014-10-29 00:41:10

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2014-10-29 00:42:42

Great!  

Just a request to release manager to make sure there is enough time for people to find any surprises in this in testing - better an early beta than an rc, anyway, though naturally sooner is better.


---

Comment by vbraun created at 2014-10-30 09:44:48

Resolution: fixed


---

Comment by novoselt created at 2014-11-04 23:13:58

For me both JS and Java do not support transparency while spinning either manually or automatically (surfaces turn to completely opaque). Is this the expected behaviour now??? One of the major problems with three.js is its handling of transparency and jmol always was great in it.


---

Comment by gutow created at 2014-11-05 00:44:03

Replying to [comment:149 novoselt]:
> For me both JS and Java do not support transparency while spinning either manually or automatically (surfaces turn to completely opaque). Is this the expected behaviour now??? One of the major problems with three.js is its handling of transparency and jmol always was great in it.
This is an adjustable setting.  Rotation speeds are much improved with transparency and some other display improvements off.  Thus I set the default to get better responsiveness out of the javascript application.  If you really need the transparency open the console and give the command "set platformspeed=10".  That should maintain the transparency.  It will probably be acceptable in Java (If people want it we could make that the java default), but unless computers get faster or javascript gets compiled the performance probably will be too slow in javascript for all but simple surfaces.


---

Comment by gutow created at 2014-11-05 00:53:20

Note: set platformspeed=7 maintains transparency without an awful hit to rotation speed and responsiveness in javascript.  This is probably something we should open a separate ticket on as this is a minor adjustment and people will need to test on lots of machines to decide what is acceptable.


---

Comment by kcrisman created at 2014-11-05 13:03:18

Hmm, interesting points.  Where is this `platformspeed` stuff documented?  (I'd do a search for it but apparently Jmol's doc is often somewhat dated...)  I think that maintaining transparency is a very important thing. This is now #17292.
