# Issue 19284: wrong inverse action when using ConstructionFunctor.coercion_reversed

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2015-11-04 15:21:56


```
sage: Q.<y> = SR.subring(no_variables=True)[[]]
sage: (y / 1).parent()
Univariate Polynomial Ring in x over Symbolic Ring
```

but the result should be

```
Univariate Polynomial Ring in x over Symbolic Constants Subring
```

since there is a coercion from the integer ring to the symbolc constants subring.

This is because the attrirute `coercion_reversed` of `ConstructionFunctor` is not taken into account.


---

Comment by dkrenn created at 2015-11-04 15:24:34

BTW: For some reason it works (partially) for polynomial rings:

```
     sage: R.<x> = SR.subring(no_variables=True)[]
     sage: (x / 1).parent()
     Univariate Polynomial Ring in x over Symbolic Constants Subring
```

but

```
     sage: cm = sage.structure.element.get_coercion_model()
     sage: cm.explain(x, 1, operator.div)
     Action discovered.
        Right inverse action by Symbolic Ring on Univariate Polynomial Ring in x over Symbolic Constants Subring
        with precomposition on right by Conversion map:
          From: Integer Ring
          To:   Symbolic Ring
    Result lives in Univariate Polynomial Ring in x over Symbolic Ring
    Univariate Polynomial Ring in x over Symbolic Ring
```


At one point this should be investigated, but probably on a different ticket.


---

Comment by dkrenn created at 2015-11-04 16:03:39

Branch should fix this; still need to run a `make ptestlong`; will do this soon...
----
Last 10 new commits:


---

Comment by dkrenn created at 2015-11-05 01:18:18

Replying to [comment:4 dkrenn]:
> Branch should fix this; still need to run a `make ptestlong`; will do this soon...

Passed. So I set it to needs review.


---

Comment by dkrenn created at 2015-11-05 01:18:18

Changing status from new to needs_review.


---

Comment by behackl created at 2016-01-24 02:11:16

Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.

I think I understand your fix as well as the strategy behind it, and I am willing to give this a `positive_review` (i.e. everything LGTM). However, I'd rather be sure:

In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?

For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?

Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.
----
New commits:


---

Comment by dkrenn created at 2016-01-24 07:26:47

Replying to [comment:6 behackl]:
> Hi! I've merged the (positively reviewed) dependency into this branch and reviewed the code in this ticket.

Thanks.

> In principle, all that happens is that you order the functors and parents from smallest to largest (in the sense of coercion) and iterate over this reordered tower such that actually the smallest parent with the required property is found?
> 
> For example, (using your notation from the comment), if we had a tower `A -> B <- C <- D -> E`, then the old code would iterate over `[A, B, C, D, E, F]`, and in your fixed version we iterate over `[A, D, C, B, E]`?

Correct.

> Also, I'd like to give the patchbots a chance to test this---or, at least, run `make ptestlong` myself.

Ok.


---

Comment by behackl created at 2016-01-24 08:38:03

... alright. Passes `ptestlong` and does what it should -> `positive_review`.


---

Comment by behackl created at 2016-01-24 08:38:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-01-24 21:48:30

Resolution: fixed
