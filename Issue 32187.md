# Issue 32187: Sage 9.4 still creates non-portable binaries with SAGE_FAT_BINARY="yes"

archive/issues_032187.json:
```json
{
    "body": "CC:  @williamstein @kliem @dimpase @NathanDunfield @culler @slel @orlitzky @vbraun @maxale tmonteil @jhpalmieri\n\nas reported in https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ\n\nIssue created by migration from https://trac.sagemath.org/ticket/32424\n\n",
    "created_at": "2021-08-26T04:16:33Z",
    "labels": [
        "porting",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Sage 9.4 still creates non-portable binaries with SAGE_FAT_BINARY=\"yes\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32187",
    "user": "@mkoeppe"
}
```
CC:  @williamstein @kliem @dimpase @NathanDunfield @culler @slel @orlitzky @vbraun @maxale tmonteil @jhpalmieri

as reported in https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ

Issue created by migration from https://trac.sagemath.org/ticket/32424





---

archive/issue_comments_459692.json:
```json
{
    "body": "The signal error is caused by `nullspaceMP`, which is in the iml library.\n\nIml itself doesn't use architecture specific instructions, but the dependencies are.\nBut then again, OPENBLAS and gmp are already built with `make DYNAMIC_ARCH=1` resp. `--enable-fat`. Both of them got updated between sage 9.0 and sage 9.3.",
    "created_at": "2021-08-26T09:47:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459692",
    "user": "@kliem"
}
```

The signal error is caused by `nullspaceMP`, which is in the iml library.

Iml itself doesn't use architecture specific instructions, but the dependencies are.
But then again, OPENBLAS and gmp are already built with `make DYNAMIC_ARCH=1` resp. `--enable-fat`. Both of them got updated between sage 9.0 and sage 9.3.



---

archive/issue_comments_459693.json:
```json
{
    "body": "I suspect the cause is OpenBLAS.  While this library is built with DYNAMIC_ARCH=1, there is still the non-performance critical code in it which will use whatever instructions are available on the machine at compile time unless you **also** set TARGET.  See\n\nhttps://github.com/xianyi/OpenBLAS/issues/3056\n\nFor the macOS app, Marc Culler had to set TARGET=CORE2 in addition to DYNAMIC_ARCH=1 so that it would run on a 2013 cylindrical Mac Pro.",
    "created_at": "2021-08-26T18:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459693",
    "user": "@NathanDunfield"
}
```

I suspect the cause is OpenBLAS.  While this library is built with DYNAMIC_ARCH=1, there is still the non-performance critical code in it which will use whatever instructions are available on the machine at compile time unless you **also** set TARGET.  See

https://github.com/xianyi/OpenBLAS/issues/3056

For the macOS app, Marc Culler had to set TARGET=CORE2 in addition to DYNAMIC_ARCH=1 so that it would run on a 2013 cylindrical Mac Pro.



---

archive/issue_comments_459694.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-26T19:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459694",
    "user": "@isuruf"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_459695.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-08-26T19:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459695",
    "user": "@isuruf"
}
```

New commits:



---

archive/issue_comments_459696.json:
```json
{
    "body": "should we also throw in an openblas upgrade? https://repology.org/projects/o/?inrepo=sagemath_stable",
    "created_at": "2021-08-26T19:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459696",
    "user": "@mkoeppe"
}
```

should we also throw in an openblas upgrade? https://repology.org/projects/o/?inrepo=sagemath_stable



---

archive/issue_comments_459697.json:
```json
{
    "body": "Yes, that would be good to have. I didn't realize openblas was way behind.\nFeel free to push to this branch",
    "created_at": "2021-08-26T19:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459697",
    "user": "@isuruf"
}
```

Yes, that would be good to have. I didn't realize openblas was way behind.
Feel free to push to this branch



---

archive/issue_comments_459698.json:
```json
{
    "body": "on macOS:\n\n```\n[openblas-0.3.17] ./spkg-install: line 55: conditional binary operator expected\n[openblas-0.3.17] ./spkg-install: line 55: syntax error near `~='\n[openblas-0.3.17] ./spkg-install: line 55: `    if [[ $os-$machine ~= darwin-x86_64 ]]; then'\n```\n",
    "created_at": "2021-08-26T20:03:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459698",
    "user": "@mkoeppe"
}
```

on macOS:

```
[openblas-0.3.17] ./spkg-install: line 55: conditional binary operator expected
[openblas-0.3.17] ./spkg-install: line 55: syntax error near `~='
[openblas-0.3.17] ./spkg-install: line 55: `    if [[ $os-$machine ~= darwin-x86_64 ]]; then'
```




---

archive/issue_comments_459699.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-08-26T23:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459699",
    "user": "@slel"
}
```

New commits:



---

archive/issue_comments_459700.json:
```json
{
    "body": "Changing keywords from \"\" to \"upgrade, openblas\".",
    "created_at": "2021-08-26T23:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459700",
    "user": "@slel"
}
```

Changing keywords from "" to "upgrade, openblas".



---

archive/issue_comments_459701.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-08-27T00:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459701",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_459702.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-08-27T00:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459702",
    "user": "@isuruf"
}
```

New commits:



---

archive/issue_comments_459703.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-27T19:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459703",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_459704.json:
```json
{
    "body": "For `SAGE_FAT_BINARY`, I think we have to set the `TARGET` to the \"oldest\" value that we expect the binaries to run on. If that's right, then using the `uname` will make it so that the binaries are portable only to other machines with the same (or \"newer\") `uname`.\n\n`CORE2` sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise.",
    "created_at": "2021-09-01T12:10:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459704",
    "user": "@orlitzky"
}
```

For `SAGE_FAT_BINARY`, I think we have to set the `TARGET` to the "oldest" value that we expect the binaries to run on. If that's right, then using the `uname` will make it so that the binaries are portable only to other machines with the same (or "newer") `uname`.

`CORE2` sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise.



---

archive/issue_comments_459705.json:
```json
{
    "body": "> If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or \"newer\") uname. \n\nThat's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?\n\n> CORE2 sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise. \n\nCORE2 is only for x86_64. Besides TARGET is needed only for non-performance critical code paths.",
    "created_at": "2021-09-01T12:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459705",
    "user": "@isuruf"
}
```

> If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 

That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?

> CORE2 sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise. 

CORE2 is only for x86_64. Besides TARGET is needed only for non-performance critical code paths.



---

archive/issue_comments_459706.json:
```json
{
    "body": "Replying to [comment:20 isuruf]:\n> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or \"newer\") uname. \n> \n> That's correct. What's wrong with that?\n\nNothing, I didn't look closely enough at the cases. The only two that overlap in any way are x86_64 and x86, and setting `TARGET` to an x86 value on an x86_64 machine won't magically make it produce 32-bit binaries, so... LGTM now.",
    "created_at": "2021-09-01T12:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459706",
    "user": "@orlitzky"
}
```

Replying to [comment:20 isuruf]:
> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 
> 
> That's correct. What's wrong with that?

Nothing, I didn't look closely enough at the cases. The only two that overlap in any way are x86_64 and x86, and setting `TARGET` to an x86 value on an x86_64 machine won't magically make it produce 32-bit binaries, so... LGTM now.



---

archive/issue_comments_459707.json:
```json
{
    "body": "I think instead of `uname`, we should use `$CC -dumpmachine` like we do in `build/pkgs/gfortran/spkg-build.in` from #29241",
    "created_at": "2021-09-01T18:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459707",
    "user": "@mkoeppe"
}
```

I think instead of `uname`, we should use `$CC -dumpmachine` like we do in `build/pkgs/gfortran/spkg-build.in` from #29241



---

archive/issue_comments_459708.json:
```json
{
    "body": "Replying to [comment:20 isuruf]:\n> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or \"newer\") uname. \n> \n> That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?\n\nThey often do, via qemu and `binfmt_misc`..., see https://hub.docker.com/r/multiarch/ubuntu-core",
    "created_at": "2021-09-01T18:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459708",
    "user": "@mkoeppe"
}
```

Replying to [comment:20 isuruf]:
> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 
> 
> That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?

They often do, via qemu and `binfmt_misc`..., see https://hub.docker.com/r/multiarch/ubuntu-core



---

archive/issue_comments_459709.json:
```json
{
    "body": "> They often do, via qemu and binfmt_misc\n\nThat's not relevant either. qemu would emulate the instruction set\nincluding cpuid instruction.",
    "created_at": "2021-09-01T20:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459709",
    "user": "@isuruf"
}
```

> They often do, via qemu and binfmt_misc

That's not relevant either. qemu would emulate the instruction set
including cpuid instruction.



---

archive/issue_comments_459710.json:
```json
{
    "body": "But because of the `binfmt_misc` emulation route, you cannot rely on `uname` to reason about the target architecture, i.e., comment:22 applies not just for x86_64/i686.",
    "created_at": "2021-09-01T20:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459710",
    "user": "@mkoeppe"
}
```

But because of the `binfmt_misc` emulation route, you cannot rely on `uname` to reason about the target architecture, i.e., comment:22 applies not just for x86_64/i686.



---

archive/issue_comments_459711.json:
```json
{
    "body": "> But because of the binfmt_misc emulation route, you cannot rely on uname to reason about the target architecture, i.e., comment:22 applies not just for x86_64/i686.\n\nOpenblas `spkg-install.in` doesn't support building for non-native architecture\neven on `develop` branch.",
    "created_at": "2021-09-01T20:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459711",
    "user": "@isuruf"
}
```

> But because of the binfmt_misc emulation route, you cannot rely on uname to reason about the target architecture, i.e., comment:22 applies not just for x86_64/i686.

Openblas `spkg-install.in` doesn't support building for non-native architecture
even on `develop` branch.



---

archive/issue_comments_459712.json:
```json
{
    "body": "We do test this at least for i686 on x86_64 - see for example https://github.com/sagemath/sage/runs/3392765581?check_suite_focus=true\n(which needed #29241)",
    "created_at": "2021-09-01T20:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459712",
    "user": "@mkoeppe"
}
```

We do test this at least for i686 on x86_64 - see for example https://github.com/sagemath/sage/runs/3392765581?check_suite_focus=true
(which needed #29241)



---

archive/issue_comments_459713.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-01T20:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459713",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459714.json:
```json
{
    "body": "testing on top of 9.5.beta0",
    "created_at": "2021-09-02T03:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459714",
    "user": "@mkoeppe"
}
```

testing on top of 9.5.beta0



---

archive/issue_comments_459715.json:
```json
{
    "body": "The tests on Linux and macOS (https://github.com/mkoeppe/sage/actions/runs/1192736161 ) look normal. Note that they do not test `--enable-fat-binary` at all.\nUnchanged:  `centos-7-i386` gives SIGFPE while building dochtml. Reported in https://groups.google.com/g/sage-release/c/ocdEAV4pFMo/m/4BEdJZQ8BAAJ for 9.4.rc1 (and probably earlier).\n\nThe test on Cygwin (https://github.com/mkoeppe/sage/actions/runs/1192736162) uses `--enable-fat-binary`. Unchanged: It gives the same segfaults whenever plotting is used (https://github.com/mkoeppe/sage/runs/3506881828) that showed up in the previous betas.\n\nSo this seems safe to merge, but it remains unknown whether it helps at all. Some help from the people who build and test binaries is needed here.",
    "created_at": "2021-09-03T18:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459715",
    "user": "@mkoeppe"
}
```

The tests on Linux and macOS (https://github.com/mkoeppe/sage/actions/runs/1192736161 ) look normal. Note that they do not test `--enable-fat-binary` at all.
Unchanged:  `centos-7-i386` gives SIGFPE while building dochtml. Reported in https://groups.google.com/g/sage-release/c/ocdEAV4pFMo/m/4BEdJZQ8BAAJ for 9.4.rc1 (and probably earlier).

The test on Cygwin (https://github.com/mkoeppe/sage/actions/runs/1192736162) uses `--enable-fat-binary`. Unchanged: It gives the same segfaults whenever plotting is used (https://github.com/mkoeppe/sage/runs/3506881828) that showed up in the previous betas.

So this seems safe to merge, but it remains unknown whether it helps at all. Some help from the people who build and test binaries is needed here.



---

archive/issue_comments_459716.json:
```json
{
    "body": "let's merge this then",
    "created_at": "2021-09-25T20:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459716",
    "user": "@dimpase"
}
```

let's merge this then



---

archive/issue_comments_459717.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-25T20:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459717",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459718.json:
```json
{
    "body": "Segfaults on OSX\n\n```\nsage: for i in range(0,n2):\n   A[i,i]=4*h2+1.\n   if i+1<n2: A[i,int(i+1)]=-h2\n   if i>0:    A[i,int(i-1)]=-h2\n   if i+n<n2: A[i,int(i+n)]=-h2\n   if i-n>=0: A[i,int(i-n)]=-h2 ## line 366 ##\nsage: Acsc = A.tocsc() ## line 372 ##\nsage: b = array([1 for i in range(0,n2)]) ## line 373 ##\nsage: solve = factorized(Acsc) # LU factorization ## line 374 ##\n------------------------------------------------------------------------\n0   signals.cpython-39-darwin.so        0x0000000103db93e2 print_backtrace + 66\n1   signals.cpython-39-darwin.so        0x0000000103dbd097 sigdie + 39\n2   signals.cpython-39-darwin.so        0x0000000103dbcf84 cysigs_signal_handler + 404\n3   libsystem_platform.dylib            0x00007fff7132b5fd _sigtramp + 29\n4   ???                                 0x0000000000000013 0x0 + 19\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py  # Killed due to segmentation fault\n----------------------------------------------------------------------\n```\n",
    "created_at": "2021-10-07T22:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459718",
    "user": "@vbraun"
}
```

Segfaults on OSX

```
sage: for i in range(0,n2):
   A[i,i]=4*h2+1.
   if i+1<n2: A[i,int(i+1)]=-h2
   if i>0:    A[i,int(i-1)]=-h2
   if i+n<n2: A[i,int(i+n)]=-h2
   if i-n>=0: A[i,int(i-n)]=-h2 ## line 366 ##
sage: Acsc = A.tocsc() ## line 372 ##
sage: b = array([1 for i in range(0,n2)]) ## line 373 ##
sage: solve = factorized(Acsc) # LU factorization ## line 374 ##
------------------------------------------------------------------------
0   signals.cpython-39-darwin.so        0x0000000103db93e2 print_backtrace + 66
1   signals.cpython-39-darwin.so        0x0000000103dbd097 sigdie + 39
2   signals.cpython-39-darwin.so        0x0000000103dbcf84 cysigs_signal_handler + 404
3   libsystem_platform.dylib            0x00007fff7132b5fd _sigtramp + 29
4   ???                                 0x0000000000000013 0x0 + 19
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
**********************************************************************
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py  # Killed due to segmentation fault
----------------------------------------------------------------------
```




---

archive/issue_comments_459719.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-07T22:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459719",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_459720.json:
```json
{
    "body": "Obviously we need more detail about the platform",
    "created_at": "2021-10-07T22:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459720",
    "user": "@mkoeppe"
}
```

Obviously we need more detail about the platform



---

archive/issue_comments_459721.json:
```json
{
    "body": "In the meantime 0.3.18 has come out",
    "created_at": "2021-10-07T23:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459721",
    "user": "@mkoeppe"
}
```

In the meantime 0.3.18 has come out



---

archive/issue_comments_459722.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-08T13:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459722",
    "user": "@dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_459723.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-08T13:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459723",
    "user": "@dimpase"
}
```

New commits:



---

archive/issue_comments_459724.json:
```json
{
    "body": "update to 0.3.18",
    "created_at": "2021-10-08T13:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459724",
    "user": "@dimpase"
}
```

update to 0.3.18



---

archive/issue_comments_459725.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-14T11:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459725",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459726.json:
```json
{
    "body": "let's get this in, see if it helps with that not easy to reproduce bug.",
    "created_at": "2021-10-14T11:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459726",
    "user": "@dimpase"
}
```

let's get this in, see if it helps with that not easy to reproduce bug.



---

archive/issue_comments_459727.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-20T23:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459727",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_459728.json:
```json
{
    "body": "still segfaults on mac in the same spot",
    "created_at": "2021-10-23T09:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459728",
    "user": "@vbraun"
}
```

still segfaults on mac in the same spot



---

archive/issue_comments_459729.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2021-10-23T09:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459729",
    "user": "@vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_459730.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2021-10-23T09:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459730",
    "user": "@vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_459731.json:
```json
{
    "body": "are you unmerging this ticket? it is a valid update, no regressions, right?",
    "created_at": "2021-10-23T09:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459731",
    "user": "@dimpase"
}
```

are you unmerging this ticket? it is a valid update, no regressions, right?



---

archive/issue_comments_459732.json:
```json
{
    "body": "There is a regression, this used to work and is now segfaulting on osx:\n\n```\n>>> solve = factorized(Acsc) # LU factorization\nProcess 56588 stopped\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)\n    frame #0: 0x0000000107d55588 libopenblas_penrynp-r0.3.18.dylib`.L01\nlibopenblas_penrynp-r0.3.18.dylib`.L01:\n->  0x107d55588 <+0>:  movaps %xmm4, (%rbp)\n    0x107d5558c <+4>:  movaps %xmm4, 0x10(%rbp)\n    0x107d55590 <+8>:  movaps %xmm4, 0x20(%rbp)\n    0x107d55594 <+12>: movaps %xmm4, 0x30(%rbp)\nTarget 0: (python3) stopped.\n```\n",
    "created_at": "2021-10-23T14:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459732",
    "user": "@vbraun"
}
```

There is a regression, this used to work and is now segfaulting on osx:

```
>>> solve = factorized(Acsc) # LU factorization
Process 56588 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)
    frame #0: 0x0000000107d55588 libopenblas_penrynp-r0.3.18.dylib`.L01
libopenblas_penrynp-r0.3.18.dylib`.L01:
->  0x107d55588 <+0>:  movaps %xmm4, (%rbp)
    0x107d5558c <+4>:  movaps %xmm4, 0x10(%rbp)
    0x107d55590 <+8>:  movaps %xmm4, 0x20(%rbp)
    0x107d55594 <+12>: movaps %xmm4, 0x30(%rbp)
Target 0: (python3) stopped.
```




---

archive/issue_comments_459733.json:
```json
{
    "body": "Building Sage with\n\n```\nOPENBLAS_CONFIGURE=\"TARGET=PENRYN DEBUG=1 USE_OPENMP=0\" make\n```\n\nworks, so its apparently a threading-related issue. Kinda guessed that from the messed up stack trace, seems to be in a thread thats not doing so well.",
    "created_at": "2021-10-24T09:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459733",
    "user": "@vbraun"
}
```

Building Sage with

```
OPENBLAS_CONFIGURE="TARGET=PENRYN DEBUG=1 USE_OPENMP=0" make
```

works, so its apparently a threading-related issue. Kinda guessed that from the messed up stack trace, seems to be in a thread thats not doing so well.



---

archive/issue_comments_459734.json:
```json
{
    "body": "Possibly related: https://github.com/xianyi/OpenBLAS/issues/2787",
    "created_at": "2021-10-24T10:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459734",
    "user": "@vbraun"
}
```

Possibly related: https://github.com/xianyi/OpenBLAS/issues/2787



---

archive/issue_comments_459735.json:
```json
{
    "body": "Replying to [comment:46 vbraun]:\n> There is a regression, this used to work and is now segfaulting on osx:\n\nVolker, more details please: \n\n* was OpenBLAS built from source? \n* On what version of macOS? \n* On what CPU?",
    "created_at": "2021-10-26T07:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459735",
    "user": "@dimpase"
}
```

Replying to [comment:46 vbraun]:
> There is a regression, this used to work and is now segfaulting on osx:

Volker, more details please: 

* was OpenBLAS built from source? 
* On what version of macOS? 
* On what CPU?



---

archive/issue_comments_459736.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-26T07:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459736",
    "user": "@dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_459737.json:
```json
{
    "body": "I'm running full builds; Does the following work for you? For me, it segfaults:\n\n```\nmake distclean\nOPENBLAS_CONFIGURE=\"TARGET=PENRYN\" make -j10\nsage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n```\n\nBoth Catalina and BigSur. CPU is qemu64 (lowest-common denominator, which is why openblas picks Penryn).",
    "created_at": "2021-10-26T19:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459737",
    "user": "@vbraun"
}
```

I'm running full builds; Does the following work for you? For me, it segfaults:

```
make distclean
OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
```

Both Catalina and BigSur. CPU is qemu64 (lowest-common denominator, which is why openblas picks Penryn).



---

archive/issue_comments_459738.json:
```json
{
    "body": "hmm, so it's a qemu64 running macOS on a Mac? \n\nOr a hackintosh, i.e. qemu running macOS on Linux?\n\nHow is this a meaningful test, and not testing the resolve of Apple to prevent \"illegal\" macOS emulators?",
    "created_at": "2021-10-26T20:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459738",
    "user": "@dimpase"
}
```

hmm, so it's a qemu64 running macOS on a Mac? 

Or a hackintosh, i.e. qemu running macOS on Linux?

How is this a meaningful test, and not testing the resolve of Apple to prevent "illegal" macOS emulators?



---

archive/issue_comments_459739.json:
```json
{
    "body": "Replying to [comment:51 vbraun]:\n> I'm running full builds; Does the following work for you? For me, it segfaults:\n> {{{\n> make distclean\n> OPENBLAS_CONFIGURE=\"TARGET=PENRYN\" make -j10\n> sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n> }}}\n\nVolker, this recipe is wildly underspecified. When you post failures like this, could you please attach at least the `config.log` and the build log of the package?",
    "created_at": "2021-10-26T21:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459739",
    "user": "@mkoeppe"
}
```

Replying to [comment:51 vbraun]:
> I'm running full builds; Does the following work for you? For me, it segfaults:
> {{{
> make distclean
> OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
> sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
> }}}

Volker, this recipe is wildly underspecified. When you post failures like this, could you please attach at least the `config.log` and the build log of the package?



---

archive/issue_comments_459740.json:
```json
{
    "body": "It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.\n\nBTW you have an account on `catalina-osx`, too ;)",
    "created_at": "2021-10-26T21:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459740",
    "user": "@vbraun"
}
```

It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.

BTW you have an account on `catalina-osx`, too ;)



---

archive/issue_comments_459741.json:
```json
{
    "body": "Can we split the two things in this ticket?\n\nFixing fat binaries and upgrading openblas?",
    "created_at": "2021-10-26T21:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459741",
    "user": "@isuruf"
}
```

Can we split the two things in this ticket?

Fixing fat binaries and upgrading openblas?



---

archive/issue_comments_459742.json:
```json
{
    "body": "Replying to [comment:54 vbraun]:\n> It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.\n> \nyou might be just hitting a deficiency in your Hackingtosh, not a real bug.\n\n \n\n> BTW you have an account on `catalina-osx`, too ;)",
    "created_at": "2021-10-27T22:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459742",
    "user": "@dimpase"
}
```

Replying to [comment:54 vbraun]:
> It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.
> 
you might be just hitting a deficiency in your Hackingtosh, not a real bug.

 

> BTW you have an account on `catalina-osx`, too ;)



---

archive/issue_comments_459743.json:
```json
{
    "body": "Logs are here: http://sagepad.org/pub/sage/32424/",
    "created_at": "2021-10-28T22:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459743",
    "user": "@vbraun"
}
```

Logs are here: http://sagepad.org/pub/sage/32424/



---

archive/issue_comments_459744.json:
```json
{
    "body": "from config.log one can see you have another OpenBLAS installed on the box \n(pkg-config finds it)\n\nCan you, just as a sanitary check,  uninstall it and check that you can reproduce the crash?",
    "created_at": "2021-10-29T12:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459744",
    "user": "@dimpase"
}
```

from config.log one can see you have another OpenBLAS installed on the box 
(pkg-config finds it)

Can you, just as a sanitary check,  uninstall it and check that you can reproduce the crash?



---

archive/issue_comments_459745.json:
```json
{
    "body": "I don't have another openblas; it seems the configure prints `configure:12750: result: openblas` by default even if you don't have any blas:\n\n```\n  12734 # Check whether --with-blas was given.\n  12735 if test \"${with_blas+set}\" = set; then :\n  12736   withval=$with_blas;\n  12737 else\n  12738   with_blas=openblas  # default\n  12739 \n  12740 fi\n  12741 \n  12742   case \"$with_blas\" in #(\n  12743   openblas) :\n  12744      ;; #(\n  12745   atlas) :\n  12746     sage_spkg_install_openblas=no ;; #(\n  12747   *) :\n  12748     as_fn_error $? \"allowed values for --with-blas are 'atlas' and 'openblas'\" \"$LINENO\" 5 ;;\n  12749 esac\n  12750   { $as_echo \"$as_me:${as_lineno-$LINENO}: result: $with_blas\" >&5\n```\n",
    "created_at": "2021-10-29T23:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459745",
    "user": "@vbraun"
}
```

I don't have another openblas; it seems the configure prints `configure:12750: result: openblas` by default even if you don't have any blas:

```
  12734 # Check whether --with-blas was given.
  12735 if test "${with_blas+set}" = set; then :
  12736   withval=$with_blas;
  12737 else
  12738   with_blas=openblas  # default
  12739 
  12740 fi
  12741 
  12742   case "$with_blas" in #(
  12743   openblas) :
  12744      ;; #(
  12745   atlas) :
  12746     sage_spkg_install_openblas=no ;; #(
  12747   *) :
  12748     as_fn_error $? "allowed values for --with-blas are 'atlas' and 'openblas'" "$LINENO" 5 ;;
  12749 esac
  12750   { $as_echo "$as_me:${as_lineno-$LINENO}: result: $with_blas" >&5
```




---

archive/issue_comments_459746.json:
```json
{
    "body": "maybe it needs gfortran 11?",
    "created_at": "2021-10-30T11:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459746",
    "user": "@dimpase"
}
```

maybe it needs gfortran 11?



---

archive/issue_comments_459747.json:
```json
{
    "body": "also, one might need more details on the hist CPU and how qemu is started/configured.",
    "created_at": "2021-10-30T11:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459747",
    "user": "@dimpase"
}
```

also, one might need more details on the hist CPU and how qemu is started/configured.



---

archive/issue_comments_459748.json:
```json
{
    "body": "Replying to [comment:53 mkoeppe]:\n> Replying to [comment:51 vbraun]:\n> > I'm running full builds; Does the following work for you? For me, it segfaults:\n> > {{{\n> > make distclean\n> > OPENBLAS_CONFIGURE=\"TARGET=PENRYN\" make -j10\n> > sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n> > }}}\n\nBased on the provided logs, I have built a similar configuration using `OPENBLAS_CONFIGURE=TARGET=PENRYN tox -e local-macos-nohomebrew -- bash` on a real Mac (Intelr Core i9, Big Sur). The tests pass.\n\nI'll try again now after merging 9.5.beta5.\n----\nNew commits:",
    "created_at": "2021-10-30T19:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459748",
    "user": "@mkoeppe"
}
```

Replying to [comment:53 mkoeppe]:
> Replying to [comment:51 vbraun]:
> > I'm running full builds; Does the following work for you? For me, it segfaults:
> > {{{
> > make distclean
> > OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
> > sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
> > }}}

Based on the provided logs, I have built a similar configuration using `OPENBLAS_CONFIGURE=TARGET=PENRYN tox -e local-macos-nohomebrew -- bash` on a real Mac (Intelr Core i9, Big Sur). The tests pass.

I'll try again now after merging 9.5.beta5.
----
New commits:



---

archive/issue_comments_459749.json:
```json
{
    "body": "Volker, I'd suggest that you take the problem on your configuration upstream by trying to reproduce it outside of Sage.",
    "created_at": "2021-10-30T19:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459749",
    "user": "@mkoeppe"
}
```

Volker, I'd suggest that you take the problem on your configuration upstream by trying to reproduce it outside of Sage.



---

archive/issue_comments_459750.json:
```json
{
    "body": "Replying to [comment:63 mkoeppe]:\n> I'll try again now after merging 9.5.beta5.\nSame result, all good.",
    "created_at": "2021-10-30T21:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459750",
    "user": "@mkoeppe"
}
```

Replying to [comment:63 mkoeppe]:
> I'll try again now after merging 9.5.beta5.
Same result, all good.



---

archive/issue_comments_459751.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-31T20:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459751",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459752.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-31T21:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459752",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_459753.json:
```json
{
    "body": "Something is definitely not right. Its not just TARGET=PENRYN, with that it also works for me.",
    "created_at": "2021-10-31T21:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459753",
    "user": "@vbraun"
}
```

Something is definitely not right. Its not just TARGET=PENRYN, with that it also works for me.



---

archive/issue_comments_459754.json:
```json
{
    "body": "So what is the configuration that fails for you?",
    "created_at": "2021-10-31T21:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459754",
    "user": "@mkoeppe"
}
```

So what is the configuration that fails for you?



---

archive/issue_comments_459755.json:
```json
{
    "body": "This is the Makefile.conf that segfaults:\n\n```\nOSNAME=Darwin\nARCH=x86_64\nC_COMPILER=CLANG\nBINARY32=\nBINARY64=1\nFU=_\nCEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/usr/local/lib  -lto_library -lSystem  /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/lib/darwin/libclang_rt.osx.a \nF_COMPILER=GFORTRAN\nFC=gfortran\nBU=_\nFEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../.. -L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  \nCORE=PENRYN\nLIBCORE=penryn\nNUM_CORES=8\nHAVE_MMX=1\nHAVE_SSE=1\nHAVE_SSE2=1\nHAVE_SSE3=1\nHAVE_SSSE3=1\nHAVE_SSE4_1=1\nHAVE_SSE4_2=1\nHAVE_AVX=1\nMAKE += -j 8\nSBGEMM_UNROLL_M=8\nSBGEMM_UNROLL_N=4\nSGEMM_UNROLL_M=8\nSGEMM_UNROLL_N=4\nDGEMM_UNROLL_M=4\nDGEMM_UNROLL_N=4\nQGEMM_UNROLL_M=2\nQGEMM_UNROLL_N=2\nCGEMM_UNROLL_M=4\nCGEMM_UNROLL_N=2\nZGEMM_UNROLL_M=2\nZGEMM_UNROLL_N=2\nXGEMM_UNROLL_M=1\nXGEMM_UNROLL_N=1\nCGEMM3M_UNROLL_M=8\nCGEMM3M_UNROLL_N=4\nZGEMM3M_UNROLL_M=4\nZGEMM3M_UNROLL_N=4\nXGEMM3M_UNROLL_M=2\nXGEMM3M_UNROLL_N=2\n```\n",
    "created_at": "2021-10-31T21:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459755",
    "user": "@vbraun"
}
```

This is the Makefile.conf that segfaults:

```
OSNAME=Darwin
ARCH=x86_64
C_COMPILER=CLANG
BINARY32=
BINARY64=1
FU=_
CEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/usr/local/lib  -lto_library -lSystem  /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/lib/darwin/libclang_rt.osx.a 
F_COMPILER=GFORTRAN
FC=gfortran
BU=_
FEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../.. -L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  
CORE=PENRYN
LIBCORE=penryn
NUM_CORES=8
HAVE_MMX=1
HAVE_SSE=1
HAVE_SSE2=1
HAVE_SSE3=1
HAVE_SSSE3=1
HAVE_SSE4_1=1
HAVE_SSE4_2=1
HAVE_AVX=1
MAKE += -j 8
SBGEMM_UNROLL_M=8
SBGEMM_UNROLL_N=4
SGEMM_UNROLL_M=8
SGEMM_UNROLL_N=4
DGEMM_UNROLL_M=4
DGEMM_UNROLL_N=4
QGEMM_UNROLL_M=2
QGEMM_UNROLL_N=2
CGEMM_UNROLL_M=4
CGEMM_UNROLL_N=2
ZGEMM_UNROLL_M=2
ZGEMM_UNROLL_N=2
XGEMM_UNROLL_M=1
XGEMM_UNROLL_N=1
CGEMM3M_UNROLL_M=8
CGEMM3M_UNROLL_N=4
ZGEMM3M_UNROLL_M=4
ZGEMM3M_UNROLL_N=4
XGEMM3M_UNROLL_M=2
XGEMM3M_UNROLL_N=2
```




---

archive/issue_comments_459756.json:
```json
{
    "body": "The build log is identical to one with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` except that the latter doesn't segfault, so it must be in the config.h value",
    "created_at": "2021-10-31T22:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459756",
    "user": "@vbraun"
}
```

The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value



---

archive/issue_comments_459757.json:
```json
{
    "body": "config.h:\n\n```\n#define OS_DARWIN\t1\n#define ARCH_X86_64\t1\n#define C_CLANG\t1\n#define __64BIT__\t1\n#define FUNDERSCORE\t_\n#define HAVE_C11\t1\n#define PTHREAD_CREATE_FUNC\tpthread_create\n#define BUNDERSCORE\t_\n#define NEEDBUNDERSCORE\t1\n#define PENRYN\n#define L1_CODE_SIZE 32768\n#define L1_CODE_ASSOCIATIVE 8\n#define L1_CODE_LINESIZE 64\n#define L1_DATA_SIZE 32768\n#define L1_DATA_ASSOCIATIVE 8\n#define L1_DATA_LINESIZE 64\n#define L2_SIZE 2097152\n#define L2_ASSOCIATIVE 8\n#define L2_LINESIZE 64\n#define L3_SIZE 16777216\n#define L3_ASSOCIATIVE 16\n#define L3_LINESIZE 64\n#define DTB_DEFAULT_ENTRIES 32\n#define HAVE_CMOV\n#define HAVE_MMX\n#define HAVE_SSE\n#define HAVE_SSE2\n#define HAVE_SSE3\n#define HAVE_SSSE3\n#define HAVE_SSE4_1\n#define HAVE_SSE4_2\n#define HAVE_AVX\n#define HAVE_CFLUSH\n#define NUM_SHAREDCACHE 1\n#define NUM_CORES 1\n#define CORE_PENRYN\n#define CHAR_CORENAME \"PENRYN\"\n#define SLOCAL_BUFFER_SIZE\t32768\n#define DLOCAL_BUFFER_SIZE\t16384\n#define CLOCAL_BUFFER_SIZE\t32768\n#define ZLOCAL_BUFFER_SIZE\t16384\n#define GEMM_MULTITHREAD_THRESHOLD\t4\n```\n",
    "created_at": "2021-10-31T22:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459757",
    "user": "@vbraun"
}
```

config.h:

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define HAVE_C11	1
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define PENRYN
#define L1_CODE_SIZE 32768
#define L1_CODE_ASSOCIATIVE 8
#define L1_CODE_LINESIZE 64
#define L1_DATA_SIZE 32768
#define L1_DATA_ASSOCIATIVE 8
#define L1_DATA_LINESIZE 64
#define L2_SIZE 2097152
#define L2_ASSOCIATIVE 8
#define L2_LINESIZE 64
#define L3_SIZE 16777216
#define L3_ASSOCIATIVE 16
#define L3_LINESIZE 64
#define DTB_DEFAULT_ENTRIES 32
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define HAVE_SSE4_2
#define HAVE_AVX
#define HAVE_CFLUSH
#define NUM_SHAREDCACHE 1
#define NUM_CORES 1
#define CORE_PENRYN
#define CHAR_CORENAME "PENRYN"
#define SLOCAL_BUFFER_SIZE	32768
#define DLOCAL_BUFFER_SIZE	16384
#define CLOCAL_BUFFER_SIZE	32768
#define ZLOCAL_BUFFER_SIZE	16384
#define GEMM_MULTITHREAD_THRESHOLD	4
```




---

archive/issue_comments_459758.json:
```json
{
    "body": "My configuration (works): \n\nMakefile.conf:\n\n```\nOSNAME=Darwin\nARCH=x86_64\nC_COMPILER=CLANG\nBINARY32=\nBINARY64=1\nFU=_\nCEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib  -lto_library -lSystem  /Library/Developer/CommandLineTools/usr/lib/clang/13.0.0/lib/darwin/libclang_rt.osx.a \nF_COMPILER=GFORTRAN\nFC=gfortran\nBU=_\nFEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../.. -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  \nCORE=PENRYN\nLIBCORE=penryn\nNUM_CORES=12\nPENRYN=1\nL1_DATA_SIZE=32768\nL1_DATA_LINESIZE=64\nL2_SIZE=1048576\nL2_LINESIZE=64\nDTB_DEFAULT_ENTRIES=256\nDTB_SIZE=4096\nHAVE_CMOV=1\nHAVE_MMX=1\nHAVE_SSE=1\nHAVE_SSE2=1\nHAVE_SSE3=1\nHAVE_SSSE3=1\nHAVE_SSE4_1=1\nMAKE += -j 12\nSBGEMM_UNROLL_M=8\nSBGEMM_UNROLL_N=4\nSGEMM_UNROLL_M=8\nSGEMM_UNROLL_N=4\nDGEMM_UNROLL_M=4\nDGEMM_UNROLL_N=4\nQGEMM_UNROLL_M=2\nQGEMM_UNROLL_N=2\nCGEMM_UNROLL_M=4\nCGEMM_UNROLL_N=2\nZGEMM_UNROLL_M=2\nZGEMM_UNROLL_N=2\nXGEMM_UNROLL_M=1\nXGEMM_UNROLL_N=1\nCGEMM3M_UNROLL_M=8\nCGEMM3M_UNROLL_N=4\nZGEMM3M_UNROLL_M=4\nZGEMM3M_UNROLL_N=4\nXGEMM3M_UNROLL_M=2\nXGEMM3M_UNROLL_N=2\n```\n\n\n\nconfig.h:\n\n```\n#define OS_DARWIN\t1\n#define ARCH_X86_64\t1\n#define C_CLANG\t1\n#define __64BIT__\t1\n#define FUNDERSCORE\t_\n#define HAVE_C11\t1\n#define PTHREAD_CREATE_FUNC\tpthread_create\n#define BUNDERSCORE\t_\n#define NEEDBUNDERSCORE\t1\n#define PENRYN\n#define L1_DATA_SIZE 32768\n#define L1_DATA_LINESIZE 64\n#define L2_SIZE 1048576\n#define L2_LINESIZE 64\n#define DTB_DEFAULT_ENTRIES 256\n#define DTB_SIZE 4096\n#define HAVE_CMOV\n#define HAVE_MMX\n#define HAVE_SSE\n#define HAVE_SSE2\n#define HAVE_SSE3\n#define HAVE_SSSE3\n#define HAVE_SSE4_1\n#define CORE_PENRYN\n#define CHAR_CORENAME \"PENRYN\"\n#define SLOCAL_BUFFER_SIZE\t32768\n#define DLOCAL_BUFFER_SIZE\t16384\n#define CLOCAL_BUFFER_SIZE\t32768\n#define ZLOCAL_BUFFER_SIZE\t16384\n#define GEMM_MULTITHREAD_THRESHOLD\t4\n```\n",
    "created_at": "2021-10-31T22:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459758",
    "user": "@mkoeppe"
}
```

My configuration (works): 

Makefile.conf:

```
OSNAME=Darwin
ARCH=x86_64
C_COMPILER=CLANG
BINARY32=
BINARY64=1
FU=_
CEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib  -lto_library -lSystem  /Library/Developer/CommandLineTools/usr/lib/clang/13.0.0/lib/darwin/libclang_rt.osx.a 
F_COMPILER=GFORTRAN
FC=gfortran
BU=_
FEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../.. -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  
CORE=PENRYN
LIBCORE=penryn
NUM_CORES=12
PENRYN=1
L1_DATA_SIZE=32768
L1_DATA_LINESIZE=64
L2_SIZE=1048576
L2_LINESIZE=64
DTB_DEFAULT_ENTRIES=256
DTB_SIZE=4096
HAVE_CMOV=1
HAVE_MMX=1
HAVE_SSE=1
HAVE_SSE2=1
HAVE_SSE3=1
HAVE_SSSE3=1
HAVE_SSE4_1=1
MAKE += -j 12
SBGEMM_UNROLL_M=8
SBGEMM_UNROLL_N=4
SGEMM_UNROLL_M=8
SGEMM_UNROLL_N=4
DGEMM_UNROLL_M=4
DGEMM_UNROLL_N=4
QGEMM_UNROLL_M=2
QGEMM_UNROLL_N=2
CGEMM_UNROLL_M=4
CGEMM_UNROLL_N=2
ZGEMM_UNROLL_M=2
ZGEMM_UNROLL_N=2
XGEMM_UNROLL_M=1
XGEMM_UNROLL_N=1
CGEMM3M_UNROLL_M=8
CGEMM3M_UNROLL_N=4
ZGEMM3M_UNROLL_M=4
ZGEMM3M_UNROLL_N=4
XGEMM3M_UNROLL_M=2
XGEMM3M_UNROLL_N=2
```



config.h:

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define HAVE_C11	1
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define PENRYN
#define L1_DATA_SIZE 32768
#define L1_DATA_LINESIZE 64
#define L2_SIZE 1048576
#define L2_LINESIZE 64
#define DTB_DEFAULT_ENTRIES 256
#define DTB_SIZE 4096
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define CORE_PENRYN
#define CHAR_CORENAME "PENRYN"
#define SLOCAL_BUFFER_SIZE	32768
#define DLOCAL_BUFFER_SIZE	16384
#define CLOCAL_BUFFER_SIZE	32768
#define ZLOCAL_BUFFER_SIZE	16384
#define GEMM_MULTITHREAD_THRESHOLD	4
```




---

archive/issue_comments_459759.json:
```json
{
    "body": "Replying to [comment:71 vbraun]:\n> The build log is identical to one with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` except that the latter doesn't segfault, so it must be in the config.h value\n\nThe files that you showed in comment:70, comment:72 have HAVE_AVX, so what's going on?",
    "created_at": "2021-10-31T22:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459759",
    "user": "@mkoeppe"
}
```

Replying to [comment:71 vbraun]:
> The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value

The files that you showed in comment:70, comment:72 have HAVE_AVX, so what's going on?



---

archive/issue_comments_459760.json:
```json
{
    "body": "PENRYN=1 is apparently not the same as CORE=PENRYN\n\nI do have AVX (and building with TARGET=PENRYN HAVE_AVX=1 works fine):\n\n```\n  <qemu:commandline>\n    <qemu:arg value=\"-device\"/>\n    <qemu:arg value=\"isa-applesmc,osk=ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc\"/>\n    <qemu:arg value=\"-smbios\"/>\n    <qemu:arg value=\"type=2\"/>\n    <qemu:arg value=\"-device\"/>\n    <qemu:arg value=\"vmware-svga\"/>\n    <qemu:arg value=\"-cpu\"/>\n    <qemu:arg value=\"Penryn,kvm=on,vendor=GenuineIntel,+invtsc,vmware-cpuid-freq=on,+pcid,+ssse3,+sse4.2,+popcnt,+avx,+aes,+xsave,+xsaveopt,check\"/>\n  </qemu:commandline>\n```\n",
    "created_at": "2021-10-31T23:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459760",
    "user": "@vbraun"
}
```

PENRYN=1 is apparently not the same as CORE=PENRYN

I do have AVX (and building with TARGET=PENRYN HAVE_AVX=1 works fine):

```
  <qemu:commandline>
    <qemu:arg value="-device"/>
    <qemu:arg value="isa-applesmc,osk=ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc"/>
    <qemu:arg value="-smbios"/>
    <qemu:arg value="type=2"/>
    <qemu:arg value="-device"/>
    <qemu:arg value="vmware-svga"/>
    <qemu:arg value="-cpu"/>
    <qemu:arg value="Penryn,kvm=on,vendor=GenuineIntel,+invtsc,vmware-cpuid-freq=on,+pcid,+ssse3,+sse4.2,+popcnt,+avx,+aes,+xsave,+xsaveopt,check"/>
  </qemu:commandline>
```




---

archive/issue_comments_459761.json:
```json
{
    "body": "Replying to [comment:74 mkoeppe]:\n> Replying to [comment:71 vbraun]:\n> > The build log is identical to one with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` except that the latter doesn't segfault, so it must be in the config.h value\n> \n> The files that you showed in comment:70, comment:72 have HAVE_AVX, so what's going on?\n\nSo when you pass `TARGET=PENRYN HAVE_AVX=1`, how do `config.h` and `Makefile.conf` change compared to what you posted in comment:70, comment:72?",
    "created_at": "2021-11-01T01:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459761",
    "user": "@mkoeppe"
}
```

Replying to [comment:74 mkoeppe]:
> Replying to [comment:71 vbraun]:
> > The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value
> 
> The files that you showed in comment:70, comment:72 have HAVE_AVX, so what's going on?

So when you pass `TARGET=PENRYN HAVE_AVX=1`, how do `config.h` and `Makefile.conf` change compared to what you posted in comment:70, comment:72?



---

archive/issue_comments_459762.json:
```json
{
    "body": "* `src-segfault` is from running `make`\n* `src-working` is from running `make TARGET=PENRYN HAVE_AVX=1`\n\nconfig.h\n\n```\nvbraun@catalina-osx openblas-test % diff -u src-segfault/config.h src-working/config.h\n--- src-segfault/config.h\t2021-11-01 15:01:57.000000000 -0700\n+++ src-working/config.h\t2021-11-01 15:02:16.000000000 -0700\n@@ -8,19 +8,12 @@\n #define BUNDERSCORE\t_\n #define NEEDBUNDERSCORE\t1\n #define PENRYN\n-#define L1_CODE_SIZE 32768\n-#define L1_CODE_ASSOCIATIVE 8\n-#define L1_CODE_LINESIZE 64\n #define L1_DATA_SIZE 32768\n-#define L1_DATA_ASSOCIATIVE 8\n #define L1_DATA_LINESIZE 64\n-#define L2_SIZE 2097152\n-#define L2_ASSOCIATIVE 8\n+#define L2_SIZE 1048576\n #define L2_LINESIZE 64\n-#define L3_SIZE 16777216\n-#define L3_ASSOCIATIVE 16\n-#define L3_LINESIZE 64\n-#define DTB_DEFAULT_ENTRIES 32\n+#define DTB_DEFAULT_ENTRIES 256\n+#define DTB_SIZE 4096\n #define HAVE_CMOV\n #define HAVE_MMX\n #define HAVE_SSE\n@@ -28,11 +21,6 @@\n #define HAVE_SSE3\n #define HAVE_SSSE3\n #define HAVE_SSE4_1\n-#define HAVE_SSE4_2\n-#define HAVE_AVX\n-#define HAVE_CFLUSH\n-#define NUM_SHAREDCACHE 1\n-#define NUM_CORES 1\n #define CORE_PENRYN\n #define CHAR_CORENAME \"PENRYN\"\n #define SLOCAL_BUFFER_SIZE\t32768\n```\n\nMakefile.conf\n\n```\nvbraun@catalina-osx openblas-test % diff -u src-segfault/Makefile.conf src-working/Makefile.conf \n--- src-segfault/Makefile.conf\t2021-11-01 15:01:57.000000000 -0700\n+++ src-working/Makefile.conf\t2021-11-01 15:02:16.000000000 -0700\n@@ -12,14 +12,20 @@\n CORE=PENRYN\n LIBCORE=penryn\n NUM_CORES=8\n+PENRYN=1\n+L1_DATA_SIZE=32768\n+L1_DATA_LINESIZE=64\n+L2_SIZE=1048576\n+L2_LINESIZE=64\n+DTB_DEFAULT_ENTRIES=256\n+DTB_SIZE=4096\n+HAVE_CMOV=1\n HAVE_MMX=1\n HAVE_SSE=1\n HAVE_SSE2=1\n HAVE_SSE3=1\n HAVE_SSSE3=1\n HAVE_SSE4_1=1\n-HAVE_SSE4_2=1\n-HAVE_AVX=1\n MAKE += -j 8\n SBGEMM_UNROLL_M=8\n SBGEMM_UNROLL_N=4\n```\n",
    "created_at": "2021-11-01T22:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459762",
    "user": "@vbraun"
}
```

* `src-segfault` is from running `make`
* `src-working` is from running `make TARGET=PENRYN HAVE_AVX=1`

config.h

```
vbraun@catalina-osx openblas-test % diff -u src-segfault/config.h src-working/config.h
--- src-segfault/config.h	2021-11-01 15:01:57.000000000 -0700
+++ src-working/config.h	2021-11-01 15:02:16.000000000 -0700
@@ -8,19 +8,12 @@
 #define BUNDERSCORE	_
 #define NEEDBUNDERSCORE	1
 #define PENRYN
-#define L1_CODE_SIZE 32768
-#define L1_CODE_ASSOCIATIVE 8
-#define L1_CODE_LINESIZE 64
 #define L1_DATA_SIZE 32768
-#define L1_DATA_ASSOCIATIVE 8
 #define L1_DATA_LINESIZE 64
-#define L2_SIZE 2097152
-#define L2_ASSOCIATIVE 8
+#define L2_SIZE 1048576
 #define L2_LINESIZE 64
-#define L3_SIZE 16777216
-#define L3_ASSOCIATIVE 16
-#define L3_LINESIZE 64
-#define DTB_DEFAULT_ENTRIES 32
+#define DTB_DEFAULT_ENTRIES 256
+#define DTB_SIZE 4096
 #define HAVE_CMOV
 #define HAVE_MMX
 #define HAVE_SSE
@@ -28,11 +21,6 @@
 #define HAVE_SSE3
 #define HAVE_SSSE3
 #define HAVE_SSE4_1
-#define HAVE_SSE4_2
-#define HAVE_AVX
-#define HAVE_CFLUSH
-#define NUM_SHAREDCACHE 1
-#define NUM_CORES 1
 #define CORE_PENRYN
 #define CHAR_CORENAME "PENRYN"
 #define SLOCAL_BUFFER_SIZE	32768
```

Makefile.conf

```
vbraun@catalina-osx openblas-test % diff -u src-segfault/Makefile.conf src-working/Makefile.conf 
--- src-segfault/Makefile.conf	2021-11-01 15:01:57.000000000 -0700
+++ src-working/Makefile.conf	2021-11-01 15:02:16.000000000 -0700
@@ -12,14 +12,20 @@
 CORE=PENRYN
 LIBCORE=penryn
 NUM_CORES=8
+PENRYN=1
+L1_DATA_SIZE=32768
+L1_DATA_LINESIZE=64
+L2_SIZE=1048576
+L2_LINESIZE=64
+DTB_DEFAULT_ENTRIES=256
+DTB_SIZE=4096
+HAVE_CMOV=1
 HAVE_MMX=1
 HAVE_SSE=1
 HAVE_SSE2=1
 HAVE_SSE3=1
 HAVE_SSSE3=1
 HAVE_SSE4_1=1
-HAVE_SSE4_2=1
-HAVE_AVX=1
 MAKE += -j 8
 SBGEMM_UNROLL_M=8
 SBGEMM_UNROLL_N=4
```




---

archive/issue_comments_459763.json:
```json
{
    "body": "Its weird that `HAVE_AVX` isn't set in the working case, but I'm pretty sure AVX isn't the reason. In particular, building with `OPENBLAS_CONFIGURE=\"NO_AVX=1\"` segfaults as well, and building with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` works.",
    "created_at": "2021-11-01T23:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459763",
    "user": "@vbraun"
}
```

Its weird that `HAVE_AVX` isn't set in the working case, but I'm pretty sure AVX isn't the reason. In particular, building with `OPENBLAS_CONFIGURE="NO_AVX=1"` segfaults as well, and building with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` works.



---

archive/issue_comments_459764.json:
```json
{
    "body": "The culprit seems to be\n\n```\n#define DTB_DEFAULT_ENTRIES 32\n```\n\nincreasing it to 64, say, fixes the segfault",
    "created_at": "2021-11-04T21:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459764",
    "user": "@vbraun"
}
```

The culprit seems to be

```
#define DTB_DEFAULT_ENTRIES 32
```

increasing it to 64, say, fixes the segfault



---

archive/issue_comments_459765.json:
```json
{
    "body": "Report upstream?",
    "created_at": "2021-11-04T21:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459765",
    "user": "@mkoeppe"
}
```

Report upstream?



---

archive/issue_comments_459766.json:
```json
{
    "body": "I've made a branch at `u/vbraun/packages/openblas/0.3.18-test` that patches  DTB_DEFAULT_ENTRIES=32 when forcing TARGET=PENRYN, with that I can reproduce the same segfault on linux when running\n\n```\nOPENBLAS_CONFIGURE=\"TARGET=PENRYN\" ./sage -p openblas\n./sage -t --long  src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n```\n",
    "created_at": "2021-11-06T10:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459766",
    "user": "@vbraun"
}
```

I've made a branch at `u/vbraun/packages/openblas/0.3.18-test` that patches  DTB_DEFAULT_ENTRIES=32 when forcing TARGET=PENRYN, with that I can reproduce the same segfault on linux when running

```
OPENBLAS_CONFIGURE="TARGET=PENRYN" ./sage -p openblas
./sage -t --long  src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
```




---

archive/issue_comments_459767.json:
```json
{
    "body": "\n```\n$ valgrind ./local/bin/python\n[...]\n>>> solve = factorized(Acsc) # LU factorization\n==727003== Invalid write of size 8\n==727003==    at 0x143AC900: dgemv_n (dgemv_n.S:233)\n==727003==    by 0xFFFFFFFFFFFFFFFE: ???\n==727003==    by 0x1F: ???\n==727003==    by 0x1E: ???\n==727003==    by 0xA75C8947: ???\n==727003==    by 0x9F0E438F: ???\n==727003==    by 0x4CF: ???\n==727003==    by 0xBFEFFFFFFFFFFFFF: ???\n==727003==    by 0xFFFFFFFFFFE00009: ???\n==727003==    by 0x1F: ???\n==727003==    by 0x9F0DAA87: ???\n==727003==    by 0x98: ???\n==727003==  Address 0x0 is not stack'd, malloc'd or (recently) free'd\n```\n\nThough dgemv_n.S hasn't been touched in 8 years ;)",
    "created_at": "2021-11-06T11:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459767",
    "user": "@vbraun"
}
```


```
$ valgrind ./local/bin/python
[...]
>>> solve = factorized(Acsc) # LU factorization
==727003== Invalid write of size 8
==727003==    at 0x143AC900: dgemv_n (dgemv_n.S:233)
==727003==    by 0xFFFFFFFFFFFFFFFE: ???
==727003==    by 0x1F: ???
==727003==    by 0x1E: ???
==727003==    by 0xA75C8947: ???
==727003==    by 0x9F0E438F: ???
==727003==    by 0x4CF: ???
==727003==    by 0xBFEFFFFFFFFFFFFF: ???
==727003==    by 0xFFFFFFFFFFE00009: ???
==727003==    by 0x1F: ???
==727003==    by 0x9F0DAA87: ???
==727003==    by 0x98: ???
==727003==  Address 0x0 is not stack'd, malloc'd or (recently) free'd
```

Though dgemv_n.S hasn't been touched in 8 years ;)



---

archive/issue_comments_459768.json:
```json
{
    "body": "This is https://github.com/xianyi/OpenBLAS/issues/3421, patch is in the linked PR",
    "created_at": "2021-11-06T12:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459768",
    "user": "@vbraun"
}
```

This is https://github.com/xianyi/OpenBLAS/issues/3421, patch is in the linked PR



---

archive/issue_comments_459769.json:
```json
{
    "body": "Testing with a bunch of other upgrade tickets \n----\nNew commits:",
    "created_at": "2021-11-06T20:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459769",
    "user": "@mkoeppe"
}
```

Testing with a bunch of other upgrade tickets 
----
New commits:



---

archive/issue_comments_459770.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-06T20:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459770",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_459771.json:
```json
{
    "body": "Tests look good",
    "created_at": "2021-11-08T00:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459771",
    "user": "@mkoeppe"
}
```

Tests look good



---

archive/issue_comments_459772.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-08T00:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459772",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459773.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-11-12T11:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459773",
    "user": "@slel"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_459774.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-11-12T21:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32187",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32187#issuecomment-459774",
    "user": "@vbraun"
}
```

Resolution: fixed
