# Issue 32187: Sage 9.4 still creates non-portable binaries with SAGE_FAT_BINARY="yes"

Issue created by migration from https://trac.sagemath.org/ticket/32424

Original creator: mkoeppe

Original creation time: 2021-08-26 04:16:33

CC:  was @kliem dimpase dunfield culler slelievre mjo vbraun @maxale tmonteil jhpalmieri

as reported in https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ


---

Comment by @kliem created at 2021-08-26 09:47:15

The signal error is caused by `nullspaceMP`, which is in the iml library.

Iml itself doesn't use architecture specific instructions, but the dependencies are.
But then again, OPENBLAS and gmp are already built with `make DYNAMIC_ARCH=1` resp. `--enable-fat`. Both of them got updated between sage 9.0 and sage 9.3.


---

Comment by dunfield created at 2021-08-26 18:40:15

I suspect the cause is OpenBLAS.  While this library is built with DYNAMIC_ARCH=1, there is still the non-performance critical code in it which will use whatever instructions are available on the machine at compile time unless you **also** set TARGET.  See

https://github.com/xianyi/OpenBLAS/issues/3056

For the macOS app, Marc Culler had to set TARGET=CORE2 in addition to DYNAMIC_ARCH=1 so that it would run on a 2013 cylindrical Mac Pro.


---

Comment by isuruf created at 2021-08-26 19:21:40

Changing status from new to needs_review.


---

Comment by isuruf created at 2021-08-26 19:21:40

New commits:


---

Comment by mkoeppe created at 2021-08-26 19:53:03

should we also throw in an openblas upgrade? https://repology.org/projects/o/?inrepo=sagemath_stable


---

Comment by isuruf created at 2021-08-26 19:55:04

Yes, that would be good to have. I didn't realize openblas was way behind.
Feel free to push to this branch


---

Comment by mkoeppe created at 2021-08-26 20:03:25

on macOS:

```
[openblas-0.3.17] ./spkg-install: line 55: conditional binary operator expected
[openblas-0.3.17] ./spkg-install: line 55: syntax error near `~='
[openblas-0.3.17] ./spkg-install: line 55: `    if [[ $os-$machine ~= darwin-x86_64 ]]; then'
```



---

Comment by slelievre created at 2021-08-26 23:17:11

New commits:


---

Comment by slelievre created at 2021-08-26 23:17:11

Changing keywords from "" to "upgrade, openblas".


---

Comment by mkoeppe created at 2021-08-27 00:41:56

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2021-08-27 00:49:16

New commits:


---

Comment by mkoeppe created at 2021-08-27 19:09:22

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2021-09-01 12:10:09

For `SAGE_FAT_BINARY`, I think we have to set the `TARGET` to the "oldest" value that we expect the binaries to run on. If that's right, then using the `uname` will make it so that the binaries are portable only to other machines with the same (or "newer") `uname`.

`CORE2` sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise.


---

Comment by isuruf created at 2021-09-01 12:35:59

> If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 

That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?

> CORE2 sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise. 

CORE2 is only for x86_64. Besides TARGET is needed only for non-performance critical code paths.


---

Comment by mjo created at 2021-09-01 12:52:09

Replying to [comment:20 isuruf]:
> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 
> 
> That's correct. What's wrong with that?

Nothing, I didn't look closely enough at the cases. The only two that overlap in any way are x86_64 and x86, and setting `TARGET` to an x86 value on an x86_64 machine won't magically make it produce 32-bit binaries, so... LGTM now.


---

Comment by mkoeppe created at 2021-09-01 18:23:08

I think instead of `uname`, we should use `$CC -dumpmachine` like we do in `build/pkgs/gfortran/spkg-build.in` from #29241


---

Comment by mkoeppe created at 2021-09-01 18:41:57

Replying to [comment:20 isuruf]:
> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 
> 
> That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?

They often do, via qemu and `binfmt_misc`..., see https://hub.docker.com/r/multiarch/ubuntu-core


---

Comment by isuruf created at 2021-09-01 20:29:19

> They often do, via qemu and binfmt_misc

That's not relevant either. qemu would emulate the instruction set
including cpuid instruction.


---

Comment by mkoeppe created at 2021-09-01 20:33:49

But because of the `binfmt_misc` emulation route, you cannot rely on `uname` to reason about the target architecture, i.e., comment:22 applies not just for x86_64/i686.


---

Comment by isuruf created at 2021-09-01 20:37:02

> But because of the binfmt_misc emulation route, you cannot rely on uname to reason about the target architecture, i.e., comment:22 applies not just for x86_64/i686.

Openblas `spkg-install.in` doesn't support building for non-native architecture
even on `develop` branch.


---

Comment by mkoeppe created at 2021-09-01 20:48:28

We do test this at least for i686 on x86_64 - see for example https://github.com/sagemath/sage/runs/3392765581?check_suite_focus=true
(which needed #29241)


---

Comment by git created at 2021-09-01 20:55:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-02 03:43:29

testing on top of 9.5.beta0


---

Comment by mkoeppe created at 2021-09-03 18:53:53

The tests on Linux and macOS (https://github.com/mkoeppe/sage/actions/runs/1192736161 ) look normal. Note that they do not test `--enable-fat-binary` at all.
Unchanged:  `centos-7-i386` gives SIGFPE while building dochtml. Reported in https://groups.google.com/g/sage-release/c/ocdEAV4pFMo/m/4BEdJZQ8BAAJ for 9.4.rc1 (and probably earlier).

The test on Cygwin (https://github.com/mkoeppe/sage/actions/runs/1192736162) uses `--enable-fat-binary`. Unchanged: It gives the same segfaults whenever plotting is used (https://github.com/mkoeppe/sage/runs/3506881828) that showed up in the previous betas.

So this seems safe to merge, but it remains unknown whether it helps at all. Some help from the people who build and test binaries is needed here.


---

Comment by dimpase created at 2021-09-25 20:33:44

let's merge this then


---

Comment by dimpase created at 2021-09-25 20:33:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-10-07 22:30:00

Segfaults on OSX

```
sage: for i in range(0,n2):
   A[i,i]=4*h2+1.
   if i+1<n2: A[i,int(i+1)]=-h2
   if i>0:    A[i,int(i-1)]=-h2
   if i+n<n2: A[i,int(i+n)]=-h2
   if i-n>=0: A[i,int(i-n)]=-h2 ## line 366 ##
sage: Acsc = A.tocsc() ## line 372 ##
sage: b = array([1 for i in range(0,n2)]) ## line 373 ##
sage: solve = factorized(Acsc) # LU factorization ## line 374 ##
------------------------------------------------------------------------
0   signals.cpython-39-darwin.so        0x0000000103db93e2 print_backtrace + 66
1   signals.cpython-39-darwin.so        0x0000000103dbd097 sigdie + 39
2   signals.cpython-39-darwin.so        0x0000000103dbcf84 cysigs_signal_handler + 404
3   libsystem_platform.dylib            0x00007fff7132b5fd _sigtramp + 29
4   ???                                 0x0000000000000013 0x0 + 19
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
**********************************************************************
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py  # Killed due to segmentation fault
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2021-10-07 22:30:00

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-10-07 22:59:54

Obviously we need more detail about the platform


---

Comment by mkoeppe created at 2021-10-07 23:00:16

In the meantime 0.3.18 has come out


---

Comment by dimpase created at 2021-10-08 13:24:18

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-10-08 13:24:18

New commits:


---

Comment by dimpase created at 2021-10-08 13:25:48

update to 0.3.18


---

Comment by dimpase created at 2021-10-14 11:55:31

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-10-14 11:55:31

let's get this in, see if it helps with that not easy to reproduce bug.


---

Comment by vbraun created at 2021-10-20 23:01:06

Resolution: fixed


---

Comment by vbraun created at 2021-10-23 09:19:00

still segfaults on mac in the same spot


---

Comment by vbraun created at 2021-10-23 09:19:00

Changing status from closed to new.


---

Comment by vbraun created at 2021-10-23 09:19:00

Resolution changed from fixed to 


---

Comment by dimpase created at 2021-10-23 09:31:36

are you unmerging this ticket? it is a valid update, no regressions, right?


---

Comment by vbraun created at 2021-10-23 14:06:13

There is a regression, this used to work and is now segfaulting on osx:

```
>>> solve = factorized(Acsc) # LU factorization
Process 56588 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)
    frame #0: 0x0000000107d55588 libopenblas_penrynp-r0.3.18.dylib`.L01
libopenblas_penrynp-r0.3.18.dylib`.L01:
->  0x107d55588 <+0>:  movaps %xmm4, (%rbp)
    0x107d5558c <+4>:  movaps %xmm4, 0x10(%rbp)
    0x107d55590 <+8>:  movaps %xmm4, 0x20(%rbp)
    0x107d55594 <+12>: movaps %xmm4, 0x30(%rbp)
Target 0: (python3) stopped.
```



---

Comment by vbraun created at 2021-10-24 09:27:10

Building Sage with

```
OPENBLAS_CONFIGURE="TARGET=PENRYN DEBUG=1 USE_OPENMP=0" make
```

works, so its apparently a threading-related issue. Kinda guessed that from the messed up stack trace, seems to be in a thread thats not doing so well.


---

Comment by vbraun created at 2021-10-24 10:36:51

Possibly related: https://github.com/xianyi/OpenBLAS/issues/2787


---

Comment by dimpase created at 2021-10-26 07:48:17

Replying to [comment:46 vbraun]:
> There is a regression, this used to work and is now segfaulting on osx:

Volker, more details please: 

* was OpenBLAS built from source? 
* On what version of macOS? 
* On what CPU?


---

Comment by dimpase created at 2021-10-26 07:52:33

Changing status from new to needs_review.


---

Comment by vbraun created at 2021-10-26 19:36:28

I'm running full builds; Does the following work for you? For me, it segfaults:

```
make distclean
OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
```

Both Catalina and BigSur. CPU is qemu64 (lowest-common denominator, which is why openblas picks Penryn).


---

Comment by dimpase created at 2021-10-26 20:44:57

hmm, so it's a qemu64 running macOS on a Mac? 

Or a hackintosh, i.e. qemu running macOS on Linux?

How is this a meaningful test, and not testing the resolve of Apple to prevent "illegal" macOS emulators?


---

Comment by mkoeppe created at 2021-10-26 21:04:04

Replying to [comment:51 vbraun]:
> I'm running full builds; Does the following work for you? For me, it segfaults:
> {{{
> make distclean
> OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
> sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
> }}}

Volker, this recipe is wildly underspecified. When you post failures like this, could you please attach at least the `config.log` and the build log of the package?


---

Comment by vbraun created at 2021-10-26 21:04:45

It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.

BTW you have an account on `catalina-osx`, too ;)


---

Comment by isuruf created at 2021-10-26 21:06:49

Can we split the two things in this ticket?

Fixing fat binaries and upgrading openblas?


---

Comment by dimpase created at 2021-10-27 22:40:26

Replying to [comment:54 vbraun]:
> It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.
> 
you might be just hitting a deficiency in your Hackingtosh, not a real bug.

 

> BTW you have an account on `catalina-osx`, too ;)


---

Comment by vbraun created at 2021-10-28 22:37:27

Logs are here: http://sagepad.org/pub/sage/32424/


---

Comment by dimpase created at 2021-10-29 12:46:05

from config.log one can see you have another OpenBLAS installed on the box 
(pkg-config finds it)

Can you, just as a sanitary check,  uninstall it and check that you can reproduce the crash?


---

Comment by vbraun created at 2021-10-29 23:08:28

I don't have another openblas; it seems the configure prints `configure:12750: result: openblas` by default even if you don't have any blas:

```
  12734 # Check whether --with-blas was given.
  12735 if test "${with_blas+set}" = set; then :
  12736   withval=$with_blas;
  12737 else
  12738   with_blas=openblas  # default
  12739 
  12740 fi
  12741 
  12742   case "$with_blas" in #(
  12743   openblas) :
  12744      ;; #(
  12745   atlas) :
  12746     sage_spkg_install_openblas=no ;; #(
  12747   *) :
  12748     as_fn_error $? "allowed values for --with-blas are 'atlas' and 'openblas'" "$LINENO" 5 ;;
  12749 esac
  12750   { $as_echo "$as_me:${as_lineno-$LINENO}: result: $with_blas" >&5
```



---

Comment by dimpase created at 2021-10-30 11:11:53

maybe it needs gfortran 11?


---

Comment by dimpase created at 2021-10-30 11:13:21

also, one might need more details on the hist CPU and how qemu is started/configured.


---

Comment by mkoeppe created at 2021-10-30 19:35:46

Replying to [comment:53 mkoeppe]:
> Replying to [comment:51 vbraun]:
> > I'm running full builds; Does the following work for you? For me, it segfaults:
> > {{{
> > make distclean
> > OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
> > sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
> > }}}

Based on the provided logs, I have built a similar configuration using `OPENBLAS_CONFIGURE=TARGET=PENRYN tox -e local-macos-nohomebrew -- bash` on a real Mac (Intelr Core i9, Big Sur). The tests pass.

I'll try again now after merging 9.5.beta5.
----
New commits:


---

Comment by mkoeppe created at 2021-10-30 19:38:28

Volker, I'd suggest that you take the problem on your configuration upstream by trying to reproduce it outside of Sage.


---

Comment by mkoeppe created at 2021-10-30 21:29:24

Replying to [comment:63 mkoeppe]:
> I'll try again now after merging 9.5.beta5.
Same result, all good.


---

Comment by mkoeppe created at 2021-10-31 20:37:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-10-31 21:55:17

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-10-31 21:56:19

Something is definitely not right. Its not just TARGET=PENRYN, with that it also works for me.


---

Comment by mkoeppe created at 2021-10-31 21:57:16

So what is the configuration that fails for you?


---

Comment by vbraun created at 2021-10-31 21:59:14

This is the Makefile.conf that segfaults:

```
OSNAME=Darwin
ARCH=x86_64
C_COMPILER=CLANG
BINARY32=
BINARY64=1
FU=_
CEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/usr/local/lib  -lto_library -lSystem  /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/lib/darwin/libclang_rt.osx.a 
F_COMPILER=GFORTRAN
FC=gfortran
BU=_
FEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../.. -L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  
CORE=PENRYN
LIBCORE=penryn
NUM_CORES=8
HAVE_MMX=1
HAVE_SSE=1
HAVE_SSE2=1
HAVE_SSE3=1
HAVE_SSSE3=1
HAVE_SSE4_1=1
HAVE_SSE4_2=1
HAVE_AVX=1
MAKE += -j 8
SBGEMM_UNROLL_M=8
SBGEMM_UNROLL_N=4
SGEMM_UNROLL_M=8
SGEMM_UNROLL_N=4
DGEMM_UNROLL_M=4
DGEMM_UNROLL_N=4
QGEMM_UNROLL_M=2
QGEMM_UNROLL_N=2
CGEMM_UNROLL_M=4
CGEMM_UNROLL_N=2
ZGEMM_UNROLL_M=2
ZGEMM_UNROLL_N=2
XGEMM_UNROLL_M=1
XGEMM_UNROLL_N=1
CGEMM3M_UNROLL_M=8
CGEMM3M_UNROLL_N=4
ZGEMM3M_UNROLL_M=4
ZGEMM3M_UNROLL_N=4
XGEMM3M_UNROLL_M=2
XGEMM3M_UNROLL_N=2
```



---

Comment by vbraun created at 2021-10-31 22:05:36

The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value


---

Comment by vbraun created at 2021-10-31 22:07:38

config.h:

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define HAVE_C11	1
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define PENRYN
#define L1_CODE_SIZE 32768
#define L1_CODE_ASSOCIATIVE 8
#define L1_CODE_LINESIZE 64
#define L1_DATA_SIZE 32768
#define L1_DATA_ASSOCIATIVE 8
#define L1_DATA_LINESIZE 64
#define L2_SIZE 2097152
#define L2_ASSOCIATIVE 8
#define L2_LINESIZE 64
#define L3_SIZE 16777216
#define L3_ASSOCIATIVE 16
#define L3_LINESIZE 64
#define DTB_DEFAULT_ENTRIES 32
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define HAVE_SSE4_2
#define HAVE_AVX
#define HAVE_CFLUSH
#define NUM_SHAREDCACHE 1
#define NUM_CORES 1
#define CORE_PENRYN
#define CHAR_CORENAME "PENRYN"
#define SLOCAL_BUFFER_SIZE	32768
#define DLOCAL_BUFFER_SIZE	16384
#define CLOCAL_BUFFER_SIZE	32768
#define ZLOCAL_BUFFER_SIZE	16384
#define GEMM_MULTITHREAD_THRESHOLD	4
```



---

Comment by mkoeppe created at 2021-10-31 22:15:30

My configuration (works): 

Makefile.conf:

```
OSNAME=Darwin
ARCH=x86_64
C_COMPILER=CLANG
BINARY32=
BINARY64=1
FU=_
CEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib  -lto_library -lSystem  /Library/Developer/CommandLineTools/usr/lib/clang/13.0.0/lib/darwin/libclang_rt.osx.a 
F_COMPILER=GFORTRAN
FC=gfortran
BU=_
FEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../.. -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  
CORE=PENRYN
LIBCORE=penryn
NUM_CORES=12
PENRYN=1
L1_DATA_SIZE=32768
L1_DATA_LINESIZE=64
L2_SIZE=1048576
L2_LINESIZE=64
DTB_DEFAULT_ENTRIES=256
DTB_SIZE=4096
HAVE_CMOV=1
HAVE_MMX=1
HAVE_SSE=1
HAVE_SSE2=1
HAVE_SSE3=1
HAVE_SSSE3=1
HAVE_SSE4_1=1
MAKE += -j 12
SBGEMM_UNROLL_M=8
SBGEMM_UNROLL_N=4
SGEMM_UNROLL_M=8
SGEMM_UNROLL_N=4
DGEMM_UNROLL_M=4
DGEMM_UNROLL_N=4
QGEMM_UNROLL_M=2
QGEMM_UNROLL_N=2
CGEMM_UNROLL_M=4
CGEMM_UNROLL_N=2
ZGEMM_UNROLL_M=2
ZGEMM_UNROLL_N=2
XGEMM_UNROLL_M=1
XGEMM_UNROLL_N=1
CGEMM3M_UNROLL_M=8
CGEMM3M_UNROLL_N=4
ZGEMM3M_UNROLL_M=4
ZGEMM3M_UNROLL_N=4
XGEMM3M_UNROLL_M=2
XGEMM3M_UNROLL_N=2
```



config.h:

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define HAVE_C11	1
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define PENRYN
#define L1_DATA_SIZE 32768
#define L1_DATA_LINESIZE 64
#define L2_SIZE 1048576
#define L2_LINESIZE 64
#define DTB_DEFAULT_ENTRIES 256
#define DTB_SIZE 4096
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define CORE_PENRYN
#define CHAR_CORENAME "PENRYN"
#define SLOCAL_BUFFER_SIZE	32768
#define DLOCAL_BUFFER_SIZE	16384
#define CLOCAL_BUFFER_SIZE	32768
#define ZLOCAL_BUFFER_SIZE	16384
#define GEMM_MULTITHREAD_THRESHOLD	4
```



---

Comment by mkoeppe created at 2021-10-31 22:20:37

Replying to [comment:71 vbraun]:
> The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value

The files that you showed in comment:70, comment:72 have HAVE_AVX, so what's going on?


---

Comment by vbraun created at 2021-10-31 23:00:35

PENRYN=1 is apparently not the same as CORE=PENRYN

I do have AVX (and building with TARGET=PENRYN HAVE_AVX=1 works fine):

```
  <qemu:commandline>
    <qemu:arg value="-device"/>
    <qemu:arg value="isa-applesmc,osk=ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc"/>
    <qemu:arg value="-smbios"/>
    <qemu:arg value="type=2"/>
    <qemu:arg value="-device"/>
    <qemu:arg value="vmware-svga"/>
    <qemu:arg value="-cpu"/>
    <qemu:arg value="Penryn,kvm=on,vendor=GenuineIntel,+invtsc,vmware-cpuid-freq=on,+pcid,+ssse3,+sse4.2,+popcnt,+avx,+aes,+xsave,+xsaveopt,check"/>
  </qemu:commandline>
```



---

Comment by mkoeppe created at 2021-11-01 01:43:42

Replying to [comment:74 mkoeppe]:
> Replying to [comment:71 vbraun]:
> > The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value
> 
> The files that you showed in comment:70, comment:72 have HAVE_AVX, so what's going on?

So when you pass `TARGET=PENRYN HAVE_AVX=1`, how do `config.h` and `Makefile.conf` change compared to what you posted in comment:70, comment:72?


---

Comment by vbraun created at 2021-11-01 22:07:02

* `src-segfault` is from running `make`
* `src-working` is from running `make TARGET=PENRYN HAVE_AVX=1`

config.h

```
vbraun@catalina-osx openblas-test % diff -u src-segfault/config.h src-working/config.h
--- src-segfault/config.h	2021-11-01 15:01:57.000000000 -0700
+++ src-working/config.h	2021-11-01 15:02:16.000000000 -0700
@@ -8,19 +8,12 @@
 #define BUNDERSCORE	_
 #define NEEDBUNDERSCORE	1
 #define PENRYN
-#define L1_CODE_SIZE 32768
-#define L1_CODE_ASSOCIATIVE 8
-#define L1_CODE_LINESIZE 64
 #define L1_DATA_SIZE 32768
-#define L1_DATA_ASSOCIATIVE 8
 #define L1_DATA_LINESIZE 64
-#define L2_SIZE 2097152
-#define L2_ASSOCIATIVE 8
+#define L2_SIZE 1048576
 #define L2_LINESIZE 64
-#define L3_SIZE 16777216
-#define L3_ASSOCIATIVE 16
-#define L3_LINESIZE 64
-#define DTB_DEFAULT_ENTRIES 32
+#define DTB_DEFAULT_ENTRIES 256
+#define DTB_SIZE 4096
 #define HAVE_CMOV
 #define HAVE_MMX
 #define HAVE_SSE
@@ -28,11 +21,6 @@
 #define HAVE_SSE3
 #define HAVE_SSSE3
 #define HAVE_SSE4_1
-#define HAVE_SSE4_2
-#define HAVE_AVX
-#define HAVE_CFLUSH
-#define NUM_SHAREDCACHE 1
-#define NUM_CORES 1
 #define CORE_PENRYN
 #define CHAR_CORENAME "PENRYN"
 #define SLOCAL_BUFFER_SIZE	32768
```

Makefile.conf

```
vbraun@catalina-osx openblas-test % diff -u src-segfault/Makefile.conf src-working/Makefile.conf 
--- src-segfault/Makefile.conf	2021-11-01 15:01:57.000000000 -0700
+++ src-working/Makefile.conf	2021-11-01 15:02:16.000000000 -0700
@@ -12,14 +12,20 @@
 CORE=PENRYN
 LIBCORE=penryn
 NUM_CORES=8
+PENRYN=1
+L1_DATA_SIZE=32768
+L1_DATA_LINESIZE=64
+L2_SIZE=1048576
+L2_LINESIZE=64
+DTB_DEFAULT_ENTRIES=256
+DTB_SIZE=4096
+HAVE_CMOV=1
 HAVE_MMX=1
 HAVE_SSE=1
 HAVE_SSE2=1
 HAVE_SSE3=1
 HAVE_SSSE3=1
 HAVE_SSE4_1=1
-HAVE_SSE4_2=1
-HAVE_AVX=1
 MAKE += -j 8
 SBGEMM_UNROLL_M=8
 SBGEMM_UNROLL_N=4
```



---

Comment by vbraun created at 2021-11-01 23:37:21

Its weird that `HAVE_AVX` isn't set in the working case, but I'm pretty sure AVX isn't the reason. In particular, building with `OPENBLAS_CONFIGURE="NO_AVX=1"` segfaults as well, and building with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` works.


---

Comment by vbraun created at 2021-11-04 21:21:10

The culprit seems to be

```
#define DTB_DEFAULT_ENTRIES 32
```

increasing it to 64, say, fixes the segfault


---

Comment by mkoeppe created at 2021-11-04 21:38:06

Report upstream?


---

Comment by vbraun created at 2021-11-06 10:35:46

I've made a branch at `u/vbraun/packages/openblas/0.3.18-test` that patches  DTB_DEFAULT_ENTRIES=32 when forcing TARGET=PENRYN, with that I can reproduce the same segfault on linux when running

```
OPENBLAS_CONFIGURE="TARGET=PENRYN" ./sage -p openblas
./sage -t --long  src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
```



---

Comment by vbraun created at 2021-11-06 11:46:57


```
$ valgrind ./local/bin/python
[...]
>>> solve = factorized(Acsc) # LU factorization
==727003== Invalid write of size 8
==727003==    at 0x143AC900: dgemv_n (dgemv_n.S:233)
==727003==    by 0xFFFFFFFFFFFFFFFE: ???
==727003==    by 0x1F: ???
==727003==    by 0x1E: ???
==727003==    by 0xA75C8947: ???
==727003==    by 0x9F0E438F: ???
==727003==    by 0x4CF: ???
==727003==    by 0xBFEFFFFFFFFFFFFF: ???
==727003==    by 0xFFFFFFFFFFE00009: ???
==727003==    by 0x1F: ???
==727003==    by 0x9F0DAA87: ???
==727003==    by 0x98: ???
==727003==  Address 0x0 is not stack'd, malloc'd or (recently) free'd
```

Though dgemv_n.S hasn't been touched in 8 years ;)


---

Comment by vbraun created at 2021-11-06 12:05:18

This is https://github.com/xianyi/OpenBLAS/issues/3421, patch is in the linked PR


---

Comment by mkoeppe created at 2021-11-06 20:06:52

Testing with a bunch of other upgrade tickets 
----
New commits:


---

Comment by mkoeppe created at 2021-11-06 20:06:52

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-08 00:49:09

Tests look good


---

Comment by mkoeppe created at 2021-11-08 00:49:09

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-11-12 11:24:14

Changing priority from critical to blocker.


---

Comment by vbraun created at 2021-11-12 21:27:59

Resolution: fixed
