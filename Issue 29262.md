# Issue 29262: ./configure --with-system-SPKG=whatever

Issue created by migration from https://trac.sagemath.org/ticket/29499

Original creator: mkoeppe

Original creation time: 2020-04-11 17:26:01

CC:  mjo @kliem dimpase vdelecroix

Right now we support `./configure --with-system-SPKG={no,yes,force}`, where `force` means: terminate with an error if no suitable system package exists.

There should be another possible value, `whatever`, so that experienced/daring users can force to use the system package even if our `spkg-configure` has a concern about the system package. See #29494 (Reject old system pari with bug in hyperellcharpoly).


---

Comment by mjo created at 2020-04-11 19:51:36

As a time-saving mechanism, this doesn't really solve the problem, because it doesn't distinguish between important checks (API and dependent-package compatibility) in spkg-configure.m4 and the ones that I consider unimportant (bug checks to enforce bleeding-edge patched versions).

While I'm working on the sage build system every day, I know that the latest pari-2.11.2 in Gentoo is absolutely fine, but if I take a month off and try to pass `--with-system-pari=yeptrustme`, it could compile stuff for three hours before crashing because another package needs a symbol in libpari that wasn't there in 2.11.2. Then I've wasted not just the time needed to build pari, but everything before it.


---

Comment by mkoeppe created at 2020-04-11 20:14:00

Of course this is a valid point. I see it more as a development tool - easier to pass that option to check if things work than to edit out some checks in the spkg-configure to achieve the same


---

Comment by mjo created at 2020-04-11 21:15:38

You can't skip the check entirely because e.g. `PKG_CHECK_MODULES` puts things into global variables that we need later on.

And after some further thought, it wouldn't do me much good to skip the checks anyway. Ultimately, for using sage to do computations, I would prefer to use the system copy. But that only works until I want to review a ticket; then I have to build a git checkout and run the test suite.

The spkg-configure work is useful for me because it cuts down that compile time from 20+ hours, to (now) about 5. But that's only helpful if the resulting test suite still passes. If we modify the spkg-configures to only accept specific versions, then the test suite will evolve to support only those specific versions. Skipping the version checks at that point is only going to build something that's useless for running a ptestlong.


---

Comment by dimpase created at 2020-04-12 04:20:08

we can have a special macro that makes some tests conditional, or a special section of 
SAGE_SPKG_CONFIGURE, which contains tests skipped if `whatever` is set.

E.g. the Pari #29494 problem won't affect anyone who does not work with hyperelliptic curves...


---

Comment by @kliem created at 2020-04-12 13:53:17

(In an ideal world) When I install sage I want all doctests to pass by default. This would also be great for automated testing, because then we don't have to keep a huge lists of things that fail here and there.

In #29493 I suggested a similar flag that skips some tests, when we don't use the package installed by sage. Of course this shouldn't be serious errors, but maybe the representation slightly differs.

In the case of #29494 it would be nice if I am informed at configuration time that pari is rejected because of a bug in hyperelliptic curves. Then, if I decide I don't care about hyperelliptic curves, I can insist on using pari anyway. In a perfect world it would even tell me at doctesting that there is 1 expected failure (because of my configuration).

Maybe we could have a flag as `# expected failure trac:12345`, such that at configuration time it detects that those doctests aren't expected to work.

This might be hard to maintain but I believe it gives great flexibility to installation (and at installation time you know pretty good which parts of sage you are breaking). And it only exposes information that we know by automated testing anyway.


---

Comment by @kliem created at 2020-04-12 19:20:00

Anyway, I don't have strong opinions on which road to take. I just think we should find a rather consistent way of how to deal with those things.


---

Comment by slabbe created at 2020-05-30 12:54:18

I think `force` is a better name for the new `whatever` option. (When I do `rm -f file` it does not return an error if `file` does not exist, and that's the point, no?)

What is the difference between `yes` and the current `force`?


---

Comment by dimpase created at 2020-05-30 16:21:53

* yes: it will try the system lib, and fallback to Sage one if it does not pass the tests.

* force: it will try the system lib and  fail with an error if it does not pass the tests.


---

Comment by @kliem created at 2020-05-30 18:47:46

I agree that this new `whatever` option really sounds like `force`.

How about a message that requires user confirmation? Similar to the message when you want to install `polymake` (or any experimental message). But this might be awful for automated testing.

Maybe we instead find a reasonable new name for the `force` option. How about `require`.

I think it might even be reasonable to move the current `force` option to `yes`. If I tell configure to use my system package, but it can't, IMO it should terminate and not just go ahead and not use the system package.


---

Comment by mkoeppe created at 2020-06-07 03:18:59

Changing no/yes/force/whatever to no/yes/require/force is fine with me, 
but I think I might prefer no/check/yes/force (new default: check)


---

Comment by @kliem created at 2020-06-08 06:30:40

Replying to [comment:12 mkoeppe]:
> but I think I might prefer no/check/yes/force (new default: check)
> 

Sounds good to me.


---

Comment by slabbe created at 2020-06-13 09:46:05

I agree too.


---

Comment by mkoeppe created at 2020-06-13 10:15:08

Updated the ticket description accordingly.


---

Comment by dimpase created at 2020-07-31 18:52:52

hmm, what is this branch doing here?!
----
Last 10 new commits:


---

Comment by @EnderWannabe created at 2020-07-31 18:58:01

Replying to [comment:18 dimpase]:
> hmm, what is this branch doing here?!

Yikes! I'm so sorry, I meant to push to 29949. How do you want to handle this? I can try and fix it.

- edit: did this ticket have a branch?


---

Comment by dimpase created at 2020-07-31 20:41:31

there was no branch. Just manually enter `u/gh-EnderWannabe/berkovich_dynamical` into the Branch: field of #29949


---

Comment by dimpase created at 2020-07-31 20:43:07

Actually #29949 already has it set, so no need to do anything (I've cleared the Branch: field here).


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
