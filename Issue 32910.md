# Issue 32910: use PARI's ellmul() for elliptic curves over finite fields

Issue created by migration from https://trac.sagemath.org/ticket/33147

Original creator: lorenz

Original creation time: 2022-01-11 05:40:23

CC:  vdelecroix

Currently, Sage uses the generic action of `ZZ` on additive groups to compute scalar multiplications for elliptic curves. This is significantly slower than PARI's specialized `ellmul()` function:


```
sage: E = EllipticCurve(GF(65537), [1,2,3,4,5])
sage: P = E.random_point()
sage: %timeit 12345*P
241 µs ± 3.31 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit pari.ellmul(E,P,12345)
47.4 µs ± 645 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


This patch adds the use of `ellmul()` for elliptic curves over finite fields. The speedup is very significant for all sizes I've tried (between ~10 and ~1000 bits), ranging from 4× to 8×.

Diff without the dependency:
  https://git.sagemath.org/sage.git/diff?id2=682dc5a0da835e06ae01461ab80de1301b2c1333&id=fdeeff6756f22fe3236d0cd1edd12751adee85c6
The dependency is by no means essential, but it was convenient since #32786 already adds the `_acted_upon_` method.


---

Comment by lorenz created at 2022-01-11 05:40:39

Changing status from new to needs_review.


---

Comment by git created at 2022-01-18 08:58:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-21 06:55:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2022-02-22 05:35:22


```diff
-               Finite Fields*. Inventiones math. 2, 134-144, 1966.
+               Finite Fields*. Inventiones Math. 2, 134-144, 1966.
```


I am not sure how good it is to rely on upstream caching here:

```
        card = getattr(E, "_order", None)  # get cached order of the curve
        self._order = Integer(E.pari_curve().ellorder(self, card))
        if card is None:
            # ellcard() is essentially free at this point because
            # the curve order was cached by PARI during ellorder().
            E._order = Integer(E.pari_curve().ellcard())
        return self._order
```

Would it be simple to just used the result to set the cache yourself?

It might be better to first check for the attribute here

```
if isinstance(R, FiniteField) and self.__base_ring.is_subring(R) and hasattr(self, '_order'):
```

as I believe the `hasattr` check should be faster (and fail more often). Although this is a very mild suggestion since I don't know what to expect from this code usage in the wild.


---

Comment by lorenz created at 2022-02-23 04:58:29

It seems all of these comments are for #32786, did you mean to post them there?


---

Comment by tscrim created at 2022-02-23 05:04:39

The middle comment is only applicable for here, but the others are indeed really about the changes in #32786. You can take care of them either there or here, whichever you prefer.


---

Comment by git created at 2022-02-24 05:27:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-02-24 05:38:15

Okay, done. Thank you.


---

Comment by tscrim created at 2022-02-24 05:55:53

Thank you. LGTM.


---

Comment by tscrim created at 2022-02-24 05:55:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-03-03 22:19:52

Resolution: fixed


---

Comment by vbraun created at 2022-03-07 23:39:10

Changing status from closed to new.


---

Comment by vbraun created at 2022-03-07 23:39:10

On the OSX buildbot:

```
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 773, in sage.structure.coerce_actions.IntegerMulAction._act_
Failed example:
    alarm(0.5); (2^(10^7)) * P
Expected:
    Traceback (most recent call last):
    ...
    AlarmInterrupt
Got:
    (0 : 1 : 0)
**********************************************************************
1 item had failures:
   1 of  15 in sage.structure.coerce_actions.IntegerMulAction._act_
    [150 tests, 1 failure, 0.55 s]
----------------------------------------------------------------------
sage -t --long --warn-long 81.8 --random-seed=0 src/sage/structure/coerce_actions.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2022-03-07 23:39:10

Resolution changed from fixed to 


---

Comment by tscrim created at 2022-03-08 00:22:19

It is now too fast for that doctest on that machine. I am not sure what the best thing to do is. Probably decrease the alarm length?


---

Comment by git created at 2022-03-08 02:58:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-03-08 03:01:03

Changing status from new to needs_review.


---

Comment by lorenz created at 2022-03-08 03:01:03

Probably, indeed. Let's try this one.

(Amazingly, I had already adjusted the same doctest to take 10× longer in the first commit here, and it still fails!)


---

Comment by tscrim created at 2022-03-08 03:21:51

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-03-08 03:21:51

Let’s give it a go.


---

Comment by vbraun created at 2022-03-09 23:38:11

Resolution: fixed


---

Comment by vbraun created at 2022-03-13 14:00:34

Thats not really an acceptable solution, cross fingers and hope that that there is no machine that is faster than 5x of what you have? You need at least a couple of orders of magnitude of safety if you want to test something like that. See also:

https://groups.google.com/g/sage-release/c/dkP267r52Y8/m/CoVwCH3aAQAJ


---

Comment by slelievre created at 2022-03-13 17:03:59

Follow-up at #33496.
