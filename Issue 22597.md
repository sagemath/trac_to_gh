# Issue 22597: infinite recursion in sage.rings.complex_interval.ComplexIntervalFieldElement.__invert__

archive/issues_022597.json:
```json
{
    "body": "CC:  @miguelmarco\n\nIt is possible to crash sage with an infinite recursion by comparing a number to zero:\n\n\n```\n...\n  File \"sage/rings/complex_interval.pyx\", line 1287, in sage.rings.complex_interval.ComplexIntervalFieldElement.__invert__ (/builddir/build/BUILD/sage-7.3/src/build/cythonized/sage/rings/complex_interval.c:13434)\n  File \"sage/rings/complex_interval.pyx\", line 1287, in sage.rings.complex_interval.ComplexIntervalFieldElement.__invert__ (/builddir/build/BUILD/sage-7.3/src/build/cythonized/sage/rings/complex_interval.c:13434)\nRuntimeError: maximum recursion depth exceeded while calling a Python object\n```\n\n\nIt looks like this came up in my code when comparing an algebraic number to zero, but the bug appears to trace to this code at `sage/rings/complex_interval.pyx`, line 1287 (SageMath version 7.3, Release Date: 2016-08-04):\n\n\n```\n        elif mpfr_sgn(a) <= 0 and mpfr_sgn(d) <= 0: # thirthd quadrant or between thirthd and fourth\n            return -(-self).__invert__()\n```\n\n\nwhich looks like it can fail in that way if the signs are zero.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22834\n\n",
    "created_at": "2017-04-19T18:44:52Z",
    "labels": [
        "number fields",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "infinite recursion in sage.rings.complex_interval.ComplexIntervalFieldElement.__invert__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22597",
    "user": "wonder"
}
```
CC:  @miguelmarco

It is possible to crash sage with an infinite recursion by comparing a number to zero:


```
...
  File "sage/rings/complex_interval.pyx", line 1287, in sage.rings.complex_interval.ComplexIntervalFieldElement.__invert__ (/builddir/build/BUILD/sage-7.3/src/build/cythonized/sage/rings/complex_interval.c:13434)
  File "sage/rings/complex_interval.pyx", line 1287, in sage.rings.complex_interval.ComplexIntervalFieldElement.__invert__ (/builddir/build/BUILD/sage-7.3/src/build/cythonized/sage/rings/complex_interval.c:13434)
RuntimeError: maximum recursion depth exceeded while calling a Python object
```


It looks like this came up in my code when comparing an algebraic number to zero, but the bug appears to trace to this code at `sage/rings/complex_interval.pyx`, line 1287 (SageMath version 7.3, Release Date: 2016-08-04):


```
        elif mpfr_sgn(a) <= 0 and mpfr_sgn(d) <= 0: # thirthd quadrant or between thirthd and fourth
            return -(-self).__invert__()
```


which looks like it can fail in that way if the signs are zero.

Issue created by migration from https://trac.sagemath.org/ticket/22834





---

archive/issue_comments_315266.json:
```json
{
    "body": "Calling N() before comparing to zero seems to be a usable workaround",
    "created_at": "2017-04-19T18:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22597#issuecomment-315266",
    "user": "wonder"
}
```

Calling N() before comparing to zero seems to be a usable workaround



---

archive/issue_comments_315267.json:
```json
{
    "body": "Do you have a complete example?",
    "created_at": "2017-04-20T08:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22597#issuecomment-315267",
    "user": "@jdemeyer"
}
```

Do you have a complete example?



---

archive/issue_comments_315268.json:
```json
{
    "body": "Changing component from number fields to basic arithmetic.",
    "created_at": "2017-04-20T08:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22597#issuecomment-315268",
    "user": "@jdemeyer"
}
```

Changing component from number fields to basic arithmetic.



---

archive/issue_comments_315269.json:
```json
{
    "body": "Works now\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.1.rc4, Release Date: 2020-05-09                 \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: ~CIF(RIF(-1,1))\n[.. NaN ..] + [.. NaN ..]*I\n```\n",
    "created_at": "2020-05-13T15:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22597",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22597#issuecomment-315269",
    "user": "@fchapoton"
}
```

Works now

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.1.rc4, Release Date: 2020-05-09                 │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: ~CIF(RIF(-1,1))
[.. NaN ..] + [.. NaN ..]*I
```

