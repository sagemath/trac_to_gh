# Issue 22573: Pari initialization segfaults in Cygwin since #22633

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-04-14 14:50:23

CC:  jdemeyer

Keywords: windows cygwin pari mmap

Sorry, I thought I had tested the last version of the patch in #22633.  But I think I just tested it in PARI/GP, but not in Sage itself, since my Sage build was broken at the time for other reasons.

The offending line is [here](https://git.sagemath.org/sage.git/tree/build/pkgs/pari/patches/prot_none_4.patch?h=develop&id=89e6ef4aea6f5af63a9ae40a998413dfc0bb39b5#n50).  It seems that `MAP_FIXED` is not working correctly for some reason, but the resulting call to `pari_err` segfaults because the pari mainstack is left in an invalid state.

I'm not sure if this is a bug in Cygwin or what, but I'm trying to put together a simplified test case.


---

Comment by jdemeyer created at 2017-04-14 14:57:22

Replying to [ticket:22810 embray]:
> It seems that `MAP_FIXED` is not working correctly for some reason

The question now becomes: why?

Does everything work fine if you remove the line `if (res != addr) pari_err(e_MEM);`

For debugging, it would be useful to print the values of `addr`, `s` and `res` after that `mmap()` call.


---

Comment by embray created at 2017-04-14 15:09:53

Yes, that's what I'm trying to do now.


---

Comment by jdemeyer created at 2017-04-14 15:17:36

I guess that `MAP_FIXED` is not commonly used, so it wouldn't be so surprising that it is buggy in Cygwin.


---

Comment by embray created at 2017-04-14 15:42:26

The problem is not so much `MAP_FIXED` itself--it works in a different context.

In this case the `mmap` in `pari_mainstack_mreset` is failing unless I call `munmap(addr, s)` first.  If I understand correctly that should be fine, because we're not using that memory anyways right now if we're setting it to `PROT_NONE`.


---

Comment by embray created at 2017-04-14 15:52:04

I also found some relevant discussion here: http://cygwin.1069669.n5.nabble.com/mmap-MAP-FIXED-vs-mprotect-td98125.html  But I think it's fine as long as you `munmap()` first--that will set those pages to unused/unresreved, and then they can be re-reserved.  The only problem is the `munmap` followed by `mmap` will not be atomic.  But how likely is that to be a problem in practice?


---

Comment by jdemeyer created at 2017-04-17 09:25:19

Replying to [comment:5 embray]:
> The only problem is the `munmap` followed by `mmap` will not be atomic.  But how likely is that to be a problem in practice?

With multi-threading, there is a non-zero chance of things going wrong.

For the record, calling `mmap()` with `MAP_FIXED` on a already-mapped region is specified by POSIX to replace an existing mapping. So if Cygwin does not support that, I would consider that a bug.


---

Comment by embray created at 2017-04-17 12:32:55

Right, I think that would be a bug too--the thread I linked to above has some comment about that.

Honestly, I might just add a patch that reverts to the old mprotect-based approach on Cygwin.


---

Comment by embray created at 2017-04-21 12:23:02

Changing priority from major to blocker.


---

Comment by embray created at 2017-04-21 14:12:51

I spent some more time poking at this, and what I found is that it suffices on Cygwin to `mprotect(..., PROT_NONE)` rather than re-mmap with PROT_NONE and MAP_FIXED, which is in fact buggy (although a known issue).

This means, unfortunately, having to put an `#ifdef __CYGWIN__` in `pari_mainstack_mreset`, to have it use `mprotect` instead of `mmap`, but other than that I think that is the only change needed.  In Cygwin, `mprotect(..., PROT_NONE)` will actually _decommit_ the memory, which is what we want.


---

Comment by jdemeyer created at 2017-04-21 14:31:09

Thanks for the analysis. Do you have a patch ready?


---

Comment by embray created at 2017-04-21 14:50:52

Incoming.


---

Comment by jdemeyer created at 2017-04-21 14:52:08

Remember to base this ticket on top of #22675.


---

Comment by embray created at 2017-04-21 14:58:08

Yep, that's the plan.


---

Comment by embray created at 2017-04-21 15:28:09

Still waiting on some testing.
----
New commits:


---

Comment by git created at 2017-04-21 17:41:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-04-21 17:42:38

Seems to work now.


---

Comment by embray created at 2017-04-21 17:42:38

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-04-23 02:46:13

Jeroen, any more comments on this? Since this worked for me on Cygwin, I would set this to a positive review. However, you know much more about Pari than I do.


---

Comment by jdemeyer created at 2017-04-23 06:19:40

Replying to [comment:17 tscrim]:
> Since this worked for me on Cygwin

Define "worked". Did you run the PARI testsuite? And the Sage doctests in `src/sage/libs/*pari*`?

If both of these pass, then it's fine for me.


---

Comment by embray created at 2017-04-24 11:25:13

I did all of the above, but Travis should confirm if possible.


---

Comment by embray created at 2017-04-24 11:25:41

Please by my CI, Travis (sorry, you probably get that all the time...)


---

Comment by tscrim created at 2017-04-24 20:08:33

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-04-24 20:08:33

I will be your CI. :P

Built okay and tests pass.


---

Comment by vbraun created at 2017-04-25 17:34:33

Resolution: fixed


---

Comment by embray created at 2017-04-28 13:11:36

This still needs to be reported upstream, however.


---

Comment by jdemeyer created at 2017-04-28 13:40:37

Right. Should I?
