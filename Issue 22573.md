# Issue 22573: Pari initialization segfaults in Cygwin since #22633

archive/issues_022573.json:
```json
{
    "body": "CC:  @jdemeyer\n\nKeywords: windows cygwin pari mmap\n\nSorry, I thought I had tested the last version of the patch in #22633.  But I think I just tested it in PARI/GP, but not in Sage itself, since my Sage build was broken at the time for other reasons.\n\nThe offending line is [here](https://git.sagemath.org/sage.git/tree/build/pkgs/pari/patches/prot_none_4.patch?h=develop&id=89e6ef4aea6f5af63a9ae40a998413dfc0bb39b5#n50).  It seems that `MAP_FIXED` is not working correctly for some reason, but the resulting call to `pari_err` segfaults because the pari mainstack is left in an invalid state.\n\nI'm not sure if this is a bug in Cygwin or what, but I'm trying to put together a simplified test case.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22810\n\n",
    "created_at": "2017-04-14T14:50:23Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Pari initialization segfaults in Cygwin since #22633",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22573",
    "user": "https://github.com/embray"
}
```
CC:  @jdemeyer

Keywords: windows cygwin pari mmap

Sorry, I thought I had tested the last version of the patch in #22633.  But I think I just tested it in PARI/GP, but not in Sage itself, since my Sage build was broken at the time for other reasons.

The offending line is [here](https://git.sagemath.org/sage.git/tree/build/pkgs/pari/patches/prot_none_4.patch?h=develop&id=89e6ef4aea6f5af63a9ae40a998413dfc0bb39b5#n50).  It seems that `MAP_FIXED` is not working correctly for some reason, but the resulting call to `pari_err` segfaults because the pari mainstack is left in an invalid state.

I'm not sure if this is a bug in Cygwin or what, but I'm trying to put together a simplified test case.

Issue created by migration from https://trac.sagemath.org/ticket/22810





---

archive/issue_comments_314480.json:
```json
{
    "body": "Replying to [ticket:22810 embray]:\n> It seems that `MAP_FIXED` is not working correctly for some reason\n\nThe question now becomes: why?\n\nDoes everything work fine if you remove the line `if (res != addr) pari_err(e_MEM);`\n\nFor debugging, it would be useful to print the values of `addr`, `s` and `res` after that `mmap()` call.",
    "created_at": "2017-04-14T14:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314480",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:22810 embray]:
> It seems that `MAP_FIXED` is not working correctly for some reason

The question now becomes: why?

Does everything work fine if you remove the line `if (res != addr) pari_err(e_MEM);`

For debugging, it would be useful to print the values of `addr`, `s` and `res` after that `mmap()` call.



---

archive/issue_comments_314481.json:
```json
{
    "body": "Yes, that's what I'm trying to do now.",
    "created_at": "2017-04-14T15:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314481",
    "user": "https://github.com/embray"
}
```

Yes, that's what I'm trying to do now.



---

archive/issue_comments_314482.json:
```json
{
    "body": "I guess that `MAP_FIXED` is not commonly used, so it wouldn't be so surprising that it is buggy in Cygwin.",
    "created_at": "2017-04-14T15:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314482",
    "user": "https://github.com/jdemeyer"
}
```

I guess that `MAP_FIXED` is not commonly used, so it wouldn't be so surprising that it is buggy in Cygwin.



---

archive/issue_comments_314483.json:
```json
{
    "body": "The problem is not so much `MAP_FIXED` itself--it works in a different context.\n\nIn this case the `mmap` in `pari_mainstack_mreset` is failing unless I call `munmap(addr, s)` first.  If I understand correctly that should be fine, because we're not using that memory anyways right now if we're setting it to `PROT_NONE`.",
    "created_at": "2017-04-14T15:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314483",
    "user": "https://github.com/embray"
}
```

The problem is not so much `MAP_FIXED` itself--it works in a different context.

In this case the `mmap` in `pari_mainstack_mreset` is failing unless I call `munmap(addr, s)` first.  If I understand correctly that should be fine, because we're not using that memory anyways right now if we're setting it to `PROT_NONE`.



---

archive/issue_comments_314484.json:
```json
{
    "body": "I also found some relevant discussion here: http://cygwin.1069669.n5.nabble.com/mmap-MAP-FIXED-vs-mprotect-td98125.html  But I think it's fine as long as you `munmap()` first--that will set those pages to unused/unresreved, and then they can be re-reserved.  The only problem is the `munmap` followed by `mmap` will not be atomic.  But how likely is that to be a problem in practice?",
    "created_at": "2017-04-14T15:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314484",
    "user": "https://github.com/embray"
}
```

I also found some relevant discussion here: http://cygwin.1069669.n5.nabble.com/mmap-MAP-FIXED-vs-mprotect-td98125.html  But I think it's fine as long as you `munmap()` first--that will set those pages to unused/unresreved, and then they can be re-reserved.  The only problem is the `munmap` followed by `mmap` will not be atomic.  But how likely is that to be a problem in practice?



---

archive/issue_comments_314485.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> The only problem is the `munmap` followed by `mmap` will not be atomic.  But how likely is that to be a problem in practice?\n\nWith multi-threading, there is a non-zero chance of things going wrong.\n\nFor the record, calling `mmap()` with `MAP_FIXED` on a already-mapped region is specified by POSIX to replace an existing mapping. So if Cygwin does not support that, I would consider that a bug.",
    "created_at": "2017-04-17T09:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314485",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 embray]:
> The only problem is the `munmap` followed by `mmap` will not be atomic.  But how likely is that to be a problem in practice?

With multi-threading, there is a non-zero chance of things going wrong.

For the record, calling `mmap()` with `MAP_FIXED` on a already-mapped region is specified by POSIX to replace an existing mapping. So if Cygwin does not support that, I would consider that a bug.



---

archive/issue_comments_314486.json:
```json
{
    "body": "Right, I think that would be a bug too--the thread I linked to above has some comment about that.\n\nHonestly, I might just add a patch that reverts to the old mprotect-based approach on Cygwin.",
    "created_at": "2017-04-17T12:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314486",
    "user": "https://github.com/embray"
}
```

Right, I think that would be a bug too--the thread I linked to above has some comment about that.

Honestly, I might just add a patch that reverts to the old mprotect-based approach on Cygwin.



---

archive/issue_comments_314487.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2017-04-21T12:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314487",
    "user": "https://github.com/embray"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_314488.json:
```json
{
    "body": "I spent some more time poking at this, and what I found is that it suffices on Cygwin to `mprotect(..., PROT_NONE)` rather than re-mmap with PROT_NONE and MAP_FIXED, which is in fact buggy (although a known issue).\n\nThis means, unfortunately, having to put an `#ifdef __CYGWIN__` in `pari_mainstack_mreset`, to have it use `mprotect` instead of `mmap`, but other than that I think that is the only change needed.  In Cygwin, `mprotect(..., PROT_NONE)` will actually *decommit* the memory, which is what we want.",
    "created_at": "2017-04-21T14:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314488",
    "user": "https://github.com/embray"
}
```

I spent some more time poking at this, and what I found is that it suffices on Cygwin to `mprotect(..., PROT_NONE)` rather than re-mmap with PROT_NONE and MAP_FIXED, which is in fact buggy (although a known issue).

This means, unfortunately, having to put an `#ifdef __CYGWIN__` in `pari_mainstack_mreset`, to have it use `mprotect` instead of `mmap`, but other than that I think that is the only change needed.  In Cygwin, `mprotect(..., PROT_NONE)` will actually *decommit* the memory, which is what we want.



---

archive/issue_comments_314489.json:
```json
{
    "body": "Thanks for the analysis. Do you have a patch ready?",
    "created_at": "2017-04-21T14:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314489",
    "user": "https://github.com/jdemeyer"
}
```

Thanks for the analysis. Do you have a patch ready?



---

archive/issue_comments_314490.json:
```json
{
    "body": "Incoming.",
    "created_at": "2017-04-21T14:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314490",
    "user": "https://github.com/embray"
}
```

Incoming.



---

archive/issue_comments_314491.json:
```json
{
    "body": "Remember to base this ticket on top of #22675.",
    "created_at": "2017-04-21T14:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314491",
    "user": "https://github.com/jdemeyer"
}
```

Remember to base this ticket on top of #22675.



---

archive/issue_comments_314492.json:
```json
{
    "body": "Yep, that's the plan.",
    "created_at": "2017-04-21T14:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314492",
    "user": "https://github.com/embray"
}
```

Yep, that's the plan.



---

archive/issue_comments_314493.json:
```json
{
    "body": "Still waiting on some testing.\n----\nNew commits:",
    "created_at": "2017-04-21T15:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314493",
    "user": "https://github.com/embray"
}
```

Still waiting on some testing.
----
New commits:



---

archive/issue_comments_314494.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-04-21T17:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314494",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_314495.json:
```json
{
    "body": "Seems to work now.",
    "created_at": "2017-04-21T17:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314495",
    "user": "https://github.com/embray"
}
```

Seems to work now.



---

archive/issue_comments_314496.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-21T17:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314496",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_314497.json:
```json
{
    "body": "Jeroen, any more comments on this? Since this worked for me on Cygwin, I would set this to a positive review. However, you know much more about Pari than I do.",
    "created_at": "2017-04-23T02:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314497",
    "user": "https://github.com/tscrim"
}
```

Jeroen, any more comments on this? Since this worked for me on Cygwin, I would set this to a positive review. However, you know much more about Pari than I do.



---

archive/issue_comments_314498.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> Since this worked for me on Cygwin\n\nDefine \"worked\". Did you run the PARI testsuite? And the Sage doctests in `src/sage/libs/*pari*`?\n\nIf both of these pass, then it's fine for me.",
    "created_at": "2017-04-23T06:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314498",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 tscrim]:
> Since this worked for me on Cygwin

Define "worked". Did you run the PARI testsuite? And the Sage doctests in `src/sage/libs/*pari*`?

If both of these pass, then it's fine for me.



---

archive/issue_comments_314499.json:
```json
{
    "body": "I did all of the above, but Travis should confirm if possible.",
    "created_at": "2017-04-24T11:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314499",
    "user": "https://github.com/embray"
}
```

I did all of the above, but Travis should confirm if possible.



---

archive/issue_comments_314500.json:
```json
{
    "body": "Please by my CI, Travis (sorry, you probably get that all the time...)",
    "created_at": "2017-04-24T11:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314500",
    "user": "https://github.com/embray"
}
```

Please by my CI, Travis (sorry, you probably get that all the time...)



---

archive/issue_comments_314501.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-24T20:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314501",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_314502.json:
```json
{
    "body": "I will be your CI. :P\n\nBuilt okay and tests pass.",
    "created_at": "2017-04-24T20:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314502",
    "user": "https://github.com/tscrim"
}
```

I will be your CI. :P

Built okay and tests pass.



---

archive/issue_comments_314503.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-25T17:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314503",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_059308.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-04-25T17:34:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22573#event-59308"
}
```



---

archive/issue_comments_314504.json:
```json
{
    "body": "This still needs to be reported upstream, however.",
    "created_at": "2017-04-28T13:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314504",
    "user": "https://github.com/embray"
}
```

This still needs to be reported upstream, however.



---

archive/issue_comments_314505.json:
```json
{
    "body": "Right. Should I?",
    "created_at": "2017-04-28T13:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22573",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22573#issuecomment-314505",
    "user": "https://github.com/jdemeyer"
}
```

Right. Should I?
