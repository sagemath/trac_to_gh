# Issue 29596: Translate Mathematica's "E" as e

Issue created by migration from https://trac.sagemath.org/ticket/29833

Original creator: charpent

Original creation time: 2020-06-09 19:24:59

Mathematica may return exp(x) as `E^x`. This is missed by our current translation to Sage, both in the `sage` method of objects with `Mathematica` parent and in the "mathematica_free" integrator.

Clarification by exemple:

```
var('x a b')
(x, a, b)
assume(b > 0)
f = (exp((x-a)/b) + 1)**(-1)
(f*f).integrate(x, algorithm="mathematica_free")
-b*log(1/E^((a - x)/b) + 1) + x + b/(1/E^((a - x)/b) + 1)
```


Exploration shows that in this symbolic expression, E is taken as the Gap function E (returns the "n"-th root of unity as an element of the universal cyclotomic field).

However:

```
mathematica.Integrate(f^2,x).sage(locals={"E":e})
-b*log(e^(-(a - x)/b) + 1) + x + b/(e^(-(a - x)/b) + 1)
```


which is correct:

```
integrate(f^2,x)
-b*log(e^(-a/b + x/b) + 1) - a + x + b/(e^(-a/b + x/b) + 1)
```


This simple workaround, however, cannot be used with Sage objects returned by `integrate(..., algorithm="mathematica_free")`. A fix to our translation is needed. It doesn't seems obvious, since `e` translation is handled by `exp`.



---

Comment by @mwageringel created at 2020-06-09 21:21:49

This can be solved by adding `E` to the symbol table, which takes care of the conversion from Mathematica to Sage. This should probably be added to `sage.symbolic.constants`.


```
sage: from sage.libs.pynac.pynac import register_symbol
sage: register_symbol(e, {'mathematica': 'E'})
sage: (f*f).integrate(x, algorithm="mathematica_free")
-b*log(e^(-(a - x)/b) + 1) + x + b/(e^(-(a - x)/b) + 1)
```



---

Comment by kcrisman created at 2020-06-10 04:08:16

That's right, that is the correct place to handle such translations.


---

Comment by charpent created at 2020-06-10 21:49:51

Replying to [comment:2 kcrisman]:
> That's right, that is the correct place to handle such translations.

This won't work. From `src/sage/symbolic/constants.py`:

```
# The base of the natural logarithm, e, is not a constant in GiNaC/Sage. It is
# represented by exp(1). A dummy class to make this work with arithmetic and
# coercion is implemented in the module sage.symbolic.constants_c for speed.
```


At the time other constants are initialized by `constants.pyx`, `e` isn't yet available. And I wasn't able to make it available at the end of the `_init__` method for exponentian in `constant_c.pyx`.

Hints ?


---

Comment by kcrisman created at 2020-06-10 22:50:10

Sorry, I had forgotten about the special case.  Hmm... how does it handle other similar conversions, or are they all lowercase?


---

Comment by charpent created at 2020-06-11 07:27:16

This can be done in the same `constants.py` file, but //after// global definition of `e`. Doctested in the `mathematica.py` interface (passes for me).

===>`needs_review`.
----
New commits:


---

Comment by charpent created at 2020-06-11 07:27:16

Changing status from new to needs_review.


---

Comment by charpent created at 2020-06-11 10:13:23

Forgot my name. Again...


---

Comment by kcrisman created at 2020-06-11 12:30:03

Thanks for fixing this, that was definitely an oversight - Maxima also has a weird symbol for `e` but we handle that with a perhaps somewhat stupid removal of `%` signs in strings, if I recall correctly, which wouldn't work so well here.  A few comments:
* You might as well add the original example as a test somewhere (perhaps in the integration file), because that provides an opportunity to test for regression in two ways then - one with people who have Mathematica, the other with people who might run internet tests.  Something like this?

```
    sage: (x,a,b)=var('x a b')
    sage: assume(b > 0)
    sage: f = (exp((x-a)/b) + 1)**(-1)
    sage: (f*f).integrate(x, algorithm="mathematica_free")  # optional -- internet
    -b*log(e^(-(a - x)/b) + 1) + x + b/(e^(-(a - x)/b) + 1)
```

* You have this already earlier in the file:

```
from sage.libs.pynac.pynac import register_symbol, I
```

  and the function is used, so do you need the whole `foo` construction?  Seems like `register_symbol` should be available.
* `bachtranslated` -> I am a big fan of Bach, but didn't know he also was responsible for the natural base of the logarithm! :-)


---

Comment by kcrisman created at 2020-06-11 12:30:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-06-11 19:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2020-06-11 20:12:28

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2020-06-11 20:12:28

Replying to [comment:8 kcrisman]:
> Thanks for fixing this, that was definitely an oversight - Maxima also has a weird symbol for `e` but we handle that with a perhaps somewhat stupid removal of `%` signs in strings, if I recall correctly, which wouldn't work so well here.  A few comments:
> * You might as well add the original example as a test somewhere (perhaps in the integration file), because that provides an opportunity to test for regression in two ways then - one with people who have Mathematica, the other with people who might run internet tests.  Something like this?
> {{{
>     sage: (x,a,b)=var('x a b')
>     sage: assume(b > 0)
>     sage: f = (exp((x-a)/b) + 1)**(-1)
>     sage: (f*f).integrate(x, algorithm="mathematica_free")  # optional -- internet
>     -b*log(e^(-(a - x)/b) + 1) + x + b/(e^(-(a - x)/b) + 1)
> }}}

Done (in `integration.py`).

> * You have this already earlier in the file:
> {{{
> from sage.libs.pynac.pynac import register_symbol, I
> }}}
>   and the function is used, so do you need the whole `foo` construction?  Seems like `register_symbol` should be available.

That was a nice thinko. Thanks for catching this !

> * `bachtranslated` -> I am a big fan of Bach, but didn't know he also was responsible for the natural base of the logarithm! :-)

The musical scale is naturally logarithmic. Any musician uses it without having to be responsible for anything. ;-) Typo nevertheless fixed.

==>`needs_review`.


---

Comment by kcrisman created at 2020-06-11 20:35:34

From my point of view this is fine, thanks for the quick work.  I would want (as per usual with me and my inability to keep a working branch anywhere near develop) someone to do the doctest running.  (I never know if we are supposed to trust the patchbot.)

> > * `bachtranslated` -> I am a big fan of Bach, but didn't know he also was responsible for the natural base of the logarithm! :-)
> 
> The musical scale is naturally logarithmic. Any musician uses it without having to be responsible for anything. ;-) Typo nevertheless fixed.

Let's not start getting into arguments over equal temperament versus Pythagorean tuning - after all, it's only the base 2 log that all agree on using :-)


---

Comment by @mwageringel created at 2020-06-11 21:40:45

Changing status from needs_review to needs_work.


---

Comment by @mwageringel created at 2020-06-11 21:40:45

The code block in integral.py needs to be indented.


---

Comment by charpent created at 2020-06-11 22:07:33

Replying to [comment:12 gh-mwageringel]:
> The code block in integral.py needs to be indented.

Which one ?


---

Comment by @mwageringel created at 2020-06-11 22:12:44

There is just one. ;)


```diff
         Check for :trac:`29833`::

-        sage: (x,a,b)=var('x a b')
-        sage: assume(b > 0)
-        sage: f = (exp((x-a)/b) + 1)**(-1)
-        sage: (f*f).integrate(x, algorithm="mathematica_free") # optional -- internet
-        -b*log(e^(-(a - x)/b) + 1) + x + b/(e^(-(a - x)/b) + 1)
+            sage: (x,a,b)=var('x a b')
+            sage: assume(b > 0)
+            sage: f = (exp((x-a)/b) + 1)**(-1)
+            sage: (f*f).integrate(x, algorithm="mathematica_free") # optional -- internet
+            -b*log(e^(-(a - x)/b) + 1) + x + b/(e^(-(a - x)/b) + 1)
```



---

Comment by @mwageringel created at 2020-06-11 22:29:02

Also, please apply this change.  Otherwise, the optional tests do not actually pass, as both `x` and `e` were set to something different in preceding tests.


```diff
--- a/src/sage/interfaces/mathematica.py
+++ b/src/sage/interfaces/mathematica.py
@@ -172,8 +172,8 @@ We find the `x` such that `e^x - 3x = 0`.

 ::

-    sage: e = mathematica('Exp[x] - 3x == 0') # optional - mathematica
-    sage: e.FindRoot(['x', 2])                # optional - mathematica
+    sage: eqn = mathematica('Exp[x] - 3x == 0') # optional - mathematica
+    sage: eqn.FindRoot(['x', 2])                # optional - mathematica
     {x -> 1.512134551657842}

 Note that this agrees with what the PARI interpreter gp produces::
@@ -358,6 +358,7 @@ correctly (:trac:`18888`, :trac:`28907`)::
 Check that Mathematica's `E` exponential symbol is correctly backtranslated
 as Sage's `e` (:trac:`29833`)::

+    sage: x = var('x')
     sage: (e^x)._mathematica_().sage()  # optional -- mathematica
     e^x
     sage: exp(x)._mathematica_().sage() # optional -- mathematica
```



---

Comment by git created at 2020-06-11 22:55:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2020-06-11 23:01:24

The changes suggested by `gh-mwageringel`  are sound, applied.

==>`needs_review`.


---

Comment by charpent created at 2020-06-11 23:01:24

Changing status from needs_work to needs_review.


---

Comment by @mwageringel created at 2020-06-12 07:12:22

Ok, thank you for fixing this.


---

Comment by @mwageringel created at 2020-06-12 07:12:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-06-27 09:25:31

Resolution: fixed
