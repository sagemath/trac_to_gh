# Issue 13213: Remove TLS/SSL-related packages

Issue created by migration from Trac.

Original creator: kini

Original creation time: 2012-08-21 07:03:26

Assignee: tbd

See [this sage-devel post by William](http://thread.gmane.org/gmane.comp.mathematics.sage.devel/54802/).

## Task

Remove the following SPKGs:

 * python_gnutls
 * gnutls
 * opencdk
 * libgcrypt
 * libgpg_error

Also:

 * no longer ship pyOpenSSL with sagenb (this will be taken care of in #13121)
 * no longer require OpenSSL dev headers in prereq

## Rationale

Read the above linked thread, but basically, `notebook(secure=True)` is rarely used, and is not even really that desirable to use, except for people setting up multiuser Sage servers, which is a small percentage of Sage users. Therefore we will require users who want to use `notebook(secure=True)` to perform the additional step of installing pyOpenSSL into Sage's Python. This allows us to get rid of our sort of problematic dependencies on OpenSSL.

Furthermore, as I understand it, our switching to OpenSSL had already made GNUTLS useless in Sage when we started shipping the Flask notebook (Sage 5.2), so we can get rid of GNUTLS and related SPKGs at the same time.


---

Comment by novoselt created at 2012-08-21 13:10:21

It would be nice to have a clear description of what someone has to do to make `secure=True` work and if someone has not done it - there should be a clear error message directing to these instructions...


---

Comment by novoselt created at 2012-08-21 13:14:49

It also would be a bit annoying to perform some extra installation on every newly built version of Sage. Is it possible to have instead some system dependencies and an environment variable that will force Sage to add pyOpenSSL automatically during build?


---

Comment by kini created at 2012-08-21 13:15:46

You can just install the SPKG from #11384 after building Sage. Is that sufficient?


---

Comment by kini created at 2012-08-21 13:16:26

Sorry, I mean #13384. Also you'd need to have OpenSSL and its dev headers installed on the system if you wanted to use `notebook(secure=True)`.


---

Comment by novoselt created at 2012-08-21 13:19:27

Replying to [comment:3 kini]:
> You can just install the SPKG from #11384 after building Sage. Is that sufficient?

So far

```
sage -i openssl
```

was sufficient (in 5.2 and later), but if this could be done automatically during build, it would be awesome.


---

Comment by kini created at 2012-08-21 13:45:48

Personally I don't think it's worth adding another environment variable to the long list we already have, just to avoid a small percentage of users having to run `sage -i openssl` and `sage -i pyopenssl` after `make`. Furthermore this will set a new precedent. Currently we have no environment variables which control whether a certain package is installed or not, except `SAGE_INSTALL_GCC` which is kind of a special case because we use GCC in Sage regardless of whether it's installed via SPKG or used from the system. Also, no environment variable causes the Sage build process to need network connectivity, as this suggestion would (unless you also want to make pyOpenSSL a standard shipped package).

IMHO installing an SPKG is not a big deal, it's one line and the average user doesn't need to know about it because they are not running a multi-user notebook server.


---

Comment by vbraun created at 2012-08-21 14:52:37

Please no new environment variables. We could have an extra makefile target 

```
ssl: all
    ./sage -i openssl
    ./sage -i pyOpenSSL
```



---

Comment by jhpalmieri created at 2012-08-21 15:30:14

So what needs doing here?

Root repo:
- remove the spkgs, modify `deps` and `spkg/install` accordingly
- modify prereq so it no longer checks for openssl (i.e., undo some of the changes at #13329)
- in README.txt, document what needs to be done to use the secure notebook
- possibly add a new target to the Makefile

Sage library:
- in the installation guide, document what needs to be done to use the secure notebook

Sagenb:
- make it work without openssl

Anything else?


---

Comment by kini created at 2012-08-21 15:35:28

In the sage library there is some code that does something with GNUTLS. It appears to be legacy code in devel/sage/sage/server/notebook . So I guess one more task is to see if anything breaks after removing the SPKGs.


---

Comment by kini created at 2012-08-21 16:34:12

(That includes upgrading extremely old notebook data, I guess.)


---

Comment by kini created at 2012-08-21 16:54:08

Here's a patch for the root repo. Did I miss anything in `deps` or `install`?


---

Comment by jhpalmieri created at 2012-08-21 18:55:32

The changes look okay at first glance. I'll try a build (on a system with openssl headers) to see how it goes. Perhaps you should mention `make ssl` in your changes to README.txt? And add a comment to the Makefile briefly describing the purpose of that target?


---

Comment by jhpalmieri created at 2012-08-21 21:53:11

Oh, and in `README.txt` and `Makefile`, you should point out that `sage -i openssl`, `make ssl`, etc., require internet access.


---

Comment by jhpalmieri created at 2012-08-22 01:19:39

When I built with the root repo patch, all tests passed, because the old notebook directory has a file `nodoctest.py`. The appropriate files (like `server/notebook/gnutls_socket_ssl.py`) say things like

```
# This file is part of the OLD Sage notebook and is NOT actively developed,
# maintained, or supported.  As of Sage v4.1.2, all notebook development has
# moved to the separate Sage Notebook project
```

at the top, so I think it's okay to completely break this by removing gnutls.


---

Attachment


---

Comment by jhpalmieri created at 2012-08-22 01:54:04

Here are some documentation patches, one for the root repo, one for the Sage library.


---

Comment by jhpalmieri created at 2012-08-22 03:32:12

Here's a patch for the prereq tarball, and here's a new [prereq tarball](http://sage.math.washington.edu/home/palmieri/SPKG/prereq-1.1.tar.gz).


---

Attachment

for prereq package; for review only


---

Attachment

apply to $SAGE_ROOT


---

Comment by kini created at 2012-08-22 05:20:33

Updated the root patches to account for the decapitalization of the pyOpenSSL SPKG name (see comments on #13384).


---

Comment by kini created at 2012-08-22 07:27:47

sagenb fix is at https://github.com/sagemath/sagenb/pull/95 if someone wants to review it.


---

Comment by kini created at 2012-08-23 01:05:52

Looking at sagenb's README.rst, I notice that besides HTTPS notebook login, OpenSSL is also used by OpenID authentication, this time through Python's bundled ssl module rather than through pyOpenSSL.

This means that if a user wanted to use OpenID authentication on their server, they'd have to install OpenSSL dev headers on their system (or install the optional openssl SPKG) and then rebuild Python, which is a bit involved. This should also be included in the "ssl" makefile target, I guess. Preferably the "ssl" makefile target shouldn't build Python twice.


---

Comment by jhpalmieri created at 2012-08-23 02:05:04

So the "ssl" target should install openssl, then build Sage, then install pyopenssl. Fortunately, the openssl spkg has very few requirements: patch should be enough, I think (and patch is necessary on Solaris, at least: the system's patch is brain-dead).

So if the ssl makefile target should include openssl, perhaps it should run a script to download the spkg and then maybe modify spkg/standard/deps, adding openssl in the appropriate place (after patch). Or maybe, given the change at #13373, you could add three (?) new targets:

- "patch", which does `./sage -i patch`
- "openssl", which has patch as a prerequisite and does `./sage -i openssl`
- "sslbuild", which has openssl as a prerequisite and just builds Sage.

Then "ssl" would have "sslbuild" as a dependency and would do `./sage -i pyopenssl`. This all seems kind of clunky, especially since we should only install openssl if necessary.

Other ideas: 
- force the user to read README.txt and install openssl manually (`./sage -i patch; ./sage -i openssl`), and then `make ssl` will take care of everything else, by building Sage and installing pyopenssl.
- include a script to check whether openssl is present, and run it as part of `make ssl`. If openssl is not present, exit and tell the user to install it.

(Wouldn't it be nice if Sage used configure? Then the user could do `./configure --ssl=True; make` and the script would figure out whether openssl was necessary, and also install pyopenssl at the end.)


---

Comment by kini created at 2012-08-23 02:55:45

Another complication is that `make ssl` (or whatever it's called) _should_ rebuild Python if it has already been built but without an ssl module.

I'm inclined to just make the user do this stuff and detail what needs to be done in the README. I'm also a bit wary of automating the installation of OpenSSL because that seems dangerously close to "bundling" it (though IANAL of course).


---

Comment by jhpalmieri created at 2012-08-23 03:07:23

Note the variable `SAGE_UPGRADING`. You should be able to rebuild Python (./sage -f python), and set this variable to "yes" and rebuild Python's dependencies by doing `make build` (is the syntax `SAGE_UPGRADING=yes make build`?). This will take a while, of course.

By they way, how should users tell if they have openssl installed? Can we put some helpful information about this in the documentation?


---

Comment by jhpalmieri created at 2012-08-23 03:55:57

Here's some documentation for README.txt (the "v2" patch). If it's okay, we can add something similar to the installation guide.


---

Attachment

for prereq package; for review only


---

Comment by kini created at 2012-08-23 05:19:23

Yup, that looks fine to me!


---

Comment by jdemeyer created at 2012-08-23 13:45:04

It seems to me that "remove GNUTLS-related packages" and "make sagenb work without OpenSSL" are two independent things.  So I think we should have two tickets, unless there is a good reason to connect these two issues.


---

Comment by jdemeyer created at 2012-08-23 13:59:24

Just FYI, the following is supported:

```
./sage -i openssl pyopenssl
```



---

Comment by jhpalmieri created at 2012-08-23 15:12:39

New documentation for the Sage library.


---

Comment by jhpalmieri created at 2012-08-23 15:12:39

Changing status from new to needs_review.


---

Attachment


---

Comment by kini created at 2012-08-24 06:02:15

Update on what's left to do: I need to build Sage and test sagenb on it in an environment where SSL doesn't exist at all, on the system or in the Sage directory (because the ssl module, on which OpenID support relies, is built or not built based on whether the system has OpenSSL dev headers, and is different from the OpenSSL module, which is provided or not provided by pyOpenSSL being installed or not installed).

Depending on what happens, I might need to add a bit more to [the pull request](https://github.com/sagemath/sagenb/pull/95). Once the pull request is merged, I'll cut a 0.10.2 and put it up on #13121.


---

Comment by ppurka created at 2012-08-24 07:21:07

I am reading the documentation and from what I understand of it, shouldn't this line be part of the ssl section of the `Makefile`?

```
./sage -f python # after ./sage -i openssl
```


Then the documentation can be simplified to:

```
1. If you don't have OpenSSL development headers installed, then run
make ssl
to get a local copy of OpenSSL and pyOpenSSL within your Sage installation.

2. If you have OpenSSL development headers installed, but pyOpenSSL is not installed,
then you can run
./sage -i pyopenssl
to install it.
```



---

Comment by kini created at 2012-08-24 07:42:57

AFAIK It's generally considered bad form to write make targets that are not idempotent or close to idempotent. Also you forgot the part about `SAGE_UPGRADING`, if I understand correctly. Finally, as I said earlier, maybe it's not such a great idea to even have OpenSSL pulled into a make target as that seems dangerously close to "bundling OpenSSL with GPL software". I like the way the patches are right now.


---

Comment by vbraun created at 2012-08-24 10:46:51

The license issue is that Sage hosts the openssl spkg, not whether or not there is a make target. I can see three options here:
  * get rid of the openssl spkg.
  * add a openssl license exception to the notebook.
  * modify the openssl spkg to only install if the openssl library is installed on the system.
While quirky, the last option might be the easiest way out. Gnome links to openssl, so unless you really know what you are doing the openssl library is installed. The problem for Sage is that the development headers are generally not installed in a end-user setup. So as long as we intend the openssl spkg to simply be a way to get the devel headers without administrative privileges then we could still claim the system library exception.


---

Comment by kini created at 2012-08-25 09:54:25

About OpenID sans ssl module: looks like it just silently breaks, i.e. clicking on certain providers in the OpenID login box just... doesn't do anything. On the other hand it's pretty clearly marked in the options that turning on OpenID requires the ssl module to be available in Python, so a little detail about this in the Sage and sagenb READMEs should be enough, IMO.

Volker, does your third option involve gutting the upstream source and only shipping the header files, or can we also build and install the actual libraries if OpenSSL exists on the system? If the latter, then even if OpenSSL doesn't exist on the system, aren't we, by hosting the SPKG, still "distributing OpenSSL", since the user could just untar the SPKG and run `make && sudo make install` in the src directory?


---

Comment by jdemeyer created at 2012-08-27 07:25:04

Replying to [comment:38 kini]:
> even if OpenSSL doesn't exist on the system, aren't we, by hosting the SPKG, still "distributing OpenSSL", since the user could just untar the SPKG and run `make && sudo make install` in the src directory?
It could be that we're violating the GPL, yes.  But it's not really clear to me, who knows?

I do think that adding the `ssl` make target doesn't change much, since it just automates something which is already possible anyway.


---

Comment by kini created at 2012-08-27 07:32:03

Well, packaging OpenSSL directly into the Sage tarball just automates something which is already possible anyway, too (downloading OpenSSL sources and compiling/installing it into $SAGE_LOCAL).


---

Comment by kini created at 2012-09-02 07:18:58

The new SPKG on #13121 is ready for review, and doesn't require OpenSSL or pyOpenSSL. If someone could also review the optional pyOpenSSL SPKG at #13384, that would great.


---

Comment by jhpalmieri created at 2012-09-02 16:30:58

Re [comment:34 the above comment]: is this ready to go? I'm happy with your changes, for what that's worth.

Re the licensing issues: this ticket doesn't make things worse, does it? It seems like it should actually improve them, since OpenSSL will no longer be required to build Sage. So I don't think these issues should hold up this ticket. The license discussion should continue on sage-devel.


---

Comment by jhpalmieri created at 2012-09-02 16:33:44

Re licensing: note by the way that running `make ssl` does not install OpenSSL, just pyOpenSSL.


---

Comment by kini created at 2012-09-02 17:05:43

Yeah, I'm fine with what's on this ticket at the moment. Especially after you removed the line `./sage -i openssl` from the `ssl` make target.


---

Comment by jdemeyer created at 2012-09-03 13:35:15

apply to $SAGE_ROOT


---

Attachment

Merged both `SAGE_ROOT` patches for easier reviewing.


---

Comment by kini created at 2012-09-03 13:38:05

Since John has already reviewed this, I find that pretty unnecessary. Note that you also merged two patches with different authors.


---

Comment by jdemeyer created at 2012-09-03 13:47:40

Replying to [comment:36 kini]:
> AFAIK It's generally considered bad form to write make targets that are not idempotent or close to idempotent.

I think that

```
./sage -i foo
```

is pretty-much idempotent, what's the concern?


---

Comment by kini created at 2012-09-03 13:49:58

I was referring to [comment:35 ppurka's comment] about putting `./sage -f python` in the makefile target.


---

Comment by jdemeyer created at 2012-09-03 13:57:48

Replying to [comment:46 kini]:
> Since John has already reviewed this, I find that pretty unnecessary.
Well, I found it confusing to look at the second patch which almost replaced the first patch completely.  I was unaware that those patches were already reviewed.  What's left to review?


---

Comment by kini created at 2012-09-03 14:00:56

Changing status from needs_review to positive_review.


---

Comment by kini created at 2012-09-03 14:00:56

Nothing, afaik. John said he's happy with my changes, and I said I'm happy with his changes. I guess neither of us considered that sufficient to set it to positive review, but now that I say it, I guess I should have...


---

Comment by jdemeyer created at 2012-09-05 18:05:39

Resolution: fixed
