# Issue 24413: fix subprocess32 on Solaris

archive/issues_024413.json:
```json
{
    "body": "CC:  jdemeyer\n\nThis is needed for #23696:\n\n\n```\nInstalling collected packages: subprocess32\n  Running setup.py install for subprocess32 ... error\n    Complete output from command /datapool/dima/Sage/sagetrac-mirror/local/bin/python2 -u -c \"import setuptools, tokenize;__file__='/tmp/pip-build-E3_FpG/subprocess32/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\\r\\n', '\\n');f.close();exec(compile(code, __file__, 'exec'))\" install --record /tmp/pip-Zw7eSW-record/install-record.txt --single-version-externally-managed --compile:\n    running install\n    running build\n    running build_py\n    creating build\n    creating build/lib.solaris-2.11-sun4v.64bit-2.7\n    copying subprocess32.py -> build/lib.solaris-2.11-sun4v.64bit-2.7\n    running build_ext\n    building '_posixsubprocess' extension\n    creating build/temp.solaris-2.11-sun4v.64bit-2.7\n    gcc -DNDEBUG -g -O3 -Wall -D_XPG6 -fPIC -I/datapool/dima/Sage/sagetrac-mirror/local/include/python2.7 -c _posixsubprocess.c -o build/temp.solaris-2.11-sun4v.64bit-2.7/_posixsubprocess.o\n    _posixsubprocess.c: In function \u2018_close_open_fds_maybe_unsafe\u2019:\n    _posixsubprocess.c:334:50: error: \u2018DIR {aka struct <anonymous>}\u2019 has no member named \u2018dd_fd\u2019; did you mean \u2018d_fd\u2019?\n             int fd_used_by_opendir = dirfd(proc_fd_dir);\n                                                      ^~~\n                                                      d_fd\n    error: command 'gcc' failed with exit status 1\n\n```\n\nThis is well-known trouble, simple (conditional on `_sun` or so) changing `dd_fd` to `d_fd` should fix it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24650\n\n",
    "created_at": "2018-02-03T14:28:46Z",
    "labels": [
        "porting: Solaris",
        "major",
        "bug"
    ],
    "title": "fix subprocess32 on Solaris",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24413",
    "user": "dimpase"
}
```
CC:  jdemeyer

This is needed for #23696:


```
Installing collected packages: subprocess32
  Running setup.py install for subprocess32 ... error
    Complete output from command /datapool/dima/Sage/sagetrac-mirror/local/bin/python2 -u -c "import setuptools, tokenize;__file__='/tmp/pip-build-E3_FpG/subprocess32/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" install --record /tmp/pip-Zw7eSW-record/install-record.txt --single-version-externally-managed --compile:
    running install
    running build
    running build_py
    creating build
    creating build/lib.solaris-2.11-sun4v.64bit-2.7
    copying subprocess32.py -> build/lib.solaris-2.11-sun4v.64bit-2.7
    running build_ext
    building '_posixsubprocess' extension
    creating build/temp.solaris-2.11-sun4v.64bit-2.7
    gcc -DNDEBUG -g -O3 -Wall -D_XPG6 -fPIC -I/datapool/dima/Sage/sagetrac-mirror/local/include/python2.7 -c _posixsubprocess.c -o build/temp.solaris-2.11-sun4v.64bit-2.7/_posixsubprocess.o
    _posixsubprocess.c: In function ‘_close_open_fds_maybe_unsafe’:
    _posixsubprocess.c:334:50: error: ‘DIR {aka struct <anonymous>}’ has no member named ‘dd_fd’; did you mean ‘d_fd’?
             int fd_used_by_opendir = dirfd(proc_fd_dir);
                                                      ^~~
                                                      d_fd
    error: command 'gcc' failed with exit status 1

```

This is well-known trouble, simple (conditional on `_sun` or so) changing `dd_fd` to `d_fd` should fix it.

Issue created by migration from https://trac.sagemath.org/ticket/24650





---

archive/issue_comments_342058.json:
```json
{
    "body": "How do we report it? I'm not familiar with reporting bugs to Python and pip packages.",
    "created_at": "2018-02-03T14:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342058",
    "user": "dimpase"
}
```

How do we report it? I'm not familiar with reporting bugs to Python and pip packages.



---

archive/issue_comments_342059.json:
```json
{
    "body": "On Solaris 11, one has `dirfd()`, and \n\n```\nCFLAGS=\"$CFLAGS -DHAVE_DIRFD\" ./sage -i subprocess32\n```\n\nworks. The problem with the source is that it provides a (hacky) workaround for older Solaris systems, that lack `dirfd()`, but do not check for the version.\n\nI don't know why  `HAVE_DIRFD` is not defined by Solaris, it might be a GNUism, in fact.",
    "created_at": "2018-02-03T15:06:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342059",
    "user": "dimpase"
}
```

On Solaris 11, one has `dirfd()`, and 

```
CFLAGS="$CFLAGS -DHAVE_DIRFD" ./sage -i subprocess32
```

works. The problem with the source is that it provides a (hacky) workaround for older Solaris systems, that lack `dirfd()`, but do not check for the version.

I don't know why  `HAVE_DIRFD` is not defined by Solaris, it might be a GNUism, in fact.



---

archive/issue_comments_342060.json:
```json
{
    "body": "Reported here: https://github.com/google/python-subprocess32/issues/40",
    "created_at": "2018-02-03T16:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342060",
    "user": "dimpase"
}
```

Reported here: https://github.com/google/python-subprocess32/issues/40



---

archive/issue_comments_342061.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> I don't know why  `HAVE_DIRFD` is not defined by Solaris, it might be a GNUism, in fact.\n\n`subprocess32` is a backport from Python3. They backported the C sources but not the `configure` script which defines macros like `HAVE_DIRFD`. So this can never work...",
    "created_at": "2018-02-04T13:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342061",
    "user": "jdemeyer"
}
```

Replying to [comment:2 dimpase]:
> I don't know why  `HAVE_DIRFD` is not defined by Solaris, it might be a GNUism, in fact.

`subprocess32` is a backport from Python3. They backported the C sources but not the `configure` script which defines macros like `HAVE_DIRFD`. So this can never work...



---

archive/issue_comments_342062.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2018-02-06T14:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342062",
    "user": "jdemeyer"
}
```

Last 10 new commits:



---

archive/issue_comments_342063.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-06T14:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342063",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_342064.json:
```json
{
    "body": "I am willing to give this a positive review, provided there is a message printed\nby spkg-install regarding running fix_config.py --- otherwise it looks totally mysterious why it actually works (it did work for me).",
    "created_at": "2018-02-07T00:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342064",
    "user": "dimpase"
}
```

I am willing to give this a positive review, provided there is a message printed
by spkg-install regarding running fix_config.py --- otherwise it looks totally mysterious why it actually works (it did work for me).



---

archive/issue_comments_342065.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-07T06:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342065",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_342066.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-02-07T06:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342066",
    "user": "jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_342067.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-07T06:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342067",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_342068.json:
```json
{
    "body": "I put a `print` statement in `fix_config.py`. Good for you?",
    "created_at": "2018-02-07T06:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342068",
    "user": "jdemeyer"
}
```

I put a `print` statement in `fix_config.py`. Good for you?



---

archive/issue_comments_342069.json:
```json
{
    "body": "Sure, thanks.",
    "created_at": "2018-02-07T11:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342069",
    "user": "dimpase"
}
```

Sure, thanks.



---

archive/issue_comments_342070.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-09T23:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24413",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24413#issuecomment-342070",
    "user": "vbraun"
}
```

Resolution: fixed
