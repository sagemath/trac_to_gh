# Issue 24413: fix subprocess32 on Solaris

Issue created by migration from https://trac.sagemath.org/ticket/24650

Original creator: dimpase

Original creation time: 2018-02-03 14:28:46

CC:  jdemeyer

This is needed for #23696:


```
Installing collected packages: subprocess32
  Running setup.py install for subprocess32 ... error
    Complete output from command /datapool/dima/Sage/sagetrac-mirror/local/bin/python2 -u -c "import setuptools, tokenize;__file__='/tmp/pip-build-E3_FpG/subprocess32/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" install --record /tmp/pip-Zw7eSW-record/install-record.txt --single-version-externally-managed --compile:
    running install
    running build
    running build_py
    creating build
    creating build/lib.solaris-2.11-sun4v.64bit-2.7
    copying subprocess32.py -> build/lib.solaris-2.11-sun4v.64bit-2.7
    running build_ext
    building '_posixsubprocess' extension
    creating build/temp.solaris-2.11-sun4v.64bit-2.7
    gcc -DNDEBUG -g -O3 -Wall -D_XPG6 -fPIC -I/datapool/dima/Sage/sagetrac-mirror/local/include/python2.7 -c _posixsubprocess.c -o build/temp.solaris-2.11-sun4v.64bit-2.7/_posixsubprocess.o
    _posixsubprocess.c: In function ‘_close_open_fds_maybe_unsafe’:
    _posixsubprocess.c:334:50: error: ‘DIR {aka struct <anonymous>}’ has no member named ‘dd_fd’; did you mean ‘d_fd’?
             int fd_used_by_opendir = dirfd(proc_fd_dir);
                                                      ^~~
                                                      d_fd
    error: command 'gcc' failed with exit status 1

```

This is well-known trouble, simple (conditional on `_sun` or so) changing `dd_fd` to `d_fd` should fix it.


---

Comment by dimpase created at 2018-02-03 14:33:31

How do we report it? I'm not familiar with reporting bugs to Python and pip packages.


---

Comment by dimpase created at 2018-02-03 15:06:55

On Solaris 11, one has `dirfd()`, and 

```
CFLAGS="$CFLAGS -DHAVE_DIRFD" ./sage -i subprocess32
```

works. The problem with the source is that it provides a (hacky) workaround for older Solaris systems, that lack `dirfd()`, but do not check for the version.

I don't know why  `HAVE_DIRFD` is not defined by Solaris, it might be a GNUism, in fact.


---

Comment by dimpase created at 2018-02-03 16:17:38

Reported here: https://github.com/google/python-subprocess32/issues/40


---

Comment by jdemeyer created at 2018-02-04 13:45:40

Replying to [comment:2 dimpase]:
> I don't know why  `HAVE_DIRFD` is not defined by Solaris, it might be a GNUism, in fact.

`subprocess32` is a backport from Python3. They backported the C sources but not the `configure` script which defines macros like `HAVE_DIRFD`. So this can never work...


---

Comment by jdemeyer created at 2018-02-06 14:37:01

Last 10 new commits:


---

Comment by jdemeyer created at 2018-02-06 14:37:01

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-02-07 00:55:54

I am willing to give this a positive review, provided there is a message printed
by spkg-install regarding running fix_config.py --- otherwise it looks totally mysterious why it actually works (it did work for me).


---

Comment by git created at 2018-02-07 06:26:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-07 06:32:11

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2018-02-07 06:32:11

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-02-07 06:32:59

I put a `print` statement in `fix_config.py`. Good for you?


---

Comment by dimpase created at 2018-02-07 11:11:27

Sure, thanks.


---

Comment by vbraun created at 2018-02-09 23:48:15

Resolution: fixed
