# Issue 12383: Reimplement elements of Zp and Qp using templates

Issue created by migration from https://trac.sagemath.org/ticket/12555

Original creator: roed

Original creation time: 2012-02-21 11:36:04

Assignee: roed

CC:  sydahmad justin wstein jstarx jpflori

The goal of this ticket is to reimplement elements of Zp and Qp using the ideas from sage/rings/polynomial/polynomial_template.pxi.  This should make p-adics in Sage both easier to maintain and easier to add new classes.


---

Comment by sydahmad created at 2012-02-21 16:17:05

Replying to [ticket:12555 roed]:
> The goal of this ticket is to reimplement elements of Zp and Qp using the ideas from sage/rings/polynomial/polynomial_template.pxi.  This should make p-adics in Sage both easier to maintain and easier to add new classes.


---

Comment by roed created at 2012-02-25 18:19:21

Now includes capped absolute and fixed modulus elements.  There are a few problems remaining:

 * `teichmuller_list` is disabled since it had a bug and I didn't want to fix it at the time.  I'll track this down later.
 * Some coercions aren't working since the element class has changed.

This version should be enough for Justin to compare the performance of the templated and non-templated versions.  I'm now going to create another patch on top of this which removes the untemplated versions.


---

Attachment

Still some bugs, but it should be useable to compare timings


---

Comment by roed created at 2012-02-29 23:33:41

I've fixed all known bugs; currently doctesting


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Comment by roed created at 2012-03-04 05:25:45

Changing status from new to needs_review.


---

Comment by was created at 2012-03-05 04:20:57

this is my REFEREE patch after reading through half the code.  I stopped at padic_ZZ_pX_FM_element.pyx.  This is the ultimate patch bomb.  Very hard to referee...


---

Attachment

A review of this patch is at `https://github.com/saraedum/padic-review/commit`. We agreed to work on the remaining issues there.


---

Comment by saraedum created at 2013-02-11 09:11:37

Changing status from needs_review to needs_work.


---

Comment by roed created at 2013-02-25 13:01:20

I've made a pull request to `https://github.com/saraedum/padic-review/commit`, addressing the comments.  Tests all pass for me.

We had discussed having a document that runs some overall tests.  I haven't made that yet, but can this week.  If someone has time to take a look at this this week, I'll be available to make changes....


---

Comment by saraedum created at 2013-02-26 23:20:09

Replying to [comment:8 roed]:
> I've made a pull request to `https://github.com/saraedum/padic-review/commit`, addressing the comments.  Tests all pass for me.
Great.

> We had discussed having a document that runs some overall tests.  I haven't made that yet, but can this week.  If someone has time to take a look at this this week, I'll be available to make changes....
You haven't started to work on this already, have you? I just started to work on these tests. I'll push to github as soon as I have something working.


---

Comment by roed created at 2013-02-26 23:32:01

> > We had discussed having a document that runs some overall tests.  I haven't made that yet, but can this week.  If someone has time to take a look at this this week, I'll be available to make changes....
> You haven't started to work on this already, have you? I just started to work on these tests. I'll push to github as soon as I have something working.

No, I haven't started.  I'll wait to see what you come up with.

Do we have a list of things that need to be done before this gets a positive review?


---

Comment by saraedum created at 2013-02-26 23:38:00

Replying to [comment:10 roed]:
> Do we have a list of things that need to be done before this gets a positive review?
Not yet. Should we use github issues for this?


---

Comment by roed created at 2013-02-26 23:39:37

Replying to [comment:11 saraedum]:
> Replying to [comment:10 roed]:
> > Do we have a list of things that need to be done before this gets a positive review?
> Not yet. Should we use github issues for this?

Sure, that sounds good.


---

Comment by saraedum created at 2013-03-17 00:54:16

apply trac_12555.patch


---

Comment by saraedum created at 2013-03-18 06:27:11

apply trac_12555.patch


---

Comment by saraedum created at 2013-03-18 23:20:53

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2013-03-18 23:43:19

apply trac_12555.patch


---

Comment by saraedum created at 2013-03-19 00:42:17

apply trac_12555.patch


---

Comment by saraedum created at 2013-03-19 02:20:15

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2013-03-19 07:10:35

apply trac_12555.patch


---

Attachment

review patch to match changes done in 5.9.beta0


---

Comment by jdemeyer created at 2013-04-23 15:24:17

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-04-23 15:24:17

Please rebase to #6223.


---

Comment by jdemeyer created at 2013-04-23 15:29:21

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-04-23 17:16:03

This still needs work rebasing to #6223. Also `PyErr_Occured()` should not be used anymore in favour of standard Python `except` handling.


---

Comment by jdemeyer created at 2013-04-23 17:16:03

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-04-23 18:35:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-04-23 18:36:31

[attachment:12555_rebase_6223.patch] needs review.


---

Comment by roed created at 2013-04-23 22:19:29

Those changes look fine to me.


---

Comment by roed created at 2013-04-23 22:19:29

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-04-23 23:54:55

Please fix this documentation problem (I won't):

```
[139 [690]] [130
! Missing $ inserted.
<inserted text> 
                $
l.10592 $i^{\mbox{prec_cap}
                           }$ if the element was defined by
? ]
! Emergency stop.
<inserted text> 
                $
l.10592 $i^{\mbox{prec_cap}
                           }$ if the element was defined by
!  ==> Fatal error occurred, no output PDF file produced!
Transcript written on padics.log.
 [17make[1]: *** [padics.pdf] Error 1
make[1]: Leaving directory `/mazur/release/merger/sage-5.10.beta1/devel/sage-main/doc/output/latex/en/reference/padics'
```



---

Comment by jdemeyer created at 2013-04-23 23:54:55

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-05-04 12:30:48

** ping **


---

Comment by roed created at 2013-05-04 19:10:06

Thanks for the ping.  I had a visitor this week, but he just left so I'll take a look.


---

Attachment

combined github patch


---

Attachment


---

Attachment

Sorry for the long delay: I've been mostly working on research rather than Sage this summer.

I was unable to reproduce the documentation problem that you observed by running `sage -docbuild reference html`.  Is there something I should do instead, or somewhere with a more complete log of the problem?  I'm not quite sure what needs to be fixed.

I did go through and change most of the dollar signs in the p-adics directory to backticks, and updated these patches against Sage 5.10.


---

Comment by roed created at 2013-07-15 22:57:00

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2013-07-16 05:33:56

I think Jeroen was refering to the pdf doc:

```
sage -docbuild all pdf
```

maybe?

For patchbot:

Apply: trac_12555.patch trac_12555_review.patch 12555_rebase_6223.patch trac_12555_doc_improvements.patch


---

Comment by roed created at 2013-07-16 06:06:19

Replying to [comment:43 tscrim]:
> I think Jeroen was refering to the pdf doc:
> {{{
> sage -docbuild all pdf
> }}}
> maybe?

Cool.  I will try that overnight.


---

Attachment


---

Comment by tscrim created at 2013-08-20 17:15:10

Okay, I fixed the pdf docbuild issue and made some minor tweaks to that file.

```
Build finished.  The built documents can be found in /home/travis/sage-5.11.rc0/devel/sage/doc/output/pdf/en/reference/padics
```


If you're happy with my tweaks, we can set this (back to) positive review.

For patchbot:

Apply: trac_12555.patch, trac_12555_review.patch, 12555_rebase_6223.patch, trac_12555_doc_improvements.patch, trac_12555-pdf_fix-ts.patchâ€‹


---

Comment by roed created at 2013-08-20 18:32:47

Thanks!  I've been trying to focus on writing papers this summer rather than Sage.  I'm happy with the changes.


---

Comment by tscrim created at 2013-08-24 15:40:21

I'm interpreting that as a positive review.


---

Comment by tscrim created at 2013-08-24 15:40:21

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-25 09:32:42

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-08-25 09:32:42

Needs to be rebased to sage-5.12.beta3.


---

Comment by saraedum created at 2013-09-05 18:52:17

Changing status from needs_work to positive_review.


---

Comment by jpflori created at 2013-09-24 16:16:25

It seems to me this does not apply cleanly anymore to what I got when I clone Sage's git branch "build_system" as of today.
I've pushed a hopefully correctly rebased branch to:
* u/jpflori/12555

Best,
JP


---

Comment by jpflori created at 2013-09-25 17:17:01

Changing keywords from "" to "sd53 padics templates".


---

Comment by ohanar created at 2013-12-15 23:00:42

New commits:


---

Comment by vbraun created at 2013-12-17 19:57:54

Conflicts with current release - git merge master & resolve


---

Comment by tscrim created at 2013-12-17 21:23:01

I've uploaded a branch with the merge. I'm recompiling now and will test it shortly.
----
New commits:


---

Comment by git created at 2013-12-19 17:18:50

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2013-12-19 17:18:50

Changing status from positive_review to needs_review.


---

Comment by tscrim created at 2013-12-19 17:19:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-12-21 14:35:22

Conflicts with sage-6.1.beta1, please fix


---

Comment by tscrim created at 2013-12-21 15:38:59

I'm not familiar enough with the code to do this merge. David, Julian, could one of you do the merge?


---

Comment by jpflori created at 2013-12-24 11:30:37

The problem is with commit fcf7972 "adapt miscellaneous files in the Sage library" which deals with Pari stuff.
Note sure from which trac ticket this is: <hint hint> put trac ticket number into git commit messages...
I'll fix it later today (currently my touchpad does not click, I cannot reboot, and tabbing all over the place is not so nice).


---

Comment by jdemeyer created at 2013-12-24 11:43:10

Replying to [comment:64 jpflori]:
> Note sure from which trac ticket this is
#15185

> <hint hint> put trac ticket number into git commit messages...
If you have to ask people, that's not going to work. When I started as release manager, I asked that and people forgot, were lazy, put the wrong number... or worse: got angry because I was complaining over such trivial things like ticket numbers in commit messages.

I learned that the only feasible solution is to have a system which automatically added the ticket number to the commit message. With git that cannot be done (that would be rewriting history), but at least automating the mapping commit -> ticket number could be done some other way.


---

Comment by vbraun created at 2013-12-24 11:49:59

Don't put trac ticket numbers in the commit message, its useless double book-keeping. Its trivial to extract from the commit tree, e.g. using my "git trac" subcommand scripts it:

```
$ git trac find fcf7972
Commit has been merged by the release manager into your current branch.
commit c04a8de608cd41ed9d7ffbe250656bce03683301
Merge: 69b08fa 7ec74e0
Author: Release Manager <release@sagemath.org>
Date:   Fri Dec 20 13:21:14 2013 +0000

    Trac #15185: Clean up interface to the PARI library
    
    The file `sage/libs/pari/gen.pyx` is too big and contains too many
    different things.  For clarity and maintainability, it should be split
    into two parts:
    - `gen.pyx` containing the class `gen`;
    - `pari_instance.pyx` containing the class `PariInstance` and some
    utility functions;
    More cleaning-up will be done in #15461.
    
    URL: http://trac.sagemath.org/15185
    Reported by: pbruin
    Ticket author(s): Peter Bruin
    Reviewer(s): Jeroen Demeyer
```



---

Comment by jdemeyer created at 2013-12-24 11:52:08


```
jdemeyer@tamiyo:/usr/local/src/sage-git$ git trac find fcf7972
git: 'trac' is not a git command. See 'git --help'.

Did you mean this?
        branch
```



---

Comment by jdemeyer created at 2013-12-24 11:52:59

Rebasing to #15185 should be easy, it doesn't make any fundamental changes, only moves stuff around...


---

Comment by vbraun created at 2013-12-24 11:53:14

No, I mean this: https://github.com/sagemath/git-trac-command


---

Comment by jdemeyer created at 2013-12-24 11:56:15

vbraun: Are there any plans to make that script part of Sage?


---

Comment by vbraun created at 2013-12-24 11:58:04

I think they are now ready to be used by a wider audience. Will make a package...


---

Comment by jdemeyer created at 2013-12-24 16:37:48

Changing status from positive_review to needs_work.


---

Comment by git created at 2013-12-24 23:43:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2013-12-24 23:47:33

Still some errors in src/sage/schemes/elliptic_curves/constructor.py and ell_egros.py raising:

```
SystemError: error return without exception set
```

when computing padic elliptic logs.
Not sure where this comes from, maybe related to #15299.


---

Comment by jpflori created at 2013-12-25 00:08:42

Apparently its when testing

```
y1 == -y2 - a1*x2 - a3
```

in ell_point.py.
The following reproduces it:

```
sage: y1 = 10*11^2 + 3*11^3 + O(11^40)
sage: y2 = 11^2 + 7*11^3 + 10*11^4 + 10*11^5 + 10*11^6 + 10*11^7 + 10*11^8 + 10*11^9 + 10*11^10 + 10*11^11 + 10*11^12 + 10*11^13 + 10*11^14 + 10*11^15 + 10*11^16 + 10*11^17 + 10*11^18 + 10*11^19 + 10*11^20 + 10*11^21 + 10*11^22 + 10*11^23 + 10*11^24 + 10*11^25 + 10*11^26 + 10*11^27 + 10*11^28 + 10*11^29 + 10*11^30 + 10*11^31 + 10*11^32 + 10*11^33 + 10*11^34 + 10*11^35 + 10*11^36 + 10*11^37 + 10*11^38 + 10*11^39 + O(11^40)
sage: y1 == y2
---------------------------------------------------------------------------
SystemError                               Traceback (most recent call last)
<ipython-input-4-2a7abc374794> in <module>()
----> 1 y1 == y2

SystemError: error return without exception set
sage: 
```



---

Comment by jpflori created at 2013-12-25 00:34:19

Ok it seems its just that mpz_cmp decides to return -2 which is also set as the except value.


---

Comment by git created at 2013-12-25 00:47:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2013-12-25 00:58:58

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-12-25 00:58:58

Should be ok now.
May be worth putting an additional test in there, but I'm too tired now and the code is already tested by the previous bug.


---

Comment by tscrim created at 2013-12-25 18:41:54

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2013-12-25 18:41:54

That example (and testing the files) now works for me, so it's back to positive review.

EDIT - also I don't think `.pxi` files are run as part of doctesting?


---

Comment by vbraun created at 2013-12-27 14:07:33

Resolution: fixed


---

Comment by vbraun created at 2013-12-27 18:33:56

Documentation doesn't build

```
[padics   ] /mnt/SSD1/mod_buildslave/sage_git/build/src/doc/en/reference/padics/sage/rings/padics/padic_base_generic_element.rst:11: WARNING: autodoc can't import/find module 'sage.rings.padics.padic_base_generic_element', it reported error: "No module named padic_base_generic_element", please check your spelling and sys.path
[padics   ] docstring of sage.rings.padics.padic_fixed_mod_element:9: ERROR: Unknown directive type "NOTES".
```



---

Comment by vbraun created at 2013-12-27 18:33:56

Resolution changed from fixed to 


---

Comment by vbraun created at 2013-12-27 18:33:56

Changing status from closed to new.


---

Comment by git created at 2013-12-27 19:33:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-12-27 19:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2013-12-27 19:36:06

New commits:


---

Comment by tscrim created at 2013-12-27 19:36:06

Changing status from new to needs_review.


---

Comment by tscrim created at 2013-12-28 20:40:18

Changing status from needs_review to positive_review.


---

Comment by niles created at 2014-01-03 20:26:09

There are a number of other power series bugs that have been waiting in one way or another for rewriting of padics.  Could someone here take a look and comment on the appropriate tickets?  They do not seem to be resolved by this one.

#9457: Buggy equality of power series -- The fix seems straightforward, but causes a bizarre doctest failure in `sha_tate.py`

#4656: Power series over p-adics treat inexact zeros inconsistently -- The fix here causes the same doctest to fail.

#8198:  p-adic precision is dropped when matrix acts on vector -- Possibly a root cause of the previous two bugs.

#5075: Polynomials over inexact rings truncate inexact leading zeroes -- This was somehow fixed for polynomials over p-adics, but polynomials over other power series still have the issue.  David Roe commented that it may be fixed as part of a larger patch (I hope there's not another one after this!)


---

Comment by vbraun created at 2014-01-04 02:09:40

Resolution: fixed


---

Comment by jdemeyer created at 2014-01-09 12:51:32

See #15653 for a blocker follow-up.
