# Issue 31755: FiniteRankFreeModuleMorphism: Add method SVD (singular value decomposition)

archive/issues_031755.json:
```json
{
    "body": "CC:  @egourgoulhon @mjungmath @honglizhaobob\n\nThis operation is currently available for matrices over `RDF`.\n\nThe version for `FiniteRankFreeModuleMorphism` would define a new basis on each of the domain and codomain (with an orthogonal change of basis) so that the matrix of the morphism in the new bases is the diagonal of the singular values.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31992\n\n",
    "created_at": "2021-06-16T17:30:36Z",
    "labels": [
        "linear algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "FiniteRankFreeModuleMorphism: Add method SVD (singular value decomposition)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31755",
    "user": "@mkoeppe"
}
```
CC:  @egourgoulhon @mjungmath @honglizhaobob

This operation is currently available for matrices over `RDF`.

The version for `FiniteRankFreeModuleMorphism` would define a new basis on each of the domain and codomain (with an orthogonal change of basis) so that the matrix of the morphism in the new bases is the diagonal of the singular values.

Issue created by migration from https://trac.sagemath.org/ticket/31992





---

archive/issue_comments_453662.json:
```json
{
    "body": "Replying to [comment:1 mkoeppe]:\n\nSorry for asking a naive question... In the description, what does `RDF` refer to (\"this operation is currently available for matrices over `RDF`\")?",
    "created_at": "2021-07-05T21:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453662",
    "user": "@honglizhaobob"
}
```

Replying to [comment:1 mkoeppe]:

Sorry for asking a naive question... In the description, what does `RDF` refer to ("this operation is currently available for matrices over `RDF`")?



---

archive/issue_comments_453663.json:
```json
{
    "body": "RDF is the \"real double-precision field\" - equivalent of `double` in C.\nhttps://doc.sagemath.org/html/en/reference/rings_numerical/sage/rings/real_double.html",
    "created_at": "2021-07-05T21:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453663",
    "user": "@mkoeppe"
}
```

RDF is the "real double-precision field" - equivalent of `double` in C.
https://doc.sagemath.org/html/en/reference/rings_numerical/sage/rings/real_double.html



---

archive/issue_comments_453664.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> RDF is the \"real double-precision field\" - equivalent of `double` in C.\n> https://doc.sagemath.org/html/en/reference/rings_numerical/sage/rings/real_double.html\n\nThanks professor. Additionally, in implementing the SVD, should we resort to external libraries such as `numpy`, or is it a better practice to use `sage` methods whenever possible?",
    "created_at": "2021-07-06T01:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453664",
    "user": "@honglizhaobob"
}
```

Replying to [comment:3 mkoeppe]:
> RDF is the "real double-precision field" - equivalent of `double` in C.
> https://doc.sagemath.org/html/en/reference/rings_numerical/sage/rings/real_double.html

Thanks professor. Additionally, in implementing the SVD, should we resort to external libraries such as `numpy`, or is it a better practice to use `sage` methods whenever possible?



---

archive/issue_comments_453665.json:
```json
{
    "body": "If I'm understanding correctly after reading the code, we are still working with matrices (instead of high-dimensional tensors). Suppose `A` is the matrix obtained from `M.hom(N, some_matrix, basis=(e, f))`. Let `x.parent() == M`, `y.parent() == N`. Then we have:\n\n\n```\ny = A*x\ny = U * S * V_dagger * x            # do SVD on A\n(U_dagger * y) = S * (V_dagger * x) # invert U\ny_prime = S*x_prime                 # renamed x and y\n```\n\n\nIn code, we will reassign the default bases of `M` and `N`:\n\n```\nM._def_basis = V\nN._def_basis = U                    # certainly, this reassignment needs more\n                                    # work in terms of actual implementations\n```\n \n\nsuch that `S` would be the result of `hom.matrix()` in this new basis.",
    "created_at": "2021-07-06T02:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453665",
    "user": "@honglizhaobob"
}
```

If I'm understanding correctly after reading the code, we are still working with matrices (instead of high-dimensional tensors). Suppose `A` is the matrix obtained from `M.hom(N, some_matrix, basis=(e, f))`. Let `x.parent() == M`, `y.parent() == N`. Then we have:


```
y = A*x
y = U * S * V_dagger * x            # do SVD on A
(U_dagger * y) = S * (V_dagger * x) # invert U
y_prime = S*x_prime                 # renamed x and y
```


In code, we will reassign the default bases of `M` and `N`:

```
M._def_basis = V
N._def_basis = U                    # certainly, this reassignment needs more
                                    # work in terms of actual implementations
```
 

such that `S` would be the result of `hom.matrix()` in this new basis.



---

archive/issue_comments_453666.json:
```json
{
    "body": "Replying to [comment:4 gh-honglizhaobob]:\n> in implementing the SVD, should we resort to external libraries such as `numpy`, or is it a better practice to use `sage` methods whenever possible?\n\nIn Sage we support a wide range of rings for the arithmetic, and consequently often use multiple libraries for the implementation and also have an in-Sage generic implementation.\n\nThe existing implementation of `SVD` in `src/sage/matrix/matrix_double_dense.pyx` just calls `scipy.linalg.svd`.\n\nIt would be quite useful to add a generic implementation that only uses the general methods that Sage matrices offer. In that way, we could have access to arbitrary precision and symbolic computations.\n\nIt would also be good to check what other libraries that we already use or could easily use also provide implementations of SVD.",
    "created_at": "2021-07-06T03:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453666",
    "user": "@mkoeppe"
}
```

Replying to [comment:4 gh-honglizhaobob]:
> in implementing the SVD, should we resort to external libraries such as `numpy`, or is it a better practice to use `sage` methods whenever possible?

In Sage we support a wide range of rings for the arithmetic, and consequently often use multiple libraries for the implementation and also have an in-Sage generic implementation.

The existing implementation of `SVD` in `src/sage/matrix/matrix_double_dense.pyx` just calls `scipy.linalg.svd`.

It would be quite useful to add a generic implementation that only uses the general methods that Sage matrices offer. In that way, we could have access to arbitrary precision and symbolic computations.

It would also be good to check what other libraries that we already use or could easily use also provide implementations of SVD.



---

archive/issue_comments_453667.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> Replying to [comment:4 gh-honglizhaobob]:\n> > in implementing the SVD, should we resort to external libraries such as `numpy`, or is it a better practice to use `sage` methods whenever possible?\n> \n> In Sage we support a wide range of rings for the arithmetic, and consequently often use multiple libraries for the implementation and also have an in-Sage generic implementation.\n> \n> The existing implementation of `SVD` in `src/sage/matrix/matrix_double_dense.pyx` just calls `scipy.linalg.svd`.\n> \n> It would be quite useful to add a generic implementation that only uses the general methods that Sage matrices offer. In that way, we could have access to arbitrary precision and symbolic computations.\n> \n> It would also be good to check what other libraries that we already use or could easily use also provide implementations of SVD.\n\nI think currently `SVD()` doesn't support other fields such as `ZZ`, or `QQ`. We may be restricted to `RDF` if we choose to use `matrix_double_dense.pyx`.",
    "created_at": "2021-07-06T06:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453667",
    "user": "@honglizhaobob"
}
```

Replying to [comment:6 mkoeppe]:
> Replying to [comment:4 gh-honglizhaobob]:
> > in implementing the SVD, should we resort to external libraries such as `numpy`, or is it a better practice to use `sage` methods whenever possible?
> 
> In Sage we support a wide range of rings for the arithmetic, and consequently often use multiple libraries for the implementation and also have an in-Sage generic implementation.
> 
> The existing implementation of `SVD` in `src/sage/matrix/matrix_double_dense.pyx` just calls `scipy.linalg.svd`.
> 
> It would be quite useful to add a generic implementation that only uses the general methods that Sage matrices offer. In that way, we could have access to arbitrary precision and symbolic computations.
> 
> It would also be good to check what other libraries that we already use or could easily use also provide implementations of SVD.

I think currently `SVD()` doesn't support other fields such as `ZZ`, or `QQ`. We may be restricted to `RDF` if we choose to use `matrix_double_dense.pyx`.



---

archive/issue_comments_453668.json:
```json
{
    "body": "Yes, that's right -- and that's I think also exactly what `scipy.linalg.svd` provides. That's why I said that it will be good to check what other implementations are available in other software. A quick search for \"arbitrary precision svd\" did not lead me to good results though",
    "created_at": "2021-07-06T07:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453668",
    "user": "@mkoeppe"
}
```

Yes, that's right -- and that's I think also exactly what `scipy.linalg.svd` provides. That's why I said that it will be good to check what other implementations are available in other software. A quick search for "arbitrary precision svd" did not lead me to good results though



---

archive/issue_comments_453669.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> Yes, that's right -- and that's I think also exactly what `scipy.linalg.svd` provides. That's why I said that it will be good to check what other implementations are available in other software. A quick search for \"arbitrary precision svd\" did not lead me to good results though\n\nCould we consider symbolic SVD such as in MATLAB or `sympy`\uff1f This way we can preserve the `QQ` structure, however I feel svd on `ZZ` will be a bit demanding..",
    "created_at": "2021-07-06T07:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453669",
    "user": "@honglizhaobob"
}
```

Replying to [comment:8 mkoeppe]:
> Yes, that's right -- and that's I think also exactly what `scipy.linalg.svd` provides. That's why I said that it will be good to check what other implementations are available in other software. A quick search for "arbitrary precision svd" did not lead me to good results though

Could we consider symbolic SVD such as in MATLAB or `sympy`？ This way we can preserve the `QQ` structure, however I feel svd on `ZZ` will be a bit demanding..



---

archive/issue_comments_453670.json:
```json
{
    "body": "Replying to [comment:9 gh-honglizhaobob]:\n> Could we consider symbolic SVD such as in MATLAB or `sympy`\uff1f This way we can preserve the `QQ` structure\n\nDo you have an example or link that illustrates what you have in mind?",
    "created_at": "2021-07-06T12:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453670",
    "user": "@mkoeppe"
}
```

Replying to [comment:9 gh-honglizhaobob]:
> Could we consider symbolic SVD such as in MATLAB or `sympy`？ This way we can preserve the `QQ` structure

Do you have an example or link that illustrates what you have in mind?



---

archive/issue_comments_453671.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> Replying to [comment:9 gh-honglizhaobob]:\n> > Could we consider symbolic SVD such as in MATLAB or `sympy`\uff1f This way we can preserve the `QQ` structure\n> \n> Do you have an example or link that illustrates what you have in mind?\n\nIn `sympy`, by `Matrix.singular_value_decomposition()` which would return symbolic results: https://docs.sympy.org/latest/modules/matrices/matrices.html",
    "created_at": "2021-07-07T07:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453671",
    "user": "@honglizhaobob"
}
```

Replying to [comment:10 mkoeppe]:
> Replying to [comment:9 gh-honglizhaobob]:
> > Could we consider symbolic SVD such as in MATLAB or `sympy`？ This way we can preserve the `QQ` structure
> 
> Do you have an example or link that illustrates what you have in mind?

In `sympy`, by `Matrix.singular_value_decomposition()` which would return symbolic results: https://docs.sympy.org/latest/modules/matrices/matrices.html



---

archive/issue_comments_453672.json:
```json
{
    "body": "Replying to [comment:11 gh-honglizhaobob]:\n\nPushed a preliminary version which only deals with `RDF`, added a method `diagonalize()` in `FiniteRankFreeModuleMorphism`.",
    "created_at": "2021-07-07T07:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453672",
    "user": "@honglizhaobob"
}
```

Replying to [comment:11 gh-honglizhaobob]:

Pushed a preliminary version which only deals with `RDF`, added a method `diagonalize()` in `FiniteRankFreeModuleMorphism`.



---

archive/issue_comments_453673.json:
```json
{
    "body": "Be careful what you push. You accidentally pushed your from the built generated files. The source code you want to modify is in `src/sage/`.\n\nCan you please rebase the branch accordingly?",
    "created_at": "2021-07-09T07:54:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453673",
    "user": "@mjungmath"
}
```

Be careful what you push. You accidentally pushed your from the built generated files. The source code you want to modify is in `src/sage/`.

Can you please rebase the branch accordingly?



---

archive/issue_comments_453674.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-09T21:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453674",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453675.json:
```json
{
    "body": "Replying to [comment:15 gh-mjungmath]:\n> Be careful what you push. You accidentally pushed your from the built generated files. The source code you want to modify is in `src/sage/`.\n> \n> Can you please rebase the branch accordingly?\n\nSorry, I have reset and pushed the code again.",
    "created_at": "2021-07-09T21:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453675",
    "user": "@honglizhaobob"
}
```

Replying to [comment:15 gh-mjungmath]:
> Be careful what you push. You accidentally pushed your from the built generated files. The source code you want to modify is in `src/sage/`.
> 
> Can you please rebase the branch accordingly?

Sorry, I have reset and pushed the code again.



---

archive/issue_comments_453676.json:
```json
{
    "body": "I've opened #32171 (Matrix: Add generic SVD method using sympy)",
    "created_at": "2021-07-09T22:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453676",
    "user": "@mkoeppe"
}
```

I've opened #32171 (Matrix: Add generic SVD method using sympy)



---

archive/issue_comments_453677.json:
```json
{
    "body": "Replying to [comment:17 gh-honglizhaobob]:\n> Sorry, I have reset and pushed the code again.\n\nDon't worry. Thanks for taking care of it. :)",
    "created_at": "2021-07-09T22:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453677",
    "user": "@mjungmath"
}
```

Replying to [comment:17 gh-honglizhaobob]:
> Sorry, I have reset and pushed the code again.

Don't worry. Thanks for taking care of it. :)



---

archive/issue_comments_453678.json:
```json
{
    "body": "When ready for review, please set author name here on the ticket to your full name, and set to \"needs_review\".",
    "created_at": "2021-07-10T21:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453678",
    "user": "@mkoeppe"
}
```

When ready for review, please set author name here on the ticket to your full name, and set to "needs_review".



---

archive/issue_comments_453679.json:
```json
{
    "body": "The `EXAMPLES` section should probably be extended so that one can see the effect of the function.\n\nSome development tools that help with this: \n- `./sage -fixdoctests src/sage/tensor/modules/free_module_morphism.py` will run the doctests and update the output\n- `./sage -docbuild reference/tensor_free_modules html` will build the HMTL documentation - looking at it may reveal mistakes in the markup of the docstring",
    "created_at": "2021-07-10T21:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31755#issuecomment-453679",
    "user": "@mkoeppe"
}
```

The `EXAMPLES` section should probably be extended so that one can see the effect of the function.

Some development tools that help with this: 
- `./sage -fixdoctests src/sage/tensor/modules/free_module_morphism.py` will run the doctests and update the output
- `./sage -docbuild reference/tensor_free_modules html` will build the HMTL documentation - looking at it may reveal mistakes in the markup of the docstring
