# Issue 12579: make sage build with gcc-4.7

Issue created by migration from https://trac.sagemath.org/ticket/12751

Original creator: mariah

Original creation time: 2012-03-26 19:48:57

Assignee: GeorgSWeber

CC:  jdemeyer leif

sage-5.0.beta10 fails to build using gcc-4.7.0
on Skynet/eno.

First failure is at linbox-1.1.6.p7:


```
../../linbox/matrix/matrix-domain.h:821:36: error: ‘mulColDense’ was not declared in this scope, and no declarations were found by argument-dependent lookup at the point of instantiation [-fpermissive]
../../linbox/matrix/matrix-domain.h:821:36: note: declarations in dependent base ‘LinBox::MVProductDomain<LinBox::GivaroExtension<LinBox::Modular<unsigned int> > >’ are not found by unqualified lookup
../../linbox/matrix/matrix-domain.h:821:36: note: use ‘this->mulColDense’ instead
make[4]: *** [linbox-sage.lo] Error 1
make[4]: Leaving directory `/home/mariah/sage/sage-5.0.beta10-x86_64-Linux-core2-fc-gcc-4.7.0/spkg/build/linbox-1.1.6.p7/src/interfaces/sage'
```



---

Comment by leif created at 2012-03-28 12:37:17

Changing keywords from "" to "GCC 4.7.0 C++11".


---

Comment by leif created at 2012-03-28 12:37:17

Also PARI 2.5.1's test suite fails due to segfaults in two test files, `compat` and `linear` (statically linked `gp` as well as the dynamically linked one).

SciPy's test suite fails to build due to an internal compiler error.

R now fails to build for me (when byte-compiling), interestingly only with _less_ fancy GCC optimizations enabled.  (It did build with LTO and Graphite loop optimization enabled).

This is all on Ubuntu 10.04.4 LTS x86_64.


---

Comment by leif created at 2012-03-28 13:15:02

Replying to [comment:5 leif]:
> SciPy's test suite fails to build due to an internal compiler error.

Turns out that this isn't reproducible.  Actually, in the first attempt (although with `SAGE_CHECK=yes`) _the build_ failed, before the test suite got built or run.

I've then successfully rebuilt SciPy without `SAGE_CHECK=yes`, and now also again with it.

Nevertheless, SciPy's `spkg-check` (for whatever reason a Python script) is suboptimal, and `spkg-install` *overwrites* `LDFLAGS`.  (It also unsets `CFLAGS` etc., but distutils take these from Python, so that's not as bad as it sounds, provided one doesn't want to rebuild [Python and] SciPy with different flags.)


---

Comment by leif created at 2012-03-28 14:23:54

Replying to [comment:5 leif]:
> Also PARI 2.5.1's test suite fails due to segfaults in two test files, `compat` and `linear` (statically linked `gp` as well as the dynamically linked one).

FWIW, I get the same test errors in the build with GCC 4.7.0 with LTO and Graphite loop optimization enabled.  Note that `ptestlong` passed for that build (with a couple of spkgs replaced, cf. sage-release thread for Sage 5.0.beta10).


---

Comment by leif created at 2012-03-28 17:32:58

Replying to [comment:5 leif]:
> R now fails to build for me (when byte-compiling), interestingly only with _less_ fancy GCC optimizations enabled.  (It did build with LTO and Graphite loop optimization enabled).

This is _really_ weird: R _does_ build if I just in addition enable LTO... 8)

(My second Sage 5.0.beta10 build with GCC 4.7.0, without LTO and Graphite loop optimization, just used `-march=native -O3 -g -fno-strict-aliasing`.)


---

Comment by leif created at 2012-03-28 18:30:51

Replying to [comment:9 leif]:
> Replying to [comment:5 leif]:
> > R now fails to build for me (when byte-compiling), interestingly only with _less_ fancy GCC optimizations enabled.  (It did build with LTO and Graphite loop optimization enabled).
> 
> This is _really_ weird: R _does_ build if I just in addition enable LTO... 8)

... and also passes its test suite with that.


---

Comment by jdemeyer created at 2012-03-31 20:49:21

Changing priority from critical to blocker.


---

Comment by leif created at 2012-03-31 20:53:10

Replying to [comment:11 jdemeyer]:

Btw., any timeline aimed at for the 5.0 release?


---

Comment by jdemeyer created at 2012-04-01 15:13:30

Replying to [comment:12 leif]:
> Btw., any timeline aimed at for the 5.0 release?
No, but you should ask William Stein.


---

Comment by leif created at 2012-04-08 01:11:43

For the record: I've updated the LinBox spkg at #12762, now also adding an `spkg-check` script; the test suite wouldn't have built with GCC 4.7.0 (even with `-fpermissive`) [nor with 4.6.3], so I patched some upstream files in addition, and changed the "disable commentator" patch.


---

Comment by leif created at 2012-04-12 13:29:46

Changing keywords from "GCC 4.7.0 C++11" to "GCC 4.7.0 C++11 -fpermissive compiler bugs".


---

Comment by leif created at 2012-04-15 11:05:36

I get a build error for the (old) eclib spkg on *Solaris* [SPARC, 32-bit]:

```
...
g++ -c -fPIC -g -O2 -DNEW_OP_ORDER -DUSE_PARI_FACTORING -DNTL_ALL -I/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/include -I/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/include arith.cc -o arith_n.o
In file included from arith.cc:24:0:
arith.h: In function 'int div(long int, long int)':
arith.h:182:39: error: 'int div(long int, long int)' conflicts with previous using declaration 'std::ldiv_t std::div(long int, long int)'
make[3]: *** [arith_n.o] Error 1
make[3]: Leaving directory `/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/spkg/build/eclib-20100711.p0/src/procs'
make[2]: *** [all] Error 2
make[2]: Leaving directory `/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/spkg/build/eclib-20100711.p0/src'
Error building eclib

real    0m9.843s
user    0m5.982s
sys     0m0.474s
************************************************************************
Error installing package eclib-20100711.p0
************************************************************************
```


Haven't yet tried the new autotools-enabled upstream package; a new _spkg_ should be posted soon on #10993, hopefully...


---

Comment by leif created at 2012-04-15 12:37:24

Replying to [comment:21 leif]:
> I get a build error for the (old) eclib spkg on *Solaris* [SPARC, 32-bit]:
> {{{
> ...
> arith.h:182:39: error: 'int div(long int, long int)' conflicts with previous using declaration 'std::ldiv_t std::div(long int, long int)'
> ...
> }}}
> 
> Haven't yet tried the new autotools-enabled upstream package; a new _spkg_ should be posted soon on #10993, hopefully...

It fails in the same way; yet I have no idea why this only fails on Solaris, as AFAIK


```C++
std::ldiv_t std::div(long int, long int)
```


is pretty C++98.  Maybe on Solaris just some `using namespace std;` gets pulled in, which isn't present on other systems.


---

Comment by leif created at 2012-04-15 12:54:37

Replying to [comment:22 leif]:
> Replying to [comment:21 leif]:
> > I get a build error for the (old) eclib spkg on *Solaris* [SPARC, 32-bit]:
> > {{{
> > ...
> > arith.h:182:39: error: 'int div(long int, long int)' conflicts with previous using declaration 'std::ldiv_t std::div(long int, long int)'
> > ...
> > }}}
> [...] I have no idea why this only fails on Solaris, as AFAIK
> 
> {{{
> #!C++
> std::ldiv_t std::div(long int, long int)
> }}}
> 
> is pretty C++98.  Maybe on Solaris just some `using namespace std;` gets pulled in, which isn't present on other systems.

Apparently Solaris' `/usr/include/stdlib.h` is the culprit:

```c++
/*
 * Copyright 2004 Sun Microsystems, Inc.  All rights reserved.
 * Use is subject to license terms.
 */

/*      Copyright (c) 1988 AT&T */
/*        All Rights Reserved   */

/*      THIS IS UNPUBLISHED PROPRIETARY SOURCE CODE OF AT&T     */
/*      The copyright notice above does not evidence any        */
/*      actual or intended publication of such source code.     */

#ifndef _STDLIB_H
#define _STDLIB_H

#pragma ident   "@(#)stdlib.h   1.51    04/06/30 SMI"   /* SVr4.0 1.22  */

#include <iso/stdlib_iso.h>
#include <iso/stdlib_c99.h>

#if defined(__EXTENSIONS__) || defined(_XPG4)
#include <sys/wait.h>
#endif

/*
 * Allow global visibility for symbols defined in
 * C++ "std" namespace in <iso/stdlib_iso.h>.
 */
#if __cplusplus >= 199711L
...
using std::div;
...
```



---

Comment by leif created at 2012-04-15 13:20:36

Minimal example:

```c++
// div.cc

#include <cstdlib>

int div(long a, long b)
{
  return 0;
}
```

This fails with GCC 4.7.0 on Solaris, while it doesn't on (e.g.) Linux.


---

Comment by leif created at 2012-04-15 16:57:13

Replying to [comment:22 leif]:
> Replying to [comment:21 leif]:
> > I get a build error for the (old) eclib spkg on *Solaris* [SPARC, 32-bit]:
> > {{{
> > ...
> > arith.h:182:39: error: 'int div(long int, long int)' conflicts with previous using declaration 'std::ldiv_t std::div(long int, long int)'
> > ...
> > }}}
> > 
> > Haven't yet tried the new autotools-enabled upstream package; a new _spkg_ should be posted soon on #10993, hopefully...
> 
> It fails in the same way; yet I have no idea why this only fails on Solaris, as AFAIK
> 
> {{{
> #!C++
> std::ldiv_t std::div(long int, long int)
> }}}
> 
> is pretty C++98.  Maybe on Solaris just some `using namespace std;` gets pulled in, which isn't present on other systems.

Now fixed in the new upstream tarball (eclib-2012-04-15.tar.gz), by renaming the function.  (See #10993.)


---

Comment by leif created at 2012-04-16 23:05:38

Added a reference to the GMP-ECM spkg ticket working around the bug on ia64.


---

Comment by leif created at 2012-04-18 01:50:16

Replying to [comment:23 leif]:
> Replying to [comment:22 leif]:
> > Replying to [comment:21 leif]:
> > > I get a build error for the (old) eclib spkg on *Solaris* [SPARC, 32-bit]:
> > > {{{
> > > ...
> > > arith.h:182:39: error: 'int div(long int, long int)' conflicts with previous using declaration 'std::ldiv_t std::div(long int, long int)'
> > > ...
> > > }}}
> > [...] I have no idea why this only fails on Solaris, as AFAIK
> > 
> > {{{
> > #!C++
> > std::ldiv_t std::div(long int, long int)
> > }}}
> > 
> > is pretty C++98.  Maybe on Solaris just some `using namespace std;` gets pulled in, which isn't present on other systems.
> 
> Apparently Solaris' `/usr/include/stdlib.h` is the culprit [...]

See #12855 for a similar issue with the FLINTQS spkg, showing up as an ambiguous call of `log()` due to definitions from `math.h` (which puts all overloaded functions also into the _global_ namespace).


---

Comment by leif created at 2012-04-18 02:25:26

Perhaps doesn't really belong to this ticket, but now also PPL fails to build -- more precisely _install_ -- (with GCC 4.7.0) on Solaris (SPARC; mark2):

```
libtool: install: strip --strip-debug /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZN22Parma_Watchdog_Library7HandlerD5Ev
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZNK22Parma_Watchdog_Library16Handler_Function3actEv
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZN22Parma_Watchdog_Library16Handler_FunctionD1Ev
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZN22Parma_Watchdog_Library16Handler_FunctionD0Ev
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZN22Parma_Watchdog_Library7HandlerD0Ev
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZStplIcSt11char_traitsIcESaIcEESbIT_T0_T1_ERKS6_PKS3_
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZN22Parma_Watchdog_Library4InitC5Ev
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZN22Parma_Watchdog_Library5EListINS_15Pending_ElementINS_4TimeEEEED5Ev
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZTSN22Parma_Watchdog_Library7HandlerE
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZTIN22Parma_Watchdog_Library7HandlerE
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZTSN22Parma_Watchdog_Library16Handler_FunctionE
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZTIN22Parma_Watchdog_Library16Handler_FunctionE
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZTVN22Parma_Watchdog_Library7HandlerE
BFD: /home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/lib/libpwl.a(Watchdog.o): no group info for section .group%_ZTVN22Parma_Watchdog_Library16Handler_FunctionE
BFD: BFD (GNU Binutils) 2.22 internal error, aborting at ../../binutils-2.22/bfd/elf.c line 2905 in bfd_elf_set_group_contents

BFD: Please report this bug.
```



---

Comment by leif created at 2012-04-18 21:22:00

Replying to [comment:10 leif]:
> Replying to [comment:9 leif]:
> > Replying to [comment:5 leif]:
> > > R now fails to build for me (when byte-compiling), interestingly only with _less_ fancy GCC optimizations enabled.  (It did build with LTO and Graphite loop optimization enabled).
> > 
> > This is _really_ weird: R _does_ build if I just in addition enable LTO... 8)
> 
> ... and also passes its test suite with that.

On 32-bit Solaris SPARC (skynet machine mark2), R segfaults during byte-compiling package "base" when compiled with `-O3`; using `-O2` instead apparently works.

(The setup -- when just sourcing `/usr/local/skynet_bash_profile` -- on the Solaris machines is currently quite broken anyway.  In addition, R 2.14.0 messes up `LD_LIBRARY_PATH` such that the dynamic linker picks up an incompatible [and totally outdated] version of `libgcc_s.so.1`, so `R` cannot be run, which of course breaks the build as well.  A work-around is to create a symbolic link to the proper version in e.g. `$SAGE_LOCAL/lib/`.)


---

Comment by jdemeyer created at 2012-04-19 08:46:12

Since the GCC spkg "fixes" all of these except for MPIR and MPFR, this won't be a blocker.


---

Comment by jdemeyer created at 2012-04-19 08:46:12

Changing priority from blocker to critical.


---

Comment by leif created at 2012-04-20 04:01:33

The zn_poly spkg from #12433 now also works around the GCC 4.7.0 bug on Itanium.


---

Comment by jdemeyer created at 2012-05-26 16:55:11

Changing keywords from "GCC 4.7.0 C++11 -fpermissive compiler bugs" to "GCC 4.7.0 C++11 -fpermissive compiler bugs sd40.5".


---

Comment by jdemeyer created at 2012-05-27 21:04:48

The ia64 bug is fixed in SVN now, tested on Skynet `cleo` (build + ptestlong passed).


---

Comment by jdemeyer created at 2012-05-29 02:13:40

Changing status from new to needs_review.


---

Attachment

Diff for the ecm spkg. For reference / review only.


---

Comment by jdemeyer created at 2012-05-29 02:21:46

Diff for the mpfr spkg. For reference / review only.


---

Attachment

Diff for the mpir spkg. For reference / review only.


---

Attachment

Diff for the zn_poly spkg. For reference / review only.


---

Attachment

Apply to SAGE_ROOT


---

Attachment


---

Comment by vbraun created at 2012-07-03 09:28:23

Well testing on skynet might be a bit difficult, but it works for me on Fedora 17 (which ships gcc 4.7.0). There are still vestiges of ia64/gcc checking in the spkgs, I still believe that this should just once and for all be dealt with by the compiler wrapper instead of littering checks for `$DYING_ARCH` everywhere. But thats for another day ;)


---

Comment by vbraun created at 2012-07-03 09:28:23

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-07-03 09:48:58

Replying to [comment:53 vbraun]:
> There are still vestiges of ia64/gcc checking in the spkgs.
There should be in the MPIR and MPFR packages, because those are prerequisites for the Sage GCC spkg.


---

Comment by jdemeyer created at 2012-07-03 09:51:27

To clarify: we still want people with GCC-4.7.0 on ia64 to be able to build Sage, but only with the Sage-built GCC.


---

Comment by leif created at 2012-07-03 10:17:37

GCC 4.7.1 has been released on June 14th.


---

Comment by leif created at 2012-07-03 10:51:14

Replying to [comment:53 vbraun]:
> There are still vestiges of ia64/gcc checking in the spkgs, I still believe that this should just once and for all be dealt with by the compiler wrapper instead of littering checks for `$DYING_ARCH` everywhere. But thats for another day ;)

Depends...  The compiler wrapper (afaik) doesn't know what code or spkg it currently builds, and usually only few parts are affected (probably with different work-arounds).  E.g. disabling optimization for the whole build is poor and may not even work.

It's probably more tedious to put [specific] work-arounds into a couple of spkgs, but IMHO also preserves some kind of modularity.

As a brute alternative, we could just blacklist (almost) all somehow non-functional compiler/OS combinations (most probably ignoring compiler options) _in Sage's prerequisite check_, but that's not very user- (nor developer-) friendly, and isn't "modular" either.




`$DYING_ARCH` does certainly have different values on different machines, or even depends on `$USER`... ;-)


---

Comment by vbraun created at 2012-07-03 11:02:25

Replying to [comment:58 leif]:
> Depends...  The compiler wrapper (afaik) doesn't know what code or spkg it currently builds, and usually only few parts are affected (probably with different work-arounds).  E.g. disabling optimization for the whole build is poor and may not even work.

I disagree. Just because our testsuite didn't catch it doesn't mean that the code was compiled correctly. If the optimizer has a known bug then we must not use that particular optimization anywhere it if we want to trust the result.


---

Comment by leif created at 2012-07-03 12:53:01

Replying to [comment:59 vbraun]:
> Replying to [comment:58 leif]:
> > Depends...  The compiler wrapper (afaik) doesn't know what code or spkg it currently builds, and usually only few parts are affected (probably with different work-arounds).  E.g. disabling optimization for the whole build is poor and may not even work.
> 
> I disagree. Just because our testsuite didn't catch it doesn't mean that the code was compiled correctly. If the optimizer has a known bug then we must not use that particular optimization anywhere it if we want to trust the result.

:-) Well, in the case I think you're referring to (ia64, "impossible reload"), the compiler bailed out, and it wasn't some "particular optimization", but the whole code generation (more precisely register allocation, in the presence of inline assemby) was broken, although only in some "corner cases".

You can almost never be sure all code will be compiled correctly [or otherwise raise an error] (under all circumstances), but testsuites are _supposed_ to get at least some confidence.  In this case certainly *GCC's* testsuite was insufficient, and/or the release hadn't been thoroughly tested [on ia64].  If instead we'd discovered `-ffoo` produced wrong code, we'd most probably used `-fno-foo`, globally.  (But if the bug affected lots of code or situations, it certainly would have shown up earlier, upstream.)

In general, if you experience some function (or code, tool, whatever) gives wrong results on _some_ inputs, you usually first try to narrow its domain, unless or until you can really fix it (and probably make sure it _does_ work in all cases it was specified for).  Dropping it completely until some "rare" issue is solved is not always an option (while _documenting_ the issue is), or simply too inconvenient.  Otherwise we'd never release any Sage version, since there are and always will be known "bugs" or limitations.


---

Comment by vbraun created at 2012-07-03 13:24:16

Its nice for the 2 remaining users (down from 3 now that skynet is down) of `$DYING_ARCH`, but I don't think its maintainable for Sage in the long run. Either we deprecate ancient compiler workarounds or the spkg-installs will fill up with crud that nobody remembers why it is there or what Itanium was. 

I don't see a problem with disabling optimization on rare architectures where this can simply be fixed by updating the compiler from the point-oh release that you probably shouldn't have used anyways. And if your distribution backported a fix then you can still reenable optimizations.


---

Comment by jdemeyer created at 2012-07-03 14:09:33

Replying to [comment:61 vbraun]:
> Its nice for the 2 remaining users (down from 3 now that skynet is down) of `$DYING_ARCH`, but I don't think its maintainable for Sage in the long run. Either we deprecate ancient compiler workarounds or the spkg-installs will fill up with crud that nobody remembers why it is there or what Itanium was.
The GCC spkg solves most of these issues.


---

Comment by leif created at 2012-07-03 14:16:44

Replying to [comment:61 vbraun]:
> Its nice for the 2 remaining users (down from 3 now that skynet is down) of `$DYING_ARCH`, but I don't think its maintainable for Sage in the long run.

We can hardly officially support platforms we have no access to.

Is skynet intentionally down?  Incidentally just tried to login...




  
> Either we deprecate ancient compiler workarounds or the spkg-installs will fill up with crud that nobody remembers why it is there or what Itanium was.

Well, that's a matter of documentation (and wikipedia ;-) ).

We used to clean up "obsolete" work-arounds regularly, have our weird prerequisites check (besides checks in some spkgs' `configure` scripts), and we meanwhile have a GCC spkg anyway (although we still have to make sure bootstrapping works, as Jeroen mentioned).

IMHO the bigger problem is some distros (or OSs) shipping immature compilers by default (some not even providing fixes later).  Always supporting the most recent GCC version on all skynet platforms may now be a requirement of the past; don't know.


---

Comment by jdemeyer created at 2012-07-07 22:29:57

Resolution: fixed


---

Comment by leif created at 2013-03-14 12:15:21

There are still issues with GCC 4.7.0 (presumably any GCC 4.7.x) on Solaris, e.g. with Singular, similar to those with FLINTQS (#12855).  (These are _not_ related to compiler bugs!)


---

Comment by leif created at 2013-03-18 18:08:18

Replying to [comment:65 leif]:
> There are still issues with GCC 4.7.0 (presumably any GCC 4.7.x) on Solaris, e.g. with Singular, similar to those with FLINTQS (#12855).  (These are _not_ related to compiler bugs!)

It seems only Singular (3-1-5) meanwhile needs to get fixed; this is #14295.
