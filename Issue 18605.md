# Issue 18605: Cythonization broken

archive/issues_018605.json:
```json
{
    "body": "CC:  fbissey ncohen\n\nThis is probably due to #18494 but needs to be investigated further.\n\nSteps to reproduce:\n\n```\ngit checkout 551d0f0ab9c7942e4d8d61bc2f18808011698dfb  # ticket 18746\nmake\ngit checkout 6.8.beta6\nmake\n```\n\nthis gives\n\n```\nError compiling Cython file:\n------------------------------------------------------------\n...\ninclude 'sage/ext/interrupt.pxi'\n\nfrom libc.stdint cimport uint8_t\n\ncdef class FastDigraph:\n    cdef uint8_t n\n                ^\n------------------------------------------------------------\n\nsage/graphs/graph_decompositions/fast_digraph.pyx:23:17: C attributes cannot be added in implementation part of extension type defined in a pxd\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18842\n\n",
    "created_at": "2015-07-02T11:21:49Z",
    "labels": [
        "cython",
        "blocker",
        "bug"
    ],
    "title": "Cythonization broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18605",
    "user": "jdemeyer"
}
```
CC:  fbissey ncohen

This is probably due to #18494 but needs to be investigated further.

Steps to reproduce:

```
git checkout 551d0f0ab9c7942e4d8d61bc2f18808011698dfb  # ticket 18746
make
git checkout 6.8.beta6
make
```

this gives

```
Error compiling Cython file:
------------------------------------------------------------
...
include 'sage/ext/interrupt.pxi'

from libc.stdint cimport uint8_t

cdef class FastDigraph:
    cdef uint8_t n
                ^
------------------------------------------------------------

sage/graphs/graph_decompositions/fast_digraph.pyx:23:17: C attributes cannot be added in implementation part of extension type defined in a pxd
```


Issue created by migration from https://trac.sagemath.org/ticket/18842





---

archive/issue_comments_253225.json:
```json
{
    "body": "Here a \n\n```\nrm local/lib/python2.7/site-packages/sage/graphs/graph_decompositions/*.pxd\n```\n\nseemed to allow one to recover, but then required a `make doc-clean && make` to rebuild the docs.",
    "created_at": "2015-07-02T22:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253225",
    "user": "strogdon"
}
```

Here a 

```
rm local/lib/python2.7/site-packages/sage/graphs/graph_decompositions/*.pxd
```

seemed to allow one to recover, but then required a `make doc-clean && make` to rebuild the docs.



---

archive/issue_comments_253226.json:
```json
{
    "body": "Actually, only `fast_digraph.pxd` and `vertex_separation.pxd` have to be removed which are new with ticket #18746.",
    "created_at": "2015-07-02T22:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253226",
    "user": "strogdon"
}
```

Actually, only `fast_digraph.pxd` and `vertex_separation.pxd` have to be removed which are new with ticket #18746.



---

archive/issue_comments_253227.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-07-03T11:09:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253227",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_253228.json:
```json
{
    "body": "So i see you are switching to only using `data_files` and the only headers to be considered are those found in `SAGE_CYTHONIZED` which makes sense as all the useful headers will be copied. \n\nIs the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?",
    "created_at": "2015-07-03T11:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253228",
    "user": "fbissey"
}
```

So i see you are switching to only using `data_files` and the only headers to be considered are those found in `SAGE_CYTHONIZED` which makes sense as all the useful headers will be copied. 

Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?



---

archive/issue_comments_253229.json:
```json
{
    "body": "Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.",
    "created_at": "2015-07-03T12:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253229",
    "user": "jdemeyer"
}
```

Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.



---

archive/issue_comments_253230.json:
```json
{
    "body": "Replying to [comment:6 fbissey]:\n> Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?\nYes, if we delete a `.pxd` file from the sources, it should also be deleted from the installation directory.",
    "created_at": "2015-07-03T12:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253230",
    "user": "jdemeyer"
}
```

Replying to [comment:6 fbissey]:
> Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?
Yes, if we delete a `.pxd` file from the sources, it should also be deleted from the installation directory.



---

archive/issue_comments_253231.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.\nBummer. You're absolutely correct. And this is what is done when they are removed manually.",
    "created_at": "2015-07-03T17:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253231",
    "user": "strogdon"
}
```

Replying to [comment:7 jdemeyer]:
> Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done **before** cythonization.
Bummer. You're absolutely correct. And this is what is done when they are removed manually.



---

archive/issue_comments_253232.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-03T20:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253232",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_253233.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2015-07-03T20:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253233",
    "user": "jdemeyer"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_253234.json:
```json
{
    "body": "See #18851 for the Cython patch.\n\nThis branch is still relevant, but it doesn't fix the problem originally reported.",
    "created_at": "2015-07-03T20:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253234",
    "user": "jdemeyer"
}
```

See #18851 for the Cython patch.

This branch is still relevant, but it doesn't fix the problem originally reported.



---

archive/issue_comments_253235.json:
```json
{
    "body": "Built Sage on top of 6.8.beta6 with commits from this ticket and #18851 + #18746. All `.pxd` files added with #18746 were removed when Sage was rebuild without #18746. Fran\u00e7ois, feel free to reverse things if you see anything out of place with the commits.",
    "created_at": "2015-07-04T22:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253235",
    "user": "strogdon"
}
```

Built Sage on top of 6.8.beta6 with commits from this ticket and #18851 + #18746. All `.pxd` files added with #18746 were removed when Sage was rebuild without #18746. Fran√ßois, feel free to reverse things if you see anything out of place with the commits.



---

archive/issue_comments_253236.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-04T22:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253236",
    "user": "strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_253237.json:
```json
{
    "body": "It's absolutely fine with me and definitely should go in.",
    "created_at": "2015-07-04T23:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253237",
    "user": "fbissey"
}
```

It's absolutely fine with me and definitely should go in.



---

archive/issue_comments_253238.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-05T10:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18605#issuecomment-253238",
    "user": "vbraun"
}
```

Resolution: fixed
