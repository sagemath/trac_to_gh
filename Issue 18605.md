# Issue 18605: Cythonization broken

Issue created by migration from https://trac.sagemath.org/ticket/18842

Original creator: jdemeyer

Original creation time: 2015-07-02 11:21:49

CC:  fbissey ncohen

This is probably due to #18494 but needs to be investigated further.

Steps to reproduce:

```
git checkout 551d0f0ab9c7942e4d8d61bc2f18808011698dfb  # ticket 18746
make
git checkout 6.8.beta6
make
```

this gives

```
Error compiling Cython file:
------------------------------------------------------------
...
include 'sage/ext/interrupt.pxi'

from libc.stdint cimport uint8_t

cdef class FastDigraph:
    cdef uint8_t n
                ^
------------------------------------------------------------

sage/graphs/graph_decompositions/fast_digraph.pyx:23:17: C attributes cannot be added in implementation part of extension type defined in a pxd
```



---

Comment by strogdon created at 2015-07-02 22:23:51

Here a 

```
rm local/lib/python2.7/site-packages/sage/graphs/graph_decompositions/*.pxd
```

seemed to allow one to recover, but then required a `make doc-clean && make` to rebuild the docs.


---

Comment by strogdon created at 2015-07-02 22:49:33

Actually, only `fast_digraph.pxd` and `vertex_separation.pxd` have to be removed which are new with ticket #18746.


---

Comment by jdemeyer created at 2015-07-03 11:09:53

New commits:


---

Comment by fbissey created at 2015-07-03 11:46:46

So i see you are switching to only using `data_files` and the only headers to be considered are those found in `SAGE_CYTHONIZED` which makes sense as all the useful headers will be copied. 

Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?


---

Comment by jdemeyer created at 2015-07-03 12:56:39

Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done *before* cythonization.


---

Comment by jdemeyer created at 2015-07-03 12:57:42

Replying to [comment:6 fbissey]:
> Is the issue only happening when one does an upgrade or a re-build where as your commit suggest we may have obsolete `.pxd`, `.pyx` or `.h` files being kept while they should have been deleted?
Yes, if we delete a `.pxd` file from the sources, it should also be deleted from the installation directory.


---

Comment by strogdon created at 2015-07-03 17:56:24

Replying to [comment:7 jdemeyer]:
> Hmm... the basic idea of my commit works, but the problem is the order: this cleaning needs to be done *before* cythonization.
Bummer. You're absolutely correct. And this is what is done when they are removed manually.


---

Comment by jdemeyer created at 2015-07-03 20:46:05

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-07-03 20:46:05

Changing priority from blocker to major.


---

Comment by jdemeyer created at 2015-07-03 20:46:05

See #18851 for the Cython patch.

This branch is still relevant, but it doesn't fix the problem originally reported.


---

Comment by strogdon created at 2015-07-04 22:14:25

Built Sage on top of 6.8.beta6 with commits from this ticket and #18851 + #18746. All `.pxd` files added with #18746 were removed when Sage was rebuild without #18746. Fran√ßois, feel free to reverse things if you see anything out of place with the commits.


---

Comment by strogdon created at 2015-07-04 22:14:25

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-07-04 23:57:38

It's absolutely fine with me and definitely should go in.


---

Comment by vbraun created at 2015-07-05 10:21:56

Resolution: fixed
