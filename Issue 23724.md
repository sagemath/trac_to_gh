# Issue 23724: construction functor for dendriform algebras

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-10-03 18:56:02

CC:  tscrim

similar to #22591


---

Comment by chapoton created at 2017-10-03 18:56:56

New commits:


---

Comment by chapoton created at 2017-10-04 06:31:53

beware : there remains 2 failing doctests. I have copied the code from the pre-Lie case, but something seems to go wrong..


---

Comment by tscrim created at 2017-10-04 18:33:46

So it is doing the pushout correctly:

```
sage: R = algebras.FreeDendriform(ZZ, 'x,y,z')
sage: S = algebras.FreeDendriform(QQ, 'zt')
sage: P = pushout(R, S)
sage: P
Free Dendriform algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field
```

The problem comes from this:

```
sage: P.coerce_map_from(R)
sage: P.coerce_map_from(S)
```

Contrast this with the pre-Lie algebra:

```
sage: R = algebras.FreePreLie(ZZ, 'xyz')
sage: S = algebras.FreePreLie(QQ, 'zt')
sage: P = pushout(R, S)
sage: P.coerce_map_from(S)
Coercion map:
  From: Free PreLie algebra on 2 generators ['z', 't'] over Rational Field
  To:   Free PreLie algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field
sage: P.coerce_map_from(R)
Coercion map:
  From: Free PreLie algebra on 3 generators ['x', 'y', 'z'] over Integer Ring
  To:   Free PreLie algebra on 4 generators ['z', 't', 'x', 'y'] over Rational Field
```

However, now I run into a problem with an infinite recursion that comes from this:

```
sage: T = R.basis().keys()
Labelled binary trees
sage: z in T  # Which calls the line below
sage: T(z)    # This is where the problem really comes from
```

Strangely, this works:

```
sage: x in R.basis().keys()
False
sage: R.basis().keys()(x)
...  # Takes quite a while to get to this error message
TypeError: 'sage.rings.integer.Integer' object is not iterable
```

This is the same on vanilla `8.1.beta6` (on `8.1.beta3`, the last one actually returned the "correct" error of `ValueError: this is not a binary tree`).

Still investigating.


---

Comment by tscrim created at 2017-10-04 19:02:16

Okay, so the problem comes down to this:

```
sage: T(1)
None[., .]
sage: T(1/2)  # BOOM
```

Now, why does it infinitely recurse? Answer: `BinaryTree.__init__` iterates over its input if it is not a string, empty list/tuple, or a binary tree. Now what is really strange is we can iterate over rational numbers, but not integers:

```
sage: list(QQ(1))
[1]
sage: list(ZZ(1))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-10-9e757a9d24a6> in <module>()
----> 1 list(ZZ(Integer(1)))

TypeError: 'sage.rings.integer.Integer' object is not iterable
```

It is the fact that a rational number iterator just yields itself, and hence the loop:

```
sage: list(1/2)
[1/2]
```

In particular, this iterator behavior comes from implemented in `Rational.list`. This was done for compatibility with number fields according to its docstring.
----
So now we need to decide how to fix this bug (which we can do here or a separate ticket). Note #23821 does not affect this problem. Here are some possible solutions that come to my mind:

1. Only allowing list, tuple, and subclasses of `Tree` for iteration (in `BinaryTree.__init__`).
2. Immediately error out on subclasses of `FieldElement` for iteration.
3. Immediately error out on any element whose parent is in `Rings` for iteration.
4. Immediately error out if any iterator that does not give a length 2 list.


---

Comment by tscrim created at 2017-10-04 19:03:13

New commits:


---

Comment by git created at 2017-10-08 08:44:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-10-08 08:47:26

I have added a simple check in the init of binary trees.


---

Comment by tscrim created at 2017-10-08 15:31:40

Works for me, but I think we should add a test in the `BinaryTree.__init__` about the infinite loop with a `QQ` element. I would set a positive review otherwise if this is ready for review.


---

Comment by git created at 2017-10-08 16:22:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-10-08 16:24:09

I have added the doctest. Patchbot was green before this addition.


---

Comment by chapoton created at 2017-10-08 16:24:09

Changing status from new to needs_review.


---

Comment by git created at 2017-10-08 21:27:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-10-08 21:28:17

I expanded the documentation about that test a little bit more. If my change is good, then positive review.


---

Comment by chapoton created at 2017-10-09 06:50:35

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2017-10-09 06:50:35

ok, thanks


---

Comment by vbraun created at 2017-10-20 09:15:21

Resolution: fixed
