# Issue 26032: Implement lean_matrix.RationalMatrix using mpq

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2018-09-13 10:38:37

CC:  rudi stefan yomcat jdemeyer

Keywords: rational matrix

There are special `LeanMatrices` for matroids for `GF(k)` with `k = 2,3,4` and for matrices with entires `+-1` and `0`. However, `QQ` is a common realization field for matroids, so we should implement a custom subclass of `LeanMatrix` for working over `QQ` that directly manipulates an array of mpq values. This way Cython can optimize these code paths rather than falling back on the generic implementation.


---

Comment by tscrim created at 2018-09-14 01:11:10

New commits:


---

Comment by git created at 2018-09-14 02:08:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-09-14 03:02:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-09-14 03:10:18

Okay, things seem to work now. I also fixed a bug with `IntegerMatrix.resize`.

Here is my test case:

```
sage: W = WeylGroup(['F',4], prefix='s')
sage: def test(W):
....:     d = {}
....:     for w in W:
....:         I = w.inversion_arrangement()
....:         M = I.matroid()
....:         c = M.chordality()
....:         if c in d:
....:             d[c].append(w)
....:         else:
....:             d[c] = [w]
....:     return d
sage: %time d = test(W)
CPU times: user 19.4 s, sys: 12 ms, total: 19.4 s
Wall time: 19.4 s
```

vs before

```
sage: %time d = test(W)
CPU times: user 40.1 s, sys: 8 ms, total: 40.1 s
Wall time: 40.1 s
```


Perhaps Jeroen has some extra tricks for getting some more speed out, but I am happy with a ~2x speedup.


---

Comment by tscrim created at 2018-09-14 03:10:18

Changing status from new to needs_review.


---

Comment by git created at 2018-09-14 03:17:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-09-14 03:21:41

Okay, I should have checked better. The change to `IntegerMatrix.resize()` did not fix the crash. So I reverted them. Here is the current state (which should be the same on vanilla 8.4.beta4):

```
sage: from sage.matroids.lean_matrix import IntegerMatrix
sage: IM = IntegerMatrix(2, 2, matrix(2,2))
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (2, 2, [0, 0, 0, 0])))
sage: %%cython
....: from sage.matroids.lean_matrix cimport IntegerMatrix
....: def resize(R, k):
....:     (<IntegerMatrix?> R).resize(k)
....: 
sage: resize(IM, 3)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (3, 2, [0, 0, 0, 0, 32, 0])))
sage: resize(IM, 5)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>,
 (0, (5, 2, [90453552, 0, 81528480, 0, 32, 0, 944, 0, 2, 0])))
sage: IM = IntegerMatrix(2, 2, matrix(2,2))  # Crash
```


```
sage: resize(IM, 1)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (1, 2, [0, 0])))
sage: resize(IM, 3)
*** Error in `/home/uqtscrim/sage-build/local/bin/python2': realloc(): invalid next size: 0x0000000004b42580 ***
```

However, this deserves to also be a separate ticket.


---

Comment by tscrim created at 2018-09-14 05:00:00

Wrong ticket (suppose to be #26237). Patchbot here has some errors that I need to fix.


---

Comment by tscrim created at 2018-09-14 05:06:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-09-14 22:30:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-09-14 22:31:03

Okay, this one is now ready.


---

Comment by tscrim created at 2018-09-14 22:31:03

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-09-15 05:27:20

Now with green patchbot. :)


---

Comment by tscrim created at 2018-09-16 22:57:39

Rebased branch over last commit in #26237.
----
New commits:


---

Comment by chapoton created at 2021-07-08 06:55:45

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-07-08 06:55:45

ok, let's move on


---

Comment by vbraun created at 2021-07-18 22:53:44

Resolution: fixed
