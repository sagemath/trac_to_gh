# Issue 26032: Implement lean_matrix.RationalMatrix using mpq

archive/issues_026032.json:
```json
{
    "body": "CC:  rudi stefan yomcat @jdemeyer\n\nKeywords: rational matrix\n\nThere are special `LeanMatrices` for matroids for `GF(k)` with `k = 2,3,4` and for matrices with entires `+-1` and `0`. However, `QQ` is a common realization field for matroids, so we should implement a custom subclass of `LeanMatrix` for working over `QQ` that directly manipulates an array of mpq values. This way Cython can optimize these code paths rather than falling back on the generic implementation.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26269\n\n",
    "created_at": "2018-09-13T10:38:37Z",
    "labels": [
        "matroid theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Implement lean_matrix.RationalMatrix using mpq",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26032",
    "user": "@tscrim"
}
```
CC:  rudi stefan yomcat @jdemeyer

Keywords: rational matrix

There are special `LeanMatrices` for matroids for `GF(k)` with `k = 2,3,4` and for matrices with entires `+-1` and `0`. However, `QQ` is a common realization field for matroids, so we should implement a custom subclass of `LeanMatrix` for working over `QQ` that directly manipulates an array of mpq values. This way Cython can optimize these code paths rather than falling back on the generic implementation.

Issue created by migration from https://trac.sagemath.org/ticket/26269





---

archive/issue_comments_367192.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-09-14T01:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367192",
    "user": "@tscrim"
}
```

New commits:



---

archive/issue_comments_367193.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-14T02:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367193",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_367194.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-14T03:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367194",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367195.json:
```json
{
    "body": "Okay, things seem to work now. I also fixed a bug with `IntegerMatrix.resize`.\n\nHere is my test case:\n\n```\nsage: W = WeylGroup(['F',4], prefix='s')\nsage: def test(W):\n....:     d = {}\n....:     for w in W:\n....:         I = w.inversion_arrangement()\n....:         M = I.matroid()\n....:         c = M.chordality()\n....:         if c in d:\n....:             d[c].append(w)\n....:         else:\n....:             d[c] = [w]\n....:     return d\nsage: %time d = test(W)\nCPU times: user 19.4 s, sys: 12 ms, total: 19.4 s\nWall time: 19.4 s\n```\n\nvs before\n\n```\nsage: %time d = test(W)\nCPU times: user 40.1 s, sys: 8 ms, total: 40.1 s\nWall time: 40.1 s\n```\n\n\nPerhaps Jeroen has some extra tricks for getting some more speed out, but I am happy with a ~2x speedup.",
    "created_at": "2018-09-14T03:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367195",
    "user": "@tscrim"
}
```

Okay, things seem to work now. I also fixed a bug with `IntegerMatrix.resize`.

Here is my test case:

```
sage: W = WeylGroup(['F',4], prefix='s')
sage: def test(W):
....:     d = {}
....:     for w in W:
....:         I = w.inversion_arrangement()
....:         M = I.matroid()
....:         c = M.chordality()
....:         if c in d:
....:             d[c].append(w)
....:         else:
....:             d[c] = [w]
....:     return d
sage: %time d = test(W)
CPU times: user 19.4 s, sys: 12 ms, total: 19.4 s
Wall time: 19.4 s
```

vs before

```
sage: %time d = test(W)
CPU times: user 40.1 s, sys: 8 ms, total: 40.1 s
Wall time: 40.1 s
```


Perhaps Jeroen has some extra tricks for getting some more speed out, but I am happy with a ~2x speedup.



---

archive/issue_comments_367196.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-14T03:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367196",
    "user": "@tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367197.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-14T03:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367197",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367198.json:
```json
{
    "body": "Okay, I should have checked better. The change to `IntegerMatrix.resize()` did not fix the crash. So I reverted them. Here is the current state (which should be the same on vanilla 8.4.beta4):\n\n```\nsage: from sage.matroids.lean_matrix import IntegerMatrix\nsage: IM = IntegerMatrix(2, 2, matrix(2,2))\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>, (0, (2, 2, [0, 0, 0, 0])))\nsage: %%cython\n....: from sage.matroids.lean_matrix cimport IntegerMatrix\n....: def resize(R, k):\n....:     (<IntegerMatrix?> R).resize(k)\n....: \nsage: resize(IM, 3)\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>, (0, (3, 2, [0, 0, 0, 0, 32, 0])))\nsage: resize(IM, 5)\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>,\n (0, (5, 2, [90453552, 0, 81528480, 0, 32, 0, 944, 0, 2, 0])))\nsage: IM = IntegerMatrix(2, 2, matrix(2,2))  # Crash\n```\n\n\n```\nsage: resize(IM, 1)\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>, (0, (1, 2, [0, 0])))\nsage: resize(IM, 3)\n*** Error in `/home/uqtscrim/sage-build/local/bin/python2': realloc(): invalid next size: 0x0000000004b42580 ***\n```\n\nHowever, this deserves to also be a separate ticket.",
    "created_at": "2018-09-14T03:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367198",
    "user": "@tscrim"
}
```

Okay, I should have checked better. The change to `IntegerMatrix.resize()` did not fix the crash. So I reverted them. Here is the current state (which should be the same on vanilla 8.4.beta4):

```
sage: from sage.matroids.lean_matrix import IntegerMatrix
sage: IM = IntegerMatrix(2, 2, matrix(2,2))
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (2, 2, [0, 0, 0, 0])))
sage: %%cython
....: from sage.matroids.lean_matrix cimport IntegerMatrix
....: def resize(R, k):
....:     (<IntegerMatrix?> R).resize(k)
....: 
sage: resize(IM, 3)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (3, 2, [0, 0, 0, 0, 32, 0])))
sage: resize(IM, 5)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>,
 (0, (5, 2, [90453552, 0, 81528480, 0, 32, 0, 944, 0, 2, 0])))
sage: IM = IntegerMatrix(2, 2, matrix(2,2))  # Crash
```


```
sage: resize(IM, 1)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (1, 2, [0, 0])))
sage: resize(IM, 3)
*** Error in `/home/uqtscrim/sage-build/local/bin/python2': realloc(): invalid next size: 0x0000000004b42580 ***
```

However, this deserves to also be a separate ticket.



---

archive/issue_comments_367199.json:
```json
{
    "body": "Wrong ticket (suppose to be #26237). Patchbot here has some errors that I need to fix.",
    "created_at": "2018-09-14T05:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367199",
    "user": "@tscrim"
}
```

Wrong ticket (suppose to be #26237). Patchbot here has some errors that I need to fix.



---

archive/issue_comments_367200.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-14T05:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367200",
    "user": "@tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_367201.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-14T22:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367201",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367202.json:
```json
{
    "body": "Okay, this one is now ready.",
    "created_at": "2018-09-14T22:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367202",
    "user": "@tscrim"
}
```

Okay, this one is now ready.



---

archive/issue_comments_367203.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-14T22:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367203",
    "user": "@tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_367204.json:
```json
{
    "body": "Now with green patchbot. :)",
    "created_at": "2018-09-15T05:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367204",
    "user": "@tscrim"
}
```

Now with green patchbot. :)



---

archive/issue_comments_367205.json:
```json
{
    "body": "Rebased branch over last commit in #26237.\n----\nNew commits:",
    "created_at": "2018-09-16T22:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367205",
    "user": "@tscrim"
}
```

Rebased branch over last commit in #26237.
----
New commits:



---

archive/issue_comments_367206.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-08T06:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367206",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367207.json:
```json
{
    "body": "ok, let's move on",
    "created_at": "2021-07-08T06:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367207",
    "user": "@fchapoton"
}
```

ok, let's move on



---

archive/issue_comments_367208.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-18T22:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26032",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26032#issuecomment-367208",
    "user": "@vbraun"
}
```

Resolution: fixed
