# Issue 17163: Speed improvement for DiGraph.in_degree

archive/issues_016926.json:
```json
{
    "body": "As reported by Jori, the following is... unexpected:\n\n```\nsage: g = digraphs.RandomDirectedGNP(300,.2)\nsage: %timeit g.sinks() # vertices of outdegree 0\n1000 loops, best of 3: 376 \u00b5s per loop\nsage: %timeit g.sources() # vertices of indegree 0\n100 loops, best of 3: 7.78 ms per loop\n```\n\nWith this patch:\n\n```\nsage: g = digraphs.RandomDirectedGNP(300,.2)      \nsage: %timeit g.sinks() # vertices of outdegree 0 \n1000 loops, best of 3: 370 \u00b5s per loop\nsage: %timeit g.sources() # vertices of indegree 0\n1000 loops, best of 3: 361 \u00b5s per loop\n```\n\nCause:\n\nThis is because the function `in_degree` was not implemented at the data structure level, but \"abstractly\" by iterating over all incoming edges of a vertices and counting them. This is bad, especially since any sensible backends already stores that information.\n\nWhat the branch does:\n\n1) Add a `in_degree` function in the CGraph backend.\n\n2) Add a `in_degree` and `out_degree` (empty) function in the `GenericGraph` backend (the only point is to write somewhere that the `in_degree/out_degree` functions should be implemented by all graph backends\n\n3) Add a `in_degree/out_degree` function to the NetworkX backend. This backend is only used in one doctest, and this is the only backend that did not have this function.\n\n4) Because all backends now have the `in_degree/out_degree` functions, it is now useless to 'check if the backend has the function' before calling it. As a result the code of `DiGraph.in_degree/out_degree` is simplified.\n\nNathann\n\nCC:  @jm58660\n\nBranch/Commit: 0bcb1b78e32614db88ea00658caf986eff07a3f1\n\nReviewer: David Coudert\n\nAuthor: Nathann Cohen\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17163\n\n",
    "closed_at": "2014-10-18T18:19:10Z",
    "created_at": "2014-10-16T06:03:08Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Speed improvement for DiGraph.in_degree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17163",
    "user": "https://github.com/nathanncohen"
}
```
As reported by Jori, the following is... unexpected:

```
sage: g = digraphs.RandomDirectedGNP(300,.2)
sage: %timeit g.sinks() # vertices of outdegree 0
1000 loops, best of 3: 376 µs per loop
sage: %timeit g.sources() # vertices of indegree 0
100 loops, best of 3: 7.78 ms per loop
```

With this patch:

```
sage: g = digraphs.RandomDirectedGNP(300,.2)      
sage: %timeit g.sinks() # vertices of outdegree 0 
1000 loops, best of 3: 370 µs per loop
sage: %timeit g.sources() # vertices of indegree 0
1000 loops, best of 3: 361 µs per loop
```

Cause:

This is because the function `in_degree` was not implemented at the data structure level, but "abstractly" by iterating over all incoming edges of a vertices and counting them. This is bad, especially since any sensible backends already stores that information.

What the branch does:

1) Add a `in_degree` function in the CGraph backend.

2) Add a `in_degree` and `out_degree` (empty) function in the `GenericGraph` backend (the only point is to write somewhere that the `in_degree/out_degree` functions should be implemented by all graph backends

3) Add a `in_degree/out_degree` function to the NetworkX backend. This backend is only used in one doctest, and this is the only backend that did not have this function.

4) Because all backends now have the `in_degree/out_degree` functions, it is now useless to 'check if the backend has the function' before calling it. As a result the code of `DiGraph.in_degree/out_degree` is simplified.

Nathann

CC:  @jm58660

Branch/Commit: 0bcb1b78e32614db88ea00658caf986eff07a3f1

Reviewer: David Coudert

Author: Nathann Cohen

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17163





---

archive/issue_comments_289342.json:
```json
{
    "body": "Changing branch from \"\" to \"u/ncohen/17163\"",
    "created_at": "2014-10-16T06:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289342",
    "user": "https://github.com/nathanncohen"
}
```

Changing branch from "" to "u/ncohen/17163"



---

archive/issue_comments_289343.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-16T06:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289343",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_289344.json:
```json
{
    "body": "Changing commit from \"\" to \"303ad6cc6643b491f160b539c0750153a8158486\"",
    "created_at": "2014-10-16T06:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289344",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "303ad6cc6643b491f160b539c0750153a8158486"



---

archive/issue_comments_289345.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|\n|[303ad6c](http://git.sagemath.org/sage.git/commit/?id=303ad6cc6643b491f160b539c0750153a8158486)|`trac #17163: Speed improvement for DiGraph.in_degree`|",
    "created_at": "2014-10-16T06:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289345",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                      |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------|
|[303ad6c](http://git.sagemath.org/sage.git/commit/?id=303ad6cc6643b491f160b539c0750153a8158486)|`trac #17163: Speed improvement for DiGraph.in_degree`|



---

archive/issue_comments_289346.json:
```json
{
    "body": "<a id='comment:3'></a>\nSeems to work; now `top()` and `bottom()` on posets take same time. This also explains why timings with #13223 where little strange.\n\nUnfortunately I don't know enought Sage to be able to really review this.",
    "created_at": "2014-10-16T11:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289346",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:3'></a>
Seems to work; now `top()` and `bottom()` on posets take same time. This also explains why timings with #13223 where little strange.

Unfortunately I don't know enought Sage to be able to really review this.



---

archive/issue_comments_289347.json:
```json
{
    "body": "Changing reviewer from \"\" to \"David Coudert\"",
    "created_at": "2014-10-18T11:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289347",
    "user": "https://github.com/dcoudert"
}
```

Changing reviewer from "" to "David Coudert"



---

archive/issue_comments_289348.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe patch is working well. However, there are several places in `src/sage/graphs/base/c_graph.pyx` where you have such instruction (this one from your patch):\n\n```\ncdef v_int = get_vertex(v,\n                        self.vertex_ints,\n                        self.vertex_labels,\n                        self._cg)\n```\n\nShouldn't you specify the *int* type ?",
    "created_at": "2014-10-18T11:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289348",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:4'></a>
The patch is working well. However, there are several places in `src/sage/graphs/base/c_graph.pyx` where you have such instruction (this one from your patch):

```
cdef v_int = get_vertex(v,
                        self.vertex_ints,
                        self.vertex_labels,
                        self._cg)
```

Shouldn't you specify the *int* type ?



---

archive/issue_comments_289349.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[c51510f](http://git.sagemath.org/sage.git/commit/?id=c51510fbeecb33b084d983aeefc4169be972b824)|`trac #17163: Merged with beta6`|\n|[0bcb1b7](http://git.sagemath.org/sage.git/commit/?id=0bcb1b78e32614db88ea00658caf986eff07a3f1)|`trac #17163: missing 'int'`|",
    "created_at": "2014-10-18T11:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289349",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[c51510f](http://git.sagemath.org/sage.git/commit/?id=c51510fbeecb33b084d983aeefc4169be972b824)|`trac #17163: Merged with beta6`|
|[0bcb1b7](http://git.sagemath.org/sage.git/commit/?id=0bcb1b78e32614db88ea00658caf986eff07a3f1)|`trac #17163: missing 'int'`|



---

archive/issue_comments_289350.json:
```json
{
    "body": "Changing commit from \"303ad6cc6643b491f160b539c0750153a8158486\" to \"0bcb1b78e32614db88ea00658caf986eff07a3f1\"",
    "created_at": "2014-10-18T11:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289350",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "303ad6cc6643b491f160b539c0750153a8158486" to "0bcb1b78e32614db88ea00658caf986eff07a3f1"



---

archive/issue_comments_289351.json:
```json
{
    "body": "<a id='comment:6'></a>\n> Shouldn't you specify the *int* type ?\n\n\nIndeed. I just did, thanks.\n\nNathann",
    "created_at": "2014-10-18T11:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289351",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:6'></a>
> Shouldn't you specify the *int* type ?


Indeed. I just did, thanks.

Nathann



---

archive/issue_comments_289352.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-18T13:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289352",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_289353.json:
```json
{
    "body": "<a id='comment:7'></a>\nAll tests pass on `src/sage/graphs/`, so I give positive review.",
    "created_at": "2014-10-18T13:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289353",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>
All tests pass on `src/sage/graphs/`, so I give positive review.



---

archive/issue_comments_289354.json:
```json
{
    "body": "<a id='comment:8'></a>\nThanks !\n\nNathann",
    "created_at": "2014-10-18T13:30:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289354",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:8'></a>
Thanks !

Nathann



---

archive/issue_events_049774.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-18T18:19:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17163#event-49774"
}
```



---

archive/issue_comments_289355.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-18T18:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289355",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_289356.json:
```json
{
    "body": "Changing branch from \"u/ncohen/17163\" to \"0bcb1b78e32614db88ea00658caf986eff07a3f1\"",
    "created_at": "2014-10-18T18:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17163",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17163#issuecomment-289356",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/ncohen/17163" to "0bcb1b78e32614db88ea00658caf986eff07a3f1"
