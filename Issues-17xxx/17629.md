# Issue 17629: Handle FLINT exceptions gracefully

archive/issues_017392.json:
```json
{
    "body": "Sage crashes with \n\n```\nsage: (x^2222222222+1).polynomial(QQ)\n...\n#2  0x00007f46536d606d in sigdie()\n#3  0x00007f46536d575a in sage_signal_handler()\n#4  0x00007f46596f03e0 in __restore_rt()\n#5  0x00007f46590e70a0 in raise()\n#6  0x00007f465865c3a0 in abort()\n#7  0x00007f4645da4b40 in flint_memory_error()\n#8  0x00007f4645daa400 in flint_calloc()\n#9  0x00007f4645e00150 in fmpq_poly_realloc()\n#10 0x00007f4645e058a0 in fmpq_poly_fit_length()\n#11 0x00007f4645dff850 in fmpq_poly_set_coeff_si()\n#12 0x00007f463c1b6f30 in __pyx_pf_4sage_5rings_10polynomial_25polynomial_rational_flint_25Polynomial_rational_flint_58__pow__() at /home/ralf/sage/src/build/cythonized/sage/rings/polynomial/polynomial_rational_flint.cpp:10287\n  10282     *             if self._is_gen:\n  10283     *                 fmpq_poly_set_coeff_si(res.__poly, n, 1)             # <<<<<<<<<<<<<<\n  10284     *             else:\n  10285     *                 sig_on()\n  10286     */\n> 10287          fmpq_poly_set_coeff_si(__pyx_v_res->__pyx___poly, __pyx_v_n, 1);\n  10288          goto __pyx_L16;\n  10289        }\n  10290        /*else*/ {\n  10291    \n#13 0x00007f465933e270 in ternary_op()\n#14 0x00007f4659340520 in PyNumber_Power()\n#15 0x00007f46593e62b0 in arithmetic() at /home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py:1110\n  1105            if not any(repr(v) in self.varnames for v in ex.variables()):\n  1106                return self.base_ring(ex)\n  1107            elif operator == _operator.pow:\n  1108                from sage.rings.all import Integer\n  1109                base, exp = ex.operands()\n> 1110                return self(base)**Integer(exp)\n  1111            else:\n```\n\n**Keywords:** flint_memory_error\n\n**Branch/Commit:** [4835d4ba4448922208676100491a88126fd6db25](https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25)\n\n**Reviewer:** Ralf Stephan\n\n**Author:** Jeroen Demeyer\n\n**Dependencies:** #17668\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17629\n\n",
    "closed_at": "2015-02-17T20:50:37Z",
    "created_at": "2015-01-13T14:38:35Z",
    "labels": [
        "component: c_lib",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Handle FLINT exceptions gracefully",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17629",
    "user": "https://github.com/rwst"
}
```
Sage crashes with 

```
sage: (x^2222222222+1).polynomial(QQ)
...
#2  0x00007f46536d606d in sigdie()
#3  0x00007f46536d575a in sage_signal_handler()
#4  0x00007f46596f03e0 in __restore_rt()
#5  0x00007f46590e70a0 in raise()
#6  0x00007f465865c3a0 in abort()
#7  0x00007f4645da4b40 in flint_memory_error()
#8  0x00007f4645daa400 in flint_calloc()
#9  0x00007f4645e00150 in fmpq_poly_realloc()
#10 0x00007f4645e058a0 in fmpq_poly_fit_length()
#11 0x00007f4645dff850 in fmpq_poly_set_coeff_si()
#12 0x00007f463c1b6f30 in __pyx_pf_4sage_5rings_10polynomial_25polynomial_rational_flint_25Polynomial_rational_flint_58__pow__() at /home/ralf/sage/src/build/cythonized/sage/rings/polynomial/polynomial_rational_flint.cpp:10287
  10282     *             if self._is_gen:
  10283     *                 fmpq_poly_set_coeff_si(res.__poly, n, 1)             # <<<<<<<<<<<<<<
  10284     *             else:
  10285     *                 sig_on()
  10286     */
> 10287          fmpq_poly_set_coeff_si(__pyx_v_res->__pyx___poly, __pyx_v_n, 1);
  10288          goto __pyx_L16;
  10289        }
  10290        /*else*/ {
  10291    
#13 0x00007f465933e270 in ternary_op()
#14 0x00007f4659340520 in PyNumber_Power()
#15 0x00007f46593e62b0 in arithmetic() at /home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py:1110
  1105            if not any(repr(v) in self.varnames for v in ex.variables()):
  1106                return self.base_ring(ex)
  1107            elif operator == _operator.pow:
  1108                from sage.rings.all import Integer
  1109                base, exp = ex.operands()
> 1110                return self(base)**Integer(exp)
  1111            else:
```

**Keywords:** flint_memory_error

**Branch/Commit:** [4835d4ba4448922208676100491a88126fd6db25](https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25)

**Reviewer:** Ralf Stephan

**Author:** Jeroen Demeyer

**Dependencies:** #17668

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/17629





---

archive/attachments_020622.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "sage_crash_mG0GBp.log",
    "asset_url": "tarball://root/attachments/some-uuid/ticket17629/sage_crash_mG0GBp.log",
    "created_at": "2015-01-13T14:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.log",
    "user": "https://github.com/rwst"
}
```



---

archive/issue_comments_304844.json:
```json
{
    "body": "crash report",
    "created_at": "2015-01-13T14:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304844",
    "user": "https://github.com/rwst"
}
```

crash report



---

archive/issue_comments_304845.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -37,4 +37,4 @@\n > 1110                return self(base)**Integer(exp)\n   1111            else:\n   ```\n-Rather, it should throw `TypeError: denominator must be a unit` like it does with `polynomial(ZZ)`.\n+Rather, it should throw `TypeError: denominator must be a unit` like it does with `1/(1+x)`, or `OverflowError: value too large to convert to int` with `polynomial(ZZ)`.\n``````\n",
    "created_at": "2015-01-13T14:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304845",
    "user": "https://github.com/rwst"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -37,4 +37,4 @@
 > 1110                return self(base)**Integer(exp)
   1111            else:
   ```
-Rather, it should throw `TypeError: denominator must be a unit` like it does with `polynomial(ZZ)`.
+Rather, it should throw `TypeError: denominator must be a unit` like it does with `1/(1+x)`, or `OverflowError: value too large to convert to int` with `polynomial(ZZ)`.
``````




---

archive/issue_events_057440.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "rename": {
        "from": "crash with SR(fraction).polynomial(QQ)",
        "to": "FLINT crash with SR(fraction).polynomial(QQ)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17629#event-57440"
}
```



---

archive/issue_comments_304846.json:
```json
{
    "body": "<a id='comment:3'></a>\nHas nothing to do with fraction, crashes with only `x^2222222222+1` too. If this is memory, can we work around with sparse polynomials, at least give the user the option?",
    "created_at": "2015-01-25T17:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304846",
    "user": "https://github.com/rwst"
}
```

<a id='comment:3'></a>
Has nothing to do with fraction, crashes with only `x^2222222222+1` too. If this is memory, can we work around with sparse polynomials, at least give the user the option?



---

archive/issue_comments_304847.json:
```json
{
    "body": "**Changing keywords** from \"conversion\" to \"conversion, sparse, dense\".",
    "created_at": "2015-01-25T17:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304847",
    "user": "https://github.com/rwst"
}
```

**Changing keywords** from "conversion" to "conversion, sparse, dense".



---

archive/issue_events_057441.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "rename": {
        "from": "FLINT crash with SR(fraction).polynomial(QQ)",
        "to": "FLINT crash with expression.polynomial()"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17629#event-57441"
}
```



---

archive/issue_comments_304848.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n Sage crashes with \n \n ```\n-sage: ((x^2222222222+1)/(x+1))\n-(x^2222222222 + 1)/(x + 1)\n+sage: x^2222222222+1\n+x^2222222222 + 1\n sage: _.polynomial(QQ)\n ...\n #2  0x00007f46536d606d in sigdie()\n@@ -37,4 +37,5 @@\n > 1110                return self(base)**Integer(exp)\n   1111            else:\n   ```\n-Rather, it should throw `TypeError: denominator must be a unit` like it does with `1/(1+x)`, or `OverflowError: value too large to convert to int` with `polynomial(ZZ)`.\n+\n+If this is memory and no FLINT solution is possible, give user the option to create sparse polynomials. \n``````\n",
    "created_at": "2015-01-25T17:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304848",
    "user": "https://github.com/rwst"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,8 +1,8 @@
 Sage crashes with 
 
 ```
-sage: ((x^2222222222+1)/(x+1))
-(x^2222222222 + 1)/(x + 1)
+sage: x^2222222222+1
+x^2222222222 + 1
 sage: _.polynomial(QQ)
 ...
 #2  0x00007f46536d606d in sigdie()
@@ -37,4 +37,5 @@
 > 1110                return self(base)**Integer(exp)
   1111            else:
   ```
-Rather, it should throw `TypeError: denominator must be a unit` like it does with `1/(1+x)`, or `OverflowError: value too large to convert to int` with `polynomial(ZZ)`.
+
+If this is memory and no FLINT solution is possible, give user the option to create sparse polynomials. 
``````




---

archive/issue_comments_304849.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -36,6 +36,4 @@\n   1109                base, exp = ex.operands()\n > 1110                return self(base)**Integer(exp)\n   1111            else:\n-  ```\n-\n-If this is memory and no FLINT solution is possible, give user the option to create sparse polynomials. \n+```\n``````\n",
    "created_at": "2015-02-13T20:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304849",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -36,6 +36,4 @@
   1109                base, exp = ex.operands()
 > 1110                return self(base)**Integer(exp)
   1111            else:
-  ```
-
-If this is memory and no FLINT solution is possible, give user the option to create sparse polynomials. 
+```
``````




---

archive/issue_comments_304850.json:
```json
{
    "body": "<a id='comment:4'></a>\nSparse polynomials should be a different ticket.",
    "created_at": "2015-02-13T20:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304850",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Sparse polynomials should be a different ticket.



---

archive/issue_comments_304851.json:
```json
{
    "body": "**Changing keywords** from \"conversion, sparse, dense\" to \"flint_memory_error\".",
    "created_at": "2015-02-13T20:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304851",
    "user": "https://github.com/jdemeyer"
}
```

**Changing keywords** from "conversion, sparse, dense" to "flint_memory_error".



---

archive/issue_comments_304852.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [jdemeyer](#comment%3A4):\n> Sparse polynomials should be a different ticket.\n\nSee #17782 (EDIT)",
    "created_at": "2015-02-14T07:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304852",
    "user": "https://github.com/rwst"
}
```

<a id='comment:5'></a>
Replying to [jdemeyer](#comment%3A4):
> Sparse polynomials should be a different ticket.

See #17782 (EDIT)



---

archive/issue_events_057442.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "rename": {
        "from": "FLINT crash with expression.polynomial()",
        "to": "Handle FLINT exceptions gracefully"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17629#event-57442"
}
```



---

archive/issue_comments_304853.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2015-02-14T10:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304853",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_304854.json:
```json
{
    "body": "**Dependencies:** #17668",
    "created_at": "2015-02-14T10:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304854",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #17668



---

archive/issue_comments_304855.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,9 +1,7 @@\n Sage crashes with \n \n ```\n-sage: x^2222222222+1\n-x^2222222222 + 1\n-sage: _.polynomial(QQ)\n+sage: (x^2222222222+1).polynomial(QQ)\n ...\n #2  0x00007f46536d606d in sigdie()\n #3  0x00007f46536d575a in sage_signal_handler()\n``````\n",
    "created_at": "2015-02-14T10:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304855",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,9 +1,7 @@
 Sage crashes with 
 
 ```
-sage: x^2222222222+1
-x^2222222222 + 1
-sage: _.polynomial(QQ)
+sage: (x^2222222222+1).polynomial(QQ)
 ...
 #2  0x00007f46536d606d in sigdie()
 #3  0x00007f46536d575a in sage_signal_handler()
``````




---

archive/issue_comments_304856.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/ticket/17629](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17629)",
    "created_at": "2015-02-14T13:01:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304856",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/ticket/17629](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17629)



---

archive/issue_comments_304857.json:
```json
{
    "body": "**Commit:** [4835d4ba4448922208676100491a88126fd6db25](https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25)",
    "created_at": "2015-02-14T13:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304857",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [4835d4ba4448922208676100491a88126fd6db25](https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25)



---

archive/issue_comments_304858.json:
```json
{
    "body": "<a id='comment:8'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/47217bc771195d933edb8aa1b89614e1219c4a82\">47217bc</a></td><td><code>Replace PY_NEW and PY_NEW_SAME_TYPE by Cython code</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25\">4835d4b</a></td><td><code>Handle FLINT exceptions gracefully</code></td></tr></table>\n",
    "created_at": "2015-02-14T13:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304858",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/47217bc771195d933edb8aa1b89614e1219c4a82">47217bc</a></td><td><code>Replace PY_NEW and PY_NEW_SAME_TYPE by Cython code</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25">4835d4b</a></td><td><code>Handle FLINT exceptions gracefully</code></td></tr></table>




---

archive/issue_comments_304859.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2015-02-14T13:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304859",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_304860.json:
```json
{
    "body": "**Reviewer:** Ralf Stephan",
    "created_at": "2015-02-17T15:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304860",
    "user": "https://github.com/rwst"
}
```

**Reviewer:** Ralf Stephan



---

archive/issue_comments_304861.json:
```json
{
    "body": "<a id='comment:9'></a>\nExcept for cosmetics this practically replaces `sig_on` with `sig_str(...)` in FLINT code and adds an exception for 0<sup>(-1)</sup>. It also passes `make ptestlong`.  So, depending on the review for #17668 this is fine.",
    "created_at": "2015-02-17T15:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304861",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>
Except for cosmetics this practically replaces `sig_on` with `sig_str(...)` in FLINT code and adds an exception for 0<sup>(-1)</sup>. It also passes `make ptestlong`.  So, depending on the review for #17668 this is fine.



---

archive/issue_comments_304862.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2015-02-17T15:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304862",
    "user": "https://github.com/rwst"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_057443.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-17T20:50:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17629#event-57443"
}
```



---

archive/issue_comments_304863.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/ticket/17629](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17629)\" to \"[4835d4ba4448922208676100491a88126fd6db25](https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25)\".",
    "created_at": "2015-02-17T20:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304863",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/ticket/17629](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17629)" to "[4835d4ba4448922208676100491a88126fd6db25](https://github.com/sagemath/sagetrac-mirror/commit/4835d4ba4448922208676100491a88126fd6db25)".



---

archive/issue_comments_304864.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2015-02-17T20:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17629",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17629#issuecomment-304864",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed
