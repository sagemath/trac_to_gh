# Issue 17808: Preparse old-style octals as strings

archive/issues_017571.json:
```json
{
    "body": "To solve #17807, we preparse `0100` as `Integer('0100')` instead of `Integer(0100)`: thanks to #17413, this will give a deprecation warning so that users should know something funny is going on:\n\n```\nsage: 0100\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2883: DeprecationWarning: use 0o as octal prefix instead of 0\nIf you do not want this number to be interpreted as octal, remove the leading zeros.\nSee http://trac.sagemath.org/17413 for details.\n  exec(code_obj, self.user_global_ns, self.user_ns)\n64\n```\n\nWe also preparse new-style binary/octal/hex strings as integers instead of strings, which should be faster, see [comment:5].\n\nIssue created by migration from https://trac.sagemath.org/ticket/17808\n\n",
    "closed_at": "2016-05-31T07:29:46Z",
    "created_at": "2015-02-19T08:31:31Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Preparse old-style octals as strings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17808",
    "user": "https://github.com/jdemeyer"
}
```
To solve #17807, we preparse `0100` as `Integer('0100')` instead of `Integer(0100)`: thanks to #17413, this will give a deprecation warning so that users should know something funny is going on:

```
sage: 0100
/usr/local/src/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2883: DeprecationWarning: use 0o as octal prefix instead of 0
If you do not want this number to be interpreted as octal, remove the leading zeros.
See http://trac.sagemath.org/17413 for details.
  exec(code_obj, self.user_global_ns, self.user_ns)
64
```

We also preparse new-style binary/octal/hex strings as integers instead of strings, which should be faster, see [comment:5].

Issue created by migration from https://trac.sagemath.org/ticket/17808





---

archive/issue_comments_234230.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-21T20:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234230",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_234231.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-02-21T20:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234231",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_234232.json:
```json
{
    "body": "I would think the slow-down for small integers makes the proposed changes very unattractive. The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one, and hence conversion is much faster.\n\nFor instance, in code like:\n\n```\nsage: %timeit L=[Integer('1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') for i in range(10000r)]\n100 loops, best of 3: 11.4 ms per loop\nsage: %timeit L=[Integer(1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) for i in range(10000r)]\n100 loops, best of 3: 4.66 ms per loop\n```\nyou really start to notice this.\n\npreparse_file mitigates issues like this a little bit by factoring out numeric constants, so that their conversion doesn't happen in inner loops.\n\nIf you want to store your numerical constants as strings in the byte code and have fast conversion, you should probably store them in hex. It's a little more work in the preparser, but the result is more compact and conversion to a numerical constant is truly linear in number of bits.",
    "created_at": "2015-02-22T08:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234232",
    "user": "https://github.com/nbruin"
}
```

I would think the slow-down for small integers makes the proposed changes very unattractive. The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one, and hence conversion is much faster.

For instance, in code like:

```
sage: %timeit L=[Integer('1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000') for i in range(10000r)]
100 loops, best of 3: 11.4 ms per loop
sage: %timeit L=[Integer(1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) for i in range(10000r)]
100 loops, best of 3: 4.66 ms per loop
```
you really start to notice this.

preparse_file mitigates issues like this a little bit by factoring out numeric constants, so that their conversion doesn't happen in inner loops.

If you want to store your numerical constants as strings in the byte code and have fast conversion, you should probably store them in hex. It's a little more work in the preparser, but the result is more compact and conversion to a numerical constant is truly linear in number of bits.



---

archive/issue_comments_234233.json:
```json
{
    "body": "Replying to [comment:5 nbruin]:\n> The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one\n\nIs that really important? The \"timeit\" example is of course a bit artificial.",
    "created_at": "2015-02-22T09:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234233",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 nbruin]:
> The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one

Is that really important? The "timeit" example is of course a bit artificial.



---

archive/issue_comments_234234.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Replying to [comment:5 nbruin]:\n> > The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one\n\n> Is that really important? The \"timeit\" example is of course a bit artificial.\n\nI think so. Storing the numerical constant as a string forces the decimal-to-binary conversion to happen at runtime. If you just write it as a python integer, the conversion happens at parsing, so by the time it's an ast and the compiler looks at it, you're already dealing with an integer. \n\nUnfortunately, python doesn't permit compile-time macros (perhaps if we're ever going to rewrite our preparser to properly parse, we can combine it with [MacroPy](https://pypi.python.org/pypi/MacroPy) and then we can have `Integer` object creation at compile time)\n\nI am fairly certain that nearly all code that gets run with sage has TONS of small integer literals in it. Probably for many applications, people would get better performance writing `100r`, but of course nobody will. This ticket would deteriorate the much more common situation in favour of a small gain in the extremely rare situation that someone wants to include an incredibly large integer literal in their code (talk about artificial--I don't think having a (small) numerical literal in an inner loop is artificial at all!). And the extremely rare situation can be solved by writing quotes already (and by the time you're writing such a long string you might as well convert it to hex anyway, in which case Python and GMP are (at least asymptotically) comparable.\n\nIf you use `preparse_file` instead of `preparse`, you'll see that numerical constants get pushed outside (which has its own set of problems, see #11542), which mitigates the string-conversion-in-inner-loop.",
    "created_at": "2015-02-22T18:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234234",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 nbruin]:
> > The whole idea of preparsing `100` as `Integer(100)` is that in the AST and the generated byte code, the constant `100` is already stored as a numerical one

> Is that really important? The "timeit" example is of course a bit artificial.

I think so. Storing the numerical constant as a string forces the decimal-to-binary conversion to happen at runtime. If you just write it as a python integer, the conversion happens at parsing, so by the time it's an ast and the compiler looks at it, you're already dealing with an integer. 

Unfortunately, python doesn't permit compile-time macros (perhaps if we're ever going to rewrite our preparser to properly parse, we can combine it with [MacroPy](https://pypi.python.org/pypi/MacroPy) and then we can have `Integer` object creation at compile time)

I am fairly certain that nearly all code that gets run with sage has TONS of small integer literals in it. Probably for many applications, people would get better performance writing `100r`, but of course nobody will. This ticket would deteriorate the much more common situation in favour of a small gain in the extremely rare situation that someone wants to include an incredibly large integer literal in their code (talk about artificial--I don't think having a (small) numerical literal in an inner loop is artificial at all!). And the extremely rare situation can be solved by writing quotes already (and by the time you're writing such a long string you might as well convert it to hex anyway, in which case Python and GMP are (at least asymptotically) comparable.

If you use `preparse_file` instead of `preparse`, you'll see that numerical constants get pushed outside (which has its own set of problems, see #11542), which mitigates the string-conversion-in-inner-loop.



---

archive/issue_comments_234235.json:
```json
{
    "body": "Fine, you convinced me.",
    "created_at": "2015-02-22T19:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234235",
    "user": "https://github.com/jdemeyer"
}
```

Fine, you convinced me.



---

archive/issue_comments_234236.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-22T19:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234236",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_234237.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-02-24T14:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234237",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_234238.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-24T15:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234238",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_050846.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-04-19T08:07:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17808#event-50846"
}
```



---

archive/issue_comments_234239.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-19T08:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234239",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_234240.json:
```json
{
    "body": "Changing component from misc to python3.",
    "created_at": "2016-05-02T13:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234240",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from misc to python3.



---

archive/issue_comments_234241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-02T15:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234241",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_050847.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-05-02T15:25:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17808#event-50847"
}
```



---

archive/issue_events_050848.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-05-02T15:25:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "milestone": "sage-7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17808#event-50848"
}
```



---

archive/issue_events_050849.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-05-29T18:27:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "milestone": "sage-7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17808#event-50849"
}
```



---

archive/issue_events_050850.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2016-05-29T18:27:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17808#event-50850"
}
```



---

archive/issue_comments_234242.json:
```json
{
    "body": "is the title still acurately describing the content of the ticket ?",
    "created_at": "2016-05-29T18:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234242",
    "user": "https://github.com/fchapoton"
}
```

is the title still acurately describing the content of the ticket ?



---

archive/issue_comments_234243.json:
```json
{
    "body": "Replying to [comment:17 chapoton]:\n> is the title still acurately describing the content of the ticket ?\n\n\nYes.",
    "created_at": "2016-05-29T19:12:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234243",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 chapoton]:
> is the title still acurately describing the content of the ticket ?


Yes.



---

archive/issue_comments_234244.json:
```json
{
    "body": "Although the ticket does change a little bit more than that, I added a sentence to the description.",
    "created_at": "2016-05-29T19:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234244",
    "user": "https://github.com/jdemeyer"
}
```

Although the ticket does change a little bit more than that, I added a sentence to the description.



---

archive/issue_comments_234245.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-29T19:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234245",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_234246.json:
```json
{
    "body": "ok, looks good to me",
    "created_at": "2016-05-29T19:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234246",
    "user": "https://github.com/fchapoton"
}
```

ok, looks good to me



---

archive/issue_comments_234247.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-31T07:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17808#issuecomment-234247",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_050851.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-31T07:29:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17808",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17808#event-50851"
}
```
