# Issue 17394: TypeError in Expression.simplify_hypergeometric()

archive/issues_017157.json:
```json
{
    "body": "When calling `simplify_hypergeometric()` on an expression with two variables, sometimes a `TypeError` is thrown:\n\n```\nsage: y = SR.symbol('y')\nsage: f = x*y + x + y\nsage: f.simplify_hypergeometric()\n```\n\nproduces,\n\n```\nTypeError                                 Traceback (most recent call last)\n<ipython-input-4-9e70db185ac4> in <module>()\n----> 1 f.simplify_hypergeometric()\n\n/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.simplify_hypergeometric (build/cythonized/sage/symbolic/expression.cpp:40840)()\n\nTypeError: op_add expected 2 arguments, got 3\n```\n\n\nCC:  @rwst\n\nBranch/Commit: c16d36f8c9b09bd467d209345df0c965dec5cf0a\n\nReviewer: Ralf Stephan\n\nAuthor: Nils Bruin\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17394\n\n",
    "closed_at": "2015-05-09T23:03:15Z",
    "created_at": "2014-11-25T14:42:19Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "TypeError in Expression.simplify_hypergeometric()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17394",
    "user": "https://github.com/orlitzky"
}
```
When calling `simplify_hypergeometric()` on an expression with two variables, sometimes a `TypeError` is thrown:

```
sage: y = SR.symbol('y')
sage: f = x*y + x + y
sage: f.simplify_hypergeometric()
```

produces,

```
TypeError                                 Traceback (most recent call last)
<ipython-input-4-9e70db185ac4> in <module>()
----> 1 f.simplify_hypergeometric()

/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.simplify_hypergeometric (build/cythonized/sage/symbolic/expression.cpp:40840)()

TypeError: op_add expected 2 arguments, got 3
```


CC:  @rwst

Branch/Commit: c16d36f8c9b09bd467d209345df0c965dec5cf0a

Reviewer: Ralf Stephan

Author: Nils Bruin

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17394





---

archive/issue_comments_299320.json:
```json
{
    "body": "<a id='comment:1'></a>\nIt's simply this:\n\n```\nsage: A=SR(x+y+x*y)\nsage: A.operator()(*A.operands())\nTypeError: op_add expected 2 arguments, got 3\nsage: A.operator()\nsage: A.operator()\n<built-in function add>\n```\nWe should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.\n\nOther point:\n\n```\nop(*map(lambda o: o.simplify_hypergeometric(algorithm), ops))\n```\nis both more compactly and more efficiently expressed in python by\n\n```\nop(*(o.simplify_hypergeometric(algorithm) for o in ops))\n```\nCompare:\n\n```\nsage: def l(*args):\n....:         return list(args)\n....: \nsage: %timeit l( *[a.bit_length() for a in xrange(100)] )\n100000 loops, best of 3: 10.2 \u00b5s per loop\nsage: %timeit l( *(a.bit_length() for a in xrange(100)) )\n100000 loops, best of 3: 12.9 \u00b5s per loop\nsage: %timeit l( *map(lambda a: a.bit_length(), xrange(100)) )\n10000 loops, best of 3: 17.9 \u00b5s per loop\n```\n\nBasically: don't use \"map\" in python unless it's considerably more convenient than the corresponding list comprehension.",
    "created_at": "2014-11-25T20:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299320",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:1'></a>
It's simply this:

```
sage: A=SR(x+y+x*y)
sage: A.operator()(*A.operands())
TypeError: op_add expected 2 arguments, got 3
sage: A.operator()
sage: A.operator()
<built-in function add>
```
We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.

Other point:

```
op(*map(lambda o: o.simplify_hypergeometric(algorithm), ops))
```
is both more compactly and more efficiently expressed in python by

```
op(*(o.simplify_hypergeometric(algorithm) for o in ops))
```
Compare:

```
sage: def l(*args):
....:         return list(args)
....: 
sage: %timeit l( *[a.bit_length() for a in xrange(100)] )
100000 loops, best of 3: 10.2 µs per loop
sage: %timeit l( *(a.bit_length() for a in xrange(100)) )
100000 loops, best of 3: 12.9 µs per loop
sage: %timeit l( *map(lambda a: a.bit_length(), xrange(100)) )
10000 loops, best of 3: 17.9 µs per loop
```

Basically: don't use "map" in python unless it's considerably more convenient than the corresponding list comprehension.



---

archive/issue_comments_299321.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [nbruin](#comment%3A1):\n> We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.\n\n\nNo, it's all in `Expression::operator()`:\n\n```\n        import operator\n        if is_a_add(self._gobj):\n            return operator.add",
    "created_at": "2015-05-08T06:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299321",
    "user": "https://github.com/rwst"
}
```

<a id='comment:3'></a>
Replying to [nbruin](#comment%3A1):
> We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.


No, it's all in `Expression::operator()`:

```
        import operator
        if is_a_add(self._gobj):
            return operator.add



---

archive/issue_comments_299322.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [rws](#comment%3A3):\n> Replying to [nbruin](#comment%3A1):\n> > It's probably a change that would need to be made in pynac somewhere.\n\n> No, it's all in `Expression::operator()`:\nI don't understand the comment. Do you mean \"no, that line of code is not in pynac\" or do you mean \"no we cannot/won't make that change\" or something else?\n\nIt seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.",
    "created_at": "2015-05-08T15:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299322",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>
Replying to [rws](#comment%3A3):
> Replying to [nbruin](#comment%3A1):
> > It's probably a change that would need to be made in pynac somewhere.

> No, it's all in `Expression::operator()`:
I don't understand the comment. Do you mean "no, that line of code is not in pynac" or do you mean "no we cannot/won't make that change" or something else?

It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.



---

archive/issue_comments_299323.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [nbruin](#comment%3A4):\n> Replying to [rws](#comment%3A3):\n> > Replying to [nbruin](#comment%3A1):\n> > > It's probably a change that would need to be made in pynac somewhere.\n\n> > No, it's all in `Expression::operator()`:\n> I don't understand the comment. Do you mean \"no, that line of code is not in pynac\" or do you mean \"no we cannot/won't make that change\" or something else?\n> \n> It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.\n\n\n**edit:** ah, I see. You mean `sage.symbolic.expression.Expression.operator`. The double colon made me think it was `C++` (and `search_src` doesn't give a hit either, so I was assuming the line appeared in external code). So we can just fix this!",
    "created_at": "2015-05-08T18:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299323",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'></a>
Replying to [nbruin](#comment%3A4):
> Replying to [rws](#comment%3A3):
> > Replying to [nbruin](#comment%3A1):
> > > It's probably a change that would need to be made in pynac somewhere.

> > No, it's all in `Expression::operator()`:
> I don't understand the comment. Do you mean "no, that line of code is not in pynac" or do you mean "no we cannot/won't make that change" or something else?
> 
> It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.


**edit:** ah, I see. You mean `sage.symbolic.expression.Expression.operator`. The double colon made me think it was `C++` (and `search_src` doesn't give a hit either, so I was assuming the line appeared in external code). So we can just fix this!



---

archive/issue_comments_299324.json:
```json
{
    "body": "Changing branch from \"\" to \"u/nbruin/typeerror_in_expression_simplify_hypergeometric__\"",
    "created_at": "2015-05-08T19:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299324",
    "user": "https://github.com/nbruin"
}
```

Changing branch from "" to "u/nbruin/typeerror_in_expression_simplify_hypergeometric__"



---

archive/issue_comments_299325.json:
```json
{
    "body": "Changing commit from \"\" to \"6a3cb27234c22f76062ebc9c7d4ecff6fbb1578a\"",
    "created_at": "2015-05-08T19:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299325",
    "user": "https://github.com/nbruin"
}
```

Changing commit from "" to "6a3cb27234c22f76062ebc9c7d4ecff6fbb1578a"



---

archive/issue_comments_299326.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-08T19:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299326",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_299327.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis should do the trick",
    "created_at": "2015-05-08T19:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299327",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>
This should do the trick



---

archive/issue_comments_299328.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|\n|[e7881fe](https://github.com/sagemath/sagetrac-mirror/commit/e7881fec5314b95497a27587e865fa93b939a12e)|`17394: make sure that `(x+y+z).operator()` returns a function that accepts multiple arguments (and same for multiplication)`|",
    "created_at": "2015-05-08T19:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299328",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
|[e7881fe](https://github.com/sagemath/sagetrac-mirror/commit/e7881fec5314b95497a27587e865fa93b939a12e)|`17394: make sure that `(x+y+z).operator()` returns a function that accepts multiple arguments (and same for multiplication)`|



---

archive/issue_comments_299329.json:
```json
{
    "body": "Changing commit from \"6a3cb27234c22f76062ebc9c7d4ecff6fbb1578a\" to \"e7881fec5314b95497a27587e865fa93b939a12e\"",
    "created_at": "2015-05-08T19:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299329",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6a3cb27234c22f76062ebc9c7d4ecff6fbb1578a" to "e7881fec5314b95497a27587e865fa93b939a12e"



---

archive/issue_comments_299330.json:
```json
{
    "body": "Changing author from \"\" to \"Nils Bruin\"",
    "created_at": "2015-05-08T19:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299330",
    "user": "https://github.com/nbruin"
}
```

Changing author from "" to "Nils Bruin"



---

archive/issue_comments_299331.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                                          |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------|\n|[08349c6](https://github.com/sagemath/sagetrac-mirror/commit/08349c6520dae6fa631728fdadecec81e45a62a5)|`17394: doctest that add_vararg and mul_vararg get used by <symbolic-expression>.operator`|",
    "created_at": "2015-05-08T21:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299331",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------|
|[08349c6](https://github.com/sagemath/sagetrac-mirror/commit/08349c6520dae6fa631728fdadecec81e45a62a5)|`17394: doctest that add_vararg and mul_vararg get used by <symbolic-expression>.operator`|



---

archive/issue_comments_299332.json:
```json
{
    "body": "Changing commit from \"e7881fec5314b95497a27587e865fa93b939a12e\" to \"08349c6520dae6fa631728fdadecec81e45a62a5\"",
    "created_at": "2015-05-08T21:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299332",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e7881fec5314b95497a27587e865fa93b939a12e" to "08349c6520dae6fa631728fdadecec81e45a62a5"



---

archive/issue_events_056981.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-09T06:46:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17394#event-56981"
}
```



---

archive/issue_comments_299333.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Ralf Stephan\"",
    "created_at": "2015-05-09T06:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299333",
    "user": "https://github.com/rwst"
}
```

Changing reviewer from "" to "Ralf Stephan"



---

archive/issue_comments_299334.json:
```json
{
    "body": "<a id='comment:11'></a>\nLooks okay. Patchbot has doctest failures in `combinat/finite_state_machine_generators.py` however.",
    "created_at": "2015-05-09T06:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299334",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>
Looks okay. Patchbot has doctest failures in `combinat/finite_state_machine_generators.py` however.



---

archive/issue_comments_299335.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-09T06:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299335",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299336.json:
```json
{
    "body": "Changing commit from \"08349c6520dae6fa631728fdadecec81e45a62a5\" to \"c16d36f8c9b09bd467d209345df0c965dec5cf0a\"",
    "created_at": "2015-05-09T07:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299336",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "08349c6520dae6fa631728fdadecec81e45a62a5" to "c16d36f8c9b09bd467d209345df0c965dec5cf0a"



---

archive/issue_comments_299337.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|\n|[c16d36f](https://github.com/sagemath/sagetrac-mirror/commit/c16d36f8c9b09bd467d209345df0c965dec5cf0a)|`17394: fixes to finite_state_machine_generators`|",
    "created_at": "2015-05-09T07:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299337",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
|[c16d36f](https://github.com/sagemath/sagetrac-mirror/commit/c16d36f8c9b09bd467d209345df0c965dec5cf0a)|`17394: fixes to finite_state_machine_generators`|



---

archive/issue_comments_299338.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-09T07:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299338",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299339.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-09T07:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299339",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_299340.json:
```json
{
    "body": "<a id='comment:14'></a>\nIs fine now, thanks.",
    "created_at": "2015-05-09T07:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299340",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>
Is fine now, thanks.



---

archive/issue_comments_299341.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-09T23:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299341",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_299342.json:
```json
{
    "body": "Changing branch from \"u/nbruin/typeerror_in_expression_simplify_hypergeometric__\" to \"c16d36f8c9b09bd467d209345df0c965dec5cf0a\"",
    "created_at": "2015-05-09T23:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17394#issuecomment-299342",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/nbruin/typeerror_in_expression_simplify_hypergeometric__" to "c16d36f8c9b09bd467d209345df0c965dec5cf0a"



---

archive/issue_events_056982.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-09T23:03:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17394",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17394#event-56982"
}
```
