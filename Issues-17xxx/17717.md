# Issue 17717: Failure to reduce int modulo large prime

archive/issues_017480.json:
```json
{
    "body": "```\nsage: p = next_prime(2^32)\nsage: p\n4294967311\nsage: GF(p)(int(p+1))\n4294967312\nsage: GF(p)(p+1)\n1\n```\n\nThe issue arises in \nsage/rings/finite_rings/integer_mod.pyx\n\nclass method\nIntegerMod_gmp.set_from_long\n\nOn line 1732, the code reduces value (mod modulus) when value < 0 or ( value < modulus ). The latter condition is backward. It should be replaced with ( modulus < value). \n\nReplace line 1732\n        `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) >= 0:`\nwith\n        `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) <= 0:`\n\n\n\nKeywords: modular arithmetic\n\nBranch/Commit: a50d79df6cb35e20d3061fa4c817afe92f330b67\n\nReviewer: Travis Scrimshaw\n\nAuthor: Xander Faber\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17717\n\n",
    "closed_at": "2015-02-18T23:22:40Z",
    "created_at": "2015-02-03T02:06:47Z",
    "labels": [
        "component: finite rings",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Failure to reduce int modulo large prime",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17717",
    "user": "https://trac.sagemath.org/admin/accounts/users/xander.faber"
}
```
```
sage: p = next_prime(2^32)
sage: p
4294967311
sage: GF(p)(int(p+1))
4294967312
sage: GF(p)(p+1)
1
```

The issue arises in 
sage/rings/finite_rings/integer_mod.pyx

class method
IntegerMod_gmp.set_from_long

On line 1732, the code reduces value (mod modulus) when value < 0 or ( value < modulus ). The latter condition is backward. It should be replaced with ( modulus < value). 

Replace line 1732
        `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) >= 0:`
with
        `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) <= 0:`



Keywords: modular arithmetic

Branch/Commit: a50d79df6cb35e20d3061fa4c817afe92f330b67

Reviewer: Travis Scrimshaw

Author: Xander Faber

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17717





---

archive/issue_comments_303452.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -19,7 +19,9 @@\n Replace line 1732\n         `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) >= 0:`\n with\n-        `if value < 0 or mpz_cmp_si(value, self.__modulus.sageInteger.value) >= 0:`\n+        `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) <= 0:`\n+\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2015-02-10T01:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303452",
    "user": "https://trac.sagemath.org/admin/accounts/users/xander.faber"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -19,7 +19,9 @@
 Replace line 1732
         `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) >= 0:`
 with
-        `if value < 0 or mpz_cmp_si(value, self.__modulus.sageInteger.value) >= 0:`
+        `if value < 0 or mpz_cmp_si(self.__modulus.sageInteger.value, value) <= 0:`
+
+
 
 Comment: 1
 
``````




---

archive/issue_comments_303453.json:
```json
{
    "body": "Changing author from \"\" to \"Xander Faber\"",
    "created_at": "2015-02-10T01:23:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303453",
    "user": "https://trac.sagemath.org/admin/accounts/users/xander.faber"
}
```

Changing author from "" to "Xander Faber"



---

archive/issue_comments_303454.json:
```json
{
    "body": "Changing branch from \"\" to \"u/xander.faber/integer_mod_fix\"",
    "created_at": "2015-02-10T01:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303454",
    "user": "https://trac.sagemath.org/admin/accounts/users/xander.faber"
}
```

Changing branch from "" to "u/xander.faber/integer_mod_fix"



---

archive/issue_comments_303455.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-10T01:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303455",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_303456.json:
```json
{
    "body": "Changing commit from \"\" to \"216a263607d80e0f399c6832df4943757026b6bd\"",
    "created_at": "2015-02-10T01:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303456",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "216a263607d80e0f399c6832df4943757026b6bd"



---

archive/issue_comments_303457.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-10T01:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303457",
    "user": "https://trac.sagemath.org/admin/accounts/users/xander.faber"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_303458.json:
```json
{
    "body": "<a id='comment:6'></a>Yes, those are indeed the other way around. I think the more consistent solution (at least with `set_from_mpz` above it) is\n\n```python\nif value < 0 or mpz_cmp_si(value, self.__modulus.sageInteger.value) >= 0\n```\nand then if you could also add a doctest to that method\n\n```\n\"\"\"\nEXAMPLES::\n\n    sage: p = next_prime(2^32)\n    sage: GF(p)(int(p+1))\n    1\n\"\"\"\n```\nThanks.",
    "created_at": "2015-02-10T08:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303458",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>Yes, those are indeed the other way around. I think the more consistent solution (at least with `set_from_mpz` above it) is

```python
if value < 0 or mpz_cmp_si(value, self.__modulus.sageInteger.value) >= 0
```
and then if you could also add a doctest to that method

```
"""
EXAMPLES::

    sage: p = next_prime(2^32)
    sage: GF(p)(int(p+1))
    1
"""
```
Thanks.



---

archive/issue_comments_303459.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-12T01:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303459",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_303460.json:
```json
{
    "body": "Changing commit from \"216a263607d80e0f399c6832df4943757026b6bd\" to \"c962120feca71975f1cb72f9d095058a2f854c3a\"",
    "created_at": "2015-02-12T01:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303460",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "216a263607d80e0f399c6832df4943757026b6bd" to "c962120feca71975f1cb72f9d095058a2f854c3a"



---

archive/issue_comments_303461.json:
```json
{
    "body": "<a id='comment:8'></a>tscrim - The fix you suggest has the wrong syntax for gmp. The mpz_t must be the first argument. \n\nDoctest added\n\n---\nNew commits:\n|                                                                                                                                          |               |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------|\n|[c962120](http://git.sagemath.org/sage.git/commit/?id=c962120feca71975f1cb72f9d095058a2f854c3a)|`Doctest added`|\n---\nNew commits:",
    "created_at": "2015-02-12T01:23:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303461",
    "user": "https://trac.sagemath.org/admin/accounts/users/xander.faber"
}
```

<a id='comment:8'></a>tscrim - The fix you suggest has the wrong syntax for gmp. The mpz_t must be the first argument. 

Doctest added

---
New commits:
|                                                                                                                                          |               |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------|
|[c962120](http://git.sagemath.org/sage.git/commit/?id=c962120feca71975f1cb72f9d095058a2f854c3a)|`Doctest added`|
---
New commits:



---

archive/issue_comments_303462.json:
```json
{
    "body": "<a id='comment:9'></a>Ah, I see, it's a different function. You need to indent the code within the `EXAMPLES::` block one more, and once you do that, you can set a positive review on my behalf. Thanks.",
    "created_at": "2015-02-12T05:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303462",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Ah, I see, it's a different function. You need to indent the code within the `EXAMPLES::` block one more, and once you do that, you can set a positive review on my behalf. Thanks.



---

archive/issue_comments_303463.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2015-02-12T05:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303463",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_303464.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-12T09:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303464",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_303465.json:
```json
{
    "body": "Changing commit from \"c962120feca71975f1cb72f9d095058a2f854c3a\" to \"a50d79df6cb35e20d3061fa4c817afe92f330b67\"",
    "created_at": "2015-02-12T11:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303465",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c962120feca71975f1cb72f9d095058a2f854c3a" to "a50d79df6cb35e20d3061fa4c817afe92f330b67"



---

archive/issue_comments_303466.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-12T11:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303466",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_303467.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-02-12T11:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303467",
    "user": "https://trac.sagemath.org/admin/accounts/users/xander.faber"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_050691.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-18T23:22:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17717#event-50691"
}
```



---

archive/issue_comments_303468.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-18T23:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303468",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_303469.json:
```json
{
    "body": "Changing branch from \"u/xander.faber/integer_mod_fix\" to \"a50d79df6cb35e20d3061fa4c817afe92f330b67\"",
    "created_at": "2015-02-18T23:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17717",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17717#issuecomment-303469",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/xander.faber/integer_mod_fix" to "a50d79df6cb35e20d3061fa4c817afe92f330b67"
