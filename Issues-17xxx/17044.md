# Issue 17044: fix pexpect interfaces with a system-wide sage install

archive/issues_016807.json:
```json
{
    "body": "CC:  @novoselt\n\nIf you install Sage system-wide (e.g., in /usr/local) for all users on your system, most of the pexpect interfaces for optional packages will be completely massively broken.  For example, on a system which doesn't have scilab installed:\n\n```\nsage: scilab('2+3')\n---------------------------------------------------------------------------\nOSError                                   Traceback (most recent call last)\n<ipython-input-1-c7d52e4ba13e> in <module>()\n----> 1 scilab('2+3')\n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __call__(self, x, name)\n    197 \n    198         if isinstance(x, basestring):\n--> 199             return cls(self, x, name=name)\n    200         try:\n    201             return self._coerce_from_special_method(x)\n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in __init__(self, parent, value, is_name, name)\n   1310         else:\n   1311             try:\n-> 1312                 self._name = parent._create(value, name=name)\n   1313             # Convert ValueError and RuntimeError to TypeError for\n   1314             # coercion to work properly.\n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in _create(self, value, name)\n    387     def _create(self, value, name=None):\n    388         name = self._next_var_name() if name is None else name\n--> 389         self.set(name, value)\n    390         return name\n    391 \n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/scilab.pyc in set(self, var, value)\n    307         \"\"\"\n    308         cmd = '%s=%s;'%(var,value)\n--> 309         out = self.eval(cmd)\n    310         if out.find(\"error\") != -1:\n    311             raise TypeError(\"Error executing code in Scilab\\nCODE:\\n\\t%s\\nScilab ERROR:\\n\\t%s\"%(cmd, out))\n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/scilab.pyc in eval(self, command, *args, **kwds)\n    274             'd  =\\n \\n    44.'\n    275         \"\"\"\n--> 276         s = Expect.eval(self, command, **kwds).replace(\"\\x1b[?1l\\x1b>\",\"\").strip()\n    277         return s\n    278 \n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)                                                                                                                                                                       \n   1227                 elif split_lines:\n   1228                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1229                                         for L in code.split('\\n') if L != ''])\n   1230                 else:                                                                                                                                           \n   1231                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)\n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)\n    821         try:\n    822             if self._expect is None:\n--> 823                 self._start()\n    824             E = self._expect\n    825             try:\n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/scilab.pyc in _start(self)\n    261             sage: scilab._start()                       # optional - scilab\n    262         \"\"\"\n--> 263         Expect._start(self)\n    264         self.eval(\"mode(0)\")\n    265 \n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in _start(self, alt_message, block_during_init)\n    389         current_path = os.path.abspath('.')\n    390         dir = self.__path\n--> 391         sage_makedirs(dir)\n    392         os.chdir(dir)\n    393 \n\n/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/misc.pyc in sage_makedirs(dir)\n     79     \"\"\"\n     80     try:\n---> 81         os.makedirs(dir)\n     82     except OSError:\n     83         if not os.path.isdir(dir):\n\n/usr/local/src/sage-git/local/lib/python/os.pyc in makedirs(name, mode)\n    148     if head and tail and not path.exists(head):\n    149         try:\n--> 150             makedirs(head, mode)\n    151         except OSError, e:\n    152             # be happy if someone already created the path\n\n/usr/local/src/sage-git/local/lib/python/os.pyc in makedirs(name, mode)\n    155         if tail == curdir:           # xxx/newdir/. exists if xxx/newdir exists\n    156             return\n--> 157     mkdir(name, mode)\n    158 \n    159 def removedirs(name):\n\nOSError: [Errno 13] Permission denied: '/usr/local/src/sage-git/local/share/sage/ext/scilab'\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/17044\n\n",
    "closed_at": "2014-10-02T16:21:49Z",
    "created_at": "2014-09-25T23:34:38Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "fix pexpect interfaces with a system-wide sage install",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17044",
    "user": "https://github.com/williamstein"
}
```
CC:  @novoselt

If you install Sage system-wide (e.g., in /usr/local) for all users on your system, most of the pexpect interfaces for optional packages will be completely massively broken.  For example, on a system which doesn't have scilab installed:

```
sage: scilab('2+3')
---------------------------------------------------------------------------
OSError                                   Traceback (most recent call last)
<ipython-input-1-c7d52e4ba13e> in <module>()
----> 1 scilab('2+3')

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __call__(self, x, name)
    197 
    198         if isinstance(x, basestring):
--> 199             return cls(self, x, name=name)
    200         try:
    201             return self._coerce_from_special_method(x)

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in __init__(self, parent, value, is_name, name)
   1310         else:
   1311             try:
-> 1312                 self._name = parent._create(value, name=name)
   1313             # Convert ValueError and RuntimeError to TypeError for
   1314             # coercion to work properly.

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in _create(self, value, name)
    387     def _create(self, value, name=None):
    388         name = self._next_var_name() if name is None else name
--> 389         self.set(name, value)
    390         return name
    391 

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/scilab.pyc in set(self, var, value)
    307         """
    308         cmd = '%s=%s;'%(var,value)
--> 309         out = self.eval(cmd)
    310         if out.find("error") != -1:
    311             raise TypeError("Error executing code in Scilab\nCODE:\n\t%s\nScilab ERROR:\n\t%s"%(cmd, out))

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/scilab.pyc in eval(self, command, *args, **kwds)
    274             'd  =\n \n    44.'
    275         """
--> 276         s = Expect.eval(self, command, **kwds).replace("\x1b[?1l\x1b>","").strip()
    277         return s
    278 

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)                                                                                                                                                                       
   1227                 elif split_lines:
   1228                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1229                                         for L in code.split('\n') if L != ''])
   1230                 else:                                                                                                                                           
   1231                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    821         try:
    822             if self._expect is None:
--> 823                 self._start()
    824             E = self._expect
    825             try:

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/scilab.pyc in _start(self)
    261             sage: scilab._start()                       # optional - scilab
    262         """
--> 263         Expect._start(self)
    264         self.eval("mode(0)")
    265 

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in _start(self, alt_message, block_during_init)
    389         current_path = os.path.abspath('.')
    390         dir = self.__path
--> 391         sage_makedirs(dir)
    392         os.chdir(dir)
    393 

/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/misc.pyc in sage_makedirs(dir)
     79     """
     80     try:
---> 81         os.makedirs(dir)
     82     except OSError:
     83         if not os.path.isdir(dir):

/usr/local/src/sage-git/local/lib/python/os.pyc in makedirs(name, mode)
    148     if head and tail and not path.exists(head):
    149         try:
--> 150             makedirs(head, mode)
    151         except OSError, e:
    152             # be happy if someone already created the path

/usr/local/src/sage-git/local/lib/python/os.pyc in makedirs(name, mode)
    155         if tail == curdir:           # xxx/newdir/. exists if xxx/newdir exists
    156             return
--> 157     mkdir(name, mode)
    158 
    159 def removedirs(name):

OSError: [Errno 13] Permission denied: '/usr/local/src/sage-git/local/share/sage/ext/scilab'
```

Issue created by migration from https://trac.sagemath.org/ticket/17044





---

archive/issue_comments_222231.json:
```json
{
    "body": "Done\n\n---\nNew commits:",
    "created_at": "2014-09-26T07:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222231",
    "user": "https://github.com/fchapoton"
}
```

Done

---
New commits:



---

archive/issue_comments_222232.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-26T07:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222232",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_222233.json:
```json
{
    "body": "I would like to understand the problem better. So William, could you please\n1) say which version of Sage this refers to\n2) describe the actual input and error you are getting\n3) if any doctests fail in your setup (without this patch)\n\nI am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. So the problem is probably more subtle than you think.",
    "created_at": "2014-09-26T07:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222233",
    "user": "https://github.com/jdemeyer"
}
```

I would like to understand the problem better. So William, could you please
1) say which version of Sage this refers to
2) describe the actual input and error you are getting
3) if any doctests fail in your setup (without this patch)

I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. So the problem is probably more subtle than you think.



---

archive/issue_comments_222234.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> I would like to understand the problem better. So William, could you please\n> 1) say which version of Sage this refers to\n\n\nAt least any Sage-6.x.\n\n> 2) describe the actual input and error you are getting\n\n\nInstall Sage system-wide, then try to do anything with *some* of the pexpect-based interfaces as a normal user who doesn't own the sage install, especially ones that use optional software.  E.g., \n\n sage: scilab('2+3')\n\n> 3) if any doctests fail in your setup (without this patch)\n\n\nNope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  \n\n> \n> I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. \n\n\nThis problem has popped on the mailing lists, and basically got ignored, probably because for the most part our Sage developers usually own their own Sage installs.   However, with SageMathCloud, which has now 7000 *active users* per week all using a system-wide Sage install, this problem comes up more.  I had dome some horrible hacks to try to get around it, e.g., pointing SAGE_ROOT/local/share at something world writeable, but even this fails miserable if *two* regular users use the same interface -- one creates the user directory as their own, and the other then can't write to it. \n\nI think much of this boils down to a stupid coding mistake (surely made by me) involving `=\"\"` versus `=None`.\n\n> So the problem is probably more subtle than you think.\n\n\nIt probably is.  I wouldn't be surprised at all if this small patch is not the whole story, and there are similar bugs still lurking, since any classes that derive from the base Expect class (in expect.py) could cause their own related trouble...",
    "created_at": "2014-09-26T15:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222234",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:2 jdemeyer]:
> I would like to understand the problem better. So William, could you please
> 1) say which version of Sage this refers to


At least any Sage-6.x.

> 2) describe the actual input and error you are getting


Install Sage system-wide, then try to do anything with *some* of the pexpect-based interfaces as a normal user who doesn't own the sage install, especially ones that use optional software.  E.g., 

 sage: scilab('2+3')

> 3) if any doctests fail in your setup (without this patch)


Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  

> 
> I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. 


This problem has popped on the mailing lists, and basically got ignored, probably because for the most part our Sage developers usually own their own Sage installs.   However, with SageMathCloud, which has now 7000 *active users* per week all using a system-wide Sage install, this problem comes up more.  I had dome some horrible hacks to try to get around it, e.g., pointing SAGE_ROOT/local/share at something world writeable, but even this fails miserable if *two* regular users use the same interface -- one creates the user directory as their own, and the other then can't write to it. 

I think much of this boils down to a stupid coding mistake (surely made by me) involving `=""` versus `=None`.

> So the problem is probably more subtle than you think.


It probably is.  I wouldn't be surprised at all if this small patch is not the whole story, and there are similar bugs still lurking, since any classes that derive from the base Expect class (in expect.py) could cause their own related trouble...



---

archive/issue_comments_222235.json:
```json
{
    "body": "Replying to [comment:3 was]:\n> > 3) if any doctests fail in your setup (without this patch)\n\n> \n> Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  \n  \nI meant: do any doctests fail when running doctests as the user who *doesn't* own the Sage install? That should work (see #5155), although I don't know if this is still tested on a regular basis (I did it as part of my release management scripts, I have no idea if Volker does it).",
    "created_at": "2014-09-26T16:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222235",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 was]:
> > 3) if any doctests fail in your setup (without this patch)

> 
> Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  
  
I meant: do any doctests fail when running doctests as the user who *doesn't* own the Sage install? That should work (see #5155), although I don't know if this is still tested on a regular basis (I did it as part of my release management scripts, I have no idea if Volker does it).



---

archive/issue_comments_222236.json:
```json
{
    "body": "Patch doesn't solve the issue.",
    "created_at": "2014-09-26T18:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222236",
    "user": "https://github.com/jdemeyer"
}
```

Patch doesn't solve the issue.



---

archive/issue_comments_222237.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-26T18:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222237",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_222238.json:
```json
{
    "body": "My proposal to fix this ticket would be to get rid completely of the \"script_subdirectory\" argument, it's a broken design.",
    "created_at": "2014-09-26T18:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222238",
    "user": "https://github.com/jdemeyer"
}
```

My proposal to fix this ticket would be to get rid completely of the "script_subdirectory" argument, it's a broken design.



---

archive/issue_comments_222239.json:
```json
{
    "body": "OK, perhaps not get rid of \"script_directory\" completely, but only use it for scripts which are known to be shipped with Sage, e.g. some PARI/GP scripts.",
    "created_at": "2014-09-26T18:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222239",
    "user": "https://github.com/jdemeyer"
}
```

OK, perhaps not get rid of "script_directory" completely, but only use it for scripts which are known to be shipped with Sage, e.g. some PARI/GP scripts.



---

archive/issue_comments_222240.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-09-26T19:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222240",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_222241.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-26T19:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222241",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_222242.json:
```json
{
    "body": "This fixes the bug, but I still have to run doctests.",
    "created_at": "2014-09-26T19:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222242",
    "user": "https://github.com/jdemeyer"
}
```

This fixes the bug, but I still have to run doctests.



---

archive/issue_comments_222243.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-27T09:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222243",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_222244.json:
```json
{
    "body": "Doctests pass.",
    "created_at": "2014-09-27T09:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222244",
    "user": "https://github.com/jdemeyer"
}
```

Doctests pass.



---

archive/issue_comments_222245.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-09-27T09:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222245",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_222246.json:
```json
{
    "body": "Hello,\n\nI am not sure at all to be competent to review this ticket. As far as I can tell, this looks good.\n\nI allowed myself to remove a few unused imports (except one which is in fact used in an indirect way) and one unused variable.\n\nJeroen, you can set this to positive review if you want.",
    "created_at": "2014-09-30T15:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222246",
    "user": "https://github.com/fchapoton"
}
```

Hello,

I am not sure at all to be competent to review this ticket. As far as I can tell, this looks good.

I allowed myself to remove a few unused imports (except one which is in fact used in an indirect way) and one unused variable.

Jeroen, you can set this to positive review if you want.



---

archive/issue_comments_222247.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-30T15:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222247",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_222248.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-30T15:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222248",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_049592.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-02T16:21:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17044#event-49592"
}
```



---

archive/issue_comments_222249.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-02T16:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17044",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17044#issuecomment-222249",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
