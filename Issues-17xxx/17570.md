# Issue 17570: ToricRationalDivisorClass: Integer/Rational mixed up

archive/issues_017333.json:
```json
{
    "body": "In `src/sage/schemes/toric/divisor.py`, there is:\n\n```\nclass ToricRationalDivisorClassGroup_basis_lattice(FreeModule_ambient_pid):\n    def __init__(self, group):\n        # ...\n        super(ToricRationalDivisorClassGroup_basis_lattice, self).__init__(\n            ZZ, group.dimension())\n```\n(note the `ZZ`)\n\nHowever, in `src/sage/schemes/toric/divisor_class.pyx`, there is\n\n```\ncdef class ToricRationalDivisorClass(Vector_rational_dense):\n```\n\nSo, do we want rationals or integers? This causes segfaults when improving vectors in #17562.\n\nCC:  @vbraun @novoselt\n\nReviewer: Jeroen Demeyer\n\nBranch: u/jdemeyer/ticket/17570\n\nCommit: b2c68ca56a6235b049c260c0cf181a252935037c\n\nResolution: worksforme\n\nIssue created by migration from https://trac.sagemath.org/ticket/17570\n\n",
    "closed_at": "2015-01-13T01:21:03Z",
    "created_at": "2014-12-30T14:38:49Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "ToricRationalDivisorClass: Integer/Rational mixed up",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17570",
    "user": "https://github.com/jdemeyer"
}
```
In `src/sage/schemes/toric/divisor.py`, there is:

```
class ToricRationalDivisorClassGroup_basis_lattice(FreeModule_ambient_pid):
    def __init__(self, group):
        # ...
        super(ToricRationalDivisorClassGroup_basis_lattice, self).__init__(
            ZZ, group.dimension())
```
(note the `ZZ`)

However, in `src/sage/schemes/toric/divisor_class.pyx`, there is

```
cdef class ToricRationalDivisorClass(Vector_rational_dense):
```

So, do we want rationals or integers? This causes segfaults when improving vectors in #17562.

CC:  @vbraun @novoselt

Reviewer: Jeroen Demeyer

Branch: u/jdemeyer/ticket/17570

Commit: b2c68ca56a6235b049c260c0cf181a252935037c

Resolution: worksforme

Issue created by migration from https://trac.sagemath.org/ticket/17570





---

archive/issue_comments_299245.json:
```json
{
    "body": "<a id='comment:1'></a>\nIt should be `QQ` (the \"rational\" part). I vaguely remember that this caused some problem with the old modules. If you can change it then please do.",
    "created_at": "2014-12-30T17:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299245",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>
It should be `QQ` (the "rational" part). I vaguely remember that this caused some problem with the old modules. If you can change it then please do.



---

archive/issue_comments_299246.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe problem is when you're constructing a `Cone` using this as lattice (the `Kaehler_cone` or `Mori_cone`), it complains since it wants integer lattices.",
    "created_at": "2014-12-30T17:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299246",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
The problem is when you're constructing a `Cone` using this as lattice (the `Kaehler_cone` or `Mori_cone`), it complains since it wants integer lattices.



---

archive/issue_comments_299247.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/ticket/17570\"",
    "created_at": "2014-12-30T20:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299247",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/ticket/17570"



---

archive/issue_comments_299248.json:
```json
{
    "body": "Changing commit from \"\" to \"b2c68ca56a6235b049c260c0cf181a252935037c\"",
    "created_at": "2014-12-30T20:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299248",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "b2c68ca56a6235b049c260c0cf181a252935037c"



---

archive/issue_comments_299249.json:
```json
{
    "body": "Changing author from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2014-12-30T20:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299249",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "" to "Jeroen Demeyer"



---

archive/issue_comments_299250.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-12-30T20:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299250",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_299251.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                        |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------|\n|[b2c68ca](http://git.sagemath.org/sage.git/commit/?id=b2c68ca56a6235b049c260c0cf181a252935037c)|`ToricRationalDivisorClassGroup_basis_lattice should be defined over QQ`|",
    "created_at": "2014-12-30T20:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299251",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.

---
New commits:
|                                                                                                                                          |                                                                        |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------|
|[b2c68ca](http://git.sagemath.org/sage.git/commit/?id=b2c68ca56a6235b049c260c0cf181a252935037c)|`ToricRationalDivisorClassGroup_basis_lattice should be defined over QQ`|



---

archive/issue_comments_299252.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-12-31T05:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299252",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299253.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [jdemeyer](#comment%3A4):\n> This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.\n\n\nIt is most definitely not the right thing to do in the cone module - a lattice is a free module over integers and not rationals! (On the other hand there is nothing wrong with a vector over rationals related to a cone defined over integers.) I can try to figure out what is the right thing to do here, but not this minute.",
    "created_at": "2014-12-31T05:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299253",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:5'></a>
Replying to [jdemeyer](#comment%3A4):
> This branch passes all doctests, however I admit that I do not understand what this code is doing and whether my fix does *The Right Thing*.


It is most definitely not the right thing to do in the cone module - a lattice is a free module over integers and not rationals! (On the other hand there is nothing wrong with a vector over rationals related to a cone defined over integers.) I can try to figure out what is the right thing to do here, but not this minute.



---

archive/issue_comments_299254.json:
```json
{
    "body": "<a id='comment:6'></a>\nSo, what you really want is a free `ZZ`-module generated by vectors which might have coefficients in `QQ`, is that right?\n\nThat's actually legal:\n\n```\nsage: M = (ZZ^2).span([(1,1/3),(0,1/2)])\nsage: M\nFree module of degree 2 and rank 2 over Integer Ring\nEchelon basis matrix:\n[  1 1/3]\n[  0 1/2]\nsage: M.base_ring()\nInteger Ring\nsage: type(M.basis()[0])\n<type 'sage.modules.vector_rational_dense.Vector_rational_dense'>\n```\n\nSo the problem might be solvable by deriving from\n\n```\nsage: type(M)\n<class 'sage.modules.free_module.FreeModule_submodule_pid_with_category'>\n```\ninstead of `FreeModule_generic_pid`.",
    "created_at": "2014-12-31T09:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299254",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
So, what you really want is a free `ZZ`-module generated by vectors which might have coefficients in `QQ`, is that right?

That's actually legal:

```
sage: M = (ZZ^2).span([(1,1/3),(0,1/2)])
sage: M
Free module of degree 2 and rank 2 over Integer Ring
Echelon basis matrix:
[  1 1/3]
[  0 1/2]
sage: M.base_ring()
Integer Ring
sage: type(M.basis()[0])
<type 'sage.modules.vector_rational_dense.Vector_rational_dense'>
```

So the problem might be solvable by deriving from

```
sage: type(M)
<class 'sage.modules.free_module.FreeModule_submodule_pid_with_category'>
```
instead of `FreeModule_generic_pid`.



---

archive/issue_comments_299255.json:
```json
{
    "body": "<a id='comment:7'></a>\nI'm wondering if we should introduce a new method `coefficient_ring` or something on the *element* class which would return `QQ` in this case.",
    "created_at": "2014-12-31T09:40:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299255",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
I'm wondering if we should introduce a new method `coefficient_ring` or something on the *element* class which would return `QQ` in this case.



---

archive/issue_comments_299256.json:
```json
{
    "body": "<a id='comment:8'></a>\nThe more I'm thinking about this, the more I'm thinking that this is not a bug.",
    "created_at": "2014-12-31T10:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299256",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
The more I'm thinking about this, the more I'm thinking that this is not a bug.



---

archive/issue_comments_299257.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis is really a whole can of worms and this toric stuff is just the only place where it is exposed by doctests.\n\nA lot of code in free modules assumes that the `base_ring()` of the parent (i.e. the free module) is the same ring as the ring of coefficients of the elements.",
    "created_at": "2014-12-31T10:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299257",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
This is really a whole can of worms and this toric stuff is just the only place where it is exposed by doctests.

A lot of code in free modules assumes that the `base_ring()` of the parent (i.e. the free module) is the same ring as the ring of coefficients of the elements.



---

archive/issue_comments_299258.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-01-02T10:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299258",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_050431.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-01-02T10:37:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17570#event-50431"
}
```



---

archive/issue_comments_299259.json:
```json
{
    "body": "Changing author from \"Jeroen Demeyer\" to \"\"",
    "created_at": "2015-01-02T10:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299259",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "Jeroen Demeyer" to ""



---

archive/issue_comments_299260.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2015-01-02T10:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299260",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_299261.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis is not a bug, see [https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g](https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g)",
    "created_at": "2015-01-02T10:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299261",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
This is not a bug, see [https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g](https://groups.google.com/forum/#!topic/sage-devel/7n5xtT9Dw2g)



---

archive/issue_events_050432.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-01-13T01:21:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17570#event-50432"
}
```



---

archive/issue_comments_299262.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2015-01-13T01:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17570",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17570#issuecomment-299262",
    "user": "https://github.com/vbraun"
}
```

Resolution: worksforme
