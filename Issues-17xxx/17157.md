# Issue 17157: Improve formula for Bell numbers

archive/issues_016920.json:
```json
{
    "body": "Improve the error analysis for the implementation of Dobinski's formula to compute the Bell numbers leading to\n\n1. code which is actually consistent with the mathematical formulas\n2. code which is cleaner and simpler than before\n3. a complete error estimate including the final real approximation\n4. faster code:\n\nBefore:\n\n```\nsage: timeit('bell_number(200)', number=2000)\n2000 loops, best of 3: 1.45 ms per loop\n```\n\nAfter:\n\n```\nsage: timeit('bell_number(200)', number=2000)\n2000 loops, best of 3: 441 \u00b5s per loop\n```\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nBranch: 330617caa6e52c1cc5d7b67ae41fd5cf30ef8dc9\n\nDependencies: #16428, #15300\n\nCommit: 330617caa6e52c1cc5d7b67ae41fd5cf30ef8dc9\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17157\n\n",
    "closed_at": "2014-10-24T18:05:57Z",
    "created_at": "2014-10-15T08:35:38Z",
    "labels": [
        "component: combinatorics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Improve formula for Bell numbers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17157",
    "user": "https://github.com/jdemeyer"
}
```
Improve the error analysis for the implementation of Dobinski's formula to compute the Bell numbers leading to

1. code which is actually consistent with the mathematical formulas
2. code which is cleaner and simpler than before
3. a complete error estimate including the final real approximation
4. faster code:

Before:

```
sage: timeit('bell_number(200)', number=2000)
2000 loops, best of 3: 1.45 ms per loop
```

After:

```
sage: timeit('bell_number(200)', number=2000)
2000 loops, best of 3: 441 µs per loop
```

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Branch: 330617caa6e52c1cc5d7b67ae41fd5cf30ef8dc9

Dependencies: #16428, #15300

Commit: 330617caa6e52c1cc5d7b67ae41fd5cf30ef8dc9

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17157





---

archive/issue_comments_223837.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-15T21:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223837",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_223838.json:
```json
{
    "body": "<a id='comment:5'></a>New commits:",
    "created_at": "2014-10-15T22:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223838",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>New commits:



---

archive/issue_comments_223839.json:
```json
{
    "body": "<a id='comment:6'></a>You might also consider wrapping flint's arith_bell_number. On this computer it seems to be about twice as fast as Sage's current bell_number(n, algorithm='dobinski') for n = 1000, 2000, 4000, 10000, 20000, 40000.",
    "created_at": "2014-10-16T13:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223839",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:6'></a>You might also consider wrapping flint's arith_bell_number. On this computer it seems to be about twice as fast as Sage's current bell_number(n, algorithm='dobinski') for n = 1000, 2000, 4000, 10000, 20000, 40000.



---

archive/issue_comments_223840.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 fredrik.johansson]:\n> Sage's current bell_number(n, algorithm='dobinski')\n\nWith or without this patch?",
    "created_at": "2014-10-16T13:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223840",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 fredrik.johansson]:
> Sage's current bell_number(n, algorithm='dobinski')

With or without this patch?



---

archive/issue_comments_223841.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 fredrik.johansson]:\n> You might also consider wrapping flint's arith_bell_number.\n\nIf I do so, will you review this ticket?",
    "created_at": "2014-10-16T13:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223841",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:6 fredrik.johansson]:
> You might also consider wrapping flint's arith_bell_number.

If I do so, will you review this ticket?



---

archive/issue_comments_223842.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 jdemeyer]:\n> Replying to [comment:6 fredrik.johansson]:\n> > Sage's current bell_number(n, algorithm='dobinski')\n\n> With or without this patch?\n\nWithout. The difference is bigger for smaller n of course. Here is a more accurate comparison:\n\nflint:\n\n100  cpu/wall(s): 2.6e-05 2.68e-05\n200  cpu/wall(s): 8.2e-05 8.57e-05\n400  cpu/wall(s): 0.00039 0.000403\n1000  cpu/wall(s): 0.004 0.00441\n2000  cpu/wall(s): 0.023 0.026\n4000  cpu/wall(s): 0.16 0.172\n10000  cpu/wall(s): 0.91 0.949\n20000  cpu/wall(s): 4.02 4.173\n40000  cpu/wall(s): 18.12 21.109\n\nsage (without patch):\n\n100 5 loops, best of 3: 1.05 ms per loop\n200 625 loops, best of 3: 1.52 ms per loop\n400 125 loops, best of 3: 1.96 ms per loop\n1000 125 loops, best of 3: 7.39 ms per loop\n2000 5 loops, best of 3: 38 ms per loop\n4000 5 loops, best of 3: 216 ms per loop\n10000 5 loops, best of 3: 2.17 s per loop\n20000 1 loops, best of 3: 13 s per loop\n40000 1 loops, best of 3: 68 s per loop",
    "created_at": "2014-10-16T13:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223842",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:9'></a>Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 fredrik.johansson]:
> > Sage's current bell_number(n, algorithm='dobinski')

> With or without this patch?

Without. The difference is bigger for smaller n of course. Here is a more accurate comparison:

flint:

100  cpu/wall(s): 2.6e-05 2.68e-05
200  cpu/wall(s): 8.2e-05 8.57e-05
400  cpu/wall(s): 0.00039 0.000403
1000  cpu/wall(s): 0.004 0.00441
2000  cpu/wall(s): 0.023 0.026
4000  cpu/wall(s): 0.16 0.172
10000  cpu/wall(s): 0.91 0.949
20000  cpu/wall(s): 4.02 4.173
40000  cpu/wall(s): 18.12 21.109

sage (without patch):

100 5 loops, best of 3: 1.05 ms per loop
200 625 loops, best of 3: 1.52 ms per loop
400 125 loops, best of 3: 1.96 ms per loop
1000 125 loops, best of 3: 7.39 ms per loop
2000 5 loops, best of 3: 38 ms per loop
4000 5 loops, best of 3: 216 ms per loop
10000 5 loops, best of 3: 2.17 s per loop
20000 1 loops, best of 3: 13 s per loop
40000 1 loops, best of 3: 68 s per loop



---

archive/issue_comments_223843.json:
```json
{
    "body": "<a id='comment:10'></a>You can just compute the sum in Dobinski's formula as an exact fraction (keeping the numerator and denominator separate, not actually dividing rational numbers by successive factorials). Indeed this is what flint does for n < 5000 (for larger n it uses a multimodular algorithm). This simplifies the error analysis.",
    "created_at": "2014-10-16T14:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223843",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:10'></a>You can just compute the sum in Dobinski's formula as an exact fraction (keeping the numerator and denominator separate, not actually dividing rational numbers by successive factorials). Indeed this is what flint does for n < 5000 (for larger n it uses a multimodular algorithm). This simplifies the error analysis.



---

archive/issue_comments_223844.json:
```json
{
    "body": "<a id='comment:11'></a>Which reminds me that flint is missing two tricks: firstly, batch computing all the powers `1^n, 3^n, 5^n, ..., N^n` using sieving (one multiplication for every odd index, then one shift for every even index), and secondly, only working with approximate values of the powers near the end of that list.\n\nThe first trick would use much more memory, of course, but that's fine as one can fall back to the multimodular algorithm for very large n anyway.",
    "created_at": "2014-10-16T14:28:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223844",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:11'></a>Which reminds me that flint is missing two tricks: firstly, batch computing all the powers `1^n, 3^n, 5^n, ..., N^n` using sieving (one multiplication for every odd index, then one shift for every even index), and secondly, only working with approximate values of the powers near the end of that list.

The first trick would use much more memory, of course, but that's fine as one can fall back to the multimodular algorithm for very large n anyway.



---

archive/issue_comments_223845.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-20T19:36:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223845",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223846.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:8 jdemeyer]:\n> Replying to [comment:6 fredrik.johansson]:\n> > You might also consider wrapping flint's arith_bell_number.\n\n> If I do so, will you review this ticket?\n\nI will review it if you do so. I'm for including access to multiple implementations.",
    "created_at": "2014-10-23T14:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223846",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Replying to [comment:8 jdemeyer]:
> Replying to [comment:6 fredrik.johansson]:
> > You might also consider wrapping flint's arith_bell_number.

> If I do so, will you review this ticket?

I will review it if you do so. I'm for including access to multiple implementations.



---

archive/issue_comments_223847.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-23T14:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223847",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_223848.json:
```json
{
    "body": "<a id='comment:15'></a>Waiting now for all my cython files to recompile.",
    "created_at": "2014-10-23T15:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223848",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>Waiting now for all my cython files to recompile.



---

archive/issue_comments_223849.json:
```json
{
    "body": "<a id='comment:16'></a>Some timings:\n\n```\nsage: %timeit bell_number(200)\n1000 loops, best of 3: 612 \u00b5s per loop\nsage: %timeit bell_number(200, algorithm='dobinski')\n100 loops, best of 3: 2.2 ms per loop\nsage: %timeit bell_number(200, algorithm='gap')\n1 loops, best of 3: 21 ms per loop\nsage: %timeit bell_number(200, algorithm='mpmath')\n10 loops, best of 3: 21.2 ms per loop\n\nsage: %timeit bell_number(1000)\n10 loops, best of 3: 40.1 ms per loop\nsage: %timeit bell_number(1000, algorithm='dobinski')\n10 loops, best of 3: 49.5 ms per loop\nsage: %timeit bell_number(1000, algorithm='gap')\n1 loops, best of 3: 1.58 s per loop\nsage: %timeit bell_number(1000, algorithm='mpmath')\n1 loops, best of 3: 737 ms per loop\n\nsage: %timeit bell_number(10000, algorithm='flint')\n1 loops, best of 3: 3.57 s per loop\nsage: %timeit bell_number(10000, algorithm='dobinski')\n1 loops, best of 3: 20 s per loop\n```\n\nSo LGTM.",
    "created_at": "2014-10-23T16:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223849",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Some timings:

```
sage: %timeit bell_number(200)
1000 loops, best of 3: 612 µs per loop
sage: %timeit bell_number(200, algorithm='dobinski')
100 loops, best of 3: 2.2 ms per loop
sage: %timeit bell_number(200, algorithm='gap')
1 loops, best of 3: 21 ms per loop
sage: %timeit bell_number(200, algorithm='mpmath')
10 loops, best of 3: 21.2 ms per loop

sage: %timeit bell_number(1000)
10 loops, best of 3: 40.1 ms per loop
sage: %timeit bell_number(1000, algorithm='dobinski')
10 loops, best of 3: 49.5 ms per loop
sage: %timeit bell_number(1000, algorithm='gap')
1 loops, best of 3: 1.58 s per loop
sage: %timeit bell_number(1000, algorithm='mpmath')
1 loops, best of 3: 737 ms per loop

sage: %timeit bell_number(10000, algorithm='flint')
1 loops, best of 3: 3.57 s per loop
sage: %timeit bell_number(10000, algorithm='dobinski')
1 loops, best of 3: 20 s per loop
```

So LGTM.



---

archive/issue_comments_223850.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-23T16:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223850",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_223851.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-10-23T19:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223851",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_223852.json:
```json
{
    "body": "<a id='comment:17'></a>Conflicts with #15300 most likely",
    "created_at": "2014-10-23T19:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223852",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Conflicts with #15300 most likely



---

archive/issue_comments_223853.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2014-10-23T19:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223853",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_223854.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-10-23T19:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223854",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_223855.json:
```json
{
    "body": "<a id='comment:19'></a>Last 10 new commits:",
    "created_at": "2014-10-23T19:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223855",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Last 10 new commits:



---

archive/issue_comments_223856.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-24T18:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-223856",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_049769.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-24T18:05:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17157#event-49769"
}
```
