# Issue 17940: IOError: cannot identify image file

archive/issues_017703.json:
```json
{
    "body": "With Sage 6.6 beta 3 and using Sage Notebook I get a backtrace when I want to see a sphere:\n\n```\nsage: sphere()\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"_sage_input_3.py\", line 10, in <module>\n    exec compile(u'open(\"___code___.py\",\"w\").write(\"# -*- coding: utf-8 -*-\\\\n\" + _support_.preparse_worksheet_cell(base64.b64decode(\"c3BoZXJlKCk=\"),globals())+\"\\\\n\"); execfile(os.path.abspath(\"___code___.py\"))\n  File \"\", line 1, in <module>\n    \n  File \"/tmp/tmpWqCNEl/___code___.py\", line 2, in <module>\n    exec compile(u'sphere()\n  File \"\", line 1, in <module>\n    \n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 716, in displayhook\n    return self._backend.displayhook(plain_text, rich_output)\n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_base.py\", line 432, in displayhook\n    return self.display_immediately(plain_text, rich_output)\n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py\", line 361, in display_immediately\n    rich_output.embed()\n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py\", line 258, in embed\n    self.save_preview()\n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py\", line 237, in save_preview\n    self.preview_png.save_as(self.preview_filename())\n  File \"sage/misc/cachefunc.pyx\", line 2209, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13699)\n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py\", line 189, in preview_filename\n    directory, filename = os.path.split(self._base_filename())\n  File \"sage/misc/cachefunc.pyx\", line 2209, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13699)\n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py\", line 147, in _base_filename\n    filename = self.sagenb_launch_script_filename()\n  File \"sage/misc/cachefunc.pyx\", line 2209, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13699)\n  File \"sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py\", line 122, in sagenb_launch_script_filename\n    width, height = PIL.Image.open(StringIO(self.preview_png.get())).size\n  File \"build/bdist.linux-x86_64/egg/PIL/Image.py\", line 2006, in open\nIOError: cannot identify image file\n```\n\nUsing strace I can see access to some `preview.png` and looking at that file I notice that it appears to be a regular PNG, concatenated with a Jmol script. So apparently two outputs ended up in the same data stream. This is likely a consequence of #17234.\n\nCC:  @vbraun\n\nKeywords: strange\n\nBranch/Commit: 381899884cca9c1d4c1654cb41e3b3d0eeac553c\n\nUpstream: Workaround found; Bug reported upstream.\n\nReviewer: Volker Braun\n\nAuthor: Martin von Gagern\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17940\n\n",
    "closed_at": "2015-03-12T23:06:36Z",
    "created_at": "2015-03-12T17:31:10Z",
    "labels": [
        "component: user interface",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "IOError: cannot identify image file",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17940",
    "user": "https://github.com/gagern"
}
```
With Sage 6.6 beta 3 and using Sage Notebook I get a backtrace when I want to see a sphere:

```
sage: sphere()
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "_sage_input_3.py", line 10, in <module>
    exec compile(u'open("___code___.py","w").write("# -*- coding: utf-8 -*-\\n" + _support_.preparse_worksheet_cell(base64.b64decode("c3BoZXJlKCk="),globals())+"\\n"); execfile(os.path.abspath("___code___.py"))
  File "", line 1, in <module>
    
  File "/tmp/tmpWqCNEl/___code___.py", line 2, in <module>
    exec compile(u'sphere()
  File "", line 1, in <module>
    
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 716, in displayhook
    return self._backend.displayhook(plain_text, rich_output)
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_base.py", line 432, in displayhook
    return self.display_immediately(plain_text, rich_output)
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py", line 361, in display_immediately
    rich_output.embed()
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py", line 258, in embed
    self.save_preview()
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py", line 237, in save_preview
    self.preview_png.save_as(self.preview_filename())
  File "sage/misc/cachefunc.pyx", line 2209, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13699)
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py", line 189, in preview_filename
    directory, filename = os.path.split(self._base_filename())
  File "sage/misc/cachefunc.pyx", line 2209, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13699)
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py", line 147, in _base_filename
    filename = self.sagenb_launch_script_filename()
  File "sage/misc/cachefunc.pyx", line 2209, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:13699)
  File "sage/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_sagenb.py", line 122, in sagenb_launch_script_filename
    width, height = PIL.Image.open(StringIO(self.preview_png.get())).size
  File "build/bdist.linux-x86_64/egg/PIL/Image.py", line 2006, in open
IOError: cannot identify image file
```

Using strace I can see access to some `preview.png` and looking at that file I notice that it appears to be a regular PNG, concatenated with a Jmol script. So apparently two outputs ended up in the same data stream. This is likely a consequence of #17234.

CC:  @vbraun

Keywords: strange

Branch/Commit: 381899884cca9c1d4c1654cb41e3b3d0eeac553c

Upstream: Workaround found; Bug reported upstream.

Reviewer: Volker Braun

Author: Martin von Gagern

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17940





---

archive/issue_comments_251829.json:
```json
{
    "body": "<a id='comment:1'></a>Works for me. Can you post your strace output? Can PIL open a PNG at all on your system?",
    "created_at": "2015-03-12T18:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251829",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>Works for me. Can you post your strace output? Can PIL open a PNG at all on your system?



---

archive/issue_comments_251830.json:
```json
{
    "body": "Replying to [ticket:17940 gagern]:\n> Using strace I can see access to some `preview.png` and looking at that file I notice that it appears to be a regular PNG, concatenated with a Jmol script. So apparently two outputs ended up in the same data stream. This is likely a consequence of #17234.\n\n\nIt seems I was misled: apparently JMol attaching its script to the generated PNG is normal behavior. The PNG file is apparently broken at some other point. Looking at the PNG chunks as reported by the `pngchunks` tool, I see that the `IDAT` chunk appears to be off by one byte. The chunk before that is an `iTXt` chunk stating the creation date. It does so in a locale-dependent manner, and in my case that means using the German abbreviation for March, which is `M\u00e4r`. So I'd say JMol is counting UTF-16 code units when it should be counting UTF-8 code units. This is a bug in JMol, and probably can be reproduced at least this month by using a German locale.\n\nI'll try to see whether we can work around this issue by forcing the locale to C, like `LC_ALL=C` or some Java-specific analogon to this.",
    "created_at": "2015-03-12T18:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251830",
    "user": "https://github.com/gagern"
}
```

Replying to [ticket:17940 gagern]:
> Using strace I can see access to some `preview.png` and looking at that file I notice that it appears to be a regular PNG, concatenated with a Jmol script. So apparently two outputs ended up in the same data stream. This is likely a consequence of #17234.


It seems I was misled: apparently JMol attaching its script to the generated PNG is normal behavior. The PNG file is apparently broken at some other point. Looking at the PNG chunks as reported by the `pngchunks` tool, I see that the `IDAT` chunk appears to be off by one byte. The chunk before that is an `iTXt` chunk stating the creation date. It does so in a locale-dependent manner, and in my case that means using the German abbreviation for March, which is `MÃ¤r`. So I'd say JMol is counting UTF-16 code units when it should be counting UTF-8 code units. This is a bug in JMol, and probably can be reproduced at least this month by using a German locale.

I'll try to see whether we can work around this issue by forcing the locale to C, like `LC_ALL=C` or some Java-specific analogon to this.



---

archive/issue_comments_251831.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-12T19:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251831",
    "user": "https://github.com/gagern"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_251832.json:
```json
{
    "body": "<a id='comment:4'></a>Setting the locale to C works as expected.\n\n---\nNew commits:",
    "created_at": "2015-03-12T19:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251832",
    "user": "https://github.com/gagern"
}
```

<a id='comment:4'></a>Setting the locale to C works as expected.

---
New commits:



---

archive/issue_comments_251833.json:
```json
{
    "body": "<a id='comment:5'></a>Good detective job ;-)\n\nDid you report it upstream?",
    "created_at": "2015-03-12T19:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251833",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>Good detective job ;-)

Did you report it upstream?



---

archive/issue_comments_251834.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-12T19:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251834",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_251835.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 vbraun]:\n> Did you report it upstream?\n\n\nDid so now: https://sourceforge.net/p/jmol/bugs/570/",
    "created_at": "2015-03-12T20:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251835",
    "user": "https://github.com/gagern"
}
```

<a id='comment:6'></a>Replying to [comment:5 vbraun]:
> Did you report it upstream?


Did so now: https://sourceforge.net/p/jmol/bugs/570/



---

archive/issue_comments_251836.json:
```json
{
    "body": "<a id='comment:7'></a>A bug which happens only in March :-)\n\nThis should be added to the \"strange bug list\" together with #10609 and #12221.",
    "created_at": "2015-03-12T21:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251836",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>A bug which happens only in March :-)

This should be added to the "strange bug list" together with #10609 and #12221.



---

archive/issue_comments_251837.json:
```json
{
    "body": "Changing keywords from \"\" to \"strange\".",
    "created_at": "2015-03-12T21:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251837",
    "user": "https://github.com/gagern"
}
```

Changing keywords from "" to "strange".



---

archive/issue_comments_251838.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 jdemeyer]:\n> This should be added to the \"strange bug list\" together with #10609 and #12221.\n\n\nDone here, shoudl I do the others as well?",
    "created_at": "2015-03-12T21:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251838",
    "user": "https://github.com/gagern"
}
```

<a id='comment:8'></a>Replying to [comment:7 jdemeyer]:
> This should be added to the "strange bug list" together with #10609 and #12221.


Done here, shoudl I do the others as well?



---

archive/issue_comments_251839.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-03-12T23:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17940#issuecomment-251839",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_051050.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-03-12T23:06:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17940",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17940#event-51050"
}
```
