# Issue 17647: Branch and Bound for vertex separation

archive/issues_017410.json:
```json
{
    "body": "This patch implements a branch and bound algorithm for computing the vertex separation of directed graphs. It can be significantly faster than other methods already implemented. Furthermore, it can handle graphs with more than 31 vertices, but of course the computation time could be long.\n\n```\nsage: from sage.graphs.graph_decompositions import vertex_separation as VS\nsage: D = digraphs.RandomDirectedGNP(30,.1)\nsage: %time w,l = VS.vertex_separation(D); print w\n4\nCPU times: user 229 ms, sys: 345 ms, total: 574 ms\nWall time: 575 ms\nsage: %time w,l = VS.vertex_separation_BAB(D); print w\n4\nCPU times: user 1.34 ms, sys: 32 \u00b5s, total: 1.37 ms\nWall time: 1.35 ms\n```\n\nCC:  @nathanncohen\n\nBranch/Commit: dd12f60ede78325f58b166096778249820307e5d\n\nReviewer: Nathann Cohen\n\nAuthor: David Coudert\n\nDependencies: #17665\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17647\n\n",
    "closed_at": "2015-02-17T20:50:16Z",
    "created_at": "2015-01-17T10:43:32Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Branch and Bound for vertex separation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17647",
    "user": "https://github.com/dcoudert"
}
```
This patch implements a branch and bound algorithm for computing the vertex separation of directed graphs. It can be significantly faster than other methods already implemented. Furthermore, it can handle graphs with more than 31 vertices, but of course the computation time could be long.

```
sage: from sage.graphs.graph_decompositions import vertex_separation as VS
sage: D = digraphs.RandomDirectedGNP(30,.1)
sage: %time w,l = VS.vertex_separation(D); print w
4
CPU times: user 229 ms, sys: 345 ms, total: 574 ms
Wall time: 575 ms
sage: %time w,l = VS.vertex_separation_BAB(D); print w
4
CPU times: user 1.34 ms, sys: 32 µs, total: 1.37 ms
Wall time: 1.35 ms
```

CC:  @nathanncohen

Branch/Commit: dd12f60ede78325f58b166096778249820307e5d

Reviewer: Nathann Cohen

Author: David Coudert

Dependencies: #17665

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17647





---

archive/issue_comments_301665.json:
```json
{
    "body": "Changing branch from \"\" to \"u/dcoudert/17647\"",
    "created_at": "2015-01-17T18:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301665",
    "user": "https://github.com/dcoudert"
}
```

Changing branch from "" to "u/dcoudert/17647"



---

archive/issue_comments_301666.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2015-01-17T18:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301666",
    "user": "https://github.com/dcoudert"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_301667.json:
```json
{
    "body": "Changing branch from \"u/dcoudert/17647\" to \"public/17647\"",
    "created_at": "2015-01-17T18:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301667",
    "user": "https://github.com/dcoudert"
}
```

Changing branch from "u/dcoudert/17647" to "public/17647"



---

archive/issue_comments_301668.json:
```json
{
    "body": "Changing commit from \"\" to \"9b5f33e7a67218dda91bed304b5f3e2f276b389b\"",
    "created_at": "2015-01-17T19:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301668",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "9b5f33e7a67218dda91bed304b5f3e2f276b389b"



---

archive/issue_comments_301669.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-17T19:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301669",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301670.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-17T19:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301670",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_301671.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,14 @@\n-This patch implements a branch and bound algorithm for computing the vertex separation of directed graphs, and so the pathwidth of graphs.\n+This patch implements a branch and bound algorithm for computing the vertex separation of directed graphs. It can be significantly faster than other methods already implemented. Furthermore, it can handle graphs with more than 31 vertices, but of course the computation time could be long.\n+\n+```\n+sage: from sage.graphs.graph_decompositions import vertex_separation as VS\n+sage: D = digraphs.RandomDirectedGNP(30,.1)\n+sage: %time w,l = VS.vertex_separation(D); print w\n+4\n+CPU times: user 229 ms, sys: 345 ms, total: 574 ms\n+Wall time: 575 ms\n+sage: %time w,l = VS.vertex_separation_BAB(D); print w\n+4\n+CPU times: user 1.34 ms, sys: 32 \u00b5s, total: 1.37 ms\n+Wall time: 1.35 ms\n+```\n``````\n",
    "created_at": "2015-01-17T19:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301671",
    "user": "https://github.com/dcoudert"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,14 @@
-This patch implements a branch and bound algorithm for computing the vertex separation of directed graphs, and so the pathwidth of graphs.
+This patch implements a branch and bound algorithm for computing the vertex separation of directed graphs. It can be significantly faster than other methods already implemented. Furthermore, it can handle graphs with more than 31 vertices, but of course the computation time could be long.
+
+```
+sage: from sage.graphs.graph_decompositions import vertex_separation as VS
+sage: D = digraphs.RandomDirectedGNP(30,.1)
+sage: %time w,l = VS.vertex_separation(D); print w
+4
+CPU times: user 229 ms, sys: 345 ms, total: 574 ms
+Wall time: 575 ms
+sage: %time w,l = VS.vertex_separation_BAB(D); print w
+4
+CPU times: user 1.34 ms, sys: 32 µs, total: 1.37 ms
+Wall time: 1.35 ms
+```
``````




---

archive/issue_comments_301672.json:
```json
{
    "body": "<a id='comment:5'></a>A first question: you implement a graph data structure with bitsets... but what about using this instead?\n\nhttp://www.sagemath.org/doc/reference/graphs/sage/graphs/base/static_dense_graph.html\n\nNathann",
    "created_at": "2015-01-18T01:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301672",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'></a>A first question: you implement a graph data structure with bitsets... but what about using this instead?

http://www.sagemath.org/doc/reference/graphs/sage/graphs/base/static_dense_graph.html

Nathann



---

archive/issue_comments_301673.json:
```json
{
    "body": "<a id='comment:6'></a>The `binary_matrix_t` data structure encodes the neighborhood of a vertex using a specific bitset, that is without using the type `bitset_t`. Consequently, it is not easy to use the operations already implemented for `bitset_t` (union, intersection, difference, etc.) when using `binary_matrix_t`. I would have to encapsulate the rows into an instance of `bitset_t` before each operation. This is certainly doable. However, I don't know how `safe` it is to cast a `unsigned long *` into a `mp_limb_t*`. This is the main problem.",
    "created_at": "2015-01-18T08:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301673",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:6'></a>The `binary_matrix_t` data structure encodes the neighborhood of a vertex using a specific bitset, that is without using the type `bitset_t`. Consequently, it is not easy to use the operations already implemented for `bitset_t` (union, intersection, difference, etc.) when using `binary_matrix_t`. I would have to encapsulate the rows into an instance of `bitset_t` before each operation. This is certainly doable. However, I don't know how `safe` it is to cast a `unsigned long *` into a `mp_limb_t*`. This is the main problem.



---

archive/issue_comments_301674.json:
```json
{
    "body": "<a id='comment:7'></a>HMmmm... Agreed, but we can't keep on adding graph data structures in this graph_decomposition/ folder when we have a base/ directory where everything else is already.\n\nLet's not think about this now. I'll do a review first.",
    "created_at": "2015-01-18T08:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301674",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:7'></a>HMmmm... Agreed, but we can't keep on adding graph data structures in this graph_decomposition/ folder when we have a base/ directory where everything else is already.

Let's not think about this now. I'll do a review first.



---

archive/issue_comments_301675.json:
```json
{
    "body": "<a id='comment:8'></a>Actually, static dense graph is used only in `independent_sets.pyx`, right? and in this code, we can see many cast to `mp_limb_t*`.\nI think we could, in another patch, change the static dense graphs to use my data structure. This way we could clean the independent set code (remove all cast operations) and enable a direct access to bitset operations.",
    "created_at": "2015-01-18T08:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301675",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:8'></a>Actually, static dense graph is used only in `independent_sets.pyx`, right? and in this code, we can see many cast to `mp_limb_t*`.
I think we could, in another patch, change the static dense graphs to use my data structure. This way we could clean the independent set code (remove all cast operations) and enable a direct access to bitset operations.



---

archive/issue_comments_301676.json:
```json
{
    "body": "Changing commit from \"9b5f33e7a67218dda91bed304b5f3e2f276b389b\" to \"9aaf80ef0d8dea032d3cda04537fb8a42e1e3311\"",
    "created_at": "2015-01-22T08:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301676",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9b5f33e7a67218dda91bed304b5f3e2f276b389b" to "9aaf80ef0d8dea032d3cda04537fb8a42e1e3311"



---

archive/issue_comments_301677.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-22T08:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301677",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301678.json:
```json
{
    "body": "<a id='comment:10'></a>Hello David,\n\nHere are some superficial changes. It's faster to implement them than to write a long comment. Fix anything that you don't agree with.\n\nI am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?\n\nAlso, I did some profiling on your code and it seems that the most time-consuming operations is the call to popcount. I do not know where it is needed yet, but if you know how to work around that you would probably earn some perf.\n\nTell me what you think,\n\nNathann",
    "created_at": "2015-01-22T08:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301678",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>Hello David,

Here are some superficial changes. It's faster to implement them than to write a long comment. Fix anything that you don't agree with.

I am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?

Also, I did some profiling on your code and it seems that the most time-consuming operations is the call to popcount. I do not know where it is needed yet, but if you know how to work around that you would probably earn some perf.

Tell me what you think,

Nathann



---

archive/issue_comments_301679.json:
```json
{
    "body": "<a id='comment:11'></a>> Here are some superficial changes. It's faster to implement them than to write a long comment. Fix anything that you don't agree with.\nNice. I have just fixed a small typo.\n \n> I am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?\n\nI already though about it and I don't have a \"clean\" method to propose. I could for instance allocate one for all 5 arrays of n bitsets each and access to the bitsets of level *level* since the BAB has depth at most n. This way we avoid multiple allocations.\nIf you think it is OK, I can implement it.\n\n \n> Also, I did some profiling on your code and it seems that the most time-consuming operations is the call to popcount. I do not know where it is needed yet, but if you know how to work around that you would probably earn some perf.\n\nWhat's the magic commande to profile this code? %prun is not working here.\n\nThe speed of the `bitset_len` method depends on the system. Since patch #13352, we use the mpn methods for popcount which is expected to use `__builtin_popcount`. I don't know how fast it is on my laptop. I'll check as soon as you give me the magic command ;)\n\nThanks,\nDavid.",
    "created_at": "2015-01-22T09:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301679",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:11'></a>> Here are some superficial changes. It's faster to implement them than to write a long comment. Fix anything that you don't agree with.
Nice. I have just fixed a small typo.
 
> I am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?

I already though about it and I don't have a "clean" method to propose. I could for instance allocate one for all 5 arrays of n bitsets each and access to the bitsets of level *level* since the BAB has depth at most n. This way we avoid multiple allocations.
If you think it is OK, I can implement it.

 
> Also, I did some profiling on your code and it seems that the most time-consuming operations is the call to popcount. I do not know where it is needed yet, but if you know how to work around that you would probably earn some perf.

What's the magic commande to profile this code? %prun is not working here.

The speed of the `bitset_len` method depends on the system. Since patch #13352, we use the mpn methods for popcount which is expected to use `__builtin_popcount`. I don't know how fast it is on my laptop. I'll check as soon as you give me the magic command ;)

Thanks,
David.



---

archive/issue_comments_301680.json:
```json
{
    "body": "Changing commit from \"9aaf80ef0d8dea032d3cda04537fb8a42e1e3311\" to \"0504e8f1946309d9784c4837275c919b047f9829\"",
    "created_at": "2015-01-22T09:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301680",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9aaf80ef0d8dea032d3cda04537fb8a42e1e3311" to "0504e8f1946309d9784c4837275c919b047f9829"



---

archive/issue_comments_301681.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-22T09:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301681",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301682.json:
```json
{
    "body": "<a id='comment:13'></a>> Nice. I have just fixed a small typo.\n\n\nThanks\n\n> > I am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?\n\n> I already though about it and I don't have a \"clean\" method to propose. I could for instance allocate one for all 5 arrays of n bitsets each and access to the bitsets of level *level* since the BAB has depth at most n. This way we avoid multiple allocations.\n> If you think it is OK, I can implement it.\n\n\nUsing bitsets that would mean dozens of allocations lines again. What is it that you use in those fast digraphs of yours that are not in the 'binary matrix' type ? Possibly the best is to implement it there and use the binary matrices?\n\n> What's the magic commande to profile this code? %prun is not working here.\n\n\nRun a long command, then type 'perf top' in a console. You'll love it.\n\n> The speed of the `bitset_len` method depends on the system. Since patch #13352, we use the mpn methods for popcount which is expected to use `__builtin_popcount`. I don't know how fast it is on my laptop. I'll check as soon as you give me the magic command ;)\n\n\nI will probably write a \"profiling tutorial\" soon. It would be cool if you were willing to review it. That will be helpful, along with the \"interface C code with Sage\" tutorial.\n\nNathann",
    "created_at": "2015-01-22T10:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301682",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:13'></a>> Nice. I have just fixed a small typo.


Thanks

> > I am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?

> I already though about it and I don't have a "clean" method to propose. I could for instance allocate one for all 5 arrays of n bitsets each and access to the bitsets of level *level* since the BAB has depth at most n. This way we avoid multiple allocations.
> If you think it is OK, I can implement it.


Using bitsets that would mean dozens of allocations lines again. What is it that you use in those fast digraphs of yours that are not in the 'binary matrix' type ? Possibly the best is to implement it there and use the binary matrices?

> What's the magic commande to profile this code? %prun is not working here.


Run a long command, then type 'perf top' in a console. You'll love it.

> The speed of the `bitset_len` method depends on the system. Since patch #13352, we use the mpn methods for popcount which is expected to use `__builtin_popcount`. I don't know how fast it is on my laptop. I'll check as soon as you give me the magic command ;)


I will probably write a "profiling tutorial" soon. It would be cool if you were willing to review it. That will be helpful, along with the "interface C code with Sage" tutorial.

Nathann



---

archive/issue_comments_301683.json:
```json
{
    "body": "<a id='comment:14'></a>> > > I am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?\n\n> > I already though about it and I don't have a \"clean\" method to propose. I could for instance allocate one for all 5 arrays of n bitsets each and access to the bitsets of level *level* since the BAB has depth at most n. This way we avoid multiple allocations.\n> > If you think it is OK, I can implement it.\n\n> \n> Using bitsets that would mean dozens of allocations lines again.\n\n\nshould be something like that\n\n```\ncdef bitset_t * bitset_pool = <bitset_t *>sage_malloc(5 * n * sizeof(bitset_t))\nfor i from 0 <= i < 5*n:\n    bitset_init(bitset_pool[i], n)\n...\n...\nfor i from 0 <= i < 5*n:\n    bitset_free(bitset_pool[i])\nsage_free(bitset_pool)\n```\n\n \n> What is it that you use in those fast digraphs of yours that are not in the 'binary matrix' type ? Possibly the best is to implement it there and use the binary matrices?\n\n\nI'm using extensively `bitset_union, bitset_difference, bitset_discard, bitset_add, bitset_len, bitset_first`.\nWhat you propose is to recode what has already been properly implemented for bitsets into the binary matrix type. For instance, in module `static_dense_graph.pyx`, we have code like that:\n\n```\n            # The intersection of the common neighbors of i and j is a AND of\n            # their respective rows. A popcount then returns its cardinality.                  \n            inter = 0\n            for l in range(m.width):\n                inter += __builtin_popcountl(m.rows[i][l] & m.rows[j][l])\n```\n\nSeriously, it would be much cleaner to use bitsets for rows and to call `bitset_len`.\n\nAs I said previously, my suggestion is more to change the `static_dense_graph` data_structure to use directly `bitset_t` for rows. \n\n \n> > What's the magic commande to profile this code? %prun is not working here.\n\n> \n> Run a long command, then type 'perf top' in a console. You'll love it.\n\n\nDon't have it on OSX :(\n\n \n> > The speed of the `bitset_len` method depends on the system. Since patch #13352, we use the mpn methods for popcount which is expected to use `__builtin_popcount`. I don't know how fast it is on my laptop. I'll check as soon as you give me the magic command ;)\n\n> \n> I will probably write a \"profiling tutorial\" soon. It would be cool if you were willing to review it. That will be helpful, along with the \"interface C code with Sage\" tutorial.\n\nAccording some discussions on the mailing lists, we have some profiling experts that could be of more help than me. I can have a look anyway to tell if it is dummy's level ;)\n\nDavid.",
    "created_at": "2015-01-22T12:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301683",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:14'></a>> > > I am not done with the review, but I worry a bit about the fact that you allocate memory in a recursive function. They can cost a lot, these things. Do you see a clean way to avoid that ?

> > I already though about it and I don't have a "clean" method to propose. I could for instance allocate one for all 5 arrays of n bitsets each and access to the bitsets of level *level* since the BAB has depth at most n. This way we avoid multiple allocations.
> > If you think it is OK, I can implement it.

> 
> Using bitsets that would mean dozens of allocations lines again.


should be something like that

```
cdef bitset_t * bitset_pool = <bitset_t *>sage_malloc(5 * n * sizeof(bitset_t))
for i from 0 <= i < 5*n:
    bitset_init(bitset_pool[i], n)
...
...
for i from 0 <= i < 5*n:
    bitset_free(bitset_pool[i])
sage_free(bitset_pool)
```

 
> What is it that you use in those fast digraphs of yours that are not in the 'binary matrix' type ? Possibly the best is to implement it there and use the binary matrices?


I'm using extensively `bitset_union, bitset_difference, bitset_discard, bitset_add, bitset_len, bitset_first`.
What you propose is to recode what has already been properly implemented for bitsets into the binary matrix type. For instance, in module `static_dense_graph.pyx`, we have code like that:

```
            # The intersection of the common neighbors of i and j is a AND of
            # their respective rows. A popcount then returns its cardinality.                  
            inter = 0
            for l in range(m.width):
                inter += __builtin_popcountl(m.rows[i][l] & m.rows[j][l])
```

Seriously, it would be much cleaner to use bitsets for rows and to call `bitset_len`.

As I said previously, my suggestion is more to change the `static_dense_graph` data_structure to use directly `bitset_t` for rows. 

 
> > What's the magic commande to profile this code? %prun is not working here.

> 
> Run a long command, then type 'perf top' in a console. You'll love it.


Don't have it on OSX :(

 
> > The speed of the `bitset_len` method depends on the system. Since patch #13352, we use the mpn methods for popcount which is expected to use `__builtin_popcount`. I don't know how fast it is on my laptop. I'll check as soon as you give me the magic command ;)

> 
> I will probably write a "profiling tutorial" soon. It would be cool if you were willing to review it. That will be helpful, along with the "interface C code with Sage" tutorial.

According some discussions on the mailing lists, we have some profiling experts that could be of more help than me. I can have a look anyway to tell if it is dummy's level ;)

David.



---

archive/issue_comments_301684.json:
```json
{
    "body": "<a id='comment:15'></a>> should be something like that\n> \n> ```\n> cdef bitset_t * bitset_pool = <bitset_t *>sage_malloc(5 * n * sizeof(bitset_t))\n> for i from 0 <= i < 5*n:\n>     bitset_init(bitset_pool[i], n)\n> ...\n> ...\n> for i from 0 <= i < 5*n:\n>     bitset_free(bitset_pool[i])\n> sage_free(bitset_pool)\n> ```\n\n\nIn a design like that there is a problem if some `bitset_init` fails. But well. Yeah, then it would probably be cleaner anyway. Good idea.\n\n> {{{\n>             # The intersection of the common neighbors of i and j is a AND of\n>             # their respective rows. A popcount then returns its cardinality.                  \n>             inter = 0\n>             for l in range(m.width):\n>                 inter += __builtin_popcountl(m.rows[i][l] & m.rows[j][l])\n> }}}\n> \n> Seriously, it would be much cleaner to use bitsets for rows and to call `bitset_len`.\n\n\nWith bitsets you cannot do this very computation without allocating a third bitset. \n\nOkay, let's say that it is not important: could you turn/extend your `fast_digraph` into a bitset matrix ? You can overwrite the current one if you like, nobody but me uses it anyway. This way it would work with bitsets, and you could allocate this matrix of bitsets in one instruction without having to handle the memory allocation problems in your branch and bound code.\n\n> As I said previously, my suggestion is more to change the `static_dense_graph` data_structure to use directly `bitset_t` for rows.\n\n\nWe agree if you actually talk of changing the 'binary_matrix' type, which is then used by the static dense graph stuff.\n\n> > Run a long command, then type 'perf top' in a console. You'll love it.\n\n> \n> Don't have it on OSX :(\n\n\n`O_o`\n\nTry it on a real machine. That will give you a reason to install some real OS `:-P`\n\n> According some discussions on the mailing lists, we have some profiling experts that could be of more help than me. I can have a look anyway to tell if it is dummy's level ;)\n\n\nThe problem with 'profiling experts' is that they don't review those patches, and if nobody does it everybody loses.\n\nNathann",
    "created_at": "2015-01-22T15:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301684",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:15'></a>> should be something like that
> 
> ```
> cdef bitset_t * bitset_pool = <bitset_t *>sage_malloc(5 * n * sizeof(bitset_t))
> for i from 0 <= i < 5*n:
>     bitset_init(bitset_pool[i], n)
> ...
> ...
> for i from 0 <= i < 5*n:
>     bitset_free(bitset_pool[i])
> sage_free(bitset_pool)
> ```


In a design like that there is a problem if some `bitset_init` fails. But well. Yeah, then it would probably be cleaner anyway. Good idea.

> {{{
>             # The intersection of the common neighbors of i and j is a AND of
>             # their respective rows. A popcount then returns its cardinality.                  
>             inter = 0
>             for l in range(m.width):
>                 inter += __builtin_popcountl(m.rows[i][l] & m.rows[j][l])
> }}}
> 
> Seriously, it would be much cleaner to use bitsets for rows and to call `bitset_len`.


With bitsets you cannot do this very computation without allocating a third bitset. 

Okay, let's say that it is not important: could you turn/extend your `fast_digraph` into a bitset matrix ? You can overwrite the current one if you like, nobody but me uses it anyway. This way it would work with bitsets, and you could allocate this matrix of bitsets in one instruction without having to handle the memory allocation problems in your branch and bound code.

> As I said previously, my suggestion is more to change the `static_dense_graph` data_structure to use directly `bitset_t` for rows.


We agree if you actually talk of changing the 'binary_matrix' type, which is then used by the static dense graph stuff.

> > Run a long command, then type 'perf top' in a console. You'll love it.

> 
> Don't have it on OSX :(


`O_o`

Try it on a real machine. That will give you a reason to install some real OS `:-P`

> According some discussions on the mailing lists, we have some profiling experts that could be of more help than me. I can have a look anyway to tell if it is dummy's level ;)


The problem with 'profiling experts' is that they don't review those patches, and if nobody does it everybody loses.

Nathann



---

archive/issue_comments_301685.json:
```json
{
    "body": "Changing commit from \"0504e8f1946309d9784c4837275c919b047f9829\" to \"fdef6749dd23929f9903937a82c11e52ea7ddb28\"",
    "created_at": "2015-01-22T18:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301685",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0504e8f1946309d9784c4837275c919b047f9829" to "fdef6749dd23929f9903937a82c11e52ea7ddb28"



---

archive/issue_comments_301686.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-22T18:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301686",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301687.json:
```json
{
    "body": "<a id='comment:17'></a>Hello,\n\nI'm now using a pool of bitsets. I add to use type `bitset_s *`, but it's working and indeed a bit faster (try with G = graphs.MycielskiGraph(5)).\n\nAbout changing the `static_dense_graph` structure to use directly bitsets, should I do it in this patch or in another patch? \n\nIt's a pitty I don't have this perf top command on mac. In fact it is not installed on my linux desktop :(\n\nBest,\nDavid.",
    "created_at": "2015-01-22T18:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301687",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:17'></a>Hello,

I'm now using a pool of bitsets. I add to use type `bitset_s *`, but it's working and indeed a bit faster (try with G = graphs.MycielskiGraph(5)).

About changing the `static_dense_graph` structure to use directly bitsets, should I do it in this patch or in another patch? 

It's a pitty I don't have this perf top command on mac. In fact it is not installed on my linux desktop :(

Best,
David.



---

archive/issue_comments_301688.json:
```json
{
    "body": "<a id='comment:18'></a>Hello,\n\n> I'm now using a pool of bitsets. I add to use type `bitset_s *`, but it's working and indeed a bit faster (try with G = graphs.MycielskiGraph(5)).\n\n\nGood news !\n\n> About changing the `static_dense_graph` structure to use directly bitsets, should I do it in this patch or in another patch? \n\n\nCould you do it in another patch, then rebase this ticket on top of it ? This way we will not have to discuss code that will be changed afterwards.\n\n> It's a pitty I don't have this perf top command on mac. In fact it is not installed on my linux desktop :(\n\n\nDid you try it on a linux machine ? It really tells you all you want to know.\n\nNathann",
    "created_at": "2015-01-23T11:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301688",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:18'></a>Hello,

> I'm now using a pool of bitsets. I add to use type `bitset_s *`, but it's working and indeed a bit faster (try with G = graphs.MycielskiGraph(5)).


Good news !

> About changing the `static_dense_graph` structure to use directly bitsets, should I do it in this patch or in another patch? 


Could you do it in another patch, then rebase this ticket on top of it ? This way we will not have to discuss code that will be changed afterwards.

> It's a pitty I don't have this perf top command on mac. In fact it is not installed on my linux desktop :(


Did you try it on a linux machine ? It really tells you all you want to know.

Nathann



---

archive/issue_comments_301689.json:
```json
{
    "body": "<a id='comment:19'></a>> > About changing the `static_dense_graph` structure to use directly bitsets, should I do it in this patch or in another patch? \n\n> \n> Could you do it in another patch, then rebase this ticket on top of it ? This way we will not have to discuss code that will be changed afterwards.\n\n\nOK, I will work on it.\nI will certainly need your help to understand the procedure to \"rebase this ticket on top of the other one\" ;) \n\n \n> > It's a pitty I don't have this perf top command on mac. In fact it is not installed on my linux desktop :(\n\n> \n> Did you try it on a linux machine ? It really tells you all you want to know.\n\n\nI don't have it installed on my linux desktop(s), and since I don't know the package name, yum returns me hundreds of possible packaged containing the keyword \"perf\".\n\nD.",
    "created_at": "2015-01-23T13:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301689",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:19'></a>> > About changing the `static_dense_graph` structure to use directly bitsets, should I do it in this patch or in another patch? 

> 
> Could you do it in another patch, then rebase this ticket on top of it ? This way we will not have to discuss code that will be changed afterwards.


OK, I will work on it.
I will certainly need your help to understand the procedure to "rebase this ticket on top of the other one" ;) 

 
> > It's a pitty I don't have this perf top command on mac. In fact it is not installed on my linux desktop :(

> 
> Did you try it on a linux machine ? It really tells you all you want to know.


I don't have it installed on my linux desktop(s), and since I don't know the package name, yum returns me hundreds of possible packaged containing the keyword "perf".

D.



---

archive/issue_comments_301690.json:
```json
{
    "body": "<a id='comment:20'></a>Yo!\n\n> OK, I will work on it.\n> I will certainly need your help to understand the procedure to \"rebase this ticket on top of the other one\" ;) \n\n\nEasy. Let us say that this ticket is a branch A. Once the other branch will be written, name it B.\n\ngit checkout A\ngit rebase -i B\n\nAfter this your branch A will be above B.\n\n> I don't have it installed on my linux desktop(s), and since I don't know the package name, yum returns me hundreds of possible packaged containing the keyword \"perf\".\n\n\nIn debian it is in the package linux-tools.\n\nNathann",
    "created_at": "2015-01-23T14:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301690",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:20'></a>Yo!

> OK, I will work on it.
> I will certainly need your help to understand the procedure to "rebase this ticket on top of the other one" ;) 


Easy. Let us say that this ticket is a branch A. Once the other branch will be written, name it B.

git checkout A
git rebase -i B

After this your branch A will be above B.

> I don't have it installed on my linux desktop(s), and since I don't know the package name, yum returns me hundreds of possible packaged containing the keyword "perf".


In debian it is in the package linux-tools.

Nathann



---

archive/issue_comments_301691.json:
```json
{
    "body": "Changing commit from \"fdef6749dd23929f9903937a82c11e52ea7ddb28\" to \"2ad04bc49191f533041f095284a8a6ae29ab8f69\"",
    "created_at": "2015-01-27T16:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301691",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fdef6749dd23929f9903937a82c11e52ea7ddb28" to "2ad04bc49191f533041f095284a8a6ae29ab8f69"



---

archive/issue_comments_301692.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-01-27T16:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301692",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_301693.json:
```json
{
    "body": "<a id='comment:22'></a>Nathann,\n\nI tried to do what you proposed. I don't know if the result is correct or not with regards git.\nIf it is not the case, please help me going back to the state before the rebase.\n\nI should certainly add a dependency with ticket #17665, right?\n\nDavid.",
    "created_at": "2015-01-27T16:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301693",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:22'></a>Nathann,

I tried to do what you proposed. I don't know if the result is correct or not with regards git.
If it is not the case, please help me going back to the state before the rebase.

I should certainly add a dependency with ticket #17665, right?

David.



---

archive/issue_comments_301694.json:
```json
{
    "body": "<a id='comment:23'></a>Hello,\n\n> I tried to do what you proposed. I don't know if the result is correct or not with regards git.\n\n\nIt is not. If you click on 'commits' right next to the branch, you will see that some commits appear twice (like 'trac #17647: small typo')\n\n> If it is not the case, please help me going back to the state before the rebase.\n\n\nIt is very difficult for me to tell you what to do now, considering that I have no idea how you ended up with this branch in the first place. It seems that all you did wrong was to merge two branches together in the end (you merged a branch with a copy of that branch, apparently). So I would say that all you need to do is to go back before that happened, i.e.:\n\n```\ngit checkout 30f80f1c4158b512310cde25b32d311a92220e2e # go back to 'trac #17647: rebase on 17665 to use binary_matrix'\ngit push trac HEAD:public/17647 -f # update the distant branch\n```\n\nPlease double-check that, for it will erase commits from the trac server.\n\n> I should certainly add a dependency with ticket #17665, right?\n\n\nYes.\n\nNathann",
    "created_at": "2015-01-27T17:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301694",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:23'></a>Hello,

> I tried to do what you proposed. I don't know if the result is correct or not with regards git.


It is not. If you click on 'commits' right next to the branch, you will see that some commits appear twice (like 'trac #17647: small typo')

> If it is not the case, please help me going back to the state before the rebase.


It is very difficult for me to tell you what to do now, considering that I have no idea how you ended up with this branch in the first place. It seems that all you did wrong was to merge two branches together in the end (you merged a branch with a copy of that branch, apparently). So I would say that all you need to do is to go back before that happened, i.e.:

```
git checkout 30f80f1c4158b512310cde25b32d311a92220e2e # go back to 'trac #17647: rebase on 17665 to use binary_matrix'
git push trac HEAD:public/17647 -f # update the distant branch
```

Please double-check that, for it will erase commits from the trac server.

> I should certainly add a dependency with ticket #17665, right?


Yes.

Nathann



---

archive/issue_comments_301695.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-01-27T17:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301695",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301696.json:
```json
{
    "body": "Changing commit from \"2ad04bc49191f533041f095284a8a6ae29ab8f69\" to \"30f80f1c4158b512310cde25b32d311a92220e2e\"",
    "created_at": "2015-01-27T17:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301696",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2ad04bc49191f533041f095284a8a6ae29ab8f69" to "30f80f1c4158b512310cde25b32d311a92220e2e"



---

archive/issue_comments_301697.json:
```json
{
    "body": "<a id='comment:25'></a>Apparently it works. Thanks.",
    "created_at": "2015-01-27T17:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301697",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:25'></a>Apparently it works. Thanks.



---

archive/issue_comments_301698.json:
```json
{
    "body": "Changing dependencies from \"\" to \"17665\"",
    "created_at": "2015-01-27T17:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301698",
    "user": "https://github.com/dcoudert"
}
```

Changing dependencies from "" to "17665"



---

archive/issue_comments_301699.json:
```json
{
    "body": "Changing dependencies from \"17665\" to \"#17665\"",
    "created_at": "2015-01-27T17:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301699",
    "user": "https://github.com/dcoudert"
}
```

Changing dependencies from "17665" to "#17665"



---

archive/issue_comments_301700.json:
```json
{
    "body": "<a id='comment:27'></a>Given that this branch contains many commits (some of which undo what is done by the previous ones), I merged them all into one, available at public/17647b.\n\nNathann",
    "created_at": "2015-01-28T10:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301700",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:27'></a>Given that this branch contains many commits (some of which undo what is done by the previous ones), I merged them all into one, available at public/17647b.

Nathann



---

archive/issue_comments_301701.json:
```json
{
    "body": "<a id='comment:28'></a>Shouldn't you change the branch name in the ticket?",
    "created_at": "2015-01-28T12:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301701",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:28'></a>Shouldn't you change the branch name in the ticket?



---

archive/issue_comments_301702.json:
```json
{
    "body": "Changing branch from \"public/17647\" to \"public/17647b\"",
    "created_at": "2015-01-28T12:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301702",
    "user": "https://github.com/nathanncohen"
}
```

Changing branch from "public/17647" to "public/17647b"



---

archive/issue_comments_301703.json:
```json
{
    "body": "Changing commit from \"30f80f1c4158b512310cde25b32d311a92220e2e\" to \"fdf3c001ccf9deb6fba3653532f762f4c7c39788\"",
    "created_at": "2015-01-28T12:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301703",
    "user": "https://github.com/nathanncohen"
}
```

Changing commit from "30f80f1c4158b512310cde25b32d311a92220e2e" to "fdf3c001ccf9deb6fba3653532f762f4c7c39788"



---

archive/issue_comments_301704.json:
```json
{
    "body": "<a id='comment:29'></a>> Shouldn't you change the branch name in the ticket?\n\n\nWell, I usually let the author do that if he likes the idea `^^;`\n\nNathann\n\n---\nNew commits:",
    "created_at": "2015-01-28T12:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301704",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:29'></a>> Shouldn't you change the branch name in the ticket?


Well, I usually let the author do that if he likes the idea `^^;`

Nathann

---
New commits:



---

archive/issue_comments_301705.json:
```json
{
    "body": "<a id='comment:30'></a>If it's more \"clean\", I like the idea ;)\nThanks.",
    "created_at": "2015-01-28T12:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301705",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:30'></a>If it's more "clean", I like the idea ;)
Thanks.



---

archive/issue_comments_301706.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-01-28T16:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301706",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_301707.json:
```json
{
    "body": "<a id='comment:31'></a>Hello!\n\nA first pass:\n\n- Some modifications that you did to the header of `fast_digraph.pyx` should be\n  undone now that you use `binary_matrix`.\n\n- I do not know whether `positions` is actually needed in this code, but I still\n  do not understand it totally. It seems that you enumerate all permutations,\n  cutting branches from time to time: the code is in its principle very similar\n  from the bandwidth code that was recently included. That code does not need\n  such an array: do you think that it could also be removed from here?\n\n- in `_my_invert_positions`: you cannot in C, but in Cython you can do\n  `a,b=b,a`.\n\n- ``best_seq`` has no reason to be a C array. If you turn it into a Python list,\n  you will remove several lines of alloc/dealloc code.\n\n- Not worth changing it now, but try to use `:class:`class_name`` instead of\n  ```class_name``` in the doc.\n\n- Can you document the parameters taken by `vertex_separation_BAB_C` ? `bm_pool`\n  is not that self-explaining (what are its dimensions? its role?)\n\n- Do you really need both `current_prefix` and `current_other`? They seem to be\n  the complement of each other at all times.\n\n- What about removing \"current\" from\n  `loc_b_current_prefix,loc_b_current_neighborhood,loc_b_current_other,b_current_prefix,b_current_neighborhood,b_current_other,current_prefix`?\n  It seems to me that `b_prefix, b_prefix_neighborhood`, `b_nonprefix` would be\n  equally meaningful and 'lighter' to read?\n\n- It seems that `current_cost` is the cost of `best_seq`. What about\n  `best_cost`?\n\n- `order = [int_to_vertex[best_seq[i]] for i in range(n)]` is better than\n\n```\ncdef list order = list()\nfor 0 <= i < n:\n   order.append(int_to_vertex[best_seq[i]])\n```\n\n- Instead of `somemore`, use a `break` if `select_it is False`.\n\nNathann",
    "created_at": "2015-01-28T16:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301707",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:31'></a>Hello!

A first pass:

- Some modifications that you did to the header of `fast_digraph.pyx` should be
  undone now that you use `binary_matrix`.

- I do not know whether `positions` is actually needed in this code, but I still
  do not understand it totally. It seems that you enumerate all permutations,
  cutting branches from time to time: the code is in its principle very similar
  from the bandwidth code that was recently included. That code does not need
  such an array: do you think that it could also be removed from here?

- in `_my_invert_positions`: you cannot in C, but in Cython you can do
  `a,b=b,a`.

- ``best_seq`` has no reason to be a C array. If you turn it into a Python list,
  you will remove several lines of alloc/dealloc code.

- Not worth changing it now, but try to use `:class:`class_name`` instead of
  ```class_name``` in the doc.

- Can you document the parameters taken by `vertex_separation_BAB_C` ? `bm_pool`
  is not that self-explaining (what are its dimensions? its role?)

- Do you really need both `current_prefix` and `current_other`? They seem to be
  the complement of each other at all times.

- What about removing "current" from
  `loc_b_current_prefix,loc_b_current_neighborhood,loc_b_current_other,b_current_prefix,b_current_neighborhood,b_current_other,current_prefix`?
  It seems to me that `b_prefix, b_prefix_neighborhood`, `b_nonprefix` would be
  equally meaningful and 'lighter' to read?

- It seems that `current_cost` is the cost of `best_seq`. What about
  `best_cost`?

- `order = [int_to_vertex[best_seq[i]] for i in range(n)]` is better than

```
cdef list order = list()
for 0 <= i < n:
   order.append(int_to_vertex[best_seq[i]])
```

- Instead of `somemore`, use a `break` if `select_it is False`.

Nathann



---

archive/issue_comments_301708.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [ncohen](#comment%3A31):\n> Hello!\n> \n> A first pass:\n> \n> - Some modifications that you did to the header of `fast_digraph.pyx` should be\n>   undone now that you use `binary_matrix`.\n \ndone\n  \n> - I do not know whether `positions` is actually needed in this code, but I still\n>   do not understand it totally. It seems that you enumerate all permutations,\n>   cutting branches from time to time: the code is in its principle very similar\n>   from the bandwidth code that was recently included. That code does not need\n>   such an array: do you think that it could also be removed from here?\n \nI don't see how.\nThis code is different from the `bandwidth` one because I have the greedy steps. \nUsing the `positions` array, I know exactly where are the vertices in the array `current_prefix` (now `prefix`). This way I don't have to undo the permutations when I track back or after a recursive call.\nSo yes it is possible to get rid of this array, but the price is to undo all permutations which is particularly painful with the greedy steps.\nI definitively prefer my solution.\n\n \n> - in `_my_invert_positions`: you cannot in C, but in Cython you can do\n>   `a,b=b,a`.\n \nI don't see how to use it here.\n\n> - ``best_seq`` has no reason to be a C array. If you turn it into a Python list,\n>   you will remove several lines of alloc/dealloc code.\n \nBut if it is a Python list, method `vertex_separation_BAB_C` has to return both the value and that list. How would that be more efficient than passing a pointer and updating the content of the array when needed ?\n\n \n> - Not worth changing it now, but try to use `:class:`class_name`` instead of\n>   ```class_name``` in the doc.\n> \n> - Can you document the parameters taken by `vertex_separation_BAB_C` ? `bm_pool`\n>   is not that self-explaining (what are its dimensions? its role?)\n \nI added some documentation. Let me know if it is enough.\n \n> - Do you really need both `current_prefix` and `current_other`? They seem to be\n>   the complement of each other at all times.\n \nRight, `current_other` is not used at all. Removed.\n\n \n> - What about removing \"current\" from\n>   `loc_b_current_prefix,loc_b_current_neighborhood,loc_b_current_other,b_current_prefix,b_current_neighborhood,b_current_other,current_prefix`?\n>   It seems to me that `b_prefix, b_prefix_neighborhood`, `b_nonprefix` would be\n>   equally meaningful and 'lighter' to read?\n \nI have remove `current_` from many variables.\n\n  \n> - It seems that `current_cost` is the cost of `best_seq`. What about\n>   `best_cost`?\n \n`current_cost`is the cost of the current prefix. Therefore, I think the name is appropriate.\n\n \n> - `order = [int_to_vertex[best_seq[i]] for i in range(n)]` is better than\n> \n> \n> ```\n> cdef list order = list()\n> for 0 <= i < n:\n>    order.append(int_to_vertex[best_seq[i]])\n> ```\n\nChanged\n \n \n> - Instead of `somemore`, use a `break` if `select_it is False`.\n \nI had to find another way since I had a for loop inside a while loop. Furthermore, the condition `if select_it is False then break` is incorrect in this case.\nNow I have removed the for loop and I only have the while without break.\n \n\nThanks,\nDavid.",
    "created_at": "2015-01-28T19:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301708",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:32'></a>Replying to [ncohen](#comment%3A31):
> Hello!
> 
> A first pass:
> 
> - Some modifications that you did to the header of `fast_digraph.pyx` should be
>   undone now that you use `binary_matrix`.
 
done
  
> - I do not know whether `positions` is actually needed in this code, but I still
>   do not understand it totally. It seems that you enumerate all permutations,
>   cutting branches from time to time: the code is in its principle very similar
>   from the bandwidth code that was recently included. That code does not need
>   such an array: do you think that it could also be removed from here?
 
I don't see how.
This code is different from the `bandwidth` one because I have the greedy steps. 
Using the `positions` array, I know exactly where are the vertices in the array `current_prefix` (now `prefix`). This way I don't have to undo the permutations when I track back or after a recursive call.
So yes it is possible to get rid of this array, but the price is to undo all permutations which is particularly painful with the greedy steps.
I definitively prefer my solution.

 
> - in `_my_invert_positions`: you cannot in C, but in Cython you can do
>   `a,b=b,a`.
 
I don't see how to use it here.

> - ``best_seq`` has no reason to be a C array. If you turn it into a Python list,
>   you will remove several lines of alloc/dealloc code.
 
But if it is a Python list, method `vertex_separation_BAB_C` has to return both the value and that list. How would that be more efficient than passing a pointer and updating the content of the array when needed ?

 
> - Not worth changing it now, but try to use `:class:`class_name`` instead of
>   ```class_name``` in the doc.
> 
> - Can you document the parameters taken by `vertex_separation_BAB_C` ? `bm_pool`
>   is not that self-explaining (what are its dimensions? its role?)
 
I added some documentation. Let me know if it is enough.
 
> - Do you really need both `current_prefix` and `current_other`? They seem to be
>   the complement of each other at all times.
 
Right, `current_other` is not used at all. Removed.

 
> - What about removing "current" from
>   `loc_b_current_prefix,loc_b_current_neighborhood,loc_b_current_other,b_current_prefix,b_current_neighborhood,b_current_other,current_prefix`?
>   It seems to me that `b_prefix, b_prefix_neighborhood`, `b_nonprefix` would be
>   equally meaningful and 'lighter' to read?
 
I have remove `current_` from many variables.

  
> - It seems that `current_cost` is the cost of `best_seq`. What about
>   `best_cost`?
 
`current_cost`is the cost of the current prefix. Therefore, I think the name is appropriate.

 
> - `order = [int_to_vertex[best_seq[i]] for i in range(n)]` is better than
> 
> 
> ```
> cdef list order = list()
> for 0 <= i < n:
>    order.append(int_to_vertex[best_seq[i]])
> ```

Changed
 
 
> - Instead of `somemore`, use a `break` if `select_it is False`.
 
I had to find another way since I had a for loop inside a while loop. Furthermore, the condition `if select_it is False then break` is incorrect in this case.
Now I have removed the for loop and I only have the while without break.
 

Thanks,
David.



---

archive/issue_comments_301709.json:
```json
{
    "body": "Changing commit from \"fdf3c001ccf9deb6fba3653532f762f4c7c39788\" to \"fdfe120bc438b041a7ff480a288f29d6c73b17e5\"",
    "created_at": "2015-01-28T19:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301709",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fdf3c001ccf9deb6fba3653532f762f4c7c39788" to "fdfe120bc438b041a7ff480a288f29d6c73b17e5"



---

archive/issue_comments_301710.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-28T19:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301710",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301711.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-28T19:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301711",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_301712.json:
```json
{
    "body": "<a id='comment:35'></a>Hello,\n\n> > - in `_my_invert_positions`: you cannot in C, but in Cython you can do\n> >   `a,b=b,a`.\n \n> I don't see how to use it here.\n\n```\nsource_pos = positions[i]\nj = prefix[target_pos]\nprefix[target_pos],prefix[source_pos] = prefix[source_pos], prefix[target_pos]\npositions[i],positions[j] = positions[j],positions[i]\n```\n\nIt could be made simpler if the code of `_my_invert_positions` was taking two positions (or two vertices) as argument instead of 'one of each type'.\n\n> But if it is a Python list, method `vertex_separation_BAB_C` has to return both the value and that list. \n\n\n```\ne = [1,2,3]\ndef invert_two_entries(l):\n   l[0],l[1] = l[1],l[0]\ninvert_two_entries(e)\nprint e # prints [2, 1, 3]\n```\n\n> How would that be more efficient than passing a pointer and updating the content of the array when needed ?\n\n\nIt is not about efficiency, it is about not allocating/deallocating something if it can be avoided. This table is updated very rarely, so it does not have to be a C array.\n\n> Now I have removed the for loop and I only have the while without break.\n\n\nGreat! I'll resume the review.\n\nNathann",
    "created_at": "2015-01-29T14:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301712",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:35'></a>Hello,

> > - in `_my_invert_positions`: you cannot in C, but in Cython you can do
> >   `a,b=b,a`.
 
> I don't see how to use it here.

```
source_pos = positions[i]
j = prefix[target_pos]
prefix[target_pos],prefix[source_pos] = prefix[source_pos], prefix[target_pos]
positions[i],positions[j] = positions[j],positions[i]
```

It could be made simpler if the code of `_my_invert_positions` was taking two positions (or two vertices) as argument instead of 'one of each type'.

> But if it is a Python list, method `vertex_separation_BAB_C` has to return both the value and that list. 


```
e = [1,2,3]
def invert_two_entries(l):
   l[0],l[1] = l[1],l[0]
invert_two_entries(e)
print e # prints [2, 1, 3]
```

> How would that be more efficient than passing a pointer and updating the content of the array when needed ?


It is not about efficiency, it is about not allocating/deallocating something if it can be avoided. This table is updated very rarely, so it does not have to be a C array.

> Now I have removed the for loop and I only have the while without break.


Great! I'll resume the review.

Nathann



---

archive/issue_comments_301713.json:
```json
{
    "body": "<a id='comment:36'></a>Helloooooo again,\n\n- What is the purpose of `lower_bound`? The documentation says that the code is\n  trying to find an ordering whose cost is *lower* than `lower_bound`? On what\n  exactly is it a lower bound?\n\n  Do you mean that the code will \"return any ordering whose cost is lower than\n  `lower_bound`, even if it has no proof that it is optimal?\n\n- Do you think that you actually need `loc_b_neighborhood`? It feels like all\n  you need is what you store in `bits_tmp`, i.e. the union of the prefix and the\n  neighborhood. And you could drop one of your two tmp bitets.\n\n- Are those two lines needed?\n\n```\ndelta_i = max(current_cost, delta_i)\nif delta_i < upper_bound:\n```\n\n  It seems that you can already suppose that `current_cost<upper_bound`, and you\n  checked several lines above that `delta_i < upper_bound`.\n\n- I do not agree with this comment\n\n```\nif upper_bound <= lower_bound:\n  # Either we have optimal solution, or we are satisfied with\n  # current solution.\n```\n\n  it seems that this code only deals with the case when 'we are satisfied with\n  the current solution'.\n\n- Is there any reason why you did not expose your function in the main\n  `vertex_separation` function? If you do, is there any reason why it should not\n  be the default one? (if it is faster?..). Finally, note that if you do make it\n  the default some doctests of your functions will have to be updated, as you\n  would be comparing the BAB function with `vertex_separation` (which would also\n  call the BAB).\n\nWith those comments and those from my previous message, I would say that my\nreview is finished. We only have to settle those last remarks.\n\nThanks for your work!\n\nNathann",
    "created_at": "2015-01-29T15:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301713",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:36'></a>Helloooooo again,

- What is the purpose of `lower_bound`? The documentation says that the code is
  trying to find an ordering whose cost is *lower* than `lower_bound`? On what
  exactly is it a lower bound?

  Do you mean that the code will "return any ordering whose cost is lower than
  `lower_bound`, even if it has no proof that it is optimal?

- Do you think that you actually need `loc_b_neighborhood`? It feels like all
  you need is what you store in `bits_tmp`, i.e. the union of the prefix and the
  neighborhood. And you could drop one of your two tmp bitets.

- Are those two lines needed?

```
delta_i = max(current_cost, delta_i)
if delta_i < upper_bound:
```

  It seems that you can already suppose that `current_cost<upper_bound`, and you
  checked several lines above that `delta_i < upper_bound`.

- I do not agree with this comment

```
if upper_bound <= lower_bound:
  # Either we have optimal solution, or we are satisfied with
  # current solution.
```

  it seems that this code only deals with the case when 'we are satisfied with
  the current solution'.

- Is there any reason why you did not expose your function in the main
  `vertex_separation` function? If you do, is there any reason why it should not
  be the default one? (if it is faster?..). Finally, note that if you do make it
  the default some doctests of your functions will have to be updated, as you
  would be comparing the BAB function with `vertex_separation` (which would also
  call the BAB).

With those comments and those from my previous message, I would say that my
review is finished. We only have to settle those last remarks.

Thanks for your work!

Nathann



---

archive/issue_comments_301714.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-01-29T15:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301714",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_301715.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [ncohen](#comment%3A35):\n> Hello,\n> \n> > > - in `_my_invert_positions`: you cannot in C, but in Cython you can do\n> > >   `a,b=b,a`.\n \n> > I don't see how to use it here.\n> {{{\n> source_pos = positions[i]\n> j = prefix[target_pos]\n> prefix[target_pos],prefix[source_pos] = prefix[source_pos], prefix[target_pos]\n> positions[i],positions[j] = positions[j],positions[i]\n> }}}\n> \n> It could be made simpler if the code of `_my_invert_positions` was taking two positions (or two vertices) as argument instead of 'one of each type'.\n\nI have change the method and updated calls to it.\n\n \n> > But if it is a Python list, method `vertex_separation_BAB_C` has to return both the value and that list. \n\n> \n> {{{\n> e = [1,2,3]\n> def invert_two_entries(l):\n>    l[0],l[1] = l[1],l[0]\n> invert_two_entries(e)\n> print e # prints [2, 1, 3]\n> }}}\n> \n> > How would that be more efficient than passing a pointer and updating the content of the array when needed ?\n\n> \n> It is not about efficiency, it is about not allocating/deallocating something if it can be avoided. This table is updated very rarely, so it does not have to be a C array.\n\nApparently your care a lot about reducing mallocs.\n\nI changed it.\n \nReplying to [ncohen](#comment%3A36):\n> Helloooooo again,\n> \n> - What is the purpose of `lower_bound`? The documentation says that the code is\n>   trying to find an ordering whose cost is *lower* than `lower_bound`? On what\n>   exactly is it a lower bound?\n> \n>   Do you mean that the code will \"return any ordering whose cost is lower than\n>   `lower_bound`, even if it has no proof that it is optimal?\n \nExactly.\nWith parameter `upper_bound`, you ask for a solution with width less than `upper_bound` if such a solution exists.\nWith parameter `lower_bound`, you say that you are satisfied with any solution with width less than this bound. This is useful in particular when you split the input digraph into strongly connected components and solve the problem on each of them. If one component has width `k`, you don't care if another component has width `k-1` since you know that the vertex separation of the entire digraph is at least `k`.\n\nThis will be useful when we will start adding pre-processing.\n\n \n> - Do you think that you actually need `loc_b_neighborhood`? It feels like all\n>   you need is what you store in `bits_tmp`, i.e. the union of the prefix and the\n>   neighborhood. And you could drop one of your two tmp bitets.\n \nI succeed to remove it. I have changed the name of some variables and updated the size of `bm_pool`accordingly.\n \n> - Are those two lines needed?\n> \n> \n> ```\n> delta_i = max(current_cost, delta_i)\n> if delta_i < upper_bound:\n> ```\n> \n>   It seems that you can already suppose that `current_cost<upper_bound`, and you\n>   checked several lines above that `delta_i < upper_bound`.\n\nIf we reduce the upper bound during the recursive call of the kth element of the list, we want to prune (cut) branches that are no longer useful.\nSo yes, these lines are needed.\n  \n> - I do not agree with this comment\n> \n> \n> ```\n> if upper_bound <= lower_bound:\n>   # Either we have optimal solution, or we are satisfied with\n>   # current solution.\n> ```\n> \n>   it seems that this code only deals with the case when 'we are satisfied with\n>   the current solution'.\n\n\nI changed the sentence to `We are satisfied with current solution`\n \n> - Is there any reason why you did not expose your function in the main\n>   `vertex_separation` function? If you do, is there any reason why it should not\n>   be the default one? (if it is faster?..). Finally, note that if you do make it\n>   the default some doctests of your functions will have to be updated, as you\n>   would be comparing the BAB function with `vertex_separation` (which would also\n>   call the BAB).\n \nYep, I have many reasons for not exposing the BAB in the main `vertex_separation` function yet.\n1. this patch is already quite long and technical. Since you often complain about patch bombs, I did my best to decompose the work\n2. I plan to add pre-processing rules. The first one is to decompose the input digraph into strongly connected components, but I have others, more complex. I will work on this part only when the BAB will be finalized (including memoization of prefixes). I believe its better to wok this way.\n\n\n> With those comments and those from my previous message, I would say that my\n> review is finished. We only have to settle those last remarks.\n> \n> Thanks for your work!\n> \n> Nathann\n\n\nI hope I have answered all your comments ;)\n\nDavid.",
    "created_at": "2015-01-29T23:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301715",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:37'></a>Replying to [ncohen](#comment%3A35):
> Hello,
> 
> > > - in `_my_invert_positions`: you cannot in C, but in Cython you can do
> > >   `a,b=b,a`.
 
> > I don't see how to use it here.
> {{{
> source_pos = positions[i]
> j = prefix[target_pos]
> prefix[target_pos],prefix[source_pos] = prefix[source_pos], prefix[target_pos]
> positions[i],positions[j] = positions[j],positions[i]
> }}}
> 
> It could be made simpler if the code of `_my_invert_positions` was taking two positions (or two vertices) as argument instead of 'one of each type'.

I have change the method and updated calls to it.

 
> > But if it is a Python list, method `vertex_separation_BAB_C` has to return both the value and that list. 

> 
> {{{
> e = [1,2,3]
> def invert_two_entries(l):
>    l[0],l[1] = l[1],l[0]
> invert_two_entries(e)
> print e # prints [2, 1, 3]
> }}}
> 
> > How would that be more efficient than passing a pointer and updating the content of the array when needed ?

> 
> It is not about efficiency, it is about not allocating/deallocating something if it can be avoided. This table is updated very rarely, so it does not have to be a C array.

Apparently your care a lot about reducing mallocs.

I changed it.
 
Replying to [ncohen](#comment%3A36):
> Helloooooo again,
> 
> - What is the purpose of `lower_bound`? The documentation says that the code is
>   trying to find an ordering whose cost is *lower* than `lower_bound`? On what
>   exactly is it a lower bound?
> 
>   Do you mean that the code will "return any ordering whose cost is lower than
>   `lower_bound`, even if it has no proof that it is optimal?
 
Exactly.
With parameter `upper_bound`, you ask for a solution with width less than `upper_bound` if such a solution exists.
With parameter `lower_bound`, you say that you are satisfied with any solution with width less than this bound. This is useful in particular when you split the input digraph into strongly connected components and solve the problem on each of them. If one component has width `k`, you don't care if another component has width `k-1` since you know that the vertex separation of the entire digraph is at least `k`.

This will be useful when we will start adding pre-processing.

 
> - Do you think that you actually need `loc_b_neighborhood`? It feels like all
>   you need is what you store in `bits_tmp`, i.e. the union of the prefix and the
>   neighborhood. And you could drop one of your two tmp bitets.
 
I succeed to remove it. I have changed the name of some variables and updated the size of `bm_pool`accordingly.
 
> - Are those two lines needed?
> 
> 
> ```
> delta_i = max(current_cost, delta_i)
> if delta_i < upper_bound:
> ```
> 
>   It seems that you can already suppose that `current_cost<upper_bound`, and you
>   checked several lines above that `delta_i < upper_bound`.

If we reduce the upper bound during the recursive call of the kth element of the list, we want to prune (cut) branches that are no longer useful.
So yes, these lines are needed.
  
> - I do not agree with this comment
> 
> 
> ```
> if upper_bound <= lower_bound:
>   # Either we have optimal solution, or we are satisfied with
>   # current solution.
> ```
> 
>   it seems that this code only deals with the case when 'we are satisfied with
>   the current solution'.


I changed the sentence to `We are satisfied with current solution`
 
> - Is there any reason why you did not expose your function in the main
>   `vertex_separation` function? If you do, is there any reason why it should not
>   be the default one? (if it is faster?..). Finally, note that if you do make it
>   the default some doctests of your functions will have to be updated, as you
>   would be comparing the BAB function with `vertex_separation` (which would also
>   call the BAB).
 
Yep, I have many reasons for not exposing the BAB in the main `vertex_separation` function yet.
1. this patch is already quite long and technical. Since you often complain about patch bombs, I did my best to decompose the work
2. I plan to add pre-processing rules. The first one is to decompose the input digraph into strongly connected components, but I have others, more complex. I will work on this part only when the BAB will be finalized (including memoization of prefixes). I believe its better to wok this way.


> With those comments and those from my previous message, I would say that my
> review is finished. We only have to settle those last remarks.
> 
> Thanks for your work!
> 
> Nathann


I hope I have answered all your comments ;)

David.



---

archive/issue_comments_301716.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-29T23:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301716",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301717.json:
```json
{
    "body": "Changing commit from \"fdfe120bc438b041a7ff480a288f29d6c73b17e5\" to \"2f0bf7a386eff5ff28a9ce87106ab50ab5c5488a\"",
    "created_at": "2015-01-29T23:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301717",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "fdfe120bc438b041a7ff480a288f29d6c73b17e5" to "2f0bf7a386eff5ff28a9ce87106ab50ab5c5488a"



---

archive/issue_comments_301718.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-29T23:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301718",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_301719.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Nathann Cohen\"",
    "created_at": "2015-01-29T23:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301719",
    "user": "https://github.com/dcoudert"
}
```

Changing reviewer from "" to "Nathann Cohen"



---

archive/issue_comments_301720.json:
```json
{
    "body": "<a id='comment:40'></a>Hello,\n\n> Apparently your care a lot about reducing mallocs.\n\n\nHaving a short code that only does what is needed helps a lot when you try to understand someboy else's code.\n\n> >   Do you mean that the code will \"return any ordering whose cost is lower than\n> >   `lower_bound`, even if it has no proof that it is optimal?\n\n> Exactly.\n\nOkay I understand. That helps when you split your first graph into subproblems. This being said, the term `lower_bound` seems to indicate that the user can provide a lower bound on the optimal value of the graph, which confused me when I read code that dealt with returning any \"solution below the lower bound\". What would you think of renaming it to something like \"accept_any_below=4\"? That's the best keyword I found, but if you have in mind something which could represent a bit better what it does... I find this name confusing.\n\n> > - Are those two lines needed?\n> > \n> > \n> > ```\n> > delta_i = max(current_cost, delta_i)\n> > if delta_i < upper_bound:\n> > ```\n\n> If we reduce the upper bound during the recursive call of the kth element of the list, we want to prune (cut) branches that are no longer useful.\n> So yes, these lines are needed.\n\n\nOh I see. I had not noticed that `upper_bound` was updated at every loop. Consequently, wouldn't it be better to do something like that instead?\n\n```\nif delta_i >= upper_bound:\n    break\n<continue exploring>\n```\n\n> Yep, I have many reasons for not exposing the BAB in the main `vertex_separation` function yet.\n> 1. this patch is already quite long and technical. Since you often complain about patch bombs, I did my best to decompose the work\n> 2. I plan to add pre-processing rules. The first one is to decompose the input digraph into strongly connected components, but I have others, more complex. I will work on this part only when the BAB will be finalized (including memoization of prefixes). I believe its better to wok this way.\n\n\nOkay, as you like. As long as you plan to do it in the short future, you can manage the patches as you like.\n\nNathann_from_Nantes",
    "created_at": "2015-01-31T12:04:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301720",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:40'></a>Hello,

> Apparently your care a lot about reducing mallocs.


Having a short code that only does what is needed helps a lot when you try to understand someboy else's code.

> >   Do you mean that the code will "return any ordering whose cost is lower than
> >   `lower_bound`, even if it has no proof that it is optimal?

> Exactly.

Okay I understand. That helps when you split your first graph into subproblems. This being said, the term `lower_bound` seems to indicate that the user can provide a lower bound on the optimal value of the graph, which confused me when I read code that dealt with returning any "solution below the lower bound". What would you think of renaming it to something like "accept_any_below=4"? That's the best keyword I found, but if you have in mind something which could represent a bit better what it does... I find this name confusing.

> > - Are those two lines needed?
> > 
> > 
> > ```
> > delta_i = max(current_cost, delta_i)
> > if delta_i < upper_bound:
> > ```

> If we reduce the upper bound during the recursive call of the kth element of the list, we want to prune (cut) branches that are no longer useful.
> So yes, these lines are needed.


Oh I see. I had not noticed that `upper_bound` was updated at every loop. Consequently, wouldn't it be better to do something like that instead?

```
if delta_i >= upper_bound:
    break
<continue exploring>
```

> Yep, I have many reasons for not exposing the BAB in the main `vertex_separation` function yet.
> 1. this patch is already quite long and technical. Since you often complain about patch bombs, I did my best to decompose the work
> 2. I plan to add pre-processing rules. The first one is to decompose the input digraph into strongly connected components, but I have others, more complex. I will work on this part only when the BAB will be finalized (including memoization of prefixes). I believe its better to wok this way.


Okay, as you like. As long as you plan to do it in the short future, you can manage the patches as you like.

Nathann_from_Nantes



---

archive/issue_comments_301721.json:
```json
{
    "body": "<a id='comment:41'></a>> > >   Do you mean that the code will \"return any ordering whose cost is lower than\n> > >   `lower_bound`, even if it has no proof that it is optimal?\n\n> > Exactly.\n> \n> Okay I understand. That helps when you split your first graph into subproblems. This being said, the term `lower_bound` seems to indicate that the user can provide a lower bound on the optimal value of the graph, which confused me when I read code that dealt with returning any \"solution below the lower bound\". What would you think of renaming it to something like \"accept_any_below=4\"? That's the best keyword I found, but if you have in mind something which could represent a bit better what it does... I find this name confusing.\n\n\nIt is used for both usage: If a lower bound is known, then the user can provide it to the BAB to stop if a solution reaches this bound. It can also be used to say \"I'm happy with any solution with cost less than k\".\n\nI propose to rename it `cut_off` as for shortests paths algorithms.\nI have updated the doc and tests accordingly\n\n \n> > > - Are those two lines needed?\n> > > \n> > > \n> > > ```\n> > > delta_i = max(current_cost, delta_i)\n> > > if delta_i < upper_bound:\n> > > ```\n\n> > If we reduce the upper bound during the recursive call of the kth element of the list, we want to prune (cut) branches that are no longer useful.\n> > So yes, these lines are needed.\n\n> \n> Oh I see. I had not noticed that `upper_bound` was updated at every loop. Consequently, wouldn't it be better to do something like that instead?\n> \n> ```\n> if delta_i >= upper_bound:\n>     break\n> <continue exploring>\n> ```\n\nRight, done.\n\n \n> > Yep, I have many reasons for not exposing the BAB in the main `vertex_separation` function yet.\n> > 1. this patch is already quite long and technical. Since you often complain about patch bombs, I did my best to decompose the work\n> > 2. I plan to add pre-processing rules. The first one is to decompose the input digraph into strongly connected components, but I have others, more complex. I will work on this part only when the BAB will be finalized (including memoization of prefixes). I believe its better to wok this way.\n  \n> \n> Okay, as you like. As long as you plan to do it in the short future, you can manage the patches as you like.\n> \n> Nathann_from_Nantes\n\nLet us know if you meet Lulu ;)\n\nThank you again for the review.\n\nDavid.",
    "created_at": "2015-01-31T14:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301721",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:41'></a>> > >   Do you mean that the code will "return any ordering whose cost is lower than
> > >   `lower_bound`, even if it has no proof that it is optimal?

> > Exactly.
> 
> Okay I understand. That helps when you split your first graph into subproblems. This being said, the term `lower_bound` seems to indicate that the user can provide a lower bound on the optimal value of the graph, which confused me when I read code that dealt with returning any "solution below the lower bound". What would you think of renaming it to something like "accept_any_below=4"? That's the best keyword I found, but if you have in mind something which could represent a bit better what it does... I find this name confusing.


It is used for both usage: If a lower bound is known, then the user can provide it to the BAB to stop if a solution reaches this bound. It can also be used to say "I'm happy with any solution with cost less than k".

I propose to rename it `cut_off` as for shortests paths algorithms.
I have updated the doc and tests accordingly

 
> > > - Are those two lines needed?
> > > 
> > > 
> > > ```
> > > delta_i = max(current_cost, delta_i)
> > > if delta_i < upper_bound:
> > > ```

> > If we reduce the upper bound during the recursive call of the kth element of the list, we want to prune (cut) branches that are no longer useful.
> > So yes, these lines are needed.

> 
> Oh I see. I had not noticed that `upper_bound` was updated at every loop. Consequently, wouldn't it be better to do something like that instead?
> 
> ```
> if delta_i >= upper_bound:
>     break
> <continue exploring>
> ```

Right, done.

 
> > Yep, I have many reasons for not exposing the BAB in the main `vertex_separation` function yet.
> > 1. this patch is already quite long and technical. Since you often complain about patch bombs, I did my best to decompose the work
> > 2. I plan to add pre-processing rules. The first one is to decompose the input digraph into strongly connected components, but I have others, more complex. I will work on this part only when the BAB will be finalized (including memoization of prefixes). I believe its better to wok this way.
  
> 
> Okay, as you like. As long as you plan to do it in the short future, you can manage the patches as you like.
> 
> Nathann_from_Nantes

Let us know if you meet Lulu ;)

Thank you again for the review.

David.



---

archive/issue_comments_301722.json:
```json
{
    "body": "Changing commit from \"2f0bf7a386eff5ff28a9ce87106ab50ab5c5488a\" to \"0bd12bf4ce6c006d60aecaaad042878052d9d395\"",
    "created_at": "2015-01-31T14:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301722",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2f0bf7a386eff5ff28a9ce87106ab50ab5c5488a" to "0bd12bf4ce6c006d60aecaaad042878052d9d395"



---

archive/issue_comments_301723.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-31T14:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301723",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301724.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-31T15:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301724",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_301725.json:
```json
{
    "body": "<a id='comment:43'></a>Yoooooooooooo !\n\n> Thank you again for the review.\n\n\nAnd thank you for the code `;-)`\n\nNathann",
    "created_at": "2015-01-31T15:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301725",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:43'></a>Yoooooooooooo !

> Thank you again for the review.


And thank you for the code `;-)`

Nathann



---

archive/issue_comments_301726.json:
```json
{
    "body": "<a id='comment:44'></a>Youhou!",
    "created_at": "2015-01-31T15:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301726",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:44'></a>Youhou!



---

archive/issue_comments_301727.json:
```json
{
    "body": "<a id='comment:45'></a>PDF docs don't build",
    "created_at": "2015-02-17T01:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301727",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:45'></a>PDF docs don't build



---

archive/issue_comments_301728.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-02-17T01:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301728",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_301729.json:
```json
{
    "body": "Changing commit from \"0bd12bf4ce6c006d60aecaaad042878052d9d395\" to \"dd12f60ede78325f58b166096778249820307e5d\"",
    "created_at": "2015-02-17T08:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301729",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0bd12bf4ce6c006d60aecaaad042878052d9d395" to "dd12f60ede78325f58b166096778249820307e5d"



---

archive/issue_comments_301730.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-17T08:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301731.json:
```json
{
    "body": "<a id='comment:47'></a>Should be OK now.",
    "created_at": "2015-02-17T08:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301731",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:47'></a>Should be OK now.



---

archive/issue_comments_301732.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-17T08:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301732",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_301733.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-17T10:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301733",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_301734.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-17T20:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301734",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_050565.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-17T20:50:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17647#event-50565"
}
```



---

archive/issue_comments_301735.json:
```json
{
    "body": "Changing branch from \"public/17647b\" to \"dd12f60ede78325f58b166096778249820307e5d\"",
    "created_at": "2015-02-17T20:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17647#issuecomment-301735",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/17647b" to "dd12f60ede78325f58b166096778249820307e5d"
