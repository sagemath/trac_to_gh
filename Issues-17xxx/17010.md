# Issue 17010: Random failure in diagram algebras

archive/issues_016773.json:
```json
{
    "body": "I've seen this more than once on the buildbot...\n\n```\nsage -t --long src/sage/combinat/diagram_algebras.py\n**********************************************************************\nFile \"src/sage/combinat/diagram_algebras.py\", line 696, in sage.combinat.diagram_algebras.SubPartitionAlgebra.__init__\nFailed example:\n    BA.ambient().has_coerce_map_from(BA)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n```\n\n**CC:**  @simon-king-jena\n\n**Keywords:** random_fail\n\nIssue created by migration from https://trac.sagemath.org/ticket/17010\n\n",
    "created_at": "2014-09-20T11:23:51Z",
    "labels": [
        "component: combinatorics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "title": "Random failure in diagram algebras",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/17010",
    "user": "https://github.com/vbraun"
}
```
I've seen this more than once on the buildbot...

```
sage -t --long src/sage/combinat/diagram_algebras.py
**********************************************************************
File "src/sage/combinat/diagram_algebras.py", line 696, in sage.combinat.diagram_algebras.SubPartitionAlgebra.__init__
Failed example:
    BA.ambient().has_coerce_map_from(BA)
Expected:
    True
Got:
    False
**********************************************************************
```

**CC:**  @simon-king-jena

**Keywords:** random_fail

Issue created by migration from https://trac.sagemath.org/ticket/17010





---

archive/issue_comments_227386.json:
```json
{
    "body": "<a id='comment:1'></a>\nSomething related to the coercion is getting garbage collected during the execution of the command. On my desktop (a fast computer with gobs of RAM) I always get the right answer. But if I use the trace hook to force run a garbage collection between each Python command: \n\n```python\ndef trace_gc(frame, event, arg):\n    import gc\n    gc.collect()\n```\nthen a) everything gets dog slow, about 5 mins for the lines below, and b) I get the wrong answer:\n\n```\nsage: sys.settrace(trace_gc)\nsage: R.<x> = QQ[]\nsage: BA = BrauerAlgebra(2, x, R)\nsage: BA.ambient().has_coerce_map_from(BA)\nFalse\n```",
    "created_at": "2014-09-20T11:41:12Z",
    "issue": "https://github.com/sagemath/sage/issues/17010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17010#issuecomment-227386",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>
Something related to the coercion is getting garbage collected during the execution of the command. On my desktop (a fast computer with gobs of RAM) I always get the right answer. But if I use the trace hook to force run a garbage collection between each Python command: 

```python
def trace_gc(frame, event, arg):
    import gc
    gc.collect()
```
then a) everything gets dog slow, about 5 mins for the lines below, and b) I get the wrong answer:

```
sage: sys.settrace(trace_gc)
sage: R.<x> = QQ[]
sage: BA = BrauerAlgebra(2, x, R)
sage: BA.ambient().has_coerce_map_from(BA)
False
```



---

archive/issue_comments_227387.json:
```json
{
    "body": "<a id='comment:2'></a>\nI suppose the problem comes from `__init_extra__`, which for algebras is supposed to register the coercion from the base ring.",
    "created_at": "2014-09-20T11:57:54Z",
    "issue": "https://github.com/sagemath/sage/issues/17010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17010#issuecomment-227387",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>
I suppose the problem comes from `__init_extra__`, which for algebras is supposed to register the coercion from the base ring.



---

archive/issue_comments_227388.json:
```json
{
    "body": "<a id='comment:3'></a>\nI found that we are in a rare case. This\n\n```python\n            try:\n                has_custom_conversion = self.category().parent_class.from_base_ring.__func__ is not self.from_base_ring.__func__\n            except AttributeError:\n                # Sometimes from_base_ring is a lazy attribute\n                has_custom_conversion = True\n```\nends up in \"`except AttributeError`\". So, the question is if it is really the case here that `from_base_ring` exists as lazy attribute, or the attribute error came from a different reason.",
    "created_at": "2014-09-20T14:18:02Z",
    "issue": "https://github.com/sagemath/sage/issues/17010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17010#issuecomment-227388",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
I found that we are in a rare case. This

```python
            try:
                has_custom_conversion = self.category().parent_class.from_base_ring.__func__ is not self.from_base_ring.__func__
            except AttributeError:
                # Sometimes from_base_ring is a lazy attribute
                has_custom_conversion = True
```
ends up in "`except AttributeError`". So, the question is if it is really the case here that `from_base_ring` exists as lazy attribute, or the attribute error came from a different reason.



---

archive/issue_comments_227389.json:
```json
{
    "body": "<a id='comment:4'></a>\nYes, it is a lazy attribute of the parent class.",
    "created_at": "2014-09-20T14:19:21Z",
    "issue": "https://github.com/sagemath/sage/issues/17010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17010#issuecomment-227389",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>
Yes, it is a lazy attribute of the parent class.



---

archive/issue_comments_227390.json:
```json
{
    "body": "<a id='comment:5'></a>\nI'm thinking the problem is coming from line 700-1:\n\n```\nself.module_morphism(self.lift, codomain=amb,\n                     category=self.category()).register_as_coercion()\n```\nand is similar to what I posted on #16532, as a reference to the ambient partition algebra is not held by the subpartition algebra.\n\nI'm thinking the easiest fix would be to actually just store a reference to the ambient algebra in the subpartition algebra. The best fix would probably be to add a `_coerce_map_from_` in `PartitionAlgebra` which checks if the parent is an instance of `SubPartitionAlgebra` and returns the lift module morphism. Both fixes are easy, which do you think we should do?",
    "created_at": "2014-09-20T16:11:50Z",
    "issue": "https://github.com/sagemath/sage/issues/17010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17010#issuecomment-227390",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
I'm thinking the problem is coming from line 700-1:

```
self.module_morphism(self.lift, codomain=amb,
                     category=self.category()).register_as_coercion()
```
and is similar to what I posted on #16532, as a reference to the ambient partition algebra is not held by the subpartition algebra.

I'm thinking the easiest fix would be to actually just store a reference to the ambient algebra in the subpartition algebra. The best fix would probably be to add a `_coerce_map_from_` in `PartitionAlgebra` which checks if the parent is an instance of `SubPartitionAlgebra` and returns the lift module morphism. Both fixes are easy, which do you think we should do?



---

archive/issue_comments_227391.json:
```json
{
    "body": "<a id='comment:6'></a>\nI don't see how storing a reference to ambient is going to help, the call to `has_coerce_map_from` in the ticket description already holds a reference to ambient (== self)",
    "created_at": "2014-09-27T14:21:54Z",
    "issue": "https://github.com/sagemath/sage/issues/17010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17010#issuecomment-227391",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:6'></a>
I don't see how storing a reference to ambient is going to help, the call to `has_coerce_map_from` in the ticket description already holds a reference to ambient (== self)
