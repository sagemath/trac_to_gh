# Issue 17735: runsnake() cleanup

archive/issues_017498.json:
```json
{
    "body": "This ticket aims at cleaning `runsnake()` function to:\n- update the installation documentation\n- check that runsnakerun is installed before failing silently\n- behave consistently with the state of the preparser\n\nSee also #14414 and #17689.\n\n\n**CC:**  @nathanncohen\n\n**Branch:** [u/tmonteil/runsnake___cleanup](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/runsnake___cleanup)\n\n**Commit:** [ecaf0528f278c20f6c6c7497d311f11594e8a02d](https://github.com/sagemath/sagetrac-mirror/commit/ecaf0528f278c20f6c6c7497d311f11594e8a02d)\n\n**Dependencies:** #9386, #14414\n\nIssue created by migration from https://trac.sagemath.org/ticket/17735\n\n",
    "created_at": "2015-02-05T16:34:25Z",
    "labels": [
        "component: misc",
        "enhancement",
        "needs work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.5",
    "title": "runsnake() cleanup",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/17735",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
This ticket aims at cleaning `runsnake()` function to:
- update the installation documentation
- check that runsnakerun is installed before failing silently
- behave consistently with the state of the preparser

See also #14414 and #17689.


**CC:**  @nathanncohen

**Branch:** [u/tmonteil/runsnake___cleanup](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/runsnake___cleanup)

**Commit:** [ecaf0528f278c20f6c6c7497d311f11594e8a02d](https://github.com/sagemath/sagetrac-mirror/commit/ecaf0528f278c20f6c6c7497d311f11594e8a02d)

**Dependencies:** #9386, #14414

Issue created by migration from https://trac.sagemath.org/ticket/17735





---

archive/issue_comments_242013.json:
```json
{
    "body": "<a id='comment:2'></a>\nSee also #14414. In fact, I'm inclined to close this ticket as \"dupe\" and address the issues mentioned here on that ticket.",
    "created_at": "2015-02-05T22:11:24Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242013",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>
See also #14414. In fact, I'm inclined to close this ticket as "dupe" and address the issues mentioned here on that ticket.



---

archive/issue_comments_242014.json:
```json
{
    "body": "**Branch:** [u/tmonteil/runsnake___cleanup](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/runsnake___cleanup)",
    "created_at": "2015-02-06T13:33:45Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242014",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Branch:** [u/tmonteil/runsnake___cleanup](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/runsnake___cleanup)



---

archive/issue_comments_242015.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n This ticket aims at cleaning `runsnake()` function to:\n - update the installation documentation\n+- check that runsnakerun is installed before failing silently\n - behave consistently with the state of the preparser\n \n+See also #14414 and #17689.\n+\n``````\n",
    "created_at": "2015-02-06T22:01:22Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242015",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,7 @@
 This ticket aims at cleaning `runsnake()` function to:
 - update the installation documentation
+- check that runsnakerun is installed before failing silently
 - behave consistently with the state of the preparser
 
+See also #14414 and #17689.
+
``````




---

archive/issue_events_159187.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/tmonteil",
    "created_at": "2015-02-06T22:01:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17735#event-159187"
}
```



---

archive/issue_comments_242016.json:
```json
{
    "body": "**Commit:** [ecaf0528f278c20f6c6c7497d311f11594e8a02d](https://github.com/sagemath/sagetrac-mirror/commit/ecaf0528f278c20f6c6c7497d311f11594e8a02d)",
    "created_at": "2015-02-06T22:01:22Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242016",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Commit:** [ecaf0528f278c20f6c6c7497d311f11594e8a02d](https://github.com/sagemath/sagetrac-mirror/commit/ecaf0528f278c20f6c6c7497d311f11594e8a02d)



---

archive/issue_comments_242017.json:
```json
{
    "body": "<a id='comment:4'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f21efcce742e55e452649b45973ae8df4860fb33\">f21efcc</a></td><td><code>#17735 preparsing behaves consistently with the state of the preparser.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8b6a71187ef9926f2a58841bf139402920c67611\">8b6a711</a></td><td><code>#17735 check that the RunSnakeRun program is available.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/364095021932a7b5f40f6d4e852064fec9450c99\">3640950</a></td><td><code>#17735 string formatting.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6aead48544fd741e63cca7a457428697b2be99cf\">6aead48</a></td><td><code>#17735 update installation documentation.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/185fa563dfc403e615afe32f77ab1c8e98d1d7f5\">185fa56</a></td><td><code>#17735 missing dot.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ecaf0528f278c20f6c6c7497d311f11594e8a02d\">ecaf052</a></td><td><code>#17735 link to the profiling thematic tutorial.</code></td></tr></table>\n",
    "created_at": "2015-02-06T22:01:22Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242017",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:4'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f21efcce742e55e452649b45973ae8df4860fb33">f21efcc</a></td><td><code>#17735 preparsing behaves consistently with the state of the preparser.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8b6a71187ef9926f2a58841bf139402920c67611">8b6a711</a></td><td><code>#17735 check that the RunSnakeRun program is available.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/364095021932a7b5f40f6d4e852064fec9450c99">3640950</a></td><td><code>#17735 string formatting.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6aead48544fd741e63cca7a457428697b2be99cf">6aead48</a></td><td><code>#17735 update installation documentation.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/185fa563dfc403e615afe32f77ab1c8e98d1d7f5">185fa56</a></td><td><code>#17735 missing dot.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ecaf0528f278c20f6c6c7497d311f11594e8a02d">ecaf052</a></td><td><code>#17735 link to the profiling thematic tutorial.</code></td></tr></table>




---

archive/issue_comments_242018.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [nbruin](#comment%3A2):\n> See also #14414. \n\n\nThanks for the pointer, i did not see it.\n\n> In fact, I'm inclined to close this ticket as \"dupe\" and address the issues mentioned here on that ticket.\n\n\nThis ticket adresses different (and more trivial) issues (doc, preparsing, checks) that do not require to wait for a `wxPython` spkg to be created. It can be merged soon, and rebasing #14414 on this one when it becomes ready should not be hard. Actually, this ticket was first related to #17689 so that we have a simple installation procedure somewhere.",
    "created_at": "2015-02-06T22:06:18Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242018",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:5'></a>
Replying to [nbruin](#comment%3A2):
> See also #14414. 


Thanks for the pointer, i did not see it.

> In fact, I'm inclined to close this ticket as "dupe" and address the issues mentioned here on that ticket.


This ticket adresses different (and more trivial) issues (doc, preparsing, checks) that do not require to wait for a `wxPython` spkg to be created. It can be merged soon, and rebasing #14414 on this one when it becomes ready should not be hard. Actually, this ticket was first related to #17689 so that we have a simple installation procedure somewhere.



---

archive/issue_comments_242019.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [tmonteil](#comment%3A5):\n> This ticket adresses different (and more trivial) issues (doc, preparsing, checks) that do not require to wait for a `wxPython` spkg to be created. It can be merged soon, and rebasing #14414 on this one when it becomes ready should not be hard. Actually, this ticket was first related to #17689 so that we have a simple installation procedure somewhere.\n\n\nOK, it's also possible to repurpose #14414 for providing the infrastructure to install runsnake in sage itself.\n\nIn that case, you would need to do something along the lines of [ticket:14414#comment:23] because checking if runsnake is available and then invoking it in an inappropriate fashion is not an improvement. I have tested that the following works for me (the code on the #14414 comment needed some adjustments)\n\n```\n    ...\n    import os, subprocess\n    cProfile.runctx(preparse(command.lstrip().rstrip()), get_main_globals(), locals(), filename=tmpfile)\n    if os.path.exists(os.path.join(os.environ['SAGE_LOCAL'],'bin','runsnake')):\n        subprocess.call([\"runsnake\",tmpfile])\n    else:\n        os.system(\"\"\"sh -c \"\n          LD_LIBRARY_PATH=$SAGE_ORIG_LD_LIBRARY_PATH; export LD_LIBRARY_PATH\n          if [ `uname` = 'Darwin' ]; then\n              DYLD_LIBRARY_PATH=$SAGE_ORIG_DYLD_LIBRARY_PATH\n          fi\n          unset PYTHONHOME\n          unset PYTHONPATH\n          runsnake %s\n        \"    \n        \"\"\"%tmpfile)\n\n```\nI really need all of PYTHONHOME, PYTHONPATH, LD_LIBRARY_PATH reset.\n\nFailure depends on `/usr/bin/python` and `$SAGE_LOCAL/bin/python` being binary incompatible, so this is something that needs to be tested on a bunch of platforms.\n\nI can help testing/reviewing if you're ok with that approach (but we need to test on multiple platforms).",
    "created_at": "2015-02-06T23:49:32Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242019",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'></a>
Replying to [tmonteil](#comment%3A5):
> This ticket adresses different (and more trivial) issues (doc, preparsing, checks) that do not require to wait for a `wxPython` spkg to be created. It can be merged soon, and rebasing #14414 on this one when it becomes ready should not be hard. Actually, this ticket was first related to #17689 so that we have a simple installation procedure somewhere.


OK, it's also possible to repurpose #14414 for providing the infrastructure to install runsnake in sage itself.

In that case, you would need to do something along the lines of [ticket:14414#comment:23] because checking if runsnake is available and then invoking it in an inappropriate fashion is not an improvement. I have tested that the following works for me (the code on the #14414 comment needed some adjustments)

```
    ...
    import os, subprocess
    cProfile.runctx(preparse(command.lstrip().rstrip()), get_main_globals(), locals(), filename=tmpfile)
    if os.path.exists(os.path.join(os.environ['SAGE_LOCAL'],'bin','runsnake')):
        subprocess.call(["runsnake",tmpfile])
    else:
        os.system("""sh -c "
          LD_LIBRARY_PATH=$SAGE_ORIG_LD_LIBRARY_PATH; export LD_LIBRARY_PATH
          if [ `uname` = 'Darwin' ]; then
              DYLD_LIBRARY_PATH=$SAGE_ORIG_DYLD_LIBRARY_PATH
          fi
          unset PYTHONHOME
          unset PYTHONPATH
          runsnake %s
        "    
        """%tmpfile)

```
I really need all of PYTHONHOME, PYTHONPATH, LD_LIBRARY_PATH reset.

Failure depends on `/usr/bin/python` and `$SAGE_LOCAL/bin/python` being binary incompatible, so this is something that needs to be tested on a bunch of platforms.

I can help testing/reviewing if you're ok with that approach (but we need to test on multiple platforms).



---

archive/issue_comments_242020.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [nbruin](#comment%3A6):\n> OK, it's also possible to repurpose #14414 for providing the infrastructure to install runsnake in sage itself.\n\n\nWhy not.\n\n> I really need all of PYTHONHOME, PYTHONPATH, LD_LIBRARY_PATH reset.\n\n\nI like the `sage-native-execute` approach of Jeroen since it solves the issue for other similar calls, and i wonder whether we could also take the opportunity to also reset the `PATH` to `$SAGE_ORIG_PATH` there.",
    "created_at": "2015-02-08T11:25:14Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242020",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:7'></a>
Replying to [nbruin](#comment%3A6):
> OK, it's also possible to repurpose #14414 for providing the infrastructure to install runsnake in sage itself.


Why not.

> I really need all of PYTHONHOME, PYTHONPATH, LD_LIBRARY_PATH reset.


I like the `sage-native-execute` approach of Jeroen since it solves the issue for other similar calls, and i wonder whether we could also take the opportunity to also reset the `PATH` to `$SAGE_ORIG_PATH` there.



---

archive/issue_events_159188.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2015-02-16T16:10:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17735#event-159188"
}
```



---

archive/issue_events_159189.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2015-02-16T16:10:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17735#event-159189"
}
```



---

archive/issue_comments_242021.json:
```json
{
    "body": "<a id='comment:8'></a>\nSetting #9386 as a dependency, since that now offers a saner `sage-native-execute`. Branch here needs rebasing, by the way. Otherwise, should be good to go. It's probably easiest to rebase on #14414 right away, since that already has the rather small fix in place to properly run `runsnake` either installed in `SAGE_LOCAL` or via `sage-native-execute`.",
    "created_at": "2015-02-16T16:10:52Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242021",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:8'></a>
Setting #9386 as a dependency, since that now offers a saner `sage-native-execute`. Branch here needs rebasing, by the way. Otherwise, should be good to go. It's probably easiest to rebase on #14414 right away, since that already has the rather small fix in place to properly run `runsnake` either installed in `SAGE_LOCAL` or via `sage-native-execute`.



---

archive/issue_comments_242022.json:
```json
{
    "body": "**Dependencies:** 17746",
    "created_at": "2015-02-16T16:10:52Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242022",
    "user": "https://github.com/nbruin"
}
```

**Dependencies:** 17746



---

archive/issue_comments_242023.json:
```json
{
    "body": "**Changing dependencies** from \"17746\" to \"9386\".",
    "created_at": "2015-02-16T16:11:15Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242023",
    "user": "https://github.com/nbruin"
}
```

**Changing dependencies** from "17746" to "9386".



---

archive/issue_comments_242024.json:
```json
{
    "body": "**Changing dependencies** from \"9386\" to \"#9386\".",
    "created_at": "2015-02-16T16:11:41Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242024",
    "user": "https://github.com/nbruin"
}
```

**Changing dependencies** from "9386" to "#9386".



---

archive/issue_comments_242025.json:
```json
{
    "body": "**Changing dependencies** from \"#9386\" to \"#9386, #14414\".",
    "created_at": "2015-02-16T21:09:07Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242025",
    "user": "https://github.com/nbruin"
}
```

**Changing dependencies** from "#9386" to "#9386, #14414".



---

archive/issue_comments_242026.json:
```json
{
    "body": "<a id='comment:12'></a>\nLooking at the implementation of sage.misc.sage_ostools.have_program, we might want to change:\n\n```diff\n-           if os.access(os.path.join(p, program), os.X_OK):\n+           pth=os.path.join(p, program)\n+           if os.path.isfile(pth) and os.access(pth, os.X_OK):\n```\nsince `os.access(..., os.X_OK)` might return true for a directory and yet this would not be picked up as an executable by the operating system.",
    "created_at": "2015-02-16T21:19:38Z",
    "issue": "https://github.com/sagemath/sage/issues/17735",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17735#issuecomment-242026",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:12'></a>
Looking at the implementation of sage.misc.sage_ostools.have_program, we might want to change:

```diff
-           if os.access(os.path.join(p, program), os.X_OK):
+           pth=os.path.join(p, program)
+           if os.path.isfile(pth) and os.access(pth, os.X_OK):
```
since `os.access(..., os.X_OK)` might return true for a directory and yet this would not be picked up as an executable by the operating system.
