# Issue 17663: Clean up sparse matrices

archive/issues_017426.json:
```json
{
    "assignees": [],
    "body": "Big cleaning (and speedup x1.5)\n\nDepends on #17658\n\nCC:  @gagern @pjbruin @nathanncohen\n\nBranch/Commit: **[d292e6f](https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add)**\n\nReviewer: **Martin von Gagern**\n\nAuthor: **Vincent Delecroix**\n\nComponent: **linear algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/17663_\n\n",
    "closed_at": "2015-01-29T13:26:10Z",
    "created_at": "2015-01-22T23:15:14Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Clean up sparse matrices",
    "type": "issue",
    "updated_at": "2015-01-29T13:26:10Z",
    "url": "https://github.com/sagemath/sage/issues/17663",
    "user": "https://github.com/videlec"
}
```
Big cleaning (and speedup x1.5)

Depends on #17658

CC:  @gagern @pjbruin @nathanncohen

Branch/Commit: **[d292e6f](https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add)**

Reviewer: **Martin von Gagern**

Author: **Vincent Delecroix**

Component: **linear algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/17663_





---

archive/issue_events_251681.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-22T23:15:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "milestone_number": null,
    "milestone_title": "sage-6.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251681"
}
```



---

archive/issue_events_251682.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-22T23:15:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "c: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251682"
}
```



---

archive/issue_events_251683.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-22T23:15:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251683"
}
```



---

archive/issue_events_251684.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-22T23:15:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251684"
}
```



---

archive/issue_events_251685.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-22T23:16:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251685"
}
```



---

archive/issue_comments_238299.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/84f7248720bb3ab274ed97ac00aa0bc56c072924\">84f7248</a></td><td><code>Convert keys of generic sparse matrix to pair of ints.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/aca0531f9ca26a3c32690032c4d7e170a4e5a5cb\">aca0531</a></td><td><code>cleaning sparse matrices</code></td></tr></table>\n",
    "created_at": "2015-01-22T23:16:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238299",
    "user": "https://github.com/videlec"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/84f7248720bb3ab274ed97ac00aa0bc56c072924">84f7248</a></td><td><code>Convert keys of generic sparse matrix to pair of ints.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/aca0531f9ca26a3c32690032c4d7e170a4e5a5cb">aca0531</a></td><td><code>cleaning sparse matrices</code></td></tr></table>




---

archive/issue_comments_238300.json:
```json
{
    "body": "Branch: **[public/17663](https://github.com/sagemath/sagetrac-mirror/tree/public/17663)**",
    "created_at": "2015-01-22T23:16:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238300",
    "user": "https://github.com/videlec"
}
```

Branch: **[public/17663](https://github.com/sagemath/sagetrac-mirror/tree/public/17663)**



---

archive/issue_comments_238301.json:
```json
{
    "body": "Commit: **[aca0531](https://github.com/sagemath/sagetrac-mirror/commit/aca0531f9ca26a3c32690032c4d7e170a4e5a5cb)**",
    "created_at": "2015-01-22T23:16:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238301",
    "user": "https://github.com/videlec"
}
```

Commit: **[aca0531](https://github.com/sagemath/sagetrac-mirror/commit/aca0531f9ca26a3c32690032c4d7e170a4e5a5cb)**



---

archive/issue_comments_238302.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nInteresting. Looks mostly good.\n\nThis is wrong, though:\n\n```\nfor i from 0 <= i < self._nrows:\n  for j from 0 <= j < self._ncols:\n    if not x[k]:\n      entries[(i,j)] = x[k]\n    k += 1\n```\n\nIt should be `if x[k]`: you want to copy the *non*-zero elements. I had some trouble testing this code path, though:\n\n```\nsage: R.<a,b>=QQ[]\nsage: m1=matrix(2,2,[0,a,b,0],sparse=True); m1\n[0 a]\n[b 0]\nsage: type(m1)(m1.parent(),[0,a,b,0],True,True)\n[0 0]\n[0 0]\n```\n\nI haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.\n\nI also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.\n\nAs far as I can see, most other (non-generic) sparse matrix implementations use something other than a dict to represent its entries. Something like [Yale format](http://en.wikipedia.org/wiki/Sparse_matrix#Yale) as far as I can tell at a quick glance. Perhaps a really proper cleanup should go all the way to using that? I'm not sure. Benefits are better memory efficiency, but we'd get logarithmic lookup times as opposed to the almost constant lookup in a hash table. And modifications would become costly. So perhaps we should offer two alternatives, depending on whether memory is an issue or not? Just thinking out loud, I'm not asking for this to be implemented in the ticket at hand.\n\nThe whole class has poor docstring and doctest coverage. I know that when adding new code, it should come with doctests these days. I'm not sure whether your modifications are simply changing existing code and are therefore exempt from this rule. I'd certainly be more happy if you were to add docstrings with tests to all the methods you modified, taking care to test all relevant code paths. To catch things like the one above.",
    "created_at": "2015-01-23T07:03:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238302",
    "user": "https://github.com/gagern"
}
```

<div id="comment:2" align="right">comment:2</div>

Interesting. Looks mostly good.

This is wrong, though:

```
for i from 0 <= i < self._nrows:
  for j from 0 <= j < self._ncols:
    if not x[k]:
      entries[(i,j)] = x[k]
    k += 1
```

It should be `if x[k]`: you want to copy the *non*-zero elements. I had some trouble testing this code path, though:

```
sage: R.<a,b>=QQ[]
sage: m1=matrix(2,2,[0,a,b,0],sparse=True); m1
[0 a]
[b 0]
sage: type(m1)(m1.parent(),[0,a,b,0],True,True)
[0 0]
[0 0]
```

I haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.

I also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.

As far as I can see, most other (non-generic) sparse matrix implementations use something other than a dict to represent its entries. Something like [Yale format](http://en.wikipedia.org/wiki/Sparse_matrix#Yale) as far as I can tell at a quick glance. Perhaps a really proper cleanup should go all the way to using that? I'm not sure. Benefits are better memory efficiency, but we'd get logarithmic lookup times as opposed to the almost constant lookup in a hash table. And modifications would become costly. So perhaps we should offer two alternatives, depending on whether memory is an issue or not? Just thinking out loud, I'm not asking for this to be implemented in the ticket at hand.

The whole class has poor docstring and doctest coverage. I know that when adding new code, it should come with doctests these days. I'm not sure whether your modifications are simply changing existing code and are therefore exempt from this rule. I'd certainly be more happy if you were to add docstrings with tests to all the methods you modified, taking care to test all relevant code paths. To catch things like the one above.



---

archive/issue_events_251686.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2015-01-23T07:05:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251686"
}
```



---

archive/issue_events_251687.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2015-01-23T07:05:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251687"
}
```



---

archive/issue_comments_238303.json:
```json
{
    "body": "Reviewer: **Martin von Gagern**",
    "created_at": "2015-01-23T07:05:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238303",
    "user": "https://github.com/gagern"
}
```

Reviewer: **Martin von Gagern**



---

archive/issue_comments_238304.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7e215dfc871214b8c74997d65422ea7467b3502\">b7e215d</a></td><td><code>documentation and remove unused code</code></td></tr></table>\n",
    "created_at": "2015-01-23T07:56:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238304",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7e215dfc871214b8c74997d65422ea7467b3502">b7e215d</a></td><td><code>documentation and remove unused code</code></td></tr></table>




---

archive/issue_comments_238305.json:
```json
{
    "body": "Changed commit from **[aca0531](https://github.com/sagemath/sagetrac-mirror/commit/aca0531f9ca26a3c32690032c4d7e170a4e5a5cb)** to **[b7e215d](https://github.com/sagemath/sagetrac-mirror/commit/b7e215dfc871214b8c74997d65422ea7467b3502)**",
    "created_at": "2015-01-23T07:56:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238305",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[aca0531](https://github.com/sagemath/sagetrac-mirror/commit/aca0531f9ca26a3c32690032c4d7e170a4e5a5cb)** to **[b7e215d](https://github.com/sagemath/sagetrac-mirror/commit/b7e215dfc871214b8c74997d65422ea7467b3502)**



---

archive/issue_comments_238306.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nHello,\n\nReplying to [@gagern](#comment:2):\n> Interesting. Looks mostly good.\n> \n> This is wrong, though:\n> \n> <...>\n\n>\n\nRight\n \n> I haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.\n\nDone\n\n> I also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.\n\nNope. I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.\n\n> As far as I can see, most other (non-generic) sparse matrix implementations <...>\n\nHash table is cool. But not in the way it is done currently. We should not use Python objects other than to wrap the ring elements.\n\nAn important question is whether you want to access quickly to the following data:\n\n- nonzero entries in a fixed row\n- nonzero entries in a fixed column\n\nThe best would be as you did: look at the literature and other softwares/libraries.\n\n> The whole class has poor docstring and doctest coverage.\n\nRight, I added some. But I will not go any further.\n\nVincent",
    "created_at": "2015-01-23T08:00:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238306",
    "user": "https://github.com/videlec"
}
```

<div id="comment:5" align="right">comment:5</div>

Hello,

Replying to [@gagern](#comment:2):
> Interesting. Looks mostly good.
> 
> This is wrong, though:
> 
> <...>

>

Right
 
> I haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.

Done

> I also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.

Nope. I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.

> As far as I can see, most other (non-generic) sparse matrix implementations <...>

Hash table is cool. But not in the way it is done currently. We should not use Python objects other than to wrap the ring elements.

An important question is whether you want to access quickly to the following data:

- nonzero entries in a fixed row
- nonzero entries in a fixed column

The best would be as you did: look at the literature and other softwares/libraries.

> The whole class has poor docstring and doctest coverage.

Right, I added some. But I will not go any further.

Vincent



---

archive/issue_comments_238307.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@videlec](#comment:5):\n> I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.\n\nIt might be better to keep that for a follow-up ticket.",
    "created_at": "2015-01-23T11:17:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238307",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@videlec](#comment:5):
> I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.

It might be better to keep that for a follow-up ticket.



---

archive/issue_events_251688.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-23T12:17:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251688"
}
```



---

archive/issue_events_251689.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-23T12:17:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251689"
}
```



---

archive/issue_comments_238308.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@jdemeyer](#comment:6):\n> Replying to [@videlec](#comment:5):\n> > I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.\n\n> It might be better to keep that for a follow-up ticket.\n\nRight. And thinking more, I am not so sure about the overhead as Python int (for -5 <= i < 128) do not need allocation.\n\nVincent",
    "created_at": "2015-01-23T12:17:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238308",
    "user": "https://github.com/videlec"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@jdemeyer](#comment:6):
> Replying to [@videlec](#comment:5):
> > I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.

> It might be better to keep that for a follow-up ticket.

Right. And thinking more, I am not so sure about the overhead as Python int (for -5 <= i < 128) do not need allocation.

Vincent



---

archive/issue_events_251690.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2015-01-23T18:44:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251690"
}
```



---

archive/issue_events_251691.json:
```json
{
    "actor": "https://github.com/gagern",
    "created_at": "2015-01-23T18:44:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251691"
}
```



---

archive/issue_comments_238309.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\n\n```\nsage -t --long --warn-long 46.2 src/sage/matrix/matrix_space.py\n**********************************************************************\nFile \"src/sage/matrix/matrix_space.py\", line 1649, in sage.matrix.matrix_space.test_trivial_matrices_inverse\nFailed example:\n    tinv(QQ['x,y'], sparse=True)\nException raised:\n    Traceback (most recent call last):\n      File \"local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 488, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 850, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.matrix.matrix_space.test_trivial_matrices_inverse[17]>\", line 1, in <module>\n        tinv(QQ['x,y'], sparse=True)\n      File \"local/lib/python2.7/site-packages/sage/matrix/matrix_space.py\", line 1658, in test_trivial_matrices_inverse\n        assert(m00.inverse() == m00)\n    AssertionError\n**********************************************************************\n1 item had failures:\n   1 of  20 in sage.matrix.matrix_space.test_trivial_matrices_inverse\n    [261 tests, 1 failure, 2.72 s]\n```",
    "created_at": "2015-01-23T18:44:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238309",
    "user": "https://github.com/gagern"
}
```

<div id="comment:8" align="right">comment:8</div>


```
sage -t --long --warn-long 46.2 src/sage/matrix/matrix_space.py
**********************************************************************
File "src/sage/matrix/matrix_space.py", line 1649, in sage.matrix.matrix_space.test_trivial_matrices_inverse
Failed example:
    tinv(QQ['x,y'], sparse=True)
Exception raised:
    Traceback (most recent call last):
      File "local/lib/python2.7/site-packages/sage/doctest/forker.py", line 488, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "local/lib/python2.7/site-packages/sage/doctest/forker.py", line 850, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix_space.test_trivial_matrices_inverse[17]>", line 1, in <module>
        tinv(QQ['x,y'], sparse=True)
      File "local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 1658, in test_trivial_matrices_inverse
        assert(m00.inverse() == m00)
    AssertionError
**********************************************************************
1 item had failures:
   1 of  20 in sage.matrix.matrix_space.test_trivial_matrices_inverse
    [261 tests, 1 failure, 2.72 s]
```



---

archive/issue_comments_238310.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI'm curious about the statement \"This datastructure is not very efficient.\" Instead of asking you to explain it here, I think it's reasonable to assume that other people will be curious about it, too, so it should be explained in the docstring where you've introduced it.",
    "created_at": "2015-01-23T19:43:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238310",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:9" align="right">comment:9</div>

I'm curious about the statement "This datastructure is not very efficient." Instead of asking you to explain it here, I think it's reasonable to assume that other people will be curious about it, too, so it should be explained in the docstring where you've introduced it.



---

archive/issue_comments_238311.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d6302e4ce044a95a78f7c1437d712c9ee0c870a1\">d6302e4</a></td><td><code>Fix doctest and more documentation</code></td></tr></table>\n",
    "created_at": "2015-01-23T21:33:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238311",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d6302e4ce044a95a78f7c1437d712c9ee0c870a1">d6302e4</a></td><td><code>Fix doctest and more documentation</code></td></tr></table>




---

archive/issue_comments_238312.json:
```json
{
    "body": "Changed commit from **[b7e215d](https://github.com/sagemath/sagetrac-mirror/commit/b7e215dfc871214b8c74997d65422ea7467b3502)** to **[d6302e4](https://github.com/sagemath/sagetrac-mirror/commit/d6302e4ce044a95a78f7c1437d712c9ee0c870a1)**",
    "created_at": "2015-01-23T21:33:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238312",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b7e215d](https://github.com/sagemath/sagetrac-mirror/commit/b7e215dfc871214b8c74997d65422ea7467b3502)** to **[d6302e4](https://github.com/sagemath/sagetrac-mirror/commit/d6302e4ce044a95a78f7c1437d712c9ee0c870a1)**



---

archive/issue_events_251692.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-23T21:38:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251692"
}
```



---

archive/issue_events_251693.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-23T21:38:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251693"
}
```



---

archive/issue_comments_238313.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@gagern](#comment:8):\n\nVery strange. Actually, when you try to convert matrix from a ring to another you might end up to call the constructor of `MatrixGenericSparse` with arguments `entries=[]`. And so, the case of the empty list needs to be treated!! I added a long comment in the constructor and it might be appropriate to actually modify the code in `MatrixSpace.matrix`.\n\nReplying to [@jhpalmieri](#comment:9)\n\nTrue. I added two sentences in a `.. NOTE::`. Actually, I have no idea about the potential speed up.\n\nVincent",
    "created_at": "2015-01-23T21:38:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238313",
    "user": "https://github.com/videlec"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@gagern](#comment:8):

Very strange. Actually, when you try to convert matrix from a ring to another you might end up to call the constructor of `MatrixGenericSparse` with arguments `entries=[]`. And so, the case of the empty list needs to be treated!! I added a long comment in the constructor and it might be appropriate to actually modify the code in `MatrixSpace.matrix`.

Replying to [@jhpalmieri](#comment:9)

True. I added two sentences in a `.. NOTE::`. Actually, I have no idea about the potential speed up.

Vincent



---

archive/issue_comments_238314.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b52ad708d1190c4b5de75bcbafd4f59c13a5c84b\">b52ad70</a></td><td><code>Fix doctest and more documentation</code></td></tr></table>\n",
    "created_at": "2015-01-23T21:41:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238314",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b52ad708d1190c4b5de75bcbafd4f59c13a5c84b">b52ad70</a></td><td><code>Fix doctest and more documentation</code></td></tr></table>




---

archive/issue_comments_238315.json:
```json
{
    "body": "Changed commit from **[d6302e4](https://github.com/sagemath/sagetrac-mirror/commit/d6302e4ce044a95a78f7c1437d712c9ee0c870a1)** to **[b52ad70](https://github.com/sagemath/sagetrac-mirror/commit/b52ad708d1190c4b5de75bcbafd4f59c13a5c84b)**",
    "created_at": "2015-01-23T21:41:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238315",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[d6302e4](https://github.com/sagemath/sagetrac-mirror/commit/d6302e4ce044a95a78f7c1437d712c9ee0c870a1)** to **[b52ad70](https://github.com/sagemath/sagetrac-mirror/commit/b52ad708d1190c4b5de75bcbafd4f59c13a5c84b)**



---

archive/issue_comments_238316.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThe nonzero doctest has me confused:\n\n```\nsage: bool(m)\nFalse\nsage: m.is_zero() # indirect doctest\nTrue\n```\n\nWhy is the first expected to be false? Shouldn't a zero matrix evaluate as zero? Isn't one invariant the fact that all entries in the dict must be non-zero?",
    "created_at": "2015-01-24T09:08:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238316",
    "user": "https://github.com/gagern"
}
```

<div id="comment:13" align="right">comment:13</div>

The nonzero doctest has me confused:

```
sage: bool(m)
False
sage: m.is_zero() # indirect doctest
True
```

Why is the first expected to be false? Shouldn't a zero matrix evaluate as zero? Isn't one invariant the fact that all entries in the dict must be non-zero?



---

archive/issue_comments_238317.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@gagern](#comment:13):\n> The nonzero doctest has me confused:\n> \n> ```\n> sage: bool(m)\n> False\n> sage: m.is_zero() # indirect doctest\n> True\n> ```\n> Why is the first expected to be false?\n> Shouldn't a zero matrix evaluate as zero?\n\nIt is like 0\n\n```\nsage: bool(0)\nFalse\nsage: 0.is_zero()\nTrue\n```\n\nWe have zero <-> False and non-zero <-> True\n\n> Isn't one invariant the fact that all entries in the dict must be non-zero?\n\nYes, it is. So that the matrix is zero if and only if the dict is empty.\n\nVincent",
    "created_at": "2015-01-24T09:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238317",
    "user": "https://github.com/videlec"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@gagern](#comment:13):
> The nonzero doctest has me confused:
> 
> ```
> sage: bool(m)
> False
> sage: m.is_zero() # indirect doctest
> True
> ```
> Why is the first expected to be false?
> Shouldn't a zero matrix evaluate as zero?

It is like 0

```
sage: bool(0)
False
sage: 0.is_zero()
True
```

We have zero <-> False and non-zero <-> True

> Isn't one invariant the fact that all entries in the dict must be non-zero?

Yes, it is. So that the matrix is zero if and only if the dict is empty.

Vincent



---

archive/issue_comments_238318.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nSorry, had a knot in my thoughts. Read this before becoming fully awake, I guess. I'm running the full test suite again, then I'll have a (hopefully final) look at the code.",
    "created_at": "2015-01-24T09:59:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238318",
    "user": "https://github.com/gagern"
}
```

<div id="comment:15" align="right">comment:15</div>

Sorry, had a knot in my thoughts. Read this before becoming fully awake, I guess. I'm running the full test suite again, then I'll have a (hopefully final) look at the code.



---

archive/issue_comments_238319.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@gagern](#comment:15):\n> Sorry, had a knot in my thoughts. Read this before becoming fully awake, I guess.\n\n:-)",
    "created_at": "2015-01-24T10:01:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238319",
    "user": "https://github.com/videlec"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@gagern](#comment:15):
> Sorry, had a knot in my thoughts. Read this before becoming fully awake, I guess.

:-)



---

archive/issue_comments_238320.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@gagern](#comment:15):\n> Sorry, had a knot in my thoughts.\n\nDid you look too much at #17030 by chance :-)",
    "created_at": "2015-01-24T10:07:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238320",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@gagern](#comment:15):
> Sorry, had a knot in my thoughts.

Did you look too much at #17030 by chance :-)



---

archive/issue_comments_238321.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@jdemeyer](#comment:17):\n> Did you look too much at #17030 by chance :-)\n\n:-D\n\nThat would be a very professional excuse, but I guess I was thinking more along the lines `bool(\u2026)` vs. `x.__nonzero__()` (which should behave the same) instead of `bool(x)` vs. `x.is_zero()` as the doctest used them.\n\nSome more comments from reading the latest commit.\n* `if entries is None or not entries` could be shortened to `if not entries`.\n* `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n\nOne more thing, not related to that last commit. Contrary to other sparse matrix implementations, we don't do a range check for inputs. Of course, that might be considered a bug in its own right, but if you feel like it, you could address this here as well.\n\n```\nsage: m = matrix(Zmod(5)['x'],2,2,{(3,3):2}) # this APPEARS to work at first\nsage: m.is_zero()\nFalse\nsage: m\n<repr(<sage.matrix.matrix_generic_sparse.Matrix_generic_sparse at 0x7fc795dcbf50>) failed: IndexError: list assignment index out of range>\nsage: matrix(Zmod(5),2,2,{(3,3):2}) # this reports the problem early on\n...\nIndexError: invalid entries list\n```",
    "created_at": "2015-01-24T11:03:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238321",
    "user": "https://github.com/gagern"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@jdemeyer](#comment:17):
> Did you look too much at #17030 by chance :-)

:-D

That would be a very professional excuse, but I guess I was thinking more along the lines `bool(…)` vs. `x.__nonzero__()` (which should behave the same) instead of `bool(x)` vs. `x.is_zero()` as the doctest used them.

Some more comments from reading the latest commit.
* `if entries is None or not entries` could be shortened to `if not entries`.
* `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.

One more thing, not related to that last commit. Contrary to other sparse matrix implementations, we don't do a range check for inputs. Of course, that might be considered a bug in its own right, but if you feel like it, you could address this here as well.

```
sage: m = matrix(Zmod(5)['x'],2,2,{(3,3):2}) # this APPEARS to work at first
sage: m.is_zero()
False
sage: m
<repr(<sage.matrix.matrix_generic_sparse.Matrix_generic_sparse at 0x7fc795dcbf50>) failed: IndexError: list assignment index out of range>
sage: matrix(Zmod(5),2,2,{(3,3):2}) # this reports the problem early on
...
IndexError: invalid entries list
```



---

archive/issue_comments_238322.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@gagern](#comment:18):\n> Some more comments from reading the latest commit.\n> * `if entries is None or not entries` could be shortened to `if not entries`.\n\nIt depends on the school! \"my_var is None\" is a simple address lookup while \"not my_var\" implies a function call. So \"my_var is None\" is very fast compared to \"not my_var\". But I agree that is fighting for micro seconds that are negligible looking at the rest of the code...\n\n> * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n\nActually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!\n\n> One more thing, not related to that last commit.\n\nIndeed, this needs to be fixed. I thought that `MatrixSpace` would have taken care of that. I will add a commit.\n\nVincent",
    "created_at": "2015-01-24T11:10:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238322",
    "user": "https://github.com/videlec"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@gagern](#comment:18):
> Some more comments from reading the latest commit.
> * `if entries is None or not entries` could be shortened to `if not entries`.

It depends on the school! "my_var is None" is a simple address lookup while "not my_var" implies a function call. So "my_var is None" is very fast compared to "not my_var". But I agree that is fighting for micro seconds that are negligible looking at the rest of the code...

> * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.

Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!

> One more thing, not related to that last commit.

Indeed, this needs to be fixed. I thought that `MatrixSpace` would have taken care of that. I will add a commit.

Vincent



---

archive/issue_comments_238323.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/79b9ddb64ca846c48cd191a8e7e052f7effa7a4b\">79b9ddb</a></td><td><code>check indices range</code></td></tr></table>\n",
    "created_at": "2015-01-24T11:33:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238323",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/79b9ddb64ca846c48cd191a8e7e052f7effa7a4b">79b9ddb</a></td><td><code>check indices range</code></td></tr></table>




---

archive/issue_comments_238324.json:
```json
{
    "body": "Changed commit from **[b52ad70](https://github.com/sagemath/sagetrac-mirror/commit/b52ad708d1190c4b5de75bcbafd4f59c13a5c84b)** to **[79b9ddb](https://github.com/sagemath/sagetrac-mirror/commit/79b9ddb64ca846c48cd191a8e7e052f7effa7a4b)**",
    "created_at": "2015-01-24T11:33:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238324",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b52ad70](https://github.com/sagemath/sagetrac-mirror/commit/b52ad708d1190c4b5de75bcbafd4f59c13a5c84b)** to **[79b9ddb](https://github.com/sagemath/sagetrac-mirror/commit/79b9ddb64ca846c48cd191a8e7e052f7effa7a4b)**



---

archive/issue_comments_238325.json:
```json
{
    "body": "Changed commit from **[79b9ddb](https://github.com/sagemath/sagetrac-mirror/commit/79b9ddb64ca846c48cd191a8e7e052f7effa7a4b)** to **[8e90cbd](https://github.com/sagemath/sagetrac-mirror/commit/8e90cbd79a5accee51ecea6cf298705ca9f2d1a8)**",
    "created_at": "2015-01-24T11:34:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238325",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[79b9ddb](https://github.com/sagemath/sagetrac-mirror/commit/79b9ddb64ca846c48cd191a8e7e052f7effa7a4b)** to **[8e90cbd](https://github.com/sagemath/sagetrac-mirror/commit/8e90cbd79a5accee51ecea6cf298705ca9f2d1a8)**



---

archive/issue_comments_238326.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8e90cbd79a5accee51ecea6cf298705ca9f2d1a8\">8e90cbd</a></td><td><code>check indices range</code></td></tr></table>\n",
    "created_at": "2015-01-24T11:34:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238326",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8e90cbd79a5accee51ecea6cf298705ca9f2d1a8">8e90cbd</a></td><td><code>check indices range</code></td></tr></table>




---

archive/issue_comments_238327.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nSorry, wrong doctests. I had to do a forced push.",
    "created_at": "2015-01-24T11:35:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238327",
    "user": "https://github.com/videlec"
}
```

<div id="comment:22" align="right">comment:22</div>

Sorry, wrong doctests. I had to do a forced push.



---

archive/issue_comments_238328.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nIs there any way to actually reach that `The input must be scalar or a dictionary` exception? Since the \u201centries is not a dict\u201d case is already handled before, I think not.\n\nThe comment about the `coerce=False` case sounds like someone asking for a revival of #17658. So if anyone wonders just how bad this \u201creally bad\u201d could be, I'd say \u201cvery bad indeed\u201d.",
    "created_at": "2015-01-24T13:33:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238328",
    "user": "https://github.com/gagern"
}
```

<div id="comment:23" align="right">comment:23</div>

Is there any way to actually reach that `The input must be scalar or a dictionary` exception? Since the “entries is not a dict” case is already handled before, I think not.

The comment about the `coerce=False` case sounds like someone asking for a revival of #17658. So if anyone wonders just how bad this “really bad” could be, I'd say “very bad indeed”.



---

archive/issue_comments_238329.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nPlease remove\n\n```python\n## def _sparse_dot_product(v, w):\n##     \"\"\"\n##     INPUT:\n##         v and w are dictionaries with integer keys.\n##     \"\"\"\n##     x = set(v.keys()).intersection(set(w.keys()))\n##     a = 0\n##     for k in x:\n##         a = a + v[k]*w[k]\n##     return a\n```",
    "created_at": "2015-01-24T14:01:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238329",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Please remove

```python
## def _sparse_dot_product(v, w):
##     """
##     INPUT:
##         v and w are dictionaries with integer keys.
##     """
##     x = set(v.keys()).intersection(set(w.keys()))
##     a = 0
##     for k in x:
##         a = a + v[k]*w[k]
##     return a
```



---

archive/issue_events_251694.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-01-24T14:01:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251694"
}
```



---

archive/issue_events_251695.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-01-24T14:01:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251695"
}
```



---

archive/issue_events_251696.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-01-24T14:12:51Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "title_is": "Clean up sparse matrices",
    "title_was": "clean sparse matrices",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251696"
}
```



---

archive/issue_comments_238330.json:
```json
{
    "body": "Changed commit from **[8e90cbd](https://github.com/sagemath/sagetrac-mirror/commit/8e90cbd79a5accee51ecea6cf298705ca9f2d1a8)** to **[d8ca206](https://github.com/sagemath/sagetrac-mirror/commit/d8ca20698c0e03a9da4f5c6cbaab32387ed4df6b)**",
    "created_at": "2015-01-24T14:14:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238330",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[8e90cbd](https://github.com/sagemath/sagetrac-mirror/commit/8e90cbd79a5accee51ecea6cf298705ca9f2d1a8)** to **[d8ca206](https://github.com/sagemath/sagetrac-mirror/commit/d8ca20698c0e03a9da4f5c6cbaab32387ed4df6b)**



---

archive/issue_comments_238331.json:
```json
{
    "body": "<div id=\"comment:26\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d8ca20698c0e03a9da4f5c6cbaab32387ed4df6b\">d8ca206</a></td><td><code>remove commented code</code></td></tr></table>\n",
    "created_at": "2015-01-24T14:14:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238331",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d8ca20698c0e03a9da4f5c6cbaab32387ed4df6b">d8ca206</a></td><td><code>remove commented code</code></td></tr></table>




---

archive/issue_comments_238332.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jdemeyer](#comment:24):\n\nIs there anything special about that one comment block? There are similar comments all over the file, although most come from [2076edf](https://github.com/sagemath/sagetrac-mirror/commit/2076edfc5e985d848980204f103a1157087350f1) while the one you wanted removed comes from [43baa1b](https://github.com/sagemath/sagetrac-mirror/commit/43baa1bbc23e4a0f84c37d72f411c1a04ad1fa72). Does that have anything to do with your choice, or is simply that this one comment appeared in the diff?",
    "created_at": "2015-01-24T15:28:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238332",
    "user": "https://github.com/gagern"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jdemeyer](#comment:24):

Is there anything special about that one comment block? There are similar comments all over the file, although most come from [2076edf](https://github.com/sagemath/sagetrac-mirror/commit/2076edfc5e985d848980204f103a1157087350f1) while the one you wanted removed comes from [43baa1b](https://github.com/sagemath/sagetrac-mirror/commit/43baa1bbc23e4a0f84c37d72f411c1a04ad1fa72). Does that have anything to do with your choice, or is simply that this one comment appeared in the diff?



---

archive/issue_comments_238333.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@gagern](#comment:27):\n> Is there anything special about that one comment block?\n\nIt's because somebody complained in #17583 about this particular comment block.",
    "created_at": "2015-01-24T16:52:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238333",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@gagern](#comment:27):
> Is there anything special about that one comment block?

It's because somebody complained in #17583 about this particular comment block.



---

archive/issue_events_251697.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-24T20:07:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251697"
}
```



---

archive/issue_events_251698.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-24T20:07:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251698"
}
```



---

archive/issue_comments_238334.json:
```json
{
    "body": "Changed commit from **[d8ca206](https://github.com/sagemath/sagetrac-mirror/commit/d8ca20698c0e03a9da4f5c6cbaab32387ed4df6b)** to **[d292e6f](https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add)**",
    "created_at": "2015-01-25T22:40:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238334",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[d8ca206](https://github.com/sagemath/sagetrac-mirror/commit/d8ca20698c0e03a9da4f5c6cbaab32387ed4df6b)** to **[d292e6f](https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add)**



---

archive/issue_comments_238335.json:
```json
{
    "body": "<div id=\"comment:30\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add\">d292e6f</a></td><td><code>Drop dead code.</code></td></tr></table>\n",
    "created_at": "2015-01-25T22:40:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238335",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:30"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add">d292e6f</a></td><td><code>Drop dead code.</code></td></tr></table>




---

archive/issue_comments_238336.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@videlec](#comment:19):\n> It depends on the school! \"my_var is None\" is a simple address lookup while \"not my_var\" implies a function call. So \"my_var is None\" is very fast compared to \"not my_var\".\n\nValid point, so I won't object to leave the code as it is. Might even adapt that style.\n\n> > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n\n> \n> Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!\n\nCan't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.\n\nMy question about the `The input must be scalar or a dictionary` exception being dead code (from [comment:23](#comment:23)) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.",
    "created_at": "2015-01-25T22:42:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238336",
    "user": "https://github.com/gagern"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@videlec](#comment:19):
> It depends on the school! "my_var is None" is a simple address lookup while "not my_var" implies a function call. So "my_var is None" is very fast compared to "not my_var".

Valid point, so I won't object to leave the code as it is. Might even adapt that style.

> > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.

> 
> Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!

Can't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.

My question about the `The input must be scalar or a dictionary` exception being dead code (from [comment:23](#comment:23)) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.



---

archive/issue_events_251699.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-25T22:56:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251699"
}
```



---

archive/issue_events_251700.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-01-25T22:56:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251700"
}
```



---

archive/issue_comments_238337.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@gagern](#comment:31):\n> Replying to [@videlec](#comment:19):\n> > It depends on the school! \"my_var is None\" is a simple address lookup while \"not my_var\" implies a function call. So \"my_var is None\" is very fast compared to \"not my_var\".\n\n> \n> Valid point, so I won't object to leave the code as it is. Might even adapt that style.\n\n;-)\n\n> > > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n\n> > \n> > Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!\n\n> \n> Can't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.\n\nAt some point, I had trouble with this but I do not remember exactly. I just learn a funny way to do it returning 1,0 or -1 fast:\n\n```\nreturn (i > j) - (i < j)\n```\n\n> My question about the `The input must be scalar or a dictionary` exception being dead code (from [comment:23](#comment:23)) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.\n\nThanks for that!\n\nVincent",
    "created_at": "2015-01-25T22:56:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238337",
    "user": "https://github.com/videlec"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@gagern](#comment:31):
> Replying to [@videlec](#comment:19):
> > It depends on the school! "my_var is None" is a simple address lookup while "not my_var" implies a function call. So "my_var is None" is very fast compared to "not my_var".

> 
> Valid point, so I won't object to leave the code as it is. Might even adapt that style.

;-)

> > > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.

> > 
> > Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!

> 
> Can't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.

At some point, I had trouble with this but I do not remember exactly. I just learn a funny way to do it returning 1,0 or -1 fast:

```
return (i > j) - (i < j)
```

> My question about the `The input must be scalar or a dictionary` exception being dead code (from [comment:23](#comment:23)) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.

Thanks for that!

Vincent



---

archive/issue_comments_238338.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nAnd thanks for the review!\n\nVincent",
    "created_at": "2015-01-25T23:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238338",
    "user": "https://github.com/videlec"
}
```

<div id="comment:33" align="right">comment:33</div>

And thanks for the review!

Vincent



---

archive/issue_comments_238339.json:
```json
{
    "body": "Changed branch from **[public/17663](https://github.com/sagemath/sagetrac-mirror/tree/public/17663)** to **[d292e6f](https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add)**",
    "created_at": "2015-01-29T13:26:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17663#issuecomment-238339",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/17663](https://github.com/sagemath/sagetrac-mirror/tree/public/17663)** to **[d292e6f](https://github.com/sagemath/sagetrac-mirror/commit/d292e6ff17ea1815e5b24267a6d0140ea5598add)**



---

archive/issue_events_251701.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-01-29T13:26:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251701"
}
```



---

archive/issue_events_251702.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "bacf687d5c23a7b484cb0b26d38b09b12aa5bc47",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-01-29T13:26:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/17663",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17663#event-251702"
}
```
