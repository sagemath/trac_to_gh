# Issue 17712: Adds memoization to the branch and bound for vertex separation

archive/issues_017475.json:
```json
{
    "body": "This patch adds to the branch and bound algorithm for the vertex separation (#17647) a kind of memoization tool for storing prefixes as proposed in [CMN14]. This can significantly reduce the number of nodes of the branch-and-bound tree to consider.\n\n\nReference:\n[CMN14] D. Coudert, D. Mazauric, N. Nisse. *Experimental Evaluation of a Branch and Bound Algorithm for computing Pathwidth*. In SEA'13, LNCS vol. 8504, pp.46-58, 2014.\n\nCC:  @nathanncohen\n\nBranch/Commit: 93e9a0ab8ffae7ae695e51f8a89ca72994c3a9de\n\nReviewer: Nathann Cohen\n\nAuthor: David Coudert\n\nDependencies: #17711\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17712\n\n",
    "closed_at": "2015-02-18T23:22:42Z",
    "created_at": "2015-02-01T14:59:18Z",
    "labels": [
        "component: graph theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Adds memoization to the branch and bound for vertex separation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17712",
    "user": "https://github.com/dcoudert"
}
```
This patch adds to the branch and bound algorithm for the vertex separation (#17647) a kind of memoization tool for storing prefixes as proposed in [CMN14]. This can significantly reduce the number of nodes of the branch-and-bound tree to consider.


Reference:
[CMN14] D. Coudert, D. Mazauric, N. Nisse. *Experimental Evaluation of a Branch and Bound Algorithm for computing Pathwidth*. In SEA'13, LNCS vol. 8504, pp.46-58, 2014.

CC:  @nathanncohen

Branch/Commit: 93e9a0ab8ffae7ae695e51f8a89ca72994c3a9de

Reviewer: Nathann Cohen

Author: David Coudert

Dependencies: #17711

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17712





---

archive/issue_comments_233147.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-02-05T15:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233147",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_233148.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-05T16:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233148",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233149.json:
```json
{
    "body": "<a id='comment:4'></a>I have pushed a first draft for storing prefixes.\nWe can certainly reduce further the computation time, but I don't know how. Also, I tried to be as simple as possible.\n\nDavid.",
    "created_at": "2015-02-05T16:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233149",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:4'></a>I have pushed a first draft for storing prefixes.
We can certainly reduce further the computation time, but I don't know how. Also, I tried to be as simple as possible.

David.



---

archive/issue_comments_233150.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-05T16:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233150",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_233151.json:
```json
{
    "body": "<a id='comment:5'></a>Hello David,\n\nA short review before going to sleep:\n\n1) You do not seem to do anything at all with `max_prefix_number`.\n\n2) You add parameters in `path_decomposition` but you don't do\nanything with them.\n\n3) Given that you seem to only store sets of integers, I am\ntempted to think that you should prefer `FrozenBitset` objects\nover `frozenset`. They should give you a faster hash/equality\ntest.\n\n4) There are many empty docstrings in the methods of\n`PrefixStorage`. And to be honest, considering the amount of doc\nit takes to implement all of that, I wonder if it would not be\nbetter to leave it all in the code, without creating a new\nclass. \"Just a dictionary whose keys are bitsets\".\n\nIn order to not have too many things in the actual\nbranch-and-bound, it may be enough to have just a couple of\nfunctions (your update/is_known_prefix) taking a dictionary as an\nadditional argument.\n\nGood night,\n\nNathann",
    "created_at": "2015-02-05T22:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233151",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:5'></a>Hello David,

A short review before going to sleep:

1) You do not seem to do anything at all with `max_prefix_number`.

2) You add parameters in `path_decomposition` but you don't do
anything with them.

3) Given that you seem to only store sets of integers, I am
tempted to think that you should prefer `FrozenBitset` objects
over `frozenset`. They should give you a faster hash/equality
test.

4) There are many empty docstrings in the methods of
`PrefixStorage`. And to be honest, considering the amount of doc
it takes to implement all of that, I wonder if it would not be
better to leave it all in the code, without creating a new
class. "Just a dictionary whose keys are bitsets".

In order to not have too many things in the actual
branch-and-bound, it may be enough to have just a couple of
functions (your update/is_known_prefix) taking a dictionary as an
additional argument.

Good night,

Nathann



---

archive/issue_comments_233152.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-05T22:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233152",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_233153.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-05T22:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233153",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233154.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 ncohen]:\n> Hello David,\n> \n> A short review before going to sleep:\n> \n> 1) You do not seem to do anything at all with `max_prefix_number`.\n\n\nNow used. I forgot some parts. Surprizingly you are less efficient when the heating system of your building is broken during winter time...\n\nAlso I'm now only recording 1 boolean per prefix. We don't need to store the cost.\n \n> 2) You add parameters in `path_decomposition` but you don't do\n> anything with them.\n\nFixed\n  \n> 3) Given that you seem to only store sets of integers, I am\n> tempted to think that you should prefer `FrozenBitset` objects\n> over `frozenset`. They should give you a faster hash/equality\n> test.\n\nMy tests gives better performances with `frozenset`. But if you have better ideas...\n  \n> 4) There are many empty docstrings in the methods of\n> `PrefixStorage`. And to be honest, considering the amount of doc\n> it takes to implement all of that, I wonder if it would not be\n> better to leave it all in the code, without creating a new\n> class. \"Just a dictionary whose keys are bitsets\".\n> \n> In order to not have too many things in the actual\n> branch-and-bound, it may be enough to have just a couple of\n> functions (your update/is_known_prefix) taking a dictionary as an\n> additional argument.\n\nThe main advantage of the class is to hide all the parameters. It is very useful to be able to tune these parameters according the amount of memory you have. Passing the dict as parameter, we would also have to pass other parameters.\nI'm not convinced that it would really be shorter to have 2 functions instead of this class. \n\nWe could however save the `enable_prefix_storage` parameter since we can obtain the same behavior setting `max_prefix_length=0`.\n\n \n> Good night,\n> \n> Nathann\n\n\n\nIf you want to know the kind of speedup we get for a quite hard instance:\n\n```\nsage: G = graphs.MycielskiGraph(5)\nsage: %timeit vs, seq = VS.vertex_separation_BAB(G, enable_prefix_storage=True)\n1000 loops, best of 3: 1.3 ms per loop\nsage: %timeit vs, seq = VS.vertex_separation_BAB(G, enable_prefix_storage=False)\n100 loops, best of 3: 2.19 ms per loop\n\nsage: G = graphs.MycielskiGraph(6)\nsage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=20)\n1 loops, best of 3: 1.05 s per loop\nsage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=10)\n1 loops, best of 3: 1.84 s per loop\nsage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=8)\n1 loops, best of 3: 12 s per loop\nsage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=7)\n1 loops, best of 3: 40.8 s per loop\n```\n\nI have not tested `VS.vertex_separation_BAB(G, enable_prefix_storage=False)` with this version of the prefix storage. With a former version (using trees and so much more ugly code) it was around 40min, so with dict should be more than 1h\n\nDavid.",
    "created_at": "2015-02-05T23:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233154",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>Replying to [comment:5 ncohen]:
> Hello David,
> 
> A short review before going to sleep:
> 
> 1) You do not seem to do anything at all with `max_prefix_number`.


Now used. I forgot some parts. Surprizingly you are less efficient when the heating system of your building is broken during winter time...

Also I'm now only recording 1 boolean per prefix. We don't need to store the cost.
 
> 2) You add parameters in `path_decomposition` but you don't do
> anything with them.

Fixed
  
> 3) Given that you seem to only store sets of integers, I am
> tempted to think that you should prefer `FrozenBitset` objects
> over `frozenset`. They should give you a faster hash/equality
> test.

My tests gives better performances with `frozenset`. But if you have better ideas...
  
> 4) There are many empty docstrings in the methods of
> `PrefixStorage`. And to be honest, considering the amount of doc
> it takes to implement all of that, I wonder if it would not be
> better to leave it all in the code, without creating a new
> class. "Just a dictionary whose keys are bitsets".
> 
> In order to not have too many things in the actual
> branch-and-bound, it may be enough to have just a couple of
> functions (your update/is_known_prefix) taking a dictionary as an
> additional argument.

The main advantage of the class is to hide all the parameters. It is very useful to be able to tune these parameters according the amount of memory you have. Passing the dict as parameter, we would also have to pass other parameters.
I'm not convinced that it would really be shorter to have 2 functions instead of this class. 

We could however save the `enable_prefix_storage` parameter since we can obtain the same behavior setting `max_prefix_length=0`.

 
> Good night,
> 
> Nathann



If you want to know the kind of speedup we get for a quite hard instance:

```
sage: G = graphs.MycielskiGraph(5)
sage: %timeit vs, seq = VS.vertex_separation_BAB(G, enable_prefix_storage=True)
1000 loops, best of 3: 1.3 ms per loop
sage: %timeit vs, seq = VS.vertex_separation_BAB(G, enable_prefix_storage=False)
100 loops, best of 3: 2.19 ms per loop

sage: G = graphs.MycielskiGraph(6)
sage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=20)
1 loops, best of 3: 1.05 s per loop
sage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=10)
1 loops, best of 3: 1.84 s per loop
sage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=8)
1 loops, best of 3: 12 s per loop
sage: %timeit vs, seq = VS.vertex_separation_BAB(G, max_prefix_length=7)
1 loops, best of 3: 40.8 s per loop
```

I have not tested `VS.vertex_separation_BAB(G, enable_prefix_storage=False)` with this version of the prefix storage. With a former version (using trees and so much more ugly code) it was around 40min, so with dict should be more than 1h

David.



---

archive/issue_comments_233155.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-06T17:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233155",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233156.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-07T12:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233156",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233157.json:
```json
{
    "body": "<a id='comment:10'></a>Hello again,\n\nI am working again on this patch, and I cannot say that I like this `PrefixStorage` class very much. To make it simple it is just a dictionary, in which you seem to store all values that you do not want to carry around as parameters of the `BAB_C` function.\n\nSome parameters are almost impossible to document in the `PrefixStorage` class and can only be understood if you know exactly where they are called from the inside of the `BAB_C` function.\n\nI removed some undocumented functions from `PrefixStorage` that you did not call (as well as the undocumented `__len__`). Please make sure that `sage -coverage <file>` does not return anything wrong before you submit a patch for review.\n\n....\n\nOkay, and I just noticed that you pushed a new commit on this `needs_review` patch. So now I will see whether it breaks all my modifications.\n\nToday is not a good day.\n\nNathann\n\n---\nNew commits:",
    "created_at": "2015-02-07T12:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233157",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:10'></a>Hello again,

I am working again on this patch, and I cannot say that I like this `PrefixStorage` class very much. To make it simple it is just a dictionary, in which you seem to store all values that you do not want to carry around as parameters of the `BAB_C` function.

Some parameters are almost impossible to document in the `PrefixStorage` class and can only be understood if you know exactly where they are called from the inside of the `BAB_C` function.

I removed some undocumented functions from `PrefixStorage` that you did not call (as well as the undocumented `__len__`). Please make sure that `sage -coverage <file>` does not return anything wrong before you submit a patch for review.

....

Okay, and I just noticed that you pushed a new commit on this `needs_review` patch. So now I will see whether it breaks all my modifications.

Today is not a good day.

Nathann

---
New commits:



---

archive/issue_comments_233158.json:
```json
{
    "body": "<a id='comment:11'></a>Sorry, sorry, sorry, sorry, I removed the enable prefix storage parameter to shorten the doc. Really sorry if I breaks your edits...",
    "created_at": "2015-02-07T12:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233158",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:11'></a>Sorry, sorry, sorry, sorry, I removed the enable prefix storage parameter to shorten the doc. Really sorry if I breaks your edits...



---

archive/issue_comments_233159.json:
```json
{
    "body": "<a id='comment:12'></a>If you believe it is better to add extra parameters to `BAB_C` (dict, max length, max number, etc.) and to remove this class, we can try.",
    "created_at": "2015-02-07T12:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233159",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:12'></a>If you believe it is better to add extra parameters to `BAB_C` (dict, max length, max number, etc.) and to remove this class, we can try.



---

archive/issue_comments_233160.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-07T13:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233160",
    "user": "https://github.com/nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_233161.json:
```json
{
    "body": "<a id='comment:13'></a>Hello again,\n\nThis commit does what was said above, and also rephrases the short description of the caching mechanism in the module's doc. I hope that it is clearer.\n\nAs you just removed a keyword I also wondered about the use of \"is_on\".\n\nTwo remarks:\n\n1) Right now you 'store' the size of the dictionary in an integer variable. To do this, every time you add a new element in the dictionary, you check whether the element is there already. Thus, each of the `+1` costs you a lookup, theoretically a `log(n)` operation. I have not run any timings, but I would be a bit troubled if calling `len(the_dict)` was not faster.\n\n2) I still do not understand the point of the dictionary: what are \"False\" values useful for ? Why isn't it just a set of frozensets ?\n\n3) \n\n```\n~/sage/graphs/graph_decompositions$ sage -coverage vertex_separation.pyx \n------------------------------------------------------------------------\nSCORE vertex_separation.pyx: 88.9% (8 of 9)\n\nMissing doctests:\n     * line 1663: def __init__(self, int max_prefix_length=20, int max_prefix_number=10**6)\n------------------------------------------------------------------------\n```\n\nNathann\n\nP.S. : About removing this `PrefixStorage`: let us first see what happens with this dict/set question. My intuition is that if this thing becomes a set you can already remove `cost/upper_bound/is_improved` from `update()` (and only call 'update' when appropriate) which may already simplify matters.",
    "created_at": "2015-02-07T13:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233161",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:13'></a>Hello again,

This commit does what was said above, and also rephrases the short description of the caching mechanism in the module's doc. I hope that it is clearer.

As you just removed a keyword I also wondered about the use of "is_on".

Two remarks:

1) Right now you 'store' the size of the dictionary in an integer variable. To do this, every time you add a new element in the dictionary, you check whether the element is there already. Thus, each of the `+1` costs you a lookup, theoretically a `log(n)` operation. I have not run any timings, but I would be a bit troubled if calling `len(the_dict)` was not faster.

2) I still do not understand the point of the dictionary: what are "False" values useful for ? Why isn't it just a set of frozensets ?

3) 

```
~/sage/graphs/graph_decompositions$ sage -coverage vertex_separation.pyx 
------------------------------------------------------------------------
SCORE vertex_separation.pyx: 88.9% (8 of 9)

Missing doctests:
     * line 1663: def __init__(self, int max_prefix_length=20, int max_prefix_number=10**6)
------------------------------------------------------------------------
```

Nathann

P.S. : About removing this `PrefixStorage`: let us first see what happens with this dict/set question. My intuition is that if this thing becomes a set you can already remove `cost/upper_bound/is_improved` from `update()` (and only call 'update' when appropriate) which may already simplify matters.



---

archive/issue_comments_233162.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-07T13:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233162",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233163.json:
```json
{
    "body": "<a id='comment:16'></a>Hello Nathann,\n\nYou are right, we could use a set instead of a dictionary and add the prefix `P` to the set only if `c(P)<\\min_{L\\in{\\cal L}_P(V)} c(L)`.\n\nHowever, it is apparently faster to test if a frozenset is a key of a dictionary than if it is in a set.\n\n```\nsage: d = dict()\nsage: s = set()\nsage: for i in range(1, 11):\n....:     for z in Combinations(range(2*i), i):\n....:         d[frozenset(z)] = True\n....:         s.add(frozenset(z))\n....:         \nsage: len(d)\n250952\nsage: %timeit len(d)\n10000000 loops, best of 3: 63 ns per loop\nsage: %timeit len(s)\n10000000 loops, best of 3: 59.9 ns per loop\nsage:\nsage: elt = d.keys()[randint(0, len(d)-1)]\nsage: %timeit elt in d\n10000000 loops, best of 3: 60.9 ns per loop\nsage: %timeit elt in s\n10000000 loops, best of 3: 163 ns per loop\nsage:\nsage: elt = d.keys()[randint(0, len(d)-1)]\nsage: %timeit elt in d\n10000000 loops, best of 3: 58.8 ns per loop\nsage: %timeit elt in s\n10000000 loops, best of 3: 160 ns per loop\n```\n\n\nWhat we can do is to change `is_known_prefix` as follows:\n\n```\n        if size<1 or size>self.max_prefix_length:\n            return False\n\n        cdef int i\n        cdef frozenset my_prefix = frozenset([prefix[i] for i in range(size)])\n\n        return my_prefix in self.PT\n```\nand `update` as:\n\n```\n        cdef int i\n        if size>0 and size<=self.max_prefix_length \\\n           and not (is_improved and cost==upper_bound) \\\n           and len(self.PT)< self.max_prefix_number:\n\n            my_prefix = frozenset(prefix[i] for i in range(size))\n            self.PT[my_prefix] = True\n```\nFurthermore, if we do that inside `BAB_C`, we do only once `my_prefix = frozenset(prefix[i] for i in range(size))`.\n\nIf you agree, I will implement the changes.\n\nDavid.",
    "created_at": "2015-02-07T14:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233163",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:16'></a>Hello Nathann,

You are right, we could use a set instead of a dictionary and add the prefix `P` to the set only if `c(P)<\min_{L\in{\cal L}_P(V)} c(L)`.

However, it is apparently faster to test if a frozenset is a key of a dictionary than if it is in a set.

```
sage: d = dict()
sage: s = set()
sage: for i in range(1, 11):
....:     for z in Combinations(range(2*i), i):
....:         d[frozenset(z)] = True
....:         s.add(frozenset(z))
....:         
sage: len(d)
250952
sage: %timeit len(d)
10000000 loops, best of 3: 63 ns per loop
sage: %timeit len(s)
10000000 loops, best of 3: 59.9 ns per loop
sage:
sage: elt = d.keys()[randint(0, len(d)-1)]
sage: %timeit elt in d
10000000 loops, best of 3: 60.9 ns per loop
sage: %timeit elt in s
10000000 loops, best of 3: 163 ns per loop
sage:
sage: elt = d.keys()[randint(0, len(d)-1)]
sage: %timeit elt in d
10000000 loops, best of 3: 58.8 ns per loop
sage: %timeit elt in s
10000000 loops, best of 3: 160 ns per loop
```


What we can do is to change `is_known_prefix` as follows:

```
        if size<1 or size>self.max_prefix_length:
            return False

        cdef int i
        cdef frozenset my_prefix = frozenset([prefix[i] for i in range(size)])

        return my_prefix in self.PT
```
and `update` as:

```
        cdef int i
        if size>0 and size<=self.max_prefix_length \
           and not (is_improved and cost==upper_bound) \
           and len(self.PT)< self.max_prefix_number:

            my_prefix = frozenset(prefix[i] for i in range(size))
            self.PT[my_prefix] = True
```
Furthermore, if we do that inside `BAB_C`, we do only once `my_prefix = frozenset(prefix[i] for i in range(size))`.

If you agree, I will implement the changes.

David.



---

archive/issue_comments_233164.json:
```json
{
    "body": "<a id='comment:17'></a>Yo !\n\n> You are right, we could use a set instead of a dictionary and add the prefix `P` to the set only if `c(P)<\\min_{L\\in{\\cal L}_P(V)} c(L)`.\n\n\nCool. This should sipmlify both code and doc.\n\n> However, it is apparently faster to test if a frozenset is a key of a dictionary than if it is in a set.\n\n\nWHaaaaaaaaaaaaaaat ?.... `-_-`\n\nOkay. Dict with 'True' keys. Really... `-_-`\n\nI will write to sage-devel with your timings.\n\n> If you agree, I will implement the changes.\n\n+1\n\nNathann",
    "created_at": "2015-02-07T14:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233164",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:17'></a>Yo !

> You are right, we could use a set instead of a dictionary and add the prefix `P` to the set only if `c(P)<\min_{L\in{\cal L}_P(V)} c(L)`.


Cool. This should sipmlify both code and doc.

> However, it is apparently faster to test if a frozenset is a key of a dictionary than if it is in a set.


WHaaaaaaaaaaaaaaat ?.... `-_-`

Okay. Dict with 'True' keys. Really... `-_-`

I will write to sage-devel with your timings.

> If you agree, I will implement the changes.

+1

Nathann



---

archive/issue_comments_233165.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-07T15:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233165",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233166.json:
```json
{
    "body": "<a id='comment:19'></a>With this modification, the code is significantly faster. Cool! I'm really happy to have this timing on my MBA, knowing that it is a hard instance for this problem.\n\n```\nsage: from sage.graphs.graph_decompositions import vertex_separation as VS\nsage: G = graphs.MycielskiGraph(6)\nsage: %timeit vs, seq = VS.vertex_separation(G)\n1 loops, best of 3: 965 ms per loop\n```\nWe can easily change from `dict` to any other relevant data structure if it is faster.\n\nDavid.",
    "created_at": "2015-02-07T15:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233166",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:19'></a>With this modification, the code is significantly faster. Cool! I'm really happy to have this timing on my MBA, knowing that it is a hard instance for this problem.

```
sage: from sage.graphs.graph_decompositions import vertex_separation as VS
sage: G = graphs.MycielskiGraph(6)
sage: %timeit vs, seq = VS.vertex_separation(G)
1 loops, best of 3: 965 ms per loop
```
We can easily change from `dict` to any other relevant data structure if it is faster.

David.



---

archive/issue_comments_233167.json:
```json
{
    "body": "<a id='comment:20'></a>HMmmmm.. Less code, more speed. Love when it happens `:-P`\n\nNathann",
    "created_at": "2015-02-07T15:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233167",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:20'></a>HMmmmm.. Less code, more speed. Love when it happens `:-P`

Nathann



---

archive/issue_comments_233168.json:
```json
{
    "body": "<a id='comment:21'></a>Since we learned that \"internally sets are implemented just as dictionaries with no values\", there is no reason for using dictionary. The timing was certainly due to the order in which values were inserted in the set and in the dictionary. Moreover, we can get different results:\n\n```\nsage: L = []\nsage: for i in range(1, 11):\n....:     for z in Combinations(range(2*i), i):\n....:         L.append(frozenset(z))\n....:         \nsage: shuffle(L)\nsage: d = dict( (k, True) for k in L )\nsage: s = set(L)\nsage: elt = L[randint(0, len(L)-1)]\nsage: %timeit elt in s\n10000000 loops, best of 3: 66.8 ns per loop\nsage: %timeit elt in d\n10000000 loops, best of 3: 64.1 ns per loop\nsage: d = dict()\nsage: for i in range(1, 11):\n    for z in Combinations(range(2*i), i):\n        d[frozenset(z)] = True\n....:\nsage: %timeit elt in d\n10000000 loops, best of 3: 157 ns per loop\n```\n\nI will change to set.\n\nDavid.",
    "created_at": "2015-02-07T16:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233168",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:21'></a>Since we learned that "internally sets are implemented just as dictionaries with no values", there is no reason for using dictionary. The timing was certainly due to the order in which values were inserted in the set and in the dictionary. Moreover, we can get different results:

```
sage: L = []
sage: for i in range(1, 11):
....:     for z in Combinations(range(2*i), i):
....:         L.append(frozenset(z))
....:         
sage: shuffle(L)
sage: d = dict( (k, True) for k in L )
sage: s = set(L)
sage: elt = L[randint(0, len(L)-1)]
sage: %timeit elt in s
10000000 loops, best of 3: 66.8 ns per loop
sage: %timeit elt in d
10000000 loops, best of 3: 64.1 ns per loop
sage: d = dict()
sage: for i in range(1, 11):
    for z in Combinations(range(2*i), i):
        d[frozenset(z)] = True
....:
sage: %timeit elt in d
10000000 loops, best of 3: 157 ns per loop
```

I will change to set.

David.



---

archive/issue_comments_233169.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-07T16:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233169",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233170.json:
```json
{
    "body": "<a id='comment:23'></a>Same speed and bit less doc.",
    "created_at": "2015-02-07T16:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233170",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:23'></a>Same speed and bit less doc.



---

archive/issue_comments_233171.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-07T16:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233171",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233172.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-08T11:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233172",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233173.json:
```json
{
    "body": "<a id='comment:25'></a>I have added a few lines to store the prefixes generated by the greedy steps.\nAlthough it takes some time locally, it should help reducing the total number of visited branches.",
    "created_at": "2015-02-08T11:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233173",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:25'></a>I have added a few lines to store the prefixes generated by the greedy steps.
Although it takes some time locally, it should help reducing the total number of visited branches.



---

archive/issue_comments_233174.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-08T14:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233174",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233175.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-08T18:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233175",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233176.json:
```json
{
    "body": "<a id='comment:28'></a>Yoooooooooo !\n\nIf you don't see anything wrong in this last commit you can set the ticket to `positive_review`. Thanks for you work,\n\nNathann",
    "created_at": "2015-02-08T18:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233176",
    "user": "https://github.com/nathanncohen"
}
```

<a id='comment:28'></a>Yoooooooooo !

If you don't see anything wrong in this last commit you can set the ticket to `positive_review`. Thanks for you work,

Nathann



---

archive/issue_comments_233177.json:
```json
{
    "body": "<a id='comment:29'></a>Youhou!!!\n\nThank you once again Nathann for your very constructive help. The final solution is very nice.\n\nBest,\nDavid.\n\nPS: I have other possible inputs for this module (algorithm for trees, pre-processing for reducing the size of input, algorithm for testing vs=1 and vs=2, heuristics, etc.), but not right now.",
    "created_at": "2015-02-08T19:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233177",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:29'></a>Youhou!!!

Thank you once again Nathann for your very constructive help. The final solution is very nice.

Best,
David.

PS: I have other possible inputs for this module (algorithm for trees, pre-processing for reducing the size of input, algorithm for testing vs=1 and vs=2, heuristics, etc.), but not right now.



---

archive/issue_comments_233178.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-08T19:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233178",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_050683.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-18T23:22:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17712#event-50683"
}
```



---

archive/issue_comments_233179.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-18T23:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17712#issuecomment-233179",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
