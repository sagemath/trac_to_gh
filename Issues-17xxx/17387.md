# Issue 17387: Regression in riemann.pyx

archive/issues_017150.json:
```json
{
    "body": "The following comes from a doctest in `src/sage/calculus/riemann.pyx`:\n\nSage 5.12:\n\n```\nsage: f(t) = e^(I*t) - 0.5*e^(-I*t)\nsage: fprime(t) = I*e^(I*t) + 0.5*I*e^(-I*t)\nsage: m = Riemann_Map([f], [fprime], 0)\nsage: %time m.plot_colored(plot_points=1000).save(\"/tmp/foo.png\")\nCPU times: user 33.13 s, sys: 0.78 s, total: 33.92 s\nWall time: 34.73 s\n```\n\nSage 6.3:\n\n```\nsage: f(t) = e^(I*t) - 0.5*e^(-I*t)\nsage: fprime(t) = I*e^(I*t) + 0.5*I*e^(-I*t)\nsage: m = Riemann_Map([f], [fprime], 0)\nsage: %time m.plot_colored(plot_points=1000).save(\"/tmp/foo.png\")\nCPU times: user 1min 6s, sys: 1.81 s, total: 1min 7s\nWall time: 1min 8s\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/17387\n\n",
    "created_at": "2014-11-24T09:32:17Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "Regression in riemann.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17387",
    "user": "https://github.com/vbraun"
}
```
The following comes from a doctest in `src/sage/calculus/riemann.pyx`:

Sage 5.12:

```
sage: f(t) = e^(I*t) - 0.5*e^(-I*t)
sage: fprime(t) = I*e^(I*t) + 0.5*I*e^(-I*t)
sage: m = Riemann_Map([f], [fprime], 0)
sage: %time m.plot_colored(plot_points=1000).save("/tmp/foo.png")
CPU times: user 33.13 s, sys: 0.78 s, total: 33.92 s
Wall time: 34.73 s
```

Sage 6.3:

```
sage: f(t) = e^(I*t) - 0.5*e^(-I*t)
sage: fprime(t) = I*e^(I*t) + 0.5*I*e^(-I*t)
sage: m = Riemann_Map([f], [fprime], 0)
sage: %time m.plot_colored(plot_points=1000).save("/tmp/foo.png")
CPU times: user 1min 6s, sys: 1.81 s, total: 1min 7s
Wall time: 1min 8s
```

Issue created by migration from https://trac.sagemath.org/ticket/17387





---

archive/issue_comments_227694.json:
```json
{
    "body": "Is it a regression? If plotting did become slower, then it's something to be investigated.\n\nThe comment mentions that it takes 29s on `sage.math` which is not a very fast machine. Other doctests are documented to take far more time. This 29s shouldn't cause timeouts (unless the machine is very slow, but then you should just increase the timeout).",
    "created_at": "2014-11-24T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17387#issuecomment-227694",
    "user": "https://github.com/jdemeyer"
}
```

Is it a regression? If plotting did become slower, then it's something to be investigated.

The comment mentions that it takes 29s on `sage.math` which is not a very fast machine. Other doctests are documented to take far more time. This 29s shouldn't cause timeouts (unless the machine is very slow, but then you should just increase the timeout).



---

archive/issue_comments_227695.json:
```json
{
    "body": "I don't think its a regression, I think I've seen it before. Its just unnecessarily slow.",
    "created_at": "2014-11-24T11:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17387#issuecomment-227695",
    "user": "https://github.com/vbraun"
}
```

I don't think its a regression, I think I've seen it before. Its just unnecessarily slow.



---

archive/issue_comments_227696.json:
```json
{
    "body": "PS: Machine is my desktop, Haswell-E 6-core with 32 GB ram (but doing stuff in the background).",
    "created_at": "2014-11-24T11:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17387#issuecomment-227696",
    "user": "https://github.com/vbraun"
}
```

PS: Machine is my desktop, Haswell-E 6-core with 32 GB ram (but doing stuff in the background).



---

archive/issue_comments_227697.json:
```json
{
    "body": "This is probably due to some great final stuff Ethan put in that I finally reviewed not that long ago (in Sage time).  Comments:\n* `sage: m.plot_colored(plot_points=100)` probably will need something about a graphics primitive or it will fail tests.\n* Same one should be upped to `plot_points=200` but otherwise it's (barely) acceptable actual output.\n* The test\n\n```\np = m.plot_spiderweb(withcolor=True, plot_points=100, thickness = 2.0, min_mag=0.1) # long time\n```\n  is just not acceptable, it's completely unintelligible.    `plot_points=350` is the first time it seems reasonable.\n* For the \"high-resolution\" plot, why not keep the test but just do \"not tested\" along with the \"tested\" smaller one?\nThe point is that it's not just manpage style documentation, but something people will want to test without having to guess what to do.  Hopefully these suggestions will still be within your timing frame for the file.\n\n---\nNew commits:",
    "created_at": "2014-12-04T03:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17387#issuecomment-227697",
    "user": "https://github.com/kcrisman"
}
```

This is probably due to some great final stuff Ethan put in that I finally reviewed not that long ago (in Sage time).  Comments:
* `sage: m.plot_colored(plot_points=100)` probably will need something about a graphics primitive or it will fail tests.
* Same one should be upped to `plot_points=200` but otherwise it's (barely) acceptable actual output.
* The test

```
p = m.plot_spiderweb(withcolor=True, plot_points=100, thickness = 2.0, min_mag=0.1) # long time
```
  is just not acceptable, it's completely unintelligible.    `plot_points=350` is the first time it seems reasonable.
* For the "high-resolution" plot, why not keep the test but just do "not tested" along with the "tested" smaller one?
The point is that it's not just manpage style documentation, but something people will want to test without having to guess what to do.  Hopefully these suggestions will still be within your timing frame for the file.

---
New commits:



---

archive/issue_comments_227698.json:
```json
{
    "body": "The main goal of this ticket should be to fix the actual regression in the plotting. Once that's done, we can have a look at what should be done about the doctests.",
    "created_at": "2014-12-04T07:31:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17387#issuecomment-227698",
    "user": "https://github.com/jdemeyer"
}
```

The main goal of this ticket should be to fix the actual regression in the plotting. Once that's done, we can have a look at what should be done about the doctests.



---

archive/issue_comments_227699.json:
```json
{
    "body": "Okay, #11273 was merged in Sage 5.13.beta0 (thanks, \"Merged in\" box!) - probably commit f597e49695b.  The longer plot test time overall is probably mostly due to additional tests being added for quite a bit of new functionality (multiply connected domains, etc.).  The specific example in question is most likely due to moving the generation of plot points (the thing that actually is slow), not the image creation itself) to `compute_on_grid`, though I didn't see any obviously wrong or new code at the time, nor do I see anything obvious where Cython was replaced with Python there.\n\nBy the way, on my OS X 10.7 2.3 GHz laptop with only 8GB, I still get about 35 seconds like in your earlier version.",
    "created_at": "2014-12-04T14:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17387#issuecomment-227699",
    "user": "https://github.com/kcrisman"
}
```

Okay, #11273 was merged in Sage 5.13.beta0 (thanks, "Merged in" box!) - probably commit f597e49695b.  The longer plot test time overall is probably mostly due to additional tests being added for quite a bit of new functionality (multiply connected domains, etc.).  The specific example in question is most likely due to moving the generation of plot points (the thing that actually is slow), not the image creation itself) to `compute_on_grid`, though I didn't see any obviously wrong or new code at the time, nor do I see anything obvious where Cython was replaced with Python there.

By the way, on my OS X 10.7 2.3 GHz laptop with only 8GB, I still get about 35 seconds like in your earlier version.



---

archive/issue_comments_227700.json:
```json
{
    "body": "Changing keywords from \"random_fail\" to \"\".",
    "created_at": "2015-09-19T10:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17387#issuecomment-227700",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "random_fail" to "".



---

archive/issue_events_050097.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-09-19T10:56:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17387",
    "milestone": "sage-6.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17387#event-50097"
}
```
