# Issue 17924: Race condition in pexpect

archive/issues_017687.json:
```json
{
    "body": "There is a race condition in `pexpect`, which is worked around by the `SageSpawn` class from #17686. Apply [attachment:test17924.patch] and rebuild `pexpect` to test this race condition.\n\nAfter applying [attachment:test17924.patch]:\n\n```\n    sage -t src/sage/interfaces/qsieve.py  # Bad exit: 1\n    sage -t local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/worksheet.py\n    # Bad exit: 1\n    sage -t local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/cell.py\n    # Bad exit: 1\n```\n\n---\n\nThe original report was about running Sage under docker, which always triggers the race condition:\n\nMinimal steps to reproduce and complete log:\n\n```\n# Install docker (here for Debian / Ubuntu):\n> sudo apt-get install docker.io\n\n# Run a docker container with Sage:\n> docker run -t -i --entrypoint \"sudo\" sagemath/sage su - sage\nLast login: Thu Nov 27 15:28:05 GMT 2014\n[sage@63182b1b1561 ~]$ uname -a\nLinux 63182b1b1561 3.13.0-43-generic #72-Ubuntu SMP Mon Dec 8 19:35:06 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux\n\n[sage@63182b1b1561 ~]$ cd /opt/sage\n[sage@63182b1b1561 sage-6.4.1]$ ./sage -v\nSageMath Version 6.7, Release Date: 2015-05-17\n\n[sage@63182b1b1561 sage-6.4.1]$ cat > bla.py << EOF\nr\"\"\"\n        sage: from sage.interfaces.qsieve import qsieve\n        sage: q = qsieve(next_prime(10^20)*next_prime(10^21), block=False)\n\"\"\"\nEOF\n\n[sage@63182b1b1561 sage]$ ./sage -t --verbose bla.py \ninit.sage does not exist ... creating\nno stored timings available\nRunning doctests with ID 2015-03-04-07-53-04-191d76e2.\nDoctesting 1 file.\nsage -t bla.py\nTrying (line 2):    from sage.interfaces.qsieve import qsieve\nExpecting nothing\nok [0.00 s]\nTrying (line 3):    k = 19; n = next_prime(10^k)*next_prime(10^(k+1))\nExpecting nothing\nok [0.00 s]\nTrying (line 5):    q = qsieve(next_prime(10^20)*next_prime(10^21), block=False)\nExpecting nothing\nok [0.23 s]\nTrying (line 6):    sig_on_count()\nExpecting:\n    0\nok [0.00 s]\n1 item passed all tests:\n   4 tests in bla\n4 tests in 1 item.\n4 passed and 0 failed.\nTest passed.\nProcess DocTestWorker-1:\nTraceback (most recent call last):\n  File \"/home/sage/sage-6.4.1/local/lib/python/multiprocessing/process.py\", line 258, in _bootstrap\n    self.run()\n  File \"/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1839, in run\n    task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n  File \"/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2159, in __call__\n    result_queue.put(result, False)\n  File \"/home/sage/sage-6.4.1/local/lib/python/multiprocessing/queues.py\", line 102, in put\n    raise Full\nFull\n    Bad exit: 1\n**********************************************************************\nTests run before process (pid=108) failed:\nsage: from sage.interfaces.qsieve import qsieve ## line 2 ##\nsage: k = 19; n = next_prime(10^k)*next_prime(10^(k+1)) ## line 3 ##\nsage: q = qsieve(next_prime(10^20)*next_prime(10^21), block=False) ## line 5 ##\nsage: sig_on_count() ## line 6 ##\n0\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t bla.py  # Bad exit: 1\n----------------------------------------------------------------------\nTotal time for all tests: 0.4 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n[sage@63182b1b1561 sage-6.4.1]$ logout\n```\n\nThis was tested with the centos-based image built by Volker:\n\n        https://github.com/sagemath/docker\n\nand a variety of homemade docker images built on several other linux\ndistributions (debian) and various recent versions of Sage (including\n6.4.1, 6.5, 6.7). The failure is systematic.\n\nInvesting this further, it's the doctesting framework that fails in\nforker.py. There seems to be a race condition at the complete end,\nafter collecting and reporting the results of the slaves: on line\n2159, forker wants to put back something in the queue which is\nreported as Full. If one tests just before whether the queue is empty,\nthe answer is positive, and the error disappears (isn't that a nice\nheisenbug!!!). The error disappears as well if one inserts a little\nsleep (no less than 0.3s!).\n\nIt's very frustrating not to have a better understanding of the cause\nof the problem, and why it appears specifically under docker and those\nfiles. If someone understands precisely the problem and can fix the\nproblem now, that's great. Otherwise, as this is a blocker for moving\nfurther with deploying patchbots, we propose in the attached branch to\ninsert the emptyness test as a temporary workaround.\n\nThread on sage-devel: https://groups.google.com/d/msg/sage-devel/8hWBzBMjKXI/5DfW8H3nKbAJ\n\nCC:  @vbraun @nthiery @hivert @jdemeyer\n\nKeywords: docker\n\nReviewer: Vincent Neri, Volker Braun\n\nAuthor: Jeroen Demeyer, Volker Braun\n\nBranch: 6a759cd704efd7d7b2109b8c58e2621074ea3b07\n\nDependencies: #17686\n\nCommit: 6a759cd704efd7d7b2109b8c58e2621074ea3b07\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17924\n\n",
    "closed_at": "2015-06-19T08:25:03Z",
    "created_at": "2015-03-10T08:59:17Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Race condition in pexpect",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17924",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vincent.Neri"
}
```
There is a race condition in `pexpect`, which is worked around by the `SageSpawn` class from #17686. Apply [attachment:test17924.patch] and rebuild `pexpect` to test this race condition.

After applying [attachment:test17924.patch]:

```
    sage -t src/sage/interfaces/qsieve.py  # Bad exit: 1
    sage -t local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/worksheet.py
    # Bad exit: 1
    sage -t local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/cell.py
    # Bad exit: 1
```

---

The original report was about running Sage under docker, which always triggers the race condition:

Minimal steps to reproduce and complete log:

```
# Install docker (here for Debian / Ubuntu):
> sudo apt-get install docker.io

# Run a docker container with Sage:
> docker run -t -i --entrypoint "sudo" sagemath/sage su - sage
Last login: Thu Nov 27 15:28:05 GMT 2014
[sage@63182b1b1561 ~]$ uname -a
Linux 63182b1b1561 3.13.0-43-generic #72-Ubuntu SMP Mon Dec 8 19:35:06 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux

[sage@63182b1b1561 ~]$ cd /opt/sage
[sage@63182b1b1561 sage-6.4.1]$ ./sage -v
SageMath Version 6.7, Release Date: 2015-05-17

[sage@63182b1b1561 sage-6.4.1]$ cat > bla.py << EOF
r"""
        sage: from sage.interfaces.qsieve import qsieve
        sage: q = qsieve(next_prime(10^20)*next_prime(10^21), block=False)
"""
EOF

[sage@63182b1b1561 sage]$ ./sage -t --verbose bla.py 
init.sage does not exist ... creating
no stored timings available
Running doctests with ID 2015-03-04-07-53-04-191d76e2.
Doctesting 1 file.
sage -t bla.py
Trying (line 2):    from sage.interfaces.qsieve import qsieve
Expecting nothing
ok [0.00 s]
Trying (line 3):    k = 19; n = next_prime(10^k)*next_prime(10^(k+1))
Expecting nothing
ok [0.00 s]
Trying (line 5):    q = qsieve(next_prime(10^20)*next_prime(10^21), block=False)
Expecting nothing
ok [0.23 s]
Trying (line 6):    sig_on_count()
Expecting:
    0
ok [0.00 s]
1 item passed all tests:
   4 tests in bla
4 tests in 1 item.
4 passed and 0 failed.
Test passed.
Process DocTestWorker-1:
Traceback (most recent call last):
  File "/home/sage/sage-6.4.1/local/lib/python/multiprocessing/process.py", line 258, in _bootstrap
    self.run()
  File "/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1839, in run
    task(self.options, self.outtmpfile, msgpipe, self.result_queue)
  File "/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2159, in __call__
    result_queue.put(result, False)
  File "/home/sage/sage-6.4.1/local/lib/python/multiprocessing/queues.py", line 102, in put
    raise Full
Full
    Bad exit: 1
**********************************************************************
Tests run before process (pid=108) failed:
sage: from sage.interfaces.qsieve import qsieve ## line 2 ##
sage: k = 19; n = next_prime(10^k)*next_prime(10^(k+1)) ## line 3 ##
sage: q = qsieve(next_prime(10^20)*next_prime(10^21), block=False) ## line 5 ##
sage: sig_on_count() ## line 6 ##
0

**********************************************************************
----------------------------------------------------------------------
sage -t bla.py  # Bad exit: 1
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
[sage@63182b1b1561 sage-6.4.1]$ logout
```

This was tested with the centos-based image built by Volker:

        https://github.com/sagemath/docker

and a variety of homemade docker images built on several other linux
distributions (debian) and various recent versions of Sage (including
6.4.1, 6.5, 6.7). The failure is systematic.

Investing this further, it's the doctesting framework that fails in
forker.py. There seems to be a race condition at the complete end,
after collecting and reporting the results of the slaves: on line
2159, forker wants to put back something in the queue which is
reported as Full. If one tests just before whether the queue is empty,
the answer is positive, and the error disappears (isn't that a nice
heisenbug!!!). The error disappears as well if one inserts a little
sleep (no less than 0.3s!).

It's very frustrating not to have a better understanding of the cause
of the problem, and why it appears specifically under docker and those
files. If someone understands precisely the problem and can fix the
problem now, that's great. Otherwise, as this is a blocker for moving
further with deploying patchbots, we propose in the attached branch to
insert the emptyness test as a temporary workaround.

Thread on sage-devel: https://groups.google.com/d/msg/sage-devel/8hWBzBMjKXI/5DfW8H3nKbAJ

CC:  @vbraun @nthiery @hivert @jdemeyer

Keywords: docker

Reviewer: Vincent Neri, Volker Braun

Author: Jeroen Demeyer, Volker Braun

Branch: 6a759cd704efd7d7b2109b8c58e2621074ea3b07

Dependencies: #17686

Commit: 6a759cd704efd7d7b2109b8c58e2621074ea3b07

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17924





---

archive/issue_comments_236127.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-10T09:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236127",
    "user": "https://github.com/nthiery"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_236128.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2015-03-10T09:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236128",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_236129.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-10T09:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236129",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_236130.json:
```json
{
    "body": "<a id='comment:7'></a>Let's first take some time to understand this problem before jumping to add workarounds.",
    "created_at": "2015-03-10T09:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236130",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Let's first take some time to understand this problem before jumping to add workarounds.



---

archive/issue_comments_236131.json:
```json
{
    "body": "<a id='comment:8'></a>What happens if you add this patch (just this one, not on top of the branch of this ticket)?\n\n```\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex fde65c3..91eb232 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):\n                             # would leave them open until we call\n                             # report(), parallel testing can easily fail\n                             # with a \"Too many open files\" error.\n+                            time.sleep(1)\n                             w.save_result_output()\n                             finished.append(w)\n                     workers = new_workers\n```",
    "created_at": "2015-03-10T10:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236131",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>What happens if you add this patch (just this one, not on top of the branch of this ticket)?

```
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index fde65c3..91eb232 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):
                             # would leave them open until we call
                             # report(), parallel testing can easily fail
                             # with a "Too many open files" error.
+                            time.sleep(1)
                             w.save_result_output()
                             finished.append(w)
                     workers = new_workers
```



---

archive/issue_comments_236132.json:
```json
{
    "body": "<a id='comment:9'></a>Or even better, try this:\n\n```\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex fde65c3..d214dc2 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):\n                             # would leave them open until we call\n                             # report(), parallel testing can easily fail\n                             # with a \"Too many open files\" error.\n+                            time.sleep(1)\n                             w.save_result_output()\n                             finished.append(w)\n                     workers = new_workers\n@@ -2159,5 +2160,6 @@ class DocTestTask(object):\n             result = (0, DictAsObject(dict(err=exc_info[0], tb=tb)))\n \n         if result_queue is not None:\n+            print(\"Process %s writing to %r\"%(os.getpid(), result_queue))\n             result_queue.put(result, False)\n         return result\n```\n\nand run\n\n```\n./sage -bt src/sage/rings/integer.pyx      # or whatever test which normally works\n./sage -bt src/sage/interfaces/qsieve.py   # or whatever test which normally fails\n```",
    "created_at": "2015-03-10T10:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236132",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Or even better, try this:

```
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index fde65c3..d214dc2 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):
                             # would leave them open until we call
                             # report(), parallel testing can easily fail
                             # with a "Too many open files" error.
+                            time.sleep(1)
                             w.save_result_output()
                             finished.append(w)
                     workers = new_workers
@@ -2159,5 +2160,6 @@ class DocTestTask(object):
             result = (0, DictAsObject(dict(err=exc_info[0], tb=tb)))
 
         if result_queue is not None:
+            print("Process %s writing to %r"%(os.getpid(), result_queue))
             result_queue.put(result, False)
         return result
```

and run

```
./sage -bt src/sage/rings/integer.pyx      # or whatever test which normally works
./sage -bt src/sage/interfaces/qsieve.py   # or whatever test which normally fails
```



---

archive/issue_comments_236133.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:\n> Or even better, try this:\n\n\nVincent just tried, and indeed the error disappears. Funilly enough, for qsieve.py, but not for cell.py, it's actually enough to only insert a\n\n```\n      print(\"test\")\n```\n(without the sleep beforehand) to make the error disappear! Speak of an heisenbug.\n\nOk, now we would need to understand why there is a race condition ...",
    "created_at": "2015-03-10T10:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236133",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:
> Or even better, try this:


Vincent just tried, and indeed the error disappears. Funilly enough, for qsieve.py, but not for cell.py, it's actually enough to only insert a

```
      print("test")
```
(without the sleep beforehand) to make the error disappear! Speak of an heisenbug.

Ok, now we would need to understand why there is a race condition ...



---

archive/issue_comments_236134.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 nthiery]:\n> Replying to [comment:9 jdemeyer]:\n> > Or even better, try this:\n\n> \n> Vincent just tried, and indeed the error disappears.\n\n\nPlease report full output, all details...",
    "created_at": "2015-03-10T10:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236134",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Replying to [comment:10 nthiery]:
> Replying to [comment:9 jdemeyer]:
> > Or even better, try this:

> 
> Vincent just tried, and indeed the error disappears.


Please report full output, all details...



---

archive/issue_comments_236135.json:
```json
{
    "body": "<a id='comment:12'></a>I get the same error on my machine...",
    "created_at": "2015-03-14T19:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236135",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>I get the same error on my machine...



---

archive/issue_comments_236136.json:
```json
{
    "body": "<a id='comment:13'></a>Just tried to increase the /dev/shm size to 2G using mount -o remount,size=2G /dev/shm in the (privileged) docker container and the failure still happens. Changing storage driver in docker from devicemapper to aufs, btrfs or overlay yields the same error.",
    "created_at": "2015-03-14T23:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236136",
    "user": "https://trac.sagemath.org/admin/accounts/users/Vincent.Neri"
}
```

<a id='comment:13'></a>Just tried to increase the /dev/shm size to 2G using mount -o remount,size=2G /dev/shm in the (privileged) docker container and the failure still happens. Changing storage driver in docker from devicemapper to aufs, btrfs or overlay yields the same error.



---

archive/issue_comments_236137.json:
```json
{
    "body": "<a id='comment:14'></a>Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff.  Presumably the fork child needs to do something but isn't fast enough in this case.",
    "created_at": "2015-03-14T23:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236137",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff.  Presumably the fork child needs to do something but isn't fast enough in this case.



---

archive/issue_comments_236138.json:
```json
{
    "body": "<a id='comment:15'></a>> Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff\n\nWhy do you think that?\n\nGiven that people are ignoring my requests for more information, nothing is clear to me.",
    "created_at": "2015-03-15T10:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236138",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>> Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff

Why do you think that?

Given that people are ignoring my requests for more information, nothing is clear to me.



---

archive/issue_comments_236139.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2015-03-15T10:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236139",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_236140.json:
```json
{
    "body": "Attachment [report2](tarball://root/attachments/some-uuid/ticket17924/report2) by @nthiery created at 2015-03-15 11:30:24",
    "created_at": "2015-03-15T11:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236140",
    "user": "https://github.com/nthiery"
}
```

Attachment [report2](tarball://root/attachments/some-uuid/ticket17924/report2) by @nthiery created at 2015-03-15 11:30:24



---

archive/issue_comments_236141.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:\n> Given that people are ignoring my requests for more information, nothing is clear to me.\n\n\nSee the attached files [attachment:report1] and [attachment:report2].\nHopefully you can find something interesting besides what we reported.\n\nI very well know the importance of having all data when tracking down\nbugs, and how frustrating and time consuming it can be when you don't\nhave it under hand. And I appreciate that you are spending time on\nthis issue. But reciprocally, it's also time consuming to build\ninformative reports that reach the right balance of conciseness (so\nthat we can keep an overview of the ticket) while not losing any\nuseful information (for the record, I just spent 30 minutes on it).\n\nWith the issue at hand, it is really easy to reproduce everything. In\ncase you need to experiment further, may I recommend that you run the\ntests yourself?\n\nThanks,\n                                       Nicolas\n\nPS: If this can save you a couple minutes, please send me your public\nssh key, and I'll grant you access to the exact machine on which I ran\nthe tests which has docker and the sage image installed.",
    "created_at": "2015-03-15T11:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236141",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:
> Given that people are ignoring my requests for more information, nothing is clear to me.


See the attached files [attachment:report1] and [attachment:report2].
Hopefully you can find something interesting besides what we reported.

I very well know the importance of having all data when tracking down
bugs, and how frustrating and time consuming it can be when you don't
have it under hand. And I appreciate that you are spending time on
this issue. But reciprocally, it's also time consuming to build
informative reports that reach the right balance of conciseness (so
that we can keep an overview of the ticket) while not losing any
useful information (for the record, I just spent 30 minutes on it).

With the issue at hand, it is really easy to reproduce everything. In
case you need to experiment further, may I recommend that you run the
tests yourself?

Thanks,
                                       Nicolas

PS: If this can save you a couple minutes, please send me your public
ssh key, and I'll grant you access to the exact machine on which I ran
the tests which has docker and the sage image installed.



---

archive/issue_comments_236142.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 nthiery]:\n> In\n> case you need to experiment further, may I recommend that you run the\n> tests yourself?\n\nI have never used docker and I don't feel like installing docker just to help fix this issue.\n\n> PS: If this can save you a couple minutes, please send me your public\n> ssh key, and I'll grant you access to the exact machine on which I ran\n> the tests which has docker and the sage image installed.\n\nThat's by far the best solution.",
    "created_at": "2015-03-15T12:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236142",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:16 nthiery]:
> In
> case you need to experiment further, may I recommend that you run the
> tests yourself?

I have never used docker and I don't feel like installing docker just to help fix this issue.

> PS: If this can save you a couple minutes, please send me your public
> ssh key, and I'll grant you access to the exact machine on which I ran
> the tests which has docker and the sage image installed.

That's by far the best solution.



---

archive/issue_comments_236143.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 jdemeyer]:\n> That's by far the best solution.\n\n\nThanks for your key. You should now be able to:\n\n```\nssh root@onevm-92.lal.in2p3.fr\ndocker run -t -i sagemath/sage su - sage\n...                   # as in the ticket description\n```\nLet me know if you encounter any issue.\n\nAnyone else interested in investigating on this machine, just send me\nyour key. Otherwise installing docker boils down to:\n\n```\n     apt-get install docker.io    # on Ubuntu/Debian\n```\n\nI have updated the description to include this.\nCheers,\n                            Nicolas",
    "created_at": "2015-03-15T12:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236143",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:18'></a>Replying to [comment:17 jdemeyer]:
> That's by far the best solution.


Thanks for your key. You should now be able to:

```
ssh root@onevm-92.lal.in2p3.fr
docker run -t -i sagemath/sage su - sage
...                   # as in the ticket description
```
Let me know if you encounter any issue.

Anyone else interested in investigating on this machine, just send me
your key. Otherwise installing docker boils down to:

```
     apt-get install docker.io    # on Ubuntu/Debian
```

I have updated the description to include this.
Cheers,
                            Nicolas



---

archive/issue_comments_236144.json:
```json
{
    "body": "<a id='comment:20'></a>```\njdemeyer@tamiyo:/usr/local/src/sage-git$ ssh root@onevm-92.lal.in2p3.fr\nssh: connect to host onevm-92.lal.in2p3.fr port 22: Connection timed out\n```",
    "created_at": "2015-03-16T10:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236144",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>```
jdemeyer@tamiyo:/usr/local/src/sage-git$ ssh root@onevm-92.lal.in2p3.fr
ssh: connect to host onevm-92.lal.in2p3.fr port 22: Connection timed out
```



---

archive/issue_comments_236145.json:
```json
{
    "body": "<a id='comment:22'></a>Hi!\n\nDuring PyCon 2015, I discussed this issue with a couple people, and filled up the following ticket:\n\nhttps://github.com/docker/docker/issues/12277\n\nOllie Walsh jumped in, investigated, and wrote an interesting report. It might actually be an issue on Sage's side. Could someone familiar with the peexpect interface and our doctest forker have a look at his report?\n\nIs the notebook also using queues in a way which could explain the similar looking issue appearing in the notebook tests?",
    "created_at": "2015-04-22T09:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236145",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:22'></a>Hi!

During PyCon 2015, I discussed this issue with a couple people, and filled up the following ticket:

https://github.com/docker/docker/issues/12277

Ollie Walsh jumped in, investigated, and wrote an interesting report. It might actually be an issue on Sage's side. Could someone familiar with the peexpect interface and our doctest forker have a look at his report?

Is the notebook also using queues in a way which could explain the similar looking issue appearing in the notebook tests?



---

archive/issue_comments_236146.json:
```json
{
    "body": "<a id='comment:23'></a>Hi,\n\nThere are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?\n\nCheers,\n                                Nicolas",
    "created_at": "2015-06-03T21:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236146",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:23'></a>Hi,

There are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?

Cheers,
                                Nicolas



---

archive/issue_comments_236147.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 nthiery]:\n> There are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?\n\n\nI don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.\n\nFrom my initial investigation, I couldn't figure out what the problem was. If you're willing to re-install the docker image on that machine, I can have a second fresh look.",
    "created_at": "2015-06-14T20:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236147",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:23 nthiery]:
> There are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?


I don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.

From my initial investigation, I couldn't figure out what the problem was. If you're willing to re-install the docker image on that machine, I can have a second fresh look.



---

archive/issue_comments_236148.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 jdemeyer]:\n> I don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.\n\n\nYes, that's why I called it a work around, not a fix :-)\n\n> From my initial investigation, I couldn't figure out what the\n> problem was. If you're willing to re-install the docker image on\n> that machine, I can have a second fresh look .\n\n\nGreat, thanks! I'll recreate the machine for you, presumably tomorrow.",
    "created_at": "2015-06-14T21:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236148",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:25'></a>Replying to [comment:24 jdemeyer]:
> I don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.


Yes, that's why I called it a work around, not a fix :-)

> From my initial investigation, I couldn't figure out what the
> problem was. If you're willing to re-install the docker image on
> that machine, I can have a second fresh look .


Great, thanks! I'll recreate the machine for you, presumably tomorrow.



---

archive/issue_comments_236149.json:
```json
{
    "body": "<a id='comment:27'></a>Hi Jeroen!\n\nThe machine is up and running for you. Note that the docker image\nslightly evolved since last time (there is a default entry point set\nto start sage automatically by default). I just updated the\ninstructions accordingly in the ticket description. If you want to be\nable to use strace & stuff in a privileged docker container this\nbecomes:\n\n```\n> ssh root@onevm-143.lal.in2p3.fr\n\nroot@onevm-143:~# docker run --privileged -t -i --entrypoint \"sudo\" sagemath/sage su -\n\n-bash-4.3# yum install strace\n\n-bash-4.3# su - sage\n\n... as in the ticket description ...\n```\n\nNote that in this docker image `sage` is sudoer without password.\n\nGood hunt!\n                                Nicolas",
    "created_at": "2015-06-16T14:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236149",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:27'></a>Hi Jeroen!

The machine is up and running for you. Note that the docker image
slightly evolved since last time (there is a default entry point set
to start sage automatically by default). I just updated the
instructions accordingly in the ticket description. If you want to be
able to use strace & stuff in a privileged docker container this
becomes:

```
> ssh root@onevm-143.lal.in2p3.fr

root@onevm-143:~# docker run --privileged -t -i --entrypoint "sudo" sagemath/sage su -

-bash-4.3# yum install strace

-bash-4.3# su - sage

... as in the ticket description ...
```

Note that in this docker image `sage` is sudoer without password.

Good hunt!
                                Nicolas



---

archive/issue_comments_236150.json:
```json
{
    "body": "<a id='comment:28'></a>Minimal testcase (run with `sage -python docker-semaphore.py`):\n\n```python\nimport multiprocessing, os, sys, time, signal, pexpect\n\n## Not importing Sage makes the bug go away                                                                                                              \nimport sage.all\n\n\nclass Subprocess(multiprocessing.Process):\n\n    def run(self):\n        result_queue = multiprocessing.Queue(1)\n\n        try:\n            print('run-pre: {0}'.format(result_queue._sem))\n            p = pexpect.spawn('QuadraticSieve')\n            p.sendline('100000000000000000050700000000000000004563\\n\\n\\n')\n            p.closed = True  # avoid surprises from p.__del__                                                                                            \n            print('run-post 1: {0}'.format(result_queue._sem))\n            os.kill(p.pid, signal.SIGHUP)\n            print('run-post 2: {0}'.format(result_queue._sem))\n            time.sleep(0.1)\n            print('run-post 3: {0}'.format(result_queue._sem))\n        except SystemExit as err:\n            # Not catching SystemExit makes the bug go away                                                                                              \n            print(err)\n\n        # Checking empty makes the bug go away                                                                                                           \n        # print(result_queue.empty())                                                                                                                    \n\n        # This is the bug, value should equal to one                                                                                                     \n        v = result_queue._sem.get_value()\n        if v == 0:\n            print('got the wrong value for the semaphore')\n\n        # Raises Full                                                                                                                                    \n        result_queue.put(123, False)\n\n\nif __name__ == '__main__':\n    w = Subprocess()\n    w.start()\n```\nOutput inside the docker container is \n\n```\nrun-pre: <BoundedSemaphore(value=1, count=0, maxvalue=1)>\nrun-post 1: <BoundedSemaphore(value=1, count=0, maxvalue=1)>\nrun-post 2: <BoundedSemaphore(value=1, count=0, maxvalue=1)>\nrun-post 3: <BoundedSemaphore(value=0, count=0, maxvalue=1)>\ngot the wrong value for the semaphore\n```\nThe value of the semaphore switches to zero a short while after the process is killed, but I don't understand why.  Must be something that we drag in with importing sage...",
    "created_at": "2015-06-16T21:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236150",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:28'></a>Minimal testcase (run with `sage -python docker-semaphore.py`):

```python
import multiprocessing, os, sys, time, signal, pexpect

## Not importing Sage makes the bug go away                                                                                                              
import sage.all


class Subprocess(multiprocessing.Process):

    def run(self):
        result_queue = multiprocessing.Queue(1)

        try:
            print('run-pre: {0}'.format(result_queue._sem))
            p = pexpect.spawn('QuadraticSieve')
            p.sendline('100000000000000000050700000000000000004563\n\n\n')
            p.closed = True  # avoid surprises from p.__del__                                                                                            
            print('run-post 1: {0}'.format(result_queue._sem))
            os.kill(p.pid, signal.SIGHUP)
            print('run-post 2: {0}'.format(result_queue._sem))
            time.sleep(0.1)
            print('run-post 3: {0}'.format(result_queue._sem))
        except SystemExit as err:
            # Not catching SystemExit makes the bug go away                                                                                              
            print(err)

        # Checking empty makes the bug go away                                                                                                           
        # print(result_queue.empty())                                                                                                                    

        # This is the bug, value should equal to one                                                                                                     
        v = result_queue._sem.get_value()
        if v == 0:
            print('got the wrong value for the semaphore')

        # Raises Full                                                                                                                                    
        result_queue.put(123, False)


if __name__ == '__main__':
    w = Subprocess()
    w.start()
```
Output inside the docker container is 

```
run-pre: <BoundedSemaphore(value=1, count=0, maxvalue=1)>
run-post 1: <BoundedSemaphore(value=1, count=0, maxvalue=1)>
run-post 2: <BoundedSemaphore(value=1, count=0, maxvalue=1)>
run-post 3: <BoundedSemaphore(value=0, count=0, maxvalue=1)>
got the wrong value for the semaphore
```
The value of the semaphore switches to zero a short while after the process is killed, but I don't understand why.  Must be something that we drag in with importing sage...



---

archive/issue_comments_236151.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2015-06-17T07:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236151",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_events_051033.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-06-17T07:17:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "milestone": "sage-6.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17924#event-51033"
}
```



---

archive/issue_comments_236152.json:
```json
{
    "body": "Changing component from doctest framework to interfaces.",
    "created_at": "2015-06-17T07:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236152",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from doctest framework to interfaces.



---

archive/issue_comments_236153.json:
```json
{
    "body": "<a id='comment:32'></a>Attached branch fixes the problem for `qsieve.py`, but not for the notebook.\n\n---\nNew commits:",
    "created_at": "2015-06-17T07:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236153",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>Attached branch fixes the problem for `qsieve.py`, but not for the notebook.

---
New commits:



---

archive/issue_comments_236154.json:
```json
{
    "body": "<a id='comment:33'></a>Whats the race?",
    "created_at": "2015-06-17T07:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236154",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:33'></a>Whats the race?



---

archive/issue_comments_236155.json:
```json
{
    "body": "<a id='comment:34'></a>It's this from `sagespawn.pyx` (#17686):\n\n```\ntry:\n    spawn.__init__(self, *args, **kwds)\nfinally:\n    # Protect against a race condition where the child process\n    # is interrupted *before* calling execve(). Then the SIGINT\n    # signal will raise a Python KeyboardInterrupt and we end\n    # up here.\n    if self.pid == 0:\n        _exit(1)\n```",
    "created_at": "2015-06-17T07:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236155",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:34'></a>It's this from `sagespawn.pyx` (#17686):

```
try:
    spawn.__init__(self, *args, **kwds)
finally:
    # Protect against a race condition where the child process
    # is interrupted *before* calling execve(). Then the SIGINT
    # signal will raise a Python KeyboardInterrupt and we end
    # up here.
    if self.pid == 0:
        _exit(1)
```



---

archive/issue_comments_236156.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:28 vbraun]:\n> Minimal testcase (run with `sage -python docker-semaphore.py`):\n\n\nThank you for this excellent analysis! It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.",
    "created_at": "2015-06-17T08:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236156",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>Replying to [comment:28 vbraun]:
> Minimal testcase (run with `sage -python docker-semaphore.py`):


Thank you for this excellent analysis! It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.



---

archive/issue_comments_236157.json:
```json
{
    "body": "Attachment [test17924.patch](tarball://root/attachments/some-uuid/ticket17924/test17924.patch) by @jdemeyer created at 2015-06-17 08:03:52\n\nMake pexpect race condition reproducible",
    "created_at": "2015-06-17T08:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236157",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [test17924.patch](tarball://root/attachments/some-uuid/ticket17924/test17924.patch) by @jdemeyer created at 2015-06-17 08:03:52

Make pexpect race condition reproducible



---

archive/issue_comments_236158.json:
```json
{
    "body": "<a id='comment:37'></a>Adding Volker Braun as author as credit for [comment:28]",
    "created_at": "2015-06-17T08:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236158",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Adding Volker Braun as author as credit for [comment:28]



---

archive/issue_comments_236159.json:
```json
{
    "body": "<a id='comment:39'></a>Great job guys! Thanks so much.\n\nDo you think the issue with the notebook is of the same nature and could be fixed along the same lines?",
    "created_at": "2015-06-17T08:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236159",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:39'></a>Great job guys! Thanks so much.

Do you think the issue with the notebook is of the same nature and could be fixed along the same lines?



---

archive/issue_comments_236160.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:39 nthiery]:\n> Do you think the issue with the notebook is of the same nature and could be fixed along the same lines?\n\n\nMost likely yes, except that the notebook is *supposed* to be independent of Sage (even though, in practice, it's not). There is also the non-trivial issue of actually getting a patch into `sagenb` and making a new `sagenb` release.",
    "created_at": "2015-06-17T08:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236160",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>Replying to [comment:39 nthiery]:
> Do you think the issue with the notebook is of the same nature and could be fixed along the same lines?


Most likely yes, except that the notebook is *supposed* to be independent of Sage (even though, in practice, it's not). There is also the non-trivial issue of actually getting a patch into `sagenb` and making a new `sagenb` release.



---

archive/issue_comments_236161.json:
```json
{
    "body": "<a id='comment:41'></a>I wonder if we could somehow monkey-patch the `pexcept` module such that `pexpect.spawn` always refers to the Sage version?",
    "created_at": "2015-06-17T08:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236161",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>I wonder if we could somehow monkey-patch the `pexcept` module such that `pexpect.spawn` always refers to the Sage version?



---

archive/issue_comments_236162.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:35 jdemeyer]:\n> It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.\n\n\nI agree that it looks related, but there is actually no SystemExit caught. So I still don't understand how that race could have been responsible. Actually I don't understand at all why the SystemExit matters, it must be either a) coincidence, its just timing for the underlying race or b) catching SystemExit somehow changes how signals are handled.",
    "created_at": "2015-06-17T15:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236162",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:42'></a>Replying to [comment:35 jdemeyer]:
> It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.


I agree that it looks related, but there is actually no SystemExit caught. So I still don't understand how that race could have been responsible. Actually I don't understand at all why the SystemExit matters, it must be either a) coincidence, its just timing for the underlying race or b) catching SystemExit somehow changes how signals are handled.



---

archive/issue_comments_236163.json:
```json
{
    "body": "<a id='comment:43'></a>Replying to [comment:42 vbraun]:\n> there is actually no SystemExit caught.\n\nWrong...\n\nHere is what really happens:\n1. `pexpect` calls `os.fork()`, creating 2 Python processes.\n2. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`. As a consequence, anything `print`ed by the child process is not seen.\n3. The child process receives a `SIGHUP`, which (due to the interrupt code in Sage) raises `SystemExit`.\n4. The child process catches `SystemExit` and runs the code which is really meant for the parent process (this is the bug that #17686 fixes).\n5. The child process puts something in the queue, filling it.\n6. The parent process also tries to put something in the queue, which fails.",
    "created_at": "2015-06-17T15:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236163",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:43'></a>Replying to [comment:42 vbraun]:
> there is actually no SystemExit caught.

Wrong...

Here is what really happens:
1. `pexpect` calls `os.fork()`, creating 2 Python processes.
2. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`. As a consequence, anything `print`ed by the child process is not seen.
3. The child process receives a `SIGHUP`, which (due to the interrupt code in Sage) raises `SystemExit`.
4. The child process catches `SystemExit` and runs the code which is really meant for the parent process (this is the bug that #17686 fixes).
5. The child process puts something in the queue, filling it.
6. The parent process also tries to put something in the queue, which fails.



---

archive/issue_comments_236164.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:43 jdemeyer]:\n> 1. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`.\n\n\nArgh, true.",
    "created_at": "2015-06-17T17:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236164",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:44'></a>Replying to [comment:43 jdemeyer]:
> 1. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`.


Argh, true.



---

archive/issue_comments_236165.json:
```json
{
    "body": "<a id='comment:45'></a>Assuming there is still a failure in sagenb: can you open a new ticket? Then I'll merge this one...\n\nLogging (optional, to a file, with high-resolution time stamps) would be nice. Not on this ticket, obviously.",
    "created_at": "2015-06-17T17:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236165",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:45'></a>Assuming there is still a failure in sagenb: can you open a new ticket? Then I'll merge this one...

Logging (optional, to a file, with high-resolution time stamps) would be nice. Not on this ticket, obviously.



---

archive/issue_comments_236166.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-06-17T17:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236166",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_236167.json:
```json
{
    "body": "<a id='comment:47'></a>Follow-up: #18721",
    "created_at": "2015-06-17T17:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236167",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>Follow-up: #18721



---

archive/issue_comments_236168.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-19T08:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17924#issuecomment-236168",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_051034.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-06-19T08:25:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17924",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17924#event-51034"
}
```
