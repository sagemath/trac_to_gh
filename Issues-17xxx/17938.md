# Issue 17938: implement common refinement of fans

archive/issues_017701.json:
```json
{
    "assignees": [],
    "body": "Given two fans in the same lattice, compute the common refinement.\n\nCC:  @vbraun @novoselt jkeitel\n\nKeywords: **fan, toric, refinement**\n\nBranch/Commit: **[da9d676](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)**\n\nReviewer: **Andrey Novoseltsev**\n\nAuthor: **Fr\u00e9d\u00e9ric Chapoton**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/17938_\n\n",
    "closed_at": "2015-03-19T03:17:28Z",
    "created_at": "2015-03-12T10:06:24Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20geometry",
        "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "implement common refinement of fans",
    "type": "issue",
    "updated_at": "2015-03-19T03:17:28Z",
    "url": "https://github.com/sagemath/sage/issues/17938",
    "user": "https://github.com/fchapoton"
}
```
Given two fans in the same lattice, compute the common refinement.

CC:  @vbraun @novoselt jkeitel

Keywords: **fan, toric, refinement**

Branch/Commit: **[da9d676](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)**

Reviewer: **Andrey Novoseltsev**

Author: **Frédéric Chapoton**

_Issue created by migration from https://trac.sagemath.org/ticket/17938_





---

archive/issue_events_228990.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:06:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "milestone_number": null,
    "milestone_title": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228990"
}
```



---

archive/issue_events_228991.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:06:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20geometry",
    "label_color": "0000ff",
    "label_name": "component: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228991"
}
```



---

archive/issue_events_228992.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:06:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228992"
}
```



---

archive/issue_events_228993.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:06:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228993"
}
```



---

archive/issue_comments_245654.json:
```json
{
    "body": "Branch: **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)**",
    "created_at": "2015-03-12T10:42:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245654",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)**



---

archive/issue_events_228994.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:42:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228994"
}
```



---

archive/issue_comments_245655.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f\">0ca9d10</a></td><td><code>trac #17938 common refinement of fans</code></td></tr></table>\n",
    "created_at": "2015-03-12T10:42:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245655",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f">0ca9d10</a></td><td><code>trac #17938 common refinement of fans</code></td></tr></table>




---

archive/issue_events_228995.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:42:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228995"
}
```



---

archive/issue_events_228996.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:42:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228996"
}
```



---

archive/issue_comments_245656.json:
```json
{
    "body": "Commit: **[0ca9d10](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)**",
    "created_at": "2015-03-12T10:42:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245656",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[0ca9d10](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)**



---

archive/issue_comments_245657.json:
```json
{
    "body": "Changed commit from **[0ca9d10](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)** to **[2062a13](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)**",
    "created_at": "2015-03-14T21:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245657",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[0ca9d10](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)** to **[2062a13](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)**



---

archive/issue_comments_245658.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca\">2062a13</a></td><td><code>Merge branch 'u/chapoton/17938' into 6.6.b5</code></td></tr></table>\n",
    "created_at": "2015-03-14T21:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245658",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:2'>Comment 2:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca">2062a13</a></td><td><code>Merge branch 'u/chapoton/17938' into 6.6.b5</code></td></tr></table>




---

archive/issue_comments_245659.json:
```json
{
    "body": "Changed branch from **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)** to **[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)**",
    "created_at": "2015-03-15T18:59:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245659",
    "user": "https://github.com/novoselt"
}
```

Changed branch from **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)** to **[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)**



---

archive/issue_comments_245660.json:
```json
{
    "body": "Reviewer: **Andrey Novoseltsev**",
    "created_at": "2015-03-15T19:01:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245660",
    "user": "https://github.com/novoselt"
}
```

Reviewer: **Andrey Novoseltsev**



---

archive/issue_comments_245661.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nThere is nothing difficult with incomplete fans, just need to verify that supports are the same! If you are fine with changes, set to positive review.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d\">9acc632</a></td><td><code>There is no problem subdividing incomplete fans.</code></td></tr></table>\n",
    "created_at": "2015-03-15T19:01:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245661",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:4'>Comment 4:</a>
There is nothing difficult with incomplete fans, just need to verify that supports are the same! If you are fine with changes, set to positive review.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d">9acc632</a></td><td><code>There is no problem subdividing incomplete fans.</code></td></tr></table>




---

archive/issue_comments_245662.json:
```json
{
    "body": "Changed commit from **[2062a13](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)** to **[9acc632](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)**",
    "created_at": "2015-03-15T19:01:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245662",
    "user": "https://github.com/novoselt"
}
```

Changed commit from **[2062a13](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)** to **[9acc632](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)**



---

archive/issue_comments_245663.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nSorry, but I do not understand what you do with the reverse morphism. It seems like you just do nothing in this `if not(self.is_complete())` statement. Does the simple fact of calling `FanMorphism` magically modify `subdivision` ?",
    "created_at": "2015-03-16T08:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245663",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'>Comment 5:</a>
Sorry, but I do not understand what you do with the reverse morphism. It seems like you just do nothing in this `if not(self.is_complete())` statement. Does the simple fact of calling `FanMorphism` magically modify `subdivision` ?



---

archive/issue_comments_245664.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nIt better not modify anything in the global namespace!!!\n\n```\nsage: F1 = toric_varieties.P2().fan()\nsage: F2 = Fan([F1.generating_cone(0)])\nsage: F2.common_refinement(F1)\n...\n   1661         if not self.is_complete():\n   1662             # Construct the opposite morphism to ensure support equality\n-> 1663             FanMorphism(id, other, self, subdivide=True)\n...\nValueError: morphism defined by\n[1 0]\n[0 1]\ndoes not map\nRational polyhedral fan in 2-d lattice N\ninto the support of\nRational polyhedral fan in 2-d lattice N!\n```\nWithout constructing the second morphism, it is not obvious that the support of F1 is not strictly bigger than the support of F2. Yet if the second one can be constructed, its domain fan will be exactly the same subdivision, so no need to use it somehow.\n\nChecking equality of supports of non-complete fans is tricky, since the support does not have to be convex, so there is no simple object that can model it. (And that's why we don't have `fan.support()` method - the best model for the support of a general fan is the fan itself as a polyhedral complex.) Another more transparent option is to check if the first constructed morphism is surjective, but looking at the code I suspect it is more time-consuming.",
    "created_at": "2015-03-16T17:45:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245664",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'>Comment 6:</a>
It better not modify anything in the global namespace!!!

```
sage: F1 = toric_varieties.P2().fan()
sage: F2 = Fan([F1.generating_cone(0)])
sage: F2.common_refinement(F1)
...
   1661         if not self.is_complete():
   1662             # Construct the opposite morphism to ensure support equality
-> 1663             FanMorphism(id, other, self, subdivide=True)
...
ValueError: morphism defined by
[1 0]
[0 1]
does not map
Rational polyhedral fan in 2-d lattice N
into the support of
Rational polyhedral fan in 2-d lattice N!
```
Without constructing the second morphism, it is not obvious that the support of F1 is not strictly bigger than the support of F2. Yet if the second one can be constructed, its domain fan will be exactly the same subdivision, so no need to use it somehow.

Checking equality of supports of non-complete fans is tricky, since the support does not have to be convex, so there is no simple object that can model it. (And that's why we don't have `fan.support()` method - the best model for the support of a general fan is the fan itself as a polyhedral complex.) Another more transparent option is to check if the first constructed morphism is surjective, but looking at the code I suspect it is more time-consuming.



---

archive/issue_comments_245665.json:
```json
{
    "body": "Changed commit from **[9acc632](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)** to **[da9d676](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)**",
    "created_at": "2015-03-16T20:13:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245665",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[9acc632](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)** to **[da9d676](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)**



---

archive/issue_comments_245666.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nOk, looks good to me. I have just added one more example. If you agree, you can set a positive review. \n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f\">da9d676</a></td><td><code>trac #17938 one more example</code></td></tr></table>\n",
    "created_at": "2015-03-16T20:13:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245666",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'>Comment 7:</a>
Ok, looks good to me. I have just added one more example. If you agree, you can set a positive review. 

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f">da9d676</a></td><td><code>trac #17938 one more example</code></td></tr></table>




---

archive/issue_comments_245667.json:
```json
{
    "body": "Changed branch from **[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)** to **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)**",
    "created_at": "2015-03-16T20:13:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245667",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)** to **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)**



---

archive/issue_events_228997.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2015-03-16T20:21:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228997"
}
```



---

archive/issue_events_228998.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2015-03-16T20:21:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228998"
}
```



---

archive/issue_events_228999.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-03-19T03:17:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-228999"
}
```



---

archive/issue_events_229000.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "ca682a11466112929d3f4121eaa6177f4df0964d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-03-19T03:17:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17938#event-229000"
}
```



---

archive/issue_comments_245668.json:
```json
{
    "body": "Changed branch from **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)** to **[da9d676](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)**",
    "created_at": "2015-03-19T03:17:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17938#issuecomment-245668",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)** to **[da9d676](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)**
