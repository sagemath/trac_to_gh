# Issue 17938: implement common refinement of fans

archive/issues_017701.json:
```json
{
    "body": "Given two fans in the same lattice, compute the common refinement.\n\n**CC:**  @vbraun @novoselt jkeitel\n\n**Keywords:** fan, toric, refinement\n\n**Branch/Commit:** [da9d6765d00393f8b76e496fdaae7f47307f943f](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)\n\n**Reviewer:** Andrey Novoseltsev\n\n**Author:** Fr\u00e9d\u00e9ric Chapoton\n\nIssue created by migration from https://trac.sagemath.org/ticket/17938\n\n",
    "closed_at": "2015-03-19T03:17:28Z",
    "created_at": "2015-03-12T10:06:24Z",
    "labels": [
        "component: geometry",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "implement common refinement of fans",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17938",
    "user": "https://github.com/fchapoton"
}
```
Given two fans in the same lattice, compute the common refinement.

**CC:**  @vbraun @novoselt jkeitel

**Keywords:** fan, toric, refinement

**Branch/Commit:** [da9d6765d00393f8b76e496fdaae7f47307f943f](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)

**Reviewer:** Andrey Novoseltsev

**Author:** Frédéric Chapoton

Issue created by migration from https://trac.sagemath.org/ticket/17938





---

archive/issue_comments_247179.json:
```json
{
    "body": "**Branch:** [u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)",
    "created_at": "2015-03-12T10:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247179",
    "user": "https://github.com/fchapoton"
}
```

**Branch:** [u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)



---

archive/issue_events_164188.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:42:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17938#event-164188"
}
```



---

archive/issue_comments_247180.json:
```json
{
    "body": "<a id='comment:1'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f\">0ca9d10</a></td><td><code>trac #17938 common refinement of fans</code></td></tr></table>\n",
    "created_at": "2015-03-12T10:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247180",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f">0ca9d10</a></td><td><code>trac #17938 common refinement of fans</code></td></tr></table>




---

archive/issue_events_164189.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-03-12T10:42:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "label": "minor",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17938#event-164189"
}
```



---

archive/issue_comments_247181.json:
```json
{
    "body": "**Commit:** [0ca9d108e87269365c8659755356d7ae1ca73b2f](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)",
    "created_at": "2015-03-12T10:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247181",
    "user": "https://github.com/fchapoton"
}
```

**Commit:** [0ca9d108e87269365c8659755356d7ae1ca73b2f](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)



---

archive/issue_comments_247182.json:
```json
{
    "body": "**Changing commit** from \"[0ca9d108e87269365c8659755356d7ae1ca73b2f](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)\" to \"[2062a13a12294275dfd231d09f17258a52ca87ca](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)\".",
    "created_at": "2015-03-14T21:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247182",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0ca9d108e87269365c8659755356d7ae1ca73b2f](https://github.com/sagemath/sagetrac-mirror/commit/0ca9d108e87269365c8659755356d7ae1ca73b2f)" to "[2062a13a12294275dfd231d09f17258a52ca87ca](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)".



---

archive/issue_comments_247183.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca\">2062a13</a></td><td><code>Merge branch 'u/chapoton/17938' into 6.6.b5</code></td></tr></table>\n",
    "created_at": "2015-03-14T21:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247183",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca">2062a13</a></td><td><code>Merge branch 'u/chapoton/17938' into 6.6.b5</code></td></tr></table>




---

archive/issue_comments_247184.json:
```json
{
    "body": "**Changing branch** from \"[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)\" to \"[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)\".",
    "created_at": "2015-03-15T18:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247184",
    "user": "https://github.com/novoselt"
}
```

**Changing branch** from "[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)" to "[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)".



---

archive/issue_comments_247185.json:
```json
{
    "body": "**Reviewer:** Andrey Novoseltsev",
    "created_at": "2015-03-15T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247185",
    "user": "https://github.com/novoselt"
}
```

**Reviewer:** Andrey Novoseltsev



---

archive/issue_comments_247186.json:
```json
{
    "body": "<a id='comment:4'></a>\nThere is nothing difficult with incomplete fans, just need to verify that supports are the same! If you are fine with changes, set to positive review.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d\">9acc632</a></td><td><code>There is no problem subdividing incomplete fans.</code></td></tr></table>\n",
    "created_at": "2015-03-15T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247186",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:4'></a>
There is nothing difficult with incomplete fans, just need to verify that supports are the same! If you are fine with changes, set to positive review.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d">9acc632</a></td><td><code>There is no problem subdividing incomplete fans.</code></td></tr></table>




---

archive/issue_comments_247187.json:
```json
{
    "body": "**Changing commit** from \"[2062a13a12294275dfd231d09f17258a52ca87ca](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)\" to \"[9acc6329f0453e71c760111a98af36b5b2e8c83d](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)\".",
    "created_at": "2015-03-15T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247187",
    "user": "https://github.com/novoselt"
}
```

**Changing commit** from "[2062a13a12294275dfd231d09f17258a52ca87ca](https://github.com/sagemath/sagetrac-mirror/commit/2062a13a12294275dfd231d09f17258a52ca87ca)" to "[9acc6329f0453e71c760111a98af36b5b2e8c83d](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)".



---

archive/issue_comments_247188.json:
```json
{
    "body": "<a id='comment:5'></a>\nSorry, but I do not understand what you do with the reverse morphism. It seems like you just do nothing in this `if not(self.is_complete())` statement. Does the simple fact of calling `FanMorphism` magically modify `subdivision` ?",
    "created_at": "2015-03-16T08:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247188",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
Sorry, but I do not understand what you do with the reverse morphism. It seems like you just do nothing in this `if not(self.is_complete())` statement. Does the simple fact of calling `FanMorphism` magically modify `subdivision` ?



---

archive/issue_comments_247189.json:
```json
{
    "body": "<a id='comment:6'></a>\nIt better not modify anything in the global namespace!!!\n\n```\nsage: F1 = toric_varieties.P2().fan()\nsage: F2 = Fan([F1.generating_cone(0)])\nsage: F2.common_refinement(F1)\n...\n   1661         if not self.is_complete():\n   1662             # Construct the opposite morphism to ensure support equality\n-> 1663             FanMorphism(id, other, self, subdivide=True)\n...\nValueError: morphism defined by\n[1 0]\n[0 1]\ndoes not map\nRational polyhedral fan in 2-d lattice N\ninto the support of\nRational polyhedral fan in 2-d lattice N!\n```\nWithout constructing the second morphism, it is not obvious that the support of F1 is not strictly bigger than the support of F2. Yet if the second one can be constructed, its domain fan will be exactly the same subdivision, so no need to use it somehow.\n\nChecking equality of supports of non-complete fans is tricky, since the support does not have to be convex, so there is no simple object that can model it. (And that's why we don't have `fan.support()` method - the best model for the support of a general fan is the fan itself as a polyhedral complex.) Another more transparent option is to check if the first constructed morphism is surjective, but looking at the code I suspect it is more time-consuming.",
    "created_at": "2015-03-16T17:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247189",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'></a>
It better not modify anything in the global namespace!!!

```
sage: F1 = toric_varieties.P2().fan()
sage: F2 = Fan([F1.generating_cone(0)])
sage: F2.common_refinement(F1)
...
   1661         if not self.is_complete():
   1662             # Construct the opposite morphism to ensure support equality
-> 1663             FanMorphism(id, other, self, subdivide=True)
...
ValueError: morphism defined by
[1 0]
[0 1]
does not map
Rational polyhedral fan in 2-d lattice N
into the support of
Rational polyhedral fan in 2-d lattice N!
```
Without constructing the second morphism, it is not obvious that the support of F1 is not strictly bigger than the support of F2. Yet if the second one can be constructed, its domain fan will be exactly the same subdivision, so no need to use it somehow.

Checking equality of supports of non-complete fans is tricky, since the support does not have to be convex, so there is no simple object that can model it. (And that's why we don't have `fan.support()` method - the best model for the support of a general fan is the fan itself as a polyhedral complex.) Another more transparent option is to check if the first constructed morphism is surjective, but looking at the code I suspect it is more time-consuming.



---

archive/issue_comments_247190.json:
```json
{
    "body": "**Changing commit** from \"[9acc6329f0453e71c760111a98af36b5b2e8c83d](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)\" to \"[da9d6765d00393f8b76e496fdaae7f47307f943f](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)\".",
    "created_at": "2015-03-16T20:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247190",
    "user": "https://github.com/fchapoton"
}
```

**Changing commit** from "[9acc6329f0453e71c760111a98af36b5b2e8c83d](https://github.com/sagemath/sagetrac-mirror/commit/9acc6329f0453e71c760111a98af36b5b2e8c83d)" to "[da9d6765d00393f8b76e496fdaae7f47307f943f](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)".



---

archive/issue_comments_247191.json:
```json
{
    "body": "<a id='comment:7'></a>\nOk, looks good to me. I have just added one more example. If you agree, you can set a positive review. \n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f\">da9d676</a></td><td><code>trac #17938 one more example</code></td></tr></table>\n",
    "created_at": "2015-03-16T20:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247191",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
Ok, looks good to me. I have just added one more example. If you agree, you can set a positive review. 

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f">da9d676</a></td><td><code>trac #17938 one more example</code></td></tr></table>




---

archive/issue_comments_247192.json:
```json
{
    "body": "**Changing branch** from \"[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)\" to \"[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)\".",
    "created_at": "2015-03-16T20:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247192",
    "user": "https://github.com/fchapoton"
}
```

**Changing branch** from "[u/novoselt/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/novoselt/17938)" to "[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)".



---

archive/issue_events_164190.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2015-03-16T20:21:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17938#event-164190"
}
```



---

archive/issue_events_164191.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2015-03-16T20:21:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17938#event-164191"
}
```



---

archive/issue_events_164192.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-03-19T03:17:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17938#event-164192"
}
```



---

archive/issue_events_164193.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-03-19T03:17:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17938#event-164193"
}
```



---

archive/issue_comments_247193.json:
```json
{
    "body": "**Changing branch** from \"[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)\" to \"[da9d6765d00393f8b76e496fdaae7f47307f943f](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)\".",
    "created_at": "2015-03-19T03:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17938",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17938#issuecomment-247193",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/chapoton/17938](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/17938)" to "[da9d6765d00393f8b76e496fdaae7f47307f943f](https://github.com/sagemath/sagetrac-mirror/commit/da9d6765d00393f8b76e496fdaae7f47307f943f)".
