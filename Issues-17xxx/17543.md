# Issue 17543: Move the last few module classes from Module_old to Module

archive/issues_017306.json:
```json
{
    "body": "After #10513, only the following module classes still inherit from `Module_old`, which is being deprecated:\n1. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`\n2. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`\n3. `sage.structure.formal_sum.FormalSums`\nThe goal of this ticket is to make these classes inherit from `Module` instead, to make them use the new coercion model, and to add a deprecation warning to `Module_old`.\n\nCC:  jpflori simonking\n\nKeywords: module coercion\n\nBranch/Commit: c3356ebb98b93142a5a06720b66dfff14dd5f294\n\nReviewer: Vincent Delecroix, Travis Scrimshaw\n\nAuthor: Peter Bruin\n\nDependencies: #10513\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17543\n\n",
    "closed_at": "2015-05-02T14:22:28Z",
    "created_at": "2014-12-23T17:35:29Z",
    "labels": [
        "component: commutative algebra",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Move the last few module classes from Module_old to Module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17543",
    "user": "https://github.com/pjbruin"
}
```
After #10513, only the following module classes still inherit from `Module_old`, which is being deprecated:
1. `sage.modular.abvar.finite_subgroup.FiniteSubgroup`
2. `sage.modular.overconvergent.genus0.OverconvergentModularFormsSpace`
3. `sage.structure.formal_sum.FormalSums`
The goal of this ticket is to make these classes inherit from `Module` instead, to make them use the new coercion model, and to add a deprecation warning to `Module_old`.

CC:  jpflori simonking

Keywords: module coercion

Branch/Commit: c3356ebb98b93142a5a06720b66dfff14dd5f294

Reviewer: Vincent Delecroix, Travis Scrimshaw

Author: Peter Bruin

Dependencies: #10513

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17543





---

archive/issue_comments_230170.json:
```json
{
    "body": "Changing keywords from \"module\" to \"module coercion\".",
    "created_at": "2014-12-30T11:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230170",
    "user": "https://github.com/pjbruin"
}
```

Changing keywords from "module" to "module coercion".



---

archive/issue_comments_230171.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-12-30T11:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230171",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_230172.json:
```json
{
    "body": "<a id='comment:3'></a>Many conflicts on the last beta that I was not able to deal with completely. Moreover, I guess that it would also be safer to rebase over #17585 and #17850 that should be in sage-6.6.beta2. I am willing to review it if you find time to do the rebase after sage-6.6.beta2 is out.\n\nVincent",
    "created_at": "2015-02-28T19:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230172",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>Many conflicts on the last beta that I was not able to deal with completely. Moreover, I guess that it would also be safer to rebase over #17585 and #17850 that should be in sage-6.6.beta2. I am willing to review it if you find time to do the rebase after sage-6.6.beta2 is out.

Vincent



---

archive/issue_comments_230173.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-28T19:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230173",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_230174.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 vdelecroix]:\n> Many conflicts on the last beta that I was not able to deal with completely. Moreover, I guess that it would also be safer to rebase over #17585 and #17850 that should be in sage-6.6.beta2. I am willing to review it if you find time to do the rebase after sage-6.6.beta2 is out.\n\nI think it is best to wait until #10513 is merged.",
    "created_at": "2015-02-28T21:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230174",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:4'></a>Replying to [comment:3 vdelecroix]:
> Many conflicts on the last beta that I was not able to deal with completely. Moreover, I guess that it would also be safer to rebase over #17585 and #17850 that should be in sage-6.6.beta2. I am willing to review it if you find time to do the rebase after sage-6.6.beta2 is out.

I think it is best to wait until #10513 is merged.



---

archive/issue_comments_230175.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-03-20T23:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230175",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_230176.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-03-20T23:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230176",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_230177.json:
```json
{
    "body": "<a id='comment:6'></a>After resolving the merge conflicts for #10513 there was only one left on this ticket.",
    "created_at": "2015-03-20T23:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230177",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:6'></a>After resolving the merge conflicts for #10513 there was only one left on this ticket.



---

archive/issue_comments_230178.json:
```json
{
    "body": "<a id='comment:7'></a>Hi Peter,\n\nI do only have very minor points.\n\nThis error message is not very nice\n\n```\n\"x does not define an element of self\"\n```\nI would rather be more explicit\n\n```\n\"x (={}) does not define an element of {}\".format(x, self)\n```\n(I notice that you are not responsible for that)\n\nWhy did you create the method `generator_orders`? Why not instead replace the code in `abelian_iterator`?\n\n```diff\ndiff --git a/src/sage/structure/gens_py.py b/src/sage/structure/gens_py.py\nindex c272503..e22a8a2 100644\n--- a/src/sage/structure/gens_py.py\n+++ b/src/sage/structure/gens_py.py\n@@ -52,7 +52,7 @@ def abelian_iterator(M):\n         yield M(0)\n         return\n \n-    stop = list(M.generator_orders())\n+    stop = [g.additive_order() for g in G]\n     for i in range(len(stop)):\n         if stop[i] is infinity:\n             raise ArithmeticError(\"%s is not finite.\"%M)\n```\n\n## not for this ticket\n\nDo you know why `FormalSums` is in `sage.structure`? It makes no sense to me. It should rather be in `sage.modules`. Moreover it intersects very much with the combinatorial free modules\n\n```\nsage: C = CombinatorialFreeModule(ZZ,GF(7))\nsage: C.an_element()\n2*B[0] + 2*B[1] + 3*B[2]\n```\nWhat do you think? \n\nwhat `gens_py.py` is doing in `sage.structure`?! I would rather put it in `sage.combinat` or `sage.misc.`",
    "created_at": "2015-04-26T14:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230178",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>Hi Peter,

I do only have very minor points.

This error message is not very nice

```
"x does not define an element of self"
```
I would rather be more explicit

```
"x (={}) does not define an element of {}".format(x, self)
```
(I notice that you are not responsible for that)

Why did you create the method `generator_orders`? Why not instead replace the code in `abelian_iterator`?

```diff
diff --git a/src/sage/structure/gens_py.py b/src/sage/structure/gens_py.py
index c272503..e22a8a2 100644
--- a/src/sage/structure/gens_py.py
+++ b/src/sage/structure/gens_py.py
@@ -52,7 +52,7 @@ def abelian_iterator(M):
         yield M(0)
         return
 
-    stop = list(M.generator_orders())
+    stop = [g.additive_order() for g in G]
     for i in range(len(stop)):
         if stop[i] is infinity:
             raise ArithmeticError("%s is not finite."%M)
```

## not for this ticket

Do you know why `FormalSums` is in `sage.structure`? It makes no sense to me. It should rather be in `sage.modules`. Moreover it intersects very much with the combinatorial free modules

```
sage: C = CombinatorialFreeModule(ZZ,GF(7))
sage: C.an_element()
2*B[0] + 2*B[1] + 3*B[2]
```
What do you think? 

what `gens_py.py` is doing in `sage.structure`?! I would rather put it in `sage.combinat` or `sage.misc.`



---

archive/issue_comments_230179.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-04-26T14:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230179",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_230180.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 vdelecroix]:\n> {{{\n> \"x (={}) does not define an element of {}\".format(x, self)\n> }}}\n\n\nEven better: `\"{!r} does not define an element of {}\".format(x, self)`",
    "created_at": "2015-04-26T15:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230180",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:7 vdelecroix]:
> {{{
> "x (={}) does not define an element of {}".format(x, self)
> }}}


Even better: `"{!r} does not define an element of {}".format(x, self)`



---

archive/issue_comments_230181.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-27T22:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230181",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_230182.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:7 vdelecroix]:\n> This error message is not very nice\n> \n> ```\n> \"x does not define an element of self\"\n> ```\n\nI changed to `\"cannot convert {!r} into {}\".format(x, self)` (also because it sounds nicer: perhaps the user passes an object that makes mathematical sense but for which conversion does not work for some reason).\n> Why did you create the method `generator_orders`? Why not instead replace the code in `abelian_iterator`?\n\nGood idea; I changed this as you suggested.  Maybe `generator_orders()` can be regarded as belonging to the obsolete `ParentWithAdditiveAbelianGens`.\n\n> == not for this ticket ==\n> \n> Do you know why `FormalSums` is in `sage.structure`? It makes no sense to me. It should rather be in `sage.modules`.\n\nYes, it would certainly makes more sense for it to be there.\n> what `gens_py.py` is doing in `sage.structure`?! I would rather put it in `sage.combinat` or `sage.misc.`\n\nProbably because it is only used in `sage.structure.parent_gens`...",
    "created_at": "2015-04-27T23:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230182",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:11'></a>Replying to [comment:7 vdelecroix]:
> This error message is not very nice
> 
> ```
> "x does not define an element of self"
> ```

I changed to `"cannot convert {!r} into {}".format(x, self)` (also because it sounds nicer: perhaps the user passes an object that makes mathematical sense but for which conversion does not work for some reason).
> Why did you create the method `generator_orders`? Why not instead replace the code in `abelian_iterator`?

Good idea; I changed this as you suggested.  Maybe `generator_orders()` can be regarded as belonging to the obsolete `ParentWithAdditiveAbelianGens`.

> == not for this ticket ==
> 
> Do you know why `FormalSums` is in `sage.structure`? It makes no sense to me. It should rather be in `sage.modules`.

Yes, it would certainly makes more sense for it to be there.
> what `gens_py.py` is doing in `sage.structure`?! I would rather put it in `sage.combinat` or `sage.misc.`

Probably because it is only used in `sage.structure.parent_gens`...



---

archive/issue_comments_230183.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-04-27T23:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230183",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_230184.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:11 pbruin]:\n> I changed to `\"cannot convert {!r} into {}\".format(x, self)` (also because it sounds nicer: perhaps the user passes an object that makes mathematical sense but for which conversion does not work for some reason).\n\n\nCaveat: In Python, exception paths can end up being pretty common. For instance, the coercion framework will frequently use \"leap before you look\", relying on catching the exception if that happens. With the line above you can end up with expensive strings processing in a situation where the string never gets displayed. I haven't checked whether that's actually the case for this string and it's a reason to be conservative with constructing complicated error strings. An alternative (if it's necessary) is to use \"lazy\" strings, where the string reps of the constituents are only asked if the \"lazy string\" itself is asked for its representation.\n\n(mind you, our current object for this, `LazyFormat`, is only faster when used with rather complicated parameters, but if we ever find that error message construction is a bottleneck, we could probably optimize `LazyFormat` to really become competitive)",
    "created_at": "2015-04-28T04:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230184",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:13'></a>Replying to [comment:11 pbruin]:
> I changed to `"cannot convert {!r} into {}".format(x, self)` (also because it sounds nicer: perhaps the user passes an object that makes mathematical sense but for which conversion does not work for some reason).


Caveat: In Python, exception paths can end up being pretty common. For instance, the coercion framework will frequently use "leap before you look", relying on catching the exception if that happens. With the line above you can end up with expensive strings processing in a situation where the string never gets displayed. I haven't checked whether that's actually the case for this string and it's a reason to be conservative with constructing complicated error strings. An alternative (if it's necessary) is to use "lazy" strings, where the string reps of the constituents are only asked if the "lazy string" itself is asked for its representation.

(mind you, our current object for this, `LazyFormat`, is only faster when used with rather complicated parameters, but if we ever find that error message construction is a bottleneck, we could probably optimize `LazyFormat` to really become competitive)



---

archive/issue_comments_230185.json:
```json
{
    "body": "<a id='comment:14'></a>Two patchbots are not happy but for no serious reason. The strangely failing doctest on eddy is perfectly fine on my computer.\n\nGood to go!\n\nVincent",
    "created_at": "2015-04-28T06:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230185",
    "user": "https://github.com/videlec"
}
```

<a id='comment:14'></a>Two patchbots are not happy but for no serious reason. The strangely failing doctest on eddy is perfectly fine on my computer.

Good to go!

Vincent



---

archive/issue_comments_230186.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-28T06:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230186",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_230187.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 nbruin]:\n> Replying to [comment:11 pbruin]:\n> > I changed to `\"cannot convert {!r} into {}\".format(x, self)` (also because it sounds nicer: perhaps the user passes an object that makes mathematical sense but for which conversion does not work for some reason).\n\n> \n> Caveat: In Python, exception paths can end up being pretty common. For instance, the coercion framework will frequently use \"leap before you look\", relying on catching the exception if that happens. With the line above you can end up with expensive strings processing in a situation where the string never gets displayed. I haven't checked whether that's actually the case for this string and it's a reason to be conservative with constructing complicated error strings. An alternative (if it's necessary) is to use \"lazy\" strings, where the string reps of the constituents are only asked if the \"lazy string\" itself is asked for its representation.\n> \n> (mind you, our current object for this, `LazyFormat`, is only faster when used with rather complicated parameters, but if we ever find that error message construction is a bottleneck, we could probably optimize `LazyFormat` to really become competitive)\n\n\nWould be cool that string formatting to be fast and uniformized in errors. Why Python does not have a native solution for that?! Right now, I do prefer clear error messages instead of potentially faster coercion discovery.\n\nVincent",
    "created_at": "2015-04-28T06:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230187",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:13 nbruin]:
> Replying to [comment:11 pbruin]:
> > I changed to `"cannot convert {!r} into {}".format(x, self)` (also because it sounds nicer: perhaps the user passes an object that makes mathematical sense but for which conversion does not work for some reason).

> 
> Caveat: In Python, exception paths can end up being pretty common. For instance, the coercion framework will frequently use "leap before you look", relying on catching the exception if that happens. With the line above you can end up with expensive strings processing in a situation where the string never gets displayed. I haven't checked whether that's actually the case for this string and it's a reason to be conservative with constructing complicated error strings. An alternative (if it's necessary) is to use "lazy" strings, where the string reps of the constituents are only asked if the "lazy string" itself is asked for its representation.
> 
> (mind you, our current object for this, `LazyFormat`, is only faster when used with rather complicated parameters, but if we ever find that error message construction is a bottleneck, we could probably optimize `LazyFormat` to really become competitive)


Would be cool that string formatting to be fast and uniformized in errors. Why Python does not have a native solution for that?! Right now, I do prefer clear error messages instead of potentially faster coercion discovery.

Vincent



---

archive/issue_comments_230188.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 vdelecroix]:\n> Would be cool that string formatting to be fast and uniformized in errors. Why Python does not have a native solution for that?! Right now, I do prefer clear error messages instead of potentially faster coercion discovery.\n\n\nI was wrong in my timing. The difference is considerable even here. Taking one of the examples from the documentation:\n\n```\nsage: from sage.misc.lazy_format import LazyFormat\nsage: J = J0(23)\nsage: G = J.torsion_subgroup(11)\nsage: G(J.torsion_subgroup(3).0)\nsage: self=G\nsage: x=J.torsion_subgroup(3).0\nsage: %timeit \"cannot convert {!r} into {}\".format(x, self)\n10000 loops, best of 3: 38.4 \u00b5s per loop\nsage: %timeit \"TypeError: cannot convert %s into %s\"%(x,self)\n10000 loops, best of 3: 33.2 \u00b5s per loop\nsage: %timeit LazyFormat(\"TypeError: cannot convert %s into %s\")%(x,self)\n100000 loops, best of 3: 1.74 \u00b5s per loop\n```\n\nI think you should consider putting LazyFormat in the error messages (it's basically a drop-in replacement) or argue that the relevant error messages are only constructed with really cheap arguments in time-critical situations, or that these error messages never get raised in time-critical situations.",
    "created_at": "2015-04-28T06:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230188",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:16'></a>Replying to [comment:15 vdelecroix]:
> Would be cool that string formatting to be fast and uniformized in errors. Why Python does not have a native solution for that?! Right now, I do prefer clear error messages instead of potentially faster coercion discovery.


I was wrong in my timing. The difference is considerable even here. Taking one of the examples from the documentation:

```
sage: from sage.misc.lazy_format import LazyFormat
sage: J = J0(23)
sage: G = J.torsion_subgroup(11)
sage: G(J.torsion_subgroup(3).0)
sage: self=G
sage: x=J.torsion_subgroup(3).0
sage: %timeit "cannot convert {!r} into {}".format(x, self)
10000 loops, best of 3: 38.4 µs per loop
sage: %timeit "TypeError: cannot convert %s into %s"%(x,self)
10000 loops, best of 3: 33.2 µs per loop
sage: %timeit LazyFormat("TypeError: cannot convert %s into %s")%(x,self)
100000 loops, best of 3: 1.74 µs per loop
```

I think you should consider putting LazyFormat in the error messages (it's basically a drop-in replacement) or argue that the relevant error messages are only constructed with really cheap arguments in time-critical situations, or that these error messages never get raised in time-critical situations.



---

archive/issue_comments_230189.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2015-04-28T06:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230189",
    "user": "https://github.com/nbruin"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_230190.json:
```json
{
    "body": "<a id='comment:17'></a>Note that a few years ago I introduced a lazy attribute error to be used in `sage.structure...`, that had a surprising impact on the performance of \"real\" computations. One of the tricks was to have precisely one instance of the lazy error message; so, one doesn't even lose time to create a new instance for each error being raised (it is only needed to set some cdef attribute of the lazy error message object).\n\nWe did some experiments whether lazy strings could achieve the same, but they couldn't compete. However, what we did there was restricted to attribute errors.\n\nIn any case, I agree that lazy error messages would be an improvment in the current situation.",
    "created_at": "2015-04-28T06:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230190",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>Note that a few years ago I introduced a lazy attribute error to be used in `sage.structure...`, that had a surprising impact on the performance of "real" computations. One of the tricks was to have precisely one instance of the lazy error message; so, one doesn't even lose time to create a new instance for each error being raised (it is only needed to set some cdef attribute of the lazy error message object).

We did some experiments whether lazy strings could achieve the same, but they couldn't compete. However, what we did there was restricted to attribute errors.

In any case, I agree that lazy error messages would be an improvment in the current situation.



---

archive/issue_comments_230191.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 SimonKing]:\n> We did some experiments whether lazy strings could achieve the same, but they couldn't compete. However, what we did there was restricted to attribute errors.\n\nI'd imagine that's faster, but it also has different semantics: if you have a traceback in which several such error messages occur, you'd have inaccurate information. The `LazyFormat` on the other hand is basically a drop-in replacement and, if used properly (i.e., fresh object every time rather than copying) it's probably quite acceptable (see #14585 for improvements though).",
    "created_at": "2015-04-28T07:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230191",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:18'></a>Replying to [comment:17 SimonKing]:
> We did some experiments whether lazy strings could achieve the same, but they couldn't compete. However, what we did there was restricted to attribute errors.

I'd imagine that's faster, but it also has different semantics: if you have a traceback in which several such error messages occur, you'd have inaccurate information. The `LazyFormat` on the other hand is basically a drop-in replacement and, if used properly (i.e., fresh object every time rather than copying) it's probably quite acceptable (see #14585 for improvements though).



---

archive/issue_comments_230192.json:
```json
{
    "body": "<a id='comment:19'></a>I ran all doctests in `sage.modular` after doing\n\n```diff\n--- a/src/sage/modular/abvar/finite_subgroup.py\n+++ b/src/sage/modular/abvar/finite_subgroup.py\n@@ -651,6 +651,7 @@ class FiniteSubgroup(Module):\n             z = self.abelian_variety().vector_space()(x, check=check)\n             if z in self.lattice():\n                 return self.element_class(self, z, check=False)\n+        print('raising complicated error')\n         raise TypeError(\"cannot convert {!r} into {}\".format(x, self))\n \n \n```\nThis shows that the error is only thrown in the doctest of `_element_constructor_()` (this method) and in `__contains__()`, which is implemented in a non-standard way.  Hence I do not suspect string formatting is something we should worry about too much in this case.",
    "created_at": "2015-04-28T08:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230192",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:19'></a>I ran all doctests in `sage.modular` after doing

```diff
--- a/src/sage/modular/abvar/finite_subgroup.py
+++ b/src/sage/modular/abvar/finite_subgroup.py
@@ -651,6 +651,7 @@ class FiniteSubgroup(Module):
             z = self.abelian_variety().vector_space()(x, check=check)
             if z in self.lattice():
                 return self.element_class(self, z, check=False)
+        print('raising complicated error')
         raise TypeError("cannot convert {!r} into {}".format(x, self))
 
 
```
This shows that the error is only thrown in the doctest of `_element_constructor_()` (this method) and in `__contains__()`, which is implemented in a non-standard way.  Hence I do not suspect string formatting is something we should worry about too much in this case.



---

archive/issue_comments_230193.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-28T12:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230193",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_230194.json:
```json
{
    "body": "<a id='comment:21'></a>The latest commit simplifies `FiniteSubgroup._element_constructor_()`.  The new version does not generate a formatted error message itself; the step of converting `x` into the lattice may still do this, as one of the doctests shows.",
    "created_at": "2015-04-28T12:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230194",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:21'></a>The latest commit simplifies `FiniteSubgroup._element_constructor_()`.  The new version does not generate a formatted error message itself; the step of converting `x` into the lattice may still do this, as one of the doctests shows.



---

archive/issue_comments_230195.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-04-28T12:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230195",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_230196.json:
```json
{
    "body": "<a id='comment:22'></a>I'm okay with your latest round of changes. I moved some of the documentation around and added some extra (long) doctests. I'd be happy setting this to positive review as it currently stands (up to someone checking my changes).\n\n---\nNew commits:",
    "created_at": "2015-05-01T02:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230196",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>I'm okay with your latest round of changes. I moved some of the documentation around and added some extra (long) doctests. I'd be happy setting this to positive review as it currently stands (up to someone checking my changes).

---
New commits:



---

archive/issue_comments_230197.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 tscrim]:\n> I'm okay with your latest round of changes. I moved some of the documentation around and added some extra (long) doctests. I'd be happy setting this to positive review as it currently stands (up to someone checking my changes).\n\nOK, thanks!",
    "created_at": "2015-05-01T10:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230197",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:23'></a>Replying to [comment:22 tscrim]:
> I'm okay with your latest round of changes. I moved some of the documentation around and added some extra (long) doctests. I'd be happy setting this to positive review as it currently stands (up to someone checking my changes).

OK, thanks!



---

archive/issue_comments_230198.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-01T10:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230198",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_230199.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-02T14:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17543#issuecomment-230199",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_050386.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-02T14:22:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17543",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17543#event-50386"
}
```
