# Issue 17065: use Maxima's trigrat() in symbolic simplify

archive/issues_016828.json:
```json
{
    "body": "The ask page\nhttp://ask.sagemath.org/question/11365/simplify-trigonometric-expression/\nshowed that trigrat() is not used. What a waste. \n\n**Keywords:** maxima, simplification, trigonometric\n\n**Branch:** [u/rws/use_maxima_s_trigrat___in_symbolic_simplify](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/use_maxima_s_trigrat___in_symbolic_simplify)\n\n**Commit:** [3db6f899c380523dc6d6e940650eede5984a37fa](https://github.com/sagemath/sagetrac-mirror/commit/3db6f899c380523dc6d6e940650eede5984a37fa)\n\n**Upstream:** Fixed upstream, but not in a stable release.\n\n**Author:** Ralf Stephan\n\n**Status:** needs_work\n\nIssue created by migration from https://trac.sagemath.org/ticket/17065\n\n",
    "created_at": "2014-09-29T08:50:53Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "use Maxima's trigrat() in symbolic simplify",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17065",
    "user": "https://github.com/rwst"
}
```
The ask page
http://ask.sagemath.org/question/11365/simplify-trigonometric-expression/
showed that trigrat() is not used. What a waste. 

**Keywords:** maxima, simplification, trigonometric

**Branch:** [u/rws/use_maxima_s_trigrat___in_symbolic_simplify](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/use_maxima_s_trigrat___in_symbolic_simplify)

**Commit:** [3db6f899c380523dc6d6e940650eede5984a37fa](https://github.com/sagemath/sagetrac-mirror/commit/3db6f899c380523dc6d6e940650eede5984a37fa)

**Upstream:** Fixed upstream, but not in a stable release.

**Author:** Ralf Stephan

**Status:** needs_work

Issue created by migration from https://trac.sagemath.org/ticket/17065





---

archive/issue_comments_291510.json:
```json
{
    "body": "**Branch:** [u/rws/use_maxima_s_trigrat___in_symbolic_simplify](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/use_maxima_s_trigrat___in_symbolic_simplify)",
    "created_at": "2014-09-30T13:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291510",
    "user": "https://github.com/rwst"
}
```

**Branch:** [u/rws/use_maxima_s_trigrat___in_symbolic_simplify](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/use_maxima_s_trigrat___in_symbolic_simplify)



---

archive/issue_comments_291511.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2014-09-30T13:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291511",
    "user": "https://github.com/rwst"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_291512.json:
```json
{
    "body": "<a id='comment:2'></a>\nPlease review.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3db6f899c380523dc6d6e940650eede5984a37fa\">3db6f89</a></td><td><code>17065: do trigrat after trigexpand; doctest</code></td></tr></table>\n",
    "created_at": "2014-09-30T13:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291512",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>
Please review.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3db6f899c380523dc6d6e940650eede5984a37fa">3db6f89</a></td><td><code>17065: do trigrat after trigexpand; doctest</code></td></tr></table>




---

archive/issue_comments_291513.json:
```json
{
    "body": "**Commit:** [3db6f899c380523dc6d6e940650eede5984a37fa](https://github.com/sagemath/sagetrac-mirror/commit/3db6f899c380523dc6d6e940650eede5984a37fa)",
    "created_at": "2014-09-30T13:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291513",
    "user": "https://github.com/rwst"
}
```

**Commit:** [3db6f899c380523dc6d6e940650eede5984a37fa](https://github.com/sagemath/sagetrac-mirror/commit/3db6f899c380523dc6d6e940650eede5984a37fa)



---

archive/issue_comments_291514.json:
```json
{
    "body": "**Author:** Ralf Stephan",
    "created_at": "2014-09-30T13:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291514",
    "user": "https://github.com/rwst"
}
```

**Author:** Ralf Stephan



---

archive/issue_comments_291515.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2014-09-30T17:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291515",
    "user": "https://github.com/nbruin"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_291516.json:
```json
{
    "body": "<a id='comment:3'></a>\nQuite some doctest failures on the buildbot. Some of them are probably not due this particular change, but others most probably are. A few are simply *better* answers now (that's just a matter of changing the expected output), but there are also some that are much *worse*. So the change is not uniformly an improvement.\n\nratsimp claims \"canonical form\", so that's definitely attractive. However, do we know if its rewrites always apply across the whole domain? We'd have to document if it deviates.",
    "created_at": "2014-09-30T17:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291516",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'></a>
Quite some doctest failures on the buildbot. Some of them are probably not due this particular change, but others most probably are. A few are simply *better* answers now (that's just a matter of changing the expected output), but there are also some that are much *worse*. So the change is not uniformly an improvement.

ratsimp claims "canonical form", so that's definitely attractive. However, do we know if its rewrites always apply across the whole domain? We'd have to document if it deviates.



---

archive/issue_comments_291517.json:
```json
{
    "body": "<a id='comment:4'></a>\nSince setting \"needs_work\" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.",
    "created_at": "2014-10-02T09:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291517",
    "user": "https://github.com/rwst"
}
```

<a id='comment:4'></a>
Since setting "needs_work" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.



---

archive/issue_comments_291518.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis can even lead to disaster, I think:\n\n```\nsage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\nsage: F.maxima_methods().trigrat()\nsqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n2*I*sin(2/5*pi) + 1\n```\nI really am not interested in seeing `I` turn up in such a simplification, regardless of the \"correct\" answer.",
    "created_at": "2014-10-02T16:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291518",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:5'></a>
This can even lead to disaster, I think:

```
sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
sage: F.maxima_methods().trigrat()
sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
2*I*sin(2/5*pi) + 1
```
I really am not interested in seeing `I` turn up in such a simplification, regardless of the "correct" answer.



---

archive/issue_comments_291519.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2014-10-03T15:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291519",
    "user": "https://github.com/nbruin"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_291520.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [rws](#comment%3A4):\n> Since setting \"needs_work\" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.\n\n\nOh, that's silly. I'm setting it back to \"needs review\" to make the report visible for now. Hopefully we can have this fixed.",
    "created_at": "2014-10-03T15:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291520",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:6'></a>
Replying to [rws](#comment%3A4):
> Since setting "needs_work" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.


Oh, that's silly. I'm setting it back to "needs review" to make the report visible for now. Hopefully we can have this fixed.



---

archive/issue_comments_291521.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2014-10-03T16:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291521",
    "user": "https://github.com/rwst"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_291522.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks, the link is now here: http://build.sagedev.org/trac/builders/trac_builder/builds/1046\nso the ticket can be set to the right status.",
    "created_at": "2014-10-03T16:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291522",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>
Thanks, the link is now here: http://build.sagedev.org/trac/builders/trac_builder/builds/1046
so the ticket can be set to the right status.



---

archive/issue_comments_291523.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [kcrisman](#comment%3A5):\n> This can even lead to disaster, I think:\n> \n> ```\n> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\n> sage: F.maxima_methods().trigrat()\n> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n> 2*I*sin(2/5*pi) + 1\n> ```\n> I really am not interested in seeing `I` turn up in such a simplification, regardless of the \"correct\" answer.\n\nWhile this one could be resolved by adding a `trigreduce` to the queue:\n\n```\nsage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\nsage: F.maxima_methods().trigrat()\nsqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n2*I*sin(2/5*pi) + 1\nsage: _.maxima_methods().trigreduce()\nsqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1\n```\nI cannot see how to fix the doctest failure:\n\n```\nFile \"src/doc/de/thematische_anleitungen/sage_gymnasium.rst\", line 394, in doc.de.thematische_anleitungen.sage_gymnasium\nFailed example:\n    (sin(x + y)/(log(x) + log(y))).simplify_full()\nExpected:\n    (cos(y)*sin(x) + cos(x)*sin(y))/log(x*y)\nGot:\n    ((-I*arctan2(0, x) - I*arctan2(0, y))*sin(x + y) + log(abs(x)*abs(y))*sin(x + y))/(arctan2(0, x)^2 + 2*arctan2(0, x)*arctan2(0, y) + arctan2(0, y)^2 + log(abs(x))^2 + 2*log(abs(x))*log(abs(y)) + log(abs(y))^2)\n```\nthe minimal case being\n\n```\nsage: log(x).maxima_methods().trigrat()\nI*arctan2(0, x) + log(abs(x))\n```",
    "created_at": "2014-10-04T13:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291523",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>
Replying to [kcrisman](#comment%3A5):
> This can even lead to disaster, I think:
> 
> ```
> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
> sage: F.maxima_methods().trigrat()
> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
> 2*I*sin(2/5*pi) + 1
> ```
> I really am not interested in seeing `I` turn up in such a simplification, regardless of the "correct" answer.

While this one could be resolved by adding a `trigreduce` to the queue:

```
sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
sage: F.maxima_methods().trigrat()
sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
2*I*sin(2/5*pi) + 1
sage: _.maxima_methods().trigreduce()
sqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1
```
I cannot see how to fix the doctest failure:

```
File "src/doc/de/thematische_anleitungen/sage_gymnasium.rst", line 394, in doc.de.thematische_anleitungen.sage_gymnasium
Failed example:
    (sin(x + y)/(log(x) + log(y))).simplify_full()
Expected:
    (cos(y)*sin(x) + cos(x)*sin(y))/log(x*y)
Got:
    ((-I*arctan2(0, x) - I*arctan2(0, y))*sin(x + y) + log(abs(x)*abs(y))*sin(x + y))/(arctan2(0, x)^2 + 2*arctan2(0, x)*arctan2(0, y) + arctan2(0, y)^2 + log(abs(x))^2 + 2*log(abs(x))*log(abs(y)) + log(abs(y))^2)
```
the minimal case being

```
sage: log(x).maxima_methods().trigrat()
I*arctan2(0, x) + log(abs(x))
```



---

archive/issue_comments_291524.json:
```json
{
    "body": "<a id='comment:9'></a>\nOn the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:\n\n```\nsage: sin(1/8*pi)*sin(3/8*pi)*sin(5/8*pi)*sin(7/8*pi)\nsin(7/8*pi)*sin(5/8*pi)*sin(3/8*pi)*sin(1/8*pi)\nsage: _.maxima_methods().trigreduce()\nTypeError                                 Traceback (most recent call last)\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in `__init__`(self, parent, value, is_name, name)\n    624                 self._name = parent._create(value, name=name)\n    625             except (TypeError, RuntimeError, ValueError) as x:\n--> 626                 raise TypeError(x)\n    627 \n    628     def `_latex_`(self):\n\nTypeError: ECL says: Unrecognised output from sp1sintcos.\n```",
    "created_at": "2014-10-04T13:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291524",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>
On the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:

```
sage: sin(1/8*pi)*sin(3/8*pi)*sin(5/8*pi)*sin(7/8*pi)
sin(7/8*pi)*sin(5/8*pi)*sin(3/8*pi)*sin(1/8*pi)
sage: _.maxima_methods().trigreduce()
TypeError                                 Traceback (most recent call last)
/home/ralf/sage/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in `__init__`(self, parent, value, is_name, name)
    624                 self._name = parent._create(value, name=name)
    625             except (TypeError, RuntimeError, ValueError) as x:
--> 626                 raise TypeError(x)
    627 
    628     def `_latex_`(self):

TypeError: ECL says: Unrecognised output from sp1sintcos.
```



---

archive/issue_comments_291525.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [rws](#comment%3A9):\n> On the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:\n> [...]\n\nYes, I noticed that one too. I have confirmed that the same problem arises in Maxima 5.34.1 on SBCL, so it's probably a maxima problem. This is now:\n[https://sourceforge.net/p/maxima/bugs/2818/](https://sourceforge.net/p/maxima/bugs/2818/)",
    "created_at": "2014-10-05T18:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291525",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:10'></a>
Replying to [rws](#comment%3A9):
> On the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:
> [...]

Yes, I noticed that one too. I have confirmed that the same problem arises in Maxima 5.34.1 on SBCL, so it's probably a maxima problem. This is now:
[https://sourceforge.net/p/maxima/bugs/2818/](https://sourceforge.net/p/maxima/bugs/2818/)



---

archive/issue_comments_291526.json:
```json
{
    "body": "**Changing upstream** from \"N/A\" to \"Fixed upstream, but not in a stable release.\".",
    "created_at": "2014-10-31T16:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291526",
    "user": "https://github.com/rwst"
}
```

**Changing upstream** from "N/A" to "Fixed upstream, but not in a stable release.".



---

archive/issue_comments_291527.json:
```json
{
    "body": "<a id='comment:12'></a>\nWhile some of the mentioned problems have been fixed in recent Maxima, this no longer works:\n> \n> ```\n> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\n> sage: F.maxima_methods().trigrat()\n> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n> 2*I*sin(2/5*pi) + 1\n> sage: _.maxima_methods().trigreduce()\n> sqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1\n> ```\n",
    "created_at": "2015-02-11T15:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17065#issuecomment-291527",
    "user": "https://github.com/rwst"
}
```

<a id='comment:12'></a>
While some of the mentioned problems have been fixed in recent Maxima, this no longer works:
> 
> ```
> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
> sage: F.maxima_methods().trigrat()
> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
> 2*I*sin(2/5*pi) + 1
> sage: _.maxima_methods().trigreduce()
> sqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1
> ```

