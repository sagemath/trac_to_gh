# Issue 17670: Proper implementation of object pools

archive/issues_017433.json:
```json
{
    "body": "`integer.pyx` and `real_double.pyx` use `hook_tp_functions()` to change `tp_new` and `tp_dealloc` at run-time. It seems that one cannot avoid such hacks with the current Cython, but at least we could provide a cleaner interface.\n\nCC:  @roed314 @saraedum @xcaruso\n\nKeywords: padicIMA, padicBordeaux\n\nAuthor: Jeroen Demeyer\n\nBranch: u/roed/proper_implementation_of_object_pools\n\nDependencies: #24111\n\nCommit: d7d56b13f702b6db60b8a361111aba24c2334bda\n\nIssue created by migration from https://trac.sagemath.org/ticket/17670\n\n",
    "created_at": "2015-01-25T16:51:20Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Proper implementation of object pools",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17670",
    "user": "https://github.com/jdemeyer"
}
```
`integer.pyx` and `real_double.pyx` use `hook_tp_functions()` to change `tp_new` and `tp_dealloc` at run-time. It seems that one cannot avoid such hacks with the current Cython, but at least we could provide a cleaner interface.

CC:  @roed314 @saraedum @xcaruso

Keywords: padicIMA, padicBordeaux

Author: Jeroen Demeyer

Branch: u/roed/proper_implementation_of_object_pools

Dependencies: #24111

Commit: d7d56b13f702b6db60b8a361111aba24c2334bda

Issue created by migration from https://trac.sagemath.org/ticket/17670





---

archive/issue_events_050599.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-09-26T12:06:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "milestone": "sage-8.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17670#event-50599"
}
```



---

archive/issue_comments_232549.json:
```json
{
    "body": "<a id='comment:6'></a>I've just had a look at your implementation (sorry for the delay).\n\nI saw that you stored the address of the pool in a dictionary. Did you try to estimate the time penalty of this dictionary lookup? For instance, did you compare timings between (1) your implementation and (2) the current implementation for integers?\n\nBy design, your implementation cannot allow what I've called local pools (several different pools are possible for a same type) and global pools (a unique pool is shared all by all elements having a given type). I'm a bit sad about this because I think that having different pools may really make sense (for instance for p-adics when we are dealing with many different primes p and then objects with different sizes).\nBut OK, I can accept this :-).\n\nWhy are you limiting the number of pools to 4? Isn't it too small?\n\n---\nNew commits:",
    "created_at": "2017-10-26T08:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232549",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:6'></a>I've just had a look at your implementation (sorry for the delay).

I saw that you stored the address of the pool in a dictionary. Did you try to estimate the time penalty of this dictionary lookup? For instance, did you compare timings between (1) your implementation and (2) the current implementation for integers?

By design, your implementation cannot allow what I've called local pools (several different pools are possible for a same type) and global pools (a unique pool is shared all by all elements having a given type). I'm a bit sad about this because I think that having different pools may really make sense (for instance for p-adics when we are dealing with many different primes p and then objects with different sizes).
But OK, I can accept this :-).

Why are you limiting the number of pools to 4? Isn't it too small?

---
New commits:



---

archive/issue_comments_232550.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 caruso]:\n> Why are you limiting the number of pools to 4? Isn't it too small?\n\n\n4 **per Cython module**.",
    "created_at": "2017-10-26T09:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232550",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 caruso]:
> Why are you limiting the number of pools to 4? Isn't it too small?


4 **per Cython module**.



---

archive/issue_comments_232551.json:
```json
{
    "body": "<a id='comment:8'></a>A more general comment about pools is that everybody has a different set of features. For example, the `Integer` pool that we currently have in Sage is actually more than just a pool. It also constructs new objects quickly from a prototype object.",
    "created_at": "2017-10-26T09:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232551",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>A more general comment about pools is that everybody has a different set of features. For example, the `Integer` pool that we currently have in Sage is actually more than just a pool. It also constructs new objects quickly from a prototype object.



---

archive/issue_comments_232552.json:
```json
{
    "body": "<a id='comment:10'></a>Let me continue with this... I'm adding a dependency on #24111 because that makes it a lot easier to write modules which are partially implemented in C and partially in Cython.",
    "created_at": "2017-10-26T09:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232552",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Let me continue with this... I'm adding a dependency on #24111 because that makes it a lot easier to write modules which are partially implemented in C and partially in Cython.



---

archive/issue_comments_232553.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-10-26T11:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232554.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-10-26T12:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232554",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232555.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:6 caruso]:\n> I saw that you stored the address of the pool in a dictionary. Did you try to estimate the time penalty of this dictionary lookup?\n\n\nI am not doing any dictionary lookup (except for putting the pool in the dict). I am storing the pool in the dict for 2 reasons: for debugging purposes and to ensure that some reference is kept to the pool (to prevent it from being deleted). I do not use this dict in the implementation.\n\n> By design, your implementation cannot allow what I've called local pools (several different pools are possible for a same type) and global pools (a unique pool is shared all by all elements having a given type). I'm a bit sad about this because I think that having different pools may really make sense\n\n\nI never understood the need for local pools. I thought that you stored the pool in the parent only for practical purposes.\n\n> and then objects with different sizes\n\n\nWhat do you mean with \"objects with different sizes\"?",
    "created_at": "2017-10-26T12:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232555",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:6 caruso]:
> I saw that you stored the address of the pool in a dictionary. Did you try to estimate the time penalty of this dictionary lookup?


I am not doing any dictionary lookup (except for putting the pool in the dict). I am storing the pool in the dict for 2 reasons: for debugging purposes and to ensure that some reference is kept to the pool (to prevent it from being deleted). I do not use this dict in the implementation.

> By design, your implementation cannot allow what I've called local pools (several different pools are possible for a same type) and global pools (a unique pool is shared all by all elements having a given type). I'm a bit sad about this because I think that having different pools may really make sense


I never understood the need for local pools. I thought that you stored the pool in the parent only for practical purposes.

> and then objects with different sizes


What do you mean with "objects with different sizes"?



---

archive/issue_comments_232556.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-07T16:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232556",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232557.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-07T21:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232557",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232558.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-08T16:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232558",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232559.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-10T10:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232559",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232560.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-10T11:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232560",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_232561.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-10T14:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232561",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232562.json:
```json
{
    "body": "<a id='comment:20'></a>Cool!  I read through the code, but am too sleepy to make comments (or test further) tonight.  Overall, it looks good and tests pass!",
    "created_at": "2017-11-11T06:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232562",
    "user": "https://github.com/roed314"
}
```

<a id='comment:20'></a>Cool!  I read through the code, but am too sleepy to make comments (or test further) tonight.  Overall, it looks good and tests pass!



---

archive/issue_comments_232563.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-16T13:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232563",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232564.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-17T09:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232564",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_232565.json:
```json
{
    "body": "<a id='comment:22'></a>There is worrying doctest failure on the patchbot that I'll need to check.",
    "created_at": "2017-11-17T09:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232565",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>There is worrying doctest failure on the patchbot that I'll need to check.



---

archive/issue_comments_232566.json:
```json
{
    "body": "<a id='comment:25'></a>I do intend to come back to this ticket, but this really needs a new version of Cython.\n\n---\nLast 10 new commits:",
    "created_at": "2018-02-26T08:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232566",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>I do intend to come back to this ticket, but this really needs a new version of Cython.

---
Last 10 new commits:



---

archive/issue_comments_232567.json:
```json
{
    "body": "<a id='comment:26'></a>New commits:",
    "created_at": "2018-02-26T11:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232567",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:26'></a>New commits:



---

archive/issue_comments_232568.json:
```json
{
    "body": "<a id='comment:28'></a>???\n\n---\nNew commits:",
    "created_at": "2018-02-26T13:36:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232568",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>???

---
New commits:



---

archive/issue_comments_232569.json:
```json
{
    "body": "<a id='comment:29'></a>Sorry, I merged by mistake ticket #23505 into this one.\nThis should be fixed now.",
    "created_at": "2018-02-26T13:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232569",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:29'></a>Sorry, I merged by mistake ticket #23505 into this one.
This should be fixed now.



---

archive/issue_comments_232570.json:
```json
{
    "body": "<a id='comment:30'></a>So the branch should be reset to my branch then?",
    "created_at": "2018-02-26T14:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232570",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>So the branch should be reset to my branch then?



---

archive/issue_comments_232571.json:
```json
{
    "body": "<a id='comment:31'></a>Well, I also resolved a couple of conflicts, so that my branch is supposed to merge properly with develop.",
    "created_at": "2018-02-26T14:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232571",
    "user": "https://github.com/xcaruso"
}
```

<a id='comment:31'></a>Well, I also resolved a couple of conflicts, so that my branch is supposed to merge properly with develop.



---

archive/issue_comments_232572.json:
```json
{
    "body": "<a id='comment:32'></a>I see. But given that #24111 is not a \"real\" ticket, it's better to rebase instead of merge.",
    "created_at": "2018-02-26T14:53:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232572",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>I see. But given that #24111 is not a "real" ticket, it's better to rebase instead of merge.



---

archive/issue_comments_232573.json:
```json
{
    "body": "<a id='comment:33'></a>#24111 just became a real ticket and it needs review :-)",
    "created_at": "2018-03-14T19:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232573",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>#24111 just became a real ticket and it needs review :-)



---

archive/issue_comments_232574.json:
```json
{
    "body": "Changing keywords from \"\" to \"padicIMA\".",
    "created_at": "2018-07-22T20:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232574",
    "user": "https://github.com/roed314"
}
```

Changing keywords from "" to "padicIMA".



---

archive/issue_comments_232575.json:
```json
{
    "body": "<a id='comment:35'></a>Xavier, Julian and I are going to be working on p-adics this coming week in Bordeaux.  I'm just tagging this ticket as one we might want to look at.",
    "created_at": "2019-09-07T11:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232575",
    "user": "https://github.com/roed314"
}
```

<a id='comment:35'></a>Xavier, Julian and I are going to be working on p-adics this coming week in Bordeaux.  I'm just tagging this ticket as one we might want to look at.



---

archive/issue_comments_232576.json:
```json
{
    "body": "Changing keywords from \"padicIMA\" to \"padicIMA, padicBordeaux\".",
    "created_at": "2019-09-07T11:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232576",
    "user": "https://github.com/roed314"
}
```

Changing keywords from "padicIMA" to "padicIMA, padicBordeaux".



---

archive/issue_comments_232577.json:
```json
{
    "body": "<a id='comment:36'></a>Jeroen, we're happy to work on this a bit this week (in particular, resolving merge conflicts).  Do you have any known issues with what you've written?",
    "created_at": "2019-09-07T11:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232577",
    "user": "https://github.com/roed314"
}
```

<a id='comment:36'></a>Jeroen, we're happy to work on this a bit this week (in particular, resolving merge conflicts).  Do you have any known issues with what you've written?



---

archive/issue_comments_232578.json:
```json
{
    "body": "<a id='comment:38'></a>I resolved the merge conflicts, which were in the cython version level and `integer.pyx`, but now Sage crashes on startup.  When I ran `make build`, it surprisingly only rebuilt 4 Cython files.  Given that there are patches to Cython in this ticket, I think I might need to reinstall Cython with `sage -f cython`, but I think I'm going to work on other tickets for now rather than try to debug this.\n\n---\nNew commits:",
    "created_at": "2019-09-07T15:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17670",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17670#issuecomment-232578",
    "user": "https://github.com/roed314"
}
```

<a id='comment:38'></a>I resolved the merge conflicts, which were in the cython version level and `integer.pyx`, but now Sage crashes on startup.  When I ran `make build`, it surprisingly only rebuilt 4 Cython files.  Given that there are patches to Cython in this ticket, I think I might need to reinstall Cython with `sage -f cython`, but I think I'm going to work on other tickets for now rather than try to debug this.

---
New commits:
