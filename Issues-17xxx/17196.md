# Issue 17196: Relax assumptions on bitset operations

archive/issues_016959.json:
```json
{
    "assignees": [],
    "body": "Most bitset operations state something like\n\n```\n    We assume the two sets have the same size.  Otherwise, the\n    behavior of this function is undefined and the function may\n    segfault.\n```\n\nHowever, in fact most of these requirements can be relaxed.\n\nIn many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes `r.size <= a.size + n` which is useful for #15820.\n\nAlso move bitsets to `src/sage/data_structures`.\n\nCC:  @nathanncohen\n\nBranch/Commit: **[`23762a3`](https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d)**\n\nReviewer: **Simon King**\n\nAuthor: **Jeroen Demeyer, Simon King**\n\nComponent: **misc**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/17196_\n\n",
    "closed_at": "2014-10-27T16:02:26Z",
    "created_at": "2014-10-22T13:12:30Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Relax assumptions on bitset operations",
    "type": "issue",
    "updated_at": "2014-10-27T16:02:26Z",
    "url": "https://github.com/sagemath/sage/issues/17196",
    "user": "https://github.com/jdemeyer"
}
```
Most bitset operations state something like

```
    We assume the two sets have the same size.  Otherwise, the
    behavior of this function is undefined and the function may
    segfault.
```

However, in fact most of these requirements can be relaxed.

In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes `r.size <= a.size + n` which is useful for #15820.

Also move bitsets to `src/sage/data_structures`.

CC:  @nathanncohen

Branch/Commit: **[`23762a3`](https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d)**

Reviewer: **Simon King**

Author: **Jeroen Demeyer, Simon King**

Component: **misc**

_Issue created by migration from https://trac.sagemath.org/ticket/17196_





---

archive/issue_events_243248.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-10-22T13:12:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243248"
}
```



---

archive/issue_events_243249.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-10-22T13:12:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243249"
}
```



---

archive/issue_events_243250.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-10-22T13:12:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243250"
}
```



---

archive/issue_events_243251.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-10-22T14:17:27Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "title_is": "Relax assumptions on bitset operations",
    "title_was": "Clarify assumptions on bitset operations",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243251"
}
```



---

archive/issue_comments_228459.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,3 +7,5 @@\n ```\n \n However, in fact many of these requirements can be relaxed.\n+\n+In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes ``r.size <= a.size + n`` which is useful for #15820.\n``````\n",
    "created_at": "2014-10-22T14:17:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228459",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,3 +7,5 @@
 ```
 
 However, in fact many of these requirements can be relaxed.
+
+In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes ``r.size <= a.size + n`` which is useful for #15820.
``````




---

archive/issue_comments_228460.json:
```json
{
    "body": "Branch: **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)**",
    "created_at": "2014-10-22T15:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228460",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)**



---

archive/issue_comments_228461.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIs it ready for a review?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/83f8a5648815d7c25eb0c9f9b4bdaf04dd90335e\"><code>83f8a56</code></a></td><td><code>Relax assumptions for bitset functions</code></td></tr></table>\n",
    "created_at": "2014-10-22T18:08:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228461",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:4" align="right">comment:4</div>

Is it ready for a review?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/83f8a5648815d7c25eb0c9f9b4bdaf04dd90335e"><code>83f8a56</code></a></td><td><code>Relax assumptions for bitset functions</code></td></tr></table>




---

archive/issue_comments_228462.json:
```json
{
    "body": "Commit: **[`83f8a56`](https://github.com/sagemath/sagetrac-mirror/commit/83f8a5648815d7c25eb0c9f9b4bdaf04dd90335e)**",
    "created_at": "2014-10-22T18:08:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228462",
    "user": "https://github.com/simon-king-jena"
}
```

Commit: **[`83f8a56`](https://github.com/sagemath/sagetrac-mirror/commit/83f8a5648815d7c25eb0c9f9b4bdaf04dd90335e)**



---

archive/issue_comments_228463.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nSomething I'd like to see is the *empty* bitset. The fact that the size of a bitset must be positive caused me some headache at #15820, where I need bounded integer sequences of length zero. And I think it is not a good solution to fake-use bitsets of size 1 if the actual size is zero.",
    "created_at": "2014-10-22T18:43:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228463",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

Something I'd like to see is the *empty* bitset. The fact that the size of a bitset must be positive caused me some headache at #15820, where I need bounded integer sequences of length zero. And I think it is not a good solution to fake-use bitsets of size 1 if the actual size is zero.



---

archive/issue_comments_228464.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nBesides, while we are at it: Shouldn't it be moved to `sage.data_structures`?",
    "created_at": "2014-10-22T18:44:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228464",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

Besides, while we are at it: Shouldn't it be moved to `sage.data_structures`?



---

archive/issue_comments_228465.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nFor the record: I am trying the move to sage.data_structures right now (hope we are not having a race condition in our commits...)",
    "created_at": "2014-10-22T19:14:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228465",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

For the record: I am trying the move to sage.data_structures right now (hope we are not having a race condition in our commits...)



---

archive/issue_comments_228466.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)** to **[public/17196/relax-assumptions-on-bitset-operations](https://github.com/sagemath/sagetrac-mirror/tree/public/17196/relax-assumptions-on-bitset-operations)**",
    "created_at": "2014-10-22T21:04:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228466",
    "user": "https://github.com/simon-king-jena"
}
```

Changed branch from **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)** to **[public/17196/relax-assumptions-on-bitset-operations](https://github.com/sagemath/sagetrac-mirror/tree/public/17196/relax-assumptions-on-bitset-operations)**



---

archive/issue_comments_228467.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThe commit that I pushed moves bitsets to the new data_structures folder. I am running tests now. So far it works well...\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ae75a1f8fcfee0f78faf9bb4bb006149b535c45\"><code>3ae75a1</code></a></td><td><code>Move bitset to sage.data_structures</code></td></tr></table>\n",
    "created_at": "2014-10-22T21:05:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228467",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

The commit that I pushed moves bitsets to the new data_structures folder. I am running tests now. So far it works well...

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ae75a1f8fcfee0f78faf9bb4bb006149b535c45"><code>3ae75a1</code></a></td><td><code>Move bitset to sage.data_structures</code></td></tr></table>




---

archive/issue_comments_228468.json:
```json
{
    "body": "Changed commit from **[`83f8a56`](https://github.com/sagemath/sagetrac-mirror/commit/83f8a5648815d7c25eb0c9f9b4bdaf04dd90335e)** to **[`3ae75a1`](https://github.com/sagemath/sagetrac-mirror/commit/3ae75a1f8fcfee0f78faf9bb4bb006149b535c45)**",
    "created_at": "2014-10-22T21:05:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228468",
    "user": "https://github.com/simon-king-jena"
}
```

Changed commit from **[`83f8a56`](https://github.com/sagemath/sagetrac-mirror/commit/83f8a5648815d7c25eb0c9f9b4bdaf04dd90335e)** to **[`3ae75a1`](https://github.com/sagemath/sagetrac-mirror/commit/3ae75a1f8fcfee0f78faf9bb4bb006149b535c45)**



---

archive/issue_comments_228469.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nWhat I try to do next: Empty bitsets.\n\nQuestion: Should one perhaps create different functions `bitset_init_copy(res,src)` vs. `bitset_realloc_copy(res,src)`, where in the first it is assumed that `res` is not initialised, whereas the second function will override previous contents of `res`? And similar for other functions such as shift?",
    "created_at": "2014-10-22T21:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228469",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">comment:10</div>

What I try to do next: Empty bitsets.

Question: Should one perhaps create different functions `bitset_init_copy(res,src)` vs. `bitset_realloc_copy(res,src)`, where in the first it is assumed that `res` is not initialised, whereas the second function will override previous contents of `res`? And similar for other functions such as shift?



---

archive/issue_comments_228470.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nHow clever are compilers?\n\nThe question is related to idioms like `n % GMP_LIMB_BITS`.\n\n`GMP_LIMB_BITS` is a power of two, and it is known at compile time. Hence, `n % GMP_LIMB_BITS` does not involve a generally very expensive `%`-operation, but boils down to a simple `&`.\n\nWill compilers automatically use this optimization? If not, then I think we should introduce an integer constant `mod_mp_bits_per_limb` (see #15820), so that `n % GMP_LIMB_BITS == n & mp_bits_per_limb`. If yes, then I guess one can also avoid `n >> index_shift`, and use `n//GMP_LIMB_BITS` instead.",
    "created_at": "2014-10-22T23:32:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228470",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

How clever are compilers?

The question is related to idioms like `n % GMP_LIMB_BITS`.

`GMP_LIMB_BITS` is a power of two, and it is known at compile time. Hence, `n % GMP_LIMB_BITS` does not involve a generally very expensive `%`-operation, but boils down to a simple `&`.

Will compilers automatically use this optimization? If not, then I think we should introduce an integer constant `mod_mp_bits_per_limb` (see #15820), so that `n % GMP_LIMB_BITS == n & mp_bits_per_limb`. If yes, then I guess one can also avoid `n >> index_shift`, and use `n//GMP_LIMB_BITS` instead.



---

archive/issue_comments_228471.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nOne place or another (i.e., here or #15820), we will have to deal with the corner case of size zero. The reason: \"A common requirement for all functions is that each source area needs at least one limb. No size argument may be zero.\" See [GMP low level functions](https://gmplib.org/manual/Low_002dlevel-Functions.html). I suggest we deal with it *here*.",
    "created_at": "2014-10-22T23:38:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228471",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

One place or another (i.e., here or #15820), we will have to deal with the corner case of size zero. The reason: "A common requirement for all functions is that each source area needs at least one limb. No size argument may be zero." See [GMP low level functions](https://gmplib.org/manual/Low_002dlevel-Functions.html). I suggest we deal with it *here*.



---

archive/issue_comments_228472.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIt seems that compilers are clever. On my 32-bit laptop:\n\n```\nsage: cython(\"\"\"\n....: cpdef unsigned int f1(unsigned int size):\n....:     return (size -1)/(8*sizeof(unsigned int)) +1\n....: cpdef unsigned int f2(unsigned int size):\n....:     return ((size -1)>>5)+1\n\"\"\")\nsage: f1(89)\n3L\nsage: f2(89)\n3L\nsage: %timeit f1(89)\n1000000 loops, best of 3: 376 ns per loop\nsage: %timeit f2(89)\n1000000 loops, best of 3: 371 ns per loop\nsage: %timeit f1(89)\n1000000 loops, best of 3: 377 ns per loop\nsage: %timeit f2(89)\n1000000 loops, best of 3: 375 ns per loop\nsage: %timeit f1(189)\n1000000 loops, best of 3: 377 ns per loop\nsage: %timeit f2(189)\n1000000 loops, best of 3: 382 ns per loop\n```\n\n```\nsage: cython(\"\"\"\n....: cdef unsigned int bpl = 32\n....: cdef unsigned int modbpl = 31\n....: cpdef unsigned int f1(unsigned int size):\n....:     return size%bpl\n....: cpdef unsigned int f2(unsigned int size):\n....:     return size&modbpl\n....: \"\"\")\nsage: f1(89)\n25L\nsage: f2(89)\n25L\nsage: %timeit f1(89)\n1000000 loops, best of 3: 380 ns per loop\nsage: %timeit f2(89)\n1000000 loops, best of 3: 375 ns per loop\nsage: %timeit f1(189)\n1000000 loops, best of 3: 382 ns per loop\nsage: %timeit f2(189)\n1000000 loops, best of 3: 375 ns per loop\n```\nSo, not really a difference...",
    "created_at": "2014-10-23T06:53:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228472",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

It seems that compilers are clever. On my 32-bit laptop:

```
sage: cython("""
....: cpdef unsigned int f1(unsigned int size):
....:     return (size -1)/(8*sizeof(unsigned int)) +1
....: cpdef unsigned int f2(unsigned int size):
....:     return ((size -1)>>5)+1
""")
sage: f1(89)
3L
sage: f2(89)
3L
sage: %timeit f1(89)
1000000 loops, best of 3: 376 ns per loop
sage: %timeit f2(89)
1000000 loops, best of 3: 371 ns per loop
sage: %timeit f1(89)
1000000 loops, best of 3: 377 ns per loop
sage: %timeit f2(89)
1000000 loops, best of 3: 375 ns per loop
sage: %timeit f1(189)
1000000 loops, best of 3: 377 ns per loop
sage: %timeit f2(189)
1000000 loops, best of 3: 382 ns per loop
```

```
sage: cython("""
....: cdef unsigned int bpl = 32
....: cdef unsigned int modbpl = 31
....: cpdef unsigned int f1(unsigned int size):
....:     return size%bpl
....: cpdef unsigned int f2(unsigned int size):
....:     return size&modbpl
....: """)
sage: f1(89)
25L
sage: f2(89)
25L
sage: %timeit f1(89)
1000000 loops, best of 3: 380 ns per loop
sage: %timeit f2(89)
1000000 loops, best of 3: 375 ns per loop
sage: %timeit f1(189)
1000000 loops, best of 3: 382 ns per loop
sage: %timeit f2(189)
1000000 loops, best of 3: 375 ns per loop
```
So, not really a difference...



---

archive/issue_comments_228473.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@simon-king-jena](#comment%3A12):\n> I suggest we deal with it *here*.\n\nI would actually suggest the opposite. Keep assuming that bitsets have size > 0 and implement empty biseqs using bitsets of size 1. I think this will be the simplest.\n\nWhy do you think this is a bad idea?",
    "created_at": "2014-10-23T07:01:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228473",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@simon-king-jena](#comment%3A12):
> I suggest we deal with it *here*.

I would actually suggest the opposite. Keep assuming that bitsets have size > 0 and implement empty biseqs using bitsets of size 1. I think this will be the simplest.

Why do you think this is a bad idea?



---

archive/issue_comments_228474.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jdemeyer](#comment%3A14):\n> Replying to [@simon-king-jena](#comment%3A12):\n> > I suggest we deal with it *here*.\n\n> I would actually suggest the opposite. Keep assuming that bitsets have size > 0 and implement empty biseqs using bitsets of size 1. I think this will be the simplest.\n> \n> Why do you think this is a bad idea?\n\nSince I suppose people would think that the empty set should be available as a bitset.",
    "created_at": "2014-10-23T07:07:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228474",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jdemeyer](#comment%3A14):
> Replying to [@simon-king-jena](#comment%3A12):
> > I suggest we deal with it *here*.

> I would actually suggest the opposite. Keep assuming that bitsets have size > 0 and implement empty biseqs using bitsets of size 1. I think this will be the simplest.
> 
> Why do you think this is a bad idea?

Since I suppose people would think that the empty set should be available as a bitset.



---

archive/issue_comments_228475.json:
```json
{
    "body": "Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Simon King**",
    "created_at": "2014-10-23T07:13:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228475",
    "user": "https://github.com/simon-king-jena"
}
```

Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Simon King**



---

archive/issue_comments_228476.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nAnyway, if you think that there should be no empty bitset and if you agree that it should be moved to sage.data_structures.bitset, then it needs review, since all tests pass and the doc correctly appears in sage.data_structures.",
    "created_at": "2014-10-23T07:13:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228476",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

Anyway, if you think that there should be no empty bitset and if you agree that it should be moved to sage.data_structures.bitset, then it needs review, since all tests pass and the doc correctly appears in sage.data_structures.



---

archive/issue_events_243252.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2014-10-23T07:13:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243252"
}
```



---

archive/issue_comments_228477.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -9,3 +9,5 @@\n However, in fact many of these requirements can be relaxed.\n \n In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes ``r.size <= a.size + n`` which is useful for #15820.\n+\n+Also move bitsets to `src/sage/data_structures`.\n``````\n",
    "created_at": "2014-10-23T07:25:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228477",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -9,3 +9,5 @@
 However, in fact many of these requirements can be relaxed.
 
 In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes ``r.size <= a.size + n`` which is useful for #15820.
+
+Also move bitsets to `src/sage/data_structures`.
``````




---

archive/issue_comments_228478.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,8 +6,8 @@\n     segfault.\n ```\n \n-However, in fact many of these requirements can be relaxed.\n+However, in fact most of these requirements can be relaxed.\n \n-In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes ``r.size <= a.size + n`` which is useful for #15820.\n+In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes `r.size <= a.size + n` which is useful for #15820.\n \n Also move bitsets to `src/sage/data_structures`.\n``````\n",
    "created_at": "2014-10-23T07:25:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228478",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,8 +6,8 @@
     segfault.
 ```
 
-However, in fact many of these requirements can be relaxed.
+However, in fact most of these requirements can be relaxed.
 
-In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes ``r.size <= a.size + n`` which is useful for #15820.
+In many cases, I simply change the comment to indicate what the real conditions are. For shifts, I actually change the implementation slightly such that the condition becomes `r.size <= a.size + n` which is useful for #15820.
 
 Also move bitsets to `src/sage/data_structures`.
``````




---

archive/issue_comments_228479.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nAbout moving that to structure... If you want to move bitsets from misc to structure and so make this 'structure' folder mean \"data structure\", could you also move the other data structure files from misc there ? I looked at the list and it seems that only `binary_tree.*` and `binary_matrix.*` are there.\n\nNathann",
    "created_at": "2014-10-23T08:49:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228479",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:19" align="right">comment:19</div>

About moving that to structure... If you want to move bitsets from misc to structure and so make this 'structure' folder mean "data structure", could you also move the other data structure files from misc there ? I looked at the list and it seems that only `binary_tree.*` and `binary_matrix.*` are there.

Nathann



---

archive/issue_comments_228480.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@nathanncohen](#comment%3A19):\n> About moving that to structure... If you want to move bitsets from misc to structure and so make this 'structure' folder mean \"data structure\", could you also move the other data structure files from misc there ?\n\nIt's not `structure`, it's `data_structures`. And moving other things should be not on this ticket.",
    "created_at": "2014-10-23T08:53:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228480",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@nathanncohen](#comment%3A19):
> About moving that to structure... If you want to move bitsets from misc to structure and so make this 'structure' folder mean "data structure", could you also move the other data structure files from misc there ?

It's not `structure`, it's `data_structures`. And moving other things should be not on this ticket.



---

archive/issue_comments_228481.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOh.\n\nSo we will have two folders named `structure/`, `data_structure/`, and data structure code in both `data_structure/` and `misc/`.\n\nCool.\n\nNathan",
    "created_at": "2014-10-23T08:58:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228481",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:21" align="right">comment:21</div>

Oh.

So we will have two folders named `structure/`, `data_structure/`, and data structure code in both `data_structure/` and `misc/`.

Cool.

Nathan



---

archive/issue_comments_228482.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@nathanncohen](#comment%3A21):\n> data structure code in both `data_structure/` and `misc/`.\n\nand in `structure/` and in `matroids/` and in `combinat/` and probably other places...",
    "created_at": "2014-10-23T09:13:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228482",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@nathanncohen](#comment%3A21):
> data structure code in both `data_structure/` and `misc/`.

and in `structure/` and in `matroids/` and in `combinat/` and probably other places...



---

archive/issue_comments_228483.json:
```json
{
    "body": "Changed branch from **[public/17196/relax-assumptions-on-bitset-operations](https://github.com/sagemath/sagetrac-mirror/tree/public/17196/relax-assumptions-on-bitset-operations)** to **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)**",
    "created_at": "2014-10-23T09:22:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228483",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[public/17196/relax-assumptions-on-bitset-operations](https://github.com/sagemath/sagetrac-mirror/tree/public/17196/relax-assumptions-on-bitset-operations)** to **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)**



---

archive/issue_comments_228484.json:
```json
{
    "body": "Changed commit from **[`3ae75a1`](https://github.com/sagemath/sagetrac-mirror/commit/3ae75a1f8fcfee0f78faf9bb4bb006149b535c45)** to **[`23762a3`](https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d)**",
    "created_at": "2014-10-23T09:31:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228484",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[`3ae75a1`](https://github.com/sagemath/sagetrac-mirror/commit/3ae75a1f8fcfee0f78faf9bb4bb006149b535c45)** to **[`23762a3`](https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d)**



---

archive/issue_comments_228485.json:
```json
{
    "body": "<div id=\"comment:24\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d\"><code>23762a3</code></a></td><td><code>Import data_structures into global namespace</code></td></tr></table>\n",
    "created_at": "2014-10-23T09:31:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228485",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d"><code>23762a3</code></a></td><td><code>Import data_structures into global namespace</code></td></tr></table>




---

archive/issue_comments_228486.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@jdemeyer](#comment%3A22):\n> Replying to [@nathanncohen](#comment%3A21):\n> > data structure code in both `data_structure/` and `misc/`.\n\n> and in `structure/` and in `matroids/` and in `combinat/` and probably other places...\n\nNathann, if I understand correctly, the plan is to eventually move\n- all sage-specific data structures (e.g.,, those that only make sense within Sage's coercion framework) to `structure`, \n- all data structures that make sense without Sage and are not tied to a specific mathematical topic (bitsets, bitmatrices, bounded integer sequences, the dictionaries that are currently defined in `sage.structure.coerce_dict`) to `data_structures`\n\nand then `misc` should be reserved to miscellaneous *mathematical* topics (I think this is the definition according to the docs).",
    "created_at": "2014-10-23T09:57:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228486",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@jdemeyer](#comment%3A22):
> Replying to [@nathanncohen](#comment%3A21):
> > data structure code in both `data_structure/` and `misc/`.

> and in `structure/` and in `matroids/` and in `combinat/` and probably other places...

Nathann, if I understand correctly, the plan is to eventually move
- all sage-specific data structures (e.g.,, those that only make sense within Sage's coercion framework) to `structure`, 
- all data structures that make sense without Sage and are not tied to a specific mathematical topic (bitsets, bitmatrices, bounded integer sequences, the dictionaries that are currently defined in `sage.structure.coerce_dict`) to `data_structures`

and then `misc` should be reserved to miscellaneous *mathematical* topics (I think this is the definition according to the docs).



---

archive/issue_comments_228487.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@jdemeyer](#comment%3A22):\n> Replying to [@nathanncohen](#comment%3A21):\n> > data structure code in both `data_structure/` and `misc/`.\n\n> and in `structure/` and in `matroids/` and in `combinat/` and probably other places...\n\nPS: Of course there will be data structure code in many places, for example in `sage.matrices`. This is because such data structures are designed for a specific mathematical purpose (e.g., implementing matrix algebras).",
    "created_at": "2014-10-23T10:00:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228487",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@jdemeyer](#comment%3A22):
> Replying to [@nathanncohen](#comment%3A21):
> > data structure code in both `data_structure/` and `misc/`.

> and in `structure/` and in `matroids/` and in `combinat/` and probably other places...

PS: Of course there will be data structure code in many places, for example in `sage.matrices`. This is because such data structures are designed for a specific mathematical purpose (e.g., implementing matrix algebras).



---

archive/issue_comments_228488.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nYo !\n\n> Nathann, if I understand correctly, the plan is to eventually move\n> - all sage-specific data structures (e.g.,, those that only make sense within Sage's coercion framework) to `structure`, \n> - all data structures that make sense without Sage and are not tied to a specific mathematical topic (bitsets, bitmatrices, bounded integer sequences, the dictionaries that are currently defined in `sage.structure.coerce_dict`) to `data_structures`\n> \n> and then `misc` should be reserved to miscellaneous *mathematical* topics (I think this is the definition according to the docs).\n\nI understand. I merely mentionned that by only moving bitsets here the code would be in a weird state where only bitsets are in the new folder while others are still scattered.\n\nIt also feels weird to have a directory named \"structure\" and one named \"data structures\". Do you have any idea of how \"structure\" could be renamed ?\n\nNathann",
    "created_at": "2014-10-23T10:00:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228488",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:27" align="right">comment:27</div>

Yo !

> Nathann, if I understand correctly, the plan is to eventually move
> - all sage-specific data structures (e.g.,, those that only make sense within Sage's coercion framework) to `structure`, 
> - all data structures that make sense without Sage and are not tied to a specific mathematical topic (bitsets, bitmatrices, bounded integer sequences, the dictionaries that are currently defined in `sage.structure.coerce_dict`) to `data_structures`
> 
> and then `misc` should be reserved to miscellaneous *mathematical* topics (I think this is the definition according to the docs).

I understand. I merely mentionned that by only moving bitsets here the code would be in a weird state where only bitsets are in the new folder while others are still scattered.

It also feels weird to have a directory named "structure" and one named "data structures". Do you have any idea of how "structure" could be renamed ?

Nathann



---

archive/issue_comments_228489.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@nathanncohen](#comment%3A27):\n> It also feels weird to have a directory named \"structure\" and one named \"data structures\". Do you have any idea of how \"structure\" could be renamed ?\n\nI wouldn't rename `structure` because it will cause too much trouble. It contains very fundamental modules, with lots of code depending on it. Fixing the Sage library itself is not so hard, but the annoying part is all the tickets which currently sit on Trac and import stuff from `structure`.",
    "created_at": "2014-10-23T10:08:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228489",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@nathanncohen](#comment%3A27):
> It also feels weird to have a directory named "structure" and one named "data structures". Do you have any idea of how "structure" could be renamed ?

I wouldn't rename `structure` because it will cause too much trouble. It contains very fundamental modules, with lots of code depending on it. Fixing the Sage library itself is not so hard, but the annoying part is all the tickets which currently sit on Trac and import stuff from `structure`.



---

archive/issue_comments_228490.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@simon-king-jena](#comment%3A11):\n> How clever are compilers?\n> \n> The question is related to idioms like `n % GMP_LIMB_BITS`.\n> \n> `GMP_LIMB_BITS` is a power of two, and it is known at compile time. Hence, `n % GMP_LIMB_BITS` does not involve a generally very expensive `%`-operation, but boils down to a simple `&`.\n> \n> Will compilers automatically use this optimization?\n\nYes, they should. It's an obvious easy optimization.",
    "created_at": "2014-10-23T10:33:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228490",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@simon-king-jena](#comment%3A11):
> How clever are compilers?
> 
> The question is related to idioms like `n % GMP_LIMB_BITS`.
> 
> `GMP_LIMB_BITS` is a power of two, and it is known at compile time. Hence, `n % GMP_LIMB_BITS` does not involve a generally very expensive `%`-operation, but boils down to a simple `&`.
> 
> Will compilers automatically use this optimization?

Yes, they should. It's an obvious easy optimization.



---

archive/issue_comments_228491.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\n> > It also feels weird to have a directory named \"structure\" and one named \"data structures\". Do you have any idea of how \"structure\" could be renamed ?\n\n> I wouldn't rename `structure` because it will cause too much trouble. It contains very fundamental modules, with lots of code depending on it. Fixing the Sage library itself is not so hard, but the annoying part is all the tickets which currently sit on Trac and import stuff from `structure`.\n\nCome on, since when do we have to be compatible with the patches in `needs_review`/`needs_work` ?\n\nNathann",
    "created_at": "2014-10-23T11:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228491",
    "user": "https://github.com/nathanncohen"
}
```

<div id="comment:30" align="right">comment:30</div>

> > It also feels weird to have a directory named "structure" and one named "data structures". Do you have any idea of how "structure" could be renamed ?

> I wouldn't rename `structure` because it will cause too much trouble. It contains very fundamental modules, with lots of code depending on it. Fixing the Sage library itself is not so hard, but the annoying part is all the tickets which currently sit on Trac and import stuff from `structure`.

Come on, since when do we have to be compatible with the patches in `needs_review`/`needs_work` ?

Nathann



---

archive/issue_comments_228492.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nFor the record: I like the changes introduced by Jeroen, and it seems to work well in #15820. Hence, I give a positive review to the part of the code that I didn't author.",
    "created_at": "2014-10-24T10:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228492",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:31" align="right">comment:31</div>

For the record: I like the changes introduced by Jeroen, and it seems to work well in #15820. Hence, I give a positive review to the part of the code that I didn't author.



---

archive/issue_comments_228493.json:
```json
{
    "body": "Reviewer: **Simon King**",
    "created_at": "2014-10-24T10:22:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228493",
    "user": "https://github.com/simon-king-jena"
}
```

Reviewer: **Simon King**



---

archive/issue_events_243253.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-10-27T07:59:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243253"
}
```



---

archive/issue_events_243254.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2014-10-27T07:59:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243254"
}
```



---

archive/issue_comments_228494.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)** to **[`23762a3`](https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d)**",
    "created_at": "2014-10-27T16:02:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/17196#issuecomment-228494",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/ticket/17196](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/17196)** to **[`23762a3`](https://github.com/sagemath/sagetrac-mirror/commit/23762a31e383d765cbfe6d5bf958d5d592e1513d)**



---

archive/issue_events_243255.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-27T16:02:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243255"
}
```



---

archive/issue_events_243256.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "edbd26339275e509a704156c84b3a1286d23096d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2014-10-27T16:02:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/17196",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/17196#event-243256"
}
```
