# Issue 17182: Make sure that IPython 3.0 will warn about exceptions in formatting

archive/issues_017182.json:
```json
{
    "body": "CC:  @vbraun\n\nWith IPython 3.0.0-dev, there is a doctest failure\n\n```\nsage -t --long src/sage/plot/graphics.py                                                                                                                                \n**********************************************************************                                                                                                  \nFile \"src/sage/plot/graphics.py\", line 2412, in sage.plot.graphics.Graphics.?                                                                                           \nFailed example:                                                                                                                                                         \n    plot(x, typeset='garbage')\nExpected:\n    doctest:...: FormatterWarning: Exception in text/plain formatter: \n    typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n    None\nGot:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/IPython/core/formatters.py\", line 232, in warn_format_error\n        r = method(self, *args, **kwargs)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/repl/display/formatter.py\", line 281, in __call__\n        obj._graphics_()      # ignore whether there actually is graphics\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 872, in _graphics_\n        figsize=figsize, dpi=dpi)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/structure/graphics_file.py\", line 268, in graphics_from_save\n        save_function(filename, **kwds)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/decorators.py\", line 471, in wrapper\n        return func(*args, **kwds)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 3048, in save\n        figure = self.matplotlib(**options)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/plot/graphics.py\", line 2453, in matplotlib\n        \" or 'type1'; got '{}'.\".format(typeset))\n    ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n    None\n**********************************************************************\n```\n\n**Upstream bug**: [https://github.com/ipython/ipython/issues/7072](https://github.com/ipython/ipython/issues/7072)\n\nIssue created by migration from https://trac.sagemath.org/ticket/17419\n\n",
    "closed_at": "2015-03-13T09:02:49Z",
    "created_at": "2014-11-30T13:42:56Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Make sure that IPython 3.0 will warn about exceptions in formatting",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17182",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @vbraun

With IPython 3.0.0-dev, there is a doctest failure

```
sage -t --long src/sage/plot/graphics.py                                                                                                                                
**********************************************************************                                                                                                  
File "src/sage/plot/graphics.py", line 2412, in sage.plot.graphics.Graphics.?                                                                                           
Failed example:                                                                                                                                                         
    plot(x, typeset='garbage')
Expected:
    doctest:...: FormatterWarning: Exception in text/plain formatter: 
    typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
    None
Got:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/IPython/core/formatters.py", line 232, in warn_format_error
        r = method(self, *args, **kwargs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/repl/display/formatter.py", line 281, in __call__
        obj._graphics_()      # ignore whether there actually is graphics
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 872, in _graphics_
        figsize=figsize, dpi=dpi)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/structure/graphics_file.py", line 268, in graphics_from_save
        save_function(filename, **kwds)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 471, in wrapper
        return func(*args, **kwds)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3048, in save
        figure = self.matplotlib(**options)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 2453, in matplotlib
        " or 'type1'; got '{}'.".format(typeset))
    ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
    None
**********************************************************************
```

**Upstream bug**: [https://github.com/ipython/ipython/issues/7072](https://github.com/ipython/ipython/issues/7072)

Issue created by migration from https://trac.sagemath.org/ticket/17419





---

archive/issue_comments_228098.json:
```json
{
    "body": "No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. \n\nReally, the issue is that plots are terrible at validation. It is way too easy to construct plots that then fail later, potentially after combining them with other plots.",
    "created_at": "2014-11-30T14:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228098",
    "user": "https://github.com/vbraun"
}
```

No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. 

Really, the issue is that plots are terrible at validation. It is way too easy to construct plots that then fail later, potentially after combining them with other plots.



---

archive/issue_comments_228099.json:
```json
{
    "body": "PS: in 6.5.beta1 I get\n\n```\nsage: plot(x, typeset='garbage')\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n```\nI propose to close as fixed.",
    "created_at": "2014-11-30T14:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228099",
    "user": "https://github.com/vbraun"
}
```

PS: in 6.5.beta1 I get

```
sage: plot(x, typeset='garbage')
/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
```
I propose to close as fixed.



---

archive/issue_comments_228100.json:
```json
{
    "body": "I now get (sage-6.5.beta1):\n\n```\nsage: plot(x, typeset='garbage')\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n  FormatterWarning,\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n<ipython-input-1-37a028c62b8b> in <module>()\n----> 1 plot(x, typeset='garbage')\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)\n    251             self.write_output_prompt()\n    252             format_dict, md_dict = self.compute_format_data(result)\n--> 253             self.write_format_data(format_dict, md_dict)\n    254             self.update_user_ns(result)\n    255             self.log_output(format_dict)\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in write_format_data(self, format_dict, md_dict)\n    172         # newline, even if all the prompt separators are ''. This is the\n    173         # standard IPython behavior.\n--> 174         result_repr = format_dict['text/plain']\n    175         if '\\n' in result_repr:\n    176             # So that multi-line strings line up with the left column of\n\nKeyError: 'text/plain'\n```",
    "created_at": "2014-11-30T14:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228100",
    "user": "https://github.com/jdemeyer"
}
```

I now get (sage-6.5.beta1):

```
sage: plot(x, typeset='garbage')
/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
  FormatterWarning,
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-1-37a028c62b8b> in <module>()
----> 1 plot(x, typeset='garbage')

/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    251             self.write_output_prompt()
    252             format_dict, md_dict = self.compute_format_data(result)
--> 253             self.write_format_data(format_dict, md_dict)
    254             self.update_user_ns(result)
    255             self.log_output(format_dict)

/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in write_format_data(self, format_dict, md_dict)
    172         # newline, even if all the prompt separators are ''. This is the
    173         # standard IPython behavior.
--> 174         result_repr = format_dict['text/plain']
    175         if '\n' in result_repr:
    176             # So that multi-line strings line up with the left column of

KeyError: 'text/plain'
```



---

archive/issue_comments_228101.json:
```json
{
    "body": "Yes, the traceback is as expected, too. There is no 'text/plain' output because that raised an exception.",
    "created_at": "2014-11-30T14:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228101",
    "user": "https://github.com/vbraun"
}
```

Yes, the traceback is as expected, too. There is no 'text/plain' output because that raised an exception.



---

archive/issue_comments_228102.json:
```json
{
    "body": "Sorry for the confusion, I was testing the IPython master.\n\nThen the `ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'` traceback in shown in any case (both the command line and the doctest). So it seems that ``@`warn_format_error` stopped working...",
    "created_at": "2014-11-30T14:26:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228102",
    "user": "https://github.com/jdemeyer"
}
```

Sorry for the confusion, I was testing the IPython master.

Then the `ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'` traceback in shown in any case (both the command line and the doctest). So it seems that ``@`warn_format_error` stopped working...



---

archive/issue_comments_228103.json:
```json
{
    "body": "Replying to [comment:1 vbraun]:\n> No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. \n\nIt's not `__repr__()` which fails here, it's `_graphics_()` which fails. An important distinction.",
    "created_at": "2014-11-30T14:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228103",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:1 vbraun]:
> No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. 

It's not `__repr__()` which fails here, it's `_graphics_()` which fails. An important distinction.



---

archive/issue_comments_228104.json:
```json
{
    "body": "Since `_graphics_()` is sort of the main point of `Graphics` objects, I doubt that we should downgrade exceptions to warnings. So my proposal would be the opposite of yours: always treat `_graphics_()` exceptions as true exceptions.",
    "created_at": "2014-11-30T14:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228104",
    "user": "https://github.com/jdemeyer"
}
```

Since `_graphics_()` is sort of the main point of `Graphics` objects, I doubt that we should downgrade exceptions to warnings. So my proposal would be the opposite of yours: always treat `_graphics_()` exceptions as true exceptions.



---

archive/issue_comments_228105.json:
```json
{
    "body": "No, it works as expected. Well, IPython could show a nicer diagnostic in case `text/plain` fails, but really you shouldn't build a UI around objects that fall flat on their face when you print them. \n\nRight now we only use `_graphics_` in IPython's plain text formatter. This is part of the stupid design for how graphics shows itself as a side effect of calling `__repr__`. Should be fixed by #17234 when its ready.",
    "created_at": "2014-11-30T14:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228105",
    "user": "https://github.com/vbraun"
}
```

No, it works as expected. Well, IPython could show a nicer diagnostic in case `text/plain` fails, but really you shouldn't build a UI around objects that fall flat on their face when you print them. 

Right now we only use `_graphics_` in IPython's plain text formatter. This is part of the stupid design for how graphics shows itself as a side effect of calling `__repr__`. Should be fixed by #17234 when its ready.



---

archive/issue_comments_228106.json:
```json
{
    "body": "When you're redesigning the IPython interface, could you try to make it compatible with IPython master?",
    "created_at": "2014-12-01T09:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228106",
    "user": "https://github.com/jdemeyer"
}
```

When you're redesigning the IPython interface, could you try to make it compatible with IPython master?



---

archive/issue_comments_228107.json:
```json
{
    "body": "Is there a ticket for the IPython 3.0 upgrade, or even an upstream release?\n\nIMHO it is a bug if upstream master doesn't catch the exception.",
    "created_at": "2014-12-01T09:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228107",
    "user": "https://github.com/vbraun"
}
```

Is there a ticket for the IPython 3.0 upgrade, or even an upstream release?

IMHO it is a bug if upstream master doesn't catch the exception.



---

archive/issue_comments_228108.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> Is there a ticket for the IPython 3.0 upgrade\n\nNot yet, but if you want I can easily create one...\n\nIn any case, there is no IPython 3 release yet, but that doesn't mean we shouldn't anticipate it.\n\n> IMHO it is a bug if upstream master doesn't catch the exception.\n\nIt catches the exception and prints a traceback. Which to the user is indistinguishable from not catching the exception.",
    "created_at": "2014-12-01T09:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228108",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> Is there a ticket for the IPython 3.0 upgrade

Not yet, but if you want I can easily create one...

In any case, there is no IPython 3 release yet, but that doesn't mean we shouldn't anticipate it.

> IMHO it is a bug if upstream master doesn't catch the exception.

It catches the exception and prints a traceback. Which to the user is indistinguishable from not catching the exception.



---

archive/issue_comments_228109.json:
```json
{
    "body": "Feel free to submit an upstream bug about the changed behaviour of `warn_format_error`.",
    "created_at": "2014-12-01T09:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228109",
    "user": "https://github.com/jdemeyer"
}
```

Feel free to submit an upstream bug about the changed behaviour of `warn_format_error`.



---

archive/issue_comments_228110.json:
```json
{
    "body": "[IPython 3 has been released](http://ipython.org/ipython-doc/3/whatsnew/version3.html#release-3-0).\n\nA while ago, upstream renamed the `warn_format_error` decorator to `catch_format_error` in [f3d60](https://github.com/ipython/ipython/commit/f3d604d86088fcd6aa7b09a691edc0fde26e5573) in response to [the upstream bug report](https://github.com/ipython/ipython/issues/7072) which has been declared closed in the process. [04bb1](https://github.com/ipython/ipython/commit/04bb1e712ab39a61adecad1153e8afee79402c66) which changed the behavior to show a backtrace instead of a warning has not been reverted.\n\nThe name change means that at the moment we get an import error for [formatter.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/repl/display/formatter.py?h=develop&id=2d915f086b25c7c72cf1fc9d0dd441015abd9fad#n64) when running with IPython 3, as I do on Gentoo.",
    "created_at": "2015-03-11T21:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228110",
    "user": "https://github.com/gagern"
}
```

[IPython 3 has been released](http://ipython.org/ipython-doc/3/whatsnew/version3.html#release-3-0).

A while ago, upstream renamed the `warn_format_error` decorator to `catch_format_error` in [f3d60](https://github.com/ipython/ipython/commit/f3d604d86088fcd6aa7b09a691edc0fde26e5573) in response to [the upstream bug report](https://github.com/ipython/ipython/issues/7072) which has been declared closed in the process. [04bb1](https://github.com/ipython/ipython/commit/04bb1e712ab39a61adecad1153e8afee79402c66) which changed the behavior to show a backtrace instead of a warning has not been reverted.

The name change means that at the moment we get an import error for [formatter.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/repl/display/formatter.py?h=develop&id=2d915f086b25c7c72cf1fc9d0dd441015abd9fad#n64) when running with IPython 3, as I do on Gentoo.



---

archive/issue_comments_228111.json:
```json
{
    "body": "Fixed in #17826",
    "created_at": "2015-03-11T22:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228111",
    "user": "https://github.com/vbraun"
}
```

Fixed in #17826



---

archive/issue_comments_228112.json:
```json
{
    "body": "propose to close as duplicate/fixed",
    "created_at": "2015-03-11T22:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228112",
    "user": "https://github.com/vbraun"
}
```

propose to close as duplicate/fixed



---

archive/issue_events_050153.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-03-11T22:26:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17182#event-50153"
}
```



---

archive/issue_comments_228113.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-11T22:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228113",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_228114.json:
```json
{
    "body": "PS: Actual output after #17826\n\n```\nsage: plot(x, typeset='garbage')\n.../display_manager.py:541: RichReprWarning: Exception in _rich_repr_ while displaying object: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n  RichReprWarning,\nGraphics object consisting of 1 graphics primitive\n```",
    "created_at": "2015-03-11T22:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228114",
    "user": "https://github.com/vbraun"
}
```

PS: Actual output after #17826

```
sage: plot(x, typeset='garbage')
.../display_manager.py:541: RichReprWarning: Exception in _rich_repr_ while displaying object: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
  RichReprWarning,
Graphics object consisting of 1 graphics primitive
```



---

archive/issue_comments_228115.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-13T08:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228115",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_050154.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-03-13T09:02:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17182#event-50154"
}
```



---

archive/issue_comments_228116.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-03-13T09:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228116",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
