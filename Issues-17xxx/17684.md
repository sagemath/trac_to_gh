# Issue 17684: density_plot() is broken with functions involving symbolic expressions

archive/issues_017447.json:
```json
{
    "body": "As reported on [this ask question](http://ask.sagemath.org/question/25617/density_plot-defed-python-function-typeerror/), the following does not work:\n\n```\nsage: f1(a, b) = 1 - b / a\nsage: f2(a, b) = 1 - a / b\nsage: def f12(a, b):\n....:         if a - b < 0:\n....:                 return f1(a, b)\n....:         else:\n....:                 return f2(a, b)\nsage: density_plot(f,(1,2),(1,2))\nKeyError: 'text/plain'\n```\n\nWhile the following works:\n\n```\nsage: f1(a, b) = 1 - b / a\nsage: f2(a, b) = 1 - a / b\nsage: def f12(a, b):\n....:     if a - b < 0:\n....:         return RDF(f1(a, b))\n....:     else:\n....:         return RDF(f2(a, b))\nsage: density_plot(f12,(1,2),(1,2))\n```\n\n\nCC:  @kcrisman\n\nReviewer: Karl-Dieter Crisman\n\nAuthor: Dave Morris\n\nBranch: bb5a812902cd1d29ddb17989116d054222c144bb\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/17684\n\n",
    "closed_at": "2021-03-01T00:21:04Z",
    "created_at": "2015-01-28T12:06:43Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "density_plot() is broken with functions involving symbolic expressions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17684",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
As reported on [this ask question](http://ask.sagemath.org/question/25617/density_plot-defed-python-function-typeerror/), the following does not work:

```
sage: f1(a, b) = 1 - b / a
sage: f2(a, b) = 1 - a / b
sage: def f12(a, b):
....:         if a - b < 0:
....:                 return f1(a, b)
....:         else:
....:                 return f2(a, b)
sage: density_plot(f,(1,2),(1,2))
KeyError: 'text/plain'
```

While the following works:

```
sage: f1(a, b) = 1 - b / a
sage: f2(a, b) = 1 - a / b
sage: def f12(a, b):
....:     if a - b < 0:
....:         return RDF(f1(a, b))
....:     else:
....:         return RDF(f2(a, b))
sage: density_plot(f12,(1,2),(1,2))
```


CC:  @kcrisman

Reviewer: Karl-Dieter Crisman

Author: Dave Morris

Branch: bb5a812902cd1d29ddb17989116d054222c144bb

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/17684





---

archive/issue_comments_302618.json:
```json
{
    "body": "Changing branch from \"\" to \"public/17684\"",
    "created_at": "2021-02-09T08:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302618",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "" to "public/17684"



---

archive/issue_comments_302619.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2021-02-09T08:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302619",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_302620.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-09T08:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302620",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_302621.json:
```json
{
    "body": "Changing commit from \"\" to \"bb5a812902cd1d29ddb17989116d054222c144bb\"",
    "created_at": "2021-02-09T08:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302621",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "" to "bb5a812902cd1d29ddb17989116d054222c144bb"



---

archive/issue_events_050624.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-02-09T08:45:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17684#event-50624"
}
```



---

archive/issue_comments_302622.json:
```json
{
    "body": "Changing author from \"\" to \"Dave Morris\"",
    "created_at": "2021-02-09T08:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302622",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing author from "" to "Dave Morris"



---

archive/issue_comments_302623.json:
```json
{
    "body": "<a id='comment:3'></a>Nice.  Unfortunately I can't upgrade my Sage currently to actually check this (quite old computer with fragile installation, based on past experience, and I can't afford to bork it), but patchbot says okay ... would you be willing to post some of the plots from the documentation (Including the tests for bug fixes, including your new one) here to verify?  Then I'd be happy to provide positive review, the code should certainly be okay.\n\n---\n\nThat said, the real bug here is in `fast_float`, because it should still be taking this function in `setup_for_eval_on_grid` and doing the \"right\" thing with it.  See [this admittedly bizarre Sage cell interact](https://sagecell.sagemath.org/?z=eJyFUNuKwyAQfRf8h3k0YLON0JfQwv5HCGJSFSHRMNr9_h3bprAX6HkQ5Vxmjtl424PrhJEwNXCBDg4wwQcYzvKDUz84Q9y0c1fryPsU9Jy1hB52BEfqmnaG4x9yB9pyw_ja4LfMLtm-9ard-9wY0wr12m5LKu0a8gxh3RIWyOTYtEuo7ZdZdIraY7hyxtlniMWimQtntZUW7hbny0DtpOukU2PtV4d6CWiit5k-5P84MVTvKGEQnVSNvJ_0VKfmEbEhDRN-OI7NN3AcY8Q=&lang=sage&interacts=eJyLjgUAARUAuQ==).  Maybe we should open/search for a ticket about this error - I'm sure it comes up elsewhere, there are definitely open tickets with `fast_float` or `fast_callable` and I know some have suggested completely rewriting that code.",
    "created_at": "2021-02-09T13:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302623",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:3'></a>Nice.  Unfortunately I can't upgrade my Sage currently to actually check this (quite old computer with fragile installation, based on past experience, and I can't afford to bork it), but patchbot says okay ... would you be willing to post some of the plots from the documentation (Including the tests for bug fixes, including your new one) here to verify?  Then I'd be happy to provide positive review, the code should certainly be okay.

---

That said, the real bug here is in `fast_float`, because it should still be taking this function in `setup_for_eval_on_grid` and doing the "right" thing with it.  See [this admittedly bizarre Sage cell interact](https://sagecell.sagemath.org/?z=eJyFUNuKwyAQfRf8h3k0YLON0JfQwv5HCGJSFSHRMNr9_h3bprAX6HkQ5Vxmjtl424PrhJEwNXCBDg4wwQcYzvKDUz84Q9y0c1fryPsU9Jy1hB52BEfqmnaG4x9yB9pyw_ja4LfMLtm-9ard-9wY0wr12m5LKu0a8gxh3RIWyOTYtEuo7ZdZdIraY7hyxtlniMWimQtntZUW7hbny0DtpOukU2PtV4d6CWiit5k-5P84MVTvKGEQnVSNvJ_0VKfmEbEhDRN-OI7NN3AcY8Q=&lang=sage&interacts=eJyLjgUAARUAuQ==).  Maybe we should open/search for a ticket about this error - I'm sure it comes up elsewhere, there are definitely open tickets with `fast_float` or `fast_callable` and I know some have suggested completely rewriting that code.



---

archive/issue_comments_302624.json:
```json
{
    "body": "<a id='comment:4'></a>(And of course if providing all that is too much to ask, that's fine too; I'm sure someone else will be able to review this, it's an obvious hotfix.)",
    "created_at": "2021-02-09T13:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302624",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:4'></a>(And of course if providing all that is too much to ask, that's fine too; I'm sure someone else will be able to review this, it's an obvious hotfix.)



---

archive/issue_comments_302625.json:
```json
{
    "body": "Attachment [density_plots.pdf](tarball://root/attachments/some-uuid/ticket17684/density_plots.pdf) by @DaveWitteMorris created at 2021-02-14 00:53:49\n\ndensity plot doctests",
    "created_at": "2021-02-14T00:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302625",
    "user": "https://github.com/DaveWitteMorris"
}
```

Attachment [density_plots.pdf](tarball://root/attachments/some-uuid/ticket17684/density_plots.pdf) by @DaveWitteMorris created at 2021-02-14 00:53:49

density plot doctests



---

archive/issue_comments_302626.json:
```json
{
    "body": "<a id='comment:5'></a>I think the attachment ([density_plots.pdf](https://trac.sagemath.org/attachment/ticket/17684/density_plots.pdf)) has all of the plots that are in the doctests of this file. (Let me know if I missed any that you were wondering about.) However, I jpeg-compressed the file, so there are some artifacts, especially where the plot has white at an edge.\n\nI did not find the issue of this ticket listed anywhere.  (Related: ticket #5572 seems to suggest replacing `fast_float` with `fast_callable`.)  I agree that the real problem is in `fast_float`, so probably a ticket should be opened (or a comment added to #5572).  I think that fix will take more care, because `RDF` works on this ticket, but I suspect that `fast_float` will need to consider the precision of its inputs before choosing the field of floating-point numbers to use.",
    "created_at": "2021-02-14T01:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302626",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:5'></a>I think the attachment ([density_plots.pdf](https://trac.sagemath.org/attachment/ticket/17684/density_plots.pdf)) has all of the plots that are in the doctests of this file. (Let me know if I missed any that you were wondering about.) However, I jpeg-compressed the file, so there are some artifacts, especially where the plot has white at an edge.

I did not find the issue of this ticket listed anywhere.  (Related: ticket #5572 seems to suggest replacing `fast_float` with `fast_callable`.)  I agree that the real problem is in `fast_float`, so probably a ticket should be opened (or a comment added to #5572).  I think that fix will take more care, because `RDF` works on this ticket, but I suspect that `fast_float` will need to consider the precision of its inputs before choosing the field of floating-point numbers to use.



---

archive/issue_comments_302627.json:
```json
{
    "body": "<a id='comment:6'></a>Nice, thank you very much!\n\nYes, go ahead and make a comment there at least - that is one of the tickets I was thinking of.",
    "created_at": "2021-02-14T03:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302627",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:6'></a>Nice, thank you very much!

Yes, go ahead and make a comment there at least - that is one of the tickets I was thinking of.



---

archive/issue_comments_302628.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Karl-Dieter Crisman\"",
    "created_at": "2021-02-14T03:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302628",
    "user": "https://github.com/kcrisman"
}
```

Changing reviewer from "" to "Karl-Dieter Crisman"



---

archive/issue_comments_302629.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-14T03:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302629",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302630.json:
```json
{
    "body": "<a id='comment:7'></a>Thanks for the reviews. I added a comment to the description of #5572.",
    "created_at": "2021-02-16T05:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302630",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:7'></a>Thanks for the reviews. I added a comment to the description of #5572.



---

archive/issue_events_050625.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-01T00:21:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17684#event-50625"
}
```



---

archive/issue_comments_302631.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-01T00:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302631",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_302632.json:
```json
{
    "body": "Changing branch from \"public/17684\" to \"bb5a812902cd1d29ddb17989116d054222c144bb\"",
    "created_at": "2021-03-01T00:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302632",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/17684" to "bb5a812902cd1d29ddb17989116d054222c144bb"



---

archive/issue_comments_302633.json:
```json
{
    "body": "<a id='comment:9'></a>Thanks for fixing this. Is the problem reported\nin [Ask Sage question 55824](https://ask.sagemath.org/question/55824) related?",
    "created_at": "2021-03-01T15:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302633",
    "user": "https://github.com/slel"
}
```

<a id='comment:9'></a>Thanks for fixing this. Is the problem reported
in [Ask Sage question 55824](https://ask.sagemath.org/question/55824) related?



---

archive/issue_comments_302634.json:
```json
{
    "body": "Changing commit from \"bb5a812902cd1d29ddb17989116d054222c144bb\" to \"\"",
    "created_at": "2021-03-01T15:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302634",
    "user": "https://github.com/slel"
}
```

Changing commit from "bb5a812902cd1d29ddb17989116d054222c144bb" to ""



---

archive/issue_comments_302635.json:
```json
{
    "body": "<a id='comment:10'></a>It may be a similar issue, but I don't understand what is going on there. I opened #31488.",
    "created_at": "2021-03-11T21:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17684#issuecomment-302635",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:10'></a>It may be a similar issue, but I don't understand what is going on there. I opened #31488.
