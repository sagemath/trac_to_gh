# Issue 26712: Make sage autodoc extension work for both python2 and python3

Issue created by migration from https://trac.sagemath.org/ticket/26949

Original creator: klee

Original creation time: 2018-12-24 00:43:23




---

Comment by klee created at 2018-12-24 01:13:46

New commits:


---

Comment by klee created at 2018-12-24 01:22:16

Changing component from documentation to python3.


---

Comment by klee created at 2018-12-24 01:26:39

Changing status from new to needs_review.


---

Comment by strogdon created at 2018-12-24 17:55:00

I had always thought the issue was with `sage_autodoc.py` but I didn't have the python 3 background to attempt a change. I'll give it a try.


---

Comment by jhpalmieri created at 2018-12-24 20:46:39

This is good progress. Methods in the Python 3 documentation look like `method(self):`, while in the Python 2 version, they look like `method()`. I don't object to that, but do we know why this change has happened? More significantly, in the Python 3 version, it seems that if a method has a decorator like ``@`cached_method` or ``@`abstract_method`, then the signature is gone completely and it just says `method`.


---

Comment by strogdon created at 2018-12-24 21:13:08

Also under [Sets](http://doc.sagemath.org/html/en/reference/categories/sage/categories/sets_cat.html) 
**an_element()** with Python 2 appears as **an_element** with Python 3. This may be due to confusing `py:method` (Python 2) with `py:attribute` (Python 3).


---

Comment by jhpalmieri created at 2018-12-24 22:30:34

Replying to [comment:10 strogdon]:
> Also under [Sets](http://doc.sagemath.org/html/en/reference/categories/sage/categories/sets_cat.html) 
> **an_element()** with Python 2 appears as **an_element** with Python 3. This may be due to confusing `py:method` (Python 2) with `py:attribute` (Python 3).

I was guessing that this was because `an_element` is marked as ``@`cached_method`.


---

Comment by klee created at 2018-12-24 23:44:34

Replying to [comment:9 jhpalmieri]:
> This is good progress. Methods in the Python 3 documentation look like `method(self):`, while in the Python 2 version, they look like `method()`. I don't object to that, but do we know why this change has happened? More significantly, in the Python 3 version, it seems that if a method has a decorator like ``@`cached_method` or ``@`abstract_method`, then the signature is gone completely and it just says `method`.

I expected these subtle differences. I cannot explain the cause of the differences, but know where to look. You can start with 

`vimdiff src/sage_setup/docbuild/ext/sage_autodoc3.py local/lib/python2.7/site-packages/sphinx/ext/autodoc/__init__.py` 

and perhaps also with comparing `sage_autodoc3` with the original `sage_autodoc`. 

I would welcome commits to fix these unpleasant changes, after switching to a public branch. 

To understand how an attribute (in the general sense, of a module or of a class) is rendered by Sphinx, note that a  suitable `Documenter` is selected for each attribute in the last lines of the following (in `sage_autodoc`): 

```
    def document_members(self, all_members=False):
        """Generate reST for member documentation.

        If *all_members* is True, do all members, else those given by
        *self.options.members*.
        """
        # set current namespace for finding members
        self.env.temp_data['autodoc:module'] = self.modname
        if self.objpath:
            self.env.temp_data['autodoc:class'] = self.objpath[0]

        want_all = all_members or self.options.inherited_members or \
            self.options.members is ALL
        # find out which members are documentable
        members_check_module, members = self.get_object_members(want_all)

        # remove members given by exclude-members
        if self.options.exclude_members:
            members = [(membername, member) for (membername, member) in members
                       if membername not in self.options.exclude_members]

        # document non-skipped members
        memberdocumenters = []
        for (mname, member, isattr) in self.filter_members(members, want_all): <------------------------
            classes = [cls for cls in itervalues(self.documenters)
                       if cls.can_document_member(member, mname, isattr, self)]  <----------------------
            if not classes:
                # don't know how to document this member
                continue
            # prefer the documenter with the highest priority
            classes.sort(key=lambda cls: cls.priority)                 <----------------------
            # give explicitly separated module name, so that members
            # of inner classes can be documented
            full_mname = self.modname + '::' + \
                '.'.join(self.objpath + [mname])
            documenter = classes[-1](self.directive, full_mname, self.indent)               <---------- look here

            memberdocumenters.append((documenter, isattr))

        ...
```



---

Comment by jdemeyer created at 2018-12-25 11:53:24

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-12-25 11:53:24

While making things compatible with Python 3 is a good goal, having two completely independent implementations of it is a horrible solution. Then we would have two autodoc extensions to maintain instead of one.


---

Comment by jdemeyer created at 2018-12-25 11:55:53

Also, I would personally prefer to wait with this until after #26451. But it's partially my fault for dragging that, so consider this just a suggestion.


---

Comment by git created at 2018-12-26 01:37:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2018-12-26 01:42:20

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-12-26 02:19:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by strogdon created at 2018-12-26 04:31:06

A cursory look at a python 3 build of the docs looks OK. Now for python 2.


---

Comment by jdemeyer created at 2018-12-26 12:33:42

Replying to [ticket:26949 klee]:
> trimmed a lot to be in sync well with Sphinx' orthodox `autodoc`.

Can you justify this? In particular, which "orthodox `autodoc`" are you talking about? Given that Sage is not using the latest Sphinx (see #26451 for that), this is a relevant question.


---

Comment by klee created at 2018-12-26 12:57:52

Replying to [comment:19 jdemeyer]:
> Replying to [ticket:26949 klee]:
> > trimmed a lot to be in sync well with Sphinx' orthodox `autodoc`.
> 
> Can you justify this? In particular, which "orthodox `autodoc`" are you talking about? Given that Sage is not using the latest Sphinx (see #26451 for that), this is a relevant question.

I just meant the one currently shipped with Sage. So not the latest. 

You know what I mean by "sync well" if you "vimdiff" old `sage_autodoc` and then the new `sage_autodoc`,  against Sphinx' `ext/autodoc/__init__py`.


---

Comment by git created at 2018-12-26 13:41:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-12-26 13:47:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-12-26 14:04:36

Please rebase to 8.5 and squash commits to just one commit.


---

Comment by git created at 2018-12-26 14:32:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-12-26 14:34:50

`sage.combinat.diagram_algebras.AbstractPartitionDiagrams.Element` is now documented as "alias of `InheritComparisonClasscallMetaclass`" which is not very informative.

This used to be "alias of `AbstractPartitionDiagram`".


---

Comment by jdemeyer created at 2018-12-26 14:34:50

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-12-26 14:36:43

Replying to [comment:20 klee]:
> I just meant the one currently shipped with Sage. So not the latest. 

The most reasonable comparison is probably with Sphinx 1.7.9, the lastest bugfix of the version currently in Sage.


---

Comment by git created at 2018-12-27 06:57:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2018-12-27 10:17:05

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-12-27 20:00:38

Thanks! I'll have a deeper look at what's going wrong with `__qualname__`.


---

Comment by jdemeyer created at 2018-12-30 01:38:21

The "problem" seems to be that Cython defines an ordinary attribute `__qualname__` on the metaclass. I'm not entirely convinced that your fix is the right thing to do, I'll need to think about it.


---

Comment by chapoton created at 2018-12-30 10:38:10

see also #26319


---

Comment by jdemeyer created at 2018-12-31 09:32:58

I consider the `__qualname__` issue a Cython bug: https://github.com/cython/cython/issues/2772

Since the issue is almost certainly not limited to `InheritComparisonMetaclass`, it's pointless to work around it only there.

Instead, I suggest to simply not use `__qualname__` in autodoc until this Cython bug is fixed.


---

Comment by jdemeyer created at 2018-12-31 09:34:50

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-12-31 09:35:13

Replying to [comment:32 chapoton]:
> see also #26319

That is a different unrelated problem with `__qualname__`


---

Comment by git created at 2018-12-31 22:52:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2018-12-31 22:54:59

Replying to [comment:33 jdemeyer]:
> I consider the `__qualname__` issue a Cython bug: https://github.com/cython/cython/issues/2772
> 
> Since the issue is almost certainly not limited to `InheritComparisonMetaclass`, it's pointless to work around it only there.

Right.

> Instead, I suggest to simply not use `__qualname__` in autodoc until this Cython bug is fixed.

Done. Thanks.


---

Comment by klee created at 2018-12-31 22:55:36

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-01-01 09:28:42

Rebased to 8.6.beta0 and squashed.
----
New commits:


---

Comment by jdemeyer created at 2019-01-01 09:29:47

Building the docs now...


---

Comment by jdemeyer created at 2019-01-02 17:54:03

Since the change involving `__qualname__` is a functional change, I decided to deal with that in a separate ticket: #27002


---

Comment by git created at 2019-01-02 17:57:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-01-02 22:31:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2019-01-02 22:31:49

Some things are no longer documented. For example `sage.schemes.elliptic_curves.padics.padic_lseries` which is a `CachedMethod`.


---

Comment by klee created at 2019-01-03 11:39:15

Replying to [comment:44 jdemeyer]:
> Some things are no longer documented. For example `sage.schemes.elliptic_curves.padics.padic_lseries` which is a `CachedMethod`.

You might have noticed that these cached functions have wrong documentations already with the current sage. With the present patch, they now have no documentation. We are just seeing different manifestations of an issue with cached functions. Fixing this issue with cached functions seems to be out of the scope of the present ticket. I may open a ticket to tackle this issue if you agree.


---

Comment by klee created at 2019-01-03 20:10:44

Replying to [comment:45 klee]:
> Replying to [comment:44 jdemeyer]:
> > Some things are no longer documented. For example `sage.schemes.elliptic_curves.padics.padic_lseries` which is a `CachedMethod`.
> 
> You might have noticed that these cached functions have wrong documentations already with the current sage. With the present patch, they now have no documentation. 

This is right.

> We are just seeing different manifestations of an issue with cached functions. 

This is wrong. There is no issue with cached functions! All functions defined in `sage.schemes.elliptic_curves.padics` are imported and embedded into the class `EllipticCurve_rational_field` defined in `sage.schemes.elliptic_curves.padics.ell_rational_field`.  Thus the functions are well documented as methods in the documentation of the class. Hence there is no need to (should not) document the functions in `padics.py` in duplicate!

>Fixing this issue with cached functions seems to be out of the scope of the present ticket. I may open a ticket to tackle this issue if you agree.

What should be done is to remove the article `Miscellaneous p-adic functions` from the Sage documentation. I may open a ticket for this, if you agree.


---

Comment by klee created at 2019-01-03 20:15:34

Changing status from needs_work to needs_review.


---

Comment by klee created at 2019-01-04 01:16:26

Rebased on sage 8.6.rc0 and removed a few unuseful comments like `# type: ...`
----
New commits:


---

Comment by jdemeyer created at 2019-01-04 11:50:08

Fair enough regarding `padic_lseries`.

Still, there is more documentation which is removed. For example `sage.combinat.finite_state_machine.FiniteStateMachine.output_alphabet`

In the sources, there is

```python
    output_alphabet = None
    """
    A list of letters representing the output alphabet of the finite
    state machine.

    It can be set by the parameter ``output_alphabet`` when initializing
    a finite state machine, see :class:`FiniteStateMachine`.

    It can also be set by the method :meth:`determine_alphabets`.

    .. SEEALSO::

        :class:`FiniteStateMachine`,
        :meth:`determine_alphabets`,
        :attr:`input_alphabet`.
    """
```

and apparently Sphinx parses this correctly before this patch but not after this patch.


---

Comment by jdemeyer created at 2019-01-04 12:54:17

Replying to [comment:48 klee]:
> removed a few unuseful comments like `# type: ...`

If those comments appear in the original, it's more maintainable to keep them.


---

Comment by klee created at 2019-01-04 13:26:11

Replying to [comment:50 jdemeyer]:
> Replying to [comment:48 klee]:
> > removed a few unuseful comments like `# type: ...`
> 
> If those comments appear in the original, it's more maintainable to keep them.

The old `sage_autodoc` didn't keep those comments. It seems to be a convention of Sphinx, but absolutely not of Sage. Anyway I don't care. Do you prefer to follow Sphinx?


---

Comment by git created at 2019-01-04 13:29:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2019-01-04 13:30:46

Replying to [comment:51 klee]:
> It seems to be a convention of Sphinx, but absolutely not of Sage.

It's not just a Sphinx thing: https://www.python.org/dev/peps/pep-0484/#suggested-syntax-for-python-2-7-and-straddling-code

> Do you prefer to follow Sphinx? 

Yes. More generally, we should stay as close to upstream Sphinx as possible.


---

Comment by klee created at 2019-01-04 13:39:33

I am not sure if my last commit will finally make everything right or break something somewhere. This business is going to be close to blind trials...

Anyway personally I could not afford more trials if anything breaks, for some weeks. Sorry.


---

Comment by jdemeyer created at 2019-01-04 13:43:05

Replying to [comment:54 klee]:
> Anyway personally I could not afford more trials if anything breaks, for some weeks. Sorry.

No need to apologize. You already did very good work!

Good to know that you'll be inactive. I'll try to fix any issues myself.


---

Comment by jdemeyer created at 2019-01-07 11:59:45

I'm happy enough with the generated documentation now.


---

Comment by git created at 2019-01-07 14:26:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2019-01-07 14:31:48

The last commit should not affect documentation. Tried a tiny bit to prepare for Sphinx 1.8.


---

Comment by jdemeyer created at 2019-01-07 14:33:33

OK, do you plan further changes? I'll just need to know when I can review the final version of this branch.


---

Comment by klee created at 2019-01-07 14:34:50

Replying to [comment:59 jdemeyer]:
> OK, do you plan further changes? I'll just need to know when I can review the final version of this branch.

No. Please proceed.


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by chapoton created at 2019-01-17 09:58:30

any progress here ? Will this fix `make doc` for python3 ?


---

Comment by klee created at 2019-01-17 10:42:16

Replying to [comment:62 chapoton]:
> any progress here ? Will this fix `make doc` for python3 ?

Yes. I am waiting for a final review.


---

Comment by chapoton created at 2019-01-17 10:52:22

could you please check these pyflakes warnings (maybe not pertinent)

```
+src/sage_setup/docbuild/ext/sage_autodoc.py:33: 'warnings' imported but unused
+src/sage_setup/docbuild/ext/sage_autodoc.py:36: 'six.iteritems' imported but unused
+src/sage_setup/docbuild/ext/sage_autodoc.py:39: 'sphinx.errors.ExtensionError' imported but unused
+src/sage_setup/docbuild/ext/sage_autodoc.py:41: 'sphinx.ext.autodoc.inspector.format_annotation' imported but unused
+src/sage_setup/docbuild/ext/sage_autodoc.py:47: 'sphinx.util.inspect.Signature' imported but unused
+src/sage_setup/docbuild/ext/sage_autodoc.py:50: 'sphinx.util.inspect.getargspec' imported but unused
```



---

Comment by jdemeyer created at 2019-01-17 11:57:36

Sorry, I forgot about this ticket. I will review it. Please do not make further changes.


---

Comment by klee created at 2019-01-17 12:15:27

Replying to [comment:64 chapoton]:
> could you please check these pyflakes warnings (maybe not pertinent)
> {{{
> +src/sage_setup/docbuild/ext/sage_autodoc.py:33: 'warnings' imported but unused
> +src/sage_setup/docbuild/ext/sage_autodoc.py:36: 'six.iteritems' imported but unused
> +src/sage_setup/docbuild/ext/sage_autodoc.py:39: 'sphinx.errors.ExtensionError' imported but unused
> +src/sage_setup/docbuild/ext/sage_autodoc.py:41: 'sphinx.ext.autodoc.inspector.format_annotation' imported but unused
> +src/sage_setup/docbuild/ext/sage_autodoc.py:47: 'sphinx.util.inspect.Signature' imported but unused
> +src/sage_setup/docbuild/ext/sage_autodoc.py:50: 'sphinx.util.inspect.getargspec' imported but unused
> }}}

Fixed all pyflakes warnings, except  one about`sphinx.util.inspect.Signature`. `Signature` is imported in the original Sphinx autodoc, and I think is very likely to be used in future,  perhaps in #26451 or in #26254.


---

Comment by git created at 2019-01-17 12:15:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2019-01-17 13:02:27

I explicitly asked not to make further changes, so I will revert that last commit.


---

Comment by klee created at 2019-01-17 13:55:19

Replying to [comment:68 jdemeyer]:
> I explicitly asked not to make further changes, so I will revert that last commit. 

Ok with that. But I am curious why the small, rather insignificant, change like the last commit is unacceptable to you. It seems not a big deal to me... Is there a technical reason that I miss?


---

Comment by jdemeyer created at 2019-01-17 14:16:06

I just don't want to review a moving target. The change itself may or may not be fine but at some point the branch needs to be fixed. For example, I would need to review the fact that the change is as innocent as you claim it to be.


---

Comment by klee created at 2019-01-17 14:20:46

Replying to [comment:70 jdemeyer]:
> I just don't want to review a moving target. The change itself may or may not be fine but at some point the branch needs to be fixed. For example, I would need to review the fact that the change is as innocent as you claim it to be.

I agree in general. Ok.


---

Comment by jhpalmieri created at 2019-01-17 18:13:11

I know that everyone is in agreement, but if you want actual evidence: in #16298, an import was apparently unused anywhere, so removing it was recommended by `pyflakes` and looked innocent to all parties involved, but removing it actually broke things. So (a) `pyflakes` can be wrong, and (b) "innocent" changes may not actually be innocent.


---

Comment by git created at 2019-01-18 08:42:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-01-18 08:42:40

Reverted last commit and squashed the other commits.


---

Comment by jdemeyer created at 2019-01-18 08:50:11

Changing status from needs_review to positive_review.


---

Comment by klee created at 2019-01-18 09:42:55

Thank you. I wish that now with this patch, `make` builds the documentation also on python3!


---

Comment by embray created at 2019-01-18 13:15:09

Replying to [comment:68 jdemeyer]:
> I explicitly asked not to make further changes, so I will revert that last commit. 

I understand your reasoning, but given that the commit was made and you hadn't actually (as far as anyone can tell) begun the review the change, why not just incorporate it into your review?  It does look pretty harmless to me and, while it should still have been checked, really doesn't add significant burden to review.


---

Comment by jdemeyer created at 2019-01-18 13:35:06

Replying to [comment:78 embray]:
> you hadn't actually (as far as anyone can tell) begun the review the change,

I thought that "I will review it. Please do not make further changes." was clear enough. So yes, I was already building the documentation when that additional commit was pushed.

Can we please not make further fuss about this? This ticket has positive review now, let's keep it that way. It's not perfect and that's fine. And the `pyflakes` warnings are the least of my worries with the Sage docbuilder.


---

Comment by vbraun created at 2019-01-24 18:17:49

Resolution: fixed
