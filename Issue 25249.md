# Issue 25249: $SAGE_LOCAL/bin/sage should work in an environment without SAGE_* variables

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2018-05-31 17:36:50

CC:  jdemeyer nbruin embray fbissey charpent thansen saraedum slelievre @timokau dimpase

From https://groups.google.com/d/msg/sage-devel/oODph9-yjaI/FVeBsCk_CgAJ:

On Wednesday, May 30, 2018 at 9:01:59 AM UTC-7, Nils Bruin wrote:

 Currently, if I run the script $SAGE_LOCAL/bin/sage in my normal environment (where SAGE_ROOT is not set) then I get:

 Error: You must set the SAGE_ROOT environment variable or run this
 script from the SAGE_ROOT or SAGE_ROOT/local/bin/ directory.
 Error setting environment variables by sourcing '/usr/local/sage/sage-git/local/bin/sage-env';
 possibly contact sage-devel (see http://groups.google.com/group/sage-devel).

 If instead I run the script $SAGE_ROOT/sage a value for SAGE_ROOT is figured out and everything works 
 fine when called from my normal environment.

We should make `$SAGE_LOCAL/bin/sage` work without environment variables set.
We discussed this in #21479 (`./configure --prefix=SAGE_LOCAL`), when `$SAGE_LOCAL/bin/sage-env-config` was introduced; but then a less ambitious solution was implemented for that ticket.

We could add a line setting `$SAGE_ROOT` in `$SAGE_LOCAL/bin/sage-env-config` (via `src/bin/sage-env-config.in`).


---

Comment by slelievre created at 2018-06-01 21:12:16

Likewise, a naive trial to start the GAP shipped by Sage fails:

```
$ /path/to/sagedir/local/bin/gap
Set the environment variable SAGE_LOCAL.
```

and one instead has to run:

```
$ /path/to/sagedir/sage --gap
```

or

```
$ SAGE_LOCAL='/path/to/sagedir' /path/to/sagedir/local/bin/gap
```

(where `/path/to/sagedir` should be replaced by the actual path to
the Sage installation directory).

This makes it hard to use
[Gap.app](https://sourceforge.net/projects/cocoagap), the macOS
interface to GAP by Russ Woodroofe, with the GAP shipped by Sage.


---

Comment by slelievre created at 2018-06-01 21:12:16

Changing keywords from "" to "SAGE_LOCAL, SAGE_ROOT".


---

Comment by @RussWoodroofe created at 2018-06-06 10:04:14

One comment: the new version of GAP deprecates the gap.sh as the right way to start GAP.  (The gap binary detects the directory that it lives in, and uses that as the default library directory.)  Relying on the shell script to check for SAGE_LOCAL probably isn't a great idea for GAP 4.9.1 or later.  That might make this more pressing.

If you do need to check for the SAGE_LOCAL variable, it seems to me like a better place to check would be in GAP code.  (The `IO_environ()` function from the IO package will read the environment, which you could do on package load.)  But I'm coming from outside, and might not be aware of all issues.

Also, I'm the Gap.app author.  If it still looks necessary when I next make updates, I'll consider adding logic to set SAGE_LOCAL to a sensible guess on startup.  I ran out of time for this release (as I wanted to get something out at the same time as GAP 4.9.1).  I'd love for it to no longer be necessary!


---

Comment by embray created at 2018-07-10 14:32:09

I don't think there should be _anything_ in GAP that cares about `$SAGE_LOCAL`.  If anything Sage's `bin/gap` should just be a wrapper script that sets the necessary environment variables, rather than patching `gap.sh` which it currently does =_=


---

Comment by mkoeppe created at 2020-01-15 23:30:50

A step into this direction: #29022 "Create module `src/sage/env_config.py` from `src/sage/env_config.py.in`, defining variables for use in `sage.env`.


---

Comment by mkoeppe created at 2020-01-17 20:27:32

This is adapted from an old branch of #21479 (`./configure --prefix=SAGE_LOCAL`), when `$SAGE_LOCAL/bin/sage-env-config` was introduced; but then a less ambitious solution was implemented for that ticket.
----
New commits:


---

Comment by mkoeppe created at 2020-01-17 20:27:32

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-01-18 19:12:24

Removed a dependency that is not needed.


---

Comment by embray created at 2020-01-22 11:42:15

A few suggestions:

rename `SOURCED_SAGE_ENV_CONFIG` to `SAGE_ENV_CONFIG_SOURCED` (we already have a `SAGE_ENV_SOURCED`) variable as well.

Make `sage-env-config` itself responsible for setting `SAGE_ENV_CONFIG_SOURCED`, rather than setting it in `sage-env`.


```
+# SAGE_ROOT is the location of the Sage source/build tree.
+export SAGE_ROOT="`@`abs_top_srcdir`@`"
```


Wouldn't this permanently encode the directory in which Sage happens to be built in any Sage installation, including for binary builds?  E.g. if Volker does a binary build and publishes it, then it will contain in `local/bin/sage-env-config` something like `SAGE_ROOT=/home/vbraun/src/sage/` and won't work when moved.  So I'm not sure this make sense to me...

How do distros currently handle `$SAGE_ROOT`, a path that doesn't have significant meaning in standard installs?  Perhaps what we need is to do away with any dependency on `$SAGE_ROOT` at runtime.


---

Comment by embray created at 2020-01-22 11:42:15

Changing status from needs_review to needs_work.


---

Comment by embray created at 2020-01-22 11:42:57

I think otherwise in principle I'm +1 to this but I don't see how it resolves that last question...


---

Comment by git created at 2020-01-22 15:57:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-22 15:57:39

Replying to [comment:12 embray]:
> A few suggestions:
> 
> rename `SOURCED_SAGE_ENV_CONFIG` to `SAGE_ENV_CONFIG_SOURCED` (we already have a `SAGE_ENV_SOURCED`) variable as well.
> 
> Make `sage-env-config` itself responsible for setting `SAGE_ENV_CONFIG_SOURCED`, rather than setting it in `sage-env`.

Thanks! Done.


---

Comment by mkoeppe created at 2020-01-22 16:15:09

Replying to [comment:12 embray]:
> {{{
> +# SAGE_ROOT is the location of the Sage source/build tree.
> +export SAGE_ROOT="`@`abs_top_srcdir`@`"
> }}}
> 
> Wouldn't this permanently encode the directory in which Sage happens to be built in any Sage installation,  

Yes, that's what it does. Sage installations (`SAGE_LOCAL`) and non-`distclean` source trees (`SAGE_ROOT`) are not relocatable with or without this ticket.

> including for binary builds? E.g. if Volker does a binary build and publishes it, then it will contain in `local/bin/sage-env-config` something like `SAGE_ROOT=/home/vbraun/src/sage/` and won't work when moved.  

The binary build uses `SAGE_ROOT` = a long pseudorandom path and then rewrites all paths, including this one, using https://github.com/sagemath/binary-pkg/blob/master/binary_pkg/templates/relocate-once.py the first time that `SAGE_ROOT/sage` is used.

> How do distros currently handle `$SAGE_ROOT`, a path that doesn't have significant meaning in standard installs?  

Distributions tend to replace all of `sage-env` by their own tooling anyway.

> Perhaps what we need is to do away with any dependency on `$SAGE_ROOT` at runtime.

Yes, in fact, there's very little left (see #25828/#28815). In any case, that's orthogonal to the present ticket.


---

Comment by mkoeppe created at 2020-01-22 16:15:31

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-02-01 14:08:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-02-01 14:09:02

Rebased on 9.1.beta2, needs review


---

Comment by git created at 2020-02-16 20:29:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-02 01:44:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-09 21:26:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-19 13:46:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-19 13:46:41

Rebased on 9.1.beta8, needs review


---

Comment by mkoeppe created at 2020-04-14 06:38:06

pushing these forward to 9.2


---

Comment by git created at 2020-06-07 21:56:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-07 21:57:18

Rebased on 9.2.beta0


---

Comment by dimpase created at 2020-06-11 12:57:41

lgtm


---

Comment by dimpase created at 2020-06-11 12:57:41

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-11 13:01:40

Changing status from positive_review to needs_info.


---

Comment by dimpase created at 2020-06-11 13:01:40

oops, sorry, doesn't it need a shebang to make sure it is running in bash?


---

Comment by mkoeppe created at 2020-06-12 11:08:39

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2020-06-12 11:08:39

Well, I guess this ticket conflicts somehow with #29345


---

Comment by mkoeppe created at 2020-06-24 05:12:38

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-06-24 05:12:38

Actually it is already documented that `sage-env` "uses bash features, so it cannot be used with other shells." It is sourced by other scripts, so it does not need a #! line.


---

Comment by dimpase created at 2020-06-25 23:27:41

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-25 23:27:41

lgtm


---

Comment by mkoeppe created at 2020-06-26 00:22:35

Thanks!


---

Comment by vbraun created at 2020-06-27 09:26:50

Resolution: fixed


---

Comment by mkoeppe created at 2020-07-05 19:47:36

Follow up: #29446


---

Comment by mjo created at 2020-07-13 04:04:52

Replying to [comment:31 mkoeppe]:
> Actually it is already documented that `sage-env` "uses bash features, so it cannot be used with other shells." It is sourced by other scripts, so it does not need a #! line.

I fixed all of the bashisms in #29345, but missed that comment. The sage build now fails again with any other `/bin/sh`:


```
cd '/home/mjo/src/sage.git/build/pkgs/sage_conf' && . '/home/mjo/src/sage.git/src/bin/sage-env' && . '/home/mjo/src/sage.git/build/bin/sage-build-env-config' && sage-logger -p '/home/mjo/src/sage.git/build/pkgs/sage_conf/spkg-install' '/home/mjo/src/sage.git/logs/pkgs/sage_conf-none.log'
/bin/sh: 123: /home/mjo/src/sage.git/src/bin/sage-env: Bad substitution
Error: SAGE_SCRIPTS_DIR is set to a bad value:
SAGE_SCRIPTS_DIR=/home/mjo/src/sage.git/build/pkgs/sage_conf
You must correct it or erase it and rerun this script
make[3]: *** [Makefile:2022: /home/mjo/src/sage.git/local/var/lib/sage/installed/sage_conf-none] Error 1
```


Debian's dash shell is crippled, but would it be possible to symlink `/bin/sh` to dash on e.g. Arch linux, or maybe to ksh on some other distro that we have CI for? (To prevent regressions in the future?)


---

Comment by mjo created at 2020-07-13 04:12:03

Follow-up on #30128
