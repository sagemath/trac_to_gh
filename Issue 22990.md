# Issue 22990: Add cpdef declarations in pxd files when overwriting a cdef method

Issue created by migration from https://trac.sagemath.org/ticket/23227

Original creator: roed

Original creation time: 2017-06-13 06:11:00

CC:  saraedum

See https://github.com/cython/cython/issues/1732

This affects `Polynomial_generic_dense` at least.


---

Comment by jdemeyer created at 2017-06-13 18:40:38

How did you come up with this? Is there a specific concrete problem or just a theoretical bug?

By the way, the gist link talks about "`cpdef`'d without a corresponding entry in their pxd file" while the Cython bug talks about "`cpdef` override of a `cdef` method". These are obviously different things, so what is the problem exactly? If the problem is only `cpdef` overrides of `cdef` methods, I guess that a large majority of the entries in the gist link are false positives, making that link not very informative.


---

Comment by roed created at 2017-06-13 19:13:39

Replying to [comment:3 jdemeyer]:
> How did you come up with this? Is there a specific concrete problem or just a theoretical bug?

Yeah, this caused a segfault that saraedum and I spent 10 hours yesterday debugging, while working on #23218.  Because the vtable is screwed up, function calls behave unpredictably.
 
> By the way, the gist link talks about "`cpdef`'d without a corresponding entry in their pxd file" while the Cython bug talks about "`cpdef` override of a `cdef` method". These are obviously different things, so what is the problem exactly? If the problem is only `cpdef` overrides of `cdef` methods, I guess that a large majority of the entries in the gist link are false positives, making that link not very informative.

Yeah, I agree that the link is not that informative.  I wrote something easy to try to get an idea of the scope of the problem, then determined that it wasn't easy to actually find the cases where the problem actually occurs (which is, indeed, where a cdef method is overwritten by a cpdef method without a corresponding entry in the pxd file).  I decided that I wanted to move on and work on other stuff, so I uploaded the gist as a place to start looking.


---

Comment by roed created at 2017-06-13 19:15:25

Replying to [comment:4 roed]:
> Replying to [comment:3 jdemeyer]:
> > How did you come up with this? Is there a specific concrete problem or just a theoretical bug?
> 
> Yeah, this caused a segfault that saraedum and I spent 10 hours yesterday debugging, while working on #23218.  Because the vtable is screwed up, function calls behave unpredictably.

In particular, we noticed the problem for `Polynomial_generic_dense`, where `_add_`, `_mul_` and `_floordiv_` have this issue.


---

Comment by jdemeyer created at 2017-06-13 19:46:41

Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.


---

Comment by roed created at 2017-06-13 19:55:26

Replying to [comment:6 jdemeyer]:
> Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.

Sure, and I'm fine waiting to see what Cython does.  But one possible thing for them to do is to require a cpdef declaration in the pxd file, in which case this ticket can track those additions.


---

Comment by roed created at 2017-06-15 06:27:49

Replying to [comment:7 roed]:
> Replying to [comment:6 jdemeyer]:
> > Honestly, I don't think it is realistic to fix the general problem in Sage since the underlying problem is in upstream Cython. Of course, we can fix specific cases like the `Polynomial_generic_dense` that you mentioned.
> 
> Sure, and I'm fine waiting to see what Cython does.  But one possible thing for them to do is to require a cpdef declaration in the pxd file, in which case this ticket can track those additions.

Cython will soon raise an error in these cases.  I think the best thing to do is to wait until we update to a new version of Cython and change these pxd files then.  I think it's worth leaving this ticket open until that point in case someone else runs into a similar problem.


---

Comment by jdemeyer created at 2017-07-05 14:53:19

Replying to [comment:8 roed]:
> Cython will soon raise an error in these cases.

I convinced Cython upstream to downgrade this to a warning for now. That will make our life easier, since we can first upgrade to Cython 0.26 (in beta now) and then fix this gradually.


---

Comment by git created at 2017-08-03 16:54:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-08-07 10:02:12

Ready for review?


---

Comment by jdemeyer created at 2017-08-07 10:04:52

Why restrict to `_add_` and `_mul_`? (edit: you are not doing that, it's just the commit message implying that you do)


---

Comment by roed created at 2017-08-07 17:32:49

Yeah, I just got lazy going through and figuring out all the functions that I'd actually changed.  I used the log of warnings to find the places to edit, so I think I got them all, but I haven't rebuilt from scratch to check.


---

Comment by roed created at 2017-08-07 17:33:23

Yeah, I think this is ready for review.  I don't have anything else to add to it.


---

Comment by roed created at 2017-08-07 17:33:23

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-08-08 07:58:23

Replying to [comment:16 roed]:
> Yeah, I just got lazy going through and figuring out all the functions that I'd actually changed.  I used the log of warnings to find the places to edit, so I think I got them all, but I haven't rebuilt from scratch to check.

Even if you didn't catch them all, that's not really a problem.


---

Comment by jdemeyer created at 2017-08-08 08:00:33

Rebased to 8.1.beta1
----
New commits:


---

Comment by jdemeyer created at 2017-08-08 08:02:42

Why this?

```diff
-    cpdef normalize(self)
+    cpdef normalize(self, include_zeroth_moment = *)
```



---

Comment by jdemeyer created at 2017-08-08 08:10:52

In some cases, I am wondering whether it is better to add "abstract" `_add_` and `_mul_` methods on a lower level. For example, instead of adding those functions to `QuaternionAlgebraElement_generic`, `QuaternionAlgebraElement_number_field` and `QuaternionAlgebraElement_rational_field`, add them to `QuaternionAlgebraElement_abstract` raising `NotImplementedError`.

Concretely for this ticket, I would like to fix only the totally uncontroversial cases (for example, undoing the changes to quaternion algebra elements) and leave the rest for a follow-up.


---

Comment by git created at 2017-08-08 08:48:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-08-08 12:38:46

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-08-08 12:38:46

positive_review to this strict subset of the original patch.


---

Comment by roed created at 2017-08-08 21:28:45

See #23600 for the followup.


---

Comment by vbraun created at 2017-08-11 18:18:03

Resolution: fixed
