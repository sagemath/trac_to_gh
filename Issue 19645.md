# Issue 19645: Let "make doc" always work.

Issue created by migration from https://trac.sagemath.org/ticket/19882

Original creator: tmonteil

Original creation time: 2016-01-13 17:39:04

As requested in #18464. Currently `make doc` can fail when some previous documentation was built.




---

Comment by tmonteil created at 2016-01-13 17:42:47

Changing status from new to needs_review.


---

Comment by tmonteil created at 2016-01-13 17:42:47

The proposed fix is to just let the `doc` target depend on `doc-clean`. Perhaps is there a lighter solution ?
----
New commits:


---

Comment by jdemeyer created at 2016-01-13 18:03:38

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-01-13 18:03:38

No, this would force the doc to be rebuilt everytime you run `make`.


---

Comment by tmonteil created at 2016-01-13 18:23:14

So, what should be done ?


---

Comment by jdemeyer created at 2016-01-13 18:25:53

Figure out *why* the docbuilder sometimes fails and fix that.


---

Comment by jhpalmieri created at 2016-01-13 21:27:02

Do we have ideas why? If a `.py` or `.pyx` file is present in one branch and not in another, this confuses the docbuilder. What else goes wrong?


---

Comment by jdemeyer created at 2016-01-14 22:15:22

Replying to [comment:4 tmonteil]:
> So, what should be done ?

As quick fix, the following might work:

1. try to build the documentation normally.
2. if that fails, run `make doc-clean` and rebuild the documentation.

Step 1 is crucial to avoid a lot of needless rebuilds of the documentation.


---

Comment by git created at 2016-01-15 17:08:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-15 17:58:07

I am wondering if the recursive call of `$(MAKE)` is a good idea (I'm not saying it's bad, I just need to think about it).


---

Comment by tmonteil created at 2016-01-15 19:32:19

The current Makefile already calls `$(MAKE)`, see e.g. in #18710:


```
bdist-clean: clean
        $(MAKE) misc-clean
```


That said, there is no real recursivity since the `doc` target depends on `doc-html` and `doc-clean`, and none of those depend on `doc`, so i do not see any loop possibility. I am currently doing a few tests to see how it works in various cases.


---

Comment by jdemeyer created at 2016-01-16 10:58:30

It's problematic that `doc-html` has dependencies which also appear as dependencies of `all-sage`. So we can end up in a situation where there are two instances of `make` building the same targets.


---

Comment by jdemeyer created at 2016-01-16 11:03:18

Maybe you can solve this with an extra level of indirection:

```
doc-html: $(DOC_DEPENDENCIES)
    $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )

docbuild-html:
    cd ../.. && sage-logger './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
```


Ugly, but I guess it would work.


---

Comment by git created at 2016-01-26 10:11:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2016-01-27 21:59:32

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2016-01-27 21:59:32

It seems to work. Do someone know a way to reproduce that kind of docbuild error that disappears after a `doc-clean` ?


---

Comment by jdemeyer created at 2016-01-29 07:16:21

Did you try `make -q` too? I am afraid that will break.


---

Comment by tscrim created at 2016-01-29 15:19:33

Replying to [comment:14 tmonteil]:
> It seems to work. Do someone know a way to reproduce that kind of docbuild error that disappears after a `doc-clean` ?

I would just create a dummy file with some simple doc<sup>1</sup>, build the doc, delete the file, and rebuild the doc (perhaps on a branch based on this one).

Alternatively, you could create a branch where you just remove a file and try to build the doc.

<sup>1</sup> - Don't forget to add an entry in the `.rst` files.


---

Comment by slabbe created at 2016-10-05 15:40:47

#21378 got positive review (duplicate won't fix) saying that this ticket (#19882) is a better solution. But there was no update on #19882 since 8 months...

No later than yesterday, I run `make ptestlong` overnight to realize the day after that the doc failed and no test at all were ever made:


```
[dochtml] OSError: [homology ] Exception occurred:
[dochtml] 
[dochtml] 
[dochtml] Note: incremental documentation builds sometimes cause spurious
[dochtml] error messages. To be certain that these are real errors, run
[dochtml] "make doc-clean" first and try again.
Makefile:1061 : la recette pour la cible « doc-html » a échouée
```


I would like that `make ptestlong` always work...


---

Comment by jdemeyer created at 2016-10-21 08:07:24

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-10-21 08:07:24

Merge conflict...


---

Comment by git created at 2017-03-10 09:04:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tmonteil created at 2017-03-10 09:06:39

Here is a rebased version. Unfortunately, my laptop does not have enough memory anymore to build Sage doc, so that i can not test it seriously :(


---

Comment by tmonteil created at 2017-03-10 09:06:39

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2017-03-10 18:18:27

I got the error

```
***********************************************
Makefile:1093: *** missing separator.  Stop.
```

with this, until I made the change

```diff
diff --git a/build/make/deps b/build/make/deps
index e18fd6f..da0a4e9 100644
--- a/build/make/deps
+++ b/build/make/deps
@@ -206,7 +206,7 @@ DOC_DEPENDENCIES = sagelib $(inst_sphinx) $(inst_sagenb) \
 doc: doc-html
 
 doc-html: $(DOC_DEPENDENCIES)
-    $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )
+       $(MAKE) docbuild-html || ( $(MAKE) doc-clean ; $(MAKE) docbuild-html )
 
 docbuild-html:
        $(AM_V_at)cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS)' logs/dochtml.log
```

(that is, replacing spaces with a tab).


---

Comment by git created at 2017-03-10 18:25:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2017-03-10 18:27:45

Oops, thanks for noticing, i did a 'hand rebase', without noticing that my editor behave as for python files. Sorry.


---

Comment by jhpalmieri created at 2017-03-10 20:25:34

This works. I wish there were a less drastic solution, but let's merge it now and see if someone comes up with something better later.


---

Comment by jhpalmieri created at 2017-03-10 20:25:34

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-03-10 20:28:44

Did you check that `make -q` still works as expected?


---

Comment by jhpalmieri created at 2017-03-10 20:35:57

Changing status from positive_review to needs_info.


---

Comment by jhpalmieri created at 2017-03-10 20:35:57

No, good point.


---

Comment by jhpalmieri created at 2017-03-10 20:45:39

Replying to [comment:25 jdemeyer]:
> Did you check that `make -q` still works as expected?

I guess I don't know what you mean, now that I've tested it. With the current develop branch, if I run `make` successfully, then I see

```
$ make -q
$ echo $?
1
```

So it doesn't work (IMHO) with the develop branch. It continues to not work with this branch. Is that working "as expected"?


---

Comment by klee created at 2017-03-13 00:44:01

Check this out for alternative solution.

https://trac.sagemath.org/ticket/22588


---

Comment by jhpalmieri created at 2017-03-14 18:57:54

I think that the alternate solution at #22588 and this one both have advantages. For example, if you change your version of Sphinx, you may need to delete the docs and rebuild from scratch (maybe because of the inventory files? I'm not sure). I'm not sure that #22588 will catch that. So why not use both approaches?

That said, my question above about `make -q` still remains.


---

Comment by jhpalmieri created at 2017-08-03 23:09:09

Jeroen: can you explain what you meant in comment:25 about `make -q`? With or without this branch, `make -q` leads to `echo $?` reporting "1", not "0". Do you object to a positive review for this?

(As I said, I also think that there is reason to keep both this and #22588.)


---

Comment by jdemeyer created at 2017-09-05 13:04:57

So what should we do here, given #22588? Close as wontfix?


---

Comment by jhpalmieri created at 2017-09-05 14:09:31

Will #22588 always work, or will the docs still fail to build some time (I guessed at one scenario in comment:29)?


---

Comment by jdemeyer created at 2017-09-05 14:31:56

Replying to [comment:32 jhpalmieri]:
> Will #22588 always work, or will the docs still fail to build some time

That's something to be seen I guess. The question is: if issues arise with #22588, should we try to fix those issues or should we implement the "nuclear option" of this ticket?


---

Comment by jhpalmieri created at 2017-09-05 15:00:50

I don't have strong feelings about it. Since it took so long to get an attempted fix, I'm not that optimistic that future problems will be dealt with, but I don't mind closing this and seeing what happens.


---

Comment by klee created at 2017-09-05 15:33:27

Now with #22588, I hope that the doc builder is reliable.  I mean: if doc build fails, then the reason is genuine, that is, there is a problem with the doc source, and doc build would fail even after doc-clean. Then the solution of this ticket is actually just to delay the time to recognize the problem of the doc source.  

But time will tell whether I am just too optimistic..


---

Comment by jhpalmieri created at 2017-09-06 01:54:27

I just did an incremental build from 8.1.beta3 to 8.1.beta4 and got

```
[dochtml] Building reference manual, first pass.
[dochtml] 
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1675, in main
[dochtml]     builder()
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 310, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 505, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 246, in build_many
[dochtml]     ret = x.get(99999)
[dochtml]   File "/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/multiprocessing/pool.py", line 567, in get
[dochtml]     raise self._value
[dochtml] AttributeError: 'module' object has no attribute 'WarningStream'
[dochtml] 
[dochtml] Note: incremental documentation builds sometimes cause spurious
[dochtml] error messages. To be certain that these are real errors, run
[dochtml] "make doc-clean" first and try again.
```



---

Comment by jhpalmieri created at 2017-09-06 04:17:42

And this seems to be repeatable for me: I switched back to 8.1.beta3, did `make doc-clean; make`, and then when I tried to build 8.1.beta4, same error.


---

Comment by jdemeyer created at 2017-09-06 11:16:41

Replying to [comment:36 jhpalmieri]:
> `[dochtml] AttributeError: 'module' object has no attribute 'WarningStream'`

This is very likely due to the Sphinx upgrade #23023. It makes sense to require a complete rebuild of the docs when changing Sphinx versions. This should be automated, just like we automatically re-cythonize the Sage library whenever the Cython version changes.


---

Comment by jhpalmieri created at 2017-09-07 15:19:02

We could delete the docs in the Sphinx `spkg-install` script. We used to do this, but then at some point (#11665) we decided to try to keep the old docs.


---

Comment by jhpalmieri created at 2017-09-07 17:32:53

For example like this:

```diff
diff --git a/build/pkgs/sphinx/spkg-install b/build/pkgs/sphinx/spkg-install
index 200965b566..05085aaa79 100644
--- a/build/pkgs/sphinx/spkg-install
+++ b/build/pkgs/sphinx/spkg-install
@@ -23,6 +23,12 @@ $PIP_INSTALL .
 success 'Error installing Sphinx'
 echo
 
+echo "A new version of Sphinx was installed, so deleting old Sage documentation output..."
+echo "Removing \"$SAGE_DOC\"..."
+rm -rf "$SAGE_DOC"
+success 'Error removing the old documentation'
+echo
+
 cd "$CUR"
 echo "Creating grammar pickle..."
 sage-python23 create_grammar_pickle.py
```



---

Comment by jhpalmieri created at 2017-09-07 17:33:13

If this is a good idea, we can do it here or open another ticket.


---

Comment by jdemeyer created at 2017-09-08 07:38:30

I like the principle, but not the approach of using the Sphinx installer to remove the docs. It goes against seperation of concerns. Better would be to implement this in the docbuilder: find out the timestamp or version of the installed Sphinx and then take action.


---

Comment by jdemeyer created at 2017-09-08 07:48:15

See #23803


---

Comment by jhpalmieri created at 2017-09-08 18:39:12

Changing status from needs_info to needs_review.


---

Comment by jhpalmieri created at 2017-09-08 18:39:12

Okay, let's close this.


---

Comment by jdemeyer created at 2017-10-31 10:56:24

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-12-12 08:23:33

Resolution: wontfix
