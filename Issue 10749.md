# Issue 10749: Matrix multiplication and power are very slow

archive/issues_010749.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  tmonteil\n\nKeywords: matrix, multiplication, slow\n\nIt seems that the multiplication and the power of a matrix is very slow:\n\n\n```\nsize = 500\nA = matrix(RR, size, size)\nfor i in range(size):\n    A[i,i] = random()\n    for j in range(8):\n        A[i,randint(0,size-1)] = random()\n\ntimeit('A*A')\n```\n\n\ngives \n\n\n```\nCPU times: user 60.72 s, sys: 0.11 s, total: 60.83 s\nWall time: 61.10 s\n500 x 500 dense matrix over Real Field with 53 bits of precision\nsage: timeit('A*A')\n5 loops, best of 3: 60.6 s per loop\n\n```\n\n\nTrying with the 100th power of a 2000*2000 matrix is impossible, according to a colleague working for linbox, taking the 100th power of such a matrix would take no more that 10 seconds.\n\nIs the interface with atlas working well ?\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10815\n\n",
    "created_at": "2011-02-21T15:14:56Z",
    "labels": [
        "linear algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Matrix multiplication and power are very slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10749",
    "user": "frieux"
}
```
Assignee: jason, was

CC:  tmonteil

Keywords: matrix, multiplication, slow

It seems that the multiplication and the power of a matrix is very slow:


```
size = 500
A = matrix(RR, size, size)
for i in range(size):
    A[i,i] = random()
    for j in range(8):
        A[i,randint(0,size-1)] = random()

timeit('A*A')
```


gives 


```
CPU times: user 60.72 s, sys: 0.11 s, total: 60.83 s
Wall time: 61.10 s
500 x 500 dense matrix over Real Field with 53 bits of precision
sage: timeit('A*A')
5 loops, best of 3: 60.6 s per loop

```


Trying with the 100th power of a 2000*2000 matrix is impossible, according to a colleague working for linbox, taking the 100th power of such a matrix would take no more that 10 seconds.

Is the interface with atlas working well ?



Issue created by migration from https://trac.sagemath.org/ticket/10815





---

archive/issue_comments_113471.json:
```json
{
    "body": "I think the issue is that you're doing the computations in RR, the Real Field with 53 bits, rather than in RDF, the Real Double Field.\n\n\n```\nfor size in [5, 10, 20, 50, 100, 200, 500, 1000, 2000]:\n    A = matrix(RDF, size, size, dense=True)\n    for i in range(size):\n        A[i,i] = random()\n        for j in range(8):\n            A[i,randint(0,size-1)] = random()\n    print 'size:', size\n    print 'time for one multiplication:'\n    timeit('A*A')\n    print 'time for A**100:'\n    timeit('A**100')\n```\n\n\ngives (on my notebook)\n\n\n```\nsize: 5\ntime for one multiplication:\n625 loops, best of 3: 79 \u00b5s per loop\ntime for A**100:\n625 loops, best of 3: 646 \u00b5s per loop\nsize: 10\ntime for one multiplication:\n625 loops, best of 3: 79.3 \u00b5s per loop\ntime for A**100:\n625 loops, best of 3: 648 \u00b5s per loop\nsize: 20\ntime for one multiplication:\n625 loops, best of 3: 83.3 \u00b5s per loop\ntime for A**100:\n625 loops, best of 3: 687 \u00b5s per loop\nsize: 50\ntime for one multiplication:\n625 loops, best of 3: 154 \u00b5s per loop\ntime for A**100:\n625 loops, best of 3: 1.26 ms per loop\nsize: 100\ntime for one multiplication:\n625 loops, best of 3: 499 \u00b5s per loop\ntime for A**100:\n125 loops, best of 3: 4.11 ms per loop\nsize: 200\ntime for one multiplication:\n125 loops, best of 3: 3.24 ms per loop\ntime for A**100:\n25 loops, best of 3: 26.2 ms per loop\nsize: 500\ntime for one multiplication:\n25 loops, best of 3: 35 ms per loop\ntime for A**100:\n5 loops, best of 3: 281 ms per loop\nsize: 1000\ntime for one multiplication:\n5 loops, best of 3: 237 ms per loop\ntime for A**100:\n5 loops, best of 3: 1.9 s per loop\nsize: 2000\ntime for one multiplication:\n5 loops, best of 3: 1.64 s per loop\ntime for A**100:\n5 loops, best of 3: 13.4 s per loop\n```\n\n\nwhich I think is pretty close to your colleague's expectation.",
    "created_at": "2011-02-21T15:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113471",
    "user": "dsm"
}
```

I think the issue is that you're doing the computations in RR, the Real Field with 53 bits, rather than in RDF, the Real Double Field.


```
for size in [5, 10, 20, 50, 100, 200, 500, 1000, 2000]:
    A = matrix(RDF, size, size, dense=True)
    for i in range(size):
        A[i,i] = random()
        for j in range(8):
            A[i,randint(0,size-1)] = random()
    print 'size:', size
    print 'time for one multiplication:'
    timeit('A*A')
    print 'time for A**100:'
    timeit('A**100')
```


gives (on my notebook)


```
size: 5
time for one multiplication:
625 loops, best of 3: 79 µs per loop
time for A**100:
625 loops, best of 3: 646 µs per loop
size: 10
time for one multiplication:
625 loops, best of 3: 79.3 µs per loop
time for A**100:
625 loops, best of 3: 648 µs per loop
size: 20
time for one multiplication:
625 loops, best of 3: 83.3 µs per loop
time for A**100:
625 loops, best of 3: 687 µs per loop
size: 50
time for one multiplication:
625 loops, best of 3: 154 µs per loop
time for A**100:
625 loops, best of 3: 1.26 ms per loop
size: 100
time for one multiplication:
625 loops, best of 3: 499 µs per loop
time for A**100:
125 loops, best of 3: 4.11 ms per loop
size: 200
time for one multiplication:
125 loops, best of 3: 3.24 ms per loop
time for A**100:
25 loops, best of 3: 26.2 ms per loop
size: 500
time for one multiplication:
25 loops, best of 3: 35 ms per loop
time for A**100:
5 loops, best of 3: 281 ms per loop
size: 1000
time for one multiplication:
5 loops, best of 3: 237 ms per loop
time for A**100:
5 loops, best of 3: 1.9 s per loop
size: 2000
time for one multiplication:
5 loops, best of 3: 1.64 s per loop
time for A**100:
5 loops, best of 3: 13.4 s per loop
```


which I think is pretty close to your colleague's expectation.



---

archive/issue_comments_113472.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2013-02-04T17:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113472",
    "user": "kcrisman"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_113473.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2013-02-04T17:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113473",
    "user": "kcrisman"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_113474.json:
```json
{
    "body": "So... what should we do here?  I think that maybe the best thing is to find more ways in various reference and tutorial sources to say \"use RDF for speed\", but I don't know how realistic that is.  Anyway, not a bug, so setting to \"needs info\".",
    "created_at": "2013-02-04T17:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113474",
    "user": "kcrisman"
}
```

So... what should we do here?  I think that maybe the best thing is to find more ways in various reference and tutorial sources to say "use RDF for speed", but I don't know how realistic that is.  Anyway, not a bug, so setting to "needs info".



---

archive/issue_comments_113475.json:
```json
{
    "body": "Changing priority from critical to minor.",
    "created_at": "2014-03-15T08:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113475",
    "user": "mmezzarobba"
}
```

Changing priority from critical to minor.



---

archive/issue_comments_113476.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-03-15T08:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113476",
    "user": "mmezzarobba"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_113477.json:
```json
{
    "body": "May also be effected by #15912.",
    "created_at": "2014-03-15T11:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113477",
    "user": "rws"
}
```

May also be effected by #15912.



---

archive/issue_comments_113478.json:
```json
{
    "body": "`@`rws: this is not related to printing, but to the fact that `RR` privides emulated floating-point arithmetics (by MPFR), which is inherently slower than CPU implementation provided by `RDF`. Moreover, some optimized libraries (like atlas) require CPU doubles to work with, and are not used in such a case.\n\nI was the one surprised by Frederic's timings. As `@`kcrisman, i think there is still an issue about misleadingly using `RR` as the default implementation of real floating point (which seems to come from its generic name).\n\nThis documentation issue should be fixed by the forthcomig tutorial #15944.",
    "created_at": "2014-03-15T13:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113478",
    "user": "tmonteil"
}
```

`@`rws: this is not related to printing, but to the fact that `RR` privides emulated floating-point arithmetics (by MPFR), which is inherently slower than CPU implementation provided by `RDF`. Moreover, some optimized libraries (like atlas) require CPU doubles to work with, and are not used in such a case.

I was the one surprised by Frederic's timings. As `@`kcrisman, i think there is still an issue about misleadingly using `RR` as the default implementation of real floating point (which seems to come from its generic name).

This documentation issue should be fixed by the forthcomig tutorial #15944.



---

archive/issue_comments_113479.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-10T06:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113479",
    "user": "rws"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_113480.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2014-05-10T20:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10749",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10749#issuecomment-113480",
    "user": "vbraun"
}
```

Resolution: wontfix
