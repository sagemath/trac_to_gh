# Issue 28013: importing libgap in a threaded environment

Issue created by migration from https://trac.sagemath.org/ticket/28250

Original creator: edgarcosta

Original creation time: 2019-07-24 14:42:57

Importing `libgap` in a threaded environment often fails.

Here is the code to recreate it

```
import threading

def An(n):
    from sage.all import AlternatingGroup
    return AlternatingGroup(n)

class MyThread(threading.Thread):
    def run(self):
        print("{} started!".format(self.getName()))
        print(An(3))
        print("{} finished!".format(self.getName()))

mythread = MyThread(name = "foo")
mythread.start()
print("main thread = %s" % An(2))
```


If I try to run the script above many times I observe three possible outcomes, I believe these depend 
depends how hast the main thread loads `libgap`

1- it works (rarely)

```
#sage -python bug3.py
foo started!
main thread = Alternating group of order 2!/2 as a permutation groupAlternating group of order 3!/2 as a permutation group

foo finished!
```


2- second most common output

```
#sage -python bug3.py
foo started!
main thread = Alternating group of order 2!/2 as a permutation group
Exception in thread foo:
Traceback (most recent call last):
  File "/Applications/sage-dev/local/lib/python2.7/threading.py", line 801, in __bootstrap_inner
    self.run()
  File "bug3.py", line 12, in run
    print(An(3))
  File "bug3.py", line 7, in An
    return AlternatingGroup(n)
  File "sage/misc/classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1734)
    return cls.classcall(cls, *args, **kwds)
  File "/Applications/sage-dev/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup_named.py", line 200, in __classcall__
    return super(PermutationGroup_symalt, cls).__classcall__(cls, domain=v)
  File "sage/misc/cachefunc.pyx", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6010)
    w = self.f(*args, **kwds)
  File "/Applications/sage-dev/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup_named.py", line 145, in __classcall__
    return super(PermutationGroup_unique, cls).__classcall__(cls, *args, **kwds)
  File "sage/misc/cachefunc.pyx", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6010)
    w = self.f(*args, **kwds)
  File "/Applications/sage-dev/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
    instance = typecall(cls, *args, **options)
  File "sage/misc/classcall_metaclass.pyx", line 497, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2184)
    return (<PyTypeObject*>type).tp_call(cls, args, kwds)
  File "/Applications/sage-dev/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup_named.py", line 662, in __init__
    PermutationGroup_symalt.__init__(self, gap_group='AlternatingGroup(%s)' % len(domain), domain=domain)
  File "/Applications/sage-dev/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 418, in __init__
    super(PermutationGroup_generic, self).__init__(category=category)
  File "sage/groups/group.pyx", line 281, in sage.groups.group.FiniteGroup.__init__ (build/cythonized/sage/groups/group.c:3717)
    raise ValueError("%s is not a subcategory of %s" % (category, FiniteGroups()))
ValueError: (Join of Category of finite enumerated permutation groups and Category of finite finitely generated semigroups,) is not a subcategory of Category of finite groups
```


3 - a signal is unhandled (most common output)

```
#sage -python bug3.py
foo started!
Exception in thread foo:
Traceback (most recent call last):
  File "/Applications/sage-dev/local/lib/python2.7/threading.py", line 801, in __bootstrap_inner
    self.run()
  File "bug3.py", line 12, in run
    print(An(3))
  File "bug3.py", line 6, in An
    from sage.all import AlternatingGroup
  File "/Applications/sage-dev/local/lib/python2.7/site-packages/sage/all.py", line 76, in <module>
    from cysignals.signals import (AlarmInterrupt, SignalError,
  File "/Applications/sage-dev/local/lib/python2.7/site-packages/cysignals/__init__.py", line 3, in <module>
    init_cysignals()
  File "src/cysignals/signals.pyx", line 251, in cysignals.signals.init_cysignals
ValueError: signal only works in main thread

main thread = Alternating group of order 2!/2 as a permutation group
```


If one comments out the last line of the script above, I always observe the last outcome.


---

Comment by edgarcosta created at 2019-07-24 14:44:12

Changing type from PLEASE CHANGE to defect.


---

Comment by embray created at 2019-09-04 09:35:59

Python-level multi-threading is basically not supported in Sage except for code that doesn't need to use subsystems like GAP or PARI.  See in fact the very recent discussion at https://github.com/OpenDreamKit/OpenDreamKit/issues/60

I'm tempted to close this ticket as "wontfix", not because it wouldn't be desirable to fix this, but more to do with the fact that it's a known issue.


---

Comment by embray created at 2019-09-04 09:36:22

Changing keywords from "" to "libgap".


---

Comment by edgarcosta created at 2019-09-04 13:32:01

I won't object against a "wontfix", perhaps we could add some documentation somewhere mentioning the issue.


---

Comment by embray created at 2019-09-04 14:33:36

I agree, though it's hard to know where, or exactly what to document.  That's worth thinking about though.
