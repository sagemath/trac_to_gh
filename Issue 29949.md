# Issue 29949: containment check for standard bracketed lyndon words does not work

archive/issues_029949.json:
```json
{
    "body": "Keywords: Standard bracketed Lyndon words\n\n\n```\nsage: SBLW33 = StandardBracketedLyndonWords(3,3)\nsage: SBLW33.an_element() in SBLW33\nFalse\nsage: SBLW33.random_element() in SBLW33\nFalse\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30186\n\n",
    "created_at": "2020-07-21T07:06:57Z",
    "labels": [
        "combinatorics",
        "major",
        "bug"
    ],
    "title": "containment check for standard bracketed lyndon words does not work",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29949",
    "user": "@kliem"
}
```
Keywords: Standard bracketed Lyndon words


```
sage: SBLW33 = StandardBracketedLyndonWords(3,3)
sage: SBLW33.an_element() in SBLW33
False
sage: SBLW33.random_element() in SBLW33
False
```


Issue created by migration from https://trac.sagemath.org/ticket/30186





---

archive/issue_comments_425445.json:
```json
{
    "body": "In an ideal words, this should be implemented. If not, than it should raise a `NotImplementedError` instead of returning wrong things.",
    "created_at": "2020-07-21T07:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425445",
    "user": "@kliem"
}
```

In an ideal words, this should be implemented. If not, than it should raise a `NotImplementedError` instead of returning wrong things.



---

archive/issue_comments_425446.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-15T11:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425446",
    "user": "@mrejmon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_425447.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-02-15T11:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425447",
    "user": "@mrejmon"
}
```

New commits:



---

archive/issue_comments_425448.json:
```json
{
    "body": "\n```\n+        # If x = st is a standard Lyndon factorization, and y is a Lyndon word\n+        # such that y <= t, then xy is standard (but not necessarily Lyndon).\n+        if x < y and (len(t) == 0 or y <= t):\n+            x += y\n+            return x, y\n```\n\n\nThere is a couple of things here. The way I understand it, the check should be that `y >= t`??\n\nIf I'm not mistaking, then checking whether `len(t) == 0` is also redundant.\n\nI also would prefer to return `x + y, y` over adding `y` to `x`. This seems more transparent to me.",
    "created_at": "2021-02-15T11:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425448",
    "user": "@kliem"
}
```


```
+        # If x = st is a standard Lyndon factorization, and y is a Lyndon word
+        # such that y <= t, then xy is standard (but not necessarily Lyndon).
+        if x < y and (len(t) == 0 or y <= t):
+            x += y
+            return x, y
```


There is a couple of things here. The way I understand it, the check should be that `y >= t`??

If I'm not mistaking, then checking whether `len(t) == 0` is also redundant.

I also would prefer to return `x + y, y` over adding `y` to `x`. This seems more transparent to me.



---

archive/issue_comments_425449.json:
```json
{
    "body": "Replying to [comment:4 gh-kliem]:\n> {{{\n> +        # If x = st is a standard Lyndon factorization, and y is a Lyndon word\n> +        # such that y <= t, then xy is standard (but not necessarily Lyndon).\n> +        if x < y and (len(t) == 0 or y <= t):\n> +            x += y\n> +            return x, y\n> }}}\n> \n> There is a couple of things here. The way I understand it, the check should be that `y >= t`??\n> \n> If I'm not mistaking, then checking whether `len(t) == 0` is also redundant.\n\nWith y >= t ((1, 2), 3) would pass as valid since 3 >= 2, but the correct bracketing is (1, (2, 3)). I didn't come up with y <= t myself so I'm not entirely sure why it works, I got it from [here](https://www.sciencedirect.com/science/article/pii/S0195669805001629), section 4.2, end of second paragraph. I tested it quite extensively though on words of length < 10 and it seems to work correctly.\n\n> I also would prefer to return `x + y, y` over adding `y` to `x`. This seems more transparent to me.\n\nI used `x += y` since extending the list should be slightly faster then creating a new one in some cases, and similar in other. Running:\n\n\n```\nsage: from sage.combinat.words.lyndon_word import standard_bracketing, standard_unbracketing\nsage: w1 = standard_bracketing(Word('1222222222'))\nsage: %timeit standard_unbracketing(w1)\nsage: w2 = standard_bracketing(Word('1111111112'))\nsage: %timeit standard_unbracketing(w2)\n```\n\n\nwith `x += y; return x, y` prints for example:\n\n\n```\n5.64 \u00b5s \u00b1 72.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n5.31 \u00b5s \u00b1 19.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n\nwhile with `return x + y, y` prints for example:\n\n\n```\n5.95 \u00b5s \u00b1 16.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n5.48 \u00b5s \u00b1 5.17 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n\nI agree that it is less readable.",
    "created_at": "2021-02-15T14:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425449",
    "user": "@mrejmon"
}
```

Replying to [comment:4 gh-kliem]:
> {{{
> +        # If x = st is a standard Lyndon factorization, and y is a Lyndon word
> +        # such that y <= t, then xy is standard (but not necessarily Lyndon).
> +        if x < y and (len(t) == 0 or y <= t):
> +            x += y
> +            return x, y
> }}}
> 
> There is a couple of things here. The way I understand it, the check should be that `y >= t`??
> 
> If I'm not mistaking, then checking whether `len(t) == 0` is also redundant.

With y >= t ((1, 2), 3) would pass as valid since 3 >= 2, but the correct bracketing is (1, (2, 3)). I didn't come up with y <= t myself so I'm not entirely sure why it works, I got it from [here](https://www.sciencedirect.com/science/article/pii/S0195669805001629), section 4.2, end of second paragraph. I tested it quite extensively though on words of length < 10 and it seems to work correctly.

> I also would prefer to return `x + y, y` over adding `y` to `x`. This seems more transparent to me.

I used `x += y` since extending the list should be slightly faster then creating a new one in some cases, and similar in other. Running:


```
sage: from sage.combinat.words.lyndon_word import standard_bracketing, standard_unbracketing
sage: w1 = standard_bracketing(Word('1222222222'))
sage: %timeit standard_unbracketing(w1)
sage: w2 = standard_bracketing(Word('1111111112'))
sage: %timeit standard_unbracketing(w2)
```


with `x += y; return x, y` prints for example:


```
5.64 µs ± 72.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
5.31 µs ± 19.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


while with `return x + y, y` prints for example:


```
5.95 µs ± 16.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
5.48 µs ± 5.17 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


I agree that it is less readable.



---

archive/issue_comments_425450.json:
```json
{
    "body": "Thank you for explaining. At least I understand what standard bracketed lyndon words are. Learnt something new today.\n\nI guess the benchmarking is reason enough for the code the way it is. It is not that hard to read.",
    "created_at": "2021-02-15T19:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425450",
    "user": "@kliem"
}
```

Thank you for explaining. At least I understand what standard bracketed lyndon words are. Learnt something new today.

I guess the benchmarking is reason enough for the code the way it is. It is not that hard to read.



---

archive/issue_comments_425451.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-15T19:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425451",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_425452.json:
```json
{
    "body": "Thank you for implementing this.",
    "created_at": "2021-02-15T19:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425452",
    "user": "@kliem"
}
```

Thank you for implementing this.



---

archive/issue_comments_425453.json:
```json
{
    "body": "Thanks for your fast review!",
    "created_at": "2021-02-16T12:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425453",
    "user": "@mrejmon"
}
```

Thanks for your fast review!



---

archive/issue_comments_425454.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-02-16T12:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425454",
    "user": "@kliem"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_425455.json:
```json
{
    "body": "Actually, on second thought, I don't really like returning `[]` when the function should have raised an error.\n\nCould you change to something like:\n\n\n```diff\n     def standard_unbracketing_rec(w):\n         if not isinstance(w, list):\n             return [w], []\n         if len(w) != 2:\n-            return [], []\n+            raise ValueError(\"not a standard brackening\")\n         x, t = standard_unbracketing_rec(w[0])\n-        if not x:\n-            return [], []\n         y, _ = standard_unbracketing_rec(w[1])\n-        if not y:\n-            return [], []\n         # If x = st is a standard Lyndon factorization, and y is a Lyndon word\n         # such that y <= t, then xy is standard (but not necessarily Lyndon).\n         if x < y and (len(t) == 0 or y <= t):\n             x += y\n             return x, y\n         else:\n-            return [], []\n+            raise ValueError(\"not a standard brackening\")\n```\n\nThe method `__contains__` then needs to catch this error, but I think an error raising is appropriate here, because `standard_unbracketing` might be used on its own.",
    "created_at": "2021-02-16T12:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425455",
    "user": "@kliem"
}
```

Actually, on second thought, I don't really like returning `[]` when the function should have raised an error.

Could you change to something like:


```diff
     def standard_unbracketing_rec(w):
         if not isinstance(w, list):
             return [w], []
         if len(w) != 2:
-            return [], []
+            raise ValueError("not a standard brackening")
         x, t = standard_unbracketing_rec(w[0])
-        if not x:
-            return [], []
         y, _ = standard_unbracketing_rec(w[1])
-        if not y:
-            return [], []
         # If x = st is a standard Lyndon factorization, and y is a Lyndon word
         # such that y <= t, then xy is standard (but not necessarily Lyndon).
         if x < y and (len(t) == 0 or y <= t):
             x += y
             return x, y
         else:
-            return [], []
+            raise ValueError("not a standard brackening")
```

The method `__contains__` then needs to catch this error, but I think an error raising is appropriate here, because `standard_unbracketing` might be used on its own.



---

archive/issue_comments_425456.json:
```json
{
    "body": "While implementing that I had another idea: rename `standard_unbracketing` to `is_standard_bracketing` (`is_standard_bracketed`?) and have it return !True/False, but also have a boolean parameter `return_word` with default value False, which would cause the method to return a pair of for example `True, [1, 2, 3]` or `False, None`. Or I could just hide it inside the ```__contains__``` method. What do you think?",
    "created_at": "2021-02-16T14:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425456",
    "user": "@mrejmon"
}
```

While implementing that I had another idea: rename `standard_unbracketing` to `is_standard_bracketing` (`is_standard_bracketed`?) and have it return !True/False, but also have a boolean parameter `return_word` with default value False, which would cause the method to return a pair of for example `True, [1, 2, 3]` or `False, None`. Or I could just hide it inside the ```__contains__``` method. What do you think?



---

archive/issue_comments_425457.json:
```json
{
    "body": "I think `standard_unbracketing` should really return a finite word with the correct alphabet and raise an error if this is not a standard_bracketing`.\n\nI don't see the advantage in adding an extra keyword and having various types of ouput. Return the word raise an error if the bracketing is incorrect or the word isn't lyndon should be fine for most purposes.\n\nThere is a couple of things to fix yet; probably not in this ticket:\n\n- \n\n```\nsage: S = StandardBracketedLyndonWords(2, 4)                                                                                                                                        \nsage: S([1,2])                                                                                                                                                                      \n[1, 2]\nsage: S.random_element()                                                                                                                                                            \n[1, [1, [1, 2]]]\nsage: S([1,2,2,2])                                                                                                                                                                  \n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-71-bd319410246c> in <module>\n----> 1 S([Integer(1),Integer(2),Integer(2),Integer(2)])\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)\n    538             [1, [2, 3]]\n    539         \"\"\"\n--> 540         return standard_bracketing(self._lyndon(*args, **kwds))\n    541 \n    542     def __iter__(self):\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)\n    415             raise ValueError(\"not a Lyndon word\")\n    416         if w.length() != self._n:\n--> 417             raise ValueError(\"length is not n={}\".format(self._n))\n    418         return w\n    419 \n\nValueError: length is not n=2\n```\n\n  This really is caused by an underlying bug:\n\n```\nsage: L = LyndonWords(2,4); L                                                                                                                                                       \nLyndon words from an alphabet of size 2 of length 4\nsage: L.random_element()                                                                                                                                                            \nword: 1222\nsage: L([1,2])                                                                                                                                                                      \nword: 12\nsage: L([1,2,2,2])                                                                                                                                                                  \n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-82-0ddb9da93b95> in <module>\n----> 1 L([Integer(1),Integer(2),Integer(2),Integer(2)])\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)\n    415             raise ValueError(\"not a Lyndon word\")\n    416         if w.length() != self._n:\n--> 417             raise ValueError(\"length is not n={}\".format(self._n))\n    418         return w\n    419 \n\nValueError: length is not n=2\n```\n\n\n- `__contains__` is missing for most classes in this module. It can usually fixed by just `try ... except` calling `__call__`. Maybe not super efficient, but it works.",
    "created_at": "2021-02-16T17:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425457",
    "user": "@kliem"
}
```

I think `standard_unbracketing` should really return a finite word with the correct alphabet and raise an error if this is not a standard_bracketing`.

I don't see the advantage in adding an extra keyword and having various types of ouput. Return the word raise an error if the bracketing is incorrect or the word isn't lyndon should be fine for most purposes.

There is a couple of things to fix yet; probably not in this ticket:

- 

```
sage: S = StandardBracketedLyndonWords(2, 4)                                                                                                                                        
sage: S([1,2])                                                                                                                                                                      
[1, 2]
sage: S.random_element()                                                                                                                                                            
[1, [1, [1, 2]]]
sage: S([1,2,2,2])                                                                                                                                                                  
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-71-bd319410246c> in <module>
----> 1 S([Integer(1),Integer(2),Integer(2),Integer(2)])

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)
    538             [1, [2, 3]]
    539         """
--> 540         return standard_bracketing(self._lyndon(*args, **kwds))
    541 
    542     def __iter__(self):

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)
    415             raise ValueError("not a Lyndon word")
    416         if w.length() != self._n:
--> 417             raise ValueError("length is not n={}".format(self._n))
    418         return w
    419 

ValueError: length is not n=2
```

  This really is caused by an underlying bug:

```
sage: L = LyndonWords(2,4); L                                                                                                                                                       
Lyndon words from an alphabet of size 2 of length 4
sage: L.random_element()                                                                                                                                                            
word: 1222
sage: L([1,2])                                                                                                                                                                      
word: 12
sage: L([1,2,2,2])                                                                                                                                                                  
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-82-0ddb9da93b95> in <module>
----> 1 L([Integer(1),Integer(2),Integer(2),Integer(2)])

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)
    415             raise ValueError("not a Lyndon word")
    416         if w.length() != self._n:
--> 417             raise ValueError("length is not n={}".format(self._n))
    418         return w
    419 

ValueError: length is not n=2
```


- `__contains__` is missing for most classes in this module. It can usually fixed by just `try ... except` calling `__call__`. Maybe not super efficient, but it works.



---

archive/issue_comments_425458.json:
```json
{
    "body": "Replying to [comment:11 gh-kliem]:\n> I think `standard_unbracketing` should really return a finite word with the correct alphabet and raise an error if this is not a standard_bracketing`.\n\nBy correct alphabet you mean something like this?\n\n```\nres = ...\nreturn FiniteWords(list(set(res)))(res, datatype=list, check=False)\n```\n\n\n> I don't see the advantage in adding an extra keyword and having various types of ouput. Return the word raise an error if the bracketing is incorrect or the word isn't lyndon should be fine for most purposes.\n\nAlright, I'll change it later.\n\n> There is a couple of things to fix yet; probably not in this ticket:\n> \n> - \n> {{{\n> ... \n> ValueError: length is not n=2\n> }}}\n\nDefinitely. I'll create a ticket for it after this is done, unless you want to do it.\n\n> - `__contains__` is missing for most classes in this module. It can usually fixed by just `try ... except` calling `__call__`. Maybe not super efficient, but it works.\n\nThis however, it seems to me there are 4 classes in this file and 3 of them already have `__contains__` (and this branch adds the last one)?",
    "created_at": "2021-02-17T14:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425458",
    "user": "@mrejmon"
}
```

Replying to [comment:11 gh-kliem]:
> I think `standard_unbracketing` should really return a finite word with the correct alphabet and raise an error if this is not a standard_bracketing`.

By correct alphabet you mean something like this?

```
res = ...
return FiniteWords(list(set(res)))(res, datatype=list, check=False)
```


> I don't see the advantage in adding an extra keyword and having various types of ouput. Return the word raise an error if the bracketing is incorrect or the word isn't lyndon should be fine for most purposes.

Alright, I'll change it later.

> There is a couple of things to fix yet; probably not in this ticket:
> 
> - 
> {{{
> ... 
> ValueError: length is not n=2
> }}}

Definitely. I'll create a ticket for it after this is done, unless you want to do it.

> - `__contains__` is missing for most classes in this module. It can usually fixed by just `try ... except` calling `__call__`. Maybe not super efficient, but it works.

This however, it seems to me there are 4 classes in this file and 3 of them already have `__contains__` (and this branch adds the last one)?



---

archive/issue_comments_425459.json:
```json
{
    "body": "Oh yes, I missed those `__contains__` methods. I think I got confused by the case where `__call__` does the wrong thing.",
    "created_at": "2021-02-17T14:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425459",
    "user": "@kliem"
}
```

Oh yes, I missed those `__contains__` methods. I think I got confused by the case where `__call__` does the wrong thing.



---

archive/issue_comments_425460.json:
```json
{
    "body": "Yes, this I mean by correct alphabet. In that bracketing and unbracketing would be almost inverses then.",
    "created_at": "2021-02-17T14:54:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425460",
    "user": "@kliem"
}
```

Yes, this I mean by correct alphabet. In that bracketing and unbracketing would be almost inverses then.



---

archive/issue_comments_425461.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-18T10:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425461",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425462.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-18T11:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425462",
    "user": "@mrejmon"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_425463.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-02-18T16:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425463",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_425464.json:
```json
{
    "body": "Sorry about being misleading:\n\nThere is a problem with the alphabet length. In case of the word `13` you will actually return true for lyndon words over `{1, 2}`.\n\nMaybe we really fix everything here, because it appears to be just small typos:\n\nAround line 416:\n\n\n```diff\n-        if w.length() != self._n:\n-            raise ValueError(\"length is not n={}\".format(self._n))\n+        if w.length() != self._k:\n+            raise ValueError(\"length is not k={}\".format(self._k))\n```\n\nand a corresponding doctest.\n\nAround line 428\n\n\n```diff\n         if isinstance(w, list):\n             w = self._words(w)\n-        return w in self._words and w.length() == self._k and len(set(w)) <= self._n\n+        return w in self._words and w.length() == self._k and w.is_lyndon()\n```\n\n\nthis is a redundant and confusing thing. It is already taken care of by `w in self._words` and besides the length of the set of the alphabet doesn't mean a lot.\nAnd the actual important thing is completely missed.\n\nAnd then we treat our case likewise:\n\n\n```\n        try:\n            lw = standard_unbracketing(sblw)\n        except ValueError:\n            return False\n        return len(lw) == self._k and lw in self._lyndon._words\n```\n\n\nDoes this sound plausible?",
    "created_at": "2021-02-18T16:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425464",
    "user": "@kliem"
}
```

Sorry about being misleading:

There is a problem with the alphabet length. In case of the word `13` you will actually return true for lyndon words over `{1, 2}`.

Maybe we really fix everything here, because it appears to be just small typos:

Around line 416:


```diff
-        if w.length() != self._n:
-            raise ValueError("length is not n={}".format(self._n))
+        if w.length() != self._k:
+            raise ValueError("length is not k={}".format(self._k))
```

and a corresponding doctest.

Around line 428


```diff
         if isinstance(w, list):
             w = self._words(w)
-        return w in self._words and w.length() == self._k and len(set(w)) <= self._n
+        return w in self._words and w.length() == self._k and w.is_lyndon()
```


this is a redundant and confusing thing. It is already taken care of by `w in self._words` and besides the length of the set of the alphabet doesn't mean a lot.
And the actual important thing is completely missed.

And then we treat our case likewise:


```
        try:
            lw = standard_unbracketing(sblw)
        except ValueError:
            return False
        return len(lw) == self._k and lw in self._lyndon._words
```


Does this sound plausible?



---

archive/issue_comments_425465.json:
```json
{
    "body": "I can also do those changes, if you like.",
    "created_at": "2021-02-19T12:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425465",
    "user": "@kliem"
}
```

I can also do those changes, if you like.



---

archive/issue_comments_425466.json:
```json
{
    "body": "Oh wow, I got confused by the `len(set(w)) <= self._n` and thought `LyndonWords(2, 2)` would also accept `word: 13`, so I implemented it the same way, but that is not the case.\n\nThe problem with `lw in self._lyndon._words` is that `__contains__` for `FiniteWords` is weird, and only returns true if the alphabets match exactly, so since\n\n```\nsage: F = FiniteWords(alphabet=[1, 2, 3])\nsage: Word([1, 2, 2]) in F\nFalse\nsage: Word([1, 2, 2], alphabet=[1, 2]) in F\nFalse\nsage: Word([1, 2, 2], alphabet=[1, 2, 3]) in F\nTrue\n```\n\n`[[1, 2], 2] in StandardBracketedLyndonWords(3, 3)` would also return false.\n\nWe could fix this by doing for example\n\n```\n        try:\n            lw = standard_unbracketing(sblw)\n        except ValueError:\n            return False\n        return len(lw) == self._k and all(1 <= x <= self._n for x in lw)\n```\n\nbut\n\n```\nall(standard_unbracketing(standard_bracketing(u)) in LyndonWords(3, 3) for u in LyndonWords(3,3))\n```\n\nwould still return false (as it does right now). So I think we should revert `standard_unbracketing` and make it return a list again? Or we could similarly modify `__contains__` for `LyndonWords_nk`.\n\nAlso I noticed that `[1, 3] in LyndonWords(2, 2)` throws an exception instead of returning false, which is a little weird.",
    "created_at": "2021-02-19T15:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425466",
    "user": "@mrejmon"
}
```

Oh wow, I got confused by the `len(set(w)) <= self._n` and thought `LyndonWords(2, 2)` would also accept `word: 13`, so I implemented it the same way, but that is not the case.

The problem with `lw in self._lyndon._words` is that `__contains__` for `FiniteWords` is weird, and only returns true if the alphabets match exactly, so since

```
sage: F = FiniteWords(alphabet=[1, 2, 3])
sage: Word([1, 2, 2]) in F
False
sage: Word([1, 2, 2], alphabet=[1, 2]) in F
False
sage: Word([1, 2, 2], alphabet=[1, 2, 3]) in F
True
```

`[[1, 2], 2] in StandardBracketedLyndonWords(3, 3)` would also return false.

We could fix this by doing for example

```
        try:
            lw = standard_unbracketing(sblw)
        except ValueError:
            return False
        return len(lw) == self._k and all(1 <= x <= self._n for x in lw)
```

but

```
all(standard_unbracketing(standard_bracketing(u)) in LyndonWords(3, 3) for u in LyndonWords(3,3))
```

would still return false (as it does right now). So I think we should revert `standard_unbracketing` and make it return a list again? Or we could similarly modify `__contains__` for `LyndonWords_nk`.

Also I noticed that `[1, 3] in LyndonWords(2, 2)` throws an exception instead of returning false, which is a little weird.



---

archive/issue_comments_425467.json:
```json
{
    "body": "I think that `__contains__` behaves weird is just the next bug.\n\nThe problem with `1 <= x <= self._n` is that it might just raise the next error message, if `x` is a letter. However, you can ask `x in range(1, self._n + 1)`, which is exactly what we want.",
    "created_at": "2021-02-19T15:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425467",
    "user": "@kliem"
}
```

I think that `__contains__` behaves weird is just the next bug.

The problem with `1 <= x <= self._n` is that it might just raise the next error message, if `x` is a letter. However, you can ask `x in range(1, self._n + 1)`, which is exactly what we want.



---

archive/issue_comments_425468.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-20T12:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425468",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425469.json:
```json
{
    "body": "I fixed the bugs you mentioned above + in the meantime I replaced `w in self._words` with a manual alphabet check in all classes.\n\nReplying to [comment:20 gh-kliem]:\n> I think that `__contains__` behaves weird is just the next bug.\n\nI think that was done on purpose a long time ago, see #15481. Doesn't mean it can't get changed though.\n\n> The problem with `1 <= x <= self._n` is that it might just raise the next error message, if `x` is a letter. However, you can ask `x in range(1, self._n + 1)`, which is exactly what we want.\n\nRight, in the end I used `x in self._words.alphabet()`.",
    "created_at": "2021-02-20T12:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425469",
    "user": "@mrejmon"
}
```

I fixed the bugs you mentioned above + in the meantime I replaced `w in self._words` with a manual alphabet check in all classes.

Replying to [comment:20 gh-kliem]:
> I think that `__contains__` behaves weird is just the next bug.

I think that was done on purpose a long time ago, see #15481. Doesn't mean it can't get changed though.

> The problem with `1 <= x <= self._n` is that it might just raise the next error message, if `x` is a letter. However, you can ask `x in range(1, self._n + 1)`, which is exactly what we want.

Right, in the end I used `x in self._words.alphabet()`.



---

archive/issue_comments_425470.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-20T12:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425470",
    "user": "@mrejmon"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_425471.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-20T13:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425471",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425472.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-20T15:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425472",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425473.json:
```json
{
    "body": "Alright, now all `LyndonWords*.__contains__` should never throw an exception (and also shouldn't make decisions based on the alphabet of inputted words).",
    "created_at": "2021-02-20T15:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425473",
    "user": "@mrejmon"
}
```

Alright, now all `LyndonWords*.__contains__` should never throw an exception (and also shouldn't make decisions based on the alphabet of inputted words).



---

archive/issue_comments_425474.json:
```json
{
    "body": "You should add a test that this is fixed:\n\n\n```\nsage: S = StandardBracketedLyndonWords(2, 4)                                                                                                                                        \nsage: S([1,2])                                                                                                                                                                      \n[1, 2]\nsage: S(S.random_element())                                                                                                                                                         \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-601071e1255f> in <module>\n----> 1 S(S.random_element())\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)\n    538             [1, [2, 3]]\n    539         \"\"\"\n--> 540         return standard_bracketing(self._lyndon(*args, **kwds))\n    541 \n    542     def __iter__(self):\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)\n    411             ValueError: length is not n=3\n    412         \"\"\"\n--> 413         w = self._words(*args, **kwds)\n    414         if kwds.get('check', True) and not w.is_lyndon():\n    415             raise ValueError(\"not a Lyndon word\")\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/words.py in __call__(self, data, length, datatype, caching, check)\n    816             elif not isinstance(data, (tuple, list)):\n    817                 data = list(data)\n--> 818             w = self._element_classes['char'](self, data)\n    819 \n    820         elif isinstance(data, list):\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/word_char.pyx in sage.combinat.words.word_char.WordDatatype_char.__init__ (build/cythonized/sage/combinat/words/word_char.c:3732)()\n     95             data = list(data)\n     96         if data:\n---> 97             self._set_data(data)\n     98 \n     99     @cython.boundscheck(False) # assume that indexing will not cause any IndexErrors\n\n/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/word_char.pyx in sage.combinat.words.word_char.WordDatatype_char._set_data (build/cythonized/sage/combinat/words/word_char.c:3831)()\n    109 \n    110         for i in range(self._length):\n--> 111             self._data[i] = data[i]\n    112 \n    113     def __dealloc__(self):\n\nTypeError: an integer is required\n```\n\n\nMaybe something like this:\n\n\n```\nCheck that the correct length is checked when calling; see :trac:`30186`::\n\n    sage: L = LyndonWonds(2, 4)\n    sage: _ = L(L.random_element())\n```\n",
    "created_at": "2021-02-23T08:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425474",
    "user": "@kliem"
}
```

You should add a test that this is fixed:


```
sage: S = StandardBracketedLyndonWords(2, 4)                                                                                                                                        
sage: S([1,2])                                                                                                                                                                      
[1, 2]
sage: S(S.random_element())                                                                                                                                                         
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-601071e1255f> in <module>
----> 1 S(S.random_element())

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)
    538             [1, [2, 3]]
    539         """
--> 540         return standard_bracketing(self._lyndon(*args, **kwds))
    541 
    542     def __iter__(self):

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/lyndon_word.py in __call__(self, *args, **kwds)
    411             ValueError: length is not n=3
    412         """
--> 413         w = self._words(*args, **kwds)
    414         if kwds.get('check', True) and not w.is_lyndon():
    415             raise ValueError("not a Lyndon word")

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/words.py in __call__(self, data, length, datatype, caching, check)
    816             elif not isinstance(data, (tuple, list)):
    817                 data = list(data)
--> 818             w = self._element_classes['char'](self, data)
    819 
    820         elif isinstance(data, list):

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/word_char.pyx in sage.combinat.words.word_char.WordDatatype_char.__init__ (build/cythonized/sage/combinat/words/word_char.c:3732)()
     95             data = list(data)
     96         if data:
---> 97             self._set_data(data)
     98 
     99     @cython.boundscheck(False) # assume that indexing will not cause any IndexErrors

/srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/combinat/words/word_char.pyx in sage.combinat.words.word_char.WordDatatype_char._set_data (build/cythonized/sage/combinat/words/word_char.c:3831)()
    109 
    110         for i in range(self._length):
--> 111             self._data[i] = data[i]
    112 
    113     def __dealloc__(self):

TypeError: an integer is required
```


Maybe something like this:


```
Check that the correct length is checked when calling; see :trac:`30186`::

    sage: L = LyndonWonds(2, 4)
    sage: _ = L(L.random_element())
```




---

archive/issue_comments_425475.json:
```json
{
    "body": "Otherwise this looks good.",
    "created_at": "2021-02-23T08:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425475",
    "user": "@kliem"
}
```

Otherwise this looks good.



---

archive/issue_comments_425476.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-26T09:42:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425476",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425477.json:
```json
{
    "body": "Replying to [comment:27 gh-kliem]:\n> You should add a test that this is fixed:\n>\n> ...\n>\n> Maybe something like this:\n> \n> {{{\n> Check that the correct length is checked when calling; see :trac:`30186`::\n> \n>     sage: L = LyndonWonds(2, 4)\n>     sage: _ = L(L.random_element())\n> }}}\n\nDone.",
    "created_at": "2021-02-26T09:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425477",
    "user": "@mrejmon"
}
```

Replying to [comment:27 gh-kliem]:
> You should add a test that this is fixed:
>
> ...
>
> Maybe something like this:
> 
> {{{
> Check that the correct length is checked when calling; see :trac:`30186`::
> 
>     sage: L = LyndonWonds(2, 4)
>     sage: _ = L(L.random_element())
> }}}

Done.



---

archive/issue_comments_425478.json:
```json
{
    "body": "LGTM.",
    "created_at": "2021-02-26T10:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425478",
    "user": "@kliem"
}
```

LGTM.



---

archive/issue_comments_425479.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-26T10:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425479",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_425480.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-07T17:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425480",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_425481.json:
```json
{
    "body": "Note: the `__contains__` method has `EXAMPLES:` instead of `EXAMPLES::`.\n\nThis means that examples block will not be doctested.\n\nPlease fix in follow-up ticket #31462.",
    "created_at": "2021-03-07T18:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29949",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29949#issuecomment-425481",
    "user": "slelievre"
}
```

Note: the `__contains__` method has `EXAMPLES:` instead of `EXAMPLES::`.

This means that examples block will not be doctested.

Please fix in follow-up ticket #31462.
