# Issue 29771: sphinx 3.0.4 does not build on centos 7

archive/issues_029771.json:
```json
{
    "body": "CC:  @vbraun @dimpase @orlitzky @jhpalmieri @seblabbe\n\n```\n/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory\n/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)\nFound local metadata for sphinx-3.0.4.p0\nbash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)\nAttempting to download package Sphinx-3.0.4.tar.gz from mirrors\nhttp://mirrors.xmission.com/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz\n[......................................................................]\nsphinx-3.0.4.p0\n====================================================\nSetting up build directory for sphinx-3.0.4.p0\nbash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)\nTraceback (most recent call last):\n  File \"/sage/build/bin/sage-uncompress-spkg\", line 23, in <module>\n    run()\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py\", line 72, in run\n    unpack_archive(archive, dirname)\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/action.py\", line 68, in unpack_archive\n    archive.extractall(members=archive.names)\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 96, in extractall\n    **kwargs)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2010, in extractall\n    numeric_owner=numeric_owner)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2052, in extract\n    numeric_owner=numeric_owner)\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 122, in _extract_member\n    **kwargs)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2122, in _extract_member\n    self.makefile(tarinfo, targetpath)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2163, in makefile\n    with bltn_open(targetpath, \"wb\") as target:\nUnicodeEncodeError: 'ascii' codec can't encode character '\\xe4' in position 45: ordinal not in range(128)\n************************************************************************\nError: failed to extract /sage/upstream/Sphinx-3.0.4.tar.gz\n************************************************************************\nPlease email sage-devel (http://groups.google.com/group/sage-devel)\nexplaining the problem and including the log file\n  /sage/logs/pkgs/sphinx-3.0.4.p0.log\nDescribe your computer, operating system, etc.\n************************************************************************\n```\n\nSee e.g. https://github.com/sagemath/sage/runs/811777719?check_suite_focus=true\n\nIssue created by migration from https://trac.sagemath.org/ticket/30008\n\n",
    "created_at": "2020-06-28T12:44:02Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "sphinx 3.0.4 does not build on centos 7",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29771",
    "user": "https://github.com/kliem"
}
```
CC:  @vbraun @dimpase @orlitzky @jhpalmieri @seblabbe

```
/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Found local metadata for sphinx-3.0.4.p0
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Attempting to download package Sphinx-3.0.4.tar.gz from mirrors
http://mirrors.xmission.com/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz
[......................................................................]
sphinx-3.0.4.p0
====================================================
Setting up build directory for sphinx-3.0.4.p0
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Traceback (most recent call last):
  File "/sage/build/bin/sage-uncompress-spkg", line 23, in <module>
    run()
  File "/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py", line 72, in run
    unpack_archive(archive, dirname)
  File "/sage/build/bin/../sage_bootstrap/uncompress/action.py", line 68, in unpack_archive
    archive.extractall(members=archive.names)
  File "/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 96, in extractall
    **kwargs)
  File "/usr/lib64/python3.6/tarfile.py", line 2010, in extractall
    numeric_owner=numeric_owner)
  File "/usr/lib64/python3.6/tarfile.py", line 2052, in extract
    numeric_owner=numeric_owner)
  File "/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 122, in _extract_member
    **kwargs)
  File "/usr/lib64/python3.6/tarfile.py", line 2122, in _extract_member
    self.makefile(tarinfo, targetpath)
  File "/usr/lib64/python3.6/tarfile.py", line 2163, in makefile
    with bltn_open(targetpath, "wb") as target:
UnicodeEncodeError: 'ascii' codec can't encode character '\xe4' in position 45: ordinal not in range(128)
************************************************************************
Error: failed to extract /sage/upstream/Sphinx-3.0.4.tar.gz
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /sage/logs/pkgs/sphinx-3.0.4.p0.log
Describe your computer, operating system, etc.
************************************************************************
```

See e.g. https://github.com/sagemath/sage/runs/811777719?check_suite_focus=true

Issue created by migration from https://trac.sagemath.org/ticket/30008





---

archive/issue_comments_422394.json:
```json
{
    "body": "That's a very strange error",
    "created_at": "2020-06-28T15:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422394",
    "user": "https://github.com/mkoeppe"
}
```

That's a very strange error



---

archive/issue_comments_422395.json:
```json
{
    "body": "https://bugs.python.org/issue17153",
    "created_at": "2020-06-28T15:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422395",
    "user": "https://github.com/mkoeppe"
}
```

https://bugs.python.org/issue17153



---

archive/issue_comments_422396.json:
```json
{
    "body": "Perhaps #30001 happens to fix it?",
    "created_at": "2020-06-29T19:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422396",
    "user": "https://github.com/mkoeppe"
}
```

Perhaps #30001 happens to fix it?



---

archive/issue_comments_422397.json:
```json
{
    "body": "Testing here:\n\nhttps://github.com/kliem/sage/pull/17/checks",
    "created_at": "2020-06-29T19:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422397",
    "user": "https://github.com/kliem"
}
```

Testing here:

https://github.com/kliem/sage/pull/17/checks



---

archive/issue_comments_422398.json:
```json
{
    "body": "No, doesn't help. At least not as it is now.",
    "created_at": "2020-06-30T05:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422398",
    "user": "https://github.com/kliem"
}
```

No, doesn't help. At least not as it is now.



---

archive/issue_comments_422399.json:
```json
{
    "body": "According to this\n\nhttps://www.noreplied.com/how-to-fixed-cannot-change-locale-utf-8-error-in-centos-7/\n\none should add `LC_CTYPE=\"en_US.UTF-8\"` to `/etc/environment`. Very unsatisfying fix for someone without root privileges.\n\nThis appears to be a bug with centos 7, which is merely exposed now.",
    "created_at": "2020-06-30T19:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422399",
    "user": "https://github.com/kliem"
}
```

According to this

https://www.noreplied.com/how-to-fixed-cannot-change-locale-utf-8-error-in-centos-7/

one should add `LC_CTYPE="en_US.UTF-8"` to `/etc/environment`. Very unsatisfying fix for someone without root privileges.

This appears to be a bug with centos 7, which is merely exposed now.



---

archive/issue_comments_422400.json:
```json
{
    "body": "Just exporting this environment variable setting in `build/bin/sage-spkg` should be enough. No need for a systemwide setting",
    "created_at": "2020-06-30T19:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422400",
    "user": "https://github.com/mkoeppe"
}
```

Just exporting this environment variable setting in `build/bin/sage-spkg` should be enough. No need for a systemwide setting



---

archive/issue_comments_422401.json:
```json
{
    "body": "Ok. Testing this now. https://github.com/kliem/sage/pull/19/checks",
    "created_at": "2020-07-01T15:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422401",
    "user": "https://github.com/kliem"
}
```

Ok. Testing this now. https://github.com/kliem/sage/pull/19/checks



---

archive/issue_comments_422402.json:
```json
{
    "body": "apparently should be fixed by #30053",
    "created_at": "2020-07-05T15:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422402",
    "user": "https://github.com/dimpase"
}
```

apparently should be fixed by #30053



---

archive/issue_events_077113.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-07-23T20:31:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29771#event-77113"
}
```



---

archive/issue_comments_422403.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-23T20:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422403",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_422404.json:
```json
{
    "body": "It appears that things fixed itself: https://github.com/sagemath/sage/actions/runs/166309975",
    "created_at": "2020-07-23T20:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422404",
    "user": "https://github.com/kliem"
}
```

It appears that things fixed itself: https://github.com/sagemath/sage/actions/runs/166309975



---

archive/issue_comments_422405.json:
```json
{
    "body": "In any case, let's take care of all locale issues in #30053.",
    "created_at": "2020-07-23T22:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422405",
    "user": "https://github.com/mkoeppe"
}
```

In any case, let's take care of all locale issues in #30053.



---

archive/issue_comments_422406.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-23T22:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422406",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422407.json:
```json
{
    "body": "Also the upgrade to Sphinx 3.1.2 is complete at #30001 and was merged in Sage 9.2.beta5.",
    "created_at": "2020-07-26T17:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422407",
    "user": "https://github.com/slel"
}
```

Also the upgrade to Sphinx 3.1.2 is complete at #30001 and was merged in Sage 9.2.beta5.



---

archive/issue_events_077114.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-01T23:03:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29771#event-77114"
}
```



---

archive/issue_comments_422408.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2020-09-01T23:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422408",
    "user": "https://github.com/vbraun"
}
```

Resolution: duplicate



---

archive/issue_comments_422409.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2020-09-21T04:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422409",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from closed to new.



---

archive/issue_events_077115.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T04:42:32Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29771#event-77115"
}
```



---

archive/issue_comments_422410.json:
```json
{
    "body": "Resolution changed from duplicate to ",
    "created_at": "2020-09-21T04:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422410",
    "user": "https://github.com/mkoeppe"
}
```

Resolution changed from duplicate to 



---

archive/issue_events_077116.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T04:42:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29771#event-77116"
}
```



---

archive/issue_events_077117.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T04:42:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29771#event-77117"
}
```



---

archive/issue_comments_422411.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-21T05:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422411",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_422412.json:
```json
{
    "body": "On Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.",
    "created_at": "2020-09-21T09:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422412",
    "user": "https://github.com/seblabbe"
}
```

On Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.



---

archive/issue_comments_422413.json:
```json
{
    "body": "the error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?\n\nWhat is the commit in comment:20 doing? I am lost.",
    "created_at": "2020-09-21T12:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422413",
    "user": "https://github.com/dimpase"
}
```

the error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?

What is the commit in comment:20 doing? I am lost.



---

archive/issue_comments_422414.json:
```json
{
    "body": "Replying to [comment:22 dimpase]:\n> the error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?\n\n\n`build/bin/sage-system-python` finds the Python that we use for downloading and unpacking packages. \n\nIt is unrelated to the python that we try to find in `build/pkgs/python3/spkg-configure.m4` (which rejects Python 3.6 after #30053).\n\n`build/bin/sage-system-python` can use any of the Pythons listed in `build/tox.ini`. In particular, it can be an early 3.x series Python. For these, `LC_ALL=C` disables UTF-8 operation, which causes the errors described on this ticket. \n\nLook at the GH Actions links in the ticket description to see it in action.",
    "created_at": "2020-09-21T15:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422414",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:22 dimpase]:
> the error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?


`build/bin/sage-system-python` finds the Python that we use for downloading and unpacking packages. 

It is unrelated to the python that we try to find in `build/pkgs/python3/spkg-configure.m4` (which rejects Python 3.6 after #30053).

`build/bin/sage-system-python` can use any of the Pythons listed in `build/tox.ini`. In particular, it can be an early 3.x series Python. For these, `LC_ALL=C` disables UTF-8 operation, which causes the errors described on this ticket. 

Look at the GH Actions links in the ticket description to see it in action.



---

archive/issue_comments_422415.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-21T17:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422415",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_422416.json:
```json
{
    "body": "Ready for review",
    "created_at": "2020-09-21T17:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422416",
    "user": "https://github.com/mkoeppe"
}
```

Ready for review



---

archive/issue_comments_422417.json:
```json
{
    "body": "Replying to [comment:21 slabbe]:\n> On Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.\n\nYou probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.",
    "created_at": "2020-09-21T17:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422417",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:21 slabbe]:
> On Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.

You probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.



---

archive/issue_comments_422418.json:
```json
{
    "body": "Why again are we trying to extract a tarball with python?\n\nThe problem here isn't really the `C` locale, it's that Sphinx ships files with non-ascii characters in them...\n\n```\n$ ls tests/roots/test-images/ | tail -n 1\n-rw-r--r-- 1 mjo mjo  65K 2020-08-13 11:46 testim\u00e4ge.png\n```\n\nand we don't specify an encoding, which ultimately leaves it up to the locale.\n\nIgnoring the fact that reimplementing this is absurd, we should be able to set the filename encoding to utf8 here without touching the locale at all.",
    "created_at": "2020-09-21T18:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422418",
    "user": "https://github.com/orlitzky"
}
```

Why again are we trying to extract a tarball with python?

The problem here isn't really the `C` locale, it's that Sphinx ships files with non-ascii characters in them...

```
$ ls tests/roots/test-images/ | tail -n 1
-rw-r--r-- 1 mjo mjo  65K 2020-08-13 11:46 testimäge.png
```

and we don't specify an encoding, which ultimately leaves it up to the locale.

Ignoring the fact that reimplementing this is absurd, we should be able to set the filename encoding to utf8 here without touching the locale at all.



---

archive/issue_comments_422419.json:
```json
{
    "body": "Replying to [comment:27 mjo]:\n> Why again are we trying to extract a tarball with python?\n\n\nThis question is not within the scope of this ticket",
    "created_at": "2020-09-21T19:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422419",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:27 mjo]:
> Why again are we trying to extract a tarball with python?


This question is not within the scope of this ticket



---

archive/issue_comments_422420.json:
```json
{
    "body": "Replying to [comment:27 mjo]:\n> The problem here isn't really the `C` locale\n\n\nYes, it is specifically the problem with setting the `C` locale explicitly. This is explained well in https://www.python.org/dev/peps/pep-0538/",
    "created_at": "2020-09-21T19:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422420",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:27 mjo]:
> The problem here isn't really the `C` locale


Yes, it is specifically the problem with setting the `C` locale explicitly. This is explained well in https://www.python.org/dev/peps/pep-0538/



---

archive/issue_comments_422421.json:
```json
{
    "body": "Replying to [comment:27 mjo]:\n> we should be able to set the filename encoding to utf8 here without touching the locale at all.\n\n\nWe are using the `tarfile` module as supplied by the system python.",
    "created_at": "2020-09-21T19:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422421",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:27 mjo]:
> we should be able to set the filename encoding to utf8 here without touching the locale at all.


We are using the `tarfile` module as supplied by the system python.



---

archive/issue_comments_422422.json:
```json
{
    "body": "I'm not willing to install a version of python from 2014 to test it, but setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.",
    "created_at": "2020-09-21T19:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422422",
    "user": "https://github.com/orlitzky"
}
```

I'm not willing to install a version of python from 2014 to test it, but setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.



---

archive/issue_comments_422423.json:
```json
{
    "body": "Replying to [comment:33 mjo]:\n> I'm not willing to install a version of python from 2014 to test it\n\n\nYou don't have to. We have the GH Actions to test it. The link with the runs and results is in the \"Reviewer field\".",
    "created_at": "2020-09-21T20:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422423",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:33 mjo]:
> I'm not willing to install a version of python from 2014 to test it


You don't have to. We have the GH Actions to test it. The link with the runs and results is in the "Reviewer field".



---

archive/issue_comments_422424.json:
```json
{
    "body": "Replying to [comment:33 mjo]:\n> setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.\n\n\nNo, that is absolutely not the correct fix because the default (obtained using `sys.getfilesystemencoding()` or `sys.getdefaultencoding()`) is correct. See https://docs.python.org/2.6/library/tarfile.html#tar-unicode (Python 2.6 is the earliest version that we support for `sage-system-python`).\n\nThe specific problem is that if someone puts a `LC_ALL=C`, the default encodings are set to ASCII. This is what causes the breakage, and this is what the current ticket fixes.\n\nNeeds review.",
    "created_at": "2020-09-21T20:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422424",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:33 mjo]:
> setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.


No, that is absolutely not the correct fix because the default (obtained using `sys.getfilesystemencoding()` or `sys.getdefaultencoding()`) is correct. See https://docs.python.org/2.6/library/tarfile.html#tar-unicode (Python 2.6 is the earliest version that we support for `sage-system-python`).

The specific problem is that if someone puts a `LC_ALL=C`, the default encodings are set to ASCII. This is what causes the breakage, and this is what the current ticket fixes.

Needs review.



---

archive/issue_comments_422425.json:
```json
{
    "body": "Setting the locale to `C` causes the default guess to be wrong, but we *know* the correct encoding. And the `utf-8` encoding is available \"everywhere,\" unlike the locales that we're guessing at in your branch. Finally, changing the system locale to affect one tarfile is like setting your house on fire to stop the faucet from leaking.",
    "created_at": "2020-09-21T20:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422425",
    "user": "https://github.com/orlitzky"
}
```

Setting the locale to `C` causes the default guess to be wrong, but we *know* the correct encoding. And the `utf-8` encoding is available "everywhere," unlike the locales that we're guessing at in your branch. Finally, changing the system locale to affect one tarfile is like setting your house on fire to stop the faucet from leaking.



---

archive/issue_comments_422426.json:
```json
{
    "body": "Replying to [comment:36 mjo]:\n> Finally, changing the system locale to affect one tarfile is like [...]\n\n\nIt is very localized, and it undoes the damage done by #30053's `sage-spkg` doing exactly what you seem to be criticizing here - namely setting the system locale for all its subprocesses.",
    "created_at": "2020-09-21T20:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422426",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:36 mjo]:
> Finally, changing the system locale to affect one tarfile is like [...]


It is very localized, and it undoes the damage done by #30053's `sage-spkg` doing exactly what you seem to be criticizing here - namely setting the system locale for all its subprocesses.



---

archive/issue_comments_422427.json:
```json
{
    "body": "Replying to [comment:36 mjo]:\n> we *know* the correct encoding. \n\n\nThis is of course a good point. We can just decide that our tarballs have utf-8 pathnames.  I will test the approach with setting `tarfile.ENCODING`.\n\nNevertheless, removing the `C` locale setting in `sage-system-python` would still be good because there could be other parts that are affected by this unsuitable setting.",
    "created_at": "2020-09-21T20:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422427",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:36 mjo]:
> we *know* the correct encoding. 


This is of course a good point. We can just decide that our tarballs have utf-8 pathnames.  I will test the approach with setting `tarfile.ENCODING`.

Nevertheless, removing the `C` locale setting in `sage-system-python` would still be good because there could be other parts that are affected by this unsuitable setting.



---

archive/issue_comments_422428.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-21T20:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422428",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_422429.json:
```json
{
    "body": "And #30053 just put things back the way they were before we tried to switch to `C.UTF-8`. We need to set *some* locale, because otherwise the behavior of standard utilities in spkg-install and spkg-check scripts is unknowable. For example, this branch can choose the `en_US.utf8` locale. How do grep ranges work there? According to https://www.gnu.org/software/grep/manual/html_node/Character-Classes-and-Bracket-Expressions.html,\n\n> In the default C locale, the sorting sequence is the native character order; for example, \u2018[a-d]\u2019 is equivalent to \u2018[abcd]\u2019. In other locales, the sorting sequence is not specified, and \u2018[a-d]\u2019 might be equivalent to \u2018[abcd]\u2019 or to \u2018[aBbCcDd]\u2019, or it might fail to match any character, or the set of characters that it matches might even be erratic. To obtain the traditional interpretation of bracket expressions, you can use the \u2018C\u2019 locale by setting the LC_ALL environment variable to the value \u2018C\u2019.\n\n\nMucking with this is bad luck.",
    "created_at": "2020-09-21T21:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422429",
    "user": "https://github.com/orlitzky"
}
```

And #30053 just put things back the way they were before we tried to switch to `C.UTF-8`. We need to set *some* locale, because otherwise the behavior of standard utilities in spkg-install and spkg-check scripts is unknowable. For example, this branch can choose the `en_US.utf8` locale. How do grep ranges work there? According to https://www.gnu.org/software/grep/manual/html_node/Character-Classes-and-Bracket-Expressions.html,

> In the default C locale, the sorting sequence is the native character order; for example, ‘[a-d]’ is equivalent to ‘[abcd]’. In other locales, the sorting sequence is not specified, and ‘[a-d]’ might be equivalent to ‘[abcd]’ or to ‘[aBbCcDd]’, or it might fail to match any character, or the set of characters that it matches might even be erratic. To obtain the traditional interpretation of bracket expressions, you can use the ‘C’ locale by setting the LC_ALL environment variable to the value ‘C’.


Mucking with this is bad luck.



---

archive/issue_comments_422430.json:
```json
{
    "body": "Replying to [comment:40 mjo]:\n> And #30053 just put things back the way they were before we tried to switch to `C.UTF-8`.\n\n\nYes, it was a good change for that ticket, which is why I agreed with the change there.\n\nBut it affects the Pythons that run below it.\n(1) the `sage-system-python` - which the present ticket addresses\n(2) the python3 from which we build our venv -- which is yet to be addressed in #30576 if we want to support python 3.6.",
    "created_at": "2020-09-21T21:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422430",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:40 mjo]:
> And #30053 just put things back the way they were before we tried to switch to `C.UTF-8`.


Yes, it was a good change for that ticket, which is why I agreed with the change there.

But it affects the Pythons that run below it.
(1) the `sage-system-python` - which the present ticket addresses
(2) the python3 from which we build our venv -- which is yet to be addressed in #30576 if we want to support python 3.6.



---

archive/issue_comments_422431.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-21T21:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422431",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422432.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-21T21:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422432",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_422433.json:
```json
{
    "body": "Needs review.",
    "created_at": "2020-09-22T13:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422433",
    "user": "https://github.com/mkoeppe"
}
```

Needs review.



---

archive/issue_comments_422434.json:
```json
{
    "body": "Replying to [comment:26 mkoeppe]:\n> You probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.\n\n\nI have:\n\n```\n$ build/bin/sage-system-python --version\nPython 2.7.17\n```\n\nI don't know how to properly review this ticket. With ubuntu-bionic 18.04, I do not have problem. So what I can do is to check that with the branch, I still don't have a problem. Should I do some kind of make distclean? For now, I just pulled that branch on top of freshly built beta13, and I am currently running make ptestlong. Will report later.",
    "created_at": "2020-09-22T20:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422434",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:26 mkoeppe]:
> You probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.


I have:

```
$ build/bin/sage-system-python --version
Python 2.7.17
```

I don't know how to properly review this ticket. With ubuntu-bionic 18.04, I do not have problem. So what I can do is to check that with the branch, I still don't have a problem. Should I do some kind of make distclean? For now, I just pulled that branch on top of freshly built beta13, and I am currently running make ptestlong. Will report later.



---

archive/issue_comments_422435.json:
```json
{
    "body": "The tests have already run on GH Actions. It is not necessary to run them again to review this ticket.",
    "created_at": "2020-09-22T20:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422435",
    "user": "https://github.com/mkoeppe"
}
```

The tests have already run on GH Actions. It is not necessary to run them again to review this ticket.



---

archive/issue_comments_422436.json:
```json
{
    "body": "The problem shows on machines where sage-system-python is python 3.x with x < 7.\n\nIt's probably not a good idea to try to uninstall python2 to review this ticket, but you could try to shadow it",
    "created_at": "2020-09-22T20:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422436",
    "user": "https://github.com/mkoeppe"
}
```

The problem shows on machines where sage-system-python is python 3.x with x < 7.

It's probably not a good idea to try to uninstall python2 to review this ticket, but you could try to shadow it



---

archive/issue_comments_422437.json:
```json
{
    "body": "Replying to [comment:48 mkoeppe]:\n> you could try to shadow it \n\n\ntell me how to shadow, I will try that tomorrow. How can I make `sage-system-python` to use:\n\n```\n$ which python3.6\n/usr/bin/python3.6\n```\n?",
    "created_at": "2020-09-22T20:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422437",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:48 mkoeppe]:
> you could try to shadow it 


tell me how to shadow, I will try that tomorrow. How can I make `sage-system-python` to use:

```
$ which python3.6
/usr/bin/python3.6
```
?



---

archive/issue_comments_422438.json:
```json
{
    "body": "```\nmkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python \nexport PATH=/somewhere:$PATH\n```",
    "created_at": "2020-09-22T22:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422438",
    "user": "https://github.com/mkoeppe"
}
```

```
mkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python 
export PATH=/somewhere:$PATH
```



---

archive/issue_comments_422439.json:
```json
{
    "body": "Doesn't the tarball commit alone fix issue without the locale voodoo?",
    "created_at": "2020-09-23T01:07:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422439",
    "user": "https://github.com/orlitzky"
}
```

Doesn't the tarball commit alone fix issue without the locale voodoo?



---

archive/issue_comments_422440.json:
```json
{
    "body": "It does fix the issue, but it is best not to pass a locale to python 3.6 that we know to break things.",
    "created_at": "2020-09-23T01:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422440",
    "user": "https://github.com/mkoeppe"
}
```

It does fix the issue, but it is best not to pass a locale to python 3.6 that we know to break things.



---

archive/issue_comments_422441.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-23T06:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422441",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422442.json:
```json
{
    "body": "Seems to work fine and looks good to me.",
    "created_at": "2020-09-23T06:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422442",
    "user": "https://github.com/kliem"
}
```

Seems to work fine and looks good to me.



---

archive/issue_comments_422443.json:
```json
{
    "body": "Replying to [comment:50 mkoeppe]:\n> {{{\n> mkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python \n> export PATH=/somewhere:$PATH\n> }}}\n> \n\nIndeed, the above shadowing method works:\n\n```\n$ build/bin/sage-system-python --version\nPython 3.6.9\n```\nI can now reproduce the issue with Ubuntu 18.04 + 9.2.beta13 and I confirm that the current branch fixes it.",
    "created_at": "2020-09-23T10:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422443",
    "user": "https://github.com/seblabbe"
}
```

Replying to [comment:50 mkoeppe]:
> {{{
> mkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python 
> export PATH=/somewhere:$PATH
> }}}
> 

Indeed, the above shadowing method works:

```
$ build/bin/sage-system-python --version
Python 3.6.9
```
I can now reproduce the issue with Ubuntu 18.04 + 9.2.beta13 and I confirm that the current branch fixes it.



---

archive/issue_comments_422444.json:
```json
{
    "body": "Thanks everyone!",
    "created_at": "2020-09-23T11:57:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422444",
    "user": "https://github.com/mkoeppe"
}
```

Thanks everyone!



---

archive/issue_comments_422445.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-27T09:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29771#issuecomment-422445",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_077118.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-27T09:10:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29771",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29771#event-77118"
}
```
