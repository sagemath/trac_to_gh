# Issue 31159: relocatable wheel version of package sage_conf

Issue created by migration from https://trac.sagemath.org/ticket/31396

Original creator: mkoeppe

Original creation time: 2021-02-14 22:06:47

CC:  culler @kliem dimpase jhpalmieri slelievre fbissey

This version of `sage_conf` is for making a wheel that packages the precompiled non-Python bits of the Sage distribution, making `SAGE_LOCAL` relocatable using the method proposed in #31076, using `SAGE_LOCAL=/var/tmp/sage-...` and a symlink.

The `sage` script invokes `sage-config` to determine `SAGE_ROOT` and `SAGE_LOCAL`. In the version of `sage-config` supplied by this version of `sage_conf`, we ensure that the symlink from `/var/tmp/sage-....` to the actual install location is set.


---

Comment by git created at 2021-02-15 06:36:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-15 07:56:12

On macOS, some shared libraries from homebrew still leak into the build:

```
find src/pkgs/sage_conf-relocatable/.tox/python/lib/python3.9/site-packages/sage_root -name "*.so" -o -name "*.dylib" | xargs otool -L
libgiac.dylib:
/usr/local/opt/gettext/lib/libintl.8.dylib
R/library/cluster/libs/*.dylib:
	/usr/local/opt/gettext/lib/libintl.8.dylib (compatibility version 11.0.0, current version 11.0.0)
	/usr/local/opt/pcre/lib/libpcre.1.dylib (compatibility version 4.0.0, current version 4.12.0)
	/usr/local/opt/xz/lib/liblzma.5.dylib (compatibility version 8.0.0, current version 8.5.0)
```

Definitely should disable the R build (#30383).

Also check whether setting CC=`gcc -sysroot....` helps getting rid of `/usr/local` leaking in.

Also need to add `--enable-fat-binary`.

`setup.py build_py` should probably use a symlink from `/var/tmp...` into `~/.sage` as well so that it is easy to test relocation after removing the symlink.
Also `copytree` from `sage_root_source` should be changed so it overwrites (updates) the existing contents of SAGE_ROOT.

the tox test should include the test with `otool` for self-containedness.


---

Comment by git created at 2021-02-16 02:56:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-16 02:58:06

Using -isysroot helps but giac configuration needs more work - #31403


---

Comment by mkoeppe created at 2021-02-16 03:26:34

Replying to [comment:4 mkoeppe]:
> `setup.py build_py` should probably use a symlink from `/var/tmp...` into `~/.sage` as well so that it is easy to test relocation after removing the symlink.
Does not work because sage resolves symlinks when it determines SAGE_ROOT.


---

Comment by git created at 2021-02-19 00:02:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-19 02:19:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-19 03:35:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-19 06:10:23

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-02-19 06:40:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-15 06:02:00

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-03-24 17:32:21

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-03-24 17:43:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 19:14:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-24 20:35:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-25 01:04:34

`delocate-listdeps` reports the following library dependencies:

```
/usr/local/Cellar/gettext/0.21/lib/libintl.8.dylib
/usr/local/Cellar/gmp/6.2.1/lib/libgmp.10.dylib
/usr/local/Cellar/harfbuzz/2.8.0/lib/libharfbuzz.0.dylib
/usr/local/Cellar/libtiff/4.2.0/lib/libtiff.5.dylib
/usr/local/Cellar/libxcb/1.14_1/lib/libxcb.1.1.0.dylib
/usr/local/Cellar/little-cms2/2.12/lib/liblcms2.2.dylib
/usr/local/Cellar/mpfr/4.1.0/lib/libmpfr.6.dylib
/usr/local/Cellar/openjpeg/2.4.0/lib/libopenjp2.2.4.0.dylib
/usr/local/Cellar/readline/8.1/lib/libreadline.8.1.dylib
/usr/local/Cellar/webp/1.2.0/lib/libwebp.7.dylib
/usr/local/Cellar/webp/1.2.0/lib/libwebpdemux.2.dylib
/usr/local/Cellar/webp/1.2.0/lib/libwebpmux.3.dylib
/usr/local/Cellar/zeromq/4.3.3/lib/libzmq.5.dylib
/usr/local/Cellar/zlib/1.2.11/lib/libz.1.2.11.dylib
@executable_path/../../../../Python3
liba.dylib
libb.dylib
libc.dylib
```



---

Comment by git created at 2021-03-25 01:19:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-25 05:07:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-25 06:49:26


```
/usr/local/Cellar/gettext/0.21/lib/libintl.8.dylib
/usr/local/Cellar/harfbuzz/2.8.0/lib/libharfbuzz.0.dylib
/usr/local/Cellar/libtiff/4.2.0/lib/libtiff.5.dylib
/usr/local/Cellar/libxcb/1.14_1/lib/libxcb.1.1.0.dylib
/usr/local/Cellar/little-cms2/2.12/lib/liblcms2.2.dylib
/usr/local/Cellar/openjpeg/2.4.0/lib/libopenjp2.2.4.0.dylib
/usr/local/Cellar/webp/1.2.0/lib/libwebp.7.dylib
/usr/local/Cellar/webp/1.2.0/lib/libwebpdemux.2.dylib
/usr/local/Cellar/webp/1.2.0/lib/libwebpmux.3.dylib
/usr/local/Cellar/zlib/1.2.11/lib/libz.1.2.11.dylib
@executable_path/../../../../Python3
liba.dylib
libb.dylib
libc.dylib
```



---

Comment by mkoeppe created at 2021-03-25 07:17:24

`libintl` is still coming in through giac


---

Comment by git created at 2021-03-25 18:10:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-25 23:36:35

The remaining shared libraries from `/usr/local` come in through our `freetype` (which uses libharfbuzz from `/usr/local`), `libgd` (which uses libtiff), and `pillow` (libtiff and everything else).

We could try not to ship `matplotlib` at all in the wheelhouse - it is responsible for pulling in `freetype` and `pillow` - but it still shares one shared library with some of our packages - `libpng`.


---

Comment by git created at 2021-03-26 01:51:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-26 02:03:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-03-26 02:29:33

Replying to [comment:30 mkoeppe]:
> `libintl` is still coming in through giac
Solved now via #31562.


---

Comment by git created at 2021-03-26 19:36:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-27 04:06:04

Replying to [comment:32 mkoeppe]:
> The remaining shared libraries from `/usr/local` come in through our `freetype` (which uses libharfbuzz from `/usr/local`)

freetype checks for harfbuzz using pkg-config, accepts `configure --without-harfbuzz`. https://github.com/freetype/freetype/blob/f9f6adb625c48ef15b5d61a3ac1709a068ea95a3/builds/unix/configure.raw#L504


---

Comment by git created at 2021-03-27 05:08:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-28 06:43:49

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-03-29 02:00:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-03-29 04:44:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-29 16:37:59

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-30 16:45:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-04-03 21:08:50

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-04-04 00:49:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-04 02:15:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-04 04:53:39

Unfortunately it turns out that PyPI does not allow `@` references in install requires (see https://github.com/pypa/pip/issues/6301)

```
HTTPError: 400 Bad Request from https://upload.pypi.org/legacy/
Invalid value for requires_dist. Error: Can't have direct dependency: 'Cython @ https://github.com/sagemath/sage-wheels/releases/download/9.3.rc1/Cython-0.29.21-cp38-cp38-macosx_10_15_x86_64.whl'
```



---

Comment by git created at 2021-04-04 21:26:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-04 23:50:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-05 02:53:40

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-04-06 04:20:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-06 04:54:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-07 00:39:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-07 00:43:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-07 02:38:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-08 19:55:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-08 22:16:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-09 02:08:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-10 18:19:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-11 16:32:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-11 17:02:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-04-11 17:07:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-11 03:03:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-06 20:18:51

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-06-07 02:04:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-07 02:06:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-07 18:35:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-07 23:59:05

Installation with `/usr/bin/python3 -m pip install -I --user https://github.com/sagemath/sage-wheels/releases/download/9.4.beta1/sage_conf-9.4b1-cp38-cp38-macosx_11_0_x86_64.whl https://github.com/sagemath/sage-wheels/releases/download/9.4.beta1/sagemath_standard-9.4b1-cp38-cp38-macosx_11_0_x86_64.whl` fails with:


```
Collecting argon2-cffi (from notebook>=4.4.1->widgetsnbextension~=3.5.0->ipywidgets>=7.5.1->sagemath-standard==9.4b1)
  Downloading https://files.pythonhosted.org/packages/74/fd/d78e003a79c453e8454197092fce9d1c6099445b7e7da0b04eb4fe1dbab7/argon2-cffi-20.1.0.tar.gz (1.8MB)
[...]
Failed to build argon2-cffi
```



---

Comment by dimpase created at 2021-06-08 11:02:11

#29039 is listed as a dependency, is it an error?


---

Comment by mkoeppe created at 2021-06-09 13:00:02

No, that's correct


---

Comment by git created at 2021-06-25 07:30:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-06-25 19:31:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-06-25 19:37:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-25 20:02:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-06-26 18:52:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-06-27 10:07:17

<deleted - meant to be on #31456>


---

Comment by git created at 2021-07-24 19:58:53

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-08-12 21:19:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 22:19:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-27 04:18:23

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-09-28 01:31:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-10-14 10:26:26

On Linux, `PATH` in testing instructions should start from `$HOME/.local/lib/python3.8` or something like this. There is no `~/Library`, that's macOS-only.


---

Comment by git created at 2021-10-25 03:35:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-13 06:51:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-01-01 01:37:10

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-01-01 01:43:01

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-01-01 02:28:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-01 02:40:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-01 03:58:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-01 05:33:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-01 06:01:17

To avoid the duplication between the two versions of `sage_conf.py.in`, could do what was suggested in #29039#comment:148 - split module `sage_conf` into several modules of a `sage_conf` package


---

Comment by git created at 2022-01-01 19:30:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-02 19:37:45

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-01-02 19:37:45

Need to get uninstallation of script package `sage_conf` fixed, or switching between branches with `sage_conf.py` and branches with `sage_conf/` will be tricky


---

Comment by git created at 2022-01-11 17:15:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-11 20:30:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-11 20:36:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-11 20:49:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-11 20:53:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-11 21:02:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-11 21:33:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-01-12 00:08:39

`tox -e local-macos-10.15-nohomebrew-python3_xcode -- SAGE_CHECK=no sage-wheels`
currently builds a mistagged `sage_conf-9.5rc0-cp38-cp38-macosx_11_0_x86_64.whl`


---

Comment by git created at 2022-01-16 20:19:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-16 20:24:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-17 00:20:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-17 01:02:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-17 01:46:30

Replying to [comment:150 mkoeppe]:
> `tox -e local-macos-10.15-nohomebrew-python3_xcode -- SAGE_CHECK=no sage-wheels`
> currently builds a mistagged `sage_conf-9.5rc0-cp38-cp38-macosx_11_0_x86_64.whl`

That was caused by trash in `pkgs/sage-conf_relocatable/build/`


---

Comment by git created at 2022-01-17 07:38:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-18 22:13:40

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-02-05 17:32:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-05 17:37:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-03 01:25:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2022-06-16 18:00:45

There seem to be merge conflicts.


---

Comment by saraedum created at 2022-06-16 18:01:24

Do you want this to be reviewed & merged even though it does not work on Linux yet? Or does it work by now?


---

Comment by saraedum created at 2022-06-16 18:01:24

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-06-17 18:58:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-17 18:58:40

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-06-17 18:59:16

Replying to [comment:171 saraedum]:
> Do you want this to be reviewed & merged even though it does not work on Linux yet?

Yes, that would be great!


---

Comment by git created at 2022-07-01 02:11:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-11 00:32:57

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-07-11 03:48:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2022-07-14 20:22:17

There's an isolated


```
+        #
```


Is a comment missing there?


---

Comment by saraedum created at 2022-07-14 20:25:57

I don't understand the `STICKY` business. Why is there a hardcoded `/var/tmp` there?


---

Comment by saraedum created at 2022-07-14 20:26:22

Is the plan to eventually make these wheels available on PyPI?


---

Comment by saraedum created at 2022-07-14 20:27:24

Changing status from needs_review to needs_info.


---

Comment by saraedum created at 2022-07-14 20:27:24

Note to self. I don't really understand what `pkgs/sage-conf_relocatable/setup.py` does because of the above. The rest looks fine.


---

Comment by mkoeppe created at 2022-07-14 20:38:16

/var/tmp is a sticky directory, meaning every user can create a new subdirectory, which then securely belongs to them.

The README of https://pypi.org/project/sage-conf/ (section "sage_conf wheels") explains more


---

Comment by mkoeppe created at 2022-07-14 20:46:04

Replying to [comment:181 saraedum]:
> Is the plan to eventually make these wheels available on PyPI?

Ticket description explains why they can't go to PyPI.


---

Comment by git created at 2022-07-27 01:53:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-27 03:50:03

Changing status from needs_info to needs_review.


---

Comment by saraedum created at 2022-12-14 22:35:30

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2022-12-14 22:35:30

Sorry for not having a look at this ticket for a while. There are merge conflicts now btw.


---

Comment by git created at 2022-12-15 01:16:24

Branch pushed to git repo; I updated commit sha1. New commits:
