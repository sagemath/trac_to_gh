# Issue 21560: misc/cython.py: Clean up unnecessary include directories

archive/issues_021560.json:
```json
{
    "body": "CC:  @jdemeyer\n\nA doctest in misc/cython.py passes unnecessary include directories, depending on $SAGE_LOCAL.\nWe can remove it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21797\n\n",
    "created_at": "2016-11-02T02:16:49Z",
    "labels": [
        "cython",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "misc/cython.py: Clean up unnecessary include directories",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21560",
    "user": "@mkoeppe"
}
```
CC:  @jdemeyer

A doctest in misc/cython.py passes unnecessary include directories, depending on $SAGE_LOCAL.
We can remove it.

Issue created by migration from https://trac.sagemath.org/ticket/21797





---

archive/issue_comments_299311.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-11-02T02:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299311",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_299312.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-11-02T02:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299312",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_299313.json:
```json
{
    "body": "Replying to [ticket:21797 mkoeppe]:\n> The same file also uses `$SAGE_LOCAL/include/flint`, but that needs handling in a different way -- this will be on a different ticket.\n\nCan you explain what makes flint different?",
    "created_at": "2016-11-02T07:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299313",
    "user": "@jdemeyer"
}
```

Replying to [ticket:21797 mkoeppe]:
> The same file also uses `$SAGE_LOCAL/include/flint`, but that needs handling in a different way -- this will be on a different ticket.

Can you explain what makes flint different?



---

archive/issue_comments_299314.json:
```json
{
    "body": "Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the \"flint/\" prefix.\nThis makes it necessary to add a separate include path.",
    "created_at": "2016-11-02T07:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299314",
    "user": "@mkoeppe"
}
```

Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the "flint/" prefix.
This makes it necessary to add a separate include path.



---

archive/issue_comments_299315.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-02T08:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299315",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_299316.json:
```json
{
    "body": "Changing component from cython to doctest coverage.",
    "created_at": "2016-11-02T08:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299316",
    "user": "@jdemeyer"
}
```

Changing component from cython to doctest coverage.



---

archive/issue_comments_299317.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the \"flint/\" prefix.\n> This makes it necessary to add a separate include path.\n\nI'm lost: I just reviewed #21803 before discovering this ticket, and rebuilding modules that use flint seems to work, even though #21803 doesn't look like it does things differently from this ticket. What did I miss?",
    "created_at": "2016-11-03T08:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299317",
    "user": "@mezzarobba"
}
```

Replying to [comment:4 mkoeppe]:
> Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the "flint/" prefix.
> This makes it necessary to add a separate include path.

I'm lost: I just reviewed #21803 before discovering this ticket, and rebuilding modules that use flint seems to work, even though #21803 doesn't look like it does things differently from this ticket. What did I miss?



---

archive/issue_comments_299318.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the \"flint/\" prefix.\n\nThat doesn't matter because\n\n```\n#include \"foo.h\"\n```\n\nwill always look for `foo.h` in the same directory as the including file.\n\nSo, the include path would only matter for external includes (i.e. from Sage) and there we always use the `flint/` prefix.",
    "created_at": "2016-11-03T13:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299318",
    "user": "@jdemeyer"
}
```

Replying to [comment:4 mkoeppe]:
> Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the "flint/" prefix.

That doesn't matter because

```
#include "foo.h"
```

will always look for `foo.h` in the same directory as the including file.

So, the include path would only matter for external includes (i.e. from Sage) and there we always use the `flint/` prefix.



---

archive/issue_comments_299319.json:
```json
{
    "body": "Ah, thanks, I missed that.",
    "created_at": "2016-11-03T14:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299319",
    "user": "@mkoeppe"
}
```

Ah, thanks, I missed that.



---

archive/issue_comments_299320.json:
```json
{
    "body": "I have problem with this on Volker's branch, since he included it.\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/misc/cython.py\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 317, in sage.misc.cython.?\nFailed example:\n    cython(os.linesep.join(code))\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 501, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 864, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.cython.?[1]>\", line 1, in <module>\n        cython(os.linesep.join(code))\n      File \"sage/misc/lazy_import.pyx\", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/lazy_import.c:3998)\n        return self._get_object()(*args, **kwds)\n      File \"sage/misc/cython_c.pyx\", line 65, in sage.misc.cython_c.cython_compile (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cython_c.c:1178)\n        cython_import_all(tmpfile, get_globals(),\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 710, in cython_import_all\n        create_local_c_file=create_local_c_file)\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 687, in cython_import\n        **kwds)\n      File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 480, in cython\n        raise RuntimeError(\"Error compiling {}:\\n{}\\n{}\".format(filename, log, err))\n    RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/28014/tmp_SP1JOv.spyx:\n    running build\n    running build_ext\n    building '_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0' extension\n    creating build\n    creating build/temp.linux-x86_64-2.7\n    x86_64-pc-linux-gnu-g++ -pthread -fPIC -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/lib64/python2.7/site-packages/cysignals -I/home/fbissey/.sage/temp/QCD-nzi3/28014/spyx/_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_MTIPno_pyx/cysignals -I/home/fbissey/.sage/temp/QCD-nzi3/28014 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.cpp -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.o -w -O2\n\n    In file included from _home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.cpp:424:0:\n    /usr/include/singular/Singular/libsingular.h:6:28: fatal error: singularconfig.h: No such file or directory\n    compilation terminated.\n    error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1\n```\n\nHeaders location have changed in singular 4 and the way to deal with them too. This is `libsingular.h`\n\n```\n#ifndef LIBSINGULAR__H\n#define LIBSINGULAR__H\n\n#include <math.h> // Why this?\n\n#include <singularconfig.h>\n#include <kernel/mod2.h>\n#include <kernel/structs.h>\n#include <kernel/polys.h>\n#include <coeffs/numbers.h>\n#include <kernel/oswrapper/feread.h>\n#include <polys/monomials/ring.h>\n#include <omalloc/omalloc.h>\n#include <polys/clapsing.h>\n#include <polys/monomials/maps.h>\n#include <kernel/GBEngine/kutil.h>\n#include <kernel/GBEngine/kstd1.h>\n#include <kernel/GBEngine/tgb.h>\n#include <polys/sparsmat.h>\n\n#include <Singular/mod_lib.h>\n#include <Singular/subexpr.h>\n#include <Singular/tok.h>\n#include <Singular/grammar.h>\n#include <Singular/ipid.h>\n#include <Singular/ipshell.h>\n#include <Singular/attrib.h>\n#include <misc/options.h>\n\nvoid siInit(char *);\n\n\n\n#endif // #ifndef LIBSINGULAR__H\n```\n\nIt all assume you have `-I$path/include/singular`. But the `factory` bit can go.",
    "created_at": "2016-11-07T01:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299320",
    "user": "@kiwifb"
}
```

I have problem with this on Volker's branch, since he included it.

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/misc/cython.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 317, in sage.misc.cython.?
Failed example:
    cython(os.linesep.join(code))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 501, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 864, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cython.?[1]>", line 1, in <module>
        cython(os.linesep.join(code))
      File "sage/misc/lazy_import.pyx", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/lazy_import.c:3998)
        return self._get_object()(*args, **kwds)
      File "sage/misc/cython_c.pyx", line 65, in sage.misc.cython_c.cython_compile (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cython_c.c:1178)
        cython_import_all(tmpfile, get_globals(),
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 710, in cython_import_all
        create_local_c_file=create_local_c_file)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 687, in cython_import
        **kwds)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 480, in cython
        raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/28014/tmp_SP1JOv.spyx:
    running build
    running build_ext
    building '_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0' extension
    creating build
    creating build/temp.linux-x86_64-2.7
    x86_64-pc-linux-gnu-g++ -pthread -fPIC -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/lib64/python2.7/site-packages/cysignals -I/home/fbissey/.sage/temp/QCD-nzi3/28014/spyx/_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_MTIPno_pyx/cysignals -I/home/fbissey/.sage/temp/QCD-nzi3/28014 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.cpp -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.o -w -O2

    In file included from _home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.cpp:424:0:
    /usr/include/singular/Singular/libsingular.h:6:28: fatal error: singularconfig.h: No such file or directory
    compilation terminated.
    error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1
```

Headers location have changed in singular 4 and the way to deal with them too. This is `libsingular.h`

```
#ifndef LIBSINGULAR__H
#define LIBSINGULAR__H

#include <math.h> // Why this?

#include <singularconfig.h>
#include <kernel/mod2.h>
#include <kernel/structs.h>
#include <kernel/polys.h>
#include <coeffs/numbers.h>
#include <kernel/oswrapper/feread.h>
#include <polys/monomials/ring.h>
#include <omalloc/omalloc.h>
#include <polys/clapsing.h>
#include <polys/monomials/maps.h>
#include <kernel/GBEngine/kutil.h>
#include <kernel/GBEngine/kstd1.h>
#include <kernel/GBEngine/tgb.h>
#include <polys/sparsmat.h>

#include <Singular/mod_lib.h>
#include <Singular/subexpr.h>
#include <Singular/tok.h>
#include <Singular/grammar.h>
#include <Singular/ipid.h>
#include <Singular/ipshell.h>
#include <Singular/attrib.h>
#include <misc/options.h>

void siInit(char *);



#endif // #ifndef LIBSINGULAR__H
```

It all assume you have `-I$path/include/singular`. But the `factory` bit can go.



---

archive/issue_comments_299321.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-11-07T01:58:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299321",
    "user": "@kiwifb"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_299322.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-11-07T02:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299322",
    "user": "@kiwifb"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_299323.json:
```json
{
    "body": "I didn't see that someone hacked singular headers to make it work. It is not the place of this ticket to discuss the wisdom of that move.",
    "created_at": "2016-11-07T02:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299323",
    "user": "@kiwifb"
}
```

I didn't see that someone hacked singular headers to make it work. It is not the place of this ticket to discuss the wisdom of that move.



---

archive/issue_comments_299324.json:
```json
{
    "body": "Replying to [comment:12 fbissey]:\n> I didn't see that someone hacked singular headers to make it work. It is not the place of this ticket to discuss the wisdom of that move.\n\nI submitted this as upstream issue https://www.singular.uni-kl.de:8002/trac/ticket/783",
    "created_at": "2016-11-07T12:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299324",
    "user": "@jdemeyer"
}
```

Replying to [comment:12 fbissey]:
> I didn't see that someone hacked singular headers to make it work. It is not the place of this ticket to discuss the wisdom of that move.

I submitted this as upstream issue https://www.singular.uni-kl.de:8002/trac/ticket/783



---

archive/issue_comments_299325.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-07T18:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21560",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21560#issuecomment-299325",
    "user": "@vbraun"
}
```

Resolution: fixed
