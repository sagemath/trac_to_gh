# Issue 21560: misc/cython.py: Clean up unnecessary include directories

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-11-02 02:16:49

CC:  jdemeyer

A doctest in misc/cython.py passes unnecessary include directories, depending on $SAGE_LOCAL.
We can remove it.


---

Comment by mkoeppe created at 2016-11-02 02:37:27

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-11-02 02:37:27

New commits:


---

Comment by jdemeyer created at 2016-11-02 07:20:50

Replying to [ticket:21797 mkoeppe]:
> The same file also uses `$SAGE_LOCAL/include/flint`, but that needs handling in a different way -- this will be on a different ticket.

Can you explain what makes flint different?


---

Comment by mkoeppe created at 2016-11-02 07:24:55

Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the "flint/" prefix.
This makes it necessary to add a separate include path.


---

Comment by jdemeyer created at 2016-11-02 08:01:56

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-11-02 08:01:56

Changing component from cython to doctest coverage.


---

Comment by mmezzarobba created at 2016-11-03 08:57:27

Replying to [comment:4 mkoeppe]:
> Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the "flint/" prefix.
> This makes it necessary to add a separate include path.

I'm lost: I just reviewed #21803 before discovering this ticket, and rebuilding modules that use flint seems to work, even though #21803 doesn't look like it does things differently from this ticket. What did I miss?


---

Comment by jdemeyer created at 2016-11-03 13:24:26

Replying to [comment:4 mkoeppe]:
> Flint's header files are installed in SAGE_LOCAL/include/flint but include each other without the "flint/" prefix.

That doesn't matter because

```
#include "foo.h"
```

will always look for `foo.h` in the same directory as the including file.

So, the include path would only matter for external includes (i.e. from Sage) and there we always use the `flint/` prefix.


---

Comment by mkoeppe created at 2016-11-03 14:10:01

Ah, thanks, I missed that.


---

Comment by fbissey created at 2016-11-07 01:34:48

I have problem with this on Volker's branch, since he included it.

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/misc/cython.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 317, in sage.misc.cython.?
Failed example:
    cython(os.linesep.join(code))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 501, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 864, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cython.?[1]>", line 1, in <module>
        cython(os.linesep.join(code))
      File "sage/misc/lazy_import.pyx", line 389, in sage.misc.lazy_import.LazyImport.__call__ (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/lazy_import.c:3998)
        return self._get_object()(*args, **kwds)
      File "sage/misc/cython_c.pyx", line 65, in sage.misc.cython_c.cython_compile (/scratch2/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/misc/cython_c.c:1178)
        cython_import_all(tmpfile, get_globals(),
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 710, in cython_import_all
        create_local_c_file=create_local_c_file)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 687, in cython_import
        **kwds)
      File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 480, in cython
        raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/28014/tmp_SP1JOv.spyx:
    running build
    running build_ext
    building '_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0' extension
    creating build
    creating build/temp.linux-x86_64-2.7
    x86_64-pc-linux-gnu-g++ -pthread -fPIC -I/usr/include -I/usr/include/python2.7 -I/usr/lib64/python2.7/site-packages/numpy/core/include -I/usr/lib64/python2.7/site-packages -I/usr/lib64/python2.7/site-packages/sage/ext -I/usr/lib64/python2.7/site-packages/cysignals -I/home/fbissey/.sage/temp/QCD-nzi3/28014/spyx/_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_MTIPno_pyx/cysignals -I/home/fbissey/.sage/temp/QCD-nzi3/28014 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.cpp -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.o -w -O2

    In file included from _home_fbissey__sage_temp_QCD_nzi3_28014_tmp_SP1JOv_spyx_0.cpp:424:0:
    /usr/include/singular/Singular/libsingular.h:6:28: fatal error: singularconfig.h: No such file or directory
    compilation terminated.
    error: command 'x86_64-pc-linux-gnu-g++' failed with exit status 1
```

Headers location have changed in singular 4 and the way to deal with them too. This is `libsingular.h`

```
#ifndef LIBSINGULAR__H
#define LIBSINGULAR__H

#include <math.h> // Why this?

#include <singularconfig.h>
#include <kernel/mod2.h>
#include <kernel/structs.h>
#include <kernel/polys.h>
#include <coeffs/numbers.h>
#include <kernel/oswrapper/feread.h>
#include <polys/monomials/ring.h>
#include <omalloc/omalloc.h>
#include <polys/clapsing.h>
#include <polys/monomials/maps.h>
#include <kernel/GBEngine/kutil.h>
#include <kernel/GBEngine/kstd1.h>
#include <kernel/GBEngine/tgb.h>
#include <polys/sparsmat.h>

#include <Singular/mod_lib.h>
#include <Singular/subexpr.h>
#include <Singular/tok.h>
#include <Singular/grammar.h>
#include <Singular/ipid.h>
#include <Singular/ipshell.h>
#include <Singular/attrib.h>
#include <misc/options.h>

void siInit(char *);



#endif // #ifndef LIBSINGULAR__H
```

It all assume you have `-I$path/include/singular`. But the `factory` bit can go.


---

Comment by fbissey created at 2016-11-07 01:58:57

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2016-11-07 02:07:14

Changing status from needs_work to positive_review.


---

Comment by fbissey created at 2016-11-07 02:07:14

I didn't see that someone hacked singular headers to make it work. It is not the place of this ticket to discuss the wisdom of that move.


---

Comment by jdemeyer created at 2016-11-07 12:42:44

Replying to [comment:12 fbissey]:
> I didn't see that someone hacked singular headers to make it work. It is not the place of this ticket to discuss the wisdom of that move.

I submitted this as upstream issue https://www.singular.uni-kl.de:8002/trac/ticket/783


---

Comment by vbraun created at 2016-11-07 18:27:33

Resolution: fixed
