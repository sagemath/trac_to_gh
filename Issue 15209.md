# Issue 15209: GP interface confused by stack overflow when enlarging results vector

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2013-11-22 18:49:31

Keywords: gp stack overflow

From Georgi Guninski on sage-support (https://groups.google.com/forum/#!topic/sage-support/A_GilhiUAwM):

```
sage: gp("{T(n)=n+1}")
sage: for n in [ 1 .. 2**20]:
    a=gp.T(n)
    print n

#wait some time..
...
65535
65536
---------------------------------------------------------------------------
TypeError

TypeError: Error executing code in GP:
CODE:
        sage[131074]=65537;
PARI/GP ERROR:
  ***   at top-level: sage[131074]=65537
  ***                     ^--------------
  ***   array index (131074) out of allowed range [1-131073].
```

after this trying:

```
sage: gp.T(1)
```

again raises exception.

After the above computation, the log file `.sage/gp-expect.log` ends with

```
? sage[131070]=65535;
sage[131070]=65535;
? sage[131071]=T(sage[131070]);
sage[131071]=T(sage[131070]);
? sage=concat(sage, vector(131072,k,0));
sage=concat(sage, vector(131072,k,0));
  ***   at top-level: sage=concat(sage,vec
  ***                 ^--------------------
  ***   the PARI stack overflows !
  current stack size: 10000000 (9.537 Mbytes)
  [hint] you can increase GP stack with allocatemem()

? allocatemem()
allocatemem()
  ***   Warning: new stack size = 20000000 (19.073 Mbytes).
? sage=concat(sage, vector(131072,k,0));
sage=concat(sage, vector(131072,k,0));
? sage[131072]=65536;
sage[131072]=65536;
? sage[131073]=T(sage[131072]);
sage[131073]=T(sage[131072]);
? sage[131074]=65537;
sage[131074]=65537;
  ***   at top-level: sage[131074]=65537
  ***                     ^--------------
  ***   array index (131074) out of allowed range [1-131073].
?
```

It appears that the vector `sage` wasn't doubled correctly; probably it got messed up by the failed `concat()`.

This could be related to #11017/#11018.


---

Comment by pbruin created at 2014-02-18 14:52:24

The problem appears to be fixed by introducing a temporary variable to hold the result of `concat()` instead of directly assigning it to `sage`.


---

Comment by pbruin created at 2014-02-18 14:52:24

Changing status from new to needs_review.


---

Comment by git created at 2014-02-20 00:49:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by pbruin created at 2014-02-20 00:50:18

Never mind the commit in comment:3, this breaks when there are more than 65535 variables.


---

Comment by git created at 2014-02-20 00:52:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by ArgaezG created at 2014-02-21 18:00:11

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-02-21 20:27:27

Alejandro, could you fill in your name (more precisely your real name, not Trac username) in the "Reviewer" field?


---

Comment by vbraun created at 2014-02-22 21:23:50

Resolution: fixed
