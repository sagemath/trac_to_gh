# Issue 24698: Upgrade to Sphinx 1.7.1

Issue created by migration from https://trac.sagemath.org/ticket/24935

Original creator: jdemeyer

Original creation time: 2018-03-09 13:06:24

CC:  embray fbissey dimpase




---

Comment by jdemeyer created at 2018-03-16 10:21:11

New commits:


---

Comment by git created at 2018-03-16 10:22:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-16 11:33:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-16 15:57:47

Changing status from new to needs_review.


---

Comment by rws created at 2018-03-19 14:43:04

Can you please give a link to the sphinxcontrib_websupport package, or is it supposed to be installed by other means? An upgrade attempt failed here because the mirrors didn't have it.


---

Comment by jdemeyer created at 2018-03-19 18:17:21

Replying to [comment:9 rws]:
> Can you please give a link to the sphinxcontrib_websupport package, or is it supposed to be installed by other means?

It's linked on the dependency #24972


---

Comment by rws created at 2018-03-20 07:09:04

Changing status from needs_review to needs_info.


---

Comment by rws created at 2018-03-20 07:09:04


```
**********************************************************************
File "src/sage/misc/sphinxify.py", line 51, in sage.misc.sphinxify.sphinxify
Failed example:
    sphinxify('**Testing**\n`monospace`')
Expected:
    '...<div class="docstring"...<strong>Testing</strong>\n<span class="math"...</p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><strong>Testing</strong>\n<span class="math notranslate">monospace</span></p>\n\n\n</div>'
**********************************************************************
File "src/sage/misc/sphinxify.py", line 53, in sage.misc.sphinxify.sphinxify
Failed example:
    sphinxify('`x=y`')
Expected:
    '...<div class="docstring">\n    \n  <p><span class="math">x=y</span></p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><span class="math notranslate">x=y</span></p>\n\n\n</div>'
**********************************************************************
```



---

Comment by rws created at 2018-03-20 07:09:18

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2018-03-20 08:47:43

I did not consider that Sphinx might affect doctests too.


---

Comment by git created at 2018-03-20 10:41:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-03-20 12:35:05

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-03-20 12:57:16

Replying to [comment:13 jdemeyer]:
> I did not consider that Sphinx might affect doctests too.

It definitely can :)  There are several places in Python 3 where I've had to make sure to ignore some python 3 specific `DeprecationWarning`s from Sphinx at import time or else it broke some tests.  So I'm not too surprised that a Sphinx upgrade might also affect some docbuild-related tests.


---

Comment by rws created at 2018-03-20 14:29:43

It would be great if patchbot could test "unsafe" tickets but I remember about difficulties.


---

Comment by rws created at 2018-03-20 14:29:43

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-03-20 15:30:01

Replying to [comment:17 rws]:
> It would be great if patchbot could test "unsafe" tickets but I remember about difficulties.
> 

I already have a patch for patchbot that will allow it to test tickets with new packages.  It's been running on my Cygwin patchbot for a while now, but it does occasionally run into hiccups requiring me to manually restart the patchbot (after cleaning things up a bit).

I especially am not 100% sure why this happens sometimes, since the patchbot creates a copy of SAGE_LOCAL for "unsafe" tickets before doing much else.


---

Comment by jdemeyer created at 2018-03-20 15:33:46

Speaking of "unsafe" tickets, I'm not convinced that "unsafe" tickets are on average less safe than "safe" tickets. We certainly have had "safe" tickets messing up a patchbot installation.


---

Comment by embray created at 2018-03-20 15:37:08

Yes, it's a pretty flimsy distinction.


---

Comment by rws created at 2018-03-20 16:34:00

Replying to [comment:18 embray]:
> I especially am not 100% sure why this happens sometimes, since the patchbot creates a copy of SAGE_LOCAL for "unsafe" tickets before doing much else.

Please note https://github.com/sagemath/sage-patchbot/issues/34


---

Comment by vbraun created at 2018-05-10 07:05:40

PDF docs don't build...


---

Comment by vbraun created at 2018-05-10 07:05:40

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-15 14:51:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-16 13:31:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-05-16 15:03:12

Replying to [comment:22 vbraun]:
> PDF docs don't build...

Indeed... unfortunately it's a genuine problem with Sphinx. I reported it at https://github.com/sphinx-doc/sphinx/issues/4978


---

Comment by git created at 2018-06-04 07:42:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slelievre created at 2018-06-04 19:25:41

The Sphinx problem with Brazilian is fixed [0] but
now there is a Sphinx problem with Russian [1].

- [0] https://github.com/sphinx-doc/sphinx/issues/4978
- [1] https://github.com/sphinx-doc/sphinx/issues/5037


---

Comment by git created at 2018-06-06 15:31:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-07 12:24:00

This took several iterations to get right, but now the PDF docs build for me.


---

Comment by jdemeyer created at 2018-06-07 12:24:00

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2018-06-07 23:25:23

Upstream greatly simplified the patch for PR5400 but I'll admit I am unclear if it can be used alone or need some other PR to go with it.


---

Comment by jdemeyer created at 2018-06-08 08:15:18

Are you referring to https://github.com/sphinx-doc/sphinx/pull/5045?

Anyway, the current branch seems to work so I'd rather keep it.


---

Comment by fbissey created at 2018-06-08 08:19:50

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-06-08 08:19:50

Replying to [comment:37 jdemeyer]:
> Are you referring to https://github.com/sphinx-doc/sphinx/pull/5045?
> 
> Anyway, the current branch seems to work so I'd rather keep it.

No. 5040 has two commits. Your current patch is the first one. It is described as a temporary solution while the second commit is more "future proofing". But indeed the first commit you are using is supposed to work. Let's send this to the bots as is.


---

Comment by jdemeyer created at 2018-06-08 08:28:46

Replying to [comment:38 fbissey]:
> Your current patch is the first one.

It actually contains both commits.


---

Comment by fbissey created at 2018-06-08 08:32:30

Cumulative patches on the same files confuse me no end.


---

Comment by vbraun created at 2018-06-10 08:15:36

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-06-10 08:15:36


```
sage -t --long src/sage/misc/sphinxify.py  # 2 doctests failed
sage -t --long local/lib/python2.7/site-packages/sagenb/misc/sphinxify.py  # 2 doctests failed
```



---

Comment by fbissey created at 2018-06-10 08:22:46

Trivial but we should have seen it in reviews

```
fbissey@moonloop ~ $ sage -t --long /usr/lib64/python2.7/site-packages/sage/misc/sphinxify.py 
too many failed tests, not using stored timings
Running doctests with ID 2018-06-10-20-16-29-93e55012.
Using --optional=optional,sage
Doctesting 1 file.
sage -t --long /usr/lib64/python2.7/site-packages/sage/misc/sphinxify.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/misc/sphinxify.py", line 51, in sage.misc.sphinxify.sphinxify
Failed example:
    sphinxify('**Testing**\n`monospace`')
Expected:
    '<div class="docstring"...<strong>Testing</strong>\n<span class="math notranslate"...</p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><strong>Testing</strong>\n<span class="math notranslate nohighlight">monospace</span></p>\n\n\n</div>'
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/misc/sphinxify.py", line 53, in sage.misc.sphinxify.sphinxify
Failed example:
    sphinxify('`x=y`')
Expected:
    '<div class="docstring">\n    \n  <p><span class="math notranslate">x=y</span></p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><span class="math notranslate nohighlight">x=y</span></p>\n\n\n</div>'
**********************************************************************
1 item had failures:
   2 of  10 in sage.misc.sphinxify.sphinxify
    [9 tests, 2 failures, 1.02 s]
----------------------------------------------------------------------
sage -t --long /usr/lib64/python2.7/site-packages/sage/misc/sphinxify.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 1.0 seconds
    cpu time: 1.0 seconds
    cumulative wall time: 1.0 seconds
fbissey@moonloop ~ $ sage -t --long /usr/lib64/python2.7/site-packages/sagenb/misc/sphinxify.py 
too many failed tests, not using stored timings
Running doctests with ID 2018-06-10-20-17-44-197b0e5d.
Using --optional=optional,sage
Doctesting 1 file.
sage -t --long /usr/lib64/python2.7/site-packages/sagenb/misc/sphinxify.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sagenb/misc/sphinxify.py", line 68, in sagenb.misc.sphinxify.sphinxify
Failed example:
    sphinxify('**Testing**\n`monospace`')
Expected:
    '...<div class="docstring"...<strong>Testing</strong>\n<span class="math"...</p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><strong>Testing</strong>\n<span class="math notranslate nohighlight">monospace</span></p>\n\n\n</div>'
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sagenb/misc/sphinxify.py", line 70, in sagenb.misc.sphinxify.sphinxify
Failed example:
    sphinxify('`x=y`')
Expected:
    '...<div class="docstring">\n    \n  <p><span class="math">x=y</span></p>\n\n\n</div>'
Got:
    '<div class="docstring">\n    \n  <p><span class="math notranslate nohighlight">x=y</span></p>\n\n\n</div>'
**********************************************************************
1 item had failures:
   2 of  10 in sagenb.misc.sphinxify.sphinxify
    [14 tests, 2 failures, 0.74 s]
----------------------------------------------------------------------
sage -t --long /usr/lib64/python2.7/site-packages/sagenb/misc/sphinxify.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 1.2 seconds
    cpu time: 0.7 seconds
    cumulative wall time: 0.7 seconds
```

That unfortunately requires a new version of `sagenb`. `@`Dima could we get a 1.0.3 for this.


---

Comment by dimpase created at 2018-06-10 08:37:34

OK, so that's just doctests  in sagenb, right? No problem, I'll fix these.
https://github.com/sagemath/sagenb/issues/445


---

Comment by jdemeyer created at 2018-06-10 09:23:53

Replying to [comment:42 fbissey]:
> Trivial but we should have seen it in reviews

Right. I just did not think about running doctests after fixing the PDF documentation stuff.


---

Comment by fbissey created at 2018-06-10 22:10:39

Replying to [comment:43 dimpase]:
> OK, so that's just doctests  in sagenb, right? No problem, I'll fix these.
> https://github.com/sagemath/sagenb/issues/445

The commit works for me. We just have to reproduce it in sage's `sphinxify.py`.


---

Comment by dimpase created at 2018-06-10 22:50:24

here is the new sagenb https://github.com/sagemath/sagenb/releases/download/1.0.3/sagenb-1.0.3.tar.bz2

Could you bump up the version in build/pkgs/sagenb/ etc to include it on this ticket?


---

Comment by fbissey created at 2018-06-10 22:52:20

Replying to [comment:46 dimpase]:
> here is the new sagenb https://github.com/sagemath/sagenb/releases/download/1.0.3/sagenb-1.0.3.tar.bz2
> 
> Could you bump up the version in build/pkgs/sagenb/ etc to include it on this ticket?

Definitely. I am leaving it to Jeroen as the ticket author, unless he indicates he is too busy to handle it in which case I will step up.


---

Comment by jdemeyer created at 2018-06-11 08:04:40

Replying to [comment:47 fbissey]:
> I am leaving it to Jeroen as the ticket author, unless he indicates he is too busy to handle it in which case I will step up.

It's literally my job to do this...


---

Comment by git created at 2018-06-11 08:20:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-11 08:20:55

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2018-06-11 08:26:39

Works for me.


---

Comment by fbissey created at 2018-06-11 08:26:39

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-06-11 12:28:59

Damn. Could we get rid of the `"import __builtin__"` in sagenb/misc/sphinxify.py and sagenb/misc/support.py ??

This is breaking the compatibility of sagenb with python3...


---

Comment by jdemeyer created at 2018-06-11 12:58:46

Replying to [comment:53 chapoton]:
> Damn. Could we get rid of the `"import __builtin__"` in sagenb/misc/sphinxify.py and sagenb/misc/support.py ??

Perhaps, but not in this ticket please.


---

Comment by fbissey created at 2018-06-11 20:55:02

Replying to [comment:54 jdemeyer]:
> Replying to [comment:53 chapoton]:
> > Damn. Could we get rid of the `"import __builtin__"` in sagenb/misc/sphinxify.py and sagenb/misc/support.py ??
> 
> Perhaps, but not in this ticket please.

Totally agree with Jeroen, another ticket please. 

That being said, historically we have migrated `sphinxify.py` from `sagenb` into sage to reduce dependency on `sagenb` (that's what I remember at least). If you want to work on that, I would really suggest to try eliminating the `sphinxify.py` of `sagenb` and use sage's one instead.


---

Comment by vbraun created at 2018-06-12 20:45:51


```
File "src/doc/common/conf.py", line 627, in doc.common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():
        if "padics" in line:
            sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics ...)"><span>Introduction to the -adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics)"><span>Introduction to the -adics</span></a></li>
**********************************************************************
1 item had failures:
   1 of   4 in doc.common.conf.call_intersphinx
    [3 tests, 1 failure, 0.61 s]
```



---

Comment by vbraun created at 2018-06-12 20:45:51

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2018-06-12 21:36:17

I have seen it too in the vbraun branch and it confused me quite a bit because I don't remember seeing it the first time round but it should have been there. It seems like before this ticket the title field ends up with ` v` as in `title="(in Sage Reference Manual:  p-Adics v)` not just for this particular one that's tested but for all of them. After this ticket it is reduced to just `title="(in Sage Reference Manual: p-Adics)` and the ` v` has disappeared everywhere.


---

Comment by jdemeyer created at 2018-06-13 11:36:24

It's supposed to say `v8.3.beta5` so that's a regression somehow.


---

Comment by jdemeyer created at 2018-06-13 11:44:26

I opened #25570 for the version number regression.


---

Comment by jdemeyer created at 2018-06-13 11:44:26

Changing status from needs_work to positive_review.


---

Comment by git created at 2018-06-13 12:41:21

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by git created at 2018-06-13 12:41:21

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2018-06-14 12:10:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-17 22:15:18

Resolution: fixed
