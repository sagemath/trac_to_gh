# Issue 18767: Do not search old-style spkgs

Issue created by migration from https://trac.sagemath.org/ticket/19004

Original creator: vbraun

Original creation time: 2015-08-09 08:49:35




---

Comment by git created at 2015-08-09 09:33:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-08-09 09:34:39

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-08-09 09:34:39

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2015-08-09 09:34:39

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2015-08-09 09:39:06


```
$ tox
[...]
  py26: commands succeeded
  py27: commands succeeded
  py33: commands succeeded
  py34: commands succeeded
  congratulations :)
```



---

Comment by dimpase created at 2015-08-10 20:01:35

What does `Levenshtein Distance` do here? It should be in `src/sage/coding/`...


---

Comment by vbraun created at 2015-08-10 20:15:30

Its here so we can suggest similarly-named packages

```
$ ./build/bin/sage-package apropos python
Did you mean: cython, ipython, python2, python3, patch?
```

`sage_bootstrap` must work without Sage for the obvious chicken-and-egg reasons, so no, we can't put it anywhere else.


---

Comment by jhpalmieri created at 2015-08-10 21:22:31

Re "call the new package manager", how long will it be "new"? Maybe this should just say "Call Sage's package manager".


---

Comment by jhpalmieri created at 2015-08-10 21:27:38

To clarify: if you want to install an old-style spkg, do you need to download the spkg file manually and then do `sage -i FILE`?


---

Comment by vdelecroix created at 2015-08-10 22:15:59

on the wishlist:

Having as answer `patch` when asking for `python` is funny ;-) And having `cython` first is bad as well. Could you weight the Levenshtein distance. Reasonable parameters for your purpose might be:
 - deletion: 1
 - addition: 1
 - exchange: 2  (so basically this would count for one deletion + one addition)

`patch` would then be out if I count well (would be distance 6) and `cython` will appear after `python2` and `python3` (would be distance `2` against `1`).


---

Comment by vbraun created at 2015-08-10 23:00:29

We'll call it new until New Hall changes its name, easy.

Both `sage -i /path/to/old.spkg` and `sage -i http://url/to/old.spkg` still work.

Ad hoc weighting the distance is so passe, we should train a RNN on command line input! This is obviously a good investment of time and developer effort.


---

Comment by jhpalmieri created at 2015-08-10 23:37:35

Also on the wishlist: the suggestions should also include relevant old-style packages, perhaps with a suitable warning (while we don't want someone to install the old "python" package, we should be happy to have them install the "p_group_cohomology" package).


---

Comment by vbraun created at 2015-08-13 20:29:47

Any actionable suggestions or should I just go with the original plan and delete the spkgs from the server?


---

Comment by jhpalmieri created at 2015-08-16 15:08:28

So what will happen to the `p_group_cohomology` package, for example? Will it completely disappear from the lists of available packages? If this is the plan, then I object. We would need some sort of official deprecation period for old-style packages, and at the end of that period (which could be strictly enforced, unlike some of our other deprecation time tables), then we delete all old-style packages.


---

Comment by jdemeyer created at 2015-08-16 21:44:36

Replying to [comment:13 jhpalmieri]:
> some of our other deprecation time tables
[off topic] A deprecation is not a time table: deprecated code MAY be removed after one year, it's not that it SHOULD be removed.


---

Comment by vbraun created at 2015-08-16 22:46:09

Nothing will happen to the `p_group_cohomology` package. You can install it by specifying its path or url. The only change is that installing `python` will no longer automatically download the ancient python spkg.


---

Comment by jhpalmieri created at 2015-08-16 23:45:12

I'm sorry, I'm confused again. Are you just proposing the changes in the branch, or also to remove files from the server? It's important that commands like `sage --optional` still list the old-style packages. If you actually remove them from the server, that won't happen, right?


```
$ sage -i p_group_cohomology
Attempting to download package p_group_cohomology
Error: could not find a package matching p_group_cohomology
       Try 'sage --package list' to see the available packages
       There is no package similar to p_group_cohomology
```

Then since `sage --package list` doesn't actually list `p_group_cohomology`, it is not clear how someone is supposed to find out about it or find its URL. `sage --optional` does list it, but doesn't say how to obtain it. If I were a novice user, I would be confused about whether this was a valid package or not.

It might be better if, instead of deleting item 2b, it behaved differently: it should never install a package, but only print a warning, something like: "Old-style Sage package available from <URL>. Run <CMD> to install it. Only do this if you know what you're doing." In addition, it should print the apropos message (probably first), so someone running `sage -i python` will be given appropriate advice.


---

Comment by vbraun created at 2015-08-17 07:47:02

Nobody in their right mind is going to want to install the old python spkg. Its akin to handing out razor blades to babies if you just tell people to type in this other command to install the python spkg. The entire mashing-up old (and almost always broken) and new packages is insane, and technically savvy users trip over it on a daily basis. As documented on sage-devel. 

This ticket doesn't change `sage --optional`, but IMHO its just as insane that it mashes old and new spkgs together. In any case, this is not what this ticket is about. 

If you want to distribute code outside of Sage (in a spkg) then imho its not too much to ask that you also tell your users the download url. Weighted against the very real and documented risk that people get confused about standard packages, this is a no-brainer to me.


---

Comment by jhpalmieri created at 2015-08-17 14:56:37

Replying to [comment:17 vbraun]:
> Nobody in their right mind is going to want to install the old python spkg.

Absolutely.

> If you want to distribute code outside of Sage (in a spkg) then imho its not too much to ask that you also tell your users the download url.

Okay, but Simon's package is not being distributed outside of Sage: you are proposing with this ticket to move it outside of Sage. I think a deprecation period makes a lot of sense, giving the late-adopters time to update their old-style packages. It is not reasonable, on the other hand, to just say "we are immediately deleting all old-style packages from the servers with no warning."


---

Comment by vbraun created at 2015-08-17 19:13:12

Well fine then we shall be completely utterly broken for a year, to the extent that William can't even install anything. Cool.


---

Comment by jhpalmieri created at 2015-08-17 19:38:50

How about this, instead: for old-style packages, if the apropos function finds anything, just print that message and exit. If it doesn't find anything, search the servers and print the URL of the matching package, with instructions on how to install it. Not perfect, but it doesn't just dump all of the old packages.

I also didn't say we had to wait a year. Three months might be enough warning.


---

Comment by vbraun created at 2015-08-17 20:16:20

How about we move the spkgs to http://old.files.sagemath.org/spkg/archive/ and have apropos print that url if it can't find anything.


---

Comment by jhpalmieri created at 2015-08-17 20:34:27

That sounds okay to me.


---

Comment by git created at 2015-08-17 21:04:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-17 21:14:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-08-17 21:15:45

Actually, http://files.sagemath.org/spkg/ is a better link.

The spkgs can actualy stay where they are now if we don't search for them.
----
New commits:


---

Comment by jhpalmieri created at 2015-08-17 22:58:30

It's not ideal (http://files.sagemath.org/spkg/ is not the friendliest web site), but it's basically good enough for me. I would suggest either of the following changes:

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index a9f68a6..9c0c00c 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -57,6 +57,25 @@
 # Avoid surprises with character ranges [a-z] in regular expressions
 export LC_ALL=C
 
+usage()
+{
+cat <<EOF
+Usage: sage -i <options> <package name>
+
+If <package name> is a URL, download and install it. If it is a file
+name, install it. Otherwise, search Sage's list of packages (see 'sage
+--package list') for a matching package, and if a match is found,
+install it.
+
+Options:
+   -f: force install a package even if the same version is already installed
+   -s: do not delete temporary build directory
+   -c: after installing, run the test suite for the spkg
+   -d: only download the package
+
+EOF
+}
+
 # error_msg(header, command)
 # This is for printing an error message if something went wrong.
 # The first argument is the header to print, the second argument should
@@ -152,8 +171,8 @@ fi
 # Handle special command-line options
 ##################################################################
 if [ $# -eq 0 ]; then
-    echo "Currently installed packages:"
-    exec ls -1 "$SAGE_SPKG_INST"
+    usage
+    exit 0
 fi
 
 # Options have to come in a specific order,
```

or

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index a9f68a6..2ddd35b 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -153,7 +153,7 @@ fi
 ##################################################################
 if [ $# -eq 0 ]; then
     echo "Currently installed packages:"
-    exec ls -1 "$SAGE_SPKG_INST"
+    exec sage-list-packages installed
 fi
 
 # Options have to come in a specific order,
```

I have a slight preference for the first, since `sage -i <pkg>` is not very well documented. I also don't think that `sage -i` (with no arguments) is documented anywhere, so maybe it's not a terrible idea to change its behavior. Or we could use the second change and add a `-h` flag for the usage message.

(My goal here is to not leave someone completely baffled if they want to install an old-style package.)

Meanwhile, it would be good to reiterate on sage-devel that old-style packages are on the way out, so people who maintain them should update to new-style packages ASAP.


---

Comment by vbraun created at 2015-08-18 17:38:10

I'm fine with either, can you add a commit?


---

Comment by jhpalmieri created at 2015-08-18 22:07:55

Sure, here you go.


---

Comment by vbraun created at 2015-08-20 13:01:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-08-21 01:56:10

Resolution: fixed
