# Issue 31582: Only subfaces/supfaces for polyhedral face iterator

archive/issues_031582.json:
```json
{
    "body": "CC:  mkoeppe yzh\n\nKeywords: face iterator, polyhedron\n\nWe allow for the face iterator to only visit subsets of the current face.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31819\n\n",
    "created_at": "2021-05-12T09:23:39Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Only subfaces/supfaces for polyhedral face iterator",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31582",
    "user": "@kliem"
}
```
CC:  mkoeppe yzh

Keywords: face iterator, polyhedron

We allow for the face iterator to only visit subsets of the current face.

Issue created by migration from https://trac.sagemath.org/ticket/31819





---

archive/issue_comments_451252.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-05-12T09:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451252",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_451253.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-12T09:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451253",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451254.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-12T14:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451254",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451255.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-13T18:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451255",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451256.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-05-13T18:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451256",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_451257.json:
```json
{
    "body": "(Edited)\nYou probably need to rebase this ticket on the #29683, or put `face.ambient_H_indices(add_equations=False) ` everywhere.",
    "created_at": "2021-05-20T02:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451257",
    "user": "yzh"
}
```

(Edited)
You probably need to rebase this ticket on the #29683, or put `face.ambient_H_indices(add_equations=False) ` everywhere.



---

archive/issue_comments_451258.json:
```json
{
    "body": "Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.\n\n```\ncdef inline int next_face_loop(iter_t structure) nogil except -1:\n    r\"\"\"\n    See :meth:`FaceIterator.next_face_loop`.\n    \"\"\"\n    if unlikely(structure.current_dimension == structure.dimension):\n        # The function is not supposed to be called,\n        # just prevent it from crashing.\n        raise StopIteration\n```\n",
    "created_at": "2021-05-20T03:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451258",
    "user": "yzh"
}
```

Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.

```
cdef inline int next_face_loop(iter_t structure) nogil except -1:
    r"""
    See :meth:`FaceIterator.next_face_loop`.
    """
    if unlikely(structure.current_dimension == structure.dimension):
        # The function is not supposed to be called,
        # just prevent it from crashing.
        raise StopIteration
```




---

archive/issue_comments_451259.json:
```json
{
    "body": "Does `self.structure.dimension` in `cdef int find_face(self, face_t face) except -1` need changing?",
    "created_at": "2021-05-20T03:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451259",
    "user": "yzh"
}
```

Does `self.structure.dimension` in `cdef int find_face(self, face_t face) except -1` need changing?



---

archive/issue_comments_451260.json:
```json
{
    "body": "In `face_iterator.pxd`: New value 3 to be added to the comment\n\n```\nint face_status            # 0 not initialized, 1 initialized, 2 added to visited_all\n```\n",
    "created_at": "2021-05-20T04:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451260",
    "user": "yzh"
}
```

In `face_iterator.pxd`: New value 3 to be added to the comment

```
int face_status            # 0 not initialized, 1 initialized, 2 added to visited_all
```




---

archive/issue_comments_451261.json:
```json
{
    "body": "\n```\nraise ValueError(\"cannot only visit subsets after ignoring a face\")\nraise ValueError(\"cannot ignore a face after setting iterator to only visit subsets\")\n```\n\nI understood the first, but not the second. Why is it an error, rather than say that the iterator is consumed? \nI apologize if this is a silly question",
    "created_at": "2021-05-20T04:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451261",
    "user": "yzh"
}
```


```
raise ValueError("cannot only visit subsets after ignoring a face")
raise ValueError("cannot ignore a face after setting iterator to only visit subsets")
```

I understood the first, but not the second. Why is it an error, rather than say that the iterator is consumed? 
I apologize if this is a silly question



---

archive/issue_comments_451262.json:
```json
{
    "body": "\n```\ncdef int only_subsets(self) except -1:\n    self.structure.highest_dimension = self.structure.current_dimension - 1\n```\n\nWhy doesn't it prevent visiting the (sub) faces of dimension >= `self.structure.current_dimension`?",
    "created_at": "2021-05-20T04:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451262",
    "user": "yzh"
}
```


```
cdef int only_subsets(self) except -1:
    self.structure.highest_dimension = self.structure.current_dimension - 1
```

Why doesn't it prevent visiting the (sub) faces of dimension >= `self.structure.current_dimension`?



---

archive/issue_comments_451263.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-05-20T07:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451263",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_451264.json:
```json
{
    "body": "Replying to [comment:11 yzh]:\n> {{{\n> raise ValueError(\"cannot only visit subsets after ignoring a face\")\n> raise ValueError(\"cannot ignore a face after setting iterator to only visit subsets\")\n> }}}\n> I understood the first, but not the second. Why is it an error, rather than say that the iterator is consumed? \n> I apologize if this is a silly question\n\nIt's not a silly question and even if it where: You are reviewing the ticket and I'm very thankful for this. You have every right to ask silly questions.\n\nFixed.",
    "created_at": "2021-05-20T07:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451264",
    "user": "@kliem"
}
```

Replying to [comment:11 yzh]:
> {{{
> raise ValueError("cannot only visit subsets after ignoring a face")
> raise ValueError("cannot ignore a face after setting iterator to only visit subsets")
> }}}
> I understood the first, but not the second. Why is it an error, rather than say that the iterator is consumed? 
> I apologize if this is a silly question

It's not a silly question and even if it where: You are reviewing the ticket and I'm very thankful for this. You have every right to ask silly questions.

Fixed.



---

archive/issue_comments_451265.json:
```json
{
    "body": "Replying to [comment:9 yzh]:\n> Does `self.structure.dimension` in `cdef int find_face(self, face_t face) except -1` need changing?\n\nI specified what I expect in `find_face`. It's a hidden cython method. So I think it is fine to assume things without checking.\n\nIt's not a terrible fail, if `self.structure.highest_dimension` was set. This would just be ignored in this case.",
    "created_at": "2021-05-20T07:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451265",
    "user": "@kliem"
}
```

Replying to [comment:9 yzh]:
> Does `self.structure.dimension` in `cdef int find_face(self, face_t face) except -1` need changing?

I specified what I expect in `find_face`. It's a hidden cython method. So I think it is fine to assume things without checking.

It's not a terrible fail, if `self.structure.highest_dimension` was set. This would just be ignored in this case.



---

archive/issue_comments_451266.json:
```json
{
    "body": "Replying to [comment:8 yzh]:\n> Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.\n> {{{\n> cdef inline int next_face_loop(iter_t structure) nogil except -1:\n>     r\"\"\"\n>     See :meth:`FaceIterator.next_face_loop`.\n>     \"\"\"\n>     if unlikely(structure.current_dimension == structure.dimension):\n>         # The function is not supposed to be called,\n>         # just prevent it from crashing.\n>         raise StopIteration\n> }}}\n\nThis just prevents segmentation fault. It's never supposed to happen anyway. In fact I can't even change this. Because when I set `highest_dimension` it will be equal to `current_dimension`. Only after running this, is `current_dimension` lower, if there are faces left.",
    "created_at": "2021-05-20T07:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451266",
    "user": "@kliem"
}
```

Replying to [comment:8 yzh]:
> Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.
> {{{
> cdef inline int next_face_loop(iter_t structure) nogil except -1:
>     r"""
>     See :meth:`FaceIterator.next_face_loop`.
>     """
>     if unlikely(structure.current_dimension == structure.dimension):
>         # The function is not supposed to be called,
>         # just prevent it from crashing.
>         raise StopIteration
> }}}

This just prevents segmentation fault. It's never supposed to happen anyway. In fact I can't even change this. Because when I set `highest_dimension` it will be equal to `current_dimension`. Only after running this, is `current_dimension` lower, if there are faces left.



---

archive/issue_comments_451267.json:
```json
{
    "body": "Replying to [comment:12 yzh]:\n> {{{\n> cdef int only_subsets(self) except -1:\n>     self.structure.highest_dimension = self.structure.current_dimension - 1\n> }}}\n> Why doesn't it prevent visiting the (sub) faces of dimension >= `self.structure.current_dimension`?\n\nI don't understand the question.\n\n`next_dimension` first calls `next_face_loop`. `only_subsets` makes sure that `next_face_loop` actually gets to the point of calling `get_next_level` (unless our face is the the only face left, than there are no new subfaces). If `new_faces_counter` is non-zero, the current dimension is lowered and it holds that `current_dimension < highest_dimension`.\n\nIf `new_faces_counter` is zero and there are no new subfaces, then `next_face_loop` returns `0` and `next_dimension` terminates as `current_dimension = highest_dimension`.\n\nWhenever `next_face_loop` raises the dimension, it will return `0`. This way `next_dimension` will in fact check, that we still have `current_dimension <= highest_dimension`.",
    "created_at": "2021-05-20T08:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451267",
    "user": "@kliem"
}
```

Replying to [comment:12 yzh]:
> {{{
> cdef int only_subsets(self) except -1:
>     self.structure.highest_dimension = self.structure.current_dimension - 1
> }}}
> Why doesn't it prevent visiting the (sub) faces of dimension >= `self.structure.current_dimension`?

I don't understand the question.

`next_dimension` first calls `next_face_loop`. `only_subsets` makes sure that `next_face_loop` actually gets to the point of calling `get_next_level` (unless our face is the the only face left, than there are no new subfaces). If `new_faces_counter` is non-zero, the current dimension is lowered and it holds that `current_dimension < highest_dimension`.

If `new_faces_counter` is zero and there are no new subfaces, then `next_face_loop` returns `0` and `next_dimension` terminates as `current_dimension = highest_dimension`.

Whenever `next_face_loop` raises the dimension, it will return `0`. This way `next_dimension` will in fact check, that we still have `current_dimension <= highest_dimension`.



---

archive/issue_comments_451268.json:
```json
{
    "body": "Replying to [comment:16 gh-kliem]:\n> Replying to [comment:8 yzh]:\n> > Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.\n> > {{{\n> > cdef inline int next_face_loop(iter_t structure) nogil except -1:\n> >     r\"\"\"\n> >     See :meth:`FaceIterator.next_face_loop`.\n> >     \"\"\"\n> >     if unlikely(structure.current_dimension == structure.dimension):\n> >         # The function is not supposed to be called,\n> >         # just prevent it from crashing.\n> >         raise StopIteration\n> > }}}\n> \n> This just prevents segmentation fault. It's never supposed to happen anyway. In fact I can't even change this. Because when I set `highest_dimension` it will be equal to `current_dimension`. Only after running this, is `current_dimension` lower, if there are faces left.\n\nI meant to change to `if unlikely(self.structure.current_dimension > self.structure.highest_dimension):` like all other checkings.\n\nSure, if it never happens, then the current version is fine.",
    "created_at": "2021-05-21T04:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451268",
    "user": "yzh"
}
```

Replying to [comment:16 gh-kliem]:
> Replying to [comment:8 yzh]:
> > Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.
> > {{{
> > cdef inline int next_face_loop(iter_t structure) nogil except -1:
> >     r"""
> >     See :meth:`FaceIterator.next_face_loop`.
> >     """
> >     if unlikely(structure.current_dimension == structure.dimension):
> >         # The function is not supposed to be called,
> >         # just prevent it from crashing.
> >         raise StopIteration
> > }}}
> 
> This just prevents segmentation fault. It's never supposed to happen anyway. In fact I can't even change this. Because when I set `highest_dimension` it will be equal to `current_dimension`. Only after running this, is `current_dimension` lower, if there are faces left.

I meant to change to `if unlikely(self.structure.current_dimension > self.structure.highest_dimension):` like all other checkings.

Sure, if it never happens, then the current version is fine.



---

archive/issue_comments_451269.json:
```json
{
    "body": "\n```\n    if n_faces <= 1:\n        # There will be no more faces from intersections.\n        structure.current_dimension += 1\n        return 0\n```\n\nWhat do you mean by \"no more faces from intersections\"? Why is it `n_faces <= 1`, not `n_faces == 0`, nor `n_faces == 1`?",
    "created_at": "2021-05-21T05:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451269",
    "user": "yzh"
}
```


```
    if n_faces <= 1:
        # There will be no more faces from intersections.
        structure.current_dimension += 1
        return 0
```

What do you mean by "no more faces from intersections"? Why is it `n_faces <= 1`, not `n_faces == 0`, nor `n_faces == 1`?



---

archive/issue_comments_451270.json:
```json
{
    "body": "All other things on this ticket look good to me. Thanks for the explanations!",
    "created_at": "2021-05-21T05:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451270",
    "user": "yzh"
}
```

All other things on this ticket look good to me. Thanks for the explanations!



---

archive/issue_comments_451271.json:
```json
{
    "body": "Replying to [comment:19 yzh]:\n> Replying to [comment:16 gh-kliem]:\n> > Replying to [comment:8 yzh]:\n> > > Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.\n> > > {{{\n> > > cdef inline int next_face_loop(iter_t structure) nogil except -1:\n> > >     r\"\"\"\n> > >     See :meth:`FaceIterator.next_face_loop`.\n> > >     \"\"\"\n> > >     if unlikely(structure.current_dimension == structure.dimension):\n> > >         # The function is not supposed to be called,\n> > >         # just prevent it from crashing.\n> > >         raise StopIteration\n> > > }}}\n> > \n> > This just prevents segmentation fault. It's never supposed to happen anyway. In fact I can't even change this. Because when I set `highest_dimension` it will be equal to `current_dimension`. Only after running this, is `current_dimension` lower, if there are faces left.\n> \n> I meant to change to `if unlikely(self.structure.current_dimension > self.structure.highest_dimension):` like all other checkings.\n> \n> Sure, if it never happens, then the current version is fine.\n\nThat's what I figure you meant. But it does not work. E.g. when you want to only visit the elements below the first facet, the highest dimension will be set to `d-2`. But current dimension is `d-1`. Only after `next_face_loop` is called has the dimension changed to `d-2`. This is different from the start. At the start the facets are already known and hence the dimension starts at `d-1`. But when you want to visit everything below something, the elements below have not been computed yet.\n\nI could set this up differently, if you find it confusing and make `only_subsets` call `next_face_loop` once.",
    "created_at": "2021-05-21T19:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451271",
    "user": "@kliem"
}
```

Replying to [comment:19 yzh]:
> Replying to [comment:16 gh-kliem]:
> > Replying to [comment:8 yzh]:
> > > Does this need to be changed to `structure.highest_dimension`? Or maybe I'm looking at a wrong version of the code.
> > > {{{
> > > cdef inline int next_face_loop(iter_t structure) nogil except -1:
> > >     r"""
> > >     See :meth:`FaceIterator.next_face_loop`.
> > >     """
> > >     if unlikely(structure.current_dimension == structure.dimension):
> > >         # The function is not supposed to be called,
> > >         # just prevent it from crashing.
> > >         raise StopIteration
> > > }}}
> > 
> > This just prevents segmentation fault. It's never supposed to happen anyway. In fact I can't even change this. Because when I set `highest_dimension` it will be equal to `current_dimension`. Only after running this, is `current_dimension` lower, if there are faces left.
> 
> I meant to change to `if unlikely(self.structure.current_dimension > self.structure.highest_dimension):` like all other checkings.
> 
> Sure, if it never happens, then the current version is fine.

That's what I figure you meant. But it does not work. E.g. when you want to only visit the elements below the first facet, the highest dimension will be set to `d-2`. But current dimension is `d-1`. Only after `next_face_loop` is called has the dimension changed to `d-2`. This is different from the start. At the start the facets are already known and hence the dimension starts at `d-1`. But when you want to visit everything below something, the elements below have not been computed yet.

I could set this up differently, if you find it confusing and make `only_subsets` call `next_face_loop` once.



---

archive/issue_comments_451272.json:
```json
{
    "body": "Replying to [comment:20 yzh]:\n> {{{\n>     if n_faces <= 1:\n>         # There will be no more faces from intersections.\n>         structure.current_dimension += 1\n>         return 0\n> }}}\n> What do you mean by \"no more faces from intersections\"? Why is it `n_faces <= 1`, not `n_faces == 0`, nor `n_faces == 1`?\n\nThe intersections are obtained by intersecting the last face with each previous ones. If there is only one face, we can stop and don't need `get_next_level` to tell us that there are no intersections.\n\nI don't think `n_faces == 0` can happen, but it is better to be safe than sorry. Because `get_next_level` will intersect the last face with all previous ones. If there is zero faces we have an overflow and the face `2^64-1` is intersected with all previous once, which will result in an segmentation fault.\n\nBut maybe it is better to handle this check as a first thing in `get_next_level`. This is probably where it belongs anyway. What do you think?",
    "created_at": "2021-05-21T19:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451272",
    "user": "@kliem"
}
```

Replying to [comment:20 yzh]:
> {{{
>     if n_faces <= 1:
>         # There will be no more faces from intersections.
>         structure.current_dimension += 1
>         return 0
> }}}
> What do you mean by "no more faces from intersections"? Why is it `n_faces <= 1`, not `n_faces == 0`, nor `n_faces == 1`?

The intersections are obtained by intersecting the last face with each previous ones. If there is only one face, we can stop and don't need `get_next_level` to tell us that there are no intersections.

I don't think `n_faces == 0` can happen, but it is better to be safe than sorry. Because `get_next_level` will intersect the last face with all previous ones. If there is zero faces we have an overflow and the face `2^64-1` is intersected with all previous once, which will result in an segmentation fault.

But maybe it is better to handle this check as a first thing in `get_next_level`. This is probably where it belongs anyway. What do you think?



---

archive/issue_comments_451273.json:
```json
{
    "body": "Replying to [comment:22 gh-kliem]:\n\n> That's what I figure you meant. But it does not work. E.g. when you want to only visit the elements below the first facet, the highest dimension will be set to `d-2`. But current dimension is `d-1`. Only after `next_face_loop` is called has the dimension changed to `d-2`. This is different from the start. At the start the facets are already known and hence the dimension starts at `d-1`. But when you want to visit everything below something, the elements below have not been computed yet.\n> \n> I could set this up differently, if you find it confusing and make `only_subsets` call `next_face_loop` once.\n\nThank you for the patient answer! It makes sense to me now.",
    "created_at": "2021-05-22T02:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451273",
    "user": "yzh"
}
```

Replying to [comment:22 gh-kliem]:

> That's what I figure you meant. But it does not work. E.g. when you want to only visit the elements below the first facet, the highest dimension will be set to `d-2`. But current dimension is `d-1`. Only after `next_face_loop` is called has the dimension changed to `d-2`. This is different from the start. At the start the facets are already known and hence the dimension starts at `d-1`. But when you want to visit everything below something, the elements below have not been computed yet.
> 
> I could set this up differently, if you find it confusing and make `only_subsets` call `next_face_loop` once.

Thank you for the patient answer! It makes sense to me now.



---

archive/issue_comments_451274.json:
```json
{
    "body": "Replying to [comment:23 gh-kliem]:\n> The intersections are obtained by intersecting the last face with each previous ones. If there is only one face, we can stop and don't need `get_next_level` to tell us that there are no intersections.\n> \n> I don't think `n_faces == 0` can happen, but it is better to be safe than sorry. Because `get_next_level` will intersect the last face with all previous ones. If there is zero faces we have an overflow and the face `2^64-1` is intersected with all previous once, which will result in an segmentation fault.\n> \n> But maybe it is better to handle this check as a first thing in `get_next_level`. This is probably where it belongs anyway. What do you think? \n\nI thought that `n_faces == 0` couldn't happen too; that's why I asked, in case I missed/misunderstood something. I was also wondering about the order of the `if` checks in `next_face_loop`, but I figured out that it doesn't really matter. Besides, `next_face_loop` and `get_next_level` are not objects of this ticket. The current implementation works well, so I don't think more changes are needed.",
    "created_at": "2021-05-22T02:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451274",
    "user": "yzh"
}
```

Replying to [comment:23 gh-kliem]:
> The intersections are obtained by intersecting the last face with each previous ones. If there is only one face, we can stop and don't need `get_next_level` to tell us that there are no intersections.
> 
> I don't think `n_faces == 0` can happen, but it is better to be safe than sorry. Because `get_next_level` will intersect the last face with all previous ones. If there is zero faces we have an overflow and the face `2^64-1` is intersected with all previous once, which will result in an segmentation fault.
> 
> But maybe it is better to handle this check as a first thing in `get_next_level`. This is probably where it belongs anyway. What do you think? 

I thought that `n_faces == 0` couldn't happen too; that's why I asked, in case I missed/misunderstood something. I was also wondering about the order of the `if` checks in `next_face_loop`, but I figured out that it doesn't really matter. Besides, `next_face_loop` and `get_next_level` are not objects of this ticket. The current implementation works well, so I don't think more changes are needed.



---

archive/issue_comments_451275.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-22T02:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451275",
    "user": "yzh"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451276.json:
```json
{
    "body": "Thank you.\n\nHowever, I will set this on \"needs work\" due to merge conflict with #31245. Depending on whether #31245 gets in or not, I will either rebase here or rebase #31245 and then put it back on \"positive review\".",
    "created_at": "2021-05-22T08:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451276",
    "user": "@kliem"
}
```

Thank you.

However, I will set this on "needs work" due to merge conflict with #31245. Depending on whether #31245 gets in or not, I will either rebase here or rebase #31245 and then put it back on "positive review".



---

archive/issue_comments_451277.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-05-22T08:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451277",
    "user": "@kliem"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_451278.json:
```json
{
    "body": "Ready to merge #31245?",
    "created_at": "2021-06-19T20:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451278",
    "user": "mkoeppe"
}
```

Ready to merge #31245?



---

archive/issue_comments_451279.json:
```json
{
    "body": "I don't know, if #31245 will be rejected again. But it looks like it's done now. It just triggered an unrelated bug.\n\nWhat is the best way to proceed from here? I could just create a branch for this ticket here on top of #31245 and can always go back to the old branch if that fails.",
    "created_at": "2021-06-19T20:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451279",
    "user": "@kliem"
}
```

I don't know, if #31245 will be rejected again. But it looks like it's done now. It just triggered an unrelated bug.

What is the best way to proceed from here? I could just create a branch for this ticket here on top of #31245 and can always go back to the old branch if that fails.



---

archive/issue_comments_451280.json:
```json
{
    "body": "Sure, it's easy to just back out the merge if necessary",
    "created_at": "2021-06-19T21:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451280",
    "user": "mkoeppe"
}
```

Sure, it's easy to just back out the merge if necessary



---

archive/issue_comments_451281.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-06-19T23:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451281",
    "user": "@kliem"
}
```

Last 10 new commits:



---

archive/issue_comments_451282.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-19T23:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451282",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_451283.json:
```json
{
    "body": "Rebased on #31245 and new version of #29683.\n\nNeeded to fix `max_dim` in `next_dimension` because of #31245.",
    "created_at": "2021-06-19T23:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451283",
    "user": "@kliem"
}
```

Rebased on #31245 and new version of #29683.

Needed to fix `max_dim` in `next_dimension` because of #31245.



---

archive/issue_comments_451284.json:
```json
{
    "body": "Actually rebasing on new version of #29683 and then pulling in #31245.\n----\nLast 10 new commits:",
    "created_at": "2021-06-19T23:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451284",
    "user": "@kliem"
}
```

Actually rebasing on new version of #29683 and then pulling in #31245.
----
Last 10 new commits:



---

archive/issue_comments_451285.json:
```json
{
    "body": "Back to positive review. LGTM\n----\nNew commits:",
    "created_at": "2021-06-23T01:21:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451285",
    "user": "mkoeppe"
}
```

Back to positive review. LGTM
----
New commits:



---

archive/issue_comments_451286.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-23T01:21:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451286",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451287.json:
```json
{
    "body": "Thank you.",
    "created_at": "2021-06-23T11:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451287",
    "user": "@kliem"
}
```

Thank you.



---

archive/issue_comments_451288.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-01T20:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31582#issuecomment-451288",
    "user": "vbraun"
}
```

Resolution: fixed
