# Issue 28292: Some micro-optimizations related to univariate polynomials

Issue created by migration from https://trac.sagemath.org/ticket/28529

Original creator: mmezzarobba

Original creation time: 2019-09-23 08:14:47

CC:  roed mjo




---

Comment by mmezzarobba created at 2019-09-23 08:17:03

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2019-09-23 13:10:43


```
File "src/sage/rings/polynomial/polynomial_element.pyx", line 1164, in sage.rings.polynomial.polynomial_element.Polynomial._cache_key
Failed example:
    foo(x)
Expected:
    (1 + O(2^20))*x
Got:
    x
```


Hmmm, so if I understand right, a p-adic polynomial `f` that prints as `(1 + O(2^20))*x` satisfies `f.is_gen()`. Is that intentional?


---

Comment by roed created at 2019-09-23 14:00:24

Yep, that's intentional.  For capped-relative and capped-absolute p-adic rings, we don't have an exact 1.  So `(1 + O(2^20))*x` is as close to it as possible, and we mark it as the generator.  I don't know what would be broken by changing this, so perhaps the easiest fix is to check for the base ring being exact when you return the name.


---

Comment by vdelecroix created at 2019-10-25 04:24:40

Why did you change the evaluation code?


---

Comment by mmezzarobba created at 2019-10-25 12:29:48

Replying to [comment:4 vdelecroix]:
> Why did you change the evaluation code?

To make it a little bit faster. I'm not sure I understand the question, sorry. And I don't remember the details, but I think it had to do with the cost of going through an fmpz vs an mpz.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mjo created at 2020-02-26 15:18:54

The p-adic issue aside, how come the fast path for `_is_gen` is under the `if name is None` branch?


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2020-08-18 21:08:10

patchbot indicates doctest errors


---

Comment by mkoeppe created at 2020-08-18 21:08:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-19 07:33:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2020-08-19 07:36:29

Replying to [comment:7 mjo]:
> The p-adic issue aside, how come the fast path for `_is_gen` is under the `if name is None` branch?

I guess it was a mistake. I fixed it and added an exception for polynomials over p-adic parents.


---

Comment by mmezzarobba created at 2020-08-19 07:36:29

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-08-20 23:46:53

Can you explain a bit why this is an optimization? It seems like you need an extra temporary object, which would be slower. Have you run any timings?


---

Comment by mmezzarobba created at 2020-08-21 06:40:04

Replying to [comment:12 tscrim]:
> Can you explain a bit why this is an optimization? It seems like you need an extra temporary object, which would be slower. Have you run any timings?

I assume you are talking about the code for evaluation at integers. There are timings in the commit message. I don't remember why I thought my version would be faster (it was a year ago...), but I suppose part of the explanation must be that `fmpq_poly_evaluate_mpz` does more or less the same conversions that my version is doing and requires temporary objects as well.


---

Comment by tscrim created at 2020-08-21 08:24:35

Okay, well, let it be so.


---

Comment by tscrim created at 2020-08-21 08:24:35

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2020-08-21 11:26:51

Can you also please add a comment about the p-adic line,


```
if self._is_gen and not isinstance(self._parent._base, pAdicGeneric)
```


Otherwise that's going to look very mysterious out of context.


---

Comment by git created at 2020-08-26 09:17:15

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by git created at 2020-08-26 09:17:15

Changing status from positive_review to needs_review.


---

Comment by mmezzarobba created at 2020-08-26 09:17:47

Replying to [comment:15 mjo]:
> Can you also please add a comment about the p-adic line,
> 
> {{{
> if self._is_gen and not isinstance(self._parent._base, pAdicGeneric)
> }}}

Done; thanks for the remark!


---

Comment by mmezzarobba created at 2020-08-26 09:22:40

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2020-08-26 09:22:40

I am taking the liberty of leaving the ticket marked as positive_review since all my last push does was to add the requested comment without changing the code.


---

Comment by vbraun created at 2020-08-30 08:38:38

Resolution: fixed
