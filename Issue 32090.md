# Issue 32090: multivariate polynomials: catch nonsensical inputs in .subs()

Issue created by migration from https://trac.sagemath.org/ticket/32327

Original creator: lorenz

Original creation time: 2021-08-02 16:35:25

Keywords: multivariate polynomials, substitution

It seems to me that all of the following things should throw errors instead of whatever is happening right now:

```
sage: R.<x,y,z> = QQ[]
sage: f = x^3 + y^2
sage: f.subs({x^3: 2})
y^2 + 8
sage: f.subs({-1: z})
#### (crashes)
```



```
sage: P.<x,y,z> = BooleanPolynomialRing()
sage: f = x*y + z
sage: f.subs({x+y: z})
y*z + z
sage: f.subs({1: 0})
x*y + z
```



```
sage: R.<x,y,z> = PolynomialRing(QQ, implementation='generic')
sage: f = x^3 + y^2
sage: f.subs({5: z})
x^3 + y^2
sage: f.subs({x+y: z})
x^3 + y^2
```



```
sage: L.<x,y,z> = LaurentPolynomialRing(QQ)
sage: f = x^3 + y^2
sage: f.subs({-17: z})
x^3 + y^2
sage: f.subs({x^2: z})
x^3 + y^2
```





---

Comment by lorenz created at 2021-08-02 16:38:46

Changing status from new to needs_review.


---

Comment by tscrim created at 2021-08-15 00:33:47

I think this is more clear:

```diff
-for v in (in_dict.keys() if in_dict is not None else ()):
+if in_dict:
+    for v in in_dict:
```

(This might also make better compiled Cython code too.)

You are backwards on your `::` versus `:` in the docstring endings.

I don't see the need to wrap this

```diff
-                    var = P(var)
+                    try:
+                        var = P(var)
+                    except TypeError:
+                        raise TypeError("keys do not match self's parent")
```

You can just let the error propagate up.

I would make the error message a little more concise:

```diff
-cannot substitute {v}: not a variable in {self.parent()}'
+{v} is not a variable in {self.parent()}'
```



---

Comment by git created at 2021-08-15 07:07:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-08-15 07:10:34

Thank you for looking at this! Updated.


---

Comment by tscrim created at 2021-08-15 08:42:39

Thanks. One last little thing. You don't need the keys() to iterate over a dictionary. Generally it is not consider pythonic to add this.


---

Comment by git created at 2021-08-15 09:00:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-08-15 09:04:44

Done.


---

Comment by tscrim created at 2021-08-15 22:36:59

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-08-15 22:36:59

Thank you.


---

Comment by vbraun created at 2021-10-17 08:28:12

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-10-17 08:28:12

Causes a massive slowdown

Before:

```
sage -t --long --warn-long 46.7 --random-seed=0 src/sage/crypto/mq/sr.py
    [368 tests, 27.83 s]
```

After:

```
sage -t --long --warn-long 46.7 --random-seed=0 src/sage/crypto/mq/sr.py
**********************************************************************
File "src/sage/crypto/mq/sr.py", line 2072, in sage.crypto.mq.sr.SR_generic.polynomial_system
Warning, slow doctest:
    F.subs(s).groebner_basis() # long time
Test ran for 701.17 s
**********************************************************************
File "src/sage/crypto/mq/sr.py", line 3360, in sage.crypto.mq.sr.test_consistency
Warning, slow doctest:
    test_consistency(1)  # long time (65s on sage.math, 2012)
Test ran for 199.60 s
    [368 tests, 904.41 s]
```

