# Issue 34060: GAP interface hangs waiting for prompt

Issue created by migration from https://trac.sagemath.org/ticket/34297

Original creator: @collares

Original creation time: 2022-08-07 02:03:16

Recently, the Sage testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).

Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/8af8cb3eef1de2af881694de7a1575b5f3449b45/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.

Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then I can boot up a machine on Oracle Cloud and get stack traces from the real-world hang; unfortunately I didn't save them the first time, but they had the same characteristics as above: [this `expect_list` call in gap.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524) caused pexpect to run [a select call with timeout=None](https://github.com/pexpect/pexpect/blob/2be6c4d1aa2b9b522636342c2fd54b73c058060d/pexpect/pty_spawn.py#L500)). I would also be happy to apply further patches to get extra debugging output.

This was reproduced both with ptyprocess 0.5.1 and 0.7.0, by the way.


---

Comment by mkoeppe created at 2022-08-07 03:18:46

Does the output of the gap process give any insights? For example by using `sage.interfaces.gap.gap = Gap(logfile="LOG")`


---

Comment by @collares created at 2022-08-07 15:54:02

An old version of the description had some invalid information. I've since edited it to fix the problems.


---

Comment by @collares created at 2022-09-23 16:09:46

After updating to GAP 4.12 and applying the patch in #34391, this no longer happens on Nix's aarch64 builders. For some weird reason, this still happens on an Oracle Cloud free tier box, but I don't know how to debug that (and, given that it might be some interaction with Oracle's cloud monitoring tools, I don't really care).
