# Issue 31978: Asymptotic Term Monoids: refactor element construction

Issue created by migration from https://trac.sagemath.org/ticket/32215

Original creator: dkrenn

Original creation time: 2021-07-16 19:55:19

CC:  cheuberg behackl @thhagelmayer

In #31933 conversion fails. In order to fix this properly, a refactor of the conversion process seems the best solution. This ticket does this (without fixing the open issue on #31933 which will be a follow up).


---

Comment by dkrenn created at 2021-07-16 20:04:27

Changing status from new to needs_review.


---

Comment by dkrenn created at 2021-07-16 20:04:27

New commits:


---

Comment by dkrenn created at 2021-07-16 20:06:56

Review recommendation: commit-wise


---

Comment by git created at 2021-07-17 10:00:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-18 11:26:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-18 14:09:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by behackl created at 2021-07-22 11:12:20

Here are some minor points that should be addressed: 

1. The new exceptions caused by ambiguously passing additional `growth` and `coefficient` keyword arguments should be tested.

2. Is there a particular reason for changing the implementation of `OTerm.can_absorb`?

3. The implementations of `TermWithCoefficientMonoid._convert_construction_` and `ExactTermMonoid._convert_construction_` are identical. I think the tests contained in the docstring of `ExactTermMonoid._convert_construction_` should be moved to `TermWithCoefficientMonoid._convert_construction_` and the separate implementation of `ExactTermMonoid._convert_construction_` should be removed.


Otherwise, the proposed changes look good to me. Here are the changes I've made in my reviewer commits:

- the `cached_method` import was unused and is now removed.

- The `EXAMPLES` block in some newly added methods used `TermMonoidFactory` to manually construct a factory, I've changed it to `from sage.rings.asymptotic.term_monoid import DefaultTermMonoidFactory as TermMonoid` (also see #32032).

- Language improvements for the error messages and the deprecation warning in `GenericTermMonoid._element_constructor`.
----
New commits:


---

Comment by behackl created at 2021-07-22 11:12:20

Changing status from needs_review to needs_work.


---

Comment by @thhagelmayer created at 2021-08-07 16:15:33

I have merged #32032 and fixed some doctests.
----
New commits:


---

Comment by dkrenn created at 2021-08-09 13:55:17

Replying to [comment:9 behackl]:
> Otherwise, the proposed changes look good to me. Here are the changes I've made in my reviewer commits:
> 
> - the `cached_method` import was unused and is now removed.
> 
> - The `EXAMPLES` block in some newly added methods used `TermMonoidFactory` to manually construct a factory, I've changed it to `from sage.rings.asymptotic.term_monoid import DefaultTermMonoidFactory as TermMonoid` (also see #32032).
> 
> - Language improvements for the error messages and the deprecation warning in `GenericTermMonoid._element_constructor`.

LGTM, thanks.


---

Comment by git created at 2021-08-09 14:42:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-08-09 14:48:15

Replying to [comment:9 behackl]:
> 1. The new exceptions caused by ambiguously passing additional `growth` and `coefficient` keyword arguments should be tested.

Tested now. Indeed there was code, that could have never been reached. I think we should have full coverage now.

> 2. Is there a particular reason for changing the implementation of `OTerm.can_absorb`?

This was the only place, where the `<=` of a term was used. However, I think it should be made clear what we compare here ("explicit is better than implicit"), so I switched to comparing the growth directly.

The reason for having `<=` (and method `le`) is for being compatible with SageMath's poset class in this perspective. If it wouldn't be for that, I would suggest to deprecate `<=` in the long run. However, as there is a reason for keeping it, I suggest to, at least, not use it further.

> 3. The implementations of `TermWithCoefficientMonoid._convert_construction_` and `ExactTermMonoid._convert_construction_` are identical. I think the tests contained in the docstring of `ExactTermMonoid._convert_construction_` should be moved to `TermWithCoefficientMonoid._convert_construction_` and the separate implementation of `ExactTermMonoid._convert_construction_` should be removed.

I disagree here. Usually I am in strong favour of removeing code duplicities, however, `_convert_construction_` is the one crucial method that all different terms (or their monoids, to be precise) have that do the conversion and making this conversion as explicit as possible helps understanding what is going on. I find it more of an incidient that two different type of terms have the same conversion.


---

Comment by behackl created at 2021-08-09 16:22:01

Changing status from needs_work to positive_review.


---

Comment by behackl created at 2021-08-09 16:22:01

> I think we should have full coverage now.

Great, thanks!

>  I would suggest to deprecate `<=` in the long run. However, as there is a reason for keeping it, I suggest to, at least, not use it further.

Another example of //spiritual deprecation//. +1.

>  I find it more of an incidient that two different type of terms have the same conversion.

Okay, good argument.

This LGTM now, thanks for your efforts!


---

Comment by behackl created at 2021-08-09 16:47:04

I am not sure why the `deprecation_number` test in the most recent patchbot run failed though. The deprecation introduced here correctly uses 32215.


---

Comment by git created at 2021-08-09 20:47:39

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-08-09 20:47:39

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-08-09 20:48:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-08-09 20:49:45

Merged #32153 and fixed doctest. It's now on 9.4.beta4.


---

Comment by behackl created at 2021-08-10 07:44:05

Changing status from needs_review to positive_review.


---

Comment by @thhagelmayer created at 2021-08-18 13:58:17

Changing keywords from "" to "gsoc2021".


---

Comment by vbraun created at 2021-08-30 22:47:04

Merge conflict


---

Comment by vbraun created at 2021-08-30 22:47:04

Changing status from positive_review to needs_work.


---

Comment by @thhagelmayer created at 2021-09-15 15:31:45

I merged #31933 into this ticket and resolved the merge conflict.
----
New commits:


---

Comment by @thhagelmayer created at 2021-09-15 15:31:45

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-09-17 08:14:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-24 12:49:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @thhagelmayer created at 2021-11-24 12:52:17

Somwthing went wrong with the last push here, so I went back to the status of `u/dkrenn/refactor-element-construction-term-monoids` and redid the merge and fixed the doctests. There is still one doctest failing:



```
File "src/sage/rings/asymptotic/term_monoid.py", line 4698, in sage.rings.asymptotic.term_monoid.BTerm.can_absorb
Failed example:
    t2.absorb(t1)
Expected:
    B(2003/400*x^3, x >= 20)
Got:
...
    DeprecationWarning: Passing 'coefficient' as a positional argument is deprecated; specify it as keyword argument 'coefficient=...'.
    See https://trac.sagemath.org/32215 for details.
    B(2003/400*x^3, x >= 20)
```



---

Comment by behackl created at 2021-11-24 13:54:37

Replying to [comment:29 gh-thhagelmayer]:
> Somwthing went wrong with the last push here, so I went back to the status of `u/dkrenn/refactor-element-construction-term-monoids` and redid the merge and fixed the doctests. There is still one doctest failing:
> 
> 
> {{{
> File "src/sage/rings/asymptotic/term_monoid.py", line 4698, in sage.rings.asymptotic.term_monoid.BTerm.can_absorb
> Failed example:
>     t2.absorb(t1)
> Expected:
>     B(2003/400*x^3, x >= 20)
> Got:
> ...
>     DeprecationWarning: Passing 'coefficient' as a positional argument is deprecated; specify it as keyword argument 'coefficient=...'.
>     See https://trac.sagemath.org/32215 for details.
>     B(2003/400*x^3, x >= 20)
> }}}

Yes, this should be resolved as well: it comes from https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/asymptotic/term_monoid.py?id=683acc1eaa07fd3375bdd031516cfce30f1e363b#n4753, the coefficient should be passed via keyword argument.


---

Comment by git created at 2021-11-25 11:17:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @thhagelmayer created at 2021-11-25 11:23:53

I fixed the doctest in [7e7b5c7](https://git.sagemath.org/sage.git/commit/?id=7e7b5c7bf93c713e3688a94ccb33561092556b83)


---

Comment by behackl created at 2021-11-25 20:28:57

I've managed to find the problem causing the `deprecation_number` plugin failure: looking at the implementation of the plugin over at https://github.com/sagemath/sage-patchbot/blob/745ec21b12f3bce03e8f1c8399cba0fb77bdc45c/sage_patchbot/plugins.py#L546, the plugin parses all //added// lines. If one of those contains `deprecation(` or `deprecated_function_alias(`, the code tries to parse the part following afterwards to find the ticket number, and then compares this parsed number to the actual ticket number.

The problem with our code is that we currently have

```diff
+            deprecation(
+                32215,
+                "Passing 'coefficient' as a positional argument is deprecated; "
+                "specify it as keyword argument 'coefficient=...'.")
```

in our diff, so the code fails to properly parse the deprecation number. Changing this addition in `term_monoid.py` to

```diff
+            deprecation(32215,
+                "Passing 'coefficient' as a positional argument is deprecated; "
+                "specify it as keyword argument 'coefficient=...'.")
```

will fix the failing test.


---

Comment by git created at 2021-11-26 10:57:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @thhagelmayer created at 2021-11-26 10:58:03

Replying to [comment:33 behackl]:
> I've managed to find the problem causing the `deprecation_number` plugin failure: looking at the implementation of the plugin over at https://github.com/sagemath/sage-patchbot/blob/745ec21b12f3bce03e8f1c8399cba0fb77bdc45c/sage_patchbot/plugins.py#L546, the plugin parses all //added// lines. If one of those contains `deprecation(` or `deprecated_function_alias(`, the code tries to parse the part following afterwards to find the ticket number, and then compares this parsed number to the actual ticket number.
> 
> The problem with our code is that we currently have
> {{{#!diff
> +            deprecation(
> +                32215,
> +                "Passing 'coefficient' as a positional argument is deprecated; "
> +                "specify it as keyword argument 'coefficient=...'.")
> }}}
> in our diff, so the code fails to properly parse the deprecation number. Changing this addition in `term_monoid.py` to
> {{{#!diff
> +            deprecation(32215,
> +                "Passing 'coefficient' as a positional argument is deprecated; "
> +                "specify it as keyword argument 'coefficient=...'.")
> }}}
> will fix the failing test.

I changed that line accordingly.


---

Comment by behackl created at 2021-12-01 09:36:42

Changing status from needs_review to positive_review.


---

Comment by behackl created at 2021-12-01 09:36:42

This seems fine to me now, thank you! The latest patchbot test failures seem unrelated.


---

Comment by vbraun created at 2021-12-12 15:08:54

Resolution: fixed
