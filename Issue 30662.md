# Issue 30662: igraph, python-igraph: Update to 0.8.3

Issue created by migration from https://trac.sagemath.org/ticket/30899

Original creator: mkoeppe

Original creation time: 2020-11-12 00:33:31

CC:  fbissey dcoudert dimpase slelievre isuruf

(from #30611)


---

Comment by dimpase created at 2020-11-13 13:53:05

source at https://github.com/igraph/igraph/releases/download/0.8.3/igraph-0.8.3.tar.gz


---

Comment by dcoudert created at 2020-11-13 18:03:06

This version of igraph is also in homebrew https://formulae.brew.sh/formula/igraph. I don't think we are currently checking whether graph is a system package or not.

We also need python_igraph (https://igraph.org/python/), right ?


---

Comment by dcoudert created at 2020-11-16 19:24:43

Changing status from new to needs_info.


---

Comment by dcoudert created at 2020-11-16 19:24:43

I tried to update to 0.8.3 on macOS 10.15.7. Compilation went well, but I have the following issues:

```
sapristi:sage dcoudert$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.3.beta1, Release Date: 2020-11-07               │
│ Using Python 3.9.0. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import igraph                                                                                                                 
---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
<ipython-input-1-73ffca960e68> in <module>
----> 1 import igraph

~/sage/local/lib/python3.9/site-packages/igraph/__init__.py in <module>
     33 # W0401: wildcard import
     34 from igraph._igraph import *
---> 35 from igraph.clustering import *
     36 from igraph.cut import *
     37 from igraph.configuration import Configuration

~/sage/local/lib/python3.9/site-packages/igraph/clustering.py in <module>
     36 from igraph.drawing.colors import ClusterColoringPalette
     37 from igraph.statistics import Histogram
---> 38 from igraph.summary import _get_wrapper_for_width
     39 from igraph.utils import str_to_orientation
     40 

~/sage/local/lib/python3.9/site-packages/igraph/summary.py in <module>
      9 from itertools import islice
     10 from math import ceil
---> 11 from texttable import Texttable
     12 from textwrap import TextWrapper
     13 

ModuleNotFoundError: No module named 'texttable'
```

and

```
sage: from sage.features import PythonModule                                                                                        
sage: F = PythonModule("igraph", spkg="python_igraph", url="http://igraph.org")                                                     
sage: F.is_present()                                                                                                                
FeatureTestResult('igraph', False)
```

I don't know what to do
----
New commits:


---

Comment by fbissey created at 2020-11-16 19:45:52

`python-igraph` has new dependencies that need to be added. `pycairo` and `texttable`

https://pypi.org/project/texttable/

https://pypi.org/project/pycairo/

We may be able to do without pycairo (which in turns will require cairo either as a spkg or system package, may be it is already required, that need to be checked).


---

Comment by slelievre created at 2020-11-17 00:51:28

Indeed python-igraph used to vendor `texttable` but this was changed:

https://github.com/igraph/python-igraph/commit/60194fbb7ff3dbd05c140493e116673834318fc2

Careful, it's `texttable`, not `textable` (both exist on PyPI).

https://pypi.org/project/texttable/


---

Comment by dimpase created at 2020-11-17 08:25:12

as far as cairo and pycairo are concerned, we can add them, why not?


---

Comment by fbissey created at 2020-11-17 08:33:43

cairo is potentially opening a nest of dependencies, so if skipping it was possible, I think that would be preferable.


---

Comment by git created at 2020-11-17 13:56:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-11-17 13:57:48

Changing status from needs_info to needs_review.


---

Comment by dcoudert created at 2020-11-17 13:57:48

I added texttable and it seems ok now on my side. Not sure I did it the right way...


---

Comment by mkoeppe created at 2020-11-17 16:49:44

`checksums.ini` needs `upstream_url` (see #30895)

`spkg-check.in` looks incomplete.

The error handling in `spkg-install.in` can be removed - the function `sdh_pip_install` already takes care of it


---

Comment by git created at 2020-11-17 16:53:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-17 17:00:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-17 17:05:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-11-17 17:08:21

What else should be done if we want to use a local installation of igraph (e.g., homebrew) ?


---

Comment by git created at 2020-11-17 17:11:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-17 17:20:47

Add system package information in `distros/` (see https://repology.org/project/igraph/versions) and add spkg-configure.m4


---

Comment by dimpase created at 2020-11-17 17:49:16

`python_igraph` by default vendors `libigraph`, to avoid it one needs to follow
https://github.com/igraph/python-igraph#linking-to-an-existing-igraph-installation

But I don't know how this can be done with our `sdh_pip_install`, which does not accept arguments other than `.`.


---

Comment by dimpase created at 2020-11-17 17:49:16

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2020-11-17 18:10:19

You can use the same method that we use in `numpy`: Use `setup.py bdist_wheel` and then `sdh_store_and_pip_install_wheel`.


---

Comment by dcoudert created at 2020-11-18 18:27:21

Unless someone wants to give it a try now, I propose to postpone the use of system package to another ticket.


---

Comment by dimpase created at 2020-11-18 18:36:40

Replying to [comment:21 dcoudert]:
> Unless someone wants to give it a try now, I propose to postpone the use of system package to another ticket.

The tricky part is to take care of comment:20 - I'll write the spkg-configure for igraph once this is done, but 1st things 1st.


---

Comment by git created at 2020-11-18 19:30:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-11-18 20:19:47

igraph does not build on macOS 10.5 with Xcode 12.

```
[igraph-0.8.3] /bin/bash ../libtool  --tag=CC   --mode=compile clang -DHAVE_CONFIG_H -I. -I..   -O3 -DIGRAPH_VERIFY_FINALLY_STACK=0 -I../include -I../include -I../src/CHOLMOD/Include -I../src/CHOLMOD/Include -I../src/AMD/Include -I../src/AMD/Include -I../src/COLAMD/Include -I../src/COLAMD/Include -I../src/SuiteSparse_config -I../src/SuiteSparse_config -DNPARTITION -DNTIMER -DNCAMD -Wall  -I../src/prpack -DPRPACK_IGRAPH_SUPPORT -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -O3 -c -o AMD/Source/libigraph_la-amd_1.lo `test -f 'AMD/Source/amd_1.c' || echo './'`AMD/Source/amd_1.c
[igraph-0.8.3] In file included from CHOLMOD/Supernodal/cholmod_super_numeric.c:80:
[igraph-0.8.3] CHOLMOD/Supernodal/t_cholmod_super_numeric.c:510:17: error: implicit declaration of function 'dsyrk_' is invalid in C99 [-Werror,-Wimplicit-function-declaration]
[igraph-0.8.3]                 BLAS_dsyrk ("L", "N",
[igraph-0.8.3]                 ^
[igraph-0.8.3] ../src/CHOLMOD/Include/cholmod_blas.h:331:2: note: expanded from macro 'BLAS_dsyrk'
[igraph-0.8.3]         BLAS_DSYRK (uplo, trans, &N, &K, alpha, A, &LDA, beta, C, &LDC) ; \
[igraph-0.8.3]         ^
[igraph-0.8.3] ../src/CHOLMOD/Include/cholmod_blas.h:132:20: note: expanded from macro 'BLAS_DSYRK'
[igraph-0.8.3] #define BLAS_DSYRK igraphdsyrk_
[igraph-0.8.3]                    ^
[igraph-0.8.3] ./igraph_lapack_internal.h:86:29: note: expanded from macro 'igraphdsyrk_'
[igraph-0.8.3]     #define igraphdsyrk_    dsyrk_
[igraph-0.8.3]                             ^
```

no surprise, it's very old code they vendor for no good reason, too. I'll open an issue with upstream.
The following fixes the problem

```diff
--- a/build/pkgs/igraph/spkg-install.in
+++ b/build/pkgs/igraph/spkg-install.in
@@ -4,6 +4,7 @@ You need libxml2 to run igraph. On Ubuntu and Debian Linux, installing the build
     exit 1
 fi
 
+export CFLAGS="$CFLAGS -Wno-strict-prototypes -Wno-implicit-function-declaration"
 cd src
 sdh_configure --with-external-blas --with-external-lapack --with-external-glpk
 sdh_make
```



---

Comment by git created at 2020-11-18 20:30:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-11-18 21:25:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-11-18 21:26:38

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2020-11-18 21:54:02


```
+upstream_url=https://github.com/foutaise/texttable/archive/vVERSION.tar.gz
```

better to use pypi.io URLs


---

Comment by dimpase created at 2020-11-18 22:39:49

Replying to [comment:28 mkoeppe]:
> {{{
> +upstream_url=https://github.com/foutaise/texttable/archive/vVERSION.tar.gz
> }}}
> better to use pypi.io URLs 

I don't know where to get a nice url there. there are links to pypi.org there with ugly hashes.


---

Comment by fbissey created at 2020-11-18 22:43:01

It should be of the following form (try it)
[https://pypi.io/packages/source/t/texttable/texttable-VERSION.tar.gz](https://pypi.io/packages/source/t/texttable/texttable-VERSION.tar.gz)


---

Comment by git created at 2020-11-18 23:29:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-11-18 23:34:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-11-19 02:12:56

The distros files are missing the extension ".txt"


---

Comment by mkoeppe created at 2020-11-19 02:12:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-11-19 08:05:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-11-19 08:08:55

I renamed the files.

I have a doubt for `gentoo.txt`: on page https://repology.org/project/igraph/versions it's written `dev-libs/igraph` but our file contains only `igraph`. Should I change to `dev-libs/igraph` ?


---

Comment by fbissey created at 2020-11-19 08:15:47

Replying to [comment:36 dcoudert]:
> I renamed the files.
> 
> I have a doubt for `gentoo.txt`: on page https://repology.org/project/igraph/versions it's written `dev-libs/igraph` but our file contains only `igraph`. Should I change to `dev-libs/igraph` ?
> 

`igraph` would be fine. `dev-libs/igraph` would be useful to lift ambiguities if there were several igraph packages across different categories. That being said you should check what was done for other packages. If we have a convention of using the "long" package name you should follow it.


---

Comment by git created at 2020-11-19 08:21:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-11-19 08:22:25

the convention is `dev-libs/igraph`. I also added a file for freebsd ports.


---

Comment by dimpase created at 2020-11-19 09:00:20

OK, needs final review?


---

Comment by dimpase created at 2020-11-19 09:00:20

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2020-11-19 09:10:17

python-igraph is on pypi https://pypi.org/project/python-igraph/ so we should use it as upstream instead of 

```
upstream_url=https://github.com/igraph/python-igraph/releases/download/VERSION/python-igraph-VERSION.tar.gz
```

github generated tarballs sometimes have issues.


---

Comment by fbissey created at 2020-11-19 09:15:37

I am not sure about using `sage-python23` , aren't we phasing that out to use plain `python3` or `python`?


---

Comment by dimpase created at 2020-11-19 09:36:11

Replying to [comment:42 fbissey]:
> I am not sure about using `sage-python23` , aren't we phasing that out to use plain `python3` or `python`?

I copied this from numpy's spkg-install. I suppose here should be a ticket that does away with sage-python23 at some point.


---

Comment by dimpase created at 2020-11-19 09:39:25

Replying to [comment:41 fbissey]:
> python-igraph is on pypi https://pypi.org/project/python-igraph/ so we should use it as upstream instead of 
> {{{
> upstream_url=https://github.com/igraph/python-igraph/releases/download/VERSION/python-igraph-VERSION.tar.gz
> }}}
> github generated tarballs sometimes have issues.

this tarball is not github-generated, it's a manually uploaded one. cf
https://github.com/igraph/igraph/releases/tag/0.8.3


---

Comment by fbissey created at 2020-11-19 09:41:03

Replying to [comment:44 dimpase]:
> Replying to [comment:41 fbissey]:
> > python-igraph is on pypi https://pypi.org/project/python-igraph/ so we should use it as upstream instead of 
> > {{{
> > upstream_url=https://github.com/igraph/python-igraph/releases/download/VERSION/python-igraph-VERSION.tar.gz
> > }}}
> > github generated tarballs sometimes have issues.
> 
> this tarball is not github-generated, it's a manually uploaded one. cf
> https://github.com/igraph/igraph/releases/tag/0.8.3

that's definitely a good thing. I won't insist on pypi.


---

Comment by dcoudert created at 2020-11-19 11:19:37

I tried with a homebrew install of igraph and then `sage -I python_igraph` and it's working well. I don't know for other systems.


---

Comment by slelievre created at 2020-11-19 11:26:05

Replying to [comment:42 fbissey]:
> I am not sure about using `sage-python23` , aren't we
> phasing that out to use plain `python3` or `python`?

Yes, see #30731.


---

Comment by git created at 2020-11-19 12:28:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-11-19 12:31:36

build/pkgs/python_igraph/spkg-install.in also has sage-python23


---

Comment by git created at 2020-11-19 12:33:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-11-19 12:54:41

I don't like these sage-python23 -> python3 changes.
I don't see why this python3 is guaranteed to be the correct python.

In fact, no package at the moment uses `python3` to run `setup.py`, while about a dozen
packages use `sage-python23`.
I really think until #30731 is done, we should continue using `sage-python23`.
Sorry I didn't check earlier.


---

Comment by dcoudert created at 2020-11-19 12:58:51

I don't know how to remove the 2 lasts commits (I'm still at git beginner level...). Otherwise I can push a revert commit.


---

Comment by git created at 2020-11-19 14:52:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dcoudert created at 2020-11-19 14:54:25

OK, I was able to remove the last 2 commits (and so revert to sage-python23). I had to do a forced push.


---

Comment by mkoeppe created at 2020-11-19 17:25:58

Replying to [comment:51 dimpase]:
> I don't like these sage-python23 -> python3 changes.

We will switch over in #30371 - and I agree that it is better for uniformity if we don't do this package by package.

> I don't see why this python3 is guaranteed to be the correct python.

It is actually guaranteed by our installation. 
- When there is a suitable system python3.x, then Sage creates a venv over it and installs a `python3` symlink in `$SAGE_LOCAL/bin` (which is in `$PATH` and not shadowed by what is in front of it), so `python3` works. 
- When there is no suitable system python3.x, then Sage builds one and installs a binary in `$SAGE_LOCAL/bin`, so `python3` also works.
(Side note: After #22731/#30013, the above is still true, but with `$SAGE_VENV/bin` instead of `$SAGE_LOCAL/bin`.)


---

Comment by dimpase created at 2020-11-19 20:23:49

lgtm


---

Comment by dimpase created at 2020-11-19 20:23:49

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-11-19 21:02:33

Looks good. Given that this is an optional package, we can defer the actual portability tests to the automatic run of the GH Actions when it is merged into a beta release.


---

Comment by dimpase created at 2020-11-20 12:52:03

I've opened https://github.com/igraph/igraph/issues/1547 in regard of XCode 12 issue (solved with CFLAGS here).


---

Comment by vbraun created at 2020-11-22 15:05:47

Resolution: fixed


---

Comment by mkoeppe created at 2020-12-03 05:13:58

Follow up in #27921, running the libxml2 check via a script package


---

Comment by mkoeppe created at 2020-12-07 00:13:14

Volker, the upstream tarball for `python_igraph` seems to be missing on the mirrors. Note that `make download` has been repaired - so it should be easy to check if anything is missing
