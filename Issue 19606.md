# Issue 19606: Improve location change error message

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2016-01-07 22:45:47




---

Comment by vbraun created at 2016-01-07 23:10:24

New commits:


---

Comment by vbraun created at 2016-01-07 23:10:24

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2016-01-07 23:10:24

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2016-01-07 23:10:24

Changing status from new to needs_review.


---

Comment by kcrisman created at 2016-01-08 06:13:21

This seems reasonable but I have no way of testing it properly right now.  But if someone can do that I think the message and removal of other stuff is probably the right solution here.


---

Comment by jdemeyer created at 2016-01-16 13:30:32

This warning is useful:

```sh
    # Display a message if we actually installed something (using this
    # file, generated by sage-spkg, is a bit of a hack though)
    if [ -f "$SAGE_LOCAL/lib/sage-force-relocate.txt" ]; then
        echo
        echo "Warning: it might be needed to update the Sage library before"
        echo "installed packages work: you should run 'make' from \$SAGE_ROOT"
        echo "before running Sage."
    fi
```

Using `sage-force-relocate.txt` to determine when to display this message is a hack, but the message itself still makes sense.


---

Comment by vbraun created at 2016-01-16 14:18:50

There is no relocation any more, if you move the install tree without using the binary packaging script then it does not work. In particular, updating the Sage library isn't going to help.


---

Comment by vbraun created at 2016-01-16 14:19:44

Changing priority from major to blocker.


---

Comment by vbraun created at 2016-01-16 14:19:44

this should really be in 7.0


---

Comment by jdemeyer created at 2016-01-16 14:41:17

Please read [comment:5] again. It's not about relocation at all. It just uses the file `sage-force-relocate.txt` as proxy to determine whether a package was installed.


---

Comment by vbraun created at 2016-01-16 14:45:58

Hmm OK, but its a bad implementation of a questionable feature. If you use "make foo" to install foo then its not needed, and if you manually mucked with packages then there are a million ways to break it so why try to catch this particular one?


---

Comment by jdemeyer created at 2016-01-16 19:31:29

Replying to [comment:9 vbraun]:
> Hmm OK, but its a bad implementation of a questionable feature. If you use "make foo" to install foo then its not needed

That's not true. This is to catch "reverse dependencies": say you have a package A depending on B and you decide to (re)build B. Then you should also rebuild A before running Sage.


---

Comment by vbraun created at 2016-01-16 20:42:57

Make already has `--question` to check whether dependencies are satisfied. We should just use that. Or, even easier, print that warning simply after `make B`. But piggy-backing it on sage-force-relocation isnt' really an option. 

In any case, I made #19902 for that.


---

Comment by jdemeyer created at 2016-01-17 08:57:08

Replying to [comment:11 vbraun]:
> Make already has `--question` to check whether dependencies are satisfied. We should just use that.
The problem with `make --question` is that the Sage library (i.e. Cython + distutils) does not support that. You can't do `./setup.py --question` to ask if Python dependencies are up-to-date.

> Or, even easier, print that warning simply after `make B`.
OK, please move this message to the end of `sage-spkg` then.


---

Comment by vbraun created at 2016-01-17 09:45:46

See #19902


---

Comment by git created at 2016-01-17 13:14:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-17 13:15:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-01-18 10:03:40

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-01-18 10:03:40

This is a bit sloppy. Why keep all the functions `update_pkgconfig_files()`, `make_scripts_relative()`, `sage_relocate()` if they aren't used anymore? You might argue that they will still be called when running Sage _the first time_. However, they won't be called anymore when upgrading packages. So there is really no point in running them just once.

Either you run them every time a package is installed (like it used to be) or you never run them.

Second, the `check_processor_flags()` function becomes pointless since it's only run on the machine which created the binary, not on the machine running the binary. But maybe we should consider `check_processor_flags()` obsolete and just remove it.


---

Comment by jdemeyer created at 2016-01-18 10:06:48

I suggest the following: apply just the part of this patch which adds an error message if the Sage installation was moved. Keep the old functionality, including the `sage-force-relocate.txt` file. Then make more serious changes to `sage-location` in Sage 7.1. That will have the least chances of breakage.


---

Comment by vbraun created at 2016-01-18 12:17:02

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-01-18 12:17:02

Making script paths relative is still a plus IMHO for the binary build, so I would keep them. Of course thats a bit of a matter of taste. But I have no intention of engaging in a bikeshedding session here over what to do, either change it yourself or live with it.

This branch is tested and works, any alternative implementation is just going to have lower chances of working. I'm at the sage gap workshop this week so I don't have time to rewrite this for no good reason whatsoever.

Feature requests for `check_processor_flags` should also go to a separate ticket.


---

Comment by jdemeyer created at 2016-01-18 12:24:35

Replying to [comment:18 vbraun]:
> But I have no intention of engaging in a bikeshedding session here over what to do

Not every discussion/disagreement is "bikeshedding". I pointed out actual problems out with your branch (that `sage-location` is not re-run after re-installing packages).

> either change it yourself

Fine.


---

Comment by jdemeyer created at 2016-01-18 12:34:28

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2016-01-18 12:40:52

Replying to [comment:19 jdemeyer]:
> Not every discussion/disagreement is "bikeshedding". I pointed out actual problems out with your branch (that `sage-location` is not re-run after re-installing packages).

That is intentional, there is no relocation after re-installing packages so we shouldn't mislead people into believing anything else.


---

Comment by jdemeyer created at 2016-01-18 12:45:37

New commits:


---

Comment by jdemeyer created at 2016-01-18 12:45:37

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-01-18 12:46:26

This implements [comment:17]: make a minimal patch for Sage 7.0 and deal with the deeper issues later on #19908.


---

Comment by vbraun created at 2016-01-18 12:48:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-01-18 12:48:47

much worse but at least we don't have to hold the release process hostage any more with this pointless exercise


---

Comment by vbraun created at 2016-01-18 12:49:48

Resolution: fixed


---

Comment by jdemeyer created at 2016-01-18 12:57:22

> at least we don't have to hold the release process hostage
Is that cynism really needed? Pointing out issues with a branch is not "holding the release process hostage".

I think you are "reverse bikeshedding": you're destroying half of the nuclear reactor but pretending that you are only repainting the bikeshed.

At least my patch is much safer than yours, because it really only changes the color of the bikeshed.


---

Comment by vbraun created at 2016-01-18 13:02:28

It still leaves lots of misleading messages about relocation that will be confusing to our users, which IMHO is terrible UX. But at least they eventually get a hard error even if it contradicts the signals before.


---

Comment by jdemeyer created at 2016-01-18 13:13:19

Replying to [comment:28 vbraun]:
> It still leaves lots of misleading messages about relocation

I don't believe that the messages are so misleading. The most common is

```
Forcing sage-location, probably because a new package was installed.
Updating various hardcoded paths...
(Please wait at most a few minutes.)
DO NOT INTERRUPT THIS.
```

which is not really wrong.

More seriously, you are of course right that the messages can be improved. However, having a properly functioning Sage is a much higher priority than getting the messages right (which _is_ a bikeshedding issue!)


---

Comment by vbraun created at 2016-01-18 13:21:15

How is a user not going to interpret that as "relocation is ok", especially since it has been like that for the last years.
