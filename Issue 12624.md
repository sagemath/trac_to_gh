# Issue 12624: Allow more general evaluation of FDerivativeOperator

archive/issues_012624.json:
```json
{
    "body": "Assignee: @burcin\n\nCC:  @kcrisman @orlitzky\n\nCurrently:\n\n```\nsage: f=function(\"f\");\nsage: fx=f(x).diff(x).operator();\nsage: fx\nD[0](f)\nsage: fx(x^2)\nNotImplementedError: currently all arguments must be distinct variables\n```\n\nThis can change.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12796\n\n",
    "created_at": "2012-04-03T03:33:27Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Allow more general evaluation of FDerivativeOperator",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12624",
    "user": "https://github.com/nbruin"
}
```
Assignee: @burcin

CC:  @kcrisman @orlitzky

Currently:

```
sage: f=function("f");
sage: fx=f(x).diff(x).operator();
sage: fx
D[0](f)
sage: fx(x^2)
NotImplementedError: currently all arguments must be distinct variables
```

This can change.

Issue created by migration from https://trac.sagemath.org/ticket/12796





---

archive/issue_comments_149889.json:
```json
{
    "body": "With the attached patch we have:\n\n```\nsage: f=function('f')\nsage: g=function('g')\nsage: fx=diff(f(x),x).operator()\nsage: fx(g(x))\nD[0](f)(g(x))\nsage: I=fx(g(x)).integrate(x)\nsage: I\nintegrate(D[0](f)(g(x)), x)\n```\n\nbut unfortunately:\n\n```\nsage: I.simplify()\nTypeError: unable to make sense of Maxima expression 'integrate(at(diff(f(t0),t0,1),[t0=g(x)]),x)' in Sage\n```\n\nThe problem here is in `symbolic_expression_from_maxima_string`. Maxima's syntax allows a sequence as an argument for multiple substitutions, but the string-based parser is unable to handle that.\n`max_to_sr` and `sr_to_max` do the trick already, which is why \"I\" can be defined in the first place. `simplify` still uses the strings-based conversion, hence the problem. Any experts on the parser of maxima strings want to weigh in? In short, the maxima expression\n\n```\nat( f(x,y,z), [x=u,y=v,z=w])\n```\n\nis valid, but is currently not accepted by the string-based parser.",
    "created_at": "2012-04-03T03:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149889",
    "user": "https://github.com/nbruin"
}
```

With the attached patch we have:

```
sage: f=function('f')
sage: g=function('g')
sage: fx=diff(f(x),x).operator()
sage: fx(g(x))
D[0](f)(g(x))
sage: I=fx(g(x)).integrate(x)
sage: I
integrate(D[0](f)(g(x)), x)
```

but unfortunately:

```
sage: I.simplify()
TypeError: unable to make sense of Maxima expression 'integrate(at(diff(f(t0),t0,1),[t0=g(x)]),x)' in Sage
```

The problem here is in `symbolic_expression_from_maxima_string`. Maxima's syntax allows a sequence as an argument for multiple substitutions, but the string-based parser is unable to handle that.
`max_to_sr` and `sr_to_max` do the trick already, which is why "I" can be defined in the first place. `simplify` still uses the strings-based conversion, hence the problem. Any experts on the parser of maxima strings want to weigh in? In short, the maxima expression

```
at( f(x,y,z), [x=u,y=v,z=w])
```

is valid, but is currently not accepted by the string-based parser.



---

archive/issue_comments_149890.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-04-04T05:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149890",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_149891.json:
```json
{
    "body": "The problem of lists as arguments can be solved by changing the grammar that `sage.misc.parser.Parser` accepts: An argument now can also contain a list. This is necessary because the parser is meant to accept essentially maxima language grammar and the construction `at(f(x,y),[x=1,y=2])` is grammatical in maxima.\nThis means that some errors may change from being syntax errors to being semantic errors for certain uses of Parser, but none occur in the doc tests.\n\nAnother possibly controversial point is the name of the temporary variables used: now it's `t0,t1,...`. It's good to pick names that print reasonably, because they can end up on the screen (e.g., if you use\n`latex(maxima(f(x^2).diff(x)))`\nor\n`show(maxima(f(x^2).diff(x)))`.\nand `t` seemed sufficiently neutral for that.",
    "created_at": "2012-04-04T05:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149891",
    "user": "https://github.com/nbruin"
}
```

The problem of lists as arguments can be solved by changing the grammar that `sage.misc.parser.Parser` accepts: An argument now can also contain a list. This is necessary because the parser is meant to accept essentially maxima language grammar and the construction `at(f(x,y),[x=1,y=2])` is grammatical in maxima.
This means that some errors may change from being syntax errors to being semantic errors for certain uses of Parser, but none occur in the doc tests.

Another possibly controversial point is the name of the temporary variables used: now it's `t0,t1,...`. It's good to pick names that print reasonably, because they can end up on the screen (e.g., if you use
`latex(maxima(f(x^2).diff(x)))`
or
`show(maxima(f(x^2).diff(x)))`.
and `t` seemed sufficiently neutral for that.



---

archive/issue_comments_149892.json:
```json
{
    "body": "Just for reference - related, though only very distantly, are #6756 and #6480.",
    "created_at": "2012-04-04T17:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149892",
    "user": "https://github.com/kcrisman"
}
```

Just for reference - related, though only very distantly, are #6756 and #6480.



---

archive/issue_comments_149893.json:
```json
{
    "body": "Quite closely related: #7401, which takes a similar approach but only implements the univariate case.",
    "created_at": "2012-04-05T01:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149893",
    "user": "https://github.com/nbruin"
}
```

Quite closely related: #7401, which takes a similar approach but only implements the univariate case.



---

archive/issue_comments_149894.json:
```json
{
    "body": "Hmm, does that mean that the doctest in #7401 that caused it to never be merged will now not fail?  That would be nice; it was really a shame that was never brought in.",
    "created_at": "2012-04-05T01:46:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149894",
    "user": "https://github.com/kcrisman"
}
```

Hmm, does that mean that the doctest in #7401 that caused it to never be merged will now not fail?  That would be nice; it was really a shame that was never brought in.



---

archive/issue_comments_149895.json:
```json
{
    "body": "It'll take me a while to understand the patch, but combined with #12801 and the use of `function('f')(x)` this looks like it will save me a lot of trouble:\n\n\n```\nsage: f = function('f')                            \nsage: f(x).diff(x)(x=1).substitute_function(f, sin)\ncos(1)\n```\n\n\nI have a *lot* of code I can test it against.",
    "created_at": "2012-04-07T02:48:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149895",
    "user": "https://github.com/orlitzky"
}
```

It'll take me a while to understand the patch, but combined with #12801 and the use of `function('f')(x)` this looks like it will save me a lot of trouble:


```
sage: f = function('f')                            
sage: f(x).diff(x)(x=1).substitute_function(f, sin)
cos(1)
```


I have a *lot* of code I can test it against.



---

archive/issue_comments_149896.json:
```json
{
    "body": "The approach looks correct to me, I've just added a bunch of doctests and fixed some small issues:\n\n* A failing doctest due to an extra space.\n* The p_arg parser couldn't handle val = [x]\n* Logic duplicated in `max_at_to_sage()` and `calculus.at()`\n\nI get two deprecation warnings from my spline code, but one of them occurs on the lines that #12801 modifies, so we can fix them there.\n\nIf the review patch is OK, the original is for me.",
    "created_at": "2012-04-07T18:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149896",
    "user": "https://github.com/orlitzky"
}
```

The approach looks correct to me, I've just added a bunch of doctests and fixed some small issues:

* A failing doctest due to an extra space.
* The p_arg parser couldn't handle val = [x]
* Logic duplicated in `max_at_to_sage()` and `calculus.at()`

I get two deprecation warnings from my spline code, but one of them occurs on the lines that #12801 modifies, so we can fix them there.

If the review patch is OK, the original is for me.



---

archive/issue_comments_149897.json:
```json
{
    "body": "Replying to [comment:9 mjo]:\n> The approach looks correct to me, I've just added a bunch of doctests and fixed some small issues:\n> \n>  * A failing doctest due to an extra space.\n\nThanks! that was a typo that crept in.\n\n>  * The p_arg parser couldn't handle val = [x]\n\nA nice idea, but have you tested what your solution does with \"val = a = 1\" ? I think the result will be (val,(a,1)), which is probably not what is intended (it should be a syntax error).\n\nI did think about a `p_list_or_expr` which peeks to the next token and dispatches to p_list, p_expr etc. Note that we have to be careful with accepting tuples. Otherwise\n`f( (a,1) )` and `f( a=1 )` both get parsed to the same form.\n\nOne way to avoid that is to let p_arg parse `a=1` to `{a:1}`. I don't think Parser ever generates dicts. However, by now we're solving non-existent problems. So perhaps simply not accepting tuples in p_arg (as it is now) is the simpler solution.\n\n>  * Logic duplicated in `max_at_to_sage()` and `calculus.at()`\n\nDon't import `sage.calculus` into `maxima_lib`, because the reverse import is already in effect. I don't think a bit of logic duplication here is so problematic, since the input the routines in maxima_lib have to deal with is much better controlled than the other ones. `maxima_lib` has the potential for much better optimizations. So perhaps leaving it as it was is simplest and acceptable?\n\nThanks for your work.",
    "created_at": "2012-04-07T19:59:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149897",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:9 mjo]:
> The approach looks correct to me, I've just added a bunch of doctests and fixed some small issues:
> 
>  * A failing doctest due to an extra space.

Thanks! that was a typo that crept in.

>  * The p_arg parser couldn't handle val = [x]

A nice idea, but have you tested what your solution does with "val = a = 1" ? I think the result will be (val,(a,1)), which is probably not what is intended (it should be a syntax error).

I did think about a `p_list_or_expr` which peeks to the next token and dispatches to p_list, p_expr etc. Note that we have to be careful with accepting tuples. Otherwise
`f( (a,1) )` and `f( a=1 )` both get parsed to the same form.

One way to avoid that is to let p_arg parse `a=1` to `{a:1}`. I don't think Parser ever generates dicts. However, by now we're solving non-existent problems. So perhaps simply not accepting tuples in p_arg (as it is now) is the simpler solution.

>  * Logic duplicated in `max_at_to_sage()` and `calculus.at()`

Don't import `sage.calculus` into `maxima_lib`, because the reverse import is already in effect. I don't think a bit of logic duplication here is so problematic, since the input the routines in maxima_lib have to deal with is much better controlled than the other ones. `maxima_lib` has the potential for much better optimizations. So perhaps leaving it as it was is simplest and acceptable?

Thanks for your work.



---

archive/issue_comments_149898.json:
```json
{
    "body": "Replying to [comment:10 nbruin]:\n> \n> A nice idea, but have you tested what your solution does with \"val = a = 1\" ? I think the result will be (val,(a,1)), which is probably not what is intended (it should be a syntax error).\n\n\nIndeed. I'll revert this and remove its doctest. It used to return `('val', a)` or I would add a doctest for the syntax error.\n\n\n\n\n> >  * Logic duplicated in `max_at_to_sage()` and `calculus.at()`\n> \n> Don't import `sage.calculus` into `maxima_lib`, because the reverse import is already in effect. I don't think a bit of logic duplication here is so problematic, since the input the routines in maxima_lib have to deal with is much better controlled than the other ones. `maxima_lib` has the potential for much better optimizations. So perhaps leaving it as it was is simplest and acceptable?\n\n\nWe're doing a lazy_import of maxima_lib in calculus, though, or is there still a reason to avoid it? I'll just revert that too if so.",
    "created_at": "2012-04-07T20:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149898",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:10 nbruin]:
> 
> A nice idea, but have you tested what your solution does with "val = a = 1" ? I think the result will be (val,(a,1)), which is probably not what is intended (it should be a syntax error).


Indeed. I'll revert this and remove its doctest. It used to return `('val', a)` or I would add a doctest for the syntax error.




> >  * Logic duplicated in `max_at_to_sage()` and `calculus.at()`
> 
> Don't import `sage.calculus` into `maxima_lib`, because the reverse import is already in effect. I don't think a bit of logic duplication here is so problematic, since the input the routines in maxima_lib have to deal with is much better controlled than the other ones. `maxima_lib` has the potential for much better optimizations. So perhaps leaving it as it was is simplest and acceptable?


We're doing a lazy_import of maxima_lib in calculus, though, or is there still a reason to avoid it? I'll just revert that too if so.



---

archive/issue_comments_149899.json:
```json
{
    "body": "Replying to [comment:11 mjo]:\n> > >  * Logic duplicated in `max_at_to_sage()` and `calculus.at()`\n> > \n> > Don't import `sage.calculus` into `maxima_lib`, because the reverse import is already in effect. I don't think a bit of logic duplication here is so problematic, since the input the routines in maxima_lib have to deal with is much better controlled than the other ones. `maxima_lib` has the potential for much better optimizations. So perhaps leaving it as it was is simplest and acceptable?\n> \n\n> We're doing a lazy_import of maxima_lib in calculus, though, or is there still a reason to avoid it? I'll just revert that too if so.\n\nI know I had trouble with it before, with dummy_integral. You're right that the lazy import might have fixed the issue there.\n\nMy main argument against sharing the code would be to keep the logic simple. The routines `symbolic_expression_from_maxima_string` and `max_to_sr` both serve to translate maxima expressions to SR expressions and they do so independently by design (ideally, we can eventually rip out the entire string-based conversion). In this case we're finding that both need to translate `at` to a `subs` method call. In both cases, the translation is straightforward. If you find that the translation step is too involved to replicate, the proper place to fix it would be to add, for instance, an \"at\" method to SR that accepts input closer to what `symbolic_expression_from_maxima_string` and `max_to_sr` find. I don't think that's necessary (and it's nicer to keep SR as lean as possible).",
    "created_at": "2012-04-08T03:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149899",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:11 mjo]:
> > >  * Logic duplicated in `max_at_to_sage()` and `calculus.at()`
> > 
> > Don't import `sage.calculus` into `maxima_lib`, because the reverse import is already in effect. I don't think a bit of logic duplication here is so problematic, since the input the routines in maxima_lib have to deal with is much better controlled than the other ones. `maxima_lib` has the potential for much better optimizations. So perhaps leaving it as it was is simplest and acceptable?
> 

> We're doing a lazy_import of maxima_lib in calculus, though, or is there still a reason to avoid it? I'll just revert that too if so.

I know I had trouble with it before, with dummy_integral. You're right that the lazy import might have fixed the issue there.

My main argument against sharing the code would be to keep the logic simple. The routines `symbolic_expression_from_maxima_string` and `max_to_sr` both serve to translate maxima expressions to SR expressions and they do so independently by design (ideally, we can eventually rip out the entire string-based conversion). In this case we're finding that both need to translate `at` to a `subs` method call. In both cases, the translation is straightforward. If you find that the translation step is too involved to replicate, the proper place to fix it would be to add, for instance, an "at" method to SR that accepts input closer to what `symbolic_expression_from_maxima_string` and `max_to_sr` find. I don't think that's necessary (and it's nicer to keep SR as lean as possible).



---

archive/issue_comments_149900.json:
```json
{
    "body": "Revert two chunks of the review patch per comments",
    "created_at": "2012-04-08T03:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149900",
    "user": "https://github.com/orlitzky"
}
```

Revert two chunks of the review patch per comments



---

archive/issue_comments_149901.json:
```json
{
    "body": "Attachment [sage-trac_12796-review.patch](tarball://root/attachments/some-uuid/ticket12796/sage-trac_12796-review.patch) by @orlitzky created at 2012-04-08 03:56:33\n\nNo problem, I'm just trying to wrap my head around all of the symbolics code. I've reverted those two changes in the last patch.",
    "created_at": "2012-04-08T03:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149901",
    "user": "https://github.com/orlitzky"
}
```

Attachment [sage-trac_12796-review.patch](tarball://root/attachments/some-uuid/ticket12796/sage-trac_12796-review.patch) by @orlitzky created at 2012-04-08 03:56:33

No problem, I'm just trying to wrap my head around all of the symbolics code. I've reverted those two changes in the last patch.



---

archive/issue_comments_149902.json:
```json
{
    "body": "OK! I'm happy with the reviewer patch. Thank you for writing such comprehensive documentation. I'll leave it to you to set the ticket to positive review if you're happy now as well.",
    "created_at": "2012-04-08T05:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149902",
    "user": "https://github.com/nbruin"
}
```

OK! I'm happy with the reviewer patch. Thank you for writing such comprehensive documentation. I'll leave it to you to set the ticket to positive review if you're happy now as well.



---

archive/issue_comments_149903.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-08T15:47:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149903",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_149904.json:
```json
{
    "body": "Why was there no newline after the commit message?... fixed now.",
    "created_at": "2012-04-10T09:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149904",
    "user": "https://github.com/jdemeyer"
}
```

Why was there no newline after the commit message?... fixed now.



---

archive/issue_comments_149905.json:
```json
{
    "body": "Apply this patch",
    "created_at": "2012-04-10T09:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149905",
    "user": "https://github.com/jdemeyer"
}
```

Apply this patch



---

archive/issue_comments_149906.json:
```json
{
    "body": "Attachment [12796.patch](tarball://root/attachments/some-uuid/ticket12796/12796.patch) by @jdemeyer created at 2012-04-19 06:40:57",
    "created_at": "2012-04-19T06:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149906",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12796.patch](tarball://root/attachments/some-uuid/ticket12796/12796.patch) by @jdemeyer created at 2012-04-19 06:40:57



---

archive/issue_comments_149907.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-04-19T06:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12624",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12624#issuecomment-149907",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
