# Issue 11023: Implementation of finite reflection groups

Issue created by migration from https://trac.sagemath.org/ticket/11187

Original creator: stumpc5

Original creation time: 2011-04-13 15:07:49

Assignee: tbd

CC:  vripoll kdilks simonking jmichel hivert

Keywords: reflection group

This patch adds a function


```
sage: FiniteReflectionGroup(classification_type)
```


to work with finite (crystallographic, real, complex) reflection groups. It uses the data from GAP3/chevie.

Depends on #8327.


---

Comment by stumpc5 created at 2011-04-14 00:36:45

Changing status from new to needs_work.


---

Comment by stumpc5 created at 2011-04-14 00:36:45

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by stumpc5 created at 2011-04-18 19:22:10

Apply only trac_11187-finite_reflection_groups-cs.patch


---

Comment by stumpc5 created at 2011-04-24 19:23:31

Apply only trac_11187-finite_reflection_groups-cs.patch


---

Comment by stumpc5 created at 2011-04-24 19:23:31

Changing status from needs_work to needs_review.


---

Comment by stumpc5 created at 2011-06-08 21:01:56

Changing status from needs_review to needs_work.


---

Comment by stumpc5 created at 2011-06-10 16:47:25

Apply only trac_11187-finite_reflection_groups-cs.patch


---

Attachment


```
+    class SubcategoryMethods:
+
+        @cached_method
+        def Irreducible(self):
+            """
+            Returns the full subcategory of the irreducible objects of ``self``.
+
+            EXAMPLES::
+
+                sage: CoxeterGroups().Irreducible()
+                Category of irreducible coxeter groups
+
+            TESTS::
+
+                sage: AffineWeylGroups().Irreducible.__module__
+                'sage.categories.complex_reflection_groups'
+            """
+            return self._with_adjectives(('Irreducible',))
+
+    class Irreducible(AdjectiveCategory):
+        pass
+
```



---

Comment by tscrim created at 2013-04-12 14:08:08

I've factored out the `CartanMatrix` class into #14137.


---

Comment by tscrim created at 2013-06-21 13:59:01

I've rebased the patch and noticed that this will likely depend on #10963. I'll post a new version once I completely untangle what is going on with #10963.


---

Comment by tscrim created at 2013-06-21 13:59:01

Changing keywords from "reflection group" to "reflection group, days49".


---

Comment by stumpc5 created at 2013-06-21 14:04:51

Replying to [comment:11 tscrim]:
> I've rebased the patch and noticed that this will likely depend on #10963. I'll post a new version once I completely untangle what is going on with #10963.

I always made some minor changes on this patch locally - I would actually only start working on this patch after you guys are finished with #10963. If you want to actively work on this patch, ping me again, and we can discuss what is still needed to finilize this patch.

Cheers, Christian


---

Comment by chapoton created at 2014-06-30 19:28:55

Hello Christian

Do you have a git branch for this ticket somewhere ? or should I try to resurrect the patch ?


---

Comment by stumpc5 created at 2014-07-01 02:36:25

> Do you have a git branch for this ticket somewhere ? or should I try to resurrect the patch ?

No, I don't. But I have a local old version of Sage containing that code and quite a bit more, so I wonder if I should/will try to organize it a bit and put it up here.

Do you need any from that code in particular (in which case I am more tempted to work on that), or is that just a general question?


---

Comment by chapoton created at 2014-07-01 11:32:58

Hello, no, no real need for this code, just asking a general question. Now that #10963 is over.


---

Comment by tscrim created at 2014-07-28 08:12:08

Here's a git version of this patch with changes necessary to get Sage to start (I did not run any tests, so I am not saying things are working). There might be other changes to the files in question which need to be moved over too. Just as a general note from doing the rebasing, there are a bunch of methods missing doctests.
----
New commits:


---

Comment by git created at 2014-07-28 20:23:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-28 20:31:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-29 11:37:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-29 12:14:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-30 12:48:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-31 09:03:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-31 20:34:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-08 19:19:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-24 20:43:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-31 22:00:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-01 09:37:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-02 11:06:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-02 11:41:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-02 12:38:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-02 14:38:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-02 19:20:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-02 19:48:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-02 20:12:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2015-06-02 21:59:17

The current code gives

```
sage: C = ComplexReflectionGroups()
sage: C.Irreducible()
Category of complex reflection groups
sage: C.Irreducible() is C
True
```

Is that what you intended? Perhaps the "irreducible" axiom should be defined on `ComplexReflectionGroups().Finite()`, not on `ComplexReflectionGroups()`.


---

Comment by SimonKing created at 2015-06-02 22:22:14

To summarise the discussion Christian and I just had: I believe `WellGenerated` should be an axiom. Christian said that the general notion of well-generated is a bit tricky for infinite groups. Hence, he actually only wants to take into account well-generatedness for _finite_ complex reflection groups.

Hence, the aim would be to define `WellGeneratedComplexReflectionGroups` as application of an axiom to `ComplexReflectionGroups.Finite`. However, I believe that the name should contain the word "finite" if we really want to focus on finite well-generated groups. Alternatively, it should be implemented as a nested-nested class `WellGenerated` within the nested class `ComplexReflectionGroups.Finite`.

I also think that `WellGeneratedComplexReflectionGroups` should provide a parent method `_test_well_generated` that tests whether `self` is well-generated. Such method would automatically be executed when running the test suite.


---

Comment by SimonKing created at 2015-06-02 22:26:42

We have discussed already that in order to fix the `Irreducible` axiom, it is needed (in addition to the nested class) to have a `SubcategoryMethod` called `Irreducible`.

Note that if we define `WellGeneratedComplexReflectionGroups` as a sub-category of `ComplexReflectionGroups.Finite()`, we should probably remove its subcategory-methods `Finite` and `Irreducible`, since both axioms have already been defined in the super-category.


---

Comment by SimonKing created at 2015-06-02 22:30:00

The iterators currently cache the list of all elements of the group. Is that (always) a good idea?


---

Comment by SimonKing created at 2015-06-02 23:22:50

After discussion with Christian, the iterator of a complex reflection group is a lot faster. What we did was to keep `._reduced_word` as a list, and only transform it into an actual word when needed (i.e., in the `.reduced_word()` method).

Before:

```
sage: G = ComplexReflectionGroup([2,1,4])
sage: %timeit L = list(G); G._elements=None
The slowest run took 6.02 times longer than the fastest. This could mean that an intermediate result is being cached 
1 loops, best of 3: 66.4 ms per loop
```

After:

```
sage: G = ComplexReflectionGroup([2,1,4])
sage: %timeit L = list(G); G._elements=None
The slowest run took 66.44 times longer than the fastest. This could mean that an intermediate result is being cached 
1 loops, best of 3: 5.56 ms per loop
```

----
New commits:


---

Comment by chapoton created at 2015-06-03 18:58:30

New commits:


---

Comment by git created at 2015-06-03 23:41:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2015-06-03 23:48:34

Hi Christian,

This is not how the tests work:

```python
                def _test_well_generated(self, **options):
                    tester = self._tester(**options)
                    return self.is_well_generated()
```

Instead, do

```python
                def _test_well_generated(self, **options):
                    tester = self._tester(**options)
                    tester.assert_(self.is_well_generated())
```

or something similar.


---

Comment by chapoton created at 2015-06-04 07:08:20

see patchbot reports : 
* some doctests should be marked with `# optional - chevie` or whatever
* doctest continuation is now `....:` and not `...`
* raise statements should use py3 syntax `raise Error('message')`


---

Comment by git created at 2015-06-04 11:45:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2015-06-04 11:57:33

`@`Simon and Nicolas: The category for complex reflection groups (with axioms finite/irreducible/well-generated) is now sort of ready. I would now like to make `ComplexReflectionGroups().Finite().WellGenerated()` a super category of `FiniteCoxeterGroups`.

* Is that what I should do?
* If I simply add a method `supercategories` to `FiniteCoxeterGroups`, its string repr changes in a not desired way. How should I treat that?

Thanks, Christian


---

Comment by git created at 2015-06-05 00:12:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-05 06:50:38

Replying to [comment:56 stumpc5]:
> `@`Simon and Nicolas: The category for complex reflection groups (with axioms finite/irreducible/well-generated) is now sort of ready. I would now like to make `ComplexReflectionGroups().Finite().WellGenerated()` a super category of `FiniteCoxeterGroups`.
> 
> * Is that what I should do?
> * If I simply add a method `supercategories` to `FiniteCoxeterGroups`, its string repr changes in a not desired way. How should I treat that?

It sounds more like you want to add `ComplexReflectionGroups().WellGenerated()` as a supercategory to `CoxeterGroups`, in particular to replace `Groups().FinitelyGenerated()` by `ComplexReflectionGroups().WellGenerated()`. I also think `ComplexReflectionGroups()` should be a subcategory of `Groups().FinitelyGenerated()` (otherwise the additional axiom should go on the supercategory for `CoxeterGroups()`). The finite part will take care of itself by the `CategoryWithAxiom` magic.


---

Comment by git created at 2015-06-05 19:04:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-06-05 19:14:02

Hello,

- once again: doctest continuation is now `....:` and not `...`

- could you please put a positive review on the duplicate #9288 ?


---

Comment by git created at 2015-06-05 19:26:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2015-06-05 19:31:24

Hi

> - once again: doctest continuation is now `....:` and not `...`

done

> - could you please put a positive review on the duplicate #9288 ?

done

Thanks for looking at this (and all the other tickets!

    Christian


---

Comment by git created at 2015-06-05 22:46:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-06 01:16:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-06 01:18:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2015-06-06 01:19:38

I took out the subword complex stuff which is handled in #11010, and which is depending on this one.


---

Comment by git created at 2015-06-06 02:10:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-10 20:31:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-11 07:05:12

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-06-11 08:05:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-12 14:26:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-12 14:37:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-14 17:23:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-15 11:27:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-15 13:11:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-15 14:02:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-15 14:48:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-15 14:55:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2015-06-15 15:16:27

Changing keywords from "reflection group, days49" to "reflection group, days49, days 64.5".


---

Comment by git created at 2015-06-16 09:59:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-16 10:14:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-06-17 07:35:58

Hello Christian,
thanks for your hard work on this ticket. I have only had a quick look, so trivial remarks:
* not yet 100% coverage, I think (I have seen a few methods without examples)
* `TODO::` should be `.. TODO::`
* Could you please replace `Returns` by `Return` everywhere.
* Sometime the first line of the doc is made of two sentences. Please separate them as:

```
Return something.

Something is very very important.
```

* Please try to keep the lines 80 characters long.
* Bad alignement of EXAMPLES:: in `distinguished_reflection`, `distinguished_reflections`
* missing optional in `sage: W = CoxeterGroup(["A",4], implementation="chevie")`

And you should aim to have a green light from the patchbot. So far, this has *never* been the case.


---

Comment by stumpc5 created at 2015-06-17 07:49:15

Replying to [comment:86 chapoton]:

Thanks for having a look at this ticket!

> I have only had a quick look, so trivial remarks

I am aware of the stuff to do in the documentation, but before getting there (or, at least, in parallel, I'll fix your complaints now), I try to get the overall setting right (this includes the category framework, the interaction with other reflection group classes, and the dependence of chevie).

> And you should aim to have a green light from the patchbot. So far, this has *never* been the case.

I'd like to get it green, but it has not run in 5 days, and I can only fix stuff the patchbot complaints about if I see its results regularly after uploading a new commit sequence (a patchbot that doesn't run soon after uploading doesn't really help during a coding sprint)...

Thanks again, Christian


---

Comment by chapoton created at 2015-06-17 08:08:19

There are many patchbots, but only one that has added all your participants to its trust list (_at my demand_). This one is currently not active. You can try to contact some active patchbots owners to ask them to trust the participants (see http://wiki.sagemath.org/buildbot/owners and http://patchbot.sagemath.org/machines). Or run your own patchbot.


---

Comment by stumpc5 created at 2015-06-17 08:13:42

> There are many patchbots, but only one that has added all your participants to its trust list (at my demand).

Oh, I didn't know that **all** participants must be on the trust list, I thought it was only the submitter of the branch - I gonna try to get a patchbot running...


---

Comment by chapoton created at 2015-06-17 08:18:00

Yes, this comes from some difficulty to identify the true authors of the code..

For patchbot, please see the instructions there : http://wiki.sagemath.org/buildbot/details


---

Comment by git created at 2015-06-17 11:56:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kdilks created at 2015-06-17 21:05:09

I just started a patchbot recently, and I believe I now have it configured to trust all relevant participants and prioritize this ticket.

First run through wasn't very helpful, since I don't have Chevie installed. Though presumably everything should be marked with some kind of optional tag so that tests are skipped if Chevie isn't installed.

I'm in the process of trying to install Chevie, and if I succeed, I'll have it do another run.


---

Comment by kdilks created at 2015-06-18 10:04:12

I have Gap3/Chevie installed now.

It's probably easier (and a lot faster) to run

`./sage -t ./src/sage/combinat/root_system/reflection_group_complex.py` ,

and if things are crashing and you need to see where, then do

`./sage -t --verbose ./src/sage/combinat/root_system/reflection_group_complex.py` .

Patchbots are good for finding merge conflicts with new betas and seeing if you unintentionally broke other parts of Sage, but at this point I think it's sufficient to only test the one file you're changing with this ticket.

After playing around for a bit, something seems to be broken with the iterator. The example `W = ReflectionGroup((1,1,3))` (should be isomorphic to S3) included as a test works fine, but if I try `W = ReflectionGroup((3,1,1))` (should be isomorphic to cyclic group of order 3) then it keeps printing out the three elements in a never-ending loop.


---

Comment by jdemeyer created at 2015-06-18 10:11:30

Replace

```
# optional (require chevie)
```

by

```
# optional - chevie
```



---

Comment by jdemeyer created at 2015-06-18 10:13:24

When adding new files, you should follow [http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files](http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files), in particular use the correct license statement.


---

Comment by stumpc5 created at 2015-06-18 10:14:24

Thanks for having a look here! I am currently working (since yesterday) on speeding the iteration through the group, I hope I have gotten somewhere later today...

I guess I must tag each and every test as

```
# optional - chevie
```

which means that these tests are not run on patchbots per default, or do they run if the patchbot has chevie installed?


---

Comment by jdemeyer created at 2015-06-18 10:19:07

Replying to [comment:96 stumpc5]:
> I guess I must tag each and every test

Not literally every test, there are probably tests which do not require `chevie`.

> do they run if the patchbot has chevie installed?

They would be run if the Sage optional package `chevie` is installed. However, such a package does not exist.


---

Comment by stumpc5 created at 2015-06-18 11:13:29

Replying to [comment:97 jdemeyer]:
> Not literally every test, there are probably tests which do not require `chevie`.

Every test (except for the creation of the category of complex reflection groups) handle with reflection groups (no surprise), and even initializing such a group requires `chevie`.

But within finite time, I will work on making some core functionalities work without having `chevie` installed.

> They would be run if the Sage optional package `chevie` is installed. However, such a package does not exist.

Is that a problem? Should there be a possibility of installing `chevie` as an optional package? I update the description of this ticket to explain how to get chevie installed in a system. See #8906 for old stuff about that.


---

Comment by jdemeyer created at 2015-06-18 11:37:11

Replying to [comment:98 stumpc5]:
> Is that a problem? Should there be a possibility of installing `chevie` as an optional package?

It's not a problem for me or for this ticket. I guess it is a problem if people want to use the code that you are writing here, since getting `chevie` to work within Sage is non-trivial.


---

Comment by git created at 2015-06-18 11:55:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-18 15:25:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2015-06-18 15:28:12

Okay, got 100% coverage and all tests passing! But I wouldn't know how to get the startup module green as I turned the `ComplexReflectionGroups` category into a super category of `CoxeterGroups` which is loaded on startup.


---

Comment by kdilks created at 2015-06-18 17:15:44

I have a failing doctest for `is_regular`. There's not a problem with the `is_regular` method, but for `W = ReflectionGroup(23)`, there are two elements where my computer returns a different reduced word than expected ( https://www.diffchecker.com/ewvevrda ). I consistently get the same different answer. Are you using the older/more stable gap-jm4, or the latest gap-jm5 ?

Unrelated, but I also can't get the long_element() method to work.


---

Comment by stumpc5 created at 2015-06-18 18:12:33

Replying to [comment:104 kdilks]:
> for `W = ReflectionGroup(23)`, there are two elements where my computer returns a different
> reduced word than expected

This computation is currently done purely in my code, and it's not related to `chevie`. The iterator comes from `_iterator_tracking_words` so let's see what happens there.

Related here, and indeed also to your question on `long_element`, observe that currently

```
sage: W = ReflectionGroup(23); W
Irreducible complex reflection group of rank 3 and type H3
sage: W.category()
Join of Category of finite permutation groups and Category of irreducible finite coxeter groups
sage: W = ReflectionGroup(['H',3]); W
Irreducible real reflection group of rank 3 and type H3
sage: W.category()
Join of Category of finite permutation groups and Category of irreducible finite coxeter groups
```


Since the iter algorithm for coxeter groups is slightly smarter (it takes into account that the weak order is graded), the two iter functions are different.

But:

* both iter functions are supposed to return the same iteration through the group
* both iter functions should always return the elements in the very same order (in contrary to what we see on my vs on your machine)

I found a bug (having a `set` rather than a `list` in one spot), so let's see if this is fixed with my next push in a few minutes after all tests pass here.

> Unrelated, but I also can't get the long_element() method to work.

The reason is, that you constructed the real group as a complex group, so the long element for `ReflectionGroup(['H',3])` works while it currently doesn't work for `ReflectionGroup(23)`. I do have to fix that and be more careful constructing the right class instance.


---

Comment by git created at 2015-06-18 18:25:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-19 12:34:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-06-24 07:48:25

There are a few failing doctests, some easy, some less clear.


---

Comment by chapoton created at 2015-07-11 06:24:11

now needs rebase, and care for the many failing doctests


---

Comment by git created at 2015-07-26 02:57:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-26 11:56:58

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2015-08-24 09:49:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-10-04 19:06:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-03 12:06:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-15 16:43:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-15 17:15:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-19 09:34:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-19 09:51:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-27 15:56:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-28 15:32:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-01-28 16:55:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-02-24 19:10:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-16 07:49:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-16 08:29:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-03-25 20:30:20

are you aware of Geck's [PyCox](http://journals.cambridge.org/download.php?file=%2FJCM%2FJCM15%2FS1461157012001064a.pdf&code=2dce26d518748bf0db323feb4fadd1e3)?
http://www.mathematik.uni-stuttgart.de/~geckmf/chv1r6180.py


---

Comment by stumpc5 created at 2016-03-26 14:12:36

Replying to [comment:129 dimpase]:
> are you aware of Geck's [PyCox](http://journals.cambridge.org/download.php?file=%2FJCM%2FJCM15%2FS1461157012001064a.pdf&code=2dce26d518748bf0db323feb4fadd1e3)?
> http://www.mathematik.uni-stuttgart.de/~geckmf/chv1r6180.py

Sure, but it is limited to finite _real_ reflection groups, while I certainly want to work with real and with complex reflection groups. E.g., the results in
* http://jlms.oxfordjournals.org/content/90/3/919.abstract (paywall)
* http://arxiv.org/abs/1211.2789 (free)
were only possible by using the code in this ticket to work in Sage with complex reflection groups from chevie through the gap3 interface.


---

Comment by git created at 2016-04-02 15:59:11

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by stumpc5 created at 2016-04-08 07:38:01

Concerning the iteration through elements without keeping them in memory, we have to benchmark agains

```
    gap> i:=0;;
    gap> W:=CoxeterGroup("E",7);;
    gap> ForEachElement(W,function(x)i:=i+1; 
    > if i mod 1000000=0 then Print("*\c");fi;
    > end);Print("\n");
    **
```

which takes about a second per million elements, see https://webusers.imj-prg.fr/~jean.michel/gap3/htm/chap075.htm.


---

Comment by tscrim created at 2016-04-08 10:05:42

Continuing the discussion from #13580.

Replying to [#13580 hivert]:
> Replying to [#13580 tscrim]:
> > Christian, Vivien, and I are working on trying to speed up the iteration of
> > finite Coxeter groups by using (subgroups of) permutation groups and the
> > iterator method of generic Coxeter groups, which uses a `SearchForest` (see
> > #11187 and the `CoxeterGroups` category). Our goal is to try and match or
> > beat GAP3 iteration time (which we are about ~30x slower).
> 
> I'll be both very happy and interested to have usecase for this code.

This will have the more serious use case I know of (the code in the generic Coxeter groups iterator, e.g., via `CoxeterGroup`, has not had any serious optimization attempts AFAIK).

> > We are in the process pushing our successor computation code to Cython and
> > some of our other methods, but we would appreciate any insights you have.
> 
> Do you have a typical example relying on `SearchForest` of code on top of
> #11187 that I can profile ? Note that I included in the documentation of
> map_reduce.py a guide on how to profile the parallel code. I'd like to measure
> the proportion of time that is spend on Coxeter code one one hand and on the
> parallel infrastructure on the other.

Our current test cases are B<sub>6</sub> (~0.5s) and E<sub>7</sub> (~1m).

> Now, concerning coxeter group, I'm quite sure that rewriting part of the code
> in C/C++ and using advanced parallel stuff (AVX instruction set + SIMD) you
> can get speedup a large as several hundreds and even thousand ! As a witness
> on https://github.com/hivert/IVMPG I wrote a code whose goal is to enumerate
> integer vector modulo permutation group. Compared to the code we have in Sage
> which has been Cythonized and optimized by Simon King I manage to get speedup
> a large as x2000 ! I need help on the build system to be able to distribute
> it. I'm pretty sure the code there is very similar to what you need in Coxeter
> groups.

One of the thoughts I'm bouncing around is doing a full C/C++ version using arrays, and then using Cython (mainly `PermutationGroupElement`) as a transfer layer to Sage/GAP. In which case it probably should be split off as a little specialized spkg.

That is quite an impressive speedup. I know a little bit about build systems (and its on my todo to learn more for fixing up coxeter3/LiE too), but, e.g., Jeroen or FranÃ§ois are good people to ask. Although if you need GCC 5.x, then we will need to do some changes to Sage. Yet, I think moving to GCC 5.x is something that we want and are going to do soon...
----
New commits:


---

Comment by hivert created at 2016-04-08 11:12:06

Replying to [comment:134 tscrim]:
> One of the thoughts I'm bouncing around is doing a full C/C++ version using arrays, and then using Cython (mainly `PermutationGroupElement`) as a transfer layer to Sage/GAP. In which case it probably should be split off as a little specialized spkg.

This is very similar to what I did. The idea is that if you want large performance, you need to completely control the way you use the memory. So what I did is to build in parallel a large linked list of arrays and then thanks to Cython I returns Sage an iterator which is a view on this list which wrap the element of the linked list into proper Sage Element.


---

Comment by git created at 2016-04-08 13:49:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-09 06:43:02

For the record: as discussed last night, the first goal would be to separate the category stuff into its own ticket (`@`tscim is working on this), and then to get the present version well documented, tested, and finished. Only after this work is done, we will start improving stuff and add functionality.

To this end, we have to:
* get the category stuff right
* test properly that reducible groups work as desired
* test properly that the labelling system of simples/hyperplanes/reflections works properly
* test that the assumptions on how we obtain the data from chevie is correct (one example here is that the code tries to get n simple reflections, N* distinguished reflections, and then the remaining (N-N*) other reflections when listing all reflections. This has to be rechecked, but there are plenty of more similar examples.
----
New commits:


---

Comment by chapoton created at 2016-04-09 07:22:34

new branch, I have cleaned up the imports
----
New commits:


---

Comment by git created at 2016-04-09 07:59:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 09:20:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 09:45:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 09:51:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 10:02:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 10:10:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 10:23:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 10:26:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 10:30:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-09 10:36:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-04-09 12:51:18

New commits:


---

Comment by git created at 2016-04-09 14:49:06

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by tscrim created at 2016-04-09 16:52:36

Everything should work now up to the printing of well-generated as part of the finite Coxeter group category.
----
Last 10 new commits:


---

Comment by chapoton created at 2016-04-09 19:12:06

New commits:


---

Comment by tscrim created at 2016-04-09 21:30:38

I was able to stop `GeneralizedCoxeterGroup`, `ComplexReflectionGroup`, and `FiniteCoxeterGroup` from being imported during startup.
----
New commits:


---

Comment by git created at 2016-04-10 06:56:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-10 07:42:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-10 08:08:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-04-10 11:48:03

some tiny fixes in doc, mainly
----
New commits:


---

Comment by stumpc5 created at 2016-04-10 12:10:14

in the cython iterator, we should use sth like

```
tuple( W.simple_reflection(W._index_set_inverse[i]) for i in xrange(len(W._index_set)) )
```



---

Comment by tscrim created at 2016-04-10 12:25:59

New commits:


---

Comment by git created at 2016-04-10 15:48:00

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by stumpc5 created at 2016-04-10 16:38:57

New commits:


---

Comment by git created at 2016-04-10 18:42:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-10 18:43:38

Only two trivial doctests failing + the missing doctest for `_test_well_generated`, though Nicolas thought he had added it.


---

Comment by git created at 2016-04-10 21:58:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 07:03:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 08:12:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 08:41:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 09:53:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 09:55:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 10:04:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 10:14:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 10:23:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 11:59:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 12:38:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 13:06:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 13:08:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 14:13:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 14:43:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 14:55:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 15:31:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 15:37:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 15:45:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 16:21:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 18:24:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 18:40:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 18:58:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 19:10:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 19:30:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 21:02:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 21:06:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-11 21:22:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-12 07:31:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-12 07:33:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-12 07:42:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-12 10:28:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-12 10:33:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-12 12:48:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-12 15:49:19

Okay, all tests pass!


---

Comment by stumpc5 created at 2016-04-13 07:14:47

`@`trscim: For the record, the timings for iteration in E7 seem to be odd:

```
sage: W = ReflectionGroup(['E',7])                                              
sage: %time for w in W.iteration(algorithm="depth",tracking_words=False): pass  
CPU times: user 3.71 s, sys: 0 ns, total: 3.71 s
Wall time: 3.79 s
sage: %time for w in W.iteration(algorithm="breadth",tracking_words=False): pass
CPU times: user 8.72 s, sys: 4.84 ms, total: 8.73 s
Wall time: 8.72 s
sage: %time for w in W.iteration(algorithm="depth",tracking_words=True): pass   
CPU times: user 5.83 s, sys: 0 ns, total: 5.83 s
Wall time: 5.81 s
sage: %time for w in W.iteration(algorithm="breadth",tracking_words=True): pass 
CPU times: user 20.6 s, sys: 67.4 ms, total: 20.6 s
Wall time: 20.7 s
```

Also, I discussed with Nicolas yesterday, and (as what I said on the weekend), we are back at the situation that one can be much smarter concerning the ascents: Let i be an ascent of w and si and s_j commute. Then i is also an ascent of wsj. I will try to use that today, but it still seems that any test in this direction is much slower than doing the actual test for an ascent the way we already do it.


---

Comment by git created at 2016-04-13 10:13:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-13 10:21:11

Travis, could you have a look at the diffset 8497f5d; I commented out that the change is actually used, see `#for i in self.noncom[first]`, it seems to slow down the test even though much less is actually tested. Maybe you see how to get rid of the overhead the line `for i in self.noncom[first]` has compared to `for i in range(first+1,self.n)`.


---

Comment by stumpc5 created at 2016-04-13 10:33:26

Travis: Also, you introduced `_reduced_word` to be a lazy attribute. This has a few drawbacks: `not self._reduced_word is None` in the length function in `reflection_group_real.py` is never triggered, and `_reduced_word` is now either a word in the index set (if the lazy attribute is triggered in the real case), or a word in `range(n)` if one has gotten it through the iterator. This way, the method `reduced_word` in the real case is always executed, even though the reduced word is already known.

Two solutions are:
* either set `_reduced_word` to a word in the indices in the iterator for the cost of list lookups for each letter in the word
* write the lazy attribute in the real case so that it gives a word in `range(n)`
* do neither and forget about the info gotten from the iterator in the real case.


---

Comment by tscrim created at 2016-04-13 13:01:01

Replying to [comment:210 stumpc5]:
> Travis, could you have a look at the diffset 8497f5d; I commented out that the change is actually used, see `#for i in self.noncom[first]`, it seems to slow down the test even though much less is actually tested. Maybe you see how to get rid of the overhead the line `for i in self.noncom[first]` has compared to `for i in range(first+1,self.n)`.

My guess is because Cython is smart enough to translate

```python
for i in range(n)
```

into

```c
for(i=0; i<n; ++i)
```

whereas for the other, it is iterating over some object (which, a priori, may not even be iterable). In more detail, Cython doesn't even know that it is iterating over a list, just that `self.noncom` is. Try:

```python
        nc = self.noncom[first]
        for i in nc:
```

or the variant

```python
        nc = self.noncom[first]
        k = len(nc)
        for dummy in range(k):
            i = nc[dummy]
```

where you have `cdef list nc` and `cdef int dummy, k` (although I suspect the former of these is faster).


---

Comment by tscrim created at 2016-04-13 13:24:30

Replying to [comment:211 stumpc5]:
> Travis: Also, you introduced `_reduced_word` to be a lazy attribute. This has a few drawbacks: `not self._reduced_word is None` in the length function in `reflection_group_real.py` is never triggered, and `_reduced_word` is now either a word in the index set (if the lazy attribute is triggered in the real case), or a word in `range(n)` if one has gotten it through the iterator. This way, the method `reduced_word` in the real case is always executed, even though the reduced word is already known.
Doing this simplified the code and probably got us a small speedup. Yet, this is a bug in my implementation.  However, I'm not sure how much it is worth it to compute the length of an arbitrary element without computing its reduced word. If it becomes that time critical for someone, we can get them an `algorithm` option for `length()`.

> This way, the method `reduced_word` in the real case is always executed, even though the reduced word is already known.

This doesn't make sense. If anything `reduced_word()` will throw an error if `_reduced_word` was done by the `lazy_attribute`. The iterator overwrites (the lazy attribute) `_reduced_word` if the word comes from there, so it does not get computed twice. Otherwise it was a user created word and will never be identical (not just equals) to an element created from the iterator.

> Two solutions are:
> * write the lazy attribute in the real case so that it gives a word in `range(n)`

This is what I would do. Although we might be better off just doing our own implementation using a list (which we mutate) and starting with `self.domain()`.


---

Comment by git created at 2016-04-13 14:58:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-13 15:00:22

Done with "write the lazy attribute in the real case so that it gives a word in range(n)". This is now moved to cython (speed gain ~100 times faster).


---

Comment by stumpc5 created at 2016-04-13 15:04:11

One big issue that is still waiting for me to fix it is that it remains unclear if we want a left or right action. The implementation is a left action, but e.g. #20402 assumes a right action. I will get to this before the weekend and would then hope for the code to become stable and some final reviewing :-)


---

Comment by tscrim created at 2016-04-13 15:43:13

Just FYI - you have reverted a python3 compatible change with this:

```diff
-                ....:     print('%s %s'%(w.reduced_word(), w.is_regular(W.coxeter_number())))
+                ....:     print w.reduced_word(), w.is_regular(h)
```

I think `2to3` can handle this, but I'm just stating a paranoia about it.

Although I would advocate for making doctests that avoid printing through an iteration altogether (really annoying failures when the iteration order changes), but this isn't really a big issue.

I will take a more detailed look at the recent changes before the weekend.


---

Comment by nthiery created at 2016-04-13 16:48:11

Replying to [comment:216 stumpc5]:
> One big issue that is still waiting for me to fix it is that it remains unclear if we want a left or right action. The implementation is a left action, but e.g. #20402 assumes a right action. I will get to this before the weekend and would then hope for the code to become stable and some final reviewing :-)

How much additional code would it take to make it work on both sides, allowing the user to do `ReflectionGroup(..., action="right")`?


---

Comment by stumpc5 created at 2016-04-13 17:23:28

> Just FYI - you have reverted a python3 compatible change with this

I am sure there are reasons for that python3 convention, but I do prefer simple to read code. Anyway, I can also do the other if you prefer.

> How much additional code would it take to make it work on both sides,

I was afraid you'd ask that. in my eyes: too much. The elements are considered as permutations, words, and matrices at the same time (and there are even two types of words, in simples and in all reflections, and the simple words have wired properties in the non-real case), making options would pollute the code just soo much, I think, and would introduce so many possible mistakes. I prefer to have clean and fast code, that is hopefully getting better than chevie, eventually. Once that is achieved, I am getting in favour with adding another layer of user friendliness.


---

Comment by nthiery created at 2016-04-13 17:59:34

Replying to [comment:219 stumpc5]:
> I was afraid you'd ask that.

:-)

> in my eyes: too much. The elements are considered as permutations,
> words, and matrices at the same time (and there are even two types
> of words, in simples and in all reflections, and the simple words
> have wired properties in the non-real case), making options would
> pollute the code just soo much, I think, and would introduce so many
> possible mistakes. I prefer to have clean and fast code, that is
> hopefully getting better than chevie, eventually. Once that is
> achieved, I am getting in favour with adding another layer of user
> friendliness.

Fair enough: let's focus on getting things to work.

One thing though is that a lot of features are completely symmetric
(e.g. the reverse of a word is a word). The only spot where things
differ is when there is an explicit action. In my experience when
implementing representations of semigroups, it was often possible to
abstracted everything out by manipulating elements in the code as
functions whenever there is an action involved (sorry, I know, this is
a big vague).

Of course, a prerequisite for implementing this seamlessly is that
permutation groups themselves would allow for both left and right
actions.

Cheers,
                                        Nicolas


---

Comment by git created at 2016-04-13 18:47:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-04-13 19:05:58

Replying to [comment:219 stumpc5]:
> > Just FYI - you have reverted a python3 compatible change with this
> 
> I am sure there are reasons for that python3 convention, but I do prefer simple to read code. Anyway, I can also do the other if you prefer.

In python3, `print` becomes an actual function, so it needs the parentheses (which due to Python's handling of parentheses, `print(foo)` gets evaluated to `print foo`, but having a comma means `(foo, bar)` becomes a tuple). So to help make the doctests 2/3 compatible and to ease the eventual transition, I do prefer the way I had it or make it into a few examples and have a doctest which does check everything (without verbose).


---

Comment by git created at 2016-04-13 19:13:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-13 19:16:18

Replying to [comment:222 tscrim]:
> In python3, `print` becomes an actual function, so it needs the parentheses

I see, doesn't make it easier to read though...


---

Comment by git created at 2016-04-13 19:44:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-13 20:23:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-15 06:16:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-15 06:38:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-15 06:47:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-15 13:24:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-15 16:37:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-15 16:47:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-15 19:14:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-16 13:52:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-17 07:52:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-17 11:12:02

Changing status from needs_work to needs_review.


---

Comment by stumpc5 created at 2016-04-17 11:12:02

Changing keywords from "reflection group, days49, days 64.5" to "reflection group, days49, days64.5, days80".


---

Comment by git created at 2016-04-20 01:54:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-04-20 01:55:52

I've done a few little beautification things. If my changes are good, then we can set this to a positive review.


---

Comment by stumpc5 created at 2016-04-20 07:46:58

Thanks Travis, looking forward to have this to positive review and then merged!


---

Comment by tscrim created at 2016-04-20 14:59:55

FYI - Patchbots seem happy with it.


---

Comment by stumpc5 created at 2016-04-20 15:04:28

> FYI - Patchbots seem happy with it.

yes, but it didn't test the gap3 stuff again (I just asked Frederic how to get the patchbot to also test those), and also we still have two new startup modules (though the patchbot sees them without indicating it, see http://patchbot.sagemath.org/log/11187/Ubuntu/14.04/x86_64/3.13.0-85-generic/librae/2016-04-20%2010:00:02?plugin=plugins.startup_modules&diff=/log/0/Ubuntu/14.04/x86_64/3.13.0-85-generic/librae/2016-04-12%2018%3A16%3A59&ticket=11187&base=7.2.beta4)


---

Comment by stumpc5 created at 2016-04-20 15:16:34

To now run the doctests `# optional - gap3`, it seems I cannot use the patchbot anymore. Should I then do instead

```
sage-patchbot/sage -tp 4 --all --long --optional=gap3
```

myself?


---

Comment by tscrim created at 2016-04-20 15:19:27

I think that will be best. I was going to try this afternoon to see if I can avoid importing those categories at startup, but I might not be successful at it.


---

Comment by dimpase created at 2016-04-20 15:20:42

Replying to [comment:243 stumpc5]:
> To now run the doctests `# optional - gap3`, it seems I cannot use the patchbot anymore. Should I then do instead
> {{{
> sage-patchbot/sage -tp 4 --all --long --optional=gap3
> }}}
> myself?
I'd use `--optional=gap3,sage`


---

Comment by stumpc5 created at 2016-04-20 15:22:36

Replying to [comment:245 dimpase]:
> I'd use `--optional=gap3,sage` 

wow, you are silently reading these hundreds of comments to now help out -- impressive, thanks!


---

Comment by tscrim created at 2016-04-20 20:49:26

To remove `generalized_coxeter_groups.py` from the startup would either require making it a lazy import in `coxeter_groups.py` or making `coxeter_groups.py` not being imported at startup. I think the better strategy is to leave things how they are as an incentive to have `coxeter_groups.py` not be imported at startup. (Also it is only a net +1 imported at startup.)


---

Comment by git created at 2016-04-21 08:12:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-21 08:25:17

I also copied the other optional from the patchbot:

```
./sage -tp 6 --all --long --optional=ccache,gap3,mpir,patchbot,python2,sage
```

`@`Frederic, is that what I should do? Would it be hard (desirable?) to tell the patchbot (maybe in `config_file.json`) which optional tests should in general be run?


---

Comment by stumpc5 created at 2016-04-21 11:20:11

there are still a few doctest failures that need to be fixed:

```
stumpc5@findstat:~/web-findstat/sage-patchbot$ ./sage -tp 6 --long --optional=ccache,gap3,mpir,patchbot,python2,sage src/sage/combinat/root_system/coxeter_group.py
too many failed tests, not using stored timings
Running doctests with ID 2016-04-21-13-13-55-f420497c.
Git branch: t/11187/public/11187
Using --optional=ccache,gap3,mpir,patchbot,python2,sage
Doctesting 1 file using 6 threads.
sage -t --long src/sage/combinat/root_system/coxeter_group.py
**********************************************************************
File "src/sage/combinat/root_system/coxeter_group.py", line 205, in sage.combinat.root_system.coxeter_group.CoxeterGroupAsPermutationGroup.__init__
Failed example:
    TestSuite(W).run()             # optional - gap3
Expected nothing
Got:
    Failure in _test_well_generated:
    Traceback (most recent call last):
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/misc/sage_unittest.py", line 283, in run
        test_method(tester = tester)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/categories/finite_complex_reflection_groups.py", line 628, in _test_well_generated
        tester.assertEqual(self.number_of_simple_reflections(), self.rank())
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python/unittest/case.py", line 515, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python/unittest/case.py", line 508, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: 3 != 27
    ------------------------------------------------------------
    The following tests failed: _test_well_generated
**********************************************************************
File "src/sage/combinat/root_system/coxeter_group.py", line 231, in sage.combinat.root_system.coxeter_group.CoxeterGroupAsPermutationGroup._element_class
Failed example:
    W._element_class() is W.element_class                      # optional - gap3
Exception raised:
    Traceback (most recent call last):
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.root_system.coxeter_group.CoxeterGroupAsPermutationGroup._element_class[1]>", line 1, in <module>
        W._element_class() is W.element_class                      # optional - gap3
      File "sage/structure/parent.pyx", line 854, in sage.structure.parent.Parent.__getattr__ (/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/src/build/cythonized/sage/structure/parent.c:8083)
        attr = getattr_from_other_class(self, self._category.parent_class, name)
      File "sage/structure/misc.pyx", line 253, in sage.structure.misc.getattr_from_other_class (/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/src/build/cythonized/sage/structure/misc.c:1763)
        raise dummy_attribute_error
    AttributeError: 'CoxeterMatrixGroup_with_category' object has no attribute '_element_class'
**********************************************************************
2 items had failures:
   1 of   4 in sage.combinat.root_system.coxeter_group.CoxeterGroupAsPermutationGroup.__init__
   1 of   3 in sage.combinat.root_system.coxeter_group.CoxeterGroupAsPermutationGroup._element_class
    [54 tests, 2 failures, 10.25 s]
----------------------------------------------------------------------
sage -t --long src/sage/combinat/root_system/coxeter_group.py  # 2 doctests failed
```



---

Comment by stumpc5 created at 2016-04-21 11:21:23

And then, there are also a few in `gap3.py`, I am not sure if we have to treat them, but if anyone knows how to do it, please go ahead (this is also necessary to get the package to be optional rather than experimental...

```
stumpc5@findstat:~/web-findstat/sage-patchbot$ ./sage -tp 6 --long --optional=ccache,gap3,mpir,patchbot,python2,sage src/sage/interfaces/gap3.py
too many failed tests, not using stored timings
Running doctests with ID 2016-04-21-13-15-35-52e24ead.
Git branch: t/11187/public/11187
Using --optional=ccache,gap3,mpir,patchbot,python2,sage
Doctesting 1 file using 6 threads.
sage -t --long src/sage/interfaces/gap3.py
**********************************************************************
File "src/sage/interfaces/gap3.py", line 393, in sage.interfaces.gap3.Gap3._execute_line
Failed example:
    f([1,2,3])                                   #optional - gap3
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: Gap3 produced error output   
    Error, List Element: <position> must be a positive integer at
    return L[0] ... in
    ... called from
    main loop
    brk> quit;
    ...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.gap3.Gap3._execute_line[3]>", line 1, in <module>
        f([Integer(1),Integer(2),Integer(3)])                                   #optional - gap3
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 805, in __call__
        return getattr(P, self.name())(*args)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 607, in __call__
        return self._parent.function_call(self._name, list(args), kwds)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 921, in function_call
        res = self.eval(marker+cmd)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 573, in eval
        result = Expect.eval(self, input_line, **kwds)
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1239, in eval
        for L in code.split('\n') if L != ''])
      File "/srv/data/findstat.imp.fu-berlin.de/sage-patchbot/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 771, in _eval_line
        raise RuntimeError(message)
    RuntimeError: Gap3 produced error output
    Error, Function: <function> must be a function
    <BLANKLINE>
       executing __SAGE_LAST__:="__SAGE_LAST__";;x(sage0);;
**********************************************************************
File "src/sage/interfaces/gap3.py", line 440, in sage.interfaces.gap3.Gap3.help
Failed example:
    m                                        #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/interfaces/gap3.py", line 442, in sage.interfaces.gap3.Gap3.help
Failed example:
    m.Print()                                #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    "__SAGE_LAST__"
**********************************************************************
File "src/sage/interfaces/gap3.py", line 446, in sage.interfaces.gap3.Gap3.help
Failed example:
    m                                        #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/interfaces/gap3.py", line 448, in sage.interfaces.gap3.Gap3.help
Failed example:
    m.Print()                                #optional - gap3
Expected:
    [ [ 1, 2, 3 ], [ 4, 5, 6 ] ]
Got:
    "__SAGE_LAST__"
**********************************************************************
2 items had failures:
   1 of   5 in sage.interfaces.gap3.Gap3._execute_line
   4 of  10 in sage.interfaces.gap3.Gap3.help
    [108 tests, 5 failures, 7.01 s]
----------------------------------------------------------------------
sage -t --long src/sage/interfaces/gap3.py  # 5 doctests failed
----------------------------------------------------------------------
Total time for all tests: 15.7 seconds
    cpu time: 2.2 seconds
    cumulative wall time: 7.0 seconds
```

}}}


---

Comment by git created at 2016-04-21 13:40:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-04-21 13:43:42

not a good idea in general to use a bare except:

```
except:
```

rather find what exception it is supposed to catch


---

Comment by tscrim created at 2016-04-21 13:44:10

I fixed the errors in `combinat/root_system/coxeter_group.py` (to which, we should be able to do most (all) of that functionality without appealing to GAP3 and we should probably fold that into `(Irreducible)RealReflectionGroup` at some point). The latter errors are indicating issues with the interface, so I would just wait on those until we do #20393. Since `gap3` is an experimental package, we are not strictly required to have all `# optional - gap3` doctests pass.


---

Comment by git created at 2016-04-21 13:45:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-04-21 13:47:24

Replying to [comment:253 chapoton]:
> not a good idea in general to use a bare except:
> {{{
> except:
> }}}
> rather find what exception it is supposed to catch

Right, good catch. I'm going to try and find the precise error that gets raised, but I've pushed a hack fix for now.


---

Comment by git created at 2016-04-21 13:50:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-04-21 13:52:05

Replying to [comment:256 tscrim]:
> Replying to [comment:253 chapoton]:
> > not a good idea in general to use a bare except:
> > {{{
> > except:
> > }}}
> > rather find what exception it is supposed to catch
> 
> Right, good catch. I'm going to try and find the precise error that gets raised, but I've pushed a hack fix for now.

It only throws an `AttributeError`, and I have changed it to catch only that.


---

Comment by stumpc5 created at 2016-04-21 15:14:57

Thanks for the fixes, I am doing another round of doctests now...


---

Comment by stumpc5 created at 2016-04-21 18:17:16

okay, the only remaining failures are

```
sage -t --long src/sage/tests/cmdline.py  # 1 doctest failed
sage -t --long src/sage/repl/interpreter.py  # 1 doctest failed
sage -t --long src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t --long src/sage/interfaces/gap3.py  # 5 doctests failed
sage -t --long src/sage/repl/interface_magic.py  # 1 doctest failed
```

of which we are only responsible for `gap3.py`. I'd thus suggest to set this to positive review...


---

Comment by hivert created at 2016-04-21 18:23:31

Replying to [comment:260 stumpc5]:
> okay, the only remaining failures are
> {{{
> sage -t --long src/sage/tests/cmdline.py  # 1 doctest failed
> sage -t --long src/sage/repl/interpreter.py  # 1 doctest failed
> sage -t --long src/sage/parallel/map_reduce.py  # 1 doctest failed
> sage -t --long src/sage/interfaces/gap3.py  # 5 doctests failed
> sage -t --long src/sage/repl/interface_magic.py  # 1 doctest failed
> }}}
> of which we are only responsible for `gap3.py`. I'd thus suggest to set this to positive review...

Hi travis, 

Can you send me the log of the `map_reduce.py` error ? On what kinds of machine was it ? Is it reproducible ?

Florent


---

Comment by stumpc5 created at 2016-04-21 18:27:12

Replying to [comment:261 hivert]:
> Replying to [comment:260 stumpc5]:
> > okay, the only remaining failures are
> > {{{
> > sage -t --long src/sage/tests/cmdline.py  # 1 doctest failed
> > sage -t --long src/sage/repl/interpreter.py  # 1 doctest failed
> > sage -t --long src/sage/parallel/map_reduce.py  # 1 doctest failed
> > sage -t --long src/sage/interfaces/gap3.py  # 5 doctests failed
> > sage -t --long src/sage/repl/interface_magic.py  # 1 doctest failed
> > }}}
> > of which we are only responsible for `gap3.py`. I'd thus suggest to set this to positive review...
> 
> Hi travis,

...christian.

> Can you send me the log of the `map_reduce.py` error ? On what kinds of machine was it ? Is it reproducible ?

I didn't log the test, but I can restart it now. If it stays, I will give you the details.


---

Comment by stumpc5 created at 2016-04-21 19:05:18

all tests pass this time, sorry for not being able to get you the error...


---

Comment by hivert created at 2016-04-21 20:19:31

Replying to [comment:263 stumpc5]:
> all tests pass this time, sorry for not being able to get you the error...

Please let me know if it happen again.


---

Comment by chapoton created at 2016-04-22 06:55:16

Replying to [comment:264 hivert]:
> Replying to [comment:263 stumpc5]:
> > all tests pass this time, sorry for not being able to get you the error...
> 
> Please let me know if it happen again.

see there for one problem with map_reduce:

http://patchbot.sagemath.org/log/11187/Ubuntu/14.04/x86_64/3.16.0-60-generic/irma-atlas/2016-04-19%2009:27:11?short


---

Comment by git created at 2016-04-22 07:05:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2016-04-22 07:08:30

Should I actually at all still push stuff into this ticket, or should we rather get it to positive review and do everything else in individual tickets? (I have redone the doctest for `reflection_group_real.py` after this last change.)


---

Comment by chapoton created at 2016-04-22 07:17:43

Please *stop touching anything here* if you want this to be positive reviewed soon and not in 4 more years.


---

Comment by stumpc5 created at 2016-04-22 08:21:17

> if you want this to be positive reviewed soon and not in 4 more years.

That's a little harsh for my taste. Anyway, I agree that I should stop doing anything here, the list of improvements is at #20394.


---

Comment by chapoton created at 2016-04-22 08:23:54

sorry for that, I am not in a good mood..


---

Comment by stumpc5 created at 2016-04-22 08:29:36

I would rebase this to `beta5`, run the patchbot and do all doctests with the gap3 flag one more time.


---

Comment by git created at 2016-04-22 10:14:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-04-22 16:27:21

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2016-04-22 16:27:21

ok, guys, I think it is time. I am setting to `positive review` in the name of all authors/reviewers.


---

Comment by stumpc5 created at 2016-04-22 18:18:12

Great -- thanks to all of you for participating!


---

Comment by vbraun created at 2016-04-23 08:45:42

Resolution: fixed
