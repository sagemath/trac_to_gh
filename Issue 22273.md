# Issue 22273: Enhanced package uninstallation for Sage spkgs

archive/issues_022273.json:
```json
{
    "body": "Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).  Here are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):\n\n* For all installed packages, maintain lists of the files installed by those packages.  For this, something like #22509 is a prerequisite. This list could even go into the `$SAGE_LOCAL/var/lib/sage/installed/` files we already have.  Uninstalling a package would consist primarily of removing all files in this list.  It would also remove directories that are left empty after all files are removed.\n\n* Add support an optional `spkg-uninstall` script for any spkgs.  This can be used to perform any additional uninstallation steps.  For example, it is a place to remove files / data added specifically for Sage by `spkg-install` (e.g. symlinks) that are not installed by the package's `make install`.  This would be run *before* the full uninstall described in the previous bullet point (in case any files from the package are necessary to determine additional uninstall steps).  So this would be sort of like a pre-uninstall.\n\n* Add support for an optional `spkg-legacy-uninstall` script.  This would contain whatever commands the `spkg-install` scripts currently perform for uninstall.  This would only be run when the installed file list described in the first bullet point is unavailable (e.g. for backwards compatibility when upgrading to this new system for the first time).  This feature could maybe be removed entirely later, but would be good to add at first and keep around for a while.\n\nThe new process for upgrading / reinstalling a package could b (especially if more progress is made toward supporting #21726 in all spkgs):\n\n1. Build\n2. Install to temporary directory (#22509)\n3. Upon successful completion of 1. and 2., uninstall old package\n4. Install new package by copying from temp dir into `$SAGE_LOCAL`\n\nThis means a cleaner rollback from failed upgrades.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22510\n\n",
    "created_at": "2017-03-03T13:45:02Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "title": "Enhanced package uninstallation for Sage spkgs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22273",
    "user": "embray"
}
```
Currently spkg uninstallation is handled in an ad-hoc manner.  Many packages contain some rough uninstallation steps in their `spkg-install` scripts (to be run, for example, when upgrading/reinstalling a package).  But these are often imprecise and not thorough (though maybe still worth keeping where they already exist, as I will explain below).  Here are a few proposals for improving package uninstallation (which is useful even for required packages, such as in the case of upgrading them):

* For all installed packages, maintain lists of the files installed by those packages.  For this, something like #22509 is a prerequisite. This list could even go into the `$SAGE_LOCAL/var/lib/sage/installed/` files we already have.  Uninstalling a package would consist primarily of removing all files in this list.  It would also remove directories that are left empty after all files are removed.

* Add support an optional `spkg-uninstall` script for any spkgs.  This can be used to perform any additional uninstallation steps.  For example, it is a place to remove files / data added specifically for Sage by `spkg-install` (e.g. symlinks) that are not installed by the package's `make install`.  This would be run *before* the full uninstall described in the previous bullet point (in case any files from the package are necessary to determine additional uninstall steps).  So this would be sort of like a pre-uninstall.

* Add support for an optional `spkg-legacy-uninstall` script.  This would contain whatever commands the `spkg-install` scripts currently perform for uninstall.  This would only be run when the installed file list described in the first bullet point is unavailable (e.g. for backwards compatibility when upgrading to this new system for the first time).  This feature could maybe be removed entirely later, but would be good to add at first and keep around for a while.

The new process for upgrading / reinstalling a package could b (especially if more progress is made toward supporting #21726 in all spkgs):

1. Build
2. Install to temporary directory (#22509)
3. Upon successful completion of 1. and 2., uninstall old package
4. Install new package by copying from temp dir into `$SAGE_LOCAL`

This means a cleaner rollback from failed upgrades.

Issue created by migration from https://trac.sagemath.org/ticket/22510





---

archive/issue_comments_309639.json:
```json
{
    "body": "Adding initial work on the `sage-spkg-uninstall` script.\n\nI've already created `spkg-legacy-uninstall` scripts for most standard packages, but I'm still testing this mechanism.  These scripts are just created by taking any uninstall steps found in the `spkg-install` and splitting it out to a separate script.  Implementation of uninstall steps is of course very uneven across packages, and I'm not creating legacy-uninstall scripts for those packages that didn't already have uninstall steps--if it wasn't needed before it isn't needed now.  Many of the existing uninstall steps probably aren't needed either, but are (they reference specific tickets).  To be on the safe side I just took what already exists more or less at face value and didn't change any of the details.\n\nI haven't implemented support for the separate `spkg-uninstall` script yet as it hasn't been needed.  Though there are a handful of packages where it might be useful (for example maxima's `spkg-install` has a step that removes files from `$DOT_SAGE`).\n----\nLast 10 new commits:",
    "created_at": "2017-06-01T14:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309639",
    "user": "embray"
}
```

Adding initial work on the `sage-spkg-uninstall` script.

I've already created `spkg-legacy-uninstall` scripts for most standard packages, but I'm still testing this mechanism.  These scripts are just created by taking any uninstall steps found in the `spkg-install` and splitting it out to a separate script.  Implementation of uninstall steps is of course very uneven across packages, and I'm not creating legacy-uninstall scripts for those packages that didn't already have uninstall steps--if it wasn't needed before it isn't needed now.  Many of the existing uninstall steps probably aren't needed either, but are (they reference specific tickets).  To be on the safe side I just took what already exists more or less at face value and didn't change any of the details.

I haven't implemented support for the separate `spkg-uninstall` script yet as it hasn't been needed.  Though there are a handful of packages where it might be useful (for example maxima's `spkg-install` has a step that removes files from `$DOT_SAGE`).
----
Last 10 new commits:



---

archive/issue_comments_309640.json:
```json
{
    "body": "There is a *slight* possibility for a race condition here.  If two packages share a directory (other than some top level directory like `lib` that almost all packages use), but say something like `share/pari`, it's possible one package can be trying to install to that directory while the other is uninstalling from it and this could lead to errors.\n\nI haven't seen it come up in practice yet and it's probably pretty rare, but I might consider a mutex around the uninstall/install sections...",
    "created_at": "2017-06-01T16:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309640",
    "user": "embray"
}
```

There is a *slight* possibility for a race condition here.  If two packages share a directory (other than some top level directory like `lib` that almost all packages use), but say something like `share/pari`, it's possible one package can be trying to install to that directory while the other is uninstalling from it and this could lead to errors.

I haven't seen it come up in practice yet and it's probably pretty rare, but I might consider a mutex around the uninstall/install sections...



---

archive/issue_comments_309641.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-02T07:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309641",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_309642.json:
```json
{
    "body": "Out of curiosity I had a look to see if any packages are installing (and hence uninstalling) the same file, as I figured there might be some such cases and indeed there are.  I don't have an exhaustive list, because I have not installed every optional and experimental package.\n\nThe duplicate files fall into a few different categories:\n\n1. Most are due to packages that conflict with/replace another package.  Either because two packages provide the same functionality (e.g. openblas/atlas, mpir/gmp) or because one package is a stripped down version of another (e.g. boost_cropped/boost, pari_seadata_small/database_pari). \n\n   I think it might be good if we had explicit conflicts/replaces markers for some packages.  If a package conflicts with an installed package, it will not be installed unless forced.  If a package *replaces* another package, the package it replaces is explicitly uninstalled first.  In effect this already happens implicitly.  If I install pari_seadata_small, and then install database_pari, the latter will override the former.  But I think it would be better to do this explicitly.\n\n2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. \n\n   Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.\n\n3. `__init__.py` in Python namespace packages (e.g. backports_ssl_match_hostname/backports_shutil_get_terminal_size).  If both are installed and one clobbers the other that's fine, but if one is then uninstalled it should *not* remove the shared `__init__.py`.  I'll have to look at how Debian handles this.  It might be handled contextually--these files usually contain some boilerplate like `__path__ = extend_path(__path__, __name__)`.  But the boilerplate is not always spelled exactly the same, so it might be tricky to check for.  Maybe this just needs to be handled explicitly on a case-by-case basis.\n\n4. `bin/2to3`--just one special case of a script that is being installed by both Python 2 and Python 3.  This should of course be fixed in those packages.",
    "created_at": "2017-06-06T11:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309642",
    "user": "embray"
}
```

Out of curiosity I had a look to see if any packages are installing (and hence uninstalling) the same file, as I figured there might be some such cases and indeed there are.  I don't have an exhaustive list, because I have not installed every optional and experimental package.

The duplicate files fall into a few different categories:

1. Most are due to packages that conflict with/replace another package.  Either because two packages provide the same functionality (e.g. openblas/atlas, mpir/gmp) or because one package is a stripped down version of another (e.g. boost_cropped/boost, pari_seadata_small/database_pari). 

   I think it might be good if we had explicit conflicts/replaces markers for some packages.  If a package conflicts with an installed package, it will not be installed unless forced.  If a package *replaces* another package, the package it replaces is explicitly uninstalled first.  In effect this already happens implicitly.  If I install pari_seadata_small, and then install database_pari, the latter will override the former.  But I think it would be better to do this explicitly.

2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. 

   Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.

3. `__init__.py` in Python namespace packages (e.g. backports_ssl_match_hostname/backports_shutil_get_terminal_size).  If both are installed and one clobbers the other that's fine, but if one is then uninstalled it should *not* remove the shared `__init__.py`.  I'll have to look at how Debian handles this.  It might be handled contextually--these files usually contain some boilerplate like `__path__ = extend_path(__path__, __name__)`.  But the boilerplate is not always spelled exactly the same, so it might be tricky to check for.  Maybe this just needs to be handled explicitly on a case-by-case basis.

4. `bin/2to3`--just one special case of a script that is being installed by both Python 2 and Python 3.  This should of course be fixed in those packages.



---

archive/issue_comments_309643.json:
```json
{
    "body": "Replying to [comment:5 embray]:\n> 2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. \n\n Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.\n\nIn retrospect, I've come back around to thinking there should be a mechanism for `post-install/pre-uninstall` scripts.  For common examples like `share/info/dir` there can be a boilerplate that's linked to or something.\n\nAnother example I found where this would be useful, which granted is an experimental package, while be `compilerwrapper`.  This package conflicts with `gcc` unless the step of creating the wrapper scripts is done as a post-install step (and undone, if necessary, pre-uninstall).",
    "created_at": "2017-06-07T12:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309643",
    "user": "embray"
}
```

Replying to [comment:5 embray]:
> 2. `share/info/dir`--this is a file shared by many packages.  It is written/updated by the `install-info` program.  Of course, when installing into a temp root, there will be no existing `share/info/dir` file, and `install-info` will create it.  But then each package that installs it overrides each other. 

 Debian handles this file by stripping it from the installation, then calling `install-info` from a post-install (and pre-uninstall) script.  This is the sort of thing for which I anticipated possibly needing post-install/uninstall hooks.  That said, this is the only example like this I've encountered so far in Sage-the-dist.  So I might just make a special case for it for now, directly in `sage-spkg`, rather than placing the onus on each package that updates this file to do it correctly.

In retrospect, I've come back around to thinking there should be a mechanism for `post-install/pre-uninstall` scripts.  For common examples like `share/info/dir` there can be a boilerplate that's linked to or something.

Another example I found where this would be useful, which granted is an experimental package, while be `compilerwrapper`.  This package conflicts with `gcc` unless the step of creating the wrapper scripts is done as a post-install step (and undone, if necessary, pre-uninstall).



---

archive/issue_comments_309644.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-09-05T08:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309644",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_309645.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-05T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309645",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_309646.json:
```json
{
    "body": "Rebased on latest #22509; addressed issue of properly uninstalling the widgetsnbextension.  It's working pretty well now, after multiple around of install/uninstall and upgrading from old builds from before these changes.\n\nOf course #22509 should be reviewed and merged first as it lays most of the groundwork for this.  If diff'd against #22509 the changes in this ticket don't look as big.",
    "created_at": "2017-09-05T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309646",
    "user": "embray"
}
```

Rebased on latest #22509; addressed issue of properly uninstalling the widgetsnbextension.  It's working pretty well now, after multiple around of install/uninstall and upgrading from old builds from before these changes.

Of course #22509 should be reviewed and merged first as it lays most of the groundwork for this.  If diff'd against #22509 the changes in this ticket don't look as big.



---

archive/issue_comments_309647.json:
```json
{
    "body": "Needs to be rebased (but maybe not right now).",
    "created_at": "2017-11-28T10:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309647",
    "user": "jdemeyer"
}
```

Needs to be rebased (but maybe not right now).



---

archive/issue_comments_309648.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-28T10:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309648",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_309649.json:
```json
{
    "body": "Yes, there's more work needed to be done in breaking up #22509 into smaller bites before this ticket can even work again (at least for all packages--it will probably work for *most* packages with #24106).",
    "created_at": "2017-11-28T13:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309649",
    "user": "embray"
}
```

Yes, there's more work needed to be done in breaking up #22509 into smaller bites before this ticket can even work again (at least for all packages--it will probably work for *most* packages with #24106).



---

archive/issue_comments_309650.json:
```json
{
    "body": "I've had this on hold pending total completion of #22509 but it's still taking some time to get all the packages updated for DESTDIR support (see #24024).  However, for many packages this is already working, and the general infrastructure is in place.  So there's no reason not to move forward with the uninstallation work--the only problem is that packages that aren't installed with staged installation won't be properly uninstallable...yet.\n\nSimilarly, this work can be split up into a few smaller tickets, so I will move forward on that.",
    "created_at": "2018-04-05T14:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309650",
    "user": "embray"
}
```

I've had this on hold pending total completion of #22509 but it's still taking some time to get all the packages updated for DESTDIR support (see #24024).  However, for many packages this is already working, and the general infrastructure is in place.  So there's no reason not to move forward with the uninstallation work--the only problem is that packages that aren't installed with staged installation won't be properly uninstallable...yet.

Similarly, this work can be split up into a few smaller tickets, so I will move forward on that.



---

archive/issue_comments_309651.json:
```json
{
    "body": "Some new explanation of the work planned for this ticket, so I can break it up into multiple smaller chunks.",
    "created_at": "2018-04-05T15:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309651",
    "user": "embray"
}
```

Some new explanation of the work planned for this ticket, so I can break it up into multiple smaller chunks.



---

archive/issue_comments_309652.json:
```json
{
    "body": "Changing keywords from \"\" to \"uninstall\".",
    "created_at": "2018-04-10T17:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309652",
    "user": "embray"
}
```

Changing keywords from "" to "uninstall".



---

archive/issue_comments_309653.json:
```json
{
    "body": "I believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309653",
    "user": "embray"
}
```

I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_comments_309654.json:
```json
{
    "body": "Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309654",
    "user": "embray"
}
```

Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_comments_309655.json:
```json
{
    "body": "This is essentially done since #25139.  There are still some packages that should have `spkg-legacy-uninstall` scripts, but that is tracked in #25140.  Some packages still need to be ported to the new install system in order to be properly uninstallable, but that is being tracked in #24024.",
    "created_at": "2019-01-09T17:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309655",
    "user": "embray"
}
```

This is essentially done since #25139.  There are still some packages that should have `spkg-legacy-uninstall` scripts, but that is tracked in #25140.  Some packages still need to be ported to the new install system in order to be properly uninstallable, but that is being tracked in #24024.



---

archive/issue_comments_309656.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2019-01-09T17:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22273",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22273#issuecomment-309656",
    "user": "embray"
}
```

Resolution: worksforme
