# Issue 28147: py2: UnicodeDecodeError in doctest framework exception handling

Issue created by migration from https://trac.sagemath.org/ticket/28384

Original creator: embray

Original creation time: 2019-08-22 17:07:56

CC:  slelievre

I mentioned on #28116, that if an exception is raised in a doctest that happens to contain non-ASCII bytes in its message, there is a `UnicodeDecodeError` that occurs when trying to mix the text of the exception with `unicode` strings.

This can be reproduced by running:


```
LANG=fr_FR.UTF8 ./sage -bt src/sage/misc/cython.py
```


It happens to contain a test in which `gcc` is run, producing an error, which is wrapped in a `RuntimeError`.  If the French localization of gcc is available then the error message contains unicode (in this case utf-8 encoded) characters that do not get decoded.


---

Comment by embray created at 2019-08-22 17:11:05

Changing status from new to needs_review.


---

Comment by embray created at 2019-08-22 17:11:05

New commits:


---

Comment by embray created at 2019-08-22 17:11:47

I thought of adding a regression test, but given that it's a huge pain to write one for the doctest framework, and that it's Python 2 only, I hope to get away without it.


---

Comment by slelievre created at 2019-08-25 21:27:38

Changing keywords from "" to "unicode, locale".


---

Comment by slelievre created at 2019-08-25 21:27:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-09-02 21:40:43

Resolution: fixed
