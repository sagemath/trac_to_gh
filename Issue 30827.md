# Issue 30827: ci-cygwin*.yml: Adjust to new script packages _bootstrap, _prereq

Issue created by migration from https://trac.sagemath.org/ticket/31064

Original creator: mkoeppe

Original creation time: 2020-12-16 22:28:04

CC:  slabbe @kliem arojas embray slelievre

#29124 moved the files `build/pkgs/*.txt` to new locations but forgot to update the CI scripts for Cygwin, leading to failures like this (https://github.com/mkoeppe/sage/runs/1561097256):

```
sed: can't read ./build/pkgs/cygwin.txt: No such file or directory
sed: can't read ./build/pkgs/cygwin-bootstrap.txt: No such file or directory
Chocolatey v0.10.15
Package name is required. Please pass at least one package name to install.
Error: Process completed with exit code 1.
```

We fix it in this ticket.


---

Comment by mkoeppe created at 2020-12-17 05:55:57

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-12-17 05:55:57

Last 10 new commits:


---

Comment by mkoeppe created at 2020-12-17 18:44:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-18 00:28:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-18 00:28:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-18 06:50:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-12-18 18:15:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-18 21:14:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-19 03:12:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-19 03:34:53

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-19 17:53:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-19 17:53:47

Merged #31062 to fix a merge conflict


---

Comment by git created at 2020-12-19 18:10:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-19 18:25:06

Integrated the workflow changes from #29152


---

Comment by git created at 2020-12-19 19:46:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-20 18:29:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-20 18:31:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-12-21 18:42:06

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-12-22 01:27:43

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-12-22 07:45:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-29 19:10:51

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-12-29 19:19:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-08 18:28:31

Follow-up: #31211


---

Comment by @tobiasdiez created at 2021-01-09 12:46:08

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2021-01-09 12:46:08

A few remarks after skimming the changes:

> +        PACKAGES="python38 python38-pip"

I think it's better to install python using the python action, which brings a few goodies along: https://github.com/marketplace/actions/setup-python

> +        C:\tools\cygwin\bin\bash -l -x -c
Can you try to put this as `shell: C:\\tools\\cygwin\\bin\\bash -l -x -c {0}`? Would make the workflow easier to read.


And then my usual rant about using tox for this ;-). I know you are a big fan of using tox, and this is fine. But I still think it's not the best tool for github workflows. You are cramping a lot of things into one command, which makes it hard to see at which stake the workflow fails. I would propose to add helper scripts so that the workflow looks like
- Install dependencies:
  `choco install (build/bin/get-dependencies cygwin) --source cygwin`
- Build: 
  `build/bin/build-local` (with the script that is currently in tox: local, running bootstrap, configure and make)
- Test:
  `tox` (running all python tests)

The scripts can of course be reused in `tox.ini` still giving you the chance to locally use tox for this (although I find it counterintuitive that tox might change my system installation).


---

Comment by mkoeppe created at 2021-01-09 18:08:43

Replying to [comment:35 gh-tobiasdiez]:
> > +        C:\tools\cygwin\bin\bash -l -x -c
> Can you try to put this as `shell: C:\\tools\\cygwin\\bin\\bash -l -x -c {0}`? Would make the workflow easier to read.

I'm pretty sure I went through several iterations, including use of the shell directive, before settling on something that actually works


---

Comment by mkoeppe created at 2021-01-09 18:10:24

Replying to [comment:35 gh-tobiasdiez]:
> You are cramping a lot of things into one command, which makes it hard to see at which stake the workflow fails. 

This has not been a problem in my experience.


---

Comment by mkoeppe created at 2021-01-09 18:28:14

Let me explain again why I like to use `tox` to drive as much as possible in our CI. `tox` is a stable tool that has been under long term maintenance.  For context, before we (well, I) started to use GH Actions, we (well, individual developers many of whom no longer have sufficient time) used buildbot, Circle CI, Travis CI, [GitLab](GitLab) pipelines, ... Because our project is surfing on "free compute", the available technologies are changing faster than our project can sustain. Therefore it is important not to spend too much effort on development specific to the CI platform. 

The present ticket consolidates GH Actions-specific code for installing Cygwin to just become part of the tox workflow. It is not enough to just factor through scripts that "could" also be run by developers on a local Windows machine: We currently do not even have any developers who do that. By using tox inside the GH Actions workflow, we actually make sure that these scripts are usable (and remain usable when changes are made) outside of a GH Actions environment.


---

Comment by mkoeppe created at 2021-01-09 18:45:21

Replying to [comment:35 gh-tobiasdiez]:
> A few remarks after skimming the changes:
> 
> > +        PACKAGES="python38 python38-pip"
> 
> I think it's better to install python using the python action, which brings a few goodies along: https://github.com/marketplace/actions/setup-python

This is used in `choco install $PACKAGES --source cygwin` to install Cygwin and then these package in Cygwin.

I don't think the setup-python action can do that.


---

Comment by @tobiasdiez created at 2021-01-09 18:46:14

Thanks for the explanation. That's indeed something I understand and appreciate. My only problem is that managing the user system locally using tox is not very handy in my experience.

Here is an example I was experiencing the last few hours:
The tox run encountered problems in the docbuild stage. The reason was/is a that ecl under wsl 1 has some problems and I needed to play around installing/deinstalling it combined with other changes. However, I couldn't use the tox command that the GH workflow uses since this installs ecl again. What I ended up doing was to copy & paste the commands printed by the tox run on github. That worked to some extend, but was a rather awful experience.

I think it is good to have an easy way for developers to investigate problems in the GH workflow on their local system. And for this, it is in my opinion crucial that they can quickly recreate the state that is used. In my opinion a clearer separation in system-setup, build and test is helpful in this regard. If this can be done using tox, sure why not.


---

Comment by mkoeppe created at 2021-01-09 18:53:48

Replying to [comment:40 gh-tobiasdiez]:
> managing the user system locally using tox is not very handy in my experience.

Right. Managing the global installation of Cygwin is not the final form of this development. What I would actually prefer (but have not had time to figure out -- any help is welcome) is to have the `local-cygwin` tox environment make an isolated installation of Cygwin. (I do this for the `local-conda` and `local-homebrew` environments.)


---

Comment by mkoeppe created at 2021-01-09 19:02:39

Replying to [comment:40 gh-tobiasdiez]:
> Here is an example I was experiencing the last few hours:
> The tox run encountered problems in the docbuild stage. The reason was/is a that ecl under wsl 1 has some problems and I needed to play around installing/deinstalling it combined with other changes. However, I couldn't use the tox command that the GH workflow uses since this installs ecl again. What I ended up doing was to copy & paste the commands printed by the tox run on github. That worked to some extend, but was a rather awful experience.

OK, I have run into this situation too. I think what is needed for the `local-...` environments is:
 - an environment variable that can be passed to tox to disable system package installs
 - a target or environment variable to give an interactive shell.

I will open a ticket for this.


---

Comment by @tobiasdiez created at 2021-01-09 19:09:10

That would also work, thanks! Please also give a thought to my suggestion to extract some of the scripts in tox.ini to scripts that can be called independently of tox.


---

Comment by mkoeppe created at 2021-01-09 19:19:38

This is now #31216


---

Comment by mkoeppe created at 2021-01-09 19:20:10

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-01-10 00:02:44

Replying to [comment:43 gh-tobiasdiez]:
> Please also give a thought to my suggestion to extract some of the scripts in tox.ini to scripts that can be called independently of tox.

I see two directions of improvement here:
 - Moving stuff from `tox.ini` (for `tox -e local-...`) and `build/bin/write-dockerfile.sh` (for `tox -e docker-...`) into our top-level `Makefile`. For example, the complicated rule for the commands of `local` consists entirely of workarounds for things that should really be fixed/improved there.
 - Improving the system package information scripts such as `sage-print-system-package-command` further.
Meta-ticket #29146 keeps track of such improvements, let's continue there.

On the other hand, I would be reluctant to add more scripts that developers can use to set up their system automatically. As I have written elsewhere, I think the current approach of printing command lines to educate developers about how to do things on their system is better for the Sage community than trying to provide scripts that do things automagically.


---

Comment by @tobiasdiez created at 2021-01-10 12:38:27

Replying to [comment:46 mkoeppe]:
> I see two directions of improvement here: 
> Meta-ticket #29146 keeps track of such improvements, let's continue there.

Sounds good to me! Sorry for starting this somewhat off-topic discussion, but I very much appreciate your detailed explanations. It's always good to learn more about sage's inner workings ;-). I'll review this ticket as soon as the dependencies are merged (as it's hard to see right now which changes are coming from this ticket).


---

Comment by mkoeppe created at 2021-01-10 18:25:30

Great, and thanks for the discussion.


---

Comment by dimpase created at 2021-02-02 16:19:54

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-02-02 16:19:54

lgtm


---

Comment by mkoeppe created at 2021-02-02 17:37:05

Thank you!


---

Comment by git created at 2021-02-07 20:44:14

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-02-07 20:44:14

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-02-07 20:44:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-02-20 10:46:44

Resolution: fixed
