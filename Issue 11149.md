# Issue 11149: Make lcalc compatible with the new PARI

Issue created by migration from https://trac.sagemath.org/ticket/11321

Original creator: jdemeyer

Original creation time: 2011-05-10 15:28:26

Assignee: tbd

CC:  fbissey rishi

Keywords: lcalc spkg

PARI version 2.4.4 (see #11130) no longer has an `allocatemoremem()` function, which `lcalc` uses.  There is a function `allocatemem()` which can be used instead.


---

Comment by vbraun created at 2011-05-10 16:12:05

Looks good to me. Are you making a full lcalc spkg at one point?


---

Comment by jdemeyer created at 2011-05-11 07:18:57

Replying to [comment:1 vbraun]:
> Looks good to me. Are you making a full lcalc spkg at one point?

Yes, when I have time.


---

Comment by jdemeyer created at 2011-05-12 15:55:02

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-05-12 15:55:02

New spkg ready for review, needs to be built with the new PARI spkg.


---

Comment by jdemeyer created at 2011-05-12 18:10:21

_On 2011-05-12 18:56, Michael Rubinstein wrote:_

Thanks for the patch.

I should point out that I now have a google code page for lcalc:

http://code.google.com/p/l-calc/

(lcalc was taken, so I went with l-calc).

The page has my beta newer version of lcalc, L-1.3
However, Rishikesh's cython wrapper is still being updated for that, so it
won't work within sage with the current wrapper.

I should point out that Lcommandline_elliptic.cc has become part of
the underlying class library and moved to
Lelliptic.cc in version L-1.3

Mike


---

Comment by jdemeyer created at 2011-05-12 18:34:10

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-05-12 18:41:39

Changing status from needs_work to needs_review.


---

Comment by leif created at 2011-07-17 17:42:34

The patch to the Makefile still uses `-lmpir` instead of `-lgmp`. (We always build MPIR with GMP compatibility, as all other packages refer to GMP rather than MPIR.) And the receipt for `all` is still funny, but that's upstream...

I'd quote `$patch` to be on the safe side. Also, the patches are / have to be applied with `-p1` (from `lcalc-*/src/`) rather than `-p0`, which I don't mind, but Jeroen wanted to unify this across spkgs IIRC.


---

Comment by leif created at 2011-07-17 19:46:59

`spkg-install:`
 * The comment and a message regarding `SAGE_DEBUG` is not consistent. (`SAGE_DEBUG` has to be set to `yes` to enable debugging support, while anything else disables it, though not deleting any user-specified flags of course.) I'd always add `-g` anyway, since this doesn't have any measureable performance impact, only the object files will grow slightly.
 * `$CC` must not be quoted in the compiler test (if we support flags within `CC` rather than compiler paths containing spaces). Perhaps a matter of taste, but this should be consistent in Sage, and e.g. `distutils` uses the former variant, not to mention the way we use `$MAKE`. Same applies to `$CXX` and in principle `$SAGE_FORTRAN`, while the Fortran compiler test is useless there anyway.
 * Funny that Dave uses `test -e` for the Fortran library...
 * I wonder if error messages etc. should be redirected to `stderr` as we started to do in a couple of scripts. The disadvantage of doing so is that both streams occasionally get out of sync due to buffering, leading to potentially confusing output.
 * _Copy sage specific modifications_ should now of course read _Apply Sage ..._.
 * `$UNAME` should also be quoted (twice); `case ... in ...` would anyway be better.
 * I'm not sure if Cygwin needs _both_ a `.dll` _and_ a `.so` file (cf. #11547). Currently the `.dll` is copied to an `.so` in `$SAGE_LOCAL/lib/`. Unless it is statically linked, the stand-alone `lcalc` might also require the shared library in `$SAGE_LOCAL/bin/`.

`SPKG.txt`:
 * The _Upstream contact_ section should be moved up.
 * _Special Build Instructions_ should read _... Update/Build ..._.
 * The _Changelog_ heading is missing.
 * The _Dependencies_ section is completely missing.

Some files from `src/include/` can also be deleted (and I doubt we have to copy _all_ of them to `$SAGE_LOCAL/include/lcalc/`; `L*.h` and `mpfr_mul_d.h` -- included by `Lgmpfrxx.h` -- should suffice):

```sh
~/Sage/spkgs/lcalc-1.23.p7$ ls src/include/
cmdline.h                      Lfind_zeros.h
getopt.h                       Lgamma.h
Lcommandline_elliptic.h        Lglobals.h
Lcommandline_globals.h         Lgmpfrxx.h
Lcommandline.h                 Lgram.h
Lcommandline_misc.h            L.h
Lcommandline_numbertheory.h    Lint_complex.h
Lcommandline_twist.h           Lmisc.h
Lcommandline_values_zeros.h    Lnumberzeros.h
Lcommon.h                      Lnumeric.h
Lcommon_ld.h                   Lprint.h
Lcomplex.h                     Lriemannsiegel_blfi.h
Ldirichlet_series.h            Lriemannsiegel.h
Ldokchitser.h                  Lvalue.h
Lexplicit_formula.h            Lvalue.h.bak
Lexplicit_formula.h.swap.crap  mpfr_mul_d.h
```


I wonder if it's worth to run Lcalc's tests from an `spkg-check` file.

----

I'd _really_ appreciate having the changes to spkgs to be "finally" reviewed committed, especially if files get deleted, as is the case here. Also, IMHO commit messages are subject to review as well, no matter if some merge script would add a generic one in case it is missing.


---

Comment by jdemeyer created at 2011-07-19 09:49:50

New spkg, same location.  This cases care of _most_ of leif's comments.  I believe that the remainder of leif's comments should not prevent a positive review for this ticket.

About committing the changes: I find it very annoying to have to commit the changes everytime I make a change.  If you are happy with the spkg except for the committing of the changes, I can still commit the changes at that point.


---

Comment by leif created at 2011-07-19 16:58:52

Replying to [comment:14 jdemeyer]:
> About committing the changes: I find it very annoying to have to commit the changes everytime I make a change.

You don't have to, unless you publish them. ;-)

And you can always keep an uncommitted copy. I don't think it's much work to commit the changes if you have to create (perhaps upload) and announce a new spkg anyway.

> If you are happy with the spkg except for the committing of the changes, I can still commit the changes at that point.

Well, not committing the changes means _I_ have to commit your changes _in your name_ (with some random commit message) and repackage the spkg
 * in order to really test all changes (as files get deleted upon commit),
 * if I want to make some reviewer patch or a (follow-up) spkg based on yours.

The first point is of course more crucial, since not only lazy people might just install and test the spkg as is, such that potential errors will only show up much later. So not committing the changes is IMHO simply bad practice unless the spkg is really and explicitly said to be in some alpha state, most probably not ready and not intended to get merged as is (despite needing review / testing by others), which might be ok in rare cases.

There's a reason the term _commit_ is used rather than just e.g. _save changes_, the former implying some confidence or conviction by the author (or committer).


---

Comment by jdemeyer created at 2011-07-19 17:23:07

Replying to [comment:15 leif]:
> Well, not committing the changes means _I_ have to commit your changes _in your name_ (with some random commit message) and repackage the spkg in order to really test all changes (as files get deleted upon commit),

This is simply false.  Committing does not delete the files.  Committing only changes files inside `.hg`.


---

Comment by jdemeyer created at 2011-07-19 17:28:21

Replying to [comment:15 leif]:
> Well, not committing the changes means _I_ have to commit your changes _in your name_ (with some random commit message) and repackage the spkg if I want to make some reviewer patch or a (follow-up) spkg based on yours.

When doing this, committing the changes is probably the least of your worries.  Basing a new spkg on a not-yet-positively-reviewed skpg is not a very good idea anyway (see #11605 vs #11130).


---

Comment by leif created at 2011-07-19 18:11:49

From first glance:
 * (GNU) `patch` should be added to the dependencies section.
 * This is still in:

```sh
# If SAGE_DEBUG is set either unset (the default), or set to 'yes'
...
   echo >&2 "Code will be built with debugging information present. Set 'SAGE_DEBUG' to 'no' if you don't want that."
   # Actually anything othe than 'yes' will cause 
   # no debugging information to be added.
```

   (As mentioned, I also would add `-g` by default.)
 * There's neither a `patches/README.txt` nor a _Patches_ section in `SPKG.txt`.
 * `success 'install'` should perhaps be `success 'copying header files'`.

The rest looks ok.

I've btw. successfully tested the _previous p7_ with PARI 2.5.0.p0 and Sage 4.7.1.rc0 (Ubuntu 10.04 x86_64, GCC 4.5.1), both with our current MPIR and the newer MPIR 2.1.3 from #8664.


---

Comment by leif created at 2011-07-19 18:18:20

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 leif]:
> > Well, not committing the changes means _I_ have to commit your changes _in your name_ (with some random commit message) and repackage the spkg in order to really test all changes (as files get deleted upon commit),
> 
> This is simply false.  Committing does not delete the files.  Committing only changes files inside `.hg`.

`hg remove foo && hg commit` removes `foo` also from the working directory (unless you've already deleted it).


---

Comment by leif created at 2011-07-19 18:37:19

Replying to [comment:17 jdemeyer]:
> Replying to [comment:15 leif]:
> > Well, not committing the changes means _I_ have to commit your changes _in your name_ (with some random commit message) and repackage the spkg if I want to make some reviewer patch or a (follow-up) spkg based on yours.
> 
> When doing this, committing the changes is probably the least of your worries.

For a reviewer patch it is.

> Basing a new spkg on a not-yet-positively-reviewed skpg is not a very good idea anyway (see #11605 vs #11130).

#11604 was based on #11605 in the hope of (or giving it a chance) getting it into Sage 4.7.1, such that this bug gets fixed in reasonable time (in an official release). #11605 was likely to get merged into 4.7.1 because it is a critical bug, so not basing #11604 on the former would have simply been stupid.

#11130 has the milestone set to Sage 4.7.2 and currently (officially) still needs _work_. (Basing a new spkg on that of #11130 would not have been necessary since the new PARI version fixes the bug anyway. And even if it didn't, you claim above it would have been a bad idea to base a new one on a not yet positively reviewed, as is the case with PARI 2.5.0.p0, more precisely, it even "needs work" as I mentioned above.)


---

Comment by leif created at 2011-07-19 18:43:51

Replying to [comment:19 leif]:
> Replying to [comment:16 jdemeyer]:
> > This is simply false.  Committing does not delete the files.  Committing only changes files inside `.hg`.
> 
> `hg remove foo && hg commit` removes `foo` also from the working directory (unless you've already deleted it).

P.S.: If you don't want the file in the working directory to get deleted, use `hg forget ...`, which just removes it from the (current version in the) repository.


---

Comment by leif created at 2011-07-19 19:01:27

Ok, you're right. `hg remove foo` removes `foo` from the working directory immediately. (And if you recreate it and commit, that won't delete the new one either, which might be a different pitfall, though Mercurial will report it as an unknown file afterwards.)

Anyway, I believe `hg status` should simply report nothing, as one might miss the `?` among lots of other files marked `M`, `A` or `R`.


---

Comment by leif created at 2011-07-19 19:20:08

P.P.S.: `src/include/Lvalue.h.bak` is still present in the p8.


---

Comment by jdemeyer created at 2011-07-20 08:27:45

Replying to [comment:18 leif]:
>  * This is still in:
> {{{
> #!sh
> # If SAGE_DEBUG is set either unset (the default), or set to 'yes'
> ...
>    echo >&2 "Code will be built with debugging information present. Set 'SAGE_DEBUG' to 'no' if you don't want that."
>    # Actually anything othe than 'yes' will cause 
>    # no debugging information to be added.
> }}}
>    (As mentioned, I also would add `-g` by default.)

I do _not_ plan to change this here.  This is a functional change which is unrelated to the topic of this ticket so such a change does not belong here.


---

Comment by jdemeyer created at 2011-07-20 08:27:45

Changing status from needs_review to needs_work.


---

Comment by leif created at 2011-07-20 08:53:15

Replying to [comment:24 jdemeyer]:
> Replying to [comment:18 leif]:
> >  * This is still in:

```sh
# If SAGE_DEBUG is set either unset (the default), or set to 'yes'
...
    echo >&2 "Code will be built with debugging information present. Set 'SAGE_DEBUG' to 'no' if you don't want that."
    # Actually anything othe than 'yes' will cause 
    # no debugging information to be added.
```

> >    (As mentioned, I also would add `-g` by default.)
> 
> I do _not_ plan to change this here.  This is a functional change which is unrelated to the topic of this ticket so such a change does not belong here.

Just remove the _"is set either unset (the default), or"_, add _"or unset it"_ to _"Set 'SAGE_DEBUG' to 'no' ..."_, and `s/othe/other/`.

I don't mind not adding `-g` by default here (though it really makes sense, and other packages do this). Of course one can always put `-g` into the "global" `CFLAGS`, but you usually need debugging information when it's "too late". Getting better tracebacks from less experienced users is the main reason. One can always strip the symbols afterwards...

Also, other packages that disable optimization completely (`-O0`) if `SAGE_DEBUG=yes` should IMHO issue a warning when doing so.


---

Comment by jdemeyer created at 2011-07-26 10:24:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-07-26 10:24:35

New spkg (even with changes *committed*), same location: [http://boxen.math.washington.edu/home/jdemeyer/spkg/lcalc-1.23.p8.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/lcalc-1.23.p8.spkg)


---

Comment by leif created at 2011-07-29 14:38:58

This still applies:

Replying to [comment:18 leif]:
>  * (GNU) `patch` should be added to the dependencies section. 

>  * There's neither a `patches/README.txt` nor a _Patches_ section in `SPKG.txt`. 

>  * `success 'install'` should perhaps be `success 'copying header files'`. 



I'll perhaps add a reviewer patch for this, which of course doesn't affect that:

> P.P.S.: src/include/Lvalue.h.bak is still present in the p8.

But it's mentioned in the _Special Update/Build Instructions_, and only about 25 KB, so a minor issue.


---

Comment by leif created at 2011-07-29 15:46:50

Just found some more things:

 * `src/src/Makefile.old` can also be deleted.

 * The `Makefile` not only defines `CC` to `g++`, but also hardcodes `g++` when linking the shared library.


---

Comment by leif created at 2011-07-29 21:48:33

Any reason to not build (and run) the test suite (from an `spkg-check`, to be added)?

(Haven't tried, so it may be in an unusable state.)


---

Comment by leif created at 2011-07-29 22:05:58

SPKG patch. The only change with slight functional effect is the rearrangement of flags (CFLAGS et al.). Apply to Jeroen's p8 of July 26th.


---

Attachment

Replying to [comment:27 leif]:
> This still applies:
> 
> Replying to [comment:18 leif]: 

> >  * (GNU) `patch` should be added to the dependencies section. 

> >  * There's neither a `patches/README.txt` nor a _Patches_ section in `SPKG.txt`. 

> >  * `success 'install'` should perhaps be `success 'copying header files'`. 

> 
> 
> I'll perhaps add a reviewer patch for this.

Did so. I've also made further cosmetic changes to `spkg-install`, and also changed the order of flags in `CFLAGS` etc. such that user settings only get overridden when necessary.

I'll perhaps add a second reviewer patch fixing the hardcoded `g++` in Lcalc's Makefile, eventually along with a p9 spkg with the other two superfluous upstream files deleted.


---

Comment by leif created at 2011-07-30 04:48:36

SPKG patch. Makes this spkg also work with older PARI versions (prior to 2.4.4), adds some notes to SPKG.txt. Apply on top of "part_1".


---

Attachment

A second reviewer patch is up.

This does not yet fix the hardcoded `g++`, but changes the `pari-2.4.4.patch` such that it will work with older PARI versions, e.g. our current 2.4.3.alpha.* spkgs, as well, so we can in principle remove the dependency on #11130 (and merge it earlier).

I've also detailed the description of the patches in `SPKG.txt` and added a few more comments there.


---

Comment by jdemeyer created at 2011-08-02 09:57:13

Leif, will you post a new spkg with your changes added?


---

Comment by jdemeyer created at 2011-08-02 10:15:37

Replying to [comment:31 leif]:
> changes the `pari-2.4.4.patch` such that it will work with older PARI versions, e.g. our current 2.4.3.alpha.* spkgs, as well, so we can in principle remove the dependency on #11130 (and merge it earlier).

I'm not sure why we should do this.  There is no reason to merge this before #11130, so making it compatible with earlier versions just looks like more complication to me.


---

Comment by leif created at 2011-08-02 13:06:02

Replying to [comment:33 jdemeyer]:
> Replying to [comment:31 leif]:
> Leif, will you post a new spkg with your changes added?

Yes, later today.

> > changes the `pari-2.4.4.patch` such that it will work with older PARI versions, e.g. our current 2.4.3.alpha.* spkgs, as well, so we can in principle remove the dependency on #11130 (and merge it earlier).
> 
> I'm not sure why we should do this.  There is no reason to merge this before #11130, so making it compatible with earlier versions just looks like more complication to me.

Well, it's not too complicated it wasn't worth to remove the dependency, be it for testing / reviewing, or further work on the package. (The new spkg will have other advantages btw.)

But _that's_ IMHO something we should report upstream, as it won't be the last time Lcalc will have some PARI version-dependent parts... ;-)


---

Comment by leif created at 2011-08-03 04:04:37

Replying to [comment:34 leif]:
> Replying to [comment:33 jdemeyer]:
> > Replying to [comment:31 leif]:
> > Leif, will you post a new spkg with your changes added?
> 
> Yes, later today.

"Today" still applies, only it's Wednesday now... ;-)


---

Comment by jdemeyer created at 2011-09-22 19:56:16

Regardless of what `leif` said, I think my spkg still stands to be reviewed as-is.

leif, please do not clutter the `SPKG.txt` with a `patches` section since we have a `patches/README.txt`.  No reason to state the same information in more than one place.

Also, I dislike

```
echo >&2 "fooooooooooooooo" \
         "barrrrrrrrrrrrrr"
```

This is much harder to read than

```
echo >&2 "fooooooooooooooo" "barrrrrrrrrrrrrr"
```



---

Comment by jdemeyer created at 2011-09-22 19:57:13

As said before, I don't see much reason to support older versions of PARI.  The code would only get more complicated without much gain.


---

Comment by jdemeyer created at 2011-09-26 14:05:11

leif, do you still plan to make a follow-up spkg?  I don't mind making a new spkg myself based on your suggestions, I just need to know how to move ahead.


---

Comment by leif created at 2011-09-26 14:14:01

Replying to [comment:38 jdemeyer]:
> leif, do you still plan to make a follow-up spkg?  I don't mind making a new spkg myself based on your suggestions, I just need to know how to move ahead.

I'll look at it right *now*, as I don't exactly recall what the remaining changes were.

I still don't think we should break Lcalc compatibility with older PARI versions for no reason; the change to make it work with _both_ is quite trivial, and we should submit it upstream anyway.


---

Comment by leif created at 2011-09-26 14:55:19

Replying to [comment:39 leif]:
> I'll look at it right *now*, as I don't exactly recall what the remaining changes were.

Oh, it seems all my changes are already committed (July 30th btw.), unfortunately all in yet another p8. I'll try to separate them into a p9, then you can make whatever changes you want (e.g. reverting the removal of overlong lines), and provide a p10.

IMHO it's very convenient to have at least _an overview_ of the patches in `SPKG.txt`; IIRC, I spent quite some time recovering and documenting all the changes (mentioning just those that are still current) made over time on various tickets, of which at least some weren't referenced from `SPKG.txt` / the changelog, nor commit messages. (P.S.: Just looked into `patches/`, *there's no `README.patches` at all*.)


---

Comment by jdemeyer created at 2011-09-26 14:58:46

Replying to [comment:40 leif]:
> P.S.: Just looked into `patches/`, *there's no `README.patches` at all*.)

My apologies, I got confused with the pari spkg, which does have a `patches/README`.


---

Comment by leif created at 2011-09-26 15:00:15

Replying to [comment:31 leif]:
> [...] This does not yet fix the hardcoded `g++` [...]

This seems to still apply.

I guess this was what was delaying my spkg, i.e., why I didn't upload it.




> [...] eventually along with a p9 spkg with the other two superfluous upstream files deleted. [...]

Not sure about that, but I presumably already did; will check this.


---

Comment by leif created at 2011-09-26 15:01:59

Replying to [comment:41 jdemeyer]:
> Replying to [comment:40 leif]:
> > P.S.: Just looked into `patches/`, *there's no `README.patches` at all*.)
> 
> I got confused with the pari spkg, which does have a `patches/README`.

Me too... ;-)


---

Comment by jdemeyer created at 2011-10-06 09:36:04

New spkg containing most (not all) of leif's changes:
[http://boxen.math.washington.edu/home/jdemeyer/spkg/lcalc-1.23.p9.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/lcalc-1.23.p9.spkg)

Needs review.


---

Comment by jdemeyer created at 2011-10-06 09:36:04

Changing assignee from tbd to jdemeyer.


---

Attachment


---

Comment by was created at 2011-11-03 00:29:14

Changing status from needs_review to positive_review.


---

Comment by was created at 2011-11-03 00:29:14

I read through the diff to the spkg, and everything looked reasonable to me.  I applied the new pari stuff (#11330), then build this spkg, and it worked fine, and passed the full test suite (for Sage) after applying it.  

I tried one simple example "by hand" that actually *uses* lcalc, and was not pleased by what happened:

```
sage: E = EllipticCurve('37a')
sage: L = E.lseries()
sage: L.zeros(10)
  ***   Warning: new stack size = 1030944 (0.983 Mbytes).
[0.000000000, 5.00317001, 6.87039122, 8.01433081, 9.93309835, 10.7751382, 11.7573247, 12.9583864, 15.6038579, 16.1920174]
sage: L.zeros(10)
  ***   Warning: new stack size = 1030944 (0.983 Mbytes).
[0.000000000, 5.00317001, 6.87039122, 8.01433081, 9.93309835, 10.7751382, 11.7573247, 12.9583864, 15.6038579, 16.1920174]
```

Basically, every time you use lcalc to do anything with elliptic curve L-series, you get some mysterious warning (of course, really output from PARI).   However, the problem has been in released Sage for a long time, so it should be a separate ticket.    It was in sage-4.7.   That's now #11985.

So I say: positive review for this ticket.   Great work guys for cleaning up all kinds of little issues.  This is not an easy spkg, to put it mildly.


---

Comment by jdemeyer created at 2011-11-03 09:09:31

Thanks a lot for the review.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jdemeyer created at 2011-11-07 10:11:08

Resolution: fixed
