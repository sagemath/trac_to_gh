# Issue 26166: Compile Sage with Cython language_level=3str

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-10-04 15:18:26

CC:  embray chapoton

Cython 0.29 introduces a new `language_level=3str`, which is like `language_level=3` except that strings are still `str` instead of `unicode`. It would be good to use this language_level in Sage to force Python 3 syntax in all Cython files.


---

Comment by embray created at 2018-10-05 08:52:31

I am still confused by the whole language_level discussion.  I tried following the discussion on the cython mailing list but I gave up.

If I understand correctly (and this is probably just restating what you wrote in the ticket description) `language_level=3str` means it's using Python 3 syntax in all Cython files, with the _exception_ that unprefixed string literals are non-unicode strings on Python 2?


---

Comment by embray created at 2018-10-05 08:57:19

Regarding your deleted comment from the other ticket (maybe it was meant for this one) about non-ASCII strings in string literals (there was an example you used with μ).  If a docstring contains non-ASCII characters then I definitely think we should be explicitly using `u''`.


---

Comment by jdemeyer created at 2018-10-05 09:39:58

Replying to [comment:1 embray]:
> I am still confused by the whole language_level discussion.  I tried following the discussion on the cython mailing list but I gave up.
> 
> If I understand correctly (and this is probably just restating what you wrote in the ticket description) `language_level=3str` means it's using Python 3 syntax in all Cython files, with the _exception_ that unprefixed string literals are non-unicode strings on Python 2?

It's not _only_ about string literals. With `language_level=3`, the global `str` means `unicode`:

```
sage: cython('''
....: # cython: language_level=3
....: print(str)
....: ''')
<type 'unicode'>
```



---

Comment by jdemeyer created at 2018-10-05 09:43:11

Replying to [comment:2 embray]:
> If a docstring contains non-ASCII characters then I definitely think we should be explicitly using `u''`.

On the other hand, I do consider it a bug that Cython disallows `"μ"` with `language_level=3str` since that's valid in both Python 2 and Python 3 (with a different meaning though).


---

Comment by embray created at 2018-10-05 09:46:56

Replying to [comment:4 jdemeyer]:
> Replying to [comment:2 embray]:
> > If a docstring contains non-ASCII characters then I definitely think we should be explicitly using `u''`.
> 
> On the other hand, I do consider it a bug that Cython disallows `"μ"` with `language_level=3str` since that's valid in both Python 2 and Python 3 (with a different meaning though).

Sure it's technically _valid_ on Python 2, but not a great practice in most cases either, and with the different meaning there's a lot of potential for confusion around it so I think they're right to disallow it (even if it's unintentionally disallowed).  But I also see your point.


---

Comment by embray created at 2018-10-05 09:47:56

Replying to [comment:3 jdemeyer]:
> Replying to [comment:1 embray]:
> > I am still confused by the whole language_level discussion.  I tried following the discussion on the cython mailing list but I gave up.
> > 
> > If I understand correctly (and this is probably just restating what you wrote in the ticket description) `language_level=3str` means it's using Python 3 syntax in all Cython files, with the _exception_ that unprefixed string literals are non-unicode strings on Python 2?
> 
> It's not _only_ about string literals. With `language_level=3`, the global `str` means `unicode`:
> {{{
> sage: cython('''
> ....: # cython: language_level=3
> ....: print(str)
> ....: ''')
> <type 'unicode'>
> }}}

Ok, sure.  But "3str" means `str` is just always `str` right?  I guess I like that approach if so; it meshes well with the approach we've been already taking in Sage.


---

Comment by jdemeyer created at 2018-10-05 09:50:23

Replying to [comment:6 embray]:
> Ok, sure.  But "3str" means `str` is just always `str` right?

Yes, `str` is `str` and `"literals"` are also of type `str`.


---

Comment by git created at 2018-10-15 06:25:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-10-15 08:01:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-01-08 12:43:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-01-09 09:04:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by chapoton created at 2019-04-09 07:16:41

red branch


---

Comment by jdemeyer created at 2019-04-09 07:32:50

I know, but it's not ready for review anyway. This needs to wait for Cython 3.0


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by git created at 2019-08-26 21:14:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-08-26 21:24:19

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-09-13 07:53:22

red branch. I will review if you merge


---

Comment by chapoton created at 2019-09-13 07:57:09

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-09-18 10:31:07

I think this just needs a rebase + testing again.  This should be done as a dependency of #28000.


---

Comment by chapoton created at 2019-09-24 17:58:09

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-09-24 17:58:09

branch merged with 8.9.rc0
----
New commits:


---

Comment by chapoton created at 2019-09-25 07:53:47

Three patchbots seems to be happy, both with py2 and py3. Erik, would you approve a positive review ?


---

Comment by chapoton created at 2019-10-07 15:37:44

Could please somebody else approve ? Or should I set to positive all by myself ?


---

Comment by chapoton created at 2019-10-09 07:37:00

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-10-09 07:37:00

In the absence of any reaction whatsoever, I am setting to positive.


---

Comment by vbraun created at 2019-10-10 21:45:01

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-10-10 21:45:01

merge conflict...


---

Comment by embray created at 2019-10-11 07:51:46

Replying to [comment:27 chapoton]:
> Could please somebody else approve ? Or should I set to positive all by myself ?

Yeah why shouldn't you?  You reviewed the change and tested it, didn't you?  You don't need me to do that.


---

Comment by git created at 2019-10-13 09:44:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-13 09:45:30

conflicts resolved, setting back to positive


---

Comment by chapoton created at 2019-10-13 09:45:30

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2019-10-16 23:10:36

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-10-16 23:10:36

I'm getting the following failure on 32-bit:

```
File "src/sage/plot/plot3d/shapes.pyx", line 947, in sage.plot.plot3d.shapes.Sphere.get_grid
Failed example:
    Sphere(1).get_grid(100)
Expected:
    ([-10.0, ..., 0.0, ..., 10.0],
     [0.0, ..., 3.141592653589793, ..., 0.0])
Got:
    ([-10.0,
      -1.0471975511965976,
      -0.5235987755982988,
      6.1257422745431e-17,
      0.5235987755982989,
      1.0471975511965979,
      10.0],
     [0.0,
      1.0471975511965979,
      2.0943951023931957,
      3.141592653589793,
      4.188790204786391,
      5.235987755982989,
      0.0])
**********************************************************************
1 item had failures:
   1 of   3 in sage.plot.plot3d.shapes.Sphere.get_grid
    [162 tests, 1 failure, 43.51 s]
----------------------------------------------------------------------
sage -t --long src/sage/plot/plot3d/shapes.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by git created at 2019-10-17 18:30:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-17 18:31:30

ok, fixed


---

Comment by chapoton created at 2019-10-17 18:31:30

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2019-10-20 22:16:51

Resolution: fixed
