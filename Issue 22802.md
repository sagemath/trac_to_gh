# Issue 22802: make_scripts_relative in sage-location breaks ipython3

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2017-05-20 22:07:40

Keywords: python3

If `SAGE_PYTHON3=yes`, then when IPython is build, it adds a script `ipython3` to `local/bin`. This script carefully writes the path to Sage's python3 to its first line: `#!/path/to/.../python3`. Then the function `make_scripts_relative` in `sage-location` replaces this with `#!/usr/bin/env python`, which breaks it.



---

Comment by nbruin created at 2017-05-29 05:26:18

Hm, it really seems wrong to me that a routine that is supposed to make scripts relative also changes the kind of interpreter that's used. A reasonable default seems to me to stick with whatever was specified (including maintaining the options that are selected!!!)

If we need further tweaking of the "#!" line, I would think this needs to be tuned to the script in question, and thus not just be done for all files with a first line matching "#!.*/python".
----
New commits:


---

Comment by git created at 2017-05-29 12:59:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2017-05-29 15:06:19

This gets back to the question of what influence `SAGE_PYTHON3` should have at runtime. Would it be best if the `ipython` script used `python` and `ipython3` used `python3` in its `#!` line? Since they are essentially identical when written by IPython's installer, they end up being identical after running `make_scripts_relative`.

I guess the right fix is to trust the individual packages to do the right thing (write `python2` or `python3` to the `#!` line) and to patch them if they don't. So this branch makes sense to me.

There is also an issue about the scripts in `src/bin`, but that's probably for another ticket. Some of those import the Sage library, so it is important that they run the version of Python into which Sage has been imported. Back to the runtime issue for `SAGE_PYTHON3`.


---

Comment by jhpalmieri created at 2017-05-29 23:53:12

One doctest failure:

```
sage -t --long --warn-long 80.4 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 576, in sage.tests.cmdline.test_executable
Failed example:
    open(os.path.join(SAGE_LOCAL, "bin", "ipython")).readline()
Expected:
    '#!/usr/bin/env python\n'
Got:
    '#!/usr/bin/env python2\n'
**********************************************************************
```

Probably should be "python..." if we want the test to work for any version of Python.


---

Comment by git created at 2017-05-30 02:43:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by nbruin created at 2017-05-30 02:45:00

Good point.


---

Comment by nbruin created at 2017-05-30 02:45:00

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2017-05-30 21:01:34

Replying to [comment:4 jhpalmieri]:
> There is also an issue about the scripts in `src/bin`, but that's probably for another ticket. Some of those import the Sage library, so it is important that they run the version of Python into which Sage has been imported. Back to the runtime issue for `SAGE_PYTHON3`.

See #23106.


---

Comment by jhpalmieri created at 2017-05-31 14:19:10

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2017-05-31 14:19:10

Okay, this passes all tests.


---

Comment by jhpalmieri created at 2017-05-31 14:24:09

And fixes some old bugs, too. For example, `pip3` now runs with `python3` rather than `python` (= `python2`).


---

Comment by vbraun created at 2017-05-31 22:58:40

The whole "making scripts relative" and most of sage-location can be deleted fwiw; A normal build isn't relocatable and the binaries will rewrite the hardcoded paths on installation.


---

Comment by jhpalmieri created at 2017-05-31 23:24:39

Replying to [comment:12 vbraun]:
> The whole "making scripts relative" and most of sage-location can be deleted fwiw; A normal build isn't relocatable and the binaries will rewrite the hardcoded paths on installation.

Does this rewriting preserve python2 vs. python3?


---

Comment by vbraun created at 2017-06-01 06:52:34

Yes, the parent directory is rewritten but the part within `SAGE_ROOT` is kept.


---

Comment by jhpalmieri created at 2017-06-01 17:50:35

Replying to [comment:12 vbraun]:
> The whole "making scripts relative" and most of sage-location can be deleted fwiw.

Which parts of sage-location actually need to be kept? Just the parts dealing with the location file, to make sure the Sage installation hasn't been moved?


---

Comment by vbraun created at 2017-06-01 20:33:42

Yeah, the diagnostics is possibly worth keeping. Apart from that we don't need anything, I think.


---

Comment by jhpalmieri created at 2017-06-02 17:52:07

See #23129 for a clean-up of sage-location. We can merge that instead of this if it makes more sense. I'm going to mark this as "needs info" until we figure out which approach is better.


---

Comment by jhpalmieri created at 2017-06-02 17:52:07

Changing status from positive_review to needs_info.


---

Comment by chapoton created at 2017-08-06 09:07:34

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2017-08-06 09:07:34

So can we now close this as duplicate ?


---

Comment by jhpalmieri created at 2017-08-06 15:32:45

Yes, I think so. If #23129 has to be reverted, we can return to this.


---

Comment by jhpalmieri created at 2017-08-06 15:32:45

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-12-12 08:23:33

Resolution: wontfix
