# Issue 11562: sage_wraps should only read the sources of wrapped functions when needed.

archive/issues_011562.json:
```json
{
    "body": "Assignee: @jasongrout\n\nCC:  @kiwifb\n\nKeywords: sage_wraps sources gentoo\n\nAccording to private conversation with Francois Bissey, #9976 has introduced a problem that makes it impossible start sage-4.7.1 on Gentoo. That's pretty serious, and so this ticket is a blocker.\n\nThe problem is that sage_wraps reads the sources of to-be-wrapped functions and methods. The sources are stored as an attribute to the wrapper, which, on the one hand, is a waste of memory. Worse: Reading the Cython sources is impossible for sage-on-gentoo. Therefore, sage can't start.\n\nMy patch introduces some lightweight classes, that simply store a reference to an object (e.g., the to-be-wrapped function) and return the sources or source lines or the argument list *only when called*.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11734\n\n",
    "created_at": "2011-08-24T08:11:27Z",
    "labels": [
        "component: misc",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "sage_wraps should only read the sources of wrapped functions when needed.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11562",
    "user": "https://github.com/simon-king-jena"
}
```
Assignee: @jasongrout

CC:  @kiwifb

Keywords: sage_wraps sources gentoo

According to private conversation with Francois Bissey, #9976 has introduced a problem that makes it impossible start sage-4.7.1 on Gentoo. That's pretty serious, and so this ticket is a blocker.

The problem is that sage_wraps reads the sources of to-be-wrapped functions and methods. The sources are stored as an attribute to the wrapper, which, on the one hand, is a waste of memory. Worse: Reading the Cython sources is impossible for sage-on-gentoo. Therefore, sage can't start.

My patch introduces some lightweight classes, that simply store a reference to an object (e.g., the to-be-wrapped function) and return the sources or source lines or the argument list *only when called*.

Issue created by migration from https://trac.sagemath.org/ticket/11734





---

archive/issue_comments_129820.json:
```json
{
    "body": "sage_wraps should only read source files when needed.",
    "created_at": "2011-08-24T08:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129820",
    "user": "https://github.com/simon-king-jena"
}
```

sage_wraps should only read source files when needed.



---

archive/issue_comments_129821.json:
```json
{
    "body": "Attachment [trac11734_sage_wraps_no_sourceread.patch](tarball://root/attachments/some-uuid/ticket11734/trac11734_sage_wraps_no_sourceread.patch) by @simon-king-jena created at 2011-08-24 08:26:55\n\nThe patch should solve the problem with prematurely reading sources on gentoo. However, I can not test it, myself. Francois, can you verify it?\n\n**__Benefits__**\n\n__Startuptime__\n\nThe startuptime did slightly improve (but perhaps that is not significant):\n\nWithout patch\n\n```\n$ ./sage -startuptime\n## Tree\nsage.all: 1.132 (None)\n...\n```\nWith patch\n\n```\n$ ./sage -startuptime\n## Tree\nsage.all: 1.045 (None)\n```\n\n__Memory__\n\nThe memory consumption improved as well:\n\nWithout patch:\n\n```\nsage: get_memory_usage()\n861.2890625\n```\nWith patch:\n\n```\nsage: get_memory_usage()\n861.234375\n```\n\n__Bugfix__\n\nNot reading the sources when a function is wrapped has an additional benefit: If one interactively defines a lambda function and wraps it, then the source is not available. Hence, the following example (that is a new doctest) used to fail:\n\n```\n        sage: def square(f):\n        ...     @sage_wraps(f)\n        ...     def new_f(x):\n        ...         return f(x)*f(x)\n        ...     return new_f\n        ... \n        sage: f = lambda x:x^2\n        sage: g = square(f)\n        sage: g(3)\n        81\n```\nWithout the patch, the last line fails with a mysterious attribute error (the user would certainly have not easily been able to track the problem down).",
    "created_at": "2011-08-24T08:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129821",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11734_sage_wraps_no_sourceread.patch](tarball://root/attachments/some-uuid/ticket11734/trac11734_sage_wraps_no_sourceread.patch) by @simon-king-jena created at 2011-08-24 08:26:55

The patch should solve the problem with prematurely reading sources on gentoo. However, I can not test it, myself. Francois, can you verify it?

**__Benefits__**

__Startuptime__

The startuptime did slightly improve (but perhaps that is not significant):

Without patch

```
$ ./sage -startuptime
## Tree
sage.all: 1.132 (None)
...
```
With patch

```
$ ./sage -startuptime
## Tree
sage.all: 1.045 (None)
```

__Memory__

The memory consumption improved as well:

Without patch:

```
sage: get_memory_usage()
861.2890625
```
With patch:

```
sage: get_memory_usage()
861.234375
```

__Bugfix__

Not reading the sources when a function is wrapped has an additional benefit: If one interactively defines a lambda function and wraps it, then the source is not available. Hence, the following example (that is a new doctest) used to fail:

```
        sage: def square(f):
        ...     @sage_wraps(f)
        ...     def new_f(x):
        ...         return f(x)*f(x)
        ...     return new_f
        ... 
        sage: f = lambda x:x^2
        sage: g = square(f)
        sage: g(3)
        81
```
Without the patch, the last line fails with a mysterious attribute error (the user would certainly have not easily been able to track the problem down).



---

archive/issue_comments_129822.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-24T08:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129822",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_129823.json:
```json
{
    "body": "Changing keywords from \"sage_wraps sources gentoo\" to \"sage_wraps sources gentoo startuptime\".",
    "created_at": "2011-08-24T08:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129823",
    "user": "https://github.com/simon-king-jena"
}
```

Changing keywords from "sage_wraps sources gentoo" to "sage_wraps sources gentoo startuptime".



---

archive/issue_comments_129824.json:
```json
{
    "body": "I do not fully understand your patch. How does it differ from simply taking out the call to sage_getargspec and moving it into a lambda? (see my attached patch)\n\nBtw. On my install of sage-4.7.2alpha2 the doctest described in *Bugfix* does not fail.",
    "created_at": "2011-08-24T17:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129824",
    "user": "https://github.com/saraedum"
}
```

I do not fully understand your patch. How does it differ from simply taking out the call to sage_getargspec and moving it into a lambda? (see my attached patch)

Btw. On my install of sage-4.7.2alpha2 the doctest described in *Bugfix* does not fail.



---

archive/issue_comments_129825.json:
```json
{
    "body": "Replying to [comment:3 saraedum]:\n> I do not fully understand your patch. How does it differ from simply taking out the call to sage_getargspec and moving it into a lambda? (see my attached patch)\n\n\nIf I remember correctly, I once tried that approach. The line `argspec = sage_getargspec(wrapped)` was introduced for a reason (something went wrong), but I can't remember what it was.\n\nDid you run full tests with your patch?\n\n> Btw. On my install of sage-4.7.2alpha2 the doctest described in *Bugfix* does not fail.\n\n\nReally? Strange. It failed for me both with sage-4.7.2.alpha1 and with sage-4.6.2.",
    "created_at": "2011-08-24T17:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129825",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:3 saraedum]:
> I do not fully understand your patch. How does it differ from simply taking out the call to sage_getargspec and moving it into a lambda? (see my attached patch)


If I remember correctly, I once tried that approach. The line `argspec = sage_getargspec(wrapped)` was introduced for a reason (something went wrong), but I can't remember what it was.

Did you run full tests with your patch?

> Btw. On my install of sage-4.7.2alpha2 the doctest described in *Bugfix* does not fail.


Really? Strange. It failed for me both with sage-4.7.2.alpha1 and with sage-4.6.2.



---

archive/issue_comments_129826.json:
```json
{
    "body": "The tests in sage/misc pass with your patch, and the example from my post above (the \"bugfix\") works as well.\n\nIf all tests pass, then you patch should be preferred.\n\nIt turned out that I am not to blame for the \"argspec = sage_getargspec(wrapped)\". The first author of #9976 had introduced an alternative approach to provide the argument list when building the documentation -- and I think what we have here is an artefact of that approach.\n\nSince it was about documentation: Could you please build the documentation with your patch (I will only be able to do so tomorrow) and look whether the list of arguments of functions and methods created with `@`sage_wraps are correct in the reference manual? See, for example, the interreduced_basis method of multivariate polynomial ideals.",
    "created_at": "2011-08-24T17:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129826",
    "user": "https://github.com/simon-king-jena"
}
```

The tests in sage/misc pass with your patch, and the example from my post above (the "bugfix") works as well.

If all tests pass, then you patch should be preferred.

It turned out that I am not to blame for the "argspec = sage_getargspec(wrapped)". The first author of #9976 had introduced an alternative approach to provide the argument list when building the documentation -- and I think what we have here is an artefact of that approach.

Since it was about documentation: Could you please build the documentation with your patch (I will only be able to do so tomorrow) and look whether the list of arguments of functions and methods created with `@`sage_wraps are correct in the reference manual? See, for example, the interreduced_basis method of multivariate polynomial ideals.



---

archive/issue_comments_129827.json:
```json
{
    "body": "PS: Even though the example from my previous post does not fail on your machine (for reasons that I don't understand), it did fail for me. Hence, I think it would make sense to include that example into your patch (you can of course simply copy the example from my patch).",
    "created_at": "2011-08-24T18:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129827",
    "user": "https://github.com/simon-king-jena"
}
```

PS: Even though the example from my previous post does not fail on your machine (for reasons that I don't understand), it did fail for me. Hence, I think it would make sense to include that example into your patch (you can of course simply copy the example from my patch).



---

archive/issue_comments_129828.json:
```json
{
    "body": "I ran the doctests without long and they passed. Let me try to build the reference manual.",
    "created_at": "2011-08-24T18:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129828",
    "user": "https://github.com/saraedum"
}
```

I ran the doctests without long and they passed. Let me try to build the reference manual.



---

archive/issue_comments_129829.json:
```json
{
    "body": "The reference manual seems ok. For example I get *complete_primary_decomposition(algorithm='sy')* which is a method with the *    `@`libsingular_standard_options* decorator.",
    "created_at": "2011-08-24T19:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129829",
    "user": "https://github.com/saraedum"
}
```

The reference manual seems ok. For example I get *complete_primary_decomposition(algorithm='sy')* which is a method with the *    `@`libsingular_standard_options* decorator.



---

archive/issue_comments_129830.json:
```json
{
    "body": "I can confirm that the doc tests pass. I can also confirm that your patch provides a similar (small) positive side effect (comparable to what I stated on my patch) on startuptime and memory consumption.\n\nPlease add the above \"bugfix\" example to your patch. In the author field, please replace my name by yours.",
    "created_at": "2011-08-24T19:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129830",
    "user": "https://github.com/simon-king-jena"
}
```

I can confirm that the doc tests pass. I can also confirm that your patch provides a similar (small) positive side effect (comparable to what I stated on my patch) on startuptime and memory consumption.

Please add the above "bugfix" example to your patch. In the author field, please replace my name by yours.



---

archive/issue_comments_129831.json:
```json
{
    "body": "Changing keywords from \"sage_wraps sources gentoo startuptime\" to \"sage_wraps sources gentoo startuptime sd32\".",
    "created_at": "2011-08-24T23:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129831",
    "user": "https://github.com/williamstein"
}
```

Changing keywords from "sage_wraps sources gentoo startuptime" to "sage_wraps sources gentoo startuptime sd32".



---

archive/issue_comments_129832.json:
```json
{
    "body": "Hi, I had to take a bit more rest than I expected - exhaustion is bad for you :)\n\nI have just tested this patch in 4.7.2.alpha2 and it works. I think Simon has not made clear the fact that my original report was about the sage on gentoo distribution. It still meant that sage was looking at some cython files before starting up, which can't be good for the startup time.",
    "created_at": "2011-08-25T01:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129832",
    "user": "https://github.com/kiwifb"
}
```

Hi, I had to take a bit more rest than I expected - exhaustion is bad for you :)

I have just tested this patch in 4.7.2.alpha2 and it works. I think Simon has not made clear the fact that my original report was about the sage on gentoo distribution. It still meant that sage was looking at some cython files before starting up, which can't be good for the startup time.



---

archive/issue_comments_129833.json:
```json
{
    "body": "Replying to [comment:11 fbissey]:\n> I have just tested this patch in 4.7.2.alpha2 and it works.\n\n\nYou mean, it would definitely fix the Gentoo problem?\n\n> I think Simon has not made clear the fact that my original report was about the sage on gentoo distribution.\n\n\nThe ticket description states \"introduced a problem that makes it impossible start sage-4.7.1 on Gentoo.\" I thought that it *is* clear enough.\n\n> It still meant that sage was looking at some cython files before starting up, which can't be good for the startup time. \n\n\nYep. Actually I have tested (by inserting print statements in the functions that read the sources for auto-inspection) that no file is read at startup, with the patch.",
    "created_at": "2011-08-25T06:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129833",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:11 fbissey]:
> I have just tested this patch in 4.7.2.alpha2 and it works.


You mean, it would definitely fix the Gentoo problem?

> I think Simon has not made clear the fact that my original report was about the sage on gentoo distribution.


The ticket description states "introduced a problem that makes it impossible start sage-4.7.1 on Gentoo." I thought that it *is* clear enough.

> It still meant that sage was looking at some cython files before starting up, which can't be good for the startup time. 


Yep. Actually I have tested (by inserting print statements in the functions that read the sources for auto-inspection) that no file is read at startup, with the patch.



---

archive/issue_comments_129834.json:
```json
{
    "body": "Concerning documentation: It looks very nice!\n\nJust for testing, I had inserted a function with a complicated argument list, and put it under the `@`singular_standard_options decorator:\n\n```\n@singular_standard_options\ndef MyTestFunc(bla, blubb, bar={'bla':{1:2}}, foo=None, **kwds):\n    \"\"\"\n    This is just a test\n    \"\"\"\n    return\n```\nIt is shown in the reference manual exactly as it should.\n\nIn addition, the doc tests pass, the startup time seems to slightly improve (perhaps not significantly), and the memory consumption decreases a little.\n\nI hope I understood correctly that it will fix the problem on gentoo.\n\nIn general, if a bug is fixed, it should be demonstrated by a new doc test. The example that I gave above *does* fail (at least for me) without the patch. So, I think it should be included. If nobody beats me to it, I'd provide that example in a referee patch.\n\nAlso I don't know the real name of saraedum. So, please insert the name in the Author field.\n\nApart from that, it is a positive review.",
    "created_at": "2011-08-25T07:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129834",
    "user": "https://github.com/simon-king-jena"
}
```

Concerning documentation: It looks very nice!

Just for testing, I had inserted a function with a complicated argument list, and put it under the `@`singular_standard_options decorator:

```
@singular_standard_options
def MyTestFunc(bla, blubb, bar={'bla':{1:2}}, foo=None, **kwds):
    """
    This is just a test
    """
    return
```
It is shown in the reference manual exactly as it should.

In addition, the doc tests pass, the startup time seems to slightly improve (perhaps not significantly), and the memory consumption decreases a little.

I hope I understood correctly that it will fix the problem on gentoo.

In general, if a bug is fixed, it should be demonstrated by a new doc test. The example that I gave above *does* fail (at least for me) without the patch. So, I think it should be included. If nobody beats me to it, I'd provide that example in a referee patch.

Also I don't know the real name of saraedum. So, please insert the name in the Author field.

Apart from that, it is a positive review.



---

archive/issue_comments_129835.json:
```json
{
    "body": "I'm not sure if I misunderstand what you mean to say with 'significantly' but the average startuptime does actually improve with that patch. (I would provide some data but can't reach the machine where that data is stored right now)",
    "created_at": "2011-08-25T07:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129835",
    "user": "https://github.com/saraedum"
}
```

I'm not sure if I misunderstand what you mean to say with 'significantly' but the average startuptime does actually improve with that patch. (I would provide some data but can't reach the machine where that data is stored right now)



---

archive/issue_comments_129836.json:
```json
{
    "body": "Replying to [comment:15 saraedum]:\n> I'm not sure if I misunderstand what you mean to say with 'significantly'\n\n\nThere is the \"sage -startuptime\" script. It prints a lot of data, but the time for importing sage.all is most important, as much as I understood.\n\nWithout the patch, I get with sage-4.7.2.alpha2:\n\n```\n## Slowest (including children)\n1.242 sage.all (None)\n```\nWith the patch, I get:\n## Slowest (including children)\n1.133 sage.all (None)\n}}}\n\nHowever, these times are a little flaky. So, I don't know if we can call it significant if the difference is 10%.\n\nConcerning the additional test: It is a bit strange. It turned out that it *does* fail when I execute it on command line, but it does *not* fail (even without your patch) when it is a doc test. Apparently, in a doc test, Sage is able to find the function definition, which is impossible on the command line.",
    "created_at": "2011-08-25T07:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129836",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:15 saraedum]:
> I'm not sure if I misunderstand what you mean to say with 'significantly'


There is the "sage -startuptime" script. It prints a lot of data, but the time for importing sage.all is most important, as much as I understood.

Without the patch, I get with sage-4.7.2.alpha2:

```
## Slowest (including children)
1.242 sage.all (None)
```
With the patch, I get:
## Slowest (including children)
1.133 sage.all (None)
}}}

However, these times are a little flaky. So, I don't know if we can call it significant if the difference is 10%.

Concerning the additional test: It is a bit strange. It turned out that it *does* fail when I execute it on command line, but it does *not* fail (even without your patch) when it is a doc test. Apparently, in a doc test, Sage is able to find the function definition, which is impossible on the command line.



---

archive/issue_comments_129837.json:
```json
{
    "body": "Anyway, I would leave the doctest in; probably we should add a comment, describing this difference.\nBtw. I use dumbbench and a *silenced* version of startuptime to make sure that I'm not only seeing random speedups.\n\nThe speedup is actually a little bit mysterious. It occurs once you remove a few *sage_wraps* decorators. Apparently python's *inspect.ArgSpec* does something smart once it gets called very often (to speed up things?) which results in a slowdown in our case.",
    "created_at": "2011-08-25T07:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129837",
    "user": "https://github.com/saraedum"
}
```

Anyway, I would leave the doctest in; probably we should add a comment, describing this difference.
Btw. I use dumbbench and a *silenced* version of startuptime to make sure that I'm not only seeing random speedups.

The speedup is actually a little bit mysterious. It occurs once you remove a few *sage_wraps* decorators. Apparently python's *inspect.ArgSpec* does something smart once it gets called very often (to speed up things?) which results in a slowdown in our case.



---

archive/issue_comments_129838.json:
```json
{
    "body": "Replying to [comment:17 saraedum]:\n> Anyway, I would leave the doctest in; probably we should add a comment, describing this difference.\n\n\nOK, please do!\n\n> The speedup is actually a little bit mysterious. It occurs once you remove a few *sage_wraps* decorators. Apparently python's *inspect.ArgSpec* does something smart once it gets called very often (to speed up things?) which results in a slowdown in our case.\n\n\nYou removed a few sage_wraps for a test? \n\nActually I find the speedup not mysterious. The 10% are just with your patch, i.e., I did not additionally remove sage_wraps. And the reason for the speedup is clear: Python's `inspect.getargspec` is insufficient for Sage. It can not deal with Cython functions, and of course it can not understand the special wrappers in Sage:\n\n```\nsage: import inspect\nsage: cython('cpdef f(a,b,c=None): pass')\nsage: inspect.getargspec(f)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/mnt/local/king/SAGE/sage-4.7.2.alpha2/devel/sage-main/<ipython console> in <module>()\n\n/mnt/local/king/SAGE/sage-4.7.2.alpha2/local/lib/python/inspect.pyc in getargspec(func)\n    801         func = func.im_func\n    802     if not isfunction(func):\n--> 803         raise TypeError('arg is not a Python function')\n    804     args, varargs, varkw = getargs(func.func_code)\n    805     return ArgSpec(args, varargs, varkw, func.func_defaults)\n\nTypeError: arg is not a Python function\n```\nand similarly\n\n```\nsage: P.<x,y,z> = QQ[]\nsage: I = P*[x,y]\nsage: inspect.getargspec(I.interreduced_basis)\nArgSpec(args=[], varargs='args', keywords='kwds', defaults=None)\nsage: inspect.getargspec(I.groebner_basis)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n\n/mnt/local/king/SAGE/sage-4.7.2.alpha2/devel/sage-main/<ipython console> in <module>()\n\n/mnt/local/king/SAGE/sage-4.7.2.alpha2/local/lib/python/inspect.pyc in getargspec(func)\n    801         func = func.im_func\n    802     if not isfunction(func):\n--> 803         raise TypeError('arg is not a Python function')\n    804     args, varargs, varkw = getargs(func.func_code)\n    805     return ArgSpec(args, varargs, varkw, func.func_defaults)\n\nTypeError: arg is not a Python function\n```\nwhile the Sage autoinspection finds\n\n```\nsage: from sage.misc.sageinspect import sage_getargspec\nsage: sage_getargspec(I.interreduced_basis)\nArgSpec(args=['self'], varargs=None, keywords=None, defaults=None)\nsage: sage_getargspec(I.groebner_basis)\nArgSpec(args=['self', 'algorithm', 'deg_bound', 'mult_bound', 'prot'], varargs='args', keywords='kwds', defaults=('', None, None, False))\n```\n\nIn the most difficult cases, `sage_getargspec` actually needs to read the source (using `sage_getsourcelines`) and analyse the function definition. That's why inspect.getargspec is faster (yet a lot less powerful) than sage.misc.sageinspect.sage_getargspec.",
    "created_at": "2011-08-25T07:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129838",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:17 saraedum]:
> Anyway, I would leave the doctest in; probably we should add a comment, describing this difference.


OK, please do!

> The speedup is actually a little bit mysterious. It occurs once you remove a few *sage_wraps* decorators. Apparently python's *inspect.ArgSpec* does something smart once it gets called very often (to speed up things?) which results in a slowdown in our case.


You removed a few sage_wraps for a test? 

Actually I find the speedup not mysterious. The 10% are just with your patch, i.e., I did not additionally remove sage_wraps. And the reason for the speedup is clear: Python's `inspect.getargspec` is insufficient for Sage. It can not deal with Cython functions, and of course it can not understand the special wrappers in Sage:

```
sage: import inspect
sage: cython('cpdef f(a,b,c=None): pass')
sage: inspect.getargspec(f)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/mnt/local/king/SAGE/sage-4.7.2.alpha2/devel/sage-main/<ipython console> in <module>()

/mnt/local/king/SAGE/sage-4.7.2.alpha2/local/lib/python/inspect.pyc in getargspec(func)
    801         func = func.im_func
    802     if not isfunction(func):
--> 803         raise TypeError('arg is not a Python function')
    804     args, varargs, varkw = getargs(func.func_code)
    805     return ArgSpec(args, varargs, varkw, func.func_defaults)

TypeError: arg is not a Python function
```
and similarly

```
sage: P.<x,y,z> = QQ[]
sage: I = P*[x,y]
sage: inspect.getargspec(I.interreduced_basis)
ArgSpec(args=[], varargs='args', keywords='kwds', defaults=None)
sage: inspect.getargspec(I.groebner_basis)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/mnt/local/king/SAGE/sage-4.7.2.alpha2/devel/sage-main/<ipython console> in <module>()

/mnt/local/king/SAGE/sage-4.7.2.alpha2/local/lib/python/inspect.pyc in getargspec(func)
    801         func = func.im_func
    802     if not isfunction(func):
--> 803         raise TypeError('arg is not a Python function')
    804     args, varargs, varkw = getargs(func.func_code)
    805     return ArgSpec(args, varargs, varkw, func.func_defaults)

TypeError: arg is not a Python function
```
while the Sage autoinspection finds

```
sage: from sage.misc.sageinspect import sage_getargspec
sage: sage_getargspec(I.interreduced_basis)
ArgSpec(args=['self'], varargs=None, keywords=None, defaults=None)
sage: sage_getargspec(I.groebner_basis)
ArgSpec(args=['self', 'algorithm', 'deg_bound', 'mult_bound', 'prot'], varargs='args', keywords='kwds', defaults=('', None, None, False))
```

In the most difficult cases, `sage_getargspec` actually needs to read the source (using `sage_getsourcelines`) and analyse the function definition. That's why inspect.getargspec is faster (yet a lot less powerful) than sage.misc.sageinspect.sage_getargspec.



---

archive/issue_comments_129839.json:
```json
{
    "body": "I spend quite a bit of time looking at that speedup yesterday. While everything you say is certainly correct, a big part comes from calling the constructor I mentioned less frequently. It turned out that removing the decorator from *any* interacts control would almost yield the same speedup - even though the that control is never referenced in the --startuptime call.\nIf I trust cProfile then there is a single call to the ArgSpec constructor that is slow after a certain number of calls. Maybe cProfile is misleading here, and actually something else is happening...anyway, it's faster now, I don't think it introduces any new bug, so I'm happy with the result ;)",
    "created_at": "2011-08-25T07:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129839",
    "user": "https://github.com/saraedum"
}
```

I spend quite a bit of time looking at that speedup yesterday. While everything you say is certainly correct, a big part comes from calling the constructor I mentioned less frequently. It turned out that removing the decorator from *any* interacts control would almost yield the same speedup - even though the that control is never referenced in the --startuptime call.
If I trust cProfile then there is a single call to the ArgSpec constructor that is slow after a certain number of calls. Maybe cProfile is misleading here, and actually something else is happening...anyway, it's faster now, I don't think it introduces any new bug, so I'm happy with the result ;)



---

archive/issue_comments_129840.json:
```json
{
    "body": "Attachment [trac11734_sage_wraps_no_sourceread_lambda.patch](tarball://root/attachments/some-uuid/ticket11734/trac11734_sage_wraps_no_sourceread_lambda.patch) by @simon-king-jena created at 2011-08-25 09:41:39\n\nWith the new patch, all tests pass, and for the reasons mentioned previously it is a positive review.",
    "created_at": "2011-08-25T09:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129840",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac11734_sage_wraps_no_sourceread_lambda.patch](tarball://root/attachments/some-uuid/ticket11734/trac11734_sage_wraps_no_sourceread_lambda.patch) by @simon-king-jena created at 2011-08-25 09:41:39

With the new patch, all tests pass, and for the reasons mentioned previously it is a positive review.



---

archive/issue_comments_129841.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-25T09:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129841",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_129842.json:
```json
{
    "body": "For the patchbot:\n\nApply trac11734_sage_wraps_no_sourceread_lambda.patch",
    "created_at": "2011-09-13T09:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129842",
    "user": "https://github.com/simon-king-jena"
}
```

For the patchbot:

Apply trac11734_sage_wraps_no_sourceread_lambda.patch



---

archive/issue_comments_129843.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-09-17T05:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129843",
    "user": "https://github.com/nexttime"
}
```

Resolution: fixed



---

archive/issue_events_030866.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2011-09-17T05:20:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11562#event-30866"
}
```



---

archive/issue_comments_129844.json:
```json
{
    "body": "Attachment [trac11734_sage_wraps_no_sourceread_lambda.proper.patch](tarball://root/attachments/some-uuid/ticket11734/trac11734_sage_wraps_no_sourceread_lambda.proper.patch) by @nexttime created at 2011-09-28 16:59:56\n\n\"Proper\" Mercurial changeset replacement patch.",
    "created_at": "2011-09-28T16:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129844",
    "user": "https://github.com/nexttime"
}
```

Attachment [trac11734_sage_wraps_no_sourceread_lambda.proper.patch](tarball://root/attachments/some-uuid/ticket11734/trac11734_sage_wraps_no_sourceread_lambda.proper.patch) by @nexttime created at 2011-09-28 16:59:56

"Proper" Mercurial changeset replacement patch.



---

archive/issue_comments_129845.json:
```json
{
    "body": "I've attached a `*.proper.patch`, which is identical except that I removed the \"garbage\" before \"`# HG changeset patch`\", i.e., I deleted the first line \"`exporting patch:`\", since Jeroen's current merger rejects such patches.\n\nFor now, please make sure all your patches start with \"`# HG changeset patch`\", i.e., have it on the first line without any preceding messages or whatever.\n\nI've relaxed that in *my version* of the merger, but Jeroen and maybe others are likely to use his more restrictive one.",
    "created_at": "2011-09-28T17:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11562",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11562#issuecomment-129845",
    "user": "https://github.com/nexttime"
}
```

I've attached a `*.proper.patch`, which is identical except that I removed the "garbage" before "`# HG changeset patch`", i.e., I deleted the first line "`exporting patch:`", since Jeroen's current merger rejects such patches.

For now, please make sure all your patches start with "`# HG changeset patch`", i.e., have it on the first line without any preceding messages or whatever.

I've relaxed that in *my version* of the merger, but Jeroen and maybe others are likely to use his more restrictive one.
