# Issue 20212: Let the doctest of map_reduce work for single-core computers

Issue created by migration from Trac.

Original creator: tmonteil

Original creation time: 2016-04-15 20:41:00

CC:  hivert

Followup of #13580, which creates a module whose doctests assume that the host has at least two cores.

In the longer term, we could imagine to have a `# multicore` option for doctests, but let us just fix the doctests for this ticket to test whether the host has a single core first.



---

Comment by tmonteil created at 2016-04-15 20:51:46

Changing priority from major to blocker.


---

Comment by tmonteil created at 2016-04-15 20:51:46

Let me put this ticket as blocker since the doctest are currently broken on single core computers.


---

Comment by hivert created at 2016-04-15 21:10:42

Hi thiery,

I just pushed a 1 character fix. It allows two parallel processes even on single core machines. Note that on those kinds of machines, it make no sense to use map_reduce. The same functionality is provided by the `run_serial` method which makes no use of multi-core.

Can you test this patch on your patchbot and report failure if any ?

Florent
----
New commits:


---

Comment by tmonteil created at 2016-04-15 21:43:12

Patchbot launched, let us see.


---

Comment by hivert created at 2016-04-15 22:03:48

Hi thiery,

How long will it takes ? I've to get up early tomorrow...

While waiting, I'm playing with SSE/AVX. I've a speedup of x20 for a function which sorts 16 bytes. 

Florent


---

Comment by hivert created at 2016-04-15 22:16:00

Going to bed... I'll check you report tomorrow evening.


---

Comment by tmonteil created at 2016-04-16 10:44:02

I do not really like the fact that we change the code while the problem comes from the doctest, but at least the doctests now pass with that change, see http://patchbot.sagemath.org/log/20449/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-16%2000:11:02?short


---

Comment by slabbe created at 2016-04-16 12:57:44

I also had a decision like this (what to do when ncpus=1) to make recently in the parallelization of dancing links code:

https://github.com/sagemath/sage/blob/master/src/sage/combinat/matrices/dancing_links.pyx#L373


---

Comment by jdemeyer created at 2016-04-17 07:51:04

Replying to [ticket:20449 tmonteil]:
> In the longer term, we could imagine to have a `# multicore` option for doctests, but let us just fix the doctests for this ticket to test whether the host has a single core first.

Is the problem really in the _doctest_ or in the functionality?


---

Comment by vbraun created at 2016-05-07 11:31:38

Any progress? IMHO a failing doctest on some particular setup isn't a blocker, there are far worse bugs than that...


---

Comment by vbraun created at 2016-05-07 11:31:38

Changing priority from blocker to major.


---

Comment by tmonteil created at 2016-08-20 20:36:27

Changing status from new to needs_review.


---

Comment by tmonteil created at 2016-08-20 20:36:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-21 23:39:41

Resolution: fixed


---

Comment by tmonteil created at 2019-08-27 19:45:19

Changing keywords from "" to "sdl".
