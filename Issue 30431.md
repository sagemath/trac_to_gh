# Issue 30431: Prepare for autoconf-2.70

Issue created by migration from https://trac.sagemath.org/ticket/30668

Original creator: mjo

Original creation time: 2020-09-26 18:52:47

CC:  mkoeppe fbissey dimpase vbraun

Autoconf is finally getting an update after 8 years, and there are some breaking changes. A beta version has been released for testing:

  https://lists.gnu.org/archive/html/autoconf/2020-09/msg00006.html

We should try to bootstrap sage with the new version to make sure everything works before any end-users get a chance to.


---

Comment by mkoeppe created at 2020-09-26 20:05:21

Well, fortunately end users do not run autoconf.


---

Comment by mjo created at 2020-09-26 23:11:13

Lots of people clone the git repo and run `./bootstrap`. They're who I had in mind.


---

Comment by dimpase created at 2020-09-27 10:43:10

I think it's a good idea to check whether we can point out some issued, before the release is final.


---

Comment by mjo created at 2020-10-15 16:41:15

Bootstrap output (cleaned up):


```
configure.ac:392: warning: back quotes and double quotes must not be escaped in: multiple installation records for $SPKG_NAME: m4_newline($(ls -l "$SAGE_SPKG_INST/$SPKG_NAME"-*)) m4_newline([only one should exist, so please delete some or all of these files and re-run \"$srcdir/configure\"])
m4/sage_spkg_configures.m4:191: warning: The macro `AC_FOREACH' is obsolete.
m4/sage_spkg_configures.m4:191: warning: The macro `AC_PROG_CC_C99' is obsolete.
m4/sage_spkg_configures.m4:204: warning: The macro `AC_FOREACH' is obsolete.
m4/sage_spkg_configures.m4:261: warning: The macro `AC_TRY_LINK' is obsolete.
m4/sage_spkg_configures.m4:261: warning: The macro `AC_TRY_RUN' is obsolete.
```



---

Comment by mjo created at 2020-10-15 16:53:14

AC_TRY_LINK comes from ppl.m4, and has an easy replacement. Reported upstream at https://www.cs.unipr.it/mantis/view.php?id=2751


---

Comment by mjo created at 2020-10-15 16:55:38

AC_TRY_RUN, too: https://www.cs.unipr.it/mantis/view.php?id=2752


---

Comment by mjo created at 2020-10-17 16:53:54

AC_FOREACH: http://savannah.gnu.org/patch/index.php?9983


---

Comment by mjo created at 2020-10-28 19:06:48

Dropping the backslashes that it complains about in `m4/sage_spkg_collect.m4` doesn't seem to hurt anything (output does not change):


```patch
diff --git a/m4/sage_spkg_collect.m4 b/m4/sage_spkg_collect.m4
index 7cba7252c4..3867bc16c9 100644
--- a/m4/sage_spkg_collect.m4
+++ b/m4/sage_spkg_collect.m4
@@ -183,7 +183,7 @@ for DIR in $SAGE_ROOT/build/pkgs/*; do
                         multiple installation records for $SPKG_NAME:
                         m4_newline($(ls -l "$SAGE_SPKG_INST/$SPKG_NAME"-*))
                         m4_newline([only one should exist, so please delete some or all
-                        of these files and re-run \"$srcdir/configure\"])
+                        of these files and re-run "$srcdir/configure"])
                     ]))
                 ])
                 stampfile=yes
```



---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by dimpase created at 2021-03-15 11:37:08

on Gentoo, autoconf is now version 2.71. Running `autoupdate m4/*` produces mostly backward-compatible changes.


---

Comment by dimpase created at 2021-03-15 11:53:02

New commits:


---

Comment by mjo created at 2021-03-15 14:59:46

I think that leaves only the obsolete `AC_PROG_CC_C99` in `build/pkgs/gcc/spkg-configure.m4`. The new autoconf docs say that we can replace


```
    AC_LANG_PUSH(C)
    if test -z "$CC"; then
        SAGE_MUST_INSTALL_GCC([a C compiler is missing])
    fi

    # Save compiler before checking for C99 support                             
    save_CC=$CC
    # Check that we can compile C99 code                                        
    AC_PROG_CC_C99()
    if test "x$ac_cv_prog_cc_c99" = xno; then
        SAGE_MUST_INSTALL_GCC([your C compiler cannot compile C99 code])
    fi
    # restore original CC                                                       
    CC=$save_CC
    AC_LANG_POP()
```


with


```
    if test -z "$CC"; then
        SAGE_MUST_INSTALL_GCC([a C compiler is missing])
    fi

    if test "x$ac_cv_prog_cc_c99" = xno; then
        SAGE_MUST_INSTALL_GCC([your C compiler cannot compile C99 code])
    fi
```


since we already call `AC_PROG_CC()`, and it now sets `$ac_cv_prog_cc_c99`.

**But** that would skip the C99 check for people using older autoconf. Should we...

1. ignore that problem, or
2. set the minimum version of autoconf required to 2.70, or
3. just leave the `AC_PROG_CC_C99()` alone for now and fix it in the future?


---

Comment by mkoeppe created at 2021-03-15 16:16:27

Replying to [comment:13 mjo]:
> Should we[...]
> 2. set the minimum version of autoconf required to 2.70, or
> [...]

No, that would be too disruptive


---

Comment by mjo created at 2021-03-15 18:51:32

Changing status from new to needs_review.


---

Comment by mjo created at 2021-03-15 18:51:32

This looks sufficient for both autoconf-2.69 and autoconf-2.71.
----
New commits:


---

Comment by dimpase created at 2021-03-16 10:52:58

As you could check,

```
     if test "x$ac_cv_prog_cc_c99" = xno; then
         SAGE_MUST_INSTALL_GCC([your C compiler cannot compile C99 code])
     fi
```

can be removed, as nothing sets `ac_cv_prog_cc_c99` any more.


---

Comment by mjo created at 2021-03-16 11:23:38

Replying to [comment:16 dimpase]:
> as nothing sets `ac_cv_prog_cc_c99` any more.

Of course I haven't tested on a system with a brand-new autoconf and a twenty-year-old gcc, but the documentation for >=autoconf-2.70 says that `AC_PROG_CC` can now set it:

https://www.gnu.org/software/autoconf/manual/autoconf-2.70/html_node/C-Compiler.html


---

Comment by dimpase created at 2021-03-16 17:05:03

OK, fine, thanks. I'm bumping it to 9.3, perhaps there is still room...


---

Comment by dimpase created at 2021-03-16 17:05:03

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-03-16 17:30:20

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-03-16 17:30:20


```
diff --git a/m4/ax_check_compile_flag.m4 b/m4/ax_check_compile_flag.m4
index bd753b3..423ab25 100644
--- a/m4/ax_check_compile_flag.m4
+++ b/m4/ax_check_compile_flag.m4
@@ -37,7 +37,7 @@
 #serial 6
 
 AC_DEFUN([AX_CHECK_COMPILE_FLAG],
-[AC_PREREQ(2.64)dnl for _AC_LANG_PREFIX and AS_VAR_IF
+[AC_PREREQ([2.69])dnl for _AC_LANG_PREFIX and AS_VAR_IF
 AS_VAR_PUSHDEF([CACHEVAR],[ax_cv_check_[]_AC_LANG_ABBREV[]flags_$4_$1])dnl
 AC_CACHE_CHECK([whether _AC_LANG compiler accepts $1], CACHEVAR, [
   ax_check_save_flags=$[]_AC_LANG_PREFIX[]FLAGS
```

Changes like this are not good. These are files from autoconf-archive, and their versions are identified by `#serial`. Don't make changes within them. If necessary, get a newer version from autoconf-archive.


---

Comment by dimpase created at 2021-03-16 17:50:55

well, the archive still has these old versions, e.g.: http://git.savannah.gnu.org/gitweb/?p=autoconf-archive.git;a=blob_plain;f=m4/ax_check_compile_flag.m4


---

Comment by mkoeppe created at 2021-03-16 18:10:05

Well, bumping the `AC_PREREQ` of these macros is certainly not needed for this ticket. There is already `AC_PREREQ([2.69])` in `configure.ac`, so what are you trying to achieve by these changes?


---

Comment by mkoeppe created at 2021-03-16 18:24:50

http://git.savannah.gnu.org/gitweb/?p=autoconf-archive.git;a=blob_plain;f=m4/ax_absolute_header.m4 has a newer version.

For other autoconf-archive macros that actually need changing, it would probably be good to prepare a pull request.


---

Comment by dimpase created at 2021-03-19 13:53:01

One reason I changed the version in these files was that autoupdate script changes them, to 2.71.


---

Comment by mkoeppe created at 2021-03-19 17:01:36

It sure looked like an automatically made change. But it should not be on the ticket.


---

Comment by dimpase created at 2021-03-20 23:22:19

I can revert ax_c_check_flag.m4 change. 

How about extra quotes to be put in in
ax_check_compile_flag.m4 ?
Would you object to `2.64` becoming `[2.64]` ?


---

Comment by mkoeppe created at 2021-03-21 01:11:15

Is the quoting fix needed to suppress warnings with the new version? Then it should be upstreamed...


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by dimpase created at 2021-03-24 12:44:40

Replying to [comment:27 mkoeppe]:
> Is the quoting fix needed to suppress warnings with the new version? Then it should be upstreamed...

no, no warning without quotes.


---

Comment by mkoeppe created at 2021-05-16 23:54:21

ping?


---

Comment by dimpase created at 2021-05-17 09:07:11

OK, how about this?
----
New commits:


---

Comment by dimpase created at 2021-05-17 09:07:11

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-05-18 03:56:41

Same as before


---

Comment by mkoeppe created at 2021-05-18 03:56:41

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-05-18 04:07:25

And also, what is this:

```
-AU_ALIAS([CHECK_SSL], [AX_CHECK_OPENSSL])
+AU_ALIAS([AX_CHECK_OPENSSL], [AX_CHECK_OPENSSL])
```



---

Comment by dimpase created at 2021-05-18 15:25:20

our `m4/ax_*` files are not pristine upstream, e.g. check `m4/ax_check_root.m4`.
We do fix bugs there. Thus I think you're too strict in demanding these be left untouched.

As to comment:33 goes, that's what the automatic update did.
I guess this means that this `AU_ALIAS` may be deleted.


---

Comment by mkoeppe created at 2021-05-18 16:14:32

Replying to [comment:34 dimpase]:
> our `m4/ax_*` files are not pristine upstream, e.g. check `m4/ax_check_root.m4`.
> We do fix bugs there. Thus I think you're too strict in demanding these be left untouched.

comment 22. PR for upstream


---

Comment by git created at 2021-05-18 16:43:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-05-18 16:44:41

I'll ask on autoconf mailing list how/if they want updates


---

Comment by dimpase created at 2021-05-18 16:44:56

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-05-20 09:38:16

by the way, I noticed that Gentoo went back to 2.69, for a reason stated on https://packages.gentoo.org/packages/sys-devel/autoconf as

```
Has unidentified race condition on very fast CPUs that causes maintainer- mode to be triggered. Most likely caused by the following upstream commit: https://git.savannah.gnu.org/cgit/autoconf.git/commit/?id=aba75f6d4a9c875a9d5d90a07c6b3678db66a4bf
```

but this supposed bug does not seem to be on Gentoo bug tracker, nor reported on bug-autoconf mailing list.


---

Comment by dimpase created at 2021-05-20 09:39:27

this leaves me without a ready to use system I can test these updates.


---

Comment by dimpase created at 2021-05-20 09:39:39

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2021-05-20 15:18:29

You can unmask autoconf-2.71 on Gentoo by adding the line `sys-devel/autoconf:2.71` to `/etc/portage/package.unmask`.

I am sceptical of the unreported race condition, but have too many other things to worry about at the moment.


---

Comment by git created at 2021-05-20 16:58:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-05-20 16:59:59

I've removed all the changes to ax_* files - except the one that was updated upstream, so I included this update here.


---

Comment by dimpase created at 2021-05-20 16:59:59

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-05-20 17:23:03

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-05-28 10:17:22

weirdly, `SAGE_SPKG_CONFIGURE_BOOST` creeps up in a warning, even though full `boost` package is gone.

```
configure.ac:43: installing 'config/missing'
m4/sage_spkg_configures.m4:500: warning: SAGE_SPKG_CONFIGURE_BOOST is m4_require'd but not m4_defun'd
m4/sage_spkg_configure.m4:159: SAGE_SPKG_DEPCHECK is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:500: the top level
```


feels like wrong quoting somewhere?

As well:

```
% ./configure --help | grep boost
  --with-system-boost_cropped={no|yes (default)|force (exit with an error if no usable version is found)}
                          detect and use an existing system boost_cropped
  --with-boost[=ARG]      use Boost library from a standard location
  --with-boost-libdir=LIB_DIR
                          Force given directory for boost libraries. Note that
                          fails and you know exactly where your boost
```



---

Comment by dimpase created at 2021-05-28 15:17:40

the latter is fixed by
https://trac.sagemath.org/ticket/31575#comment:19

I'll open another ticket for this.


---

Comment by dimpase created at 2021-05-28 16:54:58

Replying to [comment:47 dimpase]:
> the latter is fixed by
> #31575#comment:19
> 
> I'll open another ticket for this.
fixed by #31871


---

Comment by dimpase created at 2021-06-27 11:19:49

Changing priority from major to critical.


---

Comment by dimpase created at 2021-06-27 11:19:49

please merge this soon, a number of distros use autoconf 2.70+ now, and it breaks CI stuff not to support it properly.


---

Comment by dimpase created at 2021-07-07 09:13:30

Changing type from task to defect.


---

Comment by dimpase created at 2021-07-07 09:13:30

Made it a blocker, as I am tired of seeing

```
configure.ac:43: installing 'config/missing'
m4/sage_spkg_configures.m4:515: warning: The macro `AC_PROG_CC_C99' is obsolete.
m4/sage_spkg_configures.m4:515: You should run autoupdate.
./lib/autoconf/c.m4:1659: AC_PROG_CC_C99 is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:515: the top level
m4/sage_spkg_configures.m4:515: warning: The macro `AC_FOREACH' is obsolete.
m4/sage_spkg_configures.m4:515: You should run autoupdate.
./lib/autoconf/general.m4:191: AC_FOREACH is expanded from...
m4/ax_absolute_header.m4:41: AX_ABSOLUTE_HEADER is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_configure.m4:159: SAGE_SPKG_DEPCHECK is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:515: the top level
m4/sage_spkg_configures.m4:515: warning: The macro `AC_TRY_LINK' is obsolete.
m4/sage_spkg_configures.m4:515: You should run autoupdate.
./lib/autoconf/general.m4:2920: AC_TRY_LINK is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_configure.m4:159: SAGE_SPKG_DEPCHECK is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:515: the top level
m4/sage_spkg_configures.m4:517: warning: The macro `AC_FOREACH' is obsolete.
m4/sage_spkg_configures.m4:517: You should run autoupdate.
./lib/autoconf/general.m4:191: AC_FOREACH is expanded from...
m4/ax_absolute_header.m4:41: AX_ABSOLUTE_HEADER is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:517: the top level
m4/sage_spkg_configures.m4:531: warning: The macro `AC_FOREACH' is obsolete.
m4/sage_spkg_configures.m4:531: You should run autoupdate.
./lib/autoconf/general.m4:191: AC_FOREACH is expanded from...
m4/ax_absolute_header.m4:41: AX_ABSOLUTE_HEADER is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
./lib/autoconf/headers.m4:89: _AC_CHECK_HEADER_COMPILE is expanded from...
./lib/autoconf/headers.m4:56: AC_CHECK_HEADER is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:531: the top level
m4/sage_spkg_configures.m4:595: warning: The macro `AC_TRY_RUN' is obsolete.
m4/sage_spkg_configures.m4:595: You should run autoupdate.
./lib/autoconf/general.m4:2997: AC_TRY_RUN is expanded from...
m4/ppl.m4:29: AM_PATH_PPL is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_configure.m4:159: SAGE_SPKG_DEPCHECK is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:595: the top level
m4/sage_spkg_configures.m4:595: warning: The macro `AC_TRY_LINK' is obsolete.
m4/sage_spkg_configures.m4:595: You should run autoupdate.
./lib/autoconf/general.m4:2920: AC_TRY_LINK is expanded from...
m4/ppl.m4:29: AM_PATH_PPL is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_configure.m4:159: SAGE_SPKG_DEPCHECK is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:692: _AS_IF_ELSE is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
m4/sage_spkg_configures.m4:595: the top level
configure.ac:447: warning: back quotes and double quotes must not be escaped in: multiple installation records for $SPKG_NAME: m4_newline($(ls -l "$SAGE_SPKG_INST/$SPKG_NAME"-*)) m4_newline([only one should exist, so please delete some or all of these files and re-run \"$srcdir/configure\"])
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
lib/m4sugar/m4sh.m4:699: AS_IF is expanded from...
m4/sage_spkg_collect.m4:69: SAGE_SPKG_COLLECT is expanded from...
configure.ac:447: the top level
```

every time I run `./bootstrap`

also, `make distclean` is broken for me without this branch.


---

Comment by dimpase created at 2021-07-07 09:13:30

Changing priority from critical to blocker.


---

Comment by vbraun created at 2021-07-25 18:51:45

Resolution: fixed


---

Comment by dimpase created at 2021-07-27 08:06:58

Thanks, Volker. 

Were "typos" (well, unprintable chars - thanks Michael for spotting these) in the list of authors tripping up your scripts?
