# Issue 17426: clean sparse matrices

archive/issues_017426.json:
```json
{
    "body": "CC:  @gagern @pjbruin @nathanncohen\n\nBig cleaning (and speedup x1.5)\n\nIssue created by migration from https://trac.sagemath.org/ticket/17663\n\n",
    "created_at": "2015-01-22T23:15:14Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "clean sparse matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17426",
    "user": "https://github.com/videlec"
}
```
CC:  @gagern @pjbruin @nathanncohen

Big cleaning (and speedup x1.5)

Issue created by migration from https://trac.sagemath.org/ticket/17663





---

archive/issue_comments_232417.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-01-22T23:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232417",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_232418.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-01-22T23:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232418",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_232419.json:
```json
{
    "body": "Interesting. Looks mostly good.\n\nThis is wrong, though:\n\n```\nfor i from 0 <= i < self._nrows:\n  for j from 0 <= j < self._ncols:\n    if not x[k]:\n      entries[(i,j)] = x[k]\n    k += 1\n```\n\nIt should be `if x[k]`: you want to copy the *non*-zero elements. I had some trouble testing this code path, though:\n\n```\nsage: R.<a,b>=QQ[]\nsage: m1=matrix(2,2,[0,a,b,0],sparse=True); m1\n[0 a]\n[b 0]\nsage: type(m1)(m1.parent(),[0,a,b,0],True,True)\n[0 0]\n[0 0]\n```\n\nI haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.\n\nI also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.\n\nAs far as I can see, most other (non-generic) sparse matrix implementations use something other than a dict to represent its entries. Something like [Yale format](http://en.wikipedia.org/wiki/Sparse_matrix#Yale) as far as I can tell at a quick glance. Perhaps a really proper cleanup should go all the way to using that? I'm not sure. Benefits are better memory efficiency, but we'd get logarithmic lookup times as opposed to the almost constant lookup in a hash table. And modifications would become costly. So perhaps we should offer two alternatives, depending on whether memory is an issue or not? Just thinking out loud, I'm not asking for this to be implemented in the ticket at hand.\n\nThe whole class has poor docstring and doctest coverage. I know that when adding new code, it should come with doctests these days. I'm not sure whether your modifications are simply changing existing code and are therefore exempt from this rule. I'd certainly be more happy if you were to add docstrings with tests to all the methods you modified, taking care to test all relevant code paths. To catch things like the one above.",
    "created_at": "2015-01-23T07:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232419",
    "user": "https://github.com/gagern"
}
```

Interesting. Looks mostly good.

This is wrong, though:

```
for i from 0 <= i < self._nrows:
  for j from 0 <= j < self._ncols:
    if not x[k]:
      entries[(i,j)] = x[k]
    k += 1
```

It should be `if x[k]`: you want to copy the *non*-zero elements. I had some trouble testing this code path, though:

```
sage: R.<a,b>=QQ[]
sage: m1=matrix(2,2,[0,a,b,0],sparse=True); m1
[0 a]
[b 0]
sage: type(m1)(m1.parent(),[0,a,b,0],True,True)
[0 0]
[0 0]
```

I haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.

I also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.

As far as I can see, most other (non-generic) sparse matrix implementations use something other than a dict to represent its entries. Something like [Yale format](http://en.wikipedia.org/wiki/Sparse_matrix#Yale) as far as I can tell at a quick glance. Perhaps a really proper cleanup should go all the way to using that? I'm not sure. Benefits are better memory efficiency, but we'd get logarithmic lookup times as opposed to the almost constant lookup in a hash table. And modifications would become costly. So perhaps we should offer two alternatives, depending on whether memory is an issue or not? Just thinking out loud, I'm not asking for this to be implemented in the ticket at hand.

The whole class has poor docstring and doctest coverage. I know that when adding new code, it should come with doctests these days. I'm not sure whether your modifications are simply changing existing code and are therefore exempt from this rule. I'd certainly be more happy if you were to add docstrings with tests to all the methods you modified, taking care to test all relevant code paths. To catch things like the one above.



---

archive/issue_comments_232420.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-01-23T07:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232420",
    "user": "https://github.com/gagern"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_232421.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-23T07:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232421",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_232422.json:
```json
{
    "body": "Hello,\n\nReplying to [comment:2 gagern]:\n> Interesting. Looks mostly good.\n> \n> This is wrong, though:\n> \n> <...>\n\n>\n\nRight\n \n> I haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.\n\n\nDone\n\n> I also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.\n\n\nNope. I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.\n\n> As far as I can see, most other (non-generic) sparse matrix implementations <...>\n\n\nHash table is cool. But not in the way it is done currently. We should not use Python objects other than to wrap the ring elements.\n\nAn important question is whether you want to access quickly to the following data:\n\n- nonzero entries in a fixed row\n- nonzero entries in a fixed column\n\nThe best would be as you did: look at the literature and other softwares/libraries.\n\n> The whole class has poor docstring and doctest coverage.\n\n\nRight, I added some. But I will not go any further.\n\nVincent",
    "created_at": "2015-01-23T08:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232422",
    "user": "https://github.com/videlec"
}
```

Hello,

Replying to [comment:2 gagern]:
> Interesting. Looks mostly good.
> 
> This is wrong, though:
> 
> <...>

>

Right
 
> I haven't yet figured out where the `m1` construction converts its argument, but perhaps we can deprecate or even immediately remove that code path dealing with a single flat list.


Done

> I also wonder whether we should have a custom cythonized type to be used as key, instead of the generic CPython tuple or arbitrary size and types. Might make things a lot faster and memory-efficient again.


Nope. I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.

> As far as I can see, most other (non-generic) sparse matrix implementations <...>


Hash table is cool. But not in the way it is done currently. We should not use Python objects other than to wrap the ring elements.

An important question is whether you want to access quickly to the following data:

- nonzero entries in a fixed row
- nonzero entries in a fixed column

The best would be as you did: look at the literature and other softwares/libraries.

> The whole class has poor docstring and doctest coverage.


Right, I added some. But I will not go any further.

Vincent



---

archive/issue_comments_232423.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.\n\nIt might be better to keep that for a follow-up ticket.",
    "created_at": "2015-01-23T11:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232423",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 vdelecroix]:
> I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.

It might be better to keep that for a follow-up ticket.



---

archive/issue_comments_232424.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-23T12:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232424",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_232425.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Replying to [comment:5 vdelecroix]:\n> > I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.\n\n> It might be better to keep that for a follow-up ticket.\n\nRight. And thinking more, I am not so sure about the overhead as Python int (for -5 <= i < 128) do not need allocation.\n\nVincent",
    "created_at": "2015-01-23T12:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232425",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 vdelecroix]:
> > I think we sould get rid of Python there. Sparse graphs have a much better implementation (though not very much documented either). But you are right, having a customized Cython type for pair of Py_ssize_t would be indeed much faster. Let me have a try.

> It might be better to keep that for a follow-up ticket.

Right. And thinking more, I am not so sure about the overhead as Python int (for -5 <= i < 128) do not need allocation.

Vincent



---

archive/issue_comments_232426.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-01-23T18:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232426",
    "user": "https://github.com/gagern"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_232427.json:
```json
{
    "body": "```\nsage -t --long --warn-long 46.2 src/sage/matrix/matrix_space.py\n**********************************************************************\nFile \"src/sage/matrix/matrix_space.py\", line 1649, in sage.matrix.matrix_space.test_trivial_matrices_inverse\nFailed example:\n    tinv(QQ['x,y'], sparse=True)\nException raised:\n    Traceback (most recent call last):\n      File \"local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 488, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 850, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.matrix.matrix_space.test_trivial_matrices_inverse[17]>\", line 1, in <module>\n        tinv(QQ['x,y'], sparse=True)\n      File \"local/lib/python2.7/site-packages/sage/matrix/matrix_space.py\", line 1658, in test_trivial_matrices_inverse\n        assert(m00.inverse() == m00)\n    AssertionError\n**********************************************************************\n1 item had failures:\n   1 of  20 in sage.matrix.matrix_space.test_trivial_matrices_inverse\n    [261 tests, 1 failure, 2.72 s]\n```",
    "created_at": "2015-01-23T18:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232427",
    "user": "https://github.com/gagern"
}
```

```
sage -t --long --warn-long 46.2 src/sage/matrix/matrix_space.py
**********************************************************************
File "src/sage/matrix/matrix_space.py", line 1649, in sage.matrix.matrix_space.test_trivial_matrices_inverse
Failed example:
    tinv(QQ['x,y'], sparse=True)
Exception raised:
    Traceback (most recent call last):
      File "local/lib/python2.7/site-packages/sage/doctest/forker.py", line 488, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "local/lib/python2.7/site-packages/sage/doctest/forker.py", line 850, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.matrix.matrix_space.test_trivial_matrices_inverse[17]>", line 1, in <module>
        tinv(QQ['x,y'], sparse=True)
      File "local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 1658, in test_trivial_matrices_inverse
        assert(m00.inverse() == m00)
    AssertionError
**********************************************************************
1 item had failures:
   1 of  20 in sage.matrix.matrix_space.test_trivial_matrices_inverse
    [261 tests, 1 failure, 2.72 s]
```



---

archive/issue_comments_232428.json:
```json
{
    "body": "I'm curious about the statement \"This datastructure is not very efficient.\" Instead of asking you to explain it here, I think it's reasonable to assume that other people will be curious about it, too, so it should be explained in the docstring where you've introduced it.",
    "created_at": "2015-01-23T19:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232428",
    "user": "https://github.com/jhpalmieri"
}
```

I'm curious about the statement "This datastructure is not very efficient." Instead of asking you to explain it here, I think it's reasonable to assume that other people will be curious about it, too, so it should be explained in the docstring where you've introduced it.



---

archive/issue_comments_232429.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-23T21:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232429",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_232430.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-23T21:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232430",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_232431.json:
```json
{
    "body": "Replying to [comment:8 gagern]:\n\nVery strange. Actually, when you try to convert matrix from a ring to another you might end up to call the constructor of `MatrixGenericSparse` with arguments `entries=[]`. And so, the case of the empty list needs to be treated!! I added a long comment in the constructor and it might be appropriate to actually modify the code in `MatrixSpace.matrix`.\n\nReplying to [comment:9 jhpalmieri]\n\nTrue. I added two sentences in a `.. NOTE::`. Actually, I have no idea about the potential speed up.\n\nVincent",
    "created_at": "2015-01-23T21:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232431",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:8 gagern]:

Very strange. Actually, when you try to convert matrix from a ring to another you might end up to call the constructor of `MatrixGenericSparse` with arguments `entries=[]`. And so, the case of the empty list needs to be treated!! I added a long comment in the constructor and it might be appropriate to actually modify the code in `MatrixSpace.matrix`.

Replying to [comment:9 jhpalmieri]

True. I added two sentences in a `.. NOTE::`. Actually, I have no idea about the potential speed up.

Vincent



---

archive/issue_comments_232432.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-01-23T21:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232432",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232433.json:
```json
{
    "body": "The nonzero doctest has me confused:\n\n```\nsage: bool(m)\nFalse\nsage: m.is_zero() # indirect doctest\nTrue\n```\n\nWhy is the first expected to be false? Shouldn't a zero matrix evaluate as zero? Isn't one invariant the fact that all entries in the dict must be non-zero?",
    "created_at": "2015-01-24T09:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232433",
    "user": "https://github.com/gagern"
}
```

The nonzero doctest has me confused:

```
sage: bool(m)
False
sage: m.is_zero() # indirect doctest
True
```

Why is the first expected to be false? Shouldn't a zero matrix evaluate as zero? Isn't one invariant the fact that all entries in the dict must be non-zero?



---

archive/issue_comments_232434.json:
```json
{
    "body": "Replying to [comment:13 gagern]:\n> The nonzero doctest has me confused:\n> \n> \n> ```\n> sage: bool(m)\n> False\n> sage: m.is_zero() # indirect doctest\n> True\n> ```\n> Why is the first expected to be false?\n> Shouldn't a zero matrix evaluate as zero?\n\n\nIt is like 0\n\n```\nsage: bool(0)\nFalse\nsage: 0.is_zero()\nTrue\n```\n\nWe have zero <-> False and non-zero <-> True\n\n> Isn't one invariant the fact that all entries in the dict must be non-zero?\n\n\nYes, it is. So that the matrix is zero if and only if the dict is empty.\n\nVincent",
    "created_at": "2015-01-24T09:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232434",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:13 gagern]:
> The nonzero doctest has me confused:
> 
> 
> ```
> sage: bool(m)
> False
> sage: m.is_zero() # indirect doctest
> True
> ```
> Why is the first expected to be false?
> Shouldn't a zero matrix evaluate as zero?


It is like 0

```
sage: bool(0)
False
sage: 0.is_zero()
True
```

We have zero <-> False and non-zero <-> True

> Isn't one invariant the fact that all entries in the dict must be non-zero?


Yes, it is. So that the matrix is zero if and only if the dict is empty.

Vincent



---

archive/issue_comments_232435.json:
```json
{
    "body": "Sorry, had a knot in my thoughts. Read this before becoming fully awake, I guess. I'm running the full test suite again, then I'll have a (hopefully final) look at the code.",
    "created_at": "2015-01-24T09:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232435",
    "user": "https://github.com/gagern"
}
```

Sorry, had a knot in my thoughts. Read this before becoming fully awake, I guess. I'm running the full test suite again, then I'll have a (hopefully final) look at the code.



---

archive/issue_comments_232436.json:
```json
{
    "body": "Replying to [comment:15 gagern]:\n> Sorry, had a knot in my thoughts. Read this before becoming fully awake, I guess.\n\n\n:-)",
    "created_at": "2015-01-24T10:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232436",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:15 gagern]:
> Sorry, had a knot in my thoughts. Read this before becoming fully awake, I guess.


:-)



---

archive/issue_comments_232437.json:
```json
{
    "body": "Replying to [comment:15 gagern]:\n> Sorry, had a knot in my thoughts.\n\nDid you look too much at #17030 by chance :-)",
    "created_at": "2015-01-24T10:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232437",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 gagern]:
> Sorry, had a knot in my thoughts.

Did you look too much at #17030 by chance :-)



---

archive/issue_comments_232438.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> Did you look too much at #17030 by chance :-)\n\n\n:-D\n\nThat would be a very professional excuse, but I guess I was thinking more along the lines `bool(\u2026)` vs. `x.__nonzero__()` (which should behave the same) instead of `bool(x)` vs. `x.is_zero()` as the doctest used them.\n\nSome more comments from reading the latest commit.\n* `if entries is None or not entries` could be shortened to `if not entries`.\n* `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n\nOne more thing, not related to that last commit. Contrary to other sparse matrix implementations, we don't do a range check for inputs. Of course, that might be considered a bug in its own right, but if you feel like it, you could address this here as well.\n\n```\nsage: m = matrix(Zmod(5)['x'],2,2,{(3,3):2}) # this APPEARS to work at first\nsage: m.is_zero()\nFalse\nsage: m\n<repr(<sage.matrix.matrix_generic_sparse.Matrix_generic_sparse at 0x7fc795dcbf50>) failed: IndexError: list assignment index out of range>\nsage: matrix(Zmod(5),2,2,{(3,3):2}) # this reports the problem early on\n...\nIndexError: invalid entries list\n```",
    "created_at": "2015-01-24T11:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232438",
    "user": "https://github.com/gagern"
}
```

Replying to [comment:17 jdemeyer]:
> Did you look too much at #17030 by chance :-)


:-D

That would be a very professional excuse, but I guess I was thinking more along the lines `bool(…)` vs. `x.__nonzero__()` (which should behave the same) instead of `bool(x)` vs. `x.is_zero()` as the doctest used them.

Some more comments from reading the latest commit.
* `if entries is None or not entries` could be shortened to `if not entries`.
* `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.

One more thing, not related to that last commit. Contrary to other sparse matrix implementations, we don't do a range check for inputs. Of course, that might be considered a bug in its own right, but if you feel like it, you could address this here as well.

```
sage: m = matrix(Zmod(5)['x'],2,2,{(3,3):2}) # this APPEARS to work at first
sage: m.is_zero()
False
sage: m
<repr(<sage.matrix.matrix_generic_sparse.Matrix_generic_sparse at 0x7fc795dcbf50>) failed: IndexError: list assignment index out of range>
sage: matrix(Zmod(5),2,2,{(3,3):2}) # this reports the problem early on
...
IndexError: invalid entries list
```



---

archive/issue_comments_232439.json:
```json
{
    "body": "Replying to [comment:18 gagern]:\n> Some more comments from reading the latest commit.\n> * `if entries is None or not entries` could be shortened to `if not entries`.\n\n\nIt depends on the school! \"my_var is None\" is a simple address lookup while \"not my_var\" implies a function call. So \"my_var is None\" is very fast compared to \"not my_var\". But I agree that is fighting for micro seconds that are negligible looking at the rest of the code...\n\n> * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n\n\nActually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!\n\n> One more thing, not related to that last commit.\n\n\nIndeed, this needs to be fixed. I thought that `MatrixSpace` would have taken care of that. I will add a commit.\n\nVincent",
    "created_at": "2015-01-24T11:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232439",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:18 gagern]:
> Some more comments from reading the latest commit.
> * `if entries is None or not entries` could be shortened to `if not entries`.


It depends on the school! "my_var is None" is a simple address lookup while "not my_var" implies a function call. So "my_var is None" is very fast compared to "not my_var". But I agree that is fighting for micro seconds that are negligible looking at the rest of the code...

> * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.


Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!

> One more thing, not related to that last commit.


Indeed, this needs to be fixed. I thought that `MatrixSpace` would have taken care of that. I will add a commit.

Vincent



---

archive/issue_comments_232440.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-24T11:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232440",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_232441.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-01-24T11:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232441",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_232442.json:
```json
{
    "body": "Sorry, wrong doctests. I had to do a forced push.",
    "created_at": "2015-01-24T11:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232442",
    "user": "https://github.com/videlec"
}
```

Sorry, wrong doctests. I had to do a forced push.



---

archive/issue_comments_232443.json:
```json
{
    "body": "Is there any way to actually reach that `The input must be scalar or a dictionary` exception? Since the \u201centries is not a dict\u201d case is already handled before, I think not.\n\nThe comment about the `coerce=False` case sounds like someone asking for a revival of #17658. So if anyone wonders just how bad this \u201creally bad\u201d could be, I'd say \u201cvery bad indeed\u201d.",
    "created_at": "2015-01-24T13:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232443",
    "user": "https://github.com/gagern"
}
```

Is there any way to actually reach that `The input must be scalar or a dictionary` exception? Since the “entries is not a dict” case is already handled before, I think not.

The comment about the `coerce=False` case sounds like someone asking for a revival of #17658. So if anyone wonders just how bad this “really bad” could be, I'd say “very bad indeed”.



---

archive/issue_comments_232444.json:
```json
{
    "body": "Please remove\n\n```python\n## def _sparse_dot_product(v, w):\n##     \"\"\"\n##     INPUT:\n##         v and w are dictionaries with integer keys.\n##     \"\"\"\n##     x = set(v.keys()).intersection(set(w.keys()))\n##     a = 0\n##     for k in x:\n##         a = a + v[k]*w[k]\n##     return a\n```",
    "created_at": "2015-01-24T14:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232444",
    "user": "https://github.com/jdemeyer"
}
```

Please remove

```python
## def _sparse_dot_product(v, w):
##     """
##     INPUT:
##         v and w are dictionaries with integer keys.
##     """
##     x = set(v.keys()).intersection(set(w.keys()))
##     a = 0
##     for k in x:
##         a = a + v[k]*w[k]
##     return a
```



---

archive/issue_comments_232445.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-01-24T14:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232445",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_232446.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-24T14:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232446",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_232447.json:
```json
{
    "body": "Replying to [comment:24 jdemeyer]:\n\nIs there anything special about that one comment block? There are similar comments all over the file, although most come from [2076edf](http://git.sagemath.org/sage.git/commit/?id=2076edfc5e985d848980204f103a1157087350f1) while the one you wanted removed comes from [43baa1b](http://git.sagemath.org/sage.git/commit/?id=43baa1bbc23e4a0f84c37d72f411c1a04ad1fa72). Does that have anything to do with your choice, or is simply that this one comment appeared in the diff?",
    "created_at": "2015-01-24T15:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232447",
    "user": "https://github.com/gagern"
}
```

Replying to [comment:24 jdemeyer]:

Is there anything special about that one comment block? There are similar comments all over the file, although most come from [2076edf](http://git.sagemath.org/sage.git/commit/?id=2076edfc5e985d848980204f103a1157087350f1) while the one you wanted removed comes from [43baa1b](http://git.sagemath.org/sage.git/commit/?id=43baa1bbc23e4a0f84c37d72f411c1a04ad1fa72). Does that have anything to do with your choice, or is simply that this one comment appeared in the diff?



---

archive/issue_comments_232448.json:
```json
{
    "body": "Replying to [comment:27 gagern]:\n> Is there anything special about that one comment block?\n\nIt's because somebody complained in #17583 about this particular comment block.",
    "created_at": "2015-01-24T16:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232448",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:27 gagern]:
> Is there anything special about that one comment block?

It's because somebody complained in #17583 about this particular comment block.



---

archive/issue_comments_232449.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-01-24T20:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232449",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_232450.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-01-25T22:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232450",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_232451.json:
```json
{
    "body": "Replying to [comment:19 vdelecroix]:\n> It depends on the school! \"my_var is None\" is a simple address lookup while \"not my_var\" implies a function call. So \"my_var is None\" is very fast compared to \"not my_var\".\n\n\nValid point, so I won't object to leave the code as it is. Might even adapt that style.\n\n> > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n \n> \n> Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!\n\n\nCan't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.\n\nMy question about the `The input must be scalar or a dictionary` exception being dead code (from comment:23) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.",
    "created_at": "2015-01-25T22:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232451",
    "user": "https://github.com/gagern"
}
```

Replying to [comment:19 vdelecroix]:
> It depends on the school! "my_var is None" is a simple address lookup while "not my_var" implies a function call. So "my_var is None" is very fast compared to "not my_var".


Valid point, so I won't object to leave the code as it is. Might even adapt that style.

> > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.
 
> 
> Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!


Can't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.

My question about the `The input must be scalar or a dictionary` exception being dead code (from comment:23) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.



---

archive/issue_comments_232452.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-01-25T22:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232452",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_232453.json:
```json
{
    "body": "Replying to [comment:31 gagern]:\n> Replying to [comment:19 vdelecroix]:\n> > It depends on the school! \"my_var is None\" is a simple address lookup while \"not my_var\" implies a function call. So \"my_var is None\" is very fast compared to \"not my_var\".\n\n> \n> Valid point, so I won't object to leave the code as it is. Might even adapt that style.\n\n\n;-)\n\n> > > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.\n \n> > \n> > Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!\n\n> \n> Can't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.\n\n\nAt some point, I had trouble with this but I do not remember exactly. I just learn a funny way to do it returning 1,0 or -1 fast:\n\n```\nreturn (i > j) - (i < j)\n```\n\n> My question about the `The input must be scalar or a dictionary` exception being dead code (from comment:23) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.\n\n\nThanks for that!\n\nVincent",
    "created_at": "2015-01-25T22:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232453",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:31 gagern]:
> Replying to [comment:19 vdelecroix]:
> > It depends on the school! "my_var is None" is a simple address lookup while "not my_var" implies a function call. So "my_var is None" is very fast compared to "not my_var".

> 
> Valid point, so I won't object to leave the code as it is. Might even adapt that style.


;-)

> > > * `_cmp_backward` might use `if i != j: return i - j` in the first case as well. Not sure whether that makes much of a difference.
 
> > 
> > Actually this is what I tried. But if you do that, you end up with some warning claiming that the comparison routine returns something different from 0,1,-1!

> 
> Can't reproduce such a warning. Who is complaining when? Why no warning for the other pair component? I wonder whether one would want to put some bigger numbers in the test case, in order to make sure that steps with absolute value more than one are always involved in some comparison. But even then I don't see this warning you mention.


At some point, I had trouble with this but I do not remember exactly. I just learn a funny way to do it returning 1,0 or -1 fast:

```
return (i > j) - (i < j)
```

> My question about the `The input must be scalar or a dictionary` exception being dead code (from comment:23) still stands. I just pushed a commit for that. If you have no objections to it, feel free to mark this as positive review, since I'm happy with your changes.


Thanks for that!

Vincent



---

archive/issue_comments_232454.json:
```json
{
    "body": "And thanks for the review!\n\nVincent",
    "created_at": "2015-01-25T23:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232454",
    "user": "https://github.com/videlec"
}
```

And thanks for the review!

Vincent



---

archive/issue_events_050591.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-01-29T13:26:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17426#event-50591"
}
```



---

archive/issue_comments_232455.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-01-29T13:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17426#issuecomment-232455",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
