# Issue 24782: Multiple results for division by zero in AA

Issue created by migration from https://trac.sagemath.org/ticket/25019

Original creator: wphooper

Original creation time: 2018-03-21 15:27:58

CC:  bruno gagern mkoeppe mmezzarobba slelievre tmonteil vdelecroix

Keywords: division by zero, AA

Sometimes dividing by zero in AA results in returning an object which prints as

```
[-infinity .. +infinity]
```

Other times it the ZeroDivisionError is raised.

I am not sure what the "[-infinity .. +infinity]" object is and as far as I can tell there are no methods in AA to test for it, so my feeling is that this return is erroneous. I believe that dividing by zero should always be handled in a consistent way, which it is not as the following example illustrates:


```
sage: a = QQbar(1)
sage: b = QQbar(1+I)
sage: (b.imag()-a.imag())/(b.real()-a.real())
[-infinity .. +infinity]
sage: denom = b.real()-a.real()
sage: numer = b.imag()-a.imag()
sage: numer/denom
[-infinity .. +infinity]
sage: denom == 0
True
sage: numer == 1
True
sage: numer/denom
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)
<
```


The above example clearly indicates that simply testing the value of variables in AA (which you would naively guess has no effect on their internal state) changes the outcome of division (by zero). Reminds me of quantum mechanics...

I think this is a significant issue because people unaware of the possibility of a [-infinity .. +infinity] return will not test for it.


---

Comment by slelievre created at 2019-09-18 04:57:38

Edit description with simpler example illustrating the issue.


---

Comment by tmonteil created at 2019-09-18 09:59:48

There is a lazyness mechanism of the computations in `QQbar`, which does not compute (costly) exactifications unless it is required to save time, see for example:


```
sage: a = QQbar(2)
sage: b = a.sqrt()
sage: b
1.414213562373095?
sage: b^2
2.000000000000000?
sage: b^2 < 4       # this is fast because Sage does not need exactifying b^2 for deciding
True
sage: b^2
2.000000000000000?
sage: b^2 == 2      # this exact computation requires exactification, of course the better internal representation is kept for further computations
True
sage: b^2
```


I admit that in your case, an error is delayed, but i guess that in a "true" computation process, the error will happen anyway later. Exactifying to catch such error on-time might slow down every `QQbar` computation.


---

Comment by vdelecroix created at 2019-09-18 12:16:13

Replying to [comment:2 tmonteil]:
> There is a lazyness mechanism of the computations in `QQbar`, which does not compute (costly) exactifications unless it is required to save time, see for example:
> 
> {{{
> sage: a = QQbar(2)
> sage: b = a.sqrt()
> sage: b
> 1.414213562373095?
> sage: b^2
> 2.000000000000000?
> sage: b^2 < 4       # this is fast because Sage does not need exactifying b^2 for deciding
> True
> sage: b^2
> 2.000000000000000?
> sage: b^2 == 2      # this exact computation requires exactification, of course the better internal representation is kept for further computations
> True
> sage: b^2
> }}}
> 
> I admit that in your case, an error is delayed, but i guess that in a "true" computation process, the error will happen anyway later. Exactifying to catch such error on-time might slow down every `QQbar` computation.

In case a division is performed, we must check for nonzeroness. Otherwise, we can easily end up with inconsistent results if automatic simplification happen later.


---

Comment by vdelecroix created at 2019-09-18 12:30:47

For example, this is a critical bug

```
sage: z = QQbar(I).real()
sage: a = ~z
sage: (z*a).is_zero()
True
```



---

Comment by vdelecroix created at 2019-09-18 15:39:54

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-09-18 15:39:54

New commits:


---

Comment by git created at 2019-09-18 15:40:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-09-18 18:49:35

one failing doctest in src/sage/rings/integer.pyx


---

Comment by git created at 2019-09-18 20:50:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-09-18 20:51:01

Fixed... Though, I don't understand why this is tested in `integer.pyx`.


---

Comment by chapoton created at 2019-09-19 07:12:21

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-09-19 07:12:21

feu vert


---

Comment by mmezzarobba created at 2019-09-23 13:20:11

Maybe tangentially related: #28530.


---

Comment by vbraun created at 2019-10-03 17:58:23

Resolution: fixed
