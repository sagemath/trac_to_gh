# Issue 25692: Python 3 fixes in homology/delta_complex.py

archive/issues_025692.json:
```json
{
    "body": "CC:  @fchapoton @tscrim\n\nAs in the summary.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25929\n\n",
    "created_at": "2018-07-25T20:36:18Z",
    "labels": [
        "component: python3",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Python 3 fixes in homology/delta_complex.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25692",
    "user": "https://github.com/jhpalmieri"
}
```
CC:  @fchapoton @tscrim

As in the summary.

Issue created by migration from https://trac.sagemath.org/ticket/25929





---

archive/issue_comments_362181.json:
```json
{
    "body": "There are lots of sorting issues in `sage/homology` \u2013\u00a0the code intentionally tries to sort almost everything, so as to get consistent matrices for boundary maps, etc. This naturally leads to problems with Python 3, because not only does it not want to sort everything, but in cases where sorting was not done explicitly (for a `set`, for example), the default sorting is different between Python 2 and Python 3. I've added a few general fixes for sorting and I've fixed the infinite recursion with `delta_complex.py`. I now get no doctest failures for `cell_complex.py` and `delta_complex.py`.",
    "created_at": "2018-07-25T20:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362181",
    "user": "https://github.com/jhpalmieri"
}
```

There are lots of sorting issues in `sage/homology` – the code intentionally tries to sort almost everything, so as to get consistent matrices for boundary maps, etc. This naturally leads to problems with Python 3, because not only does it not want to sort everything, but in cases where sorting was not done explicitly (for a `set`, for example), the default sorting is different between Python 2 and Python 3. I've added a few general fixes for sorting and I've fixed the infinite recursion with `delta_complex.py`. I now get no doctest failures for `cell_complex.py` and `delta_complex.py`.



---

archive/issue_comments_362182.json:
```json
{
    "body": "Changing keywords from \"\" to \"python3\".",
    "created_at": "2018-07-25T20:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362182",
    "user": "https://github.com/jhpalmieri"
}
```

Changing keywords from "" to "python3".



---

archive/issue_comments_362183.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2018-07-25T20:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362183",
    "user": "https://github.com/jhpalmieri"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_362184.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-25T20:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362184",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_362185.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-25T20:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362185",
    "user": "https://github.com/jhpalmieri"
}
```

New commits:



---

archive/issue_comments_362186.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-01T23:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362186",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362187.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-01T23:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362187",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_362188.json:
```json
{
    "body": "Compared to #25932, this ticket only changes `delta_complex.py`.",
    "created_at": "2018-08-01T23:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362188",
    "user": "https://github.com/jhpalmieri"
}
```

Compared to #25932, this ticket only changes `delta_complex.py`.



---

archive/issue_comments_362189.json:
```json
{
    "body": "This change makes me nervous:\n\n```diff\n             sage: delta_g4 = delta_complexes.SurfaceOfGenus(4)\n             sage: delta_g4.f_vector()\n-            [1, 5, 33, 22]\n+            [1, 3, 27, 18]\n```\n\nIs this related to what you mentioned in comment:1? I don't see how your changes could have affected this.",
    "created_at": "2018-08-02T00:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362189",
    "user": "https://github.com/tscrim"
}
```

This change makes me nervous:

```diff
             sage: delta_g4 = delta_complexes.SurfaceOfGenus(4)
             sage: delta_g4.f_vector()
-            [1, 5, 33, 22]
+            [1, 3, 27, 18]
```

Is this related to what you mentioned in comment:1? I don't see how your changes could have affected this.



---

archive/issue_comments_362190.json:
```json
{
    "body": "It's related to that. The only change in the code inserts sorting into the `elementary_subdivision` method, which is used by `connected_sum`. Before, it was somewhat random which faces were removed and then had their boundaries glued together; with the sorting, it (a) is more deterministic and (b) can lead to different results. It happens that this leads to a smaller model for the surface of genus 4.\n\nIn more detail, suppose you want to compute a Delta complex model for a surface of genus n. You start with a torus, which has a Delta complex model with two triangles with some identifications along their boundaries. To avoid problems when forming the connected sum, first subdivide one of the triangles (the last one in the list). Then check to see if the new last face has any identifications along its boundaries. If you're unlucky, you might have to subdivide again. With a different sorting scheme, you might end up with a different \"last\" face, and also a different result from the subdivision (a different ordering on the new faces obtained from subdividing), and therefore you might have to subdivide a different number of times.\n\nIn this case, the new sorting lets us subdivide fewer times, so we get a smaller f-vector.",
    "created_at": "2018-08-02T01:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362190",
    "user": "https://github.com/jhpalmieri"
}
```

It's related to that. The only change in the code inserts sorting into the `elementary_subdivision` method, which is used by `connected_sum`. Before, it was somewhat random which faces were removed and then had their boundaries glued together; with the sorting, it (a) is more deterministic and (b) can lead to different results. It happens that this leads to a smaller model for the surface of genus 4.

In more detail, suppose you want to compute a Delta complex model for a surface of genus n. You start with a torus, which has a Delta complex model with two triangles with some identifications along their boundaries. To avoid problems when forming the connected sum, first subdivide one of the triangles (the last one in the list). Then check to see if the new last face has any identifications along its boundaries. If you're unlucky, you might have to subdivide again. With a different sorting scheme, you might end up with a different "last" face, and also a different result from the subdivision (a different ordering on the new faces obtained from subdividing), and therefore you might have to subdivide a different number of times.

In this case, the new sorting lets us subdivide fewer times, so we get a smaller f-vector.



---

archive/issue_comments_362191.json:
```json
{
    "body": "Oh, and this ticket itself is an illustration that the sorting order matters: without the branch here, with Python 3's default sorting on `pi[n]`, after subdividing a cell with identifications along its boundary, the new last cell still has identifications along its boundary, so you get an infinite loop.",
    "created_at": "2018-08-02T16:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362191",
    "user": "https://github.com/jhpalmieri"
}
```

Oh, and this ticket itself is an illustration that the sorting order matters: without the branch here, with Python 3's default sorting on `pi[n]`, after subdividing a cell with identifications along its boundary, the new last cell still has identifications along its boundary, so you get an infinite loop.



---

archive/issue_comments_362192.json:
```json
{
    "body": "Thank you for the explanations. LGTM.",
    "created_at": "2018-08-03T03:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362192",
    "user": "https://github.com/tscrim"
}
```

Thank you for the explanations. LGTM.



---

archive/issue_comments_362193.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-03T03:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362193",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_064824.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-01T09:10:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25692#event-64824"
}
```



---

archive/issue_comments_362194.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-01T09:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25692",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25692#issuecomment-362194",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
