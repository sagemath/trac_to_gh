# Issue 33083: Rework on Thebe for live sage documentation

Issue created by migration from https://trac.sagemath.org/ticket/33320

Original creator: klee

Original creation time: 2022-02-10 12:20:51

CC:  jhpalmieri

As Thebe is not working in our Sage documentation, we turned it off.

This ticket is to revive Thebe as a long term goal.

Related tickets:

- #24593


---

Comment by mkoeppe created at 2022-03-22 02:02:13

Changing component from PLEASE CHANGE to documentation.


---

Comment by klee created at 2022-03-22 08:21:12

Changing status from new to needs_review.


---

Comment by klee created at 2022-03-22 08:21:12

Achieved by #33507.


---

Comment by mkoeppe created at 2022-03-22 16:37:59

Isn't the goal that every cell on every documentation page can be activated?


---

Comment by klee created at 2022-03-23 00:20:34

Changing status from needs_review to needs_info.


---

Comment by klee created at 2022-03-23 00:21:12

Replying to [comment:5 mkoeppe]:
> Isn't the goal that every cell on every documentation page can be activated?

Okay. I felt I was missing something.


---

Comment by git created at 2022-03-24 12:38:01

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-03-25 02:38:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by klee created at 2022-03-25 02:46:04

To use a local jupyter server for live doc: in `src/sage/docs/conf.py`,

```
# comment out if local jupyter server is running
jupyter_sphinx_thebelab_config.update({
    'binderOptions': {
        'repo': "sagemath/sage-binder-env",
    },
})
```

and rebuild the doc.



To view the live doc, run

```
sage --notebook=jupyterlab --ServerApp.token='secret' --ServerApp.allow_origin='null' --ServerApp.disable_check_xsrf=true
```

and open the doc.


---

Comment by git created at 2022-03-25 05:00:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-25 05:02:52

Now the procedure to use a local server is 

```
export JUPYTER_SERVER='http://localhost:8888'
export JUPYTER_SERVER_TOKEN='secret'
```

and rebuild the doc. No need to touch `conf.py`.


---

Comment by klee created at 2022-03-26 13:36:55

Changing status from needs_info to needs_work.


---

Comment by git created at 2022-03-26 13:38:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-26 22:35:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-27 08:41:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-27 10:09:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-27 12:39:14

This is now ready to play with.


---

Comment by git created at 2022-03-27 20:39:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-28 01:43:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-28 01:47:16

Just uploaded a late commit. Building live doc takes triple times more time. So `LIVE_DOC=no` is the default.


---

Comment by klee created at 2022-03-28 05:54:40

Matthias, the lines 150-154 of `execute.py` should be removed.


---

Comment by git created at 2022-03-28 13:28:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-28 13:38:05

Replying to [comment:32 klee]:
> Matthias, the lines 150-154 of `execute.py` should be removed.

I fixed the patch.


---

Comment by git created at 2022-03-29 05:52:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-29 06:06:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-30 02:11:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-30 02:14:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by klee created at 2022-03-30 02:24:12

I thought about reducing live doc building time. But it seems that this should be done on jupyter-sphinx side, or rather by forking it to make our own tailored for sage. In short, this belongs to a wishlist.

As the live doc is optional, it is safe to merge this branch now.


---

Comment by klee created at 2022-03-30 02:24:12

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-30 02:40:45

I think the new environment variables should use a prefix `SAGE_` and it would be good if they could be set by `src/sage_docbuild/__init__.py` like it sets environment variables `SAGE_SKIP_PLOT_DIRECTIVE` etc.  I don't think they should go through `sage.env`.


---

Comment by jhpalmieri created at 2022-03-30 03:21:11

Some questions:

- Should the live docs be built in a different location (for example "html_live") so that it can coexist with the static documentation? Then it would play a role more like the PDF documentation.

- Should building the live docs be an option for `./configure`, and/or a `make` target, like the PDF docs? (Separately, I wonder if options like `SAGE_SKIP_PLOT_DIRECTIVE` should also be controlled by `./configure` arguments.)


---

Comment by klee created at 2022-03-30 09:01:28

Replying to [comment:46 jhpalmieri]:
> Some questions:
> 
> - Should the live docs be built in a different location (for example "html_live") so that it can coexist with the static documentation? Then it would play a role more like the PDF documentation.

Live html docs are exactly like the normal html docs with additional "make live" capability. You may see the live docs as an upgrade version. So it makes not much sense to have both.


---

Comment by klee created at 2022-03-30 09:07:37

Replying to [comment:46 jhpalmieri]:
> - Should building the live docs be an option for `./configure`, and/or a `make` target, like the PDF docs? 

I think it's possible to choose live or static by `./configure`, but Matthias will know it better.


---

Comment by klee created at 2022-03-30 09:09:59

Changing status from needs_review to needs_work.


---

Comment by klee created at 2022-03-30 09:09:59

Replying to [comment:44 mkoeppe]:
> I think the new environment variables should use a prefix `SAGE_` and it would be good if they could be set by `src/sage_docbuild/__init__.py` like it sets environment variables `SAGE_SKIP_PLOT_DIRECTIVE` etc.  I don't think they should go through `sage.env`.

Okay. I am working on it.


---

Comment by git created at 2022-03-30 09:28:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-30 14:43:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-03-30 14:50:12

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-04-01 05:47:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-03 12:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-03 13:13:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-04-03 13:16:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-04-03 16:21:34

So if I understand correctly, both (1) during the documentation build and (2) when viewing the documentation, either (a) binder is used or (b) a local Jupyter is used.

Is it possible to do 1(b) and 2(a)?


---

Comment by klee created at 2022-04-04 01:35:34

Replying to [comment:60 mkoeppe]:
> So if I understand correctly, both (1) during the documentation build and (2) when viewing the documentation, either (a) binder is used or (b) a local Jupyter is used.
> 
> Is it possible to do 1(b) and 2(a)?

When you do 1(b), thebe configuration is baked into the htmls, so you cannot do 2(a).

If you want to do 1(a) for the whole documentation, and do 2(b) for a specific documentation, for instance 'prep', then 

```
export SAGE_JUPYTER_SERVER=http://localhost:8888
export SAGE_JUPYTER_SERVER_TOKEN=secret
sage --docbuild --live-doc prep html
```

should work, but does not. I don't understand why. Instead you should do

```
sage --docbuild prep html
export SAGE_JUPYTER_SERVER=http://localhost:8888
export SAGE_JUPYTER_SERVER_TOKEN=secret
sage --docbuild --live-doc prep html
```

This is because sphinx recognizes the changes of the config variable `jupyter_execute_default_kernel` but not of `jupyter_sphinx_thebelab_config`. Any idea why?


---

Comment by klee created at 2022-04-04 05:52:57

Replying to [comment:61 klee]:
> This is because sphinx recognizes the changes of the config variable `jupyter_execute_default_kernel` but not of `jupyter_sphinx_thebelab_config`. Any idea why?

It is because jupyter-sphinx enrolls `jupyter_execute_default_kernel` as a config value of type `env` and `jupyter_sphinx_thebelab_config` as a config value of type `html`.


---

Comment by mkoeppe created at 2022-04-04 08:05:42

I just tried the full docbuild from scratch with the local Jupyter. The build first failed with

```
[sagemath_doc_html-none] [reference] preparing documents... skipping loading of indexes... done
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:34: WARNING: unknown document: categories/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:41: WARNING: unknown document: polynomial_rings/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:43: WARNING: unknown document: finite_rings/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:58: WARNING: unknown document: calculus/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:84: WARNING: unknown document: combinat/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:85: WARNING: unknown document: graphs/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:89: WARNING: unknown document: coding/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:90: WARNING: unknown document: cryptography/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:99: WARNING: unknown document: discrete_geometry/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:102: WARNING: unknown document: manifolds/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:133: WARNING: unknown document: curves/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:134: WARNING: unknown document: arithmetic_curves/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:139: WARNING: unknown document: databases/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:149: WARNING: unknown document: misc/index
[sagemath_doc_html-none] [reference] /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/doc/en/reference/index.rst:150: WARNING: unknown document: doctest/index
[sagemath_doc_html-none] [reference] The inventory files are in local/share/doc/sage/inventory/en/reference.
[sagemath_doc_html-none] Error building the documentation.
```

but re-running it, it succeeded. 

Then, running the command from the ticket description, I got:

```
$ sage --notebook=jupyterlab --ServerApp.token='secret' --ServerApp.allow_origin='null' --ServerApp.disable_check_xsrf=true --ServerApp.open_browser=false
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.6.beta7, Release Date: 2022-04-02               │
│ Using Python 3.10.2. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
Please wait while the Jupyterlab server starts...
[I 2022-04-04 00:50:38.225 ServerApp] jupyterlab | extension was successfully linked.
[W 2022-04-04 00:50:38.230 NotebookApp] 'disable_check_xsrf' has moved from NotebookApp to ServerApp. This config will be passed to ServerApp. Be sure to update your config before our next release.
[I 2022-04-04 00:50:38.239 ServerApp] nbclassic | extension was successfully linked.
[I 2022-04-04 00:50:38.489 ServerApp] notebook_shim | extension was successfully linked.
[I 2022-04-04 00:50:38.588 ServerApp] notebook_shim | extension was successfully loaded.
[I 2022-04-04 00:50:38.590 LabApp] JupyterLab extension loaded from /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/jupyterlab
[I 2022-04-04 00:50:38.590 LabApp] JupyterLab application directory is /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/share/jupyter/lab
[I 2022-04-04 00:50:38.594 ServerApp] jupyterlab | extension was successfully loaded.
[I 2022-04-04 00:50:38.601 ServerApp] nbclassic | extension was successfully loaded.
[I 2022-04-04 00:50:38.602 ServerApp] The port 8888 is already in use, trying another port.
[I 2022-04-04 00:50:38.603 ServerApp] Serving notebooks from local directory: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11
[I 2022-04-04 00:50:38.603 ServerApp] Jupyter Server 1.15.6 is running at:
[I 2022-04-04 00:50:38.603 ServerApp] http://localhost:8889/lab?token=...
[I 2022-04-04 00:50:38.603 ServerApp]  or http://127.0.0.1:8889/lab?token=...
[I 2022-04-04 00:50:38.603 ServerApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
```

Probably, if possible, the instructions should be refined so that the server app does not fall back to another port but rather gives a hard error.


---

Comment by mkoeppe created at 2022-04-04 08:15:27

Overall, this looks quite promising, but I think there are still a few things that need to be improved to make it ready for the public. One thing is that the interaction is very limited - one cannot edit the inputs, so all one can do is reproduce the result that the doctest is already showing. (Also, in doctest blocks with more than one command, it only shows the last result or the first error.)


---

Comment by klee created at 2022-04-04 08:22:18

Replying to [comment:63 mkoeppe]:
> I just tried the full docbuild from scratch with the local Jupyter. The build first failed with ... but re-running it, it succeeded. 

You mean `make doc-clean; make doc-uninstall; make`? 

The first failure seems not related with this ticket...

> Probably, if possible, the instructions should be refined so that the server app does not fall back to another port but rather gives a hard error.

Done.


---

Comment by klee created at 2022-04-04 08:29:01

Replying to [comment:64 mkoeppe]:
> Overall, this looks quite promising, but I think there are still a few things that need to be improved to make it ready for the public. One thing is that the interaction is very limited - one cannot edit the inputs, so all one can do is reproduce the result that the doctest is already showing.

I think this is the primary purpose of the documentation -- running the examples as they are. If they want to do variations, they should go to jupyter and copy-paste.

Of course, it is easy to allow user modifications. A couple of configuration changes. But first we have to decide what behavior we want.

> (Also, in doctest blocks with more than one command, it only shows the last result or the first error.)

This is to be done by editing the documentation. We cannot make jupyter-sphinx an AI.


---

Comment by klee created at 2022-04-04 08:32:42

Replying to [comment:67 klee]:
> > (Also, in doctest blocks with more than one command, it only shows the last result or the first error.)
> 
> This is to be done by editing the documentation. We cannot make jupyter-sphinx an AI.

We can get output from each input line. Then we will have "Run" button for each line. Do we want that?


---

Comment by git created at 2022-04-05 09:22:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-05 09:35:39

With the latest commit, live doc building is almost as fast as building the static doc.


---

Comment by klee created at 2022-04-05 09:38:01

Selective build works now well. You can quickly switch between binder server and local server.


---

Comment by klee created at 2022-04-05 09:41:55

As live doc building is as fast as building static doc, it makes sense to switch to the live doc (with binder server) as default. Binder servers seem slow though (at least to me).


---

Comment by klee created at 2022-04-05 09:47:24

I think the branch is good enough (frankly, very nice!) to make it into sage 9.6, as this ticket supersedes #33507: `sagemath_doc_html: Use jupyter-sphinx for 3D graphics`.


---

Comment by klee created at 2022-04-11 08:55:11

I just found this project:

https://sphinx-thebe.readthedocs.io/en/latest/index.html

It may be more suitable for us.


---

Comment by klee created at 2022-04-11 08:55:11

Changing status from needs_review to needs_work.


---

Comment by klee created at 2022-04-12 06:43:07

Replying to [comment:78 klee]:
> https://sphinx-thebe.readthedocs.io/en/latest/index.html
> 
> It may be more suitable for us.

sphinx-thebe translates nodes

```
.. container::
   :class: thebe
   
   1 + 1
```

to html elements that can be activated by thebe.

jupyter-sphinx executes nodes

```
.. jupyter_execute::

   1 + 1
```

by jupyter and insert the output to the built htmls and can also insert html elements that can be activated by thebe.

Presently we are using jupyter-sphinx but suppressing jupyter execution part (somewhat clumsily), which we don't need currently.

There is also a discussion (https://github.com/jupyter/jupyter-sphinx/issues/137) about using sphinx-thebe for jupyter-sphinx's thebe part. It is unclear how much this progressed.

So I think that from where we stand, there is no clear benefit of switching to sphinx-thebe.


---

Comment by git created at 2022-04-12 06:46:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-12 07:06:17

#33507 introduced a performance regression in sage html documentation by inserting 

```
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
}}}  
which loads rather big javascripts to every page and incurs a slow page loading. You may notice this if compared with the previous sage documentation.

The last commit contains a patch to fix this.


---

Comment by klee created at 2022-04-12 07:12:24

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-04-12 16:44:25

Is there a way to fix this with a patch that could be accepted upstream? 

(See #31543)


---

Comment by klee created at 2022-04-13 00:10:28

Replying to [comment:84 mkoeppe]:
> Is there a way to fix this with a patch that could be accepted upstream? 
> 
> (See #31543)

There would be no simple patch. Even if there is a (big) patch, they may not accept it because it is not fixing a bug. 

If we don't like patched source, then perhaps we should switch to sphinx-thebe.


---

Comment by git created at 2022-04-13 04:31:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-13 04:38:46

Replying to [comment:67 klee]:
> Replying to [comment:64 mkoeppe]:
> > One thing is that the interaction is very limited - one cannot edit the inputs, so all one can do is reproduce the result that the doctest is already showing.
> 
> I think this is the primary purpose of the documentation -- running the examples as they are. If they want to do variations, they should go to jupyter and copy-paste.
> 
> Of course, it is easy to allow user modifications. A couple of configuration changes. But first we have to decide what behavior we want.

Using live docs, I realized that many example code blocks in sage documentation are not ready for live run, and frequently needs user's editing before run. Hence I changed my mind, and the last commit makes code blocks editable.


---

Comment by klee created at 2022-04-13 04:41:02

Note that code-mirror configuration doesn't work. It seems an issue of the current thebe.


---

Comment by klee created at 2022-04-13 04:44:09

Note also that it is now a lot easy to copy-paste code blocks into jupyter :)


---

Comment by git created at 2022-04-24 07:59:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-24 08:04:24

The last commit fixes a bug that causes a failure when `.. JUPYTER_EXECUTE::` is directly used without `execute` tag.


---

Comment by git created at 2022-04-25 07:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-04-29 19:00:07

Changing status from needs_review to needs_work.
