# Issue 22882: Change behavior if SAGE_PYTHON3=yes: build for both Python 2 and Python 3

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2017-05-31 19:35:58

CC:  embray jdemeyer nbruin

This is a proposal for changing Sage's build behavior: if `SAGE_PYTHON3=yes`, then build for both Python 2 and Python 3. This will increase the build time and the required disk space, but then at runtime, you can choose which version of Sage to run.

I also propose that we introduce a new shell command "sage3" which runs Sage using Python 3.

After Sage builds with Python 3, we can change the default to `SAGE_PYTHON3=yes`, so more people can test this. A while after that, we can stop supporting Python 2 altogether.



---

Comment by jhpalmieri created at 2017-05-31 19:47:26

This branch is not complete, but it is good enough for testing. In particular, it does not address all of the issues at #23106, only the ones absolutely necessary for running Sage (not that Sage builds with Python 3 yet, but it almost does). Also, there are a few spkg-check scripts that still use `sage-python23` (cvxopt, gmpy2, pycrypto, python_igraph, scipy). Should they still use `sage-python23`? Should they run tests twice if `SAGE_PYTHON3=yes`, once for each version of Python?
----
New commits:


---

Comment by jhpalmieri created at 2017-05-31 20:06:50

I recommend running "autoreconf" with this branch, because it changes `configure.ac`. What do I need to do to create a new configure tarball? (If you don't run autoreconf and if `SAGE_PYTHON3=yes`, just make sure that Python 2 is built before any packages depending on PYTHON in `build/make/Makefile`. For example, I think you could run `./configure; ./sage -i python2; make`.)


---

Comment by jhpalmieri created at 2017-06-01 00:10:32

One issue with this: if SAGE_PYTHON3=yes, the cythonizing scripts are not written correctly: the scripts `local/bin/cython`, `local/bin/cythonize`, and `local/bin/cygdb` start with `#!/usr/bin/env python3` (because the pip3 version is installed after the pip2 version). It would be better to have separate `cython`, `cython2`, and `cython3` scripts, the way IPython does.


---

Comment by git created at 2017-06-01 21:07:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-06-01 21:08:44

Here is a partial fix for the Cython problem. I wonder if we need to do the same for cysignals, and possibly for other packages. Is pynac also going to be a problem?


---

Comment by rws created at 2017-06-02 06:00:10

Replying to [comment:7 jhpalmieri]:
> ... Is pynac also going to be a problem?

Yes. Pynac uses the Python C API and several functions there that changed name between version 2 and 3.


---

Comment by fbissey created at 2017-06-02 10:10:05

Further we need a new release of pynac or at least https://github.com/pynac/pynac/pull/248 just to build pynac.


---

Comment by fbissey created at 2017-06-02 10:23:28

I will make a new release of brial early next week which will make it easier (and faster) to install for both python, although I don't know if it will work well with `pip` since I am not usually using it.


---

Comment by chapoton created at 2017-06-19 19:51:37

So what is the status of all that, now ? I would appreciate if something would happen, but I am not able to review these tickets.


---

Comment by fbissey created at 2017-06-19 21:46:01

Replying to [comment:12 chapoton]:
> So what is the status of all that, now ? I would appreciate if something would happen, but I am not able to review these tickets.

I am not sure what the hold up is in #23039 but the present ticket looks fine to me once this is resolved. I can do my `brial` stuff once this is merged.


---

Comment by jhpalmieri created at 2017-06-19 22:27:22

Replying to [comment:13 fbissey]:
> I am not sure what the hold up is in #23039

There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.


---

Comment by fbissey created at 2017-06-19 22:29:35

Replying to [comment:14 jhpalmieri]:
> Replying to [comment:13 fbissey]:
> > I am not sure what the hold up is in #23039
> 
> There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.

So, does this ticket depend on #23039 or not?


---

Comment by jhpalmieri created at 2017-06-20 02:38:46

Replying to [comment:15 fbissey]:
> Replying to [comment:14 jhpalmieri]:
> > Replying to [comment:13 fbissey]:
> > > I am not sure what the hold up is in #23039
> > 
> > There is a different approach to solve the same problem in #23129, and I think the plan is to merge that early in 8.1, to give it lots of time for testing.
> 
> So, does this ticket depend on #23039 or not?

It depends on #23039 or #23129. If #23129 gets merged, then we'll close #23039 as a duplicate, and vice versa, so I'll make both dependencies.


---

Comment by chapoton created at 2017-08-07 12:06:46

So what happens here now ? the branch does not apply.


---

Comment by git created at 2017-08-07 18:19:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-07 18:21:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-08-07 18:28:44

This should apply now.


---

Comment by jhpalmieri created at 2017-08-07 20:08:05

I don't know if we also need to include #23325 as a dependency. In any case we need to somehow deal with Pynac. Does it need to be built twice, once for each version of Python? If so, how do we distinguish between the library files once they have been built? Do we need two different `local/lib` directories?


---

Comment by fbissey created at 2017-08-07 21:37:19

Replying to [comment:21 jhpalmieri]:
> I don't know if we also need to include #23325 as a dependency. In any case we need to somehow deal with Pynac. Does it need to be built twice, once for each version of Python? If so, how do we distinguish between the library files once they have been built? Do we need two different `local/lib` directories?

`pynac` produce only one usable library with soname `libpynac.so.x.y`. It is not versioned for python, meaning that even if you build it twice, you get the same library again. It will just be linked to a different python after rebuild (and since some internals depend on the python version, you cannot just underlink to provide whichever python when you link against pynac).

Further, as far as I can tell, and I tried, there is no way to introduce the python implementation as a variable in the library name in libtool. It just doesn't work. In sage-on-gentoo I
* make a copy of the source for each version of python
* patch Makfeile.am in each copy to replace `libpynac.la` by `libpynac_pythonX_Y.la`
* rerun autoconf in each copy
* build and install each copy which now install `libpynac_pythonX_Y.so`
* Finally patch sage to get the right pynac library depending on the python I build for.
Luckily the header are independent of the python implementation, otherwise it would be even more tricky.

Given that sage doesn't ship autotools by default, if you want to reproduce that setup you need to re-create one tarball by version of python.


---

Comment by jhpalmieri created at 2017-08-07 22:36:32

This is far from my area of expertise, but could we instead put a version of `libpynac.so.x.y` in `local/lib/python2.7/` or `local/lib/python3.6/` (or elsewhere), depending on the Python version used when building it, and then give !Sage/Python the appropriate library path?


---

Comment by fbissey created at 2017-08-07 22:38:16

Replying to [comment:23 jhpalmieri]:
> This is far from my area of expertise, but could we instead put a version of `libpynac.so.x.y` in `local/lib/python2.7/` or `local/lib/python3.6/` (or elsewhere), depending on the Python version used when building it, and then give !Sage/Python the appropriate library path?

This is not a standard path, so you will have to add specific rpath for it if you do it this way.


---

Comment by fbissey created at 2017-08-07 22:44:27

And installation would need to be manual (`make install` will not give you what you want). But Erik's stuff about staging before installing could help with that. Distro are quite adept with this kind of stuff.


---

Comment by fbissey created at 2017-08-07 22:49:30

Looking at the ticket in its present form. `brial` doesn't quite have the same trouble as `pynac` but it uses an autotool building system. So I would prefer if, like I suggested for `pynac`, `PYTHON` was set at the end of the configure line.

Of course the point will be moot once we bump `brial` since I decoupled the python part from the autotool build system to allow it to be more easily built against multiple python.


---

Comment by fbissey created at 2017-08-08 01:28:38

Replying to [comment:25 fbissey]:
> And installation would need to be manual (`make install` will not give you what you want). But Erik's stuff about staging before installing could help with that. Distro are quite adept with this kind of stuff.

I am talking rubbish. Ignore this comment, configure will help you with this. 

However you will still need to put `-L$SAGE_LOCAL/lib/pythonX.Y -Wl,-rpath=$SAGE_LOCAL/lib/pythonX.Y` somewhere in `setup.py` or `module_list.py` and distros may hate for putting stuff in a non standard place, and they'll have to fix it to whatever they want to use.


---

Comment by jhpalmieri created at 2017-08-08 03:00:16

I am thinking of this ticket as being useful for developers who want to use Python 3, so maybe we should keep the default setup. So for example, build copies of the `pynac` library and put them in `local/lib/python...`, and then maybe at the very end of building Sage, construct a symlink at `local/lib/pynac.so.x.y` pointing to one of them. Which one? It could depend on the value of `SAGE_PYTHON3`, but this comes back to the old question of whether `SAGE_PYTHON3` should have any effect at run time, or only build time. For developers only, we could have scripts `sage2` and `sage3` which first create the appropriate symlink and then run Sage using the appropriate version of Python. (For developers only because we should not in general assume write access to `SAGE_LOCAL/lib`.)

As I said, this is not my area of expertise, so I would hope other people could come up with better solutions.


---

Comment by git created at 2017-08-08 03:05:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-08-08 03:05:35

Replying to [comment:26 fbissey]:
> Looking at the ticket in its present form. `brial` doesn't quite have the same trouble as `pynac` but it uses an autotool building system. So I would prefer if, like I suggested for `pynac`, `PYTHON` was set at the end of the configure line.

I made this change for `brial`.


---

Comment by rws created at 2017-08-08 15:03:15

Replying to [comment:28 jhpalmieri]:
> I am thinking of this ticket as being useful for developers who want to use Python 3, so maybe we should keep the default setup. So for example, build copies of the `pynac` library and put them in `local/lib/python...`, and then maybe at the very end of building Sage, construct a symlink at `local/lib/pynac.so.x.y` pointing to one of them. Which one? It could depend on the value of `SAGE_PYTHON3`, but this comes back to the old question of whether `SAGE_PYTHON3` should have any effect at run time, or only build time. For developers only, we could have scripts `sage2` and `sage3` which first create the appropriate symlink and then run Sage using the appropriate version of Python. (For developers only because we should not in general assume write access to `SAGE_LOCAL/lib`.)
> 
> As I said, this is not my area of expertise, so I would hope other people could come up with better solutions.

The same discussion happened in https://groups.google.com/forum/?hl=en#!searchin/sage-devel/Pynac$20python%7Csort:date/sage-devel/IY8rc3i-sh4/-MfB1OvkBQAJ

Nils Bruin: "But then we need to either build libraries libpynac2 and libpynac3 or put libpynac somewhere in local/lib/python*".

What's wrong with building Pynac twice?


---

Comment by fbissey created at 2017-08-08 20:22:27

Replying to [comment:31 rws]:
> What's wrong with building Pynac twice?

There is nothing wrong with that. The only thing we need to make sure is that there is a difference between the libraries either in name or location. In sage-on-gentoo I choose name but it is the hard way.


---

Comment by embray created at 2017-08-09 09:07:20

Singular also has a Python module, but I guess it apparently isn't used by Sage in any way so it can just be built against one Python.

Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.


---

Comment by fbissey created at 2017-08-09 09:12:31

Replying to [comment:33 embray]:
> Singular also has a Python module, but I guess it apparently isn't used by Sage in any way so it can just be built against one Python.
> 

It is also only python2.7 as far as I remember.

> Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.

As far as standalone sage is concerned, I approve of that approach. The dual install is only nice for people like me that do sage-on-distro. You don't really get the freedom you are talking about in that case. But I'll admit to being marginal.


---

Comment by embray created at 2017-08-09 09:15:11

I'm not sure I follow.  Why install Sage via a distribution package that includes a Python 2 Sage and a Python 3 Sage.  Having both only seems relevant to me for development reasons, in which case one would't be installing via a packaging system anyways...

I'm not against this if it's helpful to you somehow.  But I don't understand how it's helpful, and it throws a wrench slightly into support for virtual packages (of which Python would be one).


---

Comment by fbissey created at 2017-08-09 09:22:33

Distros offer side by side installations of many package for different version of python - unless there is a major problem with doing so. Of course python 2.7 will be phased out eventually.

Development is also a reason. It looks like until a few days ago I may have been the only one with a complete real python3 build.

Anyway, **I don't use any bits of sage packaging** - nor do other distros. What you do about it has usually marginal effect on us at best. I try not to be dragged into ticket about sage's packaging system for that reason. Not relevant, unless it impact some of my other interests like clang support - primarily for OS X.


---

Comment by jhpalmieri created at 2017-08-09 15:39:55

Replying to [comment:33 embray]:
> Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.

Can you implement something like this so we can test it out?


---

Comment by embray created at 2017-08-10 18:18:16

I'm just talking about `export SAGE_LOCAL=<whatever>`.  Is this not possible?


---

Comment by jhpalmieri created at 2017-08-10 19:12:54

First, my proposed goal is to build Sage so that you can switch, at run-time, between Python 2 and Python 3. With that goal, I don't want to build everything twice, just the things that depend on the version of Python. On OS X or other systems with a bad default version of `gcc`, building `gcc` twice will increase the build time considerably, for example. Singular or R can take a while to build, and I don't think they depend on the version of Python. So I would want something more clever than just setting `SAGE_LOCAL` twice during the build process.


---

Comment by chapoton created at 2017-08-26 08:10:05

Replying to [comment:37 jhpalmieri]:
> Replying to [comment:33 embray]:
> > Anyways I'm actually -1 on this approach of having two separate Sage installs for Python 2 and Python 3 in the same SAGE_LOCAL in general.  I think it overcomplicates things needlessly, when one could simply have two separate installs in separate SAGE_LOCALs each using different Pythons.
> 
> Can you implement something like this so we can test it out?

I would also prefer to have separate installs, one for python2-sage and one for python3-sage. I am not interested in being able to switch inside one unique SAGE_LOCAL. But the point is: when is this going to be possible ? I have been asking for this for quite some time now. Using SAGE_PYTHON3=yes is not enough, for example because of the scripts in src/bin, but more generally because of other build issues that have not been cared about that much so far.


---

Comment by mkoeppe created at 2017-08-27 02:43:35

People who are interested in separate SAGE_LOCALs from one source tree might be interested in helping to update/complete ticket #21469 (VPATH builds).


---

Comment by jdemeyer created at 2018-02-14 13:22:13

Close as wontfix?


---

Comment by chapoton created at 2018-02-14 13:22:41

Yes, I think so.


---

Comment by jdemeyer created at 2018-02-14 13:43:02

Resolution: wontfix
