# Issue 13458: matrix() fails for polynomial quoutient rings over inexact rings

Issue created by migration from Trac.

Original creator: saraedum

Original creation time: 2012-10-27 20:43:04

Assignee: roed

CC:  boerner

Currently, the following code fails:

```
sage: R.<x> = Zp(3,2)[]
sage: S.<xbar> = R.quo(x^2)
sage: xbar.matrix()
TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 0, 0, O(3^2)]
```


The attached patch fixes this.


---

Attachment


---

Comment by nbruin created at 2012-10-29 17:43:22

I think this patch is dangerous. Just truncating the list of coefficients without checking will make this code very prone to producing erroneous results silently.

In this case there is another solution anyway: The present code computes the coefficients of `[self,x*self,x<sup>2*self,...,x</sup>(d-1)*self]` and puts that into a matrix. If your arithmetic is to be trusted, that's probably the more efficient way of doing it. However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.

There may be other, better solutions too and perhaps the current approach (if equipped with reasonable checks) turns out to be good/better/more efficient and acceptable, but in its current form it seems to me it is masking the underlying problem rather than resolving it.


---

Comment by tscrim created at 2013-04-14 13:58:59

Changing status from new to needs_review.


---

Comment by tscrim created at 2013-04-14 13:58:59

I believe this is a duplicate of #13263, however given Nils comment here, I suggest we close #13263.


---

Comment by saraedum created at 2013-09-12 15:50:20

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2013-09-12 15:50:20

The comments are correct. This patch is dangerous. I'm fixing this now.


---

Comment by git created at 2014-06-25 21:39:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2014-06-25 21:39:35

Changing keywords from "" to "sd59".


---

Comment by saraedum created at 2014-06-25 21:39:35

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2014-06-25 21:43:04

Replying to [comment:1 nbruin]:
> However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.
I decided to just reduce leading zero coefficients mod `f` explicitly when creating the quotient ring elements. This appears to be the right thing to do to me. A different algorithm to compute the matrix would be an alternative of course. I just did what appeared to be easier to implement.


---

Comment by saraedum created at 2014-06-29 08:24:09

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2014-06-29 08:25:17

This failing doctest is a problem:

```
             sage: L.series(4)         # takes a long time (several seconds)
-            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
+            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
```

The precision should only go down by this change.


---

Comment by saraedum created at 2014-06-29 21:19:35

Replying to [comment:15 saraedum]:
> This failing doctest is a problem:
> {{{
>              sage: L.series(4)         # takes a long time (several seconds)
> -            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3<sup>0)))*T</sup>2 + O(T^5)
> +            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3<sup>0)))*T</sup>2 + O(T^5)
> }}}
> The precision should only go down by this change.
I put a comment in the last commit which clarifies what is happening here.


---

Comment by git created at 2014-06-29 21:33:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by saraedum created at 2014-06-29 21:34:09

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2015-02-02 22:25:42

Michel, I imagine you know how to do the L-series computations, so you can probably even verify that the added precision did not produce incorrect coefficients.


---

Comment by git created at 2016-03-16 20:50:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aly.deines created at 2016-03-24 00:12:40

Quick question about formatting, why when you are looking at examples like:

```
sage: E = EllipticCurve('37a1')
sage: E.is_ordinary(3)
False
sage: E.is_ordinary(5)
True
sage: L = E.padic_lseries(3)
sage: alpha = L.alpha(10)
sage: alpha^2 - E.ap(3)*alpha + 3
(O(3^11))*alpha + (O(3^11))
sage: L = E.padic_lseries(5)
sage: alpha = L.alpha(10)
sage: alpha^2 - E.ap(5)*alpha + 5
O(5^10)
```

What's going on in the ordinary versus supersingular case?


---

Comment by jen created at 2016-03-31 16:25:46

Changing keywords from "sd59" to "sd59, days71".


---

Comment by saraedum created at 2016-04-08 11:18:39

Changing status from needs_review to needs_work.
