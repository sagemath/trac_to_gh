# Issue 13458: matrix() fails for polynomial quoutient rings over inexact rings

archive/issues_013458.json:
```json
{
    "body": "Assignee: roed\n\nCC:  boerner\n\nCurrently, the following code fails:\n\n```\nsage: R.<x> = Zp(3,2)[]\nsage: S.<xbar> = R.quo(x^2)\nsage: xbar.matrix()\nTypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 0, 0, O(3^2)]\n```\n\n\nThe attached patch fixes this.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13662\n\n",
    "created_at": "2012-10-27T20:43:04Z",
    "labels": [
        "padics",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "matrix() fails for polynomial quoutient rings over inexact rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13458",
    "user": "saraedum"
}
```
Assignee: roed

CC:  boerner

Currently, the following code fails:

```
sage: R.<x> = Zp(3,2)[]
sage: S.<xbar> = R.quo(x^2)
sage: xbar.matrix()
TypeError: cannot construct an element of Full MatrixSpace of 2 by 2 dense matrices over 3-adic Ring with capped relative precision 2 from [0, 1 + O(3^2), 0, 0, O(3^2)]
```


The attached patch fixes this.

Issue created by migration from https://trac.sagemath.org/ticket/13662





---

archive/issue_comments_165939.json:
```json
{
    "body": "Attachment [trac_13662.patch](tarball://root/attachments/some-uuid/ticket13662/trac_13662.patch) by saraedum created at 2012-10-27 20:46:46",
    "created_at": "2012-10-27T20:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165939",
    "user": "saraedum"
}
```

Attachment [trac_13662.patch](tarball://root/attachments/some-uuid/ticket13662/trac_13662.patch) by saraedum created at 2012-10-27 20:46:46



---

archive/issue_comments_165940.json:
```json
{
    "body": "I think this patch is dangerous. Just truncating the list of coefficients without checking will make this code very prone to producing erroneous results silently.\n\nIn this case there is another solution anyway: The present code computes the coefficients of `[self,x*self,x<sup>2*self,...,x</sup>(d-1)*self]` and puts that into a matrix. If your arithmetic is to be trusted, that's probably the more efficient way of doing it. However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.\n\nThere may be other, better solutions too and perhaps the current approach (if equipped with reasonable checks) turns out to be good/better/more efficient and acceptable, but in its current form it seems to me it is masking the underlying problem rather than resolving it.",
    "created_at": "2012-10-29T17:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165940",
    "user": "nbruin"
}
```

I think this patch is dangerous. Just truncating the list of coefficients without checking will make this code very prone to producing erroneous results silently.

In this case there is another solution anyway: The present code computes the coefficients of `[self,x*self,x<sup>2*self,...,x</sup>(d-1)*self]` and puts that into a matrix. If your arithmetic is to be trusted, that's probably the more efficient way of doing it. However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.

There may be other, better solutions too and perhaps the current approach (if equipped with reasonable checks) turns out to be good/better/more efficient and acceptable, but in its current form it seems to me it is masking the underlying problem rather than resolving it.



---

archive/issue_comments_165941.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-04-14T13:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165941",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_165942.json:
```json
{
    "body": "I believe this is a duplicate of #13263, however given Nils comment here, I suggest we close #13263.",
    "created_at": "2013-04-14T13:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165942",
    "user": "tscrim"
}
```

I believe this is a duplicate of #13263, however given Nils comment here, I suggest we close #13263.



---

archive/issue_comments_165943.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-09-12T15:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165943",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_165944.json:
```json
{
    "body": "The comments are correct. This patch is dangerous. I'm fixing this now.",
    "created_at": "2013-09-12T15:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165944",
    "user": "saraedum"
}
```

The comments are correct. This patch is dangerous. I'm fixing this now.



---

archive/issue_comments_165945.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-25T21:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165945",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_165946.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd59\".",
    "created_at": "2014-06-25T21:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165946",
    "user": "saraedum"
}
```

Changing keywords from "" to "sd59".



---

archive/issue_comments_165947.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-06-25T21:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165947",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_165948.json:
```json
{
    "body": "Replying to [comment:1 nbruin]:\n> However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.\nI decided to just reduce leading zero coefficients mod `f` explicitly when creating the quotient ring elements. This appears to be the right thing to do to me. A different algorithm to compute the matrix would be an alternative of course. I just did what appeared to be easier to implement.",
    "created_at": "2014-06-25T21:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165948",
    "user": "saraedum"
}
```

Replying to [comment:1 nbruin]:
> However, the alternative is to create the companion matrix of the generator (that's just a matter of putting coefficients into a matrix; no arithmetic required), take its powers, and take the appropriate linear combination of that. The big advantage there is that you completely avoid doing polynomial divisions/remainders with inexact coefficients, so the numerical stability of your computations is much easier to analyse/guarantee.
I decided to just reduce leading zero coefficients mod `f` explicitly when creating the quotient ring elements. This appears to be the right thing to do to me. A different algorithm to compute the matrix would be an alternative of course. I just did what appeared to be easier to implement.



---

archive/issue_comments_165949.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-06-29T08:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165949",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_165950.json:
```json
{
    "body": "This failing doctest is a problem:\n\n```\n             sage: L.series(4)         # takes a long time (several seconds)\n-            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)\n+            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)\n```\n\nThe precision should only go down by this change.",
    "created_at": "2014-06-29T08:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165950",
    "user": "saraedum"
}
```

This failing doctest is a problem:

```
             sage: L.series(4)         # takes a long time (several seconds)
-            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
+            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T^2 + O(T^5)
```

The precision should only go down by this change.



---

archive/issue_comments_165951.json:
```json
{
    "body": "Replying to [comment:15 saraedum]:\n> This failing doctest is a problem:\n> {{{\n>              sage: L.series(4)         # takes a long time (several seconds)\n> -            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3<sup>0)))*T</sup>2 + O(T^5)\n> +            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3<sup>0)))*T</sup>2 + O(T^5)\n> }}}\n> The precision should only go down by this change.\nI put a comment in the last commit which clarifies what is happening here.",
    "created_at": "2014-06-29T21:19:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165951",
    "user": "saraedum"
}
```

Replying to [comment:15 saraedum]:
> This failing doctest is a problem:
> {{{
>              sage: L.series(4)         # takes a long time (several seconds)
> -            (O(3))*alpha + (O(3^2)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3<sup>0)))*T</sup>2 + O(T^5)
> +            (O(3^2))*alpha + (O(3^3)) + ((O(3^-1))*alpha + (2*3^-1 + O(3^0)))*T + ((O(3^-1))*alpha + (2*3^-1 + O(3<sup>0)))*T</sup>2 + O(T^5)
> }}}
> The precision should only go down by this change.
I put a comment in the last commit which clarifies what is happening here.



---

archive/issue_comments_165952.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-06-29T21:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165952",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_165953.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-06-29T21:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165953",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_165954.json:
```json
{
    "body": "Michel, I imagine you know how to do the L-series computations, so you can probably even verify that the added precision did not produce incorrect coefficients.",
    "created_at": "2015-02-02T22:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165954",
    "user": "saraedum"
}
```

Michel, I imagine you know how to do the L-series computations, so you can probably even verify that the added precision did not produce incorrect coefficients.



---

archive/issue_comments_165955.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-16T20:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165955",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_165956.json:
```json
{
    "body": "Quick question about formatting, why when you are looking at examples like:\n\n```\nsage: E = EllipticCurve('37a1')\nsage: E.is_ordinary(3)\nFalse\nsage: E.is_ordinary(5)\nTrue\nsage: L = E.padic_lseries(3)\nsage: alpha = L.alpha(10)\nsage: alpha^2 - E.ap(3)*alpha + 3\n(O(3^11))*alpha + (O(3^11))\nsage: L = E.padic_lseries(5)\nsage: alpha = L.alpha(10)\nsage: alpha^2 - E.ap(5)*alpha + 5\nO(5^10)\n```\n\nWhat's going on in the ordinary versus supersingular case?",
    "created_at": "2016-03-24T00:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165956",
    "user": "aly.deines"
}
```

Quick question about formatting, why when you are looking at examples like:

```
sage: E = EllipticCurve('37a1')
sage: E.is_ordinary(3)
False
sage: E.is_ordinary(5)
True
sage: L = E.padic_lseries(3)
sage: alpha = L.alpha(10)
sage: alpha^2 - E.ap(3)*alpha + 3
(O(3^11))*alpha + (O(3^11))
sage: L = E.padic_lseries(5)
sage: alpha = L.alpha(10)
sage: alpha^2 - E.ap(5)*alpha + 5
O(5^10)
```

What's going on in the ordinary versus supersingular case?



---

archive/issue_comments_165957.json:
```json
{
    "body": "Changing keywords from \"sd59\" to \"sd59, days71\".",
    "created_at": "2016-03-31T16:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165957",
    "user": "jen"
}
```

Changing keywords from "sd59" to "sd59, days71".



---

archive/issue_comments_165958.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-08T11:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13458#issuecomment-165958",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.
