# Issue 32970: --disable-rpath is broken

Issue created by migration from https://trac.sagemath.org/ticket/33207

Original creator: tornaria

Original creation time: 2022-01-20 12:58:56

CC:  dimpase

The help for configure claims:

```
$ ./configure --help
...
  --disable-rpath         do not hardcode runtime library paths
...
```


However, this doesn't seem to do anything; binaries still get rpaths:

```
$ objdump -p /usr/lib/sage-9.5.rc3/venv/lib/python3.10/site-packages/sage/libs/gap/libgap.cpython-310-x86_64-linux-gnu.so  | grep RPATH
  RPATH                /usr/lib/sage-9.5.rc3/local/lib
```

Since I'm using every library from system, that directory is empty and the rpath is useless.

I was able to disable rpaths as follows:

```
diff --git a/src/bin/sage-env b/src/bin/sage-env
index 27edbf4cfb..0ead5789cb 100644
--- a/src/bin/sage-env
+++ b/src/bin/sage-env
@@ -411,14 +411,6 @@ if [ -n "$PYTHONHOME" ]; then
     unset PYTHONHOME
 fi
 
-if [ -n "$SAGE_LOCAL" ]; then
-    LDFLAGS="-L$SAGE_LOCAL/lib -Wl,-rpath,$SAGE_LOCAL/lib $LDFLAGS"
-    if [ "$UNAME" = "Linux" ]; then
-        LDFLAGS="-Wl,-rpath-link,$SAGE_LOCAL/lib $LDFLAGS"
-    fi
-    export LDFLAGS
-fi
-
 if [ -z "$IPYTHONDIR" ]; then
     # We hardcode a version number in the directory name. The idea is
     # that we keep using the same version number as long as that is
diff --git a/src/sage_setup/setenv.py b/src/sage_setup/setenv.py
index b059a6e709..b6a9e3646c 100644
--- a/src/sage_setup/setenv.py
+++ b/src/sage_setup/setenv.py
@@ -30,11 +30,6 @@ def setenv():
         _environ_prepend('PATH',         f'{SAGE_LOCAL}/bin')
         _environ_prepend('LIBRARY_PATH', f'{SAGE_LOCAL}/lib')
         _environ_prepend('CPATH',        f'{SAGE_LOCAL}/include')
-        _environ_prepend('LDFLAGS',      f'-L{SAGE_LOCAL}/lib -Wl,-rpath,{SAGE_LOCAL}/lib',
-                         separator=' ')
-        if UNAME == 'Linux':
-            _environ_prepend('LDFLAGS',      f'-Wl,-rpath-link,{SAGE_LOCAL}/lib',
-                             separator=' ')
         if Path(SAGE_VENV).resolve() != Path(SAGE_LOCAL).resolve():
             # This condition is always true, but we are keeping it for clarity.
             _environ_prepend('PATH',         f'{SAGE_VENV}/bin')
```


Can this be fixed adding conditionals to those two blocks so they are disabled when `--disable-rpath` was given to configure?


---

Comment by mkoeppe created at 2022-01-21 20:37:45

That this option is even offered was just a side effect of #27823, which is waiting to be cleaned up in #29549.


---

Comment by tornaria created at 2022-01-22 19:23:25

Replying to [comment:1 mkoeppe]:
> That this option is even offered was just a side effect of #27823, which is waiting to be cleaned up in #29549.

Would it make sense to implement it though?

I'm thinking of a variable `SAGE_DISABLE_RPATH` which if set would skip the two blocks removed in my patch above. Then we could add some magic to `configure.ac` so that `--disable-rpath` would set this variable, but I guess the variable is more useful so it can be used when only installing sagelib as a python module in `/usr`. I guess the other way is to left `SAGE_LOCAL` unset, but I'm not sure if that would work, would it?


---

Comment by mkoeppe created at 2022-01-22 19:41:57

Yes, in distribution packaging, `SAGE_LOCAL` is best left unset.
