# Issue 10537: Saturation of elliptic curve points can cause an infinite loop

archive/issues_010537.json:
```json
{
    "body": "Assignee: @JohnCremona\n\nCC:  @rlmill @williamstein\n\nKeywords: saturation\n\nPossibly related to #9247.\n\nThe method saturation() for sets of points on elliptic curves over Q calls eclib in a loop which is optimistically headed \"while True:\".  Unfortunately this really can cause infinite looping.  Here's an example (the curve has conductor 130017):\n\n```\n\nE = EllipticCurve([1, 0, 1, -977842, -372252745])\nP = E([-192128125858676194585718821667542660822323528626273/336995568430319276695106602174283479617040716649, 70208213492933395764907328787228427430477177498927549075405076353624188436/195630373799784831667835900062564586429333568841391304129067339731164107, 1])\nP.height()\nE.saturation([P]) ## OK, saturated\nE.saturation([2*P]) ## loops!\n```\n\nThe problem is that there are various different ways in which the saturation inside the loop (line 2097 of ell_rational_field.py) can fail, and one -- probably the one here -- is due to a lack of precision.  I will look into how to increase the precision used in eclib from Sage.  (In this example, after mwrank_set_precision(200) it works fine, but not with 150.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/10590\n\n",
    "created_at": "2011-01-11T15:41:44Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.2",
    "title": "Saturation of elliptic curve points can cause an infinite loop",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10537",
    "user": "https://github.com/JohnCremona"
}
```
Assignee: @JohnCremona

CC:  @rlmill @williamstein

Keywords: saturation

Possibly related to #9247.

The method saturation() for sets of points on elliptic curves over Q calls eclib in a loop which is optimistically headed "while True:".  Unfortunately this really can cause infinite looping.  Here's an example (the curve has conductor 130017):

```

E = EllipticCurve([1, 0, 1, -977842, -372252745])
P = E([-192128125858676194585718821667542660822323528626273/336995568430319276695106602174283479617040716649, 70208213492933395764907328787228427430477177498927549075405076353624188436/195630373799784831667835900062564586429333568841391304129067339731164107, 1])
P.height()
E.saturation([P]) ## OK, saturated
E.saturation([2*P]) ## loops!
```

The problem is that there are various different ways in which the saturation inside the loop (line 2097 of ell_rational_field.py) can fail, and one -- probably the one here -- is due to a lack of precision.  I will look into how to increase the precision used in eclib from Sage.  (In this example, after mwrank_set_precision(200) it works fine, but not with 150.)

Issue created by migration from https://trac.sagemath.org/ticket/10590





---

archive/issue_comments_109900.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-01-11T18:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109900",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_109901.json:
```json
{
    "body": "Problem fixed.\n\nI added a function mwrank_get_precision() (by wrapping eclib's existing decimal_precision() function).  Testing revealed that mwrank_set_precision(mwrank_get_precision())  had the effect of reducing the precision by at least 1 (exactly on for precision<803, the getting worse) on account or rounding errors in the conversion to/from base 2/base 10.  That is fixed by adding some code to the wrapper function for set_precision().\n\nThis new functionality is used in the saturation() function to catch failures due to lack of precision and gradually increase the precision until success is gained.  At the end the precision is put back to what it was.\n\nIn all the above, \"precision\" only refers to the floating point precision used by the NTL library withing eclib, not to anything else in Sage.\n\nPatch has been tested on a 64-bit machine on the whole library (including long tests).",
    "created_at": "2011-01-11T18:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109901",
    "user": "https://github.com/JohnCremona"
}
```

Problem fixed.

I added a function mwrank_get_precision() (by wrapping eclib's existing decimal_precision() function).  Testing revealed that mwrank_set_precision(mwrank_get_precision())  had the effect of reducing the precision by at least 1 (exactly on for precision<803, the getting worse) on account or rounding errors in the conversion to/from base 2/base 10.  That is fixed by adding some code to the wrapper function for set_precision().

This new functionality is used in the saturation() function to catch failures due to lack of precision and gradually increase the precision until success is gained.  At the end the precision is put back to what it was.

In all the above, "precision" only refers to the floating point precision used by the NTL library withing eclib, not to anything else in Sage.

Patch has been tested on a 64-bit machine on the whole library (including long tests).



---

archive/issue_comments_109902.json:
```json
{
    "body": "This looks good to me! Passes tests on sage-4.6.1.rc0.",
    "created_at": "2011-01-11T19:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109902",
    "user": "https://github.com/rlmill"
}
```

This looks good to me! Passes tests on sage-4.6.1.rc0.



---

archive/issue_comments_109903.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-11T19:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109903",
    "user": "https://github.com/rlmill"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_109904.json:
```json
{
    "body": "Attachment [trac_10590-precision.patch](tarball://root/attachments/some-uuid/ticket10590/trac_10590-precision.patch) by @JohnCremona created at 2011-01-17 14:54:39\n\nApplies to 4.6.2.alpha0",
    "created_at": "2011-01-17T14:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109904",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [trac_10590-precision.patch](tarball://root/attachments/some-uuid/ticket10590/trac_10590-precision.patch) by @JohnCremona created at 2011-01-17 14:54:39

Applies to 4.6.2.alpha0



---

archive/issue_comments_109905.json:
```json
{
    "body": "The new patch only differs from the first one in (new) lines 2115-2118 of ell_rational_field.py, in the saturation() method:  before, if the current precision was > 100 then the initial working precision was actually reduced to 100, which is silly.  Now, if the user has \"manually\" increased precision already, that is used as the starting point.\n\nI discovered this with an example where precision of 300 was needed (250 was too small).\n\nI am switching this to \"needs work\" and then right away back to \"needs review\".",
    "created_at": "2011-01-17T14:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109905",
    "user": "https://github.com/JohnCremona"
}
```

The new patch only differs from the first one in (new) lines 2115-2118 of ell_rational_field.py, in the saturation() method:  before, if the current precision was > 100 then the initial working precision was actually reduced to 100, which is silly.  Now, if the user has "manually" increased precision already, that is used as the starting point.

I discovered this with an example where precision of 300 was needed (250 was too small).

I am switching this to "needs work" and then right away back to "needs review".



---

archive/issue_comments_109906.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-01-17T14:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109906",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_109907.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-01-17T14:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109907",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_109908.json:
```json
{
    "body": "Perhaps the two commented lines which print information about precision changes should be put into verbose commentary. This patch passes the usual testing process, and the code all looks good. John, can you suggest a more thorough way of reviewing this patch?",
    "created_at": "2011-01-18T22:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109908",
    "user": "https://github.com/rlmill"
}
```

Perhaps the two commented lines which print information about precision changes should be put into verbose commentary. This patch passes the usual testing process, and the code all looks good. John, can you suggest a more thorough way of reviewing this patch?



---

archive/issue_comments_109909.json:
```json
{
    "body": "It's a very good idea to have verbose=True cause output of precision changes.\n\nTesting hints:  it's no good giving input which is already saturated since eclib will prove saturation without using any floating point arithmetic at all.  You need to give unsaturated input, and there is no need to have rank>1 to exercise the precision code, so loop through the (extended) database, pick rank one curves E with generator P and run E.saturate([k*P]) for small k>1.\n\nOK, so I should do this.",
    "created_at": "2011-01-18T22:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109909",
    "user": "https://github.com/JohnCremona"
}
```

It's a very good idea to have verbose=True cause output of precision changes.

Testing hints:  it's no good giving input which is already saturated since eclib will prove saturation without using any floating point arithmetic at all.  You need to give unsaturated input, and there is no need to have rank>1 to exercise the precision code, so loop through the (extended) database, pick rank one curves E with generator P and run E.saturate([k*P]) for small k>1.

OK, so I should do this.



---

archive/issue_comments_109910.json:
```json
{
    "body": "I ran a loop as you suggested, and it seems that the new code never hangs (at least on the swath I tested). However, when I tried a keyboard interrupt to stop the loop, it just hanged. Maybe there should be a separate ticket to ensure that interrupts are handled properly.",
    "created_at": "2011-01-19T03:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109910",
    "user": "https://github.com/rlmill"
}
```

I ran a loop as you suggested, and it seems that the new code never hangs (at least on the swath I tested). However, when I tried a keyboard interrupt to stop the loop, it just hanged. Maybe there should be a separate ticket to ensure that interrupts are handled properly.



---

archive/issue_comments_109911.json:
```json
{
    "body": "Good point about interrupts.  I don't have the expertise to know what to do though, sorry.\n\nIf it's to be in a separate ticket can you make this one \"positive review\"?  And I hope you will, since the pre-patched code is no better regarding interrupts;  if anything it is worse (see ticket title!)",
    "created_at": "2011-01-19T09:43:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109911",
    "user": "https://github.com/JohnCremona"
}
```

Good point about interrupts.  I don't have the expertise to know what to do though, sorry.

If it's to be in a separate ticket can you make this one "positive review"?  And I hope you will, since the pre-patched code is no better regarding interrupts;  if anything it is worse (see ticket title!)



---

archive/issue_comments_109912.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-01-19T17:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109912",
    "user": "https://github.com/rlmill"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_109913.json:
```json
{
    "body": "Replying to [comment:7 rlm]:\n> Maybe there should be a separate ticket to ensure that interrupts are handled properly.\n\nI've been working a lot on interrupts in Sage. If you create that ticket, be sure to cc me.",
    "created_at": "2011-01-22T20:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109913",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:7 rlm]:
> Maybe there should be a separate ticket to ensure that interrupts are handled properly.

I've been working a lot on interrupts in Sage. If you create that ticket, be sure to cc me.



---

archive/issue_events_010664.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2011-01-25T08:16:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10537#event-10664"
}
```



---

archive/issue_comments_109914.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-01-25T08:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10537",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10537#issuecomment-109914",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
