# Issue 27724: openblas 0.3.6 vs. OS X

archive/issues_027724.json:
```json
{
    "body": "On at least some OS X machines, openblas 0.3.6 causes Sage to crash. From the end of Sage_crash_report.txt:\n\n```\nImportError: dlopen(/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_rational_dense.so, 2): Library not loaded: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/libopenblas_haswellp-r0.3.5.dylib\n  Referenced from: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_rational_dense.so\n  Reason: image not found\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/27961\n\n",
    "created_at": "2019-06-09T19:45:28Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "openblas 0.3.6 vs. OS X",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27724",
    "user": "https://github.com/jhpalmieri"
}
```
On at least some OS X machines, openblas 0.3.6 causes Sage to crash. From the end of Sage_crash_report.txt:

```
ImportError: dlopen(/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_rational_dense.so, 2): Library not loaded: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/libopenblas_haswellp-r0.3.5.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_rational_dense.so
  Reason: image not found
```

Issue created by migration from https://trac.sagemath.org/ticket/27961





---

archive/issue_comments_391184.json:
```json
{
    "body": "Attachment [Sage_crash_report.txt](tarball://root/attachments/some-uuid/ticket27961/Sage_crash_report.txt) by @jhpalmieri created at 2019-06-09 19:45:39",
    "created_at": "2019-06-09T19:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391184",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [Sage_crash_report.txt](tarball://root/attachments/some-uuid/ticket27961/Sage_crash_report.txt) by @jhpalmieri created at 2019-06-09 19:45:39



---

archive/issue_comments_391185.json:
```json
{
    "body": "I note that it talk about `libopenblas_haswellp-r0.3.5.dylib`. Shouldn't that be `0.3.6` instead? Was it from a building from scratch or an upgrade from the last beta?",
    "created_at": "2019-06-09T20:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391185",
    "user": "https://github.com/kiwifb"
}
```

I note that it talk about `libopenblas_haswellp-r0.3.5.dylib`. Shouldn't that be `0.3.6` instead? Was it from a building from scratch or an upgrade from the last beta?



---

archive/issue_comments_391186.json:
```json
{
    "body": "Mine was an incremental build. I'll try from scratch next. David Coudert reported this failure [on sage-release](https://groups.google.com/d/msg/sage-release/E4vp20O2FN0/MgOqNNrXAwAJ) and there was a similar message. I don't know if his build was an upgrade or from scratch.",
    "created_at": "2019-06-09T20:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391186",
    "user": "https://github.com/jhpalmieri"
}
```

Mine was an incremental build. I'll try from scratch next. David Coudert reported this failure [on sage-release](https://groups.google.com/d/msg/sage-release/E4vp20O2FN0/MgOqNNrXAwAJ) and there was a similar message. I don't know if his build was an upgrade or from scratch.



---

archive/issue_comments_391187.json:
```json
{
    "body": "does this happen with clang-compiled Sage?\nAnd what Fortran?",
    "created_at": "2019-06-11T10:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391187",
    "user": "https://github.com/dimpase"
}
```

does this happen with clang-compiled Sage?
And what Fortran?



---

archive/issue_comments_391188.json:
```json
{
    "body": "Replying to [comment:6 dimpase]:\n> does this happen with clang-compiled Sage?\n\n\nYes\n\n> And what Fortran?\n\n\nA previously compiled gfortran-6.4.0, which I keep around just so I don't have to wait for Sage to build its own. I'll try with Sage's gfortran to see if that makes a difference, at least in issue 2.",
    "created_at": "2019-06-11T16:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391188",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:6 dimpase]:
> does this happen with clang-compiled Sage?


Yes

> And what Fortran?


A previously compiled gfortran-6.4.0, which I keep around just so I don't have to wait for Sage to build its own. I'll try with Sage's gfortran to see if that makes a difference, at least in issue 2.



---

archive/issue_comments_391189.json:
```json
{
    "body": "I don't think issue 1 has much to do with OpenBLAS update, it's just a building problem.\nFor some reason `sage/matrix/matrix_rational_dense.so` didn't get rebuilt. I guess it might be Unicode values of strings involved in the description of this Extension in `src/module_list.py` - indeed, \n\n```\nsage: import pkgconfig\nsage: cblas_pc = pkgconfig.parse('cblas')\n....: cblas_libs = cblas_pc['libraries']\n....: cblas_library_dirs = cblas_pc['library_dirs']\n....: cblas_include_dirs = cblas_pc['include_dirs']\n....: \nsage: cblas_libs\n[u'openblas']\nsage: cblas_library_dirs\n[u'/mnt/opt/Sage/sage-dev/local/lib']\n```\nand then one has\n\n```\n        libraries = ['iml', 'ntl', 'm'] + cblas_libs,\n```\nmixing `str` and `unicode` in Python 2, at least.",
    "created_at": "2019-06-11T17:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391189",
    "user": "https://github.com/dimpase"
}
```

I don't think issue 1 has much to do with OpenBLAS update, it's just a building problem.
For some reason `sage/matrix/matrix_rational_dense.so` didn't get rebuilt. I guess it might be Unicode values of strings involved in the description of this Extension in `src/module_list.py` - indeed, 

```
sage: import pkgconfig
sage: cblas_pc = pkgconfig.parse('cblas')
....: cblas_libs = cblas_pc['libraries']
....: cblas_library_dirs = cblas_pc['library_dirs']
....: cblas_include_dirs = cblas_pc['include_dirs']
....: 
sage: cblas_libs
[u'openblas']
sage: cblas_library_dirs
[u'/mnt/opt/Sage/sage-dev/local/lib']
```
and then one has

```
        libraries = ['iml', 'ntl', 'm'] + cblas_libs,
```
mixing `str` and `unicode` in Python 2, at least.



---

archive/issue_comments_391190.json:
```json
{
    "body": "The unicode observation is interesting, although both David Coudert and I saw it with Python 2 and Python 3. With Python 3:\n\n```\nsage: import pkgconfig\nsage: cblas_pc = pkgconfig.parse('cblas')\nsage: cblas_libs = cblas_pc['libraries']\nsage: cblas_library_dirs = cblas_pc['library_dirs']\nsage: cblas_libs\n['openblas']\nsage: cblas_library_dirs\n['/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.8.beta7/local/lib']\n```",
    "created_at": "2019-06-11T17:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391190",
    "user": "https://github.com/jhpalmieri"
}
```

The unicode observation is interesting, although both David Coudert and I saw it with Python 2 and Python 3. With Python 3:

```
sage: import pkgconfig
sage: cblas_pc = pkgconfig.parse('cblas')
sage: cblas_libs = cblas_pc['libraries']
sage: cblas_library_dirs = cblas_pc['library_dirs']
sage: cblas_libs
['openblas']
sage: cblas_library_dirs
['/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.8.beta7/local/lib']
```



---

archive/issue_comments_391191.json:
```json
{
    "body": "Oh, and I completely agree about issue 1 not being a problem with the openblas update, but instead being a Sage build problem.",
    "created_at": "2019-06-11T17:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391191",
    "user": "https://github.com/jhpalmieri"
}
```

Oh, and I completely agree about issue 1 not being a problem with the openblas update, but instead being a Sage build problem.



---

archive/issue_comments_391192.json:
```json
{
    "body": "No change (back to issue 2) if I use Sage's gfortran, by the way.",
    "created_at": "2019-06-11T17:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391192",
    "user": "https://github.com/jhpalmieri"
}
```

No change (back to issue 2) if I use Sage's gfortran, by the way.



---

archive/issue_comments_391193.json:
```json
{
    "body": "Let me know what else I can do to diagnose this.",
    "created_at": "2019-06-11T19:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391193",
    "user": "https://github.com/jhpalmieri"
}
```

Let me know what else I can do to diagnose this.



---

archive/issue_comments_391194.json:
```json
{
    "body": "it might be hardware-dependent. If you don't see this on an otherwise identical branch on another OSX machine with the same OS version, then that's the most obvious conclusion.",
    "created_at": "2019-06-12T09:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391194",
    "user": "https://github.com/dimpase"
}
```

it might be hardware-dependent. If you don't see this on an otherwise identical branch on another OSX machine with the same OS version, then that's the most obvious conclusion.



---

archive/issue_comments_391195.json:
```json
{
    "body": "I agree. Is it an OpenBLAS issue? For what it's worth, when I run the OpenBLAS test suite, I seem to get failures with 0.3.5 and also 0.3.6, although `spkg-check` exits successfully. None of the failures look immediately like \"Fatal: Memory exhausted\" to me, but I don't really know what I should be looking for.",
    "created_at": "2019-06-12T22:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391195",
    "user": "https://github.com/jhpalmieri"
}
```

I agree. Is it an OpenBLAS issue? For what it's worth, when I run the OpenBLAS test suite, I seem to get failures with 0.3.5 and also 0.3.6, although `spkg-check` exits successfully. None of the failures look immediately like "Fatal: Memory exhausted" to me, but I don't really know what I should be looking for.



---

archive/issue_comments_391196.json:
```json
{
    "body": "Can you try to recompile openblas with different target arch, e.g.\n\n```\nOPENBLAS_CONFIGURE=\"TARGET=PRESCOTT\" ./sage -p openblas\n```\nAlso, are you not really running out of memory, e.g. background processes / ulimit / ...",
    "created_at": "2019-06-12T22:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391196",
    "user": "https://github.com/vbraun"
}
```

Can you try to recompile openblas with different target arch, e.g.

```
OPENBLAS_CONFIGURE="TARGET=PRESCOTT" ./sage -p openblas
```
Also, are you not really running out of memory, e.g. background processes / ulimit / ...



---

archive/issue_comments_391197.json:
```json
{
    "body": "I am pretty sure that I am not running out of memory. The machine has 32GB of RAM, and after running into this, I checked the available memory using the OS X \"Activity Monitor\" and everything was fine. I quit all potential memory hogs, I rebooted, and still got\n\n```\nsage: M = ModularSymbols(GammaH(13,[3]), weight=4)\nsage: M.cuspidal_subspace()\nFatal: Memory exhausted.\n```\nI am away from the machine now, but I will try with a different target tomorrow.",
    "created_at": "2019-06-12T22:42:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391197",
    "user": "https://github.com/jhpalmieri"
}
```

I am pretty sure that I am not running out of memory. The machine has 32GB of RAM, and after running into this, I checked the available memory using the OS X "Activity Monitor" and everything was fine. I quit all potential memory hogs, I rebooted, and still got

```
sage: M = ModularSymbols(GammaH(13,[3]), weight=4)
sage: M.cuspidal_subspace()
Fatal: Memory exhausted.
```
I am away from the machine now, but I will try with a different target tomorrow.



---

archive/issue_comments_391198.json:
```json
{
    "body": "Another datapoint would be running tests with multithreading disabled, e.g.\n\n```\nOPENBLAS_NUM_THREADS=1 sage -t src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst\n```",
    "created_at": "2019-06-13T20:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391198",
    "user": "https://github.com/vbraun"
}
```

Another datapoint would be running tests with multithreading disabled, e.g.

```
OPENBLAS_NUM_THREADS=1 sage -t src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst
```



---

archive/issue_comments_391199.json:
```json
{
    "body": "`OPENBLAS_CONFIGURE=\"TARGET=PRESCOTT\" ./sage -p openblas` works: Sage passes all tests. Also, the `openblas` test suite succeeds this way.\n\nOn the other hand, I still get \"Fatal: Memory exhausted\" if I don't specify `OPENBLAS_CONFIGURE` but instead just disable multithreading with `OPENBLAS_NUM_THREADS=1 sage -t ...`.",
    "created_at": "2019-06-13T21:37:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391199",
    "user": "https://github.com/jhpalmieri"
}
```

`OPENBLAS_CONFIGURE="TARGET=PRESCOTT" ./sage -p openblas` works: Sage passes all tests. Also, the `openblas` test suite succeeds this way.

On the other hand, I still get "Fatal: Memory exhausted" if I don't specify `OPENBLAS_CONFIGURE` but instead just disable multithreading with `OPENBLAS_NUM_THREADS=1 sage -t ...`.



---

archive/issue_comments_391200.json:
```json
{
    "body": "By the way, as mentioned above, if I don't specify `OPENBLAS_CONFIGURE`, I see some apparent failures when I run `./sage -f -c openblas`, but `spkg-check` exits successfully. Is `make tests` misconfigured by OpenBLAS?",
    "created_at": "2019-06-14T00:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391200",
    "user": "https://github.com/jhpalmieri"
}
```

By the way, as mentioned above, if I don't specify `OPENBLAS_CONFIGURE`, I see some apparent failures when I run `./sage -f -c openblas`, but `spkg-check` exits successfully. Is `make tests` misconfigured by OpenBLAS?



---

archive/issue_comments_391201.json:
```json
{
    "body": "Replying to [comment:17 vbraun]:\n> Another datapoint would be running tests with multithreading disabled, e.g.\n> \n> ```\n> OPENBLAS_NUM_THREADS=1 sage -t src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst\n> ```\n\n\nIIUC this is already the default set (somewhat to my chagrin) in sage-env:\n\n```\n626 # Multithreading in OpenBLAS does not seem to play well with Sage's attempts to\n627 # spawn new processes, see #26118. Apparently, OpenBLAS sets the thread\n628 # affinity and, e.g., parallel doctest jobs, remain on the same core.\n629 # Disabling that thread-affinity with OPENBLAS_MAIN_FREE=1 leads to hangs in\n630 # some computations.\n631 # So we disable OpenBLAS' threading completely; we might loose some performance\n632 # here but strangely the opposite seems to be the case. Note that callers such\n633 # as LinBox use a single-threaded OpenBLAS anyway.\n634 export OPENBLAS_NUM_THREADS=1\n```\n\nunless we unset that when running the tests?",
    "created_at": "2019-06-14T15:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391201",
    "user": "https://github.com/embray"
}
```

Replying to [comment:17 vbraun]:
> Another datapoint would be running tests with multithreading disabled, e.g.
> 
> ```
> OPENBLAS_NUM_THREADS=1 sage -t src/doc/en/thematic_tutorials/explicit_methods_in_number_theory/birds_other.rst
> ```


IIUC this is already the default set (somewhat to my chagrin) in sage-env:

```
626 # Multithreading in OpenBLAS does not seem to play well with Sage's attempts to
627 # spawn new processes, see #26118. Apparently, OpenBLAS sets the thread
628 # affinity and, e.g., parallel doctest jobs, remain on the same core.
629 # Disabling that thread-affinity with OPENBLAS_MAIN_FREE=1 leads to hangs in
630 # some computations.
631 # So we disable OpenBLAS' threading completely; we might loose some performance
632 # here but strangely the opposite seems to be the case. Note that callers such
633 # as LinBox use a single-threaded OpenBLAS anyway.
634 export OPENBLAS_NUM_THREADS=1
```

unless we unset that when running the tests?



---

archive/issue_comments_391202.json:
```json
{
    "body": "I wonder if the upgrade to 0.3.6 can be reverted until/unless the cause of this is rooted out.  0.3.5 was working fine, but there was a rush to upgrade for better gcc 9.0 support.  However, this has a workaround to it already: Use an older compiler.\n\nThat or, if there is a *specific* change to OpenBLAS related to the gcc problem perhaps we could just patch that selectively.",
    "created_at": "2019-06-14T15:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391202",
    "user": "https://github.com/embray"
}
```

I wonder if the upgrade to 0.3.6 can be reverted until/unless the cause of this is rooted out.  0.3.5 was working fine, but there was a rush to upgrade for better gcc 9.0 support.  However, this has a workaround to it already: Use an older compiler.

That or, if there is a *specific* change to OpenBLAS related to the gcc problem perhaps we could just patch that selectively.



---

archive/issue_comments_391203.json:
```json
{
    "body": "I've been trawling through the existing issues opened against OpenBLAS and don't see anything obvious that matches this problem, though it would help to know exactly how this call is involving OpenBLAS.",
    "created_at": "2019-06-14T15:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391203",
    "user": "https://github.com/embray"
}
```

I've been trawling through the existing issues opened against OpenBLAS and don't see anything obvious that matches this problem, though it would help to know exactly how this call is involving OpenBLAS.



---

archive/issue_comments_391204.json:
```json
{
    "body": "Can you upload the openblas config.h and install log?",
    "created_at": "2019-06-14T22:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391204",
    "user": "https://github.com/vbraun"
}
```

Can you upload the openblas config.h and install log?



---

archive/issue_comments_391205.json:
```json
{
    "body": "`config.h` looks like this (without setting `OPENBLAS_CONFIGURE`):\n\n```\n#define OS_DARWIN\t1\n#define ARCH_X86_64\t1\n#define C_CLANG\t1\n#define __64BIT__\t1\n#define FUNDERSCORE\t_\n#define PTHREAD_CREATE_FUNC\tpthread_create\n#define BUNDERSCORE\t_\n#define NEEDBUNDERSCORE\t1\n#define SKYLAKEX\n#define L1_CODE_SIZE 32768\n#define L1_CODE_ASSOCIATIVE 8\n#define L1_CODE_LINESIZE 64\n#define L1_DATA_SIZE 32768\n#define L1_DATA_ASSOCIATIVE 8\n#define L1_DATA_LINESIZE 64\n#define L2_SIZE 262144\n#define L2_ASSOCIATIVE 8\n#define L2_LINESIZE 64\n#define ITB_SIZE 2097152\n#define ITB_ASSOCIATIVE 0\n#define ITB_ENTRIES 8\n#define DTB_SIZE 4096\n#define DTB_ASSOCIATIVE 4\n#define DTB_DEFAULT_ENTRIES 64\n#define HAVE_CMOV\n#define HAVE_MMX\n#define HAVE_SSE\n#define HAVE_SSE2\n#define HAVE_SSE3\n#define HAVE_SSSE3\n#define HAVE_SSE4_1\n#define HAVE_SSE4_2\n#define HAVE_AVX\n#define HAVE_AVX2\n#define HAVE_AVX512VL\n#define HAVE_FMA3\n#define HAVE_CFLUSH\n#define NUM_SHAREDCACHE 2\n#define NUM_CORES 8\n#define CORE_SKYLAKEX\n#define CHAR_CORENAME \"SKYLAKEX\"\n#define SLOCAL_BUFFER_SIZE\t24576\n#define DLOCAL_BUFFER_SIZE\t32768\n#define CLOCAL_BUFFER_SIZE\t12288\n#define ZLOCAL_BUFFER_SIZE\t8192\n#define GEMM_MULTITHREAD_THRESHOLD\t4\n```\nIf I set `OPENBLAS_CONFIGURE=\"TARGET=PRESCOTT\"`, it looks like\n\n```\n#define OS_DARWIN\t1\n#define ARCH_X86_64\t1\n#define C_CLANG\t1\n#define __64BIT__\t1\n#define FUNDERSCORE\t_\n#define PTHREAD_CREATE_FUNC\tpthread_create\n#define BUNDERSCORE\t_\n#define NEEDBUNDERSCORE\t1\n#define PENTIUM4\n#define L1_DATA_SIZE 16384\n#define L1_DATA_LINESIZE 64\n#define L2_SIZE 1048576\n#define L2_LINESIZE 64\n#define DTB_DEFAULT_ENTRIES 64\n#define DTB_SIZE 4096\n#define L2_ASSOCIATIVE 8\n#define HAVE_CMOV\n#define HAVE_MMX\n#define HAVE_SSE\n#define HAVE_SSE2\n#define HAVE_SSE3\n#define CORE_PRESCOTT\n#define CHAR_CORENAME \"PRESCOTT\"\n#define SLOCAL_BUFFER_SIZE\t8192\n#define DLOCAL_BUFFER_SIZE\t8192\n#define CLOCAL_BUFFER_SIZE\t8192\n#define ZLOCAL_BUFFER_SIZE\t8192\n#define GEMM_MULTITHREAD_THRESHOLD\t4\n```",
    "created_at": "2019-06-15T00:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391205",
    "user": "https://github.com/jhpalmieri"
}
```

`config.h` looks like this (without setting `OPENBLAS_CONFIGURE`):

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define SKYLAKEX
#define L1_CODE_SIZE 32768
#define L1_CODE_ASSOCIATIVE 8
#define L1_CODE_LINESIZE 64
#define L1_DATA_SIZE 32768
#define L1_DATA_ASSOCIATIVE 8
#define L1_DATA_LINESIZE 64
#define L2_SIZE 262144
#define L2_ASSOCIATIVE 8
#define L2_LINESIZE 64
#define ITB_SIZE 2097152
#define ITB_ASSOCIATIVE 0
#define ITB_ENTRIES 8
#define DTB_SIZE 4096
#define DTB_ASSOCIATIVE 4
#define DTB_DEFAULT_ENTRIES 64
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define HAVE_SSE4_2
#define HAVE_AVX
#define HAVE_AVX2
#define HAVE_AVX512VL
#define HAVE_FMA3
#define HAVE_CFLUSH
#define NUM_SHAREDCACHE 2
#define NUM_CORES 8
#define CORE_SKYLAKEX
#define CHAR_CORENAME "SKYLAKEX"
#define SLOCAL_BUFFER_SIZE	24576
#define DLOCAL_BUFFER_SIZE	32768
#define CLOCAL_BUFFER_SIZE	12288
#define ZLOCAL_BUFFER_SIZE	8192
#define GEMM_MULTITHREAD_THRESHOLD	4
```
If I set `OPENBLAS_CONFIGURE="TARGET=PRESCOTT"`, it looks like

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define PENTIUM4
#define L1_DATA_SIZE 16384
#define L1_DATA_LINESIZE 64
#define L2_SIZE 1048576
#define L2_LINESIZE 64
#define DTB_DEFAULT_ENTRIES 64
#define DTB_SIZE 4096
#define L2_ASSOCIATIVE 8
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define CORE_PRESCOTT
#define CHAR_CORENAME "PRESCOTT"
#define SLOCAL_BUFFER_SIZE	8192
#define DLOCAL_BUFFER_SIZE	8192
#define CLOCAL_BUFFER_SIZE	8192
#define ZLOCAL_BUFFER_SIZE	8192
#define GEMM_MULTITHREAD_THRESHOLD	4
```



---

archive/issue_comments_391206.json:
```json
{
    "body": "Attachment [openblas.log](tarball://root/attachments/some-uuid/ticket27961/openblas.log) by @jhpalmieri created at 2019-06-15 00:51:24",
    "created_at": "2019-06-15T00:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391206",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [openblas.log](tarball://root/attachments/some-uuid/ticket27961/openblas.log) by @jhpalmieri created at 2019-06-15 00:51:24



---

archive/issue_comments_391207.json:
```json
{
    "body": "Attachment [openblas-PRESCOTT.log](tarball://root/attachments/some-uuid/ticket27961/openblas-PRESCOTT.log) by @jhpalmieri created at 2019-06-15 00:51:35",
    "created_at": "2019-06-15T00:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391207",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [openblas-PRESCOTT.log](tarball://root/attachments/some-uuid/ticket27961/openblas-PRESCOTT.log) by @jhpalmieri created at 2019-06-15 00:51:35



---

archive/issue_comments_391208.json:
```json
{
    "body": "My guess is that its a problem with AVX512, not may cpus have it so its not tested much. Also part of the release notes is \"the AVX512 DGEMM kernel has been disabled again due to unsolved problems\", not exactly filling me with confidence that it all works as expected. Can you try:\n\n```\nOPENBLAS_CONFIGURE=\"NO_AVX512=1\" ./sage -p openblas\n```",
    "created_at": "2019-06-15T08:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391208",
    "user": "https://github.com/vbraun"
}
```

My guess is that its a problem with AVX512, not may cpus have it so its not tested much. Also part of the release notes is "the AVX512 DGEMM kernel has been disabled again due to unsolved problems", not exactly filling me with confidence that it all works as expected. Can you try:

```
OPENBLAS_CONFIGURE="NO_AVX512=1" ./sage -p openblas
```



---

archive/issue_comments_391209.json:
```json
{
    "body": "Replying to [comment:25 vbraun]:\n> Can you try:\n> \n> ```\n> OPENBLAS_CONFIGURE=\"NO_AVX512=1\" ./sage -p openblas\n> ```\n\nThat works, all tests pass. `config.h`, in case it's relevant:\n\n```\n#define OS_DARWIN\t1\n#define ARCH_X86_64\t1\n#define C_CLANG\t1\n#define __64BIT__\t1\n#define FUNDERSCORE\t_\n#define PTHREAD_CREATE_FUNC\tpthread_create\n#define BUNDERSCORE\t_\n#define NEEDBUNDERSCORE\t1\n#define HASWELL\n#define L1_CODE_SIZE 32768\n#define L1_CODE_ASSOCIATIVE 8\n#define L1_CODE_LINESIZE 64\n#define L1_DATA_SIZE 32768\n#define L1_DATA_ASSOCIATIVE 8\n#define L1_DATA_LINESIZE 64\n#define L2_SIZE 262144\n#define L2_ASSOCIATIVE 8\n#define L2_LINESIZE 64\n#define ITB_SIZE 2097152\n#define ITB_ASSOCIATIVE 0\n#define ITB_ENTRIES 8\n#define DTB_SIZE 4096\n#define DTB_ASSOCIATIVE 4\n#define DTB_DEFAULT_ENTRIES 64\n#define HAVE_CMOV\n#define HAVE_MMX\n#define HAVE_SSE\n#define HAVE_SSE2\n#define HAVE_SSE3\n#define HAVE_SSSE3\n#define HAVE_SSE4_1\n#define HAVE_SSE4_2\n#define HAVE_AVX\n#define HAVE_AVX2\n#define HAVE_FMA3\n#define HAVE_CFLUSH\n#define NUM_SHAREDCACHE 2\n#define NUM_CORES 8\n#define CORE_HASWELL\n#define CHAR_CORENAME \"HASWELL\"\n#define SLOCAL_BUFFER_SIZE\t24576\n#define DLOCAL_BUFFER_SIZE\t32768\n#define CLOCAL_BUFFER_SIZE\t12288\n#define ZLOCAL_BUFFER_SIZE\t8192\n#define GEMM_MULTITHREAD_THRESHOLD\t4\n```\nNow it's using \"HASWELL\" instead of \"SKYLAKEX\".\n\nBy the way, what should the workflow be? I ran `... ./sage -p openblas` and then `make`. I didn't see any obvious errors, but `make` fails, and in particular Sage doesn't start. Running `./sage -ba` fixes it. This seems like issue !#1 (from the ticket description): something in the Sage library is not getting rebuilt properly.",
    "created_at": "2019-06-17T19:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391209",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:25 vbraun]:
> Can you try:
> 
> ```
> OPENBLAS_CONFIGURE="NO_AVX512=1" ./sage -p openblas
> ```

That works, all tests pass. `config.h`, in case it's relevant:

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define HASWELL
#define L1_CODE_SIZE 32768
#define L1_CODE_ASSOCIATIVE 8
#define L1_CODE_LINESIZE 64
#define L1_DATA_SIZE 32768
#define L1_DATA_ASSOCIATIVE 8
#define L1_DATA_LINESIZE 64
#define L2_SIZE 262144
#define L2_ASSOCIATIVE 8
#define L2_LINESIZE 64
#define ITB_SIZE 2097152
#define ITB_ASSOCIATIVE 0
#define ITB_ENTRIES 8
#define DTB_SIZE 4096
#define DTB_ASSOCIATIVE 4
#define DTB_DEFAULT_ENTRIES 64
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define HAVE_SSE4_2
#define HAVE_AVX
#define HAVE_AVX2
#define HAVE_FMA3
#define HAVE_CFLUSH
#define NUM_SHAREDCACHE 2
#define NUM_CORES 8
#define CORE_HASWELL
#define CHAR_CORENAME "HASWELL"
#define SLOCAL_BUFFER_SIZE	24576
#define DLOCAL_BUFFER_SIZE	32768
#define CLOCAL_BUFFER_SIZE	12288
#define ZLOCAL_BUFFER_SIZE	8192
#define GEMM_MULTITHREAD_THRESHOLD	4
```
Now it's using "HASWELL" instead of "SKYLAKEX".

By the way, what should the workflow be? I ran `... ./sage -p openblas` and then `make`. I didn't see any obvious errors, but `make` fails, and in particular Sage doesn't start. Running `./sage -ba` fixes it. This seems like issue !#1 (from the ticket description): something in the Sage library is not getting rebuilt properly.



---

archive/issue_comments_391210.json:
```json
{
    "body": "I think \"HASWELL\" is correct since AVX512 support is essentially the only new isa\n\nBlas doesn't have any arch-dependent headers so it must be that some binary is linking against libopenblas_haswellp-r0.3.5.dylib instead of libopenblas.dylib. Then when you replace it with libopenblas-whatever-0.3.6.dylib it wont' work any more. On Linux its correct, so thats an OSX special. I've created #28008 to deal with that separate issue.\n\n---\nNew commits:",
    "created_at": "2019-06-17T20:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391210",
    "user": "https://github.com/vbraun"
}
```

I think "HASWELL" is correct since AVX512 support is essentially the only new isa

Blas doesn't have any arch-dependent headers so it must be that some binary is linking against libopenblas_haswellp-r0.3.5.dylib instead of libopenblas.dylib. Then when you replace it with libopenblas-whatever-0.3.6.dylib it wont' work any more. On Linux its correct, so thats an OSX special. I've created #28008 to deal with that separate issue.

---
New commits:



---

archive/issue_comments_391211.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-17T20:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391211",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_391212.json:
```json
{
    "body": "Seems like the safest bet for now.  Would be nice to have but I don't most people using Sage are explicitly dependent on such bleeding-edge features, and they are probably building their own openblas if they do.",
    "created_at": "2019-06-17T21:20:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391212",
    "user": "https://github.com/embray"
}
```

Seems like the safest bet for now.  Would be nice to have but I don't most people using Sage are explicitly dependent on such bleeding-edge features, and they are probably building their own openblas if they do.



---

archive/issue_comments_391213.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-17T21:20:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391213",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_391214.json:
```json
{
    "body": "Changing keywords from \"\" to \"days101 openblas\".",
    "created_at": "2019-06-17T21:20:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391214",
    "user": "https://github.com/embray"
}
```

Changing keywords from "" to "days101 openblas".



---

archive/issue_comments_391215.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-18T22:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27724#issuecomment-391215",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069301.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-18T22:30:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27724",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27724#event-69301"
}
```
