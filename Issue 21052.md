# Issue 21052: speed regression in Poset.canonical_label

Issue created by migration from Trac.

Original creator: mantepse

Original creation time: 2016-08-19 08:58:47

CC:  jmantysalo chapoton jdemeyer mkoeppe tscrim

In 6.9.beta5 I have:

```
sage: p = posets.IntegerPartitions(20)
sage: timeit("p.canonical_label()")
5 loops, best of 3: 180 ms per loop
```

whereas in 7.4.beta1

```
sage: timeit("p.canonical_label()")
5 loops, best of 3: 1.58 s per loop
```



---

Comment by jmantysalo created at 2016-08-19 09:17:44

Can you check canonical label for plain graphs? Are you sure that you don't have Bliss installed in 6.9 but not in 7.4?


---

Comment by mantepse created at 2016-08-19 09:28:57

(no, i haven't installed bliss in either version)

The problem is actually elsewhere:


```
sage: timeit('p._hasse_diagram.canonical_label(algorithm="sage")')
5 loops, best of 3: 93 ms per loop
```


In 7.4, all the time is eaten by

```
sage: timeit("is_package_installed('bliss')")
5 loops, best of 3: 1.37 s per loop
```


I think that `Posets.canonical_label` should also accept the optional argument `algorithm`.


---

Comment by jmantysalo created at 2016-08-19 09:34:12

Replying to [comment:2 mantepse]:
> In 7.4, all the time is eaten by

> {{{
> sage: timeit("is_package_installed('bliss')")
> 5 loops, best of 3: 1.37 s per loop
> }}}

Is the problem `installed_packages()`? On my system it seems to be the problem.

> I think that `Posets.canonical_label` should also accept the optional argument `algorithm`.

True. I can add it, but let's first check what is wrong here.


---

Comment by jmantysalo created at 2016-08-19 09:52:11

I think I got it. It does


```
proc = subprocess.Popen(["pip", "list"], stdout=subprocess.PIPE)
stdout = proc.communicate()[0]
return dict((name.lower(), version) for name,version in PIP_VERSION.findall(stdout))
```


and this is clearly too much for every function call.


---

Comment by jmantysalo created at 2016-08-19 09:54:20

Jeroen is propably interested in this.


---

Comment by jmantysalo created at 2016-08-19 10:36:57

As the problem is now in the ticket #21291 and the keyword is added at #21293 we can close this one.


---

Comment by jmantysalo created at 2016-08-19 10:36:57

Changing status from new to needs_review.


---

Comment by mantepse created at 2016-08-19 10:38:48

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-08-19 11:24:48

Replying to [comment:2 mantepse]:
> {{{
> is_package_installed('bliss')
> }}}

Don't do that. Use the [Easier to ask for forgiveness than permission](https://docs.python.org/3/glossary.html#term-eafp) principle: assume that Bliss is installed and fail gracefully if not.


---

Comment by jdemeyer created at 2016-08-19 11:24:48

Changing status from positive_review to needs_work.


---

Comment by mantepse created at 2016-08-19 11:35:14

So all of these (except the ones in ```package```) are wrong:

```
-*- mode: grep; default-directory: "~/sage-develop/src/sage/" -*-
Grep started at Fri Aug 19 13:31:58

grep -r -nH -e "is_package_installed(" *
databases/cremona.py:827:            elif is_package_installed('database_cremona_ellcurve'):
databases/cremona.py:1676:        if is_package_installed('database_cremona_ellcurve'):
game_theory/normal_form_game.py:1320:            if is_package_installed('lrslib'):
game_theory/normal_form_game.py:1326:            if not is_package_installed('lrslib'):
geometry/polyhedron/base.py:3694:        if not is_package_installed('lrslib'):
graphs/generic_graph.py:7877:            elif is_package_installed("python_igraph"):
graphs/generic_graph.py:20258:             is_package_installed('bliss'))):
graphs/generic_graph.py:20927:             is_package_installed('bliss') and
graphs/graph_generators.py:1199:        if not is_package_installed("buckygen"):
graphs/graph_generators.py:1284:        if not is_package_installed("benzene"):
graphs/graph_generators.py:1437:        if not is_package_installed("plantri"):
graphs/graph_generators.py:1636:        if not is_package_installed("plantri"):
graphs/graph_generators.py:1790:        if not is_package_installed("plantri"):
graphs/lovasz_theta.py:70:    if not is_package_installed('csdp'):
graphs/generators/classical_geometries.py:1292:    if not is_package_installed('gap_packages'):
groups/perm_gps/permgroup.py:193:        if not is_package_installed('gap_packages'):
groups/perm_gps/permgroup.py:1686:            if not is_package_installed('database_gap'):
groups/perm_gps/permgroup.py:1739:            if not is_package_installed('database_gap'):
groups/perm_gps/permgroup.py:4117:        if not is_package_installed('gap_packages'):
groups/generic.py:1407:        if not is_package_installed('database_gap'):
misc/package.py:294:def is_package_installed(package):
misc/package.py:300:        sage: is_package_installed('pari')
misc/package.py:305:        sage: is_package_installed('matplotli')
Übereinstimmungen in Binärdatei misc/package.pyc.
rings/polynomial/multi_polynomial_sequence.py:1432:                if not is_package_installed('fes'):

Grep finished (matches found) at Fri Aug 19 13:31:58
```



---

Comment by jmantysalo created at 2016-08-19 11:53:46

Why can't Sage just check installed packages on startup and make a list to some global variable?


---

Comment by jdemeyer created at 2016-08-19 11:54:36

Replying to [comment:11 jmantysalo]:
> Why can't Sage just check installed packages on startup and make a list to some global variable?

Because that would be very slow, see #21291.


---

Comment by mantepse created at 2016-08-19 11:54:51

Some are possibly OK, for example in `cremona.py`, because they only determine the error message.

However, that's not quite true either: if I'm going to catch an error, I possibly rely on it being thrown quickly...


---

Comment by jdemeyer created at 2016-08-19 11:55:42

Replying to [comment:10 mantepse]:
> So all of these (except the ones in `package`) are wrong:

At least the ones which involve an `OptionalExtension` (like `bliss`) should be replaced by just importing the module.


---

Comment by jmantysalo created at 2016-08-19 11:56:43

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 jmantysalo]:
> > Why can't Sage just check installed packages on startup and make a list to some global variable?
> 
> Because that would be very slow, see #21291.

Too slow to do it once at startup?


---

Comment by mantepse created at 2016-08-19 11:57:11

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 jmantysalo]:
> > Why can't Sage just check installed packages on startup and make a list to some global variable?
> 
> Because that would be very slow, see #21291.

I do not understand this answer.  Compiling the list once does not take very long.  The problem occurs only because sage is doing it over and over again.


---

Comment by mantepse created at 2016-08-19 11:58:11

I do think however that we want to be able to pick up new packages without having to leave sage, don't we?


---

Comment by jdemeyer created at 2016-08-19 12:00:22

Replying to [comment:16 mantepse]:
> Compiling the list once does not take very long.

Compiling the list once takes an extremely long time (almost 2 seconds on my machine).


---

Comment by jmantysalo created at 2016-08-19 12:08:06

Replying to [comment:17 mantepse]:
> I do think however that we want to be able to pick up new packages without having to leave sage, don't we?

I don't think that it is an important feature. Would be nice, yes, but a minor issue.


---

Comment by jmantysalo created at 2016-08-19 12:10:06

Replying to [comment:18 jdemeyer]:

> Compiling the list once takes an extremely long time (almost 2 seconds on my machine).

OK. And there is no way to hook it to package installation?


---

Comment by jmantysalo created at 2016-08-24 07:48:16

FYI Travis: doctesting `_kl_poly(x, y)` takes now about 5 seconds because of this.


---

Comment by chapoton created at 2016-08-26 11:36:26

This is maybe (probably?) the cause of several annoying timeout failures seen in the patchbots, in particular in tutte_polynomial.py


---

Comment by jmantysalo created at 2016-08-26 11:40:53

Could we cache result of `is_package_installed()`? Or maybe result of `pip_installed_packages()` or something like that?


---

Comment by jdemeyer created at 2016-08-26 12:06:56

Replying to [comment:24 jmantysalo]:
> Could we cache result of `is_package_installed()`? Or maybe result of `pip_installed_packages()` or something like that?

All that is irrelevant to this ticket, which is just specifically about `bliss`.


---

Comment by jdemeyer created at 2016-08-26 12:07:34

See #20382 and #21291 for more general discussions.


---

Comment by jdemeyer created at 2016-08-26 12:08:09

Replying to [comment:24 jmantysalo]:
> Could we cache result of `is_package_installed()`?

As I already said in [comment:18], that would not help.


---

Comment by jmantysalo created at 2016-08-26 12:12:08

Replying to [comment:27 jdemeyer]:
> Replying to [comment:24 jmantysalo]:
> > Could we cache result of `is_package_installed()`?
> 
> As I already said in [comment:18], that would not help.

?? If the result is cached, we got only one delay of two seconds. Currently running something like


```
g_list = [g.canonical_label() for g in g_list]
```


is extremely slow. Or maybe I miss something obvious.


---

Comment by jdemeyer created at 2016-08-26 12:18:00

This ticket is super-easy to fix: just apply what I said in [comment:9] instead of coming up with overly-complicated solutions.


---

Comment by jdemeyer created at 2016-08-26 12:19:16

Just do something like:

```
try:
    import sage.graphs.bliss
    have_bliss = True
except ImportError:
    have_bliss = False
```

and use this `have_bliss` variable where needed.

That's it!


---

Comment by chapoton created at 2016-08-26 13:24:33

done, please review
----
New commits:


---

Comment by chapoton created at 2016-08-26 13:24:33

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-08-26 13:28:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-08-26 15:24:18

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-08-26 15:24:18

Could you replace

```
raise ImportError("You must install the 'bliss' package to run this command.")
```

by

```
from sage.misc.package import PackageNotFoundError
raise PackageNotFoundError("bliss")
```

This will give a customized error message.


---

Comment by git created at 2016-08-26 16:20:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-26 16:21:16

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-08-26 16:21:16

done


---

Comment by chapoton created at 2016-08-27 11:13:03

ping ?


---

Comment by jdemeyer created at 2016-08-27 12:17:52

This looks good, but it just needs testing that it works both without and with bliss.


---

Comment by jdemeyer created at 2016-08-27 12:56:28

Let's wait for the patchbot...


---

Comment by chapoton created at 2016-08-28 08:24:04

ok, bot is green. Jeroen ?


---

Comment by jdemeyer created at 2016-08-28 08:31:33

I'll test it now on my computer _with_ bliss installed.


---

Comment by fbissey created at 2016-08-28 08:33:15

Given that this code is very close to the stuff I do in sage-on-gentoo with that file - may be Jeroen has been inspired by something he saw a while back :P - I would put this positive. But since Jeroen wants to try it, I'll let him push the button.


---

Comment by jdemeyer created at 2016-08-28 08:39:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-30 06:46:25

Resolution: fixed
