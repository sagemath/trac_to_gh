# Issue 10831: Update Singular to 3-1-2 or higher

archive/issues_010831.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  zimmerma simonking\n\nKeywords: singular\n\nSingular 3-1-2 fixes a critical bug, cf. #10902. We should update as soon as possible\n\nhttp://www.singular.uni-kl.de/index.php/singular-download.html\n\nIssue created by migration from https://trac.sagemath.org/ticket/10903\n\n",
    "created_at": "2011-03-10T10:49:59Z",
    "labels": [
        "packages: standard",
        "critical",
        "bug"
    ],
    "title": "Update Singular to 3-1-2 or higher",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10831",
    "user": "malb"
}
```
Assignee: tbd

CC:  zimmerma simonking

Keywords: singular

Singular 3-1-2 fixes a critical bug, cf. #10902. We should update as soon as possible

http://www.singular.uni-kl.de/index.php/singular-download.html

Issue created by migration from https://trac.sagemath.org/ticket/10903





---

archive/issue_comments_114725.json:
```json
{
    "body": "Last time I tried libsingular from 3.1.2 didn't play well with sage (sage couldn't build). It is documented somewhere on sage-devel.",
    "created_at": "2011-03-10T18:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114725",
    "user": "fbissey"
}
```

Last time I tried libsingular from 3.1.2 didn't play well with sage (sage couldn't build). It is documented somewhere on sage-devel.



---

archive/issue_comments_114726.json:
```json
{
    "body": "[http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53](http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53)",
    "created_at": "2011-03-10T22:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114726",
    "user": "fbissey"
}
```

[http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53](http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53http://groups.google.com/group/sage-devel/browse_thread/thread/9544eb87400b5e43/e2424823682d7d53?lnk=gst&q=singular+francois#e2424823682d7d53)



---

archive/issue_comments_114727.json:
```json
{
    "body": "sorry for the double pasting the mouse is vintage.",
    "created_at": "2011-03-10T22:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114727",
    "user": "fbissey"
}
```

sorry for the double pasting the mouse is vintage.



---

archive/issue_comments_114728.json:
```json
{
    "body": "Updating singular to at least 3-1-3 (if it's out...) will also help the ARM port, as it's one of the few packages which still give issues with 4.6.2.",
    "created_at": "2011-03-12T18:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114728",
    "user": "Snark"
}
```

Updating singular to at least 3-1-3 (if it's out...) will also help the ARM port, as it's one of the few packages which still give issues with 4.6.2.



---

archive/issue_comments_114729.json:
```json
{
    "body": "Indeed 3-1-3 is out now. Already 3-1-2 adds a lot of functionality for polynomials over the integers which would be very helpful to have in Sage!",
    "created_at": "2011-06-17T21:57:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114729",
    "user": "kedlaya"
}
```

Indeed 3-1-3 is out now. Already 3-1-2 adds a lot of functionality for polynomials over the integers which would be very helpful to have in Sage!



---

archive/issue_comments_114730.json:
```json
{
    "body": "Trying to compile libsingular with this version and trying to link it to sage is on my TODO list. The singular 3-1-3 executable as called by the pexpect interface breaks a few doctest because normalization has been changed.",
    "created_at": "2011-06-17T22:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114730",
    "user": "fbissey"
}
```

Trying to compile libsingular with this version and trying to link it to sage is on my TODO list. The singular 3-1-3 executable as called by the pexpect interface breaks a few doctest because normalization has been changed.



---

archive/issue_comments_114731.json:
```json
{
    "body": "Just FYI, I'm cutting a p10 shortly with a very small fix for Cygwin in it (see #11550), so if someone if making this package, it would be great to base off that.",
    "created_at": "2011-06-28T16:13:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114731",
    "user": "kcrisman"
}
```

Just FYI, I'm cutting a p10 shortly with a very small fix for Cygwin in it (see #11550), so if someone if making this package, it would be great to base off that.



---

archive/issue_comments_114732.json:
```json
{
    "body": "Replying to [comment:5 Snark]:\n> Updating singular to at least 3-1-3 (if it's out...) will also help the ARM port, as it's one of the few packages which still give issues with 4.6.2.\n\nCf. #10810.\n\n----\n\nIf someone touches the Singular spkg, please also add a patch for #11645 in case it should then still be necessary. (I've submitted one upstream, see http://www.singular.uni-kl.de:8002/trac/ticket/352#comment:15).",
    "created_at": "2011-08-06T19:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114732",
    "user": "leif"
}
```

Replying to [comment:5 Snark]:
> Updating singular to at least 3-1-3 (if it's out...) will also help the ARM port, as it's one of the few packages which still give issues with 4.6.2.

Cf. #10810.

----

If someone touches the Singular spkg, please also add a patch for #11645 in case it should then still be necessary. (I've submitted one upstream, see http://www.singular.uni-kl.de:8002/trac/ticket/352#comment:15).



---

archive/issue_comments_114733.json:
```json
{
    "body": "Changing keywords from \"singular\" to \"singular SageDays34\".",
    "created_at": "2011-08-09T14:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114733",
    "user": "leif"
}
```

Changing keywords from "singular" to "singular SageDays34".



---

archive/issue_comments_114734.json:
```json
{
    "body": "Replying to [comment:8 kcrisman]:\n> Just FYI, I'm cutting a p10 shortly with a very small fix for Cygwin in it (see #11550), so if someone if making this package, it would be great to base off that.\n\nFWIW, the Singular spkg from #11550 will probably become a p12, since #11663 meanwhile provides a p11 (which Karl-Dieter's will have to get rebased on again).\n\nI'll then perhaps provide a p13 based on that fixing #11645. :)\n\nAnyway, I guess upgrading Sage's Singular will be attempted during the [Sage/Singular Days in Kaiserslautern](http://groups.google.com/group/sage-devel/browse_thread/thread/cca0edad4b6a41aa/1f872997a159304e) at the end of September, so we have some time until then...",
    "created_at": "2011-08-09T14:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114734",
    "user": "leif"
}
```

Replying to [comment:8 kcrisman]:
> Just FYI, I'm cutting a p10 shortly with a very small fix for Cygwin in it (see #11550), so if someone if making this package, it would be great to base off that.

FWIW, the Singular spkg from #11550 will probably become a p12, since #11663 meanwhile provides a p11 (which Karl-Dieter's will have to get rebased on again).

I'll then perhaps provide a p13 based on that fixing #11645. :)

Anyway, I guess upgrading Sage's Singular will be attempted during the [Sage/Singular Days in Kaiserslautern](http://groups.google.com/group/sage-devel/browse_thread/thread/cca0edad4b6a41aa/1f872997a159304e) at the end of September, so we have some time until then...



---

archive/issue_comments_114735.json:
```json
{
    "body": "Changing keywords from \"singular SageDays34\" to \"singular SageDays34 sd34\".",
    "created_at": "2011-09-01T15:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114735",
    "user": "leif"
}
```

Changing keywords from "singular SageDays34" to "singular SageDays34 sd34".



---

archive/issue_comments_114736.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2011-09-26T18:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114736",
    "user": "malb"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_114737.json:
```json
{
    "body": "I haven't run any tests yet and the changes in the SPKG are not committed (because our patches will probably be accepted upstream before 3-1-4 comes out).",
    "created_at": "2011-09-26T18:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114737",
    "user": "malb"
}
```

I haven't run any tests yet and the changes in the SPKG are not committed (because our patches will probably be accepted upstream before 3-1-4 comes out).



---

archive/issue_comments_114738.json:
```json
{
    "body": "Replying to [comment:12 malb]:\n> I haven't run any tests yet and the changes in the SPKG are not committed (because our patches will probably be accepted upstream before 3-1-4 comes out).\n\nThe spkg name should contain the svn version you are using.\n\n\n\n\nRegarding the patch to `module_list.py`:\n\nPlease don't randomly add all libraries any extension module using Singular might also use to `singular_libs`.",
    "created_at": "2011-09-26T19:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114738",
    "user": "leif"
}
```

Replying to [comment:12 malb]:
> I haven't run any tests yet and the changes in the SPKG are not committed (because our patches will probably be accepted upstream before 3-1-4 comes out).

The spkg name should contain the svn version you are using.




Regarding the patch to `module_list.py`:

Please don't randomly add all libraries any extension module using Singular might also use to `singular_libs`.



---

archive/issue_comments_114739.json:
```json
{
    "body": "doctests hang here:\n\n\n```\nTrying:\n    R = PolynomialRing(ZZ, Integer(5), order='lex', names=('x', 'y', 'a', 'b', 'u',)); (x, y, a, b, u,) = R._first_ngens(5)###line 4461:_sage_    >>> R.<x,y,a,b,u>=PolynomialRing(ZZ, 5, order='lex')\n```\n\n\nthey also crash in other places. Thus, more fun ahead.",
    "created_at": "2011-09-26T19:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114739",
    "user": "malb"
}
```

doctests hang here:


```
Trying:
    R = PolynomialRing(ZZ, Integer(5), order='lex', names=('x', 'y', 'a', 'b', 'u',)); (x, y, a, b, u,) = R._first_ngens(5)###line 4461:_sage_    >>> R.<x,y,a,b,u>=PolynomialRing(ZZ, 5, order='lex')
```


they also crash in other places. Thus, more fun ahead.



---

archive/issue_comments_114740.json:
```json
{
    "body": "Replying to [comment:15 malb]:\n> doctests hang here:\n> \n\n```\nTrying:\n    R = PolynomialRing(ZZ, Integer(5), order='lex', names=('x', 'y', 'a', 'b', 'u',)); (x, y, a, b, u,) = R._first_ngens(5)###line 4461:_sage_    >>> R.<x,y,a,b,u>=PolynomialRing(ZZ, 5, order='lex')\n```\n\n> \n> they also crash in other places. Thus, more fun ahead.\n\nHow about starting with 3-1-3 and some important upstream patches?",
    "created_at": "2011-09-26T20:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114740",
    "user": "leif"
}
```

Replying to [comment:15 malb]:
> doctests hang here:
> 

```
Trying:
    R = PolynomialRing(ZZ, Integer(5), order='lex', names=('x', 'y', 'a', 'b', 'u',)); (x, y, a, b, u,) = R._first_ngens(5)###line 4461:_sage_    >>> R.<x,y,a,b,u>=PolynomialRing(ZZ, 5, order='lex')
```

> 
> they also crash in other places. Thus, more fun ahead.

How about starting with 3-1-3 and some important upstream patches?



---

archive/issue_comments_114741.json:
```json
{
    "body": "I'm in Kaiserslautern right now, so I have direct access to the Singular developers. Hence, actually fixing the issues seems like the order of the day.",
    "created_at": "2011-09-26T21:04:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114741",
    "user": "malb"
}
```

I'm in Kaiserslautern right now, so I have direct access to the Singular developers. Hence, actually fixing the issues seems like the order of the day.



---

archive/issue_comments_114742.json:
```json
{
    "body": "With\n\n\n```\n$ hg qap\ntrac_11339_refcount_singular_rings.patch\ntrac_11339_refcount_singular_polynomials.patch\n10903_singular-3-1-4.patch\n```\n\n\nI currently get these doctest failures.\n\n\n```\nsage -t  \"devel/sage-main/sage/rings/polynomial/polynomial_element.pyx\"\nsage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_ideal.py\"\nsage -t  \"devel/sage-main/sage/rings/polynomial/toy_d_basis.py\"\nsage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_sequence.py\"\nsage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_element.py\"\nsage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx\"\n```\n",
    "created_at": "2011-09-27T13:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114742",
    "user": "malb"
}
```

With


```
$ hg qap
trac_11339_refcount_singular_rings.patch
trac_11339_refcount_singular_polynomials.patch
10903_singular-3-1-4.patch
```


I currently get these doctest failures.


```
sage -t  "devel/sage-main/sage/rings/polynomial/polynomial_element.pyx"
sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_ideal.py"
sage -t  "devel/sage-main/sage/rings/polynomial/toy_d_basis.py"
sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_sequence.py"
sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_element.py"
sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx"
```




---

archive/issue_comments_114743.json:
```json
{
    "body": "With the updated SPKG & patch I get:\n\n* `sage -t  \"devel/sage-main/sage/rings/polynomial/polynomial_element.pyx\"`\n\nNumerical noise, nothing serious\n\n* `sage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_ideal.py\"`\n\ncrash\n  \n* `sage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_sequence.py\"`\n\ncrash\n\n* `sage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_element.py\"`\n\n  {{{\n  sage: f=(a*x-1)*((a+1)*y-1); f\nExpected:\n    -x*y + (-a)*x + (-a - 1)*y + 1\nGot:\n    (a^2 + a)*x*y + (-a)*x + (-a - 1)*y + 1\n   }}}\n\n\n* `sage -t  \"devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx\"`\n\nFactorisation over number fields goes horribly wrong",
    "created_at": "2011-09-27T16:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114743",
    "user": "malb"
}
```

With the updated SPKG & patch I get:

* `sage -t  "devel/sage-main/sage/rings/polynomial/polynomial_element.pyx"`

Numerical noise, nothing serious

* `sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_ideal.py"`

crash
  
* `sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_sequence.py"`

crash

* `sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_element.py"`

  {{{
  sage: f=(a*x-1)*((a+1)*y-1); f
Expected:
    -x*y + (-a)*x + (-a - 1)*y + 1
Got:
    (a^2 + a)*x*y + (-a)*x + (-a - 1)*y + 1
   }}}


* `sage -t  "devel/sage-main/sage/rings/polynomial/multi_polynomial_libsingular.pyx"`

Factorisation over number fields goes horribly wrong



---

archive/issue_comments_114744.json:
```json
{
    "body": "Hans created a new branch of Singular, where the algebraic extensions are reverted to the old implementation. Using this branch, available in SPKG form at:\n\n   http://sage.math.washington.edu/home/malb/spkgs/singular-3-1-3.svn-algnumbers.spkg\n\nthe crashes seem to go away (at least for everything in sage/rings).",
    "created_at": "2011-09-28T18:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114744",
    "user": "malb"
}
```

Hans created a new branch of Singular, where the algebraic extensions are reverted to the old implementation. Using this branch, available in SPKG form at:

   http://sage.math.washington.edu/home/malb/spkgs/singular-3-1-3.svn-algnumbers.spkg

the crashes seem to go away (at least for everything in sage/rings).



---

archive/issue_comments_114745.json:
```json
{
    "body": "Output of `make ptestlong` with this patch and #11339 applied:\n\n\n```\nsage -t  -long -force_lib devel/sage/sage/misc/sageinspect.py # 1 doctests failed\nsage -t  -long -force_lib devel/sage/sage/tests/cmdline.py # 1 doctests failed\nsage -t  -long -force_lib devel/sage/sage/interfaces/singular.py # 1 doctests failed\nsage -t  -long -force_lib devel/sage/sage/crypto/mq/sr.py # 0 doctests failed\nsage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_generic.py # 0 doctests failed\nsage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_curve_isogeny.py # 0 doctests failed\nsage -t  -long -force_lib devel/sage/sage/schemes/plane_conics/con_field.py # 1 doctests failed\nsage -t  -long -force_lib devel/sage/sage/schemes/plane_conics/con_finite_field.py # 0 doctests failed\nsage -t  -long -force_lib devel/sage/sage/schemes/generic/algebraic_scheme.py # 0 doctests failed\n\n```\n\n\ni.e., crashes.",
    "created_at": "2011-09-28T19:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114745",
    "user": "malb"
}
```

Output of `make ptestlong` with this patch and #11339 applied:


```
sage -t  -long -force_lib devel/sage/sage/misc/sageinspect.py # 1 doctests failed
sage -t  -long -force_lib devel/sage/sage/tests/cmdline.py # 1 doctests failed
sage -t  -long -force_lib devel/sage/sage/interfaces/singular.py # 1 doctests failed
sage -t  -long -force_lib devel/sage/sage/crypto/mq/sr.py # 0 doctests failed
sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_generic.py # 0 doctests failed
sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/ell_curve_isogeny.py # 0 doctests failed
sage -t  -long -force_lib devel/sage/sage/schemes/plane_conics/con_field.py # 1 doctests failed
sage -t  -long -force_lib devel/sage/sage/schemes/plane_conics/con_finite_field.py # 0 doctests failed
sage -t  -long -force_lib devel/sage/sage/schemes/generic/algebraic_scheme.py # 0 doctests failed

```


i.e., crashes.



---

archive/issue_comments_114746.json:
```json
{
    "body": "I just updated the spkg such that `SAGE_DEBUG=\"yes\"` will build Singular with debugging enabled (internal consistency checks, asserts etc.)",
    "created_at": "2011-09-28T20:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114746",
    "user": "malb"
}
```

I just updated the spkg such that `SAGE_DEBUG="yes"` will build Singular with debugging enabled (internal consistency checks, asserts etc.)



---

archive/issue_comments_114747.json:
```json
{
    "body": "Alright,\n\non my computer with \n\n\n```\ntrac_11339_refcount_singular_rings.patch\ntrac_11339_refcount_singular_polynomials.patch\n10903_singular-3-1-4.patch\n```\n\n\nI'm down to these two:\n\n\n```\n$ sage -t -long -force_lib \"devel/sage/sage/schemes/plane_conics/con_finite_field.py\"\n    sage: assert all([C.defining_polynomial()(Sequence(C.has_rational_point(point = True)[1])) == 0 for C in c[r::5]]) # long time: 1.6 seconds\nException raised:\n...\nTypeError: Coordinates [4, 4, 1] do not define a point on Projective Conic Curve over Finite Field of size 5 defined by x*y + x*z + y*z + z^2\n```\n\n\n\n```\nsage -t -long -force_lib \"devel/sage/sage/schemes/generic/algebraic_scheme.py\"\n    sage: A.subscheme([x]) + A.subscheme([y^2 - (x^3+1)])\nExpected:\n    Closed subscheme of Affine Space of dimension 2 over Rational Field defined by:\n    -x^4 + x*y^2 - x\nGot:\n    Closed subscheme of Affine Space of dimension 2 over Rational Field defined by:\n      x^4 - x*y^2 + x\n```\n\n\nThe latter doesn't look like a bug but an improvement actually.",
    "created_at": "2011-09-29T10:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114747",
    "user": "malb"
}
```

Alright,

on my computer with 


```
trac_11339_refcount_singular_rings.patch
trac_11339_refcount_singular_polynomials.patch
10903_singular-3-1-4.patch
```


I'm down to these two:


```
$ sage -t -long -force_lib "devel/sage/sage/schemes/plane_conics/con_finite_field.py"
    sage: assert all([C.defining_polynomial()(Sequence(C.has_rational_point(point = True)[1])) == 0 for C in c[r::5]]) # long time: 1.6 seconds
Exception raised:
...
TypeError: Coordinates [4, 4, 1] do not define a point on Projective Conic Curve over Finite Field of size 5 defined by x*y + x*z + y*z + z^2
```



```
sage -t -long -force_lib "devel/sage/sage/schemes/generic/algebraic_scheme.py"
    sage: A.subscheme([x]) + A.subscheme([y^2 - (x^3+1)])
Expected:
    Closed subscheme of Affine Space of dimension 2 over Rational Field defined by:
    -x^4 + x*y^2 - x
Got:
    Closed subscheme of Affine Space of dimension 2 over Rational Field defined by:
      x^4 - x*y^2 + x
```


The latter doesn't look like a bug but an improvement actually.



---

archive/issue_comments_114748.json:
```json
{
    "body": "on sage.math\n\n\n```\nsage -t  -long -force_lib devel/sage/sage/crypto/mq/sr.py\n```\n\n\nalso crashes.",
    "created_at": "2011-09-29T10:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114748",
    "user": "malb"
}
```

on sage.math


```
sage -t  -long -force_lib devel/sage/sage/crypto/mq/sr.py
```


also crashes.



---

archive/issue_comments_114749.json:
```json
{
    "body": "Martin, good, you are making progress!\n\nPaul",
    "created_at": "2011-09-29T10:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114749",
    "user": "zimmerma"
}
```

Martin, good, you are making progress!

Paul



---

archive/issue_comments_114750.json:
```json
{
    "body": "make ptestlong passes on sage.math! However, it's likely that different people will see different crashes/bugs on different machines (I know that Volker has a different one on his machine). The reason is: the garbage collector may randomly change the currRing (because of #11339). The fix is to add rChangeRing() before whichever Singular function is called and crashes. As far as I understand it, there shouldn't be a Python functionc all between rChangeRing() and the function for which it is done, because those could trigger the gc.",
    "created_at": "2011-09-29T14:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114750",
    "user": "malb"
}
```

make ptestlong passes on sage.math! However, it's likely that different people will see different crashes/bugs on different machines (I know that Volker has a different one on his machine). The reason is: the garbage collector may randomly change the currRing (because of #11339). The fix is to add rChangeRing() before whichever Singular function is called and crashes. As far as I understand it, there shouldn't be a Python functionc all between rChangeRing() and the function for which it is done, because those could trigger the gc.



---

archive/issue_comments_114751.json:
```json
{
    "body": "SPKG doesn't build on bsd. Any suggestions?\n\n\n```\ng++   -o libsingular.so \\\n        iparith.o mpsr_Tok.o claptmpl.o \\\n        grammar.o scanner.o attrib.o blackbox.o eigenval_ip.o extra.o fehelp.o feOpt.o ipassign.o ipconv.o ipid.o iplib.o ipprint.o ipshell.o newstruct.o lists.o sdb.o fglm.o interpolation.o silink.o ssiLink.o subexpr.o janet.o wrapper.o libparse.o sing_win.o gms.o pcv.o maps_ip.o walk.o walk_ip.o cntrlc.o misc_ip.o calcSVD.o pipeLink.o Minor.o MinorProcessor.o MinorInterface.o bigintm.o pyobject_setup.o bbcone.o bbfan.o denom_list.o minpoly.o  slInit_Static.o mpsr_Put.o mpsr_PutPoly.o mpsr_GetPoly.o mpsr_sl.o mpsr_Get.o mpsr_GetMisc.o mpsr_Error.o ndbm.o sing_dbm.o -lkernel -L../kernel -L../factory -L../libfac -L/Users/malb/sage-4.7.2.alpha3/local/lib -lsingfac -lsingcf -lntl -lreadline -lgmp -lomalloc\nUndefined symbols:\n  \"_main\", referenced from:\n      __start in crt1.o\nld: symbol(s) not found\n```\n",
    "created_at": "2011-09-29T16:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114751",
    "user": "malb"
}
```

SPKG doesn't build on bsd. Any suggestions?


```
g++   -o libsingular.so \
        iparith.o mpsr_Tok.o claptmpl.o \
        grammar.o scanner.o attrib.o blackbox.o eigenval_ip.o extra.o fehelp.o feOpt.o ipassign.o ipconv.o ipid.o iplib.o ipprint.o ipshell.o newstruct.o lists.o sdb.o fglm.o interpolation.o silink.o ssiLink.o subexpr.o janet.o wrapper.o libparse.o sing_win.o gms.o pcv.o maps_ip.o walk.o walk_ip.o cntrlc.o misc_ip.o calcSVD.o pipeLink.o Minor.o MinorProcessor.o MinorInterface.o bigintm.o pyobject_setup.o bbcone.o bbfan.o denom_list.o minpoly.o  slInit_Static.o mpsr_Put.o mpsr_PutPoly.o mpsr_GetPoly.o mpsr_sl.o mpsr_Get.o mpsr_GetMisc.o mpsr_Error.o ndbm.o sing_dbm.o -lkernel -L../kernel -L../factory -L../libfac -L/Users/malb/sage-4.7.2.alpha3/local/lib -lsingfac -lsingcf -lntl -lreadline -lgmp -lomalloc
Undefined symbols:
  "_main", referenced from:
      __start in crt1.o
ld: symbol(s) not found
```




---

archive/issue_comments_114752.json:
```json
{
    "body": "The reason is that \n\n\n```\nifeq ($(SINGUNAME),ix86Mac-darwin) \n...\nendif\n```\n\n\ndoesn't apply any more, but x86_64Mac-darwin is now returned by singuname.sh",
    "created_at": "2011-09-29T17:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114752",
    "user": "malb"
}
```

The reason is that 


```
ifeq ($(SINGUNAME),ix86Mac-darwin) 
...
endif
```


doesn't apply any more, but x86_64Mac-darwin is now returned by singuname.sh



---

archive/issue_comments_114753.json:
```json
{
    "body": "Has anyone tried building the SPKG on amd64? Here the build works for x86 but on amd64 I get\n\n\n```\nmake install in Singular\nmake![2]: Entering directory `/storage/sage/sage-4.7.2.alpha2/spkg/build/singular-3-1-3.svn-algnumbers/src/Singular'\nsvnversion >svnver\n/bin/sh: svnversion: not found\nmake![2]: *** [svnver] Error 127\nmake![2]: Leaving directory `/storage/sage/sage-4.7.2.alpha2/spkg/build/singular-3-1-3.svn-algnumbers/src/Singular'\nmake![1]: *** [install] Error 1\nmake![1]: Leaving directory `/storage/sage/sage-4.7.2.alpha2/spkg/build/singular-3-1-3.svn-algnumbers/src'\nmake: *** ![/storage/sage/sage-4.7.2.alpha2/local/bin/Singular-3-1-3] Error 2\nUnable to build Singular.\n```\n",
    "created_at": "2011-09-29T18:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114753",
    "user": "strogdon"
}
```

Has anyone tried building the SPKG on amd64? Here the build works for x86 but on amd64 I get


```
make install in Singular
make![2]: Entering directory `/storage/sage/sage-4.7.2.alpha2/spkg/build/singular-3-1-3.svn-algnumbers/src/Singular'
svnversion >svnver
/bin/sh: svnversion: not found
make![2]: *** [svnver] Error 127
make![2]: Leaving directory `/storage/sage/sage-4.7.2.alpha2/spkg/build/singular-3-1-3.svn-algnumbers/src/Singular'
make![1]: *** [install] Error 1
make![1]: Leaving directory `/storage/sage/sage-4.7.2.alpha2/spkg/build/singular-3-1-3.svn-algnumbers/src'
make: *** ![/storage/sage/sage-4.7.2.alpha2/local/bin/Singular-3-1-3] Error 2
Unable to build Singular.
```




---

archive/issue_comments_114754.json:
```json
{
    "body": "Replying to [comment:32 strogdon]:\n\n> Has anyone tried building the SPKG on amd64? Here the build works for x86 but on amd64 I get\nLet me first install subversion and then try again!",
    "created_at": "2011-09-29T18:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114754",
    "user": "strogdon"
}
```

Replying to [comment:32 strogdon]:

> Has anyone tried building the SPKG on amd64? Here the build works for x86 but on amd64 I get
Let me first install subversion and then try again!



---

archive/issue_comments_114755.json:
```json
{
    "body": "the svnversion business should be fixed by the new SPKG:\n\n   http://sage.math.washington.edu/home/malb/spkgs/singular-3-1-3-3.spkg",
    "created_at": "2011-09-29T21:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114755",
    "user": "malb"
}
```

the svnversion business should be fixed by the new SPKG:

   http://sage.math.washington.edu/home/malb/spkgs/singular-3-1-3-3.spkg



---

archive/issue_comments_114756.json:
```json
{
    "body": "Open issues:\n\n* #11339 some doctests fail\n* testing on more architectures\n* doesn't build on bsd.math\n* SPKG has changed which aren't checked in\n\nPS: I won't be able to work on this over the next few days, so happy hacking :)",
    "created_at": "2011-09-29T21:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114756",
    "user": "malb"
}
```

Open issues:

* #11339 some doctests fail
* testing on more architectures
* doesn't build on bsd.math
* SPKG has changed which aren't checked in

PS: I won't be able to work on this over the next few days, so happy hacking :)



---

archive/issue_comments_114757.json:
```json
{
    "body": "cf. http://groups.google.com/group/libsingular-devel/browse_thread/thread/147d5f445b609209",
    "created_at": "2011-09-29T21:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114757",
    "user": "malb"
}
```

cf. http://groups.google.com/group/libsingular-devel/browse_thread/thread/147d5f445b609209



---

archive/issue_comments_114758.json:
```json
{
    "body": "Martin,\nnow I managed to compile the Singular spkg, but when starting Sage I get:\n\n```\n--> 512     from sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular\n    513     if m.integral_domain.is_IntegralDomain(base_ring):\n    514         if n < 1:\n\nImportError: /localdisk/tmp/install/sage/local/lib/python2.6/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so: undefined symbol: _Z12pTotaldegreeP8spolyrecP9sip_sring\nError importing ipy_profile_sage - perhaps you should run %upgrade?\nWARNING: Loading of ipy_profile_sage failed.\n```\n\nShould I have imported first the two patches?\n\nPaul",
    "created_at": "2011-09-30T06:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114758",
    "user": "zimmerma"
}
```

Martin,
now I managed to compile the Singular spkg, but when starting Sage I get:

```
--> 512     from sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular
    513     if m.integral_domain.is_IntegralDomain(base_ring):
    514         if n < 1:

ImportError: /localdisk/tmp/install/sage/local/lib/python2.6/site-packages/sage/rings/polynomial/multi_polynomial_libsingular.so: undefined symbol: _Z12pTotaldegreeP8spolyrecP9sip_sring
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.
```

Should I have imported first the two patches?

Paul



---

archive/issue_comments_114759.json:
```json
{
    "body": "Paul, do you have these patches applied\n\n\n```\ntrac_11339_refcount_singular_rings.patch\ntrac_11339_refcount_singular_polynomials.patch\n10903_singular-3-1-4.patch\ntrac_10903_singular-fixes.patch\n```\n\n\nand sage -b succeeded (after you installed the new SPKG)?",
    "created_at": "2011-09-30T08:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114759",
    "user": "malb"
}
```

Paul, do you have these patches applied


```
trac_11339_refcount_singular_rings.patch
trac_11339_refcount_singular_polynomials.patch
10903_singular-3-1-4.patch
trac_10903_singular-fixes.patch
```


and sage -b succeeded (after you installed the new SPKG)?



---

archive/issue_comments_114760.json:
```json
{
    "body": "no, I only applied the first two patches (from #11339) since the description of that ticket\n(#10903) says to first install the spkg, then to apply the patches. Should I first apply all\npatches?\n\nPaul",
    "created_at": "2011-09-30T08:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114760",
    "user": "zimmerma"
}
```

no, I only applied the first two patches (from #11339) since the description of that ticket
(#10903) says to first install the spkg, then to apply the patches. Should I first apply all
patches?

Paul



---

archive/issue_comments_114761.json:
```json
{
    "body": "You'll have to \n* install the SPKG, \n* apply the four patches\n\n```\ntrac_11339_refcount_singular_rings.patch\ntrac_11339_refcount_singular_polynomials.patch\n10903_singular-3-1-4.patch\ntrac_10903_singular-fixes.patch\n```\n\n* run `sage -b`\n\nSorry for the confusion.",
    "created_at": "2011-09-30T08:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114761",
    "user": "malb"
}
```

You'll have to 
* install the SPKG, 
* apply the four patches

```
trac_11339_refcount_singular_rings.patch
trac_11339_refcount_singular_polynomials.patch
10903_singular-3-1-4.patch
trac_10903_singular-fixes.patch
```

* run `sage -b`

Sorry for the confusion.



---

archive/issue_comments_114762.json:
```json
{
    "body": "I upgraded the spkg with the OSX compile fixes. I only replaced the `src/` directory with the new upstream package, I haven't compiled it on OSX. The spkg still has some not-yet-checked-in changes.",
    "created_at": "2011-10-01T21:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114762",
    "user": "vbraun"
}
```

I upgraded the spkg with the OSX compile fixes. I only replaced the `src/` directory with the new upstream package, I haven't compiled it on OSX. The spkg still has some not-yet-checked-in changes.



---

archive/issue_comments_114763.json:
```json
{
    "body": "The rules for using/setting `currRing` when calling libSingular are:\n\n* The Sage library Python code should never make any assumptions about `currRing`.\n* `currRing` can only be assumed to stay defined within pure C/Cython code.\n\nThis is particularly important because the garbage collector can run between any two Python instructions, but not within C/Cython!\n\nIn order to identify code where we forget to set `currRing`, I implemented a function `poison_currRing()` in `sage.libs.singular.singular` that will set `currRing` to NULL, triggering a segfault if we forget to set it back to a meaningful value before calling libSingular. Using the Python debugger hook, this function can be called between each Python command (but not within Cython code). \n\nIt can be globally enabled by uncommenting the lines\n\n```\n### Debugging for Singular, see trac #10903\nfrom sage.libs.singular.ring import poison_currRing\nsys.settrace(poison_currRing)\n```\n\nat the very end of `sage/all.py`.\n\nUsing this code, I identified and fixed various places in the Sage library of the form\n\n```python\n  rChangeCurrRing(_ring)\n  self.parent().some_python_method()\n  libSingular_func()\n```\n\nNote that calling some python method in-between exits Cython and allows Python to run the garbage collector etc! Not only do you exit Cython when you return from your Cython function, but also if you call Python in-between.\n\nI also ran into an issue where code uses iteritems() to iterate over `locals()`, `globals()`, or dictionaries returned by `gc.get_referrers()`. This can potentially raise a `RuntimeError` if those dictionaries change during the iteration. Hooking into the python debugger loop is a good way of triggering precisely that. This also happens in the `PolyBoRi` Python interface, this is now fixed upstream at https://sourceforge.net/tracker/?func=detail&aid=3416946&group_id=210499&atid=1013986\n\nWith the attached patch, I can run the whole Sage testsuite without errors while continuosly poisoning `currRing`. If you do not patch `PolyBoRi`, you get some otherwise harmless errors from it but no segfaults. Note that the patch does not enable the poisoning by default. I am quite sure that the patch fixes all remaining Sage/Singular segfault issues. Please give it a try!",
    "created_at": "2011-10-01T22:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114763",
    "user": "vbraun"
}
```

The rules for using/setting `currRing` when calling libSingular are:

* The Sage library Python code should never make any assumptions about `currRing`.
* `currRing` can only be assumed to stay defined within pure C/Cython code.

This is particularly important because the garbage collector can run between any two Python instructions, but not within C/Cython!

In order to identify code where we forget to set `currRing`, I implemented a function `poison_currRing()` in `sage.libs.singular.singular` that will set `currRing` to NULL, triggering a segfault if we forget to set it back to a meaningful value before calling libSingular. Using the Python debugger hook, this function can be called between each Python command (but not within Cython code). 

It can be globally enabled by uncommenting the lines

```
### Debugging for Singular, see trac #10903
from sage.libs.singular.ring import poison_currRing
sys.settrace(poison_currRing)
```

at the very end of `sage/all.py`.

Using this code, I identified and fixed various places in the Sage library of the form

```python
  rChangeCurrRing(_ring)
  self.parent().some_python_method()
  libSingular_func()
```

Note that calling some python method in-between exits Cython and allows Python to run the garbage collector etc! Not only do you exit Cython when you return from your Cython function, but also if you call Python in-between.

I also ran into an issue where code uses iteritems() to iterate over `locals()`, `globals()`, or dictionaries returned by `gc.get_referrers()`. This can potentially raise a `RuntimeError` if those dictionaries change during the iteration. Hooking into the python debugger loop is a good way of triggering precisely that. This also happens in the `PolyBoRi` Python interface, this is now fixed upstream at https://sourceforge.net/tracker/?func=detail&aid=3416946&group_id=210499&atid=1013986

With the attached patch, I can run the whole Sage testsuite without errors while continuosly poisoning `currRing`. If you do not patch `PolyBoRi`, you get some otherwise harmless errors from it but no segfaults. Note that the patch does not enable the poisoning by default. I am quite sure that the patch fixes all remaining Sage/Singular segfault issues. Please give it a try!



---

archive/issue_comments_114764.json:
```json
{
    "body": "Updated patch",
    "created_at": "2011-10-01T22:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114764",
    "user": "vbraun"
}
```

Updated patch



---

archive/issue_comments_114765.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-10-01T22:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114765",
    "user": "vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_114766.json:
```json
{
    "body": "Attachment [trac_10903_singular-fixes.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_singular-fixes.patch) by vbraun created at 2011-10-01 22:17:10",
    "created_at": "2011-10-01T22:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114766",
    "user": "vbraun"
}
```

Attachment [trac_10903_singular-fixes.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_singular-fixes.patch) by vbraun created at 2011-10-01 22:17:10



---

archive/issue_comments_114767.json:
```json
{
    "body": "[attachment:10903_singular-3-1-4.patch] still **needs work** w.r.t. `module_list.py`; I don't know whether all changes for Singular version 3-1-4 (svn) equally apply to 3-1-3-3. The name of the patch should change anyway if we upgrade to the stable version, i.e., (currently) 3-1-3-X.\n\nIf this spkg is to get into Sage 4.7.2, the linker issue (cf. #11769) also has to be fixed here. (Otherwise I'll provide a Singular 3-1-1-4.p14 spkg fixing just this.)\n\nThere are other issues which may already be fixed by the new version, or could be fixed by incorporating upstream patches and / or making changes to the Sage library; see comments above (or search for other Singular-related tickets in case I didn't add references to all of them here... ;-) ).\n\n\n\n\nIt would be much less confusing if everybody -- at least those significantly -- touching the spkg (i.e., adding changes, especially after *someone else* made such) bumped the patch level; since we apply patches to the vanilla upstream sources, there should (at least) be a p0 patch level anyway. (This applies to other spkgs as well by the way. It doesn't make sense to have many different spkgs with the exact same name floating around, even if md5sums are given, which in general isn't bad, independent of the former.)",
    "created_at": "2011-10-02T01:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114767",
    "user": "leif"
}
```

[attachment:10903_singular-3-1-4.patch] still **needs work** w.r.t. `module_list.py`; I don't know whether all changes for Singular version 3-1-4 (svn) equally apply to 3-1-3-3. The name of the patch should change anyway if we upgrade to the stable version, i.e., (currently) 3-1-3-X.

If this spkg is to get into Sage 4.7.2, the linker issue (cf. #11769) also has to be fixed here. (Otherwise I'll provide a Singular 3-1-1-4.p14 spkg fixing just this.)

There are other issues which may already be fixed by the new version, or could be fixed by incorporating upstream patches and / or making changes to the Sage library; see comments above (or search for other Singular-related tickets in case I didn't add references to all of them here... ;-) ).




It would be much less confusing if everybody -- at least those significantly -- touching the spkg (i.e., adding changes, especially after *someone else* made such) bumped the patch level; since we apply patches to the vanilla upstream sources, there should (at least) be a p0 patch level anyway. (This applies to other spkgs as well by the way. It doesn't make sense to have many different spkgs with the exact same name floating around, even if md5sums are given, which in general isn't bad, independent of the former.)



---

archive/issue_comments_114768.json:
```json
{
    "body": "I'm against bikeshedding `module_list.py` any further. The next version of Singular will split into multiple libraries and any effort trying to minimize the number of linked libraries now is going to be wasted.\n\nAs far as naming goes, Martin called the patch 3-1-4 before we knew that the next version would be 3-1-3-3. He should rename the path when he gets back on Monday but thats just a trivial change. I reviewed his patch and hereby give it positive review.\n\nThe `-ldl` issue #11769 is fixed.\n\nAll we need for this ticket is\n* review my patch\n* check that the spkg builds on OSX and Solaris",
    "created_at": "2011-10-02T09:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114768",
    "user": "vbraun"
}
```

I'm against bikeshedding `module_list.py` any further. The next version of Singular will split into multiple libraries and any effort trying to minimize the number of linked libraries now is going to be wasted.

As far as naming goes, Martin called the patch 3-1-4 before we knew that the next version would be 3-1-3-3. He should rename the path when he gets back on Monday but thats just a trivial change. I reviewed his patch and hereby give it positive review.

The `-ldl` issue #11769 is fixed.

All we need for this ticket is
* review my patch
* check that the spkg builds on OSX and Solaris



---

archive/issue_comments_114769.json:
```json
{
    "body": "Spkg doesn't build on Solaris, will investigate...",
    "created_at": "2011-10-02T13:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114769",
    "user": "vbraun"
}
```

Spkg doesn't build on Solaris, will investigate...



---

archive/issue_comments_114770.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-10-02T13:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114770",
    "user": "vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_114771.json:
```json
{
    "body": "Replying to [comment:46 vbraun]:\n> I'm against bikeshedding `module_list.py` any further.\n\nWell, I'd be happy if it just kept the color it had (more precisely, the different modules kept their different colors); what Martin did is just literally painting them all black, or brown, by mixing all the colors at least one of them had.\n\nWhat would you say if I changed the libraries in all linker commands to just use `$SAGE_ROOT/local/lib/*.so`?\n\nThis is a useless regression, although it seems the patch has meanwhile changed, and the changes are less poor now.\n\nIf you want to \"simplify\" `module_list.py` by factoring out the libraries **Singular** (i.e. `libsingular`) requires, as he probably intended, then put **these** libraries into `singular_libs`, and nothing else.\n\n\n\n\n> The next version of Singular will split into multiple libraries and any effort trying to minimize the number of linked libraries now is going to be wasted.\n\nThat's totally unrelated.",
    "created_at": "2011-10-02T13:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114771",
    "user": "leif"
}
```

Replying to [comment:46 vbraun]:
> I'm against bikeshedding `module_list.py` any further.

Well, I'd be happy if it just kept the color it had (more precisely, the different modules kept their different colors); what Martin did is just literally painting them all black, or brown, by mixing all the colors at least one of them had.

What would you say if I changed the libraries in all linker commands to just use `$SAGE_ROOT/local/lib/*.so`?

This is a useless regression, although it seems the patch has meanwhile changed, and the changes are less poor now.

If you want to "simplify" `module_list.py` by factoring out the libraries **Singular** (i.e. `libsingular`) requires, as he probably intended, then put **these** libraries into `singular_libs`, and nothing else.




> The next version of Singular will split into multiple libraries and any effort trying to minimize the number of linked libraries now is going to be wasted.

That's totally unrelated.



---

archive/issue_comments_114772.json:
```json
{
    "body": "The only bug, if you can call that, is that the `singular_libs` variable could be called `libraries_that_all_cython_code_using_libsingular_needs`. Its fine the way it is.",
    "created_at": "2011-10-02T13:38:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114772",
    "user": "vbraun"
}
```

The only bug, if you can call that, is that the `singular_libs` variable could be called `libraries_that_all_cython_code_using_libsingular_needs`. Its fine the way it is.



---

archive/issue_comments_114773.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-02T15:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114773",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114774.json:
```json
{
    "body": "Updated spkg, now with checked-in changes and p0! I successfully built it on bsd.math (OSX) and is currently building on Mark (Solaris Sparc). I found one small issue with Solaris that I fixed and reported on the libsingular mailinglist (https://groups.google.com/d/topic/libsingular-devel/Cdz0QpqFqDQ/discussion).",
    "created_at": "2011-10-02T15:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114774",
    "user": "vbraun"
}
```

Updated spkg, now with checked-in changes and p0! I successfully built it on bsd.math (OSX) and is currently building on Mark (Solaris Sparc). I found one small issue with Solaris that I fixed and reported on the libsingular mailinglist (https://groups.google.com/d/topic/libsingular-devel/Cdz0QpqFqDQ/discussion).



---

archive/issue_comments_114775.json:
```json
{
    "body": "Attachment [trac_10903_singular-3-1-3-3.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_singular-3-1-3-3.patch) by malb created at 2011-10-02 16:11:50",
    "created_at": "2011-10-02T16:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114775",
    "user": "malb"
}
```

Attachment [trac_10903_singular-3-1-3-3.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_singular-3-1-3-3.patch) by malb created at 2011-10-02 16:11:50



---

archive/issue_comments_114776.json:
```json
{
    "body": "Thank you Volker for taking care of the SPKG!",
    "created_at": "2011-10-02T16:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114776",
    "user": "malb"
}
```

Thank you Volker for taking care of the SPKG!



---

archive/issue_comments_114777.json:
```json
{
    "body": "The new .p0.spkg builds on Mark (solaris sparc). Yay ;-)",
    "created_at": "2011-10-02T18:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114777",
    "user": "vbraun"
}
```

The new .p0.spkg builds on Mark (solaris sparc). Yay ;-)



---

archive/issue_comments_114778.json:
```json
{
    "body": "[attachment:trac_10903_singular-3-1-3-3.patch] looks fine except that I don't understand why the misc.misc deprecated function alias changes are part of it.",
    "created_at": "2011-10-03T12:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114778",
    "user": "malb"
}
```

[attachment:trac_10903_singular-3-1-3-3.patch] looks fine except that I don't understand why the misc.misc deprecated function alias changes are part of it.



---

archive/issue_comments_114779.json:
```json
{
    "body": "The deprecated function stuff uses the garbage collector to find out the name of the variable / method it is assigned to. But it did it quite indiscriminately, which broke when my debugging patch was active. So there were tons of failed doctests because it used the name of some temporary variable instead. Its not strictly necessary to apply the patch to sage.misc.misc and sage.misc.sageinspect to work with Singular, but it is very useful if you want to turn the debugging on for `currRing`...",
    "created_at": "2011-10-03T12:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114779",
    "user": "vbraun"
}
```

The deprecated function stuff uses the garbage collector to find out the name of the variable / method it is assigned to. But it did it quite indiscriminately, which broke when my debugging patch was active. So there were tons of failed doctests because it used the name of some temporary variable instead. Its not strictly necessary to apply the patch to sage.misc.misc and sage.misc.sageinspect to work with Singular, but it is very useful if you want to turn the debugging on for `currRing`...



---

archive/issue_comments_114780.json:
```json
{
    "body": "I'm fine with Martin's changes to the spkg. So if he agrees with my Solaris fix then we have a positive review (except for the dependency ticket).",
    "created_at": "2011-10-03T12:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114780",
    "user": "vbraun"
}
```

I'm fine with Martin's changes to the spkg. So if he agrees with my Solaris fix then we have a positive review (except for the dependency ticket).



---

archive/issue_comments_114781.json:
```json
{
    "body": "Yes, I agree with your Solaris fix. The only issue I found in the SPKG was a few \"*~\" files in /patches which I removed in \n\nhttp://sage.math.washington.edu/home/malb/spkgs/singular-3-1-3-3.p0.spkg\n\nI don't think this should be .p1 (I only removed backup files), so perhaps you could just replace your p0 with this one?",
    "created_at": "2011-10-03T14:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114781",
    "user": "malb"
}
```

Yes, I agree with your Solaris fix. The only issue I found in the SPKG was a few "*~" files in /patches which I removed in 

http://sage.math.washington.edu/home/malb/spkgs/singular-3-1-3-3.p0.spkg

I don't think this should be .p1 (I only removed backup files), so perhaps you could just replace your p0 with this one?



---

archive/issue_comments_114782.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-03T14:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114782",
    "user": "malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114783.json:
```json
{
    "body": "I replaced the singular-3-1-3-3.p0.spkg at the ticket's URL with Martin's version.",
    "created_at": "2011-10-04T09:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114783",
    "user": "vbraun"
}
```

I replaced the singular-3-1-3-3.p0.spkg at the ticket's URL with Martin's version.



---

archive/issue_comments_114784.json:
```json
{
    "body": "Did someone check the compiler warnings for the Singular spkg?\n\nEspecially \"*always false*\" and \"*may be used uninitialized*\" are scary:\n\n\n```\ncf_factor.cc:440: warning: comparison is always false due to limited range of data type\ncf_factor.cc:467: warning: comparison is always false due to limited range of data type\nfacBivar.cc:213: warning: \u2018evaluation2\u2019 may be used uninitialized in this function\nfacBivar.cc:213: warning: \u2018evaluation\u2019 may be used uninitialized in this function\nfacFactorize.cc:322: warning: \u2018lev\u2019 may be used uninitialized in this function\nfacFqBivar.cc:594: warning: \u2018m\u2019 may be used uninitialized in this function\nfacFqBivar.cc:594: warning: \u2018i\u2019 may be used uninitialized in this function\nfacFqBivarUtil.cc:215: warning: \u2018degMipoBeta\u2019 may be used uninitialized in this function\nfacFqFactorize.cc:1495: warning: \u2018lev\u2019 may be used uninitialized in this function\nsm_sparsemod.cc:113: warning: \u2018N\u2019 may be used uninitialized in this function\ncf_factor.cc:440: warning: comparison is always false due to limited range of data type\ncf_factor.cc:467: warning: comparison is always false due to limited range of data type\ncf_factor.cc:440: warning: comparison is always false due to limited range of data type\ncf_factor.cc:467: warning: comparison is always false due to limited range of data type\nfacBivar.cc:213: warning: \u2018evaluation2\u2019 may be used uninitialized in this function\nfacBivar.cc:213: warning: \u2018evaluation\u2019 may be used uninitialized in this function\nfacFactorize.cc:322: warning: \u2018lev\u2019 may be used uninitialized in this function\nfacFqBivar.cc:594: warning: \u2018m\u2019 may be used uninitialized in this function\nfacFqBivar.cc:594: warning: \u2018i\u2019 may be used uninitialized in this function\nfacFqBivarUtil.cc:215: warning: \u2018degMipoBeta\u2019 may be used uninitialized in this function\nfacFqFactorize.cc:1495: warning: \u2018lev\u2019 may be used uninitialized in this function\nsm_sparsemod.cc:113: warning: \u2018N\u2019 may be used uninitialized in this function\ncf_factor.cc:440: warning: comparison is always false due to limited range of data type\ncf_factor.cc:467: warning: comparison is always false due to limited range of data type\ncanonicalform.cc:1744: warning: deprecated conversion from string constant to \u2018char*\u2019\ncanonicalform.cc:1750: warning: deprecated conversion from string constant to \u2018char*\u2019\ncf_factor.cc:440: warning: comparison is always false due to limited range of data type\ncf_factor.cc:467: warning: comparison is always false due to limited range of data type\nfacBivar.cc:213: warning: \u2018evaluation2\u2019 may be used uninitialized in this function\nfacBivar.cc:213: warning: \u2018evaluation\u2019 may be used uninitialized in this function\nfacFactorize.cc:322: warning: \u2018lev\u2019 may be used uninitialized in this function\nfacFqBivar.cc:594: warning: \u2018m\u2019 may be used uninitialized in this function\nfacFqBivar.cc:594: warning: \u2018i\u2019 may be used uninitialized in this function\nfacFqBivarUtil.cc:215: warning: \u2018degMipoBeta\u2019 may be used uninitialized in this function\nfacFqFactorize.cc:1495: warning: \u2018lev\u2019 may be used uninitialized in this function\n/usr/include/c++/4.2/backward/backward_warning.h:32:2: warning: #warning This file includes at least one deprecated or antiquated header. Please consider using one of the 32 headers found in section 17.4.1.2 of the C++ standard. Examples include substituting the <X> header for the <X.h> header for C++ includes, or <iostream> instead of the deprecated header <iostream.h>. To disable this warning use -Wno-deprecated.\nsm_sparsemod.cc:113: warning: \u2018N\u2019 may be used uninitialized in this function\nreadcf.cc:1452: warning: deprecated conversion from string constant to \u2018char*\u2019\nreadcf.cc:1598: warning: deprecated conversion from string constant to \u2018char*\u2019\ncanonicalform.cc:1744: warning: deprecated conversion from string constant to \u2018char*\u2019\ncanonicalform.cc:1750: warning: deprecated conversion from string constant to \u2018char*\u2019\ncf_factor.cc:440: warning: comparison is always false due to limited range of data type\ncf_factor.cc:467: warning: comparison is always false due to limited range of data type\n/usr/include/c++/4.2/backward/backward_warning.h:32:2: warning: #warning This file includes at least one deprecated or antiquated header. Please consider using one of the 32 headers found in section 17.4.1.2 of the C++ standard. Examples include substituting the <X> header for the <X.h> header for C++ includes, or <iostream> instead of the deprecated header <iostream.h>. To disable this warning use -Wno-deprecated.\nmemutil.c:98: warning: implicit declaration of function \u2018memcpy\u2019\nmemutil.c:98: warning: incompatible implicit declaration of built-in function \u2018memcpy\u2019\n```\n",
    "created_at": "2011-10-04T16:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114784",
    "user": "leif"
}
```

Did someone check the compiler warnings for the Singular spkg?

Especially "*always false*" and "*may be used uninitialized*" are scary:


```
cf_factor.cc:440: warning: comparison is always false due to limited range of data type
cf_factor.cc:467: warning: comparison is always false due to limited range of data type
facBivar.cc:213: warning: ‘evaluation2’ may be used uninitialized in this function
facBivar.cc:213: warning: ‘evaluation’ may be used uninitialized in this function
facFactorize.cc:322: warning: ‘lev’ may be used uninitialized in this function
facFqBivar.cc:594: warning: ‘m’ may be used uninitialized in this function
facFqBivar.cc:594: warning: ‘i’ may be used uninitialized in this function
facFqBivarUtil.cc:215: warning: ‘degMipoBeta’ may be used uninitialized in this function
facFqFactorize.cc:1495: warning: ‘lev’ may be used uninitialized in this function
sm_sparsemod.cc:113: warning: ‘N’ may be used uninitialized in this function
cf_factor.cc:440: warning: comparison is always false due to limited range of data type
cf_factor.cc:467: warning: comparison is always false due to limited range of data type
cf_factor.cc:440: warning: comparison is always false due to limited range of data type
cf_factor.cc:467: warning: comparison is always false due to limited range of data type
facBivar.cc:213: warning: ‘evaluation2’ may be used uninitialized in this function
facBivar.cc:213: warning: ‘evaluation’ may be used uninitialized in this function
facFactorize.cc:322: warning: ‘lev’ may be used uninitialized in this function
facFqBivar.cc:594: warning: ‘m’ may be used uninitialized in this function
facFqBivar.cc:594: warning: ‘i’ may be used uninitialized in this function
facFqBivarUtil.cc:215: warning: ‘degMipoBeta’ may be used uninitialized in this function
facFqFactorize.cc:1495: warning: ‘lev’ may be used uninitialized in this function
sm_sparsemod.cc:113: warning: ‘N’ may be used uninitialized in this function
cf_factor.cc:440: warning: comparison is always false due to limited range of data type
cf_factor.cc:467: warning: comparison is always false due to limited range of data type
canonicalform.cc:1744: warning: deprecated conversion from string constant to ‘char*’
canonicalform.cc:1750: warning: deprecated conversion from string constant to ‘char*’
cf_factor.cc:440: warning: comparison is always false due to limited range of data type
cf_factor.cc:467: warning: comparison is always false due to limited range of data type
facBivar.cc:213: warning: ‘evaluation2’ may be used uninitialized in this function
facBivar.cc:213: warning: ‘evaluation’ may be used uninitialized in this function
facFactorize.cc:322: warning: ‘lev’ may be used uninitialized in this function
facFqBivar.cc:594: warning: ‘m’ may be used uninitialized in this function
facFqBivar.cc:594: warning: ‘i’ may be used uninitialized in this function
facFqBivarUtil.cc:215: warning: ‘degMipoBeta’ may be used uninitialized in this function
facFqFactorize.cc:1495: warning: ‘lev’ may be used uninitialized in this function
/usr/include/c++/4.2/backward/backward_warning.h:32:2: warning: #warning This file includes at least one deprecated or antiquated header. Please consider using one of the 32 headers found in section 17.4.1.2 of the C++ standard. Examples include substituting the <X> header for the <X.h> header for C++ includes, or <iostream> instead of the deprecated header <iostream.h>. To disable this warning use -Wno-deprecated.
sm_sparsemod.cc:113: warning: ‘N’ may be used uninitialized in this function
readcf.cc:1452: warning: deprecated conversion from string constant to ‘char*’
readcf.cc:1598: warning: deprecated conversion from string constant to ‘char*’
canonicalform.cc:1744: warning: deprecated conversion from string constant to ‘char*’
canonicalform.cc:1750: warning: deprecated conversion from string constant to ‘char*’
cf_factor.cc:440: warning: comparison is always false due to limited range of data type
cf_factor.cc:467: warning: comparison is always false due to limited range of data type
/usr/include/c++/4.2/backward/backward_warning.h:32:2: warning: #warning This file includes at least one deprecated or antiquated header. Please consider using one of the 32 headers found in section 17.4.1.2 of the C++ standard. Examples include substituting the <X> header for the <X.h> header for C++ includes, or <iostream> instead of the deprecated header <iostream.h>. To disable this warning use -Wno-deprecated.
memutil.c:98: warning: implicit declaration of function ‘memcpy’
memutil.c:98: warning: incompatible implicit declaration of built-in function ‘memcpy’
```




---

archive/issue_comments_114785.json:
```json
{
    "body": "Replying to [comment:58 vbraun]:\n> I replaced the singular-3-1-3-3.p0.spkg at the ticket's URL with Martin's version.\n\nYou mean you copied Martin's to stp.dias.ie?\n\nWhy not change the URL in the ticket's description? I strongly doubt the md5sum is still the same... ;-)",
    "created_at": "2011-10-04T16:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114785",
    "user": "leif"
}
```

Replying to [comment:58 vbraun]:
> I replaced the singular-3-1-3-3.p0.spkg at the ticket's URL with Martin's version.

You mean you copied Martin's to stp.dias.ie?

Why not change the URL in the ticket's description? I strongly doubt the md5sum is still the same... ;-)



---

archive/issue_comments_114786.json:
```json
{
    "body": "Ticket description contains correct spkg.\n\nAs for the compiler warnings, upstream recently flipped on more pedantic checks and is working on fixing the compiler warnings. But not in this version.",
    "created_at": "2011-10-04T17:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114786",
    "user": "vbraun"
}
```

Ticket description contains correct spkg.

As for the compiler warnings, upstream recently flipped on more pedantic checks and is working on fixing the compiler warnings. But not in this version.



---

archive/issue_comments_114787.json:
```json
{
    "body": "Applying #11339 and #10903 causes the docbuilder to crash and burn:\n\n```\n$ rm -r devel/sage/doc/output\n$ make doc-html\n[...]\n^[[?1034hsphinx-build -b html -d /usr/local/src/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/en/reference   -A hide_pdf_links=1 /usr/l\n^[[?1034hRunning Sphinx v1.0.4\nloading pickled environment... not yet created\nbuilding [html]: targets for 935 source files that are out of date\nupdating environment: 935 added, 0 changed, 0 removed\nreading sources... [  0%] algebras\nreading sources... [  0%] arithgroup\nreading sources... [  0%] calculus\nreading sources... [  0%] categories\n[...]\nreading sources... [ 96%] sage/structure/sequence\nreading sources... [ 96%] sage/structure/unique_representation\nreading sources... [ 96%] sage/symbolic/constants\nreading sources... [ 96%] sage/symbolic/expression\n\nException occurred:\n  File \"/usr/local/src/sage-4.7.2.alpha3/devel/sage/doc/common/conf.py\", line 378, in skip_member\n    if (hasattr(obj, '__name__') and obj.__name__.find('.') != -1 and\nAttributeError: 'NoneType' object has no attribute 'find'\nThe full traceback has been saved in /tmp/sphinx-err-mqo1bm.log, if you want to report the issue to the developers.\nPlease also report this if it was a user error, so that a better error message can be provided next time.\nEither send bugs to the mailing list at <http://groups.google.com/group/sphinx-dev/>,\nor report them in the tracker at <http://bitbucket.org/birkenfeld/sphinx/issues/>. Thanks!\nBuild finished.  The built documents can be found in /usr/local/src/sage-4.7.2.alpha3/devel/sage/doc/output/html/en/reference\n```\n\n\nI have not yet investigated the issue, but it is clear that this needs to be fixed before we can merge this ticket.",
    "created_at": "2011-10-05T09:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114787",
    "user": "jdemeyer"
}
```

Applying #11339 and #10903 causes the docbuilder to crash and burn:

```
$ rm -r devel/sage/doc/output
$ make doc-html
[...]
^[[?1034hsphinx-build -b html -d /usr/local/src/sage-4.7.2.alpha3/devel/sage/doc/output/doctrees/en/reference   -A hide_pdf_links=1 /usr/l
^[[?1034hRunning Sphinx v1.0.4
loading pickled environment... not yet created
building [html]: targets for 935 source files that are out of date
updating environment: 935 added, 0 changed, 0 removed
reading sources... [  0%] algebras
reading sources... [  0%] arithgroup
reading sources... [  0%] calculus
reading sources... [  0%] categories
[...]
reading sources... [ 96%] sage/structure/sequence
reading sources... [ 96%] sage/structure/unique_representation
reading sources... [ 96%] sage/symbolic/constants
reading sources... [ 96%] sage/symbolic/expression

Exception occurred:
  File "/usr/local/src/sage-4.7.2.alpha3/devel/sage/doc/common/conf.py", line 378, in skip_member
    if (hasattr(obj, '__name__') and obj.__name__.find('.') != -1 and
AttributeError: 'NoneType' object has no attribute 'find'
The full traceback has been saved in /tmp/sphinx-err-mqo1bm.log, if you want to report the issue to the developers.
Please also report this if it was a user error, so that a better error message can be provided next time.
Either send bugs to the mailing list at <http://groups.google.com/group/sphinx-dev/>,
or report them in the tracker at <http://bitbucket.org/birkenfeld/sphinx/issues/>. Thanks!
Build finished.  The built documents can be found in /usr/local/src/sage-4.7.2.alpha3/devel/sage/doc/output/html/en/reference
```


I have not yet investigated the issue, but it is clear that this needs to be fixed before we can merge this ticket.



---

archive/issue_comments_114788.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-10-05T09:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114788",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_114789.json:
```json
{
    "body": "Replying to [comment:62 jdemeyer]:\n> Applying #11339 and #10903 causes the docbuilder to crash and burn:\n\nI found that the problem occurs for some `<sage.misc.misc.DeprecatedFunctionAlias object at 0x1e2fc10>`, which in fact wraps `<method 'is_constant' of 'sage.symbolic.expression.Expression' objects>`\n\nBut that's very strange, because I get\n\n```\nsage: x.is_constant.__name__\n'is_constant'\n```\n",
    "created_at": "2011-10-05T09:32:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114789",
    "user": "SimonKing"
}
```

Replying to [comment:62 jdemeyer]:
> Applying #11339 and #10903 causes the docbuilder to crash and burn:

I found that the problem occurs for some `<sage.misc.misc.DeprecatedFunctionAlias object at 0x1e2fc10>`, which in fact wraps `<method 'is_constant' of 'sage.symbolic.expression.Expression' objects>`

But that's very strange, because I get

```
sage: x.is_constant.__name__
'is_constant'
```




---

archive/issue_comments_114790.json:
```json
{
    "body": "I changed the name lookup for DeprecatedFunctionAlias to be stricter and less fragile with respect to the ordering of objects that the garbage collector returns. Maybe I missed something, let me check...",
    "created_at": "2011-10-05T09:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114790",
    "user": "vbraun"
}
```

I changed the name lookup for DeprecatedFunctionAlias to be stricter and less fragile with respect to the ordering of objects that the garbage collector returns. Maybe I missed something, let me check...



---

archive/issue_comments_114791.json:
```json
{
    "body": "Aha! Perhaps the problem arose like here:\n\n```\nsage: from sage.misc.misc import deprecated_function_alias\nsage: print deprecated_function_alias(x.is_constant, \"bla\").__name__\nNone\n```\n\n\nAnd I think I have located the problem: [attachment:trac_10903_singular-fixes.patch] introduces a change in `sage/misc/misc.py`, and apparently it can happen that the lazy attribute `__name__` of `DeprecatedFunctionAlias` returns None.\n\nPerhaps it would be a solution to return `self.func.__name__`, if no name can be determined by using `inspect.stack` and `gc.get_referrers`?",
    "created_at": "2011-10-05T09:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114791",
    "user": "SimonKing"
}
```

Aha! Perhaps the problem arose like here:

```
sage: from sage.misc.misc import deprecated_function_alias
sage: print deprecated_function_alias(x.is_constant, "bla").__name__
None
```


And I think I have located the problem: [attachment:trac_10903_singular-fixes.patch] introduces a change in `sage/misc/misc.py`, and apparently it can happen that the lazy attribute `__name__` of `DeprecatedFunctionAlias` returns None.

Perhaps it would be a solution to return `self.func.__name__`, if no name can be determined by using `inspect.stack` and `gc.get_referrers`?



---

archive/issue_comments_114792.json:
```json
{
    "body": "I found where the critical change has happened: #10859 deprecates _is_real, _is_positive and so on, and with #10903, we have\n\n```\nsage: print x._is_constant.__name__\nNone\n```\n\n\n`_is_constant` is a deprecated alias for `is_constant`. I think it would be a bad idea to use the name `\"is_constant\"` for `_is_constant` (note the underscores), because otherwise the docbuilder might think that the deprecated function has to be documented.\n\nPerhaps the easiest solution is to make the lazy attribute `__name__` raise an `AttributeError`, rather than returning `None`. That would certainly make the docbuilder happy, because it tests `if hasattr(obj,'__name__') and obj.__name__.find('.') != -1 and obj.__name__.split('.')[-1] != name): ...\"`.",
    "created_at": "2011-10-05T10:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114792",
    "user": "SimonKing"
}
```

I found where the critical change has happened: #10859 deprecates _is_real, _is_positive and so on, and with #10903, we have

```
sage: print x._is_constant.__name__
None
```


`_is_constant` is a deprecated alias for `is_constant`. I think it would be a bad idea to use the name `"is_constant"` for `_is_constant` (note the underscores), because otherwise the docbuilder might think that the deprecated function has to be documented.

Perhaps the easiest solution is to make the lazy attribute `__name__` raise an `AttributeError`, rather than returning `None`. That would certainly make the docbuilder happy, because it tests `if hasattr(obj,'__name__') and obj.__name__.find('.') != -1 and obj.__name__.split('.')[-1] != name): ..."`.



---

archive/issue_comments_114793.json:
```json
{
    "body": "Prevent `__name__` of deprecated function aliases from returning None",
    "created_at": "2011-10-05T10:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114793",
    "user": "SimonKing"
}
```

Prevent `__name__` of deprecated function aliases from returning None



---

archive/issue_comments_114794.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-05T10:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114794",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114795.json:
```json
{
    "body": "Attachment [trac10903_fix_name.patch](tarball://root/attachments/some-uuid/ticket10903/trac10903_fix_name.patch) by SimonKing created at 2011-10-05 10:51:14\n\nI have attached a patch that makes the `__name__` lazy attribute raise an attribute error when it would return None otherwise. For me, it seems to fix the problem, but I think it should better be verified by someone else.\n\nApply trac_10903_singular-3-1-3-3.patch trac_10903_singular-fixes.patch trac10903_fix_name.patch",
    "created_at": "2011-10-05T10:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114795",
    "user": "SimonKing"
}
```

Attachment [trac10903_fix_name.patch](tarball://root/attachments/some-uuid/ticket10903/trac10903_fix_name.patch) by SimonKing created at 2011-10-05 10:51:14

I have attached a patch that makes the `__name__` lazy attribute raise an attribute error when it would return None otherwise. For me, it seems to fix the problem, but I think it should better be verified by someone else.

Apply trac_10903_singular-3-1-3-3.patch trac_10903_singular-fixes.patch trac10903_fix_name.patch



---

archive/issue_comments_114796.json:
```json
{
    "body": "Otherwise we get a new contributor...",
    "created_at": "2011-10-05T11:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114796",
    "user": "leif"
}
```

Otherwise we get a new contributor...



---

archive/issue_comments_114797.json:
```json
{
    "body": "The bug is that `x._is_constant` is a lazy attribute in a Cython class, and I only tested for Python classes. I've patched this issue and will upload the fix as soon as doctests finish (and this time I'm deleting doc/output so the whole documentation will be rebuilt).\n\nThe docbuilder currently documents deprecated functions and I think thats a good idea; Say, somebody suddenly gets a deprecation warning and then looks into the developer guide.\n\nOf course `x._is_constant` is always excluded from the documentation because of the underscore, before and after deprecation. This lack of documentation is precisely the reason why I renamed it to `x.is_constant` and deprecated the underscore method...",
    "created_at": "2011-10-05T11:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114797",
    "user": "vbraun"
}
```

The bug is that `x._is_constant` is a lazy attribute in a Cython class, and I only tested for Python classes. I've patched this issue and will upload the fix as soon as doctests finish (and this time I'm deleting doc/output so the whole documentation will be rebuilt).

The docbuilder currently documents deprecated functions and I think thats a good idea; Say, somebody suddenly gets a deprecation warning and then looks into the developer guide.

Of course `x._is_constant` is always excluded from the documentation because of the underscore, before and after deprecation. This lack of documentation is precisely the reason why I renamed it to `x.is_constant` and deprecated the underscore method...



---

archive/issue_comments_114798.json:
```json
{
    "body": "Replying to [comment:68 leif]:\n> Otherwise we get a new contributor...\n\nJust one of the many errors I committed this morning...",
    "created_at": "2011-10-05T11:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114798",
    "user": "SimonKing"
}
```

Replying to [comment:68 leif]:
> Otherwise we get a new contributor...

Just one of the many errors I committed this morning...



---

archive/issue_comments_114799.json:
```json
{
    "body": "Replying to [comment:69 vbraun]:\n> The bug is that `x._is_constant` is a lazy attribute in a Cython class, and I only tested for Python classes. I've patched this issue and will upload the fix as soon as doctests finish (and this time I'm deleting doc/output so the whole documentation will be rebuilt).\n\nIs that needed? For me, both the doc tests and building the references work with the three patches that we have now.",
    "created_at": "2011-10-05T11:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114799",
    "user": "SimonKing"
}
```

Replying to [comment:69 vbraun]:
> The bug is that `x._is_constant` is a lazy attribute in a Cython class, and I only tested for Python classes. I've patched this issue and will upload the fix as soon as doctests finish (and this time I'm deleting doc/output so the whole documentation will be rebuilt).

Is that needed? For me, both the doc tests and building the references work with the three patches that we have now.



---

archive/issue_comments_114800.json:
```json
{
    "body": "Replying to [comment:71 SimonKing]:\n> Is that needed? For me, both the doc tests and building the references work with the three patches that we have now.\n\nBut I take it with your patch the deprecated functions (without underscore) from Cython classes aren't documented any more. For example, see `doc/output/html/en/reference/sage/symbolic/expression.html#sage.symbolic.expression.Expression.lgamma` --- this is currently documented and I'd like to keep it that way until we remove it altogether.",
    "created_at": "2011-10-05T12:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114800",
    "user": "vbraun"
}
```

Replying to [comment:71 SimonKing]:
> Is that needed? For me, both the doc tests and building the references work with the three patches that we have now.

But I take it with your patch the deprecated functions (without underscore) from Cython classes aren't documented any more. For example, see `doc/output/html/en/reference/sage/symbolic/expression.html#sage.symbolic.expression.Expression.lgamma` --- this is currently documented and I'd like to keep it that way until we remove it altogether.



---

archive/issue_comments_114801.json:
```json
{
    "body": "Replying to [comment:72 vbraun]:\n> Replying to [comment:71 SimonKing]:\n> > Is that needed? For me, both the doc tests and building the references work with the three patches that we have now.\n> \n> But I take it with your patch the deprecated functions (without underscore) from Cython classes aren't documented any more. For example, see `doc/output/html/en/reference/sage/symbolic/expression.html#sage.symbolic.expression.Expression.lgamma` --- this is currently documented and I'd like to keep it that way until we remove it altogether.\n\nNo, you are mistaken. I've built the documentation, and lgamma is in.\n\nIn fact, the documentation is misformatted, it looks like\n\n```\n    This method is deprecated, please use the .log_gamma() function instead.\n\n    Log gamma function evaluated at self.\n\n    EXAMPLES::\n        sage: x.lgamma() doctest:...: DeprecationWarning: The lgamma() function is deprecated. Use log_gamma() instead. log_gamma(x)\n\n```\n\nwhere actually `.log_gamma()` is TeXed. So, while we are at it, we may fix the docstring of lgamma.",
    "created_at": "2011-10-05T12:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114801",
    "user": "SimonKing"
}
```

Replying to [comment:72 vbraun]:
> Replying to [comment:71 SimonKing]:
> > Is that needed? For me, both the doc tests and building the references work with the three patches that we have now.
> 
> But I take it with your patch the deprecated functions (without underscore) from Cython classes aren't documented any more. For example, see `doc/output/html/en/reference/sage/symbolic/expression.html#sage.symbolic.expression.Expression.lgamma` --- this is currently documented and I'd like to keep it that way until we remove it altogether.

No, you are mistaken. I've built the documentation, and lgamma is in.

In fact, the documentation is misformatted, it looks like

```
    This method is deprecated, please use the .log_gamma() function instead.

    Log gamma function evaluated at self.

    EXAMPLES::
        sage: x.lgamma() doctest:...: DeprecationWarning: The lgamma() function is deprecated. Use log_gamma() instead. log_gamma(x)

```

where actually `.log_gamma()` is TeXed. So, while we are at it, we may fix the docstring of lgamma.



---

archive/issue_comments_114802.json:
```json
{
    "body": "The attached new patch fixes the misformatting in the doc of lgamma.\n\nApply trac_10903_singular-3-1-3-3.patch trac_10903_singular-fixes.patch trac10903_fix_name.patch trac10903_lgamma_doc.patch",
    "created_at": "2011-10-05T12:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114802",
    "user": "SimonKing"
}
```

The attached new patch fixes the misformatting in the doc of lgamma.

Apply trac_10903_singular-3-1-3-3.patch trac_10903_singular-fixes.patch trac10903_fix_name.patch trac10903_lgamma_doc.patch



---

archive/issue_comments_114803.json:
```json
{
    "body": "So if `skip_member()` raises an exception, the method is unconditionally documented? In that case, you would also document `_is_constant` which was not documented before and IHMO should not be documented (or, rather, be documented contingent on the value of `SAGE_DOC_UNDERSCORE` environment variable).\n\nCan you also fix the formatting of `is_constant` while you are at it?",
    "created_at": "2011-10-05T12:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114803",
    "user": "vbraun"
}
```

So if `skip_member()` raises an exception, the method is unconditionally documented? In that case, you would also document `_is_constant` which was not documented before and IHMO should not be documented (or, rather, be documented contingent on the value of `SAGE_DOC_UNDERSCORE` environment variable).

Can you also fix the formatting of `is_constant` while you are at it?



---

archive/issue_comments_114804.json:
```json
{
    "body": "The trac_10903_docbuild_fix.patch now looks into Python and Cython classes. If all fails, it raises an error as Simon suggested.",
    "created_at": "2011-10-05T12:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114804",
    "user": "vbraun"
}
```

The trac_10903_docbuild_fix.patch now looks into Python and Cython classes. If all fails, it raises an error as Simon suggested.



---

archive/issue_comments_114805.json:
```json
{
    "body": "Attachment [trac10903_lgamma_doc.patch](tarball://root/attachments/some-uuid/ticket10903/trac10903_lgamma_doc.patch) by SimonKing created at 2011-10-05 12:42:32\n\nFix doc formatting of sage.symbolic.expression",
    "created_at": "2011-10-05T12:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114805",
    "user": "SimonKing"
}
```

Attachment [trac10903_lgamma_doc.patch](tarball://root/attachments/some-uuid/ticket10903/trac10903_lgamma_doc.patch) by SimonKing created at 2011-10-05 12:42:32

Fix doc formatting of sage.symbolic.expression



---

archive/issue_comments_114806.json:
```json
{
    "body": "Replying to [comment:75 vbraun]:\n> So if `skip_member()` raises an exception, the method is unconditionally documented?\n\nApparently not.\n\n> In that case, you would also document `_is_constant` which was not documented before\n\nIt isn't. Only `is_constant` without underscore is. So, I don't see why the docbuild_fix patch should be needed.\n\n> Can you also fix the formatting of `is_constant` while you are at it?\n\nI just did (updating the lgamma_doc patch).",
    "created_at": "2011-10-05T12:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114806",
    "user": "SimonKing"
}
```

Replying to [comment:75 vbraun]:
> So if `skip_member()` raises an exception, the method is unconditionally documented?

Apparently not.

> In that case, you would also document `_is_constant` which was not documented before

It isn't. Only `is_constant` without underscore is. So, I don't see why the docbuild_fix patch should be needed.

> Can you also fix the formatting of `is_constant` while you are at it?

I just did (updating the lgamma_doc patch).



---

archive/issue_comments_114807.json:
```json
{
    "body": "Replying to [comment:77 SimonKing]:\n> > So if `skip_member()` raises an exception, the method is unconditionally documented?\n> \n> Apparently not.\n\nThat doesn't make sense if you look into the `skip_member()` code. Are you always deleting the cached documentation before testing?",
    "created_at": "2011-10-05T12:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114807",
    "user": "vbraun"
}
```

Replying to [comment:77 SimonKing]:
> > So if `skip_member()` raises an exception, the method is unconditionally documented?
> 
> Apparently not.

That doesn't make sense if you look into the `skip_member()` code. Are you always deleting the cached documentation before testing?



---

archive/issue_comments_114808.json:
```json
{
    "body": "Replying to [comment:75 vbraun]:\n> So if `skip_member()` raises an exception, the method is unconditionally documented? \n\nTo be precise: If `skip_member()` raises an exception then building the documentation crashes. That's why it tests `hasattr(obj,\"__name__\")`.\n\nAlso I wonder whether the difference between Python and Cython really matters here. Can you give a concrete example (i.e., a new doc test) that demonstrates what your patch fixes?",
    "created_at": "2011-10-05T12:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114808",
    "user": "SimonKing"
}
```

Replying to [comment:75 vbraun]:
> So if `skip_member()` raises an exception, the method is unconditionally documented? 

To be precise: If `skip_member()` raises an exception then building the documentation crashes. That's why it tests `hasattr(obj,"__name__")`.

Also I wonder whether the difference between Python and Cython really matters here. Can you give a concrete example (i.e., a new doc test) that demonstrates what your patch fixes?



---

archive/issue_comments_114809.json:
```json
{
    "body": "Replying to [comment:78 vbraun]:\n> Are you always deleting the cached documentation before testing?\n\nThe doc of sage.symbolic.expression builds fine *after* touching sage/symbolic/expression.pyx and `sage -b`. Would the documentation be taken from cache in that case?",
    "created_at": "2011-10-05T13:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114809",
    "user": "SimonKing"
}
```

Replying to [comment:78 vbraun]:
> Are you always deleting the cached documentation before testing?

The doc of sage.symbolic.expression builds fine *after* touching sage/symbolic/expression.pyx and `sage -b`. Would the documentation be taken from cache in that case?



---

archive/issue_comments_114810.json:
```json
{
    "body": "Replying to [comment:80 SimonKing]:\n> Replying to [comment:78 vbraun]:\n> > Are you always deleting the cached documentation before testing?\n> \n> The doc of sage.symbolic.expression builds fine *after* touching sage/symbolic/expression.pyx and `sage -b`. Would the documentation be taken from cache in that case?\n\nPS: And would the additional doc formatting fixes of the lgamma_doc patch be visible if the documentation was taken from cache?",
    "created_at": "2011-10-05T13:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114810",
    "user": "SimonKing"
}
```

Replying to [comment:80 SimonKing]:
> Replying to [comment:78 vbraun]:
> > Are you always deleting the cached documentation before testing?
> 
> The doc of sage.symbolic.expression builds fine *after* touching sage/symbolic/expression.pyx and `sage -b`. Would the documentation be taken from cache in that case?

PS: And would the additional doc formatting fixes of the lgamma_doc patch be visible if the documentation was taken from cache?



---

archive/issue_comments_114811.json:
```json
{
    "body": "What my patch does fix is this:\n\n```\nsage: print x._is_constant.__name__\n_is_constant\n```\n",
    "created_at": "2011-10-05T13:18:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114811",
    "user": "vbraun"
}
```

What my patch does fix is this:

```
sage: print x._is_constant.__name__
_is_constant
```




---

archive/issue_comments_114812.json:
```json
{
    "body": "Replying to [comment:82 vbraun]:\n> What my patch does fix is this:\n\nCould you add that example as a doc test? Then probably it is better to use your patch, not mine.\n\nPerhaps your trick could actually help me with something I could not solve at #11115.",
    "created_at": "2011-10-05T13:28:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114812",
    "user": "SimonKing"
}
```

Replying to [comment:82 vbraun]:
> What my patch does fix is this:

Could you add that example as a doc test? Then probably it is better to use your patch, not mine.

Perhaps your trick could actually help me with something I could not solve at #11115.



---

archive/issue_comments_114813.json:
```json
{
    "body": "Attachment [trac_10903_docbuild_fix.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_docbuild_fix.patch) by vbraun created at 2011-10-05 13:31:08\n\nUpdated patch",
    "created_at": "2011-10-05T13:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114813",
    "user": "vbraun"
}
```

Attachment [trac_10903_docbuild_fix.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_docbuild_fix.patch) by vbraun created at 2011-10-05 13:31:08

Updated patch



---

archive/issue_comments_114814.json:
```json
{
    "body": "The updated patch adds doctest and improves the cython class detection.",
    "created_at": "2011-10-05T13:33:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114814",
    "user": "vbraun"
}
```

The updated patch adds doctest and improves the cython class detection.



---

archive/issue_comments_114815.json:
```json
{
    "body": "I'm happy with trac10903_lgamma_doc.patch. Maybe Simon can quickly OK the trac_10903_docbuild_fix.patch, then we would be good to go?",
    "created_at": "2011-10-05T15:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114815",
    "user": "vbraun"
}
```

I'm happy with trac10903_lgamma_doc.patch. Maybe Simon can quickly OK the trac_10903_docbuild_fix.patch, then we would be good to go?



---

archive/issue_comments_114816.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-05T18:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114816",
    "user": "SimonKing"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114817.json:
```json
{
    "body": "Replying to [comment:85 vbraun]:\n> I'm happy with trac10903_lgamma_doc.patch. Maybe Simon can quickly OK the trac_10903_docbuild_fix.patch, then we would be good to go?\n\nSorry, I forgot to post before leaving office: Your patch manages to deduce the name of a deprecated Cython method. That certainly fixes the problem with the docs. With the patches applied as you stated it in the modified ticket description, both the doc tests and the references are fine.\n\nThus, positive review.",
    "created_at": "2011-10-05T18:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114817",
    "user": "SimonKing"
}
```

Replying to [comment:85 vbraun]:
> I'm happy with trac10903_lgamma_doc.patch. Maybe Simon can quickly OK the trac_10903_docbuild_fix.patch, then we would be good to go?

Sorry, I forgot to post before leaving office: Your patch manages to deduce the name of a deprecated Cython method. That certainly fixes the problem with the docs. With the patches applied as you stated it in the modified ticket description, both the doc tests and the references are fine.

Thus, positive review.



---

archive/issue_comments_114818.json:
```json
{
    "body": "It seems, that kernel mod_raw.cc lacks the following:\n\n\n```\n#if defined(ppcMac_darwin)\n#define HAVE_ELF_SYSTEM\n#endif\n```\n\n\nI already reported that upstream.",
    "created_at": "2011-10-05T20:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114818",
    "user": "AlexanderDreyer"
}
```

It seems, that kernel mod_raw.cc lacks the following:


```
#if defined(ppcMac_darwin)
#define HAVE_ELF_SYSTEM
#endif
```


I already reported that upstream.



---

archive/issue_comments_114819.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-10-06T07:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114819",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_114820.json:
```json
{
    "body": "Unfortunately, I discovered another serious issue with the new Singular (#11339 + #10903): there is an enormous **virtual memory usage regression** in the test\n\n```\nsage -t -long devel/sage/sage/crypto/mq/sr.py\n```\n\nIt used to need about **1.2GB** virtual memory, with the new Singular it needs **3.0GB**.  I measured this by setting `ulimit -v` and checking whether the test succeeds, for example:\n\n```\n### The parentheses start a subshell such that the ulimit only affects\n### that one command and not the whole shell.\n$ ( ulimit -v 2500000; ./sage -t -long devel/sage/sage/crypto/mq/sr.py )\nsage -t -long \"devel/sage/sage/crypto/mq/sr.py\"\n[*****  0.000s] # doctest internal\n[*****  0.000s] # doctest internal\n[00029  0.040s] sr = mq.SR(Integer(1), Integer(1), Integer(1), Integer(4))\n[...]\n[03326  0.000s] from sage.crypto.mq.sr import AllowZeroInversionsContext\n[03327  0.010s] sr = mq.SR(Integer(1),Integer(2),Integer(2),Integer(4))\n[03328  0.000s] with AllowZeroInversionsContext(sr):\n[03331  0.000s] sr._allow_zero_inversions\n[*****  0.000s] # doctest internal\n[*****  0.000s] # doctest internal\n[*****  0.000s] # doctest internal\n[03355  0.010s] from sage.crypto.mq.sr import test_consistency\n\nSingular error: no more memory\nSystem 1604712k:1604712k Appl 1450267k/23501k Malloc 1032k/0k Valloc 1472736k/23501k Pages 368184/0 Regions 2932:2932\n\nhalt 14\n\n         [114.3 s]\n```\n\nI don't know whether this issue is upstream or caused by some of the Sage library patches, but it is certainly serious enough not to merge this ticket.\n\nAs a reference: before this ticket, every test passed with 2.2GB of RAM, with the most memory used by\n\n```\nsage -t -long devel/sage/sage/schemes/elliptic_curves/heegner.py\n```\n",
    "created_at": "2011-10-06T07:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114820",
    "user": "jdemeyer"
}
```

Unfortunately, I discovered another serious issue with the new Singular (#11339 + #10903): there is an enormous **virtual memory usage regression** in the test

```
sage -t -long devel/sage/sage/crypto/mq/sr.py
```

It used to need about **1.2GB** virtual memory, with the new Singular it needs **3.0GB**.  I measured this by setting `ulimit -v` and checking whether the test succeeds, for example:

```
### The parentheses start a subshell such that the ulimit only affects
### that one command and not the whole shell.
$ ( ulimit -v 2500000; ./sage -t -long devel/sage/sage/crypto/mq/sr.py )
sage -t -long "devel/sage/sage/crypto/mq/sr.py"
[*****  0.000s] # doctest internal
[*****  0.000s] # doctest internal
[00029  0.040s] sr = mq.SR(Integer(1), Integer(1), Integer(1), Integer(4))
[...]
[03326  0.000s] from sage.crypto.mq.sr import AllowZeroInversionsContext
[03327  0.010s] sr = mq.SR(Integer(1),Integer(2),Integer(2),Integer(4))
[03328  0.000s] with AllowZeroInversionsContext(sr):
[03331  0.000s] sr._allow_zero_inversions
[*****  0.000s] # doctest internal
[*****  0.000s] # doctest internal
[*****  0.000s] # doctest internal
[03355  0.010s] from sage.crypto.mq.sr import test_consistency

Singular error: no more memory
System 1604712k:1604712k Appl 1450267k/23501k Malloc 1032k/0k Valloc 1472736k/23501k Pages 368184/0 Regions 2932:2932

halt 14

         [114.3 s]
```

I don't know whether this issue is upstream or caused by some of the Sage library patches, but it is certainly serious enough not to merge this ticket.

As a reference: before this ticket, every test passed with 2.2GB of RAM, with the most memory used by

```
sage -t -long devel/sage/sage/schemes/elliptic_curves/heegner.py
```




---

archive/issue_comments_114821.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-06T08:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114821",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114822.json:
```json
{
    "body": "Since the singular update fixes bugs that returned an incorrect result, I think the increased memory usage should be a separate ticket. If its a problem for the build bots, just pick a smaller ``#long`` example.\n\nOr in other words: http://dilbert.com/strips/comic/1995-06-24",
    "created_at": "2011-10-06T08:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114822",
    "user": "vbraun"
}
```

Since the singular update fixes bugs that returned an incorrect result, I think the increased memory usage should be a separate ticket. If its a problem for the build bots, just pick a smaller ``#long`` example.

Or in other words: http://dilbert.com/strips/comic/1995-06-24



---

archive/issue_comments_114823.json:
```json
{
    "body": "Volker, may I interpret your comment as \"I think the increased memory usage is not a big deal and we should merge this ticket anyway\"?\n\nI don't know about the buildbot, I have not yet tested.",
    "created_at": "2011-10-06T08:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114823",
    "user": "jdemeyer"
}
```

Volker, may I interpret your comment as "I think the increased memory usage is not a big deal and we should merge this ticket anyway"?

I don't know about the buildbot, I have not yet tested.



---

archive/issue_comments_114824.json:
```json
{
    "body": "Yes, that is what I meant. The increased memory usage should not prevent us from merging the Singular update into sage-4.7.2.\n\nMartin: Do you have any idea about what goes wrong in sr.py?",
    "created_at": "2011-10-06T08:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114824",
    "user": "vbraun"
}
```

Yes, that is what I meant. The increased memory usage should not prevent us from merging the Singular update into sage-4.7.2.

Martin: Do you have any idea about what goes wrong in sr.py?



---

archive/issue_comments_114825.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-10-06T09:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114825",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_114826.json:
```json
{
    "body": "Replying to [comment:91 vbraun]:\n> Yes, that is what I meant. The increased memory usage should not prevent us from merging the Singular update into sage-4.7.2.\n\nI totally understand what you mean but I disagree.  It's always hard when one has to make a choice of bugs: this ticket certainly fixes bugs but also introduces a serious bug.  If it is a memory leak, this will certainly affect people using Sage, so I don't think we can ignore this so easily.\n\nThe increased memory usage is not small either: given that Sage needs about 0.8GB by itself, the extra memory allocated for that test jumped from 0.4GB to 2.2GB.",
    "created_at": "2011-10-06T09:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114826",
    "user": "jdemeyer"
}
```

Replying to [comment:91 vbraun]:
> Yes, that is what I meant. The increased memory usage should not prevent us from merging the Singular update into sage-4.7.2.

I totally understand what you mean but I disagree.  It's always hard when one has to make a choice of bugs: this ticket certainly fixes bugs but also introduces a serious bug.  If it is a memory leak, this will certainly affect people using Sage, so I don't think we can ignore this so easily.

The increased memory usage is not small either: given that Sage needs about 0.8GB by itself, the extra memory allocated for that test jumped from 0.4GB to 2.2GB.



---

archive/issue_comments_114827.json:
```json
{
    "body": "Thanks to Martin's suggestion, I tracked the memory usage to this doctest:\n\n```\nsage: from sage.crypto.mq.sr import test_consistency\nsage: test_consistency(1)  # long time (80s on sage.math, 2011)\n```\n",
    "created_at": "2011-10-06T09:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114827",
    "user": "vbraun"
}
```

Thanks to Martin's suggestion, I tracked the memory usage to this doctest:

```
sage: from sage.crypto.mq.sr import test_consistency
sage: test_consistency(1)  # long time (80s on sage.math, 2011)
```




---

archive/issue_comments_114828.json:
```json
{
    "body": "Working at #11900, I observe that I get a very massive regression with #10903:\n\n```\nsage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)\nCPU times: user 54.17 s, sys: 0.49 s, total: 54.66 s\nWall time: 55.38 s\n```\n\n\nWith sage-4.7.2.alpha2 plus #9138 (which causes some regression in other examples), the example only takes 16.48 s, and with #11900 it reduces to 13.22 s.\n\nI am not totally sure that #11339/#10903 are really to blame for it, but it is at least possible.",
    "created_at": "2011-10-06T11:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114828",
    "user": "SimonKing"
}
```

Working at #11900, I observe that I get a very massive regression with #10903:

```
sage: %time for E in cremona_curves([11..100]): S = E.integral_points(both_signs=False)
CPU times: user 54.17 s, sys: 0.49 s, total: 54.66 s
Wall time: 55.38 s
```


With sage-4.7.2.alpha2 plus #9138 (which causes some regression in other examples), the example only takes 16.48 s, and with #11900 it reduces to 13.22 s.

I am not totally sure that #11339/#10903 are really to blame for it, but it is at least possible.



---

archive/issue_comments_114829.json:
```json
{
    "body": "In case someone should touch the spkg again, please also fix the Singular script generation in `spkg-install` by changing `$*` to `\"$`@`\"`.\n\nDo we still need the nanny `CFLAGS`, overriding a user's settings and forcing `-O2` on all platforms except Darwin?",
    "created_at": "2011-10-06T12:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114829",
    "user": "leif"
}
```

In case someone should touch the spkg again, please also fix the Singular script generation in `spkg-install` by changing `$*` to `"$`@`"`.

Do we still need the nanny `CFLAGS`, overriding a user's settings and forcing `-O2` on all platforms except Darwin?



---

archive/issue_comments_114830.json:
```json
{
    "body": "Replying to [comment:87 AlexanderDreyer]:\n> It seems, that kernel mod_raw.cc lacks the following:\n> \n\n```\n#if defined(ppcMac_darwin)\n#define HAVE_ELF_SYSTEM\n#endif\n```\n\n> \n> I already reported that upstream.\n\nFWIW, it builds on Linux PPC64 (POWER7, SLES 11, GCC 4.4.6), but it currently seems I get more doctest failures than before, i.e. Sage 4.7.2.alpha3 without #11339, the patches from here and the new spkg.\n\nHave to investigate that further.",
    "created_at": "2011-10-06T12:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114830",
    "user": "leif"
}
```

Replying to [comment:87 AlexanderDreyer]:
> It seems, that kernel mod_raw.cc lacks the following:
> 

```
#if defined(ppcMac_darwin)
#define HAVE_ELF_SYSTEM
#endif
```

> 
> I already reported that upstream.

FWIW, it builds on Linux PPC64 (POWER7, SLES 11, GCC 4.4.6), but it currently seems I get more doctest failures than before, i.e. Sage 4.7.2.alpha3 without #11339, the patches from here and the new spkg.

Have to investigate that further.



---

archive/issue_comments_114831.json:
```json
{
    "body": "I found the bug, I had accidentally remove one line too many when I removed some debugging code I introduced in #11339. And that line was the `p_Delete` in the polynomial destructor...",
    "created_at": "2011-10-06T15:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114831",
    "user": "vbraun"
}
```

I found the bug, I had accidentally remove one line too many when I removed some debugging code I introduced in #11339. And that line was the `p_Delete` in the polynomial destructor...



---

archive/issue_comments_114832.json:
```json
{
    "body": "one-",
    "created_at": "2011-10-06T15:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114832",
    "user": "vbraun"
}
```

one-



---

archive/issue_comments_114833.json:
```json
{
    "body": "Attachment [trac_10903_memleak_fix.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_memleak_fix.patch) by vbraun created at 2011-10-06 15:02:31",
    "created_at": "2011-10-06T15:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114833",
    "user": "vbraun"
}
```

Attachment [trac_10903_memleak_fix.patch](tarball://root/attachments/some-uuid/ticket10903/trac_10903_memleak_fix.patch) by vbraun created at 2011-10-06 15:02:31



---

archive/issue_comments_114834.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-06T15:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114834",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114835.json:
```json
{
    "body": "Testing right now...",
    "created_at": "2011-10-06T15:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114835",
    "user": "jdemeyer"
}
```

Testing right now...



---

archive/issue_comments_114836.json:
```json
{
    "body": "All patches together in one patch",
    "created_at": "2011-10-06T15:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114836",
    "user": "jdemeyer"
}
```

All patches together in one patch



---

archive/issue_comments_114837.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-06T15:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114837",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114838.json:
```json
{
    "body": "Attachment [10903_flat.patch](tarball://root/attachments/some-uuid/ticket10903/10903_flat.patch) by jdemeyer created at 2011-10-06 15:20:30\n\nThe memory leak seems to be fixed, so positive_review. Thanks Volker!\n\nI will do some timing tests, also regarding #9138 and #11900. So if I can confirm Simon King's observations, this ticket will need work.",
    "created_at": "2011-10-06T15:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114838",
    "user": "jdemeyer"
}
```

Attachment [10903_flat.patch](tarball://root/attachments/some-uuid/ticket10903/10903_flat.patch) by jdemeyer created at 2011-10-06 15:20:30

The memory leak seems to be fixed, so positive_review. Thanks Volker!

I will do some timing tests, also regarding #9138 and #11900. So if I can confirm Simon King's observations, this ticket will need work.



---

archive/issue_comments_114839.json:
```json
{
    "body": "As far as I can tell, this does not cause a slowdown, see sage-devel.",
    "created_at": "2011-10-06T16:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114839",
    "user": "jdemeyer"
}
```

As far as I can tell, this does not cause a slowdown, see sage-devel.



---

archive/issue_comments_114840.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-10-07T19:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114840",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_114841.json:
```json
{
    "body": "This **fails** to build on OS X 10.4 PPC:\n\n```\nMachine:\nDarwin moufang.ugent.be 8.11.0 Darwin Kernel Version 8.11.0: Wed Oct 10 18:26:00 PDT 2007; root:xnu-792.24.17~1/RELEASE_PPC Power Macintosh powerpc\nDeleting directories from past builds of previous/current versions of singular-3-1-3-3.p0\nExtracting package /Users/jdemeyer/sage-4.7.2.alpha4/spkg/standard/singular-3-1-3-3.p0.spkg ...\n-rw-r--r--   1 jdemeyer  jdemeyer  8420878 Oct  4 11:09 /Users/jdemeyer/sage-4.7.2.alpha4/spkg/standard/singular-3-1-3-3.p0.spkg\nFinished extraction\n****************************************************\nHost system\nuname -a:\nDarwin moufang.ugent.be 8.11.0 Darwin Kernel Version 8.11.0: Wed Oct 10 18:26:00 PDT 2007; root:xnu-792.24.17~1/RELEASE_PPC Power Macintosh powerpc\n****************************************************\n****************************************************\nCC Version\ngcc -v\nUsing built-in specs.\nTarget: powerpc-apple-darwin8\nConfigured with: /private/var/tmp/gcc/gcc-5367.obj~1/src/configure --disable-checking -enable-werror --prefix=/usr --mandir=/share/man --enable-languages=c,objc,c++,obj-c++ --program-transform-name=/^[cg][^.-]*$/s/$/-4.0/ --with-gxx-include-dir=/include/c++/4.0.0 --with-slibdir=/usr/lib --build=powerpc-apple-darwin8 --host=powerpc-apple-darwin8 --target=powerpc-apple-darwin8\nThread model: posix\ngcc version 4.0.1 (Apple Computer, Inc. build 5367)\n****************************************************\n~/sage-4.7.2.alpha4/spkg/build/singular-3-1-3-3.p0/src ~/sage-4.7.2.alpha4/spkg/build/singular-3-1-3-3.p0\npatching file factory/assert.h\npatching file Singular/configure\n~/sage-4.7.2.alpha4/spkg/build/singular-3-1-3-3.p0\nmake[2]: *** No rule to make target `distclean'.  Stop.\nrm: /Users/jdemeyer/sage-4.7.2.alpha4/local/bin/Singular*: No such file or directory\ncreating cache ./config.cache\nchecking uname for singular... ppcMac-darwin\nchecking for gcc... gcc\nchecking whether the C compiler (gcc  -O3 -g -fPIC ) works... yes\nchecking whether the C compiler (gcc  -O3 -g -fPIC ) is a cross-compiler... no\n[...]\ng++ -O3 -g -fPIC -I.. -I/Users/jdemeyer/sage-4.7.2.alpha4/local -pipe -I. -I.. -I/Users/jdemeyer/sage-4.7.2.alpha4/local -I/Users/jdemeyer/sage-4.7.2.alpha4/local/include -I/Users/jdemeyer/sage-4.7.2.alpha4/local/include -I/Users/jdemeyer/sage-4.7.2.alpha4/local/include   -fno-implicit-templates -I.. -I/Users/jdemeyer/sage-4.7.2.alpha4/local -DNDEBUG -DOM_NDEBUG -DppcMac_darwin -DHAVE_CONFIG_H \\\n  -o Singular \\\n  tesths.cc iparith.o mpsr_Tok.o claptmpl.o\\\n  grammar.o scanner.o attrib.o blackbox.o eigenval_ip.o extra.o fehelp.o feOpt.o ipassign.o ipconv.o ipid.o iplib.o ipprint.o ipshell.o newstruct.o lists.o sdb.o fglm.o interpolation.o silink.o ssiLink.o subexpr.o janet.o wrapper.o libparse.o sing_win.o gms.o pcv.o maps_ip.o walk.o walk_ip.o cntrlc.o misc_ip.o calcSVD.o pipeLink.o Minor.o MinorProcessor.o MinorInterface.o bigintm.o pyobject_setup.o bbcone.o bbfan.o denom_list.o minpoly.o  slInit_Static.o mpsr_Put.o mpsr_PutPoly.o mpsr_GetPoly.o mpsr_sl.o mpsr_Get.o mpsr_GetMisc.o mpsr_Error.o  ndbm.o sing_dbm.o -dynamic -L/Users/jdemeyer/sage-4.7.2.alpha4/local/kernel -L../kernel -lkernel -L/Users/jdemeyer/sage-4.7.2.alpha4/local/lib -L/Users/jdemeyer/sage-4.7.2.alpha4/local/lib   -ldl -lm -lsingfac -lsingcf -lntl -lgmp -lreadline -lncurses -lm   -lomalloc_ndebug  ../kernel/mmalloc.o\n/usr/bin/ld: warning -L: directory name (/Users/jdemeyer/sage-4.7.2.alpha4/local/kernel) does not exist\n/usr/bin/ld: Undefined symbols:\n_dynl_close\n_dynl_error\n_dynl_open\n_dynl_sym\ncollect2: ld returned 1 exit status\nmake[4]: *** [Singular] Error 1\nmake[3]: *** [install] Error 1\nmake[2]: *** [/Users/jdemeyer/sage-4.7.2.alpha4/local/bin/Singular-3-1-3] Error 2\n```\n",
    "created_at": "2011-10-10T07:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114841",
    "user": "jdemeyer"
}
```

This **fails** to build on OS X 10.4 PPC:

```
Machine:
Darwin moufang.ugent.be 8.11.0 Darwin Kernel Version 8.11.0: Wed Oct 10 18:26:00 PDT 2007; root:xnu-792.24.17~1/RELEASE_PPC Power Macintosh powerpc
Deleting directories from past builds of previous/current versions of singular-3-1-3-3.p0
Extracting package /Users/jdemeyer/sage-4.7.2.alpha4/spkg/standard/singular-3-1-3-3.p0.spkg ...
-rw-r--r--   1 jdemeyer  jdemeyer  8420878 Oct  4 11:09 /Users/jdemeyer/sage-4.7.2.alpha4/spkg/standard/singular-3-1-3-3.p0.spkg
Finished extraction
****************************************************
Host system
uname -a:
Darwin moufang.ugent.be 8.11.0 Darwin Kernel Version 8.11.0: Wed Oct 10 18:26:00 PDT 2007; root:xnu-792.24.17~1/RELEASE_PPC Power Macintosh powerpc
****************************************************
****************************************************
CC Version
gcc -v
Using built-in specs.
Target: powerpc-apple-darwin8
Configured with: /private/var/tmp/gcc/gcc-5367.obj~1/src/configure --disable-checking -enable-werror --prefix=/usr --mandir=/share/man --enable-languages=c,objc,c++,obj-c++ --program-transform-name=/^[cg][^.-]*$/s/$/-4.0/ --with-gxx-include-dir=/include/c++/4.0.0 --with-slibdir=/usr/lib --build=powerpc-apple-darwin8 --host=powerpc-apple-darwin8 --target=powerpc-apple-darwin8
Thread model: posix
gcc version 4.0.1 (Apple Computer, Inc. build 5367)
****************************************************
~/sage-4.7.2.alpha4/spkg/build/singular-3-1-3-3.p0/src ~/sage-4.7.2.alpha4/spkg/build/singular-3-1-3-3.p0
patching file factory/assert.h
patching file Singular/configure
~/sage-4.7.2.alpha4/spkg/build/singular-3-1-3-3.p0
make[2]: *** No rule to make target `distclean'.  Stop.
rm: /Users/jdemeyer/sage-4.7.2.alpha4/local/bin/Singular*: No such file or directory
creating cache ./config.cache
checking uname for singular... ppcMac-darwin
checking for gcc... gcc
checking whether the C compiler (gcc  -O3 -g -fPIC ) works... yes
checking whether the C compiler (gcc  -O3 -g -fPIC ) is a cross-compiler... no
[...]
g++ -O3 -g -fPIC -I.. -I/Users/jdemeyer/sage-4.7.2.alpha4/local -pipe -I. -I.. -I/Users/jdemeyer/sage-4.7.2.alpha4/local -I/Users/jdemeyer/sage-4.7.2.alpha4/local/include -I/Users/jdemeyer/sage-4.7.2.alpha4/local/include -I/Users/jdemeyer/sage-4.7.2.alpha4/local/include   -fno-implicit-templates -I.. -I/Users/jdemeyer/sage-4.7.2.alpha4/local -DNDEBUG -DOM_NDEBUG -DppcMac_darwin -DHAVE_CONFIG_H \
  -o Singular \
  tesths.cc iparith.o mpsr_Tok.o claptmpl.o\
  grammar.o scanner.o attrib.o blackbox.o eigenval_ip.o extra.o fehelp.o feOpt.o ipassign.o ipconv.o ipid.o iplib.o ipprint.o ipshell.o newstruct.o lists.o sdb.o fglm.o interpolation.o silink.o ssiLink.o subexpr.o janet.o wrapper.o libparse.o sing_win.o gms.o pcv.o maps_ip.o walk.o walk_ip.o cntrlc.o misc_ip.o calcSVD.o pipeLink.o Minor.o MinorProcessor.o MinorInterface.o bigintm.o pyobject_setup.o bbcone.o bbfan.o denom_list.o minpoly.o  slInit_Static.o mpsr_Put.o mpsr_PutPoly.o mpsr_GetPoly.o mpsr_sl.o mpsr_Get.o mpsr_GetMisc.o mpsr_Error.o  ndbm.o sing_dbm.o -dynamic -L/Users/jdemeyer/sage-4.7.2.alpha4/local/kernel -L../kernel -lkernel -L/Users/jdemeyer/sage-4.7.2.alpha4/local/lib -L/Users/jdemeyer/sage-4.7.2.alpha4/local/lib   -ldl -lm -lsingfac -lsingcf -lntl -lgmp -lreadline -lncurses -lm   -lomalloc_ndebug  ../kernel/mmalloc.o
/usr/bin/ld: warning -L: directory name (/Users/jdemeyer/sage-4.7.2.alpha4/local/kernel) does not exist
/usr/bin/ld: Undefined symbols:
_dynl_close
_dynl_error
_dynl_open
_dynl_sym
collect2: ld returned 1 exit status
make[4]: *** [Singular] Error 1
make[3]: *** [install] Error 1
make[2]: *** [/Users/jdemeyer/sage-4.7.2.alpha4/local/bin/Singular-3-1-3] Error 2
```




---

archive/issue_comments_114842.json:
```json
{
    "body": "Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87\n\nI don't have access to a PPC Mac.",
    "created_at": "2011-10-10T07:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114842",
    "user": "vbraun"
}
```

Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87

I don't have access to a PPC Mac.



---

archive/issue_comments_114843.json:
```json
{
    "body": "Replying to [comment:104 vbraun]:\n> Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87\nI think so. Unfortunately I do not have spare time to provida a proper patches spkg :-(\n\n> I don't have access to a PPC Mac. \nI could test the spkg.",
    "created_at": "2011-10-10T08:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114843",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:104 vbraun]:
> Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87
I think so. Unfortunately I do not have spare time to provida a proper patches spkg :-(

> I don't have access to a PPC Mac. 
I could test the spkg.



---

archive/issue_comments_114844.json:
```json
{
    "body": "Replying to [comment:104 vbraun]:\n> Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87\n\nYes.  Making a new spkg...",
    "created_at": "2011-10-10T08:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114844",
    "user": "jdemeyer"
}
```

Replying to [comment:104 vbraun]:
> Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87

Yes.  Making a new spkg...



---

archive/issue_comments_114845.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2011-10-10T08:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114845",
    "user": "jdemeyer"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_114846.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2011-10-10T08:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114846",
    "user": "jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_114847.json:
```json
{
    "body": "New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.",
    "created_at": "2011-10-10T09:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114847",
    "user": "jdemeyer"
}
```

New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.



---

archive/issue_comments_114848.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-10T09:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114848",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_114849.json:
```json
{
    "body": "Replying to [comment:104 vbraun]:\n> Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87\n\nWell, smells more as if `--without-dynamic-kernel` does no longer work... (which we pass on any OS but Linux)\n\n\n\n\nRegarding the ELF fix, cf. [comment:ticket:10810:5 this comment]...\n\n(I also thought Alexander's fix was already incorporated into the p0 spkg.)",
    "created_at": "2011-10-10T14:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114849",
    "user": "leif"
}
```

Replying to [comment:104 vbraun]:
> Would that be fixed by Alexander's suggestion in http://trac.sagemath.org/sage_trac/ticket/10903#comment:87

Well, smells more as if `--without-dynamic-kernel` does no longer work... (which we pass on any OS but Linux)




Regarding the ELF fix, cf. [comment:ticket:10810:5 this comment]...

(I also thought Alexander's fix was already incorporated into the p0 spkg.)



---

archive/issue_comments_114850.json:
```json
{
    "body": "Replying to [comment:108 jdemeyer]:\n> New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.\n\n\n```\n * Exit when `patch` fails.  We do not print an error message, patch is \n   verbose enough by itself.\n```\n\n\nNot true. `patch`'s error messages do not start with `Error` nor `Failed`, such that it's hard to find out which spkg actually failed to build / install in parallel builds.\n\nIf you don't want to apply the patches in a loop (prepending numbers to [some of] the patches could force the proper order), you should use something like\n\n```sh\npatch_error()\n{\n    echo >&2 \"Error: Patch failed to apply.\"\n    exit 1\n}\n\n...\n\n    patch -p1 < ... || patch_error\n\n...\n```\n\nor use the weirdly-named `success()` function.",
    "created_at": "2011-10-10T14:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114850",
    "user": "leif"
}
```

Replying to [comment:108 jdemeyer]:
> New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.


```
 * Exit when `patch` fails.  We do not print an error message, patch is 
   verbose enough by itself.
```


Not true. `patch`'s error messages do not start with `Error` nor `Failed`, such that it's hard to find out which spkg actually failed to build / install in parallel builds.

If you don't want to apply the patches in a loop (prepending numbers to [some of] the patches could force the proper order), you should use something like

```sh
patch_error()
{
    echo >&2 "Error: Patch failed to apply."
    exit 1
}

...

    patch -p1 < ... || patch_error

...
```

or use the weirdly-named `success()` function.



---

archive/issue_comments_114851.json:
```json
{
    "body": "Replying to [comment:109 leif]:\n> Well, smells more as if `--without-dynamic-kernel` does no longer work... (which we pass on any OS but Linux)\nIndeed - intended or not - it's still in the spkg.\n\n> Regarding the ELF fix, cf. [comment:ticket:10810:5 this comment]...\nIt's not that easy: OS X question does not define __ELF__, because it's MACH, not an ELF. Singular just needs an ELF-compatible dlopen here. (So maybe `HAVE_ELF_SYSTEM` is a misleading macro name.",
    "created_at": "2011-10-10T19:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114851",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:109 leif]:
> Well, smells more as if `--without-dynamic-kernel` does no longer work... (which we pass on any OS but Linux)
Indeed - intended or not - it's still in the spkg.

> Regarding the ELF fix, cf. [comment:ticket:10810:5 this comment]...
It's not that easy: OS X question does not define __ELF__, because it's MACH, not an ELF. Singular just needs an ELF-compatible dlopen here. (So maybe `HAVE_ELF_SYSTEM` is a misleading macro name.



---

archive/issue_comments_114852.json:
```json
{
    "body": "Replying to [comment:109 leif]:\n> Well, smells more as if `--without-dynamic-kernel` does no longer work... (which we pass on any OS but Linux)\nBut `--with-dl` is active. Even thought we do not load parts of the kernel dynamically, we can load other dynamic modules (for instance, there is an experimental python interface for Singular).",
    "created_at": "2011-10-10T19:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114852",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:109 leif]:
> Well, smells more as if `--without-dynamic-kernel` does no longer work... (which we pass on any OS but Linux)
But `--with-dl` is active. Even thought we do not load parts of the kernel dynamically, we can load other dynamic modules (for instance, there is an experimental python interface for Singular).



---

archive/issue_comments_114853.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2011-10-10T20:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114853",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_114854.json:
```json
{
    "body": "Replying to [comment:110 leif]:\n> Replying to [comment:108 jdemeyer]:\n> > New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.\n> \n> {{{\n>  * Exit when `patch` fails.  We do not print an error message, patch is \n>    verbose enough by itself.\n> }}}\n> \n> Not true. `patch`'s error messages do not start with `Error` nor `Failed`, such that it's hard to find out which spkg actually failed to build / install in parallel builds.\n\nWhat do you mean with this?  How is the message\n\n```\nError: Patch failed to apply.\n```\n\nmore clear than something like\n\n```\n1 out of 7 hunks FAILED -- saving rejects to file sage/rings/number_field/number_field_element.pyx.rej\n```\n\nIn any case, I don't see what this has to do with parallel builds.\n\nCan anybody tell me how we should proceed?",
    "created_at": "2011-10-10T20:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114854",
    "user": "jdemeyer"
}
```

Replying to [comment:110 leif]:
> Replying to [comment:108 jdemeyer]:
> > New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.
> 
> {{{
>  * Exit when `patch` fails.  We do not print an error message, patch is 
>    verbose enough by itself.
> }}}
> 
> Not true. `patch`'s error messages do not start with `Error` nor `Failed`, such that it's hard to find out which spkg actually failed to build / install in parallel builds.

What do you mean with this?  How is the message

```
Error: Patch failed to apply.
```

more clear than something like

```
1 out of 7 hunks FAILED -- saving rejects to file sage/rings/number_field/number_field_element.pyx.rej
```

In any case, I don't see what this has to do with parallel builds.

Can anybody tell me how we should proceed?



---

archive/issue_comments_114855.json:
```json
{
    "body": "Leif wants to be able to grep the install.log for \"Error\", I think. Thats not particularly high on my agenda, though. Especially since patch will either already fail at the developer's machine or always work (assuming that the hardware is working).",
    "created_at": "2011-10-10T20:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114855",
    "user": "vbraun"
}
```

Leif wants to be able to grep the install.log for "Error", I think. Thats not particularly high on my agenda, though. Especially since patch will either already fail at the developer's machine or always work (assuming that the hardware is working).



---

archive/issue_comments_114856.json:
```json
{
    "body": "Replying to [comment:114 vbraun]:\n> Leif wants to be able to grep the install.log for \"Error\", I think. Thats not particularly high on my agenda, though. Especially since patch will either already fail at the developer's machine or always work (assuming that the hardware is working).\nBTW: So it's not mandatory anymore to \"unroll\" patches in the spkg, i.e. to deliver the patched file and use `cp`? \nDespite of this, you're right from my point of view.",
    "created_at": "2011-10-10T20:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114856",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:114 vbraun]:
> Leif wants to be able to grep the install.log for "Error", I think. Thats not particularly high on my agenda, though. Especially since patch will either already fail at the developer's machine or always work (assuming that the hardware is working).
BTW: So it's not mandatory anymore to "unroll" patches in the spkg, i.e. to deliver the patched file and use `cp`? 
Despite of this, you're right from my point of view.



---

archive/issue_comments_114857.json:
```json
{
    "body": "Replying to [comment:108 jdemeyer]:\n> New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.\nThe new spkg builds and installs on SuSE 11 amd64 and OS X 10.5 ppc. The tests are running (fine so far). Somebody should test it on Solaris though.",
    "created_at": "2011-10-10T21:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114857",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:108 jdemeyer]:
> New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.
The new spkg builds and installs on SuSE 11 amd64 and OS X 10.5 ppc. The tests are running (fine so far). Somebody should test it on Solaris though.



---

archive/issue_comments_114858.json:
```json
{
    "body": "Replying to [comment:115 AlexanderDreyer]:\n> BTW: So it's not mandatory anymore to \"unroll\" patches in the spkg, i.e. to deliver the patched file and use `cp`? \n\nNot any more, we have included patch as a standard spkg!",
    "created_at": "2011-10-10T21:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114858",
    "user": "vbraun"
}
```

Replying to [comment:115 AlexanderDreyer]:
> BTW: So it's not mandatory anymore to "unroll" patches in the spkg, i.e. to deliver the patched file and use `cp`? 

Not any more, we have included patch as a standard spkg!



---

archive/issue_comments_114859.json:
```json
{
    "body": "Replying to [comment:117 vbraun]:\n> Not any more, we have included patch as a standard spkg!\nNice!",
    "created_at": "2011-10-10T22:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114859",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:117 vbraun]:
> Not any more, we have included patch as a standard spkg!
Nice!



---

archive/issue_comments_114860.json:
```json
{
    "body": "Replying to [comment:113 jdemeyer]:\n> Replying to [comment:110 leif]:\n> > Replying to [comment:108 jdemeyer]:\n> > > New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.\n> > \n\n```\n * Exit when `patch` fails.  We do not print an error message, patch is \n   verbose enough by itself.\n```\n\n> > \n> > Not true. `patch`'s error messages do not start with `Error` nor `Failed`, such that it's hard to find out which spkg actually failed to build / install in parallel builds.\n> \n> What do you mean with this?  How is the message\n\n```\nError: Patch failed to apply.\n```\n\n> more clear than something like\n\n```\n1 out of 7 hunks FAILED -- saving rejects to file sage/rings/number_field/number_field_element.pyx.rej\n```\n\n\nIt isn't more clear (the \"Error: ...\" would be printed *in addition* anyway, although an \"ordinary\" user would perhaps not know what a hunk is or the message is all about), but you can easily grep for it, so *every* error message should start with \"Failed\" or (preferably) \"Error\".\n\n(Volker, btw., the new ATLAS spkg is an IMHO poor counterexample to that, as it raises unhandled exceptions such that one gets tracebacks instead of meaningful error messages.)\n\nThe Sage library, which is built in parallel *by default*, is also a bad exception to this; it's often hard to see what really failed, not to mention the odd warnings about `-Wstrict-prototypes` not being valid for C++.\n\n\n\n\n> In any case, I don't see what this has to do with parallel builds.\n\nWell, the screen output (and hence `install.log`) is pretty messed up in parallel builds, and `make` usually doesn't stop immediately if one spkg fails to build, but continues and waits for other jobs to finish. [Another issue is that `stdout` and `stderr` frequently get \"out of sync\".]\n\nTo see what went wrong or which spkgs failed to build / didn't pass the (self-)test suite, one can usually do\n\n```sh\n$ egrep '^(Error|Failed) ' spkg/logs/*\n```\n\nwith variations on `-i`, `-h`, `-n` and `-A/B/C...` etc.\n\nIt wouldn't be bad to add something similar to the top-level `Makefile`; since we always *append* to the logs, we could create a fresh temporary log file upon every build and let `sage-spkg` write to it whenever a build or running `spkg-check` failed, such that an informative summary can be printed at the end, at least on errors. (We could also log the so far successfully built spkgs somewhere, such that one can `tail -f` that file, perhaps even with timings or date/time, \"i/N spkgs built\".)\n\n\n\n\n> Can anybody tell me how we should proceed?\n\nWell, it's a minor issue of course.  But we should IMHO avoid such in the future.\n\n\nI still cannot really tell whether this spkg (along with the patches) causes *more* doctests to fail on Linux PPC64 (the Skynet machine Silius; SLES 11.1, POWER7), since I've experimented with various things on that machine, and I haven't yet had the time to reliably compare builds which really only differ w.r.t. this ticket (and #11339).\n\nIn case this ticket should cause more problems on that platform, we could (hopefully) fix these on a follow-up, since there are other spkgs which apparently are still broken on it (also depending on the compiler version and options), so building Sage there is currently pretty experimental anyway.",
    "created_at": "2011-10-11T01:20:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114860",
    "user": "leif"
}
```

Replying to [comment:113 jdemeyer]:
> Replying to [comment:110 leif]:
> > Replying to [comment:108 jdemeyer]:
> > > New spkg needs review: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  See [attachment:singular-3-1-3-3.p0-p1.diff] for changes.
> > 

```
 * Exit when `patch` fails.  We do not print an error message, patch is 
   verbose enough by itself.
```

> > 
> > Not true. `patch`'s error messages do not start with `Error` nor `Failed`, such that it's hard to find out which spkg actually failed to build / install in parallel builds.
> 
> What do you mean with this?  How is the message

```
Error: Patch failed to apply.
```

> more clear than something like

```
1 out of 7 hunks FAILED -- saving rejects to file sage/rings/number_field/number_field_element.pyx.rej
```


It isn't more clear (the "Error: ..." would be printed *in addition* anyway, although an "ordinary" user would perhaps not know what a hunk is or the message is all about), but you can easily grep for it, so *every* error message should start with "Failed" or (preferably) "Error".

(Volker, btw., the new ATLAS spkg is an IMHO poor counterexample to that, as it raises unhandled exceptions such that one gets tracebacks instead of meaningful error messages.)

The Sage library, which is built in parallel *by default*, is also a bad exception to this; it's often hard to see what really failed, not to mention the odd warnings about `-Wstrict-prototypes` not being valid for C++.




> In any case, I don't see what this has to do with parallel builds.

Well, the screen output (and hence `install.log`) is pretty messed up in parallel builds, and `make` usually doesn't stop immediately if one spkg fails to build, but continues and waits for other jobs to finish. [Another issue is that `stdout` and `stderr` frequently get "out of sync".]

To see what went wrong or which spkgs failed to build / didn't pass the (self-)test suite, one can usually do

```sh
$ egrep '^(Error|Failed) ' spkg/logs/*
```

with variations on `-i`, `-h`, `-n` and `-A/B/C...` etc.

It wouldn't be bad to add something similar to the top-level `Makefile`; since we always *append* to the logs, we could create a fresh temporary log file upon every build and let `sage-spkg` write to it whenever a build or running `spkg-check` failed, such that an informative summary can be printed at the end, at least on errors. (We could also log the so far successfully built spkgs somewhere, such that one can `tail -f` that file, perhaps even with timings or date/time, "i/N spkgs built".)




> Can anybody tell me how we should proceed?

Well, it's a minor issue of course.  But we should IMHO avoid such in the future.


I still cannot really tell whether this spkg (along with the patches) causes *more* doctests to fail on Linux PPC64 (the Skynet machine Silius; SLES 11.1, POWER7), since I've experimented with various things on that machine, and I haven't yet had the time to reliably compare builds which really only differ w.r.t. this ticket (and #11339).

In case this ticket should cause more problems on that platform, we could (hopefully) fix these on a follow-up, since there are other spkgs which apparently are still broken on it (also depending on the compiler version and options), so building Sage there is currently pretty experimental anyway.



---

archive/issue_comments_114861.json:
```json
{
    "body": "Replying to [comment:119 leif]:\n> To see what went wrong or which spkgs failed to build / didn't pass the (self-)test suite, one can usually do\n> {{{\n> #!sh\n> $ egrep '^(Error|Failed) ' spkg/logs/*\n> }}}\n> with variations on `-i`, `-h`, `-n` and `-A/B/C...` etc.\n\nBut every failed spkg also prints the message\n\n```\nsage: An error occurred while installing mpir-2.1.3.p5\nPlease email sage-devel http://groups.google.com/group/sage-devel\nexplaining the problem and send the relevant part of\nof /home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/install.log.  Describe your computer, operating system, etc.\nIf you want to try to fix the problem yourself, *don't* just cd to\n/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/spkg/build/mpir-2.1.3.p5 and type 'make check' or whatever is appropriate.\nInstead, the following commands setup all environment variables\ncorrectly and load a subshell for you to debug the error:\n(cd '/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/spkg/build/mpir-2.1.3.p5' && '/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/sage' -sh)\nWhen you are done debugging, you can type \"exit\" to leave the\nsubshell.\n```\n\n\nOne can easily `grep` for this to find out which package caused the problem and then look at `spkg/logs/$PACKAGENAME.log`.",
    "created_at": "2011-10-11T06:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114861",
    "user": "jdemeyer"
}
```

Replying to [comment:119 leif]:
> To see what went wrong or which spkgs failed to build / didn't pass the (self-)test suite, one can usually do
> {{{
> #!sh
> $ egrep '^(Error|Failed) ' spkg/logs/*
> }}}
> with variations on `-i`, `-h`, `-n` and `-A/B/C...` etc.

But every failed spkg also prints the message

```
sage: An error occurred while installing mpir-2.1.3.p5
Please email sage-devel http://groups.google.com/group/sage-devel
explaining the problem and send the relevant part of
of /home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/install.log.  Describe your computer, operating system, etc.
If you want to try to fix the problem yourself, *don't* just cd to
/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/spkg/build/mpir-2.1.3.p5 and type 'make check' or whatever is appropriate.
Instead, the following commands setup all environment variables
correctly and load a subshell for you to debug the error:
(cd '/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/spkg/build/mpir-2.1.3.p5' && '/home/buildbot/build/sage/iras-1/iras_full/build/sage-4.7.2.alpha4/sage' -sh)
When you are done debugging, you can type "exit" to leave the
subshell.
```


One can easily `grep` for this to find out which package caused the problem and then look at `spkg/logs/$PACKAGENAME.log`.



---

archive/issue_comments_114862.json:
```json
{
    "body": "Attachment [singular-3-1-3-3.p0-p1.diff](tarball://root/attachments/some-uuid/ticket10903/singular-3-1-3-3.p0-p1.diff) by jdemeyer created at 2011-10-11 07:31:55\n\ndiff for the new Singular spkg, for review only",
    "created_at": "2011-10-11T07:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114862",
    "user": "jdemeyer"
}
```

Attachment [singular-3-1-3-3.p0-p1.diff](tarball://root/attachments/some-uuid/ticket10903/singular-3-1-3-3.p0-p1.diff) by jdemeyer created at 2011-10-11 07:31:55

diff for the new Singular spkg, for review only



---

archive/issue_comments_114863.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-10-11T07:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114863",
    "user": "jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_114864.json:
```json
{
    "body": "New spkg with error messages for failed patches: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  Needs review.",
    "created_at": "2011-10-11T07:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114864",
    "user": "jdemeyer"
}
```

New spkg with error messages for failed patches: [http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/singular-3-1-3-3.p1.spkg).  Needs review.



---

archive/issue_comments_114865.json:
```json
{
    "body": "Looks good. I take it from your comment that it works on OSX/PPC. Positive review.",
    "created_at": "2011-10-11T08:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114865",
    "user": "vbraun"
}
```

Looks good. I take it from your comment that it works on OSX/PPC. Positive review.



---

archive/issue_comments_114866.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-11T08:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114866",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114867.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-10-11T09:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114867",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_114868.json:
```json
{
    "body": "Replying to [comment:122 vbraun]:\n> Looks good. I take it from your comment that it works on OSX/PPC. Positive review.\nFor the record: I also managed to build, install and succesfully run all tests on SuSE 11.1 SP1 and OSX 10.6 ppc.",
    "created_at": "2011-10-11T09:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114868",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:122 vbraun]:
> Looks good. I take it from your comment that it works on OSX/PPC. Positive review.
For the record: I also managed to build, install and succesfully run all tests on SuSE 11.1 SP1 and OSX 10.6 ppc.



---

archive/issue_comments_114869.json:
```json
{
    "body": "Replying to [comment:122 vbraun]:\n> Looks good.\n\nLooks better.\n\nBtw., I sometimes also grep for `\"An error\"`.  Grepping for `\"^(Error|Failed) \"` (perhaps with context, which doesn't make much sense in the former case) immediately shows you *what* went wrong.  Of course the logs of spkgs that are themselves built in parallel are sometimes harder to read.",
    "created_at": "2011-10-11T14:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114869",
    "user": "leif"
}
```

Replying to [comment:122 vbraun]:
> Looks good.

Looks better.

Btw., I sometimes also grep for `"An error"`.  Grepping for `"^(Error|Failed) "` (perhaps with context, which doesn't make much sense in the former case) immediately shows you *what* went wrong.  Of course the logs of spkgs that are themselves built in parallel are sometimes harder to read.



---

archive/issue_comments_114870.json:
```json
{
    "body": "trac_10903_singular-fixes.patch seems to remove the functionality of the parameter omit_underscore_names in sageinspect.py's sage_getvariablename(). Was that done on purpose?",
    "created_at": "2011-10-17T13:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10831",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10831#issuecomment-114870",
    "user": "saraedum"
}
```

trac_10903_singular-fixes.patch seems to remove the functionality of the parameter omit_underscore_names in sageinspect.py's sage_getvariablename(). Was that done on purpose?
