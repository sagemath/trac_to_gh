# Issue 29370: Fixup for ".homebrew-build-env: Set CPATH, LIBRARY_PATH instead of CPPFLAGS, LDFLAGS"

archive/issues_029370.json:
```json
{
    "body": "CC:  @jhpalmieri @dimpase @slel @kiwifb @isuruf @antonio-rojas @mwageringel @thierry-freebsd @vbraun\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29607\n\n",
    "created_at": "2020-04-28T04:00:10Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Fixup for \".homebrew-build-env: Set CPATH, LIBRARY_PATH instead of CPPFLAGS, LDFLAGS\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29370",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @dimpase @slel @kiwifb @isuruf @antonio-rojas @mwageringel @thierry-freebsd @vbraun



Issue created by migration from https://trac.sagemath.org/ticket/29607





---

archive/issue_comments_415997.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-04-28T04:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-415997",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_415998.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-04-28T04:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-415998",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_415999.json:
```json
{
    "body": "Tests at https://github.com/mkoeppe/sage/actions/runs/89771836",
    "created_at": "2020-04-28T04:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-415999",
    "user": "https://github.com/mkoeppe"
}
```

Tests at https://github.com/mkoeppe/sage/actions/runs/89771836



---

archive/issue_comments_416000.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-28T16:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416000",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_416001.json:
```json
{
    "body": "This works for me, with or without `gfortran`. With just #29562, `gfortran` does indeed fail. This branch doesn't apply cleanly on top of #29562, I think, but I don't know if that matters.",
    "created_at": "2020-04-28T16:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416001",
    "user": "https://github.com/jhpalmieri"
}
```

This works for me, with or without `gfortran`. With just #29562, `gfortran` does indeed fail. This branch doesn't apply cleanly on top of #29562, I think, but I don't know if that matters.



---

archive/issue_comments_416002.json:
```json
{
    "body": "Thanks! Actually this is fast-forward from #29562",
    "created_at": "2020-04-28T16:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416002",
    "user": "https://github.com/mkoeppe"
}
```

Thanks! Actually this is fast-forward from #29562



---

archive/issue_comments_416003.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-04-29T07:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416003",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_416004.json:
```json
{
    "body": "Seems to need more work, to fix a problem with singular on homebrew.",
    "created_at": "2020-04-29T07:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416004",
    "user": "https://github.com/mkoeppe"
}
```

Seems to need more work, to fix a problem with singular on homebrew.



---

archive/issue_comments_416005.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-29T16:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416005",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_416006.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-29T16:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416006",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_416007.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-04-29T17:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416007",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_416008.json:
```json
{
    "body": "cc'ing some of our singular experts",
    "created_at": "2020-04-29T18:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416008",
    "user": "https://github.com/mkoeppe"
}
```

cc'ing some of our singular experts



---

archive/issue_comments_416009.json:
```json
{
    "body": "But Sage doesn't use the system's Singular. I don't understand.",
    "created_at": "2020-04-29T18:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416009",
    "user": "https://github.com/jhpalmieri"
}
```

But Sage doesn't use the system's Singular. I don't understand.



---

archive/issue_comments_416010.json:
```json
{
    "body": "No, but some dependencies of Singular are coming from the system.",
    "created_at": "2020-04-29T19:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416010",
    "user": "https://github.com/mkoeppe"
}
```

No, but some dependencies of Singular are coming from the system.



---

archive/issue_comments_416011.json:
```json
{
    "body": "Do you know which packages? I haven't seen these doctest failures, but I could install more homebrew packages to try to reproduce them.",
    "created_at": "2020-04-29T19:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416011",
    "user": "https://github.com/jhpalmieri"
}
```

Do you know which packages? I haven't seen these doctest failures, but I could install more homebrew packages to try to reproduce them.



---

archive/issue_comments_416012.json:
```json
{
    "body": "The error can be reproduced in the standard homebrew environment set up by `tox -e local-homebrew-macos-standard -- ptest`.\n\nI am now trying with ` EXTRA_CONFIGURE_ARGS=\"--with-mp=mpir\" tox -e local-homebrew-macos-standard -- ptest` to disable use of homebrew's GMP.\n\nAny help with debugging this would be very welcome!",
    "created_at": "2020-04-29T19:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416012",
    "user": "https://github.com/mkoeppe"
}
```

The error can be reproduced in the standard homebrew environment set up by `tox -e local-homebrew-macos-standard -- ptest`.

I am now trying with ` EXTRA_CONFIGURE_ARGS="--with-mp=mpir" tox -e local-homebrew-macos-standard -- ptest` to disable use of homebrew's GMP.

Any help with debugging this would be very welcome!



---

archive/issue_comments_416013.json:
```json
{
    "body": "The failures can be seen, for example, in https://github.com/mkoeppe/sage/runs/628776278",
    "created_at": "2020-04-29T19:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416013",
    "user": "https://github.com/mkoeppe"
}
```

The failures can be seen, for example, in https://github.com/mkoeppe/sage/runs/628776278



---

archive/issue_comments_416014.json:
```json
{
    "body": "Looks like failures in the pexpect interface to singular if I read those logs correctly and I haven't missed anything. This make `readline` the number one suspect amongst `singular`'s dependencies (`ntl`, `gmp`, `cddlib`, `flint`).",
    "created_at": "2020-04-29T20:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416014",
    "user": "https://github.com/kiwifb"
}
```

Looks like failures in the pexpect interface to singular if I read those logs correctly and I haven't missed anything. This make `readline` the number one suspect amongst `singular`'s dependencies (`ntl`, `gmp`, `cddlib`, `flint`).



---

archive/issue_comments_416015.json:
```json
{
    "body": "I'll try `tox -e local-homebrew-macos-standard -- ptest`. In my current setup (in which I don't see any failures), the hints at the end of running `./configure` only suggest installing `cmake`, which implies (?) that I have everything in `homebrew-macos-standard` already. (The comment in `tox.ini` says \"Install all known system packages equivalent to standard packages that have spkg-configure.m4\", but it must actually require both an spkg-configure.m4 and distros/homebrew.txt, right?)",
    "created_at": "2020-04-29T20:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416015",
    "user": "https://github.com/jhpalmieri"
}
```

I'll try `tox -e local-homebrew-macos-standard -- ptest`. In my current setup (in which I don't see any failures), the hints at the end of running `./configure` only suggest installing `cmake`, which implies (?) that I have everything in `homebrew-macos-standard` already. (The comment in `tox.ini` says "Install all known system packages equivalent to standard packages that have spkg-configure.m4", but it must actually require both an spkg-configure.m4 and distros/homebrew.txt, right?)



---

archive/issue_comments_416016.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> I'll try `tox -e local-homebrew-macos-standard -- ptest`. In my current setup (in which I don't see any failures), the hints at the end of running `./configure` only suggest installing `cmake`, which implies (?) that I have everything in `homebrew-macos-standard` already. \n\nNote that tox installs its own copy of homebrew, independent of the one in /usr/local.\n\n> (The comment in `tox.ini` says \"Install all known system packages equivalent to standard packages that have spkg-configure.m4\", but it must actually require both an spkg-configure.m4 and distros/homebrew.txt, right?)\n\nRight, with this clarification it describes correctly the behavior for the `docker-....` environments. For `local-homebrew`, however, the implementation cheats a little bit (fixing this is one of the tasks of #29146). See line 323 of `tox.ini` to see how the system package list is determined:\n\n```\n    homebrew-standard:   bash -c 'PACKAGES=`sed \"s/#.*//;\" build/pkgs/*/distros/homebrew.txt`; {env:HOMEBREW}/bin/brew install $PACKAGES; {env:HOMEBREW}/bin/brew upgrade $PACKAGES'\n```\n\nSo it really just installs every package listed in any `homebrew.txt`",
    "created_at": "2020-04-29T21:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416016",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:22 jhpalmieri]:
> I'll try `tox -e local-homebrew-macos-standard -- ptest`. In my current setup (in which I don't see any failures), the hints at the end of running `./configure` only suggest installing `cmake`, which implies (?) that I have everything in `homebrew-macos-standard` already. 

Note that tox installs its own copy of homebrew, independent of the one in /usr/local.

> (The comment in `tox.ini` says "Install all known system packages equivalent to standard packages that have spkg-configure.m4", but it must actually require both an spkg-configure.m4 and distros/homebrew.txt, right?)

Right, with this clarification it describes correctly the behavior for the `docker-....` environments. For `local-homebrew`, however, the implementation cheats a little bit (fixing this is one of the tasks of #29146). See line 323 of `tox.ini` to see how the system package list is determined:

```
    homebrew-standard:   bash -c 'PACKAGES=`sed "s/#.*//;" build/pkgs/*/distros/homebrew.txt`; {env:HOMEBREW}/bin/brew install $PACKAGES; {env:HOMEBREW}/bin/brew upgrade $PACKAGES'
```

So it really just installs every package listed in any `homebrew.txt`



---

archive/issue_comments_416017.json:
```json
{
    "body": "Replying to [comment:21 fbissey]:\n> Looks like failures in the pexpect interface to singular if I read those logs correctly and I haven't missed anything. This make `readline` the number one suspect amongst `singular`'s dependencies (`ntl`, `gmp`, `cddlib`, `flint`).\nThanks, yes, that should be the top suspect!",
    "created_at": "2020-04-29T21:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416017",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:21 fbissey]:
> Looks like failures in the pexpect interface to singular if I read those logs correctly and I haven't missed anything. This make `readline` the number one suspect amongst `singular`'s dependencies (`ntl`, `gmp`, `cddlib`, `flint`).
Thanks, yes, that should be the top suspect!



---

archive/issue_comments_416018.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> In my current setup (in which I don't see any failures), the hints at the end of running `./configure` only suggest installing `cmake`, which implies (?) that I have everything in `homebrew-macos-standard` already. \nYes, I think so",
    "created_at": "2020-04-29T21:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416018",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:22 jhpalmieri]:
> In my current setup (in which I don't see any failures), the hints at the end of running `./configure` only suggest installing `cmake`, which implies (?) that I have everything in `homebrew-macos-standard` already. 
Yes, I think so



---

archive/issue_comments_416019.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> The error can be reproduced in the standard homebrew environment set up by `tox -e local-homebrew-macos-standard -- ptest`.\nThe error also shows in `local-homebrew-macos-python2-standard`.\n\nOn the other hand: `local-homebrew-macos-python3_pythonorg-minimal` (https://github.com/mkoeppe/sage/runs/628776310) and  `local-homebrew-macos-python2-minimal` are clean.",
    "created_at": "2020-04-29T23:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416019",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:19 mkoeppe]:
> The error can be reproduced in the standard homebrew environment set up by `tox -e local-homebrew-macos-standard -- ptest`.
The error also shows in `local-homebrew-macos-python2-standard`.

On the other hand: `local-homebrew-macos-python3_pythonorg-minimal` (https://github.com/mkoeppe/sage/runs/628776310) and  `local-homebrew-macos-python2-minimal` are clean.



---

archive/issue_comments_416020.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> I am now trying with ` EXTRA_CONFIGURE_ARGS=\"--with-mp=mpir\" tox -e local-homebrew-macos-standard -- ptest` to disable use of homebrew's GMP.\nThis build does not have the failure",
    "created_at": "2020-04-30T00:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416020",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:19 mkoeppe]:
> I am now trying with ` EXTRA_CONFIGURE_ARGS="--with-mp=mpir" tox -e local-homebrew-macos-standard -- ptest` to disable use of homebrew's GMP.
This build does not have the failure



---

archive/issue_comments_416021.json:
```json
{
    "body": "`EXTRA_CONFIGURE_ARGS=\"--without-system-readline\" tox -e local-homebrew-macos-standard -- ptest` has the failure",
    "created_at": "2020-04-30T04:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416021",
    "user": "https://github.com/mkoeppe"
}
```

`EXTRA_CONFIGURE_ARGS="--without-system-readline" tox -e local-homebrew-macos-standard -- ptest` has the failure



---

archive/issue_comments_416022.json:
```json
{
    "body": "Hum, I guess that could have predicted on the fact that only singular displayed the failure. Still, there is something fishy happening in `sage/interface/singular.py`. Incidentally, after scanning the singular libraries, it appears that `mpfr` is a direct dependency of `singular` - not just through `flint`. I certainly need to update the dependency list in Gentoo.",
    "created_at": "2020-04-30T04:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416022",
    "user": "https://github.com/kiwifb"
}
```

Hum, I guess that could have predicted on the fact that only singular displayed the failure. Still, there is something fishy happening in `sage/interface/singular.py`. Incidentally, after scanning the singular libraries, it appears that `mpfr` is a direct dependency of `singular` - not just through `flint`. I certainly need to update the dependency list in Gentoo.



---

archive/issue_comments_416023.json:
```json
{
    "body": "I'm testing `EXTRA_CONFIGURE_ARGS=\"--without-system-mpfr\" tox -e local-homebrew-macos-standard -- ptest` at the moment",
    "created_at": "2020-04-30T04:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416023",
    "user": "https://github.com/mkoeppe"
}
```

I'm testing `EXTRA_CONFIGURE_ARGS="--without-system-mpfr" tox -e local-homebrew-macos-standard -- ptest` at the moment



---

archive/issue_comments_416024.json:
```json
{
    "body": "Replying to [comment:30 mkoeppe]:\n> I'm testing `EXTRA_CONFIGURE_ARGS=\"--without-system-mpfr\" tox -e local-homebrew-macos-standard -- ptest` at the moment\n... which has the failure.",
    "created_at": "2020-04-30T06:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416024",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:30 mkoeppe]:
> I'm testing `EXTRA_CONFIGURE_ARGS="--without-system-mpfr" tox -e local-homebrew-macos-standard -- ptest` at the moment
... which has the failure.



---

archive/issue_comments_416025.json:
```json
{
    "body": "Here's a self-contained interaction with Singular in the bad build:\n\n```\n$ Singular \n                     SINGULAR                                 /  Development\n A Computer Algebra System for Polynomial Computations       /   version 4.1.1\n                                                           0<\n by: W. Decker, G.-M. Greuel, G. Pfister, H. Schoenemann     \\   Feb 2018\nFB Mathematik der Universitaet, D-67653 Kaiserslautern        \\\n> ring sage7=0,(x,y),dp;\n> def sage8=9*y^8 - 9*x^2*y^7 - 18*x^3*y^6 - 18*x^5*y^6 +9*x^6*y^4 + 18*x^7*y^5 + 36*x^8*y^4 + 9*x^10*y^4 - 18*x^11*y^2 -9*x^12*y^3 - 18*x^13*y^2 + 9*x^16;\n> def sage9=factorize(sage8);\nSingular : signal 11 (v: 4112):\ncurrent line:>>def sage9=factorize(sage8);<<\nSegment fault/Bus error occurred (r:1588272268)\nplease inform the authors\ntrying to restart...\n```\n",
    "created_at": "2020-04-30T18:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416025",
    "user": "https://github.com/mkoeppe"
}
```

Here's a self-contained interaction with Singular in the bad build:

```
$ Singular 
                     SINGULAR                                 /  Development
 A Computer Algebra System for Polynomial Computations       /   version 4.1.1
                                                           0<
 by: W. Decker, G.-M. Greuel, G. Pfister, H. Schoenemann     \   Feb 2018
FB Mathematik der Universitaet, D-67653 Kaiserslautern        \
> ring sage7=0,(x,y),dp;
> def sage8=9*y^8 - 9*x^2*y^7 - 18*x^3*y^6 - 18*x^5*y^6 +9*x^6*y^4 + 18*x^7*y^5 + 36*x^8*y^4 + 9*x^10*y^4 - 18*x^11*y^2 -9*x^12*y^3 - 18*x^13*y^2 + 9*x^16;
> def sage9=factorize(sage8);
Singular : signal 11 (v: 4112):
current line:>>def sage9=factorize(sage8);<<
Segment fault/Bus error occurred (r:1588272268)
please inform the authors
trying to restart...
```




---

archive/issue_comments_416026.json:
```json
{
    "body": "Self-contained command line test:\n\n```\necho \"ring sage7=0,(x,y),dp; factorize(9*y^8 - 9*x^2*y^7 - 18*x^3*y^6 - 18*x^5*y^6 +9*x^6*y^4 + 18*x^7*y^5 + 36*x^8*y^4 + 9*x^10*y^4 - 18*x^11*y^2 -9*x^12*y^3 - 18*x^13*y^2 + 9*x^16); \" | .tox/local-homebrew-macos-standard/local/bin/Singular | fgrep -q '[2]:'\n```\n",
    "created_at": "2020-04-30T19:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416026",
    "user": "https://github.com/mkoeppe"
}
```

Self-contained command line test:

```
echo "ring sage7=0,(x,y),dp; factorize(9*y^8 - 9*x^2*y^7 - 18*x^3*y^6 - 18*x^5*y^6 +9*x^6*y^4 + 18*x^7*y^5 + 36*x^8*y^4 + 9*x^10*y^4 - 18*x^11*y^2 -9*x^12*y^3 - 18*x^13*y^2 + 9*x^16); " | .tox/local-homebrew-macos-standard/local/bin/Singular | fgrep -q '[2]:'
```




---

archive/issue_comments_416027.json:
```json
{
    "body": "I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with\n\n```\nIn file included from build/cythonized/sage/tests/stl_vector.cpp:663:\n./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found\n#include <NTL/ZZ.h>\n```\n\nSage builds fine and passes tests (except for those at #29493) with `make ptestlong`.",
    "created_at": "2020-04-30T20:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416027",
    "user": "https://github.com/jhpalmieri"
}
```

I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with

```
In file included from build/cythonized/sage/tests/stl_vector.cpp:663:
./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found
#include <NTL/ZZ.h>
```

Sage builds fine and passes tests (except for those at #29493) with `make ptestlong`.



---

archive/issue_comments_416028.json:
```json
{
    "body": "Could you attach a log of the tox run?",
    "created_at": "2020-04-30T21:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416028",
    "user": "https://github.com/mkoeppe"
}
```

Could you attach a log of the tox run?



---

archive/issue_comments_416029.json:
```json
{
    "body": "I also see a testsuite segfault for FLINT\n\n```\n  [flint-2.5.2.p5]   make[3]: *** [../build/nmod_poly_mat/test/t-concat_vertical_RUN] Segmentation fault: 11\n```\n",
    "created_at": "2020-04-30T21:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416029",
    "user": "https://github.com/mkoeppe"
}
```

I also see a testsuite segfault for FLINT

```
  [flint-2.5.2.p5]   make[3]: *** [../build/nmod_poly_mat/test/t-concat_vertical_RUN] Segmentation fault: 11
```




---

archive/issue_comments_416030.json:
```json
{
    "body": "Replying to [comment:35 jhpalmieri]:\n> I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with\n> {{{\n> In file included from build/cythonized/sage/tests/stl_vector.cpp:663:\n> ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found\n> #include <NTL/ZZ.h>\n> }}}\n> Sage builds fine and passes tests (except for those at #29493) with `make ptestlong`.\n\nDo you happen to have NTL from homebrew installed in `/usr/local` (`brew info ntl`)?",
    "created_at": "2020-04-30T22:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416030",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:35 jhpalmieri]:
> I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with
> {{{
> In file included from build/cythonized/sage/tests/stl_vector.cpp:663:
> ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found
> #include <NTL/ZZ.h>
> }}}
> Sage builds fine and passes tests (except for those at #29493) with `make ptestlong`.

Do you happen to have NTL from homebrew installed in `/usr/local` (`brew info ntl`)?



---

archive/issue_comments_416031.json:
```json
{
    "body": "Replying to [comment:38 mkoeppe]:\n> Replying to [comment:35 jhpalmieri]:\n> > I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with\n> > {{{\n> > In file included from build/cythonized/sage/tests/stl_vector.cpp:663:\n> > ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found\n> > #include <NTL/ZZ.h>\n> > }}}\n> > Sage builds fine and passes tests (except for those at #29493) with `make ptestlong`.\n> \n> Do you happen to have NTL from homebrew installed in `/usr/local` (`brew info ntl`)?\n\nYes, I do.\n\n> Could you attach a log of the tox run? \n\nWhich file do you want? One of the ones in `logs`?\n\n```\n-rw-r--r--    1 palmieri  staff  275651 Apr 30 12:17 config.log\n-rw-r--r--    1 palmieri  staff  103409 Apr 30 13:17 install.log\n-rw-r--r--    1 palmieri  staff     914 Apr 30 10:26 local-homebrew-macos-standard-0.log\n-rw-r--r--    1 palmieri  staff     268 Apr 30 10:26 local-homebrew-macos-standard-1.log\ndrwxr-xr-x  153 palmieri  staff    4896 Apr 30 13:08 pkgs\n```\n\nOr should I just uninstall homebrew's ntl?",
    "created_at": "2020-04-30T22:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416031",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:38 mkoeppe]:
> Replying to [comment:35 jhpalmieri]:
> > I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with
> > {{{
> > In file included from build/cythonized/sage/tests/stl_vector.cpp:663:
> > ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found
> > #include <NTL/ZZ.h>
> > }}}
> > Sage builds fine and passes tests (except for those at #29493) with `make ptestlong`.
> 
> Do you happen to have NTL from homebrew installed in `/usr/local` (`brew info ntl`)?

Yes, I do.

> Could you attach a log of the tox run? 

Which file do you want? One of the ones in `logs`?

```
-rw-r--r--    1 palmieri  staff  275651 Apr 30 12:17 config.log
-rw-r--r--    1 palmieri  staff  103409 Apr 30 13:17 install.log
-rw-r--r--    1 palmieri  staff     914 Apr 30 10:26 local-homebrew-macos-standard-0.log
-rw-r--r--    1 palmieri  staff     268 Apr 30 10:26 local-homebrew-macos-standard-1.log
drwxr-xr-x  153 palmieri  staff    4896 Apr 30 13:08 pkgs
```

Or should I just uninstall homebrew's ntl?



---

archive/issue_comments_416032.json:
```json
{
    "body": "Just the terminal output if you still have it, otherwise `install.log` please",
    "created_at": "2020-04-30T22:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416032",
    "user": "https://github.com/mkoeppe"
}
```

Just the terminal output if you still have it, otherwise `install.log` please



---

archive/issue_comments_416033.json:
```json
{
    "body": "There is a problem with `/usr/local` interaction. FLINT's configure script is severely broken (that's not exactly news, but...): it puts `/usr/local/include/` in as explicit defaults and stuff there can override what we have in $SAGE_LOCAL.",
    "created_at": "2020-04-30T22:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416033",
    "user": "https://github.com/mkoeppe"
}
```

There is a problem with `/usr/local` interaction. FLINT's configure script is severely broken (that's not exactly news, but...): it puts `/usr/local/include/` in as explicit defaults and stuff there can override what we have in $SAGE_LOCAL.



---

archive/issue_comments_416034.json:
```json
{
    "body": "For flint, adding `--with-gmp=$SAGE_LOCAL` is fine even if gmp is not there and is found from the system.",
    "created_at": "2020-04-30T22:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416034",
    "user": "https://github.com/isuruf"
}
```

For flint, adding `--with-gmp=$SAGE_LOCAL` is fine even if gmp is not there and is found from the system.



---

archive/issue_comments_416035.json:
```json
{
    "body": "Attachment [tox.log](tarball://root/attachments/some-uuid/ticket29607/tox.log) by @jhpalmieri created at 2020-04-30 22:51:15\n\nI cut-and-pasted this from the terminal window.",
    "created_at": "2020-04-30T22:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416035",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [tox.log](tarball://root/attachments/some-uuid/ticket29607/tox.log) by @jhpalmieri created at 2020-04-30 22:51:15

I cut-and-pasted this from the terminal window.



---

archive/issue_comments_416036.json:
```json
{
    "body": "Replying to [comment:42 isuruf]:\n> For flint, adding `--with-gmp=$SAGE_LOCAL` is fine even if gmp is not there and is found from the system.\nYes, this is the fix that I am using now",
    "created_at": "2020-04-30T22:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416036",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:42 isuruf]:
> For flint, adding `--with-gmp=$SAGE_LOCAL` is fine even if gmp is not there and is found from the system.
Yes, this is the fix that I am using now



---

archive/issue_comments_416037.json:
```json
{
    "body": "Replying to [comment:39 jhpalmieri]:\n> Replying to [comment:38 mkoeppe]:\n> > Replying to [comment:35 jhpalmieri]:\n> > > I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with\n> > > {{{\n> > > In file included from build/cythonized/sage/tests/stl_vector.cpp:663:\n> > > ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found\n> > > #include <NTL/ZZ.h>\n> > > }}}\n> > > Sage builds fine and passes tests (except for those at #29493) with `make ptestlong`.\n> > \n> > Do you happen to have NTL from homebrew installed in `/usr/local` (`brew info ntl`)?\n\nFrom your log:\n\n```\n[sagelib-9.1.rc2]   g++ -bundle -undefined dynamic_lookup -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/local/lib build/temp.macosx-10.15-x86_64-3.7/build/cythonized/sage/symbolic/substitution_map.o -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/homebrew/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/homebrew/opt/openssl@1.1/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/homebrew/opt/sqlite/lib -lgmp -lpynac -lstdc++ -o build/lib.macosx-10.15-x86_64-3.7/sage/symbolic/substitution_map.cpython-37m-darwin.so\n2400\t  [sagelib-9.1.rc2]   In file included from build/cythonized/sage/tests/stl_vector.cpp:663:\n2401\t  [sagelib-9.1.rc2]   ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found\n2402\t  [sagelib-9.1.rc2]   #include <NTL/ZZ.h>\n2403\t  [sagelib-9.1.rc2]            ^~~~~~~~~~\n```\n\n\nThis is an interesting variant of the failure mode of #29000, #29448 - where `./configure` finds a library but then the package needing it does not. In this case, Homebrew's NTL in `/usr/local` is found by `./configure`. But we compile Python modules using ` g++ -bundle -undefined dynamic_lookup -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk`, where the `-isysroot` disables the use of `/usr/local`.",
    "created_at": "2020-04-30T23:18:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416037",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:39 jhpalmieri]:
> Replying to [comment:38 mkoeppe]:
> > Replying to [comment:35 jhpalmieri]:
> > > I can't even get Sage to build with `tox -e local-homebrew-macos-standard -- ptest` with this branch or without: the Sage library fails with
> > > {{{
> > > In file included from build/cythonized/sage/tests/stl_vector.cpp:663:
> > > ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found
> > > #include <NTL/ZZ.h>
> > > }}}
> > > Sage builds fine and passes tests (except for those at #29493) with `make ptestlong`.
> > 
> > Do you happen to have NTL from homebrew installed in `/usr/local` (`brew info ntl`)?

From your log:

```
[sagelib-9.1.rc2]   g++ -bundle -undefined dynamic_lookup -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/local/lib build/temp.macosx-10.15-x86_64-3.7/build/cythonized/sage/symbolic/substitution_map.o -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/homebrew/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/homebrew/opt/openssl@1.1/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/tox/sage-9.1.rc2/.tox/local-homebrew-macos-standard/homebrew/opt/sqlite/lib -lgmp -lpynac -lstdc++ -o build/lib.macosx-10.15-x86_64-3.7/sage/symbolic/substitution_map.cpython-37m-darwin.so
2400	  [sagelib-9.1.rc2]   In file included from build/cythonized/sage/tests/stl_vector.cpp:663:
2401	  [sagelib-9.1.rc2]   ./sage/libs/ntl/ntlwrap.h:5:10: fatal error: 'NTL/ZZ.h' file not found
2402	  [sagelib-9.1.rc2]   #include <NTL/ZZ.h>
2403	  [sagelib-9.1.rc2]            ^~~~~~~~~~
```


This is an interesting variant of the failure mode of #29000, #29448 - where `./configure` finds a library but then the package needing it does not. In this case, Homebrew's NTL in `/usr/local` is found by `./configure`. But we compile Python modules using ` g++ -bundle -undefined dynamic_lookup -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk`, where the `-isysroot` disables the use of `/usr/local`.



---

archive/issue_comments_416038.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-30T23:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416038",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_416039.json:
```json
{
    "body": "Replying to [comment:44 mkoeppe]:\n> Replying to [comment:42 isuruf]:\n> > For flint, adding `--with-gmp=$SAGE_LOCAL` is fine even if gmp is not there and is found from the system.\n> Yes, this is the fix that I am using now\n... in the commit above.\n\nProbably the `spkg-install` of other packages with the same build system as FLINT need to be changed in the same way.",
    "created_at": "2020-04-30T23:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416039",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:44 mkoeppe]:
> Replying to [comment:42 isuruf]:
> > For flint, adding `--with-gmp=$SAGE_LOCAL` is fine even if gmp is not there and is found from the system.
> Yes, this is the fix that I am using now
... in the commit above.

Probably the `spkg-install` of other packages with the same build system as FLINT need to be changed in the same way.



---

archive/issue_comments_416040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-01T00:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416040",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_416041.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-05-01T00:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416041",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_416042.json:
```json
{
    "body": "how is this going to work on systems where /usr/local (or suchlike, e.g these keg-only installs on Homebrew) needs to be spelled out for a library  location to be useful?\n\nWould this break FreeBSD? Thierry, care to test this branch?",
    "created_at": "2020-05-01T08:26:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416042",
    "user": "https://github.com/dimpase"
}
```

how is this going to work on systems where /usr/local (or suchlike, e.g these keg-only installs on Homebrew) needs to be spelled out for a library  location to be useful?

Would this break FreeBSD? Thierry, care to test this branch?



---

archive/issue_comments_416043.json:
```json
{
    "body": "As you know, `/usr/local` is part of the normal library and include search path of the compiler. It does not need a `-I` or `-L` option.",
    "created_at": "2020-05-01T15:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416043",
    "user": "https://github.com/mkoeppe"
}
```

As you know, `/usr/local` is part of the normal library and include search path of the compiler. It does not need a `-I` or `-L` option.



---

archive/issue_comments_416044.json:
```json
{
    "body": "Standard configure scripts do not deal with `/usr/local` specifically at all but only check what the compiler/linker is able to find.\nThe changes to the spkg-configure scripts for FLINT and arb only work around nonstandard behavior of their configure scripts.",
    "created_at": "2020-05-01T15:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416044",
    "user": "https://github.com/mkoeppe"
}
```

Standard configure scripts do not deal with `/usr/local` specifically at all but only check what the compiler/linker is able to find.
The changes to the spkg-configure scripts for FLINT and arb only work around nonstandard behavior of their configure scripts.



---

archive/issue_comments_416045.json:
```json
{
    "body": "Replying to [comment:53 mkoeppe]:\n> As you know, `/usr/local` is part of the normal library and include search path of the compiler. It does not need a `-I` or `-L` option.\n\nthis is not the case on FreeBSD.\nhttps://forums.freebsd.org/threads/clang-cant-find-headers-in-usr-local-include.74032/",
    "created_at": "2020-05-01T16:15:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416045",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:53 mkoeppe]:
> As you know, `/usr/local` is part of the normal library and include search path of the compiler. It does not need a `-I` or `-L` option.

this is not the case on FreeBSD.
https://forums.freebsd.org/threads/clang-cant-find-headers-in-usr-local-include.74032/



---

archive/issue_comments_416046.json:
```json
{
    "body": "now, as I recalled this, I am sure that this branch breaks building Sage on FreeBSD.",
    "created_at": "2020-05-01T16:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416046",
    "user": "https://github.com/dimpase"
}
```

now, as I recalled this, I am sure that this branch breaks building Sage on FreeBSD.



---

archive/issue_comments_416047.json:
```json
{
    "body": "Do other packages' configure scripts look for stuff in /usr/local on FreeBSD even though the compiler does not?",
    "created_at": "2020-05-01T16:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416047",
    "user": "https://github.com/mkoeppe"
}
```

Do other packages' configure scripts look for stuff in /usr/local on FreeBSD even though the compiler does not?



---

archive/issue_comments_416048.json:
```json
{
    "body": "On FreeBSD, if you do not use the ports mechanism, you are right, /usr/local is not in the default search paths for include and libs, but when you create (or modify) a port (I'm in this context), you just have to define:\n\n\n```\nUSES=localbase\n```\n\n\nto solve this common problem.",
    "created_at": "2020-05-01T16:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416048",
    "user": "https://github.com/thierry-FreeBSD"
}
```

On FreeBSD, if you do not use the ports mechanism, you are right, /usr/local is not in the default search paths for include and libs, but when you create (or modify) a port (I'm in this context), you just have to define:


```
USES=localbase
```


to solve this common problem.



---

archive/issue_comments_416049.json:
```json
{
    "body": "Now that we know what we need to know about FreeBSD, can we come back to the review of this ticket?",
    "created_at": "2020-05-01T17:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416049",
    "user": "https://github.com/mkoeppe"
}
```

Now that we know what we need to know about FreeBSD, can we come back to the review of this ticket?



---

archive/issue_comments_416050.json:
```json
{
    "body": "I think it's rather #29562 that needs to be done differently. \nI don't understand that `/usr/local` being \"always wrong\".\nWhat if I install GMP there and want to build Sage using it?\n\n\nActually, one just needs to use proper Homebrew formulae for arb and flint, as I experimented on\nhttps://github.com/sagemath/homebrew-science \n(and push the needed changes upstream)",
    "created_at": "2020-05-01T17:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416050",
    "user": "https://github.com/dimpase"
}
```

I think it's rather #29562 that needs to be done differently. 
I don't understand that `/usr/local` being "always wrong".
What if I install GMP there and want to build Sage using it?


Actually, one just needs to use proper Homebrew formulae for arb and flint, as I experimented on
https://github.com/sagemath/homebrew-science 
(and push the needed changes upstream)



---

archive/issue_comments_416051.json:
```json
{
    "body": "Replying to [comment:60 dimpase]:\n> I think it's rather #29562 that needs to be done differently. \n\nThe present ticket *is* changing what #29562 did.\n\n> I don't understand that `/usr/local` being \"always wrong\".\n\nLook at the configure scripts of FLINT and arb. They are putting `/usr/local` explicitly in the compiler and linker lines as -I and -L flags. This overrides correct paths that are configured by the user's CPATH and -I options etc.\n\n> What if I install GMP there and want to build Sage using it?\n\nYes, this still works. We do this on homebrew all the time.",
    "created_at": "2020-05-01T18:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416051",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:60 dimpase]:
> I think it's rather #29562 that needs to be done differently. 

The present ticket *is* changing what #29562 did.

> I don't understand that `/usr/local` being "always wrong".

Look at the configure scripts of FLINT and arb. They are putting `/usr/local` explicitly in the compiler and linker lines as -I and -L flags. This overrides correct paths that are configured by the user's CPATH and -I options etc.

> What if I install GMP there and want to build Sage using it?

Yes, this still works. We do this on homebrew all the time.



---

archive/issue_comments_416052.json:
```json
{
    "body": "How about we just patch these configure scripts to remove `-I /usr/local` etc?",
    "created_at": "2020-05-01T18:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416052",
    "user": "https://github.com/dimpase"
}
```

How about we just patch these configure scripts to remove `-I /usr/local` etc?



---

archive/issue_comments_416053.json:
```json
{
    "body": "How is this better than just providing the options that work?",
    "created_at": "2020-05-01T18:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416053",
    "user": "https://github.com/mkoeppe"
}
```

How is this better than just providing the options that work?



---

archive/issue_comments_416054.json:
```json
{
    "body": "Of course, an upstreamable patch for FLINT and arb would be good. Upstream indicates in https://github.com/wbhart/flint2/issues/400 that  2.6.0 (from FLINT trunk) is \"nearly out\" (as of 3 weeks ago). But I don't want to work on patches to a broken ad-hoc configure script at this point. FLINT trunk also has a CMake build system (not the default), so there is hope.",
    "created_at": "2020-05-01T19:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416054",
    "user": "https://github.com/mkoeppe"
}
```

Of course, an upstreamable patch for FLINT and arb would be good. Upstream indicates in https://github.com/wbhart/flint2/issues/400 that  2.6.0 (from FLINT trunk) is "nearly out" (as of 3 weeks ago). But I don't want to work on patches to a broken ad-hoc configure script at this point. FLINT trunk also has a CMake build system (not the default), so there is hope.



---

archive/issue_comments_416055.json:
```json
{
    "body": "I looked at arb's [./configure script](https://github.com/fredrik-johansson/arb/blob/master/configure), and don't see where they unconditionally put /usr/local anywhere.\n\nAre you sure it's not coming from somewhere else, e.g. some Homebrew flags set?",
    "created_at": "2020-05-02T06:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416055",
    "user": "https://github.com/dimpase"
}
```

I looked at arb's [./configure script](https://github.com/fredrik-johansson/arb/blob/master/configure), and don't see where they unconditionally put /usr/local anywhere.

Are you sure it's not coming from somewhere else, e.g. some Homebrew flags set?



---

archive/issue_comments_416056.json:
```json
{
    "body": "Replying to [comment:65 dimpase]:\n> I looked at arb's [./configure script](https://github.com/fredrik-johansson/arb/blob/master/configure), and don't see where they unconditionally put /usr/local anywhere.\n\nNo, not \"unconditionally\", which is exactly why this ticket is able to fix it by providing options to that configure script.\n\nFrom the diff:\n\n```\n+# Trac #29607: We must always supply --with-gmp, --with-mpfr,\n+# --with-flint because otherwise ARB's configure script uses\n+# /usr/local, which is always wrong.\n+# This is why we do not use $SAGE_CONFIGURE_GMP etc. here.\n+# The value $SAGE_LOCAL is always a safe choice even if the library\n+# is coming from the system and is found using what is in\n+# LIBRARY_PATH or LDFLAGS etc.\n```\n",
    "created_at": "2020-05-02T10:31:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416056",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:65 dimpase]:
> I looked at arb's [./configure script](https://github.com/fredrik-johansson/arb/blob/master/configure), and don't see where they unconditionally put /usr/local anywhere.

No, not "unconditionally", which is exactly why this ticket is able to fix it by providing options to that configure script.

From the diff:

```
+# Trac #29607: We must always supply --with-gmp, --with-mpfr,
+# --with-flint because otherwise ARB's configure script uses
+# /usr/local, which is always wrong.
+# This is why we do not use $SAGE_CONFIGURE_GMP etc. here.
+# The value $SAGE_LOCAL is always a safe choice even if the library
+# is coming from the system and is found using what is in
+# LIBRARY_PATH or LDFLAGS etc.
```




---

archive/issue_comments_416057.json:
```json
{
    "body": "What else can I explain to facilitate review?",
    "created_at": "2020-05-02T17:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416057",
    "user": "https://github.com/mkoeppe"
}
```

What else can I explain to facilitate review?



---

archive/issue_comments_416058.json:
```json
{
    "body": "How can you be sure that SAGE_LOCAL/include/ and SAGE_LOCAL/lib/ exist when arb is built?\n(If one of them does not exist then it will error out).",
    "created_at": "2020-05-02T17:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416058",
    "user": "https://github.com/dimpase"
}
```

How can you be sure that SAGE_LOCAL/include/ and SAGE_LOCAL/lib/ exist when arb is built?
(If one of them does not exist then it will error out).



---

archive/issue_comments_416059.json:
```json
{
    "body": "Sage's config.status creates them.\n\nAnd I have tested this ticket.",
    "created_at": "2020-05-02T17:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416059",
    "user": "https://github.com/mkoeppe"
}
```

Sage's config.status creates them.

And I have tested this ticket.



---

archive/issue_comments_416060.json:
```json
{
    "body": "OK, fine, sorry for sitting on it for too long.",
    "created_at": "2020-05-02T18:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416060",
    "user": "https://github.com/dimpase"
}
```

OK, fine, sorry for sitting on it for too long.



---

archive/issue_comments_416061.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-02T18:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416061",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_416062.json:
```json
{
    "body": "Thank you!",
    "created_at": "2020-05-02T18:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416062",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!



---

archive/issue_comments_416063.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-04T06:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29370#issuecomment-416063",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
