# Issue 13894: zn_poly-0.9.p9 fails at least one its tests on power7

archive/issues_013894.json:
```json
{
    "body": "Assignee: drkirkby\n\nCC:  @jdemeyer\n\nOn the login node of our power7 cluster (beatrice) zn_poly fails make check\n\n```\n(sage-sh) frb15@p2n14-c:src$ make check\ntest/test -quick all\nmpn_smp_basecase()... ok\nmpn_smp_kara()... make: *** [check] Segmentation fault (core dumped)\n```\n\nHere is a detailed backtrace\n\n```\n(gdb) r mpn_smp_kara\nStarting program: /hpc/scratch/frb15/sandbox/sage-5.7.beta4/spkg/build/zn_poly-0.9.p9/src/test/test mpn_smp_kara\nmpn_smp_kara()... \nProgram received signal SIGSEGV, Segmentation fault.\n0x00000400000dd3f0 in gmp_rrandomb (rp=0x0, rstate=0x40000134db8, nbits=17779444199848231480) at random2.c:67\n67      random2.c: No such file or directory.\n        in random2.c\n(gdb) bt\n#0  0x00000400000dd3f0 in gmp_rrandomb (rp=0x0, rstate=0x40000134db8, nbits=17779444199848231480) at random2.c:67\n#1  0x00000400000dd360 in __gmpn_random2 (rp=0x0, n=-5198573331259894519) at random2.c:54\n#2  0x000000001002c634 in ZNP_mpn_random2 (res=0x0, n=13248170742449657097) at test/support.c:107\n#3  0x0000000010027224 in testcase_mpn_smp_kara (n=6624085371224828549) at test/mpn_mulmid-test.c:89\n#4  0x0000000010027434 in test_mpn_smp_kara (quick=0) at test/mpn_mulmid-test.c:125\n#5  0x00000000100210dc in run_test (target=0x10041488, quick=0) at test/test.c:187\n#6  0x0000000010021450 in main (argc=2, argv=0xfffffffe5a8) at test/test.c:235\n(gdb) bt full\n#0  0x00000400000dd3f0 in gmp_rrandomb (rp=0x0, rstate=0x40000134db8, nbits=17779444199848231480) at random2.c:67\n        bi = 4398113622176\n        ranm = 268711088\n        cap_chunksize = 0\n        chunksize = 0\n        i = 277803815622628616\n#1  0x00000400000dd360 in __gmpn_random2 (rp=0x0, n=-5198573331259894519) at random2.c:54\n        rstate = 0x40000134db8\n        bit_pos = 8\n        ran = 3915822088\n        ranm = 3915822088\n#2  0x000000001002c634 in ZNP_mpn_random2 (res=0x0, n=13248170742449657097) at test/support.c:107\n        i = 0\n#3  0x0000000010027224 in testcase_mpn_smp_kara (n=6624085371224828549) at test/mpn_mulmid-test.c:89\n        buf1 = 0x0\n        buf2 = 0x0\n        ref = 0x0\n        res = 0x0\n        success = 1\n#4  0x0000000010027434 in test_mpn_smp_kara (quick=0) at test/mpn_mulmid-test.c:125\n        success = 1\n        n = 6624085371224828549\n        trial = 0\n#5  0x00000000100210dc in run_test (target=0x10041488, quick=0) at test/test.c:187\n        success = 4095\n#6  0x0000000010021450 in main (argc=2, argv=0xfffffffe5a8) at test/test.c:235\n        found = 1\n        all_success = 1\n        any_targets = 1\n        quick = 0\n        i = 33\n        j = 1\n(gdb) q\n```\n\nIt seems to point the finger at mpir.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14098\n\n",
    "created_at": "2013-02-11T20:21:46Z",
    "labels": [
        "porting",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.8",
    "title": "zn_poly-0.9.p9 fails at least one its tests on power7",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13894",
    "user": "@kiwifb"
}
```
Assignee: drkirkby

CC:  @jdemeyer

On the login node of our power7 cluster (beatrice) zn_poly fails make check

```
(sage-sh) frb15@p2n14-c:src$ make check
test/test -quick all
mpn_smp_basecase()... ok
mpn_smp_kara()... make: *** [check] Segmentation fault (core dumped)
```

Here is a detailed backtrace

```
(gdb) r mpn_smp_kara
Starting program: /hpc/scratch/frb15/sandbox/sage-5.7.beta4/spkg/build/zn_poly-0.9.p9/src/test/test mpn_smp_kara
mpn_smp_kara()... 
Program received signal SIGSEGV, Segmentation fault.
0x00000400000dd3f0 in gmp_rrandomb (rp=0x0, rstate=0x40000134db8, nbits=17779444199848231480) at random2.c:67
67      random2.c: No such file or directory.
        in random2.c
(gdb) bt
#0  0x00000400000dd3f0 in gmp_rrandomb (rp=0x0, rstate=0x40000134db8, nbits=17779444199848231480) at random2.c:67
#1  0x00000400000dd360 in __gmpn_random2 (rp=0x0, n=-5198573331259894519) at random2.c:54
#2  0x000000001002c634 in ZNP_mpn_random2 (res=0x0, n=13248170742449657097) at test/support.c:107
#3  0x0000000010027224 in testcase_mpn_smp_kara (n=6624085371224828549) at test/mpn_mulmid-test.c:89
#4  0x0000000010027434 in test_mpn_smp_kara (quick=0) at test/mpn_mulmid-test.c:125
#5  0x00000000100210dc in run_test (target=0x10041488, quick=0) at test/test.c:187
#6  0x0000000010021450 in main (argc=2, argv=0xfffffffe5a8) at test/test.c:235
(gdb) bt full
#0  0x00000400000dd3f0 in gmp_rrandomb (rp=0x0, rstate=0x40000134db8, nbits=17779444199848231480) at random2.c:67
        bi = 4398113622176
        ranm = 268711088
        cap_chunksize = 0
        chunksize = 0
        i = 277803815622628616
#1  0x00000400000dd360 in __gmpn_random2 (rp=0x0, n=-5198573331259894519) at random2.c:54
        rstate = 0x40000134db8
        bit_pos = 8
        ran = 3915822088
        ranm = 3915822088
#2  0x000000001002c634 in ZNP_mpn_random2 (res=0x0, n=13248170742449657097) at test/support.c:107
        i = 0
#3  0x0000000010027224 in testcase_mpn_smp_kara (n=6624085371224828549) at test/mpn_mulmid-test.c:89
        buf1 = 0x0
        buf2 = 0x0
        ref = 0x0
        res = 0x0
        success = 1
#4  0x0000000010027434 in test_mpn_smp_kara (quick=0) at test/mpn_mulmid-test.c:125
        success = 1
        n = 6624085371224828549
        trial = 0
#5  0x00000000100210dc in run_test (target=0x10041488, quick=0) at test/test.c:187
        success = 4095
#6  0x0000000010021450 in main (argc=2, argv=0xfffffffe5a8) at test/test.c:235
        found = 1
        all_success = 1
        any_targets = 1
        quick = 0
        i = 33
        j = 1
(gdb) q
```

It seems to point the finger at mpir.

Issue created by migration from https://trac.sagemath.org/ticket/14098





---

archive/issue_comments_172962.json:
```json
{
    "body": "Note this is the quick test always run with zn_poly. It passes in 5.7beta3 without debug and it fails in beta4 with SAGE_DEBUG=yes.",
    "created_at": "2013-02-11T20:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172962",
    "user": "@kiwifb"
}
```

Note this is the quick test always run with zn_poly. It passes in 5.7beta3 without debug and it fails in beta4 with SAGE_DEBUG=yes.



---

archive/issue_comments_172963.json:
```json
{
    "body": "the `__gmpn_random2 (rp=0x0, n=-5198573331259894519)` call is very suspicious, since the second argument should be a size in limbs.\n\nPaul",
    "created_at": "2013-02-12T08:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172963",
    "user": "@zimmermann6"
}
```

the `__gmpn_random2 (rp=0x0, n=-5198573331259894519)` call is very suspicious, since the second argument should be a size in limbs.

Paul



---

archive/issue_comments_172964.json:
```json
{
    "body": "Hi Paul,\n\nI suspect that the problem is triggered when enabling the debugging code, furthermore zn_poly itself is built with -DNDEBUG regardless of SAGE_DEBUG=yes. I am wondering if it could cause the problem.\n\nFrancois",
    "created_at": "2013-02-12T08:33:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172964",
    "user": "@kiwifb"
}
```

Hi Paul,

I suspect that the problem is triggered when enabling the debugging code, furthermore zn_poly itself is built with -DNDEBUG regardless of SAGE_DEBUG=yes. I am wondering if it could cause the problem.

Francois



---

archive/issue_comments_172965.json:
```json
{
    "body": "Very odd. The main code is always compiled with -DNDEBUG - no option to turn it of. But the code for the test which fails is all compiled with -DDEBUG - no turning it off either. So it must happening when SAGE_DEBUG is turned on for some other component of sage. Since no one else seem to have seen it before it has to be a power7 specific problem.",
    "created_at": "2013-02-12T22:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172965",
    "user": "@kiwifb"
}
```

Very odd. The main code is always compiled with -DNDEBUG - no option to turn it of. But the code for the test which fails is all compiled with -DDEBUG - no turning it off either. So it must happening when SAGE_DEBUG is turned on for some other component of sage. Since no one else seem to have seen it before it has to be a power7 specific problem.



---

archive/issue_comments_172966.json:
```json
{
    "body": "To continue on what you started Paul in\n\n```\ntestcase_mpn_smp_kara (n=6624085371224828549)\n```\n\nn is supposed to be a size_t so I think we have a gross overflow somewhere earlier. The value originates from here:\n\n```\n/*\n   Tests mpn_smp_kara for a range of n.\n*/\nint\ntest_mpn_smp_kara (int quick)\n{\n   int success = 1;\n   size_t n;\n   ulong trial;\n\n   // first a dense range of small problems\n   for (n = 2; n <= 30 && success; n++)\n   for (trial = 0; trial < (quick ? 300 : 30000) && success; trial++)\n      success = success && testcase_mpn_smp_kara (n);\n\n   // now a few larger problems too\n   for (trial = 0; trial < (quick ? 100 : 3000) && success; trial++)\n   {\n      n = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2;      <======= n generated here.\n      success = success && testcase_mpn_smp_kara (n);\n   }\n\n   return success;\n}\n```\n",
    "created_at": "2013-02-12T23:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172966",
    "user": "@kiwifb"
}
```

To continue on what you started Paul in

```
testcase_mpn_smp_kara (n=6624085371224828549)
```

n is supposed to be a size_t so I think we have a gross overflow somewhere earlier. The value originates from here:

```
/*
   Tests mpn_smp_kara for a range of n.
*/
int
test_mpn_smp_kara (int quick)
{
   int success = 1;
   size_t n;
   ulong trial;

   // first a dense range of small problems
   for (n = 2; n <= 30 && success; n++)
   for (trial = 0; trial < (quick ? 300 : 30000) && success; trial++)
      success = success && testcase_mpn_smp_kara (n);

   // now a few larger problems too
   for (trial = 0; trial < (quick ? 100 : 3000) && success; trial++)
   {
      n = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2;      <======= n generated here.
      success = success && testcase_mpn_smp_kara (n);
   }

   return success;
}
```




---

archive/issue_comments_172967.json:
```json
{
    "body": "On power7 it appears that ZNP_mpn_smp_kara_thresh is equal to SIZE_MAX which according to /usr/include/stdint.h is\n\n```\n/* Limit of `size_t' type.  */\n# if __WORDSIZE == 64\n#  define SIZE_MAX              (18446744073709551615UL)\n# else\n#  define SIZE_MAX              (4294967295U)\n# endif\n```\n\nrandom_ulong is defined by\n\n```\nulong\nrandom_ulong (ulong max)\n{\n   return gmp_urandomm_ui (randstate, max);\n}\n```\n\nso n needs to be size_t which is at most SIZE_MAX but the test generate a random number between 0 and 3 * SIZE_MAX + 2.\n<sarcasm>\nOh dear! I wonder why that doesn't work.\n</sarcasm>\n\nI guess it is potentially fine if ZNP_mpn_smp_kara_thresh is not SIZE_MAX, I don't know how it is on other systems.",
    "created_at": "2013-02-13T00:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172967",
    "user": "@kiwifb"
}
```

On power7 it appears that ZNP_mpn_smp_kara_thresh is equal to SIZE_MAX which according to /usr/include/stdint.h is

```
/* Limit of `size_t' type.  */
# if __WORDSIZE == 64
#  define SIZE_MAX              (18446744073709551615UL)
# else
#  define SIZE_MAX              (4294967295U)
# endif
```

random_ulong is defined by

```
ulong
random_ulong (ulong max)
{
   return gmp_urandomm_ui (randstate, max);
}
```

so n needs to be size_t which is at most SIZE_MAX but the test generate a random number between 0 and 3 * SIZE_MAX + 2.
<sarcasm>
Oh dear! I wonder why that doesn't work.
</sarcasm>

I guess it is potentially fine if ZNP_mpn_smp_kara_thresh is not SIZE_MAX, I don't know how it is on other systems.



---

archive/issue_comments_172968.json:
```json
{
    "body": "Francois, can you see how `ZNP_mpn_smp_kara_thresh` is defined on other 64-bit systems,\nand which kinds of values is generated by `n = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2`?\n\nPaul",
    "created_at": "2013-02-13T07:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172968",
    "user": "@zimmermann6"
}
```

Francois, can you see how `ZNP_mpn_smp_kara_thresh` is defined on other 64-bit systems,
and which kinds of values is generated by `n = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2`?

Paul



---

archive/issue_comments_172969.json:
```json
{
    "body": "I am certainly poking at that. The value of ZNP_mpn_smp_kara_thresh is computed by the tuning code and it is clearly allowed to be equal to SIZE_MAX\n\n```\n   // generate tuning.c file\n   printf (header);\n\n   x = ZNP_mpn_smp_kara_thresh;\n   printf (\"size_t ZNP_mpn_smp_kara_thresh = \");\n   printf (x == SIZE_MAX ? \"SIZE_MAX;\\n\" : \"%lu;\\n\", x);\n```\n\nSo someone potentially set themselves for trouble in the test. However after inserting a few printf in the code the mystery deepens\n\n```\nmpn_smp_basecase()... ok\nmpn_smp_kara()... test: src/mpn_mulmid.c:241: ZNP_mpn_smp_kara: Assertion `n >= 2' failed.\nmaxtrial= 98 SIZE_MAX= 18446744073709551615\nmaxtrial= 98\nn=31\nn=24\nn=38\nn=40\nn=74\nn=24\nn=28\nn=32\nn=77\nn=67\nn=76\nn=64\nn=13\nn=17\nn=90\nn=42\nn=47\nn=79\nn=21\nn=82\nn=32\nn=10\nn=67\nn=25\nn=26\nn=39\nn=77\nn=90\nn=97\nn=7\nn=74\nn=59\nn=70\nn=87\nn=23\nn=6\nn=70\nn=97\nn=78\nn=74\nn=57\nn=53\nn=28\nn=21\nn=51\nn=33\nn=41\nn=2\nn=88\nn=57\nn=56\nn=96\nn=46\nn=38\nn=69\nn=93\nn=11\nn=61\nn=24\nn=25\nn=45\nn=46\nn=6\nn=44\nn=32\nn=93\nn=59\nn=45\nn=46\nn=31\nn=91\nn=32\nn=45\nn=45\nn=90\nn=61\nn=78\nn=47\nn=33\nn=75\nn=71\nn=37\nn=92\nn=94\nn=50\nn=84\nn=8\nn=43\nn=15\nn=31\nn=31\nmake: *** [check] Aborted (core dumped)\nError running zn_poly's quick test suite ('make check').\n```\n\nI didn't have the assertion before and after putting these we Abort rather than segfault.",
    "created_at": "2013-02-13T08:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172969",
    "user": "@kiwifb"
}
```

I am certainly poking at that. The value of ZNP_mpn_smp_kara_thresh is computed by the tuning code and it is clearly allowed to be equal to SIZE_MAX

```
   // generate tuning.c file
   printf (header);

   x = ZNP_mpn_smp_kara_thresh;
   printf ("size_t ZNP_mpn_smp_kara_thresh = ");
   printf (x == SIZE_MAX ? "SIZE_MAX;\n" : "%lu;\n", x);
```

So someone potentially set themselves for trouble in the test. However after inserting a few printf in the code the mystery deepens

```
mpn_smp_basecase()... ok
mpn_smp_kara()... test: src/mpn_mulmid.c:241: ZNP_mpn_smp_kara: Assertion `n >= 2' failed.
maxtrial= 98 SIZE_MAX= 18446744073709551615
maxtrial= 98
n=31
n=24
n=38
n=40
n=74
n=24
n=28
n=32
n=77
n=67
n=76
n=64
n=13
n=17
n=90
n=42
n=47
n=79
n=21
n=82
n=32
n=10
n=67
n=25
n=26
n=39
n=77
n=90
n=97
n=7
n=74
n=59
n=70
n=87
n=23
n=6
n=70
n=97
n=78
n=74
n=57
n=53
n=28
n=21
n=51
n=33
n=41
n=2
n=88
n=57
n=56
n=96
n=46
n=38
n=69
n=93
n=11
n=61
n=24
n=25
n=45
n=46
n=6
n=44
n=32
n=93
n=59
n=45
n=46
n=31
n=91
n=32
n=45
n=45
n=90
n=61
n=78
n=47
n=33
n=75
n=71
n=37
n=92
n=94
n=50
n=84
n=8
n=43
n=15
n=31
n=31
make: *** [check] Aborted (core dumped)
Error running zn_poly's quick test suite ('make check').
```

I didn't have the assertion before and after putting these we Abort rather than segfault.



---

archive/issue_comments_172970.json:
```json
{
    "body": "I guess there is a bug in the tuning code, which should not give for `ZNP_mpn_smp_kara_thresh` a huge value.\n\nPaul",
    "created_at": "2013-02-13T09:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172970",
    "user": "@zimmermann6"
}
```

I guess there is a bug in the tuning code, which should not give for `ZNP_mpn_smp_kara_thresh` a huge value.

Paul



---

archive/issue_comments_172971.json:
```json
{
    "body": "I am the author.... thanks Paul for drawing my attention to this.\n\nI haven't looked at this code for years so it's almost as mysterious to me as to everyone else here!\n\nMy guess is that the bug is in the test code rather than in the tuning code. I suspect that the threshold is allowed to be SIZE_MAX, but that the line\n\n```\nn = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2; \n```\n\nshould be replaced by e.g.\n\n```\nif (ZNP_mpn_smp_kara_thresh == SIZE_MAX)\n   n = random_ulong (100) + 2;\nelse\n   n = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2; \n```\n\n\nIt could also be a bug in the tuning code, but that would be much harder to fix. If I remember correctly what this threshold means, it is very surprising to me that its optimal value is SIZE_MAX on any real system.",
    "created_at": "2013-02-13T09:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172971",
    "user": "dmharvey"
}
```

I am the author.... thanks Paul for drawing my attention to this.

I haven't looked at this code for years so it's almost as mysterious to me as to everyone else here!

My guess is that the bug is in the test code rather than in the tuning code. I suspect that the threshold is allowed to be SIZE_MAX, but that the line

```
n = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2; 
```

should be replaced by e.g.

```
if (ZNP_mpn_smp_kara_thresh == SIZE_MAX)
   n = random_ulong (100) + 2;
else
   n = random_ulong (3 * ZNP_mpn_smp_kara_thresh) + 2; 
```


It could also be a bug in the tuning code, but that would be much harder to fix. If I remember correctly what this threshold means, it is very surprising to me that its optimal value is SIZE_MAX on any real system.



---

archive/issue_comments_172972.json:
```json
{
    "body": "Thanks for the code. My last error was due to me trying to do something similar and failing to read the original code properly (putting the +2 inside the bracket).\npower7 is a strange beast but it is unlikely that it is the optimal value. The tuning probably assume something that is wrong on this platform and that would indeed be difficult to find.",
    "created_at": "2013-02-13T09:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172972",
    "user": "@kiwifb"
}
```

Thanks for the code. My last error was due to me trying to do something similar and failing to read the original code properly (putting the +2 inside the bracket).
power7 is a strange beast but it is unlikely that it is the optimal value. The tuning probably assume something that is wrong on this platform and that would indeed be difficult to find.



---

archive/issue_comments_172973.json:
```json
{
    "body": "Not sure what happened I wanted to do another run to post tuning.c but the value of ZNP_mpn_smp_kara_thresh is now 133. I swear it was SIZE_MAX before. There is still plenty of SIZE_MAX value in the file:\n\n```\n#include \"zn_poly_internal.h\"\n\nsize_t ZNP_mpn_smp_kara_thresh = 133;\nsize_t ZNP_mpn_mulmid_fallback_thresh = 4868;\n\ntuning_info_t tuning_info[] = \n{\n   {  // bits = 0\n   },\n   {  // bits = 1\n   },\n   {  // bits = 2\n         94,   // KS1 -> KS2 multiplication threshold\n   SIZE_MAX,   // KS2 -> KS4 multiplication threshold\n   SIZE_MAX,   // KS4 -> FFT multiplication threshold\n        270,   // KS1 -> KS2 squaring threshold\n   SIZE_MAX,   // KS2 -> KS4 squaring threshold\n   SIZE_MAX,   // KS4 -> FFT squaring threshold\n        206,   // KS1 -> KS2 middle product threshold\n   SIZE_MAX,   // KS2 -> KS4 middle product threshold\n   SIZE_MAX,   // KS4 -> FFT middle product threshold\n       1000,   // nussbaumer multiplication threshold\n       1000    // nussbaumer squaring threshold\n   },\n   {  // bits = 3\n        105,   // KS1 -> KS2 multiplication threshold\n   SIZE_MAX,   // KS2 -> KS4 multiplication threshold\n   SIZE_MAX,   // KS4 -> FFT multiplication threshold\n        270,   // KS1 -> KS2 squaring threshold\n       9634,   // KS2 -> KS4 squaring threshold\n   SIZE_MAX,   // KS4 -> FFT squaring threshold\n        120,   // KS1 -> KS2 middle product threshold\n   SIZE_MAX,   // KS2 -> KS4 middle product threshold\n   SIZE_MAX,   // KS4 -> FFT middle product threshold\n       1000,   // nussbaumer multiplication threshold\n       1000    // nussbaumer squaring threshold\n   },\n   {  // bits = 4\n        123,   // KS1 -> KS2 multiplication threshold\n   SIZE_MAX,   // KS2 -> KS4 multiplication threshold\n   SIZE_MAX,   // KS4 -> FFT multiplication threshold\n        154,   // KS1 -> KS2 squaring threshold\n   SIZE_MAX,   // KS2 -> KS4 squaring threshold\n   SIZE_MAX,   // KS4 -> FFT squaring threshold\n        132,   // KS1 -> KS2 middle product threshold\n   SIZE_MAX,   // KS2 -> KS4 middle product threshold\n   SIZE_MAX,   // KS4 -> FFT middle product threshold\n```\n",
    "created_at": "2013-02-13T09:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172973",
    "user": "@kiwifb"
}
```

Not sure what happened I wanted to do another run to post tuning.c but the value of ZNP_mpn_smp_kara_thresh is now 133. I swear it was SIZE_MAX before. There is still plenty of SIZE_MAX value in the file:

```
#include "zn_poly_internal.h"

size_t ZNP_mpn_smp_kara_thresh = 133;
size_t ZNP_mpn_mulmid_fallback_thresh = 4868;

tuning_info_t tuning_info[] = 
{
   {  // bits = 0
   },
   {  // bits = 1
   },
   {  // bits = 2
         94,   // KS1 -> KS2 multiplication threshold
   SIZE_MAX,   // KS2 -> KS4 multiplication threshold
   SIZE_MAX,   // KS4 -> FFT multiplication threshold
        270,   // KS1 -> KS2 squaring threshold
   SIZE_MAX,   // KS2 -> KS4 squaring threshold
   SIZE_MAX,   // KS4 -> FFT squaring threshold
        206,   // KS1 -> KS2 middle product threshold
   SIZE_MAX,   // KS2 -> KS4 middle product threshold
   SIZE_MAX,   // KS4 -> FFT middle product threshold
       1000,   // nussbaumer multiplication threshold
       1000    // nussbaumer squaring threshold
   },
   {  // bits = 3
        105,   // KS1 -> KS2 multiplication threshold
   SIZE_MAX,   // KS2 -> KS4 multiplication threshold
   SIZE_MAX,   // KS4 -> FFT multiplication threshold
        270,   // KS1 -> KS2 squaring threshold
       9634,   // KS2 -> KS4 squaring threshold
   SIZE_MAX,   // KS4 -> FFT squaring threshold
        120,   // KS1 -> KS2 middle product threshold
   SIZE_MAX,   // KS2 -> KS4 middle product threshold
   SIZE_MAX,   // KS4 -> FFT middle product threshold
       1000,   // nussbaumer multiplication threshold
       1000    // nussbaumer squaring threshold
   },
   {  // bits = 4
        123,   // KS1 -> KS2 multiplication threshold
   SIZE_MAX,   // KS2 -> KS4 multiplication threshold
   SIZE_MAX,   // KS4 -> FFT multiplication threshold
        154,   // KS1 -> KS2 squaring threshold
   SIZE_MAX,   // KS2 -> KS4 squaring threshold
   SIZE_MAX,   // KS4 -> FFT squaring threshold
        132,   // KS1 -> KS2 middle product threshold
   SIZE_MAX,   // KS2 -> KS4 middle product threshold
   SIZE_MAX,   // KS4 -> FFT middle product threshold
```




---

archive/issue_comments_172974.json:
```json
{
    "body": "Francois, anyway it does not hurt to implement what David suggests in comment [comment:10].\nThis should fix this ticket once for all.\n\nPaul",
    "created_at": "2013-02-13T12:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172974",
    "user": "@zimmermann6"
}
```

Francois, anyway it does not hurt to implement what David suggests in comment [comment:10].
This should fix this ticket once for all.

Paul



---

archive/issue_comments_172975.json:
```json
{
    "body": "I can say it worked nicely, so I'll prepare a new spkg with it so this kind of thing cannot happen again. I think I found out what happened and made thing different. In the original build I used gcc-4.7.1, this build the compiler was gcc shipped with the distro gcc-4.3.4. There could be some subtle bugs lurking in gcc itself or the standard used to compile the tuning code. \n\n```\n#include \"zn_poly_internal.h\"\n\nsize_t ZNP_mpn_smp_kara_thresh = SIZE_MAX;\nsize_t ZNP_mpn_mulmid_fallback_thresh = SIZE_MAX;\n\ntuning_info_t tuning_info[] = \n{\n   {  // bits = 0\n   },\n   {  // bits = 1\n   },\n   {  // bits = 2\n         94,   // KS1 -> KS2 multiplication threshold\n   SIZE_MAX,   // KS2 -> KS4 multiplication threshold\n   SIZE_MAX,   // KS4 -> FFT multiplication threshold\n        218,   // KS1 -> KS2 squaring threshold\n   SIZE_MAX,   // KS2 -> KS4 squaring threshold\n   SIZE_MAX,   // KS4 -> FFT squaring threshold\n        216,   // KS1 -> KS2 middle product threshold\n   SIZE_MAX,   // KS2 -> KS4 middle product threshold\n   SIZE_MAX,   // KS4 -> FFT middle product threshold\n       1000,   // nussbaumer multiplication threshold\n       1000    // nussbaumer squaring threshold\n   },\n   {  // bits = 3\n        107,   // KS1 -> KS2 multiplication threshold\n   SIZE_MAX,   // KS2 -> KS4 multiplication threshold\n   SIZE_MAX,   // KS4 -> FFT multiplication threshold\n        167,   // KS1 -> KS2 squaring threshold\n   SIZE_MAX,   // KS2 -> KS4 squaring threshold\n   SIZE_MAX,   // KS4 -> FFT squaring threshold\n        146,   // KS1 -> KS2 middle product threshold\n       6889,   // KS2 -> KS4 middle product threshold\n   SIZE_MAX,   // KS4 -> FFT middle product threshold\n       1000,   // nussbaumer multiplication threshold\n       1000    // nussbaumer squaring threshold\n   },\n   {  // bits = 4\n         68,   // KS1 -> KS2 multiplication threshold\n   SIZE_MAX,   // KS2 -> KS4 multiplication threshold\n   SIZE_MAX,   // KS4 -> FFT multiplication threshold\n        187,   // KS1 -> KS2 squaring threshold\n   SIZE_MAX,   // KS2 -> KS4 squaring threshold\n   SIZE_MAX,   // KS4 -> FFT squaring threshold\n         95,   // KS1 -> KS2 middle product threshold\n       7367,   // KS2 -> KS4 middle product threshold\n   SIZE_MAX,   // KS4 -> FFT middle product threshold\n       1000,   // nussbaumer multiplication threshold\n       1000    // nussbaumer squaring threshold\n   },\n   {  // bits = 5\n         60,   // KS1 -> KS2 multiplication threshold\n      18841,   // KS2 -> KS4 multiplication threshold\n   SIZE_MAX,   // KS4 -> FFT multiplication threshold\n        192,   // KS1 -> KS2 squaring threshold\n   SIZE_MAX,   // KS2 -> KS4 squaring threshold\n   SIZE_MAX,   // KS4 -> FFT squaring threshold\n        128,   // KS1 -> KS2 middle product threshold\n       5037,   // KS2 -> KS4 middle product threshold\n   SIZE_MAX,   // KS4 -> FFT middle product threshold\n```\n",
    "created_at": "2013-02-14T02:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172975",
    "user": "@kiwifb"
}
```

I can say it worked nicely, so I'll prepare a new spkg with it so this kind of thing cannot happen again. I think I found out what happened and made thing different. In the original build I used gcc-4.7.1, this build the compiler was gcc shipped with the distro gcc-4.3.4. There could be some subtle bugs lurking in gcc itself or the standard used to compile the tuning code. 

```
#include "zn_poly_internal.h"

size_t ZNP_mpn_smp_kara_thresh = SIZE_MAX;
size_t ZNP_mpn_mulmid_fallback_thresh = SIZE_MAX;

tuning_info_t tuning_info[] = 
{
   {  // bits = 0
   },
   {  // bits = 1
   },
   {  // bits = 2
         94,   // KS1 -> KS2 multiplication threshold
   SIZE_MAX,   // KS2 -> KS4 multiplication threshold
   SIZE_MAX,   // KS4 -> FFT multiplication threshold
        218,   // KS1 -> KS2 squaring threshold
   SIZE_MAX,   // KS2 -> KS4 squaring threshold
   SIZE_MAX,   // KS4 -> FFT squaring threshold
        216,   // KS1 -> KS2 middle product threshold
   SIZE_MAX,   // KS2 -> KS4 middle product threshold
   SIZE_MAX,   // KS4 -> FFT middle product threshold
       1000,   // nussbaumer multiplication threshold
       1000    // nussbaumer squaring threshold
   },
   {  // bits = 3
        107,   // KS1 -> KS2 multiplication threshold
   SIZE_MAX,   // KS2 -> KS4 multiplication threshold
   SIZE_MAX,   // KS4 -> FFT multiplication threshold
        167,   // KS1 -> KS2 squaring threshold
   SIZE_MAX,   // KS2 -> KS4 squaring threshold
   SIZE_MAX,   // KS4 -> FFT squaring threshold
        146,   // KS1 -> KS2 middle product threshold
       6889,   // KS2 -> KS4 middle product threshold
   SIZE_MAX,   // KS4 -> FFT middle product threshold
       1000,   // nussbaumer multiplication threshold
       1000    // nussbaumer squaring threshold
   },
   {  // bits = 4
         68,   // KS1 -> KS2 multiplication threshold
   SIZE_MAX,   // KS2 -> KS4 multiplication threshold
   SIZE_MAX,   // KS4 -> FFT multiplication threshold
        187,   // KS1 -> KS2 squaring threshold
   SIZE_MAX,   // KS2 -> KS4 squaring threshold
   SIZE_MAX,   // KS4 -> FFT squaring threshold
         95,   // KS1 -> KS2 middle product threshold
       7367,   // KS2 -> KS4 middle product threshold
   SIZE_MAX,   // KS4 -> FFT middle product threshold
       1000,   // nussbaumer multiplication threshold
       1000    // nussbaumer squaring threshold
   },
   {  // bits = 5
         60,   // KS1 -> KS2 multiplication threshold
      18841,   // KS2 -> KS4 multiplication threshold
   SIZE_MAX,   // KS4 -> FFT multiplication threshold
        192,   // KS1 -> KS2 squaring threshold
   SIZE_MAX,   // KS2 -> KS4 squaring threshold
   SIZE_MAX,   // KS4 -> FFT squaring threshold
        128,   // KS1 -> KS2 middle product threshold
       5037,   // KS2 -> KS4 middle product threshold
   SIZE_MAX,   // KS4 -> FFT middle product threshold
```




---

archive/issue_comments_172976.json:
```json
{
    "body": "Attachment [mpn_mulmid-test.c.patch](tarball://root/attachments/some-uuid/ticket14098/mpn_mulmid-test.c.patch) by @kiwifb created at 2013-02-14 08:40:23\n\npatch added to zn_poly for review purposes",
    "created_at": "2013-02-14T08:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172976",
    "user": "@kiwifb"
}
```

Attachment [mpn_mulmid-test.c.patch](tarball://root/attachments/some-uuid/ticket14098/mpn_mulmid-test.c.patch) by @kiwifb created at 2013-02-14 08:40:23

patch added to zn_poly for review purposes



---

archive/issue_comments_172977.json:
```json
{
    "body": "OK new spkg ready for review. I also attached the patch for review but it is just David's code.",
    "created_at": "2013-02-14T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172977",
    "user": "@kiwifb"
}
```

OK new spkg ready for review. I also attached the patch for review but it is just David's code.



---

archive/issue_comments_172978.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-14T08:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172978",
    "user": "@kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_172979.json:
```json
{
    "body": "the patch looks fine to me, however since I have no access to a power7 I can only check the patch and new package on another computer. Jeroen, how should we proceed in that case, assuming Francois (the author of the patch and new package) is the only person to have access to a power7?\n\nPaul",
    "created_at": "2013-02-18T15:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172979",
    "user": "@zimmermann6"
}
```

the patch looks fine to me, however since I have no access to a power7 I can only check the patch and new package on another computer. Jeroen, how should we proceed in that case, assuming Francois (the author of the patch and new package) is the only person to have access to a power7?

Paul



---

archive/issue_comments_172980.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-18T15:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172980",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172981.json:
```json
{
    "body": "I don't mind giving positive_review in this case. We can reasonably expect that the author has tested the package on the failing machine.",
    "created_at": "2013-02-18T15:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172981",
    "user": "@jdemeyer"
}
```

I don't mind giving positive_review in this case. We can reasonably expect that the author has tested the package on the failing machine.



---

archive/issue_comments_172982.json:
```json
{
    "body": "> I don't mind giving positive_review in this case.\n\nhowever I'd like to check first the new spkg works on my machine.\n\nPaul",
    "created_at": "2013-02-18T15:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172982",
    "user": "@zimmermann6"
}
```

> I don't mind giving positive_review in this case.

however I'd like to check first the new spkg works on my machine.

Paul



---

archive/issue_comments_172983.json:
```json
{
    "body": "This doesn't even build:\n\n```\nApplying patches to upstream sources...\nmakemakefile.py.patch\npatching file makemakefile.py\nmpn_mulmid-test.c.patch\npatching file test/mpn_mulmid-test.c\nHunk #1 FAILED at 121.\n1 out of 1 hunk FAILED -- saving rejects to file test/mpn_mulmid-test.c.rej\nError: '../patches/mpn_mulmid-test.c.patch' failed to apply.\n\nreal    0m0.011s\nuser    0m0.010s\nsys     0m0.000s\n************************************************************************\nError installing package zn_poly-0.9.p10\n************************************************************************\n```\n",
    "created_at": "2013-02-19T14:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172983",
    "user": "@jdemeyer"
}
```

This doesn't even build:

```
Applying patches to upstream sources...
makemakefile.py.patch
patching file makemakefile.py
mpn_mulmid-test.c.patch
patching file test/mpn_mulmid-test.c
Hunk #1 FAILED at 121.
1 out of 1 hunk FAILED -- saving rejects to file test/mpn_mulmid-test.c.rej
Error: '../patches/mpn_mulmid-test.c.patch' failed to apply.

real    0m0.011s
user    0m0.010s
sys     0m0.000s
************************************************************************
Error installing package zn_poly-0.9.p10
************************************************************************
```




---

archive/issue_comments_172984.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-02-19T14:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172984",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_172985.json:
```json
{
    "body": "Sorry made a big mistake when preparing the final spkg (source not pristine clean, that's rather unforgiving). It should be ok now (I double checked).",
    "created_at": "2013-02-19T20:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172985",
    "user": "@kiwifb"
}
```

Sorry made a big mistake when preparing the final spkg (source not pristine clean, that's rather unforgiving). It should be ok now (I double checked).



---

archive/issue_comments_172986.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-19T20:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172986",
    "user": "@kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_172987.json:
```json
{
    "body": "all tests now pass on my computer (on top of Sage 5.6).\n\nPaul",
    "created_at": "2013-02-21T11:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172987",
    "user": "@zimmermann6"
}
```

all tests now pass on my computer (on top of Sage 5.6).

Paul



---

archive/issue_comments_172988.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-21T11:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172988",
    "user": "@zimmermann6"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172989.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-02-22T19:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172989",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_172990.json:
```json
{
    "body": "zn_poly's tuning (and apparently due to that its test suite, too) is flaky on other systems as well: #13947\n\nIt would be nice if some of you could also take a look at that... :P",
    "created_at": "2013-02-24T23:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172990",
    "user": "@nexttime"
}
```

zn_poly's tuning (and apparently due to that its test suite, too) is flaky on other systems as well: #13947

It would be nice if some of you could also take a look at that... :P



---

archive/issue_comments_172991.json:
```json
{
    "body": "Yes it looks similar. Turning debugging on was somewhat helpful here.",
    "created_at": "2013-02-25T00:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13894",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13894#issuecomment-172991",
    "user": "@kiwifb"
}
```

Yes it looks similar. Turning debugging on was somewhat helpful here.
