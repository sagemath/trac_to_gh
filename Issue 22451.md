# Issue 22451: Three.js: no plot if 'nan' occurs in JSON representation

Issue created by migration from https://trac.sagemath.org/ticket/22688

Original creator: paulmasson

Original creation time: 2017-03-27 01:36:36

CC:  novoselt â€‹egourgoulhon tscrim

After the fix of #22553 (which was a much needed improvement over past kludges), I'm seeing `nan`s in the JSON representation of some surfaces that did not happen previously. This manifests itself in a failure to render the scene, resulting in a black screen. You can test with this plot:


```
spherical_plot3d(real(spherical_harmonic(2,1,x,y)),(x,0,pi),(y,0,2*pi),viewer='threejs')
```


JMol gets the same `nan`s passed to it but still renders this plot, so it must be doing something to  work around them. We can't simple ignore vertices with `nan` because that will throw off the list of faces.


---

Comment by paulmasson created at 2017-03-27 01:42:04

Possible solutions:

1) set `nan` to zero by default, since the ones I'm seeing are coming from arctan(0/0) around the origin, but that might not be a good overall solution

2) create a popup in the HTML asking the user to modify the input data slightly to avoid singular points

3) implement some amount of randomness in 3D plots just like in 2D plots

The first is easiest to implement. The third would take appreciable time to get right. And I really don't like the second.


---

Comment by paulmasson created at 2017-03-27 19:53:10

Here's an obvious fourth option to replace the second:

4) halt the plot generation upon detection of `nan` with a `RuntimeError` and warn the user of bad data points


---

Comment by paulmasson created at 2017-03-29 01:36:08

A couple more options are reading some of the JMol source code:

5) detect `nan` before generating the Three.js plot and remove all bad vertices and any faces using them from the JSON representation

6) detect `nan` further upstream where the `IndexFaceSet` is generated, either in the method to produce its JSON representation or before that, and prevent any bad vertices from being added to begin with

This last one probably makes the most sense from a structural point of view, unless there is a good reason to include bad vertices in an `IndexFaceSet`. Perhaps I should ask that question on sage-devel.


---

Comment by paulmasson created at 2019-03-31 23:10:48

Changing status from new to needs_review.


---

Comment by paulmasson created at 2019-03-31 23:10:59

Changing status from needs_review to positive_review.


---

Comment by paulmasson created at 2019-03-31 23:28:57

Changing status from positive_review to needs_info.


---

Comment by chapoton created at 2019-09-01 16:46:16

works fine in sage 8.9.beta8


---

Comment by paulmasson created at 2019-09-02 20:39:09

Changing status from needs_info to positive_review.


---

Comment by kcrisman created at 2019-09-05 01:19:21

Maybe a doctest, or not needed/possible in this case?


---

Comment by chapoton created at 2019-09-19 09:45:57

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2019-09-19 09:45:57

I am proposing a doctest
----
New commits:


---

Comment by chapoton created at 2019-09-19 09:46:03

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-09-19 11:39:32

and the patchbot is green, please review.


---

Comment by tscrim created at 2019-09-19 12:17:41

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-09-19 12:17:41

LGTM.


---

Comment by vbraun created at 2019-10-03 17:58:30

Resolution: fixed
