# Issue 23582: Speed up AlternatingSignMatrix.from_corner_sum

Issue created by migration from https://trac.sagemath.org/ticket/23819

Original creator: mantepse

Original creation time: 2017-09-10 07:46:52

CC:  jessicapalencia kdilks




---

Comment by mantepse created at 2017-09-10 07:49:19

Changing status from new to needs_review.


---

Comment by mantepse created at 2017-09-10 07:49:19

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mantepse created at 2017-09-10 07:49:19

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by git created at 2017-09-10 07:53:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-11 14:07:16

Florian Aigner just pointed out to me that `a_i,j=c_{i,j}+c_{i-1,j-1}-c_{i-1,j}-c_{i,j-1}`.  I would expect that

```
        n = len(list(corner))-1
        asm = [[corner[i+1][j+1]+corner[i][j]-corner[i][j+1]-corner[i+1][j]
                for j in range(n)]
               for i in range(n)]
        return AlternatingSignMatrix(asm)
```

is the fastest version possible.  Curiously, this is not the case, it is even slower than the original version.  Why?


---

Comment by git created at 2017-09-11 16:22:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-11 17:33:46

The new version is *slightly* (:-) faster:

```
sage: A = AlternatingSignMatrices(6)
sage: lC = [a.corner_sum_matrix() for a in A]
sage: timeit("[A.from_corner_sum(corner) for corner in lC]", number=1, repeat=1)
1 loops, best of 1: 3.14159265359...s per loop
```

8.1.beta4:

```
sage: timeit("[A.from_corner_sum(corner) for corner in lC]", number=1, repeat=1)
1 loops, best of 1: 31.4159265359...s per loop
```



---

Comment by jhpalmieri created at 2017-09-11 17:56:05

Those can't be real timings.


---

Comment by mantepse created at 2017-09-11 18:02:25

I admit that they are imaginary - but correct to one or two decimal positions.


---

Comment by git created at 2017-09-11 20:20:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-11 21:42:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-12 04:48:58

There is one further, very important optimization, but I feel it belongs into a separate ticket.  It consists of the following patch, introducing the possibility to bypass checking in `SemistandardTableau`:

```
diff --git a/src/sage/combinat/alternating_sign_matrix.py b/src/sage/combinat/alternating_sign_matrix.py
index 30b5d49..fe07455 100644
--- a/src/sage/combinat/alternating_sign_matrix.py
+++ b/src/sage/combinat/alternating_sign_matrix.py
@@ -938,7 +938,7 @@ class AlternatingSignMatrix(Element):
         for i in range(len(mt)):
             for j in range(len(mt[i])):
                 ssyt[i][j] = mt[j][-(i+1)]
-        return SemistandardTableau(ssyt)
+        return SemistandardTableau(ssyt, check=False)
 
     def left_key(self):
         r"""
diff --git a/src/sage/combinat/tableau.py b/src/sage/combinat/tableau.py
index 377ad9e..418627b 100644
--- a/src/sage/combinat/tableau.py
+++ b/src/sage/combinat/tableau.py
@@ -4137,7 +4137,7 @@ class SemistandardTableau(Tableau):
         ValueError: entries must be positive integers
     """
     @staticmethod
-    def __classcall_private__(self, t):
+    def __classcall_private__(self, t, check=True):
         r"""
         This ensures that a SemistandardTableau is only ever constructed as an
         element_class call of an appropriate parent.
@@ -4156,8 +4156,8 @@ class SemistandardTableau(Tableau):
         """
         if isinstance(t, SemistandardTableau):
             return t
-        elif t in SemistandardTableaux():
-            return SemistandardTableaux_all().element_class(SemistandardTableaux_all(), t)
+        elif not check or t in SemistandardTableaux():
+            return SemistandardTableaux_all().element_class(SemistandardTableaux_all(), t, check=check)
 
         # t is not a semistandard tableau so we give an appropriate error message
         if t not in Tableaux():
@@ -4173,7 +4173,7 @@ class SemistandardTableau(Tableau):
         raise ValueError('%s is not a column strict tableau' % t)
 
 
-    def __init__(self, parent, t):
+    def __init__(self, parent, t, check=True):
         r"""
         Initialize a semistandard tableau.
 
@@ -4197,6 +4197,8 @@ class SemistandardTableau(Tableau):
         """
         super(SemistandardTableau, self).__init__(parent, t)
 
+        if not check:
+            return
         # Tableau() has checked that t is tableau, so it remains to check that
         # the entries of t are positive integers which are weakly increasing
         # along rows
```



---

Comment by tscrim created at 2017-09-12 13:49:48

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-09-12 13:49:48

I do not like general exception catching: it can hide real errors. Also, you should catch `Exception` as I think `StandardError` would also catch more serious errors and interrupts (e.g., ctrl-C) that should rise up.

You also do not need the `else` in that `try-except` block.


---

Comment by mantepse created at 2017-09-12 14:00:57

Replying to [comment:13 tscrim]:
> I do not like general exception catching: it can hide real errors.

Me neither, but in the case at hand it is necessary.  However, I agree that `StandardError` should be replaced with `(TypeError, ValueError)` in line 1196.  I don't know what would be better to catch in line 1199 though.

> Also, you should catch `Exception` as I think `StandardError` would also catch more serious errors and interrupts (e.g., ctrl-C) that should rise up.

Actually, it is the other way round.
 
> You also do not need the `else` in that `try-except` block.

I know, but I think it makes the code much clearer - it is easy to overlook the return just before.


---

Comment by mantepse created at 2017-09-12 14:03:49

> I don't know what would be better to catch in line 1199 though.

Just checked, it's also `(TypeError, ValueError)`.

Thanks!


---

Comment by git created at 2017-09-12 14:15:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-12 14:16:19

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-09-12 14:42:36

Replying to [comment:14 mantepse]:
> Replying to [comment:13 tscrim]:
> > Also, you should catch `Exception` as I think `StandardError` would also catch more serious errors and interrupts (e.g., ctrl-C) that should rise up.
> 
> Actually, it is the other way round.

I remember being told that if you want a general exception catching, you should do `Exception`. Maybe that does everything except interrupts? Maybe I am thinking of a different error class that is bad?

> > You also do not need the `else` in that `try-except` block.
> 
> I know, but I think it makes the code much clearer - it is easy to overlook the return just before.

I disagree. It suggests extra logic as opposed to the fact that it should just fall through and the indented `except` block is the "error handling" portion. Although I would not hold up this ticket because of this.

In a way, I am not usually satisfied using errors to control program flow, but I think this is a necessary evil to differentiate the input in a fast way.

Jessica, Kevin, do you have any comments?


---

Comment by jessicapalencia created at 2017-09-12 14:52:49

Hi all, I don't have any comments on the specifics, except to say that when I wrote this method originally, I was aiming to write something that worked rather than something that was fast. So I appreciate your efforts to speed it up!


---

Comment by kdilks created at 2017-09-12 18:17:58

There's some kind of connection issue keeping me and the Patchbots from pulling the code and testing it right now, but I'm fine with everything that I see in the diff file.


---

Comment by git created at 2017-09-12 20:04:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-12 20:18:29

> > > Also, you should catch `Exception` as I think `StandardError` would also catch more serious errors and interrupts (e.g., ctrl-C) that should rise up.
> > 
> > Actually, it is the other way round.
> 
> I remember being told that if you want a general exception catching, you should do `Exception`. Maybe that does everything except interrupts? Maybe I am thinking of a different error class that is bad?

The hierarchy of classes is here: https://docs.python.org/2/library/exceptions.html#exception-hierarchy

`Exception` catches a strict superset of `StandardError`.  For example, you can try:

```
def testit1():
    try:
        l = iter([1,2,3])
        while True:
            print l.next()
    except Exception as e:
        print e
def testit2():
    try:
        l = iter([1,2,3])
        while True:
            print l.next()
    except StandardError as e:
        print e
```


> > > You also do not need the `else` in that `try-except` block.
> > 
> > I know, but I think it makes the code much clearer - it is easy to overlook the return just before.
> 
> I disagree. It suggests extra logic as opposed to the fact that it should just fall through and the indented `except` block is the "error handling" portion. Although I would not hold up this ticket because of this.

well, the `m = self._matrix_space(asm)` is also indented.  But anyway, I removed the `else`.

> In a way, I am not usually satisfied using errors to control program flow, but I think this is a necessary evil to differentiate the input in a fast way.

Yes, unless there is an easy way to check, python prefers to try.


---

Comment by tscrim created at 2017-09-14 05:15:11

Replying to [comment:22 mantepse]:
> > > > Also, you should catch `Exception` as I think `StandardError` would also catch more serious errors and interrupts (e.g., ctrl-C) that should rise up.
> > > 
> > > Actually, it is the other way round.
> > 
> > I remember being told that if you want a general exception catching, you should do `Exception`. Maybe that does everything except interrupts? Maybe I am thinking of a different error class that is bad?
> 
> The hierarchy of classes is here: https://docs.python.org/2/library/exceptions.html#exception-hierarchy

Thank you for the reference.

> > > > You also do not need the `else` in that `try-except` block.
> > > 
> > > I know, but I think it makes the code much clearer - it is easy to overlook the return just before.
> > 
> > I disagree. It suggests extra logic as opposed to the fact that it should just fall through and the indented `except` block is the "error handling" portion. Although I would not hold up this ticket because of this.
> 
> well, the `m = self._matrix_space(asm)` is also indented.  But anyway, I removed the `else`.

Thank you.

> > In a way, I am not usually satisfied using errors to control program flow, but I think this is a necessary evil to differentiate the input in a fast way.
> 
> Yes, unless there is an easy way to check, python prefers to try.

That depends on how you define "easy". If you mean in terms of readability and robustness, then the containment check is better IMO. However, the speed-up is clear.

Also, I don't think we also have to worry about 1x1 matrices versus size 1 arrays. However, it is an internal behavior change because it now considers it as a matrix instead of an array.


---

Comment by git created at 2017-09-14 05:54:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-14 05:54:34

You are very attentive!  I actually checked the 1x1 matrix, but was too lazy to write a test.  Fixed.
----
New commits:
----
New commits:


---

Comment by git created at 2017-09-14 20:06:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-09-15 08:10:18

Instead of

```
corner = MatrixSpace(ZZ, n+1)(corner)
asm = [[corner[i+1,j+1]+corner[i,j]-corner[i,j+1]-corner[i+1,j]
           for j in range(n)]
            for i in range(n)]
self._matrix_space(asm)
```

You should use matrix operations

```
corner = MatrixSpace(ZZ, n+1)(corner)
asm = corner[1:,1:] + corner[:n,:n] - corner[:n,1:] - corner[1:,:n]
```

As I mentioned in #23819, a Python loop is a bad idea if you want speed. Though matrix slices are not seriously optimized in Sage (we are not using memory views), but still there is a win

```
sage: n = 5
sage: corner = random_matrix(ZZ, n+1)
sage: %timeit asm = matrix([[corner[i+1,j+1]+corner[i,j]-corner[i,j+1]-corner[i+1,j] for j in range(n)] for i in range(n)])
10000 loops, best of 3: 108 µs per loop
sage: %timeit asm = corner[1:,1:] + corner[:n,:n] - corner[:n,1:] - corner[1:,:n]
10000 loops, best of 3: 34.5 µs per loop
```

(In numpy it would have been tremendous!)


---

Comment by mantepse created at 2017-09-15 09:50:17

That's brilliant!


---

Comment by git created at 2017-09-15 10:00:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-09-15 13:06:40

Could you update the timings in the ticket description? (we were at 25.5s with your version)


---

Comment by vdelecroix created at 2017-09-15 13:07:35

This conversion is not needed anymore

```
self._matrix_space(asm)
```

If you really feel there should be something, just add the line

```
assert asm.parent() is self._matrix_space
```



---

Comment by git created at 2017-09-15 14:32:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-09-15 14:45:05

Haaa. Looks better now ;-)


---

Comment by tscrim created at 2017-09-15 19:55:31

Given the speed we've gained, I am setting this to positive review (unless anyone has any objections).


---

Comment by tscrim created at 2017-09-15 19:55:31

Changing status from needs_review to positive_review.


---

Comment by mantepse created at 2017-09-15 19:59:34

Replying to [comment:34 vdelecroix]:
> Haaa. Looks better now ;-)

I agree!  The new version is much faster **and** much easier to understand!  Thank you (and Florian)!


---

Comment by vbraun created at 2017-09-18 22:15:27

Resolution: fixed
