# Issue 28668: spkg-configure for libcdd

Issue created by migration from https://trac.sagemath.org/ticket/28905

Original creator: dimpase

Original creation time: 2019-12-21 02:44:23

CC:  saraedum mjo

Debian has libcdd-dev (library) and libcdd-tools (executables) packages.

The obstacles: installs headers in `usr/include/cdd` (and not in `/usr/include`,
and part of executables into `/usr/lib/cdd-tools/`


---

Comment by mkoeppe created at 2019-12-25 15:32:41

See also https://github.com/cddlib/cddlib/issues/26 "Consider installing headers in `${prefix}/include/cdd/` instead of `${prefix}/include`"


---

Comment by saraedum created at 2019-12-26 13:05:29

Sorry, I fail to understand the description of this ticket. What are you trying to achieve here exactly? Would be nice if you could elaborate a bit.


---

Comment by dimpase created at 2019-12-26 13:50:03

The goal is to use libcdd/cdd from the system (as in all tickets from #27330).
There should not be a problem with headers, after all we can install links to `$SAGE_LOCAL/include/`. I don't know which cdd executables are used in Sagemath.
Again,for these we can install links in `SAGE_LOCAL/bin/`.


---

Comment by dimpase created at 2019-12-27 12:55:31

Am I right that the only parts of cdd(lib) currently used in Sage are executables `cddexec*` ? If so, it would be trivial to provide `spkg-configure.m4`.


---

Comment by dimpase created at 2019-12-27 13:21:25

New commits:


---

Comment by dimpase created at 2019-12-28 06:21:34

cddlib is used as a library in gfan and latte. So one needs a check for headers and libraries.


---

Comment by mjo created at 2020-01-12 05:18:11

I did some work on this but the version of cddlib in Gentoo is too old to detect, so now I have to go fix that first.


---

Comment by fbissey created at 2020-01-12 09:16:41

Replying to [comment:9 mjo]:
> I did some work on this but the version of cddlib in Gentoo is too old to detect, so now I have to go fix that first.

Yes the version from the main tree is too old. I have a newer suitable version in the sage-on-gentoo overlay.


---

Comment by mkoeppe created at 2020-01-18 02:48:57

Is there a branch to test?


---

Comment by mjo created at 2020-01-18 02:51:45

Yeah, the one up there works for me. We did get cddlib upgraded in Gentoo and my branch detects it.


---

Comment by mjo created at 2020-01-18 02:51:45

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-01-18 02:55:15

Are there Dockerfiles or Docker images available that allow testing of the Gentoo Sage distribution?
Off-topic for this ticket - but I would like to add a continuous integration test for https://github.com/mkoeppe/sage-numerical-backends-coin


---

Comment by fbissey created at 2020-01-18 02:59:28

Replying to [comment:13 mkoeppe]:
> Are there Dockerfiles or Docker images available that allow testing of the Gentoo Sage distribution?
> Off-topic for this ticket - but I would like to add a continuous integration test for https://github.com/mkoeppe/sage-numerical-backends-coin

coinor is too old in Gentoo. I tried to do an upgrade privately sometime last year. Unfortunately I lost the ebuilds in a mishap (and they weren't on vcs yet when it happened). I couldn't get it to work with sage which was annoying.


---

Comment by mkoeppe created at 2020-01-18 03:01:05

I primarily want to test with Gentoo's sage, not Gentoo's coinor. I can bring my own coinor from coinbrew.


---

Comment by mkoeppe created at 2020-01-18 03:02:03

FYI - https://github.com/mkoeppe/sage-numerical-backends-coin/blob/master/tox.ini


---

Comment by fbissey created at 2020-01-18 03:04:35

Well I don't produce any docker images and I don't know if someone else did. Would be neat.


---

Comment by mjo created at 2020-01-18 03:25:21

The closest thing to a Docker image we have are the KVM images that the openstack project maintains:

  http://gentoo.osuosl.org/experimental/amd64/openstack/

In theory you can boot one of those up, configure the sage-on-gentoo overlay,

  https://github.com/cschwan/sage-on-gentoo

and then `emerge sage`. But each of those steps is tricky if you've never done it.

I'm slowly working on moving things from the overlay to the main gentoo repository, so that one day you can "emerge sage" without the overlay. (Basically, I'm just taking Francois's work and committing it to the main repository.)

This goes hand-in-hand with the spkg-configure work because in the past, while sage-on-gentoo provides the most stable and usable sage, it doesn't help me rebuild sage.git for testing tickets. But now whenever a package gets an spkg-configure.m4, adding that package to gentoo both (1) speeds up the sage.git build, and (2) brings the overlay one step closer to the main repository.


---

Comment by mkoeppe created at 2020-01-18 04:01:39

Thanks. For now I'm trying to bootstrap gentoo prefix on top of Ubuntu on Docker.


---

Comment by fbissey created at 2020-01-18 04:19:18

`@` mjo you do know that the overlay has a "vbraun" branch where sgae-9999 checkouts Volker's merging branch do you? Pointing to some other branch is not that hard but I have never tried to test ticket that way. I mostly work on my vbraun branch so I know when something is being merged that causes problems.

`@` mkoeppe for info sage-on-gentoo has a tester on prefix on top of ubuntu. So at least we know it works - mostly. There a few unidentified issue in doctesting going on at the moment https://github.com/cschwan/sage-on-gentoo/issues/560


---

Comment by mkoeppe created at 2020-01-18 04:29:53

a tester = a person who tests it?


---

Comment by fbissey created at 2020-01-18 04:30:30

Replying to [comment:21 mkoeppe]:
> a tester = a person who tests it?

Yes.


---

Attachment


---

Comment by mkoeppe created at 2020-01-18 04:34:56

Anyway, this is how far I got in case someone would like to take a look.
Sorry for hijacking the ticket.


---

Comment by dimpase created at 2020-01-18 09:23:36

this branch does not go far enough: on Debian the headers are in `/usr/include/cdd/`, and
on Fedora they are in `/usr/include/cddlib/`.

I think Singular is able to use cddlib headers from any of these locations.

I think libcdd* ought to be tested too.


---

Comment by mkoeppe created at 2020-01-18 15:07:59

Still hoping for upstream to make a decision on the canonical install location of the headers.


---

Comment by mkoeppe created at 2020-01-20 14:54:39

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2020-01-20 15:39:38

Replying to [comment:24 dimpase]:
> this branch does not go far enough: on Debian the headers are in `/usr/include/cdd/`, and
> on Fedora they are in `/usr/include/cddlib/`.
> 

I left a comment about this in the macro before I got sidetracked. It looks to me like the sage lattE and gfan spkgs only look for the cddlib headers in the standard locations, so the system cddlib will only be usable if the headers are in the standard location. Is that wrong?


---

Comment by dimpase created at 2020-01-20 15:56:40

`spkg-confugure.m4` can figure out the prefix, AC_SUBST it into an env.var., which can be used to modify CFLAGS/CXXFLAGS in spkg-install scripts of lattE etc.


---

Comment by mjo created at 2020-01-20 15:59:01

Replying to [comment:28 dimpase]:
> `spkg-confugure.m4` can figure out the prefix, AC_SUBST it into an env.var., which can be used to modify CFLAGS/CXXFLAGS in spkg-install scripts of lattE etc.

Well, sure, but that's a lot more involved. Checking only the standard locations is correct unless we modify those spkgs, right?


---

Comment by dimpase created at 2020-01-20 16:03:19

well, Singular goes out of its way to figure out the header location of cddlib. Indeed,
from the log:

```
checking whether to check for gfanlib... yes
checking setoper.h usability... yes
checking setoper.h presence... yes
checking for setoper.h... yes
checking cdd/setoper.h usability... no
checking cdd/setoper.h presence... no
checking for cdd/setoper.h... no
checking cddlib/setoper.h usability... no
checking cddlib/setoper.h presence... no
checking for cddlib/setoper.h... no
checking whether libcddgmp is usable... checking for dd_free_global_constants... yes
```



---

Comment by mjo created at 2020-01-31 16:31:05

I think the best solution is to:

  1. Merge this now, since it's correct with respect to the rest of the (current) tree.
  2. Report the fact that the headers can be installed in non-standard locations to lattE/gfan upstream.
  3. (a) If those packages make the header search more robust, great; we upgrade the spkgs and we're done. (b) If they say they won't, then we hack something together as in #28905#comment:29.
  4. We update the spkg-configure.m4 for cddlib to look in the non-standard locations as well.
  5. If cddlib upstream ever moves the headers, we can (at our leisure) simplify all of the checks.


---

Comment by saraedum created at 2020-02-06 22:25:22

I am happy to accept a PR at cddlib upstream to install the headers into `cdd/` on [GitHub](GitHub) btw.


---

Comment by mjo created at 2020-03-26 18:18:05

The next release of cddlib will use the `cddlib` prefix for its headers. But for now, our latte and gfan packages only look for the bare `cdd.h`, so that's what we need to check for. Can we merge this now, and then update things as they change?


---

Comment by mjo created at 2020-03-26 18:18:05

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-03-26 19:36:36

Could you update the comment in the added file regarding the header file locations?


---

Comment by git created at 2020-03-26 20:56:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2020-03-26 20:57:25

Sure, I added a real commit message too.


---

Comment by mkoeppe created at 2020-03-26 21:03:05

Rebased to  9.1.beta8
----
New commits:


---

Comment by mkoeppe created at 2020-03-26 21:05:28

sorry, I messed this one up


---

Comment by git created at 2020-03-26 21:06:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-26 21:06:35

Set it back to your commit


---

Comment by git created at 2020-03-26 21:13:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-26 21:18:07

Testing at https://github.com/mkoeppe/sage/actions/runs/64126739


---

Comment by mkoeppe created at 2020-03-27 12:53:30

Detects cddlib correctly on `archlinux-latest-standard` (https://github.com/mkoeppe/sage/runs/537774833).

We don't have a test for Gentoo (#29105, hint hint), but I assume you have tested it there.

As expected, not detected on debian and fedora. I have created follow-up ticket #29413 for that and edited the ticket description.


---

Comment by mkoeppe created at 2020-03-27 12:53:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-05 08:30:50

Resolution: fixed
