# Issue 26915: Make the meataxe wrapper work with py3

Issue created by migration from https://trac.sagemath.org/ticket/27152

Original creator: SimonKing

Original creation time: 2019-01-27 21:11:38

Keywords: meataxe py3

In a py3-build of Sage, installation of the meataxe spkg works, but the wrapper doesn't:

```
sage: type(random_matrix(GF(9,'x'), 1000))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-01e73e06d744> in <module>()
----> 1 type(random_matrix(GF(Integer(9),'x'), Integer(1000)))

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/special.py in random_matrix(ring, nrows, ncols, algorithm, implementation, *args, **kwds)
    597     sparse = kwds.pop('sparse', False)
    598     # Construct the parent of the desired matrix
--> 599     parent = matrix_space.MatrixSpace(ring, nrows, ncols, sparse=sparse, implementation=implementation)
    600     if algorithm == 'randomize':
    601         density = kwds.pop('density', None)

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1701)()
    328         """
    329         if cls.classcall is not None:
--> 330             return cls.classcall(cls, *args, **kwds)
    331         else:
    332             # Fast version of type.__call__(cls, *args, **kwds)

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_space.py in __classcall__(cls, base_ring, nrows, ncols, sparse, implementation)
    474             raise OverflowError("number of rows and columns may be at most %s" % sys.maxsize)
    475 
--> 476         matrix_cls = get_matrix_class(base_ring, nrows, ncols, sparse, implementation)
    477         return super(MatrixSpace, cls).__classcall__(
    478                 cls, base_ring, nrows, ncols, sparse, matrix_cls)

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_space.py in get_matrix_class(R, nrows, ncols, sparse, implementation)
    253                 elif R.order() <= 255:
    254                     try:
--> 255                         from . import matrix_gfpn_dense
    256                     except ImportError:
    257                         implementation = 'generic'

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_gfpn_dense.pyx in init sage.matrix.matrix_gfpn_dense (build/cythonized/sage/matrix/matrix_gfpn_dense.c:20584)()
     60 
     61 # The following import is just to ensure that meataxe_init() is called.
---> 62 import sage.libs.meataxe
     63 
     64 ####################

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/libs/meataxe.pyx in init sage.libs.meataxe (build/cythonized/sage/libs/meataxe.c:2493)()
     85     MtxSetErrorHandler(sage_meataxe_error_handler)
     86 
---> 87 meataxe_init()

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/libs/meataxe.pyx in sage.libs.meataxe.meataxe_init (build/cythonized/sage/libs/meataxe.c:1740)()
     81     from sage.env import DOT_SAGE
     82     global MtxLibDir
---> 83     MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
     84     ## Error handling for MeatAxe, to prevent immediate exit of the program
     85     MtxSetErrorHandler(sage_meataxe_error_handler)

TypeError: expected bytes, str found
```



---

Comment by SimonKing created at 2019-01-27 21:14:18

Indeed,

```
sage: type(os.path.join(DOT_SAGE,'meataxe'))
<class 'str'>
```

So, question from a py3 newbie: How to assign `os.path.join(DOT_SAGE,'meataxe')` to `MtxLibDir` (which is `char*`?


---

Comment by dimpase created at 2019-01-27 21:21:54

I'd try `os.path.join(DOT_SAGE,b'meataxe')`


---

Comment by SimonKing created at 2019-01-27 21:23:18

See [comment 16 at #21437](https://trac.sagemath.org/ticket/21437#comment:16), where I was told to use `PyBytes_...` instead of `PyString_...` for Python 3 compatibility.

So, the question from my perspective is: What is more py3tonic? Using `b'meataxe'`, as in Dima's comment? Or return to `PyString`?


---

Comment by SimonKing created at 2019-01-27 21:24:02

Apparently I should use `PyString_`:

```
sage: type(os.path.join(DOT_SAGE,b'meataxe'))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-7c4dcce91a7c> in <module>()
----> 1 type(os.path.join(DOT_SAGE,b'meataxe'))

/home/king/Sage/git/py3/local/lib/python3.6/posixpath.py in join(a, *p)
     92                 path += sep + b
     93     except (TypeError, AttributeError, BytesWarning):
---> 94         genericpath._check_arg_types('join', a, *p)
     95         raise
     96     return path

/home/king/Sage/git/py3/local/lib/python3.6/genericpath.py in _check_arg_types(funcname, *args)
    149                             (funcname, s.__class__.__name__)) from None
    150     if hasstr and hasbytes:
--> 151         raise TypeError("Can't mix strings and bytes in path components") from None

TypeError: Can't mix strings and bytes in path components
```



---

Comment by dimpase created at 2019-01-27 21:30:13

sorry, I misread your error message. Of course `'meataxe'` is fine there.
Could it be `b'x'`, not `'x'` in `GF(9,'x')` ?


---

Comment by SimonKing created at 2019-01-27 21:33:13

Replying to [comment:5 dimpase]:
> sorry, I misread your error message. Of course `'meataxe'` is fine there.
> Could it be `b'x'`, not `'x'` in `GF(9,'x')` ?

Why should it? The traceback says that the error occurs in the function `meataxe_init`, in the line that translates `os.path.join(...)` to some global constant of type `char*`. Hence, has nothing to do with `GF(9,'x')`, which does work, by the way:

```
sage: GF(9,'x')
Finite Field in x of size 3^2
```



---

Comment by SimonKing created at 2019-01-27 21:42:51

A duckduckgo search seems to indicate that I should use `PyUnicode_AsString`, but I don't know where to cimport it from.


---

Comment by dimpase created at 2019-01-27 21:48:42

https://bugs.python.org/issue2799 tells you that PyUnicode_AsString is gone.

But yes, of course, you are right, os.path.join(DOT_SAGE,'meataxe') is not bytes, but a string, so you cannot call  `PyBytes_...` on it, as its docs say.

Sorry, long day, already at 6am I was writing an email to a student explaining that a class sum lies in the centraliser, and debugging his GAP code along the way :-)


---

Comment by git created at 2019-01-28 02:11:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-01-28 02:13:38

With the previous two commits, I get

```
sage: ~matrix(GF(9,'x'), 2, [0,0,0,0])
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-6-0325ceaaea0b> in <module>()
----> 1 ~matrix(GF(Integer(9),'x'), Integer(2), [Integer(0),Integer(0),Integer(0),Integer(0)])

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__invert__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:13043)()
   1463         sig_on()
   1464         try:
-> 1465             mat = MatInverse(self.Data)
   1466         finally:
   1467             # Inverting a singular matrix causes MatInverse to raise a

RuntimeError: Division by zero in file matinv.c (line 50)
```

Before that, module initialisation didn't work at all and the formatting of the error message was resulting in an error.

Do I understand correctly that the argument of an error should be str, not bytes?


---

Comment by git created at 2019-01-28 02:14:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-01-28 06:35:53

This

```
MtxLibDir = PyBytes_AsString(str_to_bytes(os.path.join(DOT_SAGE,'meataxe')))
```

could be written in a more Cythonic way as

```
MtxLibDir = str_to_bytes(os.path.join(DOT_SAGE, 'meataxe'))
```

Generally, such explicit `PyBytes_AsString` calls are not needed in Cython.


---

Comment by SimonKing created at 2019-01-28 09:21:58

Replying to [comment:13 jdemeyer]:
> This
> {{{
> MtxLibDir = PyBytes_AsString(str_to_bytes(os.path.join(DOT_SAGE,'meataxe')))
> }}}
> could be written in a more Cythonic way as
> {{{
> MtxLibDir = str_to_bytes(os.path.join(DOT_SAGE, 'meataxe'))
> }}}

Do I understand correctly: `str_to_bytes` converts a Python bytes to a Python str, and when assigning it to `MtxLibDir` it will automatically converted to `char*`?

In that case, I should certainly drop the `PyBytes/String_...` functions totally (also in pickling).


---

Comment by SimonKing created at 2019-01-28 10:29:27

Replying to [comment:14 SimonKing]:
> In that case, I should certainly drop the `PyBytes/String_...` functions totally (also in pickling).

In pickling, I use `PyBytes_FromStringAndSize`. What to replace that with?


---

Comment by jdemeyer created at 2019-01-28 10:35:38

Replying to [comment:15 SimonKing]:
> In pickling, I use `PyBytes_FromStringAndSize`. What to replace that with?

Just keep that.


---

Comment by embray created at 2019-01-28 15:48:37

Changing status from new to needs_review.


---

Comment by embray created at 2019-01-28 15:48:37

I messed up again on catching up on my backlog of Python 3 fixes.  I already have this fixed in my Python 3 branch.  Apologies to anyone who wasted their time on this.

(I just didn't know who uses meataxe so this fix wasn't very high priority to make a ticket for.)


---

Comment by embray created at 2019-01-28 15:48:43

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-01-28 15:58:56

My fix looked like:


```diff
diff --git a/src/sage/libs/meataxe.pyx b/src/sage/libs/meataxe.pyx
index ab711d0..c0577a1 100644
--- a/src/sage/libs/meataxe.pyx
+++ b/src/sage/libs/meataxe.pyx
@@ -10,6 +10,9 @@

 from cpython.exc cimport PyErr_SetObject
 from cysignals.signals cimport sig_block, sig_unblock
+
+from sage.cpython.string cimport str_to_bytes
+
 cdef dict ErrMsg = {
     "Not enough memory": MemoryError,
     "Time limit exceeded": RuntimeError,
@@ -66,8 +69,6 @@ cdef Matrix_t *rawMatrix(int Field, list entries) except NULL:
 ## this module. Hence, `import sage.libs.meataxe` is enough
 ## to make sure that MeatAxe is initialised.

-from cpython.bytes cimport PyBytes_AsString
-
 cdef void sage_meataxe_error_handler(const MtxErrorRecord_t *err):
     sig_block()
     cdef bytes ErrText = err.Text
@@ -80,7 +81,9 @@ cdef inline meataxe_init():
     import os
     from sage.env import DOT_SAGE
     global MtxLibDir
-    MtxLibDir = PyBytes_AsString(os.path.join(DOT_SAGE,'meataxe'))
+    mtxdir = str_to_bytes(os.path.join(DOT_SAGE, 'meataxe'))
+    MtxLibDir[:len(mtxdir)] = mtxdir
+    MtxLibDir[len(mtxdir)] = c'\0'
     ## Error handling for MeatAxe, to prevent immediate exit of the program
     MtxSetErrorHandler(sage_meataxe_error_handler)
```


I had to do it this way because `MtxLibDir` is a statically allocated `char[1024]` array, so I couldn't just assign to it directly.  Perhaps Jeroen knows a better way (other than just using `strcpy()` directly or something).

Another problem here is that ofc if `len(os.path.join(DOT_SAGE, 'meataxe'))` does not fit in the array (unlikely, but not impossible) its value will be truncated.  We should probably check for this and raise a `RuntimeError` or something.

I'm also not sure if it _must_ be zero-terminated, but I'm guessing to be on the safe side it should be.


---

Comment by embray created at 2019-01-28 15:59:46

I didn't have the fix to `sage_meataxe_error_handler` though.  That part looks good.


---

Comment by SimonKing created at 2019-01-28 16:07:22

Replying to [comment:19 embray]:
> My fix looked like:
> ...

So, you are saying I should merge your changeset into my branch, and then it is at least ready to be tested?

> I had to do it this way because `MtxLibDir` is a statically allocated `char[1024]` array, so I couldn't just assign to it directly.

Not? Then why did it work before?

> Another problem here is that if `len(os.path.join(DOT_SAGE, 'meataxe'))` does not fit in the array (unlikely, but not impossible) its value will be truncated.  We should probably check for this and raise a `RuntimeError` or something.

Indeed, this would be safer.

> I'm also not sure if it _must_ be zero-terminated, but I'm guessing to be on the safe side it should be.

I didn't care about zero termination before, so, probably it works without it. But again, it seems safer.

OK, I'll add a commit that will assert that the string length is `<=1023`, so that including the trailing zero it fits into an array of size 1024.


---

Comment by embray created at 2019-01-28 16:16:48

Replying to [comment:21 SimonKing]:
> Replying to [comment:19 embray]:
> > My fix looked like:
> > ...
> 
> So, you are saying I should merge your changeset into my branch, and then it is at least ready to be tested?
> 
> > I had to do it this way because `MtxLibDir` is a statically allocated `char[1024]` array, so I couldn't just assign to it directly.
> 
> Not? Then why did it work before?

That is a good question.  IIRC Cython would just not let me.


---

Comment by jdemeyer created at 2019-01-28 16:29:08

Replying to [comment:19 embray]:
> I had to do it this way because `MtxLibDir` is a statically allocated `char[1024]` array, so I couldn't just assign to it directly.  Perhaps Jeroen knows a better way (other than just using `strcpy()` directly or something).

The existing Cython-generated code for that boils down to

```
memcpy(MtxLibDir, PyBytes_AsString(...), sizeof(MtxLibDir))
```

In other words, it assumes that it's given a string of the correct size. This is therefore definitely a bug to be fixed.


---

Comment by embray created at 2019-01-28 16:29:25

I see; Cython handles this with a special `__Pyx_carray_from_py_char` which is implemented [here](https://github.com/cython/cython/blob/084a25f55d0b4cf8b4c3cd496ec57bb3e2f57f71/Cython/Utility/CConvert.pyx#L71).  I wonder what happened for me that it wasn't working properly.  Maybe for some reason I had an old Cython installed at one point.

It looks like it doesn't put in a trailing zero though, though, so it might still be best to do that.


---

Comment by SimonKing created at 2019-01-28 16:30:33

Replying to [comment:24 embray]:
> It looks like it doesn't put in a trailing zero though, though, so it might still be best to do that.

At least it is unlikely that the trailing zero would hurt...


---

Comment by embray created at 2019-01-28 16:30:46

While we're fixing things here could we also move the superfluous inline `import os` out of `meataxe_init`?


---

Comment by SimonKing created at 2019-01-28 16:31:38

Replying to [comment:26 embray]:
> While we're fixing things here could we also move the superfluous inline `import os` out of `meataxe_init`?

Sure. I just thought it is needed to be imported when it is used...


---

Comment by SimonKing created at 2019-01-28 16:34:41

Replying to [comment:27 SimonKing]:
> Replying to [comment:26 embray]:
> > While we're fixing things here could we also move the superfluous inline `import os` out of `meataxe_init`?
> 
> Sure. I just thought it is needed to be imported when it is used...

Indeed:

```
Error compiling Cython file:
------------------------------------------------------------
...
cdef inline meataxe_init():
    ## Assign to a variable that enables MeatAxe to find
    ## its multiplication tables.
    from sage.env import DOT_SAGE
    global MtxLibDir
    mtxdir = str_to_bytes(os.path.join(DOT_SAGE, 'meataxe'))
                         ^
------------------------------------------------------------

sage/libs/meataxe.pyx:82:26: undeclared name not builtin: os
```

But I guess it should be imported at module level (however, meataxe_init is only called once anyway, when the module is loaded, so, having the import in the function won't hurt).


---

Comment by git created at 2019-01-28 16:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-01-28 16:38:41

With the latest commit, I get loads of compile time warnings:

```
build/cythonized/sage/matrix/matrix_gfpn_dense.c: In function ‘__pyx_pf_4sage_6matrix_17matrix_gfpn_dense_17Matrix_gfpn_dense_8__reduce__’:
build/cythonized/sage/matrix/matrix_gfpn_dense.c:6153:35: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     for (__pyx_t_6 = 0; __pyx_t_6 < __pyx_t_5; __pyx_t_6+=1) {
                                   ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c: In function ‘__pyx_pf_4sage_6matrix_17matrix_gfpn_dense_17Matrix_gfpn_dense_12randomize’:
build/cythonized/sage/matrix/matrix_gfpn_dense.c:7559:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
           for (__pyx_t_12 = 0; __pyx_t_12 < __pyx_t_11; __pyx_t_12+=1) {
                                           ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:7663:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
           for (__pyx_t_12 = 0; __pyx_t_12 < __pyx_t_11; __pyx_t_12+=1) {
                                           ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c: In function ‘__pyx_pf_4sage_6matrix_17matrix_gfpn_dense_17Matrix_gfpn_dense_48_echelon_in_place_classical’:
build/cythonized/sage/matrix/matrix_gfpn_dense.c:14408:37: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     for (__pyx_t_14 = 0; __pyx_t_14 < __pyx_t_4; __pyx_t_14+=1) {
                                     ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:14448:37: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     for (__pyx_t_14 = 0; __pyx_t_14 < __pyx_t_4; __pyx_t_14+=1) {
                                     ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:14654:37: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     for (__pyx_t_14 = 0; __pyx_t_14 < __pyx_t_4; __pyx_t_14+=1) {
                                     ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c: In function ‘__pyx_pf_4sage_6matrix_17matrix_gfpn_dense_mtx_unpickle’:
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15675:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     __pyx_t_2 = ((__pyx_v_pickled_rowsize == FfCurrentRowSizeIo) != 0);
                                           ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15697:39: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
       for (__pyx_t_23 = 0; __pyx_t_23 < __pyx_t_8; __pyx_t_23+=1) {
                                       ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15754:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     __pyx_t_2 = ((__pyx_v_pickled_rowsize >= FfCurrentRowSizeIo) != 0);
                                           ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15820:41: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
         for (__pyx_t_23 = 0; __pyx_t_23 < __pyx_t_8; __pyx_t_23+=1) {
```

This needs to be addressed, too.


---

Comment by embray created at 2019-01-28 16:41:49

Replying to [comment:28 SimonKing]:
> Replying to [comment:27 SimonKing]:
> > Replying to [comment:26 embray]:
> > > While we're fixing things here could we also move the superfluous inline `import os` out of `meataxe_init`?
> > 
> > Sure. I just thought it is needed to be imported when it is used...
> 
> Indeed:
> {{{
> Error compiling Cython file:
> ------------------------------------------------------------
> ...
> cdef inline meataxe_init():
>     ## Assign to a variable that enables MeatAxe to find
>     ## its multiplication tables.
>     from sage.env import DOT_SAGE
>     global MtxLibDir
>     mtxdir = str_to_bytes(os.path.join(DOT_SAGE, 'meataxe'))
>                          ^
> ------------------------------------------------------------
> 
> sage/libs/meataxe.pyx:82:26: undeclared name not builtin: os
> }}}
> But I guess it should be imported at module level (however, meataxe_init is only called once anyway, when the module is loaded, so, having the import in the function won't hurt).

I mean, you still need `import os`, just at module-level.


---

Comment by SimonKing created at 2019-01-28 16:44:10

I guess the "forbidden" comparison is this:

```python
        cdef size_t i
        if self.Data:
            for i in range(self.Data.Nor):
```

`self.Data.Nor` is `int`, `i` is `size_t`.

What to do? At some point I was told to use size_t to iterate through sizes (and the number of rows of a matrix _is_ a size, although MeatAxe uses a signed type for it).

Is Cython clever enough to do the right thing if it sees `for i in range(self.Data.Nor)` without an explicit type declaration for `i`?


---

Comment by SimonKing created at 2019-01-28 16:45:08

Replying to [comment:31 embray]:
> I mean, you still need `import os`, just at module-level.

The two imports (DOT_SAGE and os) are now moved to module-level.


---

Comment by jdemeyer created at 2019-01-28 16:50:17

Replying to [comment:32 SimonKing]:
> I guess the "forbidden" comparison is this:
> {{{
> #!python
>         cdef size_t i
>         if self.Data:
>             for i in range(self.Data.Nor):
> }}}
> `self.Data.Nor` is `int`, `i` is `size_t`.
> 
> What to do? At some point I was told to use size_t to iterate through sizes (and the number of rows of a matrix _is_ a size, although MeatAxe uses a signed type for it).

In this case, you should use the same type for iterating as the type of the endpoint. So, for `i` you should use whatever type that `self.Data.Nor` is.


---

Comment by embray created at 2019-01-28 16:54:04

Replying to [comment:33 SimonKing]:
> Replying to [comment:31 embray]:
> > I mean, you still need `import os`, just at module-level.
> 
> The two imports (DOT_SAGE and os) are now moved to module-level.

No, just the `import os`.  The inline import of `from sage.env import DOT_SAGE` is necessary because the value of `DOT_SAGE` can in principle be changed at runtime, so by importing it at module-level you only ever get its original value.  The alternative in this case is 

`from sage import env`

and then later use `env.DOT_SAGE`.

Either way is fine but for global variables that can change value you have to be careful about this.


---

Comment by embray created at 2019-01-28 17:05:49

Replying to [comment:30 SimonKing]:
> With the latest commit, I get loads of compile time warnings:

I don't think most, if any, are actually related to any changes you made.  You're just seeing them now since you happened to modify the `matrix_gfpn_dense.pyx` file so it was recompiled.

I think they're mostly harmless, but it would be good to fix them nonetheless if you want to.  As Jeroen wrote the solution in these cases would be to ensure that matching integer types are being used in all these expressions (or matching the type of a loop variable with the type of `range()` arguments).


---

Comment by git created at 2019-01-28 17:08:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-01-28 17:12:42

Replying to [comment:36 embray]:
> I think they're mostly harmless, but it would be good to fix them nonetheless if you want to.

Yes, while I'm at it...

The problem is that upstream is not consequent in using signed and unsigned types. `FfCurrentRowSize` is `size_t`, but `nc`/`nr` (number of columns/rows) is `int`, but naturally the current row size is closely related with the number of columns.

With the latest commit, I am down to a single warning, and I don't see how to reduce it further, since I have a variable that in one place is compared against `FfCurrenrRowSize` but in another place (in the same function `mtx_unpickle`) is compared against `FfCurrentRowSize*nr`.

Can we live with this warning?


---

Comment by embray created at 2019-01-28 17:16:58

Replying to [comment:38 SimonKing]:
> Replying to [comment:36 embray]:
> > I think they're mostly harmless, but it would be good to fix them nonetheless if you want to.
> 
> Yes, while I'm at it...
> 
> The problem is that upstream is not consequent in using signed and unsigned types. `FfCurrentRowSize` is `size_t`, but `nc`/`nr` (number of columns/rows) is `int`, but naturally the current row size is closely related with the number of columns.

Yeah, that's annoying.  I wonder if there's any point in trying to fix that upstraem.

> With the latest commit, I am down to a single warning, and I don't see how to reduce it further, since I have a variable that in one place is compared against `FfCurrenrRowSize` but in another place (in the same function `mtx_unpickle`) is compared against `FfCurrentRowSize*nr`.

You could try just casting it explicitly?  Without looking directly at the context I'm not sure, but you should be alright casting a signed int to an unsigned.


---

Comment by embray created at 2019-01-28 17:17:11

Replying to [comment:39 embray]:
> Replying to [comment:38 SimonKing]:
> > Replying to [comment:36 embray]:
> > > I think they're mostly harmless, but it would be good to fix them nonetheless if you want to.
> > 
> > Yes, while I'm at it...
> > 
> > The problem is that upstream is not consequent in using signed and unsigned types. `FfCurrentRowSize` is `size_t`, but `nc`/`nr` (number of columns/rows) is `int`, but naturally the current row size is closely related with the number of columns.
> 
> Yeah, that's annoying.  I wonder if there's any point in trying to fix that upstraem.
> 
> > With the latest commit, I am down to a single warning, and I don't see how to reduce it further, since I have a variable that in one place is compared against `FfCurrenrRowSize` but in another place (in the same function `mtx_unpickle`) is compared against `FfCurrentRowSize*nr`.
> 
> You could try just casting it explicitly?  Without looking directly at the context I'm not sure, but you should be alright casting a signed int to an unsigned in this case.


---

Comment by jdemeyer created at 2019-01-28 17:48:11

Replying to [comment:39 embray]:
> Without looking directly at the context I'm not sure, but you should be alright casting a signed int to an unsigned.

Indeed. Something like `FfCurrentRowSize * <size_t>nr` should work.


---

Comment by SimonKing created at 2019-01-28 18:47:07

Replying to [comment:39 embray]:
> > The problem is that upstream is not consequent in using signed and unsigned types. `FfCurrentRowSize` is `size_t`, but `nc`/`nr` (number of columns/rows) is `int`, but naturally the current row size is closely related with the number of columns.
> 
> Yeah, that's annoying.  I wonder if there's any point in trying to fix that upstraem.

Well, in a way, I am upstream myself `;-)`. That's to say: There is MeatAxe, that was developed in Aachen (Germany) and is not very actively maintained. When trying to create a meataxe spkg, I eventually changed so many things (adding Vinograd Strassen multiplication and an autotoolised build system) that eventually I created a fork called SharedMeatAxe. And that's what is being used in Sage.

On the other hand, I am not very eager to make these upstream changes if it can be avoided. So, I guess type casting it is...


---

Comment by SimonKing created at 2019-01-28 19:40:47

WTH??

I get

```
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15677:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     __pyx_t_2 = ((__pyx_v_pickled_rowsize == FfCurrentRowSizeIo) != 0);
                                           ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15756:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     __pyx_t_2 = ((__pyx_v_pickled_rowsize >= FfCurrentRowSizeIo) != 0);
                                           ^
```

although in my current attempt (not pushed yet) both `pickled_rowsize` and `FfCurrentRowSizeIo` are `size_t`! How can that be?


---

Comment by jdemeyer created at 2019-01-28 20:53:04

Replying to [comment:43 SimonKing]:
> both `pickled_rowsize` and `FfCurrentRowSizeIo` are `size_t`!

Probably, these assumptions are incorrect.


---

Comment by SimonKing created at 2019-01-28 21:24:24

Replying to [comment:44 jdemeyer]:
> Replying to [comment:43 SimonKing]:
> > both `pickled_rowsize` and `FfCurrentRowSizeIo` are `size_t`!
> 
> Probably, these assumptions are incorrect.

According to meataxe.pxd, we have

```python
    cdef extern size_t FfCurrentRowSize # The byte size of a single row in memory,
                                        # always a multiple of sizeof(long)
    cdef extern size_t FfCurrentRowSizeIo # The number of bytes actually used in a row
```

In my current code, I have

```python
    cdef int lenData = len(Data)
    cdef size_t pickled_rowsize
    cdef int i
    if Data:
        if nr <= 0 or nc <= 0:
            raise ValueError("This matrix pickle contains data, thus, the number of rows and columns must be positive")
        pickled_rowsize = <size_t>lenData//<size_t>nr
        if lenData != pickled_rowsize*nr:
            raise ValueError(f"Expected a pickle with {FfCurrentRowSizeIo}*{nr} bytes, got {lenData} instead")
        x = Data
        if pickled_rowsize == FfCurrentRowSizeIo:
            pt = OUT.Data.Data
            for i in range(nr):
                memcpy(pt,x,FfCurrentRowSizeIo)
                x += FfCurrentRowSizeIo
                FfStepPtr(&(pt))
                sig_check()
        elif pickled_rowsize >= FfCurrentRowSizeIo:
            deprecation(23411, "Reading this pickle may be machine dependent")
            if pickled_rowsize == FfCurrentRowSize:
                memcpy(OUT.Data.Data, x, OUT.Data.RowSize*OUT.Data.Nor)
            else:
                pt = OUT.Data.Data
                for i in range(nr):
                    memcpy(pt,x,FfCurrentRowSizeIo)
                    x += pickled_rowsize
                    FfStepPtr(&(pt))
                    sig_check()
        else:
            raise ValueError(f"Expected a pickle with {FfCurrentRowSizeIo}*{nr} bytes, got {pickled_rowsize}*{nr} instead")
```

Compilation yields

```
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15589:35: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     __pyx_t_2 = ((__pyx_v_lenData != (__pyx_v_pickled_rowsize * __pyx_v_nr)) != 0);
                                   ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15677:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     __pyx_t_2 = ((__pyx_v_pickled_rowsize == FfCurrentRowSizeIo) != 0);
                                           ^
build/cythonized/sage/matrix/matrix_gfpn_dense.c:15756:43: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     __pyx_t_2 = ((__pyx_v_pickled_rowsize >= FfCurrentRowSizeIo) != 0);
                                           ^


---

Comment by jdemeyer created at 2019-01-29 07:26:30

Replying to [comment:45 SimonKing]:
> According to meataxe.pxd

But `meataxe.pxd` isn't what really defines the type. That's just for Cython and it's wrong since `meataxe.h` contains

```C
extern size_t FfCurrentRowSize;
extern int FfCurrentRowSizeIo;
```



---

Comment by SimonKing created at 2019-01-29 08:27:35

Replying to [comment:46 jdemeyer]:
> Replying to [comment:45 SimonKing]:
> > According to meataxe.pxd
> 
> But `meataxe.pxd` isn't what really defines the type.

I didn't know that - I thought having a type in pxd means that there would be an automatic conversion.

> That's just for Cython and it's wrong since `meataxe.h` contains
> {{{
> #!C
> extern size_t FfCurrentRowSize;
> extern int FfCurrentRowSizeIo;
> }}}

Thank you! So, I should use the occasion to change the type in the pxd file.


---

Comment by jdemeyer created at 2019-01-29 08:44:52

Replying to [comment:47 SimonKing]:
> I didn't know that - I thought having a type in pxd means that there would be an automatic conversion.

No. For declarations outside `cdef extern`, Cython is the only source of truth. But for declarations in `cdef extern`, Cython uses that information to generate code but in the end only the C compiler knows the exact types.


---

Comment by git created at 2019-01-29 10:07:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-01-29 10:07:59

With the latest commit, the warnings during compilation are gone.

Now testing can start!


---

Comment by embray created at 2019-01-29 17:12:09

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-01-29 17:12:09

I'll want to test, and maybe squash some commits, but it look good to me otherwise.  Thank you for being so judicious about fixing warnings.  One of these days we should have a "fix Sage's compile warnings" sprint.


---

Comment by SimonKing created at 2019-01-29 17:22:03

Replying to [comment:51 embray]:
> I'll want to test, and maybe squash some commits, but it look good to me otherwise.  Thank you for being so judicious about fixing warnings.  One of these days we should have a "fix Sage's compile warnings" sprint.

Thank you! What is not clear to me: _How_ to test? After all, lots of Py3-doctests fail anyway. So, how to know that the ticket doesn't introduce a new failure?

In any case:

```
king@klap:~/Sage/git/py3$ ./sage -t --optional=sage,meataxe src/sage/matrix/matrix_gfpn_dense.pyx 
Running doctests with ID 2019-01-29-18-21-28-3f3b2ae3.
Using --optional=meataxe,memlimit,sage
Doctesting 1 file.
sage -t --warn-long 35.5 src/sage/matrix/matrix_gfpn_dense.pyx
    [266 tests, 11.12 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 11.2 seconds
    cpu time: 11.0 seconds
    cumulative wall time: 11.1 seconds
```



---

Comment by embray created at 2019-01-29 18:02:36

In this case it likely won't since meataxe is only used in a few places.  On a case-by-case basis I can look at some changes and make some intelligent inferences as to what other code it's likely to affect.  So I think probably exactly what you did.


---

Comment by jdemeyer created at 2019-01-29 19:39:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2019-01-29 19:39:57

I wouldn't use an `assert` statement here:

```
assert len(mtxdir)<1024, "The string os.path.join(DOT_SAGE, 'meataxe') needs to be of length < 1024 --- it is too long"
```

instead, something like

```
if len(mtxdir) >= 1024:
    raise RuntimeError(f"the path for the meataxe library {mtxdir!r} is too long, it needs to be of length < 1024")
```


Then various nitpicks:

Why change whitespace here? PEP 8 prefers the original form

```diff
-            pickle_str = PyBytes_FromStringAndSize(d, pickle_size)
+            pickle_str = PyBytes_FromStringAndSize( d, pickle_size )
```


Here, you might as well keep the `#` aligned:

```diff
     cdef extern int MPB                 # Number of marks stored in a single byte
     cdef extern size_t FfCurrentRowSize # The byte size of a single row in memory,
                                         # always a multiple of sizeof(long)
-    cdef extern size_t FfCurrentRowSizeIo # The number of bytes actually used in a row
+    cdef extern int FfCurrentRowSizeIo # The number of bytes actually used in a row
     cdef extern char MtxLibDir[1024]    # Where to search/create multiplication tables
```


This is a very long line, better split it in multiple statements. Also consider using an f-string:

```
PyErr_SetObject(ErrMsg.get(ErrText.split(': ')[-1], RuntimeError), "{} in file {} (line {})".format(ErrText, char_to_str(err.FileInfo.BaseName), err.LineNo))
```



---

Comment by SimonKing created at 2019-01-29 21:56:51

Replying to [comment:54 jdemeyer]:
> Then various nitpicks:
> 
> Why change whitespace here? PEP 8 prefers the original form
> {{{
> #!diff
> -            pickle_str = PyBytes_FromStringAndSize(d, pickle_size)
> +            pickle_str = PyBytes_FromStringAndSize( d, pickle_size )
> }}}

Seriously? I changed it because I recall people changing my code in exactly that way (i.e., inserting space after `(` and before `)`).
 
> This is a very long line, better split it in multiple statements. Also consider using an f-string:
> {{{
> PyErr_SetObject(ErrMsg.get(ErrText.split(': ')[-1], RuntimeError), "{} in file {} (line {})".format(ErrText, char_to_str(err.FileInfo.BaseName), err.LineNo))
> }}}

OK, I'll try to understand how f-strings work (never heard of them).


---

Comment by SimonKing created at 2019-01-29 21:58:30

Replying to [comment:53 embray]:
> In this case it likely won't since meataxe is only used in a few places.

Sure? It is used in every place that uses matrices over a finite non-prime field of size <255.


---

Comment by git created at 2019-01-29 22:07:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-01-29 22:15:47

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2019-01-29 22:15:47

With the latest changes (including an f-string, I succeeded to infer how it works), I get the following errors in sage/matrix:

```
sage -t --warn-long 35.5 src/sage/matrix/matrix_mod2_dense.pyx  # 1 doctest failed
sage -t --warn-long 35.5 src/sage/matrix/matrix_mpolynomial_dense.pyx  # 5 doctests failed
sage -t --warn-long 35.5 src/sage/matrix/matrix_double_dense.pyx  # 2 doctests failed
sage -t --warn-long 35.5 src/sage/matrix/docs.py  # 4 doctests failed
```

These errors all seem unrelated to meataxe:
- Apparently in `mod2_dense`, there is a byte<->str confusion.
- In `docs`, there are complaints about `M[3,range(5)]`. Has that become illegal in py3?
- In `double_dense`, there is a changed path given in a warning, and
  {{{
sage: [round(sqrt(abs(x)),4) for x in (S*S.transpose()).eigenvalues()]
Traceback (most recent call last):
...
TypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method
  }}}
  Has there been a change in a magical method name?
- `mpolynomial_dense` is the worst, it gives several results that substantially differ from the expected output.


---

Comment by jdemeyer created at 2019-01-30 09:11:44

This looks bad:

```diff
-    cdef size_t lenData = len(Data)
+    cdef int lenData = len(Data)
```

Do you intend to support matrices where `Data` is larger than 2<sup>31</sup> bytes? If so, `lenData` will overflow. The proper type to use here would be `Py_ssize_t`.

(sorry for not catching this earlier)


---

Comment by jdemeyer created at 2019-01-30 09:11:44

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2019-01-30 10:40:43

In fact, already _pickling_ a large matrix is problematic: I got a segfault with

```
M = matrix(GF(243), 2^16, 2^16)   # this takes about 1 hour
pickle = dumps(M)
```



---

Comment by jdemeyer created at 2019-01-30 10:42:00

Indeed, there is an overflow here:

```
pickle_size = FfCurrentRowSizeIo*self.Data.Nor
```



---

Comment by SimonKing created at 2019-01-30 10:48:54

Replying to [comment:60 jdemeyer]:
> In fact, already _pickling_ a large matrix is problematic: I got a segfault with
> {{{
> M = matrix(GF(243), 2^16, 2^16)   # this takes about 1 hour
> }}}

This means to allocate 4GB of memory and setting it to zero. Is it normal that it takes so long?


---

Comment by SimonKing created at 2019-01-30 10:50:42

Is `Py_ssize_t` for arbitrary large size?


---

Comment by SimonKing created at 2019-01-30 11:42:32

Replying to [comment:59 jdemeyer]:
> Do you intend to support matrices where `Data` is larger than 2<sup>31</sup> bytes? If so, `lenData` will overflow. The proper type to use here would be `Py_ssize_t`.
> 
> (sorry for not catching this earlier)

Would that really help?

```
sage: cython("""
....: def test(n):
....:     cdef Py_ssize_t n2 = n
....: """)
sage: test(2^64)
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
<ipython-input-11-e3b25168ccbb> in <module>()
----> 1 test(Integer(2)**Integer(64))

/home/king/.sage/temp/klap/15910/spyx/_home_king__sage_temp_klap_15910_tmp_ggabnpel_pyx/_home_king__sage_temp_klap_15910_tmp_ggabnpel_pyx_0.pyx in _home_king__sage_temp_klap_15910_tmp_ggabnpel_pyx_0.test()
      1 
      2 def test(n):
----> 3     cdef Py_ssize_t n2 = n

OverflowError: Python int too large to convert to C ssize_t
```

Or can one trust that `Py_ssize_t` on a specific machine is always sufficient to represent the number of bytes in the machine's memory?


---

Comment by jdemeyer created at 2019-01-30 13:26:30

Replying to [comment:64 SimonKing]:
> {{{
> sage: cython("""
> ....: def test(n):
> ....:     cdef Py_ssize_t n2 = n
> ....: """)
> sage: test(2^64)
> }}}

Why did you use `2^64` in this example? I'm talking about matrices taking `2^32` bytes of memory on 64-bit systems.


---

Comment by SimonKing created at 2019-01-30 16:00:29

Replying to [comment:65 jdemeyer]:
> Why did you use `2^64` in this example? I'm talking about matrices taking `2^32` bytes of memory on 64-bit systems.

I wanted to find out if using `Py_ssize_t` fixes the problem for good, or if it just shifts the problem.


---

Comment by chapoton created at 2019-01-30 19:57:13

Replying to [comment:58 SimonKing]:
> With the latest changes (including an f-string, I succeeded to infer how it works), I get the following errors in sage/matrix:
> {{{
> sage -t --warn-long 35.5 src/sage/matrix/matrix_mod2_dense.pyx  # 1 doctest failed
> sage -t --warn-long 35.5 src/sage/matrix/matrix_mpolynomial_dense.pyx  # 5 doctests failed
> sage -t --warn-long 35.5 src/sage/matrix/matrix_double_dense.pyx  # 2 doctests failed
> sage -t --warn-long 35.5 src/sage/matrix/docs.py  # 4 doctests failed
> }}}
> These errors all seem unrelated to meataxe:
> - Apparently in `mod2_dense`, there is a byte<->str confusion.
> - In `docs`, there are complaints about `M[3,range(5)]`. Has that become illegal in py3?
> - In `double_dense`, there is a changed path given in a warning, and
>   {{{
> sage: [round(sqrt(abs(x)),4) for x in (S*S.transpose()).eigenvalues()]
> Traceback (most recent call last):
> ...
> TypeError: type sage.rings.real_double.RealDoubleElement doesn't define __round__ method
>   }}}
>   Has there been a change in a magical method name?
> - `mpolynomial_dense` is the worst, it gives several results that substantially differ from the expected output.

These seem to be exactly the errors remaining in vanilla sage with python3 in the matrix module:

```
sage -t --long src/sage/matrix/docs.py  # 4 doctests failed
sage -t --long src/sage/matrix/matrix_double_dense.pyx  # 2 doctests failed
sage -t --long src/sage/matrix/matrix_mod2_dense.pyx  # 1 doctest failed
sage -t --long src/sage/matrix/matrix_mpolynomial_dense.pyx  # 5 doctests failed
```



---

Comment by git created at 2019-01-31 14:15:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2019-01-31 14:16:34

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2019-01-31 14:16:34

I have changed the type of `lenData` into `Py_ssize_t`. I think that was the only remaining issue raised by the reviewers. So, I'm putting it back to "needs review".


---

Comment by jdemeyer created at 2019-01-31 22:13:23

Replying to [comment:66 SimonKing]:
> I wanted to find out if using `Py_ssize_t` fixes the problem for good, or if it just shifts the problem.

On 64-bit systems, it shifts the problem to 2<sup>63</sup> which is surely larger than one can construct in practice.


---

Comment by SimonKing created at 2019-01-31 22:54:10

Replying to [comment:60 jdemeyer]:
> In fact, already _pickling_ a large matrix is problematic: I got a segfault with
> {{{
> M = matrix(GF(243), 2^16, 2^16)   # this takes about 1 hour
> pickle = dumps(M)
> }}}

For the record:

```
sage: %time M = matrix(GF(243), 2^16, 2^16)
CPU times: user 7min 31s, sys: 916 ms, total: 7min 31s
Wall time: 7min 32s
sage: pickle = dumps(M)
<crash>
```

Why is it taking 1 hour on your machine?

In any case, the problem isn't solved with the new commit, and I don't understand the stack backtrace. Part of it:

```
Stack backtrace
---------------
    options=options@entry=0) at ../sysdeps/unix/sysv/linux/waitpid.c:29
        resultvar = 18446744073709551104
        sc_cancel_oldtype = 0
#1  0x00007f51d717b103 in print_enhanced_backtrace ()
    at build/src/cysignals/implementation.c:554
        parent_pid = 7135
        pid = <optimized out>
#2  0x00007f51d717c88c in sigdie (sig=sig@entry=11, 
    s=s@entry=0x7f51d7185b90 "Unhandled SIGSEGV: A segmentation fault occurred.") at build/src/cysignals/implementation.c:579
No locals.
#3  0x00007f51d717fa1c in sigdie_for_sig (inside=0, sig=11)
    at build/src/cysignals/implementation.c:159
No locals.
#4  cysigs_signal_handler (sig=11) at build/src/cysignals/implementation.c:257
No locals.
#5  <signal handler called>
No locals.
#6  __memcpy_sse2_unaligned ()
    at ../sysdeps/x86_64/multiarch/memcpy-sse2-unaligned.S:37
No locals.
#7  0x00007f501e681655 in memcpy (__len=65536, __src=<optimized out>, 
    __dest=0x0) at /usr/include/x86_64-linux-gnu/bits/string3.h:53
No locals.
#8  __pyx_pf_4sage_6matrix_17matrix_gfpn_dense_17Matrix_gfpn_dense_8__reduce__
    (__pyx_v_self=0x7f501e8d45c8)
    at build/cythonized/sage/matrix/matrix_gfpn_dense.c:6163
        __pyx_v_p = 0x7f4f1e1c4010 ""
        __pyx_t_2 = 65536
        __pyx_t_11 = 0x0
        __pyx_t_8 = 0x0
        __pyx_t_12 = 0x0
        __pyx_t_4 = <optimized out>
        __pyx_t_9 = 0x0
        __pyx_v_x = 0x0
        __pyx_v_i = 0
        __pyx_r = 0x0
        __pyx_t_5 = 65536
        __pyx_v_pickle_size = 0
        __pyx_v_pickle_str = 0x0
        __pyx_t_1 = <optimized out>
        __pyx_t_6 = 0
        __pyx_t_10 = 0x0
#9  __pyx_pw_4sage_6matrix_17matrix_gfpn_dense_17Matrix_gfpn_dense_9__reduce__
    (__pyx_v_self=0x7f501e8d45c8, unused=<optimized out>)
    at build/cythonized/sage/matrix/matrix_gfpn_dense.c:6048
        __pyx_r = 0x0
#10 0x00007f51e5d3d0c7 in _PyCFunction_FastCallDict (
    func_obj=func_obj@entry=0x7f501ffb1bd0, args=args@entry=0x0, nargs=0, 
    kwargs=kwargs@entry=0x0) at Objects/methodobject.c:192
        func = 0x7f501ffb1bd0
        meth = 0x7f501e681540 <__pyx_pw_4sage_6matrix_17matrix_gfpn_dense_17Matrix_gfpn_dense_9__reduce__>
        self = 0x7f501e8d45c8
        result = <optimized out>
        flags = <optimized out>
#11 0x00007f51e5ce0abe in _PyObject_FastCallDict (func=0x7f501ffb1bd0, 
    args=0x0, nargs=<optimized out>, kwargs=0x0) at Objects/abstract.c:2313
        call = <optimized out>
        result = 0x0
#12 0x00007f51e5d59cf8 in object_reduce_ex (self=0x7f501e8d45c8, 
    args=<optimized out>) at Objects/typeobject.c:4392
        cls = <optimized out>
        clsreduce = <optimized out>
        override = <optimized out>
        objreduce = 0x7f51e63641b0
        reduce = 0x7f501ffb1bd0
        proto = 2
        PyId___reduce__ = {next = 0x7f51e0a48580 <PyId___reduce_ex__.12941>, 
          string = 0x7f51e5e851f5 "__reduce__", object = 0x7f51e6365d70}
#13 0x00007f51e5d3d0d9 in _PyCFunction_FastCallDict (
    func_obj=func_obj@entry=0x7f501e8cd708, args=args@entry=0x7ffca19699f0, 
    nargs=<optimized out>, kwargs=kwargs@entry=0x0)
    at Objects/methodobject.c:234
        tuple = 0x7f501f247240
        func = 0x7f501e8cd708
        meth = 0x7f51e5d59c50 <object_reduce_ex>
        self = 0x7f501e8d45c8
        result = <optimized out>
        flags = <optimized out>
#14 0x00007f51e5ce0abe in _PyObject_FastCallDict (
    func=func@entry=0x7f501e8cd708, args=args@entry=0x7ffca19699f0, 
    nargs=nargs@entry=1, kwargs=kwargs@entry=0x0) at Objects/abstract.c:2313
        call = <optimized out>
        result = 0x0
#15 0x00007f51e083dedd in _Pickle_FastCall (
    obj=0x7f51e6172500 <small_ints+224>, func=0x7f501e8cd708)
    at /home/king/Sage/git/py3/local/var/tmp/sage/build/python3-3.6.6.p0/src/Modules/_pickle.c:349
        result = <optimized out>
#16 save (self=self@entry=0x7f501efd7a98, obj=obj@entry=0x7f501e8d45c8, 
    pers_save=0)
    at /home/king/Sage/git/py3/local/var/tmp/sage/build/python3-3.6.6.p0/src/Modules/_pickle.c:3990
        proto = <optimized out>
        PyId___reduce__ = {next = 0x0, string = 0x7f51e0843064 "__reduce__", 
          object = 0x0}
        PyId___reduce_ex__ = {
          next = 0x7f51e0a485c0 <PyId_dispatch_table.13012>, 
          string = 0x7f51e084306f "__reduce_ex__", object = 0x7f51e6365d30}
        type = 0x7f501e8a6400 <__pyx_type_4sage_6matrix_17matrix_gfpn_dense_Matrix_gfpn_dense>
        reduce_func = 0x7f501e8cd708
        reduce_value = 0x0
        status = 0
#17 0x00007f51e0841603 in dump (self=self@entry=0x7f501efd7a98, 
    obj=obj@entry=0x7f501e8d45c8)
    at /home/king/Sage/git/py3/local/var/tmp/sage/build/python3-3.6.6.p0/src/Modules/_pickle.c:4063
        stop_op = 46 '.'
#18 0x00007f51e084181c in _pickle_Pickler_dump (self=0x7f501efd7a98, 
    obj=0x7f501e8d45c8)
    at /home/king/Sage/git/py3/local/var/tmp/sage/build/python3-3.6.6.p0/src/Modules/_pickle.c:4121
No locals.
#19 0x00007f51de922f2e in __Pyx_PyObject_CallMethO (arg=<optimized out>, 
    func=<optimized out>) at build/cythonized/sage/misc/persist.c:12833
        self = 0x7f501efd7a98
        result = <optimized out>
        cfunc = 0x7f51e08417a0 <_pickle_Pickler_dump>
#20 __Pyx_PyObject_CallOneArg (arg=0x7f501e8d45c8, func=<optimized out>)
    at build/cythonized/sage/misc/persist.c:12864
No locals.
#21 __pyx_pf_4sage_4misc_7persist_11SagePickler_2dumps (
    __pyx_self=<optimized out>, __pyx_v_kwargs=0x7f501f242630, 
    __pyx_v_obj=<optimized out>, __pyx_v_cls=<optimized out>)
    at build/cythonized/sage/misc/persist.c:6607
        __pyx_v_pickler = <optimized out>
        __pyx_t_2 = 0x0
        __pyx_v_buf = 0x7f501facbd58
        __pyx_r = 0x0
        __pyx_t_1 = <optimized out>
        __pyx_t_3 = 0x0
#22 __pyx_pw_4sage_4misc_7persist_11SagePickler_3dumps (
    __pyx_self=<optimized out>, __pyx_args=<optimized out>, 
    __pyx_kwds=<optimized out>) at build/cythonized/sage/misc/persist.c:6522
        __pyx_v_cls = <optimized out>
        __pyx_v_obj = <optimized out>
        __pyx_v_kwargs = 0x7f501f242630
        __pyx_r = 0x0
#23 0x00007f51de91186b in __Pyx_PyObject_Call (kw=0x0, arg=0x7f501e1cc548, 
    func=0x7f51defe6d38) at build/cythonized/sage/misc/persist.c:12642
        result = <optimized out>
        call = 0x7f51ded813c8 <__Pyx_CyFunction_CallAsMethod>
#24 __Pyx_PyObject_Call2Args (function=function@entry=0x7f51defe6d38, 
    arg1=arg1@entry=0x2923bf8, arg2=arg2@entry=0x7f501e8d45c8)
    at build/cythonized/sage/misc/persist.c:12817
        args = 0x7f501e1cc548
        result = 0x0
#25 0x00007f51de91f481 in __pyx_pf_4sage_4misc_7persist_6_base_dumps (
    __pyx_self=<optimized out>, __pyx_v_compress=<optimized out>, 
    __pyx_v_obj=<optimized out>) at build/cythonized/sage/misc/persist.c:3892
        __pyx_v_gherkin = 0x0
        __pyx_t_2 = 0x2923bf8
        __pyx_r = 0x0
        __pyx_t_1 = 0x0
        __pyx_t_3 = 0x7f51defe6d38
#26 __pyx_pw_4sage_4misc_7persist_7_base_dumps (__pyx_self=<optimized out>, 
    __pyx_args=<optimized out>, __pyx_kwds=<optimized out>)
    at build/cythonized/sage/misc/persist.c:3853
        __pyx_v_obj = <optimized out>
        __pyx_v_compress = <optimized out>
#27 0x00007f51e5d3d289 in PyCFunction_Call (func=0x7f51de038b40, 
    args=0x7f501e8e65f8, kwds=<optimized out>) at Objects/methodobject.c:98
        f = 0x7f51de038b40
        meth = 0x7f51de91ee80 <__pyx_pw_4sage_4misc_7persist_7_base_dumps>
        self = 0x0
        arg = <optimized out>
        res = <optimized out>
        size = <optimized out>
        flags = 3
#28 0x00007f51deb49b97 in __Pyx_PyObject_Call (kw=0x7f501f242870, 
    arg=0x7f501e8e65f8, func=0x7f51de038b40)
    at build/cythonized/sage/structure/sage_object.c:11976
        result = <optimized out>
        call = 0x7f51e5d3d190 <PyCFunction_Call>
#29 __pyx_pf_4sage_9structure_11sage_object_10SageObject_20dumps (
    __pyx_v_compress=<optimized out>, __pyx_v_self=<optimized out>)
    at build/cythonized/sage/structure/sage_object.c:3638
        __pyx_t_2 = 0x7f501e8e65f8
        __pyx_t_4 = 0x0
        __pyx_r = 0x0
        __pyx_t_1 = 0x7f51de038b40
        __pyx_t_3 = 0x7f501f242870
#30 __pyx_pw_4sage_9structure_11sage_object_10SageObject_21dumps (
    __pyx_v_self=<optimized out>, __pyx_args=<optimized out>, 
    __pyx_kwds=<optimized out>)
    at build/cythonized/sage/structure/sage_object.c:3604
        __pyx_v_compress = <optimized out>
#31 0x00007f51e5d3d289 in PyCFunction_Call (func=0x7f501e8c39d8, 
    args=0x7f501e8e61d0, kwds=<optimized out>) at Objects/methodobject.c:98
        f = 0x7f501e8c39d8
        meth = 0x7f51deb49a80 <__pyx_pw_4sage_9structure_11sage_object_10SageObject_21dumps>
        self = 0x7f501e8d45c8
        arg = <optimized out>
        res = <optimized out>
        size = <optimized out>
        flags = 3
#32 0x00007f51de90e03d in __Pyx_PyObject_Call (kw=0x0, arg=0x7f501e8e61d0, 
    func=0x7f501e8c39d8) at build/cythonized/sage/misc/persist.c:12642
        result = <optimized out>
        call = 0x7f51e5d3d190 <PyCFunction_Call>
#33 __Pyx__PyObject_CallOneArg (func=0x7f501e8c39d8, 
    arg=arg@entry=0x7f51e610ea60 <_Py_TrueStruct>)
    at build/cythonized/sage/misc/persist.c:12852
        args = 0x7f501e8e61d0
#34 0x00007f51de924e6b in __Pyx_PyObject_CallOneArg (
    arg=0x7f51e610ea60 <_Py_TrueStruct>, func=<optimized out>)
    at build/cythonized/sage/misc/persist.c:12871
No locals.
#35 __pyx_pf_4sage_4misc_7persist_8dumps (__pyx_self=<optimized out>, 
    __pyx_v_compress=<optimized out>, __pyx_v_obj=<optimized out>)
    at build/cythonized/sage/misc/persist.c:4158
        __pyx_tstate = 0x24a3bc0
        __pyx_t_4 = 0x0
        __pyx_t_8 = <optimized out>
        __pyx_t_12 = 0x0
        __pyx_r = 0x0
        __pyx_t_1 = <optimized out>
        __pyx_t_5 = 0x7f51e6128150 <_Py_NoneStruct>
        __pyx_t_9 = 0x0
        __pyx_t_2 = 0x0
        __pyx_t_6 = 0x0
        __pyx_t_10 = 0x0
        __pyx_t_3 = 0x7f501e8c39d8
        __pyx_t_7 = 0x0
        __pyx_t_11 = 0x0
#36 __pyx_pw_4sage_4misc_7persist_9dumps (__pyx_self=<optimized out>, 
    __pyx_args=<optimized out>, __pyx_kwds=<optimized out>)
    at build/cythonized/sage/misc/persist.c:4053
        __pyx_v_obj = <optimized out>
        __pyx_v_compress = <optimized out>
        __pyx_r = 0x0
#37 0x00007f51e5d3d076 in _PyCFunction_FastCallDict (func_obj=0x7f51de038b88, 
    args=0x7f502ede3ee8, nargs=<optimized out>, kwargs=kwargs@entry=0x0)
    at Objects/methodobject.c:231
        tuple = 0x7f501e8e68d0
        func = 0x7f51de038b88
        meth = 0x7f51de9241a0 <__pyx_pw_4sage_4misc_7persist_9dumps>
        self = 0x0
        result = <optimized out>
        flags = <optimized out>
#38 0x00007f51e5d3d3a7 in _PyCFunction_FastCallKeywords (
    func=func@entry=0x7f51de038b88, stack=stack@entry=0x7f502ede3ee8, 
    nargs=<optimized out>, kwnames=kwnames@entry=0x0)
    at Objects/methodobject.c:294
        kwdict = 0x0
        result = <optimized out>
        nkwargs = 0
#39 0x00007f51e5dd0e11 in call_function (
    pp_stack=pp_stack@entry=0x7ffca1969f20, oparg=oparg@entry=1, 
    kwnames=kwnames@entry=0x0) at Python/ceval.c:4830
        tstate = 0x24a3bc0
        pfunc = 0x7f502ede3ee0
        func = 0x7f51de038b88
        x = <optimized out>
        w = <optimized out>
        nkwargs = <optimized out>
        nargs = <optimized out>
        stack = 0x7f502ede3ee8
```



---

Comment by SimonKing created at 2019-02-01 13:06:25

Suggestion: This ticket should focus on Py3. If I see that correctly, meataxe/matrix_gfpn_dense now _does_ work with py3, and therefore the ticket should be reviewed.

For the segfault and related problems, I suggest to open a different ticket. There definitely seems something wrong when big matrices are involved:

```
sage: %time M = matrix(GF(243), 2^16, 2^16)
CPU times: user 7min 23s, sys: 1.06 s, total: 7min 24s
Wall time: 7min 25s
sage: M[0,0]
0
sage: M[2^16-1,0]
0
sage: M[2^16-1,2^16-1]
0
sage: M[2^16-1,2^16-1] = 123
sage: M[2^16-1,2^16-1]    # wrong
0
```

So, the new ticket should be about overflows (which is orthogonal to the py3-problem).


---

Comment by SimonKing created at 2019-02-01 13:10:09

The follow-up ticket is #27198


---

Comment by jdemeyer created at 2019-02-01 20:01:23

Replying to [comment:72 SimonKing]:
> Suggestion: This ticket should focus on Py3.

The problem is that it's already too late for that. You are already making many changes unrelated to Python 3, so I'm reviewing those changes too. And I have to make sure that there are no regressions.


---

Comment by SimonKing created at 2019-02-01 20:09:18

Replying to [comment:74 jdemeyer]:
> Replying to [comment:72 SimonKing]:
> > Suggestion: This ticket should focus on Py3.
> 
> The problem is that it's already too late for that. You are already making many changes unrelated to Python 3, so I'm reviewing those changes too. And I have to make sure that there are no regressions.

Right, the current branch does contain stuff that fixes warnings etc. unrelated with py3. And I think the already done changes shouldn't be reverted. But probably you agree that there should be no _further_ unrelated changes here.


---

Comment by jdemeyer created at 2019-02-01 20:46:29

Replying to [comment:75 SimonKing]:
> But probably you agree that there should be no _further_ unrelated changes here.

No, I don't agree with that. I generally don't like compromises if they are worse than either extreme. One extreme would be: a minimal ticket focusing just on Python 3, no changes to types. Fine for me, such a ticket probably would have gotten positive review already. I'm sure that you didn't expect "let's just fix a few warnings" to become so messy, so I'm not trying to blame you here.

The other extreme would be: change types but do it properly, making sure that there are no overflows in the wrappers for example.

But now we are in between, where potentially breaking changes have been made. It could be that nothing has actually been broken, I would need to check. But I'll need to know if you plan further changes to this ticket or not (I'm fine either way, I just need to know).


---

Comment by git created at 2019-02-01 21:25:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by SimonKing created at 2019-02-01 21:40:36

Replying to [comment:76 jdemeyer]:
> I generally don't like compromises if they are worse than either extreme.

I generally don't like extremes.

The compromise, from my perspective, is to acknowledge that the reviewer's time is more efficiently spent with looking at smaller changes that really focus on one ticket's topic.

Therefore, I re-ordered and partially rebased the commits, so that here are only the bits that make meataxe workwith py3 (plus some cosmetical change, aligning comments in meataxe.pxd). The other commits will be part of #27198, where they belong.

I will now move to #27198 and hope that all py3 issues are dealt with.


---

Comment by nbruin created at 2019-02-02 21:11:24

Replying to [comment:21 SimonKing]:
> > I'm also not sure if it _must_ be zero-terminated, but I'm guessing to be on the safe side it should be.
> 
> I didn't care about zero termination before, so, probably it works without it. But again, it seems safer.
> 
> OK, I'll add a commit that will assert that the string length is `<=1023`, so that including the trailing zero it fits into an array of size 1024.

Looking at the C-API documentation [https://docs.python.org/3/c-api/bytes.html](https://docs.python.org/3/c-api/bytes.html) it looks like the Python bytes data structure already has room for a trailing 0. It's not going to be a big difference, but going forward it's perhaps something to keep in mind.


---

Comment by jdemeyer created at 2019-02-04 08:58:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-05 16:57:50

Resolution: fixed
