# Issue 18539: From poset to lattice: Do not copy Hasse Diagram

archive/issues_018539.json:
```json
{
    "body": "CC:  @tscrim\n\n```\nP = Poset({0:[1]})\nQ = Poset(P)\nL = LatticePoset(P)\nP._hasse_diagram is Q._hasse_diagram, P._hasse_diagram is L._hasse_diagram\n```\n\noutputs `(True, False)`. Hence Hasse diagram, which is immutable, is copied --- and so also meet and join matrix will be computed twice.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18776\n\n",
    "created_at": "2015-06-23T18:54:50Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "From poset to lattice: Do not copy Hasse Diagram",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18539",
    "user": "https://github.com/jm58660"
}
```
CC:  @tscrim

```
P = Poset({0:[1]})
Q = Poset(P)
L = LatticePoset(P)
P._hasse_diagram is Q._hasse_diagram, P._hasse_diagram is L._hasse_diagram
```

outputs `(True, False)`. Hence Hasse diagram, which is immutable, is copied --- and so also meet and join matrix will be computed twice.



Issue created by migration from https://trac.sagemath.org/ticket/18776





---

archive/issue_comments_251855.json:
```json
{
    "body": "Actually this happens with just posets:\n\n```\nP = Poset({0:[1]})\nR = Poset(P, facade=False)\nP._hasse_diagram is R._hasse_diagram\n```\n\nalso outputs `False`. I can see no reason for this either. And still more, what about\n\n```\nP = Poset({0:[1]})\nQ = P.relabel(lambda i: chr(ord('a')+i))\nP._hasse_diagram is Q._hasse_diagram\n```\n\n? Relabeling does not touch the underlying digraph of plain `int`s.",
    "created_at": "2015-08-12T17:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251855",
    "user": "https://github.com/jm58660"
}
```

Actually this happens with just posets:

```
P = Poset({0:[1]})
R = Poset(P, facade=False)
P._hasse_diagram is R._hasse_diagram
```

also outputs `False`. I can see no reason for this either. And still more, what about

```
P = Poset({0:[1]})
Q = P.relabel(lambda i: chr(ord('a')+i))
P._hasse_diagram is Q._hasse_diagram
```

? Relabeling does not touch the underlying digraph of plain `int`s.



---

archive/issue_comments_251856.json:
```json
{
    "body": "If I remove the line `hasse_diagram = hasse_diagram.copy(immutable=True)` from `posets.py`, it seems that no test will fail. And still I got `False` when testing `P._hasse_diagram is Q._hasse_diagram`. Might be because \n\n```\nself._hasse_diagram = HasseDiagram(hasse_diagram.relabel(rdict, inplace=False), data_structure=\"static_sparse\")\n```\n\nin `__init__()` does the copy. Maybe this relates to adding immutable graphs, and now copying is unnecessary?",
    "created_at": "2015-08-13T05:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251856",
    "user": "https://github.com/jm58660"
}
```

If I remove the line `hasse_diagram = hasse_diagram.copy(immutable=True)` from `posets.py`, it seems that no test will fail. And still I got `False` when testing `P._hasse_diagram is Q._hasse_diagram`. Might be because 

```
self._hasse_diagram = HasseDiagram(hasse_diagram.relabel(rdict, inplace=False), data_structure="static_sparse")
```

in `__init__()` does the copy. Maybe this relates to adding immutable graphs, and now copying is unnecessary?



---

archive/issue_comments_251857.json:
```json
{
    "body": "> Might be because \n> \n> \n> ```\n> self._hasse_diagram = HasseDiagram(hasse_diagram.relabel(rdict, inplace=False), data_structure=\"static_sparse\")\n> ```\n\n\nYes, this line would trigger a (relabelled) copy of the graph.\n\nNathann",
    "created_at": "2015-08-13T06:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251857",
    "user": "https://github.com/nathanncohen"
}
```

> Might be because 
> 
> 
> ```
> self._hasse_diagram = HasseDiagram(hasse_diagram.relabel(rdict, inplace=False), data_structure="static_sparse")
> ```


Yes, this line would trigger a (relabelled) copy of the graph.

Nathann



---

archive/issue_comments_251858.json:
```json
{
    "body": "Travis, you might be interested in this.\n\nTo start with easy one: Why `relabel()` does not just have same Hasse diagram, and different `_vertex_to_element` etc? Is there something untrivial I can't see?",
    "created_at": "2015-09-10T15:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251858",
    "user": "https://github.com/jm58660"
}
```

Travis, you might be interested in this.

To start with easy one: Why `relabel()` does not just have same Hasse diagram, and different `_vertex_to_element` etc? Is there something untrivial I can't see?



---

archive/issue_comments_251859.json:
```json
{
    "body": "It has to do with how the constructor processes the digraph input as it gets the labels from the digraph vertex labels IIRC. When Anne and I were refactoring the class, we decided not to make backwards incompatible changes and not break things that required fixed linear extensions (and were under pressure because of some fud). There might be a better solution, but it would likely require a massive overhaul to keep certain (doctested) features from breaking.",
    "created_at": "2015-09-10T16:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251859",
    "user": "https://github.com/tscrim"
}
```

It has to do with how the constructor processes the digraph input as it gets the labels from the digraph vertex labels IIRC. When Anne and I were refactoring the class, we decided not to make backwards incompatible changes and not break things that required fixed linear extensions (and were under pressure because of some fud). There might be a better solution, but it would likely require a massive overhaul to keep certain (doctested) features from breaking.



---

archive/issue_comments_251860.json:
```json
{
    "body": "Sorry, but I do not understand. What is \"required fixed linear extensions\"?\n\nFor example there is three possible linear extension for the pentagon poset. If I do `relabel(lambda i: chr(ord('a')+i))` to it, why I can not use exactly same Hasse diagram, and so exactly same linear extension? Or to say it by code, what will following break?\n\n```\nP=Posets.PentagonPoset()\nP._elements=('a','b','c','d','e')\nP._element_to_vertex_dict={'a': 0, 'b': 1, 'c': 2, 'd': 3, 'e': 4}\nP._list=('a','b','c','d','e')\n```",
    "created_at": "2015-09-10T18:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251860",
    "user": "https://github.com/jm58660"
}
```

Sorry, but I do not understand. What is "required fixed linear extensions"?

For example there is three possible linear extension for the pentagon poset. If I do `relabel(lambda i: chr(ord('a')+i))` to it, why I can not use exactly same Hasse diagram, and so exactly same linear extension? Or to say it by code, what will following break?

```
P=Posets.PentagonPoset()
P._elements=('a','b','c','d','e')
P._element_to_vertex_dict={'a': 0, 'b': 1, 'c': 2, 'd': 3, 'e': 4}
P._list=('a','b','c','d','e')
```



---

archive/issue_comments_251861.json:
```json
{
    "body": "There is some code which depends on the poset data including a particular (fixed) linear extension. I don't remember off-hand what it is, but doctests will break if that functionality to not specify a linear extension is removed. IIRC, it is this which requires the labels of the digraph to be used. Try looking in the linear extension file.",
    "created_at": "2015-09-10T19:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251861",
    "user": "https://github.com/tscrim"
}
```

There is some code which depends on the poset data including a particular (fixed) linear extension. I don't remember off-hand what it is, but doctests will break if that functionality to not specify a linear extension is removed. IIRC, it is this which requires the labels of the digraph to be used. Try looking in the linear extension file.



---

archive/issue_comments_251862.json:
```json
{
    "body": "Found it. After my example code `Posets.PentagonPoset()` will return poset with elements `'a'..'e'`.",
    "created_at": "2015-09-10T19:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251862",
    "user": "https://github.com/jm58660"
}
```

Found it. After my example code `Posets.PentagonPoset()` will return poset with elements `'a'..'e'`.



---

archive/issue_comments_251863.json:
```json
{
    "body": "See also #20434.",
    "created_at": "2016-04-14T06:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251863",
    "user": "https://github.com/jm58660"
}
```

See also #20434.



---

archive/issue_events_052526.json:
```json
{
    "actor": "https://github.com/jm58660",
    "created_at": "2016-12-05T11:35:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18539#event-52526"
}
```



---

archive/issue_comments_251864.json:
```json
{
    "body": "The problem seems to be in `UniqueRepresentation`:\n\n```\nA = Poset( ([0,1,2], []) )\nA._elements = ('a','b','c')\nA._element_to_vertex_dict = {'a': 0, 'b': 1, 'c': 2}\nA._list = ('a','b','c')\nB = Poset( ([0,1,2], []) )\nC = Poset( ([0,1,2], []), key=\"heyhou\")\nA.list(), B.list(), C.list()\n```\n\noutputs `(['a', 'b', 'c'], ['a', 'b', 'c'], [2, 1, 0])`.\n\nThis is too complicated for me, so I suggest this one to be closed.",
    "created_at": "2016-12-05T11:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251864",
    "user": "https://github.com/jm58660"
}
```

The problem seems to be in `UniqueRepresentation`:

```
A = Poset( ([0,1,2], []) )
A._elements = ('a','b','c')
A._element_to_vertex_dict = {'a': 0, 'b': 1, 'c': 2}
A._list = ('a','b','c')
B = Poset( ([0,1,2], []) )
C = Poset( ([0,1,2], []), key="heyhou")
A.list(), B.list(), C.list()
```

outputs `(['a', 'b', 'c'], ['a', 'b', 'c'], [2, 1, 0])`.

This is too complicated for me, so I suggest this one to be closed.



---

archive/issue_comments_251865.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-12-05T11:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251865",
    "user": "https://github.com/jm58660"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_251866.json:
```json
{
    "body": "What you are doing is clear abuse, and so we should not worry about that. We just need some code path in the constructor that shortcuts to `FinitePoset` (or `FiniteLatticePoset`) when given a poset and/or Hasse diagram.",
    "created_at": "2016-12-05T14:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251866",
    "user": "https://github.com/tscrim"
}
```

What you are doing is clear abuse, and so we should not worry about that. We just need some code path in the constructor that shortcuts to `FinitePoset` (or `FiniteLatticePoset`) when given a poset and/or Hasse diagram.



---

archive/issue_comments_251867.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-12-05T14:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251867",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_052527.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-05T14:06:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18539#event-52527"
}
```



---

archive/issue_events_052528.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-05T14:06:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18539#event-52528"
}
```



---

archive/issue_comments_251868.json:
```json
{
    "body": "Replying to [comment:12 tscrim]:\n> What you are doing is clear abuse, and so we should not worry about that. We just need some code path in the constructor that shortcuts to `FinitePoset` (or `FiniteLatticePoset`) when given a poset and/or Hasse diagram.\n\n\nOK, but I raise my hands: can't do.\n\nAnd the problem is smaller now, when meets and joins are faster to compute (thanks for review, btw).",
    "created_at": "2016-12-05T14:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251868",
    "user": "https://github.com/jm58660"
}
```

Replying to [comment:12 tscrim]:
> What you are doing is clear abuse, and so we should not worry about that. We just need some code path in the constructor that shortcuts to `FinitePoset` (or `FiniteLatticePoset`) when given a poset and/or Hasse diagram.


OK, but I raise my hands: can't do.

And the problem is smaller now, when meets and joins are faster to compute (thanks for review, btw).



---

archive/issue_comments_251869.json:
```json
{
    "body": "I will try and find some time to work on this, but I can't promise anything in the next few days.",
    "created_at": "2016-12-05T14:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251869",
    "user": "https://github.com/tscrim"
}
```

I will try and find some time to work on this, but I can't promise anything in the next few days.



---

archive/issue_comments_251870.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> I will try and find some time to work on this, but I can't promise anything in the next few days.\n\n\nOf course I am not against this, but as said, less important after several other changes.",
    "created_at": "2016-12-05T18:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251870",
    "user": "https://github.com/jm58660"
}
```

Replying to [comment:14 tscrim]:
> I will try and find some time to work on this, but I can't promise anything in the next few days.


Of course I am not against this, but as said, less important after several other changes.



---

archive/issue_events_052529.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-06T15:36:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18539#event-52529"
}
```



---

archive/issue_events_052530.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-06T15:36:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/18539#event-52530"
}
```



---

archive/issue_comments_251871.json:
```json
{
    "body": "At least with how we are currently doing things, there doesn't seem to be a way around this. I'm changing this to a wishlist item.",
    "created_at": "2016-12-06T15:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18539#issuecomment-251871",
    "user": "https://github.com/tscrim"
}
```

At least with how we are currently doing things, there doesn't seem to be a way around this. I'm changing this to a wishlist item.
