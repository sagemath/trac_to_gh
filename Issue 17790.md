# Issue 17790: Move interrupts to Cython

archive/issues_017790.json:
```json
{
    "body": "CC:  jpflori\n\nWork in progress...\n\nIssue created by migration from https://trac.sagemath.org/ticket/18027\n\n",
    "created_at": "2015-03-21T12:21:48Z",
    "labels": [
        "cython",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Move interrupts to Cython",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17790",
    "user": "jdemeyer"
}
```
CC:  jpflori

Work in progress...

Issue created by migration from https://trac.sagemath.org/ticket/18027





---

archive/issue_comments_238367.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-21T14:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238367",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238368.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-21T16:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238368",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238369.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-21T19:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238369",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-21T22:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238370",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238371.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-22T11:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238371",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238372.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-23T12:20:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238372",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238373.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-03-24T07:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238373",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238374.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-24T07:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238374",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_238375.json:
```json
{
    "body": "(NOTE: despite the red link in the Trac interface, the branch merges cleanly)",
    "created_at": "2015-03-27T11:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238375",
    "user": "jdemeyer"
}
```

(NOTE: despite the red link in the Trac interface, the branch merges cleanly)



---

archive/issue_comments_238376.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-15T08:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238376",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238377.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-22T10:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238377",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238378.json:
```json
{
    "body": "Rebased to 6.7.beta2.",
    "created_at": "2015-04-22T10:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238378",
    "user": "jdemeyer"
}
```

Rebased to 6.7.beta2.



---

archive/issue_comments_238379.json:
```json
{
    "body": "I'm simplifying the changes to `src/module_list.py` and `src/setup.py`",
    "created_at": "2015-04-22T10:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238379",
    "user": "jdemeyer"
}
```

I'm simplifying the changes to `src/module_list.py` and `src/setup.py`



---

archive/issue_comments_238380.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-22T10:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238380",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_238381.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-04-22T10:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238381",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_238382.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-22T10:40:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238382",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_238383.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-28T06:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238383",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_238384.json:
```json
{
    "body": "Do you have any other reason to remove x86 CPUs without MMX support execpt that it is very old?\nI guess some other parts of sage might not work on such CPU anyway, do you have any hint?\nI at least remember that our ATLAS base configuration requires an FPU or even MMX.",
    "created_at": "2015-05-18T21:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238384",
    "user": "jpflori"
}
```

Do you have any other reason to remove x86 CPUs without MMX support execpt that it is very old?
I guess some other parts of sage might not work on such CPU anyway, do you have any hint?
I at least remember that our ATLAS base configuration requires an FPU or even MMX.



---

archive/issue_comments_238385.json:
```json
{
    "body": "Replying to [comment:27 jpflori]:\n> Do you have any other reason to remove x86 CPUs without MMX support execpt that it is very old?\nThe reason is to simplify the code.\n\n> I guess some other parts of sage might not work on such CPU anyway, do you have any hint?\nNo idea...",
    "created_at": "2015-05-18T21:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238385",
    "user": "jdemeyer"
}
```

Replying to [comment:27 jpflori]:
> Do you have any other reason to remove x86 CPUs without MMX support execpt that it is very old?
The reason is to simplify the code.

> I guess some other parts of sage might not work on such CPU anyway, do you have any hint?
No idea...



---

archive/issue_comments_238386.json:
```json
{
    "body": "I think it's dangerous to use stuff from the\n\n```\n#include \"build/cythonized/sage/ext/interrupt/interrupt_api.h\"\n```\n\nOn top of that, it occurs in a file meant to be included itsef as soon as one wants to use signal related stuff.",
    "created_at": "2015-05-22T13:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238386",
    "user": "jpflori"
}
```

I think it's dangerous to use stuff from the

```
#include "build/cythonized/sage/ext/interrupt/interrupt_api.h"
```

On top of that, it occurs in a file meant to be included itsef as soon as one wants to use signal related stuff.



---

archive/issue_comments_238387.json:
```json
{
    "body": "Replying to [comment:29 jpflori]:\n> I think it's dangerous to use stuff from the\n> {{{\n> #include \"build/cythonized/sage/ext/interrupt/interrupt_api.h\"\n> }}}\nWhy dangerous? These `_api.h` files are a standard and documented Cython mechanism to use Cython functions from C code: [http://docs.cython.org/src/userguide/external_C_code.html#c-api-declarations](http://docs.cython.org/src/userguide/external_C_code.html#c-api-declarations)",
    "created_at": "2015-05-22T15:04:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238387",
    "user": "jdemeyer"
}
```

Replying to [comment:29 jpflori]:
> I think it's dangerous to use stuff from the
> {{{
> #include "build/cythonized/sage/ext/interrupt/interrupt_api.h"
> }}}
Why dangerous? These `_api.h` files are a standard and documented Cython mechanism to use Cython functions from C code: [http://docs.cython.org/src/userguide/external_C_code.html#c-api-declarations](http://docs.cython.org/src/userguide/external_C_code.html#c-api-declarations)



---

archive/issue_comments_238388.json:
```json
{
    "body": "To explain the usage of `interrupt_api.h` better: the global variable `_signals` (and some functions like `_sig_on_interrupt_received`) which used to be implemented in `c_lib` are now implemented in Cython. For technical reasons, `sig_on()` MUST be a macro and therefore it can only reasonably be implemented in a `.h` file. But `sig_on()` needs access to `_signals`. So we need a mechanism to access the Cython global variable `_signals` in the C header `macros.h`. We use the standard `cdef api` mechanism for this.",
    "created_at": "2015-05-22T15:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238388",
    "user": "jdemeyer"
}
```

To explain the usage of `interrupt_api.h` better: the global variable `_signals` (and some functions like `_sig_on_interrupt_received`) which used to be implemented in `c_lib` are now implemented in Cython. For technical reasons, `sig_on()` MUST be a macro and therefore it can only reasonably be implemented in a `.h` file. But `sig_on()` needs access to `_signals`. So we need a mechanism to access the Cython global variable `_signals` in the C header `macros.h`. We use the standard `cdef api` mechanism for this.



---

archive/issue_comments_238389.json:
```json
{
    "body": "My only issue is the place where this header lives: `build/`.\nWhat if I decide to empty this directory and then recompile a file including `interrupts.pxi`?",
    "created_at": "2015-05-22T15:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238389",
    "user": "jpflori"
}
```

My only issue is the place where this header lives: `build/`.
What if I decide to empty this directory and then recompile a file including `interrupts.pxi`?



---

archive/issue_comments_238390.json:
```json
{
    "body": "Replying to [comment:32 jpflori]:\n> My only issue is the place where this header lives: `build/`.\n> What if I decide to empty this directory and then recompile a file including `interrupts.pxi`?\n\nCython generates the file `interrupt_api.h`. If you empty the `build` directory, the file will be regenerated just like all the other files in the `build` directory.",
    "created_at": "2015-05-22T15:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238390",
    "user": "jdemeyer"
}
```

Replying to [comment:32 jpflori]:
> My only issue is the place where this header lives: `build/`.
> What if I decide to empty this directory and then recompile a file including `interrupts.pxi`?

Cython generates the file `interrupt_api.h`. If you empty the `build` directory, the file will be regenerated just like all the other files in the `build` directory.



---

archive/issue_comments_238391.json:
```json
{
    "body": "Ah, in that case it is fine.\nI for no reason though it was only generated when interrupt.pyx was cythonized.",
    "created_at": "2015-05-22T16:02:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238391",
    "user": "jpflori"
}
```

Ah, in that case it is fine.
I for no reason though it was only generated when interrupt.pyx was cythonized.



---

archive/issue_comments_238392.json:
```json
{
    "body": "Replying to [comment:34 jpflori]:\n> I for no reason though it was only generated when interrupt.pyx was cythonized.\nYou are right, it *is* only generated when `interrupt.pyx` is Cythonized.\n\nThat's not a problem however: if you delete the `build` directory, then `interrupt.pyx` will be Cythonized and the file will be generated.",
    "created_at": "2015-05-22T16:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238392",
    "user": "jdemeyer"
}
```

Replying to [comment:34 jpflori]:
> I for no reason though it was only generated when interrupt.pyx was cythonized.
You are right, it *is* only generated when `interrupt.pyx` is Cythonized.

That's not a problem however: if you delete the `build` directory, then `interrupt.pyx` will be Cythonized and the file will be generated.



---

archive/issue_comments_238393.json:
```json
{
    "body": "Yes indeed, and I don't like this Cython behavior.\nYou have to keep the build directory alive to avoid rebuilding everything.\n\nAnyway, I'll leave with  it for this ticket.",
    "created_at": "2015-05-22T19:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238393",
    "user": "jpflori"
}
```

Yes indeed, and I don't like this Cython behavior.
You have to keep the build directory alive to avoid rebuilding everything.

Anyway, I'll leave with  it for this ticket.



---

archive/issue_comments_238394.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-22T19:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238394",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_238395.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-23T06:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238395",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_238396.json:
```json
{
    "body": "Replying to [comment:36 jpflori]:\n> Yes indeed, and I don't like this Cython behavior.\n> You have to keep the build directory alive to avoid rebuilding everything.\nI really don't understand your problem.\n\nDeleting the `src/build` directory in Sage is the same as `make clean` in a typical software package. And when you do `make clean`, you have to rebuild everything if you do `make` later.\n\nAnd when you *don't* delete the `build` directory, Cython+distutils has proper dependency checking: only needed files are rebuilt.",
    "created_at": "2015-05-23T08:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238396",
    "user": "jdemeyer"
}
```

Replying to [comment:36 jpflori]:
> Yes indeed, and I don't like this Cython behavior.
> You have to keep the build directory alive to avoid rebuilding everything.
I really don't understand your problem.

Deleting the `src/build` directory in Sage is the same as `make clean` in a typical software package. And when you do `make clean`, you have to rebuild everything if you do `make` later.

And when you *don't* delete the `build` directory, Cython+distutils has proper dependency checking: only needed files are rebuilt.



---

archive/issue_comments_238397.json:
```json
{
    "body": "I'll surely open a follow up ticket about that `build` directory question once I have figured out to deal with it. I am not completely sure you have totally broken all \"global\" sage install and whether or not making those install carry at least a fragment of the build folder will fix it properly.\nWho else needs to have their build folder kept?\nIt joins a basket of issues that I have duct-taped in sage-on-gentoo for years to have doctest and spyx files to work properly. If I had spent more time on fixing the installation of sage headers and various auxiliary files rather than the duct tape we wouldn't be there today.\n\nThat's a sample\n\n```\n    1 item had failures:\n       1 of   4 in sage.doctest.tests.sig_on\n        [2 tests, 1 failure, ...]\n    ----------------------------------------------------------------------\n    sage -t --warn-long 0.0 sig_on.rst  # 1 doctest failed\n    ----------------------------------------------------------------------\n    ...\n    1\nGot:\n    Running doctests with ID 2015-05-24-22-01-48-66399ec6.\n    Doctesting 1 file.\n    sage -t --warn-long 0.0 sig_on.rst\n    **********************************************************************\n    File \"sig_on.rst\", line 3, in sage.doctest.tests.sig_on\n    Failed example:\n        cython('sig_on()')\n    Exception raised:\n        Traceback (most recent call last):\n          File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n            self.compile_and_execute(example, compiler, test.globs)\n          File \"/usr/lib64/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n            exec(compiled, globs)\n          File \"<doctest sage.doctest.tests.sig_on[0]>\", line 1, in <module>\n            cython('sig_on()')\n          File \"sage/misc/cython_c.pyx\", line 63, in sage.misc.cython_c.cython (build/cythonized/sage/misc/cython_c.c:949)\n            sage.server.support.cython_import_all(tmpfile, globals(),\n          File \"/usr/lib64/python2.7/site-packages/sage/server/support.py\", line 85, in cython_import_all\n            create_local_c_file=create_local_c_file)\n          File \"/usr/lib64/python2.7/site-packages/sage/server/support.py\", line 62, in cython_import\n            **kwds)\n          File \"/usr/lib64/python2.7/site-packages/sage/misc/cython.py\", line 519, in cython\n            raise RuntimeError(\"Error compiling {}:\\n{}\\n{}\".format(filename, log, err))\n        RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/10231/tmp_FdPxlK.spyx:\n        running build\n        running build_ext\n        building '_home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0' extension\n        creating build\n        creating build/temp.linux-x86_64-2.7\n        x86_64-pc-linux-gnu-gcc -pthread -fPIC -I/usr/include/csage -I/usr/include -I/usr/include/python2.7 -I/usr/lib/python/site-packages/numpy/core/include -I/usr/share/sage/src/sage/ext -I/usr/share/sage/src -I/usr/share/sage/src/sage/gsl -I/home/fbissey/.sage/temp/QCD-nzi3/10231 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.c -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.o -w -O2\n    <BLANKLINE>\n        In file included from _home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.c:248:0:\n        /usr/share/sage/src/sage/ext/interrupt/pxi.h:7:63: fatal error: build/cythonized/sage/ext/interrupt/interrupt_api.h: No such file or directory\n         #include \"build/cythonized/sage/ext/interrupt/interrupt_api.h\"\n                                                                       ^\n        compilation terminated.\n        error: command 'x86_64-pc-linux-gnu-gcc' failed with exit status 1\n    <BLANKLINE>\n    **********************************************************************\n    1 item had failures:\n       1 of   4 in sage.doctest.tests.sig_on\n        [2 tests, 1 failure, 0.86 s]\n    ----------------------------------------------------------------------\n    sage -t --warn-long 0.0 sig_on.rst  # 1 doctest failed\n    ----------------------------------------------------------------------\n    Total time for all tests: 0.9 seconds\n        cpu time: 0.0 seconds\n        cumulative wall time: 0.9 seconds\n    1\n**********************************************************************\n1 item had failures:\n   1 of  45 in sage.doctest.test\n    [44 tests, 1 failure, 98.40 s]\n----------------------------------------------------------------------\nsage -t --long /usr/share/sage/src/sage/doctest/test.py  # 1 doctest failed\n```\n",
    "created_at": "2015-05-24T11:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238397",
    "user": "fbissey"
}
```

I'll surely open a follow up ticket about that `build` directory question once I have figured out to deal with it. I am not completely sure you have totally broken all "global" sage install and whether or not making those install carry at least a fragment of the build folder will fix it properly.
Who else needs to have their build folder kept?
It joins a basket of issues that I have duct-taped in sage-on-gentoo for years to have doctest and spyx files to work properly. If I had spent more time on fixing the installation of sage headers and various auxiliary files rather than the duct tape we wouldn't be there today.

That's a sample

```
    1 item had failures:
       1 of   4 in sage.doctest.tests.sig_on
        [2 tests, 1 failure, ...]
    ----------------------------------------------------------------------
    sage -t --warn-long 0.0 sig_on.rst  # 1 doctest failed
    ----------------------------------------------------------------------
    ...
    1
Got:
    Running doctests with ID 2015-05-24-22-01-48-66399ec6.
    Doctesting 1 file.
    sage -t --warn-long 0.0 sig_on.rst
    **********************************************************************
    File "sig_on.rst", line 3, in sage.doctest.tests.sig_on
    Failed example:
        cython('sig_on()')
    Exception raised:
        Traceback (most recent call last):
          File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
            self.compile_and_execute(example, compiler, test.globs)
          File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
            exec(compiled, globs)
          File "<doctest sage.doctest.tests.sig_on[0]>", line 1, in <module>
            cython('sig_on()')
          File "sage/misc/cython_c.pyx", line 63, in sage.misc.cython_c.cython (build/cythonized/sage/misc/cython_c.c:949)
            sage.server.support.cython_import_all(tmpfile, globals(),
          File "/usr/lib64/python2.7/site-packages/sage/server/support.py", line 85, in cython_import_all
            create_local_c_file=create_local_c_file)
          File "/usr/lib64/python2.7/site-packages/sage/server/support.py", line 62, in cython_import
            **kwds)
          File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 519, in cython
            raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
        RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/10231/tmp_FdPxlK.spyx:
        running build
        running build_ext
        building '_home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0' extension
        creating build
        creating build/temp.linux-x86_64-2.7
        x86_64-pc-linux-gnu-gcc -pthread -fPIC -I/usr/include/csage -I/usr/include -I/usr/include/python2.7 -I/usr/lib/python/site-packages/numpy/core/include -I/usr/share/sage/src/sage/ext -I/usr/share/sage/src -I/usr/share/sage/src/sage/gsl -I/home/fbissey/.sage/temp/QCD-nzi3/10231 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.c -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.o -w -O2
    <BLANKLINE>
        In file included from _home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.c:248:0:
        /usr/share/sage/src/sage/ext/interrupt/pxi.h:7:63: fatal error: build/cythonized/sage/ext/interrupt/interrupt_api.h: No such file or directory
         #include "build/cythonized/sage/ext/interrupt/interrupt_api.h"
                                                                       ^
        compilation terminated.
        error: command 'x86_64-pc-linux-gnu-gcc' failed with exit status 1
    <BLANKLINE>
    **********************************************************************
    1 item had failures:
       1 of   4 in sage.doctest.tests.sig_on
        [2 tests, 1 failure, 0.86 s]
    ----------------------------------------------------------------------
    sage -t --warn-long 0.0 sig_on.rst  # 1 doctest failed
    ----------------------------------------------------------------------
    Total time for all tests: 0.9 seconds
        cpu time: 0.0 seconds
        cumulative wall time: 0.9 seconds
    1
**********************************************************************
1 item had failures:
   1 of  45 in sage.doctest.test
    [44 tests, 1 failure, 98.40 s]
----------------------------------------------------------------------
sage -t --long /usr/share/sage/src/sage/doctest/test.py  # 1 doctest failed
```




---

archive/issue_comments_238398.json:
```json
{
    "body": "I understand your problem now: you need the `build` folder for `cython()` to work properly (why didn't you just tell me this?)",
    "created_at": "2015-05-24T13:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238398",
    "user": "jdemeyer"
}
```

I understand your problem now: you need the `build` folder for `cython()` to work properly (why didn't you just tell me this?)



---

archive/issue_comments_238399.json:
```json
{
    "body": "To be honest, while I saw the ticket yesterday and suspected problems, I only found the extent a few hours ago. I cooled off a little bit before commenting, possibly not enough.",
    "created_at": "2015-05-24T13:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238399",
    "user": "fbissey"
}
```

To be honest, while I saw the ticket yesterday and suspected problems, I only found the extent a few hours ago. I cooled off a little bit before commenting, possibly not enough.



---

archive/issue_comments_238400.json:
```json
{
    "body": "But it is a symptom for a larger problem sage keep a lot of stuff in the sources that should really be installed. Headers and a few c/cpp files here and there. I had that conversation with Burcin a long time ago. I have been going on with shipping a copy of the sources in sage-on-gentoo and I probably could try to ship that single file but it should be just a stop gap to better solution.",
    "created_at": "2015-05-24T21:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238400",
    "user": "fbissey"
}
```

But it is a symptom for a larger problem sage keep a lot of stuff in the sources that should really be installed. Headers and a few c/cpp files here and there. I had that conversation with Burcin a long time ago. I have been going on with shipping a copy of the sources in sage-on-gentoo and I probably could try to ship that single file but it should be just a stop gap to better solution.



---

archive/issue_comments_238401.json:
```json
{
    "body": "Replying to [comment:43 fbissey]:\n> But it is a symptom for a larger problem sage keep a lot of stuff in the sources that should really be installed. Headers and a few c/cpp files here and there.\n\nAnd `.pxd`/`.pxi` files also I guess...\n\nIt wouldn't be too hard to install all needed files, it's just that somebody has to do it.",
    "created_at": "2015-05-24T21:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17790",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17790#issuecomment-238401",
    "user": "jdemeyer"
}
```

Replying to [comment:43 fbissey]:
> But it is a symptom for a larger problem sage keep a lot of stuff in the sources that should really be installed. Headers and a few c/cpp files here and there.

And `.pxd`/`.pxi` files also I guess...

It wouldn't be too hard to install all needed files, it's just that somebody has to do it.
