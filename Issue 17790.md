# Issue 17790: Move interrupts to Cython

Issue created by migration from https://trac.sagemath.org/ticket/18027

Original creator: jdemeyer

Original creation time: 2015-03-21 12:21:48

CC:  jpflori

Work in progress...


---

Comment by git created at 2015-03-21 14:13:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-21 16:50:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-21 19:56:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-21 22:58:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-22 11:08:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-23 12:20:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-03-24 07:22:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-03-24 07:27:02

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-03-27 11:25:48

(NOTE: despite the red link in the Trac interface, the branch merges cleanly)


---

Comment by git created at 2015-04-15 08:33:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-04-22 10:13:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-22 10:17:48

Rebased to 6.7.beta2.


---

Comment by jdemeyer created at 2015-04-22 10:22:45

I'm simplifying the changes to `src/module_list.py` and `src/setup.py`


---

Comment by jdemeyer created at 2015-04-22 10:22:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-22 10:39:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-22 10:40:15

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-04-28 06:04:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-05-18 21:01:52

Do you have any other reason to remove x86 CPUs without MMX support execpt that it is very old?
I guess some other parts of sage might not work on such CPU anyway, do you have any hint?
I at least remember that our ATLAS base configuration requires an FPU or even MMX.


---

Comment by jdemeyer created at 2015-05-18 21:27:58

Replying to [comment:27 jpflori]:
> Do you have any other reason to remove x86 CPUs without MMX support execpt that it is very old?
The reason is to simplify the code.

> I guess some other parts of sage might not work on such CPU anyway, do you have any hint?
No idea...


---

Comment by jpflori created at 2015-05-22 13:01:01

I think it's dangerous to use stuff from the

```
#include "build/cythonized/sage/ext/interrupt/interrupt_api.h"
```

On top of that, it occurs in a file meant to be included itsef as soon as one wants to use signal related stuff.


---

Comment by jdemeyer created at 2015-05-22 15:04:26

Replying to [comment:29 jpflori]:
> I think it's dangerous to use stuff from the
> {{{
> #include "build/cythonized/sage/ext/interrupt/interrupt_api.h"
> }}}
Why dangerous? These `_api.h` files are a standard and documented Cython mechanism to use Cython functions from C code: [http://docs.cython.org/src/userguide/external_C_code.html#c-api-declarations](http://docs.cython.org/src/userguide/external_C_code.html#c-api-declarations)


---

Comment by jdemeyer created at 2015-05-22 15:22:16

To explain the usage of `interrupt_api.h` better: the global variable `_signals` (and some functions like `_sig_on_interrupt_received`) which used to be implemented in `c_lib` are now implemented in Cython. For technical reasons, `sig_on()` MUST be a macro and therefore it can only reasonably be implemented in a `.h` file. But `sig_on()` needs access to `_signals`. So we need a mechanism to access the Cython global variable `_signals` in the C header `macros.h`. We use the standard `cdef api` mechanism for this.


---

Comment by jpflori created at 2015-05-22 15:24:05

My only issue is the place where this header lives: `build/`.
What if I decide to empty this directory and then recompile a file including `interrupts.pxi`?


---

Comment by jdemeyer created at 2015-05-22 15:59:35

Replying to [comment:32 jpflori]:
> My only issue is the place where this header lives: `build/`.
> What if I decide to empty this directory and then recompile a file including `interrupts.pxi`?

Cython generates the file `interrupt_api.h`. If you empty the `build` directory, the file will be regenerated just like all the other files in the `build` directory.


---

Comment by jpflori created at 2015-05-22 16:02:53

Ah, in that case it is fine.
I for no reason though it was only generated when interrupt.pyx was cythonized.


---

Comment by jdemeyer created at 2015-05-22 16:49:58

Replying to [comment:34 jpflori]:
> I for no reason though it was only generated when interrupt.pyx was cythonized.
You are right, it _is_ only generated when `interrupt.pyx` is Cythonized.

That's not a problem however: if you delete the `build` directory, then `interrupt.pyx` will be Cythonized and the file will be generated.


---

Comment by jpflori created at 2015-05-22 19:16:43

Yes indeed, and I don't like this Cython behavior.
You have to keep the build directory alive to avoid rebuilding everything.

Anyway, I'll leave with  it for this ticket.


---

Comment by jpflori created at 2015-05-22 19:17:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-23 06:10:24

Resolution: fixed


---

Comment by jdemeyer created at 2015-05-23 08:52:11

Replying to [comment:36 jpflori]:
> Yes indeed, and I don't like this Cython behavior.
> You have to keep the build directory alive to avoid rebuilding everything.
I really don't understand your problem.

Deleting the `src/build` directory in Sage is the same as `make clean` in a typical software package. And when you do `make clean`, you have to rebuild everything if you do `make` later.

And when you _don't_ delete the `build` directory, Cython+distutils has proper dependency checking: only needed files are rebuilt.


---

Comment by fbissey created at 2015-05-24 11:07:53

I'll surely open a follow up ticket about that `build` directory question once I have figured out to deal with it. I am not completely sure you have totally broken all "global" sage install and whether or not making those install carry at least a fragment of the build folder will fix it properly.
Who else needs to have their build folder kept?
It joins a basket of issues that I have duct-taped in sage-on-gentoo for years to have doctest and spyx files to work properly. If I had spent more time on fixing the installation of sage headers and various auxiliary files rather than the duct tape we wouldn't be there today.

That's a sample

```
    1 item had failures:
       1 of   4 in sage.doctest.tests.sig_on
        [2 tests, 1 failure, ...]
    ----------------------------------------------------------------------
    sage -t --warn-long 0.0 sig_on.rst  # 1 doctest failed
    ----------------------------------------------------------------------
    ...
    1
Got:
    Running doctests with ID 2015-05-24-22-01-48-66399ec6.
    Doctesting 1 file.
    sage -t --warn-long 0.0 sig_on.rst
    **********************************************************************
    File "sig_on.rst", line 3, in sage.doctest.tests.sig_on
    Failed example:
        cython('sig_on()')
    Exception raised:
        Traceback (most recent call last):
          File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
            self.compile_and_execute(example, compiler, test.globs)
          File "/usr/lib64/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
            exec(compiled, globs)
          File "<doctest sage.doctest.tests.sig_on[0]>", line 1, in <module>
            cython('sig_on()')
          File "sage/misc/cython_c.pyx", line 63, in sage.misc.cython_c.cython (build/cythonized/sage/misc/cython_c.c:949)
            sage.server.support.cython_import_all(tmpfile, globals(),
          File "/usr/lib64/python2.7/site-packages/sage/server/support.py", line 85, in cython_import_all
            create_local_c_file=create_local_c_file)
          File "/usr/lib64/python2.7/site-packages/sage/server/support.py", line 62, in cython_import
            **kwds)
          File "/usr/lib64/python2.7/site-packages/sage/misc/cython.py", line 519, in cython
            raise RuntimeError("Error compiling {}:\n{}\n{}".format(filename, log, err))
        RuntimeError: Error compiling /home/fbissey/.sage/temp/QCD-nzi3/10231/tmp_FdPxlK.spyx:
        running build
        running build_ext
        building '_home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0' extension
        creating build
        creating build/temp.linux-x86_64-2.7
        x86_64-pc-linux-gnu-gcc -pthread -fPIC -I/usr/include/csage -I/usr/include -I/usr/include/python2.7 -I/usr/lib/python/site-packages/numpy/core/include -I/usr/share/sage/src/sage/ext -I/usr/share/sage/src -I/usr/share/sage/src/sage/gsl -I/home/fbissey/.sage/temp/QCD-nzi3/10231 -I/usr/include/python2.7 -c _home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.c -o build/temp.linux-x86_64-2.7/_home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.o -w -O2
    <BLANKLINE>
        In file included from _home_fbissey__sage_temp_QCD_nzi3_10231_tmp_FdPxlK_spyx_0.c:248:0:
        /usr/share/sage/src/sage/ext/interrupt/pxi.h:7:63: fatal error: build/cythonized/sage/ext/interrupt/interrupt_api.h: No such file or directory
         #include "build/cythonized/sage/ext/interrupt/interrupt_api.h"
                                                                       ^
        compilation terminated.
        error: command 'x86_64-pc-linux-gnu-gcc' failed with exit status 1
    <BLANKLINE>
    **********************************************************************
    1 item had failures:
       1 of   4 in sage.doctest.tests.sig_on
        [2 tests, 1 failure, 0.86 s]
    ----------------------------------------------------------------------
    sage -t --warn-long 0.0 sig_on.rst  # 1 doctest failed
    ----------------------------------------------------------------------
    Total time for all tests: 0.9 seconds
        cpu time: 0.0 seconds
        cumulative wall time: 0.9 seconds
    1
**********************************************************************
1 item had failures:
   1 of  45 in sage.doctest.test
    [44 tests, 1 failure, 98.40 s]
----------------------------------------------------------------------
sage -t --long /usr/share/sage/src/sage/doctest/test.py  # 1 doctest failed
```



---

Comment by jdemeyer created at 2015-05-24 13:10:06

I understand your problem now: you need the `build` folder for `cython()` to work properly (why didn't you just tell me this?)


---

Comment by fbissey created at 2015-05-24 13:45:28

To be honest, while I saw the ticket yesterday and suspected problems, I only found the extent a few hours ago. I cooled off a little bit before commenting, possibly not enough.


---

Comment by fbissey created at 2015-05-24 21:09:18

But it is a symptom for a larger problem sage keep a lot of stuff in the sources that should really be installed. Headers and a few c/cpp files here and there. I had that conversation with Burcin a long time ago. I have been going on with shipping a copy of the sources in sage-on-gentoo and I probably could try to ship that single file but it should be just a stop gap to better solution.


---

Comment by jdemeyer created at 2015-05-24 21:37:47

Replying to [comment:43 fbissey]:
> But it is a symptom for a larger problem sage keep a lot of stuff in the sources that should really be installed. Headers and a few c/cpp files here and there.

And `.pxd`/`.pxi` files also I guess...

It wouldn't be too hard to install all needed files, it's just that somebody has to do it.
