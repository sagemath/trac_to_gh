# Issue 24802: Add sdh_install helper function to sage-dist-helpers

Issue created by migration from https://trac.sagemath.org/ticket/25039

Original creator: embray

Original creation time: 2018-03-27 12:03:25

Keywords: destdir mathjax thebe

*Adds a new `sdh_install` helper function:

    This is like a very simplified version of the `install` program, and is
    intended for use by packages whose spkg-install just copies some files (or
    more complex packages that copy some files as one of its steps).  The
    majority of its functionality is just in ensuring that the full destination
    path exists, and to provide some error checking.  This replaces some
    patterns that occur frequently in some spkg-installs.

    Also updates the mathjax and thebe packages as two examples of its usage (this implements #24024 for those packages).


---

Comment by embray created at 2018-03-27 12:10:20

Changing status from new to needs_review.


---

Comment by git created at 2018-03-27 14:36:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-03-27 14:48:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-27 19:10:58

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-27 19:10:58

1. I don't really understand the point of

```
    if [ $# -eq 0 ]; then
        sdh_die "At least a source and destination file are required"
    fi
```

since it would fail anyway later and no error message would be given for `sdh_install -T`.

2. It looks strange to put this in an `else` block, it's just part of the normal flow of execution:

```
    else
        dest="${SAGE_DESTDIR}$dest"
    fi
```


3. I seem to recall that `cp -R` is more portable than `cp -r`. So unless you have a good reason for using `cp -r`, I recommend `cp -R`.

4. For consistency, I would start all `sdh_die` messages with `Error:`

5. `echo "Installing files for ${PKG_NAME}:"` looks like unneeded verbosity. I would drop that.

6. If `mkdir` or `cp` fails, it already prints an error message, so I don't need that we need `sdh_die` for that. I would just write `cp ... || exit $?`.


---

Comment by embray created at 2018-03-28 09:20:44

Replying to [comment:4 jdemeyer]:
> 1. I don't really understand the point of
> {{{
>     if [ $# -eq 0 ]; then
>         sdh_die "At least a source and destination file are required"
>     fi
> }}}
> since it would fail anyway later and no error message would be given for `sdh_install -T`.

I mean, it will still fail for `sdh_install -T` because the `$src` variable will be empty. I thought an explicit check of "there are arguments" would enhance clarity but in retrospect I agree it's superfluous.

> 
> 2. It looks strange to put this in an `else` block, it's just part of the normal flow of execution:
> {{{
>     else
>         dest="${SAGE_DESTDIR}$dest"
>     fi
> }}}

Yep. I think that was just the result of remolding of slightly different logic.

> 3. I seem to recall that `cp -R` is more portable than `cp -r`. So unless you have a good reason for using `cp -r`, I recommend `cp -R`.

I suspect it's not really a problem for us since I've already seen `cp -r` in some of the `spkg-install`s I've used this in--including standard packages.  If that were a problem for a platform we care about it would have come up by now.  However, I seem to recall the same now that you mention it, so I could change it.

> 4. For consistency, I would start all `sdh_die` messages with `Error:`

+1 

> 5. `echo "Installing files for ${PKG_NAME}:"` looks like unneeded verbosity. I would drop that.

+1 Some of the other `sdh_` commands had some kind of message like this so I put it in for consistency.  But after trying this on a few packages it hasn't been too helpful (especially in cases where there are multiple `sdh_install` calls in the package).
 
> 6. If `mkdir` or `cp` fails, it already prints an error message, so I don't need that we need `sdh_die` for that. I would just write `cp ... || exit $?`.

A lot of the code this function is replacing was also adding its own error messages on top of `mkdir` and/or `cp`, so this was just carried over from that.  In most cases those programs' error messages should be sufficient though.


---

Comment by git created at 2018-03-28 09:26:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-28 09:27:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-29 09:28:29

Wait... did you actually agree with all my comments? :-)


---

Comment by jdemeyer created at 2018-03-29 09:28:29

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-03-29 09:35:56

Replying to [comment:8 jdemeyer]:
> Wait... did you actually agree with all my comments? :-)

Fair enough--but it's not like I set out to disagree with you.  I thought they were all reasonable enough :)


---

Comment by jdemeyer created at 2018-04-11 08:04:48

New commits:


---

Comment by embray created at 2018-04-11 13:11:14

Thanks for catching that.  It was originally called `sdh_install_files` but I decided to shorten it later.


---

Comment by embray created at 2018-04-18 09:07:54

Just rebased on current develop.
----
New commits:


---

Comment by vbraun created at 2018-05-09 18:44:43

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-05-09 18:44:43

Merge conflict


---

Comment by git created at 2018-05-17 16:17:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-17 16:18:12

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-05-18 17:49:56

Resolution: fixed
