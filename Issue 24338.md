# Issue 24338: conflicts with gc

archive/issues_024338.json:
```json
{
    "body": "CC:  embray vbraun charpent defeo jpflori\n\nSage has a standard package `gc` which is also available for most operating system. The library creates conflicts with programs that are prerequisite to build Sage such as make.\n\nFor example, building Sage 8.2.beta3 on archlinux one gets\n\n```\nmake: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: \nGC_move_disappearing_link\n```\n\n\nSee also [this report on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/5LqXytiF2nQ).\n\nIssue created by migration from https://trac.sagemath.org/ticket/24575\n\n",
    "created_at": "2018-01-20T11:40:44Z",
    "labels": [
        "packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "conflicts with gc",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24338",
    "user": "vdelecroix"
}
```
CC:  embray vbraun charpent defeo jpflori

Sage has a standard package `gc` which is also available for most operating system. The library creates conflicts with programs that are prerequisite to build Sage such as make.

For example, building Sage 8.2.beta3 on archlinux one gets

```
make: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: 
GC_move_disappearing_link
```


See also [this report on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/5LqXytiF2nQ).

Issue created by migration from https://trac.sagemath.org/ticket/24575





---

archive/issue_comments_340803.json:
```json
{
    "body": "A (possibly naive) suggestion is to do (almost) what we already do for gcc and related, but simpler :\n* Depend on gc\n* Test for it (and its version) in the main configure file\n    - If found (and sufficient) : use that (possibly symlinking the relevant header/library files)\n    - Else : install \"our\" version.\n\nDrawback : a newer version might break compatibility. A code review of its use is necessary.\n\nBTW : can one use `pkg-config` in the main configure file ? I think not (alas...).",
    "created_at": "2018-01-20T13:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340803",
    "user": "charpent"
}
```

A (possibly naive) suggestion is to do (almost) what we already do for gcc and related, but simpler :
* Depend on gc
* Test for it (and its version) in the main configure file
    - If found (and sufficient) : use that (possibly symlinking the relevant header/library files)
    - Else : install "our" version.

Drawback : a newer version might break compatibility. A code review of its use is necessary.

BTW : can one use `pkg-config` in the main configure file ? I think not (alas...).



---

archive/issue_comments_340804.json:
```json
{
    "body": "At what point do you get this error? While building R? (guessing the latter from the subject of sage-devel post)",
    "created_at": "2018-01-20T15:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340804",
    "user": "dimpase"
}
```

At what point do you get this error? While building R? (guessing the latter from the subject of sage-devel post)



---

archive/issue_comments_340805.json:
```json
{
    "body": "how come make depends on guile for you? I don't see it.\n\n```\n$ ldd `which gmake`\n\tlinux-vdso.so.1 (0x00007ffe861ce000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f0e5b6d3000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f0e5b30f000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f0e5b8d7000)\n```\n\n\nI've just installed gc-7.6.2 systemwide, and things work for me with Sage, so far.",
    "created_at": "2018-01-20T15:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340805",
    "user": "dimpase"
}
```

how come make depends on guile for you? I don't see it.

```
$ ldd `which gmake`
	linux-vdso.so.1 (0x00007ffe861ce000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f0e5b6d3000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f0e5b30f000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f0e5b8d7000)
```


I've just installed gc-7.6.2 systemwide, and things work for me with Sage, so far.



---

archive/issue_comments_340806.json:
```json
{
    "body": "By the way, there is #23700, which would give you the same major gc version as you apparently need (although I fail to see why).",
    "created_at": "2018-01-20T16:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340806",
    "user": "dimpase"
}
```

By the way, there is #23700, which would give you the same major gc version as you apparently need (although I fail to see why).



---

archive/issue_comments_340807.json:
```json
{
    "body": "IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage.",
    "created_at": "2018-01-20T16:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340807",
    "user": "dimpase"
}
```

IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage.



---

archive/issue_comments_340808.json:
```json
{
    "body": "I think the \"symbol lookup error\" is just being echoed by make, its not from make not finding a symbol; This happens while R is compiling the MASS package and output is clearly being filtered.\n\nApparently R sets LD_LIBRARY_PATH while compiling packages so Sage's libraries take precedence over system ones. Which inevitably leads to problems, which is why we removed that from the Sage build system a while ago.",
    "created_at": "2018-01-20T17:21:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340808",
    "user": "vbraun"
}
```

I think the "symbol lookup error" is just being echoed by make, its not from make not finding a symbol; This happens while R is compiling the MASS package and output is clearly being filtered.

Apparently R sets LD_LIBRARY_PATH while compiling packages so Sage's libraries take precedence over system ones. Which inevitably leads to problems, which is why we removed that from the Sage build system a while ago.



---

archive/issue_comments_340809.json:
```json
{
    "body": "No, R is not setting `LD_LIBRARY_PATH`, it is merely respecting it. I think we have a case of Sage being built with LD_LIBRARY_PATH set to something, and also `guile` (indeed, it has nothing to do with Sage AFAIK) involved in the environment somehow; and `guile` (perhaps invoked from `.bashrc`?) made to use wrong `gc` version from Sage.    \n\nTo reproduce this one needs to have libgc.so.X have the same X in $SAGE_LOCAL/lib and in /usr/lib. On my system X=1 in the former and X=2 in the latter, \nand libguile is linked to libgc.so.2. So I went and made \n\n```\n$ ln -sf libgc.so.1 libgc.so.2\n```\n\nin $SAGE_LOCAL/lib. After this I duly get\n\n```\n$ LD_LIBRARY_PATH=./local/lib guile\nguile: symbol lookup error: /usr/lib64/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link\n```\n\n\nNeedless to say, R still builds just fine for me after this hack.",
    "created_at": "2018-01-20T23:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340809",
    "user": "dimpase"
}
```

No, R is not setting `LD_LIBRARY_PATH`, it is merely respecting it. I think we have a case of Sage being built with LD_LIBRARY_PATH set to something, and also `guile` (indeed, it has nothing to do with Sage AFAIK) involved in the environment somehow; and `guile` (perhaps invoked from `.bashrc`?) made to use wrong `gc` version from Sage.    

To reproduce this one needs to have libgc.so.X have the same X in $SAGE_LOCAL/lib and in /usr/lib. On my system X=1 in the former and X=2 in the latter, 
and libguile is linked to libgc.so.2. So I went and made 

```
$ ln -sf libgc.so.1 libgc.so.2
```

in $SAGE_LOCAL/lib. After this I duly get

```
$ LD_LIBRARY_PATH=./local/lib guile
guile: symbol lookup error: /usr/lib64/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link
```


Needless to say, R still builds just fine for me after this hack.



---

archive/issue_comments_340810.json:
```json
{
    "body": "For precision, my `$LD_LIBRARY_PATH` is empty. It should not have anything to do with it. What about the proposition of [charpent comment:3](https://trac.sagemath.org/ticket/24575#comment:3)?",
    "created_at": "2018-01-22T07:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340810",
    "user": "vdelecroix"
}
```

For precision, my `$LD_LIBRARY_PATH` is empty. It should not have anything to do with it. What about the proposition of [charpent comment:3](https://trac.sagemath.org/ticket/24575#comment:3)?



---

archive/issue_comments_340811.json:
```json
{
    "body": "You have a strange setup on your system, which involves guile into building Sage. Perhaps something in shell configurations, I do not know. Or something wrong with your linker settings or its cache. Guile is a system library which you can only make to fail this way by setting LD_LIBRARY_PATH. But Sage does not do it, something else does.",
    "created_at": "2018-01-22T08:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340811",
    "user": "dimpase"
}
```

You have a strange setup on your system, which involves guile into building Sage. Perhaps something in shell configurations, I do not know. Or something wrong with your linker settings or its cache. Guile is a system library which you can only make to fail this way by setting LD_LIBRARY_PATH. But Sage does not do it, something else does.



---

archive/issue_comments_340812.json:
```json
{
    "body": "Replying to [comment:7 dimpase]:\n> IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. \n\nThat's not what's going on here so please don't mischaracterize it as a \"huge security hole\".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of \"DLL hell\" (albeit less severe).",
    "created_at": "2018-01-22T13:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340812",
    "user": "embray"
}
```

Replying to [comment:7 dimpase]:
> IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. 

That's not what's going on here so please don't mischaracterize it as a "huge security hole".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of "DLL hell" (albeit less severe).



---

archive/issue_comments_340813.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> Replying to [comment:7 dimpase]:\n> > IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. \n> \n> That's not what's going on here so please don't mischaracterize it as a \"huge security hole\".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of \"DLL hell\" (albeit less severe).\n\nOne needs to set LD_LIBRARY_PATH for this to happen. If on the other hand you succeed in replacing the system library with one at your account *for all the users*, regardless of the environment, then yes, you have hacked the system via a security hole.\n\nAnyhow, there is no Sage bug to fix here, that's what I am trying to say all along.\nUnless I see an meaningful explanation how libguile is relevant to building Sage, I'd tend to set this to `wontfix`.",
    "created_at": "2018-01-22T14:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340813",
    "user": "dimpase"
}
```

Replying to [comment:12 embray]:
> Replying to [comment:7 dimpase]:
> > IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. 
> 
> That's not what's going on here so please don't mischaracterize it as a "huge security hole".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of "DLL hell" (albeit less severe).

One needs to set LD_LIBRARY_PATH for this to happen. If on the other hand you succeed in replacing the system library with one at your account *for all the users*, regardless of the environment, then yes, you have hacked the system via a security hole.

Anyhow, there is no Sage bug to fix here, that's what I am trying to say all along.
Unless I see an meaningful explanation how libguile is relevant to building Sage, I'd tend to set this to `wontfix`.



---

archive/issue_comments_340814.json:
```json
{
    "body": "Replying to [comment:13 dimpase]:\n> Replying to [comment:12 embray]:\n> > Replying to [comment:7 dimpase]:\n> > > IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. \n> > \n> > That's not what's going on here so please don't mischaracterize it as a \"huge security hole\".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of \"DLL hell\" (albeit less severe).\n> \n> One needs to set LD_LIBRARY_PATH for this to happen. If on the other hand you succeed in replacing the system library with one at your account *for all the users*, regardless of the environment, then yes, you have hacked the system via a security hole.\n\nI...don't see any evidence that that's happening here.",
    "created_at": "2018-01-22T14:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340814",
    "user": "embray"
}
```

Replying to [comment:13 dimpase]:
> Replying to [comment:12 embray]:
> > Replying to [comment:7 dimpase]:
> > > IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. 
> > 
> > That's not what's going on here so please don't mischaracterize it as a "huge security hole".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of "DLL hell" (albeit less severe).
> 
> One needs to set LD_LIBRARY_PATH for this to happen. If on the other hand you succeed in replacing the system library with one at your account *for all the users*, regardless of the environment, then yes, you have hacked the system via a security hole.

I...don't see any evidence that that's happening here.



---

archive/issue_comments_340815.json:
```json
{
    "body": "Replying to [comment:14 embray]:\n> Replying to [comment:13 dimpase]:\n> > Replying to [comment:12 embray]:\n> > > Replying to [comment:7 dimpase]:\n> > > > IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. \n> > > \n> > > That's not what's going on here so please don't mischaracterize it as a \"huge security hole\".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of \"DLL hell\" (albeit less severe).\n> > \n> > One needs to set LD_LIBRARY_PATH for this to happen. If on the other hand you succeed in replacing the system library with one at your account *for all the users*, regardless of the environment, then yes, you have hacked the system via a security hole.\n> \n> I...don't see any evidence that that's happening here.\n\nI have not said I see this, either. What I see is an unexplained attempt to invoke (lib)guile during the Sage build.",
    "created_at": "2018-01-22T14:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340815",
    "user": "dimpase"
}
```

Replying to [comment:14 embray]:
> Replying to [comment:13 dimpase]:
> > Replying to [comment:12 embray]:
> > > Replying to [comment:7 dimpase]:
> > > > IMHO, if you can nuke a system utility by installing a library with normal user privileges, then you have a huge security hole. Thus I don't think it's something to fix in Sage. 
> > > 
> > > That's not what's going on here so please don't mischaracterize it as a "huge security hole".  It's quite normal to have a broken setup where one executable is linking at runtime with the wrong version of some shared library.  This is the Linux version of "DLL hell" (albeit less severe).
> > 
> > One needs to set LD_LIBRARY_PATH for this to happen. If on the other hand you succeed in replacing the system library with one at your account *for all the users*, regardless of the environment, then yes, you have hacked the system via a security hole.
> 
> I...don't see any evidence that that's happening here.

I have not said I see this, either. What I see is an unexplained attempt to invoke (lib)guile during the Sage build.



---

archive/issue_comments_340816.json:
```json
{
    "body": "Somebody who can reproduce the original problem should make the R build more verbose and try again...",
    "created_at": "2018-01-22T15:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340816",
    "user": "vbraun"
}
```

Somebody who can reproduce the original problem should make the R build more verbose and try again...



---

archive/issue_comments_340817.json:
```json
{
    "body": "according to [Vincent](https://groups.google.com/d/msg/sage-devel/5LqXytiF2nQ/rWw82_qOAAAJ) this can happen on his system while building Flint:\n\n```\nI restart a build from scratch and I don't believe that R is responsible \nin any way. This new build stopped on flint pointing at the same library \nissue \n\nmake: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: \nGC_move_disappearing_link \n```\n",
    "created_at": "2018-01-22T15:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340817",
    "user": "dimpase"
}
```

according to [Vincent](https://groups.google.com/d/msg/sage-devel/5LqXytiF2nQ/rWw82_qOAAAJ) this can happen on his system while building Flint:

```
I restart a build from scratch and I don't believe that R is responsible 
in any way. This new build stopped on flint pointing at the same library 
issue 

make: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: 
GC_move_disappearing_link 
```




---

archive/issue_comments_340818.json:
```json
{
    "body": "Replying to [comment:16 vbraun]:\n> Somebody who can reproduce the original problem should make the R build more verbose and try again...\n\non it",
    "created_at": "2018-01-22T17:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340818",
    "user": "vdelecroix"
}
```

Replying to [comment:16 vbraun]:
> Somebody who can reproduce the original problem should make the R build more verbose and try again...

on it



---

archive/issue_comments_340819.json:
```json
{
    "body": "Failed on flint. But debug mode not very helpful (made in flint source dir)\n\n```\n(sage-sh)$ make --debug\nGNU Make 4.2.1\nBuilt for x86_64-unknown-linux-gnu\nCopyright (C) 1988-2016 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\nReading makefiles...\nUpdating makefiles....\nUpdating goal targets....\n File 'all' does not exist.\n   File 'library' does not exist.\n  Must remake target 'library'.\nmake: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link\nmake: *** [Makefile:173: library] Error 127\n```\n",
    "created_at": "2018-01-22T17:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340819",
    "user": "vdelecroix"
}
```

Failed on flint. But debug mode not very helpful (made in flint source dir)

```
(sage-sh)$ make --debug
GNU Make 4.2.1
Built for x86_64-unknown-linux-gnu
Copyright (C) 1988-2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Reading makefiles...
Updating makefiles....
Updating goal targets....
 File 'all' does not exist.
   File 'library' does not exist.
  Must remake target 'library'.
make: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link
make: *** [Makefile:173: library] Error 127
```




---

archive/issue_comments_340820.json:
```json
{
    "body": "Can you try starting guile at `(sage-sh)$` prompt?",
    "created_at": "2018-01-22T17:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340820",
    "user": "dimpase"
}
```

Can you try starting guile at `(sage-sh)$` prompt?



---

archive/issue_comments_340821.json:
```json
{
    "body": "Replying to [comment:20 dimpase]:\n> Can you try starting guile at `(sage-sh)$` prompt?\n\nIt works fine\n\n```\n(sage-sh) $ guile\nGNU Guile 2.2.3\nCopyright (C) 1995-2017 Free Software Foundation, Inc.\n\nGuile comes with ABSOLUTELY NO WARRANTY; for details type `,show w'.\nThis program is free software, and you are welcome to redistribute it\nunder certain conditions; type `,show c' for details.\n\nEnter `,help' for help.\nscheme@(guile-user)> quit()\n$1 = #<procedure quit args>\nWhile compiling expression:\nSyntax error:\nunknown location: unexpected syntax in form ()\nscheme@(guile-user)> ()\n```\n",
    "created_at": "2018-01-22T18:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340821",
    "user": "vdelecroix"
}
```

Replying to [comment:20 dimpase]:
> Can you try starting guile at `(sage-sh)$` prompt?

It works fine

```
(sage-sh) $ guile
GNU Guile 2.2.3
Copyright (C) 1995-2017 Free Software Foundation, Inc.

Guile comes with ABSOLUTELY NO WARRANTY; for details type `,show w'.
This program is free software, and you are welcome to redistribute it
under certain conditions; type `,show c' for details.

Enter `,help' for help.
scheme@(guile-user)> quit()
$1 = #<procedure quit args>
While compiling expression:
Syntax error:
unknown location: unexpected syntax in form ()
scheme@(guile-user)> ()
```




---

archive/issue_comments_340822.json:
```json
{
    "body": "Still with flint: without any option to `./configure` it succeeds\n\n```\n(sage-sh)$ ./configure --disable-static --prefix=\"$SAGE_LOCAL\"\nConfiguring...x86_64-Linux\nTesting __builtin_popcountl...yes\nTesting native popcount...yes\nTesting __thread...yes\nTesting fenv...yes\nFLINT was successfully configured.\n(sage-sh) $ make\nmkdir -p build\nmake[1]: Entering directory '/opt/sage-bis/local/var/tmp/sage/build/flint-2.5.2.p1/src'\n    CC   build/printf.lo\n    CC   build/fprintf.lo\n    CC   build/sprintf.lo\n    CC   build/scanf.lo\n    CC   build/fscanf.lo\n    CC   build/sscanf.lo\n    CC   build/clz_tab.lo\n    CC   build/memory_manager.lo\n    CC   build/version.lo\n    CC   build/profiler.lo\n    CC   build/thread_support.lo\n...\n```\n\nBut setting `--with-gmp` it fails\n\n```\n(sage-sh) $ ./configure --disable-static --prefix=\"$SAGE_LOCAL\" --with-gmp=\"$SAGE_LOCAL\"\nConfiguring...x86_64-Linux\nTesting __builtin_popcountl...yes\nTesting native popcount...yes\nTesting __thread...yes\nTesting fenv...yes\nFLINT was successfully configured.\n(sage-sh) $ make\nmake: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link\nmake: *** [Makefile:173: library] Error 127\n```\n",
    "created_at": "2018-01-22T18:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340822",
    "user": "vdelecroix"
}
```

Still with flint: without any option to `./configure` it succeeds

```
(sage-sh)$ ./configure --disable-static --prefix="$SAGE_LOCAL"
Configuring...x86_64-Linux
Testing __builtin_popcountl...yes
Testing native popcount...yes
Testing __thread...yes
Testing fenv...yes
FLINT was successfully configured.
(sage-sh) $ make
mkdir -p build
make[1]: Entering directory '/opt/sage-bis/local/var/tmp/sage/build/flint-2.5.2.p1/src'
    CC   build/printf.lo
    CC   build/fprintf.lo
    CC   build/sprintf.lo
    CC   build/scanf.lo
    CC   build/fscanf.lo
    CC   build/sscanf.lo
    CC   build/clz_tab.lo
    CC   build/memory_manager.lo
    CC   build/version.lo
    CC   build/profiler.lo
    CC   build/thread_support.lo
...
```

But setting `--with-gmp` it fails

```
(sage-sh) $ ./configure --disable-static --prefix="$SAGE_LOCAL" --with-gmp="$SAGE_LOCAL"
Configuring...x86_64-Linux
Testing __builtin_popcountl...yes
Testing native popcount...yes
Testing __thread...yes
Testing fenv...yes
FLINT was successfully configured.
(sage-sh) $ make
make: symbol lookup error: /usr/lib/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link
make: *** [Makefile:173: library] Error 127
```




---

archive/issue_comments_340823.json:
```json
{
    "body": "Replying to [comment:5 dimpase]:\n> how come make depends on guile for you? I don't see it.\n> {{{\n> $ ldd `which gmake`\n> \tlinux-vdso.so.1 (0x00007ffe861ce000)\n> \tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f0e5b6d3000)\n> \tlibc.so.6 => /lib64/libc.so.6 (0x00007f0e5b30f000)\n> \t/lib64/ld-linux-x86-64.so.2 (0x00007f0e5b8d7000)\n> }}}\n> \n> I've just installed gc-7.6.2 systemwide, and things work for me with Sage, so far.\n\nWhat is `gmake`? I got\n\n```\n(sage-sh) $ ldd `which make`\n        linux-vdso.so.1 (0x00007fff3ccf6000)\n        libguile-2.2.so.1 => /usr/lib/libguile-2.2.so.1 (0x00007f88df74d000)\n        libdl.so.2 => /usr/lib/libdl.so.2 (0x00007f88df549000)\n        libpthread.so.0 => /usr/lib/libpthread.so.0 (0x00007f88df32b000)\n        libc.so.6 => /usr/lib/libc.so.6 (0x00007f88def74000)\n        libgc.so.1 => /usr/lib/libgc.so.1 (0x00007f88ded0a000)\n        libffi.so.6 => /usr/lib/libffi.so.6 (0x00007f88deb01000)\n        libunistring.so.2 => /usr/lib/libunistring.so.2 (0x00007f88de77f000)\n        libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007f88de4ec000)\n        libltdl.so.7 => /usr/lib/libltdl.so.7 (0x00007f88de2e2000)\n        libcrypt.so.1 => /usr/lib/libcrypt.so.1 (0x00007f88de0aa000)\n        libm.so.6 => /usr/lib/libm.so.6 (0x00007f88ddd5e000)\n        /lib64/ld-linux-x86-64.so.2 => /usr/lib64/ld-linux-x86-64.so.2 (0x00007f88dfa7a000)\n        libatomic_ops.so.1 => /usr/lib/libatomic_ops.so.1 (0x00007f88ddb5c000)\n```\n",
    "created_at": "2018-01-22T18:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340823",
    "user": "vdelecroix"
}
```

Replying to [comment:5 dimpase]:
> how come make depends on guile for you? I don't see it.
> {{{
> $ ldd `which gmake`
> 	linux-vdso.so.1 (0x00007ffe861ce000)
> 	libdl.so.2 => /lib64/libdl.so.2 (0x00007f0e5b6d3000)
> 	libc.so.6 => /lib64/libc.so.6 (0x00007f0e5b30f000)
> 	/lib64/ld-linux-x86-64.so.2 (0x00007f0e5b8d7000)
> }}}
> 
> I've just installed gc-7.6.2 systemwide, and things work for me with Sage, so far.

What is `gmake`? I got

```
(sage-sh) $ ldd `which make`
        linux-vdso.so.1 (0x00007fff3ccf6000)
        libguile-2.2.so.1 => /usr/lib/libguile-2.2.so.1 (0x00007f88df74d000)
        libdl.so.2 => /usr/lib/libdl.so.2 (0x00007f88df549000)
        libpthread.so.0 => /usr/lib/libpthread.so.0 (0x00007f88df32b000)
        libc.so.6 => /usr/lib/libc.so.6 (0x00007f88def74000)
        libgc.so.1 => /usr/lib/libgc.so.1 (0x00007f88ded0a000)
        libffi.so.6 => /usr/lib/libffi.so.6 (0x00007f88deb01000)
        libunistring.so.2 => /usr/lib/libunistring.so.2 (0x00007f88de77f000)
        libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007f88de4ec000)
        libltdl.so.7 => /usr/lib/libltdl.so.7 (0x00007f88de2e2000)
        libcrypt.so.1 => /usr/lib/libcrypt.so.1 (0x00007f88de0aa000)
        libm.so.6 => /usr/lib/libm.so.6 (0x00007f88ddd5e000)
        /lib64/ld-linux-x86-64.so.2 => /usr/lib64/ld-linux-x86-64.so.2 (0x00007f88dfa7a000)
        libatomic_ops.so.1 => /usr/lib/libatomic_ops.so.1 (0x00007f88ddb5c000)
```




---

archive/issue_comments_340824.json:
```json
{
    "body": "Replying to [comment:23 vdelecroix]:\n> Replying to [comment:5 dimpase]:\n> > how come make depends on guile for you? I don't see it.\n> > {{{\n> > $ ldd `which gmake`\n> > \tlinux-vdso.so.1 (0x00007ffe861ce000)\n> > \tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f0e5b6d3000)\n> > \tlibc.so.6 => /lib64/libc.so.6 (0x00007f0e5b30f000)\n> > \t/lib64/ld-linux-x86-64.so.2 (0x00007f0e5b8d7000)\n> > }}}\n> > \n> > I've just installed gc-7.6.2 systemwide, and things work for me with Sage, so far.\n> \n> What is `gmake`? \n\nfor me `make` is a link to `gmake`, but it's not important.\nWhat's important is that your `make` is linked with `libguile` (and a slew of its dependencies, including `libgc`), and this is not usual (I never heard of it---\nalthough it is not crazy, see https://www.gnu.org/software/make/manual/html_node/Guile-Integration.html)\n\n> I got\n> {{{\n> (sage-sh) $ ldd `which make`\n>         linux-vdso.so.1 (0x00007fff3ccf6000)\n>         libguile-2.2.so.1 => /usr/lib/libguile-2.2.so.1 (0x00007f88df74d000)\n>         libdl.so.2 => /usr/lib/libdl.so.2 (0x00007f88df549000)\n>         libpthread.so.0 => /usr/lib/libpthread.so.0 (0x00007f88df32b000)\n>         libc.so.6 => /usr/lib/libc.so.6 (0x00007f88def74000)\n>         libgc.so.1 => /usr/lib/libgc.so.1 (0x00007f88ded0a000)\n>         libffi.so.6 => /usr/lib/libffi.so.6 (0x00007f88deb01000)\n>         libunistring.so.2 => /usr/lib/libunistring.so.2 (0x00007f88de77f000)\n>         libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007f88de4ec000)\n>         libltdl.so.7 => /usr/lib/libltdl.so.7 (0x00007f88de2e2000)\n>         libcrypt.so.1 => /usr/lib/libcrypt.so.1 (0x00007f88de0aa000)\n>         libm.so.6 => /usr/lib/libm.so.6 (0x00007f88ddd5e000)\n>         /lib64/ld-linux-x86-64.so.2 => /usr/lib64/ld-linux-x86-64.so.2 (0x00007f88dfa7a000)\n>         libatomic_ops.so.1 => /usr/lib/libatomic_ops.so.1 (0x00007f88ddb5c000)\n> }}}\n\nSo we see that at this point `make` appears to be correctly linked.\n\nWhat do you see if in that directory (at sage-sh prompt) you run `make -v` rather than `make`? (More precisely, I'd like to understand whether it's the generated Flint's Makefile that breaks it, or it's just `make` itself)\n\nAnd what does `ldd /usr/lib/libguile-2.2.so.1` show?",
    "created_at": "2018-01-22T19:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340824",
    "user": "dimpase"
}
```

Replying to [comment:23 vdelecroix]:
> Replying to [comment:5 dimpase]:
> > how come make depends on guile for you? I don't see it.
> > {{{
> > $ ldd `which gmake`
> > 	linux-vdso.so.1 (0x00007ffe861ce000)
> > 	libdl.so.2 => /lib64/libdl.so.2 (0x00007f0e5b6d3000)
> > 	libc.so.6 => /lib64/libc.so.6 (0x00007f0e5b30f000)
> > 	/lib64/ld-linux-x86-64.so.2 (0x00007f0e5b8d7000)
> > }}}
> > 
> > I've just installed gc-7.6.2 systemwide, and things work for me with Sage, so far.
> 
> What is `gmake`? 

for me `make` is a link to `gmake`, but it's not important.
What's important is that your `make` is linked with `libguile` (and a slew of its dependencies, including `libgc`), and this is not usual (I never heard of it---
although it is not crazy, see https://www.gnu.org/software/make/manual/html_node/Guile-Integration.html)

> I got
> {{{
> (sage-sh) $ ldd `which make`
>         linux-vdso.so.1 (0x00007fff3ccf6000)
>         libguile-2.2.so.1 => /usr/lib/libguile-2.2.so.1 (0x00007f88df74d000)
>         libdl.so.2 => /usr/lib/libdl.so.2 (0x00007f88df549000)
>         libpthread.so.0 => /usr/lib/libpthread.so.0 (0x00007f88df32b000)
>         libc.so.6 => /usr/lib/libc.so.6 (0x00007f88def74000)
>         libgc.so.1 => /usr/lib/libgc.so.1 (0x00007f88ded0a000)
>         libffi.so.6 => /usr/lib/libffi.so.6 (0x00007f88deb01000)
>         libunistring.so.2 => /usr/lib/libunistring.so.2 (0x00007f88de77f000)
>         libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007f88de4ec000)
>         libltdl.so.7 => /usr/lib/libltdl.so.7 (0x00007f88de2e2000)
>         libcrypt.so.1 => /usr/lib/libcrypt.so.1 (0x00007f88de0aa000)
>         libm.so.6 => /usr/lib/libm.so.6 (0x00007f88ddd5e000)
>         /lib64/ld-linux-x86-64.so.2 => /usr/lib64/ld-linux-x86-64.so.2 (0x00007f88dfa7a000)
>         libatomic_ops.so.1 => /usr/lib/libatomic_ops.so.1 (0x00007f88ddb5c000)
> }}}

So we see that at this point `make` appears to be correctly linked.

What do you see if in that directory (at sage-sh prompt) you run `make -v` rather than `make`? (More precisely, I'd like to understand whether it's the generated Flint's Makefile that breaks it, or it's just `make` itself)

And what does `ldd /usr/lib/libguile-2.2.so.1` show?



---

archive/issue_comments_340825.json:
```json
{
    "body": "Replying to [comment:24 dimpase]:\n> Replying to [comment:23 vdelecroix]:\n> > Replying to [comment:5 dimpase]:\n>\n> What do you see if in that directory (at sage-sh prompt) you run `make -v` rather than `make`? (More precisely, I'd like to understand whether it's the generated Flint's Makefile that breaks it, or it's just `make` itself)\n\n\n```\n(sage-sh) $ make -v\nGNU Make 4.2.1\nConstruit pour x86_64-unknown-linux-gnu\nCopyright (C) 1988-2016 Free Software Foundation, Inc.\nLicence GPLv3+\u00a0: GNU GPL version 3 ou ult\u00e9rieure <http://gnu.org/licenses/gpl.html>\nCeci est un logiciel libre\u00a0: vous \u00eates autoris\u00e9 \u00e0 le modifier et \u00e0 la redistribuer.\nIl ne comporte AUCUNE GARANTIE, dans la mesure de ce que permet la loi.\n```\n\n\nPlease read also [comment:22 comment:22]: make does not look broken when I do not configure `gmp`.\n\n> And what does `ldd /usr/lib/libguile-2.2.so.1` show?\n\n\n```\n(sage-sh) $ ldd /usr/lib/libguile-2.2.so.1\n        linux-vdso.so.1 (0x00007fff17387000)\n        libgc.so.1 => /usr/lib/libgc.so.1 (0x00007fed43ae3000)\n        libffi.so.6 => /usr/lib/libffi.so.6 (0x00007fed438da000)\n        libunistring.so.2 => /usr/lib/libunistring.so.2 (0x00007fed43558000)\n        libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007fed432c5000)\n        libltdl.so.7 => /usr/lib/libltdl.so.7 (0x00007fed430bb000)\n        libcrypt.so.1 => /usr/lib/libcrypt.so.1 (0x00007fed42e83000)\n        libm.so.6 => /usr/lib/libm.so.6 (0x00007fed42b37000)\n        libpthread.so.0 => /usr/lib/libpthread.so.0 (0x00007fed42919000)\n        libc.so.6 => /usr/lib/libc.so.6 (0x00007fed42562000)\n        /usr/lib64/ld-linux-x86-64.so.2 (0x00007fed4407a000)\n        libdl.so.2 => /usr/lib/libdl.so.2 (0x00007fed4235e000)\n        libatomic_ops.so.1 => /usr/lib/libatomic_ops.so.1 (0x00007fed4215c000)\n```\n",
    "created_at": "2018-01-22T20:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340825",
    "user": "vdelecroix"
}
```

Replying to [comment:24 dimpase]:
> Replying to [comment:23 vdelecroix]:
> > Replying to [comment:5 dimpase]:
>
> What do you see if in that directory (at sage-sh prompt) you run `make -v` rather than `make`? (More precisely, I'd like to understand whether it's the generated Flint's Makefile that breaks it, or it's just `make` itself)


```
(sage-sh) $ make -v
GNU Make 4.2.1
Construit pour x86_64-unknown-linux-gnu
Copyright (C) 1988-2016 Free Software Foundation, Inc.
Licence GPLv3+ : GNU GPL version 3 ou ultérieure <http://gnu.org/licenses/gpl.html>
Ceci est un logiciel libre : vous êtes autorisé à le modifier et à la redistribuer.
Il ne comporte AUCUNE GARANTIE, dans la mesure de ce que permet la loi.
```


Please read also [comment:22 comment:22]: make does not look broken when I do not configure `gmp`.

> And what does `ldd /usr/lib/libguile-2.2.so.1` show?


```
(sage-sh) $ ldd /usr/lib/libguile-2.2.so.1
        linux-vdso.so.1 (0x00007fff17387000)
        libgc.so.1 => /usr/lib/libgc.so.1 (0x00007fed43ae3000)
        libffi.so.6 => /usr/lib/libffi.so.6 (0x00007fed438da000)
        libunistring.so.2 => /usr/lib/libunistring.so.2 (0x00007fed43558000)
        libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007fed432c5000)
        libltdl.so.7 => /usr/lib/libltdl.so.7 (0x00007fed430bb000)
        libcrypt.so.1 => /usr/lib/libcrypt.so.1 (0x00007fed42e83000)
        libm.so.6 => /usr/lib/libm.so.6 (0x00007fed42b37000)
        libpthread.so.0 => /usr/lib/libpthread.so.0 (0x00007fed42919000)
        libc.so.6 => /usr/lib/libc.so.6 (0x00007fed42562000)
        /usr/lib64/ld-linux-x86-64.so.2 (0x00007fed4407a000)
        libdl.so.2 => /usr/lib/libdl.so.2 (0x00007fed4235e000)
        libatomic_ops.so.1 => /usr/lib/libatomic_ops.so.1 (0x00007fed4215c000)
```




---

archive/issue_comments_340826.json:
```json
{
    "body": "Replying to [comment:24 dimpase]:\n> for me `make` is a link to `gmake`, but it's not important.\n> What's important is that your `make` is linked with `libguile` (and a slew of its dependencies, including `libgc`), and this is not usual (I never heard of it---\n\nSince GNU make version 4 you can extend `make` with guile bindings. Building make with such extension is a configuration option. Building those or not is a choice usually made by distro. Usually binary distro include all possible options unless they have \"reservations\". On Gentoo it is an option that is off by default.",
    "created_at": "2018-01-22T21:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340826",
    "user": "fbissey"
}
```

Replying to [comment:24 dimpase]:
> for me `make` is a link to `gmake`, but it's not important.
> What's important is that your `make` is linked with `libguile` (and a slew of its dependencies, including `libgc`), and this is not usual (I never heard of it---

Since GNU make version 4 you can extend `make` with guile bindings. Building make with such extension is a configuration option. Building those or not is a choice usually made by distro. Usually binary distro include all possible options unless they have "reservations". On Gentoo it is an option that is off by default.



---

archive/issue_comments_340827.json:
```json
{
    "body": "I've built make from source with `--with-guile`, guile version 2.2.\n(which required changing one character in line 171 configure.ac, \n\n```\n[ PKG_CHECK_MODULES([GUILE], [guile-2.2], [have_guile=yes],\n```\n\n(`2.2` instead of `2.0` - this probably explains why I was unable to build it the gentoo way?), getting\n\n```\n$ ldd `which make`\n\tlinux-vdso.so.1 (0x00007ffc6d3c3000)\n\tlibguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007f932105f000)\n\tlibgc.so.2 => /usr/lib64/libgc.so.2 (0x00007f9320de6000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f9320be2000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007f93209c2000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f93205fe000)\n\tlibffi.so.6 => /usr/lib64/libffi.so.6 (0x00007f93203f5000)\n\tlibunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007f932007c000)\n\tlibgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f931fdf3000)\n\tlibltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007f931fbe9000)\n\tlibcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007f931f9b1000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f931f66f000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f93213b0000)\n```\n\nbut I cannot reproduce this.\nIt might be the version difference, but the produced `make` happily builds Flint\neven if I do `$export LD_LIBRARY_PATH=$SAGE_LOCAL/lib; make`.\n\nNeedless to say, this export breaks guile:\n\n```\n$ guile\nguile: symbol lookup error: /usr/lib64/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link\n```\n\nOr it might be that the generated by Flint Makefile does not trigger guile extension in my case, and does trigger it in Vincent's case?",
    "created_at": "2018-01-22T22:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340827",
    "user": "dimpase"
}
```

I've built make from source with `--with-guile`, guile version 2.2.
(which required changing one character in line 171 configure.ac, 

```
[ PKG_CHECK_MODULES([GUILE], [guile-2.2], [have_guile=yes],
```

(`2.2` instead of `2.0` - this probably explains why I was unable to build it the gentoo way?), getting

```
$ ldd `which make`
	linux-vdso.so.1 (0x00007ffc6d3c3000)
	libguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007f932105f000)
	libgc.so.2 => /usr/lib64/libgc.so.2 (0x00007f9320de6000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f9320be2000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f93209c2000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f93205fe000)
	libffi.so.6 => /usr/lib64/libffi.so.6 (0x00007f93203f5000)
	libunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007f932007c000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f931fdf3000)
	libltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007f931fbe9000)
	libcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007f931f9b1000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f931f66f000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f93213b0000)
```

but I cannot reproduce this.
It might be the version difference, but the produced `make` happily builds Flint
even if I do `$export LD_LIBRARY_PATH=$SAGE_LOCAL/lib; make`.

Needless to say, this export breaks guile:

```
$ guile
guile: symbol lookup error: /usr/lib64/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link
```

Or it might be that the generated by Flint Makefile does not trigger guile extension in my case, and does trigger it in Vincent's case?



---

archive/issue_comments_340828.json:
```json
{
    "body": "The trigger is just execution. If the symbol is not resolved you get this. There are a couple of things to remember:\n* for the problem to happen the soname of the libgc in sage and on the system need to be the same\n* while the soname are the same libgc in sage doesn't have the same symbols than on the system\n\nSo either libgc shouldn't have the same soname (upstream not bumping the number properly) or libgc is not configured with the same features in sage and on the system.",
    "created_at": "2018-01-22T22:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340828",
    "user": "fbissey"
}
```

The trigger is just execution. If the symbol is not resolved you get this. There are a couple of things to remember:
* for the problem to happen the soname of the libgc in sage and on the system need to be the same
* while the soname are the same libgc in sage doesn't have the same symbols than on the system

So either libgc shouldn't have the same soname (upstream not bumping the number properly) or libgc is not configured with the same features in sage and on the system.



---

archive/issue_comments_340829.json:
```json
{
    "body": "Replying to [comment:28 fbissey]:\n> The trigger is just execution. If the symbol is not resolved you get this. There are a couple of things to remember:\n> * for the problem to happen the soname of the libgc in sage and on the system need to be the same\n> * while the soname are the same libgc in sage doesn't have the same symbols than on the system\n> \n> So either libgc shouldn't have the same soname (upstream not bumping the number properly) or libgc is not configured with the same features in sage and on the system.\n\nThis does crash guile:\n\n```\n$ ldd `which guile`\n\tlinux-vdso.so.1 (0x00007ffd5e36a000)\n\tlibguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007f4c66c70000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007f4c66a50000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f4c6668c000)\n\tlibgc.so.2 => /usr/lib64/libgc.so.2 (0x00007f4c66413000)\n\tlibffi.so.6 => /usr/lib64/libffi.so.6 (0x00007f4c6620a000)\n\tlibunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007f4c65e91000)\n\tlibgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f4c65c08000)\n\tlibltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007f4c659fe000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007f4c657fa000)\n\tlibcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007f4c655c2000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f4c65280000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f4c66fc1000)\n(sage-sh) dima@hilbert:sage-dev$ LD_LIBRARY_PATH=$SAGE_LOCAL/lib guile\nguile: symbol lookup error: /usr/lib64/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link\n```\n\nas I created a link to the wrong libgc (see comment 9):\n\n```\n$ ls -l $SAGE_LOCAL/lib/libgc*\n-rw-r--r-- 1 dima dima 946784 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.a\nlrwxrwxrwx 1 dima dima     14 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.so -> libgc.so.1.0.3\nlrwxrwxrwx 1 dima dima     14 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.so.1 -> libgc.so.1.0.3\n-rwxr-xr-x 1 dima dima 702568 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.so.1.0.3\nlrwxrwxrwx 1 dima dima     10 Jan 20 22:54 /home/dima/Sage/sage-dev/local/lib/libgc.so.2 -> libgc.so.1\n```\n\n(libgc.so.1 is wrong (Sage's gc 7.2)) But make with guile works just fine:\n\n```\n$ LD_LIBRARY_PATH=$SAGE_LOCAL/lib /home/dima/bin/make -v\nGNU Make 4.2.1\nBuilt for x86_64-pc-linux-gnu\nCopyright (C) 1988-2016 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\n```\n\neven though it is linked to the same libguile:\n\n```\n$ ldd /home/dima/bin/make \n\tlinux-vdso.so.1 (0x00007ffd2959e000)\n\tlibguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007fb4e1418000)\n\tlibgc.so.2 => /usr/lib64/libgc.so.2 (0x00007fb4e119f000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007fb4e0f9b000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007fb4e0d7b000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fb4e09b7000)\n\tlibffi.so.6 => /usr/lib64/libffi.so.6 (0x00007fb4e07ae000)\n\tlibunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007fb4e0435000)\n\tlibgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fb4e01ac000)\n\tlibltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007fb4dffa2000)\n\tlibcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007fb4dfd6a000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fb4dfa28000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fb4e1769000)\n```\n\njust as a sanity check:\n\n```\n$ LD_LIBRARY_PATH=$SAGE_LOCAL/lib ldd /home/dima/bin/make \n\tlinux-vdso.so.1 (0x00007ffccbbfe000)\n\tlibguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007ff033858000)\n\tlibgc.so.2 => /home/dima/Sage/sage-dev/local/lib/libgc.so.2 (0x00007ff0334f9000)\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007ff0332f5000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007ff0330d5000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007ff032d11000)\n\tlibffi.so.6 => /usr/lib64/libffi.so.6 (0x00007ff032b08000)\n\tlibunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007ff03278f000)\n\tlibgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007ff032506000)\n\tlibltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007ff0322fc000)\n\tlibcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007ff0320c4000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007ff031d82000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007ff033ba9000)\n```\n\nSo even though the link ought to be resolved by the linker, it is not done (I can also run actual building, not just `-v` with this setup).",
    "created_at": "2018-01-22T23:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340829",
    "user": "dimpase"
}
```

Replying to [comment:28 fbissey]:
> The trigger is just execution. If the symbol is not resolved you get this. There are a couple of things to remember:
> * for the problem to happen the soname of the libgc in sage and on the system need to be the same
> * while the soname are the same libgc in sage doesn't have the same symbols than on the system
> 
> So either libgc shouldn't have the same soname (upstream not bumping the number properly) or libgc is not configured with the same features in sage and on the system.

This does crash guile:

```
$ ldd `which guile`
	linux-vdso.so.1 (0x00007ffd5e36a000)
	libguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007f4c66c70000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f4c66a50000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f4c6668c000)
	libgc.so.2 => /usr/lib64/libgc.so.2 (0x00007f4c66413000)
	libffi.so.6 => /usr/lib64/libffi.so.6 (0x00007f4c6620a000)
	libunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007f4c65e91000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f4c65c08000)
	libltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007f4c659fe000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f4c657fa000)
	libcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007f4c655c2000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f4c65280000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f4c66fc1000)
(sage-sh) dima@hilbert:sage-dev$ LD_LIBRARY_PATH=$SAGE_LOCAL/lib guile
guile: symbol lookup error: /usr/lib64/libguile-2.2.so.1: undefined symbol: GC_move_disappearing_link
```

as I created a link to the wrong libgc (see comment 9):

```
$ ls -l $SAGE_LOCAL/lib/libgc*
-rw-r--r-- 1 dima dima 946784 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.a
lrwxrwxrwx 1 dima dima     14 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.so -> libgc.so.1.0.3
lrwxrwxrwx 1 dima dima     14 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.so.1 -> libgc.so.1.0.3
-rwxr-xr-x 1 dima dima 702568 Dec 30 09:59 /home/dima/Sage/sage-dev/local/lib/libgc.so.1.0.3
lrwxrwxrwx 1 dima dima     10 Jan 20 22:54 /home/dima/Sage/sage-dev/local/lib/libgc.so.2 -> libgc.so.1
```

(libgc.so.1 is wrong (Sage's gc 7.2)) But make with guile works just fine:

```
$ LD_LIBRARY_PATH=$SAGE_LOCAL/lib /home/dima/bin/make -v
GNU Make 4.2.1
Built for x86_64-pc-linux-gnu
Copyright (C) 1988-2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
```

even though it is linked to the same libguile:

```
$ ldd /home/dima/bin/make 
	linux-vdso.so.1 (0x00007ffd2959e000)
	libguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007fb4e1418000)
	libgc.so.2 => /usr/lib64/libgc.so.2 (0x00007fb4e119f000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007fb4e0f9b000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fb4e0d7b000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fb4e09b7000)
	libffi.so.6 => /usr/lib64/libffi.so.6 (0x00007fb4e07ae000)
	libunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007fb4e0435000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fb4e01ac000)
	libltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007fb4dffa2000)
	libcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007fb4dfd6a000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fb4dfa28000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fb4e1769000)
```

just as a sanity check:

```
$ LD_LIBRARY_PATH=$SAGE_LOCAL/lib ldd /home/dima/bin/make 
	linux-vdso.so.1 (0x00007ffccbbfe000)
	libguile-2.2.so.1 => /usr/lib64/libguile-2.2.so.1 (0x00007ff033858000)
	libgc.so.2 => /home/dima/Sage/sage-dev/local/lib/libgc.so.2 (0x00007ff0334f9000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007ff0332f5000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007ff0330d5000)
	libc.so.6 => /lib64/libc.so.6 (0x00007ff032d11000)
	libffi.so.6 => /usr/lib64/libffi.so.6 (0x00007ff032b08000)
	libunistring.so.2 => /usr/lib64/libunistring.so.2 (0x00007ff03278f000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007ff032506000)
	libltdl.so.7 => /usr/lib64/libltdl.so.7 (0x00007ff0322fc000)
	libcrypt.so.1 => /lib64/libcrypt.so.1 (0x00007ff0320c4000)
	libm.so.6 => /lib64/libm.so.6 (0x00007ff031d82000)
	/lib64/ld-linux-x86-64.so.2 (0x00007ff033ba9000)
```

So even though the link ought to be resolved by the linker, it is not done (I can also run actual building, not just `-v` with this setup).



---

archive/issue_comments_340830.json:
```json
{
    "body": "Just wanted to confirm I'm experiencing the same problem on Arch. I have no more insights than you guys.\n\nHas Antonio Rojas popped up in the discussion yet? He might have already seen this error while packaging for Arch.",
    "created_at": "2018-02-20T14:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340830",
    "user": "defeo"
}
```

Just wanted to confirm I'm experiencing the same problem on Arch. I have no more insights than you guys.

Has Antonio Rojas popped up in the discussion yet? He might have already seen this error while packaging for Arch.



---

archive/issue_comments_340831.json:
```json
{
    "body": "One trivial way out is to upgrade our gc, see #23700",
    "created_at": "2018-02-20T15:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340831",
    "user": "dimpase"
}
```

One trivial way out is to upgrade our gc, see #23700



---

archive/issue_comments_340832.json:
```json
{
    "body": "Replying to [comment:30 defeo]:\n> Just wanted to confirm I'm experiencing the same problem on Arch. I have no more insights than you guys.\n> \n> Has Antonio Rojas popped up in the discussion yet? He might have already seen this error while packaging for Arch.\n\nI think that Arch guys forgot to bump up the version of libgc, for it is still\nlibgc.so.1 (while on gentoo the same libgc is named libgc.so.2)\ncf comments 25 and 27 above.\n\nNote that Arch most probably uses system libgc in its build of Sage, as it's\nnot listed here https://www.archlinux.org/packages/community/x86_64/sagemath/",
    "created_at": "2018-02-20T16:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340832",
    "user": "dimpase"
}
```

Replying to [comment:30 defeo]:
> Just wanted to confirm I'm experiencing the same problem on Arch. I have no more insights than you guys.
> 
> Has Antonio Rojas popped up in the discussion yet? He might have already seen this error while packaging for Arch.

I think that Arch guys forgot to bump up the version of libgc, for it is still
libgc.so.1 (while on gentoo the same libgc is named libgc.so.2)
cf comments 25 and 27 above.

Note that Arch most probably uses system libgc in its build of Sage, as it's
not listed here https://www.archlinux.org/packages/community/x86_64/sagemath/



---

archive/issue_comments_340833.json:
```json
{
    "body": "Could anyone who can reproduce this check whether #23000 fixes the problem?",
    "created_at": "2018-02-21T10:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340833",
    "user": "dimpase"
}
```

Could anyone who can reproduce this check whether #23000 fixes the problem?



---

archive/issue_comments_340834.json:
```json
{
    "body": "oops, typo, it should be\n\"Could anyone who can reproduce this check whether #23700 fixes the problem?\"",
    "created_at": "2018-02-21T10:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340834",
    "user": "dimpase"
}
```

oops, typo, it should be
"Could anyone who can reproduce this check whether #23700 fixes the problem?"



---

archive/issue_comments_340835.json:
```json
{
    "body": "I've [asked](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00013.html) on `bug-make`@`gnu.org` whether is this a GNU make bug.",
    "created_at": "2018-02-22T10:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340835",
    "user": "dimpase"
}
```

I've [asked](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00013.html) on `bug-make`@`gnu.org` whether is this a GNU make bug.



---

archive/issue_comments_340836.json:
```json
{
    "body": "Well, I am not convinced, and am still waiting for an answer to [this](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00015.html).",
    "created_at": "2018-02-22T16:43:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340836",
    "user": "dimpase"
}
```

Well, I am not convinced, and am still waiting for an answer to [this](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00015.html).



---

archive/issue_comments_340837.json:
```json
{
    "body": "Replying to [comment:36 dimpase]:\n> Well, I am not convinced, and am still waiting for an answer to [this](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00015.html).\n\nYour comment about maybe statically linking libguile makes some sense, but then you'd have to also statically link any of its dependencies as well, including libgc or else it wouldn't solve the problem.",
    "created_at": "2018-02-23T16:16:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340837",
    "user": "embray"
}
```

Replying to [comment:36 dimpase]:
> Well, I am not convinced, and am still waiting for an answer to [this](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00015.html).

Your comment about maybe statically linking libguile makes some sense, but then you'd have to also statically link any of its dependencies as well, including libgc or else it wouldn't solve the problem.



---

archive/issue_comments_340838.json:
```json
{
    "body": "Replying to [comment:37 embray]:\n> Replying to [comment:36 dimpase]:\n> > Well, I am not convinced, and am still waiting for an answer to [this](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00015.html).\n> \n> Your comment about maybe statically linking libguile makes some sense, but then you'd have to also statically link any of its dependencies as well, including libgc or else it wouldn't solve the problem.\n\nThey could also load the Guile extension only if they need it.\n(And/or have a configuration option of turning it off).",
    "created_at": "2018-02-23T16:29:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340838",
    "user": "dimpase"
}
```

Replying to [comment:37 embray]:
> Replying to [comment:36 dimpase]:
> > Well, I am not convinced, and am still waiting for an answer to [this](http://lists.gnu.org/archive/html/bug-make/2018-02/msg00015.html).
> 
> Your comment about maybe statically linking libguile makes some sense, but then you'd have to also statically link any of its dependencies as well, including libgc or else it wouldn't solve the problem.

They could also load the Guile extension only if they need it.
(And/or have a configuration option of turning it off).



---

archive/issue_comments_340839.json:
```json
{
    "body": "That would make sense too.\n\nAnyways, I'm increasingly convinced that the problem here is in the affected distros.  I'm gonna try an Arch VM and see if I can reproduce...",
    "created_at": "2018-02-23T16:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340839",
    "user": "embray"
}
```

That would make sense too.

Anyways, I'm increasingly convinced that the problem here is in the affected distros.  I'm gonna try an Arch VM and see if I can reproduce...



---

archive/issue_comments_340840.json:
```json
{
    "body": "Replying to [comment:34 dimpase]:\n> oops, typo, it should be\n> \"Could anyone who can reproduce this check whether #23700 fixes the problem?\"\n\nNot for me.\n\n1. I checked out the ticket and ran `make`. Same failure.\n\n2. I ran `make distclean`, the `make` again. I got this failure:\n\n\n```\n[patch-2.7.5] Using cached file /home/defeo/sage/upstream/patch-2.7.5.tar.gz\n[patch-2.7.5] patch-2.7.5\n[patch-2.7.5] ====================================================\n[patch-2.7.5] Setting up build directory for patch-2.7.5\n[patch-2.7.5] Traceback (most recent call last):\n[patch-2.7.5]   File \"/home/defeo/sage/build/bin/sage-uncompress-spkg\", line 23, in <module>\n[patch-2.7.5]     run()\n[patch-2.7.5]   File \"/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py\", line 72, in run\n[patch-2.7.5]     unpack_archive(archive, dirname)\n[patch-2.7.5]   File \"/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/action.py\", line 68, in unpack_archive\n[patch-2.7.5]     archive.extractall(members=archive.names)\n[patch-2.7.5]   File \"/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 90, in extractall\n[patch-2.7.5]     members=members)\n[patch-2.7.5]   File \"/usr/lib/python3.6/tarfile.py\", line 2007, in extractall\n[patch-2.7.5]     numeric_owner=numeric_owner)\n[patch-2.7.5]   File \"/usr/lib/python3.6/tarfile.py\", line 2049, in extract\n[patch-2.7.5]     numeric_owner=numeric_owner)\n[patch-2.7.5] TypeError: _extract_member() got an unexpected keyword argument 'set_attrs'\n[patch-2.7.5] ************************************************************************\n[patch-2.7.5] Error: failed to extract /home/defeo/sage/upstream/patch-2.7.5.tar.gz\n[patch-2.7.5] ************************************************************************\n```\n",
    "created_at": "2018-02-23T18:17:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340840",
    "user": "defeo"
}
```

Replying to [comment:34 dimpase]:
> oops, typo, it should be
> "Could anyone who can reproduce this check whether #23700 fixes the problem?"

Not for me.

1. I checked out the ticket and ran `make`. Same failure.

2. I ran `make distclean`, the `make` again. I got this failure:


```
[patch-2.7.5] Using cached file /home/defeo/sage/upstream/patch-2.7.5.tar.gz
[patch-2.7.5] patch-2.7.5
[patch-2.7.5] ====================================================
[patch-2.7.5] Setting up build directory for patch-2.7.5
[patch-2.7.5] Traceback (most recent call last):
[patch-2.7.5]   File "/home/defeo/sage/build/bin/sage-uncompress-spkg", line 23, in <module>
[patch-2.7.5]     run()
[patch-2.7.5]   File "/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py", line 72, in run
[patch-2.7.5]     unpack_archive(archive, dirname)
[patch-2.7.5]   File "/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/action.py", line 68, in unpack_archive
[patch-2.7.5]     archive.extractall(members=archive.names)
[patch-2.7.5]   File "/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 90, in extractall
[patch-2.7.5]     members=members)
[patch-2.7.5]   File "/usr/lib/python3.6/tarfile.py", line 2007, in extractall
[patch-2.7.5]     numeric_owner=numeric_owner)
[patch-2.7.5]   File "/usr/lib/python3.6/tarfile.py", line 2049, in extract
[patch-2.7.5]     numeric_owner=numeric_owner)
[patch-2.7.5] TypeError: _extract_member() got an unexpected keyword argument 'set_attrs'
[patch-2.7.5] ************************************************************************
[patch-2.7.5] Error: failed to extract /home/defeo/sage/upstream/patch-2.7.5.tar.gz
[patch-2.7.5] ************************************************************************
```




---

archive/issue_comments_340841.json:
```json
{
    "body": "a duplicate comment, sorry.",
    "created_at": "2018-02-23T18:47:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340841",
    "user": "dimpase"
}
```

a duplicate comment, sorry.



---

archive/issue_comments_340842.json:
```json
{
    "body": "Replying to [comment:40 defeo]:\n> Replying to [comment:34 dimpase]:\n> > oops, typo, it should be\n> > \"Could anyone who can reproduce this check whether #23700 fixes the problem?\"\n> \n> Not for me.\n> \n> 1. I checked out the ticket and ran `make`. Same failure.\n> \n> 2. I ran `make distclean`, the `make` again. I got this failure:\n> \n> {{{\n> [patch-2.7.5] Using cached file /home/defeo/sage/upstream/patch-2.7.5.tar.gz\n> [patch-2.7.5] patch-2.7.5\n> [patch-2.7.5] ====================================================\n> [patch-2.7.5] Setting up build directory for patch-2.7.5\n> [patch-2.7.5] Traceback (most recent call last):\n> [patch-2.7.5]   File \"/home/defeo/sage/build/bin/sage-uncompress-spkg\", line 23, in <module>\n> [patch-2.7.5]     run()\n> [patch-2.7.5]   File \"/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py\", line 72, in run\n> [patch-2.7.5]     unpack_archive(archive, dirname)\n> [patch-2.7.5]   File \"/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/action.py\", line 68, in unpack_archive\n> [patch-2.7.5]     archive.extractall(members=archive.names)\n> [patch-2.7.5]   File \"/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 90, in extractall\n> [patch-2.7.5]     members=members)\n> [patch-2.7.5]   File \"/usr/lib/python3.6/tarfile.py\", line 2007, in extractall\n> [patch-2.7.5]     numeric_owner=numeric_owner)\n> [patch-2.7.5]   File \"/usr/lib/python3.6/tarfile.py\", line 2049, in extract\n> [patch-2.7.5]     numeric_owner=numeric_owner)\n> [patch-2.7.5] TypeError: _extract_member() got an unexpected keyword argument 'set_attrs'\n> [patch-2.7.5] ************************************************************************\n> [patch-2.7.5] Error: failed to extract /home/defeo/sage/upstream/patch-2.7.5.tar.gz\n> [patch-2.7.5] ************************************************************************\n> }}}\n\nthis looks like system's Python is nuked too. Do you have funky stuff in your LD_LIBRARY_PATH or in PATH? Nothing to do with gc, that's certain.",
    "created_at": "2018-02-23T18:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340842",
    "user": "dimpase"
}
```

Replying to [comment:40 defeo]:
> Replying to [comment:34 dimpase]:
> > oops, typo, it should be
> > "Could anyone who can reproduce this check whether #23700 fixes the problem?"
> 
> Not for me.
> 
> 1. I checked out the ticket and ran `make`. Same failure.
> 
> 2. I ran `make distclean`, the `make` again. I got this failure:
> 
> {{{
> [patch-2.7.5] Using cached file /home/defeo/sage/upstream/patch-2.7.5.tar.gz
> [patch-2.7.5] patch-2.7.5
> [patch-2.7.5] ====================================================
> [patch-2.7.5] Setting up build directory for patch-2.7.5
> [patch-2.7.5] Traceback (most recent call last):
> [patch-2.7.5]   File "/home/defeo/sage/build/bin/sage-uncompress-spkg", line 23, in <module>
> [patch-2.7.5]     run()
> [patch-2.7.5]   File "/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py", line 72, in run
> [patch-2.7.5]     unpack_archive(archive, dirname)
> [patch-2.7.5]   File "/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/action.py", line 68, in unpack_archive
> [patch-2.7.5]     archive.extractall(members=archive.names)
> [patch-2.7.5]   File "/home/defeo/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 90, in extractall
> [patch-2.7.5]     members=members)
> [patch-2.7.5]   File "/usr/lib/python3.6/tarfile.py", line 2007, in extractall
> [patch-2.7.5]     numeric_owner=numeric_owner)
> [patch-2.7.5]   File "/usr/lib/python3.6/tarfile.py", line 2049, in extract
> [patch-2.7.5]     numeric_owner=numeric_owner)
> [patch-2.7.5] TypeError: _extract_member() got an unexpected keyword argument 'set_attrs'
> [patch-2.7.5] ************************************************************************
> [patch-2.7.5] Error: failed to extract /home/defeo/sage/upstream/patch-2.7.5.tar.gz
> [patch-2.7.5] ************************************************************************
> }}}

this looks like system's Python is nuked too. Do you have funky stuff in your LD_LIBRARY_PATH or in PATH? Nothing to do with gc, that's certain.



---

archive/issue_comments_340843.json:
```json
{
    "body": "Or perhaps it's simply due to your `python` being `python3` (or a very new `python3`, which has not been tested...)",
    "created_at": "2018-02-23T18:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340843",
    "user": "dimpase"
}
```

Or perhaps it's simply due to your `python` being `python3` (or a very new `python3`, which has not been tested...)



---

archive/issue_comments_340844.json:
```json
{
    "body": "yep, I have this error if I set my system Python to python3.5, too.\n\nThus, set python to python2, and repeat please.",
    "created_at": "2018-02-23T19:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340844",
    "user": "dimpase"
}
```

yep, I have this error if I set my system Python to python3.5, too.

Thus, set python to python2, and repeat please.



---

archive/issue_comments_340845.json:
```json
{
    "body": "Replying to [comment:44 dimpase]:\n> yep, I have this error if I set my system Python to python3.5, too.\n> \n> Thus, set python to python2, and repeat please.\n\nThis tar_file py3 problem is now #24830 (which has nothing to do with the current ticket)",
    "created_at": "2018-02-23T23:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340845",
    "user": "dimpase"
}
```

Replying to [comment:44 dimpase]:
> yep, I have this error if I set my system Python to python3.5, too.
> 
> Thus, set python to python2, and repeat please.

This tar_file py3 problem is now #24830 (which has nothing to do with the current ticket)



---

archive/issue_comments_340846.json:
```json
{
    "body": "Ok, it compiled with Python2. Now, it might be thanks to #23700, or thanks to Python2... who knows? :)",
    "created_at": "2018-02-24T00:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340846",
    "user": "defeo"
}
```

Ok, it compiled with Python2. Now, it might be thanks to #23700, or thanks to Python2... who knows? :)



---

archive/issue_comments_340847.json:
```json
{
    "body": "#23700 is reported to fix this issue. \n\n(As well as using a guile-less make, I presume.)",
    "created_at": "2018-02-24T07:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340847",
    "user": "dimpase"
}
```

#23700 is reported to fix this issue. 

(As well as using a guile-less make, I presume.)



---

archive/issue_comments_340848.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-24T07:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340848",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340849.json:
```json
{
    "body": "Neat, I was able to reproduce this in an Arch Linux Docker image.  So at least there's that.",
    "created_at": "2018-02-28T14:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340849",
    "user": "embray"
}
```

Neat, I was able to reproduce this in an Arch Linux Docker image.  So at least there's that.



---

archive/issue_comments_340850.json:
```json
{
    "body": "Does #23700 cure it?",
    "created_at": "2018-02-28T14:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340850",
    "user": "dimpase"
}
```

Does #23700 cure it?



---

archive/issue_comments_340851.json:
```json
{
    "body": "I haven't tried. But a workaround that did work was to add `LD_PRELOAD=/usr/bin/libgc.so`.  So a full workaround might look something like:\n\n\n```bash\nif [ \"$UNAME\" = \"Linux\" ]; then\n    LIBGC=\"$(ldd $(which make) | sed -n 's/\\s*libgc\\.so.* => \\(.\\+\\) .*/\\1/p')\"\n    if [ -n \"$LIBGC\" ]; then\n        export LD_PRELOAD=\"$LIBGC\"\n    fi\nfi\n```\n\n\nThis finds the `libgc` that is needed by `libguile` (and by extension `make`) and ensures it's the one that's used, not the one from Sage.  Sucks, but it works, and is kind of necessary.\n\nA similar `LD_PRELOAD` trick might be able to solve #24605 as well, but I haven't tested that yet.",
    "created_at": "2018-02-28T15:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340851",
    "user": "embray"
}
```

I haven't tried. But a workaround that did work was to add `LD_PRELOAD=/usr/bin/libgc.so`.  So a full workaround might look something like:


```bash
if [ "$UNAME" = "Linux" ]; then
    LIBGC="$(ldd $(which make) | sed -n 's/\s*libgc\.so.* => \(.\+\) .*/\1/p')"
    if [ -n "$LIBGC" ]; then
        export LD_PRELOAD="$LIBGC"
    fi
fi
```


This finds the `libgc` that is needed by `libguile` (and by extension `make`) and ensures it's the one that's used, not the one from Sage.  Sucks, but it works, and is kind of necessary.

A similar `LD_PRELOAD` trick might be able to solve #24605 as well, but I haven't tested that yet.



---

archive/issue_comments_340852.json:
```json
{
    "body": "I've gone ahead and added my workaround.  I would recommend using this even with #23700, just because really we should always be using the `libgc` from the system when invoking `make` (where applicable), even if the `libgc` in Sage happens, by some luck, to be compatible with the system's version.\n\nIn principle this workaround is needed for any build process that adds `$SAGE_LOCAL/lib` to `$LD_LIBRARY_PATH`.  In general this should not be done at all, but there is at least one other case I know of in Sage: python.  So this might also be worth extracting into a helper function for pre-loading certain libraries when needed...\n----\nNew commits:",
    "created_at": "2018-03-02T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340852",
    "user": "embray"
}
```

I've gone ahead and added my workaround.  I would recommend using this even with #23700, just because really we should always be using the `libgc` from the system when invoking `make` (where applicable), even if the `libgc` in Sage happens, by some luck, to be compatible with the system's version.

In principle this workaround is needed for any build process that adds `$SAGE_LOCAL/lib` to `$LD_LIBRARY_PATH`.  In general this should not be done at all, but there is at least one other case I know of in Sage: python.  So this might also be worth extracting into a helper function for pre-loading certain libraries when needed...
----
New commits:



---

archive/issue_comments_340853.json:
```json
{
    "body": "Replying to [comment:51 embray]:\n> I've gone ahead and added my workaround.  I would recommend using this even with #23700, just because really we should always be using the `libgc` from the system when invoking `make` (where applicable), even if the `libgc` in Sage happens, by some luck, to be compatible with the system's version.\n> \n> In principle this workaround is needed for any build process that adds `$SAGE_LOCAL/lib` to `$LD_LIBRARY_PATH`.  In general this should not be done at all, but there is at least one other case I know of in Sage: python.  So this might also be worth extracting into a helper function for pre-loading certain libraries when needed...\n\nThanks Erik for analyzing the problem and providing the workaround! I definitely did not want to consider #23700 as a solution. (I am now compiling from scratch for checking)\n\nNote that your fix is focused towards libgc so that the same kind of trouble might appear with another library in the future. But I consider this as fine for now. Wouldn't it be possible to exclude libgc from the list of packages to install when already present (and up to date) on the system?",
    "created_at": "2018-03-04T09:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340853",
    "user": "vdelecroix"
}
```

Replying to [comment:51 embray]:
> I've gone ahead and added my workaround.  I would recommend using this even with #23700, just because really we should always be using the `libgc` from the system when invoking `make` (where applicable), even if the `libgc` in Sage happens, by some luck, to be compatible with the system's version.
> 
> In principle this workaround is needed for any build process that adds `$SAGE_LOCAL/lib` to `$LD_LIBRARY_PATH`.  In general this should not be done at all, but there is at least one other case I know of in Sage: python.  So this might also be worth extracting into a helper function for pre-loading certain libraries when needed...

Thanks Erik for analyzing the problem and providing the workaround! I definitely did not want to consider #23700 as a solution. (I am now compiling from scratch for checking)

Note that your fix is focused towards libgc so that the same kind of trouble might appear with another library in the future. But I consider this as fine for now. Wouldn't it be possible to exclude libgc from the list of packages to install when already present (and up to date) on the system?



---

archive/issue_comments_340854.json:
```json
{
    "body": "Attachment [flint-2.5.2.p2.log](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2.p2.log) by vdelecroix created at 2018-03-04 10:25:59\n\nflint build is failing (for the same reason as R did), see [attachment:flint-2.5.2.p2.log]. Should we apply the same strategy here?",
    "created_at": "2018-03-04T10:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340854",
    "user": "vdelecroix"
}
```

Attachment [flint-2.5.2.p2.log](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2.p2.log) by vdelecroix created at 2018-03-04 10:25:59

flint build is failing (for the same reason as R did), see [attachment:flint-2.5.2.p2.log]. Should we apply the same strategy here?



---

archive/issue_comments_340855.json:
```json
{
    "body": "Attachment [rpy2-2.8.2.p0.log](tarball://root/attachments/some-uuid/ticket24575/rpy2-2.8.2.p0.log) by vdelecroix created at 2018-03-04 11:03:11",
    "created_at": "2018-03-04T11:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340855",
    "user": "vdelecroix"
}
```

Attachment [rpy2-2.8.2.p0.log](tarball://root/attachments/some-uuid/ticket24575/rpy2-2.8.2.p0.log) by vdelecroix created at 2018-03-04 11:03:11



---

archive/issue_comments_340856.json:
```json
{
    "body": "Replying to [comment:53 vdelecroix]:\n> flint build is failing (for the same reason as R did), see [attachment:flint-2.5.2.p2.log]. Should we apply the same strategy here?\n\nSame also with arb and the Python package ryp2 ([attachment:rpy2-2.8.2.p0.log]). After adding the workaround to the three spkg-install the build completes.\n\nThough I did not check the optional packages.",
    "created_at": "2018-03-04T11:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340856",
    "user": "vdelecroix"
}
```

Replying to [comment:53 vdelecroix]:
> flint build is failing (for the same reason as R did), see [attachment:flint-2.5.2.p2.log]. Should we apply the same strategy here?

Same also with arb and the Python package ryp2 ([attachment:rpy2-2.8.2.p0.log]). After adding the workaround to the three spkg-install the build completes.

Though I did not check the optional packages.



---

archive/issue_comments_340857.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-04T11:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340857",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_340858.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-04T13:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340858",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340859.json:
```json
{
    "body": "Shouldn't we do the `LD_PRELOAD` in the script that calls `spkg-install`, rather than \nrepeat this boilerplate? (And the same for `spkg-check`, by the way).\n\nThis would also take care of all the non-standard packages.",
    "created_at": "2018-03-04T13:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340859",
    "user": "dimpase"
}
```

Shouldn't we do the `LD_PRELOAD` in the script that calls `spkg-install`, rather than 
repeat this boilerplate? (And the same for `spkg-check`, by the way).

This would also take care of all the non-standard packages.



---

archive/issue_comments_340860.json:
```json
{
    "body": "Replying to [comment:57 dimpase]:\n> Shouldn't we do the `LD_PRELOAD` in the script that calls `spkg-install`, rather than \n> repeat this boilerplate? (And the same for `spkg-check`, by the way).\n>\n> This would also take care of all the non-standard packages.\n\nI don't think so. This workaround takes care of fragile makefiles until a better solution is found. Having it globally applied would be a nightmare for debugging as well as upstream communication. It is also likely that the workarounds will be removed one by one.",
    "created_at": "2018-03-04T22:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340860",
    "user": "vdelecroix"
}
```

Replying to [comment:57 dimpase]:
> Shouldn't we do the `LD_PRELOAD` in the script that calls `spkg-install`, rather than 
> repeat this boilerplate? (And the same for `spkg-check`, by the way).
>
> This would also take care of all the non-standard packages.

I don't think so. This workaround takes care of fragile makefiles until a better solution is found. Having it globally applied would be a nightmare for debugging as well as upstream communication. It is also likely that the workarounds will be removed one by one.



---

archive/issue_comments_340861.json:
```json
{
    "body": "Replying to [comment:58 vdelecroix]:\n> Replying to [comment:57 dimpase]:\n> > Shouldn't we do the `LD_PRELOAD` in the script that calls `spkg-install`, rather than \n> > repeat this boilerplate? (And the same for `spkg-check`, by the way).\n> >\n> > This would also take care of all the non-standard packages.\n> \n> I don't think so. This workaround takes care of fragile makefiles until a better solution is found.\n\nA better solution is not to use Guile-enabled make, at least not until it is built in a way ensuring one can use it for hacking on Guile dependencies.\n\n>Having it globally applied would be a nightmare for debugging as well as upstream communication. It is also likely that the workarounds will be removed one by one.\n\nThere is nothing to communicate to package upstream here, I think. You cannot ban their use of LD_LIBRARY_FLAGS. Then, the LD_PRELOAD is a pretty standard way to deal with these issues. It has cured so far all these issues, why do you want to keep getting reports on such and such package mysteriously breaking while Guile-enabled make is used.",
    "created_at": "2018-03-04T22:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340861",
    "user": "dimpase"
}
```

Replying to [comment:58 vdelecroix]:
> Replying to [comment:57 dimpase]:
> > Shouldn't we do the `LD_PRELOAD` in the script that calls `spkg-install`, rather than 
> > repeat this boilerplate? (And the same for `spkg-check`, by the way).
> >
> > This would also take care of all the non-standard packages.
> 
> I don't think so. This workaround takes care of fragile makefiles until a better solution is found.

A better solution is not to use Guile-enabled make, at least not until it is built in a way ensuring one can use it for hacking on Guile dependencies.

>Having it globally applied would be a nightmare for debugging as well as upstream communication. It is also likely that the workarounds will be removed one by one.

There is nothing to communicate to package upstream here, I think. You cannot ban their use of LD_LIBRARY_FLAGS. Then, the LD_PRELOAD is a pretty standard way to deal with these issues. It has cured so far all these issues, why do you want to keep getting reports on such and such package mysteriously breaking while Guile-enabled make is used.



---

archive/issue_comments_340862.json:
```json
{
    "body": "I agree with Vincent here. This workaround should only be used for the known packages with an LD_LIBRARY_PATH problem, and this should be reported as a bug upstream. \n\nFLINT seems to be getting a CMake build system to replace its handwritten one, which will likely eliminate this problem.",
    "created_at": "2018-03-05T03:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340862",
    "user": "mkoeppe"
}
```

I agree with Vincent here. This workaround should only be used for the known packages with an LD_LIBRARY_PATH problem, and this should be reported as a bug upstream. 

FLINT seems to be getting a CMake build system to replace its handwritten one, which will likely eliminate this problem.



---

archive/issue_comments_340863.json:
```json
{
    "body": "Over in #24885 I already implemented a more generic solution for this, but I didn't push the branch yet.  That should be used instead.",
    "created_at": "2018-03-05T10:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340863",
    "user": "embray"
}
```

Over in #24885 I already implemented a more generic solution for this, but I didn't push the branch yet.  That should be used instead.



---

archive/issue_comments_340864.json:
```json
{
    "body": "Replying to [comment:60 mkoeppe]:\n> I agree with Vincent here. This workaround should only be used for the known packages with an LD_LIBRARY_PATH problem, and this should be reported as a bug upstream. \n\nThe fact that they use `LD_LIBRARY_PATH` is not a bug IMO, though it would be better, at least in some cases, if they used `LD_PRELOAD` instead for *specific* libraries.",
    "created_at": "2018-03-05T10:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340864",
    "user": "embray"
}
```

Replying to [comment:60 mkoeppe]:
> I agree with Vincent here. This workaround should only be used for the known packages with an LD_LIBRARY_PATH problem, and this should be reported as a bug upstream. 

The fact that they use `LD_LIBRARY_PATH` is not a bug IMO, though it would be better, at least in some cases, if they used `LD_PRELOAD` instead for *specific* libraries.



---

archive/issue_comments_340865.json:
```json
{
    "body": "Reworked on top of #24885\n----\nNew commits:",
    "created_at": "2018-03-05T10:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340865",
    "user": "embray"
}
```

Reworked on top of #24885
----
New commits:



---

archive/issue_comments_340866.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-05T10:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340866",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340867.json:
```json
{
    "body": "I am currently testing optional tickets, at least `deformation` has the same symptoms (I will provide a proper commit with all of them once finished).",
    "created_at": "2018-03-05T16:06:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340867",
    "user": "vdelecroix"
}
```

I am currently testing optional tickets, at least `deformation` has the same symptoms (I will provide a proper commit with all of them once finished).



---

archive/issue_comments_340868.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-05T16:06:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340868",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340869.json:
```json
{
    "body": "All right, for `deformation`, after setting the `sdh_preload_lib` I got a different error that is unrelated\n\n```\n[deformation-d05941b]     CC   ../build/perm/../perm.lo\n[deformation-d05941b] /usr/bin/ld: -r and -pie may not be used together\n[deformation-d05941b] collect2: error: ld returned 1 exit status\n[deformation-d05941b] make[4]: *** [../Makefile.subdirs:55: ../build/perm/../perm.lo] Error 1\n```\n",
    "created_at": "2018-03-05T16:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340869",
    "user": "vdelecroix"
}
```

All right, for `deformation`, after setting the `sdh_preload_lib` I got a different error that is unrelated

```
[deformation-d05941b]     CC   ../build/perm/../perm.lo
[deformation-d05941b] /usr/bin/ld: -r and -pie may not be used together
[deformation-d05941b] collect2: error: ld returned 1 exit status
[deformation-d05941b] make[4]: *** [../Makefile.subdirs:55: ../build/perm/../perm.lo] Error 1
```




---

archive/issue_comments_340870.json:
```json
{
    "body": "Concerning optional packages, only deformation needs the workaround (It appears that I also have some unrelated build failures #23533, #24901, #24902 and #24903).\n\nErik, Dima, Matthias: I am considering the branch as ready to be positively reviewed. As I added a commit on top of the branch I let somebody else finishing the review.\n----\nNew commits:",
    "created_at": "2018-03-05T16:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340870",
    "user": "vdelecroix"
}
```

Concerning optional packages, only deformation needs the workaround (It appears that I also have some unrelated build failures #23533, #24901, #24902 and #24903).

Erik, Dima, Matthias: I am considering the branch as ready to be positively reviewed. As I added a commit on top of the branch I let somebody else finishing the review.
----
New commits:



---

archive/issue_comments_340871.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-05T16:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340871",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340872.json:
```json
{
    "body": "Our package `perl_term_readline_gnu` also has some LD_LIBRARY_PATH stuff...",
    "created_at": "2018-03-05T20:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340872",
    "user": "mkoeppe"
}
```

Our package `perl_term_readline_gnu` also has some LD_LIBRARY_PATH stuff...



---

archive/issue_comments_340873.json:
```json
{
    "body": "I think it's better to patch out this LD_LIBRARY_PATH stuff from the packages' Makefiles. \nLike this: https://github.com/mkoeppe/deformation/commit/0d732b13e901b777aca000ff502a5d5aa8d690bf",
    "created_at": "2018-03-05T20:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340873",
    "user": "mkoeppe"
}
```

I think it's better to patch out this LD_LIBRARY_PATH stuff from the packages' Makefiles. 
Like this: https://github.com/mkoeppe/deformation/commit/0d732b13e901b777aca000ff502a5d5aa8d690bf



---

archive/issue_comments_340874.json:
```json
{
    "body": "Replying to [comment:70 mkoeppe]:\n> I think it's better to patch out this LD_LIBRARY_PATH stuff from the packages' Makefiles. \n> Like this: https://github.com/mkoeppe/deformation/commit/0d732b13e901b777aca000ff502a5d5aa8d690bf\n\nNote that flint Makefile contains the [very same lines](https://github.com/wbhart/flint2/blob/flint-2.5/Makefile.in#L1-L5)... would you suggest that the same operation should be applied there?",
    "created_at": "2018-03-05T21:21:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340874",
    "user": "vdelecroix"
}
```

Replying to [comment:70 mkoeppe]:
> I think it's better to patch out this LD_LIBRARY_PATH stuff from the packages' Makefiles. 
> Like this: https://github.com/mkoeppe/deformation/commit/0d732b13e901b777aca000ff502a5d5aa8d690bf

Note that flint Makefile contains the [very same lines](https://github.com/wbhart/flint2/blob/flint-2.5/Makefile.in#L1-L5)... would you suggest that the same operation should be applied there?



---

archive/issue_comments_340875.json:
```json
{
    "body": "Replying to [comment:72 vdelecroix]:\n> Replying to [comment:70 mkoeppe]:\n> > I think it's better to patch out this LD_LIBRARY_PATH stuff from the packages' Makefiles. \n> > Like this: https://github.com/mkoeppe/deformation/commit/0d732b13e901b777aca000ff502a5d5aa8d690bf\n> \n> Note that flint Makefile contains the [very same lines](https://github.com/wbhart/flint2/blob/flint-2.5/Makefile.in#L1-L5)... would you suggest that the same operation should be applied there?\n\nAs well as [arb](https://github.com/fredrik-johansson/arb/blob/master/Makefile.in#L1-L5).",
    "created_at": "2018-03-05T21:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340875",
    "user": "vdelecroix"
}
```

Replying to [comment:72 vdelecroix]:
> Replying to [comment:70 mkoeppe]:
> > I think it's better to patch out this LD_LIBRARY_PATH stuff from the packages' Makefiles. 
> > Like this: https://github.com/mkoeppe/deformation/commit/0d732b13e901b777aca000ff502a5d5aa8d690bf
> 
> Note that flint Makefile contains the [very same lines](https://github.com/wbhart/flint2/blob/flint-2.5/Makefile.in#L1-L5)... would you suggest that the same operation should be applied there?

As well as [arb](https://github.com/fredrik-johansson/arb/blob/master/Makefile.in#L1-L5).



---

archive/issue_comments_340876.json:
```json
{
    "body": "`flint`, `arb` and `deformation` share almost the same build system indeed.\nExcept I did not push the `-r`/`pie` fix to `deformation`.",
    "created_at": "2018-03-05T21:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340876",
    "user": "jpflori"
}
```

`flint`, `arb` and `deformation` share almost the same build system indeed.
Except I did not push the `-r`/`pie` fix to `deformation`.



---

archive/issue_comments_340877.json:
```json
{
    "body": "Replying to [comment:72 vdelecroix]:\n> would you suggest that the same operation should be applied there?\nYes, probably.",
    "created_at": "2018-03-05T21:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340877",
    "user": "mkoeppe"
}
```

Replying to [comment:72 vdelecroix]:
> would you suggest that the same operation should be applied there?
Yes, probably.



---

archive/issue_comments_340878.json:
```json
{
    "body": "And for R, it may be enough to remove the bottom lines of `etc/ldpaths.in`.",
    "created_at": "2018-03-05T21:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340878",
    "user": "mkoeppe"
}
```

And for R, it may be enough to remove the bottom lines of `etc/ldpaths.in`.



---

archive/issue_comments_340879.json:
```json
{
    "body": "Note for all these packages, it is to be seen whether upstream would accept these changes: Some of these libraries may in fact have valid reasons for adjusting LD_LIBRARY_PATH in the context of their build system quirks. But in our setup, since we make sure that all libraries are installed with a full rpath, none of these LD_LIBRARY_PATH things are necessary.",
    "created_at": "2018-03-05T22:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340879",
    "user": "mkoeppe"
}
```

Note for all these packages, it is to be seen whether upstream would accept these changes: Some of these libraries may in fact have valid reasons for adjusting LD_LIBRARY_PATH in the context of their build system quirks. But in our setup, since we make sure that all libraries are installed with a full rpath, none of these LD_LIBRARY_PATH things are necessary.



---

archive/issue_comments_340880.json:
```json
{
    "body": "Replying to [comment:79 mkoeppe]:\n> Note for all these packages, it is to be seen whether upstream would accept these changes: Some of these libraries may in fact have valid reasons for adjusting LD_LIBRARY_PATH in the context of their build system quirks. But in our setup, since we make sure that all libraries are installed with a full rpath, none of these LD_LIBRARY_PATH things are necessary.\n\nAt least I asked for flint/arb (see ticket description). Even if upstream remains unchanged we would have two options\n- adding a patch removing the 5 initial lines of `Makefile.in` (compiles fine on my computer)\n- use the Erik's workaround with `LD_PRELOAD`\nDoes anybody have a preference?",
    "created_at": "2018-03-05T22:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340880",
    "user": "vdelecroix"
}
```

Replying to [comment:79 mkoeppe]:
> Note for all these packages, it is to be seen whether upstream would accept these changes: Some of these libraries may in fact have valid reasons for adjusting LD_LIBRARY_PATH in the context of their build system quirks. But in our setup, since we make sure that all libraries are installed with a full rpath, none of these LD_LIBRARY_PATH things are necessary.

At least I asked for flint/arb (see ticket description). Even if upstream remains unchanged we would have two options
- adding a patch removing the 5 initial lines of `Makefile.in` (compiles fine on my computer)
- use the Erik's workaround with `LD_PRELOAD`
Does anybody have a preference?



---

archive/issue_comments_340881.json:
```json
{
    "body": "I (clearly) have a strong preference for patching.",
    "created_at": "2018-03-05T22:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340881",
    "user": "mkoeppe"
}
```

I (clearly) have a strong preference for patching.



---

archive/issue_comments_340882.json:
```json
{
    "body": "Replying to [comment:77 mkoeppe]:\n> And for R, it may be enough to remove the bottom lines of `etc/ldpaths.in`.\n`@`charpent: I see that the sage R package contains various patches from you, in particular regarding directories. Would this change, removing the set up of LD_LIBRARY_PATH (and DYLD_FALLBACK_LIBRARY_PATH on macOS), make sense to you?",
    "created_at": "2018-03-05T23:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340882",
    "user": "mkoeppe"
}
```

Replying to [comment:77 mkoeppe]:
> And for R, it may be enough to remove the bottom lines of `etc/ldpaths.in`.
`@`charpent: I see that the sage R package contains various patches from you, in particular regarding directories. Would this change, removing the set up of LD_LIBRARY_PATH (and DYLD_FALLBACK_LIBRARY_PATH on macOS), make sense to you?



---

archive/issue_comments_340883.json:
```json
{
    "body": "Replying to [comment:82 mkoeppe]:\n> Replying to [comment:77 mkoeppe]:\n> > And for R, it may be enough to remove the bottom lines of `etc/ldpaths.in`.\n> `@`charpent: I see that the sage R package contains various patches from you, in particular regarding directories. Would this change, removing the set up of LD_LIBRARY_PATH (and DYLD_FALLBACK_LIBRARY_PATH on macOS), make sense to you?\n\nIMHO this would break the Java support in R (if Java is installed in a non-standard place, which is not very unusual), and probably other R packages that might install or use shared libs.",
    "created_at": "2018-03-06T00:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340883",
    "user": "dimpase"
}
```

Replying to [comment:82 mkoeppe]:
> Replying to [comment:77 mkoeppe]:
> > And for R, it may be enough to remove the bottom lines of `etc/ldpaths.in`.
> `@`charpent: I see that the sage R package contains various patches from you, in particular regarding directories. Would this change, removing the set up of LD_LIBRARY_PATH (and DYLD_FALLBACK_LIBRARY_PATH on macOS), make sense to you?

IMHO this would break the Java support in R (if Java is installed in a non-standard place, which is not very unusual), and probably other R packages that might install or use shared libs.



---

archive/issue_comments_340884.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-08T09:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340884",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_340885.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-08T10:54:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340885",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340886.json:
```json
{
    "body": "I'm -1 on patching things out if it isn't necessary to, or if the reason to do so hasn't been fully understood.  Are any of these patches even necessary? And if so, why are these packages manipulating `LD_LIBRARY_PATH`, and how are you sure that it isn't a necessary and valid thing to do in this case?",
    "created_at": "2018-03-08T12:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340886",
    "user": "embray"
}
```

I'm -1 on patching things out if it isn't necessary to, or if the reason to do so hasn't been fully understood.  Are any of these patches even necessary? And if so, why are these packages manipulating `LD_LIBRARY_PATH`, and how are you sure that it isn't a necessary and valid thing to do in this case?



---

archive/issue_comments_340887.json:
```json
{
    "body": "In particular, since I already provided a workaround, why not just use that same workaround for those packages as well?",
    "created_at": "2018-03-08T12:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340887",
    "user": "embray"
}
```

In particular, since I already provided a workaround, why not just use that same workaround for those packages as well?



---

archive/issue_comments_340888.json:
```json
{
    "body": "Replying to [comment:89 embray]:\n> I'm -1 on patching things out if it isn't necessary to, or if the reason to do so hasn't been fully understood.  Are any of these patches even necessary? And if so, why are these packages manipulating `LD_LIBRARY_PATH`, and how are you sure that it isn't a necessary and valid thing to do in this case?\n\nMatthias might be better placed to answer (see [comment:81]). We might also wait for upstream answers (see ticket description for the links). To my mind, keeping `spkg-install` as simple as possible is better (assuming the patch is correct).\n\nI would also like to find a solution so that all these build troubles are merged soon (even if the fix has to change later on). The problem at the origin of this ticket affects all archlinux users.",
    "created_at": "2018-03-08T13:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340888",
    "user": "vdelecroix"
}
```

Replying to [comment:89 embray]:
> I'm -1 on patching things out if it isn't necessary to, or if the reason to do so hasn't been fully understood.  Are any of these patches even necessary? And if so, why are these packages manipulating `LD_LIBRARY_PATH`, and how are you sure that it isn't a necessary and valid thing to do in this case?

Matthias might be better placed to answer (see [comment:81]). We might also wait for upstream answers (see ticket description for the links). To my mind, keeping `spkg-install` as simple as possible is better (assuming the patch is correct).

I would also like to find a solution so that all these build troubles are merged soon (even if the fix has to change later on). The problem at the origin of this ticket affects all archlinux users.



---

archive/issue_comments_340889.json:
```json
{
    "body": "Hell, we can provide a make spkg. To me, make is a tool that should work, no matter what. Otherwise, patching Sage packages is akin to trying to use a [slot screwdriver on French recess screws](https://en.wikipedia.org/wiki/List_of_screw_drives), and then proceeding to saw slots in screws instead of picking up a correct tool...(sorry, my undergrad was in engineering :-))",
    "created_at": "2018-03-08T13:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340889",
    "user": "dimpase"
}
```

Hell, we can provide a make spkg. To me, make is a tool that should work, no matter what. Otherwise, patching Sage packages is akin to trying to use a [slot screwdriver on French recess screws](https://en.wikipedia.org/wiki/List_of_screw_drives), and then proceeding to saw slots in screws instead of picking up a correct tool...(sorry, my undergrad was in engineering :-))



---

archive/issue_comments_340890.json:
```json
{
    "body": "Replying to [comment:92 dimpase]:\n> Hell, we can provide a make spkg. To me, make is a tool that should work, no matter what. Otherwise, patching Sage packages is akin to trying to use a [slot screwdriver on French recess screws](https://en.wikipedia.org/wiki/List_of_screw_drives), and then proceeding to saw slots in screws instead of picking up a correct tool...(sorry, my undergrad was in engineering :-))  \n\n[No problem.](https://www.youtube.com/watch?v=CYUfPTeE0DM) After all, //my// undergrad was even more [remote...](https://upload.wikimedia.org/wikipedia/commons/6/6f/Older_barber-dentist.jpg)",
    "created_at": "2018-03-08T14:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340890",
    "user": "charpent"
}
```

Replying to [comment:92 dimpase]:
> Hell, we can provide a make spkg. To me, make is a tool that should work, no matter what. Otherwise, patching Sage packages is akin to trying to use a [slot screwdriver on French recess screws](https://en.wikipedia.org/wiki/List_of_screw_drives), and then proceeding to saw slots in screws instead of picking up a correct tool...(sorry, my undergrad was in engineering :-))  

[No problem.](https://www.youtube.com/watch?v=CYUfPTeE0DM) After all, //my// undergrad was even more [remote...](https://upload.wikimedia.org/wikipedia/commons/6/6f/Older_barber-dentist.jpg)



---

archive/issue_comments_340891.json:
```json
{
    "body": "For flint and friends another workaround I found was to simply pass `DLPATH_ADD=` when calling `make` in its `spkg-install`.",
    "created_at": "2018-03-08T15:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340891",
    "user": "embray"
}
```

For flint and friends another workaround I found was to simply pass `DLPATH_ADD=` when calling `make` in its `spkg-install`.



---

archive/issue_comments_340892.json:
```json
{
    "body": "Replying to [comment:89 embray]:\n>  why are these packages manipulating `LD_LIBRARY_PATH`, and how are you sure that it isn't a necessary and valid thing to do in this case?\n\nWe can be sure simply by testing that the build works, just like we do with any other package.",
    "created_at": "2018-03-08T18:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340892",
    "user": "mkoeppe"
}
```

Replying to [comment:89 embray]:
>  why are these packages manipulating `LD_LIBRARY_PATH`, and how are you sure that it isn't a necessary and valid thing to do in this case?

We can be sure simply by testing that the build works, just like we do with any other package.



---

archive/issue_comments_340893.json:
```json
{
    "body": "Replying to [comment:94 embray]:\n> For flint and friends another workaround I found was to simply pass `DLPATH_ADD=` when calling `make` in its `spkg-install`.\nThis is a great solution, which I prefer over patching.",
    "created_at": "2018-03-08T18:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340893",
    "user": "mkoeppe"
}
```

Replying to [comment:94 embray]:
> For flint and friends another workaround I found was to simply pass `DLPATH_ADD=` when calling `make` in its `spkg-install`.
This is a great solution, which I prefer over patching.



---

archive/issue_comments_340894.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-08T18:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340894",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_340895.json:
```json
{
    "body": "Thank you!\nNext I'd suggest that we also see how exactly `$SAGE_LOCAL/lib` ends up in R's `LD_LIBRARY_PATH`. The relevant file seems to be `$SAGE_LOCAL/lib/R/etc/ldpaths`. But I can't investigate this here on macOS.",
    "created_at": "2018-03-08T19:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340895",
    "user": "mkoeppe"
}
```

Thank you!
Next I'd suggest that we also see how exactly `$SAGE_LOCAL/lib` ends up in R's `LD_LIBRARY_PATH`. The relevant file seems to be `$SAGE_LOCAL/lib/R/etc/ldpaths`. But I can't investigate this here on macOS.



---

archive/issue_comments_340896.json:
```json
{
    "body": "Replying to [comment:92 dimpase]:\n> we can provide a make spkg. \n-1",
    "created_at": "2018-03-08T19:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340896",
    "user": "mkoeppe"
}
```

Replying to [comment:92 dimpase]:
> we can provide a make spkg. 
-1



---

archive/issue_comments_340897.json:
```json
{
    "body": "[EDITED]\n\nAt commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)\n\n- without anything new in `spkg-check` I end up with the same libguile buisness\n- with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).\n- with `sdh_preload_lib` it works fine\n\nI will add a commit in a minute.",
    "created_at": "2018-03-08T19:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340897",
    "user": "vdelecroix"
}
```

[EDITED]

At commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)

- without anything new in `spkg-check` I end up with the same libguile buisness
- with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).
- with `sdh_preload_lib` it works fine

I will add a commit in a minute.



---

archive/issue_comments_340898.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-08T19:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340898",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340899.json:
```json
{
    "body": "Interesting; normally `make check` is supposed to test against the non-installed library, rather than the installed library. (The distinction does not matter to us because we run `spkg-check` after `spkg-install`.",
    "created_at": "2018-03-08T20:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340899",
    "user": "mkoeppe"
}
```

Interesting; normally `make check` is supposed to test against the non-installed library, rather than the installed library. (The distinction does not matter to us because we run `spkg-check` after `spkg-install`.



---

archive/issue_comments_340900.json:
```json
{
    "body": "Vincent, could you try whether passing \n\n```\n$MAKE check DLPATH_ADD=`pwd`\n```\n\nworks (without using `sdh_preload_lib`)?",
    "created_at": "2018-03-08T20:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340900",
    "user": "mkoeppe"
}
```

Vincent, could you try whether passing 

```
$MAKE check DLPATH_ADD=`pwd`
```

works (without using `sdh_preload_lib`)?



---

archive/issue_comments_340901.json:
```json
{
    "body": "Attachment [flint-2.5.2-check_on_base.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_on_base.log.gz) by vdelecroix created at 2018-03-08 20:53:01",
    "created_at": "2018-03-08T20:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340901",
    "user": "vdelecroix"
}
```

Attachment [flint-2.5.2-check_on_base.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_on_base.log.gz) by vdelecroix created at 2018-03-08 20:53:01



---

archive/issue_comments_340902.json:
```json
{
    "body": "Attachment [flint-2.5.2-check_with_DLPATH_ADD_pwd.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_with_DLPATH_ADD_pwd.log.gz) by vdelecroix created at 2018-03-08 20:53:24",
    "created_at": "2018-03-08T20:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340902",
    "user": "vdelecroix"
}
```

Attachment [flint-2.5.2-check_with_DLPATH_ADD_pwd.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_with_DLPATH_ADD_pwd.log.gz) by vdelecroix created at 2018-03-08 20:53:24



---

archive/issue_comments_340903.json:
```json
{
    "body": "Attachment [flint-2.5.2-check_with_sdh_preload.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_with_sdh_preload.log.gz) by vdelecroix created at 2018-03-08 20:57:44\n\nSee in attachment the full log of the `sage -f -c flint` with the various configurations\n\n- spkg-check as in develop [attachment:flint-2.5.2-check_on_base.log.gz] \n- with `DLPATH_ADD=` [attachment:flint-2.5.2-check_with_DLPATH_ADD_empty.log.gz]\n- with `DLPATH_add=`pwd`` as suggested in [comment:103] [attachment:flint-2.5.2-check_with_DLPATH_ADD_pwd.log.gz] \n- with `sdh_preload_lib` as in `0d8a4a9` [attachment:flint-2.5.2-check_with_sdh_preload.log.gz]",
    "created_at": "2018-03-08T20:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340903",
    "user": "vdelecroix"
}
```

Attachment [flint-2.5.2-check_with_sdh_preload.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_with_sdh_preload.log.gz) by vdelecroix created at 2018-03-08 20:57:44

See in attachment the full log of the `sage -f -c flint` with the various configurations

- spkg-check as in develop [attachment:flint-2.5.2-check_on_base.log.gz] 
- with `DLPATH_ADD=` [attachment:flint-2.5.2-check_with_DLPATH_ADD_empty.log.gz]
- with `DLPATH_add=`pwd`` as suggested in [comment:103] [attachment:flint-2.5.2-check_with_DLPATH_ADD_pwd.log.gz] 
- with `sdh_preload_lib` as in `0d8a4a9` [attachment:flint-2.5.2-check_with_sdh_preload.log.gz]



---

archive/issue_comments_340904.json:
```json
{
    "body": "Thank you!\nSeems like FLINT forgets to pass the rpath linker option when it builds its test programs, relying on LD_LIBRARY_PATH instead.",
    "created_at": "2018-03-08T21:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340904",
    "user": "mkoeppe"
}
```

Thank you!
Seems like FLINT forgets to pass the rpath linker option when it builds its test programs, relying on LD_LIBRARY_PATH instead.



---

archive/issue_comments_340905.json:
```json
{
    "body": "Our patch `use_ldflags_in_tests.patch` (for FLINT) does not go far enough; it forgets to patch `Makefile.subdirs`.",
    "created_at": "2018-03-09T01:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340905",
    "user": "mkoeppe"
}
```

Our patch `use_ldflags_in_tests.patch` (for FLINT) does not go far enough; it forgets to patch `Makefile.subdirs`.



---

archive/issue_comments_340906.json:
```json
{
    "body": "Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1",
    "created_at": "2018-03-09T01:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340906",
    "user": "mkoeppe"
}
```

Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1



---

archive/issue_comments_340907.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2018-03-09T03:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340907",
    "user": "@dimpase"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_340908.json:
```json
{
    "body": "The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.\n\nIf you must work on Arch, install make without guile support. Certainly, improving various upstream build systems is a noble goal, but getting totally carried away with this is not a good idea.",
    "created_at": "2018-03-09T03:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340908",
    "user": "@dimpase"
}
```

The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.

If you must work on Arch, install make without guile support. Certainly, improving various upstream build systems is a noble goal, but getting totally carried away with this is not a good idea.



---

archive/issue_comments_340909.json:
```json
{
    "body": "I agree that it's probably not a blocker because it only happens on a relatively obscure configuration.\nBut I don't think your edit to the description was an improvement.",
    "created_at": "2018-03-09T04:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340909",
    "user": "mkoeppe"
}
```

I agree that it's probably not a blocker because it only happens on a relatively obscure configuration.
But I don't think your edit to the description was an improvement.



---

archive/issue_comments_340910.json:
```json
{
    "body": "Replying to [comment:109 mkoeppe]:\n> I agree that it's probably not a blocker because it only happens on a relatively obscure configuration.\n> But I don't think your edit to the description was an improvement. \n\nI've added a bit more detail pointing at the root cause of trouble. As well, #23700 will provide `libgc` compatible with the one needed by `libguile`, and the main problem will go away after it is merged.",
    "created_at": "2018-03-09T04:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340910",
    "user": "@dimpase"
}
```

Replying to [comment:109 mkoeppe]:
> I agree that it's probably not a blocker because it only happens on a relatively obscure configuration.
> But I don't think your edit to the description was an improvement. 

I've added a bit more detail pointing at the root cause of trouble. As well, #23700 will provide `libgc` compatible with the one needed by `libguile`, and the main problem will go away after it is merged.



---

archive/issue_comments_340911.json:
```json
{
    "body": "Replying to [comment:107 mkoeppe]:\n> Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1\n\nWith the patch applied, tests run with `DLPATH_ADD=` in `make check`. Could you make it a proper upstream pull request?",
    "created_at": "2018-03-09T08:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340911",
    "user": "vdelecroix"
}
```

Replying to [comment:107 mkoeppe]:
> Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1

With the patch applied, tests run with `DLPATH_ADD=` in `make check`. Could you make it a proper upstream pull request?



---

archive/issue_comments_340912.json:
```json
{
    "body": "Replying to [comment:100 vdelecroix]:\n> [EDITED]\n> \n> At commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)\n> \n> - without anything new in `spkg-check` I end up with the same libguile buisness\n> - with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).\n\nI didn't get an opportunity to comment on this last night, but FYI you don't need to add `DLPATH_ADD=` to the `make install` call.  Just the first one that says `make verbose`.  That works for me, and the `make check` tests pass.",
    "created_at": "2018-03-09T10:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340912",
    "user": "embray"
}
```

Replying to [comment:100 vdelecroix]:
> [EDITED]
> 
> At commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)
> 
> - without anything new in `spkg-check` I end up with the same libguile buisness
> - with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).

I didn't get an opportunity to comment on this last night, but FYI you don't need to add `DLPATH_ADD=` to the `make install` call.  Just the first one that says `make verbose`.  That works for me, and the `make check` tests pass.



---

archive/issue_comments_340913.json:
```json
{
    "body": "Replying to [comment:108 gh-dimpase]:\n> The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.\n\nIt's not a bug in Arch.  If anything it's a bug in Sage...",
    "created_at": "2018-03-09T10:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340913",
    "user": "embray"
}
```

Replying to [comment:108 gh-dimpase]:
> The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.

It's not a bug in Arch.  If anything it's a bug in Sage...



---

archive/issue_comments_340914.json:
```json
{
    "body": "Replying to [comment:113 embray]:\n> Replying to [comment:108 gh-dimpase]:\n> > The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.\n> \n> It's not a bug in Arch.  If anything it's a bug in Sage...\n\nAs you cannot reproduce it on anything but the latest Arch, I don't really see how you can say this. The make they ship is not backwards-compatible, and they have not made any announcements to that extent, have not bumped the version up, have they? At least if they insist on this make, they should also provide a guile-less make in another package.",
    "created_at": "2018-03-09T13:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340914",
    "user": "dimpase"
}
```

Replying to [comment:113 embray]:
> Replying to [comment:108 gh-dimpase]:
> > The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.
> 
> It's not a bug in Arch.  If anything it's a bug in Sage...

As you cannot reproduce it on anything but the latest Arch, I don't really see how you can say this. The make they ship is not backwards-compatible, and they have not made any announcements to that extent, have not bumped the version up, have they? At least if they insist on this make, they should also provide a guile-less make in another package.



---

archive/issue_comments_340915.json:
```json
{
    "body": "Replying to [comment:114 dimpase]:\n> Replying to [comment:113 embray]:\n> > Replying to [comment:108 gh-dimpase]:\n> > > The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.\n> > \n> > It's not a bug in Arch.  If anything it's a bug in Sage...\n> \n> As you cannot reproduce it on anything but the latest Arch, I don't really see how you can say this. The make they ship is not backwards-compatible, and they have not made any announcements to that extent, have not bumped the version up, have they? At least if they insist on this make, they should also provide a guile-less make in another package.\n\nI think you're being a tad Sage-centric.  The kind of problem we're encountering here is a normal problem when you have two different versions of a library and you load the wrong version in an executable that expects the different version.  There's certainly nothing wrong with Arch shipping a feature-complete version of GNU make (while it's a rare feature, it's probably used by at least some packages), and I can't blame them for not expecting that somebody might end up with their own copy of libgc on their shared library path, which is a highly unusual thing to be doing.\n\nYou do have a point that being a fundamental build tool, a `make` with additional dependencies is more likely to encounter a problem like this than many other tools, but this same sort of problem can happen with any other part of the build toolchain.  The real problem is that Sage is insisting on using too many of its own packages for low-level dependencies :)",
    "created_at": "2018-03-09T13:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340915",
    "user": "embray"
}
```

Replying to [comment:114 dimpase]:
> Replying to [comment:113 embray]:
> > Replying to [comment:108 gh-dimpase]:
> > > The ticket description and the title were misleading. It's a bug in Arch that we are dealing with here, and it should not be a blocker. A broken make is nothing new, e.g. while in theory BSD Make should be able to build Sage, in practice is does not work, and one has to use GNU Make.
> > 
> > It's not a bug in Arch.  If anything it's a bug in Sage...
> 
> As you cannot reproduce it on anything but the latest Arch, I don't really see how you can say this. The make they ship is not backwards-compatible, and they have not made any announcements to that extent, have not bumped the version up, have they? At least if they insist on this make, they should also provide a guile-less make in another package.

I think you're being a tad Sage-centric.  The kind of problem we're encountering here is a normal problem when you have two different versions of a library and you load the wrong version in an executable that expects the different version.  There's certainly nothing wrong with Arch shipping a feature-complete version of GNU make (while it's a rare feature, it's probably used by at least some packages), and I can't blame them for not expecting that somebody might end up with their own copy of libgc on their shared library path, which is a highly unusual thing to be doing.

You do have a point that being a fundamental build tool, a `make` with additional dependencies is more likely to encounter a problem like this than many other tools, but this same sort of problem can happen with any other part of the build toolchain.  The real problem is that Sage is insisting on using too many of its own packages for low-level dependencies :)



---

archive/issue_comments_340916.json:
```json
{
    "body": "Another example where this kind of problem can occur (but by luck doesn't seem to), which has nothing to do with make or guile or gc:  Sage ships its own libz for some reason.  Well, libpython has libz as a dependency, and when building Python it also manipulates `LD_LIBRARY_PATH`.  In this case it isn't really a problem, but if you had `$SAGE_LOCAL/lib` on `LD_LIBRARY_PATH`, and Sage's libz were incompatible with the system's libz, you would also have a problem.",
    "created_at": "2018-03-09T13:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340916",
    "user": "embray"
}
```

Another example where this kind of problem can occur (but by luck doesn't seem to), which has nothing to do with make or guile or gc:  Sage ships its own libz for some reason.  Well, libpython has libz as a dependency, and when building Python it also manipulates `LD_LIBRARY_PATH`.  In this case it isn't really a problem, but if you had `$SAGE_LOCAL/lib` on `LD_LIBRARY_PATH`, and Sage's libz were incompatible with the system's libz, you would also have a problem.



---

archive/issue_comments_340917.json:
```json
{
    "body": "Replying to [comment:116 embray]:\n> Another example where this kind of problem can occur (but by luck doesn't seem to), which has nothing to do with make or guile or gc:  Sage ships its own libz for some reason.  Well, libpython has libz as a dependency, and when building Python it also manipulates `LD_LIBRARY_PATH`.  In this case it isn't really a problem, but if you had `$SAGE_LOCAL/lib` on `LD_LIBRARY_PATH`, and Sage's libz were incompatible with the system's libz, you would also have a problem.\n\nplease have a look at comments 27-29 above. The only conclusion I can draw from it that Arch has done something dodgy and very hard to reproduce, the probably screwed up versioning of libgc, by not bumping it up while upgrading, or something similar.\n(or perhaps gentoo has a different build setup for make+libguile, so that the result is not fragile...)\n\nTLDR; manipulating LD_LIBRARY_PATH while building with make+guile on gentoo does not lead to a problem, while on arch it does.",
    "created_at": "2018-03-09T14:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340917",
    "user": "dimpase"
}
```

Replying to [comment:116 embray]:
> Another example where this kind of problem can occur (but by luck doesn't seem to), which has nothing to do with make or guile or gc:  Sage ships its own libz for some reason.  Well, libpython has libz as a dependency, and when building Python it also manipulates `LD_LIBRARY_PATH`.  In this case it isn't really a problem, but if you had `$SAGE_LOCAL/lib` on `LD_LIBRARY_PATH`, and Sage's libz were incompatible with the system's libz, you would also have a problem.

please have a look at comments 27-29 above. The only conclusion I can draw from it that Arch has done something dodgy and very hard to reproduce, the probably screwed up versioning of libgc, by not bumping it up while upgrading, or something similar.
(or perhaps gentoo has a different build setup for make+libguile, so that the result is not fragile...)

TLDR; manipulating LD_LIBRARY_PATH while building with make+guile on gentoo does not lead to a problem, while on arch it does.



---

archive/issue_comments_340918.json:
```json
{
    "body": "Replying to [comment:115 embray]:\n\n[ Snip... ]\n\n> The real problem is that Sage is insisting on using too many of its own packages for low-level dependencies :)\n\nHear, hear ! \n\nThis, IMNSHO, is a capital point, that is involved in a *lot* of other parts of Sage. It stems from our insistence to have \"known good\" versions of almost everything we use, hence \"our\" version of Maxima, \"our\" version of R, \"our\" version of Sympy ,etc... and even \"our\" version(s) of Python (!).\n\nThis //modus operandi// greatly simplifies the maintenance of the consistency of Sage with (sometimes wildly) varying versions of other people's software. But the drawback is that Sage ends up being a distribution of mathematics-related software and underlying utilities, which converges to a (not so small) Unix-like distribution.\n\nAn alternative would be to push the version-related variability of interface in specialized interface packages, presenting Sage with a uniform interface and adapting to the \"other side\" variability.\n\nAs far as I can tell, this alternative isn't used because it requires maintenance of the interface for each and every version of the interfaced software that can be met \"in the wild\". Which would be more work than maintaining one \"Sage's own\" version, it seems...\n\nBut at the point where we need \"our\" make, \"our\" gcc, \"our\" python(s), etc..., I wonder if this point of view shouldn't be re-assessed.\n\nThis ticket is probably not the right place to discuss it ; however, I think it should be opened on sage-devel.\n\nOpinions ? Advice ?",
    "created_at": "2018-03-09T14:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340918",
    "user": "charpent"
}
```

Replying to [comment:115 embray]:

[ Snip... ]

> The real problem is that Sage is insisting on using too many of its own packages for low-level dependencies :)

Hear, hear ! 

This, IMNSHO, is a capital point, that is involved in a *lot* of other parts of Sage. It stems from our insistence to have "known good" versions of almost everything we use, hence "our" version of Maxima, "our" version of R, "our" version of Sympy ,etc... and even "our" version(s) of Python (!).

This //modus operandi// greatly simplifies the maintenance of the consistency of Sage with (sometimes wildly) varying versions of other people's software. But the drawback is that Sage ends up being a distribution of mathematics-related software and underlying utilities, which converges to a (not so small) Unix-like distribution.

An alternative would be to push the version-related variability of interface in specialized interface packages, presenting Sage with a uniform interface and adapting to the "other side" variability.

As far as I can tell, this alternative isn't used because it requires maintenance of the interface for each and every version of the interfaced software that can be met "in the wild". Which would be more work than maintaining one "Sage's own" version, it seems...

But at the point where we need "our" make, "our" gcc, "our" python(s), etc..., I wonder if this point of view shouldn't be re-assessed.

This ticket is probably not the right place to discuss it ; however, I think it should be opened on sage-devel.

Opinions ? Advice ?



---

archive/issue_comments_340919.json:
```json
{
    "body": "Replying to [comment:111 vdelecroix]:\n> Replying to [comment:107 mkoeppe]:\n> > Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1\n> \n> With the patch applied, tests run with `DLPATH_ADD=` in `make check`. Could you make it a proper upstream pull request?\n\nhttps://github.com/wbhart/flint2/pull/449",
    "created_at": "2018-03-09T14:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340919",
    "user": "mkoeppe"
}
```

Replying to [comment:111 vdelecroix]:
> Replying to [comment:107 mkoeppe]:
> > Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1
> 
> With the patch applied, tests run with `DLPATH_ADD=` in `make check`. Could you make it a proper upstream pull request?

https://github.com/wbhart/flint2/pull/449



---

archive/issue_comments_340920.json:
```json
{
    "body": "Replying to [comment:116 embray]:\n> Another example where this kind of problem can occur (but by luck doesn't seem to) [...] libz [...]\nThat's why I would recommend to use `DLPATH_ADD=` in all places where make is used in the spkg scripts for the FLINT-like packages, not just the minimal list of those where the current symptom (make-guile-gc-on-arch) is observed.",
    "created_at": "2018-03-09T14:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340920",
    "user": "mkoeppe"
}
```

Replying to [comment:116 embray]:
> Another example where this kind of problem can occur (but by luck doesn't seem to) [...] libz [...]
That's why I would recommend to use `DLPATH_ADD=` in all places where make is used in the spkg scripts for the FLINT-like packages, not just the minimal list of those where the current symptom (make-guile-gc-on-arch) is observed.



---

archive/issue_comments_340921.json:
```json
{
    "body": "Replying to [comment:118 charpent]:\n> Opinions ? Advice ?\n\nThe convenience for users of having a self contained sage distribution (in particular those who are stuck on a system without root access, or distributions without a comprehensive and well-maintained set of mathematical software packages) is important.\n\nUsing the distribution's installed packages instead of our own whenever we can is of course desirable, and in fact there is an ongoing effort to do so. See for example Erik's #24919.\n\nWhether we can use some specific version is often times not a question of \"interfacing\", but to avoid critical bugs; and it seems problematic to build an interface with the purpose of working around bugs. When it is about features rather than bugs, again there is an ongoing effort already, #20382.\n\nThese tickets (and related ones) need technical discussion.",
    "created_at": "2018-03-09T18:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340921",
    "user": "mkoeppe"
}
```

Replying to [comment:118 charpent]:
> Opinions ? Advice ?

The convenience for users of having a self contained sage distribution (in particular those who are stuck on a system without root access, or distributions without a comprehensive and well-maintained set of mathematical software packages) is important.

Using the distribution's installed packages instead of our own whenever we can is of course desirable, and in fact there is an ongoing effort to do so. See for example Erik's #24919.

Whether we can use some specific version is often times not a question of "interfacing", but to avoid critical bugs; and it seems problematic to build an interface with the purpose of working around bugs. When it is about features rather than bugs, again there is an ongoing effort already, #20382.

These tickets (and related ones) need technical discussion.



---

archive/issue_comments_340922.json:
```json
{
    "body": "Attachment [flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz) by vdelecroix created at 2018-03-09 19:59:33\n\nReplying to [comment:112 embray]:\n> Replying to [comment:100 vdelecroix]:\n> > [EDITED]\n> > \n> > At commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)\n> > \n> > - without anything new in `spkg-check` I end up with the same libguile buisness\n> > - with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).\n> \n> I didn't get an opportunity to comment on this last night, but FYI you don't need to add `DLPATH_ADD=` to the `make install` call.  Just the first one that says `make verbose`.  That works for me, and the `make check` tests pass.\n\nPerhaps I misunderstood your suggestion but the following does not work on my computer\n\n```diff\ndiff --git a/build/pkgs/flint/spkg-install b/build/pkgs/flint/spkg-install\nindex f6c185433f..29cdbee8f0 100644\n--- a/build/pkgs/flint/spkg-install\n+++ b/build/pkgs/flint/spkg-install\n@@ -38,7 +38,7 @@ if [ $? -ne 0 ]; then\n fi\n \n echo \"Building FLINT shared library.\"\n-$MAKE verbose\n+$MAKE verbose DLPATH_ADD=\n if [ $? -ne 0 ]; then\n     echo >&2 \"Error: Failed to build FLINT shared library.\"\n     exit 1\n```\n\nThe log of the command `sage -f flint` is [attachment:flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz\u200b].",
    "created_at": "2018-03-09T19:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340922",
    "user": "vdelecroix"
}
```

Attachment [flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz](tarball://root/attachments/some-uuid/ticket24575/flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz) by vdelecroix created at 2018-03-09 19:59:33

Replying to [comment:112 embray]:
> Replying to [comment:100 vdelecroix]:
> > [EDITED]
> > 
> > At commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)
> > 
> > - without anything new in `spkg-check` I end up with the same libguile buisness
> > - with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).
> 
> I didn't get an opportunity to comment on this last night, but FYI you don't need to add `DLPATH_ADD=` to the `make install` call.  Just the first one that says `make verbose`.  That works for me, and the `make check` tests pass.

Perhaps I misunderstood your suggestion but the following does not work on my computer

```diff
diff --git a/build/pkgs/flint/spkg-install b/build/pkgs/flint/spkg-install
index f6c185433f..29cdbee8f0 100644
--- a/build/pkgs/flint/spkg-install
+++ b/build/pkgs/flint/spkg-install
@@ -38,7 +38,7 @@ if [ $? -ne 0 ]; then
 fi
 
 echo "Building FLINT shared library."
-$MAKE verbose
+$MAKE verbose DLPATH_ADD=
 if [ $? -ne 0 ]; then
     echo >&2 "Error: Failed to build FLINT shared library."
     exit 1
```

The log of the command `sage -f flint` is [attachment:flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz​].



---

archive/issue_comments_340923.json:
```json
{
    "body": "Replying to [comment:117 dimpase]:\n> The only conclusion I can draw from it that Arch has done something dodgy and very hard to reproduce, the probably screwed up versioning of libgc, by not bumping it up while upgrading, or something similar.\n> (or perhaps gentoo has a different build setup for make+libguile, so that the result is not fragile...)\n\nShared library versioning is certainly a powerful mechanism for a distribution to keep consistency, but it cannot protect against shadowing system libraries by user-installed libraries via LD_LIBRARY_PATH.",
    "created_at": "2018-03-09T22:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340923",
    "user": "mkoeppe"
}
```

Replying to [comment:117 dimpase]:
> The only conclusion I can draw from it that Arch has done something dodgy and very hard to reproduce, the probably screwed up versioning of libgc, by not bumping it up while upgrading, or something similar.
> (or perhaps gentoo has a different build setup for make+libguile, so that the result is not fragile...)

Shared library versioning is certainly a powerful mechanism for a distribution to keep consistency, but it cannot protect against shadowing system libraries by user-installed libraries via LD_LIBRARY_PATH.



---

archive/issue_comments_340924.json:
```json
{
    "body": "Replying to [comment:119 mkoeppe]:\n> Replying to [comment:111 vdelecroix]:\n> > Replying to [comment:107 mkoeppe]:\n> > > Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1\n> > \n> > With the patch applied, tests run with `DLPATH_ADD=` in `make check`. Could you make it a proper upstream pull request?\n> \n> https://github.com/wbhart/flint2/pull/449\n\nSuperseeded by https://github.com/wbhart/flint2/pull/450 (sorry).",
    "created_at": "2018-03-10T16:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340924",
    "user": "vdelecroix"
}
```

Replying to [comment:119 mkoeppe]:
> Replying to [comment:111 vdelecroix]:
> > Replying to [comment:107 mkoeppe]:
> > > Fix for FLINT is here: https://github.com/mkoeppe/flint2/commit/bd2684891b6da6791ae2f52482a02f5b4cc56bd1
> > 
> > With the patch applied, tests run with `DLPATH_ADD=` in `make check`. Could you make it a proper upstream pull request?
> 
> https://github.com/wbhart/flint2/pull/449

Superseeded by https://github.com/wbhart/flint2/pull/450 (sorry).



---

archive/issue_comments_340925.json:
```json
{
    "body": "Replying to [comment:118 charpent]:\n> This ticket is probably not the right place to discuss it ; however, I think it should be opened on sage-devel.\n> \n> Opinions ? Advice ?\n\nWhile I agree with you 100% this is not a new discussion, nor does a discussion really need to be opened on sage-devel (been there done that).  There is already lots of work being done on that from different directions, much of it funded by OpenDreamKit.",
    "created_at": "2018-03-12T15:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340925",
    "user": "embray"
}
```

Replying to [comment:118 charpent]:
> This ticket is probably not the right place to discuss it ; however, I think it should be opened on sage-devel.
> 
> Opinions ? Advice ?

While I agree with you 100% this is not a new discussion, nor does a discussion really need to be opened on sage-devel (been there done that).  There is already lots of work being done on that from different directions, much of it funded by OpenDreamKit.



---

archive/issue_comments_340926.json:
```json
{
    "body": "Replying to [comment:122 vdelecroix]:\n> Replying to [comment:112 embray]:\n> > Replying to [comment:100 vdelecroix]:\n> > > [EDITED]\n> > > \n> > > At commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)\n> > > \n> > > - without anything new in `spkg-check` I end up with the same libguile buisness\n> > > - with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).\n> > \n> > I didn't get an opportunity to comment on this last night, but FYI you don't need to add `DLPATH_ADD=` to the `make install` call.  Just the first one that says `make verbose`.  That works for me, and the `make check` tests pass.\n> \n> Perhaps I misunderstood your suggestion but the following does not work on my computer\n> {{{#!diff\n> diff --git a/build/pkgs/flint/spkg-install b/build/pkgs/flint/spkg-install\n> index f6c185433f..29cdbee8f0 100644\n> --- a/build/pkgs/flint/spkg-install\n> +++ b/build/pkgs/flint/spkg-install\n> `@``@` -38,7 +38,7 `@``@` if [ $? -ne 0 ]; then\n>  fi\n>  \n>  echo \"Building FLINT shared library.\"\n> -$MAKE verbose\n> +$MAKE verbose DLPATH_ADD=\n>  if [ $? -ne 0 ]; then\n>      echo >&2 \"Error: Failed to build FLINT shared library.\"\n>      exit 1\n> }}}\n> The log of the command `sage -f flint` is [attachment:flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz\u200b].\n\nExactly this is all I needed for the build to work on arch.",
    "created_at": "2018-03-12T15:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340926",
    "user": "embray"
}
```

Replying to [comment:122 vdelecroix]:
> Replying to [comment:112 embray]:
> > Replying to [comment:100 vdelecroix]:
> > > [EDITED]
> > > 
> > > At commit `21442be` flint and arb do not pass their testsuite on my computer (when doing `$ sage -f -c flint` or same with `arb`/`deformation`)
> > > 
> > > - without anything new in `spkg-check` I end up with the same libguile buisness
> > > - with `DLPATH_ADD=` it ends with the tests failing to load `libflint`/`libarb`/`libdeformation` (as I guess they are not installed at the time the tests are run).
> > 
> > I didn't get an opportunity to comment on this last night, but FYI you don't need to add `DLPATH_ADD=` to the `make install` call.  Just the first one that says `make verbose`.  That works for me, and the `make check` tests pass.
> 
> Perhaps I misunderstood your suggestion but the following does not work on my computer
> {{{#!diff
> diff --git a/build/pkgs/flint/spkg-install b/build/pkgs/flint/spkg-install
> index f6c185433f..29cdbee8f0 100644
> --- a/build/pkgs/flint/spkg-install
> +++ b/build/pkgs/flint/spkg-install
> `@``@` -38,7 +38,7 `@``@` if [ $? -ne 0 ]; then
>  fi
>  
>  echo "Building FLINT shared library."
> -$MAKE verbose
> +$MAKE verbose DLPATH_ADD=
>  if [ $? -ne 0 ]; then
>      echo >&2 "Error: Failed to build FLINT shared library."
>      exit 1
> }}}
> The log of the command `sage -f flint` is [attachment:flint-2.5.2-check_with_DLPATH_ADD_empty_but_not_on_make_install.log.gz​].

Exactly this is all I needed for the build to work on arch.



---

archive/issue_comments_340927.json:
```json
{
    "body": "Do you actually need any of this, with the new beta merging #23700 ?\nI'm not saying that this branch is not needed, it's merely for understanding the root causes...",
    "created_at": "2018-03-12T15:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340927",
    "user": "@dimpase"
}
```

Do you actually need any of this, with the new beta merging #23700 ?
I'm not saying that this branch is not needed, it's merely for understanding the root causes...



---

archive/issue_comments_340928.json:
```json
{
    "body": "Replying to [comment:126 embray]:\n> Replying to [comment:122 vdelecroix]:\n> > Perhaps I misunderstood your suggestion but the following does not work on my computer\n> Exactly this is all I needed for the build to work on arch.\n\nScratch that--it's not working for me either.  I must have made a mistake when I last tested it (perhaps I forgot to ensure that the `gc` package was installed in sage first).  Now I am getting the same result.",
    "created_at": "2018-03-12T15:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340928",
    "user": "embray"
}
```

Replying to [comment:126 embray]:
> Replying to [comment:122 vdelecroix]:
> > Perhaps I misunderstood your suggestion but the following does not work on my computer
> Exactly this is all I needed for the build to work on arch.

Scratch that--it's not working for me either.  I must have made a mistake when I last tested it (perhaps I forgot to ensure that the `gc` package was installed in sage first).  Now I am getting the same result.



---

archive/issue_comments_340929.json:
```json
{
    "body": "This is going to conflict with #25035: Erik, Vincent, in which order do you think we should handle the two tickets?",
    "created_at": "2018-04-09T08:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340929",
    "user": "mmezzarobba"
}
```

This is going to conflict with #25035: Erik, Vincent, in which order do you think we should handle the two tickets?



---

archive/issue_comments_340930.json:
```json
{
    "body": "I don't have a strong preference. If there is a conflict I can resolve it later.",
    "created_at": "2018-04-09T08:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340930",
    "user": "embray"
}
```

I don't have a strong preference. If there is a conflict I can resolve it later.



---

archive/issue_comments_340931.json:
```json
{
    "body": "Let's finish this ticket by removing the unnecessary `sdh_preload_lib` from the packages with FLINT-like build systems.",
    "created_at": "2018-04-15T11:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340931",
    "user": "mkoeppe"
}
```

Let's finish this ticket by removing the unnecessary `sdh_preload_lib` from the packages with FLINT-like build systems.



---

archive/issue_comments_340932.json:
```json
{
    "body": "I have created a follow-up ticket for a solution without the `sdh_preload_lib` with R (and rpy2) at #25170.",
    "created_at": "2018-04-15T12:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340932",
    "user": "mkoeppe"
}
```

I have created a follow-up ticket for a solution without the `sdh_preload_lib` with R (and rpy2) at #25170.



---

archive/issue_comments_340933.json:
```json
{
    "body": "By the way, #24919 provides a prototype for an easy to use (I think) generic mechanism for adding `configure`-time checks for system packages to use in favor of building copies of those packages for sage (just as we currently do for packages like gcc, curl, etc...).\n\nIn the long-term the best solution to this particular issue would be for Sage to not be installing its own libgc unless it absolute has to (which for a modern Arch Linux where this problem is occurring, it probably wouldn't have to, though that also might depend on whether or not one has the develop package installed).  We could also maybe enable header-only installs of some packages.\n\nI'll experiment with adding a configure-time check for libgc on top of #24919.",
    "created_at": "2018-04-18T10:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340933",
    "user": "embray"
}
```

By the way, #24919 provides a prototype for an easy to use (I think) generic mechanism for adding `configure`-time checks for system packages to use in favor of building copies of those packages for sage (just as we currently do for packages like gcc, curl, etc...).

In the long-term the best solution to this particular issue would be for Sage to not be installing its own libgc unless it absolute has to (which for a modern Arch Linux where this problem is occurring, it probably wouldn't have to, though that also might depend on whether or not one has the develop package installed).  We could also maybe enable header-only installs of some packages.

I'll experiment with adding a configure-time check for libgc on top of #24919.



---

archive/issue_comments_340934.json:
```json
{
    "body": "Replying to [comment:133 embray]:\n> By the way, #24919 provides a prototype for an easy to use (I think) generic mechanism for adding `configure`-time checks for system packages to use in favor of building copies of those packages for sage (just as we currently do for packages like gcc, curl, etc...).\n\nNice!",
    "created_at": "2018-05-01T12:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340934",
    "user": "vdelecroix"
}
```

Replying to [comment:133 embray]:
> By the way, #24919 provides a prototype for an easy to use (I think) generic mechanism for adding `configure`-time checks for system packages to use in favor of building copies of those packages for sage (just as we currently do for packages like gcc, curl, etc...).

Nice!



---

archive/issue_comments_340935.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-30T17:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24338",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24338#issuecomment-340935",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.
