# Issue 10699: Speedup of  matrix multiplication

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2011-02-09 17:53:58

Assignee: jason, was

Keywords: matrix multiplication

When multiplying two matrices M and N, typically one first creates a zero matrix of an appropriate matrix space. That means:

 * Call `M.matrix_space(...)`.
 * This calls `M.parent().matrix_space(...)`.
 * This calls `MatrixSpace(...)`.
 * This tests, whether the base ring really is a ring and whether the matrix space is already in the cache.

This can obviously be improved:

 * `M.matrix_space(...)` should avoid the overhead of calling `M.parent()` but create the matrix space directly.
 * It is already known that the base ring is a ring. So, there is no need to test it.
 * One may access the cache directly, thus, avoid the overhead of calling `MatrixSpace`.

I guess the ticket belongs to linear algebra. Correct me if I'm wrong.



---

Comment by SimonKing created at 2011-02-09 18:23:32

Changing status from new to needs_review.


---

Comment by SimonKing created at 2011-02-09 18:23:32

I did not run the doc test yet, but I think it already ready for review.

Here are timings. Note that the reduced overhead is most visible when the multiplication itself is trivial.

Without the patch:

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....:
sage: m = matrix(GF(3),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 51.36 s, sys: 0.16 s, total: 51.52 s
Wall time: 51.67 s
[1]
sage: m = matrix(GF(2),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 39.16 s, sys: 0.20 s, total: 39.36 s
Wall time: 39.47 s
[1]
sage: m = matrix(ZZ,[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
# apparently there is no overhead for matrices over ZZ
sage: %time test(m)
CPU times: user 7.81 s, sys: 0.15 s, total: 7.96 s
Wall time: 7.99 s
[1]
```


With the patch

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....:
sage: m = matrix(GF(3),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 33.65 s, sys: 0.30 s, total: 33.95 s
Wall time: 34.05 s
[1]
sage: m = matrix(GF(2),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 25.41 s, sys: 0.10 s, total: 25.51 s
Wall time: 25.58 s
[1]
sage: m = matrix(ZZ,[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 7.62 s, sys: 0.16 s, total: 7.78 s
Wall time: 7.80 s
[1]
```


Thus, over `GF(3)` and `GF(2)` the overhead is clearly reduced.

I don't know how the patch could be doc-tested, as it only concerns the performance.


---

Comment by SimonKing created at 2011-02-10 08:59:49

Apparently the small change led to some problems. So, it needs work.


---

Comment by SimonKing created at 2011-02-10 08:59:49

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2011-02-10 09:18:30

The problem was that the matrix spaces are cached with weak references. It could happen that the key was still available, but `_cache[key]` was a reference to `None`. So, in the updated patch I am not simply trying to return `_cache[key]()` but I first test if it is not None.

Back to "needs review"...


---

Comment by SimonKing created at 2011-02-10 09:18:30

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2011-02-10 09:21:18

PS:

The timings with the new patch are

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....: 
sage: m = matrix(GF(3),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 37.70 s, sys: 0.18 s, total: 37.89 s
Wall time: 38.00 s
[1]
sage: m = matrix(GF(2),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 27.09 s, sys: 0.17 s, total: 27.26 s
Wall time: 27.34 s
[1]
```


That's still a lot faster than without patch.


---

Comment by SimonKing created at 2011-02-11 07:33:43

I updated the patch, so that it cleanly applies to `sage-4.6.2.alpha4`.


---

Comment by rbeezer created at 2011-02-15 05:03:39

I ran tests in sage/matrix and got failures in matrix_mod2_dense.pyx and matrix2.pyx.  Mostly complaints about improper dimensions it seems.  The mod2 code appears to have some internal checks that are triggered even before the test itself fails.


---

Comment by SimonKing created at 2011-02-15 07:25:56

Replying to [comment:6 rbeezer]:
> I ran tests in sage/matrix and got failures in matrix_mod2_dense.pyx and matrix2.pyx.  Mostly complaints about improper dimensions it seems.  The mod2 code appears to have some internal checks that are triggered even before the test itself fails.

Thank you! As I wrote when I posted my patch, I hadn't run the tests, and then I was working on different tickets. Now I'll try to hunt it down.


---

Comment by SimonKing created at 2011-02-15 07:25:56

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2011-02-15 07:52:35

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2011-02-15 07:52:35

The test failures were caused by a very stupid mistake: `self.new_matrix()` by default assumes that the dimension of the new matrix is the same as the dimension of the old matrix. In the multiplication algorithms, I saw `self.new_matrix(nrows=self.nrows(),...)`, was not reading further, and thought that we are in the default case, thus, deleted the arguments.

Of course, it continues "(..., ncols=right.ncols())`.

What I did now was to avoid calling `self.nrows()` and `right.ncols()` - direct access to the attributes `self._nrows` and `right._ncols` is faster.

To my surprise, the timings improved a little more:

```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....: 
sage: m = matrix(GF(3),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 36.67 s, sys: 0.16 s, total: 36.83 s
Wall time: 36.95 s
[1]
sage: m = matrix(GF(2),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 26.29 s, sys: 0.14 s, total: 26.43 s
Wall time: 26.50 s
[1]
```


Is it faster to provide arguments with a default value _explicitly_?

The tests for `sage/matrix/` passed. I am now running all doctests (not the long ones), but I think I can already revert it to "needs review".


---

Comment by SimonKing created at 2011-02-16 10:22:35

I was updating the patch again. I am now also taking more care of sparse matrices, and I found yet another spot where overhead by calling methods could be reduced.

*__Updated timings in sage.4.6.2.alpha4__*


```
sage: def test(M):
....:     for i in xrange(10^6):
....:         M*=M
....:     return M
....: 
sage: MS = MatrixSpace(GF(5),5,5,sparse=True)
sage: ms = MS([3, 1, 0, 0, 4, 1, 2, 2, 3, 4, 2, 4, 1, 0, 3, 4, 3, 1, 2, 4, 0, 0, 0, 1, 3])
sage: MD = MatrixSpace(GF(5),5,5,sparse=False)
sage: md = MD([3, 1, 0, 0, 4, 1, 2, 2, 3, 4, 2, 4, 1, 0, 3, 4, 3, 1, 2, 4, 0, 0, 0, 1, 3])
```


Without patch:

```
sage: %time test(ms)
CPU times: user 42.41 s, sys: 0.01 s, total: 42.43 s
Wall time: 42.57 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
sage: %time test(md)
CPU times: user 53.54 s, sys: 0.20 s, total: 53.74 s
Wall time: 53.90 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
```


With patch:

```
sage: %time test(ms)
CPU times: user 29.72 s, sys: 0.03 s, total: 29.75 s
Wall time: 29.84 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
sage: %time test(md)
CPU times: user 34.13 s, sys: 0.36 s, total: 34.49 s
Wall time: 34.59 s
[1 2 4 4 3]
[3 1 2 1 3]
[1 2 2 3 1]
[2 4 0 4 4]
[2 4 2 1 3]
```


Or, with the (dense) examples that I used in the previous posts:

```
sage: m = matrix(GF(2),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 22.87 s, sys: 0.12 s, total: 22.99 s
Wall time: 23.06 s
[1]
sage: m = matrix(GF(3),[This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro))
sage: %time test(m)
CPU times: user 33.31 s, sys: 0.12 s, total: 33.43 s
Wall time: 33.52 s
[1]
```


So, the progress is clear.

I am now running doc tests (there was no problem for the previous patch), but I think it is safe to keep it "needs review".


---

Comment by SimonKing created at 2011-02-16 12:56:08

PS: Long tests in devel/sage/sage and devel/sage/doc pass without error. The error that the patchbot reports is the usual error in startup.py and seems independent of my patch.


---

Comment by rbeezer created at 2011-02-21 20:56:45

Changing status from needs_review to needs_info.


---

Comment by rbeezer created at 2011-02-21 20:56:45

Simon,

Looks real good.  One suggestion - and it really is _just_ a suggestion.  Your call.

Two instances of basically:


```
try:
    from sage.matrix.matrix_space import _cache
    MS = _cache[base_ring, nrows, ncols, sparse]()
except KeyError:
    return MatrixSpace(base_ring, nrows, ncols, sparse)
if MS is not None:
    return MS
return MatrixSpace(base_ring, nrows, ncols, sparse)
```


and a suggested replacement:


```
try:
    from sage.matrix.matrix_space import _cache
    MS = _cache[base_ring, nrows, ncols, sparse]()
except KeyError:
    MS = None
if MS is None:
    return MatrixSpace(base_ring, nrows, ncols, sparse)
else:
    return MS
```


Suggestion uses try/except to form "best guess" for `MS`.  Either we find it, or we get `None`.  Then if/else returns it, or creates it and returns it.

An extra line, an extra comparison in one case, but the `not` is gone and most importantly, just one place to describe the actual `MatrixSpace` call (instead of two that are identical).  Anyway, a toss-up, I'd guess, so just a suggestion.

In the meantime, I am going to run the full test suite right now.

Rob


---

Comment by rbeezer created at 2011-02-22 01:37:18

Passed all long tests.  So, other than my suggestion above, this looks ready to go.


---

Comment by SimonKing created at 2011-02-26 13:21:01

Replying to [comment:12 rbeezer]:
> Passed all long tests.  So, other than my suggestion above, this looks ready to go.

Can you turn your suggestion into a referee patch? I wouldn't object to the change.

Cheers,

Simon


---

Comment by SimonKing created at 2011-02-26 13:21:01

Changing status from needs_info to needs_review.


---

Attachment


---

Comment by rbeezer created at 2011-02-27 17:22:13

Replying to [comment:13 SimonKing]:
> Can you turn your suggestion into a referee patch? I wouldn't object to the change.

Done and attached. Passes all long tests with the change.  When you are satisfied with my changes, go ahead and flip this to "positive review" - everything looks good on my end.

Thanks for the speed increase!

Rob


---

Comment by SimonKing created at 2011-02-27 18:09:23

Hi Rob,

Replying to [comment:14 rbeezer]:
> Replying to [comment:13 SimonKing]:
> > Can you turn your suggestion into a referee patch? I wouldn't object to the change.
> 
> Done and attached. Passes all long tests with the change.  When you are satisfied with my changes, go ahead and flip this to "positive review" 

Done, adding your name in the "Reviewer" field.

> Thanks for the speed increase!

You're welcome! After all, the speed increase was in my own interest.

Cheers,

Simon


---

Comment by SimonKing created at 2011-02-27 18:09:23

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-03-16 11:31:35

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-03-16 11:31:35

The commit message of the patch should be broken up in multiple lines instead of one long line.  The first line should stand by itself and must mention the ticket number, a more detailed message can come on following lines.  Use `hg qrefresh -e` to change the commit message.


---

Attachment

Improve performance of matrix multiplication by using a shortpath to matrix spaces and a shortpath in multiplication algorithms for creating a zero matrix


---

Comment by SimonKing created at 2011-03-16 11:50:57

Changing status from needs_work to positive_review.


---

Comment by SimonKing created at 2011-03-16 11:50:57

Replying to [comment:17 jdemeyer]:
> The commit message of the patch should be broken up in multiple lines instead of one long line.  The first line should stand by itself and must mention the ticket number, a more detailed message can come on following lines.  Use `hg qrefresh -e` to change the commit message.

Both patches _did_ mention the ticket number, and I think it is questionable whether the message of my original patch was to long. Anyway, I just replaced it, and I hope you'll find that it is fine.


---

Comment by jdemeyer created at 2011-03-16 18:47:01

Replying to [comment:18 SimonKing]:
> I think it is questionable whether the message of my original patch was to long.

Just to clarify: the message itself was _not_ too long, the problem was that the whole message was one long line without newlines.  It should be wrapped to multiple lines instead (as you did in this case).


---

Comment by jdemeyer created at 2011-03-17 19:23:17

Resolution: fixed
