# Issue 15196: Port to OSX 10.9

Issue created by migration from https://trac.sagemath.org/ticket/15433

Original creator: ohanar

Original creation time: 2013-11-18 07:50:05

CC:  yomcat jhpalmieri

Sage fails to build on OSX 10.9.

Issues:

1. scipy doesn't play nicely with the new accelerate framework headers
1. R depends on CoreData which uses non-standard sqlite3 modules (and this affects us since we set `*_LIBRARY_PATH` and install a custom copy of sqlite3)
1. g++ and 10.9's cdefs.h header are currently incompatible, leading to a broken libstc++
1. accelerate framework no longer pretends to be atlas for linking purposes
1. polybori


---

Comment by ohanar created at 2013-11-18 08:00:00

The attached branch should fix everything except for the polybori issue. This should be checked on older OSX versions, since I've made some changes that are not 10.9 specific (I've checked these changes against bsd.math, and they work fine there).

As for the polybori issue, I'm not experiencing it anymore and I don't know what fixed it for me. I was going to setup a 10.9 VM, but unfortunately Apple refuses to let me download 10.9 on the machine I'm currently using -- however, I should be able to get a copy sometime in the few days.

I will update spkgs/add mercurial patches if we can fix this in time for 5.13, but for now it is much easier for me to work off of the git version.


---

Comment by vbraun created at 2013-11-18 15:57:03

I'm getting the following:

```
$ make
cd build && \
"../build/pipestatus" \
	"env SAGE_PARALLEL_SPKG_BUILD='' ./install all 2>&1" \
	"tee -a ../logs/install.log"
./install: line 503: syntax error near unexpected token `then'
./install: line 503: `if { uname -sr | grep 'Darwin' } &>/dev/null; then'
make: *** [build] Error 2

$ uname -sr
Linux 3.11.7-200.fc19.x86_64
```



---

Comment by git created at 2013-11-18 18:03:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2013-11-19 00:47:00

Here's a stupid git question: what command do I give to check out this branch? I mean, if I'm on an OS X Mavericks system and I don't have a working copy of Sage with the git devel tools, I can't just do `./sage -dev …`, but there must be some git command using the branch name or something. So what is it?


---

Comment by jhpalmieri created at 2013-11-19 01:03:33

My guess about polybori, by the way, is that it was fixed by the changes to gcc.


---

Comment by ohanar created at 2013-11-19 01:40:46

Replying to [comment:6 jhpalmieri]:
> Here's a stupid git question: what command do I give to check out this branch?

Assuming you have git installed and in your path, you can do

```
$ git clone git://trac.sagemath.org/sage.git -b u/ohanar/10.9-port
```

to make a clone of the git repository, or if you already have a clone, you can do 

```
$ git fetch git://trac.sagemath.org/sage.git u/ohanar/10.9-port
$ git checkout -b u/ohanar/10.9-port FETCH_HEAD
```

from within the repository.


---

Comment by zabrocki created at 2013-11-19 13:47:13

How do I resolve this problem?

```
sh: line 1: 59700 Trace/BPT trap: 5       /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -sdk / -find ar 2> /dev/null
ar: error: unable to find utility "ar", not a developer tool or in PATH
make[3]: *** [libsymmetrica.a] Error 72
make[3]: Target `all' not remade because of errors.
Error building Symmetrica.
```

because I do see

```
-bash:/Applications/sage-5.13.beta1 $ /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild -sdk / -find ar
/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ar
-bash:/Applications/sage-5.13.beta1 $ echo $PATH
.:/usr/bin:/bin:/usr/sbin
```



---

Comment by ohanar created at 2013-11-19 17:37:09

Replying to [comment:9 zabrocki]:
> How do I resolve this problem?
Looks like more or less the same problem as polybori. That said, symmetrica was updated in 5.13.beta2, so you may want to see if you still experience the issue with a more recent beta.


---

Comment by jhpalmieri created at 2013-11-19 18:24:55

I don't know how the new build system works, but if you modify a file like `build/pkgs/gcc/spkg-install`, for example, should you also modify `build/pkgs/gcc/package-version.txt` so that the new version gets built? I have a version of Sage/git from early October, and when I cloned this branch and ran `make`, gcc was not rebuilt — it didn't even try, the log file was not modified — while scipy, for example, just returned the message `Package scipy-0.12.0.p0 is already installed.`

Building the whole thing from scratch worked well, though, and all tests passed.

Regarding the patch to gcc/spkg-install, for consistency's sake among other things, would it be a good idea to check the OS X version number the same way it's done in prereqs? That is, `DARWIN_VERSION=`uname -r | cut '-d.' -f1``?


---

Comment by zabrocki created at 2013-11-19 18:37:38

The directory name is `sage-5.13.beta1` is probably misleading since it is the name of the 'git' copy of sage.  I did a checkout of the branch and it stops at the end of the compile of symmetrica with a `make -k`.  If I just run `make` I don't get as far.


---

Comment by ohanar created at 2013-11-19 18:42:45

I agree that gcc should have a patch version bump, but I don't think that scipy should: scipy issue is purely a build-time issue, unlike gcc's.

For `gcc/spkg-install` I just tried to be consistent with what was already there.


---

Comment by git created at 2013-11-19 18:43:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2013-11-19 23:08:20

Changing status from new to needs_review.


---

Comment by ohanar created at 2013-11-19 23:08:20

jhpalmieri:
the change to gcc resolved the polybori and symmetrica issues on my second machine as well

zabrocki:
try rebuilding with the latest commit


I'm marking this as needs review, although if someone could test on OSX 10.4, that would be great.


---

Comment by yomcat created at 2013-11-19 23:41:56

No issues at all building on 10.9 for me -- all test passed.


---

Comment by zabrocki created at 2013-11-20 01:04:34

Andrew, you saved me again!  Brilliant!  It worked for me too.  Successful build and all tests pass.  I had only to `make all` because files compiled pre-fix were messing things up (or instead, I just untar'ed another copy and compiled that version).


---

Comment by git created at 2013-11-21 03:08:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2013-11-23 10:45:54

Random remark: I would have put the logic for installing or not sqlite3 in the spkg-install script of sqlite3,  just as we do for cephes for example.


---

Comment by jhpalmieri created at 2013-11-23 16:21:43

Replying to [comment:19 jpflori]:
> Random remark: I would have put the logic for installing or not sqlite3 in the spkg-install script of sqlite3,  just as we do for cephes for example.

Atlas also. That makes sense to me.


---

Comment by git created at 2013-11-24 02:49:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2013-11-24 03:29:32

Now you also need to change the instructions in `src/bin/sage` about running `sage -i sqlite3`: that will have no effect on OS X. Note also that sqlite3 appears twice, once in `usage` and once in `usage_advanced`. Maybe

```diff
diff --git a/src/bin/sage b/src/bin/sage
index 7eca9b0..df51f76 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -25,6 +25,7 @@ usage() {
     echo "  -python [...]       -- run the Python interpreter"
     echo "  -R [...]            -- run Sage's R with given arguments"
     echo "  -singular [...]     -- run Sage's singular with given arguments"
+    test -x "$SAGE_LOCAL/bin/sqlite3" || \
     echo "  -sqlite3 [...]      -- run Sage's sqlite3 with given arguments"
     echo "  -root               -- print the Sage root directory"
     echo "  --nodotsage         -- run Sage without using the user's .sage directory:"
@@ -102,9 +103,8 @@ usage_advanced() {
     echo "  -scons [...]        -- run Sage's scons"
     echo "  -sh [...]           -- run \$SHELL ($SHELL) with Sage environment variables"
     echo "  -singular [...]     -- run Sage's singular with given arguments"
-    echo "  -sqlite3 [...]      -- run Sage's sqlite3 with given arguments"
     test -x "$SAGE_LOCAL/bin/sqlite3" || \
-    echo "                         (not installed currently, run sage -i sqlite3)"
+    echo "  -sqlite3 [...]      -- run Sage's sqlite3 with given arguments"
     echo "  -twistd [...]       -- run Twisted server"
 
     echo
```

Or you could do

```diff
diff --git a/src/bin/sage b/src/bin/sage
index 7eca9b0..5be445b 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -26,6 +26,8 @@ usage() {
     echo "  -R [...]            -- run Sage's R with given arguments"
     echo "  -singular [...]     -- run Sage's singular with given arguments"
     echo "  -sqlite3 [...]      -- run Sage's sqlite3 with given arguments"
+    test -x "$SAGE_LOCAL/bin/sqlite3" || \
+    echo "                         (NOTE: not installed on OS X)"
     echo "  -root               -- print the Sage root directory"
     echo "  --nodotsage         -- run Sage without using the user's .sage directory:"
     echo "                         create and use a temporary .sage directory instead"
@@ -104,7 +106,7 @@ usage_advanced() {
     echo "  -singular [...]     -- run Sage's singular with given arguments"
     echo "  -sqlite3 [...]      -- run Sage's sqlite3 with given arguments"
     test -x "$SAGE_LOCAL/bin/sqlite3" || \
-    echo "                         (not installed currently, run sage -i sqlite3)"
+    echo "                         (NOTE: not installed on OS X)"
     echo "  -twistd [...]       -- run Twisted server"
 
     echo
```



---

Comment by git created at 2013-11-24 05:03:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2013-11-26 19:16:12

Would it be a good idea on OS X to create a symlink at `local/bin/sqlite3` pointing to `/usr/bin/sqlite3` (or whatever the output of `command -v sqlite3` is)? Then `sage --sqlite3` would still work.


---

Comment by was created at 2013-11-26 19:18:43

Replying to [comment:24 jhpalmieri]:
> Would it be a good idea on OS X to create a symlink at `local/bin/sqlite3` pointing to `/usr/bin/sqlite3` (or whatever the output of `command -v sqlite3` is)? Then `sage --sqlite3` would still work.

See trac #12627 which would fix this.


---

Comment by jhpalmieri created at 2013-11-26 19:26:57

As I noted at #12627, that ticket is somewhat controversial, and I'm not sure it's a good idea to get it merged soon. Something much more targeted, like making a symlink for sqlite3 only on OS X, seems more palatable.


---

Comment by was created at 2013-11-26 19:28:52

REMARKS:

* In build/pkgs/gcc/spkg-install and build/pkgs/sqlite/spkg-install ¶, change "OSX 10.9" to "OS X 10.9".   Also "posed" --> "posted".

* If trac #12627 gets in (which it should if rebased), then this would be deleted:

```
 if test -x "$SAGE_LOCAL/bin/sqlite3" && [ "$1" = '-sqlite3' -o "$1" = '--sqlite3' ]; then 
```


I am for having #12627 merged, since I can easily imagine users, scripts, workflows, whatever that have "sage --sqlite3" in them, and would be broken by the above change.

Modulo testing (on 10.4, 10.5, 10.6, 10.7, 10.8, 10.9), and the above comment regarding #12627, I think this patch looks excellent.


---

Comment by was created at 2013-11-26 19:32:45

Replying to [comment:26 jhpalmieri]:
> As I noted at #12627, that ticket is somewhat controversial, and I'm not sure it's a good idea to get it merged soon. Something much more targeted, like making a symlink for sqlite3 only on OS X, seems more palatable.

OK, good point -- symlinking temporarily seems reasonable, since fully supporting OS X 10.9 asap is important.


---

Comment by git created at 2013-11-26 19:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2013-11-26 19:49:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by ohanar created at 2013-11-27 06:50:14

Ok, since this seems to be all but positively reviewed now, I've backported this to mercurial land.


---

Comment by jpflori created at 2013-11-27 09:59:00

I've had a quick look at the git branch and it seems fine.
Could you please attach the spkg diffs to ease review?


---

Attachment

for review purposes


---

Comment by ohanar created at 2013-11-27 19:52:13

for review purposes


---

Attachment

Replying to [comment:32 jpflori]:
> I've had a quick look at the git branch and it seems fine.
> Could you please attach the spkg diffs to ease review?
Done.


---

Comment by vbraun created at 2013-11-28 21:22:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-11-28 21:22:32

I've tested it on the buildbot and it doesn't impact other arches. Presumably it does the trick on OSX 10.9, so we should ship it asap.


---

Comment by yomcat created at 2013-11-28 21:27:42

Replying to [comment:34 vbraun]:
> Presumably it does the trick on OSX 10.9, so we should ship it asap.
I can confirm that it does indeed do the trick on Mavericks.


---

Comment by jdemeyer created at 2013-12-04 17:29:05

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-12-04 17:29:05

When upgrading from older versions of Sage on OS X:

```
sage -t --long devel/sage/sage/tests/cmdline.py
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 595, in sage.tests.cmdline.test_executable
Failed example:
    out.startswith("3.")
Expected:
    True
Got:
    False
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 597, in sage.tests.cmdline.test_executable
Failed example:
    err
Expected:
    ''
Got:
    'dyld: Library not loaded: /Users/buildbot/build/sage/bsd-1/bsd_64_upgrade/sage-4.6.2/local/lib/libreadline.6.1.dylib\n  Referenced from: /Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.13.rc0/local/bin/sqlite3\n  Reason: image not found\n'
**********************************************************************
File "devel/sage/sage/tests/cmdline.py", line 599, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    -5
**********************************************************************
```



---

Comment by jdemeyer created at 2013-12-04 17:35:22

Does the sqlite3 issue appear also on OS X < 10.9 systems? If not, then can we keep building sqlite3 on those systems and only skip it for OS X 10.9?


---

Comment by jdemeyer created at 2013-12-05 08:26:21

Changing priority from major to blocker.


---

Comment by ohanar created at 2013-12-05 08:41:42

Replying to [comment:37 jdemeyer]:
> Does the sqlite3 issue appear also on OS X < 10.9 systems? If not, then can we keep building sqlite3 on those systems and only skip it for OS X 10.9?

I don't think so, although only doing it for >= 10.9 seems dangerous as I could easily see apple changing one of their libraries that r uses in a minor update.


---

Comment by jdemeyer created at 2013-12-05 09:00:40

Or we could check whether `sqlite` already exists and is not a symbolic link:

```
if [ -x "$SAGE_LOCAL/bin/sqlite3" -a ! -h "$SAGE_LOCAL/bin/sqlite3" ]; then
    # Install sqlite3 anyway
fi
```



---

Comment by ohanar created at 2013-12-06 04:14:31

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2013-12-06 04:14:31

ok, updated the sqlite spkg, it should now gracefully handle upgrading.


---

Comment by jdemeyer created at 2013-12-06 10:39:32

Looks good on first sight, I will test it on the buildbots and set positive_review if that works.


---

Comment by jdemeyer created at 2013-12-06 23:07:31

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-12-06 23:07:31

On OS X 10.4, this causes essentially every doctest involving databases to fail, for example

```
sage -t --long devel/sage/doc/en/tutorial/tour_advanced.rst
**********************************************************************
File "devel/sage/doc/en/tutorial/tour_advanced.rst", line 251, in doc.en.tutorial.tour_advanced
Failed example:
    db.curves(37)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.13.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 479, in _run
        self.execute(example, compiled, test.globs)
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.13.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 838, in execute
        exec compiled in globs
      File "<doctest doc.en.tutorial.tour_advanced[1]>", line 1, in <module>
        db.curves(Integer(37))
      File "/Users/buildbot/build/sage/moufang-1/moufang_full/build/sage-5.13.rc0/local/lib/python2.7/site-packages/sage/databases/cremona.py", line 769, in curves
        + 'curve=class||1 AND conductor=?',(int(N),)):
    OperationalError: ambiguous column name: class
**********************************************************************
```



---

Comment by jhpalmieri created at 2013-12-06 23:24:07

So maybe we _should_ only use the system sqlite3 on OS X 10.9 and above?


---

Comment by ohanar created at 2013-12-08 01:35:11

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2013-12-08 01:35:11

Ok, I've modified the spkg so it only uses the system sqlite on 10.9 and above


---

Comment by jdemeyer created at 2013-12-08 08:46:41

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-12-08 08:46:41

You probably didn't mean to remove

```
# Old OS X systems need -DSQLITE_WITHOUT_ZONEMALLOC
if uname -sr |grep 'Darwin [0-8][.]' >/dev/null; then
    export CPPFLAGS="$CPPFLAGS -DSQLITE_WITHOUT_ZONEMALLOC"
fi
```



---

Comment by jdemeyer created at 2013-12-09 10:02:41

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by ohanar created at 2013-12-09 23:31:12

Sorry, busy week. Yes, this looks fine to me.


---

Comment by ohanar created at 2013-12-09 23:31:12

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-12-11 11:02:31

Resolution: fixed


---

Comment by leif created at 2014-05-13 11:37:05

* *Status* changed from _closed_ to _needs_work_

For the record, according to [http://trac.macports.org/ticket/41033#comment:24](http://trac.macports.org/ticket/41033#comment:24), the `cdefs.h` bug has been fixed in Xcode 5.1.

Furthermore, there's no check whether the file exists at all, and `set -e` is used...


---

Comment by vbraun created at 2014-05-13 12:02:34

cdefs.h should be part of the commandline tools. The only bug is that we don't diagnose the absence of the command line tools in a better way. Also, this ticket is closed. Open a new one.


---

Comment by leif created at 2014-05-13 12:17:54

Replying to [comment:51 vbraun]:
> cdefs.h should be part of the commandline tools. The only bug is that we don't diagnose the absence of the command line tools in a better way.

Yeah, and it probably should be checked whether the fix is still necessary.

> Also, this ticket is closed.

Really?

> Open a new one. 

Selber.


---

Comment by leif created at 2014-05-13 12:19:59

P.S.:  The top-level `configure` should check for the presence of Xcode's command line tools on Darwin, shouldn't it?
