# Issue 24191: Substitution should be the same as numerical evaluation

archive/issues_024191.json:
```json
{
    "body": "CC:  rws slelievre\n\nIt is very surprising that these do not give the same result:\n\n```\nsage: arccosh(0.9)\nNaN\n```\n\nand\n\n```\nsage: arccosh(x).subs(x=0.9)\n0.451026811796262*I\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24428\n\n",
    "created_at": "2017-12-25T09:58:04Z",
    "labels": [
        "symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Substitution should be the same as numerical evaluation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24191",
    "user": "jdemeyer"
}
```
CC:  rws slelievre

It is very surprising that these do not give the same result:

```
sage: arccosh(0.9)
NaN
```

and

```
sage: arccosh(x).subs(x=0.9)
0.451026811796262*I
```


Issue created by migration from https://trac.sagemath.org/ticket/24428





---

archive/issue_comments_338855.json:
```json
{
    "body": "I'm not decided on which result is correct. But see also #15344.",
    "created_at": "2017-12-25T13:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338855",
    "user": "rws"
}
```

I'm not decided on which result is correct. But see also #15344.



---

archive/issue_comments_338856.json:
```json
{
    "body": "> so the first should probably return a complex number too\n\nThis would mean either 1. changing general evaluation of `f(arg)` to not try `arg.f()` first or, 2. changing the interface to `mpfr_acosh()` (which is responsible for the NaN), i.e. `RR.arccosh()`, and some others too.\n\nI'm in favor of the latter.",
    "created_at": "2017-12-26T06:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338856",
    "user": "rws"
}
```

> so the first should probably return a complex number too

This would mean either 1. changing general evaluation of `f(arg)` to not try `arg.f()` first or, 2. changing the interface to `mpfr_acosh()` (which is responsible for the NaN), i.e. `RR.arccosh()`, and some others too.

I'm in favor of the latter.



---

archive/issue_comments_338857.json:
```json
{
    "body": "Note that `RBF(0.9).arccosh()` returns nan as well.",
    "created_at": "2017-12-26T06:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338857",
    "user": "rws"
}
```

Note that `RBF(0.9).arccosh()` returns nan as well.



---

archive/issue_comments_338858.json:
```json
{
    "body": "Does an expression in `SR` (like `acosh`) come with a notion of domain and codomain?",
    "created_at": "2017-12-26T07:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338858",
    "user": "mantepse"
}
```

Does an expression in `SR` (like `acosh`) come with a notion of domain and codomain?



---

archive/issue_comments_338859.json:
```json
{
    "body": "Symbolic function expressions have internal restrictions as to their arguments but there is no information associated regarding domains. The function code in `sage/functions` and in Pynac raises stock Python exceptions and runtime errors if nonsensical arguments are encountered, but just yesterday I wished I could catch them specifically, e.g. by inheriting from domain error---it would enable much better random testing.",
    "created_at": "2017-12-26T08:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338859",
    "user": "rws"
}
```

Symbolic function expressions have internal restrictions as to their arguments but there is no information associated regarding domains. The function code in `sage/functions` and in Pynac raises stock Python exceptions and runtime errors if nonsensical arguments are encountered, but just yesterday I wished I could catch them specifically, e.g. by inheriting from domain error---it would enable much better random testing.



---

archive/issue_comments_338860.json:
```json
{
    "body": "It might be important to note that this is a regression:\n\n```\nsage: arccosh(0.9)\nNaN\nsage: arccosh(x).subs(x=0.9)\nNaN\nsage: version()\n'SageMath version 8.1.beta5, Release Date: 2017-09-11'\n```\n",
    "created_at": "2017-12-26T19:14:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338860",
    "user": "mantepse"
}
```

It might be important to note that this is a regression:

```
sage: arccosh(0.9)
NaN
sage: arccosh(x).subs(x=0.9)
NaN
sage: version()
'SageMath version 8.1.beta5, Release Date: 2017-09-11'
```




---

archive/issue_comments_338861.json:
```json
{
    "body": "in fact, the change must have been introduced in 8.2.beta1, because in 8.2.beta0 it still gives the expected result.",
    "created_at": "2017-12-27T07:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338861",
    "user": "mantepse"
}
```

in fact, the change must have been introduced in 8.2.beta1, because in 8.2.beta0 it still gives the expected result.



---

archive/issue_comments_338862.json:
```json
{
    "body": "That is no surprise as I changed FP evaluation in the commit https://github.com/pynac/pynac/commit/d0f66f94ab4564a9a43aaf5907f7ac2a90047890\n\nIt might not be a bug. Still, the necessity of being consistent demands some fix somewhere.",
    "created_at": "2017-12-27T07:43:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338862",
    "user": "rws"
}
```

That is no surprise as I changed FP evaluation in the commit https://github.com/pynac/pynac/commit/d0f66f94ab4564a9a43aaf5907f7ac2a90047890

It might not be a bug. Still, the necessity of being consistent demands some fix somewhere.



---

archive/issue_comments_338863.json:
```json
{
    "body": "For example\n\n```\nsage: arccos(1.1)\nNaN\nsage: arccos(x).subs(x=1.1)\nNaN\n```\n\n(EDITED)\n\nSo one of `arccos/arccosh` should be changed.",
    "created_at": "2017-12-27T07:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338863",
    "user": "rws"
}
```

For example

```
sage: arccos(1.1)
NaN
sage: arccos(x).subs(x=1.1)
NaN
```

(EDITED)

So one of `arccos/arccosh` should be changed.



---

archive/issue_comments_338864.json:
```json
{
    "body": "Changes in symbolics code are quite likely to produce doctest differences in the fricas interface, so it might make sense to make sure that these doctests are run.\n\nIn the case at hand, I guess it would be very important to specify domain and codomain of expressions which can be evaluated numerically, otherwise it will never be clear whether something is a bug or a feature.\n\nBesides, I think that `arccosh` is terrible language :-)",
    "created_at": "2017-12-27T08:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338864",
    "user": "mantepse"
}
```

Changes in symbolics code are quite likely to produce doctest differences in the fricas interface, so it might make sense to make sure that these doctests are run.

In the case at hand, I guess it would be very important to specify domain and codomain of expressions which can be evaluated numerically, otherwise it will never be clear whether something is a bug or a feature.

Besides, I think that `arccosh` is terrible language :-)



---

archive/issue_comments_338865.json:
```json
{
    "body": "Adding an example:\n\n```\nsage: arccosh(RDF(0.9))\n0.45102681179626236*I\n```\n",
    "created_at": "2018-02-19T21:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338865",
    "user": "slelievre"
}
```

Adding an example:

```
sage: arccosh(RDF(0.9))
0.45102681179626236*I
```




---

archive/issue_comments_338866.json:
```json
{
    "body": "I don't care what you do with the function `arccosh` but **all** of\n\n```\nsage: RR(0.9).arccosh()\nNaN\nsage: RBF(0.9).arccosh()\nnan\nsage: RIF(0.9).arccosh()\n[.. NaN ..]\n```\n\nmust not change.",
    "created_at": "2018-02-24T07:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338866",
    "user": "vdelecroix"
}
```

I don't care what you do with the function `arccosh` but **all** of

```
sage: RR(0.9).arccosh()
NaN
sage: RBF(0.9).arccosh()
nan
sage: RIF(0.9).arccosh()
[.. NaN ..]
```

must not change.



---

archive/issue_comments_338867.json:
```json
{
    "body": "With pynac-0.7.17:\n\n```\nsage: acos(SR(1.1))\n0.443568254385115*I\nsage: acosh(SR(0.9))\n0.451026811796262*I\nsage: acos(x).subs(x=1.1)\n0.443568254385115*I\nsage: acosh(x).subs(x=0.9)\n0.451026811796262*I\n```\n\n\nReplying to [comment:14 vdelecroix]:\n> I don't care what you do with the function `arccosh` but **all** of\n> {{{\n> sage: RR(0.9).arccosh()\n> NaN\n> sage: RBF(0.9).arccosh()\n> nan\n> sage: RIF(0.9).arccosh()\n> [.. NaN ..]\n> }}}\n> must not change.\n\nThat is however the reason for\n\n```\nsage: acos(1.1)\nNaN\n```\n\nand all the others because here (1.1).acos() is called first.",
    "created_at": "2018-02-24T07:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338867",
    "user": "rws"
}
```

With pynac-0.7.17:

```
sage: acos(SR(1.1))
0.443568254385115*I
sage: acosh(SR(0.9))
0.451026811796262*I
sage: acos(x).subs(x=1.1)
0.443568254385115*I
sage: acosh(x).subs(x=0.9)
0.451026811796262*I
```


Replying to [comment:14 vdelecroix]:
> I don't care what you do with the function `arccosh` but **all** of
> {{{
> sage: RR(0.9).arccosh()
> NaN
> sage: RBF(0.9).arccosh()
> nan
> sage: RIF(0.9).arccosh()
> [.. NaN ..]
> }}}
> must not change.

That is however the reason for

```
sage: acos(1.1)
NaN
```

and all the others because here (1.1).acos() is called first.



---

archive/issue_comments_338868.json:
```json
{
    "body": "Replying to [comment:12 slelievre]:\n> Adding an example:\n> {{{\n> sage: arccosh(RDF(0.9))\n> 0.45102681179626236*I\n> }}}\n\nNote that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.",
    "created_at": "2018-02-24T07:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338868",
    "user": "rws"
}
```

Replying to [comment:12 slelievre]:
> Adding an example:
> {{{
> sage: arccosh(RDF(0.9))
> 0.45102681179626236*I
> }}}

Note that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.



---

archive/issue_comments_338869.json:
```json
{
    "body": "Replying to [comment:16 rws]:\n> Replying to [comment:12 slelievre]:\n> > Adding an example:\n> > {{{\n> > sage: arccosh(RDF(0.9))\n> > 0.45102681179626236*I\n> > }}}\n> \n> Note that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.\n\nIn this situation you could just fallback to `acosh`\n\n```\nsage: RDF(0.9).acosh()\nNaN\n```\n",
    "created_at": "2018-02-24T07:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338869",
    "user": "vdelecroix"
}
```

Replying to [comment:16 rws]:
> Replying to [comment:12 slelievre]:
> > Adding an example:
> > {{{
> > sage: arccosh(RDF(0.9))
> > 0.45102681179626236*I
> > }}}
> 
> Note that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.

In this situation you could just fallback to `acosh`

```
sage: RDF(0.9).acosh()
NaN
```




---

archive/issue_comments_338870.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> > > {{{\n> > > sage: arccosh(RDF(0.9))\n> > > 0.45102681179626236*I\n> > > }}}\n> > \n> > Note that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.\n> \n> In this situation you could just fallback to `acosh`\n> {{{\n> sage: RDF(0.9).acosh()\n> NaN\n> }}}\n\nInstead of special casing I'd rather change the name of the inverse hyperbolic functions away from all the wrong `arc`s (arcus) to the `a`s and have `ar` (area) aliases which would be the correct prefix.\n\nMoreover, if I get a review on the change to always delegate to `_eval_()` (EDITED) if NaN is returned then I'd change that too.",
    "created_at": "2018-02-24T08:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338870",
    "user": "rws"
}
```

Replying to [comment:17 vdelecroix]:
> > > {{{
> > > sage: arccosh(RDF(0.9))
> > > 0.45102681179626236*I
> > > }}}
> > 
> > Note that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.
> 
> In this situation you could just fallback to `acosh`
> {{{
> sage: RDF(0.9).acosh()
> NaN
> }}}

Instead of special casing I'd rather change the name of the inverse hyperbolic functions away from all the wrong `arc`s (arcus) to the `a`s and have `ar` (area) aliases which would be the correct prefix.

Moreover, if I get a review on the change to always delegate to `_eval_()` (EDITED) if NaN is returned then I'd change that too.



---

archive/issue_comments_338871.json:
```json
{
    "body": "So why is this not a bug?!\n\n```\nsage: RR(-2).sqrt()\n1.41421356237310*I\n```\n",
    "created_at": "2018-02-24T08:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338871",
    "user": "rws"
}
```

So why is this not a bug?!

```
sage: RR(-2).sqrt()
1.41421356237310*I
```




---

archive/issue_comments_338872.json:
```json
{
    "body": "See https://groups.google.com/forum/#!topic/sage-devel/4GwCuJ_-TaQ",
    "created_at": "2018-02-24T08:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338872",
    "user": "rws"
}
```

See https://groups.google.com/forum/#!topic/sage-devel/4GwCuJ_-TaQ



---

archive/issue_comments_338873.json:
```json
{
    "body": "Replying to [comment:16 rws]:\n> Replying to [comment:12 slelievre]:\n> > Adding an example:\n> > {{{\n> > sage: arccosh(RDF(0.9))\n> > 0.45102681179626236*I\n> > }}}\n> \n> Note that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.\n\nIn this situation you could just fallback to\n\n```\nsage: RDF(0.9).acosh()\nNaN\n```\n",
    "created_at": "2018-02-24T08:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338873",
    "user": "vdelecroix"
}
```

Replying to [comment:16 rws]:
> Replying to [comment:12 slelievre]:
> > Adding an example:
> > {{{
> > sage: arccosh(RDF(0.9))
> > 0.45102681179626236*I
> > }}}
> 
> Note that this only works because RDF has no arccosh member function, so the computation is delegated to Pynac.

In this situation you could just fallback to

```
sage: RDF(0.9).acosh()
NaN
```




---

archive/issue_comments_338874.json:
```json
{
    "body": "Replying to [comment:20 rws]:\n> So why is this not a bug?!\n> {{{\n> sage: RR(-2).sqrt()\n> 1.41421356237310*I\n> }}}\n\nIt is a bug.",
    "created_at": "2018-02-24T08:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338874",
    "user": "vdelecroix"
}
```

Replying to [comment:20 rws]:
> So why is this not a bug?!
> {{{
> sage: RR(-2).sqrt()
> 1.41421356237310*I
> }}}

It is a bug.



---

archive/issue_comments_338875.json:
```json
{
    "body": "Following your answer in Groups I think then, instead of calling `x.func()` in the symbolic function code, `x.func(extend=True)` should be called, or alternatively, have data in the `Function` when to call `x.func()` and when to call `parent.complex_field(x).func()`.",
    "created_at": "2018-02-24T09:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338875",
    "user": "rws"
}
```

Following your answer in Groups I think then, instead of calling `x.func()` in the symbolic function code, `x.func(extend=True)` should be called, or alternatively, have data in the `Function` when to call `x.func()` and when to call `parent.complex_field(x).func()`.



---

archive/issue_comments_338876.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-25T09:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338876",
    "user": "rws"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_338877.json:
```json
{
    "body": "This needs fixes from pynac-0.7.17. To fix `RR(-1).log` I'd suggest a similar change in `functions/log.py` to enable the fix of `RR.log()`.\n----\nNew commits:",
    "created_at": "2018-02-25T09:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338877",
    "user": "rws"
}
```

This needs fixes from pynac-0.7.17. To fix `RR(-1).log` I'd suggest a similar change in `functions/log.py` to enable the fix of `RR.log()`.
----
New commits:



---

archive/issue_comments_338878.json:
```json
{
    "body": "Merge failed.",
    "created_at": "2019-12-14T14:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338878",
    "user": "@kliem"
}
```

Merge failed.



---

archive/issue_comments_338879.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-12-14T14:03:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338879",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_338880.json:
```json
{
    "body": "Changing priority from critical to major.",
    "created_at": "2020-10-08T09:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24191",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24191#issuecomment-338880",
    "user": "mmezzarobba"
}
```

Changing priority from critical to major.
