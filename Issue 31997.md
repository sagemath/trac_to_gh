# Issue 31997: Remove code for fast_float(old=True)

archive/issues_031997.json:
```json
{
    "body": "CC:  chapoton @mjungmath egourgoulhon vdelecroix @mwageringel kcrisman slelievre nbruin\n\nThe old code was replaced by new code in 2009 and is unused in the library.\n\n```\n$ git grep 'fast_float *(.*old *='\nsrc/sage/ext/fast_eval.pyx:    sage: f = fast_float(sqrt(x^7+1), 'x', old=True)\nsrc/sage/ext/fast_eval.pyx:def fast_float(f, *vars, old=None, expect_one_var=False):\nsrc/sage/rings/polynomial/multi_polynomial.pyx:            sage: list(fast_float(K(0), old=True))\nsrc/sage/rings/polynomial/multi_polynomial.pyx:            sage: list(fast_float(K(17), old=True))\nsrc/sage/rings/polynomial/multi_polynomial.pyx:            sage: list(fast_float(y, old=True))\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32234\n\n",
    "created_at": "2021-07-18T22:58:12Z",
    "labels": [
        "fast_callable",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Remove code for fast_float(old=True)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31997",
    "user": "mkoeppe"
}
```
CC:  chapoton @mjungmath egourgoulhon vdelecroix @mwageringel kcrisman slelievre nbruin

The old code was replaced by new code in 2009 and is unused in the library.

```
$ git grep 'fast_float *(.*old *='
src/sage/ext/fast_eval.pyx:    sage: f = fast_float(sqrt(x^7+1), 'x', old=True)
src/sage/ext/fast_eval.pyx:def fast_float(f, *vars, old=None, expect_one_var=False):
src/sage/rings/polynomial/multi_polynomial.pyx:            sage: list(fast_float(K(0), old=True))
src/sage/rings/polynomial/multi_polynomial.pyx:            sage: list(fast_float(K(17), old=True))
src/sage/rings/polynomial/multi_polynomial.pyx:            sage: list(fast_float(y, old=True))
```


Issue created by migration from https://trac.sagemath.org/ticket/32234





---

archive/issue_comments_457112.json:
```json
{
    "body": "Cc'ing the last person who modified `numerical_integral`...",
    "created_at": "2021-07-19T00:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457112",
    "user": "mkoeppe"
}
```

Cc'ing the last person who modified `numerical_integral`...



---

archive/issue_comments_457113.json:
```json
{
    "body": "Needs review, or are you waiting to see if the three uses of `_fast_float_` can be removed?",
    "created_at": "2021-07-21T15:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457113",
    "user": "mjo"
}
```

Needs review, or are you waiting to see if the three uses of `_fast_float_` can be removed?



---

archive/issue_comments_457114.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-21T16:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457114",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_457115.json:
```json
{
    "body": "I was kind of hoping that we can get rid of these `_fast_float_`-using methods, but we can of course do that later",
    "created_at": "2021-07-21T16:00:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457115",
    "user": "mkoeppe"
}
```

I was kind of hoping that we can get rid of these `_fast_float_`-using methods, but we can of course do that later



---

archive/issue_comments_457116.json:
```json
{
    "body": "It's unfortunate that there is a `_fast_callable_` method on symbolic expressions that seems to do something else entirely... but this appears to be all that is necessary to update `find_local_minimum()`:\n\n\n```patch\ndiff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx\nindex 0e8dc117bc..fbe74582c2 100644\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -12173,11 +12173,13 @@ cdef class Expression(CommutativeRingElement):\n         - William Stein (2007-12-07)\n         \"\"\"\n         from sage.numerical.optimize import find_local_minimum\n+        from sage.ext.fast_callable import fast_callable\n\n         if var is None:\n             var = self.default_variable()\n-        return find_local_minimum(self._fast_float_(var),\n-                                        a=a, b=b, tol=tol, maxfun=maxfun )\n+\n+        f = fast_callable(self, vars=[var])\n+        return find_local_minimum(f, a=a, b=b, tol=tol, maxfun=maxfun)\n\n     ###################\n     # Fast Evaluation #\n```\n",
    "created_at": "2021-07-21T16:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457116",
    "user": "mjo"
}
```

It's unfortunate that there is a `_fast_callable_` method on symbolic expressions that seems to do something else entirely... but this appears to be all that is necessary to update `find_local_minimum()`:


```patch
diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
index 0e8dc117bc..fbe74582c2 100644
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -12173,11 +12173,13 @@ cdef class Expression(CommutativeRingElement):
         - William Stein (2007-12-07)
         """
         from sage.numerical.optimize import find_local_minimum
+        from sage.ext.fast_callable import fast_callable

         if var is None:
             var = self.default_variable()
-        return find_local_minimum(self._fast_float_(var),
-                                        a=a, b=b, tol=tol, maxfun=maxfun )
+
+        f = fast_callable(self, vars=[var])
+        return find_local_minimum(f, a=a, b=b, tol=tol, maxfun=maxfun)

     ###################
     # Fast Evaluation #
```




---

archive/issue_comments_457117.json:
```json
{
    "body": "Numerical integration:\n\n\n```patch\ndiff --git a/src/sage/calculus/integration.pyx b/src/sage/calculus/integration.$\nindex 93a3681854..6dd4195b2d 100644\n--- a/src/sage/calculus/integration.pyx\n+++ b/src/sage/calculus/integration.pyx\n@@ -316,7 +316,8 @@ def numerical_integral(func, a, b=None,\n                 else:\n                    if ell.is_numeric() and not ell.is_zero():\n                       raise ValueError('integral does not converge at infinity$\n-            func = func._fast_float_(v)\n+            func = fast_callable(func, vars=[v])\n+\n\n     if isinstance(func, FastDoubleFunc):\n         F.function = c_ff\n```\n",
    "created_at": "2021-07-21T16:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457117",
    "user": "mjo"
}
```

Numerical integration:


```patch
diff --git a/src/sage/calculus/integration.pyx b/src/sage/calculus/integration.$
index 93a3681854..6dd4195b2d 100644
--- a/src/sage/calculus/integration.pyx
+++ b/src/sage/calculus/integration.pyx
@@ -316,7 +316,8 @@ def numerical_integral(func, a, b=None,
                 else:
                    if ell.is_numeric() and not ell.is_zero():
                       raise ValueError('integral does not converge at infinity$
-            func = func._fast_float_(v)
+            func = fast_callable(func, vars=[v])
+

     if isinstance(func, FastDoubleFunc):
         F.function = c_ff
```




---

archive/issue_comments_457118.json:
```json
{
    "body": "Replying to [comment:9 mjo]:\n> It's unfortunate that there is a `_fast_callable_` method on symbolic expressions that seems to do something else entirely\nPossibly the name is unfortunate, but the presence of the method is actually what makes `fast_callable` work. Given that it implements the protocol that makes `fast_callable` work, I think the name is actually quite understandable.",
    "created_at": "2021-07-21T17:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457118",
    "user": "nbruin"
}
```

Replying to [comment:9 mjo]:
> It's unfortunate that there is a `_fast_callable_` method on symbolic expressions that seems to do something else entirely
Possibly the name is unfortunate, but the presence of the method is actually what makes `fast_callable` work. Given that it implements the protocol that makes `fast_callable` work, I think the name is actually quite understandable.



---

archive/issue_comments_457119.json:
```json
{
    "body": "I've updated the three files mentioned in the description. The doctests in those files pass but I haven't run the full suite yet.",
    "created_at": "2021-07-21T19:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457119",
    "user": "mjo"
}
```

I've updated the three files mentioned in the description. The doctests in those files pass but I haven't run the full suite yet.



---

archive/issue_comments_457120.json:
```json
{
    "body": "Great, thanks.\n\nIf there are no problems, we can now remove more code - all `_fast_float_` methods in all classes",
    "created_at": "2021-07-21T21:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457120",
    "user": "mkoeppe"
}
```

Great, thanks.

If there are no problems, we can now remove more code - all `_fast_float_` methods in all classes



---

archive/issue_comments_457121.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T21:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457121",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457122.json:
```json
{
    "body": "Replying to [comment:12 mjo]:\n> I've updated the three files mentioned in the description. The doctests in those files pass but I haven't run the full suite yet.\n\nThere's another use of `_fast_float_` in `Expression.find_root`, could you take care of this one please?",
    "created_at": "2021-07-21T21:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457122",
    "user": "mkoeppe"
}
```

Replying to [comment:12 mjo]:
> I've updated the three files mentioned in the description. The doctests in those files pass but I haven't run the full suite yet.

There's another use of `_fast_float_` in `Expression.find_root`, could you take care of this one please?



---

archive/issue_comments_457123.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T21:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457123",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457124.json:
```json
{
    "body": "Some more things:\n- `src/sage/plot/plot3d/plot3d.py` uses `fast_float_arg`\n\n- some files import `fast_callable` from the wrong module",
    "created_at": "2021-07-21T22:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457124",
    "user": "mkoeppe"
}
```

Some more things:
- `src/sage/plot/plot3d/plot3d.py` uses `fast_float_arg`

- some files import `fast_callable` from the wrong module



---

archive/issue_comments_457125.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T22:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457125",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457126.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T22:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457126",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457127.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T22:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457127",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457128.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T22:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457128",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457129.json:
```json
{
    "body": "Replying to [comment:18 mkoeppe]:\n> \n> - some files import `fast_callable` from the wrong module\n\nThere's a different `fast_callable` function in sage/symbolic/expression_conversions.py, if that's what you're seeing?",
    "created_at": "2021-07-21T22:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457129",
    "user": "mjo"
}
```

Replying to [comment:18 mkoeppe]:
> 
> - some files import `fast_callable` from the wrong module

There's a different `fast_callable` function in sage/symbolic/expression_conversions.py, if that's what you're seeing?



---

archive/issue_comments_457130.json:
```json
{
    "body": "I'm referring to:\n\n```\nsrc/sage/numerical/optimize.py:    from sage.ext.fast_eval import fast_callable\n```\n",
    "created_at": "2021-07-21T22:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457130",
    "user": "mkoeppe"
}
```

I'm referring to:

```
src/sage/numerical/optimize.py:    from sage.ext.fast_eval import fast_callable
```




---

archive/issue_comments_457131.json:
```json
{
    "body": "Ok, I fixed that and the same import in `sage/calculus/riemann.pyx`. I think I've fixed `find_root()` too but `sage -b` is complaining about `FastDoubleFunc` in `sage/plot/plot3d/parametric_surface.pyx` at the moment.",
    "created_at": "2021-07-21T22:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457131",
    "user": "mjo"
}
```

Ok, I fixed that and the same import in `sage/calculus/riemann.pyx`. I think I've fixed `find_root()` too but `sage -b` is complaining about `FastDoubleFunc` in `sage/plot/plot3d/parametric_surface.pyx` at the moment.



---

archive/issue_comments_457132.json:
```json
{
    "body": "I think I removed that in 927d6c2",
    "created_at": "2021-07-21T22:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457132",
    "user": "mkoeppe"
}
```

I think I removed that in 927d6c2



---

archive/issue_comments_457133.json:
```json
{
    "body": "can you merge & push your changes please?",
    "created_at": "2021-07-21T22:49:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457133",
    "user": "mkoeppe"
}
```

can you merge & push your changes please?



---

archive/issue_comments_457134.json:
```json
{
    "body": "Sure, I was trying to fix the `fast_float_arg` thing, but here are the two aforementioned commits.\n----\nNew commits:",
    "created_at": "2021-07-21T22:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457134",
    "user": "mjo"
}
```

Sure, I was trying to fix the `fast_float_arg` thing, but here are the two aforementioned commits.
----
New commits:



---

archive/issue_comments_457135.json:
```json
{
    "body": "FWIW here's a way to mimic `fast_float_arg(0)` and `fast_float_arg(1)`:\n\n\n```python\nsage: u = SR.symbol('u', domain='real')                                         \nsage: v = SR.symbol('v', domain='real')                                         \nsage: u = fast_callable(u, vars=[u,v])                                          \nsage: v = fast_callable(v, vars=[u,v])\nsage: u(1,2)                                                                    \n1\nsage: v(1,2)                                                                    \n2\n```\n",
    "created_at": "2021-07-21T23:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457135",
    "user": "mjo"
}
```

FWIW here's a way to mimic `fast_float_arg(0)` and `fast_float_arg(1)`:


```python
sage: u = SR.symbol('u', domain='real')                                         
sage: v = SR.symbol('v', domain='real')                                         
sage: u = fast_callable(u, vars=[u,v])                                          
sage: v = fast_callable(v, vars=[u,v])
sage: u(1,2)                                                                    
1
sage: v(1,2)                                                                    
2
```




---

archive/issue_comments_457136.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T23:54:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457136",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457137.json:
```json
{
    "body": "Using `SR` feels ugly there, but for lack of a better idea, it works.",
    "created_at": "2021-07-21T23:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457137",
    "user": "mjo"
}
```

Using `SR` feels ugly there, but for lack of a better idea, it works.



---

archive/issue_comments_457138.json:
```json
{
    "body": "I would be concerned that this puts global assumptions on these two variables",
    "created_at": "2021-07-22T00:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457138",
    "user": "mkoeppe"
}
```

I would be concerned that this puts global assumptions on these two variables



---

archive/issue_comments_457139.json:
```json
{
    "body": "I could either remove the `domain='real'`, or replace the whole thing with e.g.\n\n\n```\nsage: R = PolynomialRing(RDF, 'u,v')                                            \nsage: u = fast_callable(R.gen(0), vars=R.gens())                                \nsage: v = fast_callable(R.gen(1), vars=R.gens())                                \nsage: u(1,2)                                                                    \n1.0\nsage: v(1,2)                                                                    \n2.0\n```\n",
    "created_at": "2021-07-22T00:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457139",
    "user": "mjo"
}
```

I could either remove the `domain='real'`, or replace the whole thing with e.g.


```
sage: R = PolynomialRing(RDF, 'u,v')                                            
sage: u = fast_callable(R.gen(0), vars=R.gens())                                
sage: v = fast_callable(R.gen(1), vars=R.gens())                                
sage: u(1,2)                                                                    
1.0
sage: v(1,2)                                                                    
2.0
```




---

archive/issue_comments_457140.json:
```json
{
    "body": "either way should be fine, or perhaps use `ExpressionTreeBuilder.var` directly",
    "created_at": "2021-07-22T00:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457140",
    "user": "mkoeppe"
}
```

either way should be fine, or perhaps use `ExpressionTreeBuilder.var` directly



---

archive/issue_comments_457141.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-22T01:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457141",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_457142.json:
```json
{
    "body": "Looking great, but I'm getting a few doctest errors\n\n```\nsage -t --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py\n**********************************************************************\nFile \"src/sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py\", line 353, in sage.tests.books.computational-mathematics-with-sagemath.calculus_doctest\nFailed example:\n    n0 = find_root(u(n) - 1e-8 == 0, 22, 1000); n0\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 718, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1137, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tests.books.computational-mathematics-with-sagemath.calculus_doctest[89]>\", line 1, in <module>\n        n0 = find_root(u(n) - RealNumber('1e-8') == Integer(0), Integer(22), Integer(1000)); n0\n      File \"sage/misc/lazy_import.pyx\", line 362, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4036)\n        return self.get_object()(*args, **kwds)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/numerical/optimize.py\", line 105, in find_root\n        return f.find_root(a=a,b=b,xtol=xtol,rtol=rtol,maxiter=maxiter,full_output=full_output)\n      File \"sage/symbolic/expression.pyx\", line 12098, in sage.symbolic.expression.Expression.find_root (build/cythonized/sage/symbolic/expression.cpp:64387)\n        return find_root(f, a=a, b=b, xtol=xtol,\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/numerical/optimize.py\", line 113, in find_root\n        right = f(b)\n      File \"sage/ext/interpreters/wrapper_py.pyx\", line 68, in sage.ext.interpreters.wrapper_py.Wrapper_py.__call__ (build/cythonized/sage/ext/interpreters/wrapper_py.c:2040)\n        raise\n      File \"sage/ext/interpreters/wrapper_py.pyx\", line 60, in sage.ext.interpreters.wrapper_py.Wrapper_py.__call__ (build/cythonized/sage/ext/interpreters/wrapper_py.c:1974)\n        return interp_py((<PyTupleObject*>args).ob_item\n      File \"sage/rings/integer.pyx\", line 2206, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15193)\n        return coercion_model.bin_op(left, right, operator.pow)\n      File \"sage/structure/coerce.pyx\", line 1204, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10671)\n        return PyObject_CallObject(op, xy)\n    OverflowError: (34, 'Result too large')\n**********************************************************************\nsage -t --random-seed=0 src/sage/numerical/optimize.py\n**********************************************************************\nFile \"src/sage/numerical/optimize.py\", line 81, in sage.numerical.optimize.find_root\nFailed example:\n    find_root(x^2*log(x,2)-1,0, 2)  # abs tol 1e-6\nExpected:\n    1.41421356237\nGot:\n    0.0\nTolerance exceeded:\n    1.41421356237 vs 0.0, tolerance 2e0 > 1e-6\n**********************************************************************\nFile \"src/sage/numerical/optimize.py\", line 98, in sage.numerical.optimize.find_root\nFailed example:\n    find_root(f, -1, 0)\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: f appears to have no zero on the interval\nGot:\n    0.0\n**********************************************************************\n```\n",
    "created_at": "2021-07-22T02:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457142",
    "user": "mkoeppe"
}
```

Looking great, but I'm getting a few doctest errors

```
sage -t --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py
**********************************************************************
File "src/sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py", line 353, in sage.tests.books.computational-mathematics-with-sagemath.calculus_doctest
Failed example:
    n0 = find_root(u(n) - 1e-8 == 0, 22, 1000); n0
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.books.computational-mathematics-with-sagemath.calculus_doctest[89]>", line 1, in <module>
        n0 = find_root(u(n) - RealNumber('1e-8') == Integer(0), Integer(22), Integer(1000)); n0
      File "sage/misc/lazy_import.pyx", line 362, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4036)
        return self.get_object()(*args, **kwds)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/numerical/optimize.py", line 105, in find_root
        return f.find_root(a=a,b=b,xtol=xtol,rtol=rtol,maxiter=maxiter,full_output=full_output)
      File "sage/symbolic/expression.pyx", line 12098, in sage.symbolic.expression.Expression.find_root (build/cythonized/sage/symbolic/expression.cpp:64387)
        return find_root(f, a=a, b=b, xtol=xtol,
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/.tox/local-homebrew-macos-minimal/local/lib/python3.9/site-packages/sage/numerical/optimize.py", line 113, in find_root
        right = f(b)
      File "sage/ext/interpreters/wrapper_py.pyx", line 68, in sage.ext.interpreters.wrapper_py.Wrapper_py.__call__ (build/cythonized/sage/ext/interpreters/wrapper_py.c:2040)
        raise
      File "sage/ext/interpreters/wrapper_py.pyx", line 60, in sage.ext.interpreters.wrapper_py.Wrapper_py.__call__ (build/cythonized/sage/ext/interpreters/wrapper_py.c:1974)
        return interp_py((<PyTupleObject*>args).ob_item
      File "sage/rings/integer.pyx", line 2206, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15193)
        return coercion_model.bin_op(left, right, operator.pow)
      File "sage/structure/coerce.pyx", line 1204, in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10671)
        return PyObject_CallObject(op, xy)
    OverflowError: (34, 'Result too large')
**********************************************************************
sage -t --random-seed=0 src/sage/numerical/optimize.py
**********************************************************************
File "src/sage/numerical/optimize.py", line 81, in sage.numerical.optimize.find_root
Failed example:
    find_root(x^2*log(x,2)-1,0, 2)  # abs tol 1e-6
Expected:
    1.41421356237
Got:
    0.0
Tolerance exceeded:
    1.41421356237 vs 0.0, tolerance 2e0 > 1e-6
**********************************************************************
File "src/sage/numerical/optimize.py", line 98, in sage.numerical.optimize.find_root
Failed example:
    find_root(f, -1, 0)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: f appears to have no zero on the interval
Got:
    0.0
**********************************************************************
```




---

archive/issue_comments_457143.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-22T12:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457143",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457144.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-22T13:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457144",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457145.json:
```json
{
    "body": "Should be fixed now. Numpy didn't know what to do about NaN unless `domain=float` was specified.\n\nNot important, but one of those example functions isn't doing what the doctest thinks it does:\n\n\n```\nsage: f(x) = 0.0 / max(0, x)                                                                                                                                                 \nsage: f                                                                                                                                                                      \nx |--> NaN\n```\n\n\nsince\n\n\n```\nsage: max(0, x)                                                                                                                                                              \n0\n```\n",
    "created_at": "2021-07-22T13:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457145",
    "user": "mjo"
}
```

Should be fixed now. Numpy didn't know what to do about NaN unless `domain=float` was specified.

Not important, but one of those example functions isn't doing what the doctest thinks it does:


```
sage: f(x) = 0.0 / max(0, x)                                                                                                                                                 
sage: f                                                                                                                                                                      
x |--> NaN
```


since


```
sage: max(0, x)                                                                                                                                                              
0
```




---

archive/issue_comments_457146.json:
```json
{
    "body": "As this ticket makes changes to plotting functions, it would be good to check that there are no speed regressions",
    "created_at": "2021-07-22T14:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457146",
    "user": "mkoeppe"
}
```

As this ticket makes changes to plotting functions, it would be good to check that there are no speed regressions



---

archive/issue_comments_457147.json:
```json
{
    "body": "In the next step, we could deprecate the compatibility function `fast_float` and switch all uses to direct calls to `fast_callable`. Perhaps best in a follow-up ticket.",
    "created_at": "2021-07-22T15:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457147",
    "user": "mkoeppe"
}
```

In the next step, we could deprecate the compatibility function `fast_float` and switch all uses to direct calls to `fast_callable`. Perhaps best in a follow-up ticket.



---

archive/issue_comments_457148.json:
```json
{
    "body": "(That's now #32268.)",
    "created_at": "2021-07-23T16:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457148",
    "user": "mkoeppe"
}
```

(That's now #32268.)



---

archive/issue_comments_457149.json:
```json
{
    "body": "Replying to [comment:35 mkoeppe]:\n> either way should be fine, or perhaps use `ExpressionTreeBuilder.var` directly\n\nFeeling a bit stupid right now because `lambda u,v: v` is about four times as fast as the complicated fast-callable-arg2 stuff on my machine.",
    "created_at": "2021-07-27T14:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457149",
    "user": "mjo"
}
```

Replying to [comment:35 mkoeppe]:
> either way should be fine, or perhaps use `ExpressionTreeBuilder.var` directly

Feeling a bit stupid right now because `lambda u,v: v` is about four times as fast as the complicated fast-callable-arg2 stuff on my machine.



---

archive/issue_comments_457150.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-07-27T20:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457150",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_457151.json:
```json
{
    "body": "merged latest rc.\n----\nNew commits:",
    "created_at": "2021-08-15T02:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457151",
    "user": "mkoeppe"
}
```

merged latest rc.
----
New commits:



---

archive/issue_comments_457152.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-13T23:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457152",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457153.json:
```json
{
    "body": "This ticket needs another reviewer...",
    "created_at": "2021-09-13T23:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457153",
    "user": "mkoeppe"
}
```

This ticket needs another reviewer...



---

archive/issue_comments_457154.json:
```json
{
    "body": "I looked through this one more time, and noticed that `domain=float` can be used in the earlier commits as well (the functions/results get passed to external library routines expecting floats anyway). I've added a commit to do that, and rebased onto beta2.\n\nShall we say we've eached reviewed the other's contribution here?",
    "created_at": "2021-10-02T22:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457154",
    "user": "mjo"
}
```

I looked through this one more time, and noticed that `domain=float` can be used in the earlier commits as well (the functions/results get passed to external library routines expecting floats anyway). I've added a commit to do that, and rebased onto beta2.

Shall we say we've eached reviewed the other's contribution here?



---

archive/issue_comments_457155.json:
```json
{
    "body": "That would be fine with me",
    "created_at": "2021-10-02T23:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457155",
    "user": "mkoeppe"
}
```

That would be fine with me



---

archive/issue_comments_457156.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-03T11:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457156",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457157.json:
```json
{
    "body": "Ok, I added one more commit to fix a missing(?) import, or to at least satisfy the patchbots. I'm happy with your commits if you're happy with mine.",
    "created_at": "2021-10-03T11:58:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457157",
    "user": "mjo"
}
```

Ok, I added one more commit to fix a missing(?) import, or to at least satisfy the patchbots. I'm happy with your commits if you're happy with mine.



---

archive/issue_comments_457158.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-03T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457158",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_457159.json:
```json
{
    "body": "Then let's get this in.",
    "created_at": "2021-10-03T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457159",
    "user": "mkoeppe"
}
```

Then let's get this in.



---

archive/issue_comments_457160.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-10T10:17:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31997#issuecomment-457160",
    "user": "vbraun"
}
```

Resolution: fixed
