# Issue 24188: random_expr changes behaviour when unrelated code is changed

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2017-12-24 07:25:10

Applying the following minimal patch makes a completely unrelated doctest fail:

```
diff --git a/src/sage/functions/all.py b/src/sage/functions/all.py
index e7f1ea0efa..d26f83f2f9 100644
--- a/src/sage/functions/all.py
+++ b/src/sage/functions/all.py
`@``@` -4,7 +4,7 `@``@` from sage.misc.lazy_import import lazy_import
 
 lazy_import('sage.functions.piecewise_old', 'Piecewise')   # deprecated
 lazy_import('sage.functions.piecewise', 'piecewise')
-lazy_import('sage.functions.error', ['erf', 'erfc', 'erfi', 'erfinv'])
+lazy_import('sage.functions.error', ['erf', 'erfc', 'erfi', 'erfinv', 'fresnel_test1', 'fresnel_test2'])
 
 from .trig import ( sin, cos, sec, csc, cot, tan,
                    asin, acos, atan,
diff --git a/src/sage/functions/error.py b/src/sage/functions/error.py
index 9a9b03cd6d..ec0a574814 100644
--- a/src/sage/functions/error.py
+++ b/src/sage/functions/error.py
`@``@` -548,3 +548,15 `@``@` erfinv = Function_erfinv()
 from sage.structure.sage_object import register_unpickle_override
 register_unpickle_override('sage.functions.other', 'Function_erf', Function_erf)
 
+class Function_Fresnel_test1(BuiltinFunction):
+    def __init__(self):
+        BuiltinFunction.__init__(self, "fresnel_test1")
+
+fresnel_test1 = Function_Fresnel_test1()
+
+class Function_Fresnel_test2(BuiltinFunction):
+    def __init__(self):
+        BuiltinFunction.__init__(self, "fresnel_test2")
+
+fresnel_test2 = Function_Fresnel_test2()
+
```


```
File "src/sage/symbolic/random_tests.py", line 265, in sage.symbolic.random_tests.?
Failed example:
    random_expr(50, nvars=3, coeff_generator=CDF.random_element) # random
...
      File "sage/symbolic/expression.pyx", line 3518, in sage.symbolic.expression.Expression._div_ (build/cythonized/sage/symbolic/expression.cpp:25588)
        raise ZeroDivisionError("Symbolic division by zero")
    ZeroDivisionError: Symbolic division by zero
```

The reason why the doctest fails is that, despite fixing the random seed, the functions and symbols picked by `random_expr` are different. This, at some point in the buildup of the expression, leads to the sub-expression `kronecker_delta(-0.6165326641917295 + 0.15117833554974136*I, e)` which immediately evaluates to `0`. The `0` progresses eventually into a denominator, causing the error. `random_expr` is not written to avoid such errors if they happen, nor does it avoid other exceptions thrown. The author of the doctest apparently just chose a random seed that happens to not throw errors.

Of course the actual bug is that `random_expr` changes behaviour when unrelated code is changed.


---

Comment by rws created at 2017-12-24 07:31:21

The lazy_import is not even necessary for trigger.


---

Comment by rws created at 2017-12-26 08:15:32

New commits:


---

Comment by rws created at 2017-12-26 08:15:32

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2018-06-01 12:54:26

I don't fully understand the context, but the change looks reasonable and really unlikely to break anythingâ€”and this ticket has been languishing for months.


---

Comment by mmezzarobba created at 2018-06-01 12:54:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-02 16:11:52

Resolution: fixed


---

Comment by rws created at 2018-06-02 16:25:27

Thanks. Oddly enough, #24212 depends on this.
