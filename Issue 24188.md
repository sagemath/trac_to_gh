# Issue 24188: random_expr changes behaviour when unrelated code is changed

archive/issues_024188.json:
```json
{
    "body": "Applying the following minimal patch makes a completely unrelated doctest fail:\n\n```\ndiff --git a/src/sage/functions/all.py b/src/sage/functions/all.py\nindex e7f1ea0efa..d26f83f2f9 100644\n--- a/src/sage/functions/all.py\n+++ b/src/sage/functions/all.py\n@@ -4,7 +4,7 @@ from sage.misc.lazy_import import lazy_import\n \n lazy_import('sage.functions.piecewise_old', 'Piecewise')   # deprecated\n lazy_import('sage.functions.piecewise', 'piecewise')\n-lazy_import('sage.functions.error', ['erf', 'erfc', 'erfi', 'erfinv'])\n+lazy_import('sage.functions.error', ['erf', 'erfc', 'erfi', 'erfinv', 'fresnel_test1', 'fresnel_test2'])\n \n from .trig import ( sin, cos, sec, csc, cot, tan,\n                    asin, acos, atan,\ndiff --git a/src/sage/functions/error.py b/src/sage/functions/error.py\nindex 9a9b03cd6d..ec0a574814 100644\n--- a/src/sage/functions/error.py\n+++ b/src/sage/functions/error.py\n@@ -548,3 +548,15 @@ erfinv = Function_erfinv()\n from sage.structure.sage_object import register_unpickle_override\n register_unpickle_override('sage.functions.other', 'Function_erf', Function_erf)\n \n+class Function_Fresnel_test1(BuiltinFunction):\n+    def __init__(self):\n+        BuiltinFunction.__init__(self, \"fresnel_test1\")\n+\n+fresnel_test1 = Function_Fresnel_test1()\n+\n+class Function_Fresnel_test2(BuiltinFunction):\n+    def __init__(self):\n+        BuiltinFunction.__init__(self, \"fresnel_test2\")\n+\n+fresnel_test2 = Function_Fresnel_test2()\n+\n```\n\n\n```\nFile \"src/sage/symbolic/random_tests.py\", line 265, in sage.symbolic.random_tests.?\nFailed example:\n    random_expr(50, nvars=3, coeff_generator=CDF.random_element) # random\n...\n      File \"sage/symbolic/expression.pyx\", line 3518, in sage.symbolic.expression.Expression._div_ (build/cythonized/sage/symbolic/expression.cpp:25588)\n        raise ZeroDivisionError(\"Symbolic division by zero\")\n    ZeroDivisionError: Symbolic division by zero\n```\n\nThe reason why the doctest fails is that, despite fixing the random seed, the functions and symbols picked by `random_expr` are different. This, at some point in the buildup of the expression, leads to the sub-expression `kronecker_delta(-0.6165326641917295 + 0.15117833554974136*I, e)` which immediately evaluates to `0`. The `0` progresses eventually into a denominator, causing the error. `random_expr` is not written to avoid such errors if they happen, nor does it avoid other exceptions thrown. The author of the doctest apparently just chose a random seed that happens to not throw errors.\n\nOf course the actual bug is that `random_expr` changes behaviour when unrelated code is changed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24425\n\n",
    "created_at": "2017-12-24T07:25:10Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "random_expr changes behaviour when unrelated code is changed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24188",
    "user": "@rwst"
}
```
Applying the following minimal patch makes a completely unrelated doctest fail:

```
diff --git a/src/sage/functions/all.py b/src/sage/functions/all.py
index e7f1ea0efa..d26f83f2f9 100644
--- a/src/sage/functions/all.py
+++ b/src/sage/functions/all.py
@@ -4,7 +4,7 @@ from sage.misc.lazy_import import lazy_import
 
 lazy_import('sage.functions.piecewise_old', 'Piecewise')   # deprecated
 lazy_import('sage.functions.piecewise', 'piecewise')
-lazy_import('sage.functions.error', ['erf', 'erfc', 'erfi', 'erfinv'])
+lazy_import('sage.functions.error', ['erf', 'erfc', 'erfi', 'erfinv', 'fresnel_test1', 'fresnel_test2'])
 
 from .trig import ( sin, cos, sec, csc, cot, tan,
                    asin, acos, atan,
diff --git a/src/sage/functions/error.py b/src/sage/functions/error.py
index 9a9b03cd6d..ec0a574814 100644
--- a/src/sage/functions/error.py
+++ b/src/sage/functions/error.py
@@ -548,3 +548,15 @@ erfinv = Function_erfinv()
 from sage.structure.sage_object import register_unpickle_override
 register_unpickle_override('sage.functions.other', 'Function_erf', Function_erf)
 
+class Function_Fresnel_test1(BuiltinFunction):
+    def __init__(self):
+        BuiltinFunction.__init__(self, "fresnel_test1")
+
+fresnel_test1 = Function_Fresnel_test1()
+
+class Function_Fresnel_test2(BuiltinFunction):
+    def __init__(self):
+        BuiltinFunction.__init__(self, "fresnel_test2")
+
+fresnel_test2 = Function_Fresnel_test2()
+
```


```
File "src/sage/symbolic/random_tests.py", line 265, in sage.symbolic.random_tests.?
Failed example:
    random_expr(50, nvars=3, coeff_generator=CDF.random_element) # random
...
      File "sage/symbolic/expression.pyx", line 3518, in sage.symbolic.expression.Expression._div_ (build/cythonized/sage/symbolic/expression.cpp:25588)
        raise ZeroDivisionError("Symbolic division by zero")
    ZeroDivisionError: Symbolic division by zero
```

The reason why the doctest fails is that, despite fixing the random seed, the functions and symbols picked by `random_expr` are different. This, at some point in the buildup of the expression, leads to the sub-expression `kronecker_delta(-0.6165326641917295 + 0.15117833554974136*I, e)` which immediately evaluates to `0`. The `0` progresses eventually into a denominator, causing the error. `random_expr` is not written to avoid such errors if they happen, nor does it avoid other exceptions thrown. The author of the doctest apparently just chose a random seed that happens to not throw errors.

Of course the actual bug is that `random_expr` changes behaviour when unrelated code is changed.

Issue created by migration from https://trac.sagemath.org/ticket/24425





---

archive/issue_comments_338814.json:
```json
{
    "body": "The lazy_import is not even necessary for trigger.",
    "created_at": "2017-12-24T07:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24188#issuecomment-338814",
    "user": "@rwst"
}
```

The lazy_import is not even necessary for trigger.



---

archive/issue_comments_338815.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-12-26T08:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24188#issuecomment-338815",
    "user": "@rwst"
}
```

New commits:



---

archive/issue_comments_338816.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-26T08:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24188#issuecomment-338816",
    "user": "@rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_338817.json:
```json
{
    "body": "I don't fully understand the context, but the change looks reasonable and really unlikely to break anything\u2014and this ticket has been languishing for months.",
    "created_at": "2018-06-01T12:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24188#issuecomment-338817",
    "user": "@mezzarobba"
}
```

I don't fully understand the context, but the change looks reasonable and really unlikely to break anythingâ€”and this ticket has been languishing for months.



---

archive/issue_comments_338818.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-01T12:54:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24188#issuecomment-338818",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_338819.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-02T16:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24188#issuecomment-338819",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_338820.json:
```json
{
    "body": "Thanks. Oddly enough, #24212 depends on this.",
    "created_at": "2018-06-02T16:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24188",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24188#issuecomment-338820",
    "user": "@rwst"
}
```

Thanks. Oddly enough, #24212 depends on this.
