# Issue 16178: Ignore case in package directory

Issue created by migration from https://trac.sagemath.org/ticket/16415

Original creator: vbraun

Original creation time: 2014-05-30 15:32:13




---

Comment by vbraun created at 2014-05-30 15:33:50

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2014-05-30 15:33:50

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2014-05-30 17:01:04

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-05-30 17:01:04

New commits:


---

Comment by leif created at 2014-05-31 13:23:27

Is this supposed to be a temporary (=ad-hoc) solution?

In the long run, the actual folder name should probably be part of Sage's "package metadata".


---

Comment by vbraun created at 2014-05-31 13:28:46

If there is a single top-level directory then we don't need to store the name (and manually maintain) it elsewhere. There should be some checking, of course. And if you don't have a single top-level directory then I'd consider that to be an upstream bug.


---

Comment by leif created at 2014-05-31 13:46:45

Replying to [comment:5 vbraun]:
> If there is a single top-level directory then we don't need to store the name

Yep, but that's NYI.

> (and manually maintain) it elsewhere.

Well, we "manually" maintain the "checksums" for each specific upstream tarball anyway (in a *central* repo, tied to specific Sage versions, which is IMHO a bad thing to do anyway). 

> There should be some checking, of course.

Sure.

> And if you don't have a single top-level directory then I'd consider that to be an upstream bug.

:-)


---

Comment by leif created at 2014-05-31 13:50:57

P.S.:  FWIW, requiring `foo-x.y.pN.spkg` to have a `foo-x.y.pN/` folder was used as a consistency check (although I didn't like it, as it just made testing spkgs slightly harder).


---

Comment by git created at 2014-05-31 16:51:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-05-31 16:53:17

Also removed the hiding-of-errors, I want to know which packages don't work...


---

Comment by leif created at 2014-05-31 17:08:25

Probably immediately go with `find . -type d -a -not -name . -exec mv {} src \; 2>/dev/null` ;-) (and afterwards `test -d ...`)

(Haven't checked right now, but I guess `-iname` isn't portable.)


---

Comment by vbraun created at 2014-05-31 17:13:12

Besides not portable, its IMHO not readable. The whole contraption should be rewritten in Python with some proper doctesting.


---

Comment by leif created at 2014-05-31 18:01:23

Replying to [comment:11 vbraun]:
> Besides not portable, its IMHO not readable.

Well, the `find` version above is portable, although I'd just use it to get the folder name.  (Or some flavour of `(cd * && basename `pwd`)`.)

> The whole contraption should be rewritten in Python with some proper doctesting.

In Lisp, please.




Anyway, I'd really explicitly check whether `src/` afterwards exists (and is a directory); we already have

```sh
    echo "Finished extraction"

    cd "$PKG_NAME"
    if [ $? -ne 0 ]; then
        echo >&2 "Error: after extracting, the directory $PKG_NAME does not exist"
        exit 1
    fi
```

right below for legacy spkgs.




Just out of curiosity:  Which bash version(s) did the original change work with?

I tried older (3.2.*) as well as newer (4.3.11*) bashs; with none of them it worked.


---

Comment by vbraun created at 2014-05-31 18:13:44

$ bash --version
GNU bash, version 4.2.47(1)-release (x86_64-redhat-linux-gnu)

Replying to [comment:12 leif]:
> In Lisp, please.

Sage is a Python project. And Python is actually pretty good for sysadmin-type scripts. Unlike lisp. And unlike Bash it can be tested in a sane way.


---

Comment by leif created at 2014-06-02 16:25:32

Replying to [comment:13 vbraun]:
> {{{
> $ bash --version
> GNU bash, version 4.2.47(1)-release (x86_64-redhat-linux-gnu)
> }}}

FWIW, `"${PKG_NAME_UPSTREAM%.tar*}"` doesn't work with

```
GNU bash, version 4.2.28(1)-release (x86_64-redhat-linux-gnu)
Copyright (C) 2011 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
```

either.  (So it's probably a bug in your bash that it works for you. ;-) )


---

Comment by leif created at 2014-06-03 13:39:51

I'd still add a check (with an appropriate error message) that `src/` afterwards really exists (and is a directory ;-) ); cf. [comment:12 my comment above].


---

Comment by vbraun created at 2014-06-04 09:32:31

We don't need a double check, either building the package will break if the rename fails or the rename is not necessary (and, really, wtf do we rename the tarball directory to start with, afaik nobody else does that). In particular, there is no need to check that the renamed directory is still a directory.


---

Comment by jhpalmieri created at 2014-06-17 01:51:36

Looks okay to me.


---

Comment by jhpalmieri created at 2014-06-17 01:51:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-06-18 12:00:26

Resolution: fixed
