# Issue 12643: bugs in doctesting script for examples with tolerance

archive/issues_012643.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  jhpalmieri kcrisman\n\nKeywords: tolerance doctest\n\nWhen testing the file\n\n```\n\"\"\"\nEXAMPLES:\n\nThe name blah is undefined::\n\n    sage: blah+blah\n    blahblah\n\nHere's a doctest that is out of tolerance::\n\n    sage: 100+10000000000 # abs tol 0.1\n    10000000000\n    sage: 1+1\n    2\n\"\"\"\n```\n\nI get\n\n```\nFile \"/Users/marcostreng/tmp/test.sage\", line 6:\n    sage: blah+blah\nOut of tolerance 10000000000.0 vs 10000000100.0\n```\n\nSo the error of \"blah is undefined\" is not printed, while the \"out of tolerance\" is printed for the wrong test.\n\nAlso, there is a bug when a test with tolerance is the last test:\n\n```\n\"\"\"\nEXAMPLES:\n\nDoctests with tolerance cannot be followed by empty lines::\n\n    sage: 100+10000000000 # rel tol 0.1\n    10000000000\n\"\"\"\n```\n\nyields\n\n```\n  File \"/Users/marcostreng/.sage//tmp/test_71331.py\", line 58\n    ... ''', res, 0.1, 're\n    ^\nSyntaxError: invalid syntax\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12815\n\n",
    "created_at": "2012-04-07T11:56:13Z",
    "labels": [
        "doctest coverage",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "bugs in doctesting script for examples with tolerance",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12643",
    "user": "mstreng"
}
```
Assignee: mvngu

CC:  jhpalmieri kcrisman

Keywords: tolerance doctest

When testing the file

```
"""
EXAMPLES:

The name blah is undefined::

    sage: blah+blah
    blahblah

Here's a doctest that is out of tolerance::

    sage: 100+10000000000 # abs tol 0.1
    10000000000
    sage: 1+1
    2
"""
```

I get

```
File "/Users/marcostreng/tmp/test.sage", line 6:
    sage: blah+blah
Out of tolerance 10000000000.0 vs 10000000100.0
```

So the error of "blah is undefined" is not printed, while the "out of tolerance" is printed for the wrong test.

Also, there is a bug when a test with tolerance is the last test:

```
"""
EXAMPLES:

Doctests with tolerance cannot be followed by empty lines::

    sage: 100+10000000000 # rel tol 0.1
    10000000000
"""
```

yields

```
  File "/Users/marcostreng/.sage//tmp/test_71331.py", line 58
    ... ''', res, 0.1, 're
    ^
SyntaxError: invalid syntax
```


Issue created by migration from https://trac.sagemath.org/ticket/12815





---

archive/issue_comments_150577.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2013-01-03T10:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150577",
    "user": "jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_150578.json:
```json
{
    "body": "A patch at #13899 documents the third bug in the ticket description.",
    "created_at": "2013-01-03T10:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150578",
    "user": "jdemeyer"
}
```

A patch at #13899 documents the third bug in the ticket description.



---

archive/issue_comments_150579.json:
```json
{
    "body": "Issues 1 and 2 are fixed by #12415. Issue 3 might be \"wontfix\" but then the documentation needs to be changed.",
    "created_at": "2013-01-04T07:39:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150579",
    "user": "jdemeyer"
}
```

Issues 1 and 2 are fixed by #12415. Issue 3 might be "wontfix" but then the documentation needs to be changed.



---

archive/issue_comments_150580.json:
```json
{
    "body": "Testing issue 3 with #12415 gives\n\n```\nsage -t /home/jdemeyer/doctest/tolerance_fail.py\n**********************************************************************\nFile \"/home/jdemeyer/doctest/tolerance_fail.py\", line 2, in tolerance_fail\nFailed example:\n    1e16     # relative tol 1e-10\nExpected:\n    10^16\nGot:\n    1.00000000000000e16\n**********************************************************************\n```\n",
    "created_at": "2013-01-04T07:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150580",
    "user": "jdemeyer"
}
```

Testing issue 3 with #12415 gives

```
sage -t /home/jdemeyer/doctest/tolerance_fail.py
**********************************************************************
File "/home/jdemeyer/doctest/tolerance_fail.py", line 2, in tolerance_fail
Failed example:
    1e16     # relative tol 1e-10
Expected:
    10^16
Got:
    1.00000000000000e16
**********************************************************************
```




---

archive/issue_comments_150581.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Testing issue 3 with #12415 gives\n\nYes, and that is what the last block of changes of [trac_13899-doctest-rebase.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/13899/trac_13899-doctest-rebase.patch) is for.",
    "created_at": "2013-01-04T08:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150581",
    "user": "mstreng"
}
```

Replying to [comment:6 jdemeyer]:
> Testing issue 3 with #12415 gives

Yes, and that is what the last block of changes of [trac_13899-doctest-rebase.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/13899/trac_13899-doctest-rebase.patch) is for.



---

archive/issue_comments_150582.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> Testing issue 3 with #12415 gives\n> {{{\n> sage -t /home/jdemeyer/doctest/tolerance_fail.py\n> **********************************************************************\n> File \"/home/jdemeyer/doctest/tolerance_fail.py\", line 2, in tolerance_fail\n> Failed example:\n>     1e16     # relative tol 1e-10\n> Expected:\n>     10^16\n> Got:\n>     1.00000000000000e16\n> **********************************************************************\n> }}}\n\nI consider this a feature, not a bug. If we're going to allow arithmetic expressions, where do we draw the line?\n\n\n```\nsage: 1e16    # rel tol 1e-10\n100000000^2\nsage: 1e16    # rel tol 1e-10\n4e15 + 6e15\nsage: 1e16    # rel tol 1e-10\nsolve(1e16 - x, x)[0].rhs()\n```\n\n\nThere is also the advantage of being able to write\n\n\n```\nsage: \"%g is less than %g\" % (sqrt(2), pi)   # rel tol .01\n'1.41 is less than 3.14'\n```\n\n\nwhich is possible because we do a match on floating point literals.",
    "created_at": "2013-01-05T05:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150582",
    "user": "robertwb"
}
```

Replying to [comment:6 jdemeyer]:
> Testing issue 3 with #12415 gives
> {{{
> sage -t /home/jdemeyer/doctest/tolerance_fail.py
> **********************************************************************
> File "/home/jdemeyer/doctest/tolerance_fail.py", line 2, in tolerance_fail
> Failed example:
>     1e16     # relative tol 1e-10
> Expected:
>     10^16
> Got:
>     1.00000000000000e16
> **********************************************************************
> }}}

I consider this a feature, not a bug. If we're going to allow arithmetic expressions, where do we draw the line?


```
sage: 1e16    # rel tol 1e-10
100000000^2
sage: 1e16    # rel tol 1e-10
4e15 + 6e15
sage: 1e16    # rel tol 1e-10
solve(1e16 - x, x)[0].rhs()
```


There is also the advantage of being able to write


```
sage: "%g is less than %g" % (sqrt(2), pi)   # rel tol .01
'1.41 is less than 3.14'
```


which is possible because we do a match on floating point literals.



---

archive/issue_comments_150583.json:
```json
{
    "body": "Replying to [comment:8 robertwb]:\n> I consider this a feature, not a bug.\n\n+1 (for the reasons Robert mentions)\n\nJeroen, could appropriately change the documentation in [trac_13899-doctest-rebase.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/13899/trac_13899-doctest-rebase.patch)?",
    "created_at": "2013-01-05T07:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150583",
    "user": "mstreng"
}
```

Replying to [comment:8 robertwb]:
> I consider this a feature, not a bug.

+1 (for the reasons Robert mentions)

Jeroen, could appropriately change the documentation in [trac_13899-doctest-rebase.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/13899/trac_13899-doctest-rebase.patch)?



---

archive/issue_comments_150584.json:
```json
{
    "body": "I propose the following: we add a patch to this ticket to fix the documentation concerning issue 3 and close the first two issues as fixed by #12415.",
    "created_at": "2013-01-05T08:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150584",
    "user": "jdemeyer"
}
```

I propose the following: we add a patch to this ticket to fix the documentation concerning issue 3 and close the first two issues as fixed by #12415.



---

archive/issue_comments_150585.json:
```json
{
    "body": "Replying to [comment:10 jdemeyer]:\n> I propose the following: we add a patch to this ticket to fix the documentation concerning issue 3 and close the first two issues as fixed by #12415.\n\nSounds good to me.",
    "created_at": "2013-01-05T09:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150585",
    "user": "mstreng"
}
```

Replying to [comment:10 jdemeyer]:
> I propose the following: we add a patch to this ticket to fix the documentation concerning issue 3 and close the first two issues as fixed by #12415.

Sounds good to me.



---

archive/issue_comments_150586.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-08T09:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150586",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_150587.json:
```json
{
    "body": "Attachment [12815_tolerance_doc.patch](tarball://root/attachments/some-uuid/ticket12815/12815_tolerance_doc.patch) by jdemeyer created at 2013-01-08 09:20:32\n\nPatch to clarify what tolerance testing does. Needs review.",
    "created_at": "2013-01-08T09:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150587",
    "user": "jdemeyer"
}
```

Attachment [12815_tolerance_doc.patch](tarball://root/attachments/some-uuid/ticket12815/12815_tolerance_doc.patch) by jdemeyer created at 2013-01-08 09:20:32

Patch to clarify what tolerance testing does. Needs review.



---

archive/issue_comments_150588.json:
```json
{
    "body": "Could anybody please review this ticket?",
    "created_at": "2013-01-19T10:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150588",
    "user": "jdemeyer"
}
```

Could anybody please review this ticket?



---

archive/issue_comments_150589.json:
```json
{
    "body": "Is this patch \"backwards\"?",
    "created_at": "2013-01-20T01:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150589",
    "user": "kcrisman"
}
```

Is this patch "backwards"?



---

archive/issue_comments_150590.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-20T05:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150590",
    "user": "robertwb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_150591.json:
```json
{
    "body": "No, the patch is not backwards. The description looks good to me.",
    "created_at": "2013-01-20T05:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150591",
    "user": "robertwb"
}
```

No, the patch is not backwards. The description looks good to me.



---

archive/issue_comments_150592.json:
```json
{
    "body": "> No, the patch is not backwards. The description looks good to me.\nThanks, I understand now; I was getting confused with #13899.",
    "created_at": "2013-01-21T14:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150592",
    "user": "kcrisman"
}
```

> No, the patch is not backwards. The description looks good to me.
Thanks, I understand now; I was getting confused with #13899.



---

archive/issue_comments_150593.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-21T21:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12643#issuecomment-150593",
    "user": "jdemeyer"
}
```

Resolution: fixed
