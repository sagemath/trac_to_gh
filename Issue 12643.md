# Issue 12643: bugs in doctesting script for examples with tolerance

Issue created by migration from Trac.

Original creator: mstreng

Original creation time: 2012-04-07 11:56:13

Assignee: mvngu

CC:  jhpalmieri kcrisman

Keywords: tolerance doctest

When testing the file

```
"""
EXAMPLES:

The name blah is undefined::

    sage: blah+blah
    blahblah

Here's a doctest that is out of tolerance::

    sage: 100+10000000000 # abs tol 0.1
    10000000000
    sage: 1+1
    2
"""
```

I get

```
File "/Users/marcostreng/tmp/test.sage", line 6:
    sage: blah+blah
Out of tolerance 10000000000.0 vs 10000000100.0
```

So the error of "blah is undefined" is not printed, while the "out of tolerance" is printed for the wrong test.

Also, there is a bug when a test with tolerance is the last test:

```
"""
EXAMPLES:

Doctests with tolerance cannot be followed by empty lines::

    sage: 100+10000000000 # rel tol 0.1
    10000000000
"""
```

yields

```
  File "/Users/marcostreng/.sage//tmp/test_71331.py", line 58
    ... ''', res, 0.1, 're
    ^
SyntaxError: invalid syntax
```



---

Comment by jdemeyer created at 2013-01-03 10:33:00

Changing priority from major to critical.


---

Comment by jdemeyer created at 2013-01-03 10:38:57

A patch at #13899 documents the third bug in the ticket description.


---

Comment by jdemeyer created at 2013-01-04 07:39:31

Issues 1 and 2 are fixed by #12415. Issue 3 might be "wontfix" but then the documentation needs to be changed.


---

Comment by jdemeyer created at 2013-01-04 07:43:34

Testing issue 3 with #12415 gives

```
sage -t /home/jdemeyer/doctest/tolerance_fail.py
**********************************************************************
File "/home/jdemeyer/doctest/tolerance_fail.py", line 2, in tolerance_fail
Failed example:
    1e16     # relative tol 1e-10
Expected:
    10^16
Got:
    1.00000000000000e16
**********************************************************************
```



---

Comment by mstreng created at 2013-01-04 08:10:23

Replying to [comment:6 jdemeyer]:
> Testing issue 3 with #12415 gives

Yes, and that is what the last block of changes of [trac_13899-doctest-rebase.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/13899/trac_13899-doctest-rebase.patch) is for.


---

Comment by robertwb created at 2013-01-05 05:49:15

Replying to [comment:6 jdemeyer]:
> Testing issue 3 with #12415 gives
> {{{
> sage -t /home/jdemeyer/doctest/tolerance_fail.py
> **********************************************************************
> File "/home/jdemeyer/doctest/tolerance_fail.py", line 2, in tolerance_fail
> Failed example:
>     1e16     # relative tol 1e-10
> Expected:
>     10^16
> Got:
>     1.00000000000000e16
> **********************************************************************
> }}}

I consider this a feature, not a bug. If we're going to allow arithmetic expressions, where do we draw the line?


```
sage: 1e16    # rel tol 1e-10
100000000^2
sage: 1e16    # rel tol 1e-10
4e15 + 6e15
sage: 1e16    # rel tol 1e-10
solve(1e16 - x, x)[0].rhs()
```


There is also the advantage of being able to write


```
sage: "%g is less than %g" % (sqrt(2), pi)   # rel tol .01
'1.41 is less than 3.14'
```


which is possible because we do a match on floating point literals.


---

Comment by mstreng created at 2013-01-05 07:17:31

Replying to [comment:8 robertwb]:
> I consider this a feature, not a bug.

+1 (for the reasons Robert mentions)

Jeroen, could appropriately change the documentation in [trac_13899-doctest-rebase.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/13899/trac_13899-doctest-rebase.patch)?


---

Comment by jdemeyer created at 2013-01-05 08:57:52

I propose the following: we add a patch to this ticket to fix the documentation concerning issue 3 and close the first two issues as fixed by #12415.


---

Comment by mstreng created at 2013-01-05 09:27:10

Replying to [comment:10 jdemeyer]:
> I propose the following: we add a patch to this ticket to fix the documentation concerning issue 3 and close the first two issues as fixed by #12415.

Sounds good to me.


---

Comment by jdemeyer created at 2013-01-08 09:20:32

Changing status from new to needs_review.


---

Attachment

Patch to clarify what tolerance testing does. Needs review.


---

Comment by jdemeyer created at 2013-01-19 10:34:12

Could anybody please review this ticket?


---

Comment by kcrisman created at 2013-01-20 01:46:53

Is this patch "backwards"?


---

Comment by robertwb created at 2013-01-20 05:19:00

Changing status from needs_review to positive_review.


---

Comment by robertwb created at 2013-01-20 05:19:00

No, the patch is not backwards. The description looks good to me.


---

Comment by kcrisman created at 2013-01-21 14:10:05

> No, the patch is not backwards. The description looks good to me.
Thanks, I understand now; I was getting confused with #13899.


---

Comment by jdemeyer created at 2013-01-21 21:07:32

Resolution: fixed
