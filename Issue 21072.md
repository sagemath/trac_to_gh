# Issue 21072: Package thebe.js

Issue created by migration from Trac.

Original creator: tmonteil

Original creation time: 2016-08-22 19:17:59

CC:  fcayre vdelecroix nthiery slelievre

With #20690, thebe.js is entangled within Sage source code. Since upstream is well defined, the aim of this ticket is to package it the usual way.

The zipball can be found at https://github.com/oreillymedia/thebe/archive/master.zip and should be renamed thebejs-20160822.zip (upstream does not propose explicit releases).

It can also temporarly be downloaded at https://lipn.univ-paris13.fr/~monteil/hebergement/tmp/thebejs-20160822.zip


---

Comment by tmonteil created at 2016-08-22 19:24:14

New commits:


---

Comment by tmonteil created at 2016-08-22 19:24:14

Changing status from new to needs_review.


---

Comment by tmonteil created at 2016-08-24 15:21:40

Changing keywords from "" to "sd75".


---

Comment by git created at 2016-08-25 16:45:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2016-08-25 17:12:27

We discussed this face to face with Thierry, and I made minor improvements to the text in the SPKG that he double checked over my shoulder. The files look good. I tested it, and it works.

Positive review. Thanks Thierry!


---

Comment by nthiery created at 2016-08-25 17:12:27

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2016-08-27 06:16:13

I personally would have preferred a `spkg-src` that pulls a given git commit. Downloading `master.zip` is quite likely not a repeatable operation (as in "it doesn't necessarily give you the same file every time").


---

Comment by tmonteil created at 2016-08-27 06:50:45

Would downloading thebe-9624e0a07a00026103dce1a3e32bbfbf90a6d0f9.zip instead of master.zip be satisfying ?


---

Comment by fbissey created at 2016-08-27 07:09:19

It would probably work :)


---

Comment by tmonteil created at 2016-08-27 07:24:28

Changing status from positive_review to needs_work.


---

Comment by tmonteil created at 2016-08-27 07:49:44

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2016-08-27 07:49:44

OK i have done that. The hash of the zipball changed, but according to dirdiff the content is the same.
----
New commits:


---

Comment by tmonteil created at 2016-08-29 12:34:00

Is it satisfactory like this ?


---

Comment by jdemeyer created at 2016-08-30 08:19:13

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-08-30 08:19:13

You should have the git commit in the version number. It should be possible to exactly reconstruct the tarball. The date on which it was packaged is not sufficient for that.

When you do this, also adjust the instructions in `SPKG.txt` (and perhaps replace `#20690` by the actual Trac URL).


---

Comment by jdemeyer created at 2016-08-30 08:20:11

Also: upstream calls itself `thebe`, why rename to `thebejs`?


---

Comment by nthiery created at 2016-09-04 15:30:45

Hi Thierry!
Just to avoid duplicated work: have you started implementing Jeroen's comments? otherwise I can have a go tomorrow morning with him.


---

Comment by git created at 2016-09-04 21:13:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tmonteil created at 2016-09-04 21:22:55

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2016-09-04 21:22:55

Replying to [comment:15 jdemeyer]:
> You should have the git commit in the version number. It should be possible to exactly 
> reconstruct the tarball. The date on which it was packaged is not sufficient for that.

Done.

> When you do this, also adjust the instructions in `SPKG.txt` (and perhaps replace `#20690` by the actual Trac URL).

Done.

Replying to [comment:16 jdemeyer]:
> Also: upstream calls itself `thebe`, why rename to `thebejs`?

Most javascript libs have dual names, for example `node` vs `nodejs` or `d3` vs `d3js`. Since we used the `*js` name for in other packages, i took that one, but indeed, in the case of `thebe` there is no `*js` version. So i renamed the package `thebe`as suggested.


---

Comment by jdemeyer created at 2016-09-05 06:58:47

Looks good.


---

Comment by jdemeyer created at 2016-09-05 06:58:47

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2016-09-05 12:52:52

Just expanding the ticket description to make it more explanatory.


---

Comment by fbissey created at 2016-09-07 01:10:37

I am going through this for inclusion in sage-on-gentoo. Are we taking a tarball of the whole repo to install only a 1010KB text file out of it? Why not ship it directly in `src/doc/common/themes/`? With documentation on origin and how to update it.


---

Comment by slelievre created at 2016-09-07 01:43:18

Replying to [comment:24 fbissey]:
> I am going through this for inclusion in sage-on-gentoo.
> Are we taking a tarball of the whole repo to install only a 1010KB text file out of it?

Reminds me of talks and blog posts such as
http://idlewords.com/talks/website_obesity.htm
and
https://medium.com/friendship-dot-js/i-peeked-into-my-node-modules-directory-and-you-wont-believe-what-happened-next-b89f63d21558

> Why not ship it directly in `src/doc/common/themes/`?
> With documentation on origin and how to update it.

Sounds like a good idea.


---

Comment by fbissey created at 2016-09-07 01:52:21

Well I guess it ties in with my earlier comment on #20690 #20690#comment:47 so it is also not totally disinterested. 

But it has to be overkill, I must not be the only thinking it is, once the realisation sets in.


---

Comment by nthiery created at 2016-09-07 06:05:24

#20690 originally was just including thebe.js in the Sage sources as you suggest, and it was requested that we made a proper package ... See the comments there:

    #20690#comment:24

I don't mind either solution, but let's decide quickly to get this in!


---

Comment by fbissey created at 2016-09-07 07:37:53

I can understand the point of tracking upstream, but shipping a whole tarball and only installing only one file out of it because the rest is not of interest is overkill, we don't even use the rest to build something. And it creates the problem of pointing out to the file later. Another point is that the whole repo is actually not in an installable form, it is to be used as is, the fact that upstream doesn't do release means that is not that much easier to keep track of new version.

Not pretending that there is a good solution to the problem. An additional consideration is licensing, this is MIT, can we ship it with the rest of the code of the sage documentation?


---

Comment by tmonteil created at 2016-09-07 09:28:15

It is not overkill, because the tarball of "the whole repo" is 1.2M while "the only one file" is 1M. Indeed this only one file is the compiled version of the rest (from coffee+less+js to js), which is the source (+ a few examples). Most js library ship things that way with the compiled result included. Compressed, it would make a 300K archive. Of course, we could make a `sage-src` script to recreate such a tarball. The proper way would be to ship only the source part and recompile the js "binary" ourselves, but it will require packaging coffescript and dotless (and perhaps other things). With the current situation, we have a well-defined origin for the zip-ball, easy to fetch from upstream, easy to update, easy to maintain, which follows the standard Sage packaging process.

Hardcoding things within `src/` is much worse, since:
- almost nobody will notice when the package bitrots
- we create a separate process than standard packaging, so only experts will be able to update it
- each time the package is updated, we get one additional magabyte in the Sage git repository (note that thebe.js is a compiled version, so the file is basically a single 1M line of js that will change at each update). I prefer by far having the git tree only explode by a few bytes (version number + hashes) at each update than 1M at each update.
- actually, i have hesitated to rewrite the git history of #20690 and remove the fact that this 1M of js is already once in Sage source repository.

The idea behind the current solution is in minimizing maintenance work, while staying transparent. If you insist, i can write a `sage-src` script to shrink the zipball to save 900K and let us become upstream, but i doubt there is a benefit.


---

Comment by fbissey created at 2016-09-07 09:38:08

Fine. You do the maintenance here, not me.


---

Comment by slelievre created at 2016-09-07 09:46:01

Replying to [comment:29 tmonteil]:
> It is not overkill, because the tarball of "the whole repo" is 1.2M while "the only one file" is 1M.

Thanks for your thorough explanation. It's very different from the examples I quoted.


---

Comment by jdemeyer created at 2016-09-07 12:13:18

I agree with Thierry. Distributions will be happy when we don't bundle external stuff in the Sage library.


---

Comment by fbissey created at 2016-09-07 22:25:41

Replying to [comment:32 jdemeyer]:
> I agree with Thierry. Distributions will be happy when we don't bundle external stuff in the Sage library.

<putting distro hat on> I generally agree with you on that point. I started getting agitated on this ticket after looking into packaging this for Gentoo and going `WTF` - what am I even supposed to do. Possibly I don't have experience in packaging `.js` stuff but it really left me wondering. If someone with experience packaging for debian would comment on that kind of case I'd be delighted.


---

Comment by vbraun created at 2016-09-08 19:46:05

Resolution: fixed


---

Comment by tmonteil created at 2019-08-27 19:45:19

Changing keywords from "sd75" to "sd75, sdl".
