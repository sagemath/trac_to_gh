# Issue 28805: Remove sorting of dicts

archive/issues_028805.json:
```json
{
    "body": "CC:  @jhpalmieri @dimpase @tscrim @antonio-rojas\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29042\n\n",
    "created_at": "2020-01-18T23:11:28Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Remove sorting of dicts",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28805",
    "user": "https://github.com/antonio-rojas"
}
```
CC:  @jhpalmieri @dimpase @tscrim @antonio-rojas



Issue created by migration from https://trac.sagemath.org/ticket/29042





---

archive/issue_comments_406753.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-01-18T23:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406753",
    "user": "https://github.com/antonio-rojas"
}
```

New commits:



---

archive/issue_comments_406754.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2020-01-18T23:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406754",
    "user": "https://github.com/antonio-rojas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_406755.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to refactoring.",
    "created_at": "2020-01-18T23:15:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406755",
    "user": "https://github.com/antonio-rojas"
}
```

Changing component from PLEASE CHANGE to refactoring.



---

archive/issue_comments_406756.json:
```json
{
    "body": "This is going to be quite fragile, because now you're encoding a rather arbitrary dictionary order into the doctests, where no order matters (in py3 it's probably insertion order; a change in code somewhere that changes insertion order would break tests again!).\n\nWhy not introduce a little utility function `print_dict_sorted` that recovers the sorted dictionaries? It would amount to\n\n```\nsorted( D.items(), key=lambda t:t[0])\n```\n\nbut with an appropriate routine you could print the result in a more dict-compatible way so that you can fix each doctest with a single-line edit.\n\nThat way you end up with a more future-proof fix, and it makes total sense to insert such a print routine at least into the doctest namespace (but then almost by necessity also in the interactive namespace)",
    "created_at": "2020-01-19T00:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406756",
    "user": "https://github.com/nbruin"
}
```

This is going to be quite fragile, because now you're encoding a rather arbitrary dictionary order into the doctests, where no order matters (in py3 it's probably insertion order; a change in code somewhere that changes insertion order would break tests again!).

Why not introduce a little utility function `print_dict_sorted` that recovers the sorted dictionaries? It would amount to

```
sorted( D.items(), key=lambda t:t[0])
```

but with an appropriate routine you could print the result in a more dict-compatible way so that you can fix each doctest with a single-line edit.

That way you end up with a more future-proof fix, and it makes total sense to insert such a print routine at least into the doctest namespace (but then almost by necessity also in the interactive namespace)



---

archive/issue_comments_406757.json:
```json
{
    "body": "Sounds reasonable but that's beyond my ability, so someone else will have to do it.",
    "created_at": "2020-01-25T13:09:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406757",
    "user": "https://github.com/antonio-rojas"
}
```

Sounds reasonable but that's beyond my ability, so someone else will have to do it.



---

archive/issue_comments_406758.json:
```json
{
    "body": "The idiom `sorted(D.items())` is already used in several places in the doctests. Alternatively,\n\n```\nsage: from pprint import pprint\nsage: pprint(D)\n```\n\ncould be used to print a dict sorted by keys, which also seems to take care of nested dictionaries.\n\nOn the other hand, if one really wants to keep the sorted output of dicts in general, another solution would be to add a displayhook during doctests that imitates what is currently done by IPython. This would be more robust than using `pprint` everywhere, as it is likely that new doctests depending on insertion order would be introduced in the long run otherwise.",
    "created_at": "2020-01-25T21:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406758",
    "user": "https://github.com/mwageringel"
}
```

The idiom `sorted(D.items())` is already used in several places in the doctests. Alternatively,

```
sage: from pprint import pprint
sage: pprint(D)
```

could be used to print a dict sorted by keys, which also seems to take care of nested dictionaries.

On the other hand, if one really wants to keep the sorted output of dicts in general, another solution would be to add a displayhook during doctests that imitates what is currently done by IPython. This would be more robust than using `pprint` everywhere, as it is likely that new doctests depending on insertion order would be introduced in the long run otherwise.



---

archive/issue_comments_406759.json:
```json
{
    "body": "Replying to [comment:5 gh-mwageringel]:\n> The idiom `sorted(D.items())` is already used in several places in the doctests. Alternatively,\n> {{{\n> sage: from pprint import pprint\n> sage: pprint(D)\n> }}}\n> could be used to print a dict sorted by keys, which also seems to take care of nested dictionaries\n\nThanks for the suggestion! The routine I was thinking about already exists!. I think in \"examples\" doctests, the `pprint` is a little more desirable, because its output looks like a dictionary: reading the example with the printed output barely has any additional cognitive load. For that purpose, it might be worth considering to inject `pprint` in the global namespace by default. I think it serves a real purpose now that IPython dict printing is no longer sorted.\n\n> On the other hand, if one really wants to keep the sorted output of dicts in general, another solution would be to add a displayhook during doctests that imitates what is currently done by IPython. This would be more robust than using `pprint` everywhere, as it is likely that new doctests depending on insertion order would be introduced in the long run otherwise.\n\nTrue, but that would cause a deviation between doctest output and the output that the actual example in the command line would give. The `IPython` reason for dispensing with sorting dictionaries is a good one, so I would not be in favour of bringing back that hook in general.\n\nI also think that there are legitimate reasons to make doctests that do print the dict in the \"Py3\" order, for instance if used to compare with the iteration order. In those cases it would be possible to formulate the doctests differently, no doubt, but I would rather not preempt such use. I think putting up with having to use `pprint` is reasonable, with the price that it's a magnet for fragile doctests (but in reality, doctests for lots of more complicated routines are hard to make non-fragile. By comparison I think the dict issue is relatively mild.",
    "created_at": "2020-01-26T04:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406759",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:5 gh-mwageringel]:
> The idiom `sorted(D.items())` is already used in several places in the doctests. Alternatively,
> {{{
> sage: from pprint import pprint
> sage: pprint(D)
> }}}
> could be used to print a dict sorted by keys, which also seems to take care of nested dictionaries

Thanks for the suggestion! The routine I was thinking about already exists!. I think in "examples" doctests, the `pprint` is a little more desirable, because its output looks like a dictionary: reading the example with the printed output barely has any additional cognitive load. For that purpose, it might be worth considering to inject `pprint` in the global namespace by default. I think it serves a real purpose now that IPython dict printing is no longer sorted.

> On the other hand, if one really wants to keep the sorted output of dicts in general, another solution would be to add a displayhook during doctests that imitates what is currently done by IPython. This would be more robust than using `pprint` everywhere, as it is likely that new doctests depending on insertion order would be introduced in the long run otherwise.

True, but that would cause a deviation between doctest output and the output that the actual example in the command line would give. The `IPython` reason for dispensing with sorting dictionaries is a good one, so I would not be in favour of bringing back that hook in general.

I also think that there are legitimate reasons to make doctests that do print the dict in the "Py3" order, for instance if used to compare with the iteration order. In those cases it would be possible to formulate the doctests differently, no doubt, but I would rather not preempt such use. I think putting up with having to use `pprint` is reasonable, with the price that it's a magnet for fragile doctests (but in reality, doctests for lots of more complicated routines are hard to make non-fragile. By comparison I think the dict issue is relatively mild.



---

archive/issue_comments_406760.json:
```json
{
    "body": "Replying to [comment:6 nbruin]:\n> For that purpose, it might be worth considering to inject `pprint` in the global namespace by default. I think it serves a real purpose now that IPython dict printing is no longer sorted.\n\nIn that case, rather than injecting `pprint`, it might be better to improve the pretty print function that already exists in the global namespace, for example by adding a new keyword `pretty_print(D, sort=True)`. IMO, this makes it clearer why the pretty printing is used. This is synonymous to `show(D, sort=True)`.\n\n> True, but that would cause a deviation between doctest output and the output that the actual example in the command line would give. The `IPython` reason for dispensing with sorting dictionaries is a good one, so I would not be in favour of bringing back that hook in general.\n\nThis deviation already exists, as the IPython sorting of dicts is only active during doctests. That said though, I do not have a strong preference for either solution \u2013 though I agree it is generally desirable to keep doctest output as close as possible to the actual output.",
    "created_at": "2020-01-26T17:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406760",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:6 nbruin]:
> For that purpose, it might be worth considering to inject `pprint` in the global namespace by default. I think it serves a real purpose now that IPython dict printing is no longer sorted.

In that case, rather than injecting `pprint`, it might be better to improve the pretty print function that already exists in the global namespace, for example by adding a new keyword `pretty_print(D, sort=True)`. IMO, this makes it clearer why the pretty printing is used. This is synonymous to `show(D, sort=True)`.

> True, but that would cause a deviation between doctest output and the output that the actual example in the command line would give. The `IPython` reason for dispensing with sorting dictionaries is a good one, so I would not be in favour of bringing back that hook in general.

This deviation already exists, as the IPython sorting of dicts is only active during doctests. That said though, I do not have a strong preference for either solution â€“ though I agree it is generally desirable to keep doctest output as close as possible to the actual output.



---

archive/issue_comments_406761.json:
```json
{
    "body": "Replying to [comment:7 gh-mwageringel]:\n\n> In that case, rather than injecting `pprint`, it might be better to improve the pretty print function that already exists in the global namespace, for example by adding a new keyword `pretty_print(D, sort=True)`. IMO, this makes it clearer why the pretty printing is used. This is synonymous to `show(D, sort=True)`.\n\nIt seems pretty_print aims at a different target: its default is latex output in the command line (that's a bad default), and in general \"this function chooses the highest-quality output supported by the user interface\", so that doesn't quite hit the goals of doctests (which should be concise and human-readable).\n\nIf we do\n\n```\ndm = get_display_manager()\ndm.preferences.text='plain'\n```\n\nwe end up with better results for our doctesting purposes. But that would be worse than `from pprint import pprint`.",
    "created_at": "2020-01-27T02:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406761",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:7 gh-mwageringel]:

> In that case, rather than injecting `pprint`, it might be better to improve the pretty print function that already exists in the global namespace, for example by adding a new keyword `pretty_print(D, sort=True)`. IMO, this makes it clearer why the pretty printing is used. This is synonymous to `show(D, sort=True)`.

It seems pretty_print aims at a different target: its default is latex output in the command line (that's a bad default), and in general "this function chooses the highest-quality output supported by the user interface", so that doesn't quite hit the goals of doctests (which should be concise and human-readable).

If we do

```
dm = get_display_manager()
dm.preferences.text='plain'
```

we end up with better results for our doctesting purposes. But that would be worse than `from pprint import pprint`.



---

archive/issue_comments_406762.json:
```json
{
    "body": "Replying to [comment:8 nbruin]:\n> It seems pretty_print aims at a different target: its default is latex output in the command line (that's a bad default), and in general \"this function chooses the highest-quality output supported by the user interface\", so that doesn't quite hit the goals of doctests (which should be concise and human-readable).\n\nI fail to see the rationale behind defaulting to latex, or the intended use case of `pretty_print`. Making a distinction between `%display plain` and `%display None` is bizarre and seems wrong to me. The usual REPL output at least does not make such a distinction (implemented in `sage.repl.rich_output.display_manager.DisplayManager._preferred_text_formatter`).\n\nShould we add `pprint` to the global namespace then? I am not sure this is the best thing to do, but it seems practical. Or just add explicit `from pprint import pprint` statements in the doctests?",
    "created_at": "2020-01-27T18:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406762",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:8 nbruin]:
> It seems pretty_print aims at a different target: its default is latex output in the command line (that's a bad default), and in general "this function chooses the highest-quality output supported by the user interface", so that doesn't quite hit the goals of doctests (which should be concise and human-readable).

I fail to see the rationale behind defaulting to latex, or the intended use case of `pretty_print`. Making a distinction between `%display plain` and `%display None` is bizarre and seems wrong to me. The usual REPL output at least does not make such a distinction (implemented in `sage.repl.rich_output.display_manager.DisplayManager._preferred_text_formatter`).

Should we add `pprint` to the global namespace then? I am not sure this is the best thing to do, but it seems practical. Or just add explicit `from pprint import pprint` statements in the doctests?



---

archive/issue_comments_406763.json:
```json
{
    "body": "It seems to me that it would be good to discuss this at sage-devel, because it affects all developers.\n\nLet me add that it is unclear to me what the best solution is.  Initially, I liked the idea of `pretty_print(D, sort=True)`.  I think that yet another pretty print function is a bad idea, I find the existence of `show`, `pretty_print`, `ascii_art`, `.pp()` and possibly others confusing enough.",
    "created_at": "2020-01-27T21:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406763",
    "user": "https://github.com/mantepse"
}
```

It seems to me that it would be good to discuss this at sage-devel, because it affects all developers.

Let me add that it is unclear to me what the best solution is.  Initially, I liked the idea of `pretty_print(D, sort=True)`.  I think that yet another pretty print function is a bad idea, I find the existence of `show`, `pretty_print`, `ascii_art`, `.pp()` and possibly others confusing enough.



---

archive/issue_comments_406764.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-03T07:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406764",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406765.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-02T21:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406765",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406766.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-08T18:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406766",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406767.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-11T21:29:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406767",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406768.json:
```json
{
    "body": "This needs rebasing. My own thinking is that calling the structure dictionary lead humans to have an expectation for it to be ordered the way the physical object is. In fact we have look up tables which are very handy for the computer to manipulate but not necessarily  meant for full display. In most case sorting doesn't matter objectively. \n\nSo I am not sure we should compare whole dictionaries for doctests. Size of the dictionary and some key elements should be enough.",
    "created_at": "2020-03-29T01:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406768",
    "user": "https://github.com/kiwifb"
}
```

This needs rebasing. My own thinking is that calling the structure dictionary lead humans to have an expectation for it to be ordered the way the physical object is. In fact we have look up tables which are very handy for the computer to manipulate but not necessarily  meant for full display. In most case sorting doesn't matter objectively. 

So I am not sure we should compare whole dictionaries for doctests. Size of the dictionary and some key elements should be enough.



---

archive/issue_comments_406769.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-29T08:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406769",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406770.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-29T14:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406770",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406771.json:
```json
{
    "body": "Replying to [comment:15 fbissey]:\n> My own thinking is that calling the structure dictionary lead humans to have an expectation for it to be ordered the way the physical object is. In fact we have look up tables which are very handy for the computer to manipulate but not necessarily  meant for full display. In most case sorting doesn't matter objectively. \n> \n> So I am not sure we should compare whole dictionaries for doctests. Size of the dictionary and some key elements should be enough.\n\nI agree that generally doctests should be focussed on testing very specific things rather than entire dictionaries. Rewriting all these doctests case-by-case so that dictionaries are not printed anymore seems like a huge task though.\n\nAs the current patch also seems to fail with 32-bit, it still seems to me that the simplest approach to move forward with this is to extend `pretty_print` by a sort keyword. A first step for this is #29136, needing review, which stops `pretty_print` from outputting latex on the command line.\n\nFor reference, this problem was discussed in this [thread on devel](https://groups.google.com/d/msg/sage-devel/fXrv4JC6NEI/LwIcVb5EEwAJ) and there does not seem to be much disagreement about this.",
    "created_at": "2020-04-05T14:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406771",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:15 fbissey]:
> My own thinking is that calling the structure dictionary lead humans to have an expectation for it to be ordered the way the physical object is. In fact we have look up tables which are very handy for the computer to manipulate but not necessarily  meant for full display. In most case sorting doesn't matter objectively. 
> 
> So I am not sure we should compare whole dictionaries for doctests. Size of the dictionary and some key elements should be enough.

I agree that generally doctests should be focussed on testing very specific things rather than entire dictionaries. Rewriting all these doctests case-by-case so that dictionaries are not printed anymore seems like a huge task though.

As the current patch also seems to fail with 32-bit, it still seems to me that the simplest approach to move forward with this is to extend `pretty_print` by a sort keyword. A first step for this is #29136, needing review, which stops `pretty_print` from outputting latex on the command line.

For reference, this problem was discussed in this [thread on devel](https://groups.google.com/d/msg/sage-devel/fXrv4JC6NEI/LwIcVb5EEwAJ) and there does not seem to be much disagreement about this.



---

archive/issue_comments_406772.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-13T15:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406772",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406773.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406773",
    "user": "https://github.com/mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_406774.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-23T16:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406774",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406775.json:
```json
{
    "body": "Is there really not a better way to do these doctest updates that can be agreed on? Using `sorted(D.items())` as suggested early on this ticket seems much more reasonable",
    "created_at": "2020-04-23T16:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406775",
    "user": "https://github.com/mkoeppe"
}
```

Is there really not a better way to do these doctest updates that can be agreed on? Using `sorted(D.items())` as suggested early on this ticket seems much more reasonable



---

archive/issue_comments_406776.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-05T07:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406776",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_406777.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> Is there really not a better way to do these doctest updates that can be agreed on? Using `sorted(D.items())` as suggested early on this ticket seems much more reasonable\n\nIt is a quite economical way to do things. But we have to document somewhere how dictionaries have to tested going forward. As far as I can see people still want or keep testing full dictionaries. Which leaves two options\n* `sorted` if we are sure it does the job in every case\n* since we are typing the whole dictionary anyway, create a `expected_dict` populated with expected value and compare it to the result dictionary we get. I would hope dictionary comparison doesn't care about sorting.",
    "created_at": "2020-05-22T08:21:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406777",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:22 mkoeppe]:
> Is there really not a better way to do these doctest updates that can be agreed on? Using `sorted(D.items())` as suggested early on this ticket seems much more reasonable

It is a quite economical way to do things. But we have to document somewhere how dictionaries have to tested going forward. As far as I can see people still want or keep testing full dictionaries. Which leaves two options
* `sorted` if we are sure it does the job in every case
* since we are typing the whole dictionary anyway, create a `expected_dict` populated with expected value and compare it to the result dictionary we get. I would hope dictionary comparison doesn't care about sorting.



---

archive/issue_comments_406778.json:
```json
{
    "body": "And I think we may want to remove that one altogether\n\n```\nFile \"/usr/lib/python3.7/site-packages/sage/repl/display/pretty_print.py\", line 85, in sage.repl.display.pretty_print.SagePrettyPrinter.__init__\nFailed example:\n    dict(zzz=123, aaa=99, xab=10)    # sorted by keys\nExpected:\n    {'aaa': 99, 'xab': 10, 'zzz': 123}\nGot:\n    {'zzz': 123, 'aaa': 99, 'xab': 10}\n```\n\nWhich comes from\n\n```\n        IPython pretty printers::\n\n            sage: set({1, 2, 3})\n            {1, 2, 3}\n            sage: dict(zzz=123, aaa=99, xab=10)    # sorted by keys\n            {'aaa': 99, 'xab': 10, 'zzz': 123}\n```\n\nPretty print no more.",
    "created_at": "2020-05-22T08:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406778",
    "user": "https://github.com/kiwifb"
}
```

And I think we may want to remove that one altogether

```
File "/usr/lib/python3.7/site-packages/sage/repl/display/pretty_print.py", line 85, in sage.repl.display.pretty_print.SagePrettyPrinter.__init__
Failed example:
    dict(zzz=123, aaa=99, xab=10)    # sorted by keys
Expected:
    {'aaa': 99, 'xab': 10, 'zzz': 123}
Got:
    {'zzz': 123, 'aaa': 99, 'xab': 10}
```

Which comes from

```
        IPython pretty printers::

            sage: set({1, 2, 3})
            {1, 2, 3}
            sage: dict(zzz=123, aaa=99, xab=10)    # sorted by keys
            {'aaa': 99, 'xab': 10, 'zzz': 123}
```

Pretty print no more.



---

archive/issue_comments_406779.json:
```json
{
    "body": "I am looking at some stuff in .rst file. It is both doctests and documentation. For example in `doc/en/prep/Advanced-2DPlotting.rst`\n\n```\nHere are the options for contour plots.\n\n- They are given as an \"attribute\" \\- no parentheses \\- of the\n  ``contour_plot`` object.\n\n- They are given as a dictionary (see :ref:`the programming tutorial\n  <Advanced>`).\n\n::\n\n    sage: contour_plot.options\n    {'aspect_ratio': 1,\n     'axes': False,\n     'colorbar': False,\n     'contours': None,\n     'fill': True,\n     'frame': True,\n     'labels': False,\n     'legend_label': None,\n     'linestyles': None,\n     'linewidths': None,\n     'plot_points': 100,\n     'region': None}\n```\n\nthe documentation aspect doesn't really care about the sorting. It is just displaying. But this is doctested as well which does. Using an `expected_dict` variable doesn't make sense in this context. If we use `sorted` we have to make a note about it in the documentation that it is just to make presentation consistent. If we just reproduce the output, the order may change unexpectedly.",
    "created_at": "2020-05-22T09:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406779",
    "user": "https://github.com/kiwifb"
}
```

I am looking at some stuff in .rst file. It is both doctests and documentation. For example in `doc/en/prep/Advanced-2DPlotting.rst`

```
Here are the options for contour plots.

- They are given as an "attribute" \- no parentheses \- of the
  ``contour_plot`` object.

- They are given as a dictionary (see :ref:`the programming tutorial
  <Advanced>`).

::

    sage: contour_plot.options
    {'aspect_ratio': 1,
     'axes': False,
     'colorbar': False,
     'contours': None,
     'fill': True,
     'frame': True,
     'labels': False,
     'legend_label': None,
     'linestyles': None,
     'linewidths': None,
     'plot_points': 100,
     'region': None}
```

the documentation aspect doesn't really care about the sorting. It is just displaying. But this is doctested as well which does. Using an `expected_dict` variable doesn't make sense in this context. If we use `sorted` we have to make a note about it in the documentation that it is just to make presentation consistent. If we just reproduce the output, the order may change unexpectedly.



---

archive/issue_comments_406780.json:
```json
{
    "body": "Maybe we should just label that as \"random\".",
    "created_at": "2020-05-22T17:30:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406780",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe we should just label that as "random".



---

archive/issue_comments_406781.json:
```json
{
    "body": "Replying to [comment:29 jhpalmieri]:\n> Maybe we should just label that as \"random\".\n\nI thought about that. Does it show in generated html/pdf?",
    "created_at": "2020-05-22T20:05:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406781",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:29 jhpalmieri]:
> Maybe we should just label that as "random".

I thought about that. Does it show in generated html/pdf?



---

archive/issue_comments_406782.json:
```json
{
    "body": "Replying to [comment:30 fbissey]:\n> Replying to [comment:29 jhpalmieri]:\n> > Maybe we should just label that as \"random\".\n> \n> I thought about that. Does it show in generated html/pdf?\n\nIt does. We could add a remark beforehand: `The following is marked \"random\" because Python may print dictionaries in an unpredictable order`. I think I've done this sort of thing with other doctests tagged `random`.",
    "created_at": "2020-05-22T21:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406782",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:30 fbissey]:
> Replying to [comment:29 jhpalmieri]:
> > Maybe we should just label that as "random".
> 
> I thought about that. Does it show in generated html/pdf?

It does. We could add a remark beforehand: `The following is marked "random" because Python may print dictionaries in an unpredictable order`. I think I've done this sort of thing with other doctests tagged `random`.



---

archive/issue_comments_406783.json:
```json
{
    "body": "The problem is that it also accepts something like `2` as being equal. I am -1 a strong on marking things as `# random` and instead replacing them with more meaningful doctests (like comparing the result to a fixed dictionary, or getting specific values in the result, etc.).",
    "created_at": "2020-05-23T00:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406783",
    "user": "https://github.com/tscrim"
}
```

The problem is that it also accepts something like `2` as being equal. I am -1 a strong on marking things as `# random` and instead replacing them with more meaningful doctests (like comparing the result to a fixed dictionary, or getting specific values in the result, etc.).



---

archive/issue_comments_406784.json:
```json
{
    "body": "Replying to [comment:32 tscrim]:\n> The problem is that it also accepts something like `2` as being equal. \n\nYou are losing me here. Can you expand?\n\n> I am -1 a strong on marking things as `# random` and instead replacing them with more meaningful doctests (like comparing the result to a fixed dictionary, or getting specific values in the result, etc.).\n\nWe are talking about only putting `random` in specific documentation where it doesn't matter and ordering would look weird. But even there I would agree on getting as specific as possible to avoid having to do it. For example, in the same file as comment:28 and after it we have\n\n```\nsage: contour_plot.options[\"fill\"]=False\nsage: contour_plot.options\n{'aspect_ratio': 1,\n 'axes': False,\n 'colorbar': False,\n 'contours': None,\n 'fill': False,\n 'frame': True,\n 'labels': False,\n 'legend_label': None,\n 'linestyles': None,\n 'linewidths': None,\n 'plot_points': 100,\n 'region': None}\n```\n\nWhere we could look specifically at the concerned dictionary element. But the one in comment:28 is part of an exposition of a feature. It feels ridicule to compare the output or to to artificially order it as opposed to just mentioning that the elements are not always in that order.\n\nWe have to use some common sense on what is appropriate and what isn't.",
    "created_at": "2020-05-23T01:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406784",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:32 tscrim]:
> The problem is that it also accepts something like `2` as being equal. 

You are losing me here. Can you expand?

> I am -1 a strong on marking things as `# random` and instead replacing them with more meaningful doctests (like comparing the result to a fixed dictionary, or getting specific values in the result, etc.).

We are talking about only putting `random` in specific documentation where it doesn't matter and ordering would look weird. But even there I would agree on getting as specific as possible to avoid having to do it. For example, in the same file as comment:28 and after it we have

```
sage: contour_plot.options["fill"]=False
sage: contour_plot.options
{'aspect_ratio': 1,
 'axes': False,
 'colorbar': False,
 'contours': None,
 'fill': False,
 'frame': True,
 'labels': False,
 'legend_label': None,
 'linestyles': None,
 'linewidths': None,
 'plot_points': 100,
 'region': None}
```

Where we could look specifically at the concerned dictionary element. But the one in comment:28 is part of an exposition of a feature. It feels ridicule to compare the output or to to artificially order it as opposed to just mentioning that the elements are not always in that order.

We have to use some common sense on what is appropriate and what isn't.



---

archive/issue_comments_406785.json:
```json
{
    "body": "Replying to [comment:33 fbissey]:\n> Replying to [comment:32 tscrim]:\n> > The problem is that it also accepts something like `2` as being equal. \n> \n> You are losing me here. Can you expand?\n\nIf you have\n\n```\nsage: foo  # random\n2 + 2\n```\n\nthis also will pass even if `foo` is a `dict` or `'fish'` (i.e. I can make `2 + 2 = 'fish'`).\n\n> > I am -1 a strong on marking things as `# random` and instead replacing them with more meaningful doctests (like comparing the result to a fixed dictionary, or getting specific values in the result, etc.).\n> \n> We are talking about only putting `random` in specific documentation where it doesn't matter and ordering would look weird. But even there I would agree on getting as specific as possible to avoid having to do it. For example, in the same file as comment:28\n\nAh, I see. I misinterpreted what you were asking about. I was thinking it was being made as a more broad statement. Sorry.\n\n> Where we could look specifically at the concerned dictionary element. But the one in comment:28 is part of an exposition of a feature. It feels ridicule to compare the output or to to artificially order it as opposed to just mentioning that the elements are not always in that order.\n> \n> We have to use some common sense on what is appropriate and what isn't.\n\nI guess in this case because it is meant to be for an illustrative purpose that it is fine for a `# random` with an explanation.",
    "created_at": "2020-05-23T02:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406785",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:33 fbissey]:
> Replying to [comment:32 tscrim]:
> > The problem is that it also accepts something like `2` as being equal. 
> 
> You are losing me here. Can you expand?

If you have

```
sage: foo  # random
2 + 2
```

this also will pass even if `foo` is a `dict` or `'fish'` (i.e. I can make `2 + 2 = 'fish'`).

> > I am -1 a strong on marking things as `# random` and instead replacing them with more meaningful doctests (like comparing the result to a fixed dictionary, or getting specific values in the result, etc.).
> 
> We are talking about only putting `random` in specific documentation where it doesn't matter and ordering would look weird. But even there I would agree on getting as specific as possible to avoid having to do it. For example, in the same file as comment:28

Ah, I see. I misinterpreted what you were asking about. I was thinking it was being made as a more broad statement. Sorry.

> Where we could look specifically at the concerned dictionary element. But the one in comment:28 is part of an exposition of a feature. It feels ridicule to compare the output or to to artificially order it as opposed to just mentioning that the elements are not always in that order.
> 
> We have to use some common sense on what is appropriate and what isn't.

I guess in this case because it is meant to be for an illustrative purpose that it is fine for a `# random` with an explanation.



---

archive/issue_comments_406786.json:
```json
{
    "body": "Yes, I was only talking about this specific doctest, not all of these. I think we're in agreement, but to make it explicit: my approach is to try to understand what the doctest is testing. If it's merely illustrative, I don't mind tagging it with `random`. This is especially true if the same functionality is tested robustly elsewhere, although to be honest, I didn't check that in this case. Of course a `random` tag is no good if you're actually trying to test the output.",
    "created_at": "2020-05-23T03:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406786",
    "user": "https://github.com/jhpalmieri"
}
```

Yes, I was only talking about this specific doctest, not all of these. I think we're in agreement, but to make it explicit: my approach is to try to understand what the doctest is testing. If it's merely illustrative, I don't mind tagging it with `random`. This is especially true if the same functionality is tested robustly elsewhere, although to be honest, I didn't check that in this case. Of course a `random` tag is no good if you're actually trying to test the output.



---

archive/issue_comments_406787.json:
```json
{
    "body": "It is much tougher than I expected. What do you do with cases like that?\n\n```\nRepresentatives of all divisor classes with nontrivial homology::\n\n    sage: p = S.betti_complexes()\n    sage: p[0]\n    [{0: -8, 1: 5, 2: 4, 3: 1},\n     Simplicial complex with vertex set (1, 2, 3) and facets {(3,), (1, 2)}]\n```\n\nin `src/doc/en/thematic_tutorials/sandpile.rst`.  A list with a dictionary as an element and I don't want to destroy the exposition element.",
    "created_at": "2020-05-23T09:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406787",
    "user": "https://github.com/kiwifb"
}
```

It is much tougher than I expected. What do you do with cases like that?

```
Representatives of all divisor classes with nontrivial homology::

    sage: p = S.betti_complexes()
    sage: p[0]
    [{0: -8, 1: 5, 2: 4, 3: 1},
     Simplicial complex with vertex set (1, 2, 3) and facets {(3,), (1, 2)}]
```

in `src/doc/en/thematic_tutorials/sandpile.rst`.  A list with a dictionary as an element and I don't want to destroy the exposition element.



---

archive/issue_comments_406788.json:
```json
{
    "body": "\n```\nsage: from pprint import pprint\nsage: pprint(p[0])\n[{0: -8, 1: 5, 2: 4, 3: 1},\n Simplicial complex with vertex set (1, 2, 3) and facets {(3,), (1, 2)}]\n```\n",
    "created_at": "2020-05-23T09:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406788",
    "user": "https://github.com/mwageringel"
}
```


```
sage: from pprint import pprint
sage: pprint(p[0])
[{0: -8, 1: 5, 2: 4, 3: 1},
 Simplicial complex with vertex set (1, 2, 3) and facets {(3,), (1, 2)}]
```




---

archive/issue_comments_406789.json:
```json
{
    "body": "Yes, it is probably best here. And while they weren't apparently broken by ipython >= 7.10 there are other instances in that file that probably should be `pprint`-ed.",
    "created_at": "2020-05-23T09:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406789",
    "user": "https://github.com/kiwifb"
}
```

Yes, it is probably best here. And while they weren't apparently broken by ipython >= 7.10 there are other instances in that file that probably should be `pprint`-ed.



---

archive/issue_comments_406790.json:
```json
{
    "body": "Attaching a WIP branch for people to comment on. I tried to use an appropriate method depending on the context. The branch focuses on the `.rst` files under `src/doc` with the idea that they may present a good sample of issues.\n----\nNew commits:",
    "created_at": "2020-05-23T10:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406790",
    "user": "https://github.com/kiwifb"
}
```

Attaching a WIP branch for people to comment on. I tried to use an appropriate method depending on the context. The branch focuses on the `.rst` files under `src/doc` with the idea that they may present a good sample of issues.
----
New commits:



---

archive/issue_comments_406791.json:
```json
{
    "body": "I have not as much time to deal with this as I thought. If someone wants to take over or go back to arojas' branch, it is fine by me.",
    "created_at": "2020-06-01T09:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406791",
    "user": "https://github.com/kiwifb"
}
```

I have not as much time to deal with this as I thought. If someone wants to take over or go back to arojas' branch, it is fine by me.



---

archive/issue_comments_406792.json:
```json
{
    "body": "I am maintaining the patch downstream anyway, so I can push it here for other packagers  to use it until someone makes a decision on this (I'm not planning to work on implementing a different solution myself)",
    "created_at": "2020-06-01T09:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406792",
    "user": "https://github.com/antonio-rojas"
}
```

I am maintaining the patch downstream anyway, so I can push it here for other packagers  to use it until someone makes a decision on this (I'm not planning to work on implementing a different solution myself)



---

archive/issue_comments_406793.json:
```json
{
    "body": "Also, I don't see the need to give a final solution to this *now*. We could just merge my patch to unblock the ipython upgrade, and keep this open to implement a different solution when someone has time/willingness to work on it.\n\nEDIT: Actually, I forgot about 32-bit, so it seems the patch can't be merged as-is anyway",
    "created_at": "2020-06-01T10:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406793",
    "user": "https://github.com/antonio-rojas"
}
```

Also, I don't see the need to give a final solution to this *now*. We could just merge my patch to unblock the ipython upgrade, and keep this open to implement a different solution when someone has time/willingness to work on it.

EDIT: Actually, I forgot about 32-bit, so it seems the patch can't be merged as-is anyway



---

archive/issue_comments_406794.json:
```json
{
    "body": "Darn 32-bit. I otherwise agree with you. We can make this better at a later stage.",
    "created_at": "2020-06-01T10:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406794",
    "user": "https://github.com/kiwifb"
}
```

Darn 32-bit. I otherwise agree with you. We can make this better at a later stage.



---

archive/issue_comments_406795.json:
```json
{
    "body": "I don't quite understand what this ticket is about:\n` This will break the affected doctests (but not functionality) on python2`\n\n9.2 has nothing to do with python2. We can break it, why not?",
    "created_at": "2020-06-01T11:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406795",
    "user": "https://github.com/dimpase"
}
```

I don't quite understand what this ticket is about:
` This will break the affected doctests (but not functionality) on python2`

9.2 has nothing to do with python2. We can break it, why not?



---

archive/issue_comments_406796.json:
```json
{
    "body": "Replying to [comment:45 dimpase]:\n> I don't quite understand what this ticket is about:\n> ` This will break the affected doctests (but not functionality) on python2`\n> \n> 9.2 has nothing to do with python2. We can break it, why not?\n\nThis was opened in January",
    "created_at": "2020-06-01T11:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406796",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:45 dimpase]:
> I don't quite understand what this ticket is about:
> ` This will break the affected doctests (but not functionality) on python2`
> 
> 9.2 has nothing to do with python2. We can break it, why not?

This was opened in January



---

archive/issue_comments_406797.json:
```json
{
    "body": "is anything needed here for py3 ?",
    "created_at": "2020-06-01T11:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406797",
    "user": "https://github.com/dimpase"
}
```

is anything needed here for py3 ?



---

archive/issue_comments_406798.json:
```json
{
    "body": "Yes - this is meant to fix the breakage that will happen in tests when upgrading ipython. \"This will break the affected doctests (but not functionality) on python2\" refers to the proposed patch at the time.",
    "created_at": "2020-06-01T11:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406798",
    "user": "https://github.com/antonio-rojas"
}
```

Yes - this is meant to fix the breakage that will happen in tests when upgrading ipython. "This will break the affected doctests (but not functionality) on python2" refers to the proposed patch at the time.



---

archive/issue_comments_406799.json:
```json
{
    "body": "Could someone knowledgeable about the ticket please amend its description?",
    "created_at": "2020-06-01T11:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406799",
    "user": "https://github.com/dimpase"
}
```

Could someone knowledgeable about the ticket please amend its description?



---

archive/issue_comments_406800.json:
```json
{
    "body": "Maybe removing the sorting of dictionaries isn't necessary. We can just overwrite the pretty print function during testing:\n\n\n```diff\n+++ b/src/sage/doctest/forker.py\n@@ -61,6 +61,7 @@ from .parsing import SageOutputChecker, pre_hash, get_source\n from sage.repl.user_globals import set_globals\n from sage.cpython.atexit import restore_atexit\n from sage.cpython.string import bytes_to_str, str_to_bytes\n+import IPython.lib.pretty\n \n \n # All doctests run as if the following future imports are present\n@@ -86,6 +87,27 @@ _OSError_SUBCLASSES = [\n        exc is not OSError\n ]\n \n+def _sorted_dict_pprinter_factory(start, end):\n+    \"\"\"\n+    Factory that returns a pprint function used by the default pprint of\n+    dicts and dict proxies.\n+    \"\"\"\n+    def inner(obj, p, cycle):\n+        if cycle:\n+            return p.text('{...}')\n+        step = len(start)\n+        p.begin_group(step, start)\n+        keys = obj.keys()\n+        keys = IPython.lib.pretty._sorted_for_pprint(keys)\n+        for idx, key in p._enumerate(keys):\n+            if idx:\n+                p.text(',')\n+                p.breakable()\n+            p.pretty(key)\n+            p.text(': ')\n+            p.pretty(obj[key])\n+        p.end_group(step, end)\n+    return inner\n \n \n def init_sage():\n@@ -185,11 +207,11 @@ def init_sage():\n     # IPython's pretty printer sorts the repr of dicts by their keys by default\n     # (or their keys' str() if they are not otherwise orderable).  However, it\n     # disables this for CPython 3.6+ opting to instead display dicts' \"natural\"\n-    # insertion order, which is preserved in those versions).  This makes for\n-    # inconsistent results with Python 2 tests that return dicts, so here we\n-    # force the Python 2 style dict printing\n-    import IPython.lib.pretty\n-    IPython.lib.pretty.DICT_IS_ORDERED = False\n+    # insertion order, which is preserved in those versions).\n+    # However, this order is random in some instances.\n+    # Also code changes may change the order, but the result stays correct.\n+    # So we force sorting the dictionary.\n+    IPython.lib.pretty.for_type(dict, _sorted_dict_pprinter_factory('{', '}'))\n \n     # Switch on extra debugging\n     from sage.structure.debug_options import debug\n```\n\n\nThis appears to do the job. I'm testing the entire library now.",
    "created_at": "2020-06-05T09:03:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406800",
    "user": "https://github.com/kliem"
}
```

Maybe removing the sorting of dictionaries isn't necessary. We can just overwrite the pretty print function during testing:


```diff
+++ b/src/sage/doctest/forker.py
@@ -61,6 +61,7 @@ from .parsing import SageOutputChecker, pre_hash, get_source
 from sage.repl.user_globals import set_globals
 from sage.cpython.atexit import restore_atexit
 from sage.cpython.string import bytes_to_str, str_to_bytes
+import IPython.lib.pretty
 
 
 # All doctests run as if the following future imports are present
@@ -86,6 +87,27 @@ _OSError_SUBCLASSES = [
        exc is not OSError
 ]
 
+def _sorted_dict_pprinter_factory(start, end):
+    """
+    Factory that returns a pprint function used by the default pprint of
+    dicts and dict proxies.
+    """
+    def inner(obj, p, cycle):
+        if cycle:
+            return p.text('{...}')
+        step = len(start)
+        p.begin_group(step, start)
+        keys = obj.keys()
+        keys = IPython.lib.pretty._sorted_for_pprint(keys)
+        for idx, key in p._enumerate(keys):
+            if idx:
+                p.text(',')
+                p.breakable()
+            p.pretty(key)
+            p.text(': ')
+            p.pretty(obj[key])
+        p.end_group(step, end)
+    return inner
 
 
 def init_sage():
@@ -185,11 +207,11 @@ def init_sage():
     # IPython's pretty printer sorts the repr of dicts by their keys by default
     # (or their keys' str() if they are not otherwise orderable).  However, it
     # disables this for CPython 3.6+ opting to instead display dicts' "natural"
-    # insertion order, which is preserved in those versions).  This makes for
-    # inconsistent results with Python 2 tests that return dicts, so here we
-    # force the Python 2 style dict printing
-    import IPython.lib.pretty
-    IPython.lib.pretty.DICT_IS_ORDERED = False
+    # insertion order, which is preserved in those versions).
+    # However, this order is random in some instances.
+    # Also code changes may change the order, but the result stays correct.
+    # So we force sorting the dictionary.
+    IPython.lib.pretty.for_type(dict, _sorted_dict_pprinter_factory('{', '}'))
 
     # Switch on extra debugging
     from sage.structure.debug_options import debug
```


This appears to do the job. I'm testing the entire library now.



---

archive/issue_comments_406801.json:
```json
{
    "body": "`sage -t --long --all` passes for me with this branch.\n----\nNew commits:",
    "created_at": "2020-06-05T10:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406801",
    "user": "https://github.com/kliem"
}
```

`sage -t --long --all` passes for me with this branch.
----
New commits:



---

archive/issue_comments_406802.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-05T10:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406802",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_406803.json:
```json
{
    "body": "I can do some testing tomorrow. It looks so much simpler.",
    "created_at": "2020-06-05T11:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406803",
    "user": "https://github.com/kiwifb"
}
```

I can do some testing tomorrow. It looks so much simpler.



---

archive/issue_comments_406804.json:
```json
{
    "body": "I was suprised how easy this actually is. Took me a number of hours to figure out though.",
    "created_at": "2020-06-05T12:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406804",
    "user": "https://github.com/kliem"
}
```

I was suprised how easy this actually is. Took me a number of hours to figure out though.



---

archive/issue_comments_406805.json:
```json
{
    "body": "Does this need new iPython?",
    "created_at": "2020-06-05T12:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406805",
    "user": "https://github.com/dimpase"
}
```

Does this need new iPython?



---

archive/issue_comments_406806.json:
```json
{
    "body": "No, I didn't upgrade and it worked for me.\n\nThe function `_sorted_for_pprint` that it uses requires iPython at least 5:\n\nhttps://github.com/ipython/ipython/blob/5.x/IPython/lib/pretty.py\n\nIf that is a problem or if this is ever removed, we can just copy paste this tiny function.\n\nThe function `for_type` has been in their since IPython version 1. So I hope that it is somewhat stable.",
    "created_at": "2020-06-05T12:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406806",
    "user": "https://github.com/kliem"
}
```

No, I didn't upgrade and it worked for me.

The function `_sorted_for_pprint` that it uses requires iPython at least 5:

https://github.com/ipython/ipython/blob/5.x/IPython/lib/pretty.py

If that is a problem or if this is ever removed, we can just copy paste this tiny function.

The function `for_type` has been in their since IPython version 1. So I hope that it is somewhat stable.



---

archive/issue_comments_406807.json:
```json
{
    "body": "Works for me. That's one of the things I would like to see merged soon.",
    "created_at": "2020-06-06T03:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406807",
    "user": "https://github.com/kiwifb"
}
```

Works for me. That's one of the things I would like to see merged soon.



---

archive/issue_comments_406808.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-06-06T03:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406808",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_406809.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-06-06T07:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406809",
    "user": "https://github.com/kliem"
}
```

Thank you.



---

archive/issue_comments_406810.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-06-06T09:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406810",
    "user": "https://github.com/dimpase"
}
```

Changing priority from major to critical.



---

archive/issue_comments_406811.json:
```json
{
    "body": "hopefully it simplifies the thankless task of allowing multiple versions of pari/gp, etc.",
    "created_at": "2020-06-06T09:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406811",
    "user": "https://github.com/dimpase"
}
```

hopefully it simplifies the thankless task of allowing multiple versions of pari/gp, etc.



---

archive/issue_comments_406812.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-06-21T22:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28805",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28805#issuecomment-406812",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
