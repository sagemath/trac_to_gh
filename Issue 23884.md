# Issue 23884: windows version not properly detected in psutil

Issue created by migration from https://trac.sagemath.org/ticket/24121

Original creator: gouezel

Original creation time: 2017-10-29 09:32:23

CC:  embray

psutil compilation fails with

```
Traceback (most recent call last):
  File "setup.py", line 253, in <module>
    macros.append(("_WIN32_WINNT", get_winver()))
  File "setup.py", line 249, in get_winver
    maj = int(m.group('major'))
AttributeError: 'NoneType' object has no attribute 'group'
```


because the regexp to detect windows version in `setup.py` is not adapted to my windows version, which is as follows:


```
PS C:\Users\Sebastien> cmd /c ver

Microsoft Windows [version 10.0.16299.19]
```



---

Comment by embray created at 2017-10-30 13:54:59

FWIW on my machine


```
Microsoft Windows [Version 10.0.15063]
```


which is why I haven't seen this.  For some reason your Windows version has an additional component not accounted for in that regexp.

I already [fixed](https://github.com/giampaolo/psutil/pull/998/commits/a33c43ca59fd1b5327402a637a5c02b32976ed86) this issue some time ago in my psutil Cygwin port, but never updated the patch to psutil included with Sage.  I guess it would be good to do that then.


---

Comment by embray created at 2017-10-30 13:54:59

Set assignee to embray.


---

Comment by jdemeyer created at 2017-10-30 15:55:50

You might as well update psutil at the same time.


---

Comment by charpent created at 2017-11-05 10:33:45

Replying to [comment:1 embray]:
> FWIW on my machine
> 
> {{{
> Microsoft Windows [Version 10.0.15063]
> }}}
> 
> which is why I haven't seen this.  For some reason your Windows version has an additional component not accounted for in that regexp.
> 
> I already [fixed](https://github.com/giampaolo/psutil/pull/998/commits/a33c43ca59fd1b5327402a637a5c02b32976ed86) this issue some time ago in my psutil Cygwin port, but never updated the patch to psutil included with Sage.  I guess it would be good to do that then.

FWIW, I just got bitten by this. From a cygwin prompt :

```
charpent@DESKTOP-P0B7HOE ~/sage
$ cmd /c ver

Microsoft Windows [version 10.0.16299.19]
```


Since this seems to block Sage from successfully compiling on windows, I'd be tempted to raise the priority of this bug to "blocker".


---

Attachment

Emergency patch, allows compilatopn on Wndows 10 / cygwin.


---

Comment by charpent created at 2017-11-05 14:11:21

Impossible to `git trac push` at the moment. I have uploaded a patch(adaptation of Erik's patch) that allows successful recompilation on Windows 10 under cygwin.

`ptestlong` underway (will be long...).


---

Comment by charpent created at 2017-11-05 14:11:21

Changing status from new to needs_review.


---

Comment by charpent created at 2017-11-05 16:40:45

Replying to [comment:4 charpent]:
> Impossible to `git trac push` at the moment. I have uploaded a patch(adaptation of Erik's patch) that allows successful recompilation on Windows 10 under cygwin.
> 
> `ptestlong` underway (will be long...).

I get two errors :

```
----------------------------------------------------------------------
sage -t --long --warn-long 124.4 src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t --long --warn-long 124.4 src/sage/calculus/calculus.py  # Timed out
----------------------------------------------------------------------
```


Both are transient (i. e. do not fail when ran standalone).

HTH,


---

Comment by git created at 2017-11-05 16:49:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-11-05 16:51:42

Replying to [comment:8 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[ed80215](https://git.sagemath.org/sage.git/commit/?id=ed802154f7450af93b982e4f2a1c8c5eb2ce0ff7)||`24121 : Emergency patch for compilation on windows 10 ; bump patchlevel`||

Finally managed to push mu patch "manually" as described in the Developer's Manual.

But Ire-pasted my public RSA kay in the relevant place, so that may be a fluke...


---

Comment by embray created at 2017-11-06 09:45:41

Please let me handle this--this is already fixed in my branch of `psutil`, I just need to update the existing patch.

I don't consider it an emergency since it hasn't affected any of the machines I'm using for Windows builds.


---

Comment by gouezel created at 2017-11-06 09:49:51

I guess this hasn't affected you because your machines are not really up-to-date? (For me, the problem hit me after the last big windows update, Fall Creators Update, that should be soon installed for everyone).


---

Comment by embray created at 2017-11-06 10:18:25

New commits:


---

Comment by charpent created at 2017-11-06 10:18:59

Replying to [comment:10 embray]:
> Please let me handle this
You're welcome ;-)
>--this is already fixed in my branch of `psutil`, I just need to update the existing patch.
That's what I did in my patch-to-the-current-patch, following exactly what you did in your cygwin port. I don't doubt it can be done better...(In fact : do we still need the Windows version string, since we now rely on a ficntion that dives directly the version ?
> I don't consider it an emergency since it hasn't affected any of the machines I'm using for Windows builds.
I got that after my Windows VM got upgraded to "Fall Creators Update", which I *think* introduced the new format (and triggered the error).


---

Comment by charpent created at 2017-11-06 12:50:39

Re-reading this ticket, I am //quite// surprised :

* I see the "Authors" field deleted : I did **not** do that.
* Similarly, I did **not** changed the branch nor the commit.

I do not know what happened. But I want to be absolutely clear : I am **not** trying to take over this ticket.

With apologies, if necessary.


---

Comment by charpent created at 2017-11-06 12:58:26

Replying to [comment:14 charpent]:
> Re-reading this ticket, I am //quite// surprised :
> 
> * I see the "Authors" field deleted : I did **not** do that.
> * Similarly, I did **not** changed the branch nor the commit.
> 
> I do not know what happened.

I have an hypothesis : I probably //unwillingly// overtook your changes, that seem to have been done while I was typing my first answer. And I didn't see the result..

> But I want to be absolutely clear : I am **not** trying to take over this ticket.
> 
> With apologies, if necessary.

They **are** necessary. Sorry for the mess...

I can review this ticket later tonight, if you care...


---

Comment by embray created at 2017-11-06 17:23:32

It's possible you commented while having a previous version of the page with your modifications already loaded.


---

Comment by embray created at 2017-11-06 17:25:38

Thanks--I just wanted to merge that change from the current version of my branch so I could keep track of things better.

Meanwhile I'm working on the last updates I need to my branch to re-submit it, hopefully, for merging into psutil's main branch.


---

Comment by embray created at 2017-11-09 14:19:03

Changing priority from major to critical.


---

Comment by embray created at 2017-11-09 14:19:03

I still haven't gotten the fall update on my machine yet, but if more people do have it then this will be a problem (albeit only for building).


---

Comment by charpent created at 2017-11-10 10:55:30

Results so far, using Erik's branch :
* On Linux (Debian testing) :
    - 8.1.beta9 : compiles, passes ptestlong
    - after upgrade to 8.1.rc0 : compiles, passes ptestlong.
    - full recompilation (`make distclean && make ptestlong`) of 8.1.rc0 : compiles, passes ptestlong.
* On Windows 10 + "Fall Creators Update" :
    - 8.1.beta9 : compiles (ptestlong not run)
    - after upgrade to 8.1.rc0 : compiles (ptestlong not run)
    - full recompilation : //does ***not*** build//. Consistently fails building pynac, that complaints that it can't find the python library.

I'm almost sure that this failure is unrelated to #24121's target. However, I set `needs_work` to flag the problem. I can re-test whenever `needs_review` is set.


---

Comment by charpent created at 2017-11-10 10:55:30

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-11-10 11:32:09

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-11-10 11:32:09

Just because there is some other problem with building does not mean _this_ issue needs work.  If the psutil package is building/installing then any other issue is not relevant to this one.  Please clarify whether the psutil package built.


---

Comment by charpent created at 2017-11-10 22:20:47

On Windows 10 + "Fall Creators Update", sage8.0.rc0+#24121+#24189, psutil compiles. 

However, Sage fails to build : fpyll consistently fails to build.


---

Comment by charpent created at 2017-11-10 22:25:45

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2017-11-10 22:25:45

Created #24197. positive_review for this ticket.


---

Comment by embray created at 2017-12-04 13:48:18

Changing priority from critical to blocker.


---

Comment by vbraun created at 2017-12-11 01:04:19

Resolution: fixed
