# Issue 18148: deallocate pari when sage quits

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2015-05-09 06:38:29

CC:  leif jpflori

As global module variables point toward the (unique) 'PariInstance' instance built by Sage, and because those are nto automatically cleaned, this instance is never deleted. Thus, we do it exlicitly in `quit_sage`.

Nathann

[1] https://groups.google.com/d/topic/sage-devel/E-U4otPW9_0/discussion


---

Comment by ncohen created at 2015-05-09 06:38:42

Changing status from new to needs_review.


---

Comment by git created at 2015-05-09 06:40:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-09 08:26:47

I don't like this. How can you be sure that no PARI code will be executed after deallocating the PARI stack?


---

Comment by jdemeyer created at 2015-05-09 08:26:47

Changing status from needs_review to needs_info.


---

Comment by ncohen created at 2015-05-09 08:47:05

> I don't like this. How can you be sure that no PARI code will be executed after deallocating the PARI stack?

I am not, and you are right this is probably not a good idea after all. Do you know how we could do to have this be deallocated when it should?


---

Comment by leif created at 2015-05-09 09:07:16

Of course it's not nice, but the only alternatives that come to my mind are:

 * Add even more Valgrind suppressions.  (IMHO odd.)

 * Remove the global variable which is bad anyway. (Implies a performance penalty.)

 * Convince Cython to call the deallocator.  (I have no idea how; `del` in `quit_sage()` doesn't work.)


---

Comment by leif created at 2015-05-09 09:09:58

We should probably benchmark option !#2.


---

Comment by jdemeyer created at 2015-11-24 10:57:57

I am against solving this problem "by proxy". The problem isn't that `pari` is never deallocated, the problem is apparently that Cython global variables are never deallocated. Even if you fix pari, then there are still a lot of other global variables with the same problem.


---

Comment by nbruin created at 2015-11-24 18:51:49

Replying to [comment:9 jdemeyer]:
> The problem isn't that `pari` is never deallocated, the problem is apparently that Cython global variables are never deallocated.

A little googling gives me the impression that this is a wide-spread problem with python (extension) modules: there is no way to "unload" a module (which would be the time to deallocate global variables), and it seems it doesn't exist because people haven't been able to solve the subtle problems that arise in deciding when and in what order unloading should happen (especially extension modules seem to be complicated this way)

Indeed, without extra information, the fact that arbitrary code could be executed upon deallocation means there is no sure-fire way to decide a correct way to order module deallocation. It wouldn't be hard to write 2 modules A and B such that the deallocation code of one requires the other module to be functional. One would require a rather careful protocol specification to allow module deactivation.

Without extra information, you cannot start deallocating global variables unless you know the module has been "deactivated". So I think Cython in general will not be solving this problem any time soon.
