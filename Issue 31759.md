# Issue 31759: Efficient Integration on Riemann Surfaces

archive/issues_031759.json:
```json
{
    "body": "CC:  @nbruin\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31996\n\n",
    "created_at": "2021-06-17T16:36:55Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Efficient Integration on Riemann Surfaces",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31759",
    "user": "https://github.com/DisneyHogg"
}
```
CC:  @nbruin



Issue created by migration from https://trac.sagemath.org/ticket/31996





---

archive/issue_comments_453221.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2021-06-17T16:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453221",
    "user": "https://github.com/DisneyHogg"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_453222.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebraic geometry.",
    "created_at": "2021-06-17T16:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453222",
    "user": "https://github.com/DisneyHogg"
}
```

Changing component from PLEASE CHANGE to algebraic geometry.



---

archive/issue_comments_453223.json:
```json
{
    "body": "Set assignee to @DisneyHogg.",
    "created_at": "2021-06-17T16:47:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453223",
    "user": "https://github.com/DisneyHogg"
}
```

Set assignee to @DisneyHogg.



---

archive/issue_comments_453224.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-24T08:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453224",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453225.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-25T18:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453225",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453226.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-25T18:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453226",
    "user": "https://github.com/DisneyHogg"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_453227.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-27T16:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453227",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453228.json:
```json
{
    "body": "As an example of a curve \"from the wild\" (well, it's still constructed, but it was encountered somewhere else, and apart from rational bitangents it probably doesn't have particular properties that are relevant for its periods):\n\n```\nP2.<X,Y,Z>=ProjectiveSpace(QQ,2)\nf=X^4 - 2*X^3*Y + 5*X^2*Y^2 + 4*X*Y^3 + Y^4 + 2*X^3*Z - 5*X^2*Y*Z - 9*X*Y^2*Z - 6*Y^3*Z - 3*X^2*Z^2 - X*Y*Z^2 + 7*Y^2*Z^2 + 6*Y*Z^3 + Z^4\nC=Curve(f)\nS1=C.riemann_surface(prec=500,integration_method=\"heuristic\")\nS2=C.riemann_surface(prec=500,integration_method=\"rigorous\")\n```\n\nThe first one completes about 76 seconds, doing (according to prun) 41627 function evaluations. Interestingly enough, there are 49 line_integral calls and 67 calls to integrate_vector_N, indicating that the interval splitting is very modest in this case, but as you can see, has great effect.\n\nThe second one completes in 554 seconds, doing (according to prun) 121052 function evaluations. A large part of that difference is probably computing integration nodes (based on the evaluations, we'd expect about three times the run time).\n\nSo, I think this code is a big improvement, and I'm expecting that we can turn to \"rigorous\" as our default strategy.\n\n**EDIT**: as pointed out in #9, the numbers are swapped. `S1` takes longer, with more evaluations and `S2` takes less time, with less evaluations.",
    "created_at": "2021-06-30T23:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453228",
    "user": "https://github.com/nbruin"
}
```

As an example of a curve "from the wild" (well, it's still constructed, but it was encountered somewhere else, and apart from rational bitangents it probably doesn't have particular properties that are relevant for its periods):

```
P2.<X,Y,Z>=ProjectiveSpace(QQ,2)
f=X^4 - 2*X^3*Y + 5*X^2*Y^2 + 4*X*Y^3 + Y^4 + 2*X^3*Z - 5*X^2*Y*Z - 9*X*Y^2*Z - 6*Y^3*Z - 3*X^2*Z^2 - X*Y*Z^2 + 7*Y^2*Z^2 + 6*Y*Z^3 + Z^4
C=Curve(f)
S1=C.riemann_surface(prec=500,integration_method="heuristic")
S2=C.riemann_surface(prec=500,integration_method="rigorous")
```

The first one completes about 76 seconds, doing (according to prun) 41627 function evaluations. Interestingly enough, there are 49 line_integral calls and 67 calls to integrate_vector_N, indicating that the interval splitting is very modest in this case, but as you can see, has great effect.

The second one completes in 554 seconds, doing (according to prun) 121052 function evaluations. A large part of that difference is probably computing integration nodes (based on the evaluations, we'd expect about three times the run time).

So, I think this code is a big improvement, and I'm expecting that we can turn to "rigorous" as our default strategy.

**EDIT**: as pointed out in #9, the numbers are swapped. `S1` takes longer, with more evaluations and `S2` takes less time, with less evaluations.



---

archive/issue_comments_453229.json:
```json
{
    "body": "Replying to [comment:9 nbruin]:\n\n> The first one completes about 76 seconds, doing (according to prun) 41627 function evaluations. Interestingly enough, there are 49 line_integral calls and 67 calls to integrate_vector_N, indicating that the interval splitting is very modest in this case, but as you can see, has great effect.\n> \n> The second one completes in 554 seconds, doing (according to prun) 121052 function evaluations. A large part of that difference is probably computing integration nodes (based on the evaluations, we'd expect about three times the run time).\n> \nI think you have the two cases reversed, on my machine I get that `S1.period_matrix()` takes about 387s with 121052 function calls, while `S2.period_matrix()` takes 53s with 41627 function calls.",
    "created_at": "2021-07-01T09:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453229",
    "user": "https://github.com/DisneyHogg"
}
```

Replying to [comment:9 nbruin]:

> The first one completes about 76 seconds, doing (according to prun) 41627 function evaluations. Interestingly enough, there are 49 line_integral calls and 67 calls to integrate_vector_N, indicating that the interval splitting is very modest in this case, but as you can see, has great effect.
> 
> The second one completes in 554 seconds, doing (according to prun) 121052 function evaluations. A large part of that difference is probably computing integration nodes (based on the evaluations, we'd expect about three times the run time).
> 
I think you have the two cases reversed, on my machine I get that `S1.period_matrix()` takes about 387s with 121052 function calls, while `S2.period_matrix()` takes 53s with 41627 function calls.



---

archive/issue_comments_453230.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-02T12:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453231.json:
```json
{
    "body": "Branch needs rebasing (note that #30698 is merged now).",
    "created_at": "2021-07-08T04:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453231",
    "user": "https://github.com/nbruin"
}
```

Branch needs rebasing (note that #30698 is merged now).



---

archive/issue_comments_453232.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-08T04:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453232",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_453233.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453233",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_084626.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31759#event-84626"
}
```



---

archive/issue_comments_453234.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-30T11:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453234",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453235.json:
```json
{
    "body": "Branch rebased",
    "created_at": "2021-07-30T11:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453235",
    "user": "https://github.com/DisneyHogg"
}
```

Branch rebased



---

archive/issue_comments_453236.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-30T11:14:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453236",
    "user": "https://github.com/DisneyHogg"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_453237.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-08-12T22:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453237",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_453238.json:
```json
{
    "body": "In my tests it seems the \"heuristic\" method is still faster for low precisions and \"easy\" integration paths. As one increases the precision, it seems that \"rigorous\" starts to win out.\n\nI think in the introduction documentation of the module, you'll have to add a section explaining what the different integration methods do and briefly explain what the benefits and draw-backs of the methods are.\n\nOtherwise, the present code looks pretty good!\n\n----------------------\nline 1519, _bounding_data:\n\nPerhaps describe the input and output a little more unambgiously. Introducing notation may help:\n\nfor input:\n- differentials are specified as by `cohomology_basis`.\n\nOutput is a tuple (Rzw, [(g, dgdz, F, a0_info), ...]) where:\n- Rzw is a polynomial in z and w over the base ring of the defining equation\n- the list has a tuple for each differential, in order\n- g is a rational function in the quotient field of the parent of the defining polynomial of the curve such that\n  g dz represents the differential\n- dgdz is the derivative of g with respect to z, but now represented in Rzw\n- F is the minimal polynomial of g over z (represented as a bivariate polynomial in z and g\n- a0_info is a tuple (a0L, [r,...]) where describing the leading coefficient of F in g (which is itself a polynomial in z):\n  a0L is its leading coefficient (as a complex number) and the r is a list of the roots, listed with multiplicity.\n\nNote the awkward description of g. Perhaps put it in Rzw instead.\n\nTo illustrate the names used (and the fact that we're forcing the names z,w,g for the variables here), perhaps use x,y in the example instead, so that the difference is visible.\nAlso, perhaps display S.cohomology_basis() so that it's clearer what the relation is with the data given here. You should probably explain that the \"1\" given there stands for 1/(df/dw), as the output shows.\n\nline 1577 rigorous_line_integral:\n\nThe reference \"Developed by Gao\" needs adjustment. Perhaps describe: bounding an algebraic integrand on a circular domain using Cauchy's form of the remainder in Taylor approximation combined with Fujiwara's bound on algebraic functions. (see [Bruin-DisneyHogg-Gau, in preparation] ) or something like that.\n\nCertainly \"Gao\" is an entirely unhelpful reference :-)\n\nline 1619: allow for tolerance on the numerical output here. Also note that the labelling of the upstairs edge is entirely arbitrary, so this doctest is liable to break in the future.\n(there are other tests in this file like that and it's probably hard to fix this).\n\nline 1629: I think you can comment more positively here: the reason to make `differentials` available separately is so that a fast-callable version can be supplied, which\nspeeds up the evaluation of the integrands significantly. This is also why the differentials are all represented relative to the same denominator (df/dw).\n\nline 1646: \"it's\" -> \"its\"\n\nline 1659: float literals can be tricky: in library code they will be actual python \"float\" objects. \"0.5\" is explicitly representable, so it's fine here. The 0.912 is probably approximate anyway, so it doesn't matter.\n \nline 1672: can you put a comment in that explains what this loop does? i.e., cover the line segment along which we'll be integrating with ellipses inscribed in circles that avoid branch points? and that the loop continues to bisect the line segments until each fits in such an ellipse?",
    "created_at": "2021-08-12T22:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453238",
    "user": "https://github.com/nbruin"
}
```

In my tests it seems the "heuristic" method is still faster for low precisions and "easy" integration paths. As one increases the precision, it seems that "rigorous" starts to win out.

I think in the introduction documentation of the module, you'll have to add a section explaining what the different integration methods do and briefly explain what the benefits and draw-backs of the methods are.

Otherwise, the present code looks pretty good!

----------------------
line 1519, _bounding_data:

Perhaps describe the input and output a little more unambgiously. Introducing notation may help:

for input:
- differentials are specified as by `cohomology_basis`.

Output is a tuple (Rzw, [(g, dgdz, F, a0_info), ...]) where:
- Rzw is a polynomial in z and w over the base ring of the defining equation
- the list has a tuple for each differential, in order
- g is a rational function in the quotient field of the parent of the defining polynomial of the curve such that
  g dz represents the differential
- dgdz is the derivative of g with respect to z, but now represented in Rzw
- F is the minimal polynomial of g over z (represented as a bivariate polynomial in z and g
- a0_info is a tuple (a0L, [r,...]) where describing the leading coefficient of F in g (which is itself a polynomial in z):
  a0L is its leading coefficient (as a complex number) and the r is a list of the roots, listed with multiplicity.

Note the awkward description of g. Perhaps put it in Rzw instead.

To illustrate the names used (and the fact that we're forcing the names z,w,g for the variables here), perhaps use x,y in the example instead, so that the difference is visible.
Also, perhaps display S.cohomology_basis() so that it's clearer what the relation is with the data given here. You should probably explain that the "1" given there stands for 1/(df/dw), as the output shows.

line 1577 rigorous_line_integral:

The reference "Developed by Gao" needs adjustment. Perhaps describe: bounding an algebraic integrand on a circular domain using Cauchy's form of the remainder in Taylor approximation combined with Fujiwara's bound on algebraic functions. (see [Bruin-DisneyHogg-Gau, in preparation] ) or something like that.

Certainly "Gao" is an entirely unhelpful reference :-)

line 1619: allow for tolerance on the numerical output here. Also note that the labelling of the upstairs edge is entirely arbitrary, so this doctest is liable to break in the future.
(there are other tests in this file like that and it's probably hard to fix this).

line 1629: I think you can comment more positively here: the reason to make `differentials` available separately is so that a fast-callable version can be supplied, which
speeds up the evaluation of the integrands significantly. This is also why the differentials are all represented relative to the same denominator (df/dw).

line 1646: "it's" -> "its"

line 1659: float literals can be tricky: in library code they will be actual python "float" objects. "0.5" is explicitly representable, so it's fine here. The 0.912 is probably approximate anyway, so it doesn't matter.
 
line 1672: can you put a comment in that explains what this loop does? i.e., cover the line segment along which we'll be integrating with ellipses inscribed in circles that avoid branch points? and that the loop continues to bisect the line segments until each fits in such an ellipse?



---

archive/issue_comments_453239.json:
```json
{
    "body": "Wow. I tried some random examples. For hyperelliptic curves it seems heuristic (for low precisions) is often faster than than rigorous. Exchanging the roles of x, y for those generally leads to very high degree covers, which I guess is not so good for Fujiwara, so that didn't seem to be such a great thing to do for rigorous either.\n\nHowever, when we more to general plane curves (a quartic here):\n\n```\nf = -3*y^4 + 3*y^3*x + 2*y^2*x^2 + 4*y*x^3 - 4*x^4 - y^3 - 4*y^2*x + 2*y*x^2 + x^3 - 3*y^2 - 2*y*x + x^2 - 4*x + 4\n```\n\nthe results become quite striking!\n\n```\n%time B=Sh.riemann_matrix()  # heuristic\nCPU times: user 1min 11s, sys: 1.06 ms, total: 1min 11s\nWall time: 1min 11s\n\n%time B = Sr.riemann_matrix()  # rigorous\nCPU times: user 5.67 s, sys: 4.99 ms, total: 5.68 s\nWall time: 5.71 s\n```\n\nThis timing is with a warmed-up cache for integration nodes: the first run took more than 2 minutes.\n\nFor hyperelliptic curves one shouldn't be using this code anyway, so I think \"rigorous\" might actually be a better default setting.",
    "created_at": "2021-08-12T23:18:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453239",
    "user": "https://github.com/nbruin"
}
```

Wow. I tried some random examples. For hyperelliptic curves it seems heuristic (for low precisions) is often faster than than rigorous. Exchanging the roles of x, y for those generally leads to very high degree covers, which I guess is not so good for Fujiwara, so that didn't seem to be such a great thing to do for rigorous either.

However, when we more to general plane curves (a quartic here):

```
f = -3*y^4 + 3*y^3*x + 2*y^2*x^2 + 4*y*x^3 - 4*x^4 - y^3 - 4*y^2*x + 2*y*x^2 + x^3 - 3*y^2 - 2*y*x + x^2 - 4*x + 4
```

the results become quite striking!

```
%time B=Sh.riemann_matrix()  # heuristic
CPU times: user 1min 11s, sys: 1.06 ms, total: 1min 11s
Wall time: 1min 11s

%time B = Sr.riemann_matrix()  # rigorous
CPU times: user 5.67 s, sys: 4.99 ms, total: 5.68 s
Wall time: 5.71 s
```

This timing is with a warmed-up cache for integration nodes: the first run took more than 2 minutes.

For hyperelliptic curves one shouldn't be using this code anyway, so I think "rigorous" might actually be a better default setting.



---

archive/issue_comments_453240.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-13T15:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453240",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-13T15:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453241",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453242.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-13T15:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453242",
    "user": "https://github.com/DisneyHogg"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_453243.json:
```json
{
    "body": "Documentation issues raised by nbruin in comment 16 dealt with.",
    "created_at": "2021-08-13T15:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453243",
    "user": "https://github.com/DisneyHogg"
}
```

Documentation issues raised by nbruin in comment 16 dealt with.



---

archive/issue_comments_453244.json:
```json
{
    "body": "We're getting there! Some knock-on corrections:\n\nLine 400: \"approximately half\" -- that's only the case if the two methods eventually use about the same number of nodes to compute the answer they return. It's not what I observed for lower precisions. I didn't particularly see the overhead of computing the bounds for N show up in the profiles either.\n\nLine 1696: \"howver\" -> \"however\"\n\nLine 1751: \"Neu2018\": reference markup\n\nLine 1760: \"more reliable faster\" -> \"more reliable and faster\"",
    "created_at": "2021-08-14T00:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453244",
    "user": "https://github.com/nbruin"
}
```

We're getting there! Some knock-on corrections:

Line 400: "approximately half" -- that's only the case if the two methods eventually use about the same number of nodes to compute the answer they return. It's not what I observed for lower precisions. I didn't particularly see the overhead of computing the bounds for N show up in the profiles either.

Line 1696: "howver" -> "however"

Line 1751: "Neu2018": reference markup

Line 1760: "more reliable faster" -> "more reliable and faster"



---

archive/issue_comments_453245.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-14T00:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453245",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453246.json:
```json
{
    "body": "... and \"practuce\" -> \"practice\" (just introduced)",
    "created_at": "2021-08-15T19:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453246",
    "user": "https://github.com/nbruin"
}
```

... and "practuce" -> "practice" (just introduced)



---

archive/issue_comments_453247.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-15T20:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453247",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453248.json:
```json
{
    "body": "Great!",
    "created_at": "2021-08-15T23:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453248",
    "user": "https://github.com/nbruin"
}
```

Great!



---

archive/issue_comments_453249.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-15T23:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453249",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_453250.json:
```json
{
    "body": "A space after `#` for all code comments and\ncommented-out code lines would be nice.",
    "created_at": "2021-08-16T00:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453250",
    "user": "https://github.com/slel"
}
```

A space after `#` for all code comments and
commented-out code lines would be nice.



---

archive/issue_comments_453251.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-08-16T08:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453251",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_453252.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-08-16T08:34:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453252",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_453253.json:
```json
{
    "body": "Some more polishing, if you don't mind.\n\nPlease use two spaces before `#` for inline comments.\n\nBoth in example blocks for `# random` and `# abs tol`, etc.,\nand for regular code such as:\n\n```diff\n-        KP = PolynomialRing(k, 'W') # W->fraction field\n+        KP = PolynomialRing(k, 'W')  # W -> fraction field\n```\n\n\nIn the `_bounding_data` docstring's OUTPUT block,\nadd a blank line before the itemized list.\n\nConsider using comprehension syntax here:\n\n```diff\n-        integral_dict = dict()\n-        for upstairs_edge in occurring_edges:\n-            integral_dict[upstairs_edge] = line_int(upstairs_edge)\n+        integral_dict = {edge: line_int(edge)\n+                         for edge in occurring_edges}\n```\n\n\nComparison operators `==`, `!=`, `<`, `<=`, `>`, `>=`\nwant a space on each side. Here:\n\n```diff\n-        if integration_method==\"heuristic\":\n+        if integration_method == \"heuristic\":\n             line_int = lambda edge: self.simple_vector_line_integral(edge,fcd)\n-        elif integration_method==\"rigorous\":\n+        elif integration_method == \"rigorous\":\n```\n",
    "created_at": "2021-08-17T09:49:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453253",
    "user": "https://github.com/slel"
}
```

Some more polishing, if you don't mind.

Please use two spaces before `#` for inline comments.

Both in example blocks for `# random` and `# abs tol`, etc.,
and for regular code such as:

```diff
-        KP = PolynomialRing(k, 'W') # W->fraction field
+        KP = PolynomialRing(k, 'W')  # W -> fraction field
```


In the `_bounding_data` docstring's OUTPUT block,
add a blank line before the itemized list.

Consider using comprehension syntax here:

```diff
-        integral_dict = dict()
-        for upstairs_edge in occurring_edges:
-            integral_dict[upstairs_edge] = line_int(upstairs_edge)
+        integral_dict = {edge: line_int(edge)
+                         for edge in occurring_edges}
```


Comparison operators `==`, `!=`, `<`, `<=`, `>`, `>=`
want a space on each side. Here:

```diff
-        if integration_method=="heuristic":
+        if integration_method == "heuristic":
             line_int = lambda edge: self.simple_vector_line_integral(edge,fcd)
-        elif integration_method=="rigorous":
+        elif integration_method == "rigorous":
```




---

archive/issue_comments_453254.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T10:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453254",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453255.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T10:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453255",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453256.json:
```json
{
    "body": "Or just run the code through [black](https://github.com/psf/black) and be done with it.",
    "created_at": "2021-08-17T17:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453256",
    "user": "https://github.com/nbruin"
}
```

Or just run the code through [black](https://github.com/psf/black) and be done with it.



---

archive/issue_comments_453257.json:
```json
{
    "body": "Running this command based on the current branch:\n\n```\n$ ./sage --tox -- src/sage/schemes/riemann_surfaces/riemann_surface.py\n```\n\ngives one failing doctest:\n\n```\nUsing --optional=4ti2,build,dochtml,fricas,homebrew,latte_int,lidia,pip,sage,sage_spkg\nDoctesting 1 file using 4 threads.\nsage -t --random-seed=0 sage/schemes/riemann_surfaces/riemann_surface.py\n**********************************************************************\nFile \"sage/schemes/riemann_surfaces/riemann_surface.py\", line 1939, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.period_matrix\nFailed example:\n    (RM_S - rm).norm() < (RM_T - rm).norm()\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of  18 in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.period_matrix\n    [360 tests, 1 failure, 30.62 s]\n----------------------------------------------------------------------\nsage -t --random-seed=0 sage/schemes/riemann_surfaces/riemann_surface.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 30.8 seconds\n    cpu time: 24.9 seconds\n    cumulative wall time: 30.6 seconds\n```\n\nand reports three typos:\n\n```\nsage/schemes/riemann_surfaces/riemann_surface.py:352: specifing ==> specifying\nsage/schemes/riemann_surfaces/riemann_surface.py:1709: requierd ==> required\nsage/schemes/riemann_surfaces/riemann_surface.py:1720: funcions ==> functions\n```\n",
    "created_at": "2021-08-17T22:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453257",
    "user": "https://github.com/slel"
}
```

Running this command based on the current branch:

```
$ ./sage --tox -- src/sage/schemes/riemann_surfaces/riemann_surface.py
```

gives one failing doctest:

```
Using --optional=4ti2,build,dochtml,fricas,homebrew,latte_int,lidia,pip,sage,sage_spkg
Doctesting 1 file using 4 threads.
sage -t --random-seed=0 sage/schemes/riemann_surfaces/riemann_surface.py
**********************************************************************
File "sage/schemes/riemann_surfaces/riemann_surface.py", line 1939, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.period_matrix
Failed example:
    (RM_S - rm).norm() < (RM_T - rm).norm()
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of  18 in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.period_matrix
    [360 tests, 1 failure, 30.62 s]
----------------------------------------------------------------------
sage -t --random-seed=0 sage/schemes/riemann_surfaces/riemann_surface.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 30.8 seconds
    cpu time: 24.9 seconds
    cumulative wall time: 30.6 seconds
```

and reports three typos:

```
sage/schemes/riemann_surfaces/riemann_surface.py:352: specifing ==> specifying
sage/schemes/riemann_surfaces/riemann_surface.py:1709: requierd ==> required
sage/schemes/riemann_surfaces/riemann_surface.py:1720: funcions ==> functions
```




---

archive/issue_comments_453258.json:
```json
{
    "body": "This line can now be removed.\n\n\n```diff\n-        integral_dict = dict()\n         integral_dict = {edge: line_int(edge) for edge in occurring_edges}\n```\n\n\nPEP 8 recommends putting operators\n(such as `+` or `or`) after a line break:\n\n- https://www.python.org/dev/peps/pep-0008/#should-a-line-break-before-or-after-a-binary-operator\n\nin case you want to change this block and similar ones:\n\n\n```diff\n-                        if ((a_in_arg < b_in_arg < a_out_arg) or\n-                                (b_in_arg < a_out_arg < a_in_arg) or\n-                                (a_out_arg < a_in_arg < b_in_arg)):\n+                        if ((a_in_arg < b_in_arg < a_out_arg)\n+                            or (b_in_arg < a_out_arg < a_in_arg)\n+                            or (a_out_arg < a_in_arg < b_in_arg)):\n```\n\n\nSorry for holding the ticket with minor things,\nfeel free to set back to positive review at any point.",
    "created_at": "2021-08-17T22:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453258",
    "user": "https://github.com/slel"
}
```

This line can now be removed.


```diff
-        integral_dict = dict()
         integral_dict = {edge: line_int(edge) for edge in occurring_edges}
```


PEP 8 recommends putting operators
(such as `+` or `or`) after a line break:

- https://www.python.org/dev/peps/pep-0008/#should-a-line-break-before-or-after-a-binary-operator

in case you want to change this block and similar ones:


```diff
-                        if ((a_in_arg < b_in_arg < a_out_arg) or
-                                (b_in_arg < a_out_arg < a_in_arg) or
-                                (a_out_arg < a_in_arg < b_in_arg)):
+                        if ((a_in_arg < b_in_arg < a_out_arg)
+                            or (b_in_arg < a_out_arg < a_in_arg)
+                            or (a_out_arg < a_in_arg < b_in_arg)):
```


Sorry for holding the ticket with minor things,
feel free to set back to positive review at any point.



---

archive/issue_comments_453259.json:
```json
{
    "body": "Replying to [comment:32 slelievre]:\n> Running this command based on the current branch:\n> {{{\n> $ ./sage --tox -- src/sage/schemes/riemann_surfaces/riemann_surface.py\n> }}}\nOh boy, thanks for checking this. When I checked https://patchbot.sagemath.org/ticket/31996/ I noticed the yellow question mark and saw the red \"x\" for non-ascii output (which is no issue) and thought *that* was why the yellow question mark was yellow. But there are actually tests failing! Yes, the file should pass its doctests! I don't know what the 'tox' option does, but with a plain `sage -t src/sage/schemes/riemann_surfaces/riemann_surface.py` you should be getting a passing result. Failing doctests definitely needs work.\n\n(it may still be that some bot gives failing results, but in that case one just needs to double-check that the bot is malconfigured)",
    "created_at": "2021-08-18T02:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453259",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:32 slelievre]:
> Running this command based on the current branch:
> {{{
> $ ./sage --tox -- src/sage/schemes/riemann_surfaces/riemann_surface.py
> }}}
Oh boy, thanks for checking this. When I checked https://patchbot.sagemath.org/ticket/31996/ I noticed the yellow question mark and saw the red "x" for non-ascii output (which is no issue) and thought *that* was why the yellow question mark was yellow. But there are actually tests failing! Yes, the file should pass its doctests! I don't know what the 'tox' option does, but with a plain `sage -t src/sage/schemes/riemann_surfaces/riemann_surface.py` you should be getting a passing result. Failing doctests definitely needs work.

(it may still be that some bot gives failing results, but in that case one just needs to double-check that the bot is malconfigured)



---

archive/issue_comments_453260.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-08-18T02:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453260",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_453261.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-18T09:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453261",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453262.json:
```json
{
    "body": "Running tests with `--long` seems adequate\nas some tests are marked long. I tried\n\n```\n$ sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py\n```\n\nwhich trips on `%time` (apparently that is\na syntax error in doctests) and fails on\n\n```\nFile \"src/sage/schemes/riemann_surfaces/riemann_surface.py\", line 1939, in\nsage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.period_matrix\nFailed example:\n    (RM_S - rm).norm() < (RM_T - rm).norm()\nExpected:\n    True\nGot:\n    False\n```\n",
    "created_at": "2021-08-18T09:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453262",
    "user": "https://github.com/slel"
}
```

Running tests with `--long` seems adequate
as some tests are marked long. I tried

```
$ sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py
```

which trips on `%time` (apparently that is
a syntax error in doctests) and fails on

```
File "src/sage/schemes/riemann_surfaces/riemann_surface.py", line 1939, in
sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.period_matrix
Failed example:
    (RM_S - rm).norm() < (RM_T - rm).norm()
Expected:
    True
Got:
    False
```




---

archive/issue_comments_453263.json:
```json
{
    "body": "Replying to [comment:36 slelievre]: I cannot run `./sage --tox -- src/sage/schemes/riemann_surface/riemann_surface.py` on my machine, it raises an IsADirectoryError which I don't understand:\n\n```\nTraceback (most recent call last):\n  File \"/usr/bin/tox\", line 11, in <module>\n    load_entry_point('tox==2.5.0', 'console_scripts', 'tox')()\n  File \"/usr/lib/python3/dist-packages/tox/session.py\", line 38, in main\n    config = prepare(args)\n  File \"/usr/lib/python3/dist-packages/tox/session.py\", line 26, in prepare\n    config = parseconfig(args)\n  File \"/usr/lib/python3/dist-packages/tox/config.py\", line 239, in parseconfig\n    parseini(config, inipath)\n  File \"/usr/lib/python3/dist-packages/tox/config.py\", line 657, in __init__\n    self._cfg = py.iniconfig.IniConfig(config.toxinipath)\n  File \"/usr/lib/python3/dist-packages/py/_vendored_packages/iniconfig.py\", line 52, in __init__\n    f = open(self.path)\nIsADirectoryError: [Errno 21] Is a directory: '/home/s1504632/sage/src'\n```\n\n\nWhat I can do is cd into src, and run `tox -- sage/schemes/riemann_surfaces/riemann_surface.py`, which runs with all tests passed (though it did pick up the typos before I fixed those). Indeed, running the test leading to `(RM_S - rm).norm() < (RM_T - rm).norm()` manually in the command line interface or in a notebok succeeds for me. Running `-t --long` does raise error for the `%time` syntax too, which I will edit, but still doesn't fail on the period matrix test. \n\nWhat are your system details? Perhaps that will be illuminating, as I don't know enough about the lint badges to know how to use them to diagnose a problem.",
    "created_at": "2021-08-18T10:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453263",
    "user": "https://github.com/DisneyHogg"
}
```

Replying to [comment:36 slelievre]: I cannot run `./sage --tox -- src/sage/schemes/riemann_surface/riemann_surface.py` on my machine, it raises an IsADirectoryError which I don't understand:

```
Traceback (most recent call last):
  File "/usr/bin/tox", line 11, in <module>
    load_entry_point('tox==2.5.0', 'console_scripts', 'tox')()
  File "/usr/lib/python3/dist-packages/tox/session.py", line 38, in main
    config = prepare(args)
  File "/usr/lib/python3/dist-packages/tox/session.py", line 26, in prepare
    config = parseconfig(args)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 239, in parseconfig
    parseini(config, inipath)
  File "/usr/lib/python3/dist-packages/tox/config.py", line 657, in __init__
    self._cfg = py.iniconfig.IniConfig(config.toxinipath)
  File "/usr/lib/python3/dist-packages/py/_vendored_packages/iniconfig.py", line 52, in __init__
    f = open(self.path)
IsADirectoryError: [Errno 21] Is a directory: '/home/s1504632/sage/src'
```


What I can do is cd into src, and run `tox -- sage/schemes/riemann_surfaces/riemann_surface.py`, which runs with all tests passed (though it did pick up the typos before I fixed those). Indeed, running the test leading to `(RM_S - rm).norm() < (RM_T - rm).norm()` manually in the command line interface or in a notebok succeeds for me. Running `-t --long` does raise error for the `%time` syntax too, which I will edit, but still doesn't fail on the period matrix test. 

What are your system details? Perhaps that will be illuminating, as I don't know enough about the lint badges to know how to use them to diagnose a problem.



---

archive/issue_comments_453264.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-18T10:27:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453264",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453265.json:
```json
{
    "body": "Replying to [comment:37 gh-DisneyHogg]:\n> \n> What are your system details?\n\nSo far I tested on macOS 10.14.6 with\nlots of packages installed via Homebrew.\n\nIf I find time I can also test on Cygwin,\nDebian and Ubuntu (and more via tox).",
    "created_at": "2021-08-18T12:58:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453265",
    "user": "https://github.com/slel"
}
```

Replying to [comment:37 gh-DisneyHogg]:
> 
> What are your system details?

So far I tested on macOS 10.14.6 with
lots of packages installed via Homebrew.

If I find time I can also test on Cygwin,
Debian and Ubuntu (and more via tox).



---

archive/issue_comments_453266.json:
```json
{
    "body": "Replying to [comment:39 slelievre]:\n> So far I tested on macOS 10.14.6 with\n> lots of packages installed via Homebrew.\nOk, I am using Ubuntu 18.04.04, so it's possible that this is a system issue, I think I should be able to test on a macOS so will try and check that. \n\nReplying to [comment:34 nbruin]: \nWhat system are you using, and were/are you able to try running the test with tox?",
    "created_at": "2021-08-18T14:19:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453266",
    "user": "https://github.com/DisneyHogg"
}
```

Replying to [comment:39 slelievre]:
> So far I tested on macOS 10.14.6 with
> lots of packages installed via Homebrew.
Ok, I am using Ubuntu 18.04.04, so it's possible that this is a system issue, I think I should be able to test on a macOS so will try and check that. 

Replying to [comment:34 nbruin]: 
What system are you using, and were/are you able to try running the test with tox?



---

archive/issue_comments_453267.json:
```json
{
    "body": "Replying to [comment:36 slelievre]:\n> Running tests with `--long` seems adequate\n> as some tests are marked long. I tried\n> {{{\n> $ sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py\n> }}}\n> which trips on `%time` (apparently that is\n> a syntax error in doctests)\nIndeed it is, because it's line magic in IPython, which isn't active during doctesting (indeed, the doctest environment, while it pretends to test sage input, isn't identical to the actual interactive environment, so you may need to adjust code for doctests a bit so that it executes correctly).\n\nIn this case, `time` is hard to access, because it's entirely wrapped up in `IPython`s environment. Closest thing is `timeit`, which is available as a function in sage. So then to display times one can do:\n\n```\n        sage: A2.<x,y>=QQ[]\n        sage: C=Curve(y^2-x^4-1)\n        sage: S=C.riemann_surface()\n        sage: timeit(\"S.period_matrix()\", number=1, repeat=1)\n```\n\nThe statement gets executed in a local scope, so normal assignments wouldn't capture the return value. In this case, the period_matrix is available for cheap afterwards thanks to caching. In general, something like\n\n```\nsage: L=[None]\nsage: timeit(\"L[0]=expensive_result()\", number=1, repeat=1)\nsage: L[0]\n```\n\nmight be required if capturing the returned object is desired.",
    "created_at": "2021-08-18T14:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453267",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:36 slelievre]:
> Running tests with `--long` seems adequate
> as some tests are marked long. I tried
> {{{
> $ sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py
> }}}
> which trips on `%time` (apparently that is
> a syntax error in doctests)
Indeed it is, because it's line magic in IPython, which isn't active during doctesting (indeed, the doctest environment, while it pretends to test sage input, isn't identical to the actual interactive environment, so you may need to adjust code for doctests a bit so that it executes correctly).

In this case, `time` is hard to access, because it's entirely wrapped up in `IPython`s environment. Closest thing is `timeit`, which is available as a function in sage. So then to display times one can do:

```
        sage: A2.<x,y>=QQ[]
        sage: C=Curve(y^2-x^4-1)
        sage: S=C.riemann_surface()
        sage: timeit("S.period_matrix()", number=1, repeat=1)
```

The statement gets executed in a local scope, so normal assignments wouldn't capture the return value. In this case, the period_matrix is available for cheap afterwards thanks to caching. In general, something like

```
sage: L=[None]
sage: timeit("L[0]=expensive_result()", number=1, repeat=1)
sage: L[0]
```

might be required if capturing the returned object is desired.



---

archive/issue_comments_453268.json:
```json
{
    "body": "Replying to [comment:40 gh-DisneyHogg]:\n> What system are you using, and were/are you able to try running the test with tox? \nFedora. I don't know what tox is. Testing with sage's doctesting tools should be sufficient. Irregularities between architectures are always a pain. I think you need to see the MacOS output to check what MacOS is doing differently (choosing different integration paths?). Results from MPFR shouldn't depend on hardware: it's directly based on integer arithmetic, so it's completely shielded from hardware float peculiarities.",
    "created_at": "2021-08-18T14:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453268",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:40 gh-DisneyHogg]:
> What system are you using, and were/are you able to try running the test with tox? 
Fedora. I don't know what tox is. Testing with sage's doctesting tools should be sufficient. Irregularities between architectures are always a pain. I think you need to see the MacOS output to check what MacOS is doing differently (choosing different integration paths?). Results from MPFR shouldn't depend on hardware: it's directly based on integer arithmetic, so it's completely shielded from hardware float peculiarities.



---

archive/issue_comments_453269.json:
```json
{
    "body": "Replying to [comment:39 slelievre]:\n> So far I tested on macOS 10.14.6 with\n> lots of packages installed via Homebrew.\nAs an update, I have just tested on macOS 11.5.2, running from a conda environment to do most of the package installs. This test also fails there, so I will investigate what is going on.",
    "created_at": "2021-08-19T22:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453269",
    "user": "https://github.com/DisneyHogg"
}
```

Replying to [comment:39 slelievre]:
> So far I tested on macOS 10.14.6 with
> lots of packages installed via Homebrew.
As an update, I have just tested on macOS 11.5.2, running from a conda environment to do most of the package installs. This test also fails there, so I will investigate what is going on.



---

archive/issue_comments_453270.json:
```json
{
    "body": "Running the test and printing output gets \n\n```\nsage: (RM_S-rm).norm()\n1.1102230246251565e-16\nsage: (RM_T-rm).norm()\n2.482534153247273e-16\n```\n\non my Linux machine, whereas on my Mac it gets \n\n```\nsage: (RM_S-rm).norm()\n1.1102230246251565e-16\nsage: (RM_T-rm).norm()\n1.1102230246251565e-16\n```\n\nWe thus know the problem is not something within the `rigorous` method, but something a little more fundamental with floats. Comparing over a range of precisions shows that in general the two machines give answers that differ by a value in the range of `RealField(prec)(2)**(-prec)` (it may be helpful to note that when `prec=53`, this expression is `1.110223024625156e-16`). As such I'd suggest removing the test to show that the rigorous method is more accurate for this value of `prec`, as in general even on the Linux machine this test would fail if the precision was increased, for example. \n\n```\nsage: f = y^2-x^3+1\nsage: p = 200\nsage: Sh = RiemannSurface(f, prec=p, integration_method='heuristic')\nsage: Sr = RiemannSurface(f, prec=p, integration_method='rigorous')\nsage: Rh = Sh.riemann_matrix()\nsage: Rr = Sr.riemann_matrix()\nsage: (Rh-Rr).norm()\n4.186105399376987e-60\nsage: rm = (-1+I*sqrt(3))/2\nsage: (Rr-rm).norm()\n1.1102230246251565e-16\nsage: (Rh-rm).norm()\n1.1102230246251565e-16\nsage: (Rr-rm).norm()<(Rh-rm).norm()\nFalse\n```\n\nThe fact that, at this higher precision, both methods of calculating the Riemann matrix still have an error of about `RealField(53)(2)**(-53)` suggests to me that there is another source of error in the module, and that this should be its own ticket.",
    "created_at": "2021-08-20T11:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453270",
    "user": "https://github.com/DisneyHogg"
}
```

Running the test and printing output gets 

```
sage: (RM_S-rm).norm()
1.1102230246251565e-16
sage: (RM_T-rm).norm()
2.482534153247273e-16
```

on my Linux machine, whereas on my Mac it gets 

```
sage: (RM_S-rm).norm()
1.1102230246251565e-16
sage: (RM_T-rm).norm()
1.1102230246251565e-16
```

We thus know the problem is not something within the `rigorous` method, but something a little more fundamental with floats. Comparing over a range of precisions shows that in general the two machines give answers that differ by a value in the range of `RealField(prec)(2)**(-prec)` (it may be helpful to note that when `prec=53`, this expression is `1.110223024625156e-16`). As such I'd suggest removing the test to show that the rigorous method is more accurate for this value of `prec`, as in general even on the Linux machine this test would fail if the precision was increased, for example. 

```
sage: f = y^2-x^3+1
sage: p = 200
sage: Sh = RiemannSurface(f, prec=p, integration_method='heuristic')
sage: Sr = RiemannSurface(f, prec=p, integration_method='rigorous')
sage: Rh = Sh.riemann_matrix()
sage: Rr = Sr.riemann_matrix()
sage: (Rh-Rr).norm()
4.186105399376987e-60
sage: rm = (-1+I*sqrt(3))/2
sage: (Rr-rm).norm()
1.1102230246251565e-16
sage: (Rh-rm).norm()
1.1102230246251565e-16
sage: (Rr-rm).norm()<(Rh-rm).norm()
False
```

The fact that, at this higher precision, both methods of calculating the Riemann matrix still have an error of about `RealField(53)(2)**(-53)` suggests to me that there is another source of error in the module, and that this should be its own ticket.



---

archive/issue_comments_453271.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-20T11:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453272.json:
```json
{
    "body": "Replying to [comment:44 gh-DisneyHogg]:\n> The fact that, at this higher precision, both methods of calculating the Riemann matrix still have an error of about `RealField(53)(2)**(-53)` suggests to me that there is another source of error in the module, and that this should be its own ticket. \n\nNo, the problem is in how the doctest is formulated:\n\n```\nsage: rm=(-1+I*sqrt(3))/2\nsage: M=matrix(1,1,[rm.n(200)])\nsage: (M-rm).norm()\n1.1102230246251565e-16\n```\n\nThe problem is that `rm` lives in the symbolic ring. `M` is a float matrix with high precision, because the precision is explicitly requested. When you construct `M-rm` you get a matrix over the symbolic ring. Apparently `norm` then asks for a numerical result, to standard precision [no precision is requested] and apparently, `rm` computed to 53 bits does not agree with `rm` computered to 200 bits and then rounded to 53 bits. In fact:\n\n```\nsage: (M-rm).norm().parent()\nReal Double Field\n```\n\nso we did end up with system floats ... which are a little more susceptible to architecture-dependent peculiarities. They shouldn't be if they are properly IEEE ...",
    "created_at": "2021-08-21T08:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453272",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:44 gh-DisneyHogg]:
> The fact that, at this higher precision, both methods of calculating the Riemann matrix still have an error of about `RealField(53)(2)**(-53)` suggests to me that there is another source of error in the module, and that this should be its own ticket. 

No, the problem is in how the doctest is formulated:

```
sage: rm=(-1+I*sqrt(3))/2
sage: M=matrix(1,1,[rm.n(200)])
sage: (M-rm).norm()
1.1102230246251565e-16
```

The problem is that `rm` lives in the symbolic ring. `M` is a float matrix with high precision, because the precision is explicitly requested. When you construct `M-rm` you get a matrix over the symbolic ring. Apparently `norm` then asks for a numerical result, to standard precision [no precision is requested] and apparently, `rm` computed to 53 bits does not agree with `rm` computered to 200 bits and then rounded to 53 bits. In fact:

```
sage: (M-rm).norm().parent()
Real Double Field
```

so we did end up with system floats ... which are a little more susceptible to architecture-dependent peculiarities. They shouldn't be if they are properly IEEE ...



---

archive/issue_comments_453273.json:
```json
{
    "body": "About tox: it is a powerful tool for testing.\n\nIt can help build and test Sage in various\noperating systems via Docker:\n\n- [Sage 9.1 release tour > Portability > For developers](https://wiki.sagemath.org/ReleaseTours/sage-9.1#For_developers)\n\nThe `sage --tox` option runs the tests and a few extra\ntools to check code style and spelling.\n\n- [Sage 9.2 release tour > Testing and linting with tox](https://wiki.sagemath.org/ReleaseTours/sage-9.2#Testing_and_linting_with_tox)\n- [Sage 9.3 release tour > Cleaning of the Sage codebase to conform to best practices](https://wiki.sagemath.org/ReleaseTours/sage-9.3#Cleaning_of_the_Sage_codebase_to_conform_to_best_practices)",
    "created_at": "2021-08-21T09:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453273",
    "user": "https://github.com/slel"
}
```

About tox: it is a powerful tool for testing.

It can help build and test Sage in various
operating systems via Docker:

- [Sage 9.1 release tour > Portability > For developers](https://wiki.sagemath.org/ReleaseTours/sage-9.1#For_developers)

The `sage --tox` option runs the tests and a few extra
tools to check code style and spelling.

- [Sage 9.2 release tour > Testing and linting with tox](https://wiki.sagemath.org/ReleaseTours/sage-9.2#Testing_and_linting_with_tox)
- [Sage 9.3 release tour > Cleaning of the Sage codebase to conform to best practices](https://wiki.sagemath.org/ReleaseTours/sage-9.3#Cleaning_of_the_Sage_codebase_to_conform_to_best_practices)



---

archive/issue_comments_453274.json:
```json
{
    "body": "Comparing accuracy can be a different ticket,\nif you want to set back to needs_review.",
    "created_at": "2021-08-21T09:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453274",
    "user": "https://github.com/slel"
}
```

Comparing accuracy can be a different ticket,
if you want to set back to needs_review.



---

archive/issue_comments_453275.json:
```json
{
    "body": "Replying to [comment:46 nbruin]:\n> No, the problem is in how the doctest is formulated:\n> {{{\n> sage: rm=(-1+I*sqrt(3))/2\n> sage: M=matrix(1,1,[rm.n(200)])\n> sage: (M-rm).norm()\n> 1.1102230246251565e-16\n> }}}\n> The problem is that `rm` lives in the symbolic ring. `M` is a float matrix with high precision, because the precision is explicitly requested. When you construct `M-rm` you get a matrix over the symbolic ring. Apparently `norm` then asks for a numerical result, to standard precision [no precision is requested] and apparently, `rm` computed to 53 bits does not agree with `rm` computered to 200 bits and then rounded to 53 bits. \nAh brilliant spot, thanks! Instead defining `rm = ComplexField(p)((-1+I*sqrt(3))/2)` fixes this results for the Riemann matrices.",
    "created_at": "2021-08-21T11:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453275",
    "user": "https://github.com/DisneyHogg"
}
```

Replying to [comment:46 nbruin]:
> No, the problem is in how the doctest is formulated:
> {{{
> sage: rm=(-1+I*sqrt(3))/2
> sage: M=matrix(1,1,[rm.n(200)])
> sage: (M-rm).norm()
> 1.1102230246251565e-16
> }}}
> The problem is that `rm` lives in the symbolic ring. `M` is a float matrix with high precision, because the precision is explicitly requested. When you construct `M-rm` you get a matrix over the symbolic ring. Apparently `norm` then asks for a numerical result, to standard precision [no precision is requested] and apparently, `rm` computed to 53 bits does not agree with `rm` computered to 200 bits and then rounded to 53 bits. 
Ah brilliant spot, thanks! Instead defining `rm = ComplexField(p)((-1+I*sqrt(3))/2)` fixes this results for the Riemann matrices.



---

archive/issue_comments_453276.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-21T11:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453276",
    "user": "https://github.com/DisneyHogg"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_453277.json:
```json
{
    "body": "Replying to [comment:49 gh-DisneyHogg]:\n> Ah brilliant spot, thanks! Instead defining `rm = ComplexField(p)((-1+I*sqrt(3))/2)` fixes this results for the Riemann matrices. \n\nThe problem is actually a little more fundamental: `norm` is implemented in an unsuitable way, at least for the 2-norm, which is the default: It converts to CDF or RDF, so it ignores precision completely! So it's not just matrices over the symbolic ring that suffer from this problem (although, as you noticed above, if your matrix has all itsentries tiny, then `RDF` may perform a little better because ... these numbers are floats.\n\nPerhaps a measure like `max(abs(c) for c in M.list())` is a better way of measuring how far a matrix is from being a zero matrix [making sure that M has the accuracy and precision desired of course]\n\nIt looks like you're now just removing the doctest. It may sound a bit paranoid, but if you do that, you have to very clearly state what's wrong with the removed test. A failing test can point at a mistaken assumption somewhere, and testing on different OS-es and architectures can uncover these problems. So just removing the test is often not the right response: it's often an opportunity to uncover previously undiagnosed bad edge cases or assumptions.\n\nOnce you've identified what is going wrong on OSX, can you amend the test to hold by testing what you want to test in a more robust way? It looks useful to compare the methods with a known result somewhere and detecting changes in precision with which the example is computed seems like something useful.\n\nNote that you want to protect your code against at some point becoming completely dysfunctional due to changes in behaviour elsewhere in the system. If you don't test your routines for some sanity somewhere, your code will most likely (almost certainly) break in the future and not be noticed doing so. The test looks like a good canary in a coalmine to me. Just make sure the canary isn't already dead :-).",
    "created_at": "2021-08-21T16:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453277",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:49 gh-DisneyHogg]:
> Ah brilliant spot, thanks! Instead defining `rm = ComplexField(p)((-1+I*sqrt(3))/2)` fixes this results for the Riemann matrices. 

The problem is actually a little more fundamental: `norm` is implemented in an unsuitable way, at least for the 2-norm, which is the default: It converts to CDF or RDF, so it ignores precision completely! So it's not just matrices over the symbolic ring that suffer from this problem (although, as you noticed above, if your matrix has all itsentries tiny, then `RDF` may perform a little better because ... these numbers are floats.

Perhaps a measure like `max(abs(c) for c in M.list())` is a better way of measuring how far a matrix is from being a zero matrix [making sure that M has the accuracy and precision desired of course]

It looks like you're now just removing the doctest. It may sound a bit paranoid, but if you do that, you have to very clearly state what's wrong with the removed test. A failing test can point at a mistaken assumption somewhere, and testing on different OS-es and architectures can uncover these problems. So just removing the test is often not the right response: it's often an opportunity to uncover previously undiagnosed bad edge cases or assumptions.

Once you've identified what is going wrong on OSX, can you amend the test to hold by testing what you want to test in a more robust way? It looks useful to compare the methods with a known result somewhere and detecting changes in precision with which the example is computed seems like something useful.

Note that you want to protect your code against at some point becoming completely dysfunctional due to changes in behaviour elsewhere in the system. If you don't test your routines for some sanity somewhere, your code will most likely (almost certainly) break in the future and not be noticed doing so. The test looks like a good canary in a coalmine to me. Just make sure the canary isn't already dead :-).



---

archive/issue_comments_453278.json:
```json
{
    "body": "Replying to [comment:51 nbruin]:\n> It looks like you're now just removing the doctest. It may sound a bit paranoid, but if you do that, you have to very clearly state what's wrong with the removed test. A failing test can point at a mistaken assumption somewhere, and testing on different OS-es and architectures can uncover these problems. So just removing the test is often not the right response: it's often an opportunity to uncover previously undiagnosed bad edge cases or assumptions.\n\nIn this case, the test actually has no mathematical reason to be true, as even though both method are aiming for the same error bound, due to rounding in the number of nodes used in each method, neither of them will be expect to achieve this bound exactly, and so by how much this is overshot will depend on the rounding. Indeed running the test with curve given by `f=y<sup>2-x</sup>4-1` and precision 300 instead, the output is false on my Linux machine. I had initially written the test purely to demonstrate that the speed of the rigorous routine does not necessarily come at the expense of slightly less accuracy. As such I think we can safely say that this test isn't the right one. \n\n> Once you've identified what is going wrong on OSX, can you amend the test to hold by testing what you want to test in a more robust way? It looks useful to compare the methods with a known result somewhere and detecting changes in precision with which the example is computed seems like something useful.\n\nAs mentioned in comments 44 and 48, I think this should perhaps be a separate ticket, as the differences between OSX and other systems is present even in the original Riemann surfaces. I will be unable to work on OSX for a week, but I have created such a ticket as #32409.",
    "created_at": "2021-08-22T10:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453278",
    "user": "https://github.com/DisneyHogg"
}
```

Replying to [comment:51 nbruin]:
> It looks like you're now just removing the doctest. It may sound a bit paranoid, but if you do that, you have to very clearly state what's wrong with the removed test. A failing test can point at a mistaken assumption somewhere, and testing on different OS-es and architectures can uncover these problems. So just removing the test is often not the right response: it's often an opportunity to uncover previously undiagnosed bad edge cases or assumptions.

In this case, the test actually has no mathematical reason to be true, as even though both method are aiming for the same error bound, due to rounding in the number of nodes used in each method, neither of them will be expect to achieve this bound exactly, and so by how much this is overshot will depend on the rounding. Indeed running the test with curve given by `f=y<sup>2-x</sup>4-1` and precision 300 instead, the output is false on my Linux machine. I had initially written the test purely to demonstrate that the speed of the rigorous routine does not necessarily come at the expense of slightly less accuracy. As such I think we can safely say that this test isn't the right one. 

> Once you've identified what is going wrong on OSX, can you amend the test to hold by testing what you want to test in a more robust way? It looks useful to compare the methods with a known result somewhere and detecting changes in precision with which the example is computed seems like something useful.

As mentioned in comments 44 and 48, I think this should perhaps be a separate ticket, as the differences between OSX and other systems is present even in the original Riemann surfaces. I will be unable to work on OSX for a week, but I have created such a ticket as #32409.



---

archive/issue_comments_453279.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-24T03:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453279",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_453280.json:
```json
{
    "body": "Back to positive then!",
    "created_at": "2021-08-24T03:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453280",
    "user": "https://github.com/nbruin"
}
```

Back to positive then!



---

archive/issue_comments_453281.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-08-30T21:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453281",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_453282.json:
```json
{
    "body": "The abs tol must be on the first line:\n\n```\n**********************************************************************\nFile \"src/sage/schemes/riemann_surfaces/riemann_surface.py\", line 1687, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.rigorous_line_integral\nFailed example:\n    S.rigorous_line_integral([(0,0), (1,0)], differentials, \n                             bounding_data)  # abs tol 1e-10\nExpected:\n    (1.80277751848459e-16 - 0.352971844594760*I)\nGot:\n    (1.94516164135444e-16 - 0.352971844594760*I)\n**********************************************************************\n1 item had failures:\n   1 of   9 in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.rigorous_line_integral\n    [373 tests, 1 failure, 47.34 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/schemes/riemann_surfaces/riemann_surface.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2021-08-30T21:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453282",
    "user": "https://github.com/vbraun"
}
```

The abs tol must be on the first line:

```
**********************************************************************
File "src/sage/schemes/riemann_surfaces/riemann_surface.py", line 1687, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.rigorous_line_integral
Failed example:
    S.rigorous_line_integral([(0,0), (1,0)], differentials, 
                             bounding_data)  # abs tol 1e-10
Expected:
    (1.80277751848459e-16 - 0.352971844594760*I)
Got:
    (1.94516164135444e-16 - 0.352971844594760*I)
**********************************************************************
1 item had failures:
   1 of   9 in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.rigorous_line_integral
    [373 tests, 1 failure, 47.34 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/schemes/riemann_surfaces/riemann_surface.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_453283.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-31T10:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453283",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453284.json:
```json
{
    "body": "Yes, exceeding line length because the doctest system requires things to be on one line is a very valid thing! Let's try again with positive review (it's almost a good idea to change a few \"non-significant\" digits in doctest output with tolerance, so that you test if the tolerance is actually taken into account)",
    "created_at": "2021-09-01T03:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453284",
    "user": "https://github.com/nbruin"
}
```

Yes, exceeding line length because the doctest system requires things to be on one line is a very valid thing! Let's try again with positive review (it's almost a good idea to change a few "non-significant" digits in doctest output with tolerance, so that you test if the tolerance is actually taken into account)



---

archive/issue_comments_453285.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-09-01T03:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453285",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_453286.json:
```json
{
    "body": "There might be an error on line 1796, that the code should be \n\n```diff\n-    N_required = ((64*M/(15*(1-1/expr)*E_global)).log()/(2*expr.log())).ceil()\n+    N_required = ((64*M/(15*(1-expr**(-2))*E_global)).log()/(2*expr.log())).ceil()\n```\n\nThis is from the different between the exp(-r) and exp(-2r) in equations 3.11 and 3.25 of http://oops.uni-oldenburg.de/3607/1/neueff18.pdf ([Neu2018]). This would only have the effect of making `N_required` smaller, meaning the code isn't currently inaccurate, but perhaps slightly less optimised. I can't currently decipher where the change occurs in the text, perhaps someone can see this?",
    "created_at": "2021-09-03T15:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453286",
    "user": "https://github.com/DisneyHogg"
}
```

There might be an error on line 1796, that the code should be 

```diff
-    N_required = ((64*M/(15*(1-1/expr)*E_global)).log()/(2*expr.log())).ceil()
+    N_required = ((64*M/(15*(1-expr**(-2))*E_global)).log()/(2*expr.log())).ceil()
```

This is from the different between the exp(-r) and exp(-2r) in equations 3.11 and 3.25 of http://oops.uni-oldenburg.de/3607/1/neueff18.pdf ([Neu2018]). This would only have the effect of making `N_required` smaller, meaning the code isn't currently inaccurate, but perhaps slightly less optimised. I can't currently decipher where the change occurs in the text, perhaps someone can see this?



---

archive/issue_comments_453287.json:
```json
{
    "body": "In [Trefethen, 2008] equation (4.14) is\n`|I-I_n|\\leq \\frac{64 M}{15(1-\\rho<sup>{-2})\\rho</sup>{2n+2}`\nwhich is attributed to [P. Rabinowitz, Rough and ready error estimates in Gaussian integration of analytic functions, Comm. ACM, 12 (1969), pp. 268\u2013270.: Equation 18] and [H. Brass, Quadraturverfahren, 1977: Theorem 90]. The Rabinowitz reference is readily available.\n\nI don't think there is a contradiction between (3.11) and (3.25): it looks like (3.25) receives some more advanced arguments. It's certainly not claimed to be derived from (3.11) directly. It may be worth checking if the extra +2 in Trefethen's version gives a further improvement (and if it's correct!)",
    "created_at": "2021-09-03T17:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453287",
    "user": "https://github.com/nbruin"
}
```

In [Trefethen, 2008] equation (4.14) is
`|I-I_n|\leq \frac{64 M}{15(1-\rho<sup>{-2})\rho</sup>{2n+2}`
which is attributed to [P. Rabinowitz, Rough and ready error estimates in Gaussian integration of analytic functions, Comm. ACM, 12 (1969), pp. 268–270.: Equation 18] and [H. Brass, Quadraturverfahren, 1977: Theorem 90]. The Rabinowitz reference is readily available.

I don't think there is a contradiction between (3.11) and (3.25): it looks like (3.25) receives some more advanced arguments. It's certainly not claimed to be derived from (3.11) directly. It may be worth checking if the extra +2 in Trefethen's version gives a further improvement (and if it's correct!)



---

archive/issue_events_084627.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-05T21:38:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31759#event-84627"
}
```



---

archive/issue_comments_453288.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-05T21:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453288",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_453289.json:
```json
{
    "body": "Replying to [comment:58 nbruin]:\n> In [Trefethen, 2008] equation (4.14) is\n> `|I-I_n|\\leq \\frac{64 M}{15(1-\\rho<sup>{-2})\\rho</sup>{2n+2}`\n> which is attributed to [P. Rabinowitz, Rough and ready error estimates in Gaussian integration of analytic functions, Comm. ACM, 12 (1969), pp. 268\u2013270.: Equation 18] and [H. Brass, Quadraturverfahren, 1977: Theorem 90]. The Rabinowitz reference is readily available.\n> \n> I don't think there is a contradiction between (3.11) and (3.25): it looks like (3.25) receives some more advanced arguments. It's certainly not claimed to be derived from (3.11) directly. It may be worth checking if the extra +2 in Trefethen's version gives a further improvement (and if it's correct!)\n\nTrefethen is using a modification of equation (19) from Rabinowitz, which I have checked and get the same answer, so there is the room for this modification (which, now that this ticket is closed, I will add on to #32297). You are right the equations don't follow directly, hence the reason the factors are not identical.",
    "created_at": "2021-09-08T14:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31759#issuecomment-453289",
    "user": "https://github.com/DisneyHogg"
}
```

Replying to [comment:58 nbruin]:
> In [Trefethen, 2008] equation (4.14) is
> `|I-I_n|\leq \frac{64 M}{15(1-\rho<sup>{-2})\rho</sup>{2n+2}`
> which is attributed to [P. Rabinowitz, Rough and ready error estimates in Gaussian integration of analytic functions, Comm. ACM, 12 (1969), pp. 268–270.: Equation 18] and [H. Brass, Quadraturverfahren, 1977: Theorem 90]. The Rabinowitz reference is readily available.
> 
> I don't think there is a contradiction between (3.11) and (3.25): it looks like (3.25) receives some more advanced arguments. It's certainly not claimed to be derived from (3.11) directly. It may be worth checking if the extra +2 in Trefethen's version gives a further improvement (and if it's correct!)

Trefethen is using a modification of equation (19) from Rabinowitz, which I have checked and get the same answer, so there is the room for this modification (which, now that this ticket is closed, I will add on to #32297). You are right the equations don't follow directly, hence the reason the factors are not identical.
