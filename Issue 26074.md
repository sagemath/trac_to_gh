# Issue 26074: py3: strange behavior of sleep() on Sage types

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-09-19 12:46:29

For some reason, passing Python's `time.sleep()` a Sage `RealLiteral` less than 1 returns more-or-less immediately:


```
sage: x = 0.5
sage: type(x)
<class 'sage.rings.real_mpfr.RealLiteral'>
sage: x2 = float(0.5)
sage: type(x2)
<class 'float'>
sage: timeit('sleep(x)')
625 loops, best of 3: 1 µs per loop
sage: timeit('sleep(x2)')
5 loops, best of 3: 500 ms per loop
sage: # One more time for the folks in back...
sage: timeit('sleep(x)')
625 loops, best of 3: 1.01 µs per loop
```


It's not just in the context of `timeit` either.  0.5 is long enough that if you do `sleep(x2)` directly you can feel the delay, whereas with `sleep(x)` there is much less or even no perceptible delay.''

However, 


```
sage: timeit('sleep(1.0)')
5 loops, best of 3: 1 s per loop
```


as expected.


---

Comment by vklein created at 2018-09-20 07:29:22

Thanks for the investigation.


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by embray created at 2019-01-10 16:08:06

It feels like there's been a bad habit in CPython lately of needlessly breaking support for custom numerical types.


---

Comment by embray created at 2019-01-22 12:15:10

Yeesh, that thread on bpo is a mess... :(


---

Comment by jdemeyer created at 2019-01-22 12:46:31

Replying to [comment:8 embray]:
> Yeesh, that thread on bpo is a mess... :(

Wait until you see the code. DRY clearly does not apply to the CPython code base: I had to make the same fix 3 times.


---

Comment by embray created at 2019-01-23 12:17:58

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 embray]:
> > Yeesh, that thread on bpo is a mess... :(
> 
> Wait until you see the code. DRY clearly does not apply to the CPython code base: I had to make the same fix 3 times.

Have you seen Sage's code base? ;)


---

Comment by embray created at 2019-03-25 10:44:36

Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.


---

Comment by @sheerluck created at 2022-01-14 10:43:30

Replying to [comment:9 jdemeyer]:
> I had to make the same fix 3 times.
For this ticket 1 time is enough, solved with two line patch:

```diff
--- a/Python/pytime.c
+++ b/Python/pytime.c
`@``@` -404,9 +404,11 `@``@`
 }
 
 static int
-_PyTime_FromObject(_PyTime_t *t, PyObject *obj, _PyTime_round_t round,
+_PyTime_FromObject(_PyTime_t *t, PyObject *xobj, _PyTime_round_t round,
                    long unit_to_ns)
 {
+    PyObject *obj;
+    obj = PyNumber_Float(xobj);
     if (PyFloat_Check(obj)) {
         double d;
         d = PyFloat_AsDouble(obj);
```

This patch solves only one thing:

```
TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
```

and only for `time.sleep()`

I understand that custom builded python is not for everyone.
