# Issue 26074: py3: strange behavior of sleep() on Sage types

archive/issues_026074.json:
```json
{
    "body": "For some reason, passing Python's `time.sleep()` a Sage `RealLiteral` less than 1 returns more-or-less immediately:\n\n\n```\nsage: x = 0.5\nsage: type(x)\n<class 'sage.rings.real_mpfr.RealLiteral'>\nsage: x2 = float(0.5)\nsage: type(x2)\n<class 'float'>\nsage: timeit('sleep(x)')\n625 loops, best of 3: 1 \u00b5s per loop\nsage: timeit('sleep(x2)')\n5 loops, best of 3: 500 ms per loop\nsage: # One more time for the folks in back...\nsage: timeit('sleep(x)')\n625 loops, best of 3: 1.01 \u00b5s per loop\n```\n\n\nIt's not just in the context of `timeit` either.  0.5 is long enough that if you do `sleep(x2)` directly you can feel the delay, whereas with `sleep(x)` there is much less or even no perceptible delay.''\n\nHowever, \n\n\n```\nsage: timeit('sleep(1.0)')\n5 loops, best of 3: 1 s per loop\n```\n\n\nas expected.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26311\n\n",
    "created_at": "2018-09-19T12:46:29Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "py3: strange behavior of sleep() on Sage types",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26074",
    "user": "embray"
}
```
For some reason, passing Python's `time.sleep()` a Sage `RealLiteral` less than 1 returns more-or-less immediately:


```
sage: x = 0.5
sage: type(x)
<class 'sage.rings.real_mpfr.RealLiteral'>
sage: x2 = float(0.5)
sage: type(x2)
<class 'float'>
sage: timeit('sleep(x)')
625 loops, best of 3: 1 µs per loop
sage: timeit('sleep(x2)')
5 loops, best of 3: 500 ms per loop
sage: # One more time for the folks in back...
sage: timeit('sleep(x)')
625 loops, best of 3: 1.01 µs per loop
```


It's not just in the context of `timeit` either.  0.5 is long enough that if you do `sleep(x2)` directly you can feel the delay, whereas with `sleep(x)` there is much less or even no perceptible delay.''

However, 


```
sage: timeit('sleep(1.0)')
5 loops, best of 3: 1 s per loop
```


as expected.

Issue created by migration from https://trac.sagemath.org/ticket/26311





---

archive/issue_comments_367679.json:
```json
{
    "body": "Thanks for the investigation.",
    "created_at": "2018-09-20T07:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367679",
    "user": "vklein"
}
```

Thanks for the investigation.



---

archive/issue_comments_367680.json:
```json
{
    "body": "Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367680",
    "user": "embray"
}
```

Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_comments_367681.json:
```json
{
    "body": "It feels like there's been a bad habit in CPython lately of needlessly breaking support for custom numerical types.",
    "created_at": "2019-01-10T16:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367681",
    "user": "embray"
}
```

It feels like there's been a bad habit in CPython lately of needlessly breaking support for custom numerical types.



---

archive/issue_comments_367682.json:
```json
{
    "body": "Yeesh, that thread on bpo is a mess... :(",
    "created_at": "2019-01-22T12:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367682",
    "user": "embray"
}
```

Yeesh, that thread on bpo is a mess... :(



---

archive/issue_comments_367683.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> Yeesh, that thread on bpo is a mess... :(\n\nWait until you see the code. DRY clearly does not apply to the CPython code base: I had to make the same fix 3 times.",
    "created_at": "2019-01-22T12:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367683",
    "user": "jdemeyer"
}
```

Replying to [comment:8 embray]:
> Yeesh, that thread on bpo is a mess... :(

Wait until you see the code. DRY clearly does not apply to the CPython code base: I had to make the same fix 3 times.



---

archive/issue_comments_367684.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:8 embray]:\n> > Yeesh, that thread on bpo is a mess... :(\n> \n> Wait until you see the code. DRY clearly does not apply to the CPython code base: I had to make the same fix 3 times.\n\nHave you seen Sage's code base? ;)",
    "created_at": "2019-01-23T12:17:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367684",
    "user": "embray"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 embray]:
> > Yeesh, that thread on bpo is a mess... :(
> 
> Wait until you see the code. DRY clearly does not apply to the CPython code base: I had to make the same fix 3 times.

Have you seen Sage's code base? ;)



---

archive/issue_comments_367685.json:
```json
{
    "body": "Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.",
    "created_at": "2019-03-25T10:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367685",
    "user": "embray"
}
```

Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.



---

archive/issue_comments_367686.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> I had to make the same fix 3 times.\nFor this ticket 1 time is enough, solved with two line patch:\n\n```diff\n--- a/Python/pytime.c\n+++ b/Python/pytime.c\n@@ -404,9 +404,11 @@\n }\n \n static int\n-_PyTime_FromObject(_PyTime_t *t, PyObject *obj, _PyTime_round_t round,\n+_PyTime_FromObject(_PyTime_t *t, PyObject *xobj, _PyTime_round_t round,\n                    long unit_to_ns)\n {\n+    PyObject *obj;\n+    obj = PyNumber_Float(xobj);\n     if (PyFloat_Check(obj)) {\n         double d;\n         d = PyFloat_AsDouble(obj);\n```\n\nThis patch solves only one thing:\n\n```\nTypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer\n```\n\nand only for `time.sleep()`\n\nI understand that custom builded python is not for everyone.",
    "created_at": "2022-01-14T10:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26074",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26074#issuecomment-367686",
    "user": "@sheerluck"
}
```

Replying to [comment:9 jdemeyer]:
> I had to make the same fix 3 times.
For this ticket 1 time is enough, solved with two line patch:

```diff
--- a/Python/pytime.c
+++ b/Python/pytime.c
@@ -404,9 +404,11 @@
 }
 
 static int
-_PyTime_FromObject(_PyTime_t *t, PyObject *obj, _PyTime_round_t round,
+_PyTime_FromObject(_PyTime_t *t, PyObject *xobj, _PyTime_round_t round,
                    long unit_to_ns)
 {
+    PyObject *obj;
+    obj = PyNumber_Float(xobj);
     if (PyFloat_Check(obj)) {
         double d;
         d = PyFloat_AsDouble(obj);
```

This patch solves only one thing:

```
TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
```

and only for `time.sleep()`

I understand that custom builded python is not for everyone.
