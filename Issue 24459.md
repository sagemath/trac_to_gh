# Issue 24459: giac fails to compile with clang-3.8 on OpenSuSE

Issue created by migration from https://trac.sagemath.org/ticket/24696

Original creator: rws

Original creation time: 2018-02-09 15:28:22

CC:  frederichan

`hash_map` was deprecated with C++11 but is still available with gcc installations, e.g., in `/usr/bin/../lib64/gcc/x86_64-suse-linux/4.8/../../../../include/c++/4.8/backward/hash_map:83`. That's presumably why there was no need for giac authors to switch to `unordered_map`. However clang installations do not have it or pick it out of gcc include paths, leading to compile failure with `CC=clang` on OpenSuSE Leap 42.3:


```
In file included from input_lexer.ll:48:
In file included from ./giacPCH.h:8:
./index.h:571:11: error: no template named 'hash_map' in namespace 'std'; did yo
u mean '__gnu_cxx::hash_map'?
  typedef std::hash_map< index_t,index_m,hash_function_object > hash_index ;
          ^~~~~~~~~~~~~
          __gnu_cxx::hash_map
/usr/bin/../lib64/gcc/x86_64-suse-linux/4.8/../../../../include/c++/4.8/backward
/hash_map:83:11: note: '__gnu_cxx::hash_map' declared here
    class hash_map
          ^
```

Possibly a missing system package should be installed, or a shell compile option be added? Ultimately however `unordered_map` should be used.


---

Comment by jdemeyer created at 2018-02-09 15:38:38

Changing priority from major to blocker.


---

Attachment


---

Comment by rws created at 2018-02-09 15:45:23

Actually giac has involved configure detection of `hash_map`/`unordered_map` presence which just fails here. Part of the log (attached):

```
checking for clock_gettime in -lrt... yes
checking unordered_map usability... no
checking unordered_map presence... no
checking for unordered_map... no
checking ext/hash_map usability... yes
checking ext/hash_map presence... yes
checking for ext/hash_map... yes
checking tr1/unordered_map usability... yes
checking tr1/unordered_map presence... yes
checking for tr1/unordered_map... yes
checking hash_map usability... yes
checking hash_map presence... yes
checking for hash_map... yes
checking pwd.h usability... yes
```



---

Comment by rws created at 2018-02-09 15:52:31

This snippet in `index.h`:

```
#if defined UNORDERED_MAP  && !defined(__clang__) && !defined(VISUALC) // && !defined(__APPLE__)
#include <tr1/unordered_map>
#define HASH_MAP_NAMESPACE std::tr1
#define hash_map unordered_map
#else // UNORDERED_MAP
```

and the code in the same file giving the error:

```
  typedef HASH_MAP_NAMESPACE::hash_map< index_t,index_m,hash_function_object > hash_index ;  
```



---

Comment by jdemeyer created at 2018-02-09 16:04:58

These days, it would be better to just assume C++11 and use `unordered_map`.


---

Comment by rws created at 2018-02-09 16:07:51

Changing status from new to needs_review.


---

Comment by rws created at 2018-02-09 16:07:51

Should be tested on other clang systems.
----
New commits:


---

Comment by jdemeyer created at 2018-02-09 16:48:48

If this works for you, I'm willing to set this to positive_review.


---

Comment by fbissey created at 2018-02-09 18:34:38

I guess it wasn't seen because we haven't tested a clang that old for some time. Also I think your clang uses libstdc++ from gcc-4.8 while all we made a point of testing with clang's own libstdc++.
The fix looks OK but it is really stuff that should be tested in configure, with c++11 you don't need tr1 for unordered map, I battled that in `brial`.


---

Comment by rws created at 2018-02-10 07:30:11

Jeroen, it works fine, I assume I can set positive?

Replying to [comment:8 fbissey]:
> I guess it wasn't seen because we haven't tested a clang that old for some time. Also I think your clang uses libstdc++ from gcc-4.8 while all we made a point of testing with clang's own libstdc++.

Right, they have no official clang libstdc++ package on OpenSuSE.

> The fix looks OK but it is really stuff that should be tested in configure, with c++11 you don't need tr1 for unordered map, I battled that in `brial`.

Well, I think it's clearly a giac problem and the patch should be applied upstream. Could you please, `@`frederichan?


---

Comment by rws created at 2018-02-10 07:30:11

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-02-10 07:52:37

To be honest this patch is a band aid. A proper fix is to detect hash_map properly from configure rather applying pragma trying to find compilers you think will support such and such form of the feature. Something a bit like this [https://github.com/BRiAl/BRiAl/commit/510694f702ae074288e2c3fda16fbf49dabb9c36#diff-67e997bcfdac55191033d57a16d1408a](https://github.com/BRiAl/BRiAl/commit/510694f702ae074288e2c3fda16fbf49dabb9c36#diff-67e997bcfdac55191033d57a16d1408a)


---

Comment by dimpase created at 2018-02-10 08:10:31

Replying to [comment:9 rws]:
> Jeroen, it works fine, I assume I can set positive?
> 
> Replying to [comment:8 fbissey]:
> > I guess it wasn't seen because we haven't tested a clang that old for some time. Also I think your clang uses libstdc++ from gcc-4.8 while all we made a point of testing with clang's own libstdc++.
> 
> Right, they have no official clang libstdc++ package on OpenSuSE.

they do have it: https://software.opensuse.org/package/libc++1

(libstdc++ is the name for the GNU c++ library)

> 
> > The fix looks OK but it is really stuff that should be tested in configure, with c++11 you don't need tr1 for unordered map, I battled that in `brial`.
> 
> Well, I think it's clearly a giac problem and the patch should be applied upstream. Could you please, `@`frederichan?


---

Comment by rws created at 2018-02-10 08:28:51

Replying to [comment:11 dimpase]:
> Replying to [comment:9 rws]:
> > Right, they have no official clang libstdc++ package on OpenSuSE.
> 
> they do have it: https://software.opensuse.org/package/libc++1
> 
> (libstdc++ is the name for the GNU c++ library)

Maybe but the ones for Leap 42.3 are all unstable (not official in my reading).


---

Comment by rws created at 2018-02-10 09:28:01

I installed clang-5 and libc++-5 but couldn't deinstall libstdc++ because even clang depends on it. With both libs installed `sage -f giac` still fails, so libc++ needs to be specified on build.


---

Comment by fbissey created at 2018-02-10 09:32:32

Removing libstdc++ would destroy your g++ and everything in your system built with it. So it is kind of important. Try `CXX="clang++ -stdlib=libc++"`. Provided that `clang++` is the right name to use, would you have `clang-5` and `clang++-5` from those rpms?


---

Comment by rws created at 2018-02-10 09:43:13

Replying to [comment:14 fbissey]:
> Removing libstdc++ would destroy your g++ and everything in your system built with it. So it is kind of important. Try `CXX="clang++ -stdlib=libc++"`. Provided that `clang++` is the right name to use, would you have `clang-5` and `clang++-5` from those rpms?

Yes everything up to `clang++-5.0.0`. Now I get

```
[giac-1.4.9.45.p1] /home/ralf/sage/local/var/tmp/sage/build/giac-1.4.9.45.p1/src/src/.libs/libgiac.so: undefined reference to `NTL::operator<<(std::__1::basic_ostream<char, std::__1::char_traits<char> >&, NTL::GF2X const&)'
[giac-1.4.9.45.p1] /home/ralf/sage/local/var/tmp/sage/build/giac-1.4.9.45.p1/src/src/.libs/libgiac.so: undefined reference to `NTL::operator<<(std::__1::basic_ostream<char, std::__1::char_traits<char> >&, NTL::ZZ_pX const&)'
[giac-1.4.9.45.p1] clang-5.0.0: error: linker command failed with exit code 1 (use -v to see invocation)
[giac-1.4.9.45.p1] Makefile:582: recipe for target 'xcas' failed
[giac-1.4.9.45.p1] make[4]: *** [xcas] Error 1
```



---

Comment by rws created at 2018-02-10 09:45:28

Ah I should build NTL with that as well...


---

Comment by fbissey created at 2018-02-10 10:01:52

You may want to `make distclean` libc++ and libstdc++ are not compatible.


---

Comment by frederichan created at 2018-02-11 10:02:49

Hello, I am reporting this here:
http://xcas.e.ujf-grenoble.fr/XCAS/viewtopic.php?f=4&t=2010


---

Comment by vbraun created at 2018-02-11 13:10:32

Reviewer name...


---

Comment by vbraun created at 2018-02-11 13:10:32

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2018-02-11 20:11:49

Changing status from needs_work to positive_review.


---

Comment by rws created at 2018-02-12 06:58:14

It looks like this is also necessary with clang-4.0.1 if no CXXFLAGS and LDFLAGS are set for libc++ but CLANG_DEFAULT_CXX_STDLIB=libc++ is set.


---

Comment by frederichan created at 2018-02-12 10:12:55

NB: upstream is testing if there are no side effects on some other configurations:

http://xcas.e.ujf-grenoble.fr/XCAS/viewtopic.php?f=4&t=2010


---

Comment by vbraun created at 2018-02-13 08:10:52

Resolution: fixed
