# Issue 11039: elliptic curve p-adic L-series claims to default to eclib but doesn't

Issue created by migration from https://trac.sagemath.org/ticket/11211

Original creator: was

Original creation time: 2011-04-17 04:35:29

Assignee: cremona

CC:  wuthrich

The code for making an elliptic curve p-adic L-series in schemes/elliptic_curves/padic_lseries.py starts like this:

```
    def __init__(self, E, p, use_eclib=False, normalize='L_ratio'):
        r"""
        INPUT:

        -  ``E`` - an elliptic curve
        -  ``p`` - a prime of good reduction
        -  ``use_eclib`` - bool (default:True); whether or not to use
           John Cremona's ``eclib`` for the computation of modular
           symbols
```


Note that claim that use_eclib defaults to True and the fact that it doesn't. 

Since eclib is supposed to be correct, and is much faster, it should be the default as claimed in the docstring.  The fix should be a patch that changes the one __init__ line.


---

Comment by was created at 2011-04-17 04:40:27

Note: there is also a call to create the L-series in padics.py that has use_eclib=False by default and is documented correctly.  The attached patch changes both cases to default to True.


---

Attachment


---

Comment by cremona created at 2011-04-17 04:42:08

I have CC'd Chris Wuthrich who I think is responsible for this code and should be able to judge.  It may be that there is some problem with part of eclib's modular symbols so they don't give exactly what is needed for this application.


---

Comment by was created at 2011-04-17 04:42:18

Changing status from new to needs_review.


---

Comment by cremona created at 2011-04-17 17:49:14

I get zillions of errors in padic_lseries.py with this patch.  (31 in fact).

They all seem to be either

```
File "/home/jec/sage-4.7.alpha4/devel/sage-main/sage/schemes/elliptic_curves/padics.py", iled example:
    sig_on_count()
Expected:
    0
Got:
    1
```

or

```
        def __reduce__(self):
      File "rational.pyx", line 484, in sage.rings.rational.Rational.__set_value (sage/rings/rational.c:7320)
        elif isinstance(x, tuple) and len(x) == 2:
      File "/home/jec/sage-current/local/lib/python/site-packages/sage/modular/cusps.py", line 512, in _rational_
        raise TypeError, "cusp %s is not a rational number"%self
    TypeError: cusp Infinity is not a rational number
```


Also in padics.py I get similar sig_on_count errors, and also 

```

File "/home/jec/sage-4.7.alpha4/devel/sage-main/sage/schemes/elliptic_curves/padics.py", line 138:
    sage: P(0)
Expected:
    3 + 3^2 + 2*3^4 + 2*3^5 + O(3^6)
Got:
    2 + 3 + 3^2 + 2*3^3 + 2*3^5 + 3^6 + O(3^7)
```

which looks not so trivial.

I'll leave this as "needs review" and hope that Chris will also take a look.


---

Comment by cremona created at 2011-04-22 10:44:09

Replying to [comment:6 mderickx]:
OK, I'm testing again against 4.7.alpha5 which has #10280 merged.


---

Comment by cremona created at 2011-04-22 11:11:58

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2011-04-22 11:11:58

Replying to [comment:7 cremona]:
> Replying to [comment:6 mderickx]:
> OK, I'm testing again against 4.7.alpha5 which has #10280 merged.

I still get lots of failures (they look just the same) in the same two files.  I don't know what is going on.


---

Comment by mderickx created at 2011-04-22 11:24:21

Hej John,

Sorry to make you think that the dependency would fix the issue. I just searched for trac to get a ticket which had the text "depends on" so I could test the new dependencies box I just created (look at the diff, it already said it depended on 10280).


---

Comment by cremona created at 2011-04-22 11:25:39

Replying to [comment:9 mderickx]:
> Hej John,
> 
> Sorry to make you think that the dependency would fix the issue. I just searched for trac to get a ticket which had the text "depends on" so I could test the new dependencies box I just created (look at the diff, it already said it depended on 10280).

No problem, I was just being optimistic.  I'm sure I can work out what is going on, since the problems arise only when eclib is used!


---

Comment by cremona created at 2011-04-22 14:17:08

Replaces previous;  applies to 4.7.alpha5


---

Attachment

The new patch (replaces previous) now works: there was some integer overflow.

Now I cannot be the one to give this a positive review, though it deserves it!  William? Chris?


---

Comment by cremona created at 2011-04-22 14:19:42

Changing status from needs_work to needs_review.


---

Comment by was created at 2011-04-24 03:51:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-05-03 08:51:28

The buildbot discovered some doctest failures on 32-bit systems which I believe to come from this ticket (but I'm not completely sure):

```
sage -t -long  -force_lib devel/sage/sage/schemes/elliptic_curves/sha_tate.py
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/schemes/elliptic_curves/sha_tate.py", line 483:
    sage: EllipticCurve('858k2').sha().an_padic(7)   # rank 0, non trivial sha, long time (10s on sage.math, 2011)
Exception raised:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_7[5]>", line 1, in <module>
        EllipticCurve('858k2').sha().an_padic(Integer(7))   # rank 0, non trivial sha, long time (10s on sage.math, 2011)###line 483:
    sage: EllipticCurve('858k2').sha().an_padic(7)   # rank 0, non trivial sha, long time (10s on sage.math, 2011)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/sha_tate.py", line 565, in an_padic
        lp = Et.padic_lseries(p)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py", line 159, in padic_lseries
        normalize = normalize, use_eclib=use_eclib)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/padic_lseries.py", line 199, in __init__
        self._modular_symbol = E.modular_symbol(sign=+1, use_eclib = use_eclib, normalize=normalize)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 1221, in modular_symbol
        M = ell_modular_symbols.ModularSymbolECLIB(self, sign, normalize=normalize)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_modular_symbols.py", line 499, in __init__
        self._modsym = ECModularSymbol(E)
      File "newforms.pyx", line 70, in sage.libs.cremona.newforms.ECModularSymbol.__init__ (sage/libs/cremona/newforms.cpp:1825)
    OverflowError: long int too large to convert to int
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/schemes/elliptic_curves/sha_tate.py", line 740:
    sage: e.sha().p_primary_bound(3)  # long time (10s on sage.math, 2011)
Exception raised:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_8[13]>", line 1, in <module>
        e.sha().p_primary_bound(Integer(3))  # long time (10s on sage.math, 2011)###line 740:
    sage: e.sha().p_primary_bound(3)  # long time (10s on sage.math, 2011)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/sha_tate.py", line 766, in p_primary_bound
        shan = self.an_padic(p,prec = 0,use_twists=True)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/sha_tate.py", line 565, in an_padic
        lp = Et.padic_lseries(p)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py", line 159, in padic_lseries
        normalize = normalize, use_eclib=use_eclib)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/padic_lseries.py", line 199, in __init__
        self._modular_symbol = E.modular_symbol(sign=+1, use_eclib = use_eclib, normalize=normalize)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 1221, in modular_symbol
        M = ell_modular_symbols.ModularSymbolECLIB(self, sign, normalize=normalize)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_modular_symbols.py", line 499, in __init__
        self._modsym = ECModularSymbol(E)
      File "newforms.pyx", line 70, in sage.libs.cremona.newforms.ECModularSymbol.__init__ (sage/libs/cremona/newforms.cpp:1825)
    OverflowError: long int too large to convert to int
**********************************************************************
File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/devel/sage-main/sage/schemes/elliptic_curves/sha_tate.py", line 748:
    sage: e.sha().an_padic(7)  # long time (depends on "e.sha().p_primary_bound(3)" above)
Exception raised:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_8[15]>", line 1, in <module>
        e.sha().an_padic(Integer(7))  # long time (depends on "e.sha().p_primary_bound(3)" above)###line 748:
    sage: e.sha().an_padic(7)  # long time (depends on "e.sha().p_primary_bound(3)" above)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/sha_tate.py", line 565, in an_padic
        lp = Et.padic_lseries(p)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/padics.py", line 159, in padic_lseries
        normalize = normalize, use_eclib=use_eclib)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/padic_lseries.py", line 199, in __init__
        self._modular_symbol = E.modular_symbol(sign=+1, use_eclib = use_eclib, normalize=normalize)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 1221, in modular_symbol
        M = ell_modular_symbols.ModularSymbolECLIB(self, sign, normalize=normalize)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-4.7.1.alpha0/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_modular_symbols.py", line 499, in __init__
        self._modsym = ECModularSymbol(E)
      File "newforms.pyx", line 70, in sage.libs.cremona.newforms.ECModularSymbol.__init__ (sage/libs/cremona/newforms.cpp:1825)
    OverflowError: long int too large to convert to int
**********************************************************************
```



---

Comment by jdemeyer created at 2011-05-03 08:51:28

Changing status from positive_review to needs_work.


---

Comment by zimmerma created at 2011-09-16 08:10:44

I confirm the failure on 32-bit computers with Sage 4.7.1, where the patch applies smoothly.

However there are already some tests that are known to fail on 32-bit, for example
in `lib/cremona/newforms.pyx`:

```
            sage: from sage.libs.cremona.newforms import ECModularSymbol
            sage: E = EllipticCurve('858k2')
            sage: ECModularSymbol(E)
            Traceback (most recent call last):                     # 32-bit
            ...                                                    # 32-bit
            OverflowError: long int too large to convert to int    # 32-bit
```

Should we mark the tests which are failing on 32-bit in the same way?

Paul


---

Comment by zimmerma created at 2011-09-16 08:10:44

Changing status from needs_work to needs_info.


---

Comment by wuthrich created at 2013-12-27 01:14:28

I have tried to rebase this ticket, too. It seems to pass all test on my 64-bit. But I have no access to 32-bit and so I would need somone to review this who has. I copied as suggested the # 32-bit into sha_tate at the three occasions listed above. But I have no idea if that is all that is needed for 32 bit. 

Sorry, if I did something wrong here.
----
New commits:


---

Comment by wuthrich created at 2013-12-27 01:14:28

Changing status from needs_info to needs_review.


---

Comment by cremona created at 2013-12-31 11:07:34

I should be able to test this on my 2008 laptop which is 32-bit and on which I built 6.0 yesterday.  If it does, then Chris or Jeroen can give it a positive review?


---

Comment by cremona created at 2013-12-31 15:39:53

OK, so I had to change 3 error messages from

```
OverflowError: long int too large to convert to int
```

to

```
OverflowError: Python int too large to convert to C long
```

and then tests pass on 32-bit.


---

Comment by cremona created at 2013-12-31 15:40:43

New commits:


---

Comment by jdemeyer created at 2014-01-01 17:47:28

What the purpose of the comment

```
# 32-bit (see :trac: `11211`)
```

the fact that those tests don't work on 32-bit has nothing to do with this ticket, right?
I would expect that ticket number to refer to a ticket saying "make sure these tests pass even on 32-bit systems".


---

Comment by jdemeyer created at 2014-01-01 17:55:40

One other small but important comment (possibly for a different ticket, but I felt I should mention it): do not put Python code inside `sig_on()`, espcially not if that Python code can raise exceptions. In particular, the following 3 lines (possibly more) should be outside the `sig_on()` block:

```
r = Cusp(r) 
d = r.denominator() 
n = r.numerator() 
```


The consequences of this can be severe:

```
sage: from sage.libs.cremona.newforms import ECModularSymbol
sage: E = EllipticCurve('11a')
sage: M = ECModularSymbol(E)
sage: M("garbage")
...
TypeError: unable to convert garbage to a rational
sage: pari("1/0")
...
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
------------------------------------------------------------------------
```


I also recommend that the line `M("garbage")` should become a doctest.


---

Comment by cremona created at 2014-01-01 19:30:40

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2014-01-01 19:30:40

I will move the sigon() and upload a new commit tomorrow, with some new doctests.


---

Comment by git created at 2014-01-02 11:48:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2014-01-02 11:49:46

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-01-03 20:54:20

If you accept this commit, positive_review to the `sig_on()` stuff (but I hope somebody else can review the rest of the ticket).


---

Comment by jdemeyer created at 2014-01-03 21:00:26

New commits:


---

Comment by cremona created at 2014-01-07 19:46:39

Chris, can you give this a positive review now?  You are the only reviewer not also an author, I think.


---

Comment by wuthrich created at 2014-01-08 21:43:03

Changing status from needs_review to positive_review.


---

Comment by wuthrich created at 2014-01-08 21:43:03

The tests pass for me (except a couple which I know is related to relocating the directory and not to this ticket).
I can only test 64-bit, but I understand that 32-bit now passes all tests too.

Thanks for the work.


---

Comment by vbraun created at 2014-01-10 07:29:51

Resolution: fixed
