# Issue 28669: generate zlib.pc if needed, or avoid using it.

archive/issues_028669.json:
```json
{
    "body": "CC:  fbissey embray isuruf mkoeppe\n\nsome perfectly fine implementations of zlib don't install zlib.pc (e.g. MacOS does not).\n\nSince #26286 this problem was sleeping, until we updated `pkgconfig` on #28883, which made it throw an error on absense of `zlib.pc`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28906\n\n",
    "created_at": "2019-12-22T16:32:39Z",
    "labels": [
        "build: configure",
        "major",
        "bug"
    ],
    "title": "generate zlib.pc if needed, or avoid using it.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28669",
    "user": "dimpase"
}
```
CC:  fbissey embray isuruf mkoeppe

some perfectly fine implementations of zlib don't install zlib.pc (e.g. MacOS does not).

Since #26286 this problem was sleeping, until we updated `pkgconfig` on #28883, which made it throw an error on absense of `zlib.pc`.

Issue created by migration from https://trac.sagemath.org/ticket/28906





---

archive/issue_comments_404947.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-12-23T18:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404947",
    "user": "dimpase"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_404948.json:
```json
{
    "body": "The biggest question I here is how to find the full path to `libz` located by `AC_CHECK_LIB` or other similar macro.\nThis path has to be written into `zlib.pc`.\n\nI don't quite know: I can link an executable with libz and analyse it with\n`readelf` or `otool` or a similar thing, but it's not platform independent,\nand I could not find a ready-made macro (I could change `AC_CHECK_LIB`, sure...)",
    "created_at": "2019-12-23T18:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404948",
    "user": "dimpase"
}
```

The biggest question I here is how to find the full path to `libz` located by `AC_CHECK_LIB` or other similar macro.
This path has to be written into `zlib.pc`.

I don't quite know: I can link an executable with libz and analyse it with
`readelf` or `otool` or a similar thing, but it's not platform independent,
and I could not find a ready-made macro (I could change `AC_CHECK_LIB`, sure...)



---

archive/issue_comments_404949.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-12-23T18:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404949",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_404950.json:
```json
{
    "body": "You can use a minimal pkgconfig file like below which doesn't require the full path to the library.\n\n\n```\nName: Foo\nDescription: description for foo\nVersion: 1.0.0\nLibs: -lfoo\n```\n",
    "created_at": "2019-12-23T23:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404950",
    "user": "isuruf"
}
```

You can use a minimal pkgconfig file like below which doesn't require the full path to the library.


```
Name: Foo
Description: description for foo
Version: 1.0.0
Libs: -lfoo
```




---

archive/issue_comments_404951.json:
```json
{
    "body": "well, a minimal pkgconfig like this would be just a bug in waiting to bite.\n\nI can think of one platform-independent way (well, it needs [dladdr](https://linux.die.net/man/3/dladdr), which is non-POSIX, but BSD, something that is available on most Unices, certainly on Linux and MacOS)\n\nWrite a C function that calls `dlopen()` on the library in question, and then\ncalls `dladdr()` on a symbol from the library; one of parts of the returned data is the full path to the shared object where the symbol is located.\nThat's a hell of a macro call to `AC_RUN_IFELSE` though :-)",
    "created_at": "2019-12-24T17:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404951",
    "user": "dimpase"
}
```

well, a minimal pkgconfig like this would be just a bug in waiting to bite.

I can think of one platform-independent way (well, it needs [dladdr](https://linux.die.net/man/3/dladdr), which is non-POSIX, but BSD, something that is available on most Unices, certainly on Linux and MacOS)

Write a C function that calls `dlopen()` on the library in question, and then
calls `dladdr()` on a symbol from the library; one of parts of the returned data is the full path to the shared object where the symbol is located.
That's a hell of a macro call to `AC_RUN_IFELSE` though :-)



---

archive/issue_comments_404952.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2019-12-24T17:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404952",
    "user": "dimpase"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_404953.json:
```json
{
    "body": "Could someone please try if the following works on MacOS, and if yes, what's the output\n\n```\n/* save into zt.c and run as follows:\n  $ cc -o zt zt.c -ldl && ./zt\n\n  On my Debian Linux box it outputs\n  /usr/lib/x86_64-linux-gnu/libz.so\n*/\n#include <stdio.h>\n#define __USE_GNU\n#include <dlfcn.h>\n#ifdef __APPLE__\n#define EXT \"dylib\"\n#else\n#define EXT \"so\"\n#endif\nint main() {\nvoid *z;\nDl_info  info;\nint res;\nvoid *ha;\nz = dlopen(\"libz.\"EXT,  RTLD_LAZY); /* load zlib */\nha = dlsym(z, \"inflateEnd\");       /* get address of inflateEnd in libz */\nres = dladdr(ha, &info);           /* get info for the function */\nprintf(\"%s\\n\", info.dli_fname);\nreturn res;\n}\n```\n",
    "created_at": "2019-12-25T06:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404953",
    "user": "dimpase"
}
```

Could someone please try if the following works on MacOS, and if yes, what's the output

```
/* save into zt.c and run as follows:
  $ cc -o zt zt.c -ldl && ./zt

  On my Debian Linux box it outputs
  /usr/lib/x86_64-linux-gnu/libz.so
*/
#include <stdio.h>
#define __USE_GNU
#include <dlfcn.h>
#ifdef __APPLE__
#define EXT "dylib"
#else
#define EXT "so"
#endif
int main() {
void *z;
Dl_info  info;
int res;
void *ha;
z = dlopen("libz."EXT,  RTLD_LAZY); /* load zlib */
ha = dlsym(z, "inflateEnd");       /* get address of inflateEnd in libz */
res = dladdr(ha, &info);           /* get info for the function */
printf("%s\n", info.dli_fname);
return res;
}
```




---

archive/issue_comments_404954.json:
```json
{
    "body": "Replying to [comment:8 dimpase]:\n> Could someone please try if the following works on MacOS, and if yes, what's the output\n\n\n\n```\nfbissey@itsv-frb15 GitHub % uname -a\nDarwin itsv-frb15.lan 19.2.0 Darwin Kernel Version 19.2.0: Sat Nov  9 03:47:04 PST 2019; root:xnu-6153.61.1~20/RELEASE_X86_64 x86_64\nfbissey@itsv-frb15 GitHub % cc -o zt zt.c -ldl && ./zt\n/usr/lib/libz.1.dylib\n```\n",
    "created_at": "2019-12-25T06:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404954",
    "user": "fbissey"
}
```

Replying to [comment:8 dimpase]:
> Could someone please try if the following works on MacOS, and if yes, what's the output



```
fbissey@itsv-frb15 GitHub % uname -a
Darwin itsv-frb15.lan 19.2.0 Darwin Kernel Version 19.2.0: Sat Nov  9 03:47:04 PST 2019; root:xnu-6153.61.1~20/RELEASE_X86_64 x86_64
fbissey@itsv-frb15 GitHub % cc -o zt zt.c -ldl && ./zt
/usr/lib/libz.1.dylib
```




---

archive/issue_comments_404955.json:
```json
{
    "body": "I suggest linking the executable `zt` to `libz` so that the correct shared library is loaded.",
    "created_at": "2019-12-25T13:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404955",
    "user": "isuruf"
}
```

I suggest linking the executable `zt` to `libz` so that the correct shared library is loaded.



---

archive/issue_comments_404956.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-25T17:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404956",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404957.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-26T09:02:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404957",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_404958.json:
```json
{
    "body": "This branch is so far only for zlib.pc\n\nAny obvious things I missed?\n\nNaturally, I'd appreciate it tested on MacOS.\n\nFor libpng.pc I'll probably refactor that, to make computing abstolute path to libpng/libz/libWhatever a macro.",
    "created_at": "2019-12-26T09:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404958",
    "user": "dimpase"
}
```

This branch is so far only for zlib.pc

Any obvious things I missed?

Naturally, I'd appreciate it tested on MacOS.

For libpng.pc I'll probably refactor that, to make computing abstolute path to libpng/libz/libWhatever a macro.



---

archive/issue_comments_404959.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-12-26T09:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404959",
    "user": "dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_404960.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-27T02:26:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404960",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404961.json:
```json
{
    "body": "this is a result - ugly as hell. I am not sure whether this should get in.",
    "created_at": "2019-12-27T02:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404961",
    "user": "dimpase"
}
```

this is a result - ugly as hell. I am not sure whether this should get in.



---

archive/issue_comments_404962.json:
```json
{
    "body": "Replying to [comment:6 dimpase]:\n> well, a minimal pkgconfig like this would be just a bug in waiting to bite.\n\nWould it though?  Why exactly do we *require* pkgconfig here at all?  It's a convenience sure, but on systems that don't install .pc files for some libraries we can still get the required information another way...\n\nI mean, if autoconf could detect a system zlib in the first place, then I don't see why would need the absolute path to the SO file itself. All that should be needed to link against that library are whatever compiler/linker flags (e.g. `-lz`) that autoconf used to detect usability of the library in the first place.",
    "created_at": "2019-12-30T13:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404962",
    "user": "embray"
}
```

Replying to [comment:6 dimpase]:
> well, a minimal pkgconfig like this would be just a bug in waiting to bite.

Would it though?  Why exactly do we *require* pkgconfig here at all?  It's a convenience sure, but on systems that don't install .pc files for some libraries we can still get the required information another way...

I mean, if autoconf could detect a system zlib in the first place, then I don't see why would need the absolute path to the SO file itself. All that should be needed to link against that library are whatever compiler/linker flags (e.g. `-lz`) that autoconf used to detect usability of the library in the first place.



---

archive/issue_comments_404963.json:
```json
{
    "body": "Replying to [comment:17 embray]:\n> Replying to [comment:6 dimpase]:\n> > well, a minimal pkgconfig like this would be just a bug in waiting to bite.\n> \n> Would it though?  Why exactly do we *require* pkgconfig here at all?  It's a convenience sure, but on systems that don't install .pc files for some libraries we can still get the required information another way...\n\nI am thinking of a library trying to detect zlib by calling pkg-config rather than \nusing autoconf. \n\nIMHO it's better not to install a pc file at all rather than install a rather bogus one. That's why I prefer how it's done on #28883.\n\n\n> \n> I mean, if autoconf could detect a system zlib in the first place, then I don't see why would need the absolute path to the SO file itself. All that should be needed to link against that library are whatever compiler/linker flags (e.g. `-lz`) that autoconf used to detect usability of the library in the first place.",
    "created_at": "2019-12-30T14:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404963",
    "user": "dimpase"
}
```

Replying to [comment:17 embray]:
> Replying to [comment:6 dimpase]:
> > well, a minimal pkgconfig like this would be just a bug in waiting to bite.
> 
> Would it though?  Why exactly do we *require* pkgconfig here at all?  It's a convenience sure, but on systems that don't install .pc files for some libraries we can still get the required information another way...

I am thinking of a library trying to detect zlib by calling pkg-config rather than 
using autoconf. 

IMHO it's better not to install a pc file at all rather than install a rather bogus one. That's why I prefer how it's done on #28883.


> 
> I mean, if autoconf could detect a system zlib in the first place, then I don't see why would need the absolute path to the SO file itself. All that should be needed to link against that library are whatever compiler/linker flags (e.g. `-lz`) that autoconf used to detect usability of the library in the first place.



---

archive/issue_comments_404964.json:
```json
{
    "body": "It's not necessarily \"bogus\".  But I agree--I think what you did in #28883 is more in line with what I was trying to say here.",
    "created_at": "2019-12-30T15:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404964",
    "user": "embray"
}
```

It's not necessarily "bogus".  But I agree--I think what you did in #28883 is more in line with what I was trying to say here.



---

archive/issue_comments_404965.json:
```json
{
    "body": "I don't see the difference in #28883 and a minimal .pc file as in #28906#comment:5 . They do the same thing.",
    "created_at": "2019-12-31T00:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404965",
    "user": "isuruf"
}
```

I don't see the difference in #28883 and a minimal .pc file as in #28906#comment:5 . They do the same thing.



---

archive/issue_comments_404966.json:
```json
{
    "body": "Replying to [comment:20 isuruf]:\n> I don't see the difference in #28883 and a minimal .pc file as in #28906#comment:5 . They do the same thing.\n\nyes, but they do so by different means, and a pc file is much more likely to trip up someone.",
    "created_at": "2019-12-31T01:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404966",
    "user": "dimpase"
}
```

Replying to [comment:20 isuruf]:
> I don't see the difference in #28883 and a minimal .pc file as in #28906#comment:5 . They do the same thing.

yes, but they do so by different means, and a pc file is much more likely to trip up someone.



---

archive/issue_comments_404967.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-24T17:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404967",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_404968.json:
```json
{
    "body": "I don't know if this ticket is still needed; but if it is, then it should be revised along the lines of #29082 -- do not write into SAGE_LOCAL at configure time; instead generate a rule in build/make/Makefile that generates the pc file there.",
    "created_at": "2020-03-24T17:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404968",
    "user": "mkoeppe"
}
```

I don't know if this ticket is still needed; but if it is, then it should be revised along the lines of #29082 -- do not write into SAGE_LOCAL at configure time; instead generate a rule in build/make/Makefile that generates the pc file there.



---

archive/issue_comments_404969.json:
```json
{
    "body": "I don't recall right now all the details, why I thought it's needed. Anyhow, perhaps as a concept of how to generate *.pc files, e.g. for openblas.",
    "created_at": "2020-03-24T17:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28669",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28669#issuecomment-404969",
    "user": "dimpase"
}
```

I don't recall right now all the details, why I thought it's needed. Anyhow, perhaps as a concept of how to generate *.pc files, e.g. for openblas.
