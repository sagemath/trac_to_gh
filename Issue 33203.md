# Issue 33203: sage.libs.singular: Do not fail if the Singular binary is not in PATH

Issue created by migration from https://trac.sagemath.org/ticket/33440

Original creator: mkoeppe

Original creation time: 2022-03-01 19:12:07

CC:  mjo dimpase mderickx

This code from #29024

```
    os.environ["SINGULAR_BIN_DIR"] = dirname(which("Singular"))
```

assumes that `Singular` is in PATH

This causes errors when users attempt to use sagelib outside of the environment set up by `sage-env`.

https://groups.google.com/g/sage-support/c/XBxpl-JjaNU/m/FtRvcoW0AgAJ



---

Comment by mkoeppe created at 2022-03-01 19:12:54

Fix should be via `sage.features` / #31296


---

Comment by mjo created at 2022-03-01 21:11:38

We have this problem in a lot of packages and we usually use`sage_conf`to store one of two values: the system location, or the sage location -- depending on what's detected at `./configure` time. The `spkg-configure.m4` for singular already detects `SINGULAR_BIN`; we probably just need to record its `dirname()` if it's not in the system's `PATH`.


---

Comment by mkoeppe created at 2022-03-01 23:37:10

I don't know if we need it as a configuration variable because the configure script just searches for it in PATH.


---

Comment by mjo created at 2022-03-01 23:40:24

Replying to [comment:4 mkoeppe]:
> I don't know if we need it as a configuration variable because the configure script just searches for it in PATH.

The `SAGE_LOCAL` location will be prepended to `PATH` during `./configure` though, so that's the time to write it down. Then later the location is known regardless of what `PATH` contains.


---

Comment by mjo created at 2022-03-01 23:42:31

Replying to [comment:5 mjo]:
> 
> The `SAGE_LOCAL` location will be prepended to `PATH` during `./configure` though, so that's the time to write it down. Then later the location is known regardless of what `PATH` contains.
> 

Sorry, that's half nonsense. If we **don't** find `Singular` in the `PATH`, we know that it's in the `SAGE_LOCAL` location, and we put that value into `sage_conf` so that later we don't need to rely on `PATH`.


---

Comment by mjo created at 2022-03-01 23:55:58

I know you know this already, but I think adding geographically varied runtime checks for things that are known at build time is the wrong solution.
----
New commits:


---

Comment by git created at 2022-03-01 23:58:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-01 23:59:04

No objection if you want to provide `SINGULAR_BIN` via `sage_conf`


---

Comment by git created at 2022-03-02 00:10:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-02 00:11:58

Replying to [comment:10 mkoeppe]:
> No objection if you want to provide `SINGULAR_BIN` via `sage_conf`

This variable would be used in `src/sage/features/singular.py`


---

Comment by git created at 2022-03-02 05:21:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-02 05:36:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-02 05:36:43

Changing status from new to needs_review.


---

Comment by git created at 2022-03-03 02:55:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-12 18:19:19

Let's get this in please


---

Comment by dimpase created at 2022-03-12 20:34:29

How does one test this? I tried the way given in the link, but it ends up as follows:

```
ima@hilbert /mnt/opt/Sage $ ./sage-dev/sage -python3 -m venv --system-site-packages venv
dima@hilbert /mnt/opt/Sage $ source venv/bin/activate
(venv) dima@hilbert /mnt/opt/Sage $ python3
Python 3.9.10 (main, Mar  4 2022, 14:46:20) 
[GCC 11.2.1 20211127] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from sage.all import *
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ModuleNotFoundError: No module named 'sage'
>>> 
```


Am I doing something wrong?


---

Comment by mkoeppe created at 2022-03-12 20:36:43

The method of setting up the venv that was tried in that post only works when Sage has built its own Python. One cannot make a venv from a venv.


---

Comment by mkoeppe created at 2022-03-12 20:37:43

You can test it by just using command lines like the ones I showed in #31296


---

Comment by dimpase created at 2022-03-12 21:17:36

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-03-12 21:17:36

OK, this works.


---

Comment by mkoeppe created at 2022-03-12 21:41:14

Thank you!


---

Comment by vbraun created at 2022-03-21 23:34:23

Resolution: fixed
