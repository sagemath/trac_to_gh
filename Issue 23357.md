# Issue 23357: Upgrade scipy to 0.19.1

archive/issues_023357.json:
```json
{
    "body": "Routine upgrade. I have enough of seeing various doctests failing in sage-on-gentoo when using this version.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23594\n\n",
    "created_at": "2017-08-07T23:54:39Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Upgrade scipy to 0.19.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23357",
    "user": "https://github.com/kiwifb"
}
```
Routine upgrade. I have enough of seeing various doctests failing in sage-on-gentoo when using this version.

Issue created by migration from https://trac.sagemath.org/ticket/23594





---

archive/issue_comments_326527.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-08T01:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326527",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_326528.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-08-08T01:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326528",
    "user": "https://github.com/kiwifb"
}
```

New commits:



---

archive/issue_comments_326529.json:
```json
{
    "body": "Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?",
    "created_at": "2017-08-09T17:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326529",
    "user": "https://github.com/videlec"
}
```

Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?



---

archive/issue_comments_326530.json:
```json
{
    "body": "Replying to [comment:4 vdelecroix]:\n> Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?\n\nI thought of that. At the moment I kept things consistent with other doctests giving the same results. So if using tolerance I think \n* we need to go back to the whole series of doctests not just the ones broken by this upgrade\n* You can you only set one tolerance for one result so you need to align things not with `0.9999999` but with `0.999999` (one less `9`)\n\nThat being said there is already inconsistency in the number of decimals quoted for the results starting with `1.` compared to the one starting with `0.9`. Harmonizing all of this would probably be a good thing.\n\nWould you support touching the other doctest giving similar results to the ones broken by the upgrade?",
    "created_at": "2017-08-09T21:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326530",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:4 vdelecroix]:
> Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?

I thought of that. At the moment I kept things consistent with other doctests giving the same results. So if using tolerance I think 
* we need to go back to the whole series of doctests not just the ones broken by this upgrade
* You can you only set one tolerance for one result so you need to align things not with `0.9999999` but with `0.999999` (one less `9`)

That being said there is already inconsistency in the number of decimals quoted for the results starting with `1.` compared to the one starting with `0.9`. Harmonizing all of this would probably be a good thing.

Would you support touching the other doctest giving similar results to the ones broken by the upgrade?



---

archive/issue_comments_326531.json:
```json
{
    "body": "Replying to [comment:5 fbissey]:\n> Replying to [comment:4 vdelecroix]:\n> > Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?\n>\n> Would you support touching the other doctest giving similar results to the ones broken by the upgrade?\n>\n\nI will.",
    "created_at": "2017-08-10T08:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326531",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:5 fbissey]:
> Replying to [comment:4 vdelecroix]:
> > Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?
>
> Would you support touching the other doctest giving similar results to the ones broken by the upgrade?
>

I will.



---

archive/issue_comments_326532.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-20T23:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326532",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_326533.json:
```json
{
    "body": "Done! Note that I didn't convert this to use tolerance\n\n```\n    We get additional convergence information with the `verbose` option::\n\n        sage: minimize(f, [.1, .3, .4], algorithm=\"ncg\", verbose=True)\n        Optimization terminated successfully.\n        ...\n        (0.9999999..., 0.999999..., 0.999999...)\n```\n\nbecause the verbose output message is already caught by `...` and you cannot mix that with `tol`. It just fails, you cannot use `...` and `tol` at the same time.",
    "created_at": "2017-08-20T23:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326533",
    "user": "https://github.com/kiwifb"
}
```

Done! Note that I didn't convert this to use tolerance

```
    We get additional convergence information with the `verbose` option::

        sage: minimize(f, [.1, .3, .4], algorithm="ncg", verbose=True)
        Optimization terminated successfully.
        ...
        (0.9999999..., 0.999999..., 0.999999...)
```

because the verbose output message is already caught by `...` and you cannot mix that with `tol`. It just fails, you cannot use `...` and `tol` at the same time.



---

archive/issue_comments_326534.json:
```json
{
    "body": "Something on this branch was meant for another completely unrelated one. I'll try to fix it before putting it back to review.",
    "created_at": "2017-08-20T23:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326534",
    "user": "https://github.com/kiwifb"
}
```

Something on this branch was meant for another completely unrelated one. I'll try to fix it before putting it back to review.



---

archive/issue_comments_326535.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-08-20T23:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326535",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_326536.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-20T23:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326536",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_326537.json:
```json
{
    "body": "I am actually glad to have found that bit. I thought I had lost it.",
    "created_at": "2017-08-20T23:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326537",
    "user": "https://github.com/kiwifb"
}
```

I am actually glad to have found that bit. I thought I had lost it.



---

archive/issue_comments_326538.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-08-20T23:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326538",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_326539.json:
```json
{
    "body": "Replying to [comment:7 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[cbe2690](https://git.sagemath.org/sage.git/commit/?id=cbe2690f4b4fa7bbb6cca1d263be5d90ea69f9e4)||`Use tolerance as much as possible in minimize`||\nCould you do the same for the other numerical values you truncated with `...` or does it make no sense?",
    "created_at": "2017-08-21T17:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326539",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Replying to [comment:7 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[cbe2690](https://git.sagemath.org/sage.git/commit/?id=cbe2690f4b4fa7bbb6cca1d263be5d90ea69f9e4)||`Use tolerance as much as possible in minimize`||
Could you do the same for the other numerical values you truncated with `...` or does it make no sense?



---

archive/issue_comments_326540.json:
```json
{
    "body": "You mean in the other files? It can be done, but in that case I will only touch those particular tests. In optimize.py we had a whole family of tests that I kept coherent as much as possible - including the ones that weren't affected by the upgrade.",
    "created_at": "2017-08-21T21:21:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326540",
    "user": "https://github.com/kiwifb"
}
```

You mean in the other files? It can be done, but in that case I will only touch those particular tests. In optimize.py we had a whole family of tests that I kept coherent as much as possible - including the ones that weren't affected by the upgrade.



---

archive/issue_comments_326541.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-21T21:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326541",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_326542.json:
```json
{
    "body": "Nah, that's ok as it is.\nLGTM.",
    "created_at": "2017-08-21T21:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326542",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Nah, that's ok as it is.
LGTM.



---

archive/issue_comments_326543.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-08-25T23:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326543",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_326544.json:
```json
{
    "body": "\n```\n**********************************************************************\nFile \"src/doc/en/thematic_tutorials/numerical_sage/weave.rst\", line 13, in doc.en.thematic_tutorials.numerical_sage.weave\nFailed example:\n    from scipy import weave\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest doc.en.thematic_tutorials.numerical_sage.weave[0]>\", line 1, in <module>\n        from scipy import weave\n    ImportError: cannot import name weave\n**********************************************************************\nFile \"src/doc/en/thematic_tutorials/numerical_sage/weave.rst\", line 15, in doc.en.thematic_tutorials.numerical_sage.weave\nFailed example:\n    from scipy.weave import converters\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 515, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 885, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest doc.en.thematic_tutorials.numerical_sage.weave[1]>\", line 1, in <module>\n        from scipy.weave import converters\n    ImportError: No module named weave\n**********************************************************************\n1 item had failures:\n   2 of   3 in doc.en.thematic_tutorials.numerical_sage.weave\n    [2 tests, 2 failures, 0.21 s]\n----------------------------------------------------------------------\nsage -t --long src/doc/en/thematic_tutorials/numerical_sage/weave.rst  # 2 doctests failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2017-08-25T23:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326544",
    "user": "https://github.com/vbraun"
}
```


```
**********************************************************************
File "src/doc/en/thematic_tutorials/numerical_sage/weave.rst", line 13, in doc.en.thematic_tutorials.numerical_sage.weave
Failed example:
    from scipy import weave
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest doc.en.thematic_tutorials.numerical_sage.weave[0]>", line 1, in <module>
        from scipy import weave
    ImportError: cannot import name weave
**********************************************************************
File "src/doc/en/thematic_tutorials/numerical_sage/weave.rst", line 15, in doc.en.thematic_tutorials.numerical_sage.weave
Failed example:
    from scipy.weave import converters
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest doc.en.thematic_tutorials.numerical_sage.weave[1]>", line 1, in <module>
        from scipy.weave import converters
    ImportError: No module named weave
**********************************************************************
1 item had failures:
   2 of   3 in doc.en.thematic_tutorials.numerical_sage.weave
    [2 tests, 2 failures, 0.21 s]
----------------------------------------------------------------------
sage -t --long src/doc/en/thematic_tutorials/numerical_sage/weave.rst  # 2 doctests failed
----------------------------------------------------------------------
```




---

archive/issue_comments_326545.json:
```json
{
    "body": "Not sure how it escaped me yet. Or the _reviewers_. After digging upstream, `weave` has been deprecated for some time. The plan has been to remove it before `1.0` (whenever that happens) for a while. It was also the only module not to have a python 3 version. Now it's gone (I think 0.18.x was the latest version to include it).\n\nIn that light, I plan to surgically remove all instances of `weave` in sage, which apparently doesn't extend further than the documentation. Opinions?",
    "created_at": "2017-08-26T05:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326545",
    "user": "https://github.com/kiwifb"
}
```

Not sure how it escaped me yet. Or the _reviewers_. After digging upstream, `weave` has been deprecated for some time. The plan has been to remove it before `1.0` (whenever that happens) for a while. It was also the only module not to have a python 3 version. Now it's gone (I think 0.18.x was the latest version to include it).

In that light, I plan to surgically remove all instances of `weave` in sage, which apparently doesn't extend further than the documentation. Opinions?



---

archive/issue_comments_326546.json:
```json
{
    "body": "I vote for: just remove completely the offending file\n\nsrc/doc/en/thematic_tutorials/numerical_sage/weave.rst",
    "created_at": "2017-08-26T13:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326546",
    "user": "https://github.com/fchapoton"
}
```

I vote for: just remove completely the offending file

src/doc/en/thematic_tutorials/numerical_sage/weave.rst



---

archive/issue_comments_326547.json:
```json
{
    "body": "There are a few extra references in other files (all in the doc) but I guess your vote covers that.",
    "created_at": "2017-08-26T20:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326547",
    "user": "https://github.com/kiwifb"
}
```

There are a few extra references in other files (all in the doc) but I guess your vote covers that.



---

archive/issue_comments_326548.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-28T02:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326548",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_326549.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-08-28T02:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326549",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_326550.json:
```json
{
    "body": "Ok, back into review. I removed the offending documentation file and removed references to `weave` in the other files in the numerical_sage section. Please do a proof read to make sure it makes sense.",
    "created_at": "2017-08-28T02:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326550",
    "user": "https://github.com/kiwifb"
}
```

Ok, back into review. I removed the offending documentation file and removed references to `weave` in the other files in the numerical_sage section. Please do a proof read to make sure it makes sense.



---

archive/issue_comments_326551.json:
```json
{
    "body": "Anyone for moving this back on track?",
    "created_at": "2017-08-31T05:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326551",
    "user": "https://github.com/kiwifb"
}
```

Anyone for moving this back on track?



---

archive/issue_comments_326552.json:
```json
{
    "body": "running the tests now",
    "created_at": "2017-08-31T15:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326552",
    "user": "https://github.com/videlec"
}
```

running the tests now



---

archive/issue_comments_326553.json:
```json
{
    "body": "pass!",
    "created_at": "2017-08-31T17:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326553",
    "user": "https://github.com/videlec"
}
```

pass!



---

archive/issue_comments_326554.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-31T17:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326554",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_326555.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-04T06:10:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326555",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_326556.json:
```json
{
    "body": "This update does not quite work on FreeBSD, as illustrated by the following ugly\ncrash in plain Sage python (as well as in Sage code that uses `Voronoi`, such as \n`RiemannSurface` one).\n\n\n```\n>>> import numpy as np\n>>> points = np.array([[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2],[2, 0], [2, 1], [2, 2]])\n>>> from scipy.spatial import Voronoi\n>>> Voronoi(points)\nSegmentation fault (core dumped)\n```\n\n\n\n```\nsage: R.<x,y>=QQ[] \nsage: C=Curve(x^3+3*y^3+5) \nsage: C.riemann_surface() \n...\nUnhandled SIGSEGV: A segmentation fault occurred.\n```\n",
    "created_at": "2017-10-13T17:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23357",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23357#issuecomment-326556",
    "user": "https://github.com/dimpase"
}
```

This update does not quite work on FreeBSD, as illustrated by the following ugly
crash in plain Sage python (as well as in Sage code that uses `Voronoi`, such as 
`RiemannSurface` one).


```
>>> import numpy as np
>>> points = np.array([[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2],[2, 0], [2, 1], [2, 2]])
>>> from scipy.spatial import Voronoi
>>> Voronoi(points)
Segmentation fault (core dumped)
```



```
sage: R.<x,y>=QQ[] 
sage: C=Curve(x^3+3*y^3+5) 
sage: C.riemann_surface() 
...
Unhandled SIGSEGV: A segmentation fault occurred.
```

