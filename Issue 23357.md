# Issue 23357: Upgrade scipy to 0.19.1

Issue created by migration from Trac.

Original creator: fbissey

Original creation time: 2017-08-07 23:54:39

Routine upgrade. I have enough of seeing various doctests failing in sage-on-gentoo when using this version.


---

Comment by fbissey created at 2017-08-08 01:54:08

Changing status from new to needs_review.


---

Comment by fbissey created at 2017-08-08 01:54:08

New commits:


---

Comment by vdelecroix created at 2017-08-09 17:05:25

Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?


---

Comment by fbissey created at 2017-08-09 21:36:15

Replying to [comment:4 vdelecroix]:
> Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?

I thought of that. At the moment I kept things consistent with other doctests giving the same results. So if using tolerance I think 
* we need to go back to the whole series of doctests not just the ones broken by this upgrade
* You can you only set one tolerance for one result so you need to align things not with `0.9999999` but with `0.999999` (one less `9`)

That being said there is already inconsistency in the number of decimals quoted for the results starting with `1.` compared to the one starting with `0.9`. Harmonizing all of this would probably be a good thing.

Would you support touching the other doctest giving similar results to the ones broken by the upgrade?


---

Comment by vdelecroix created at 2017-08-10 08:45:39

Replying to [comment:5 fbissey]:
> Replying to [comment:4 vdelecroix]:
> > Wouldn't it be better to set some numerical tolerance in `sage/numerical/optimize.py` instead of changing `1.0` into `0.9999999`?
>
> Would you support touching the other doctest giving similar results to the ones broken by the upgrade?
>

I will.


---

Comment by git created at 2017-08-20 23:25:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-08-20 23:28:07

Done! Note that I didn't convert this to use tolerance

```
    We get additional convergence information with the `verbose` option::

        sage: minimize(f, [.1, .3, .4], algorithm="ncg", verbose=True)
        Optimization terminated successfully.
        ...
        (0.9999999..., 0.999999..., 0.999999...)
```

because the verbose output message is already caught by `...` and you cannot mix that with `tol`. It just fails, you cannot use `...` and `tol` at the same time.


---

Comment by fbissey created at 2017-08-20 23:40:50

Something on this branch was meant for another completely unrelated one. I'll try to fix it before putting it back to review.


---

Comment by fbissey created at 2017-08-20 23:40:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-08-20 23:45:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-08-20 23:46:54

I am actually glad to have found that bit. I thought I had lost it.


---

Comment by fbissey created at 2017-08-20 23:46:54

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2017-08-21 17:48:46

Replying to [comment:7 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[cbe2690](https://git.sagemath.org/sage.git/commit/?id=cbe2690f4b4fa7bbb6cca1d263be5d90ea69f9e4)||`Use tolerance as much as possible in minimize`||
Could you do the same for the other numerical values you truncated with `...` or does it make no sense?


---

Comment by fbissey created at 2017-08-21 21:21:09

You mean in the other files? It can be done, but in that case I will only touch those particular tests. In optimize.py we had a whole family of tests that I kept coherent as much as possible - including the ones that weren't affected by the upgrade.


---

Comment by jpflori created at 2017-08-21 21:31:29

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2017-08-21 21:31:29

Nah, that's ok as it is.
LGTM.


---

Comment by vbraun created at 2017-08-25 23:12:24

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-08-25 23:12:24


```
**********************************************************************
File "src/doc/en/thematic_tutorials/numerical_sage/weave.rst", line 13, in doc.en.thematic_tutorials.numerical_sage.weave
Failed example:
    from scipy import weave
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest doc.en.thematic_tutorials.numerical_sage.weave[0]>", line 1, in <module>
        from scipy import weave
    ImportError: cannot import name weave
**********************************************************************
File "src/doc/en/thematic_tutorials/numerical_sage/weave.rst", line 15, in doc.en.thematic_tutorials.numerical_sage.weave
Failed example:
    from scipy.weave import converters
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest doc.en.thematic_tutorials.numerical_sage.weave[1]>", line 1, in <module>
        from scipy.weave import converters
    ImportError: No module named weave
**********************************************************************
1 item had failures:
   2 of   3 in doc.en.thematic_tutorials.numerical_sage.weave
    [2 tests, 2 failures, 0.21 s]
----------------------------------------------------------------------
sage -t --long src/doc/en/thematic_tutorials/numerical_sage/weave.rst  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by fbissey created at 2017-08-26 05:58:38

Not sure how it escaped me yet. Or the _reviewers_. After digging upstream, `weave` has been deprecated for some time. The plan has been to remove it before `1.0` (whenever that happens) for a while. It was also the only module not to have a python 3 version. Now it's gone (I think 0.18.x was the latest version to include it).

In that light, I plan to surgically remove all instances of `weave` in sage, which apparently doesn't extend further than the documentation. Opinions?


---

Comment by chapoton created at 2017-08-26 13:49:18

I vote for: just remove completely the offending file

src/doc/en/thematic_tutorials/numerical_sage/weave.rst


---

Comment by fbissey created at 2017-08-26 20:02:58

There are a few extra references in other files (all in the doc) but I guess your vote covers that.


---

Comment by git created at 2017-08-28 02:30:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2017-08-28 02:33:27

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2017-08-28 02:33:27

Ok, back into review. I removed the offending documentation file and removed references to `weave` in the other files in the numerical_sage section. Please do a proof read to make sure it makes sense.


---

Comment by fbissey created at 2017-08-31 05:40:59

Anyone for moving this back on track?


---

Comment by vdelecroix created at 2017-08-31 15:46:42

running the tests now


---

Comment by vdelecroix created at 2017-08-31 17:27:49

pass!


---

Comment by vdelecroix created at 2017-08-31 17:27:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-04 06:10:46

Resolution: fixed


---

Comment by dimpase created at 2017-10-13 17:34:15

This update does not quite work on FreeBSD, as illustrated by the following ugly
crash in plain Sage python (as well as in Sage code that uses `Voronoi`, such as 
`RiemannSurface` one).


```
>>> import numpy as np
>>> points = np.array([[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2],[2, 0], [2, 1], [2, 2]])
>>> from scipy.spatial import Voronoi
>>> Voronoi(points)
Segmentation fault (core dumped)
```



```
sage: R.<x,y>=QQ[] 
sage: C=Curve(x^3+3*y^3+5) 
sage: C.riemann_surface() 
...
Unhandled SIGSEGV: A segmentation fault occurred.
```

