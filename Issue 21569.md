# Issue 21569: Allow multiple instances of the PariInstance object

Issue created by migration from https://trac.sagemath.org/ticket/21806

Original creator: jdemeyer

Original creation time: 2016-11-03 14:13:28

CC:  defeo

Since the `PariInstance` object is really just a callable namespace without state, it should be possible to create multiple instances of it.

When `PariInstance.__init__()` is called a second time with a `size` argument which is larger than the current size, we should increase (but never decrease) the PARI stack size but otherwise do nothing.


---

Comment by defeo created at 2017-01-10 10:25:41

Changing status from new to needs_review.


---

Comment by defeo created at 2017-01-10 10:25:41

New commits:


---

Comment by defeo created at 2017-01-10 10:29:23

Changing keywords from "" to "atelierpari2017".


---

Comment by vdelecroix created at 2017-01-10 13:52:51

I don't understand clearly why we should allow multiple pari instances. Could it be precised in the ticket description? (we discussed it yesterday but I don't quite remember)


---

Comment by vdelecroix created at 2017-01-10 13:53:05

minor remark: there are trailing whitespaces!


---

Comment by vdelecroix created at 2017-01-10 13:53:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-01-10 14:05:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2017-01-10 14:14:03

Note that an alternate, reasonable, design would initialize the PARI library at module load, rather than in `__init__`. However this ticket is not concerned with this.

With the current design, we have the (dubious) advantage of being able to call `pari_close()` (via `PariInstance._close()`, and then reinitialize PARI by creating a new `PariInstance` object at leisure.


---

Comment by defeo created at 2017-01-10 14:14:03

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-01-10 14:23:20

pari *is* initialized at module load since a global `pari_instance` is created! Calling `_close` is dangerous since this global instance is still accessible... we might want to document this bug-feature


---

Comment by jdemeyer created at 2017-01-10 15:09:12

Replying to [comment:11 vdelecroix]:
> pari *is* initialized at module load since a global `pari_instance` is created!

But that will change. `cypari2` should not do that.
----
New commits:


---

Comment by git created at 2017-01-10 15:13:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-01-10 15:14:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-01-10 15:16:25

New version, needs review...


---

Comment by defeo created at 2017-01-10 17:28:28

All doctests pass, and I like Jeroens modifications.
----
New commits:


---

Comment by vdelecroix created at 2017-01-11 08:36:31

What should I expect from

```
sage: from sage.libs.cypari2.pari_instance import PariInstance
sage: p = PariInstance()
sage: p._close()
sage: p('12')
```



---

Comment by jdemeyer created at 2017-01-11 08:45:01

Replying to [comment:19 vdelecroix]:
> What should I expect from
> {{{
> sage: from sage.libs.cypari2.pari_instance import PariInstance
> sage: p = PariInstance()
> sage: p._close()
> sage: p('12')
> }}}

A segmentation fault I guess.


---

Comment by vdelecroix created at 2017-01-11 08:50:55

Replying to [comment:20 jdemeyer]:
> Replying to [comment:19 vdelecroix]:
> > What should I expect from
> > {{{
> > sage: from sage.libs.cypari2.pari_instance import PariInstance
> > sage: p = PariInstance()
> > sage: p._close()
> > sage: p('12')
> > }}}
> 
> A segmentation fault I guess.

Shouldn't it be documented as I mentioned in [comment:11]?


---

Comment by jdemeyer created at 2017-01-11 08:54:51

There is already the comment

```
            Call this method at you own risk if you really need to free
            the memory used by PARI.
```



---

Comment by vdelecroix created at 2017-01-11 09:50:46

Replying to [comment:22 jdemeyer]:
> There is already the comment
> {{{
>             Call this method at you own risk if you really need to free
>             the memory used by PARI.
> }}}

This comment is not clear enough. The sentence says that the memory is freed. Not that you will obtain a `SEGFAULT` if you try to use pari again. Moreover, creating a new pari instance would make pari available again (right?).


---

Comment by vdelecroix created at 2017-01-11 15:52:42

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-01-11 15:52:42

New commits:


---

Comment by vbraun created at 2017-01-18 20:39:27

Resolution: fixed
