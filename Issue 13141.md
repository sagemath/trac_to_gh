# Issue 13141: gcc error while installing optionnal package pyzmq-2.1.11.p0

archive/issues_013141.json:
```json
{
    "body": "Assignee: tbd\n\nAs reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq (#12843) on OSX 10.5.8 :\n\n\n```\ngcc version 4.6.3 (GCC)\n****************************************************\nrunning configure\n******************************************\nConfigure: Autodetecting ZMQ settings...\n    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local\ngcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o\ngcc: erreur: i386: No such file or directory\ngcc: erreur: unrecognized option \u2018-arch\u2019\nFatal:\n    Failed to compile ZMQ test program.  Please check to make sure:\n\n    * You have a C compiler installed\n    * A development version of Python is installed (including header files)\n    * A development version of ZMQ >= 2.1.4 is installed (including header files)\n    * If ZMQ is not in a default location, supply the argument --zmq=<path>\n    * If you did recently install ZMQ to a default location,\n      try rebuilding the ld cache with `sudo ldconfig`\n      or specify zmq's location with `--zmq=/usr/local`\n   \nerror: command 'gcc' failed with exit status 1\n******************************************\n```\n\n\nThe following patch seems to fix the problem :\n\n\n```diff\npyzmq-2.1.11.p1/patches $ cat buildutils.patch\n--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500\n+++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400\n@@ -111,13 +111,7 @@\n    \n     cpreargs = lpreargs = None\n     if sys.platform == 'darwin':\n-        # use appropriate arch for comiler\n-        if platform.architecture()[0]=='32bit':\n-            cpreargs = ['-arch','i386']\n-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']\n-        else:\n-            # allow for missing UB arch, since it will still work:\n-            lpreargs = ['-undefined', 'dynamic_lookup']\n+        lpreargs = ['-undefined', 'dynamic_lookup']\n \n     objs = cc.compile([cfile],extra_preargs=cpreargs)\n     cc.link_executable(objs, efile, extra_preargs=lpreargs)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13313\n\n",
    "created_at": "2012-07-31T15:42:45Z",
    "labels": [
        "packages",
        "major",
        "bug"
    ],
    "title": "gcc error while installing optionnal package pyzmq-2.1.11.p0",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13141",
    "user": "slabbe"
}
```
Assignee: tbd

As reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq (#12843) on OSX 10.5.8 :


```
gcc version 4.6.3 (GCC)
****************************************************
running configure
******************************************
Configure: Autodetecting ZMQ settings...
    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local
gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
gcc: erreur: i386: No such file or directory
gcc: erreur: unrecognized option ‘-arch’
Fatal:
    Failed to compile ZMQ test program.  Please check to make sure:

    * You have a C compiler installed
    * A development version of Python is installed (including header files)
    * A development version of ZMQ >= 2.1.4 is installed (including header files)
    * If ZMQ is not in a default location, supply the argument --zmq=<path>
    * If you did recently install ZMQ to a default location,
      try rebuilding the ld cache with `sudo ldconfig`
      or specify zmq's location with `--zmq=/usr/local`
   
error: command 'gcc' failed with exit status 1
******************************************
```


The following patch seems to fix the problem :


```diff
pyzmq-2.1.11.p1/patches $ cat buildutils.patch
--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500
+++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400
@@ -111,13 +111,7 @@
    
     cpreargs = lpreargs = None
     if sys.platform == 'darwin':
-        # use appropriate arch for comiler
-        if platform.architecture()[0]=='32bit':
-            cpreargs = ['-arch','i386']
-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']
-        else:
-            # allow for missing UB arch, since it will still work:
-            lpreargs = ['-undefined', 'dynamic_lookup']
+        lpreargs = ['-undefined', 'dynamic_lookup']
 
     objs = cc.compile([cfile],extra_preargs=cpreargs)
     cc.link_executable(objs, efile, extra_preargs=lpreargs)
```


Issue created by migration from https://trac.sagemath.org/ticket/13313





---

archive/issue_comments_160050.json:
```json
{
    "body": "Could you create a proper patch and upload it as an attachment?",
    "created_at": "2012-07-31T16:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160050",
    "user": "dimpase"
}
```

Could you create a proper patch and upload it as an attachment?



---

archive/issue_comments_160051.json:
```json
{
    "body": "Changing component from packages to optional packages.",
    "created_at": "2012-07-31T16:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160051",
    "user": "dimpase"
}
```

Changing component from packages to optional packages.



---

archive/issue_comments_160052.json:
```json
{
    "body": "Attachment [buildutils.patch](tarball://root/attachments/some-uuid/ticket13313/buildutils.patch) by slabbe created at 2012-07-31 16:48:54\n\nThe patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.\n\nS\u00e9bastien",
    "created_at": "2012-07-31T16:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160052",
    "user": "slabbe"
}
```

Attachment [buildutils.patch](tarball://root/attachments/some-uuid/ticket13313/buildutils.patch) by slabbe created at 2012-07-31 16:48:54

The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.

Sébastien



---

archive/issue_comments_160053.json:
```json
{
    "body": "Replying to [comment:2 slabbe]:\n> The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.\n> \n\nin a nutshell: \n\n* rename the package directory pyzmq-2.1.11.p2\n* put the patch in pyzmq-2.1.11.p2/patches\n* adjust spkg-install so that this patch is applied (assuming your patch is not a change to Sage's patches to the upstream, but a change of the upstream)\n* create pyzmq-2.1.11.p2.spkg by running sage -spkg pyzmq-2.1.11.p2/ in the corresponding directory i.e. `SAGEROOT/spkg/optional`\n* test it.\n* upload it somewhere and put a link to it into the ticket description.\n* mark the ticket as needing review\n\n(I know, sounds like a lot of work :-))",
    "created_at": "2012-07-31T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160053",
    "user": "dimpase"
}
```

Replying to [comment:2 slabbe]:
> The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.
> 

in a nutshell: 

* rename the package directory pyzmq-2.1.11.p2
* put the patch in pyzmq-2.1.11.p2/patches
* adjust spkg-install so that this patch is applied (assuming your patch is not a change to Sage's patches to the upstream, but a change of the upstream)
* create pyzmq-2.1.11.p2.spkg by running sage -spkg pyzmq-2.1.11.p2/ in the corresponding directory i.e. `SAGEROOT/spkg/optional`
* test it.
* upload it somewhere and put a link to it into the ticket description.
* mark the ticket as needing review

(I know, sounds like a lot of work :-))



---

archive/issue_comments_160054.json:
```json
{
    "body": "Ok thanks for the cheering. I also read [Patching a spkg](http://www.sagemath.org/doc/developer/patching_spkgs.html/) in the Developper Guide. Here is my first patch to a package (p0 was the most recent version) :\n\nhttp://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg\n\nNeeds review!",
    "created_at": "2012-07-31T18:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160054",
    "user": "slabbe"
}
```

Ok thanks for the cheering. I also read [Patching a spkg](http://www.sagemath.org/doc/developer/patching_spkgs.html/) in the Developper Guide. Here is my first patch to a package (p0 was the most recent version) :

http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg

Needs review!



---

archive/issue_comments_160055.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-31T18:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160055",
    "user": "slabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_160056.json:
```json
{
    "body": "Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. \n\nThe patch looks good to me, fwiw.",
    "created_at": "2012-07-31T18:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160056",
    "user": "vbraun"
}
```

Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. 

The patch looks good to me, fwiw.



---

archive/issue_comments_160057.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. \n\nHi Volker,\n\nwell, it was a (brain)dead response by me, the code is alive. \nLater I was able to reproduce the bug on another installation.",
    "created_at": "2012-08-01T00:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160057",
    "user": "dimpase"
}
```

Replying to [comment:6 vbraun]:
> Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. 

Hi Volker,

well, it was a (brain)dead response by me, the code is alive. 
Later I was able to reproduce the bug on another installation.



---

archive/issue_comments_160058.json:
```json
{
    "body": "The patch worked for me.",
    "created_at": "2012-08-02T14:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160058",
    "user": "jtremblay"
}
```

The patch worked for me.



---

archive/issue_comments_160059.json:
```json
{
    "body": "Replying to [comment:8 jtremblay]:\n> The patch worked for me.\n\nThe patch or the spkg ? On which machine ?",
    "created_at": "2012-08-02T18:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160059",
    "user": "slabbe"
}
```

Replying to [comment:8 jtremblay]:
> The patch worked for me.

The patch or the spkg ? On which machine ?



---

archive/issue_comments_160060.json:
```json
{
    "body": "The spkg, on OSX 10.7.3 with Sage 5.2 binaries.",
    "created_at": "2012-08-02T18:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160060",
    "user": "jtremblay"
}
```

The spkg, on OSX 10.7.3 with Sage 5.2 binaries.



---

archive/issue_comments_160061.json:
```json
{
    "body": "Replying to [comment:10 jtremblay]:\n> The spkg, on OSX 10.7.3 with Sage 5.2 binaries.\n\nAnd were you obtaining the same problem as me while installing pyzmq-2.1.11.p0.spkg ?",
    "created_at": "2012-08-02T18:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160061",
    "user": "slabbe"
}
```

Replying to [comment:10 jtremblay]:
> The spkg, on OSX 10.7.3 with Sage 5.2 binaries.

And were you obtaining the same problem as me while installing pyzmq-2.1.11.p0.spkg ?



---

archive/issue_comments_160062.json:
```json
{
    "body": "Apparently not, zmq was not installed when I tried installing pyzmq :\n\n\n```\nExtracting package /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg\n-rw-r--r--  1 tremblayj  wheel  464755  2 Aug 10:02 /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg\nFinished extraction\n****************************************************\nHost system:\nDarwin jerometremblayportable.local 11.4.0 Darwin Kernel Version 11.4.0: Mon Apr  9 19:32:15 PDT 2012; root:xnu-1699.26.8~1/RELEASE_X86_64 x86_64\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/Library/sage/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper\nTarget: x86_64-apple-darwin10.8.0\nConfigured with: ../src/configure --prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-local-prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-gmp=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpfr=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpc=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-system-zlib --disable-multilib  \nThread model: posix\ngcc version 4.6.3 (GCC) \n****************************************************\nrunning configure\n******************************************\nConfigure: Autodetecting ZMQ settings...\n    Custom ZMQ dir:       /Library/sage/local\ngcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -I/Library/sage/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o\ndetect/vers.c:3:17: fatal error: zmq.h: No such file or directory\ncompilation terminated.\nFatal: \n    Failed to compile ZMQ test program.  Please check to make sure:\n\n    * You have a C compiler installed\n    * A development version of Python is installed (including header files)\n    * A development version of ZMQ >= 2.1.4 is installed (including header files)\n    * If ZMQ is not in a default location, supply the argument --zmq=<path>\n    * If you did recently install ZMQ to a default location, \n      try rebuilding the ld cache with `sudo ldconfig`\n      or specify zmq's location with `--zmq=/usr/local`\n    \nerror: command 'gcc' failed with exit status 1\n\n```\n",
    "created_at": "2012-08-02T19:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160062",
    "user": "jtremblay"
}
```

Apparently not, zmq was not installed when I tried installing pyzmq :


```
Extracting package /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg
-rw-r--r--  1 tremblayj  wheel  464755  2 Aug 10:02 /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg
Finished extraction
****************************************************
Host system:
Darwin jerometremblayportable.local 11.4.0 Darwin Kernel Version 11.4.0: Mon Apr  9 19:32:15 PDT 2012; root:xnu-1699.26.8~1/RELEASE_X86_64 x86_64
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/Library/sage/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper
Target: x86_64-apple-darwin10.8.0
Configured with: ../src/configure --prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-local-prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-gmp=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpfr=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpc=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-system-zlib --disable-multilib  
Thread model: posix
gcc version 4.6.3 (GCC) 
****************************************************
running configure
******************************************
Configure: Autodetecting ZMQ settings...
    Custom ZMQ dir:       /Library/sage/local
gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -I/Library/sage/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
detect/vers.c:3:17: fatal error: zmq.h: No such file or directory
compilation terminated.
Fatal: 
    Failed to compile ZMQ test program.  Please check to make sure:

    * You have a C compiler installed
    * A development version of Python is installed (including header files)
    * A development version of ZMQ >= 2.1.4 is installed (including header files)
    * If ZMQ is not in a default location, supply the argument --zmq=<path>
    * If you did recently install ZMQ to a default location, 
      try rebuilding the ld cache with `sudo ldconfig`
      or specify zmq's location with `--zmq=/usr/local`
    
error: command 'gcc' failed with exit status 1

```




---

archive/issue_comments_160063.json:
```json
{
    "body": "Replying to [comment:12 jtremblay]:\n> Apparently not, zmq was not installed when I tried installing pyzmq :\n\nYes, but this was not my question: zeromq needs to be installed before pyzmq.\n\nTo summarize: \n\n- The `pyzmq-2.1.11.p0.spkg` is broken on OSX 10.5.8.\n- The `pyzmq-2.1.11.p1.spkg` fixes the bug at least for OSX 10.5.8. \n- The `pyzmq-2.1.11.p1.spkg` also work on OSX 10.7.3.\n- And we do not know if `pyzmq-2.1.11.p0.spkg` was broken on OSX 10.7.3 also (which was my previous question).\n\n#12719 will be merged soon, so it would be nice if this ticket could be reviewed, no?",
    "created_at": "2013-01-25T10:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160063",
    "user": "slabbe"
}
```

Replying to [comment:12 jtremblay]:
> Apparently not, zmq was not installed when I tried installing pyzmq :

Yes, but this was not my question: zeromq needs to be installed before pyzmq.

To summarize: 

- The `pyzmq-2.1.11.p0.spkg` is broken on OSX 10.5.8.
- The `pyzmq-2.1.11.p1.spkg` fixes the bug at least for OSX 10.5.8. 
- The `pyzmq-2.1.11.p1.spkg` also work on OSX 10.7.3.
- And we do not know if `pyzmq-2.1.11.p0.spkg` was broken on OSX 10.7.3 also (which was my previous question).

#12719 will be merged soon, so it would be nice if this ticket could be reviewed, no?



---

archive/issue_comments_160064.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-25T11:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160064",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_160065.json:
```json
{
    "body": "Looks good to me.",
    "created_at": "2013-01-25T11:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160065",
    "user": "vbraun"
}
```

Looks good to me.



---

archive/issue_comments_160066.json:
```json
{
    "body": "spkg is on its way to the servers!",
    "created_at": "2013-01-25T13:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160066",
    "user": "schilly"
}
```

spkg is on its way to the servers!



---

archive/issue_comments_160067.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-26T10:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13141",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13141#issuecomment-160067",
    "user": "jdemeyer"
}
```

Resolution: fixed
