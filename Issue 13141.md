# Issue 13141: gcc error while installing optionnal package pyzmq-2.1.11.p0

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2012-07-31 15:42:45

Assignee: tbd

As reported on sage-devel [here](https://groups.google.com/forum/?fromgroups#!topic/sage-devel/CuZNKclprIQ), there is an error when installing the optional package pyzmq (#12843) on OSX 10.5.8 :


```
gcc version 4.6.3 (GCC)
****************************************************
running configure
******************************************
Configure: Autodetecting ZMQ settings...
    Custom ZMQ dir:       /Users/slabbe/Applications/sage-5.2.rc0/local
gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch i386 -I/Users/slabbe/Applications/sage-5.2.rc0/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
gcc: erreur: i386: No such file or directory
gcc: erreur: unrecognized option ‘-arch’
Fatal:
    Failed to compile ZMQ test program.  Please check to make sure:

    * You have a C compiler installed
    * A development version of Python is installed (including header files)
    * A development version of ZMQ >= 2.1.4 is installed (including header files)
    * If ZMQ is not in a default location, supply the argument --zmq=<path>
    * If you did recently install ZMQ to a default location,
      try rebuilding the ld cache with `sudo ldconfig`
      or specify zmq's location with `--zmq=/usr/local`
   
error: command 'gcc' failed with exit status 1
******************************************
```


The following patch seems to fix the problem :


```diff
pyzmq-2.1.11.p1/patches $ cat buildutils.patch
--- src/buildutils.py    2011-12-19 04:21:14.000000000 -0500
+++ src-patched/buildutils.py    2012-07-27 12:01:07.000000000 -0400
`@``@` -111,13 +111,7 `@``@`
    
     cpreargs = lpreargs = None
     if sys.platform == 'darwin':
-        # use appropriate arch for comiler
-        if platform.architecture()[0]=='32bit':
-            cpreargs = ['-arch','i386']
-            lpreargs = ['-arch', 'i386', '-undefined', 'dynamic_lookup']
-        else:
-            # allow for missing UB arch, since it will still work:
-            lpreargs = ['-undefined', 'dynamic_lookup']
+        lpreargs = ['-undefined', 'dynamic_lookup']
 
     objs = cc.compile([cfile],extra_preargs=cpreargs)
     cc.link_executable(objs, efile, extra_preargs=lpreargs)
```



---

Comment by dimpase created at 2012-07-31 16:23:12

Could you create a proper patch and upload it as an attachment?


---

Comment by dimpase created at 2012-07-31 16:23:12

Changing component from packages to optional packages.


---

Attachment

The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.

Sébastien


---

Comment by dimpase created at 2012-07-31 17:00:47

Replying to [comment:2 slabbe]:
> The patch I just attached should go in `pyzmq-2.1.11.p?/patches`. I never patch/created a package before. If I am doing something wrong, just tell me.
> 

in a nutshell: 

* rename the package directory pyzmq-2.1.11.p2
* put the patch in pyzmq-2.1.11.p2/patches
* adjust spkg-install so that this patch is applied (assuming your patch is not a change to Sage's patches to the upstream, but a change of the upstream)
* create pyzmq-2.1.11.p2.spkg by running sage -spkg pyzmq-2.1.11.p2/ in the corresponding directory i.e. `SAGEROOT/spkg/optional`
* test it.
* upload it somewhere and put a link to it into the ticket description.
* mark the ticket as needing review

(I know, sounds like a lot of work :-))


---

Comment by slabbe created at 2012-07-31 18:11:24

Ok thanks for the cheering. I also read [Patching a spkg](http://www.sagemath.org/doc/developer/patching_spkgs.html/) in the Developper Guide. Here is my first patch to a package (p0 was the most recent version) :

http://sage.math.washington.edu/home/slabbe/pyzmq-2.1.11.p1.spkg

Needs review!


---

Comment by slabbe created at 2012-07-31 18:11:45

Changing status from new to needs_review.


---

Comment by vbraun created at 2012-07-31 18:57:05

Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. 

The patch looks good to me, fwiw.


---

Comment by dimpase created at 2012-08-01 00:41:46

Replying to [comment:6 vbraun]:
> Dima, you reported on the mailinglist that installing pyzmq works if you install zmq first. Can you clarify on that? zmq is a requirement, you can't build pyzmq without. I just want tbo be clear that we aren't patching dead code here. 

Hi Volker,

well, it was a (brain)dead response by me, the code is alive. 
Later I was able to reproduce the bug on another installation.


---

Comment by jtremblay created at 2012-08-02 14:12:28

The patch worked for me.


---

Comment by slabbe created at 2012-08-02 18:00:36

Replying to [comment:8 jtremblay]:
> The patch worked for me.

The patch or the spkg ? On which machine ?


---

Comment by jtremblay created at 2012-08-02 18:02:25

The spkg, on OSX 10.7.3 with Sage 5.2 binaries.


---

Comment by slabbe created at 2012-08-02 18:04:53

Replying to [comment:10 jtremblay]:
> The spkg, on OSX 10.7.3 with Sage 5.2 binaries.

And were you obtaining the same problem as me while installing pyzmq-2.1.11.p0.spkg ?


---

Comment by jtremblay created at 2012-08-02 19:03:41

Apparently not, zmq was not installed when I tried installing pyzmq :


```
Extracting package /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg
-rw-r--r--  1 tremblayj  wheel  464755  2 Aug 10:02 /Library/sage/spkg/optional/pyzmq-2.1.11.p0.spkg
Finished extraction
****************************************************
Host system:
Darwin jerometremblayportable.local 11.4.0 Darwin Kernel Version 11.4.0: Mon Apr  9 19:32:15 PDT 2012; root:xnu-1699.26.8~1/RELEASE_X86_64 x86_64
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/Library/sage/local/bin/../libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper
Target: x86_64-apple-darwin10.8.0
Configured with: ../src/configure --prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-local-prefix=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-gmp=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpfr=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-mpc=/Users/buildbot/build/sage/bsd-1/bsd_64_binary/build/sage-5.2/local --with-system-zlib --disable-multilib  
Thread model: posix
gcc version 4.6.3 (GCC) 
****************************************************
running configure
******************************************
Configure: Autodetecting ZMQ settings...
    Custom ZMQ dir:       /Library/sage/local
gcc -fno-strict-aliasing -fwrapv -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -I/Library/sage/local/include -Izmq/utils -Izmq/core -Izmq/devices -c detect/vers.c -o detect/vers.o
detect/vers.c:3:17: fatal error: zmq.h: No such file or directory
compilation terminated.
Fatal: 
    Failed to compile ZMQ test program.  Please check to make sure:

    * You have a C compiler installed
    * A development version of Python is installed (including header files)
    * A development version of ZMQ >= 2.1.4 is installed (including header files)
    * If ZMQ is not in a default location, supply the argument --zmq=<path>
    * If you did recently install ZMQ to a default location, 
      try rebuilding the ld cache with `sudo ldconfig`
      or specify zmq's location with `--zmq=/usr/local`
    
error: command 'gcc' failed with exit status 1

```



---

Comment by slabbe created at 2013-01-25 10:40:06

Replying to [comment:12 jtremblay]:
> Apparently not, zmq was not installed when I tried installing pyzmq :

Yes, but this was not my question: zeromq needs to be installed before pyzmq.

To summarize: 

 - The `pyzmq-2.1.11.p0.spkg` is broken on OSX 10.5.8.
 - The `pyzmq-2.1.11.p1.spkg` fixes the bug at least for OSX 10.5.8. 
 - The `pyzmq-2.1.11.p1.spkg` also work on OSX 10.7.3.
 - And we do not know if `pyzmq-2.1.11.p0.spkg` was broken on OSX 10.7.3 also (which was my previous question).

#12719 will be merged soon, so it would be nice if this ticket could be reviewed, no?


---

Comment by vbraun created at 2013-01-25 11:38:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-25 11:38:52

Looks good to me.


---

Comment by schilly created at 2013-01-25 13:32:43

spkg is on its way to the servers!


---

Comment by jdemeyer created at 2013-01-26 10:03:59

Resolution: fixed
