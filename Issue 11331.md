# Issue 11331: Make new spkg to install Jmol in SAGE_LOCAL/share

Issue created by migration from https://trac.sagemath.org/ticket/11503

Original creator: gutow

Original creation time: 2011-06-16 15:55:59

Assignee: jason, mpatel, was

CC:  rado fbissey strogdon

Keywords: sd31,Jmol, flask

In an effort to remove Jmol from the notebook in the Flask notebook it is being moved to SAGE_LOCAL/share. This is based on the logic that the notebook can run without Jmol, but Sage cannot run without either the notebook or Jmol even when using just the command line.

To achieve this relocation of Jmol:

 1. install this .spkg


```
./sage -f "http://www.uwosh.edu/faculty_staff/gutow/Jmol_for_SageNoteBook-1.1.7.spkg
```

 2. Some patches are necessary to notebook paths and the plot3d code (coming...)


---

Comment by gutow created at 2011-06-16 15:56:51

Changing assignee from jason, mpatel, was to gutow.


---

Attachment

path fix for flask


---

Comment by gutow created at 2011-06-16 16:37:19

plot3d command line fix


---

Attachment


---

Comment by gutow created at 2011-06-17 18:14:22

spkg refactored to better meet Sage standards and remove dead code from spkg-install.


---

Comment by gutow created at 2011-06-25 18:31:40

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-07-17 02:57:02

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2011-07-17 02:57:02

Several comments: 

 - There are some backup files present: SPKG.txt~ and spkg-install~.  
 - As I noted on #11496, you should copy the jmol shell script to SAGE_LOCAL/bin as part of spkg-install.
 - It would be helpful if you could prepare the mercurial repository with the version of hg installed with Sage.  When I use the version included with Sage (which is the only version on my computer), I get

```
$ hg status
abort: requirement 'dotencode' not supported!
```

 so I can't check the state of the repo without installing a new version of hg.


---

Comment by gutow created at 2011-07-17 14:56:24

* Hmm...didn't notice the backup files.  I'll look into that...
 * I could add the Jmol script to the jmol .spkg.  The one that is in there is the generic install not the one for SAGE...It seems reasonable that it should not be tracked by SAGE...I will add the SAGE version as a patch to the .spkg.  Once I get this done, I believe #11496 should be closed, as it will no longer apply...let me know who to notify about that.
 * Not sure if I can manage to successfully backtrack on the Hg repository format.  In order to work with the flask-notebook on my machine, I found I needed a system install of Hg and I got the latest.  Is this going to be a hold up?  Hg has been a real pain compared to the other version control systems I've  used.  Can somebody point out how to do the backtrack cleanly and quickly.  If it takes me a couple of hours to untangle Hg that's more time than it will take me to fix the rest of the .spkg problems and more time than I have for this project at the moment.



Replying to [comment:8 jhpalmieri]:

> Several comments:  - There are some backup files present: SPKG.txt~ and spkg-install~.   - As I noted on #11496, you should copy the jmol shell script to SAGE_LOCAL/bin as part of spkg-install. - It would be helpful if you could prepare the mercurial repository with the version of hg installed with Sage.  When I use the version included with Sage (which is the only version on my computer), I get ` $ hg status abort: requirement 'dotencode' not supported! ` so I can't check the state of the repo without installing a new version of hg.


---

Comment by gutow created at 2011-07-18 20:41:34

.p2 addresses the following: * reverted to mercurial version included in Sage (lost all the history in the process).
 * jmol launch script is now included in the patches and copied to SAGE_LOCAL/bin.
 * I think I removed all the backup files.


---

Comment by gutow created at 2011-07-18 20:41:34

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-07-19 17:45:18

I upgraded my version of mercurial so I can look at the repo, and I hope that the version included with Sage will be upgraded soon, too (see #10594).  Oh, and now I see that I can open this repo with the old version.  Anyway, there are some uncommitted files:

```
$ hg status
? patches/Jmol.js.patch
? patches/jmol.patch
```

(So you should run "hg add" and then commit again.)

The file spkg-install needs some work.  In particular, any variable which refers to a path should be quoted, in case there are spaces in it.  (Right now, we don't support having spaces in the path where Sage is, but when it's easy to allow, we should.)  I think this should do it:

```diff

diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -27,12 +27,12 @@ if [ $? -ne 0 ]; then
 fi
 
 # Check for sagenb location
-cd $SAGE_ROOT"/devel/sagenb/sagenb/data/jmol"
+cd "$SAGE_ROOT/devel/sagenb/sagenb/data/jmol"
 if [ $? -ne 0 ]; then
     echo "No old Jmol install in notebook. Skipping removal of Jmol from notebook."
 else
     echo "Removing Jmol files from the notebook data directory..."
-    rm -r $SAGE_ROOT"/devel/sagenb/sagenb/data/jmol"
+    rm -r "$SAGE_ROOT/devel/sagenb/sagenb/data/jmol"
 fi
 
 TEMPDIR=$SPKDIR"/src"
@@ -47,15 +47,15 @@ if [ $? -ne 0 ]; then
    echo "Directory "$SAGE_LOCAL"/share/jmol does not exist.  Creating Directory..."
 else
     echo "Deleting all files from "$SAGE_LOCAL"/share/jmol..."
-    rm -r $SAGE_LOCAL"/share/jmol"
+    rm -r "$SAGE_LOCAL/share/jmol"
     echo "replacing jmol directory and contents..."
 fi
 
-mkdir $SAGE_LOCAL"/share/jmol"
+mkdir "$SAGE_LOCAL/share/jmol"
 
 TEMPDIR=$SPKDIR"/src/jmol"
 cd "$TEMPDIR"
-cp -r * $SAGE_LOCAL"/share/jmol/"
+cp -r * "$SAGE_LOCAL/share/jmol/"
 
 cd $SAGE_LOCAL"/bin"
 if [ $? -ne 0 ]; then
@@ -64,12 +64,12 @@ if [ $? -ne 0 ]; then
 else
     echo "Copying jmol script to "$SAGE_LOCAL"/bin."
     cd "$TEMPDIR"
-    cp -f jmol $SAGE_LOCAL"/bin"
+    cp -f jmol "$SAGE_LOCAL/bin"
 fi
 
 echo "Installing applet web directory"
-mkdir $SAGE_LOCAL"/share/jmol/appletweb"
-cp Jmol.js $SAGE_LOCAL"/share/jmol/appletweb"
+mkdir "$SAGE_LOCAL/share/jmol/appletweb"
+cp Jmol.js "$SAGE_LOCAL/share/jmol/appletweb"
 
 TEMPDIR=$SPKDIR"/patches/appletweb"
 cd "$TEMPDIR"
@@ -77,7 +77,7 @@ if [ $? -ne 0 ]; then
    echo "Error finding patches/appletweb directory. Exiting."
    exit 1
 fi
-cp -r * $SAGE_LOCAL"/share/jmol/appletweb"
+cp -r * "$SAGE_LOCAL/share/jmol/appletweb"
 
 if [ $? -ne 0 ]; then
    echo "Error installing PACKAGE_NAME."
```



---

Comment by jhpalmieri created at 2011-07-19 17:45:18

Changing status from needs_review to needs_work.


---

Comment by gutow created at 2011-07-19 19:48:03

Changing status from needs_work to needs_review.


---

Comment by gutow created at 2011-07-19 19:48:03

The below is done.  Try downloading the spkg again after 3 PM CDT.

Replying to [comment:12 jhpalmieri]:

> I upgraded my version of mercurial so I can look at the repo, and I hope that the version included with Sage will be upgraded soon, too (see #10594).  Oh, and now I see that I can open this repo with the old version.  Anyway, there are some uncommitted files: ` $ hg status ? patches/Jmol.js.patch ? patches/jmol.patch ` (So you should run "hg add" and then commit again.) The file spkg-install needs some work.  In particular, any variable which refers to a path should be quoted, in case there are spaces in it.  (Right now, we don't support having spaces in the path where Sage is, but when it's easy to allow, we should.)  I think this should do it: ` #!diff diff --git a/spkg-install b/spkg-install --- a/spkg-install +++ b/spkg-install `@``@` -27,12 +27,12 `@``@` if [ $? -ne 0 ]; then fi # Check for sagenb location -cd $SAGE_ROOT"/devel/sagenb/sagenb/data/jmol" +cd "$SAGE_ROOT/devel/sagenb/sagenb/data/jmol" if [ $? -ne 0 ]; then echo "No old Jmol install in notebook. Skipping removal of Jmol from notebook." else echo "Removing Jmol files from the notebook data directory..." -    rm -r $SAGE_ROOT"/devel/sagenb/sagenb/data/jmol" +    rm -r "$SAGE_ROOT/devel/sagenb/sagenb/data/jmol" fi TEMPDIR=$SPKDIR"/src" `@``@` -47,15 +47,15 `@``@` if [ $? -ne 0 ]; then echo "Directory "$SAGE_LOCAL"/share/jmol does not exist.  Creating Directory..." else echo "Deleting all files from "$SAGE_LOCAL"/share/jmol..." -    rm -r $SAGE_LOCAL"/share/jmol" +    rm -r "$SAGE_LOCAL/share/jmol" echo "replacing jmol directory and contents..." fi -mkdir $SAGE_LOCAL"/share/jmol" +mkdir "$SAGE_LOCAL/share/jmol" TEMPDIR=$SPKDIR"/src/jmol" cd "$TEMPDIR" -cp -r * $SAGE_LOCAL"/share/jmol/" +cp -r * "$SAGE_LOCAL/share/jmol/" cd $SAGE_LOCAL"/bin" if [ $? -ne 0 ]; then `@``@` -64,12 +64,12 `@``@` if [ $? -ne 0 ]; then else echo "Copying jmol script to "$SAGE_LOCAL"/bin." cd "$TEMPDIR" -    cp -f jmol $SAGE_LOCAL"/bin" +    cp -f jmol "$SAGE_LOCAL/bin" fi echo "Installing applet web directory" -mkdir $SAGE_LOCAL"/share/jmol/appletweb" -cp Jmol.js $SAGE_LOCAL"/share/jmol/appletweb" +mkdir "$SAGE_LOCAL/share/jmol/appletweb" +cp Jmol.js "$SAGE_LOCAL/share/jmol/appletweb" TEMPDIR=$SPKDIR"/patches/appletweb" cd "$TEMPDIR" `@``@` -77,7 +77,7 `@``@` if [ $? -ne 0 ]; then echo "Error finding patches/appletweb directory. Exiting." exit 1 fi -cp -r * $SAGE_LOCAL"/share/jmol/appletweb" +cp -r * "$SAGE_LOCAL/share/jmol/appletweb" if [ $? -ne 0 ]; then echo "Error installing PACKAGE_NAME." `


---

Comment by gutow created at 2011-12-22 02:04:57

Removing command line patch as it appears to be incorporated into 4.8.


---

Comment by ddrake created at 2012-01-11 06:03:40

Changing status from needs_review to needs_work.


---

Comment by ddrake created at 2012-01-11 06:03:40

I'm looking this over, and I have some more minor nits to pick with spkg-install. Here's an idiom I see a couple times:

```
TEMPDIR=something
cd "$TEMPDIR"
do some stuff
...
```

Two things bother me about that: (1) you call it `TEMPDIR`, which implies to me that it's a temporary directory used for some scratch work, but you're talking about an existing directory with important files in it. (2) You never use the `TEMPDIR` variable, except in the `cd` command...so why not just `cd` to the directory?

Also, I think it's more readable to just put the paths into commands, rather than `cd`ing around. I would prefer to see

```
cp $SAGE_FOO/dir/file.txt $SAGE_BAR/dir/dir2/
```

rather than

```
cd $SAGE_FOO/dir
cp file.txt $SAGE_BAR/dir/dir2/
```

It makes it easier to read the script, since you don't have to remember what the working directory is. Also, you sometimes change directories inside an if-then-else, so the working directory depends on what happened there!

Finally, at the end of `spkg-install`, you have "PACKAGE NAME" instead of Jmol!


---

Comment by ddrake created at 2012-01-11 07:06:27

changes to spkg-install, SPKG.txt. For review only.


---

Comment by ddrake created at 2012-01-11 07:13:09

Changing status from needs_work to needs_review.


---

Attachment

I've looked over the spkg, and modulo my fixes to `spkg-install`, I can give it a positive review. My changes are in attachment:trac11503.patch and I have a spkg with those changes at http://sagenb.kaist.ac.kr/~drake/Jmol-12.0.45.p3.spkg. It's identical to Jonathan's version except for the changes in attachment:trac11503.patch.

Jason, you volunteered to look it over, but that shouldn't stop anyone else. :)


---

Comment by gutow created at 2012-01-11 14:21:03

Dan's changes look good to me (obviously much more experience writing these scripts than I have:)) I suggest we try Dan's .spkg for the review and have changed the description to reflect this.

Jonathan

Replying to [comment:16 ddrake]:

> I've looked over the spkg, and modulo my fixes to `spkg-install`, I can give it a positive review. My changes are in attachment:trac11503.patch and I have a spkg with those changes at http://sagenb.kaist.ac.kr/~drake/Jmol-12.0.45.p3.spkg. It's identical to Jonathan's version except for the changes in attachment:trac11503.patch. Jason, you volunteered to look it over, but that shouldn't stop anyone else. :)


---

Comment by jason created at 2012-01-17 02:31:35

Dan: your changes look fine to me.  Do you give everything else a positive review?


---

Comment by jason created at 2012-01-17 02:47:57

Changing status from needs_review to positive_review.


---

Comment by jason created at 2012-01-17 02:47:57

Oh, wait, I see that you just said modulo your fixes, you give the spkg a positive review.  So it sounds like we agree: positive review.


---

Comment by jason created at 2012-01-17 03:05:52

Changing status from positive_review to needs_work.


---

Comment by jason created at 2012-01-17 03:05:52

hmm...nothing has been added to the deps file.  There should be another patch for that.


---

Comment by jason created at 2012-01-17 03:27:26

So I think what needs to be done at this point is:

1. Make the jmol spkg not start with a capital letter (simple rename of the spkg file)

2. Apply the [attachment:trac-11503-jmol-spkg.patch] to the sage root repository, make an sdist, put the jmol spkg in there, and try building.  In essence, review the changes to the sage root repository.


---

Comment by jason created at 2012-01-17 03:27:26

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-01-17 14:59:40

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-01-17 14:59:40

For `SPKG.txt`, you should follow the format at [http://sagemath.org/doc/developer/producing_spkgs.html#creating-a-new-spkg](http://sagemath.org/doc/developer/producing_spkgs.html#creating-a-new-spkg)


---

Comment by jdemeyer created at 2012-01-17 15:03:56

Okay, it's not in the documentation, but you should format the Changelog with lines like

```
### mypackage-3.18.spkg (Jeroen Demeyer, 17 January 2012)
 * Changed foo to bar
```

This is how every spkg does it (except for sagenb, which I can live with).


---

Comment by gutow created at 2012-01-17 15:39:00

Should I change this or will you Dan?

A comment.  As a relatively newer developer, I do not appreciate formatting requirements that are not documented.  I followed the example in the developer's guide.

Jonathan

Replying to [comment:27 jdemeyer]:

> Okay, it's not in the documentation, but you should format the Changelog with lines like ` === mypackage-3.18.spkg (Jeroen Demeyer, 17 January 2012) === * Changed foo to bar ` This is how every spkg does it (except for sagenb, which I can live with).


---

Comment by jason created at 2012-01-17 15:45:30

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-01-17 15:45:30

I made an spkg that reformats the changelog and makes the spkg lowercase.  See the new instructions.

Jonathan: I understand---I didn't object before because it wasn't in the docs.


---

Comment by jdemeyer created at 2012-01-17 15:47:04

Yeah, I can imagine it's annoying. It should be documented better. I always thought it was documented, for the simple reason that every spkg is doing it the same way.

The docs should probably be clarified.


---

Comment by jdemeyer created at 2012-01-17 16:11:10

I made some further improvements to `SPKG.txt`, in particular I simplified the Dependencies to 

```
 * Sage Notebook (sagenb)
```



---

Comment by jason created at 2012-01-17 16:13:05

I've updated the instructions over at #11080 to reflect your new spkg.


---

Comment by jhpalmieri created at 2012-01-17 16:30:25

Replying to [comment:30 jdemeyer]:
> Yeah, I can imagine it's annoying. It should be documented better.

See [http://trac.sagemath.org/sage_trac/attachment/ticket/9419/trac_9419-part2.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/9419/trac_9419-part2.patch).


---

Comment by kcrisman created at 2012-01-17 16:41:40

> > Yeah, I can imagine it's annoying. It should be documented better.
> 
> See [http://trac.sagemath.org/sage_trac/attachment/ticket/9419/trac_9419-part2.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/9419/trac_9419-part2.patch).

I knew this sounded familiar!


---

Comment by jason created at 2012-01-18 06:11:16

apply to sage repository


---

Attachment

Attached patch which fixes command-line jmol.  This issue was discovered over on #9238; I used the fix from the comments there.


---

Comment by jason created at 2012-01-19 17:47:25

To review this ticket, this is what is left:

* My and jdemeyer's changes to the spkg (reformatting SPKG.txt, basically)
* the [attachment:trac-11503-jmol-commandline.patch] that fixes command-line jmol


---

Comment by jdemeyer created at 2012-01-19 21:00:37

Since jmol doesn't use setuptools, it should be listed normally between the dependencies.  My new [attachment:trac-11503-jmol-spkg.patch] does this.


---

Comment by kini created at 2012-01-20 07:10:13

Jason, what did you base your commandline patch on? It doesn't apply to 4.8.rc0, even with fuzz, since there seem to be some different lines in the context of the second chunk. Here's a rebase on 4.8.rc0, though I don't know what's going on here so I won't put it in the ticket description.


---

Comment by kini created at 2012-01-20 07:10:13

Changing keywords from "sd31,Jmol, flask" to "sd31 Jmol flask".


---

Attachment

apply to $SAGE_ROOT/devel/sage


---

Comment by jason created at 2012-01-20 07:22:51

I made the patch on 5.0something (prealpha/beta1 maybe?).  I also had #11078 applied before this.


---

Comment by kini created at 2012-01-20 07:28:31

Oh, OK. Then there is no rebasing needed -- 4.8.rc0 -> #11078 -> your patch works perfectly.


---

Comment by jason created at 2012-01-22 02:05:06

I tried building a clean sage with this spkg and the new notebook, and command-line jmol didn't work because the local/bin/jmol script was not executable.  So it should probably be set to executable inside the spkg.


---

Comment by jason created at 2012-01-22 02:05:06

Changing status from needs_review to needs_work.


---

Comment by jason created at 2012-02-04 19:04:41

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-02-04 19:04:41

I just uploaded a p4 version that sets the jmol script to executable after copying to local/bin.  So it's needs review again.


---

Comment by jdemeyer created at 2012-02-08 07:47:26

apply to the sage root repository


---

Attachment

Rebased to sage-5.0beta11


---

Comment by ppurka created at 2012-04-02 08:57:56

The attachment [attachment:trac-11503-jmol-spkg.2.patch] has been rebased to sage-5.0beta11. Compiling it now (along with #11874 and the patches to `SAGE_ROOT` from #11080).


---

Comment by gutow created at 2012-04-08 22:02:03

Updated to Jmol-12.2.21...this will allow using Jmol to generate images server-side.


---

Comment by jdemeyer created at 2012-04-09 08:30:17

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-04-09 08:30:17


```
$ hg status
? SPKG.txt~
```



---

Comment by kini created at 2012-04-09 11:07:48

Since it's a new jmol version, the p-version number should be reset.


---

Comment by gutow created at 2012-04-09 12:50:53

Odd that the chmod is gone...I didn't edit the script....All I did was replace the .jar files....I'll check this afternoon.  Not sure why the SPKG backup got left behind, but I can delete it....

Replying to [comment:50 jdemeyer]:

> ` $ hg status ? SPKG.txt~ `


---

Comment by gutow created at 2012-04-09 23:09:30

SPKG.txt~ removed and renamed to ...p0


---

Comment by gutow created at 2012-04-09 23:09:30

Changing status from needs_work to needs_review.


---

Comment by gutow created at 2012-05-28 14:40:36

I believe this ticket is actually included in the positively reviewed #11080.  If there are no objections, I believe this should become a positive review as well.


---

Comment by ppurka created at 2012-05-28 15:10:35

Changing status from needs_review to positive_review.


---

Comment by ppurka created at 2012-05-28 15:10:35

Indeed this should be positive review. I have been using it both from the notebook and from the command line without issues, for several months.

Setting it to positive review.


---

Comment by kini created at 2012-06-27 23:20:52

Please put the latest version of the SPKG up on this ticket. It looks like #12299's instructions mention a newer version of the SPKG than is found here.


---

Comment by kcrisman created at 2012-06-28 01:22:07

Jonathan can correct me if I'm wrong, but as far as I know, this is on purpose, because the newest Jmol at #12299 needs the many updates to Jmol there.  In that sense this ticket is a 'hard' prereq for #11080 and hence for #13121/#12299.


---

Comment by kini created at 2012-06-28 02:10:31

OK, fair enough.


---

Comment by jdemeyer created at 2012-07-02 15:22:09

Resolution: fixed


---

Comment by jdemeyer created at 2012-07-23 06:50:54

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2012-07-23 06:50:54

Changing status from closed to new.


---

Comment by jdemeyer created at 2012-07-23 06:50:54

Unmerging this from sage-5.2 due to the serious security issue at #13270.


---

Comment by jdemeyer created at 2012-07-23 06:51:33

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-07-23 06:51:50

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-07-25 06:40:37

Resolution: fixed
