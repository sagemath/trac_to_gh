# Issue 24916: Refactoring of persistence-related functions from sage.structure.sage_object

Issue created by migration from https://trac.sagemath.org/ticket/25153

Original creator: embray

Original creation time: 2018-04-12 15:26:38

This moves all module-level persistence/pickling related functions that were defined in `sage.structure.sage_object` into `sage.misc.persistence` (where they were already included via imports).

See the commit message for more details.

I felt that doing something like this made sense before I continued work #24582, which proposes to add more abstraction around the pickle module.


---

Comment by embray created at 2018-04-12 15:26:50

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-04-12 17:33:25

That's a long diff. But I guess you just moved code without changing anything substantial? Or should I review all the code/comments as if you had written it from scratch? (There is at least one typo in there…)


---

Comment by jdemeyer created at 2018-04-12 19:18:41

I would keep this in `sage_object.pyx`:

```python
def make_None(*args, **kwds):
    """
    Do nothing and return ``None``. Used for overriding pickles when
    that pickle is no longer needed.

    EXAMPLES::

        sage: from sage.structure.sage_object import make_None
        sage: print(make_None(42, pi, foo='bar'))
        None
    """
    return None


# Generators is no longer used (#21382)
register_unpickle_override('sage.structure.generators', 'make_list_gens', make_None)
```

This really refers to deprecated features of `SageObject`.


---

Comment by embray created at 2018-04-13 13:38:00

Replying to [comment:3 saraedum]:
> That's a long diff. But I guess you just moved code without changing anything substantial? Or should I review all the code/comments as if you had written it from scratch? (There is at least one typo in there…)

Mostly moving code around, yes--I can certainly help direct you to where the only significant differences are.  The module-level `save()` function is rewritten such that the core of its implementation is move into `_base_save()`, and likewise the module-level `dumps` function is rewritten to use use `_base_dumps()`.  Likewise, `SageObject.save()` and `SageObject.dumps()` are rewritten similarly.

Nothing below `unpickle_override()` in `sage.misc.persist` is new or modified in any way except to change some imports.


---

Comment by embray created at 2018-04-13 13:40:05

Replying to [comment:4 jdemeyer]:
> I would keep this in `sage_object.pyx`:

Ok. While we're at it could I just delete `make_None` entirely?  It's not used anywhere else and it can be written trivially as an in-line lambda...


---

Comment by saraedum created at 2018-04-21 19:11:36

What about this? `TODO: Add a deprecation on them once we have a ticket #`


---

Comment by saraedum created at 2018-04-21 19:12:18

Why the lazy import in `loads = LazyImport('sage.misc.persist', 'loads')` and friends?


---

Comment by saraedum created at 2018-04-21 19:13:28

In principle this looks good to me. I don't see why we should keep `make_None`.


---

Comment by saraedum created at 2018-04-21 19:13:37

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-04-23 12:29:23

It looks like there were a commit or two to this branch that I never pushed--that would answer your questions.


---

Comment by git created at 2018-04-26 13:45:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-04-26 13:47:20

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-04-26 13:47:20

Decided to keep `make_None`, since even though it's only used once it's theoretically useful elsewhere, and while it's pretty trivial it's at least explicit in its purpose and self-documenting.  But I kept it in `sage.misc.persist` since it's a general utility.  I just moved that one unpickle override back to `sage.structure`.


---

Comment by embray created at 2018-04-26 15:16:20

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-04-26 15:16:20

Actually, since I added the deprecations I should probably also update all the existing imports internal to Sage as well.  I think I already did that but I have the change in my stash somewhere...


---

Comment by git created at 2018-04-28 18:30:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-04-28 18:30:25

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-04-29 09:24:23

Pretty sure there's something rather broken on the "sardonis" patchbot.


---

Comment by saraedum created at 2018-04-30 16:00:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-12 12:03:07

Merge conflict


---

Comment by vbraun created at 2018-05-12 12:03:07

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-05-14 15:31:40

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-05-14 15:31:40

Merge conflict with what?  It merges fine with current develop branch.


---

Comment by vbraun created at 2018-05-14 17:07:23

Then wait for the next beta


---

Comment by vbraun created at 2018-05-14 17:07:23

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-05-14 17:39:44

Strange process...


---

Comment by chapoton created at 2018-05-27 20:03:03

branch does not apply, needs to be rebased


---

Comment by git created at 2018-05-28 14:02:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-28 14:03:27

Rebased.  Should be able to set back to positive_review, but might be worth getting a patchbot result first.


---

Comment by embray created at 2018-05-28 14:03:27

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-05-30 07:43:41

the pyflakes configuration appears to be confused about .pyx files.  something to fix maybe...


---

Comment by embray created at 2018-05-30 07:43:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-31 17:25:43

Resolution: fixed


---

Comment by jdemeyer created at 2018-06-12 10:30:31

Something went wrong with the rebasing here. An outdated version of this branch was rebased and merged.


---

Comment by jdemeyer created at 2018-06-12 10:31:55

I opened #25565 to fix that.
