# Issue 18309: Make arb a standard package

Issue created by migration from Trac.

Original creator: mmezzarobba

Original creation time: 2015-05-29 15:17:02

CC:  cheuberg fredrik.johansson simonking




---

Comment by mmezzarobba created at 2015-05-29 15:38:49

Changing status from new to needs_review.


---

Comment by git created at 2015-05-29 15:50:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2015-05-29 16:45:46

It doesn't build for me on OS X 10.10:

```
    CC   ../build/partitions/partitions_fmpz_fmpz.o
    CC   ../build/partitions/partitions_hrr_sum_arb.o
    CC   ../build/partitions/partitions_rademacher_bound.o
    AR   libarb.a
ar: no archive members specified
usage:  ar -d [-TLsv] archive file ...
	ar -m [-TLsv] archive file ...
	ar -m [-abiTLsv] position archive file ...
	ar -p [-TLsv] archive [file ...]
	ar -q [-cTLsv] archive file ...
	ar -r [-cuTLsv] archive file ...
	ar -r [-abciuTLsv] position archive file ...
	ar -t [-TLsv] archive [file ...]
	ar -x [-ouTLsv] archive [file ...]
make[4]: *** [libarb.a] Error 1
make[3]: *** [library] Error 2
Error building arb.
```



---

Comment by mmezzarobba created at 2015-05-29 18:23:33

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2015-05-30 08:09:56

Replying to [comment:4 jhpalmieri]:
> It doesn't build for me on OS X 10.10:

I made this a separate issue (#18552).


---

Comment by mmezzarobba created at 2015-05-30 08:09:56

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2015-06-01 07:06:15

Replying to [comment:4 jhpalmieri]:
> It doesn't build for me on OS X 10.10:

Could you please try with arb 2.6 (#18560)?


---

Comment by git created at 2015-06-06 13:37:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2015-08-08 07:35:48

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-08-08 07:35:48

does not apply, needs rebase


---

Comment by git created at 2015-08-18 14:07:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2015-08-18 14:08:39

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-09-03 16:33:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-09-03 16:38:52

I reviewed this ticket. Including it into a fresh copy of develop (=6.9.beta4) builds fine with all doctests passing (three unrelated to this ticket only when called separately). In particular, the sage version built includes arb. Source code (removal of `optional - arb`) seems to be fine. Documentation seems to be ok.

There was one occurrence of `optional arb` in `real_mpfi.pyx`. I removed that as a reviewer patch. Please cross-review this change; then feel free to set to `positive_review`.


---

Comment by mmezzarobba created at 2015-09-04 05:02:39

Thanks!


---

Comment by mmezzarobba created at 2015-09-04 05:02:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-09-12 09:56:07

You can only depend on tickets that contribute code


---

Comment by vbraun created at 2015-09-12 11:37:46

Testsuite fails on 32-bit Linux

```
atan....PASS
atan2....FAIL: containment

a = (-143601044557104111888298409983 * 2^-97) +/- (0)

b = (-1 * 2^5) +/- (1040502623 * 2^-94)

c = (-1933204245030245427143485 * 2^-80) +/- (959240107 * 2^-104)

make[4]: *** [../build/arb/test/t-atan2_RUN] Aborted (core dumped)
atan_arf....g++ -pthread -shared -L/home/buildslave-sage/slave/sage_git/build/local/lib build/temp.linux-i686-2.7/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_cyclo_dense.o -L/home/buildslave-sage/slave/sage_git/build/local/lib -L/home/buildslave-sage/slave/sage_git/build/local/lib -lntl -lgmp -lstdc++ -lpython2.7 -o build/lib.linux-i686-2.7/sage/matrix/matrix_cyclo_dense.so
[ 75/170] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/buildslave-sage/slave/sage_git/build/local/include -I/home/buildslave-sage/slave/sage_git/build/local/include/python2.7 -I/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/core/include -I/home/buildslave-sage/slave/sage_git/build/src -I/home/buildslave-sage/slave/sage_git/build/src/sage/ext -I/home/buildslave-sage/slave/sage_git/build/src/build/cythonized -I/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext -I/home/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c /home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_modn_sparse.c -o build/temp.linux-i686-2.7/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/matrix/matrix_modn_sparse.o -fno-strict-aliasing -w -fno-tree-dominator-opts
FAIL: containment

a = (-9905938165778121085362896895 * 2^-91) +/- (0)

b = (-2031897670652875033840701129116896875534188457349248225 * 2^-180) +/- (538444801 * 2^-210)

make[4]: *** [../build/arb/test/t-atan_RUN] Aborted (core dumped)
```



---

Comment by vbraun created at 2015-09-12 11:37:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-09-12 11:38:01

http://build.sagedev.org/release/builders/%20%20fast%20Oxford%20arando%20%28Ubuntu%2013.04%20i686%29%20incremental/builds/538/steps/compile/logs/stdio


---

Comment by fredrik.johansson created at 2015-09-12 14:03:24

I can reproduce the failure on linux32 under virtualbox.

The source appears to be a bug in MPIR.

If you run

#include "mpir.h"

int main()
{
    mpz_t one, x, w;
    mpz_init(one);
    mpz_init(x);
    mpz_init(w);
    mpz_set_str(one, "62165404551223330269422781018352605012557018849668464680057997111644937126566671941632", 10);
    mpz_set_str(x, "39623752663112484341451587580", 10);

    mpz_tdiv_q(w, one, x);
    gmp_printf("%Zd / %Zd = %Zd\n", one, x, w);
}

it outputs 

    62165404551223330269422781018352605012557018849668464680057997111644937126566671941632 / 39623752663112484341451587580 = 1568892406419848332919986945754866320479099155002496784035

but you can check with Python ints that the correct quotient should be

        1568892403497558507879962225846103176600476845510570267609


---

Comment by vbraun created at 2015-09-12 14:14:24

Some more failures on 32-bit:

```
sage -t --long src/sage/rings/complex_ball_acb.pyx
**********************************************************************
File "src/sage/rings/complex_ball_acb.pyx", line 1137, in sage.rings.complex_ball_acb.ComplexBall.accuracy
Failed example:
    CBF(I/2).accuracy()
Expected:
    9223372036854775807
Got:
    2147483647
**********************************************************************
File "src/sage/rings/complex_ball_acb.pyx", line 1139, in sage.rings.complex_ball_acb.ComplexBall.accuracy
Failed example:
    CBF('nan', 'inf').accuracy()
Expected:
    -9223372036854775807
Got:
    -2147483647
**********************************************************************
1 item had failures:
   2 of   5 in sage.rings.complex_ball_acb.ComplexBall.accuracy
    [294 tests, 2 failures, 0.32 s]
sage -t --long src/sage/rings/real_arb.pyx
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 1430, in sage.rings.real_arb.RealBall.accuracy
Failed example:
    RBF(1).accuracy()
Expected:
    9223372036854775807
Got:
    2147483647
**********************************************************************
File "src/sage/rings/real_arb.pyx", line 1432, in sage.rings.real_arb.RealBall.accuracy
Failed example:
    RBF(NaN).accuracy()
Expected:
    -9223372036854775807
Got:
    -2147483647
**********************************************************************
1 item had failures:
   2 of   5 in sage.rings.real_arb.RealBall.accuracy
    [498 tests, 2 failures, 0.31 s]
```



---

Comment by wbhart created at 2015-09-12 14:20:28

Regarding the divion bug, can someone tell me the value of SB_DIVAPPR_Q_SMALL_THRESHOLD and SB_DIV_QR_SMALL_THRESHOLD         on this machine, in gmp-mparam.h in MPIR.

If they are not 0, you will probably find setting them to 0 is a temporary workaround. If they are already 0 I wonder what on earth can have gone wrong.

I'm afraid I personally won't be able to fix this bug until late this month, but I have posted it on mpir-devel in case someone else can track it down.

If the gcc is 5.2 or above, it might also be worth building MPIR without optimisation (and check the CFLAGS doesn't contain -ansi : I don't think it does). We've had reports of what we think is miscompilation with recent gcc on Linux 32. We are still trying to track it down (code works fine under valgrind but otherwise does not).


---

Comment by fredrik.johansson created at 2015-09-12 15:31:53

Defining both SB_DIVAPPR_Q_SMALL_THRESHOLD and SB_DIV_QR_SMALL_THRESHOLD as 0 in gmp-mparam.h fixes the problem (these values are currently not defined at all).

The bug might be restricted to 32-bit installations on a 64-bit host, where MPIR has outdated tuneup values (my arch is x86/nehalem).

Since this is a rather serious bug affecting all of Sage, should it be a separate, blocker, ticket?


---

Comment by leif created at 2015-09-12 16:30:48

Replying to [comment:24 fredrik.johansson]:
> Defining both SB_DIVAPPR_Q_SMALL_THRESHOLD and SB_DIV_QR_SMALL_THRESHOLD as 0 in gmp-mparam.h fixes the problem (these values are currently not defined at all).
> 
> The bug might be restricted to 32-bit installations on a 64-bit host, where MPIR has outdated tuneup values (my arch is x86/nehalem).
> 
> Since this is a rather serious bug affecting all of Sage, should it be a separate, blocker, ticket?

I'd say yes.

FWIW, I only tested the MPIR alphas stand-alone on Linux x86, on a true 32-bit processor.


---

Comment by git created at 2015-09-24 12:53:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-09-24 13:07:10

Replying to [comment:22 vbraun]:
> Some more failures on 32-bit:
> {{{
> sage -t --long src/sage/rings/complex_ball_acb.pyx
> **********************************************************************
> 1 item had failures:
>    2 of   5 in sage.rings.complex_ball_acb.ComplexBall.accuracy
>     [294 tests, 2 failures, 0.32 s]
> sage -t --long src/sage/rings/real_arb.pyx
> }}}
These two failures do not belong to this ticket, but to #19063 (the relevant code is not present here).

> {{{
> File "src/sage/rings/real_arb.pyx", line 1430, in sage.rings.real_arb.RealBall.accuracy
> 1 item had failures:
>    2 of   5 in sage.rings.real_arb.RealBall.accuracy
>     [498 tests, 2 failures, 0.31 s]
> }}}

I pushed a fix for this, but have not yet tested it under 32 bit.


---

Comment by cheuberg created at 2015-09-24 15:58:51

Replying to [comment:24 fredrik.johansson]:
> Since this is a rather serious bug affecting all of Sage, should it be a separate, blocker, ticket?

I opened #19280 for that.


---

Comment by cheuberg created at 2015-09-24 18:58:13

Arb's testsuite passes on 32 bit once mpir has been rebuilt using #19280.


---

Comment by cheuberg created at 2015-09-25 06:55:57

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2015-09-25 06:55:57

Replying to [comment:27 cheuberg]:
>> I pushed a fix for this, but have not yet tested it under 32 bit.

Now, after recompiling mpir with #19280 applied, all tests pass on my (virtual) 32 bit machine.


---

Comment by git created at 2015-09-25 07:31:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2015-10-15 08:27:12

Thanks for taking care of this!


---

Comment by mmezzarobba created at 2015-10-15 08:27:12

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-10-15 08:45:09

Needs to be rebased to the latest version of #19280


---

Comment by jdemeyer created at 2015-10-15 08:45:09

Changing status from positive_review to needs_work.


---

Comment by mmezzarobba created at 2015-10-15 09:47:20

Replying to [comment:33 jdemeyer]:
> Needs to be rebased to the latest version of #19280

Are you saying we should **rebase** these changes (and the other branches that depend on them) on top of #19820? I can do it, but in this case I think we should also rebase #19280 itself on top of sage-6.9.

Or do you want me to merge the branch there into this branch? (I'll do it if you want, but why? The other ticket is already a dependency, so this ticket won't get merged without it...)


---

Comment by jdemeyer created at 2015-10-15 11:47:18

Replying to [comment:34 mmezzarobba]:
> Replying to [comment:33 jdemeyer]:
> > Needs to be rebased to the latest version of #19280
> 
> Are you saying we should **rebase** these changes (and the other branches that depend on them) on top of #19820? I can do it, but in this case I think we should also rebase #19280 itself on top of sage-6.9.
> 
> Or do you want me to merge the branch there into this branch? (I'll do it if you want, but why? The other ticket is already a dependency, so this ticket won't get merged without it...)
Rebase or merge: either is fine for me. The reason I ask it is for easier review/testing. It's better if I can just do `git trac checkout <ticket number>` instead of manually needing to merge the dependencies. The fact that this branch has a _wrong_ version of #19280 makes it even worse.


---

Comment by mmezzarobba created at 2015-10-15 12:37:38

New commits:


---

Comment by mmezzarobba created at 2015-10-15 12:37:38

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-10-15 13:44:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-10-15 19:45:20

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-10-15 19:45:20

Merge conflict


---

Comment by cheuberg created at 2015-10-16 10:02:50

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2015-10-16 10:02:50

Merged 6.10.beta0 (conflict was with #19308). This introduces lots of blank space diff, so please diff with `git diff -b` to see the actual changes.
----
New commits:


---

Comment by mmezzarobba created at 2015-10-16 10:56:17

going back to my branch because I also rebased the follow-up tickets
----
New commits:


---

Comment by cheuberg created at 2015-10-16 11:00:48

I do not understand why you _rebase_ at such a late stage with a chain of tickets depending on this here.


---

Comment by cheuberg created at 2015-10-16 11:03:18

anyhow, the two branches contain the same code, so I set this back to positive.


---

Comment by cheuberg created at 2015-10-16 11:03:18

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2015-10-16 11:17:36

Replying to [comment:41 cheuberg]:
> I do not understand why you _rebase_ at such a late stage with a chain of tickets depending on this here.

I'm doing it _because_ there are other tickets depending on this one, and IMO adding merges everywhere makes their history less readable. But I can do merges instead if you prefer...


---

Comment by cheuberg created at 2015-10-16 11:33:08

IMHO, rebasing destroys history and requires much more work, e.g., you _have_ to merge the rebased ticket into all depending tickets, while a merge might just work without additional intervention.

Luckily, I never merged #18546 into #17220 and its dependencies; otherwise I'd have to remerge it again (although nothing relevant changed) and would have troubles in my private "develop" branch where I collect all tickets I authored in order to detect conflicts between apparently unrelated tickets early on.

Thus for me, rebasing something where somebody else might have based something (e.g., something pushed to a trac ticket) is something to avoid if at all possible.


---

Comment by jdemeyer created at 2015-10-16 11:35:25

Replying to [comment:44 cheuberg]:
> Thus for me, rebasing something where somebody else might have based something (e.g., something pushed to a trac ticket) is something to avoid if at all possible.

I agree, except that I would replace the condition "something pushed to a trac ticket" by "something pushed to a trac ticket and set to needs_review". I often push work-in-progress to Trac and keep rewriting history until it's ready for review.


---

Comment by mmezzarobba created at 2015-10-16 11:47:17

Replying to [comment:45 jdemeyer]:
> Replying to [comment:44 cheuberg]:
> > Thus for me, rebasing something where somebody else might have based something (e.g., something pushed to a trac ticket) is something to avoid if at all possible.
> 
> I agree, except that I would replace the condition "something pushed to a trac ticket" by "something pushed to a trac ticket and set to needs_review".

For me, rebasing on top of the last release or beta is okay if not desirable even in this case. (In particular, please feel free to do it when you know I'm on the other end.) But I'll refrain from doing it if you don't like it.


---

Comment by vbraun created at 2015-10-16 21:08:11

Doesn't actually build arb, maybe you need to bump the patchlevel as well?

http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2064%20bit%29%20incremental/builds/143/steps/compile/logs/stdio


---

Comment by vbraun created at 2015-10-16 21:08:11

Changing status from positive_review to needs_work.


---

Comment by cheuberg created at 2015-10-17 09:18:07

Replying to [comment:47 vbraun]:
> Doesn't actually build arb, maybe you need to bump the patchlevel as well?
> 
> http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%208%2064%20bit%29%20incremental/builds/143/steps/compile/logs/stdio

Bumping the patchlevel does not help.


---

Comment by jdemeyer created at 2015-10-17 11:03:48

You need to add `arb` as dependency for the Sage library in `build/make/deps`.


---

Comment by cheuberg created at 2015-10-17 11:51:23

Replying to [comment:49 jdemeyer]:
> You need to add `arb` as dependency for the Sage library in `build/make/deps`.

I'll try that soon (currently, I have no sage available due to recompilation).

What I tried up to now:

1. I checked out this ticket, ran `make distclean` and then `make`. This resulted in a version of sage _with_ `arb`.
2. I checkout out plain `6.10.beta0`, ran `make distclean` and then `make`, obviously resulting in a version without `arb`.
3. I checked out this ticket, ran `./configure` and `make`. Now everything is recompiling (_including_ arb), however, `git diff` does show empty output, so while this would solve the problem for me, I cannot push it to the ticket.

What I do not understand: why is it necessary to add `arb` to `build/make/deps` for an existing version while it is unnecessary for a fresh install or for people running `./configure`?


---

Comment by jdemeyer created at 2015-10-17 12:36:05

Replying to [comment:50 cheuberg]:
> What I do not understand: why is it necessary to add `arb` to `build/make/deps` for an existing version while it is unnecessary for a fresh install or for people running `./configure`?

Probably the fact that `arb` starts with the letter `a`. Anyway, there is no point in analysing, the fix is obvious.


---

Comment by cheuberg created at 2015-10-17 14:33:59

Replying to [comment:51 jdemeyer]:
> Probably the fact that `arb` starts with the letter `a`. Anyway, there is no point in analysing, the fix is obvious.

Unfortunately, it is not obvious to me:

Following Volker's recommendation, I increased the patchlevel, following your recommendation, I added to `build/make/deps`, but `arb` is still not built.

```diff
diff --git a/build/make/deps b/build/make/deps
index 3d0fb93..27f488d 100644
--- a/build/make/deps
+++ b/build/make/deps
`@``@` -100,6 +100,7 `@``@` base: $(INST)/$(BZIP2) $(INST)/$(PATCH) $(INST)/$(PKGCONF)
 # Sage library (e.g. CYTHON, JINJA2), and on the other hand all
 # dependencies for Cython files (e.g. PARI, NTL, SAGE_MP_LIBRARY).
 sagelib: \
+               $(INST)/$(ARB) \
                $(INST)/$(ATLAS) \
                $(INST)/$(CEPHES) \
                $(INST)/$(CLIQUER) \
diff --git a/build/pkgs/arb/package-version.txt b/build/pkgs/arb/package-version.txt
index 8f0f703..67b2238 100644
--- a/build/pkgs/arb/package-version.txt
+++ b/build/pkgs/arb/package-version.txt
`@``@` -1,2 +1,2 `@``@`
-2.6.0
+2.6.0.p0

```



---

Comment by jdemeyer created at 2015-10-17 15:09:04

Did you remember to run `./configure` first? If yes and it still doesn't work, please push your non-working branch (with the change to `build/make/deps`) and I'll have a look.

There is absolutely no need to change the patchlevel if you don't change the package.


---

Comment by cheuberg created at 2015-10-17 16:27:18

Replying to [comment:53 jdemeyer]:
> Did you remember to run `./configure` first? 

Running `./configure` solves the problem locally, but does not change any files under version control, thus will not solve the problem for anybody else.

> If yes and it still doesn't work, please push your non-working branch (with the change to `build/make/deps`) and I'll have a look.

Pushed and thanks for having a look.

> There is absolutely no need to change the patchlevel if you don't change the package.

ok, this is not part of the pushed branch.
----
Last 10 new commits:


---

Comment by jdemeyer created at 2015-10-17 18:16:22

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-10-17 18:16:22

Replying to [comment:54 cheuberg]:
> Running `./configure` solves the problem locally, but does not change any files under version control, thus will not solve the problem for anybody else.

But `./configure` is run automatically whenever the Sage version changes. So, if this ticket is merged in the next beta, there will not be problem since the Sage version will also change.


---

Comment by vbraun created at 2015-10-17 19:36:32

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-10-17 19:36:32

Doesn't build so I can't test it on the buildbot

http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20incremental/builds/501/steps/compile/logs/stdio


---

Comment by jdemeyer created at 2015-10-17 20:14:35

`@`vbraun: would it be possible to either:
1. install autotools on the buildbot
2. build from an sdist instead of from git on the buildbot
to avoid these kinds of problems.


---

Comment by jdemeyer created at 2015-10-17 20:16:18

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-10-17 20:16:18

Hang on, `configure.ac` didn't change, so autotools aren't needed here.

Do the buildbots run `./configure` before building? If not, they should.


---

Comment by vbraun created at 2015-10-17 21:17:57

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-10-17 21:17:57

They don't run configure, and thats not in http://doc.sagemath.org/html/en/installation/source.html. I don't mind adding it but the docs should be updated first then.


---

Comment by jdemeyer created at 2015-10-17 21:22:06

[It is documented](http://doc.sagemath.org/html/en/developer/packaging.html#building-the-package)


---

Comment by jdemeyer created at 2015-10-17 21:22:06

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-10-17 22:32:02

I'm against different instructions for build-from-source and build-from-source-with-ticket, thats unnecessary. And the buildbot can realistically only test one version anyways, so its save to assume that the other version is going to be broken. Also, not all buildbots have autotools (e.g. OSX doesn't).


---

Comment by jdemeyer created at 2015-10-18 07:03:33

So what would you propose then? This isn't going to be the last ticket with this problem.

See #19432 for a documentation improvement.


---

Comment by vbraun created at 2015-10-18 09:54:49

Basically we have to decide between
* Create the makefile rules at configure-time. Then running configure is mandatory; It may work without configure, but there can't be any guarantee
* Create the makefile rules from within make(*), using an include and auto-reload of changed includes. 
We previously used the latter, why did we have to change that? The rules aren't configurable, they just reflect the package types and dependencies.

(*) possibly by calling configure, though I'd prefer something more straightforward


---

Comment by vbraun created at 2015-10-18 12:08:02

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2015-10-18 12:10:30

Replying to [comment:63 vbraun]:
> We previously used the latter, why did we have to change that?

1. the new "install packages with dependencies" means that `./sage -i PKGNAME` needs a lot more time (running `./configure` takes some time). In particular, [Simon King complained about this](https://groups.google.com/d/topic/sage-devel/fQCBuz8-d8k/discussion).

2. `./configure && make` is the standard way to build packages.

> The rules aren't configurable, they just reflect the package types and dependencies.
That's something which can (and should) change in the future. It would be cool to run for example

```
./configure --with-system-python --with-package=valgrind --enable-check=yes
```



---

Comment by jdemeyer created at 2015-10-18 12:14:58

From now on, every ticket which tries to add a standard package will get set back to needs_work forever because the buildbot is broken?


---

Comment by vbraun created at 2015-10-18 12:22:17

Thats partly why I said that rerunning configure isn't the most straightforward way of updating the rules.

Configure switches can just override rules (e.g. using that explicit rules override pattern rules); that doesn't prevent us from writing a makefile that works by default.

I agree that `./configure && make` is the standard way but this is not what Sage used to do so its more of a social problem to a) agree on changing it and b) communicating that change. Write to sage-devel.

I don't think the buildbot is broken, it just does what the docs say and our users have learned to rely on. The alternative to fixing the configure/make system is always updating the confball if you change the set of standard packages.


---

Comment by jdemeyer created at 2015-10-18 14:05:24

Replying to [comment:67 vbraun]:
> Write to sage-devel.
That already happened when the change was made.

> it just does what the docs say
Building Sage, then checking out a specific git branch and then rebuilding is not a normal build from source. So I don't think the installation manual applies here. What does apply is the developer's guide which does mention `./configure` (see [comment:60]).

> The alternative to fixing the configure/make system is always updating the confball if you change the set of standard packages. 
Updating the confball is not going to help if you don't even run `./configure`.


---

Comment by jdemeyer created at 2015-10-18 14:26:30

Volker, a different solution would be to change the Sage version number in the branch you test on the buildbots. That should force a reconfiguration and is closer to a user build.


---

Comment by vbraun created at 2015-10-18 15:09:15

Of course I can bump the version with each closed ticket but thats a bit silly....


---

Comment by leif created at 2015-10-18 15:50:42

Replying to [comment:70 vbraun]:
> Of course I can bump the version with each closed ticket but thats a bit silly....

That's of course _not_ what he meant.

Increasing the Sage version when testing with tickets not yet merged into a public release seems natural, as you're doing so in order to prepare the _next_ release, aren't you?


---

Comment by vbraun created at 2015-10-18 15:57:36

Most of the work is figuring out which tickets merge cleanly and pass tests. Actually bumping the version is trivial and I only do that at the end of the release process. Its not always clear at the outset what the next version will be, another beta or rc or release?


---

Comment by leif created at 2015-10-18 16:10:31

Replying to [comment:72 vbraun]:
> Most of the work is figuring out which tickets merge cleanly and pass tests. Actually bumping the version is trivial and I only do that at the end of the release process. Its not always clear at the outset what the next version will be, another beta or rc or release?

So it doesn't make much of a difference whether you change it at the beginning or at the end;  in the rare cases where the next version won't be _betaN+1_ you could fix it again at the end, before releasing.  _What_ the temporary, internal version number for testing actually is doesn't really matter much.


---

Comment by vbraun created at 2015-10-18 16:15:21

You are proposing a more complicated release process without technical advantage, and which introduces additional differences between whats tested on the buildbot vs. what users end up doing. Sure it can be done, but why?


---

Comment by leif created at 2015-10-18 16:22:20

The problem here is that you're _now_ actually testing in a different way or in a different setting than users will (or would) when the ticket got merged and a next version released.


---

Comment by vbraun created at 2015-10-18 16:30:05

At least I'm just running the same "make" command that users are going to use. How is only tesing "configure && make" ever going to give better test coverage?

No amount of testing can guard against misuses of the version stamp, but then onbody knows what the next version stamp is going to be beforehand.


---

Comment by mmezzarobba created at 2015-10-20 11:40:57

I'm lost: could someone please explain what work _this_ ticket needs?


---

Comment by vbraun created at 2015-10-20 22:30:48

I've opened #19443


---

Comment by vbraun created at 2015-10-20 22:30:48

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-10-30 08:33:33

Resolution: fixed
