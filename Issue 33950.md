# Issue 33950: Remove src/sage/__init__.py

Issue created by migration from https://trac.sagemath.org/ticket/34187

Original creator: mkoeppe

Original creation time: 2022-07-15 14:25:03

CC:  klee vdelecroix

Follow-up from #33011.

Because of the complication described in #33011, we not only remove the file from the source tree but also remove it from site-packages before building sagelib.

Follow-up: 
- make sagemath-standard, sage-setup depend on sagemath-environment



---

Comment by klee created at 2022-07-15 15:11:24

If I remove `__init__.py` from `src/sage` and `pkgs/sagemath-standard/build/lib.macosx-12-x86_64-cpython-39/sage`, then sage is built without problem, but doctest fails. Is this expected?


---

Comment by mkoeppe created at 2022-07-15 16:10:35

I'm getting

```
sage -t --random-seed=29572225487268684535188462271558972615 src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t --random-seed=29572225487268684535188462271558972615 src/sage_setup/find.py  # 13 doctests failed
sage -t --random-seed=29572225487268684535188462271558972615 src/sage_setup/clean.py  # 4 doctests failed
sage -t --random-seed=29572225487268684535188462271558972615 src/sage/misc/edit_module.py  # 1 doctest failed
```

----
Last 10 new commits:


---

Comment by mkoeppe created at 2022-07-15 16:17:08


```
> /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_setup/find.py(278)_cythonized_dir()
    276         src_dir = Path(src_dir)
    277         sage = import_module('sage')
--> 278         d = Path(sage.__file__).resolve().parent.parent
    279         editable_install = d == src_dir.resolve()
    280     if editable_install:
```

this use of `sage.__file__` now needs to be changed


---

Comment by git created at 2022-07-15 16:29:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-15 16:34:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-15 16:39:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-15 16:40:18

Changing status from new to needs_review.


---

Comment by klee created at 2022-07-15 22:38:02

Perhaps we have to respect the deprecation period of `isfunction()` defined in `sage` and deprecated by #32479. It ends after two months from now.


---

Comment by git created at 2022-07-16 15:14:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-07-18 11:08:55

Sorry for pointing to a minor thing, but the deprecation message is somewhat misleading as the function in `sage.misc.sageinspect` is `is_function_or_cython_function`. 

```
sage: isfunction(f)
<ipython-input-3-631f9d828a9a>:1: DeprecationWarning: 
Importing isfunction from here is deprecated. If you need to use it, please import
 it directly from sage.misc.sageinspect
See https://trac.sagemath.org/32479 for details.
  isfunction(f)
True
sage: from sage.misc.sageinspect import isfunction
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
<ipython-input-4-53c0fed64cdc> in <module>
----> 1 from sage.misc.sageinspect import isfunction

ImportError: cannot import name 'isfunction' from 'sage.misc.sageinspect' (/Users/kwankyu/GitHub/sage-temp/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/sageinspect.py)
```



---

Comment by klee created at 2022-07-18 11:17:43

Perhaps moving `isfunction` in `sage.__init__.py` to `sage.all` is a solution?


---

Comment by git created at 2022-07-18 17:31:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-18 17:36:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-07-18 17:37:45

I've implemented a more general solution:

```
sage: from sage import isfunction
sage: isfunction
/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/repl/display/fancy_repr.py:272: DeprecationWarning: 
Importing isfunction from here is deprecated; please use "from sage.misc.sageinspect import is_function_or_cython_function as isfunction" instead.
See https://trac.sagemath.org/32479 for details.
  output = repr(obj)
<function is_function_or_cython_function at 0x10f957ee0>
```



---

Comment by klee created at 2022-07-18 22:22:40

That is a right solution. Thanks.

As a side remark, it seems to me that the `lazy_import` with deprecation capability is misnamed since "lazy import" itself has nothing to do with deprecation. Perhaps `LazyImport` object can just have a hook to a function, which is called when import happens, and we may have `deprecated_import` that issues the deprecation warning when import happens. Thus we have `deprecated_import` separate from the plain `lazy_import`.


---

Comment by mkoeppe created at 2022-07-18 22:49:01

I don't know, I think it's just an extra feature of `lazy_import` that is activated by a keyword. I don't see anything wrong with that


---

Comment by klee created at 2022-07-19 00:33:42

Replying to [comment:20 mkoeppe]:
> I don't know, I think it's just an extra feature of `lazy_import` that is activated by a keyword. I don't see anything wrong with that.

a `lazy_import` with `deprecation` keyword is to be removed after the deprecation period while a plain `lazy_import` is to remain. What seems wrong to me is that this distinction is implicitly made by the mere presence of a keyword argument.

Anyway, this ticket looks good to me.


---

Comment by klee created at 2022-07-19 03:23:07

doctest failures due to the changed deprecation message:

```
sage -t src/sage/functions/other.py  # 1 doctest failed
sage -t src/sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py  # 1 doctest failed
sage -t src/sage/modular/modform/find_generators.py  # 2 doctests failed
sage -t src/sage/groups/matrix_gps/homset.py  # 1 doctest failed
sage -t src/sage/schemes/hyperelliptic_curves/all.py  # 4 doctests failed
sage -t src/sage/rings/all.py  # 3 doctests failed
```



---

Comment by mkoeppe created at 2022-07-19 03:40:18

Ah, I forgot about that


---

Comment by git created at 2022-07-19 04:25:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-07-19 05:45:28

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-07-19 05:45:28

LGTM.


---

Comment by mkoeppe created at 2022-07-19 05:51:47

Thank you!


---

Comment by vbraun created at 2022-08-01 20:23:01

Resolution: fixed


---

Comment by saraedum created at 2022-10-07 10:20:52

When building surface-dynamics (a Cython project that builds against sagelib) we are getting


```
  surface_dynamics/flat_surfaces/origamis/origami_dense.pyx:39:8: 'sage/structure/element.pxd' not found
```


It seems to me that Cython does not find the .pxd file anymore because the `__init__.py` in the base directory is missing now.


---

Comment by saraedum created at 2022-10-07 10:22:49

This seems to be https://github.com/cython/cython/issues/2918 essentially.


---

Comment by saraedum created at 2022-10-07 10:26:41

We could patch the cython packaged in conda-forge with https://github.com/cython/cython/pull/4918 but maybe there is some way to fix this that works for unpatched Cythons?


---

Comment by mkoeppe created at 2022-10-07 21:50:16

https://trac.sagemath.org/wiki/ReleaseTours/sage-9.7#Packagessagesage.rings...arenownamespaces
