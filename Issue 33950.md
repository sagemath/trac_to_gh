# Issue 33950: Remove src/sage/__init__.py

archive/issues_033950.json:
```json
{
    "body": "CC:  klee vdelecroix\n\nFollow-up from #33011.\n\nBecause of the complication described in #33011, we not only remove the file from the source tree but also remove it from site-packages before building sagelib.\n\nFollow-up: \n- make sagemath-standard, sage-setup depend on sagemath-environment\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34187\n\n",
    "created_at": "2022-07-15T14:25:03Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Remove src/sage/__init__.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33950",
    "user": "mkoeppe"
}
```
CC:  klee vdelecroix

Follow-up from #33011.

Because of the complication described in #33011, we not only remove the file from the source tree but also remove it from site-packages before building sagelib.

Follow-up: 
- make sagemath-standard, sage-setup depend on sagemath-environment


Issue created by migration from https://trac.sagemath.org/ticket/34187





---

archive/issue_comments_482095.json:
```json
{
    "body": "If I remove `__init__.py` from `src/sage` and `pkgs/sagemath-standard/build/lib.macosx-12-x86_64-cpython-39/sage`, then sage is built without problem, but doctest fails. Is this expected?",
    "created_at": "2022-07-15T15:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482095",
    "user": "klee"
}
```

If I remove `__init__.py` from `src/sage` and `pkgs/sagemath-standard/build/lib.macosx-12-x86_64-cpython-39/sage`, then sage is built without problem, but doctest fails. Is this expected?



---

archive/issue_comments_482096.json:
```json
{
    "body": "I'm getting\n\n```\nsage -t --random-seed=29572225487268684535188462271558972615 src/sage/misc/sageinspect.py  # 1 doctest failed\nsage -t --random-seed=29572225487268684535188462271558972615 src/sage_setup/find.py  # 13 doctests failed\nsage -t --random-seed=29572225487268684535188462271558972615 src/sage_setup/clean.py  # 4 doctests failed\nsage -t --random-seed=29572225487268684535188462271558972615 src/sage/misc/edit_module.py  # 1 doctest failed\n```\n\n----\nLast 10 new commits:",
    "created_at": "2022-07-15T16:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482096",
    "user": "mkoeppe"
}
```

I'm getting

```
sage -t --random-seed=29572225487268684535188462271558972615 src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t --random-seed=29572225487268684535188462271558972615 src/sage_setup/find.py  # 13 doctests failed
sage -t --random-seed=29572225487268684535188462271558972615 src/sage_setup/clean.py  # 4 doctests failed
sage -t --random-seed=29572225487268684535188462271558972615 src/sage/misc/edit_module.py  # 1 doctest failed
```

----
Last 10 new commits:



---

archive/issue_comments_482097.json:
```json
{
    "body": "\n```\n> /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_setup/find.py(278)_cythonized_dir()\n    276         src_dir = Path(src_dir)\n    277         sage = import_module('sage')\n--> 278         d = Path(sage.__file__).resolve().parent.parent\n    279         editable_install = d == src_dir.resolve()\n    280     if editable_install:\n```\n\nthis use of `sage.__file__` now needs to be changed",
    "created_at": "2022-07-15T16:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482097",
    "user": "mkoeppe"
}
```


```
> /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_setup/find.py(278)_cythonized_dir()
    276         src_dir = Path(src_dir)
    277         sage = import_module('sage')
--> 278         d = Path(sage.__file__).resolve().parent.parent
    279         editable_install = d == src_dir.resolve()
    280     if editable_install:
```

this use of `sage.__file__` now needs to be changed



---

archive/issue_comments_482098.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-15T16:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482098",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482099.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-15T16:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482099",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482100.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-15T16:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482100",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482101.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-15T16:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482101",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_482102.json:
```json
{
    "body": "Perhaps we have to respect the deprecation period of `isfunction()` defined in `sage` and deprecated by #32479. It ends after two months from now.",
    "created_at": "2022-07-15T22:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482102",
    "user": "klee"
}
```

Perhaps we have to respect the deprecation period of `isfunction()` defined in `sage` and deprecated by #32479. It ends after two months from now.



---

archive/issue_comments_482103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-16T15:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482103",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482104.json:
```json
{
    "body": "Sorry for pointing to a minor thing, but the deprecation message is somewhat misleading as the function in `sage.misc.sageinspect` is `is_function_or_cython_function`. \n\n```\nsage: isfunction(f)\n<ipython-input-3-631f9d828a9a>:1: DeprecationWarning: \nImporting isfunction from here is deprecated. If you need to use it, please import\n it directly from sage.misc.sageinspect\nSee https://trac.sagemath.org/32479 for details.\n  isfunction(f)\nTrue\nsage: from sage.misc.sageinspect import isfunction\n---------------------------------------------------------------------------\nImportError                               Traceback (most recent call last)\n<ipython-input-4-53c0fed64cdc> in <module>\n----> 1 from sage.misc.sageinspect import isfunction\n\nImportError: cannot import name 'isfunction' from 'sage.misc.sageinspect' (/Users/kwankyu/GitHub/sage-temp/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/sageinspect.py)\n```\n",
    "created_at": "2022-07-18T11:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482104",
    "user": "klee"
}
```

Sorry for pointing to a minor thing, but the deprecation message is somewhat misleading as the function in `sage.misc.sageinspect` is `is_function_or_cython_function`. 

```
sage: isfunction(f)
<ipython-input-3-631f9d828a9a>:1: DeprecationWarning: 
Importing isfunction from here is deprecated. If you need to use it, please import
 it directly from sage.misc.sageinspect
See https://trac.sagemath.org/32479 for details.
  isfunction(f)
True
sage: from sage.misc.sageinspect import isfunction
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
<ipython-input-4-53c0fed64cdc> in <module>
----> 1 from sage.misc.sageinspect import isfunction

ImportError: cannot import name 'isfunction' from 'sage.misc.sageinspect' (/Users/kwankyu/GitHub/sage-temp/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/sageinspect.py)
```




---

archive/issue_comments_482105.json:
```json
{
    "body": "Perhaps moving `isfunction` in `sage.__init__.py` to `sage.all` is a solution?",
    "created_at": "2022-07-18T11:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482105",
    "user": "klee"
}
```

Perhaps moving `isfunction` in `sage.__init__.py` to `sage.all` is a solution?



---

archive/issue_comments_482106.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-18T17:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482106",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482107.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-18T17:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482107",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_482108.json:
```json
{
    "body": "I've implemented a more general solution:\n\n```\nsage: from sage import isfunction\nsage: isfunction\n/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/repl/display/fancy_repr.py:272: DeprecationWarning: \nImporting isfunction from here is deprecated; please use \"from sage.misc.sageinspect import is_function_or_cython_function as isfunction\" instead.\nSee https://trac.sagemath.org/32479 for details.\n  output = repr(obj)\n<function is_function_or_cython_function at 0x10f957ee0>\n```\n",
    "created_at": "2022-07-18T17:37:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482108",
    "user": "mkoeppe"
}
```

I've implemented a more general solution:

```
sage: from sage import isfunction
sage: isfunction
/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/repl/display/fancy_repr.py:272: DeprecationWarning: 
Importing isfunction from here is deprecated; please use "from sage.misc.sageinspect import is_function_or_cython_function as isfunction" instead.
See https://trac.sagemath.org/32479 for details.
  output = repr(obj)
<function is_function_or_cython_function at 0x10f957ee0>
```




---

archive/issue_comments_482109.json:
```json
{
    "body": "That is a right solution. Thanks.\n\nAs a side remark, it seems to me that the `lazy_import` with deprecation capability is misnamed since \"lazy import\" itself has nothing to do with deprecation. Perhaps `LazyImport` object can just have a hook to a function, which is called when import happens, and we may have `deprecated_import` that issues the deprecation warning when import happens. Thus we have `deprecated_import` separate from the plain `lazy_import`.",
    "created_at": "2022-07-18T22:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482109",
    "user": "klee"
}
```

That is a right solution. Thanks.

As a side remark, it seems to me that the `lazy_import` with deprecation capability is misnamed since "lazy import" itself has nothing to do with deprecation. Perhaps `LazyImport` object can just have a hook to a function, which is called when import happens, and we may have `deprecated_import` that issues the deprecation warning when import happens. Thus we have `deprecated_import` separate from the plain `lazy_import`.



---

archive/issue_comments_482110.json:
```json
{
    "body": "I don't know, I think it's just an extra feature of `lazy_import` that is activated by a keyword. I don't see anything wrong with that",
    "created_at": "2022-07-18T22:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482110",
    "user": "mkoeppe"
}
```

I don't know, I think it's just an extra feature of `lazy_import` that is activated by a keyword. I don't see anything wrong with that



---

archive/issue_comments_482111.json:
```json
{
    "body": "Replying to [comment:20 mkoeppe]:\n> I don't know, I think it's just an extra feature of `lazy_import` that is activated by a keyword. I don't see anything wrong with that.\n\na `lazy_import` with `deprecation` keyword is to be removed after the deprecation period while a plain `lazy_import` is to remain. What seems wrong to me is that this distinction is implicitly made by the mere presence of a keyword argument.\n\nAnyway, this ticket looks good to me.",
    "created_at": "2022-07-19T00:33:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482111",
    "user": "klee"
}
```

Replying to [comment:20 mkoeppe]:
> I don't know, I think it's just an extra feature of `lazy_import` that is activated by a keyword. I don't see anything wrong with that.

a `lazy_import` with `deprecation` keyword is to be removed after the deprecation period while a plain `lazy_import` is to remain. What seems wrong to me is that this distinction is implicitly made by the mere presence of a keyword argument.

Anyway, this ticket looks good to me.



---

archive/issue_comments_482112.json:
```json
{
    "body": "doctest failures due to the changed deprecation message:\n\n```\nsage -t src/sage/functions/other.py  # 1 doctest failed\nsage -t src/sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py  # 1 doctest failed\nsage -t src/sage/modular/modform/find_generators.py  # 2 doctests failed\nsage -t src/sage/groups/matrix_gps/homset.py  # 1 doctest failed\nsage -t src/sage/schemes/hyperelliptic_curves/all.py  # 4 doctests failed\nsage -t src/sage/rings/all.py  # 3 doctests failed\n```\n",
    "created_at": "2022-07-19T03:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482112",
    "user": "klee"
}
```

doctest failures due to the changed deprecation message:

```
sage -t src/sage/functions/other.py  # 1 doctest failed
sage -t src/sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py  # 1 doctest failed
sage -t src/sage/modular/modform/find_generators.py  # 2 doctests failed
sage -t src/sage/groups/matrix_gps/homset.py  # 1 doctest failed
sage -t src/sage/schemes/hyperelliptic_curves/all.py  # 4 doctests failed
sage -t src/sage/rings/all.py  # 3 doctests failed
```




---

archive/issue_comments_482113.json:
```json
{
    "body": "Ah, I forgot about that",
    "created_at": "2022-07-19T03:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482113",
    "user": "mkoeppe"
}
```

Ah, I forgot about that



---

archive/issue_comments_482114.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-19T04:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482114",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482115.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-19T05:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482115",
    "user": "klee"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_482116.json:
```json
{
    "body": "LGTM.",
    "created_at": "2022-07-19T05:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482116",
    "user": "klee"
}
```

LGTM.



---

archive/issue_comments_482117.json:
```json
{
    "body": "Thank you!",
    "created_at": "2022-07-19T05:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482117",
    "user": "mkoeppe"
}
```

Thank you!



---

archive/issue_comments_482118.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-01T20:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482118",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_482119.json:
```json
{
    "body": "When building surface-dynamics (a Cython project that builds against sagelib) we are getting\n\n\n```\n  surface_dynamics/flat_surfaces/origamis/origami_dense.pyx:39:8: 'sage/structure/element.pxd' not found\n```\n\n\nIt seems to me that Cython does not find the .pxd file anymore because the `__init__.py` in the base directory is missing now.",
    "created_at": "2022-10-07T10:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482119",
    "user": "saraedum"
}
```

When building surface-dynamics (a Cython project that builds against sagelib) we are getting


```
  surface_dynamics/flat_surfaces/origamis/origami_dense.pyx:39:8: 'sage/structure/element.pxd' not found
```


It seems to me that Cython does not find the .pxd file anymore because the `__init__.py` in the base directory is missing now.



---

archive/issue_comments_482120.json:
```json
{
    "body": "This seems to be https://github.com/cython/cython/issues/2918 essentially.",
    "created_at": "2022-10-07T10:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482120",
    "user": "saraedum"
}
```

This seems to be https://github.com/cython/cython/issues/2918 essentially.



---

archive/issue_comments_482121.json:
```json
{
    "body": "We could patch the cython packaged in conda-forge with https://github.com/cython/cython/pull/4918 but maybe there is some way to fix this that works for unpatched Cythons?",
    "created_at": "2022-10-07T10:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482121",
    "user": "saraedum"
}
```

We could patch the cython packaged in conda-forge with https://github.com/cython/cython/pull/4918 but maybe there is some way to fix this that works for unpatched Cythons?



---

archive/issue_comments_482122.json:
```json
{
    "body": "https://trac.sagemath.org/wiki/ReleaseTours/sage-9.7#Packagessagesage.rings...arenownamespaces",
    "created_at": "2022-10-07T21:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33950",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33950#issuecomment-482122",
    "user": "mkoeppe"
}
```

https://trac.sagemath.org/wiki/ReleaseTours/sage-9.7#Packagessagesage.rings...arenownamespaces
