# Issue 21133: Multigraph plot and error with edge_colors

Issue created by migration from https://trac.sagemath.org/ticket/21370

Original creator: jmantysalo

Original creation time: 2016-08-30 09:25:07

CC:  paulmasson

This shows third edge:


```
g = Graph(); g.allow_multiple_edges(True)
g.add_edge(0, 1); g.add_edge(0, 1)
g.show(edge_colors={'red': [(0, 1)]})
```


It is propably my error in some former ticket.


---

Comment by paulmasson created at 2016-08-30 23:24:17

Jori, it wasn't your doing: bad indentation from 2009. This should fix the problem.
----
New commits:


---

Comment by paulmasson created at 2016-08-30 23:24:17

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2016-08-31 05:09:48

Replying to [comment:2 paulmasson]:
>This should fix the problem.

It does, and I can give it a positive review if you want. However, there is another bug, see direction of arrows:


```
g = DiGraph(); g.allow_multiple_edges(True)
g.add_edge(0, 1); g.add_edge(1, 0)
g.show(edge_colors={'red': [(0, 1)]})
g.show()
```


After your patch this will become a one arrow only, so there is bug in both with and without this patch. Do you want to look at that, or want me to make that another ticket?


---

Comment by git created at 2016-08-31 21:49:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2016-08-31 22:00:04

The additional error you identified arises because currently unspecificed edges are first sorted by vertex and then tested against specified edges by edge label. If there are no edge labels then unspecified edges with the same vertices as those already specified will be ignored.

I replaced the test by labels with a test against an explicit list of edges already drawn. That should be more robust, but please test it in all the ways you can imagine.

I've also taken out the code you put in for #21053 because the default edge color is always available from the default options. This makes the code more consistent.


---

Comment by jmantysalo created at 2016-09-01 03:51:25

Now this fails:


```
g = DiGraph();
g.add_edge(0, 1); g.add_edge(1, 0)
g.show(edge_colors={'red': [(0, 1)]})
```


It works with `g.allow_multiple_edges(True)`.

I can try to get more failing examples today.


---

Comment by git created at 2016-09-04 00:32:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2016-09-04 00:39:13

Jori, try testing this update please. The last error was caused because the value returned by `self._graph.edge_label` on line 634(old)/641(new) changes depending on whether `allow_multiple_edges()` is true or false.

To clean up the code I've added the method `append_or_set()`, since the same test against `edges_to_draw[]` occurs five times.


---

Comment by git created at 2016-09-04 01:13:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2016-09-04 01:15:57

There is an example in #21368 that was not covered by the last commit. It should be covered now.


---

Comment by jmantysalo created at 2016-09-05 08:01:34

Fails with


```
x = 101; y = 102
g = DiGraph(multiedges=True)
g.add_edge(0, 1, x); g.add_edge(0, 1, x); g.add_edge(0, 1, y); 
g.show(edge_colors={'red': [(0, 1, x)]})
```



---

Comment by jmantysalo created at 2016-09-05 09:10:15

However, this patch seems to correct some bugs. So, if you want, I can check the patch so you can open another ticket for remaining bugs.


---

Comment by git created at 2016-09-09 01:12:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2016-09-09 01:14:01

That should cover the latest failing case. Any others?


---

Comment by jmantysalo created at 2016-09-09 07:14:49

It gets harder to found bugs in every round, so I guess this will converge to bug-free code. `:=)`. But should this still be seen as a bug:


```
g = DiGraph(loops=True)
g.add_edge(0, 1); g.add_edge(0, 2); g.add_edge(0, 0)
g.show(edge_colors={'red': [(0, 1)], 'blue': [(0, 2, 'xxx')]})
```


It kind of makes no sense to color edge by label when `multiedges=False`, but then, why not? If someone wants to show in red exactly the edge from `1` to `2` with label `3`, if there exists one.

But as said, I can stop this for now and check the code if you want. This corrects many bugs, thanks for that!


---

Comment by git created at 2016-09-09 21:43:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2016-09-09 21:43:42

Fixed! Anything else?


---

Comment by jmantysalo created at 2016-09-10 06:22:37

Replying to [comment:17 paulmasson]:
> Fixed! Anything else?

I tried quite hard to found more errors on colors, but did not found any. I tested with and without loops, with and wihtout multiple edges, and with some options to `edge_colors`, `edge_style` and even `vertex_size`, `graph_border` and so on.

So I suppose this if perfect now. Next I'll try to understand the code. Thanks!


---

Comment by jmantysalo created at 2016-09-11 05:37:00

OK, I mark this as positive review.

I can not say that I understand every bit of the code, but it seems reasonable, I did not found errors by testing, and possible bugs won't affect other parts of Sage.


---

Comment by jmantysalo created at 2016-09-11 05:37:00

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2016-09-11 20:09:52

patchbot is not happy at all..


---

Comment by paulmasson created at 2016-09-11 20:37:39

Changing status from positive_review to needs_work.


---

Comment by paulmasson created at 2016-09-11 20:37:39

I'm seeing failed doctests in patchbot logs. Does anything other than that need to be addressed?


---

Comment by git created at 2016-09-12 00:25:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2016-09-12 00:28:31

Changing status from needs_work to needs_review.


---

Comment by paulmasson created at 2016-09-12 00:28:31

Doctests should all be fixed. Jori, please test the examples in the previously failing doctests.


---

Comment by jmantysalo created at 2016-09-12 05:32:49

Changing status from needs_review to positive_review.


---

Comment by jmantysalo created at 2016-09-12 05:32:49

Doctests passed.


---

Comment by vbraun created at 2016-09-16 06:55:19

Resolution: fixed
