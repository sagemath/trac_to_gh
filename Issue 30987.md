# Issue 30987: Add surface-dynamics as a pip package

archive/issues_030987.json:
```json
{
    "body": "CC:  mkoeppe\n\nSee #31164. Upstream code at https://gitlab.com/videlec/surface_dynamics\n\nIssue created by migration from https://trac.sagemath.org/ticket/31224\n\n",
    "created_at": "2021-01-12T10:24:58Z",
    "labels": [
        "packages: optional",
        "major",
        "enhancement"
    ],
    "title": "Add surface-dynamics as a pip package",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30987",
    "user": "vdelecroix"
}
```
CC:  mkoeppe

See #31164. Upstream code at https://gitlab.com/videlec/surface_dynamics

Issue created by migration from https://trac.sagemath.org/ticket/31224





---

archive/issue_comments_442481.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-12T10:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442481",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_442482.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-01-12T10:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442482",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_442483.json:
```json
{
    "body": "Please change SPKG.txt to SPKG.rst; also the title should start with `surface_dynamics` (underscore, not dash -- this is the SPKG name)\n\nAnd a `requirements.txt` file needs to be added - see https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types",
    "created_at": "2021-01-12T17:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442483",
    "user": "mkoeppe"
}
```

Please change SPKG.txt to SPKG.rst; also the title should start with `surface_dynamics` (underscore, not dash -- this is the SPKG name)

And a `requirements.txt` file needs to be added - see https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types



---

archive/issue_comments_442484.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-12T20:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442484",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_442485.json:
```json
{
    "body": "Thanks. Done.",
    "created_at": "2021-01-12T20:39:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442485",
    "user": "vdelecroix"
}
```

Thanks. Done.



---

archive/issue_comments_442486.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-12T22:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442486",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442487.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-01-16T16:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442487",
    "user": "mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_442488.json:
```json
{
    "body": "This (and probably other packages just added) will need additional dependencies - see https://github.com/mkoeppe/sage/runs/1712141788?check_suite_focus=true\n\n```\n[surface_dynamics] installing. Log file: /sage/logs/pkgs/surface_dynamics.log\n  [surface_dynamics] error installing, exit status 1. End of log file:\n  [surface_dynamics]   Collecting surface_dynamics\n  [surface_dynamics]     Downloading surface_dynamics-0.4.5.tar.gz (11.3 MB)\n  [surface_dynamics]       ERROR: Command errored out with exit status 1:\n  [surface_dynamics]        command: /sage/local/bin/python3 -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py'\"'\"'; __file__='\"'\"'/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' egg_info --egg-base /tmp/pip-pip-egg-info-0g71blv2\n  [surface_dynamics]            cwd: /tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/\n  [surface_dynamics]       Complete output (15 lines):\n  [surface_dynamics]       Traceback (most recent call last):\n  [surface_dynamics]         File \"/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py\", line 8, in <module>\n  [surface_dynamics]           import sage.all\n  [surface_dynamics]       ModuleNotFoundError: No module named 'sage'\n  [surface_dynamics]       \n  [surface_dynamics]       During handling of the above exception, another exception occurred:\n  [surface_dynamics]       \n  [surface_dynamics]       Traceback (most recent call last):\n  [surface_dynamics]         File \"<string>\", line 1, in <module>\n  [surface_dynamics]         File \"/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py\", line 10, in <module>\n  [surface_dynamics]           raise ValueError(\"this package currently installs only inside SageMath (http://www.sagemath.org)\\n\"\n  [surface_dynamics]       ValueError: this package currently installs only inside SageMath (http://www.sagemath.org)\n  [surface_dynamics]       If you are using Ubuntu with Sage installed from the official apt repository, run\n  [surface_dynamics]       first in a console \"$ source /usr/share/sagemath/bin/sage-env\"\n  [surface_dynamics]       \n  [surface_dynamics]       ----------------------------------------\n  [surface_dynamics]   ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.\n```\n",
    "created_at": "2021-01-16T16:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442488",
    "user": "mkoeppe"
}
```

This (and probably other packages just added) will need additional dependencies - see https://github.com/mkoeppe/sage/runs/1712141788?check_suite_focus=true

```
[surface_dynamics] installing. Log file: /sage/logs/pkgs/surface_dynamics.log
  [surface_dynamics] error installing, exit status 1. End of log file:
  [surface_dynamics]   Collecting surface_dynamics
  [surface_dynamics]     Downloading surface_dynamics-0.4.5.tar.gz (11.3 MB)
  [surface_dynamics]       ERROR: Command errored out with exit status 1:
  [surface_dynamics]        command: /sage/local/bin/python3 -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py'"'"'; __file__='"'"'/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' egg_info --egg-base /tmp/pip-pip-egg-info-0g71blv2
  [surface_dynamics]            cwd: /tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/
  [surface_dynamics]       Complete output (15 lines):
  [surface_dynamics]       Traceback (most recent call last):
  [surface_dynamics]         File "/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py", line 8, in <module>
  [surface_dynamics]           import sage.all
  [surface_dynamics]       ModuleNotFoundError: No module named 'sage'
  [surface_dynamics]       
  [surface_dynamics]       During handling of the above exception, another exception occurred:
  [surface_dynamics]       
  [surface_dynamics]       Traceback (most recent call last):
  [surface_dynamics]         File "<string>", line 1, in <module>
  [surface_dynamics]         File "/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py", line 10, in <module>
  [surface_dynamics]           raise ValueError("this package currently installs only inside SageMath (http://www.sagemath.org)\n"
  [surface_dynamics]       ValueError: this package currently installs only inside SageMath (http://www.sagemath.org)
  [surface_dynamics]       If you are using Ubuntu with Sage installed from the official apt repository, run
  [surface_dynamics]       first in a console "$ source /usr/share/sagemath/bin/sage-env"
  [surface_dynamics]       
  [surface_dynamics]       ----------------------------------------
  [surface_dynamics]   ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
```




---

archive/issue_comments_442489.json:
```json
{
    "body": "How do I set sage Python library as a dependency!?",
    "created_at": "2021-01-16T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442489",
    "user": "vdelecroix"
}
```

How do I set sage Python library as a dependency!?



---

archive/issue_comments_442490.json:
```json
{
    "body": "For this very specific package, it is needed at install time (Cython compilation). For pure Python it will only be a runtime dependency.",
    "created_at": "2021-01-16T17:01:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442490",
    "user": "vdelecroix"
}
```

For this very specific package, it is needed at install time (Cython compilation). For pure Python it will only be a runtime dependency.



---

archive/issue_comments_442491.json:
```json
{
    "body": "I think an order-only dependency on `$(SAGE_RUNTIME)` will do the trick.\nSee `build/pkgs/sage_numerical_backends_coin/dependencies` for an example.",
    "created_at": "2021-01-16T17:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442491",
    "user": "mkoeppe"
}
```

I think an order-only dependency on `$(SAGE_RUNTIME)` will do the trick.
See `build/pkgs/sage_numerical_backends_coin/dependencies` for an example.



---

archive/issue_comments_442492.json:
```json
{
    "body": "It is written `$(SAGERUNTIME)` in this file, not `$(SAGE_RUNTIME)`... Where is it misspelled?",
    "created_at": "2021-01-16T17:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442492",
    "user": "vdelecroix"
}
```

It is written `$(SAGERUNTIME)` in this file, not `$(SAGE_RUNTIME)`... Where is it misspelled?



---

archive/issue_comments_442493.json:
```json
{
    "body": "`SAGERUNTIME` is correct. Sorry for the confusion",
    "created_at": "2021-01-16T17:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442493",
    "user": "mkoeppe"
}
```

`SAGERUNTIME` is correct. Sorry for the confusion



---

archive/issue_comments_442494.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-16T17:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442494",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442495.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-16T17:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442495",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_442496.json:
```json
{
    "body": "Wouldn't it be safer with a normal dependency? Namely I have Cython inheritance there. If a Cython object such as `sage.structure.element.Element` is changed in the Sage library, it might end up with wrong compiled Cython code.",
    "created_at": "2021-01-16T17:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442496",
    "user": "vdelecroix"
}
```

Wouldn't it be safer with a normal dependency? Namely I have Cython inheritance there. If a Cython object such as `sage.structure.element.Element` is changed in the Sage library, it might end up with wrong compiled Cython code.



---

archive/issue_comments_442497.json:
```json
{
    "body": "The problem with a normal dependency is that `sagelib` is always built (dependency on `FORCE` in `build/pkgs/sagelib/dependencies`), which would trigger an unconditional rebuild of this package. That's why I have included a number of key sage source files in `build/pkgs/sage_numerical_backends_coin/dependencies`. (See #29711 for a related discussion)",
    "created_at": "2021-01-16T17:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442497",
    "user": "mkoeppe"
}
```

The problem with a normal dependency is that `sagelib` is always built (dependency on `FORCE` in `build/pkgs/sagelib/dependencies`), which would trigger an unconditional rebuild of this package. That's why I have included a number of key sage source files in `build/pkgs/sage_numerical_backends_coin/dependencies`. (See #29711 for a related discussion)



---

archive/issue_comments_442498.json:
```json
{
    "body": "Great: `$(SAGE_SRC)/sage/cpython/string.pxd` is allowed!",
    "created_at": "2021-01-16T18:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442498",
    "user": "vdelecroix"
}
```

Great: `$(SAGE_SRC)/sage/cpython/string.pxd` is allowed!



---

archive/issue_comments_442499.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-16T18:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442499",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_442500.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-16T18:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442500",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_442501.json:
```json
{
    "body": "Looking great.",
    "created_at": "2021-01-16T18:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442501",
    "user": "mkoeppe"
}
```

Looking great.



---

archive/issue_comments_442502.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-24T10:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30987",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30987#issuecomment-442502",
    "user": "vbraun"
}
```

Resolution: fixed
