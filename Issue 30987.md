# Issue 30987: Add surface-dynamics as a pip package

Issue created by migration from https://trac.sagemath.org/ticket/31224

Original creator: vdelecroix

Original creation time: 2021-01-12 10:24:58

CC:  mkoeppe

See #31164. Upstream code at https://gitlab.com/videlec/surface_dynamics


---

Comment by vdelecroix created at 2021-01-12 10:34:01

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2021-01-12 10:34:01

New commits:


---

Comment by mkoeppe created at 2021-01-12 17:08:31

Please change SPKG.txt to SPKG.rst; also the title should start with `surface_dynamics` (underscore, not dash -- this is the SPKG name)

And a `requirements.txt` file needs to be added - see https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types


---

Comment by git created at 2021-01-12 20:35:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2021-01-12 20:39:05

Thanks. Done.


---

Comment by mkoeppe created at 2021-01-12 22:43:44

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-01-16 16:47:50

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-01-16 16:47:50

This (and probably other packages just added) will need additional dependencies - see https://github.com/mkoeppe/sage/runs/1712141788?check_suite_focus=true

```
[surface_dynamics] installing. Log file: /sage/logs/pkgs/surface_dynamics.log
  [surface_dynamics] error installing, exit status 1. End of log file:
  [surface_dynamics]   Collecting surface_dynamics
  [surface_dynamics]     Downloading surface_dynamics-0.4.5.tar.gz (11.3 MB)
  [surface_dynamics]       ERROR: Command errored out with exit status 1:
  [surface_dynamics]        command: /sage/local/bin/python3 -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py'"'"'; __file__='"'"'/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' egg_info --egg-base /tmp/pip-pip-egg-info-0g71blv2
  [surface_dynamics]            cwd: /tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/
  [surface_dynamics]       Complete output (15 lines):
  [surface_dynamics]       Traceback (most recent call last):
  [surface_dynamics]         File "/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py", line 8, in <module>
  [surface_dynamics]           import sage.all
  [surface_dynamics]       ModuleNotFoundError: No module named 'sage'
  [surface_dynamics]       
  [surface_dynamics]       During handling of the above exception, another exception occurred:
  [surface_dynamics]       
  [surface_dynamics]       Traceback (most recent call last):
  [surface_dynamics]         File "<string>", line 1, in <module>
  [surface_dynamics]         File "/tmp/pip-install-09x74vlr/surface-dynamics_62aa1d77ac5249259cfc2622814d3adf/setup.py", line 10, in <module>
  [surface_dynamics]           raise ValueError("this package currently installs only inside SageMath (http://www.sagemath.org)\n"
  [surface_dynamics]       ValueError: this package currently installs only inside SageMath (http://www.sagemath.org)
  [surface_dynamics]       If you are using Ubuntu with Sage installed from the official apt repository, run
  [surface_dynamics]       first in a console "$ source /usr/share/sagemath/bin/sage-env"
  [surface_dynamics]       
  [surface_dynamics]       ----------------------------------------
  [surface_dynamics]   ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
```



---

Comment by vdelecroix created at 2021-01-16 17:00:47

How do I set sage Python library as a dependency!?


---

Comment by vdelecroix created at 2021-01-16 17:01:24

For this very specific package, it is needed at install time (Cython compilation). For pure Python it will only be a runtime dependency.


---

Comment by mkoeppe created at 2021-01-16 17:09:39

I think an order-only dependency on `$(SAGE_RUNTIME)` will do the trick.
See `build/pkgs/sage_numerical_backends_coin/dependencies` for an example.


---

Comment by vdelecroix created at 2021-01-16 17:21:35

It is written `$(SAGERUNTIME)` in this file, not `$(SAGE_RUNTIME)`... Where is it misspelled?


---

Comment by mkoeppe created at 2021-01-16 17:24:55

`SAGERUNTIME` is correct. Sorry for the confusion


---

Comment by git created at 2021-01-16 17:26:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-01-16 17:26:42

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2021-01-16 17:28:45

Wouldn't it be safer with a normal dependency? Namely I have Cython inheritance there. If a Cython object such as `sage.structure.element.Element` is changed in the Sage library, it might end up with wrong compiled Cython code.


---

Comment by mkoeppe created at 2021-01-16 17:39:55

The problem with a normal dependency is that `sagelib` is always built (dependency on `FORCE` in `build/pkgs/sagelib/dependencies`), which would trigger an unconditional rebuild of this package. That's why I have included a number of key sage source files in `build/pkgs/sage_numerical_backends_coin/dependencies`. (See #29711 for a related discussion)


---

Comment by vdelecroix created at 2021-01-16 18:00:19

Great: `$(SAGE_SRC)/sage/cpython/string.pxd` is allowed!


---

Comment by git created at 2021-01-16 18:06:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-16 18:10:47

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-01-16 18:10:47

Looking great.


---

Comment by vbraun created at 2021-01-24 10:37:16

Resolution: fixed
