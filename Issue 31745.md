# Issue 31745: MultiCoordFunction: Make it the element class of the free module over ChartFunctionRing

archive/issues_031745.json:
```json
{
    "body": "CC:  @egourgoulhon @mjungmath @tscrim\n\nCurrently, `MultiCoordFunction` is not an element class.\n\n```\nsage: M = Manifold(2, 'M', structure='topological')\nsage: X.<x,y> = M.chart()\nsage: FR = X.function_ring()\nsage: f = X.multifunction(x+y, sin(x*y), x^2 + 3*y); f\nCoordinate functions (x + y, sin(x*y), x^2 + 3*y) on the Chart (M, (x, y))\nsage: f.parent()\n<class 'sage.manifolds.chart_func.MultiCoordFunction'>\nsage: FR^3                                                 # with #31721\nAmbient free module of rank 3 over Ring of chart functions on Chart (M, (x, y))\nsage: f in FR^3\nFalse\n```\n\n\nWe change the function `sage.modules.free_module.element_class` so that it uses the element class `Vector_symbolic_dense` not only for free modules over the ring `SR` but also for free modules over any commutative ring whose base ring is `SR`.\n\nThis makes the elementwise symbolic methods `simplify` etc. available.\n\nWe make `MultiCoordFunction` a subclass of `Vector_symbolic_dense`, moving the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.\n\nFinally, we create a parent class `MultiCoordFunctionModule` (subclassing `FreeModule_ambient`) with element class `MultiCoordFunction`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31982\n\n",
    "created_at": "2021-06-14T01:27:38Z",
    "labels": [
        "component: manifolds"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "MultiCoordFunction: Make it the element class of the free module over ChartFunctionRing",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31745",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @egourgoulhon @mjungmath @tscrim

Currently, `MultiCoordFunction` is not an element class.

```
sage: M = Manifold(2, 'M', structure='topological')
sage: X.<x,y> = M.chart()
sage: FR = X.function_ring()
sage: f = X.multifunction(x+y, sin(x*y), x^2 + 3*y); f
Coordinate functions (x + y, sin(x*y), x^2 + 3*y) on the Chart (M, (x, y))
sage: f.parent()
<class 'sage.manifolds.chart_func.MultiCoordFunction'>
sage: FR^3                                                 # with #31721
Ambient free module of rank 3 over Ring of chart functions on Chart (M, (x, y))
sage: f in FR^3
False
```


We change the function `sage.modules.free_module.element_class` so that it uses the element class `Vector_symbolic_dense` not only for free modules over the ring `SR` but also for free modules over any commutative ring whose base ring is `SR`.

This makes the elementwise symbolic methods `simplify` etc. available.

We make `MultiCoordFunction` a subclass of `Vector_symbolic_dense`, moving the method `MultiCoordFunction.jacobian` to the superclass, making it more generally available.

Finally, we create a parent class `MultiCoordFunctionModule` (subclassing `FreeModule_ambient`) with element class `MultiCoordFunction`.

Issue created by migration from https://trac.sagemath.org/ticket/31982





---

archive/issue_comments_453026.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T02:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453026",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453027.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T03:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453027",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453028.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T03:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453028",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453029.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T05:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453029",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453030.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T05:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453030",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453031.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T06:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453032.json:
```json
{
    "body": "Looks nice. However, the pickling of continuous maps fails with the new code for `MultiCoordFunction`. More precisely, the equality test of the pickling fails when attempting to compare the `MultiCoordFunction`'s describing the continuous maps is a given pair of charts, with the error\n\n```\nFile \"/home/eric/sage/9.4.develop/local/lib/python3.8/site-packages/sage/manifolds/continuous_map.py\", \nline 577, in __eq__\n...\nAttributeError: 'sage.modules.free_module_element.FreeModuleElement_generic_dense'\nobject  has no attribute 'expr'\n```\n",
    "created_at": "2021-06-14T20:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453032",
    "user": "https://github.com/egourgoulhon"
}
```

Looks nice. However, the pickling of continuous maps fails with the new code for `MultiCoordFunction`. More precisely, the equality test of the pickling fails when attempting to compare the `MultiCoordFunction`'s describing the continuous maps is a given pair of charts, with the error

```
File "/home/eric/sage/9.4.develop/local/lib/python3.8/site-packages/sage/manifolds/continuous_map.py", 
line 577, in __eq__
...
AttributeError: 'sage.modules.free_module_element.FreeModuleElement_generic_dense'
object  has no attribute 'expr'
```




---

archive/issue_comments_453033.json:
```json
{
    "body": "Thanks for taking a look! Because of these errors I hadn't set the ticket to \"needs review\" yet. I'll revise it in the next few days, but help is welcome.",
    "created_at": "2021-06-14T21:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453033",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for taking a look! Because of these errors I hadn't set the ticket to "needs review" yet. I'll revise it in the next few days, but help is welcome.



---

archive/issue_comments_453034.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-14T23:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453034",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453035.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-14T23:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453035",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_453036.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-16T06:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453036",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_453037.json:
```json
{
    "body": "\n```\nsage -t --long --random-seed=0 src/sage/algebras/lie_algebras/quotient.py  # 1 doctest failed\nsage -t --long --random-seed=0 src/sage/modules/free_module_element.pyx  # 1 doctest failed\n```\n",
    "created_at": "2021-06-16T06:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453037",
    "user": "https://github.com/mkoeppe"
}
```


```
sage -t --long --random-seed=0 src/sage/algebras/lie_algebras/quotient.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/modules/free_module_element.pyx  # 1 doctest failed
```




---

archive/issue_comments_453038.json:
```json
{
    "body": "I think I could use some help from a pickling expert here...",
    "created_at": "2021-06-16T15:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453038",
    "user": "https://github.com/mkoeppe"
}
```

I think I could use some help from a pickling expert here...



---

archive/issue_comments_453039.json:
```json
{
    "body": "I bet this is related to #31182.",
    "created_at": "2021-06-16T16:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453039",
    "user": "https://github.com/mjungmath"
}
```

I bet this is related to #31182.



---

archive/issue_comments_453040.json:
```json
{
    "body": "Okay, maybe not.",
    "created_at": "2021-06-16T16:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453040",
    "user": "https://github.com/mjungmath"
}
```

Okay, maybe not.



---

archive/issue_comments_453041.json:
```json
{
    "body": "Replying to [comment:13 mkoeppe]:\n> I think I could use some help from a pickling expert here...\n\nSorry I am definitely not such an expert and therefore cannot offer help here. Instead, let me ask about the motivation of this ticket. I understand that, from a mathematical point of view, `MultiCoordFunction`'s belong to the free module `FR^n` (`FR` being the ring of chart functions associated to a given chart and `n` the manifold's dimension) and that implementing this simplifies (a little) the code by relying on some code already implemented for `Vector_symbolic_dense`. This, by itself, is a motivation. However, I would say this is not a strong one, because no use is made in the manifold code of the *module* structure of the set of `MultiCoordFunction`'s over a given chart. Indeed, in the current implementation, the class `MultiCoordFunction` is used only to store\n\n1. the coordinate expression of a continous map in a given pair of charts;\n2. the transition map between two charts.\n\nIn both cases, there is no meaning in the basic module operations `m1 + m2` and `f*m1`, where `m1` and `m2` are two `MultiCoordFunction`'s and `f` is a chart function. Hence, the motivation to provide a parent with a module structure seems pretty weak, given the current use of the class `MultiCoordFunction`. So maybe it is not worth to pursue the effort and keep `MultiCoordFunction` as a simple technical storage class (by opposition to a \"mathematical\" class), not relying on sophisticated parts of Sage, with complicated pickling and possibly less efficient in terms of CPU time.",
    "created_at": "2021-06-16T18:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453041",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:13 mkoeppe]:
> I think I could use some help from a pickling expert here...

Sorry I am definitely not such an expert and therefore cannot offer help here. Instead, let me ask about the motivation of this ticket. I understand that, from a mathematical point of view, `MultiCoordFunction`'s belong to the free module `FR^n` (`FR` being the ring of chart functions associated to a given chart and `n` the manifold's dimension) and that implementing this simplifies (a little) the code by relying on some code already implemented for `Vector_symbolic_dense`. This, by itself, is a motivation. However, I would say this is not a strong one, because no use is made in the manifold code of the *module* structure of the set of `MultiCoordFunction`'s over a given chart. Indeed, in the current implementation, the class `MultiCoordFunction` is used only to store

1. the coordinate expression of a continous map in a given pair of charts;
2. the transition map between two charts.

In both cases, there is no meaning in the basic module operations `m1 + m2` and `f*m1`, where `m1` and `m2` are two `MultiCoordFunction`'s and `f` is a chart function. Hence, the motivation to provide a parent with a module structure seems pretty weak, given the current use of the class `MultiCoordFunction`. So maybe it is not worth to pursue the effort and keep `MultiCoordFunction` as a simple technical storage class (by opposition to a "mathematical" class), not relying on sophisticated parts of Sage, with complicated pickling and possibly less efficient in terms of CPU time.



---

archive/issue_comments_453042.json:
```json
{
    "body": "My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). If another class is better suited for this, I'd be interested to know.\n\nSome fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.",
    "created_at": "2021-06-16T18:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453042",
    "user": "https://github.com/mkoeppe"
}
```

My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). If another class is better suited for this, I'd be interested to know.

Some fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.



---

archive/issue_comments_453043.json:
```json
{
    "body": "Regarding the pickling, can you spot after which commit the error occurred; more precisely, which lines caused it?",
    "created_at": "2021-06-16T18:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453043",
    "user": "https://github.com/mjungmath"
}
```

Regarding the pickling, can you spot after which commit the error occurred; more precisely, which lines caused it?



---

archive/issue_comments_453044.json:
```json
{
    "body": "Replying to [comment:17 mkoeppe]:\n> My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). \n\nThanks for your quick reply. This sounds a strong motivation for a module structure!\n\n>If another class is better suited for this, I'd be interested to know.\n\nWouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. \n \n> Some fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.\n\nThanks for these explanations.",
    "created_at": "2021-06-16T18:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453044",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:17 mkoeppe]:
> My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). 

Thanks for your quick reply. This sounds a strong motivation for a module structure!

>If another class is better suited for this, I'd be interested to know.

Wouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. 
 
> Some fixes here on the ticket are needed to make free module elements over the ring of coordinate functions work properly. Then I realized that `MultiCoordFunction` could just be the element class, giving some mild simplifications of the code. I agree that it is not essential to change `MultiCoordFunction` -- but whether I use that or a new class as the element class, I will need to fix the pickling of the elements.

Thanks for these explanations.



---

archive/issue_comments_453045.json:
```json
{
    "body": "Replying to [comment:19 egourgoulhon]:\n> Replying to [comment:17 mkoeppe]:\n> > My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). \n> \n> Thanks for your quick reply. This sounds a strong motivation for a module structure!\n> \n> >If another class is better suited for this, I'd be interested to know.\n> \n> Wouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. \n\nYou are probably right about this. I guess a tricky point is regarding the required smoothness of scalar fields. I like to think of the domain as a smooth manifold, but the functions that I want to define on them often are less smooth - typically only piecewise C<sup>1</sup>, with Lipschitz gradients. See for example https://www.cvxpy.org/api_reference/cvxpy.atoms.elementwise.html",
    "created_at": "2021-06-16T19:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453045",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:19 egourgoulhon]:
> Replying to [comment:17 mkoeppe]:
> > My main motivation for the present ticket is for defining (not necessarily smooth) vector-valued (and later matrix-valued #31988) functions on manifolds (for #31981). 
> 
> Thanks for your quick reply. This sounds a strong motivation for a module structure!
> 
> >If another class is better suited for this, I'd be interested to know.
> 
> Wouldn't a kind of `MultiScalarField` be better suited? In some sense, for vector-valued functions, this already exists through the class `Components`. 

You are probably right about this. I guess a tricky point is regarding the required smoothness of scalar fields. I like to think of the domain as a smooth manifold, but the functions that I want to define on them often are less smooth - typically only piecewise C<sup>1</sup>, with Lipschitz gradients. See for example https://www.cvxpy.org/api_reference/cvxpy.atoms.elementwise.html



---

archive/issue_comments_453046.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31745",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31745#issuecomment-453046",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
