# Issue 21601: Better representation of exact reals in QQbar

archive/issues_021601.json:
```json
{
    "body": "CC:  tdumont @tscrim\n\nThe following example is confusing because of the apparition of the imaginary part\n\n```\nsage: y = QQbar(cos(pi/18))\nsage: y.imag() == 0\nTrue\nsage: y\n0.9848077530122081? + 0.?e-36*I\n```\n\nThis ticket proposes to change the representation of known exact reals to be without imaginary part, that is\n\n```\nsage: y\n0.9848077530122081?\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/21838\n\n",
    "created_at": "2016-11-08T10:04:44Z",
    "labels": [
        "number theory",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Better representation of exact reals in QQbar",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21601",
    "user": "@videlec"
}
```
CC:  tdumont @tscrim

The following example is confusing because of the apparition of the imaginary part

```
sage: y = QQbar(cos(pi/18))
sage: y.imag() == 0
True
sage: y
0.9848077530122081? + 0.?e-36*I
```

This ticket proposes to change the representation of known exact reals to be without imaginary part, that is

```
sage: y
0.9848077530122081?
```


Issue created by migration from https://trac.sagemath.org/ticket/21838





---

archive/issue_comments_299884.json:
```json
{
    "body": "Possibly related: #20288.",
    "created_at": "2016-11-08T11:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299884",
    "user": "@jdemeyer"
}
```

Possibly related: #20288.



---

archive/issue_comments_299885.json:
```json
{
    "body": "The problem is directly related to the not careful enough conversion\n\n```\nsage: CIF(QQbar(cos(pi/18))).imag().is_zero()\nFalse\n```\n",
    "created_at": "2017-05-03T17:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299885",
    "user": "@videlec"
}
```

The problem is directly related to the not careful enough conversion

```
sage: CIF(QQbar(cos(pi/18))).imag().is_zero()
False
```




---

archive/issue_comments_299886.json:
```json
{
    "body": "Voil\u00e0 une tentative. Ca va probablement changer pas mal de doctests.\n----\nNew commits:",
    "created_at": "2020-08-17T19:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299886",
    "user": "@fchapoton"
}
```

VoilÃ  une tentative. Ca va probablement changer pas mal de doctests.
----
New commits:



---

archive/issue_comments_299887.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-17T19:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299887",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_299888.json:
```json
{
    "body": "Looks rather good, not so many doctest failures. And they seem to be improvements\n\n```\nsage -t --long --random-seed=0 src/sage/matrix/matrix2.pyx  # 8 doctests failed\nsage -t --long --random-seed=0 src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # 1 doctest failed\nsage -t --long --random-seed=0 src/sage/geometry/polyhedron/base.py  # 2 doctests failed\nsage -t --long --random-seed=0 src/sage/schemes/generic/algebraic_scheme.py  # 2 doctests failed\nsage -t --long --random-seed=0 src/sage/matrix/matrix0.pyx  # 1 doctest failed\nsage -t --long --random-seed=0 src/sage/schemes/elliptic_curves/period_lattice.py  # 2 doctests failed\nsage -t --long --random-seed=0 src/sage/symbolic/expression_conversions.py  # 1 doctest failed\nsage -t --long --random-seed=0 src/sage/geometry/polyhedron/backend_field.py  # 2 doctests failed\n```\n\n\nOpinions ? Is this the way to go ?",
    "created_at": "2020-08-18T06:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299888",
    "user": "@fchapoton"
}
```

Looks rather good, not so many doctest failures. And they seem to be improvements

```
sage -t --long --random-seed=0 src/sage/matrix/matrix2.pyx  # 8 doctests failed
sage -t --long --random-seed=0 src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/geometry/polyhedron/base.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/schemes/generic/algebraic_scheme.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/matrix/matrix0.pyx  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/schemes/elliptic_curves/period_lattice.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage/symbolic/expression_conversions.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/geometry/polyhedron/backend_field.py  # 2 doctests failed
```


Opinions ? Is this the way to go ?



---

archive/issue_comments_299889.json:
```json
{
    "body": "I agree with your assessment and change. It does seem like an improvement.",
    "created_at": "2020-08-18T06:06:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299889",
    "user": "@tscrim"
}
```

I agree with your assessment and change. It does seem like an improvement.



---

archive/issue_comments_299890.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-18T06:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299890",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299891.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-18T10:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299891",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299892.json:
```json
{
    "body": "Green patchbot => positive review.",
    "created_at": "2020-08-18T11:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299892",
    "user": "@tscrim"
}
```

Green patchbot => positive review.



---

archive/issue_comments_299893.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-18T11:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299893",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_299894.json:
```json
{
    "body": "I was wondering (for no special reason) about possible slowing effects of the changes ?",
    "created_at": "2020-08-18T11:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299894",
    "user": "@fchapoton"
}
```

I was wondering (for no special reason) about possible slowing effects of the changes ?



---

archive/issue_comments_299895.json:
```json
{
    "body": "I guess in principle there could be 2 extra `is_zero` tests that could be done, but I doubt that would cause any significant slowdown. Since the results are usually more accurate types (well, better reflect the element), I think the result should be either net 0 or a speedup due to subsequent computations. However, without any data, I couldn't say.\n\nIn short, I doubt there would be any.",
    "created_at": "2020-08-18T11:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299895",
    "user": "@tscrim"
}
```

I guess in principle there could be 2 extra `is_zero` tests that could be done, but I doubt that would cause any significant slowdown. Since the results are usually more accurate types (well, better reflect the element), I think the result should be either net 0 or a speedup due to subsequent computations. However, without any data, I couldn't say.

In short, I doubt there would be any.



---

archive/issue_comments_299896.json:
```json
{
    "body": "I was more worried about the change\n\n```diff\n-            return repr(CIF(self._value))\n+            return repr(self.interval(CIF))\n         else:\n-            return repr(RIF(self._value))\n+            return repr(self.interval(RIF))\n```\n\nbecause I am not sure of the exact status of `_value`",
    "created_at": "2020-08-18T12:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299896",
    "user": "@fchapoton"
}
```

I was more worried about the change

```diff
-            return repr(CIF(self._value))
+            return repr(self.interval(CIF))
         else:
-            return repr(RIF(self._value))
+            return repr(self.interval(RIF))
```

because I am not sure of the exact status of `_value`



---

archive/issue_comments_299897.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-08-18T21:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299897",
    "user": "@mwageringel"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_299898.json:
```json
{
    "body": "I was also wondering whether this change means that now exactifications are computed that were not needed before?\n\n```diff\n             sage: Q*R - A\n-            [            0.?e-17 0.?e-17 + 0.?e-17*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]\n-            [            0.?e-18 0.?e-17 + 0.?e-17*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]\n-            [0.?e-17 + 0.?e-18*I 0.?e-17 + 0.?e-17*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]\n-            [0.?e-18 + 0.?e-18*I 0.?e-18 + 0.?e-18*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]\n+            [0 0 0 0]\n+            [0 0 0 0]\n+            [0 0 0 0]\n+            [0 0 0 0]\n```\n\n\nAlso, there is one more test failure. Therefore I am setting this back to *needs work*.\n\n```\nFile \"src/sage/matrix/matrix2.pyx\", line 11149, in sage.matrix.matrix2.Matrix.is_similar\nFailed example:\n    T\nExpected:\n    [ 1.00000000000000? + 0.?e-14*I            0.?e-14 + 0.?e-14*I            0.?e-14 + 0.?e-14*I]\n    [-0.66666666666667? + 0.?e-15*I 0.166666666666667? + 0.?e-15*I -0.83333333333334? + 0.?e-14*I]\n    [ 0.66666666666667? + 0.?e-14*I            0.?e-14 + 0.?e-14*I -0.33333333333333? + 0.?e-14*I]\nGot:\n    [                   1                    0                    0]\n    [-0.6666666666666667?  0.1666666666666667? -0.8333333333333333?]\n    [ 0.6666666666666667?                    0 -0.3333333333333334?]\n```\n",
    "created_at": "2020-08-18T21:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299898",
    "user": "@mwageringel"
}
```

I was also wondering whether this change means that now exactifications are computed that were not needed before?

```diff
             sage: Q*R - A
-            [            0.?e-17 0.?e-17 + 0.?e-17*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]
-            [            0.?e-18 0.?e-17 + 0.?e-17*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]
-            [0.?e-17 + 0.?e-18*I 0.?e-17 + 0.?e-17*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]
-            [0.?e-18 + 0.?e-18*I 0.?e-18 + 0.?e-18*I 0.?e-16 + 0.?e-16*I 0.?e-16 + 0.?e-16*I]
+            [0 0 0 0]
+            [0 0 0 0]
+            [0 0 0 0]
+            [0 0 0 0]
```


Also, there is one more test failure. Therefore I am setting this back to *needs work*.

```
File "src/sage/matrix/matrix2.pyx", line 11149, in sage.matrix.matrix2.Matrix.is_similar
Failed example:
    T
Expected:
    [ 1.00000000000000? + 0.?e-14*I            0.?e-14 + 0.?e-14*I            0.?e-14 + 0.?e-14*I]
    [-0.66666666666667? + 0.?e-15*I 0.166666666666667? + 0.?e-15*I -0.83333333333334? + 0.?e-14*I]
    [ 0.66666666666667? + 0.?e-14*I            0.?e-14 + 0.?e-14*I -0.33333333333333? + 0.?e-14*I]
Got:
    [                   1                    0                    0]
    [-0.6666666666666667?  0.1666666666666667? -0.8333333333333333?]
    [ 0.6666666666666667?                    0 -0.3333333333333334?]
```




---

archive/issue_comments_299899.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-19T08:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299899",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299900.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-19T08:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299900",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299901.json:
```json
{
    "body": "Well, one could argue that we now do in every case what we were only doing (these `.is_zero` tests) for real fields before. Moreover, the changes only touch either the \"repr\", which is not time critical, or the method \"interval\", which is used only for inexact conversion to real numbers or complex numbers.\n\nI would therefore advocate that this is ok. Maybe benchmarks would be welcome ?",
    "created_at": "2020-08-19T08:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299901",
    "user": "@fchapoton"
}
```

Well, one could argue that we now do in every case what we were only doing (these `.is_zero` tests) for real fields before. Moreover, the changes only touch either the "repr", which is not time critical, or the method "interval", which is used only for inexact conversion to real numbers or complex numbers.

I would therefore advocate that this is ok. Maybe benchmarks would be welcome ?



---

archive/issue_comments_299902.json:
```json
{
    "body": "Are you saying that with these changes, converting an element of QQbar to a complex interval can trigger an exactification to test if the element is real? Then I think that's a very bad idea. Testing if an element is real can be extremely costly, while converting to intervals (without caring if the result is real or not) is something you do all the time in some types of computations.\n\n(I'm all in favor of printing elements of QQbar that are *already known* to be real without an imaginary part if we're not already doing it. And I don't really like the idea of testing if the real part is zero in `_repr_`, though I can live with it.)",
    "created_at": "2020-08-19T09:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299902",
    "user": "@mezzarobba"
}
```

Are you saying that with these changes, converting an element of QQbar to a complex interval can trigger an exactification to test if the element is real? Then I think that's a very bad idea. Testing if an element is real can be extremely costly, while converting to intervals (without caring if the result is real or not) is something you do all the time in some types of computations.

(I'm all in favor of printing elements of QQbar that are *already known* to be real without an imaginary part if we're not already doing it. And I don't really like the idea of testing if the real part is zero in `_repr_`, though I can live with it.)



---

archive/issue_comments_299903.json:
```json
{
    "body": "not in the conversion to RIF or CIF, but in conversion to RR or CC, I would say",
    "created_at": "2020-08-19T09:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299903",
    "user": "@fchapoton"
}
```

not in the conversion to RIF or CIF, but in conversion to RR or CC, I would say



---

archive/issue_comments_299904.json:
```json
{
    "body": "Regarding RR, I expect the conversion to fail if the imaginary part is not exactly zero.\n\nHowever, conversion to CC shouldn't ever call `exactify()` IMO.",
    "created_at": "2020-08-19T10:06:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299904",
    "user": "@mezzarobba"
}
```

Regarding RR, I expect the conversion to fail if the imaginary part is not exactly zero.

However, conversion to CC shouldn't ever call `exactify()` IMO.



---

archive/issue_comments_299905.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299905",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_299906.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21601",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21601#issuecomment-299906",
    "user": "@mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
