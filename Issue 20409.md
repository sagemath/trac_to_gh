# Issue 20409: gsl and linbox underlinked in sage-7.2

archive/issues_020409.json:
```json
{
    "body": "When building sage-7.2 with `LDFLAGS=\"--as-needed\"`, the result is underlinked:\n\n\n```\nfrom sage.rings.complex_double import CDF\nImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot\n```\n\n\nThat first error can be avoided by adding `-lcblas` to the gsl LDFLAGS, but a more intelligent approach is probably provided by this patch:\n\nhttps://gitweb.gentoo.org/repo/gentoo.git/tree/sci-libs/gsl/files/gsl-2.1-cblas.patch\n\nAfter that's fixed...\n\n\n```\nFile \"sage/libs/linbox/linbox.pxd\", line 7, in init sage.matrix.matrix_integer_dense (/home/mjo/src/sage.git/src/build/cythonized/sage/matrix/matrix_integer_dense.c:52635)\nImportError: /home/mjo/src/sage.git/local/lib/liblinboxsage.so.0: undefined symbol: certSolveRedMP\n```\n\n\nThat one can be fixed by appending `-liml` to the LDFLAGS for linbox. Appending it to LIBS should work, too.\n\nMore info about `--as-needed`:\n\nhttps://wiki.gentoo.org/wiki/Project:Quality_Assurance/As-needed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20646\n\n",
    "created_at": "2016-05-21T13:33:15Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "title": "gsl and linbox underlinked in sage-7.2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20409",
    "user": "mjo"
}
```
When building sage-7.2 with `LDFLAGS="--as-needed"`, the result is underlinked:


```
from sage.rings.complex_double import CDF
ImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot
```


That first error can be avoided by adding `-lcblas` to the gsl LDFLAGS, but a more intelligent approach is probably provided by this patch:

https://gitweb.gentoo.org/repo/gentoo.git/tree/sci-libs/gsl/files/gsl-2.1-cblas.patch

After that's fixed...


```
File "sage/libs/linbox/linbox.pxd", line 7, in init sage.matrix.matrix_integer_dense (/home/mjo/src/sage.git/src/build/cythonized/sage/matrix/matrix_integer_dense.c:52635)
ImportError: /home/mjo/src/sage.git/local/lib/liblinboxsage.so.0: undefined symbol: certSolveRedMP
```


That one can be fixed by appending `-liml` to the LDFLAGS for linbox. Appending it to LIBS should work, too.

More info about `--as-needed`:

https://wiki.gentoo.org/wiki/Project:Quality_Assurance/As-needed

Issue created by migration from https://trac.sagemath.org/ticket/20646





---

archive/issue_comments_281320.json:
```json
{
    "body": "So should we add `-liml` in LinBox's `spkg-install`?\n\nOr patch LinBox in that way?",
    "created_at": "2016-08-08T14:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281320",
    "user": "leif"
}
```

So should we add `-liml` in LinBox's `spkg-install`?

Or patch LinBox in that way?



---

archive/issue_comments_281321.json:
```json
{
    "body": "Replying to [comment:1 leif]:\n> So should we add `-liml` in LinBox's `spkg-install`?\n> \n> Or patch LinBox in that way?\nFWIW, Sage-on-Gentoo (see:`https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/linbox/linbox-1.3.2-r2.ebuild`) does this by appending `-liml` to the `LIBS` variable and not by patching.",
    "created_at": "2016-08-08T19:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281321",
    "user": "strogdon"
}
```

Replying to [comment:1 leif]:
> So should we add `-liml` in LinBox's `spkg-install`?
> 
> Or patch LinBox in that way?
FWIW, Sage-on-Gentoo (see:`https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/linbox/linbox-1.3.2-r2.ebuild`) does this by appending `-liml` to the `LIBS` variable and not by patching.



---

archive/issue_comments_281322.json:
```json
{
    "body": "Third option:\n\nAdd\n\n```\n# distutils: libraries = iml\n```\n\nto `src/sage/libs/linbox/linbox.pxd`.",
    "created_at": "2016-08-08T19:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281322",
    "user": "leif"
}
```

Third option:

Add

```
# distutils: libraries = iml
```

to `src/sage/libs/linbox/linbox.pxd`.



---

archive/issue_comments_281323.json:
```json
{
    "body": "Replying to [comment:1 leif]:\n> So should we add `-liml` in LinBox's `spkg-install`?\n> \n\nThat's what I've been doing. But I noticed that the newer version of linbox (https://github.com/cschwan/sage-on-gentoo/tree/master/sci-libs/linbox) doesn't have the same \"append-libs\" hack, so if it's easier, an upgrade to linbox-1.4.1 probably fixes it as well.",
    "created_at": "2016-08-08T19:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281323",
    "user": "mjo"
}
```

Replying to [comment:1 leif]:
> So should we add `-liml` in LinBox's `spkg-install`?
> 

That's what I've been doing. But I noticed that the newer version of linbox (https://github.com/cschwan/sage-on-gentoo/tree/master/sci-libs/linbox) doesn't have the same "append-libs" hack, so if it's easier, an upgrade to linbox-1.4.1 probably fixes it as well.



---

archive/issue_comments_281324.json:
```json
{
    "body": "On the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.",
    "created_at": "2016-08-08T19:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281324",
    "user": "mjo"
}
```

On the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.



---

archive/issue_comments_281325.json:
```json
{
    "body": "Replying to [comment:5 mjo]:\n> On the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.\nI was just going to say that.",
    "created_at": "2016-08-08T19:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281325",
    "user": "strogdon"
}
```

Replying to [comment:5 mjo]:
> On the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.
I was just going to say that.



---

archive/issue_comments_281326.json:
```json
{
    "body": "#17635 is basically ready, modulo a rebasing and fixing minor platforms (32bit). I'd like to add that `libgsl` is underlinked upstream on purpose. In their opinion it is the responsibility of people downstream or writing their applications to provide a `cblas`.\n\nIt is our choice to provide extra linking. In that context I am not sure the gentoo patch as it is the way to go.\n\nThe people in the gentoo science overlay (including me) have not drunk the whole Kool-aid of their blas infrastructure when it comes to `gsl`. The reality is `gsl` should be split in `gslcblas` and `libgsl`. Then `libgsl` could just use `pkg-config` to find `cblas`. You still need to remove `libgslcblas.la` everywhere but you avoid adding a custom macro.",
    "created_at": "2016-08-08T21:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281326",
    "user": "fbissey"
}
```

#17635 is basically ready, modulo a rebasing and fixing minor platforms (32bit). I'd like to add that `libgsl` is underlinked upstream on purpose. In their opinion it is the responsibility of people downstream or writing their applications to provide a `cblas`.

It is our choice to provide extra linking. In that context I am not sure the gentoo patch as it is the way to go.

The people in the gentoo science overlay (including me) have not drunk the whole Kool-aid of their blas infrastructure when it comes to `gsl`. The reality is `gsl` should be split in `gslcblas` and `libgsl`. Then `libgsl` could just use `pkg-config` to find `cblas`. You still need to remove `libgslcblas.la` everywhere but you avoid adding a custom macro.



---

archive/issue_comments_281327.json:
```json
{
    "body": "Is it still relevant now that the new `linbox` stack has been merged.",
    "created_at": "2016-10-22T22:45:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281327",
    "user": "fbissey"
}
```

Is it still relevant now that the new `linbox` stack has been merged.



---

archive/issue_comments_281328.json:
```json
{
    "body": "I'm now unable to reproduce any of the issues associated with this ticket. Things implemented:\n* export export LDFLAGS=\"-Wl,--as-needed\"\n* rebuild (sage -f) `sagelib, gsl, linbox` (`gsl` was probably not necessary)\n\n`sage: from sage.rings.complex_double import CDF`\n\ndoes not fail and rebuilding `linbox` also rebuilds `iml` and `fflas_ffpack`. I don't know if using `atlas` will be a problem.",
    "created_at": "2016-10-24T15:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281328",
    "user": "strogdon"
}
```

I'm now unable to reproduce any of the issues associated with this ticket. Things implemented:
* export export LDFLAGS="-Wl,--as-needed"
* rebuild (sage -f) `sagelib, gsl, linbox` (`gsl` was probably not necessary)

`sage: from sage.rings.complex_double import CDF`

does not fail and rebuilding `linbox` also rebuilds `iml` and `fflas_ffpack`. I don't know if using `atlas` will be a problem.



---

archive/issue_comments_281329.json:
```json
{
    "body": "The linbox issue should be gone, but I don't know about gsl. I guess I'll have to recompile from scratch.",
    "created_at": "2016-10-24T15:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281329",
    "user": "mjo"
}
```

The linbox issue should be gone, but I don't know about gsl. I guess I'll have to recompile from scratch.



---

archive/issue_comments_281330.json:
```json
{
    "body": "Well `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.",
    "created_at": "2016-10-24T20:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281330",
    "user": "fbissey"
}
```

Well `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.



---

archive/issue_comments_281331.json:
```json
{
    "body": "Replying to [comment:11 fbissey]:\n> Well `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.\nYep, this is what I see. When there is linking with `libgsl.so` there also appears linking to `openblas`. Something like `-lgsl -lm -lopenblas`. And when `atlas` was used in say, `7.4.beta4` the linking would typically appear as `-lgsl ... -lm -latlas -lcblas`. I suspect everything is now OK.",
    "created_at": "2016-10-24T20:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281331",
    "user": "strogdon"
}
```

Replying to [comment:11 fbissey]:
> Well `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.
Yep, this is what I see. When there is linking with `libgsl.so` there also appears linking to `openblas`. Something like `-lgsl -lm -lopenblas`. And when `atlas` was used in say, `7.4.beta4` the linking would typically appear as `-lgsl ... -lm -latlas -lcblas`. I suspect everything is now OK.



---

archive/issue_comments_281332.json:
```json
{
    "body": "Yup, it's fixed. Thanks for all your work on this stuff.",
    "created_at": "2016-10-25T12:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281332",
    "user": "mjo"
}
```

Yup, it's fixed. Thanks for all your work on this stuff.



---

archive/issue_comments_281333.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-10-25T12:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281333",
    "user": "mjo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_281334.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-25T12:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281334",
    "user": "mjo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_281335.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-10-30T19:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281335",
    "user": "mjo"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_281336.json:
```json
{
    "body": "Oops, I just tried to run the sage that I built 5 days ago:\n\n\n```\n   from sage.misc.all       import *         # takes a while\n  File \"/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/all.py\", line 89, in <module>\n    from .functional import (additive_order,\n  File \"/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 32, in <module>\n    from sage.rings.complex_double import CDF\nImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot\n```\n",
    "created_at": "2016-10-30T19:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281336",
    "user": "mjo"
}
```

Oops, I just tried to run the sage that I built 5 days ago:


```
   from sage.misc.all       import *         # takes a while
  File "/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/all.py", line 89, in <module>
    from .functional import (additive_order,
  File "/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/functional.py", line 32, in <module>
    from sage.rings.complex_double import CDF
ImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot
```




---

archive/issue_comments_281337.json:
```json
{
    "body": "That's interesting. Can you post the output of \n\n```\nreadelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so\n```\n",
    "created_at": "2016-10-30T20:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281337",
    "user": "fbissey"
}
```

That's interesting. Can you post the output of 

```
readelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so
```




---

archive/issue_comments_281338.json:
```json
{
    "body": "Replying to [comment:16 fbissey]:\n> That's interesting. Can you post the output of \n> {{{\n> readelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so\n> }}}\n\\\\\n\nSure:\n\n\n```\nDynamic section at offset 0x48200 contains 34 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000003 (PLTGOT)             0x49660\n 0x0000000000000002 (PLTRELSZ)           3672 (bytes)\n 0x0000000000000017 (JMPREL)             0x7aa0\n 0x0000000000000014 (PLTREL)             RELA\n 0x0000000000000007 (RELA)               0x2d60\n 0x0000000000000008 (RELASZ)             19776 (bytes)\n 0x0000000000000009 (RELAENT)            24 (bytes)\n 0x000000006ffffff9 (RELACOUNT)          762\n 0x0000000000000006 (SYMTAB)             0x190\n 0x000000000000000b (SYMENT)             24 (bytes)\n 0x0000000000000005 (STRTAB)             0x15a0\n 0x000000000000000a (STRSZ)              5292 (bytes)\n 0x000000006ffffef5 (GNU_HASH)           0x2a50\n 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]\n 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000c (INIT)               0x88f8\n 0x000000000000000d (FINI)               0x40af0\n 0x000000000000001a (FINI_ARRAY)         0x5b4c8\n 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)\n 0x0000000000000019 (INIT_ARRAY)         0x5b4d0\n 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)\n 0x000000000000001d (RUNPATH)            Library runpath: [/home/mjo/src/sage.git/local/lib]\n 0x000000000000001e (FLAGS)              BIND_NOW\n 0x000000006ffffffb (FLAGS_1)            Flags: NOW\n 0x000000006ffffff0 (VERSYM)             0x2b44\n 0x000000006ffffffc (VERDEF)             0x2cf0\n 0x000000006ffffffd (VERDEFNUM)          1\n 0x000000006ffffffe (VERNEED)            0x2d0c\n 0x000000006fffffff (VERNEEDNUM)         2\n 0x0000000000000000 (NULL)               0x0\n```\n",
    "created_at": "2016-10-30T20:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281338",
    "user": "mjo"
}
```

Replying to [comment:16 fbissey]:
> That's interesting. Can you post the output of 
> {{{
> readelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so
> }}}
\\

Sure:


```
Dynamic section at offset 0x48200 contains 34 entries:
  Tag        Type                         Name/Value
 0x0000000000000003 (PLTGOT)             0x49660
 0x0000000000000002 (PLTRELSZ)           3672 (bytes)
 0x0000000000000017 (JMPREL)             0x7aa0
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000007 (RELA)               0x2d60
 0x0000000000000008 (RELASZ)             19776 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffff9 (RELACOUNT)          762
 0x0000000000000006 (SYMTAB)             0x190
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000005 (STRTAB)             0x15a0
 0x000000000000000a (STRSZ)              5292 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x2a50
 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]
 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x88f8
 0x000000000000000d (FINI)               0x40af0
 0x000000000000001a (FINI_ARRAY)         0x5b4c8
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x0000000000000019 (INIT_ARRAY)         0x5b4d0
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001d (RUNPATH)            Library runpath: [/home/mjo/src/sage.git/local/lib]
 0x000000000000001e (FLAGS)              BIND_NOW
 0x000000006ffffffb (FLAGS_1)            Flags: NOW
 0x000000006ffffff0 (VERSYM)             0x2b44
 0x000000006ffffffc (VERDEF)             0x2cf0
 0x000000006ffffffd (VERDEFNUM)          1
 0x000000006ffffffe (VERNEED)            0x2d0c
 0x000000006fffffff (VERNEEDNUM)         2
 0x0000000000000000 (NULL)               0x0
```




---

archive/issue_comments_281339.json:
```json
{
    "body": "Interesting my install in sage-on-gentoo shows\n\n```\nreadelf -d /usr/lib64/python2.7/site-packages/sage/rings/complex_double.so\n\nDynamic section at offset 0x46c00 contains 29 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]\n 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libopenblas_threads.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n```\n\nSo I have openblas here. It could be a library order problem. When `complex_double.so` is linked, is `-lopenblas` before `-lgsl`? Since this is a shared library it is legal to underlink. May be you should try a build with `-Wl,--no-undefined` to catch funny stuff.",
    "created_at": "2016-10-30T20:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281339",
    "user": "fbissey"
}
```

Interesting my install in sage-on-gentoo shows

```
readelf -d /usr/lib64/python2.7/site-packages/sage/rings/complex_double.so

Dynamic section at offset 0x46c00 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]
 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libopenblas_threads.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
```

So I have openblas here. It could be a library order problem. When `complex_double.so` is linked, is `-lopenblas` before `-lgsl`? Since this is a shared library it is legal to underlink. May be you should try a build with `-Wl,--no-undefined` to catch funny stuff.



---

archive/issue_comments_281340.json:
```json
{
    "body": "Hum my own log for vanilla 7.4 show that the order is correct at least here\n\n```\ngcc -pthread -shared -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib build/temp.linux-x86_64-2.7/home/fbissey/sandbox/git-fork/sage-7.4/src/build/cythonized/sage/rings/complex_double.o -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy\n```\n",
    "created_at": "2016-10-30T20:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281340",
    "user": "fbissey"
}
```

Hum my own log for vanilla 7.4 show that the order is correct at least here

```
gcc -pthread -shared -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib build/temp.linux-x86_64-2.7/home/fbissey/sandbox/git-fork/sage-7.4/src/build/cythonized/sage/rings/complex_double.o -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy
```




---

archive/issue_comments_281341.json:
```json
{
    "body": "This is what I've got in my sagelib log:\n\n\n```\ngcc -pthread -shared -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -march=native -O2 -pipe build/temp.linux-x86_64-2.7/home/mjo/src/sage.git/src/build/cythonized/sage/rings/complex_double.o -L/home/mjo/src/sage.git/local/lib -L/home/mjo/src/sage.git/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy\n```\n\n\nThe difference that stands out to me is `--as-needed`... won't it refuse to link OpenBLAS into the result if `complex_double.so` fails to use its symbols directly?",
    "created_at": "2016-10-30T22:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281341",
    "user": "mjo"
}
```

This is what I've got in my sagelib log:


```
gcc -pthread -shared -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -march=native -O2 -pipe build/temp.linux-x86_64-2.7/home/mjo/src/sage.git/src/build/cythonized/sage/rings/complex_double.o -L/home/mjo/src/sage.git/local/lib -L/home/mjo/src/sage.git/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy
```


The difference that stands out to me is `--as-needed`... won't it refuse to link OpenBLAS into the result if `complex_double.so` fails to use its symbols directly?



---

archive/issue_comments_281342.json:
```json
{
    "body": "I have\n\n```\ngcc -pthread -shared -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,--as-needed build/temp.linux-x86_64-2.7/64bitdev/storage/sage-git_develop/sage/src/build/cythonized/sage/rings/complex_double.o -L/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy\n```\n\nbut shouldn't the linking be with `g++`?",
    "created_at": "2016-10-30T22:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281342",
    "user": "strogdon"
}
```

I have

```
gcc -pthread -shared -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,--as-needed build/temp.linux-x86_64-2.7/64bitdev/storage/sage-git_develop/sage/src/build/cythonized/sage/rings/complex_double.o -L/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy
```

but shouldn't the linking be with `g++`?



---

archive/issue_comments_281343.json:
```json
{
    "body": "I'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to\n\n\n```\n$ sudo binutils-config --linker ld.gold\n```\n",
    "created_at": "2016-10-30T23:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281343",
    "user": "mjo"
}
```

I'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to


```
$ sudo binutils-config --linker ld.gold
```




---

archive/issue_comments_281344.json:
```json
{
    "body": "Rebuilt `sagelib` here using `LDFLAGS=-Wl,-O1 -Wl,--as-needed` instead of `LDFLAGS=-Wl,--as-needed`, just in case; still no issue. I am using gentoo default BFD linker.",
    "created_at": "2016-10-30T23:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281344",
    "user": "strogdon"
}
```

Rebuilt `sagelib` here using `LDFLAGS=-Wl,-O1 -Wl,--as-needed` instead of `LDFLAGS=-Wl,--as-needed`, just in case; still no issue. I am using gentoo default BFD linker.



---

archive/issue_comments_281345.json:
```json
{
    "body": "Replying to [comment:22 mjo]:\n> I'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to\n> \n> {{{\n> $ sudo binutils-config --linker ld.gold\n> }}}\nIt usually does with matter regarding `--as-needed` in my experience.",
    "created_at": "2016-10-30T23:57:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281345",
    "user": "fbissey"
}
```

Replying to [comment:22 mjo]:
> I'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to
> 
> {{{
> $ sudo binutils-config --linker ld.gold
> }}}
It usually does with matter regarding `--as-needed` in my experience.



---

archive/issue_comments_281346.json:
```json
{
    "body": "Somehow I had another comment that escaped posting :( The gold linker has a more strict interpretation of `--as-needed` and in this case `libgsl` would need to be linked to `cblas` itself.\n\nIt could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.",
    "created_at": "2016-11-01T08:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281346",
    "user": "fbissey"
}
```

Somehow I had another comment that escaped posting :( The gold linker has a more strict interpretation of `--as-needed` and in this case `libgsl` would need to be linked to `cblas` itself.

It could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.



---

archive/issue_comments_281347.json:
```json
{
    "body": "Replying to [comment:25 fbissey]:\n> \n> It could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.\n\nI didn't notice anything different, with a clean build of 7.5.beta1, it dies when it tries to build the docs at the end of compilation:\n\n\n```\n$ LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -Wl,--no-allow-shlib-undefined\" CFLAGS=\"${CFLAGS}\" make -j4\n...\n[conway_polynomials-0.4.p0] Finished installing conway_polynomials-0.4.p0.spkg\ncd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log\n[dochtml] /home/mjo/src/sage.git/local/bin/python: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot; 'sage_setup.docbuild' is a package and cannot be directly executed\nMakefile:1063: recipe for target 'doc-html' failed\n```\n\n\nI don't see anything unusual in that same spot in the sagelib build log either, but I don't really know what I'm looking for. I think the additional linker flag should have made it fail?",
    "created_at": "2016-11-01T20:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281347",
    "user": "mjo"
}
```

Replying to [comment:25 fbissey]:
> 
> It could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.

I didn't notice anything different, with a clean build of 7.5.beta1, it dies when it tries to build the docs at the end of compilation:


```
$ LDFLAGS="-Wl,-O1 -Wl,--as-needed -Wl,--no-allow-shlib-undefined" CFLAGS="${CFLAGS}" make -j4
...
[conway_polynomials-0.4.p0] Finished installing conway_polynomials-0.4.p0.spkg
cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
[dochtml] /home/mjo/src/sage.git/local/bin/python: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot; 'sage_setup.docbuild' is a package and cannot be directly executed
Makefile:1063: recipe for target 'doc-html' failed
```


I don't see anything unusual in that same spot in the sagelib build log either, but I don't really know what I'm looking for. I think the additional linker flag should have made it fail?



---

archive/issue_comments_281348.json:
```json
{
    "body": "Failure to link would have been my minimal expectation.\n\nSo the option we have:\n* link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.\n* add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.\n\nThe first one may be achieved by adding\n\n```\nLIBS=`pkg-config --libs-only-l cblas`\n```\n\nto the configure line of `gsl`'s spkg-install. I think.\n\nThe second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.\n\nPick your poison.",
    "created_at": "2016-11-01T20:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281348",
    "user": "fbissey"
}
```

Failure to link would have been my minimal expectation.

So the option we have:
* link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.
* add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.

The first one may be achieved by adding

```
LIBS=`pkg-config --libs-only-l cblas`
```

to the configure line of `gsl`'s spkg-install. I think.

The second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.

Pick your poison.



---

archive/issue_comments_281349.json:
```json
{
    "body": "Hum, `$(BLAS)` is currently in `gsl`'s dependency but is not in fact used.",
    "created_at": "2016-11-01T20:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281349",
    "user": "fbissey"
}
```

Hum, `$(BLAS)` is currently in `gsl`'s dependency but is not in fact used.



---

archive/issue_comments_281350.json:
```json
{
    "body": "\n```\n./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n   LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n```\n\n`-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.",
    "created_at": "2016-11-01T20:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281350",
    "user": "fbissey"
}
```


```
./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
   LIBS="`pkg-config --libs-only-l cblas` -lm"
```

`-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.



---

archive/issue_comments_281351.json:
```json
{
    "body": "Replying to [comment:29 fbissey]:\n> {{{\n> ./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n>    LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n> }}}\n> `-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.\n\nDo you think the order of where `-lm` appears is important? I always see `-lgsl ... -lm -lopenblas ...` in the `sagelib` log. I'm not sure where the order is set.",
    "created_at": "2016-11-01T22:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281351",
    "user": "strogdon"
}
```

Replying to [comment:29 fbissey]:
> {{{
> ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
>    LIBS="`pkg-config --libs-only-l cblas` -lm"
> }}}
> `-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.

Do you think the order of where `-lm` appears is important? I always see `-lgsl ... -lm -lopenblas ...` in the `sagelib` log. I'm not sure where the order is set.



---

archive/issue_comments_281352.json:
```json
{
    "body": "I don't think the order is important in that case, because openblas doesn't need it according to ldd and readelf. It certainly would be important if libopenblas wasn't linked to libm. Then it would have to be after. And even so, with gold, if the stuff you link doesn't use libm directly, it won't appear in the final shared object and you will be in the same situation as with gsl needing cblas.",
    "created_at": "2016-11-01T22:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281352",
    "user": "fbissey"
}
```

I don't think the order is important in that case, because openblas doesn't need it according to ldd and readelf. It certainly would be important if libopenblas wasn't linked to libm. Then it would have to be after. And even so, with gold, if the stuff you link doesn't use libm directly, it won't appear in the final shared object and you will be in the same situation as with gsl needing cblas.



---

archive/issue_comments_281353.json:
```json
{
    "body": "Replying to [comment:27 fbissey]:\n> Failure to link would have been my minimal expectation.\n> \n> So the option we have:\n>  * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.\n>  * add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.\n> \n> The first one may be achieved by adding\n> {{{\n> LIBS=`pkg-config --libs-only-l cblas`\n> }}}\n> to the configure line of `gsl`'s spkg-install. I think.\n> \n> The second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.\n> \n> Pick your poison.\n\nIt seems to me that altering the `gsl.pc` file is like a SoG build with `USE=cblas-external`. And this approach will require a change in the configure of `gsl` resulting in increased package maintenance on the Sage end. But doing it would remove undefined `cblas` symbols in `libgsl`.",
    "created_at": "2016-11-02T21:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281353",
    "user": "strogdon"
}
```

Replying to [comment:27 fbissey]:
> Failure to link would have been my minimal expectation.
> 
> So the option we have:
>  * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.
>  * add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.
> 
> The first one may be achieved by adding
> {{{
> LIBS=`pkg-config --libs-only-l cblas`
> }}}
> to the configure line of `gsl`'s spkg-install. I think.
> 
> The second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.
> 
> Pick your poison.

It seems to me that altering the `gsl.pc` file is like a SoG build with `USE=cblas-external`. And this approach will require a change in the configure of `gsl` resulting in increased package maintenance on the Sage end. But doing it would remove undefined `cblas` symbols in `libgsl`.



---

archive/issue_comments_281354.json:
```json
{
    "body": "Replying to [comment:27 fbissey]:\n> Failure to link would have been my minimal expectation.\n> \n> So the option we have:\n>  * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.\n\\\\\n\nWhen I first encountered this, I thought the fact that GSL wasn't linked to CBLAS was a bug, but then you pointed out that upstream leaves it that way on purpose. What's the benefit of doing so in Sage, where we know that everything is going to transitively link to the same CBLAS anyway?\n\nRequiring consumers to fill in your missing symbols still seems backwards to me, but I don't want to judge it wrong too quickly.",
    "created_at": "2016-11-03T00:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281354",
    "user": "mjo"
}
```

Replying to [comment:27 fbissey]:
> Failure to link would have been my minimal expectation.
> 
> So the option we have:
>  * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.
\\

When I first encountered this, I thought the fact that GSL wasn't linked to CBLAS was a bug, but then you pointed out that upstream leaves it that way on purpose. What's the benefit of doing so in Sage, where we know that everything is going to transitively link to the same CBLAS anyway?

Requiring consumers to fill in your missing symbols still seems backwards to me, but I don't want to judge it wrong too quickly.



---

archive/issue_comments_281355.json:
```json
{
    "body": "`@` Steve adding -lopenblas won't work. It is not the only thing we do.\n\n`@` mjo, underlinking is legal but no distro leave it way I think. The wheels come of for shared objects such as those used by python, bfd linker does ok but gold doesn't want to cater to that case I think. Not their goal. I'd rather link gsl in sage, the dependency is there already.\n\nSend from my iPhone from school camp\ud83d\ude00",
    "created_at": "2016-11-03T03:13:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281355",
    "user": "fbissey"
}
```

`@` Steve adding -lopenblas won't work. It is not the only thing we do.

`@` mjo, underlinking is legal but no distro leave it way I think. The wheels come of for shared objects such as those used by python, bfd linker does ok but gold doesn't want to cater to that case I think. Not their goal. I'd rather link gsl in sage, the dependency is there already.

Send from my iPhone from school campðŸ˜€



---

archive/issue_comments_281356.json:
```json
{
    "body": "Replying to [comment:34 fbissey]:\n> \n> I'd rather link gsl in sage, the dependency is there already.\n\nIf there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.",
    "created_at": "2016-11-03T17:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281356",
    "user": "mjo"
}
```

Replying to [comment:34 fbissey]:
> 
> I'd rather link gsl in sage, the dependency is there already.

If there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.



---

archive/issue_comments_281357.json:
```json
{
    "body": "Replying to [comment:35 mjo]:\n> Replying to [comment:34 fbissey]:\n> > \n> > I'd rather link gsl in sage, the dependency is there already.\n> \n> If there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.\n> \nditto\n\nor in common parlance\n\n+1",
    "created_at": "2016-11-03T18:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281357",
    "user": "strogdon"
}
```

Replying to [comment:35 mjo]:
> Replying to [comment:34 fbissey]:
> > 
> > I'd rather link gsl in sage, the dependency is there already.
> 
> If there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.
> 
ditto

or in common parlance

+1



---

archive/issue_comments_281358.json:
```json
{
    "body": "The way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.\n\n```\n readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so\n\nDynamic section at offset 0x3ddd0 contains 28 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]\n 0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]\n```\n\nIn concrete terms I am not sure which cblas you are getting when linking with it.",
    "created_at": "2016-11-04T07:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281358",
    "user": "fbissey"
}
```

The way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.

```
 readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so

Dynamic section at offset 0x3ddd0 contains 28 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]
 0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]
```

In concrete terms I am not sure which cblas you are getting when linking with it.



---

archive/issue_comments_281359.json:
```json
{
    "body": "Replying to [comment:37 fbissey]:\n> The way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.\n> {{{\n>  readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so\n> \n> Dynamic section at offset 0x3ddd0 contains 28 entries:\n>   Tag        Type                         Name/Value\n>  0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]\n>  0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n>  0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n>  0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]\n>  0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]\n> }}}\n> In concrete terms I am not sure which cblas you are getting when linking with it.\n\nWith my default BFD linker and extra linker flags `-Wl,-O1 -Wl,--as-needed` I have no linking to `cblas`.\n\n```\nDynamic section at offset 0x3cde0 contains 27 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]\n 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]\n```\n",
    "created_at": "2016-11-04T15:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281359",
    "user": "strogdon"
}
```

Replying to [comment:37 fbissey]:
> The way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.
> {{{
>  readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so
> 
> Dynamic section at offset 0x3ddd0 contains 28 entries:
>   Tag        Type                         Name/Value
>  0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
>  0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
>  0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]
>  0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]
> }}}
> In concrete terms I am not sure which cblas you are getting when linking with it.

With my default BFD linker and extra linker flags `-Wl,-O1 -Wl,--as-needed` I have no linking to `cblas`.

```
Dynamic section at offset 0x3cde0 contains 27 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]
 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]
```




---

archive/issue_comments_281360.json:
```json
{
    "body": "Probably a bad manipulation on my part then. It will be present for people not using `--as-needed` though. I'll post a branch later. I may also revamp the description a bit.",
    "created_at": "2016-11-05T20:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281360",
    "user": "fbissey"
}
```

Probably a bad manipulation on my part then. It will be present for people not using `--as-needed` though. I'll post a branch later. I may also revamp the description a bit.



---

archive/issue_comments_281361.json:
```json
{
    "body": "At last someone can review this.\n----\nNew commits:",
    "created_at": "2016-11-09T22:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281361",
    "user": "fbissey"
}
```

At last someone can review this.
----
New commits:



---

archive/issue_comments_281362.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-09T22:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281362",
    "user": "fbissey"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_281363.json:
```json
{
    "body": "I think this fixes things\n\n```\nreadelf -d local/lib/libgsl.so\n\nDynamic section at offset 0x23ab08 contains 28 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000e (SONAME)             Library soname: [libgsl.so.19]\n 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]\n```\n\nwith `--as-needed` added to `LDFLAGS`. But I was wrong before, so `@`mjo (Michael) should probably push the button since I don't use the offending `gold` linker.",
    "created_at": "2016-11-09T23:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281363",
    "user": "strogdon"
}
```

I think this fixes things

```
readelf -d local/lib/libgsl.so

Dynamic section at offset 0x23ab08 contains 28 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libgsl.so.19]
 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]
```

with `--as-needed` added to `LDFLAGS`. But I was wrong before, so `@`mjo (Michael) should probably push the button since I don't use the offending `gold` linker.



---

archive/issue_comments_281364.json:
```json
{
    "body": "Looks good, and I even remembered to run it this time. Thanks!",
    "created_at": "2016-11-10T12:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281364",
    "user": "mjo"
}
```

Looks good, and I even remembered to run it this time. Thanks!



---

archive/issue_comments_281365.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-10T12:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281365",
    "user": "mjo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_281366.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-11-11T17:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20409",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20409#issuecomment-281366",
    "user": "vbraun"
}
```

Resolution: fixed
