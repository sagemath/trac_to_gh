# Issue 17884: Patch Cython with PyTypeObject members

Issue created by migration from https://trac.sagemath.org/ticket/18121

Original creator: jdemeyer

Original creation time: 2015-04-03 12:19:49

Various places in Sage need access to `PyTypeObject` members. There is currently no consistent way how this is done. I propose to just add the declarations to the Cython includes.


---

Comment by git created at 2015-04-03 21:23:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-03 21:26:18

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-04-05 07:14:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-06 21:31:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-06 21:31:36

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-04-07 08:23:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-07 08:58:28

Changing keywords from "" to "sd66".


---

Comment by git created at 2015-04-16 09:22:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-19 20:18:01

As far as I can see, the patch you are using does not exactly match the changes to Cython given by [ec8ba63](https://github.com/cython/cython/commit/ec8ba63bc54839d00a07af9bcdc5129a25182a6c) (concerning the pull request 378).

You are using

```
from cpython.object cimport PyObject
```

instead of

```
from .object cimport PyObject
```

why is that? It is not supported in our Cython 0.22?


---

Comment by jdemeyer created at 2015-04-20 17:00:55

Replying to [comment:17 vdelecroix]:
> It is not supported in our Cython 0.22?
Not completely. It needs a bug-fix which isn't in Cython 0.22.


---

Comment by vdelecroix created at 2015-04-20 17:36:31

Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe. Though, your version of `MonoDict_traverse` looks nicer.

Could you explain to me the reason of declaring

```
    int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
```

and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.

In `sage/structure/coerce_dict.pyx`, couldn't you get rid of

```
cdef extern from "Python.h":
    PyObject* PyWeakref_GetObject(object r)
```

It is in `cpython.weakref`.

Do you know why `Py_None` is not available from Cython?

Could we also remove or comment the `cpdef inline Py_ssize_t signed_id(x)`?


---

Comment by nbruin created at 2015-04-20 18:32:40

Replying to [comment:19 vdelecroix]:
> Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe.

Correct, and I agree. Depending on the user giving parameters a particular name _and_ cython mangling the names in a particular way is more fragile than what the CPython macro does. We only use this stuff twice, so it's not too onerous and much less obscure to be explicit in the code. If we find ourselves writing more "traverse" functions, we should push for a more structural solution in cython (currently we're already hacking by modifying a pytype structure after PyTypeReady has run on it).

> Could you explain to me the reason of declaring
> {{{
>     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
> }}}
> and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.

See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.
> In `sage/structure/coerce_dict.pyx`, couldn't you get rid of
> {{{
> cdef extern from "Python.h":
>     PyObject* PyWeakref_GetObject(object r)
> }}}
> It is in `cpython.weakref`.

So it is now! I don't think it was before.

> Do you know why `Py_None` is not available from Cython?

It is as "None", but then it's an `object`, and we need to compare it as a `PyObject *`. Cython's support for `PyObject *` (i.e., borrowed references) is poor -- basically intentionally so at the moment because a good interface (other than just the C interface) hasn't been formulated yet.

> Could we also remove or comment the `cpdef inline Py_ssize_t signed_id(x)`?

No objections to that.


---

Comment by jdemeyer created at 2015-04-20 19:54:11

Replying to [comment:20 nbruin]:
> Replying to [comment:19 vdelecroix]:
> > Why `void Py_VISIT(PyObject *o)` is not compatible with Cython? I do not quite understand what is this `__pyx_v_visit`. Is it because of Cython renaming arguments? If it is so, I do not find it very safe.
> 
> Correct, and I agree. Depending on the user giving parameters a particular name _and_ cython mangling the names in a particular way is more fragile than what the CPython macro does.
How about generalizing the macro to accept `visit` and `arg` arguments?

> We only use this stuff twice
8 times if I count correctly.


---

Comment by nbruin created at 2015-04-20 20:59:27

Replying to [comment:21 jdemeyer]:
> How about generalizing the macro to accept `visit` and `arg` arguments?

Fine with me. It's brainless boilerplate, but at least we have a clean macro that way that doesn't depend on naming conventions and (undocumented) cython behaviour.

> > We only use this stuff twice
> 8 times if I count correctly.
OK, "twice"= in two simple, trivial, boilerplate routines :-).


---

Comment by git created at 2015-04-21 09:03:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-21 12:57:16

Replying to [comment:20 nbruin]:
> Replying to [comment:19 vdelecroix]:
> > Could you explain to me the reason of declaring
> > {{{
> >     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
> > }}}
> > and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.
> 
> See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.

`@`Nils: then do you think Cython is wrong here?

> > In `sage/structure/coerce_dict.pyx`, couldn't you get rid of
> > {{{
> > cdef extern from "Python.h":
> >     PyObject* PyWeakref_GetObject(object r)
> > }}}
> > It is in `cpython.weakref`.
> 
> So it is now! I don't think it was before.

`@`Jeroen: could this be done here?


---

Comment by jdemeyer created at 2015-04-21 18:57:28

Replying to [comment:25 vdelecroix]:
> Replying to [comment:20 nbruin]:
> > Replying to [comment:19 vdelecroix]:
> > > Could you explain to me the reason of declaring
> > > {{{
> > >     int PyList_SetItem(object list, Py_ssize_t index, PyObject * item) except -1
> > > }}}
> > > and not use the `PyList_SetItem` from `cpython.lists` declared as `(object,Py_ssize_t,object)`? It would also be cool to add a comment if it is important to keep as such.
> > 
> > See its use in `extract_*` functions. It's handling `PyObject*` there and a cast to `object` would generate an INCREF (which is really not what you want to do in code that's just deleting things). This ticket doesn't affect that code.
> 
> `@`Nils: then do you think Cython is wrong here?
> 
> > > In `sage/structure/coerce_dict.pyx`, couldn't you get rid of
> > > {{{
> > > cdef extern from "Python.h":
> > >     PyObject* PyWeakref_GetObject(object r)
> > > }}}
> > > It is in `cpython.weakref`.
> > 
> > So it is now! I don't think it was before.
> 
> `@`Jeroen: could this be done here?

Both questions have the same answer: using `PyObject*` instead of `object` is the right thing in this specific use case. Cython isn't wrong, it's just that we are doing very low-level stuff for which the standard Cython declarations don't work.


---

Comment by vdelecroix created at 2015-04-21 19:02:52

`PyWeakref_GetObject` is defined in ` cpython.weakref` as

```
    PyObject* PyWeakref_GetObject(object ref)
    # Return the referenced object from a weak reference, ref.  If the
    # referent is no longer live, returns None.
```



---

Comment by nbruin created at 2015-04-21 19:13:30

Replying to [comment:27 vdelecroix]:
> `PyWeakref_GetObject` is defined in ` cpython.weakref` as
> {{{
>     PyObject* PyWeakref_GetObject(object ref)
>     # Return the referenced object from a weak reference, ref.  If the
>     # referent is no longer live, returns None.
> }}}
Yes, and that is the same signature as with which it is defined in `coerce_dict.pyx`. Apparently we're only dereferencing weakrefs we are actually owning (i.e., `object`s). Its return type is also correctly typed, since it returns a *borrowed* reference, so the normal use of storing the returned value into an `<object>` leads exactly to the INCREF required to ensure the object doesn't get deallocated.

I am pretty sure that if this is now available in cpython.weakref, we can cimport it from there rather than explicitly "cdef extern" it from "Python.h". Of course, there will be absolutely no difference to the eventual code generated either.


---

Comment by jdemeyer created at 2015-04-21 19:44:22

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-04-21 20:02:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-04-21 20:02:40

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-21 20:26:51

I have no further remark.

Vincent


---

Comment by nbruin created at 2015-04-22 05:13:47

Changing status from needs_review to positive_review.


---

Comment by nbruin created at 2015-04-22 05:13:47

seems good to me!


---

Comment by vbraun created at 2015-04-23 03:21:55

Resolution: fixed


---

Comment by leif created at 2015-04-25 02:08:46

Please, guys, fix the milestones...  (It's odd enough "Merged in" gets no longer filled.)


---

Comment by vbraun created at 2015-04-25 02:10:59

this ticket was opened before 6.7


---

Comment by leif created at 2015-04-25 02:42:44

Replying to [comment:36 vbraun]:
> this ticket was opened before 6.7

So what?  Besides that `vbraun_spam` appears to be on holidays since a while, certainly 6.6 got released before this ticket got closed.  (And it's based on 6.7.beta2.)

If someone sees a closed milestone on a (closed) ticket, the first guess is that it'd been merged into that release.

I'm certainly not the only one not wanting having to read the ticket history and/or to look up the parent(s) of the commit to find out whether that's true or not.

Especially "ordinary" Sage users simply won't do that, e.g. if they want to find out whether a bug has already been fixed, and if so, in which [stable] release.


---

Comment by vbraun created at 2015-04-25 02:44:59

We agreed to not update the milestone at each new release. Karl-Dieter wanted to write a script to set the milestone (edit: I mean merged-in) after each release, I'm sure he would appreciate help...


---

Comment by leif created at 2015-04-25 03:06:46

Replying to [comment:38 vbraun]:
> We agreed to not update the milestone at each new release.

Why?  (Pointer?)

If so, then at least the milestone should get corrected by the authors/reviewers or the RM before it gets closed.

But it's annoying to have open (new/needs review/whatever) tickets for already closed milestones; usual queries will no longer work (as expected).





> Karl-Dieter wanted to write a script to set the milestone (edit: I mean merged-in) after each release, I'm sure he would appreciate help...

The only thing one needs is a "spam" trac account... ;-)


---

Comment by vbraun created at 2015-04-25 03:16:41

Replying to [comment:39 leif]:
> Why?  (Pointer?)

Google? ... sigh... http://thread.gmane.org/gmane.comp.mathematics.sage.devel/74794/focus=74860


---

Comment by leif created at 2015-04-25 04:38:40

Replying to [comment:40 vbraun]:
> Replying to [comment:39 leif]:
> > Why?  (Pointer?)
> 
> Google? 

Gmane!

> ... sigh... http://thread.gmane.org/gmane.comp.mathematics.sage.devel/74794/focus=74860


Quoting Ivan: _"Why can’t we just set them all to future, *and then when they get merged, we can change the milestone to the actual version*?"_
