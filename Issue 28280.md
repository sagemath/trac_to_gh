# Issue 28280: Make the evaluation of symbolic functions at intervals more reliable

Issue created by migration from https://trac.sagemath.org/ticket/28517

Original creator: mmezzarobba

Original creation time: 2019-09-18 16:30:21




---

Comment by mmezzarobba created at 2019-09-18 16:55:00

Changing status from new to needs_review.


---

Comment by git created at 2019-09-18 18:45:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-09-19 07:19:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-09-19 08:12:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-19 13:31:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-19 17:07:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2019-09-20 13:11:57

I'm done with the adjustments. The one test failure that the patchbot still reports does not seem linked to the changes made here.


---

Comment by git created at 2019-09-22 14:28:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-10-25 04:20:37

Some tests are failing at `408b2d7`

```
sage -t --long src/sage/functions/log.py
**********************************************************************
File "src/sage/functions/log.py", line 529, in sage.functions.log.Function_polylog.__init__
Failed example:
    polylog(2, BF(4/3))
Expected:
    [2.27001825336107090380391448586 +/- 5.64e-30] + [-0.90377988538400159956755721265 +/- 8.39e-30]*I
Got:
    nan
**********************************************************************
File "src/sage/functions/log.py", line 531, in sage.functions.log.Function_polylog.__init__
Failed example:
    parent(_)
Expected:
    Complex ball field with 100 bits of precision
Got:
    Real ball field with 100 bits of precision
**********************************************************************
1 item had failures:
   2 of  34 in sage.functions.log.Function_polylog.__init__
    [328 tests, 2 failures, 6.07 s]
```



---

Comment by vdelecroix created at 2019-10-25 04:20:37

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2019-10-25 12:40:52

Replying to [comment:11 vdelecroix]:
> Some tests are failing at `408b2d7`

Thank you. I would say that returning NaN in this case is acceptable (and perhaps better than returning a complex interval--I'm not sure), so I'm leaning toward changing the test to pass a complex ball instead of a real one. What do you think?


---

Comment by git created at 2019-11-17 11:30:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2019-11-19 07:51:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mmezzarobba created at 2019-11-19 07:51:55

rebased on py3-by-default beta


---

Comment by mmezzarobba created at 2019-11-19 07:51:55

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-11-19 14:46:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2019-11-19 16:32:35

Why is there `hasattr(parent, 'precision')` in the method `_is_numerical` of symbolic elements?


---

Comment by vdelecroix created at 2019-11-19 16:36:31

In the `_is_numercal` method of symbolics why not use directly the `parent_is_numerical` you introduced?


---

Comment by mmezzarobba created at 2019-11-19 18:16:31

Replying to [comment:17 vdelecroix]:
> Why is there `hasattr(parent, 'precision')` in the method `_is_numerical` of symbolic elements?

Part of the reason is that we don't want exact parents that correspond to real or complex numbers to be considered numerical in this context. I don't remember exactly why this is tested that way, but that predates this ticket.


---

Comment by mmezzarobba created at 2019-11-19 18:18:21

Replying to [comment:18 vdelecroix]:
> In the `_is_numercal` method of symbolics why not use directly the `parent_is_numerical` you introduced?

In part for the same reason as above. Probably also because I didn't want to deviate more than necessary from the behavior of the existing code in cases outside the scope of this ticket.


---

Comment by vdelecroix created at 2019-11-20 07:31:54

Replying to [comment:12 mmezzarobba]:
> Replying to [comment:11 vdelecroix]:
> > Some tests are failing at `408b2d7`
> 
> Thank you. I would say that returning NaN in this case is acceptable (and perhaps better than returning a complex interval--I'm not sure), so I'm leaning toward changing the test to pass a complex ball instead of a real one. What do you think?

If `nan` is what it is supposed to be for real balls then this should still be tested. Similarly with `sqrt(RBF(-2))`, `log(RBF(-2))`, etc. Though many functions perform base extension silently

```
sage: sqrt(-2.0)
1.41421356237310*I
sage: log(-2.0)
0.693147180559945 + 3.14159265358979*I
```

Why `RBF` should be different?


---

Comment by mmezzarobba created at 2019-11-20 13:17:22

Replying to [comment:21 vdelecroix]:
> If `nan` is what it is supposed to be for real balls then this should still be tested. Similarly with `sqrt(RBF(-2))`, `log(RBF(-2))`, etc. Though many functions perform base extension silently
> {{{
> sage: sqrt(-2.0)
> 1.41421356237310*I
> sage: log(-2.0)
> 0.693147180559945 + 3.14159265358979*I
> }}}
> Why `RBF` should be different?

I don't think it should (at least if the general rule for symbolic functions is to extend the domain, that is). As I remember it, there used to be a lot of inconsistencies regarding this point. But maybe I remember wrong, or things have improved.

Anyway, in the absence of any clear rule, I thought it safer not to do anything special for now. Changing from returning nan to returning a complex number later wouldn't break compatibility much compared to the inverse change. However, I'm completely open to having `polylog(2, RBF(4/3))` return a complex number (preferably as part of another ticket focusing on consistency in that respect)


---

Comment by mmezzarobba created at 2019-12-17 14:40:24

On the off chance someone reading this has a bit of time to review it: this ticket fixes several subtly incorrect results that apparently already trapped real users, it would be nice if it could go in 9.0!


---

Comment by git created at 2020-01-06 13:26:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by git created at 2020-01-10 13:26:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-03-02 07:53:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mmezzarobba created at 2020-03-02 10:24:36

Rebased to fix a minor incompatibility with #26749.


---

Comment by vdelecroix created at 2020-03-30 11:59:43

minor comments

- `In spite of its name` -> `Despite ...`
- In `The following conversions used to yield incorrect enclosures::` mention the ticket number with `:trac:`28517``.
- importing inconditionnally `from sage.symbolic.expression import Expression` in the complex ball constructor is not a good idea (slowdown)


---

Comment by mmezzarobba created at 2020-03-30 13:13:21

Hi Vincent,

Thank you for your comments!

Replying to [comment:29 vdelecroix]:
> - importing inconditionnally `from sage.symbolic.expression import Expression` in the complex ball constructor is not a good idea (slowdown)

Did you measure a slowdown (on what example) or you fear one? I'm asking because the import is not really unconditional: the fast path is the one where `self.element_class(self, _x)` succeeds.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by slabbe created at 2020-08-15 14:19:03

The branch needs to be rebased again.


---

Comment by slabbe created at 2020-08-15 14:19:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-18 15:17:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mmezzarobba created at 2020-08-18 15:20:10

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-18 21:02:12

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-08-18 21:02:12

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-08-18 21:02:12

Looks like an important improvement, which we should get into 9.2.


---

Comment by mmezzarobba created at 2020-08-19 06:31:10

Thanks for the review!


---

Comment by vbraun created at 2020-08-20 22:23:30

Resolution: fixed
