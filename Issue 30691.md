# Issue 30691: Backslash line continuation broken when defining a callable symbolic expression

archive/issues_030691.json:
```json
{
    "body": "CC:  @jcamp0x2a @slel\n\nKeywords: callable symbolic expression, backslash, preparser\n\nAs reported in https://groups.google.com/g/sage-devel/c/XD1VtG0TOEk/m/Lo6L8YBGCgAJ, we have currently (Sage 9.2 and 9.3.beta1):\n\n```\nsage: f(x) = x \\ \n....:        + 1                                                                                    \n  File \"<ipython-input-1-a5c1e14e19da>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)\n                                                                         ^\nSyntaxError: invalid syntax\n```\nThere was no such issue with Sage 9.1 and lower. \n\nIssue created by migration from https://trac.sagemath.org/ticket/30928\n\n",
    "closed_at": "2020-12-05T22:13:29Z",
    "created_at": "2020-11-16T16:42:16Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Backslash line continuation broken when defining a callable symbolic expression",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30691",
    "user": "https://github.com/egourgoulhon"
}
```
CC:  @jcamp0x2a @slel

Keywords: callable symbolic expression, backslash, preparser

As reported in https://groups.google.com/g/sage-devel/c/XD1VtG0TOEk/m/Lo6L8YBGCgAJ, we have currently (Sage 9.2 and 9.3.beta1):

```
sage: f(x) = x \ 
....:        + 1                                                                                    
  File "<ipython-input-1-a5c1e14e19da>", line 1
    __tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)
                                                                         ^
SyntaxError: invalid syntax
```
There was no such issue with Sage 9.1 and lower. 

Issue created by migration from https://trac.sagemath.org/ticket/30928





---

archive/issue_comments_438263.json:
```json
{
    "body": "The issue is already there in Sage 9.2.beta14.",
    "created_at": "2020-11-16T16:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438263",
    "user": "https://github.com/egourgoulhon"
}
```

The issue is already there in Sage 9.2.beta14.



---

archive/issue_comments_438264.json:
```json
{
    "body": "FWIW, in Sage 9.3.beta1, we have\n\n```\nsage: preparse(r\"f(x) = x \\ + 1\")                                                                  \n'__tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)'\n```\nwhich is correct, while in the reported issue the second line is entirely missing after `BackslahOperator() *`, which triggers the syntax error.",
    "created_at": "2020-11-17T07:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438264",
    "user": "https://github.com/egourgoulhon"
}
```

FWIW, in Sage 9.3.beta1, we have

```
sage: preparse(r"f(x) = x \ + 1")                                                                  
'__tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)'
```
which is correct, while in the reported issue the second line is entirely missing after `BackslahOperator() *`, which triggers the syntax error.



---

archive/issue_comments_438265.json:
```json
{
    "body": "The bug could arise from the upgrade to ipython 7 performed in #28197 (merged in Sage 9.2.beta8) or from the follow-up ticket #30417 (merged in Sage 9.2.beta11).",
    "created_at": "2020-11-17T08:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438265",
    "user": "https://github.com/egourgoulhon"
}
```

The bug could arise from the upgrade to ipython 7 performed in #28197 (merged in Sage 9.2.beta8) or from the follow-up ticket #30417 (merged in Sage 9.2.beta11).



---

archive/issue_comments_438266.json:
```json
{
    "body": "I may be off base, but the following may be important\n\n```\nsage: from sage.repl.interpreter import get_test_shell                                                                                                                                               \nsage: shell = get_test_shell()                                                                                                                                                                       \nsage: shell.run_cell('f(x) = x \\ + 1')                                                                                                                                                               \n<input>:1: DeprecationWarning: invalid escape sequence \\ \n<>:1: DeprecationWarning: invalid escape sequence \\ \n<ipython-input-19-e03ae3fa6f44>:1: DeprecationWarning: invalid escape sequence \\ \n  shell.run_cell('f(x) = x \\ + 1')\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-19-81598207d80e> in <module>\n----> 1 __tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)\n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/misc/misc.py in __mul__(self, right)\n    829             (0.0, 0.5, 1.0, 1.5, 2.0)\n    830         \"\"\"\n--> 831         return self.left._backslash_(right)\n    832 \n    833 \n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4701)()\n    491             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    492         \"\"\"\n--> 493         return self.getattr_from_category(name)\n    494 \n    495     cdef getattr_from_category(self, name):\n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4813)()\n    504         else:\n    505             cls = P._abstract_element_class\n--> 506         return getattr_from_other_class(self, cls, name)\n    507 \n    508     def __dir__(self):\n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2620)()\n    370         dummy_error_message.cls = type(self)\n    371         dummy_error_message.name = name\n--> 372         raise AttributeError(dummy_error_message)\n    373     attribute = <object>attr\n    374     # Check for a descriptor (__get__ in Python)\n\nAttributeError: 'sage.symbolic.expression.Expression' object has no attribute '_backslash_'\n<ExecutionResult object at 7f213d0cd130, execution_count=None error_before_exec=None error_in_exec='sage.symbolic.expression.Expression' object has no attribute '_backslash_' info=<ExecutionInfo object at 7f213d09fc40, raw_cell=\"f(x) = x \\ + 1\" store_history=False silent=False shell_futures=True> result=None>\n```",
    "created_at": "2020-11-18T00:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438266",
    "user": "https://github.com/strogdon"
}
```

I may be off base, but the following may be important

```
sage: from sage.repl.interpreter import get_test_shell                                                                                                                                               
sage: shell = get_test_shell()                                                                                                                                                                       
sage: shell.run_cell('f(x) = x \ + 1')                                                                                                                                                               
<input>:1: DeprecationWarning: invalid escape sequence \ 
<>:1: DeprecationWarning: invalid escape sequence \ 
<ipython-input-19-e03ae3fa6f44>:1: DeprecationWarning: invalid escape sequence \ 
  shell.run_cell('f(x) = x \ + 1')
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-19-81598207d80e> in <module>
----> 1 __tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/misc/misc.py in __mul__(self, right)
    829             (0.0, 0.5, 1.0, 1.5, 2.0)
    830         """
--> 831         return self.left._backslash_(right)
    832 
    833 

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4701)()
    491             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    492         """
--> 493         return self.getattr_from_category(name)
    494 
    495     cdef getattr_from_category(self, name):

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4813)()
    504         else:
    505             cls = P._abstract_element_class
--> 506         return getattr_from_other_class(self, cls, name)
    507 
    508     def __dir__(self):

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2620)()
    370         dummy_error_message.cls = type(self)
    371         dummy_error_message.name = name
--> 372         raise AttributeError(dummy_error_message)
    373     attribute = <object>attr
    374     # Check for a descriptor (__get__ in Python)

AttributeError: 'sage.symbolic.expression.Expression' object has no attribute '_backslash_'
<ExecutionResult object at 7f213d0cd130, execution_count=None error_before_exec=None error_in_exec='sage.symbolic.expression.Expression' object has no attribute '_backslash_' info=<ExecutionInfo object at 7f213d09fc40, raw_cell="f(x) = x \ + 1" store_history=False silent=False shell_futures=True> result=None>
```



---

archive/issue_comments_438267.json:
```json
{
    "body": "I get the same if `f(x) = x \\ + 1` is typed at the sage prompt. So probably not the correct thing to try.",
    "created_at": "2020-11-18T00:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438267",
    "user": "https://github.com/strogdon"
}
```

I get the same if `f(x) = x \ + 1` is typed at the sage prompt. So probably not the correct thing to try.



---

archive/issue_comments_438268.json:
```json
{
    "body": "Replying to [comment:5 strogdon]:\n> I get the same if `f(x) = x \\ + 1` is typed at the sage prompt. So probably not the correct thing to try.\n\nYes probably; moreover `shell.run_cell(r'f(x) = x \\ + 1')` yields the same `AttributeError` in Sage 9.1, where everything is fine with backslash line continuation.",
    "created_at": "2020-11-18T08:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438268",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:5 strogdon]:
> I get the same if `f(x) = x \ + 1` is typed at the sage prompt. So probably not the correct thing to try.

Yes probably; moreover `shell.run_cell(r'f(x) = x \ + 1')` yields the same `AttributeError` in Sage 9.1, where everything is fine with backslash line continuation.



---

archive/issue_comments_438269.json:
```json
{
    "body": "Some data points. I think `sage/repl/preparser.py` and perhaps `sage/repl/interpreter.py` need significant changes. Adding `print` statements as\n\n```diff\ndiff --git a/src/sage/repl/interpreter.py b/src/sage/repl/interpreter.py\nindex b70345f940..206041e4a1 100644\n--- a/src/sage/repl/interpreter.py\n+++ b/src/sage/repl/interpreter.py\n@@ -444,6 +444,7 @@ def SagePreparseTransformer(lines):\n         sage: # instead of [\"'''\", 'abc-Integer(1)-Integer(2)', \"'''\"]\n \n     \"\"\"\n+    print('we are now in sage.repl.interpreter.SagePreparseTransformer')\n     lines_out = []\n     reset = True\n     for line in lines:\ndiff --git a/src/sage/repl/preparse.py b/src/sage/repl/preparse.py\nindex 3619fd9e54..2073caa855 100644\n--- a/src/sage/repl/preparse.py\n+++ b/src/sage/repl/preparse.py\n@@ -1745,6 +1745,8 @@ def preparse(line, reset=True, do_time=False, ignore_prompts=False,\n         quote_state = None\n \n     L = line.lstrip()\n+    print('result of L = line.lstrip() in sage.repl.preparse')\n+    print(L)\n     if len(L) > 0 and L[0] in ['#', '!']:\n         return line\n```\nI see:\n\n```\nsage: f(x) = x \\ \n....:        + 1                                                                \nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n\nresult of L = line.lstrip() in sage.repl.preparse\n+ 1\n\nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n\nresult of L = line.lstrip() in sage.repl.preparse\n+ 1\n\n  File \"<ipython-input-1-a5c1e14e19da>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)\n                                                                         ^\nSyntaxError: invalid syntax\n```\nNote that `preparse` is called from `interpreter` and it is called twice! I don't believe it should be called twice. Furthermore `preparse` treats the input as two separate lines instead of one line separated by the `\\` continuation character. This results in `\\` being interpreted as the `* BackslashOperator() *`. I'm unable to test for a properly-functioning Sage.",
    "created_at": "2020-11-20T06:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438269",
    "user": "https://github.com/strogdon"
}
```

Some data points. I think `sage/repl/preparser.py` and perhaps `sage/repl/interpreter.py` need significant changes. Adding `print` statements as

```diff
diff --git a/src/sage/repl/interpreter.py b/src/sage/repl/interpreter.py
index b70345f940..206041e4a1 100644
--- a/src/sage/repl/interpreter.py
+++ b/src/sage/repl/interpreter.py
@@ -444,6 +444,7 @@ def SagePreparseTransformer(lines):
         sage: # instead of ["'''", 'abc-Integer(1)-Integer(2)', "'''"]
 
     """
+    print('we are now in sage.repl.interpreter.SagePreparseTransformer')
     lines_out = []
     reset = True
     for line in lines:
diff --git a/src/sage/repl/preparse.py b/src/sage/repl/preparse.py
index 3619fd9e54..2073caa855 100644
--- a/src/sage/repl/preparse.py
+++ b/src/sage/repl/preparse.py
@@ -1745,6 +1745,8 @@ def preparse(line, reset=True, do_time=False, ignore_prompts=False,
         quote_state = None
 
     L = line.lstrip()
+    print('result of L = line.lstrip() in sage.repl.preparse')
+    print(L)
     if len(L) > 0 and L[0] in ['#', '!']:
         return line
```
I see:

```
sage: f(x) = x \ 
....:        + 1                                                                
we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \

result of L = line.lstrip() in sage.repl.preparse
+ 1

we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \

result of L = line.lstrip() in sage.repl.preparse
+ 1

  File "<ipython-input-1-a5c1e14e19da>", line 1
    __tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)
                                                                         ^
SyntaxError: invalid syntax
```
Note that `preparse` is called from `interpreter` and it is called twice! I don't believe it should be called twice. Furthermore `preparse` treats the input as two separate lines instead of one line separated by the `\` continuation character. This results in `\` being interpreted as the `* BackslashOperator() *`. I'm unable to test for a properly-functioning Sage.



---

archive/issue_comments_438270.json:
```json
{
    "body": "I think this may have been introduced by the transition to IPython 7 and how its new input transformer API deals with lines. For example, commenting out the backslash substitution altogether in [preparse.py](https://github.com/sagemath/sage/blob/9.3.beta1/src/sage/repl/preparse.py#L1807) still yields:\n\n```python\nsage: f(x) = x \\\n....:        + 1\n  File \"<ipython-input-1-bc21d2198ee4>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression(x \\).function(x)\n                                                              ^\nSyntaxError: unexpected character after line continuation character\n```\n\nIn the old IPython [input transformer docs](https://ipython.org/ipython-doc/3/config/inputtransforms.html#string-based-transformations), it appears there were three types of transformer: physical line, logical line, and python line. In the [same docs](https://ipython.readthedocs.io/en/stable/config/inputtransforms.html#string-based-transformations) for IPython 7, there now only appears to be two: cleanup and post.\n\nJudging by the change to [ipython_extension.py](https://git.sagemath.org/sage.git/diff/src/sage/repl/ipython_extension.py?id=f55701e735b9cad2a04370b48f1148984477046a) for #28197, it looks like the SagePromptTransformer was moved from \"physical line\" to \"cleanup\" and SagePreparseTransformer from \"python line\" to \"post\".\n\nI'm wondering if that \"post\" is not quite the same as the old \"python line\" however and functions more like the old \"logical line\". That could explain why #30417 that I fixed arose in the first place.\n\nI have a couple ideas for how to patch this in the short term, but neither is likely to be particularly elegant. I'll play around with them and see if I can get something pushed in the next couple days.\n\nI agree with `@`strogdon that some significant changes/cleanup are needed in the preparser and interpreter in order to fix this properly. I know there was talk in #28974 about building a proper grammar and parser for Sage to remove the need for all these regex kludges. Would be a large undertaking though.",
    "created_at": "2020-11-20T20:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438270",
    "user": "https://github.com/jcamp0x2a"
}
```

I think this may have been introduced by the transition to IPython 7 and how its new input transformer API deals with lines. For example, commenting out the backslash substitution altogether in [preparse.py](https://github.com/sagemath/sage/blob/9.3.beta1/src/sage/repl/preparse.py#L1807) still yields:

```python
sage: f(x) = x \
....:        + 1
  File "<ipython-input-1-bc21d2198ee4>", line 1
    __tmp__=var("x"); f = symbolic_expression(x \).function(x)
                                                              ^
SyntaxError: unexpected character after line continuation character
```

In the old IPython [input transformer docs](https://ipython.org/ipython-doc/3/config/inputtransforms.html#string-based-transformations), it appears there were three types of transformer: physical line, logical line, and python line. In the [same docs](https://ipython.readthedocs.io/en/stable/config/inputtransforms.html#string-based-transformations) for IPython 7, there now only appears to be two: cleanup and post.

Judging by the change to [ipython_extension.py](https://git.sagemath.org/sage.git/diff/src/sage/repl/ipython_extension.py?id=f55701e735b9cad2a04370b48f1148984477046a) for #28197, it looks like the SagePromptTransformer was moved from "physical line" to "cleanup" and SagePreparseTransformer from "python line" to "post".

I'm wondering if that "post" is not quite the same as the old "python line" however and functions more like the old "logical line". That could explain why #30417 that I fixed arose in the first place.

I have a couple ideas for how to patch this in the short term, but neither is likely to be particularly elegant. I'll play around with them and see if I can get something pushed in the next couple days.

I agree with `@`strogdon that some significant changes/cleanup are needed in the preparser and interpreter in order to fix this properly. I know there was talk in #28974 about building a proper grammar and parser for Sage to remove the need for all these regex kludges. Would be a large undertaking though.



---

archive/issue_comments_438271.json:
```json
{
    "body": "I've pushed a potential fix.\n\n- `preparse` removes backslash+newline combinations, putting such constructions onto the same line. This happens after `strip_string_literals` so we don't have to worry about backslash continuations inside strings, and it happens before `preparse_calculus` so that it can surround the entire thing with a `symbolic_expression` call.\n\n- For the IPython use case, I've just squashed the list of lines into a single string and passed that to `preparse` instead of going line-by-line. The prompts should've already been removed by the `SagePromptTransformer` so I think that's a safe operation. Also, since IPython has already handled the `%` magic commands immediately prior to our `SagePreparseTransformer`, I removed the explicit check for them.\n\n- I've done something similar for the `preparse_file` use case with the complication of supporting `load` and `attach` statements. Basically, just calls `preparse` on batches between such statements and between them and the beginning/end of file.\n\nAs predicted: not the most elegant fix, and there's a fair chance I broke another edge case somewhere in the process. I'm not sure how else to fix it without tearing up a bunch of the existing preparser code. Input most welcome! :)\n\n---\nNew commits:",
    "created_at": "2020-11-21T23:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438271",
    "user": "https://github.com/jcamp0x2a"
}
```

I've pushed a potential fix.

- `preparse` removes backslash+newline combinations, putting such constructions onto the same line. This happens after `strip_string_literals` so we don't have to worry about backslash continuations inside strings, and it happens before `preparse_calculus` so that it can surround the entire thing with a `symbolic_expression` call.

- For the IPython use case, I've just squashed the list of lines into a single string and passed that to `preparse` instead of going line-by-line. The prompts should've already been removed by the `SagePromptTransformer` so I think that's a safe operation. Also, since IPython has already handled the `%` magic commands immediately prior to our `SagePreparseTransformer`, I removed the explicit check for them.

- I've done something similar for the `preparse_file` use case with the complication of supporting `load` and `attach` statements. Basically, just calls `preparse` on batches between such statements and between them and the beginning/end of file.

As predicted: not the most elegant fix, and there's a fair chance I broke another edge case somewhere in the process. I'm not sure how else to fix it without tearing up a bunch of the existing preparser code. Input most welcome! :)

---
New commits:



---

archive/issue_comments_438272.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-21T23:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438272",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_438273.json:
```json
{
    "body": "Initial testing indicates that line continuation is now working. However, regardless the input after the `sage: ` prompt, that input is parsed twice. Perhaps this is a separate issue or maybe not an issue? \n\nExample:\n\n```\nsage: f(x) = x \\ \n....:        + 1 \\ \n....:        + x^2                                                                                                                                                                                   \nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n       + 1 \\\n       + x^2\n\nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n       + 1 \\\n       + x^2\n\nsage: f(x)                                                                                                                                                                                           \nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x)\n\nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x)\n\nx^2 + x + 1\n```",
    "created_at": "2020-11-22T02:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438273",
    "user": "https://github.com/strogdon"
}
```

Initial testing indicates that line continuation is now working. However, regardless the input after the `sage: ` prompt, that input is parsed twice. Perhaps this is a separate issue or maybe not an issue? 

Example:

```
sage: f(x) = x \ 
....:        + 1 \ 
....:        + x^2                                                                                                                                                                                   
we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \
       + 1 \
       + x^2

we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \
       + 1 \
       + x^2

sage: f(x)                                                                                                                                                                                           
we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x)

we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x)

x^2 + x + 1
```



---

archive/issue_comments_438274.json:
```json
{
    "body": "Hmm... perhaps this is an IPython quirk? For example, running an IPython installed completely independently of Sage:\n\n```\n$ ~/.local/bin/ipython3\nPython 3.6.9 (default, Oct  8 2020, 12:12:24)\nType 'copyright', 'credits' or 'license' for more information\nIPython 7.16.1 -- An enhanced Interactive Python. Type '?' for help.\n\nIn [1]: def transform(lines):\n   ...:     print(lines)\n   ...:     return lines\n   ...:\n\nIn [2]: get_ipython().input_transformers_post.append(transform)\n\nIn [3]: 2 + 2\n['2 + 2\\n']\n['2 + 2\\n']\nOut[3]: 4\n```",
    "created_at": "2020-11-22T03:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438274",
    "user": "https://github.com/jcamp0x2a"
}
```

Hmm... perhaps this is an IPython quirk? For example, running an IPython installed completely independently of Sage:

```
$ ~/.local/bin/ipython3
Python 3.6.9 (default, Oct  8 2020, 12:12:24)
Type 'copyright', 'credits' or 'license' for more information
IPython 7.16.1 -- An enhanced Interactive Python. Type '?' for help.

In [1]: def transform(lines):
   ...:     print(lines)
   ...:     return lines
   ...:

In [2]: get_ipython().input_transformers_post.append(transform)

In [3]: 2 + 2
['2 + 2\n']
['2 + 2\n']
Out[3]: 4
```



---

archive/issue_comments_438275.json:
```json
{
    "body": "Same here with `Python 3.8.6`. Bug or feature?",
    "created_at": "2020-11-22T04:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438275",
    "user": "https://github.com/strogdon"
}
```

Same here with `Python 3.8.6`. Bug or feature?



---

archive/issue_comments_438276.json:
```json
{
    "body": "Replying to [comment:13 strogdon]:\n> Same here with `Python 3.8.6`. Bug or feature?\n\n\nLooks like intended behavior:\n\n- Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) \"Arrow printed twice for autocall\"\n\n- Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) \"Allow to mark transformers as having side effects\"\n\nThe new `has_side_effects` attribute would only work in IPython >= 7.17.0, and Sage only requires 7.13.0. Besides, the only side effects here *should* be our debugging print outs, so I vote to just let IPython do its thing.\n\nI'll add a bit about that attribute in `SagePreparseTransformer`'s docstring for those that stumble across this in the future.",
    "created_at": "2020-11-22T16:23:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438276",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:13 strogdon]:
> Same here with `Python 3.8.6`. Bug or feature?


Looks like intended behavior:

- Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) "Arrow printed twice for autocall"

- Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) "Allow to mark transformers as having side effects"

The new `has_side_effects` attribute would only work in IPython >= 7.17.0, and Sage only requires 7.13.0. Besides, the only side effects here *should* be our debugging print outs, so I vote to just let IPython do its thing.

I'll add a bit about that attribute in `SagePreparseTransformer`'s docstring for those that stumble across this in the future.



---

archive/issue_comments_438277.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-22T16:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438277",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438278.json:
```json
{
    "body": "Replying to [comment:14 gh-jcamp0x2a]:\n> Replying to [comment:13 strogdon]:\n> > Same here with `Python 3.8.6`. Bug or feature?\n\n> \n> Looks like intended behavior:\n> \n> - Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) \"Arrow printed twice for autocall\"\n> \n> - Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) \"Allow to mark transformers as having side effects\"\n> \n \nGood spotting this. I tried to search the ipython git repo bugs for this without success. I never considered that it was related to a closed issue. I have ipython-7.18.1 here on my Gentoo laptop. Your above `ipython` example, after importing `inputtransformer2` from `IPython.core` and then setting `inputtransformer2.has_side_effects = True`, does work\n\n```\nIn [5]: 2 + 2\n['2 + 2\\n']\nOut[5]: 4\n```\n\nI'm satisfied with this, but will wait to see if `@`egourgoulhon has any comments.",
    "created_at": "2020-11-23T01:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438278",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:14 gh-jcamp0x2a]:
> Replying to [comment:13 strogdon]:
> > Same here with `Python 3.8.6`. Bug or feature?

> 
> Looks like intended behavior:
> 
> - Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) "Arrow printed twice for autocall"
> 
> - Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) "Allow to mark transformers as having side effects"
> 
 
Good spotting this. I tried to search the ipython git repo bugs for this without success. I never considered that it was related to a closed issue. I have ipython-7.18.1 here on my Gentoo laptop. Your above `ipython` example, after importing `inputtransformer2` from `IPython.core` and then setting `inputtransformer2.has_side_effects = True`, does work

```
In [5]: 2 + 2
['2 + 2\n']
Out[5]: 4
```

I'm satisfied with this, but will wait to see if `@`egourgoulhon has any comments.



---

archive/issue_comments_438279.json:
```json
{
    "body": "Replying to [comment:16 strogdon]:\n> I'm satisfied with this, but will wait to see if `@`egourgoulhon has any comments.\n\nOr if anyone else has comments.",
    "created_at": "2020-11-23T01:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438279",
    "user": "https://github.com/strogdon"
}
```

Replying to [comment:16 strogdon]:
> I'm satisfied with this, but will wait to see if `@`egourgoulhon has any comments.

Or if anyone else has comments.



---

archive/issue_comments_438280.json:
```json
{
    "body": "Thanks for the fix!\n\nI made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.",
    "created_at": "2020-11-23T12:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438280",
    "user": "https://github.com/egourgoulhon"
}
```

Thanks for the fix!

I made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.



---

archive/issue_comments_438281.json:
```json
{
    "body": "Btw, while making tests for this ticket branch, I found another error:\n\n```\nsage: f(x) = (x +  \n....:         1)                                                                                    \n  File \"<ipython-input-10-ae23cb631161>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression((x + ).function(x)\n                                                   ^\nSyntaxError: invalid syntax\n```\nBut this does not pertain to the current ticket: it is already here in Sage 9.1.",
    "created_at": "2020-11-23T12:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438281",
    "user": "https://github.com/egourgoulhon"
}
```

Btw, while making tests for this ticket branch, I found another error:

```
sage: f(x) = (x +  
....:         1)                                                                                    
  File "<ipython-input-10-ae23cb631161>", line 1
    __tmp__=var("x"); f = symbolic_expression((x + ).function(x)
                                                   ^
SyntaxError: invalid syntax
```
But this does not pertain to the current ticket: it is already here in Sage 9.1.



---

archive/issue_comments_438282.json:
```json
{
    "body": "Replying to [comment:18 egourgoulhon]:\n> Thanks for the fix!\n> \n> I made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.\n> \n\n\nI think this is the same false positive that was identified in comment:8:ticket:30417. Trying to ignore it with `# noqa` didn't work, so I will use [an assertion](https://stackoverflow.com/questions/5033727/how-do-i-get-pyflakes-to-ignore-a-statement/12121404#12121404) to silence pyflakes for good.",
    "created_at": "2020-11-23T16:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438282",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:18 egourgoulhon]:
> Thanks for the fix!
> 
> I made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.
> 


I think this is the same false positive that was identified in comment:8:ticket:30417. Trying to ignore it with `# noqa` didn't work, so I will use [an assertion](https://stackoverflow.com/questions/5033727/how-do-i-get-pyflakes-to-ignore-a-statement/12121404#12121404) to silence pyflakes for good.



---

archive/issue_comments_438283.json:
```json
{
    "body": "Replying to [comment:19 egourgoulhon]:\n> Btw, while making tests for this ticket branch, I found another error:\n> \n> ```\n> sage: f(x) = (x +  \n> ....:         1)                                                                                    \n>   File \"<ipython-input-10-ae23cb631161>\", line 1\n>     __tmp__=var(\"x\"); f = symbolic_expression((x + ).function(x)\n>                                                    ^\n> SyntaxError: invalid syntax\n> ```\n> But this does not pertain to the current ticket: it is already here in Sage 9.1. \n\n\nThe code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.",
    "created_at": "2020-11-23T16:26:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438283",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:19 egourgoulhon]:
> Btw, while making tests for this ticket branch, I found another error:
> 
> ```
> sage: f(x) = (x +  
> ....:         1)                                                                                    
>   File "<ipython-input-10-ae23cb631161>", line 1
>     __tmp__=var("x"); f = symbolic_expression((x + ).function(x)
>                                                    ^
> SyntaxError: invalid syntax
> ```
> But this does not pertain to the current ticket: it is already here in Sage 9.1. 


The code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.



---

archive/issue_comments_438284.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-23T16:26:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438284",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_438285.json:
```json
{
    "body": "Replying to [comment:21 gh-jcamp0x2a]:\n> The code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.\n\n\nOK very good!",
    "created_at": "2020-11-23T16:44:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438285",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:21 gh-jcamp0x2a]:
> The code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.


OK very good!



---

archive/issue_comments_438286.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-23T17:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438286",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438287.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-23T18:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438287",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_438288.json:
```json
{
    "body": "Not trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.\n\nOn the bright side, I *was* able to quickly add support for breaking the parameter list onto multiple lines like so:\n\n```python\nf(a,\n  b,\n  c,\n  d) = a + b*2 + c*3 + d*4\n```\n\n...and we'll see what pyflakes has to say now. :)",
    "created_at": "2020-11-23T18:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438288",
    "user": "https://github.com/jcamp0x2a"
}
```

Not trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.

On the bright side, I *was* able to quickly add support for breaking the parameter list onto multiple lines like so:

```python
f(a,
  b,
  c,
  d) = a + b*2 + c*3 + d*4
```

...and we'll see what pyflakes has to say now. :)



---

archive/issue_comments_438289.json:
```json
{
    "body": "Replying to [comment:24 gh-jcamp0x2a]:\n> Not trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.\n\n\nCreated #30953 to track this.",
    "created_at": "2020-11-23T18:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438289",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:24 gh-jcamp0x2a]:
> Not trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.


Created #30953 to track this.



---

archive/issue_comments_438290.json:
```json
{
    "body": "Not sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.",
    "created_at": "2020-11-25T05:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438290",
    "user": "https://github.com/strogdon"
}
```

Not sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.



---

archive/issue_comments_438291.json:
```json
{
    "body": "Replying to [comment:26 strogdon]:\n> Not sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.\n\n\nYea, doesn't look like a very happy patchbot. :) Looking through it's history, I don't see a single green TestsPassed result, so I don't think it's due to anything introduced here.",
    "created_at": "2020-11-25T05:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438291",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:26 strogdon]:
> Not sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.


Yea, doesn't look like a very happy patchbot. :) Looking through it's history, I don't see a single green TestsPassed result, so I don't think it's due to anything introduced here.



---

archive/issue_comments_438292.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-25T05:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438292",
    "user": "https://github.com/strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_438293.json:
```json
{
    "body": "Eric please add your name to reviewers if you agree.",
    "created_at": "2020-11-25T05:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438293",
    "user": "https://github.com/strogdon"
}
```

Eric please add your name to reviewers if you agree.



---

archive/issue_comments_438294.json:
```json
{
    "body": "Thank you very much for having fixed this!",
    "created_at": "2020-11-25T10:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438294",
    "user": "https://github.com/egourgoulhon"
}
```

Thank you very much for having fixed this!



---

archive/issue_comments_438295.json:
```json
{
    "body": "Replying to [comment:29 egourgoulhon]:\n> Thank you very much for having fixed this!\n\n\nYou are most welcome!\n\nI'm going to spend some time brainstorming ways to make the preparser more robust, potentially including building that proper grammar/parser I mentioned earlier. Might have to be a year-long goal for 2021, though. :)",
    "created_at": "2020-11-25T16:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438295",
    "user": "https://github.com/jcamp0x2a"
}
```

Replying to [comment:29 egourgoulhon]:
> Thank you very much for having fixed this!


You are most welcome!

I'm going to spend some time brainstorming ways to make the preparser more robust, potentially including building that proper grammar/parser I mentioned earlier. Might have to be a year-long goal for 2021, though. :)



---

archive/issue_comments_438296.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-05T22:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30691#issuecomment-438296",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_080763.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-05T22:13:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30691",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30691#event-80763"
}
```
