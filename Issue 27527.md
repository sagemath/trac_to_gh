# Issue 27527: configure flint with --disable-tls

Issue created by migration from https://trac.sagemath.org/ticket/27764

Original creator: dimpase

Original creation time: 2019-05-03 16:00:55

CC:  embray fbissey mkoeppe dcoudert

By default, TLS (aka Thread-Local Storage) is enabled in flint.
However, it contradicts to NTL configured without threads (`NTL_THREADS=off`), and in particular non-GNU linkers might refuse to link flint
(actually happens on FreeBSD).


---

Comment by dimpase created at 2019-05-03 16:06:08

New commits:


---

Comment by dimpase created at 2019-05-03 16:28:28

Changing status from new to needs_review.


---

Comment by fbissey created at 2019-05-03 20:08:41

By default the latest `ntl` should use threads - when the compiler is C++11 capable. Is it disabled on some OS/archs?


---

Comment by dimpase created at 2019-05-03 20:27:46

this is what Sage does, it disables threads in NTL. 
https://github.com/sagemath/sage/blob/5ba5a5a40cd33901c5f4307d59aa68a4359b0430/build/pkgs/ntl/spkg-install#L103


---

Comment by dimpase created at 2019-05-03 20:34:37

an intelligent setup would sync this between dependencies automatically, but this seems to be not so easy.


---

Comment by fbissey created at 2019-05-03 20:37:12

Replying to [comment:4 dimpase]:
> this is what Sage does, it disables threads in NTL. 
> https://github.com/sagemath/sage/blob/5ba5a5a40cd33901c5f4307d59aa68a4359b0430/build/pkgs/ntl/spkg-install#L103

Well, we shouldn't anymore. I should have taken care of this during the ntl upgrade and things about C++11 standard. Unless there is a compelling reason to do so, I would recommend removing `NTL_THREADS=off` from ntl's spkg-install.


---

Comment by fbissey created at 2019-05-03 20:44:04

On the other hand, flint's configuration system is un-impressive to me. And flint uses C++ for a grand total of compiling one file for the ntl interface. Which is optional. I have no idea if this is useful for anything.


---

Comment by dimpase created at 2019-05-03 20:55:25

flint’s interface to NTL is used in sagelib. So it cannot just be switched off.


---

Comment by fbissey created at 2019-05-03 20:58:37

Replying to [comment:9 dimpase]:
> flint’s interface to NTL is used in sagelib. So it cannot just be switched off.

OK. That make something clearer to me.


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by fbissey created at 2019-07-16 23:47:24

Needs rebasing.


---

Comment by git created at 2019-07-17 09:25:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-17 09:25:49

OK, done.


---

Comment by fbissey created at 2019-07-18 02:10:55

OK now that I see again what was done and that I remember the conversation let's move on a bit. There are two options

* enabling threads in NTL and letting flint do the same
* leaving threads disabled in NTL and applying this ticket

Is there any reason or platforms preventing us from enabling threads in NTL? We historically disabled threads in NTL because it relied on C++11 and we weren't on board with it for all packages and that was causing problems on downstream packages where c++11 wasn't on. This should be solved now. So is there another reason we cannot enable threads in NTL?


---

Comment by dimpase created at 2019-07-18 08:18:56

I suppose enabling threads in NTL and flint, and all its dependencies e.g. arb, needs testing on all platforms we claim to support.


---

Comment by fbissey created at 2019-07-18 08:21:28

That's a bot job. Literally. We should make a threading branch and see how the patch bots likes it.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-03-15 18:20:47

Also related: build errors with Singular if NTL is threaded (see #29339/#29104).


---

Comment by mkoeppe created at 2020-03-15 18:29:12

Replying to [comment:17 fbissey]:
> We should make a threading branch and see how the patch bots likes it.

I have created ticket #29340 for this purpose. 
If someone wants to work on this (this requires fixing the problem with SIngular...),
I'll be happy to test it using the new [GitHub](GitHub) CI infrastructure.


---

Comment by mkoeppe created at 2020-03-15 18:30:25

For the present ticket -- is there any platform other than FreeBSD where this has been observed to be a problem?


---

Comment by mkoeppe created at 2020-04-18 16:46:57

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2020-08-23 09:09:25

yes, this happens on macOS 10.15 too, it seems

```
[sagelib-9.2.beta9] clang++ -bundle -undefined dynamic_lookup -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -L/Users/dima/software/sagetrac-mirror/local/lib -Wl,-rpath,/Users/dima/software/sagetrac-mirror/local/lib build/temp.macosx-10.15-x86_64-3.7/build/cythonized/sage/matrix/matrix_integer_sparse.o -L/usr/local/Cellar/openblas/0.3.10_1/lib -L/Users/dima/software/sagetrac-mirror/local/lib -L/usr/local/lib -L/usr/local/opt/openssl@1.1/lib -L/usr/local/opt/sqlite/lib -llinbox -lntl -liml -lfflas -lffpack -lgivaro -lflint -lmpfr -lgmp -lgmpxx -lopenblas -o build/lib.macosx-10.15-x86_64-3.7/sage/matrix/matrix_integer_sparse.cpython-37m-darwin.so -lpari
[sagelib-9.2.beta9] ld: illegal thread local variable reference to regular symbol __ZN3NTL20ZZXFac_InitNumPrimesE for architecture x86_64
```



---

Comment by mkoeppe created at 2020-09-09 01:17:59

Changing priority from major to blocker.


---

Comment by dimpase created at 2020-10-07 10:22:02

from what I recall - I was able to build and test Sage 9.2.beta12 on Homebrew macOS 10.15.6
using Homebrew's Flint and NTL, which do come with threads enabled. (Unfortunately the machine is bricked now, so I can't verify).
Moving this to 9.3.


---

Comment by mkoeppe created at 2020-12-28 04:42:40

Changing priority from blocker to major.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
