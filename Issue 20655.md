# Issue 20655: package polymake 3.0

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2016-06-27 15:40:59

CC:  dimpase mkoeppe chapoton â€‹stumpc5 moritz tscrim

Package now compiles out of the box! There will be a next ticket for its interface within Sage.


---

Comment by vdelecroix created at 2016-06-27 15:42:38

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-06-27 15:42:38

New commits:


---

Comment by git created at 2016-06-27 16:35:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-06-27 16:49:06

Installation fails on Mac OS X:

```
[polymake-3.0r1] Found local metadata for polymake-3.0r1
[polymake-3.0r1] Using cached file /Users/mkoeppe/cvs/sage/upstream/polymake-3.0r1.tar.bz2
[polymake-3.0r1] polymake-3.0r1
[polymake-3.0r1] ====================================================
[polymake-3.0r1] Setting up build directory for polymake-3.0r1
[polymake-3.0r1] Finished extraction
[polymake-3.0r1] ****************************************************
[polymake-3.0r1] Host system:
[polymake-3.0r1] Darwin egret.local 15.5.0 Darwin Kernel Version 15.5.0: Tue Apr 19 18:36:36 PDT 2016; root:xnu-3248.50.21~8/RELEASE_X86_64 x86_64
[polymake-3.0r1] ****************************************************
[polymake-3.0r1] C compiler: gcc
[polymake-3.0r1] C compiler version:
[polymake-3.0r1] Using built-in specs.
[polymake-3.0r1] COLLECT_GCC=/Users/mkoeppe/cvs/sage/local/bin/gcc
[polymake-3.0r1] COLLECT_LTO_WRAPPER=/Users/mkoeppe/cvs/sage/local/libexec/gcc/x86_64-apple-darwin15.2.0/4.9.2/lto-wrapper
[polymake-3.0r1] Target: x86_64-apple-darwin15.2.0
[polymake-3.0r1] Configured with: ../src/configure --prefix=/Users/mkoeppe/cvs/sage/local --with-local-prefix=/Users/mkoeppe/cvs/sage/local --with-gmp=/Users/mkoeppe/cvs/sage/local --with-mpfr=/Users/mkoeppe/cvs/sage/local --with-mpc=/Users/mkoeppe/cvs/sage/local --with-system-zlib --disable-multilib --disable-nls --enable-languages=c,c++,fortran --disable-libitm --with-build-config=bootstrap-debug --without-isl --without-cloog  
[polymake-3.0r1] Thread model: posix
[polymake-3.0r1] gcc version 4.9.2 (GCC) 
[polymake-3.0r1] ****************************************************
[polymake-3.0r1] checking C++ compiler ... ok (g++ is GCC 4.9.2)
[polymake-3.0r1] checking C++ library ... ok (GNU stdlibc++ 20141030, C++ 199711)
[polymake-3.0r1] checking fink installation ... ok (/sw)
[polymake-3.0r1] checking fink gmp installation ... ok
[polymake-3.0r1] checking fink mpfr installation ... ok
[polymake-3.0r1] determining compiler flags ... ok
[polymake-3.0r1]    CFLAGS= -Wall ${ARCHFLAGS}
[polymake-3.0r1]    CXXFLAGS= -ftemplate-depth-200 -Wall -Wno-strict-aliasing -Wno-parentheses -fwrapv -fopenmp ${ARCHFLAGS}
[polymake-3.0r1] checking gmp installation ... ok (/sw)
[polymake-3.0r1] checking mpfr installation ... ok
[polymake-3.0r1] checking shared perl library ... failed
[polymake-3.0r1] 
[polymake-3.0r1] Could not compile a test program for the libperl.bundle shared library.
[polymake-3.0r1] The build error is as follows:
[polymake-3.0r1] /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//polymake_54759_configure.cc: In function 'int main(int, char**, char**)':
[polymake-3.0r1] /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//polymake_54759_configure.cc:8:40: warning: deprecated conversion from string constant to 'char*' [-Wwrite-strings]
[polymake-3.0r1]     char *embedding[] = { "", "-e", "0" };
[polymake-3.0r1]                                         ^
[polymake-3.0r1] /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//polymake_54759_configure.cc:8:40: warning: deprecated conversion from string constant to 'char*' [-Wwrite-strings]
[polymake-3.0r1] /var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//polymake_54759_configure.cc:8:40: warning: deprecated conversion from string constant to 'char*' [-Wwrite-strings]
[polymake-3.0r1] <stdin>:18:8: error: register %rbp is only available in 64-bit mode
[polymake-3.0r1]         pushq   %rbp
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:20:7: error: register %rsp is only available in 64-bit mode
[polymake-3.0r1]         movq    %rsp, %rbp
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:22:12: error: register %rsp is only available in 64-bit mode
[polymake-3.0r1]         subq    $64, %rsp
[polymake-3.0r1]                      ^~~~
[polymake-3.0r1] <stdin>:23:17: error: register %rbp is only available in 64-bit mode
[polymake-3.0r1]         movl    %edi, -36(%rbp)
[polymake-3.0r1]                           ^~~~
[polymake-3.0r1] <stdin>:24:7: error: register %rsi is only available in 64-bit mode
[polymake-3.0r1]         movq    %rsi, -48(%rbp)
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:25:7: error: register %rdx is only available in 64-bit mode
[polymake-3.0r1]         movq    %rdx, -56(%rbp)
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:28:11: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         leaq    LC0(%rip), %rax
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:29:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, -32(%rbp)
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:30:11: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         leaq    LC1(%rip), %rax
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:31:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, -24(%rbp)
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:32:11: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         leaq    LC2(%rip), %rax
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:33:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, -16(%rbp)
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:35:11: error: register %rbp is only available in 64-bit mode
[polymake-3.0r1]         leaq    -56(%rbp), %rdx
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:36:11: error: register %rbp is only available in 64-bit mode
[polymake-3.0r1]         leaq    -48(%rbp), %rcx
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:37:11: error: register %rbp is only available in 64-bit mode
[polymake-3.0r1]         leaq    -36(%rbp), %rax
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:38:7: error: register %rcx is only available in 64-bit mode
[polymake-3.0r1]         movq    %rcx, %rsi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:39:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, %rdi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:43:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, __ZL7my_perl(%rip)
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:45:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rax
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:46:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, %rdi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:49:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rax
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:50:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rdx
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:51:14: error: register %rdx is only available in 64-bit mode
[polymake-3.0r1]         movzbl  1150(%rdx), %edx
[polymake-3.0r1]                      ^~~~
[polymake-3.0r1] <stdin>:53:17: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movb    %dl, 1150(%rax)
[polymake-3.0r1]                           ^~~~
[polymake-3.0r1] <stdin>:55:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rax
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:56:11: error: register %rbp is only available in 64-bit mode
[polymake-3.0r1]         leaq    -32(%rbp), %rdx
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:57:11: error: register %r8d is only available in 64-bit mode
[polymake-3.0r1]         movl    $0, %r8d
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:58:7: error: register %rdx is only available in 64-bit mode
[polymake-3.0r1]         movq    %rdx, %rcx
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:61:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, %rdi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:64:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rax
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:65:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, %rdi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:68:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rax
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:70:11: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         leaq    LC3(%rip), %rsi
[polymake-3.0r1]                     ^~~~
[polymake-3.0r1] <stdin>:71:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, %rdi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:74:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rax
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:75:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, %rdi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] <stdin>:78:20: error: register %rip is only available in 64-bit mode
[polymake-3.0r1]         movq    __ZL7my_perl(%rip), %rax
[polymake-3.0r1]                              ^~~~
[polymake-3.0r1] <stdin>:79:7: error: register %rax is only available in 64-bit mode
[polymake-3.0r1]         movq    %rax, %rdi
[polymake-3.0r1]                 ^~~~
[polymake-3.0r1] 
[polymake-3.0r1] 
[polymake-3.0r1] On some systems the library is contained in a separate package named like
[polymake-3.0r1] perl-devel or libperl-dev.  Please look for such a package and install it.
[polymake-3.0r1] 
[polymake-3.0r1] As a last resort, you can configure polymake with the option --without-callable .
[polymake-3.0r1] You won't be able to build the callable library any more, but at least you get
[polymake-3.0r1] polymake compiled.
[polymake-3.0r1] Several configurations for MacOS platform found;
[polymake-3.0r1] Please specify the desired one using the option Arch=<NAME>.
[polymake-3.0r1] Makefile:32: *** CONFIGURATION ERROR.  Stop.
[polymake-3.0r1] 
[polymake-3.0r1] real	0m1.446s
[polymake-3.0r1] user	0m0.940s
[polymake-3.0r1] sys	0m0.350s
[polymake-3.0r1] ************************************************************************
[polymake-3.0r1] Error installing package polymake-3.0r1
[polymake-3.0r1] ************************************************************************
[polymake-3.0r1] Please email sage-devel (http://groups.google.com/group/sage-devel)
[polymake-3.0r1] explaining the problem and including the relevant part of the log file
[polymake-3.0r1]   /Users/mkoeppe/cvs/sage/logs/pkgs/polymake-3.0r1.log
[polymake-3.0r1] Describe your computer, operating system, etc.
[polymake-3.0r1] If you want to try to fix the problem yourself, *don't* just cd to
[polymake-3.0r1] /Users/mkoeppe/cvs/sage/local/var/tmp/sage/build/polymake-3.0r1 and type 'make' or whatever is appropriate.
[polymake-3.0r1] Instead, the following commands setup all environment variables
[polymake-3.0r1] correctly and load a subshell for you to debug the error:
[polymake-3.0r1]   (cd '/Users/mkoeppe/cvs/sage/local/var/tmp/sage/build/polymake-3.0r1' && '/Users/mkoeppe/cvs/sage/sage' --sh)
[polymake-3.0r1] When you are done debugging, you can type "exit" to leave the subshell.
[polymake-3.0r1] ************************************************************************
make[1]: *** [/Users/mkoeppe/cvs/sage/local/var/lib/sage/installed/polymake-3.0r1] Error 1
```



---

Comment by mkoeppe created at 2016-06-27 16:55:02

It finds my Fink installation (though I removed it from PATH for building Sage) -- should this be disabled?
It does not find Perl -- should I install it in Fink or should we have a Perl package in Sage as a prerequisite?


---

Comment by dimpase created at 2016-06-27 16:55:42

this might be a mismatch between the code emitted by quite new gcc and old assembler, which is unable to compile this into binary. There were a number of such OSX-only reports recently, check the sage-develop...


---

Comment by dimpase created at 2016-06-27 16:57:16

yeah, try to move Fink totally to some /opt/blah place and try again...


---

Comment by mkoeppe created at 2016-06-27 17:10:16

OK. After hiding Fink, I get:

```
[polymake-3.0r1] checking fink installation ... The Fink package system is a mandatory prerequisite to build and use polymake under MacOS.
[polymake-3.0r1] Please refer to http://www.polymake.org/doku.php/mac for details and installation instructions.
[polymake-3.0r1] If you already have Fink installed at a non-standard location, please specify it using option --with-fink
```


I'll start again with a fresh install of Fink and install some perl there.


---

Comment by mkoeppe created at 2016-06-27 18:09:49

I will first try to install polymake from source outside of Sage -- this already fails on my machine; I have asked in the Polymake forum for help.

Vincent: I think the right package to use in Sage would be the "minimal" package which picks up cdd, lrs, nauty from the Sage distribution.


---

Comment by git created at 2016-06-27 21:36:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-06-27 21:37:21

Replying to [comment:11 mkoeppe]:
> Vincent: I think the right package to use in Sage would be the "minimal" package which picks up cdd, lrs, nauty from the Sage distribution.  

right. done.


---

Comment by git created at 2016-06-27 21:42:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-06-27 22:20:11

See #20894 for a first step towards an OS X build


---

Comment by mkoeppe created at 2016-06-28 01:03:38

I solved the problem on Mac OS X with the following patch for Polymake, which gets rid of various "-arch" options. The "-arch" options caused the above errors "register %rbp is only available in 64-bit mode" etc.  


```
--- /Users/mkoeppe/s/polymake-3.0/support/configure.pl	2016-01-25 05:34:27.000000000 -0800
+++ src/support/configure.pl	2016-06-27 16:13:24.000000000 -0700
`@``@` -503,7 +503,7 `@``@`
       }
       print "ok\n";
       if ( $NeedsArchFlag ) {
-         $ARCHFLAGS="-arch $Platform";
+         $ARCHFLAGS="";
       } else {
          $ARCHFLAGS="";
       }
`@``@` -525,7 +525,7 `@``@`
          }
       }
       if ( $NeedsArchFlag ) {
-         $ARCHFLAGS="-arch $Platform";
+         $ARCHFLAGS="";
       } else {
          $ARCHFLAGS="";
       }
`@``@` -738,7 +738,14 `@``@`
       # We also build a test program for libperl since e.g. on Debian based systems the
       # check for Config::Config{libperl} will not detect a missing libperl-dev package
       chomp(my $perlldflags = `$PERL -MExtUtils::Embed -e ldopts`);
-      my $build_error=build_test_program(<<'---', CXXflags => `$PERL -MExtUtils::Embed -e ccopts`, LDflags => "$ARCHFLAGS $perlldflags" );
+
+      my $allarch=qr/ -arch \s+ \S+ (?: \s+ -arch \s+ \S+)* /x;
+      $CXXflags =  `$PERL -MExtUtils::Embed -e ccopts` ;
+      $CXXflags =~ s/$allarch//o;
+      $LDflags = $perlldflags;
+      $LDflags =~ s/$allarch//o;
+
+      my $build_error=build_test_program(<<'---', CXXflags => $CXXflags , LDflags => $LDflags );
 #include <EXTERN.h>
 #include <perl.h>
 
```


And here is a quick change to `spkg-install`.

```
diff --git a/build/pkgs/polymake/spkg-install b/build/pkgs/polymake/spkg-install
index f8e6145..2198466 100755
--- a/build/pkgs/polymake/spkg-install
+++ b/build/pkgs/polymake/spkg-install
`@``@` -7,6 +7,7 `@``@` cd src
             --exec-prefix="$SAGE_LOCAL" \
             --includedir="$SAGE_LOCAL"/include \
             --bindir="$SAGE_LOCAL"/bin \
-            --libdir="$SAGE_LOCAL"/lib
+            --libdir="$SAGE_LOCAL"/lib \
+	    --without-fink
 make
 make install
```


With these changes, Polymake built successfully.


---

Comment by kcrisman created at 2016-06-28 03:52:32

Can you make a package with this?  I tried to test it by creating the right patch directory and changing the spkg-install for applying patches but I tend to always make a mess of that.  Anyway, having done that, it did get quite a bit further (including #20894) though I did get some warnings e.g.

```
[polymake-3.0r1] bundled extension group ... disabled because of unsatisfied prerequisite: lrs
```

But anyway it is making vastly more progress than before, so please bundle this up and with any luck I can help give positive review (I'm assuming it will take a little longer than I want to stay up now to finish!).  Great, great work.


---

Comment by mkoeppe created at 2016-06-28 04:03:15

#20692 could help with automating the patching.


---

Comment by mkoeppe created at 2016-06-28 04:11:25

Replying to [comment:18 kcrisman]:
> I did get some warnings e.g.
> {{{
> [polymake-3.0r1] bundled extension group ... disabled because of unsatisfied prerequisite: lrs
> }}}

Yes, I also get a few of those, but the polymake install goes through after that. Details of the 'bundled extensions' can be found in the package build directory (`$SAGE_LOCAL/var/tmp/sage/build/polymake-3.0r1/src/build.darwin.x86_64/bundled.log`):


```
Configuration of the following bundled extensions failed, proceeding without them.
If you really need them, please carefully read the following explanations,
take the suggested actions, and repeat the configuration.

---- bliss ----

Could not compile a test program checking for bliss library.
The most probable reasons are that the library is installed at a non-standard location,
is not configured to build a shared module, or missing at all.
The complete error log follows:

/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//polymake_25377_configure.cc:1:26: fatal error: bliss/graph.hh: No such file or directory
 #include "bliss/graph.hh"
                          ^
compilation terminated.

Please install the library and specify its location using --with-bliss option, if needed.
Please remember to enable shared modules when configuring the bliss library!

If you are running a Debian system and now see some missing GMP functions in the error message,
then you've got an old broken bliss package;  please upgrade it to the latest version.

```


I don't know what bliss is but I tried to install it -- but it gave me an error. Reported on #20871.


```
---- lrs ----

Could not compile a test program checking for lrs library.
The most probable reasons are that the library is installed at a non-standard location,
is not configured to build a shared module, or missing at all.
The complete error log follows:

Undefined symbols for architecture x86_64:
  "_lrs_ifp", referenced from:
      _readrat in liblrsgmp.a(lrsgmp-GMP.o)
      _readmp in liblrsgmp.a(lrsgmp-GMP.o)
      _lrs_mp_init in liblrsgmp.a(lrsgmp-GMP.o)
  "_lrs_ofp", referenced from:
      _readrat in liblrsgmp.a(lrsgmp-GMP.o)
      _pmp in liblrsgmp.a(lrsgmp-GMP.o)
      _prat in liblrsgmp.a(lrsgmp-GMP.o)
      _readmp in liblrsgmp.a(lrsgmp-GMP.o)
      _lrs_mp_init in liblrsgmp.a(lrsgmp-GMP.o)
ld: symbol(s) not found for architecture x86_64
collect2: error: ld returned 1 exit status

Please install the library and specify its location using --with-lrs option, if needed.
Please remember to enable shared modules when configuring the lrs library!
```


I do have lrslib installed. This needs investigating.


```
---- singular ----

Could not find 'libsingular-config' in path at bundled/singular/configure.pl line 36.
```


I think singular is standard, but there seems to be no `libsingular-config`.



```
---- soplex ----

Could not compile a test program checking for SoPlex.
Please make sure SoPlex was compiled with 'GMP=true' and 'SHARED=true'
and specify its location using --with-soplex=PATH.
The complete error log follows:

/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gn/T//polymake_25377_configure.cc:3:20: fatal error: soplex.h: No such file or directory
 #include "soplex.h"
                    ^
compilation terminated.

```

OK, yes, we don't have SoPlex. This is part of the SCIP Optimization Suite. (#10879)


---

Comment by mkoeppe created at 2016-06-28 04:34:43

Replying to [comment:20 mkoeppe]:
> {{{
> ---- lrs ----
> 
> Could not compile a test program checking for lrs library.
> The most probable reasons are that the library is installed at a non-standard location,
> is not configured to build a shared module, or missing at all.
> The complete error log follows:
> 
> Undefined symbols for architecture x86_64:
>   "_lrs_ifp", referenced from:
>       _readrat in liblrsgmp.a(lrsgmp-GMP.o)
>       _readmp in liblrsgmp.a(lrsgmp-GMP.o)
>       _lrs_mp_init in liblrsgmp.a(lrsgmp-GMP.o)
>   "_lrs_ofp", referenced from:
>       _readrat in liblrsgmp.a(lrsgmp-GMP.o)
>       _pmp in liblrsgmp.a(lrsgmp-GMP.o)
>       _prat in liblrsgmp.a(lrsgmp-GMP.o)
>       _readmp in liblrsgmp.a(lrsgmp-GMP.o)
>       _lrs_mp_init in liblrsgmp.a(lrsgmp-GMP.o)
> ld: symbol(s) not found for architecture x86_64
> collect2: error: ld returned 1 exit status
> 
> Please install the library and specify its location using --with-lrs option, if needed.
> Please remember to enable shared modules when configuring the lrs library!
> }}}
> 
> I do have lrslib installed. This needs investigating.

Apparently it needs the shared library. This is #20886.


---

Comment by kcrisman created at 2016-06-28 14:21:40

bliss is like nauty.  I think we even have a package for it, or maybe it's even standard.


---

Comment by kcrisman created at 2016-06-28 19:45:02

Some stuff from the tutorial works, some not.

```
$ ./sage -sh -c polymake
Welcome to polymake version 3.0
Copyright (c) 1997-2015
Ewgenij Gawrilow, Michael Joswig (TU Berlin)
http://www.polymake.org

This is free software licensed under GPL; see the source for copying conditions.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Press F1 or enter 'help;' for basic instructions.

Application polytope currently uses following third-party software packages:
cdd, libnormaliz, ppl, sketch, threejs, tikz, tosimplex
For more details:  show_credits;

Warning: some rulefiles could not be configured automatically
due to lacking third-party software and/or other issues.
To see the complete list: show_unconfigured;
polytope > $points=new Matrix<Rational>([[1,-1,-1],[1,1,-1],[1,-1,1],[1,1,1],[1,0,0]]);

polytope > $p=new Polytope<Rational>(POINTS=>$points);

polytope > print isomorphic(cube(2),$p);

polymake:  ERROR: Undefined subroutine &Polymake::User::isomorphic called at input line 1.
polytope > $c1=cube(2);

polytope > $c2=cube(2,2);

polytope > $p1x2=product($c1,$c2);

polytope > $p2x1=product($c2,$c1);

polytope > $nc=conv($p1x2,$p2x1);

polytope > print $c1->VERTICES;
1 -1 -1
1 1 -1
1 -1 1
1 1 1

polytope >  print $c1->VOLUME;
4
polytope > print isomorphic($p1x2,cube(4));

polymake:  ERROR: Undefined subroutine &Polymake::User::isomorphic called at input line 1.
polytope > print congruent($p1x2,cube(4));

polymake:  ERROR: Undefined subroutine &Polymake::User::congruent called at input line 1.
```

Not sure this should hold this up, though, since this is a massive improvement on the current situation!


---

Comment by mkoeppe created at 2016-06-28 19:52:01

Do these examples from the tutorial work in the online polymake shell?


---

Comment by vdelecroix created at 2016-06-28 21:54:55

It does work for me. I guess for isomorphism and congruence you need bliss or nauty. They do not appear in your list. Whereas for me I have.

```
$ sage -sh -c polymake
...
Application polytope currently uses following third-party software packages:
bliss, cdd, graphviz, libnormaliz, lrs, permlib, ppl,
sketch, sympol, threejs, tikz, tosimplex
...
```



---

Comment by mkoeppe created at 2016-06-28 22:02:21

Various of these packages do not come bundled with at least the minimal polymake distribution that the patch uses.
On your system, are they coming from the Linux distribution?


---

Comment by vdelecroix created at 2016-06-28 22:14:33

Replying to [comment:26 mkoeppe]:
> Various of these packages do not come bundled with at least the minimal polymake distribution that the patch uses.
> On your system, are they coming from the Linux distribution?

They might. I do have them installed on my Linux system. From the log, it is impossible to tell how polymake configure script actually finds bliss. I have one from the system and one in Sage. And with the very same version

```
$ bliss -version
bliss version 0.72
$ sage -sh -c "bliss -version"
bliss version 0.72
```



---

Comment by kcrisman created at 2016-06-28 22:48:51

> It does work for me. I guess for isomorphism and congruence you need bliss or nauty. 

Oh yeah, fair enough!

I would say that having a sensible message when installing this package that says "here is what you will miss out on" would be worthwhile, but this shouldn't hold up getting this in so people have at least some polymake functionality.


---

Comment by mkoeppe created at 2016-06-28 23:56:53

Replying to [comment:27 vdelecroix]:
> Replying to [comment:26 mkoeppe]:
> > Various of these packages do not come bundled with at least the minimal polymake distribution that the patch uses.
> > On your system, are they coming from the Linux distribution?
> 
> They might. I do have them installed on my Linux system. From the log, it is impossible to tell how polymake configure script actually finds bliss. I have one from the system and one in Sage. And with the very same version
> {{{
> $ bliss -version
> bliss version 0.72
> $ sage -sh -c "bliss -version"
> bliss version 0.72
> }}}

See #20901 -- our bliss package needs updating, or Polymake can't use it.


---

Comment by mkoeppe created at 2016-06-29 16:38:53

Vincent: Should I push the changes for Mac OS to this ticket?


---

Comment by vdelecroix created at 2016-06-29 16:45:49

Sure. Please inform upstream of any patching.


---

Comment by mkoeppe created at 2016-06-29 19:37:07

I have committed the changes from [comment:17 mkoeppe] for Mac OS X.
I have merged the branch for #20894, because polymake won't build without it on Mac OS X.

Didn't merge #20886 -- reviewers are asked to test this too.
----
New commits:


---

Comment by mkoeppe created at 2016-06-29 19:39:12

Replying to [comment:31 vdelecroix]:
> Sure. Please inform upstream of any patching.

I've posted a message in the polymake forum. 

My patch for polymake configuration is prepared from here: https://github.com/mkoeppe/polymake/tree/sage-package


---

Comment by vdelecroix created at 2016-06-30 10:34:02

cython wrappers at work at https://github.com/videlec/pypolymake


---

Comment by git created at 2016-07-01 13:40:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-07 04:32:20

Vincent, what's the plan regarding the old tests in `sage.geometry.polytope`, which fail? Should they just be disabled?


---

Comment by git created at 2016-07-07 10:57:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-07-07 12:22:34

Replying to [comment:40 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[7e23c61](http://git.sagemath.org/sage.git/commit/?id=7e23c614d0dd7d57b866d8b8288b01ac57fff5ef)||`Add information about dependencies`||

this appears to contradict the need for Perl 5 package, at #20894.


---

Comment by mkoeppe created at 2016-07-07 13:15:17

Replying to [comment:41 dimpase]:
> Replying to [comment:40 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[7e23c61](http://git.sagemath.org/sage.git/commit/?id=7e23c614d0dd7d57b866d8b8288b01ac57fff5ef)||`Add information about dependencies`||
> 
> this appears to contradict the need for Perl 5 package, at #20894.

Not really. #20894 adds the one missing bit that is not standard on OS X and which is "tricky to install".


---

Comment by dimpase created at 2016-07-07 13:19:10

Replying to [comment:42 mkoeppe]:
> Replying to [comment:41 dimpase]:
> > Replying to [comment:40 git]:
> > > Branch pushed to git repo; I updated commit sha1. New commits:
> > > ||[7e23c61](http://git.sagemath.org/sage.git/commit/?id=7e23c614d0dd7d57b866d8b8288b01ac57fff5ef)||`Add information about dependencies`||
> > 
> > this appears to contradict the need for Perl 5 package, at #20894.
> 
> Not really. #20894 adds the one missing bit that is not standard on OS X and which is "tricky to install".

But you say in the update:

> On Mac OS X, all modules appear to be standard.


---

Comment by git created at 2016-07-07 13:33:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-07 13:34:15

Replying to [comment:43 dimpase]:
> But you say in the update:
> 
> > On Mac OS X, all modules appear to be standard.

Ah, thanks. I've reworded it (and added some more info).


---

Comment by vdelecroix created at 2016-07-07 13:57:51

Replying to [comment:39 mkoeppe]:
> Vincent, what's the plan regarding the old tests in `sage.geometry.polytope`, which fail? Should they just be disabled? 

For now on we can just mark them as `# not tested` or `# bug`. Anyway the `polymake.py` file is completely broken and should be replaced by something that works (like pypolymake).


---

Comment by kcrisman created at 2016-07-07 14:26:15

<joke>Is featureful a word?  I prefer OED to Wiktionary :)</joke>

That's too bad about the bliss package on Sage.  How easy is it to install some of those non-Sage package things on OS X?   (I'm  not planning to test this, just asking in case that will be useful to users.)

Also,

```
+Also this old-style Sage package can be installed for a more
+featureful Polymake installation:
+ sage -p qhull
+
+Software that would need to be installed manually (no Sage package
+ available) for a more featureful Polymake installation:
+ azove,
+ porta,
+ vinci,
+ SplitsTree4,
+ bliss 
```

Should this information be in a place beyond the SPKG.txt, which after all no one except developers will read?  (And then could be put in a md or rst format...)  Sorry for the interloping.


---

Comment by mkoeppe created at 2016-07-07 20:01:36

Replying to [comment:47 kcrisman]:
> <joke>Is featureful a word?  I prefer OED to Wiktionary :)</joke>
It is a word in more featureful versions of the English language ;)

> That's too bad about the bliss package on Sage.  How easy is it to install some of those non-Sage package things on OS X?   (I'm  not planning to test this, just asking in case that will be useful to users.)

It depends. Ideally we should probably have Sage packages -- this is now task ticket #20977.

> Also,
> {{{
> +Also this old-style Sage package can be installed for a more
> +featureful Polymake installation:
> + sage -p qhull
> +
> +Software that would need to be installed manually (no Sage package
> + available) for a more featureful Polymake installation:
> + azove,
> + porta,
> + vinci,
> + SplitsTree4,
> + bliss 
> }}}
> Should this information be in a place beyond the SPKG.txt, which after all no one except developers will read?  (And then could be put in a md or rst format...)  Sorry for the interloping.
Well, 

```
sage -info polymake
```

would display this information. 

I guess it would make sense to generate some documentation from it automatically. I'm not sure if the existence of packages is advertised anywhere except in the source tree. I always just try "sage -i PACKAGENAME" and when it starts looking for old-style stuff, I hit C-c.


---

Comment by git created at 2016-07-07 20:12:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-07-07 21:08:42

On x86_64, as well as on i686, after installation, I get `Unrecognized character \x7F;`:


```
polytope > show_unconfigured;
topcom.rules
  TOPCOM is a package for computing Triangulations Of Point Configurations and Oriented Matroids.
  Copyright by JÃ¶rg Rambau.
  http://www.rambau.wm.uni-bayreuth.de/TOPCOM/

azove.rules
  azove is a tool designed for counting (without explicit enumeration) and enumeration of 0/1 vertices.
  Copyright by Markus Behle
  http://www.mpi-inf.mpg.de/~behle/azove.html


polymake:  ERROR: "/home/scratch/dimpase/sage/sage/local/lib/polymake/lib/polytope.so", line 1: Unrecognized character \x7F; marked by <-- HERE after <-- HERE near column 1
polytope > 
```



---

Comment by mkoeppe created at 2016-07-07 21:40:46

I see this too on Mac OS X.
I think it's an upstream issue.


---

Comment by mkoeppe created at 2016-07-07 22:04:02

I've reported it upstream at https://forum.polymake.org/viewtopic.php?f=10&t=517


---

Comment by git created at 2016-07-07 22:06:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-07 22:07:54

Downgraded package type from "optional" to "experimental", as suggested at #20894#comment:28


---

Comment by mkoeppe created at 2016-07-07 22:07:54

Changing component from packages: optional to packages: experimental.


---

Comment by dimpase created at 2016-07-09 12:48:57

I forgot to add that on the i686 system (running Ubuntu 14.04) I needed to do  `sudo cpan  -i  XML::Writer` (in addition to all the recommended `apt-get install...` for building to finish normally.


---

Comment by mkoeppe created at 2016-07-09 15:55:42

Replying to [comment:56 dimpase]:
> I forgot to add that on the i686 system (running Ubuntu 14.04) I needed to do  `sudo cpan  -i  XML::Writer` (in addition to all the recommended `apt-get install...` for building to finish normally.
Does the distribution package `libxml-writer-perl` work as well?


---

Comment by dimpase created at 2016-07-09 17:54:46

Replying to [comment:57 mkoeppe]:
> Replying to [comment:56 dimpase]:
> > I forgot to add that on the i686 system (running Ubuntu 14.04) I needed to do  `sudo cpan  -i  XML::Writer` (in addition to all the recommended `apt-get install...` for building to finish normally.
> Does the distribution package `libxml-writer-perl` work as well?

I don't know. There is no inverse for `cpan -i`, so it's unclear how to check.


---

Comment by git created at 2016-07-11 19:51:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-15 12:07:03

According to https://forum.polymake.org/viewtopic.php?f=10&t=517:

 Currently polymake does not have any provisions for finding the nauty package outside own source code. I'd suggest you use the complete source tarball of polymake instead of the "minimal" one; you can disable undesired extensions via configuration like this: --without-jreality.


---

Comment by dimpase created at 2016-07-15 14:16:00

Replying to [comment:61 mkoeppe]:
> According to https://forum.polymake.org/viewtopic.php?f=10&t=517:
> 
>  Currently polymake does not have any provisions for finding the nauty package outside own source code. I'd suggest you use the complete source tarball of polymake instead of the "minimal" one; you can disable undesired extensions via configuration like this: --without-jreality.

This should be trivial to patch... I don't think we want a megatarball.


---

Comment by mkoeppe created at 2016-07-15 15:07:26

The "minimal tarball" that we use omits not only the nauty sources, but also polymake's interface to it (see https://github.com/mkoeppe/polymake/tree/sage-package/bundled/nauty) 
So it's not just a matter of patching someone's configure scripts.

It appears that a polymake install can only use bliss OR nauty. So I think I'll ignore nauty for now and fix bliss instead (#20901).


---

Comment by git created at 2016-07-15 20:01:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-16 13:27:05

With the new bliss package installed (#20901) and rebuilt polymake, the command `show_unconfigured;` now works without error.

Ready for review...


---

Comment by dimpase created at 2016-07-20 08:53:25

isn't #20901 a dependence of this ticket now?


---

Comment by mkoeppe created at 2016-07-20 12:08:47

Much of polymake seems to work without bliss, which is why I didn't mark it as a dependency.


---

Comment by vdelecroix created at 2016-07-23 23:36:47


```
[polymake-3.0r1] patching file support/configure.pl
[polymake-3.0r1] Unrecognized option --without-fink;
[polymake-3.0r1] Try ./configure --help for detailed information
```



---

Comment by vdelecroix created at 2016-07-23 23:36:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-07-24 00:02:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-07-24 00:06:51

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-07-24 01:04:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-24 12:53:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-07-29 19:42:27

test, pls ignore...


---

Comment by mkoeppe created at 2016-08-04 19:32:28

Needs another reviewer.


---

Comment by vdelecroix created at 2016-08-04 19:36:13

1 - [pypolymake](https://pypi.python.org/pypi/pypolymake) is not ready to be considered as an optional package!

2 - the following is not allowed in `spkg-install` as it needs internet access

```
pip install --verbose --ignore-installed --no-deps pypolymake
```


I would rather stick to ship `polymake`.


---

Comment by vdelecroix created at 2016-08-04 19:36:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-04 21:33:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-08-04 21:37:41

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2016-08-04 21:37:41

OK. The follow-up ticket is in #21170.


---

Comment by vdelecroix created at 2016-08-04 21:51:48

tarball link in ticket description indicates `polymake-3.0r1-minimal.tar.bz2` while in spkg-install there is `3.0r2`...


---

Comment by vdelecroix created at 2016-08-04 21:52:05

(thanks for splitting `pypolymake`)


---

Comment by vdelecroix created at 2016-08-04 21:55:09

weird

```
$ sage -f polymake
... <snip> ...
[polymake-3.0r2] bundled extension bliss ... /tmp/polymake_21906_configure: error while loading shared libraries: libgmp.so.16: cannot open shared object file: No such file or directory
[polymake-3.0r2] bundled extension cdd ... /tmp/polymake_21906_configure: error while loading shared libraries: libgmp.so.16: cannot open shared object file: No such file or directory
[polymake-3.0r2] bundled extension lrs ... /tmp/polymake_21906_configure: error while loading shared libraries: libgmp.so.16: cannot open shared object file: No such file or directory
[polymake-3.0r2] bundled extension ppl ... /tmp/polymake_21906_configure: error while loading shared libraries: libppl.so.14: cannot open shared object file: No such file or directory
... <snip> ...
```

Is this expected!?


---

Comment by mkoeppe created at 2016-08-04 22:02:51

Replying to [comment:83 vdelecroix]:
> {{{
> $ sage -f polymake
> ... <snip> ...
> [polymake-3.0r2] bundled extension bliss ... /tmp/polymake_21906_configure: error while loading shared libraries: libgmp.so.16: cannot open shared object file: No such file or directory
> [polymake-3.0r2] bundled extension cdd ... /tmp/polymake_21906_configure: error while loading shared libraries: libgmp.so.16: cannot open shared object file: No such file or directory
> [polymake-3.0r2] bundled extension lrs ... /tmp/polymake_21906_configure: error while loading shared libraries: libgmp.so.16: cannot open shared object file: No such file or directory
> [polymake-3.0r2] bundled extension ppl ... /tmp/polymake_21906_configure: error while loading shared libraries: libppl.so.14: cannot open shared object file: No such file or directory
> ... <snip> ...
> }}}
> Is this expected!?

No. It works without error on my machine (Mac OS X).


---

Comment by vdelecroix created at 2016-08-04 22:09:02

Replying to [comment:85 mkoeppe]:
> Replying to [comment:83 vdelecroix]:
> > <snip error report>
> > Is this expected!?
> 
> No. It works without error on my machine (Mac OS X).

The thing is that the above did not interrupt the build (still waiting for the end of compilation...). I discovered them by grepping my install.log. I will tell what is happening with bliss, cdd, lrs and ppl interfaces inside polymake.


---

Comment by vdelecroix created at 2016-08-04 22:34:45

compilation finished and

```
polytope > show_unconfigured;
topcom.rules
  TOPCOM is a package for computing Triangulations Of Point Configurations and Oriented Matroids.
  Copyright by JÃ¶rg Rambau.
  http://www.rambau.wm.uni-bayreuth.de/TOPCOM/

azove.rules
  azove is a tool designed for counting (without explicit enumeration) and enumeration of 0/1 vertices.
  Copyright by Markus Behle
  http://www.mpi-inf.mpg.de/~behle/azove.html

porta.rules
  PORTA is a collection of routines for analyzing polytopes and polyhedra.
  Copyright by Thomas Christof and Andreas Loebel.
  http://www.iwr.uni-heidelberg.de/groups/comopt/software/PORTA/

vinci.rules
  Vinci - Computing Volumes of Convex Polytopes.
  Copyright by Benno BÃ¼eler, Andreas Enge, and Komei Fukuda
  http://www.lix.polytechnique.fr/Labo/Andreas.Enge/Vinci.html

latte.rules
  LattE (Lattice point Enumeration) is a computer software dedicated to the 
  problems of counting lattice points and integration inside convex polytopes.
  Copyright by Matthias Koeppe, Jesus A. De Loera and others.
  http://www.math.ucdavis.edu/~latte/


polymake:  ERROR: "/opt/sage/local/lib/polymake/lib/polytope.so", line 1: Unrecognized character \x7F; marked by <-- HERE after <-- HERE near column 1
```



---

Comment by vdelecroix created at 2016-08-04 22:44:45

As it is an experimental package we should get it into early sage-7.4 beta for more feedback!


---

Comment by mkoeppe created at 2016-08-05 06:18:24

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2016-08-05 06:18:24

OK, I was able to reproduce this on an Ubuntu box. One of my patches for Mac OS X is to blame. Working on it.


---

Comment by git created at 2016-08-05 08:18:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-05 08:21:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-05 14:45:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-05 14:59:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-08-05 15:43:28

Branch has now merged the bliss ticket (#20901).


---

Comment by mkoeppe created at 2016-08-05 15:44:13

#21175 (Set ARCHFLAGS environment variable - for Perl modules) would make polymake's `spkg-install` simpler.


---

Comment by mkoeppe created at 2016-08-05 16:33:41

Replying to [comment:89 mkoeppe]:
> OK, I was able to reproduce this on an Ubuntu box. One of my patches for Mac OS X is to blame. Working on it.
It's now working on Ubuntu (and still on Mac OS X), please test.


---

Comment by vdelecroix created at 2016-08-05 17:29:22

Better. Build without any error and

```
polytope > show_unconfigured;
vinci.rules
  ...
azove.rules
  ...
splitstree.rules
  ...
latte.rules
  ...
topcom.rules
  ...
porta.rules
  ...
common::property_viewer.rules
common::povray.rules
  ...
common::geomview.rules
  ...
To enable an interface:  reconfigure("RULEFILE");
```



---

Comment by vdelecroix created at 2016-08-05 17:35:18

However, after switching back to the develop branch doing `sage -b` gives me

```
/opt/sage/src/build/cythonized/sage/graphs/bliss.cpp:317:20fatal error: graph.hh: No such file or directory
```



---

Comment by mkoeppe created at 2016-08-05 17:38:14

Replying to [comment:98 vdelecroix]:
> However, after switching back to the develop branch doing `sage -b` gives me
> {{{
> /opt/sage/src/build/cythonized/sage/graphs/bliss.cpp:317:20fatal error: graph.hh: No such file or directory
> }}}
Yes, that's normal. Need to keep #20901 in your branch if you have installed the bliss package from #20901.


---

Comment by mkoeppe created at 2016-08-05 17:39:24

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-08-12 03:01:06

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2016-08-12 03:01:06

It works well on top of 7.4.beta0. Setting to positive review in order to be easily available for testing.


---

Comment by vbraun created at 2016-08-13 22:50:27

Resolution: fixed


---

Comment by kcrisman created at 2016-08-15 13:18:19

For those who really know this stuff, on a related note: http://ask.sagemath.org/question/34457/why-cant-i-compute-the-ehrhart-polynomial-of-a-polytope/?answer=34458#post-id-34458 so hopefully it will be more obvious soon what to do for this type of user.


---

Comment by dimpase created at 2017-01-12 12:19:25

People [report](https://groups.google.com/d/msg/sage-devel/wgoeFgYzgZw/Yihv5VCFBgAJ) that building Singular with polymake (not this one, a systemwide one) installed leads to a problem. This ought to be investigated.
