# Issue 27220: py3: fixes for isidentifier

Issue created by migration from https://trac.sagemath.org/ticket/27457

Original creator: chapoton

Original creation time: 2019-03-10 13:31:22

CC:  embray jdemeyer tscrim

because the python3 method of the same name is not enough for our  needs.


---

Comment by chapoton created at 2019-03-10 13:31:46

New commits:


---

Comment by chapoton created at 2019-03-10 13:31:46

Changing status from new to needs_review.


---

Comment by git created at 2019-03-10 20:25:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-03-11 07:47:09

green bot, please review. I have a small doubt on what to do exactly..


---

Comment by embray created at 2019-03-11 10:16:22

> because the python3 method of the same name is not enough for our needs.

Is there some reference for this?  I believe it, I just don't know what the explanation is.  Perhaps the text removed from the documentation could instead be changed to explain why this function _is_ needed and the builtin one from Python is not sufficient.


When making trivial changes like


```diff
diff --git a/src/sage/symbolic/ring.pyx b/src/sage/symbolic/ring.pyx
index f6bd6a8..0a0f7ab 100644
--- a/src/sage/symbolic/ring.pyx
+++ b/src/sage/symbolic/ring.pyx
@@ -841,7 +841,7 @@ cdef class SymbolicRing(CommutativeRing):
 
         for s in names_list:
             if not isidentifier(s):
-                raise ValueError('The name "'+s+'" is not a valid Python identifier.')
+                raise ValueError('The name "' + s + '" is not a valid Python identifier.')
```


I think we might as well change it to use normal string formatting instead of pointless concatenations.  Since this is a Cython module you can use an f-string:


```
               raise ValueError(f'The name "{s}" is not a valid Python identifier.')


---

Comment by git created at 2019-03-11 12:30:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-03-11 14:57:06

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-03-13 18:29:20

Resolution: fixed


---

Comment by vbraun created at 2019-03-14 11:09:44

Changing status from closed to new.


---

Comment by vbraun created at 2019-03-14 11:09:44

On Python3: 

```
sage -t --long src/sage/calculus/calculus.py
**********************************************************************
File "src/sage/calculus/calculus.py", line 1745, in sage.calculus.calculus.inverse_laplace
Failed example:
    inverse_laplace(cos(s), s, t, algorithm='sympy')
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.calculus.calculus.inverse_laplace[21]>", line 1, in <module>
        inverse_laplace(cos(s), s, t, algorithm='sympy')
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.6/site-packages/sage/calculus/calculus.py", line 1766, in inverse_laplace
        return result._sage_()
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.6/site-packages/sage/interfaces/sympy.py", line 275, in _sympysage_function
        args = [arg._sage_() for arg in self.args]
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.6/site-packages/sage/interfaces/sympy.py", line 275, in <listcomp>
        args = [arg._sage_() for arg in self.args]
      File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.6/site-packages/sage/interfaces/sympy.py", line 229, in _sympysage_symbol
        return SR.var(self.name)
      File "sage/symbolic/ring.pyx", line 844, in sage.symbolic.ring.SymbolicRing.var (build/cythonized/sage/symbolic/ring.cpp:9725)
        raise ValueError(f'The name "{s}" is not a valid Python identifier.')
    ValueError: The name "None" is not a valid Python identifier.
**********************************************************************
1 item had failures:
   1 of  24 in sage.calculus.calculus.inverse_laplace
    [418 tests, 1 failure, 17.42 s]
```



---

Comment by vbraun created at 2019-03-14 11:09:44

Resolution changed from fixed to 


---

Comment by chapoton created at 2019-03-14 20:16:54

Hmm. Sympy send us back a variable `_None` whose name is `'None'`. What should we do with that ? Make a special case to map it to `None` ?


```
sage: var('t, s')
sage: ex=cos(s)
sage: ex_sy, s, t = [expr._sympy_() for expr in (ex, s, t)]
....: from sympy import inverse_laplace_transform
....: from sage.interfaces.sympy import sympy_init
....: sympy_init()
....: result = inverse_laplace_transform(ex_sy, s, t)
sage: d = result.args[3]; d
```



---

Comment by jhpalmieri created at 2019-03-20 18:04:04

How about this:

```diff
diff --git a/src/sage/interfaces/sympy.py b/src/sage/interfaces/sympy.py
index 2ac9e40b79..f56159fa59 100644
--- a/src/sage/interfaces/sympy.py
+++ b/src/sage/interfaces/sympy.py
@@ -226,7 +226,11 @@ def _sympysage_symbol(self):
         sage: assert x == Symbol('x')._sage_()
     """
     from sage.symbolic.ring import SR
-    return SR.var(self.name)
+    try:
+        return SR.var(self.name)
+    except ValueError:
+        # sympy sometimes returns variables with name = 'None', str rep = '_None'
+        return SR.var(str(self))
 
 def _sympysage_Subs(self):
      """
```



---

Comment by jhpalmieri created at 2019-03-20 18:54:07

I also wonder if we should also forbid the use of 'None', 'True', 'False' as variable names in Python 2. Differences between the lists of keywords in Python 2 vs. Python 3:
- in `keywords.kwlist` in Python 2 but not 3: 'exec', 'print'
- in `keywords.kwlist` in Python 3 but not 2: 'None', 'True', 'False', 'nonlocal'
Should Sage maintain its own list of forbidden variable names, for example the union of the two versions of `keywords.kwlist`? Something like this:

```diff
diff --git a/src/sage/symbolic/ring.pyx b/src/sage/symbolic/ring.pyx
index df045bd0d0..11f14e2c18 100644
--- a/src/sage/symbolic/ring.pyx
+++ b/src/sage/symbolic/ring.pyx
@@ -31,6 +31,7 @@ from sage.structure.coerce cimport is_numpy_type
 
 from sage.rings.all import RR, CC, ZZ
 
+import keyword
 import operator
 import parser
     
@@ -1333,6 +1334,9 @@ def is_SymbolicVariable(x):
     """
     return is_Expression(x) and is_a_symbol((<Expression>x)._gobj)
 
+# Don't allow any of these keywords as identifiers for symbolic variables.
+KEYWORDS = set(keyword.kwlist).union(['exec', 'print', 'None', 'True',
+                                      'False', 'nonlocal'])
 
 def isidentifier(x):
     """
@@ -1367,15 +1371,14 @@ def isidentifier(x):
         True
         sage: isidentifier('lambda s:s+1')
         False
-        sage: isidentifier('None')  # py3
+        sage: isidentifier('None')
         False
         sage: isidentifier('lambda')
         False
         sage: isidentifier('def')
         False
     """
-    import keyword
-    if keyword.iskeyword(x):
+    if x in KEYWORDS:
         return False
     try:
```



---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by chapoton created at 2019-03-30 17:05:23

New commits:


---

Comment by git created at 2019-03-30 17:09:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-03-30 17:09:39

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-03-30 17:21:06

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-03-30 17:21:06

still need to fix the failure with python3 in src/sage/calculus/calculus.py


---

Comment by jhpalmieri created at 2019-03-30 19:00:23

Does the change in comment:10 work and make sense?


---

Comment by chapoton created at 2019-03-30 19:09:35

I am not so sure about your comment:10. When sympy send us `None`, we should probably not make a symbolic variable out of it, but understand it as `None`.

EDIT: at least now, we have the same failure in py2 and py3..


---

Comment by jhpalmieri created at 2019-03-30 21:09:59

So like this?

```diff
diff --git a/src/sage/interfaces/sympy.py b/src/sage/interfaces/sympy.py
index 2ac9e40b79..cb18cf8ec6 100644
--- a/src/sage/interfaces/sympy.py
+++ b/src/sage/interfaces/sympy.py
@@ -226,7 +226,8 @@ def _sympysage_symbol(self):
         sage: assert x == Symbol('x')._sage_()
     """
     from sage.symbolic.ring import SR
-    return SR.var(self.name)
+    if self.name is not 'None':
+        return SR.var(self.name)
 
 def _sympysage_Subs(self):
      """
```

Plus some documentation and a doctest, if possible.

Or is it a bad idea to special-case `None` like this? I don't know sympy, so I don't know how to (for example) convert the result of its inverse Laplace transform to remove the `_None` variable.


---

Comment by git created at 2019-04-05 15:22:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-04-05 15:23:18

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-04-05 15:23:18

let us try John's first proposal


---

Comment by chapoton created at 2019-04-05 19:23:50

bot is green on python2, and tests are ok with python3. I would say this is a reasonable solution, even if not elegant.


---

Comment by embray created at 2019-04-08 16:33:39

I see--as long as it works it's fine by me.


---

Comment by embray created at 2019-04-08 16:33:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-04-10 15:28:43

Resolution: fixed
