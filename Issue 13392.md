# Issue 13392: Improvements to IntegerMod is_square

archive/issues_013392.json:
```json
{
    "body": "Assignee: AlexGhitza\n\nCC:  nbruin saraedum jpflori\n\nCurrently we fall back on PARI if 4 divides the modulus, and we don't check first to see if the jacobi symbol is -1 (in which case we can declare a quadratic non-residue without factoring the modulus).  This patch fixes both problems.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13596\n\n",
    "created_at": "2012-10-13T02:05:55Z",
    "labels": [
        "basic arithmetic",
        "major",
        "enhancement"
    ],
    "title": "Improvements to IntegerMod is_square",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13392",
    "user": "roed"
}
```
Assignee: AlexGhitza

CC:  nbruin saraedum jpflori

Currently we fall back on PARI if 4 divides the modulus, and we don't check first to see if the jacobi symbol is -1 (in which case we can declare a quadratic non-residue without factoring the modulus).  This patch fixes both problems.

Issue created by migration from https://trac.sagemath.org/ticket/13596





---

archive/issue_comments_164897.json:
```json
{
    "body": "Attachment [13596.patch](tarball://root/attachments/some-uuid/ticket13596/13596.patch) by roed created at 2012-10-13 02:08:13",
    "created_at": "2012-10-13T02:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164897",
    "user": "roed"
}
```

Attachment [13596.patch](tarball://root/attachments/some-uuid/ticket13596/13596.patch) by roed created at 2012-10-13 02:08:13



---

archive/issue_comments_164898.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-13T02:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164898",
    "user": "roed"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_164899.json:
```json
{
    "body": "Looks good.  Passes doctests.  Much faster when Jacobi symbol is -1 and no slower otherwise.\n\nPositive review.",
    "created_at": "2012-10-17T13:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164899",
    "user": "fwclarke"
}
```

Looks good.  Passes doctests.  Much faster when Jacobi symbol is -1 and no slower otherwise.

Positive review.



---

archive/issue_comments_164900.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-17T13:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164900",
    "user": "fwclarke"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_164901.json:
```json
{
    "body": "\n```\nsage -t --long \"devel/sage/sage/rings/finite_rings/integer_mod.pyx\"\nException raised by doctesting framework. Use -verbose for details.\n         [34.4 s]\n\n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t --long \"devel/sage/sage/rings/finite_rings/integer_mod.pyx\" # Exception from doctest framework\nTotal time for all tests: 34.6 seconds\n```\n",
    "created_at": "2012-10-23T18:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164901",
    "user": "jdemeyer"
}
```


```
sage -t --long "devel/sage/sage/rings/finite_rings/integer_mod.pyx"
Exception raised by doctesting framework. Use -verbose for details.
         [34.4 s]

----------------------------------------------------------------------
The following tests failed:


        sage -t --long "devel/sage/sage/rings/finite_rings/integer_mod.pyx" # Exception from doctest framework
Total time for all tests: 34.6 seconds
```




---

archive/issue_comments_164902.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-10-23T18:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164902",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_164903.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-10-24T05:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164903",
    "user": "roed"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_164904.json:
```json
{
    "body": "Sorry about that.  I'm using syntax that depends on #12415.  I'm going to mark this as depending on #12415, though if that ticket continues to stall I can change the test here instead.",
    "created_at": "2012-10-24T05:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164904",
    "user": "roed"
}
```

Sorry about that.  I'm using syntax that depends on #12415.  I'm going to mark this as depending on #12415, though if that ticket continues to stall I can change the test here instead.



---

archive/issue_comments_164905.json:
```json
{
    "body": "The patch did not apply anymore due to the fact that the `pari()` method was renamed to `_pari_()`.  I fixed this, and then did the following (inspired by the new doctest):\n\n```python\ndef test_native():\n    for p,q,r in cartesian_product_iterator([[3,5],[11,13],[17,19]]):\n        for ep,eq,er in cartesian_product_iterator([[0,1,2,3],[0,1,2,3],[0,1,2,3]]):\n            for e2 in [0,1,2,3,4]:\n                n = p^ep*q^eq*r^er*2^e2\n                for _ in range(2):\n                    a = Zmod(n).random_element()\n                    b = a.is_square()\n\ndef test_pari():\n    for p,q,r in cartesian_product_iterator([[3,5],[11,13],[17,19]]):\n        for ep,eq,er in cartesian_product_iterator([[0,1,2,3],[0,1,2,3],[0,1,2,3]]):\n            for e2 in [0,1,2,3,4]:\n                n = p^ep*q^eq*r^er*2^e2\n                for _ in range(2):\n                    a = Zmod(n).random_element()\n                    b = bool(a._pari_().issquare())\n```\n\nI got the following timings:\n\n```\nsage: %timeit test_native()\n1 loops, best of 3: 3.11 s per loop\nsage: %timeit test_pari()\n1 loops, best of 3: 2.98 s per loop\n```\n\nFrom the perspective of someone who does not want to reinvent the wheel, this suggests that we should just call PARI instead of using a native Sage implementation.",
    "created_at": "2013-08-13T20:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164905",
    "user": "pbruin"
}
```

The patch did not apply anymore due to the fact that the `pari()` method was renamed to `_pari_()`.  I fixed this, and then did the following (inspired by the new doctest):

```python
def test_native():
    for p,q,r in cartesian_product_iterator([[3,5],[11,13],[17,19]]):
        for ep,eq,er in cartesian_product_iterator([[0,1,2,3],[0,1,2,3],[0,1,2,3]]):
            for e2 in [0,1,2,3,4]:
                n = p^ep*q^eq*r^er*2^e2
                for _ in range(2):
                    a = Zmod(n).random_element()
                    b = a.is_square()

def test_pari():
    for p,q,r in cartesian_product_iterator([[3,5],[11,13],[17,19]]):
        for ep,eq,er in cartesian_product_iterator([[0,1,2,3],[0,1,2,3],[0,1,2,3]]):
            for e2 in [0,1,2,3,4]:
                n = p^ep*q^eq*r^er*2^e2
                for _ in range(2):
                    a = Zmod(n).random_element()
                    b = bool(a._pari_().issquare())
```

I got the following timings:

```
sage: %timeit test_native()
1 loops, best of 3: 3.11 s per loop
sage: %timeit test_pari()
1 loops, best of 3: 2.98 s per loop
```

From the perspective of someone who does not want to reinvent the wheel, this suggests that we should just call PARI instead of using a native Sage implementation.



---

archive/issue_comments_164906.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-08-13T20:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164906",
    "user": "pbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_164907.json:
```json
{
    "body": "Replying to [comment:8 pbruin]:\n> From the perspective of someone who does not want to reinvent the wheel, this suggests that we should just call PARI instead of using a native Sage implementation.\n+1",
    "created_at": "2013-08-14T08:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164907",
    "user": "jdemeyer"
}
```

Replying to [comment:8 pbruin]:
> From the perspective of someone who does not want to reinvent the wheel, this suggests that we should just call PARI instead of using a native Sage implementation.
+1



---

archive/issue_comments_164908.json:
```json
{
    "body": "Replying to [comment:8 pbruin]:\n\n> I got the following timings:\n\nThe following case makes me think that the examples in the doctest are rather too small to rely on for timing information.\n\n\n```\n\nsage: print version()\nSage Version 5.10, Release Date: 2013-06-17\nsage: a, b, n = 176338465705, 161089773287, 217267613611\nsage: n.factor()\n341983 * 635317\nsage: jacobi_symbol(a, n), jacobi_symbol(b, n)\n(1, -1)\nsage: %timeit Zmod(n)(a).is_square()\n100000 loops, best of 3: 10.2 us per loop\nsage: %timeit Zmod(n)(a)._pari_().issquare()\n1000 loops, best of 3: 215 us per loop\nsage: %timeit Zmod(n)(b).is_square()\n100000 loops, best of 3: 8.83 us per loop\nsage: %timeit Zmod(n)(b)._pari_().issquare()\n100000 loops, best of 3: 14.8 us per loop\n\n```\n\nIt certainly looks as though PARI checks the Jacobi symbol first, but even without the patch the current code wins.  Perhaps it is worth reinventing this wheel.",
    "created_at": "2013-08-14T08:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164908",
    "user": "fwclarke"
}
```

Replying to [comment:8 pbruin]:

> I got the following timings:

The following case makes me think that the examples in the doctest are rather too small to rely on for timing information.


```

sage: print version()
Sage Version 5.10, Release Date: 2013-06-17
sage: a, b, n = 176338465705, 161089773287, 217267613611
sage: n.factor()
341983 * 635317
sage: jacobi_symbol(a, n), jacobi_symbol(b, n)
(1, -1)
sage: %timeit Zmod(n)(a).is_square()
100000 loops, best of 3: 10.2 us per loop
sage: %timeit Zmod(n)(a)._pari_().issquare()
1000 loops, best of 3: 215 us per loop
sage: %timeit Zmod(n)(b).is_square()
100000 loops, best of 3: 8.83 us per loop
sage: %timeit Zmod(n)(b)._pari_().issquare()
100000 loops, best of 3: 14.8 us per loop

```

It certainly looks as though PARI checks the Jacobi symbol first, but even without the patch the current code wins.  Perhaps it is worth reinventing this wheel.



---

archive/issue_comments_164909.json:
```json
{
    "body": "Replying to [comment:10 fwclarke]:\n> Replying to [comment:8 pbruin]:\n> \n> The following case makes me think that the examples in the doctest are rather too small to rely on for timing information.\n\n> It certainly looks as though PARI checks the Jacobi symbol first, but even without the patch the current code wins.  Perhaps it is worth reinventing this wheel.\n\nWhat is behind this is that Sage caches the factorisation of *n* in `Zmod(n)`, while PARI has to factor `n` every time.  With your values of `a` and `n`, the PARI version used by Sage on my system needs 367 us for `issquare(Mod(a, n))`, while `factor(n)` takes 360 us.  This means that 98% of the cost of `issquare()` in this case is spent on factoring `n`.\n\nSo for a single call, PARI is probably slightly faster, while the Sage implementation is faster for multiple calls within one `Zmod(n)` thanks to the cached factorisation.",
    "created_at": "2013-08-14T12:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164909",
    "user": "pbruin"
}
```

Replying to [comment:10 fwclarke]:
> Replying to [comment:8 pbruin]:
> 
> The following case makes me think that the examples in the doctest are rather too small to rely on for timing information.

> It certainly looks as though PARI checks the Jacobi symbol first, but even without the patch the current code wins.  Perhaps it is worth reinventing this wheel.

What is behind this is that Sage caches the factorisation of *n* in `Zmod(n)`, while PARI has to factor `n` every time.  With your values of `a` and `n`, the PARI version used by Sage on my system needs 367 us for `issquare(Mod(a, n))`, while `factor(n)` takes 360 us.  This means that 98% of the cost of `issquare()` in this case is spent on factoring `n`.

So for a single call, PARI is probably slightly faster, while the Sage implementation is faster for multiple calls within one `Zmod(n)` thanks to the cached factorisation.



---

archive/issue_comments_164910.json:
```json
{
    "body": "Here are some timings (on Linux x86_64):\n\n\n```\na = 176338465705\nb = 161089773287\nn = 217267613611\n\nissquare(Mod(a, n)) resp. Zmod(n)(a).is_square()\npari 2.5.4: 367 us\npari 2.6.1: 396 us\nsage 5.11.rc0: 8.74 us\nsage + #13596: 25 us\n\nissquare(Mod(b, n)) resp. Zmod(n)(b).is_square()\npari 2.5.4: 1.18 us\npari 2.6.1: 155 us\nsage 5.11.rc0: 15.2 us\nsage + #13596: 10.6 us\n\nkronecker(a, n) resp. a.jacobi(n)\npari 2.5.4: 0.960 us\npari 2.6.1: 0.961 us\nsage 5.11.rc0: 0.693 us\n\nkronecker(b, n) resp. b.jacobi(n)\npari 2.5.4: 0.970 us\npari 2.6.1: 0.981 us\nsage 5.11.rc0: 0.709 us\n\nfactorint(n) resp. n.factor()\npari 2.5.4: 360 us\npari 2.6.1: 330 us\nsage 5.11.rc0: 157 us\n```\n\n\nNote:\n- almost all the time for `issquare` in PARI is spent on factoring `n` (see above).\n- there is a dramatic slowdown between PARI 2.5.4 and 2.6.1 for `issquare(Mod(b, n))`.  (Edit: this has been fixed in the latest Git version of PARI.)\n- Kronecker symbols and factoring are faster in Sage than in PARI for this value of *n*; this is because Sage uses the right pre-invented wheel (GMP resp. Flint).\n- this patch slows down the Sage function by a factor of 3 for *a* mod *n*, but speeds it up by 30% for *b* mod *n*.",
    "created_at": "2013-08-14T12:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164910",
    "user": "pbruin"
}
```

Here are some timings (on Linux x86_64):


```
a = 176338465705
b = 161089773287
n = 217267613611

issquare(Mod(a, n)) resp. Zmod(n)(a).is_square()
pari 2.5.4: 367 us
pari 2.6.1: 396 us
sage 5.11.rc0: 8.74 us
sage + #13596: 25 us

issquare(Mod(b, n)) resp. Zmod(n)(b).is_square()
pari 2.5.4: 1.18 us
pari 2.6.1: 155 us
sage 5.11.rc0: 15.2 us
sage + #13596: 10.6 us

kronecker(a, n) resp. a.jacobi(n)
pari 2.5.4: 0.960 us
pari 2.6.1: 0.961 us
sage 5.11.rc0: 0.693 us

kronecker(b, n) resp. b.jacobi(n)
pari 2.5.4: 0.970 us
pari 2.6.1: 0.981 us
sage 5.11.rc0: 0.709 us

factorint(n) resp. n.factor()
pari 2.5.4: 360 us
pari 2.6.1: 330 us
sage 5.11.rc0: 157 us
```


Note:
- almost all the time for `issquare` in PARI is spent on factoring `n` (see above).
- there is a dramatic slowdown between PARI 2.5.4 and 2.6.1 for `issquare(Mod(b, n))`.  (Edit: this has been fixed in the latest Git version of PARI.)
- Kronecker symbols and factoring are faster in Sage than in PARI for this value of *n*; this is because Sage uses the right pre-invented wheel (GMP resp. Flint).
- this patch slows down the Sage function by a factor of 3 for *a* mod *n*, but speeds it up by 30% for *b* mod *n*.



---

archive/issue_comments_164911.json:
```json
{
    "body": "It turns out that PARI has a function `Zn_issquare(d, n)` to check whether *d* is a square modulo *n*; for *n* it accepts either an integer or its factorisation matrix.  This looks like a nice preinvented wheel to me.",
    "created_at": "2013-08-14T13:01:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164911",
    "user": "pbruin"
}
```

It turns out that PARI has a function `Zn_issquare(d, n)` to check whether *d* is a square modulo *n*; for *n* it accepts either an integer or its factorisation matrix.  This looks like a nice preinvented wheel to me.



---

archive/issue_comments_164912.json:
```json
{
    "body": "After experimenting with various mixtures of Cython and PARI, I believe that the most efficient solution is to use Cython for those checks for non-squareness that don't require factoring, and if that fails, call PARI's `Zn_issquare` function with the modulus in factored form.  I made a patch and am now running doctests.\n\nThere seems to be a very slight slowdown with respect to the current implementation if the element is a square (perhaps because the above quick tests are done once in Cython and again in PARI), but a noticeable speedup if it is not.",
    "created_at": "2013-09-13T15:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164912",
    "user": "pbruin"
}
```

After experimenting with various mixtures of Cython and PARI, I believe that the most efficient solution is to use Cython for those checks for non-squareness that don't require factoring, and if that fails, call PARI's `Zn_issquare` function with the modulus in factored form.  I made a patch and am now running doctests.

There seems to be a very slight slowdown with respect to the current implementation if the element is a square (perhaps because the above quick tests are done once in Cython and again in PARI), but a noticeable speedup if it is not.



---

archive/issue_comments_164913.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-09-13T16:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164913",
    "user": "pbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_164914.json:
```json
{
    "body": "Attachment [13596_new.patch](tarball://root/attachments/some-uuid/ticket13596/13596_new.patch) by pbruin created at 2013-09-13 16:09:03\n\nbased on 5.12.beta4 + #15124",
    "created_at": "2013-09-13T16:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164914",
    "user": "pbruin"
}
```

Attachment [13596_new.patch](tarball://root/attachments/some-uuid/ticket13596/13596_new.patch) by pbruin created at 2013-09-13 16:09:03

based on 5.12.beta4 + #15124



---

archive/issue_comments_164915.json:
```json
{
    "body": "Again some timings:\n\n```\na = 176338465705\nb = 161089773287\nn = 217267613611\n\ndef test1():\n    for p,q,r in cartesian_product_iterator([[3,5],[11,13],[17,19]]):\n        for ep,eq,er in cartesian_product_iterator([[0,1,2,3],[0,1,2,3],[0,1,2,3]]):\n            for e2 in [0,1,2,3,4]:\n                n = p^ep*q^eq*r^er*2^e2\n                for _ in range(2):\n                    a = Zmod(n).random_element()\n                    b = a.is_square()\n\ndef test2(bound):\n    for n in xrange(bound):\n        for a in xrange(n):\n            b = Mod(a, n).is_square()\n\n# without patch\nsage: %timeit -c -n 100000 -r 1 Zmod(n)(a).is_square()\n100000 loops, best of 1: 11.5 us per loop\nsage: %timeit -c -n 100000 -r 1 Zmod(n)(b).is_square()\n100000 loops, best of 1: 9.64 us per loop\nsage -t --long sage/rings/finite_rings/integer_mod.pyx\ncpu time: 5.5 seconds\nsage: %timeit -c -r 1 test1()\n1 loops, best of 1: 1.27 s per loop\nsage: %timeit -c -r 1 test2(1000)\n1 loops, best of 1: 7.12 s per loop\n\n# with patch\nsage: %timeit -c -n 100000 -r 1 Zmod(n)(a).is_square()\n100000 loops, best of 1: 12.1 us per loop\nsage: %timeit -c -n 100000 -r 1 Zmod(n)(b).is_square()\n100000 loops, best of 1: 6.52 us per loop\nsage -t --long sage/rings/finite_rings/integer_mod.pyx\ncpu time: 7.8 seconds\nsage: %timeit -c -r 1 test1()\n1 loops, best of 1: 1.28 s per loop\nsage: %timeit -c -r 1 test2(1000)\n1 loops, best of 1: 6.84 s per loop\n```\n\n(On x86_64 GNU/Linux, but a different machine than in comment:13. The increase in doctest time is because of the new test in this patch.)",
    "created_at": "2013-09-13T16:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164915",
    "user": "pbruin"
}
```

Again some timings:

```
a = 176338465705
b = 161089773287
n = 217267613611

def test1():
    for p,q,r in cartesian_product_iterator([[3,5],[11,13],[17,19]]):
        for ep,eq,er in cartesian_product_iterator([[0,1,2,3],[0,1,2,3],[0,1,2,3]]):
            for e2 in [0,1,2,3,4]:
                n = p^ep*q^eq*r^er*2^e2
                for _ in range(2):
                    a = Zmod(n).random_element()
                    b = a.is_square()

def test2(bound):
    for n in xrange(bound):
        for a in xrange(n):
            b = Mod(a, n).is_square()

# without patch
sage: %timeit -c -n 100000 -r 1 Zmod(n)(a).is_square()
100000 loops, best of 1: 11.5 us per loop
sage: %timeit -c -n 100000 -r 1 Zmod(n)(b).is_square()
100000 loops, best of 1: 9.64 us per loop
sage -t --long sage/rings/finite_rings/integer_mod.pyx
cpu time: 5.5 seconds
sage: %timeit -c -r 1 test1()
1 loops, best of 1: 1.27 s per loop
sage: %timeit -c -r 1 test2(1000)
1 loops, best of 1: 7.12 s per loop

# with patch
sage: %timeit -c -n 100000 -r 1 Zmod(n)(a).is_square()
100000 loops, best of 1: 12.1 us per loop
sage: %timeit -c -n 100000 -r 1 Zmod(n)(b).is_square()
100000 loops, best of 1: 6.52 us per loop
sage -t --long sage/rings/finite_rings/integer_mod.pyx
cpu time: 7.8 seconds
sage: %timeit -c -r 1 test1()
1 loops, best of 1: 1.28 s per loop
sage: %timeit -c -r 1 test2(1000)
1 loops, best of 1: 6.84 s per loop
```

(On x86_64 GNU/Linux, but a different machine than in comment:13. The increase in doctest time is because of the new test in this patch.)



---

archive/issue_comments_164916.json:
```json
{
    "body": "Hi, I didn't have time to go through this ticket, but FYI I've reimplemented the modular squareroot in cython using mpz's (translating the original python/cython implem) at least when the mod is prime or 4 times a prime as part of an implementation of ECPP.\nIt's much faster than what we have and faster than PARI IIRC.\nThis should get published together with the rest of the ECPP implem when the code is a little more polished, let's say before the end of the year hopefully.\n(We'll also present it in Paris at some Sage afternoon next week.)",
    "created_at": "2013-09-15T08:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164916",
    "user": "jpflori"
}
```

Hi, I didn't have time to go through this ticket, but FYI I've reimplemented the modular squareroot in cython using mpz's (translating the original python/cython implem) at least when the mod is prime or 4 times a prime as part of an implementation of ECPP.
It's much faster than what we have and faster than PARI IIRC.
This should get published together with the rest of the ECPP implem when the code is a little more polished, let's say before the end of the year hopefully.
(We'll also present it in Paris at some Sage afternoon next week.)



---

archive/issue_comments_164917.json:
```json
{
    "body": "Patchbot:\n\n```\napply 13596_new.patch\n```\n",
    "created_at": "2013-09-23T10:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164917",
    "user": "pbruin"
}
```

Patchbot:

```
apply 13596_new.patch
```




---

archive/issue_comments_164918.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:",
    "created_at": "2013-12-20T13:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164918",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Recent commits:



---

archive/issue_comments_164919.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-25T17:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164919",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_164920.json:
```json
{
    "body": "Looks good to me, nice work.\nSuccessfully built and tested on one system as well.",
    "created_at": "2013-12-25T17:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164920",
    "user": "jpflori"
}
```

Looks good to me, nice work.
Successfully built and tested on one system as well.



---

archive/issue_comments_164921.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-01-05T00:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13392",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13392#issuecomment-164921",
    "user": "vbraun"
}
```

Resolution: fixed
