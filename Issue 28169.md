# Issue 28169: barvinok fails to build

Issue created by migration from https://trac.sagemath.org/ticket/28406

Original creator: vdelecroix

Original creation time: 2019-08-26 15:11:12

CC:  dimpase arojas

On my machine where the system NTL is used, the optional package barvinok fails to build (Sage version 8.9.beta8).


---

Attachment


---

Attachment


---

Attachment


---

Comment by dimpase created at 2019-08-26 19:07:00

ok, so in barvinok-config one sees 

```
2415	configure:14457: gcc -o conftest -g -O2    -L/opt/sage/local/lib -Wl,-rpath,/opt/sage/local/lib  conftest.c -lntl  -lgmp  >&5
2416	/usr/bin/ld: /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/../../../../lib/libntl.so: undefined reference to `pthread_key_create'
2417	/usr/bin/ld: /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/../../../../lib/libntl.so: undefined reference to `pthread_setspecific'
2418	collect2: error: ld returned 1 exit status
```

which is why it does not build.

Could you post the output of 

```
ldd /usr/lib/libntl.so
```

it seems it's multi-threaded on Arch?

Without `barvinok`, did you run tests for this installation of Sage?
If everything works (I hope so), we should fix the configure of `barvinok`, or perhaps just its `spkg-install`. (It seems it needs to be linked with `-lpthread` as well).

It could also be that `libntl` is underlinked on Arch...


---

Comment by arojas created at 2019-08-26 23:14:34

Yes, this is a bug in ntl, which fails to link to libpthread when built with multi-thread support. It is caused by them using libtool as the build command, which adds -nostdlib to the gcc flags, which in turn overrides the -pthread flag.

I reported this to Victor a long time ago (by private mail since he doesn't use a bug tracker) but hasn't been fixed yet. For a while I was linking it manually as a workaround but I stopped doing it a few releases ago since all official Arch packages that link to ntl were working fine - but this seems to be simply because they link to libpthread themselves so the issue was just being masked.

I've restored the workaroung for now, so this should be fixed on Arch with ntl 11.3.2-2. But it will affect all distros that build ntl multi-threaded unless they apply a similar workaround.


---

Comment by vdelecroix created at 2019-08-27 08:34:31

Replying to [comment:3 dimpase]:
> Could you post the output of 
> {{{
> ldd /usr/lib/libntl.so
> }}}
> it seems it's multi-threaded on Arch?


```
$ ldd /usr/lib/libntl.so
	linux-vdso.so.1 (0x00007ffd54c8b000)
	libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007fb2c0643000)
	libgf2x.so.1 => /usr/lib/libgf2x.so.1 (0x00007fb2c0626000)
	libstdc++.so.6 => /usr/lib/libstdc++.so.6 (0x00007fb2c043e000)
	libm.so.6 => /usr/lib/libm.so.6 (0x00007fb2c02f8000)
	libc.so.6 => /usr/lib/libc.so.6 (0x00007fb2c0135000)
	/usr/lib64/ld-linux-x86-64.so.2 (0x00007fb2c09aa000)
	libgcc_s.so.1 => /usr/lib/libgcc_s.so.1 (0x00007fb2c011b000)
```



---

Comment by dimpase created at 2019-08-27 08:37:55

If I read comment:6 correctly, you should be able to install an update to NTL that fixes the issue.


---

Comment by vdelecroix created at 2019-08-27 08:40:14

Replying to [comment:8 dimpase]:
> If I read comment:6 correctly, you should be able to install an update to NTL that fixes the issue. 

Yes, I downloaded the latest version pushed by Antonio. However, in the meantime I installed Sage NTL and I have to rebuild everything from scratch... Needs some time before I confirm that this is fixed.


---

Comment by vdelecroix created at 2019-08-27 09:34:58

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-08-27 09:34:58

This is fixed! Thanks!


---

Comment by dimpase created at 2019-08-27 10:15:22

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2019-08-27 14:31:02

For what it's worth I had similar problems linking NTL into eclib.  I seem to have solved it but could not possibly explain properly; but looking at eclib's configure setup might help.


---

Comment by chapoton created at 2019-09-02 07:33:47

Resolution: worksforme
