# Issue 28169: barvinok fails to build

archive/issues_028169.json:
```json
{
    "body": "CC:  @dimpase @antonio-rojas\n\nOn my machine where the system NTL is used, the optional package barvinok fails to build (Sage version 8.9.beta8).\n\nIssue created by migration from https://trac.sagemath.org/ticket/28406\n\n",
    "created_at": "2019-08-26T15:11:12Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "barvinok fails to build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28169",
    "user": "https://github.com/videlec"
}
```
CC:  @dimpase @antonio-rojas

On my machine where the system NTL is used, the optional package barvinok fails to build (Sage version 8.9.beta8).

Issue created by migration from https://trac.sagemath.org/ticket/28406





---

archive/issue_comments_397272.json:
```json
{
    "body": "Attachment [config.log](tarball://root/attachments/some-uuid/ticket28406/config.log) by @videlec created at 2019-08-26 15:11:40",
    "created_at": "2019-08-26T15:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397272",
    "user": "https://github.com/videlec"
}
```

Attachment [config.log](tarball://root/attachments/some-uuid/ticket28406/config.log) by @videlec created at 2019-08-26 15:11:40



---

archive/issue_comments_397273.json:
```json
{
    "body": "Attachment [barvinok-0.41.1.log](tarball://root/attachments/some-uuid/ticket28406/barvinok-0.41.1.log) by @videlec created at 2019-08-26 15:15:10",
    "created_at": "2019-08-26T15:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397273",
    "user": "https://github.com/videlec"
}
```

Attachment [barvinok-0.41.1.log](tarball://root/attachments/some-uuid/ticket28406/barvinok-0.41.1.log) by @videlec created at 2019-08-26 15:15:10



---

archive/issue_comments_397274.json:
```json
{
    "body": "Attachment [barvinok-config.log](tarball://root/attachments/some-uuid/ticket28406/barvinok-config.log) by @videlec created at 2019-08-26 15:16:58",
    "created_at": "2019-08-26T15:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397274",
    "user": "https://github.com/videlec"
}
```

Attachment [barvinok-config.log](tarball://root/attachments/some-uuid/ticket28406/barvinok-config.log) by @videlec created at 2019-08-26 15:16:58



---

archive/issue_comments_397275.json:
```json
{
    "body": "ok, so in barvinok-config one sees \n\n```\n2415\tconfigure:14457: gcc -o conftest -g -O2    -L/opt/sage/local/lib -Wl,-rpath,/opt/sage/local/lib  conftest.c -lntl  -lgmp  >&5\n2416\t/usr/bin/ld: /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/../../../../lib/libntl.so: undefined reference to `pthread_key_create'\n2417\t/usr/bin/ld: /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/../../../../lib/libntl.so: undefined reference to `pthread_setspecific'\n2418\tcollect2: error: ld returned 1 exit status\n```\n\nwhich is why it does not build.\n\nCould you post the output of \n\n```\nldd /usr/lib/libntl.so\n```\n\nit seems it's multi-threaded on Arch?\n\nWithout `barvinok`, did you run tests for this installation of Sage?\nIf everything works (I hope so), we should fix the configure of `barvinok`, or perhaps just its `spkg-install`. (It seems it needs to be linked with `-lpthread` as well).\n\nIt could also be that `libntl` is underlinked on Arch...",
    "created_at": "2019-08-26T19:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397275",
    "user": "https://github.com/dimpase"
}
```

ok, so in barvinok-config one sees 

```
2415	configure:14457: gcc -o conftest -g -O2    -L/opt/sage/local/lib -Wl,-rpath,/opt/sage/local/lib  conftest.c -lntl  -lgmp  >&5
2416	/usr/bin/ld: /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/../../../../lib/libntl.so: undefined reference to `pthread_key_create'
2417	/usr/bin/ld: /usr/lib/gcc/x86_64-pc-linux-gnu/9.1.0/../../../../lib/libntl.so: undefined reference to `pthread_setspecific'
2418	collect2: error: ld returned 1 exit status
```

which is why it does not build.

Could you post the output of 

```
ldd /usr/lib/libntl.so
```

it seems it's multi-threaded on Arch?

Without `barvinok`, did you run tests for this installation of Sage?
If everything works (I hope so), we should fix the configure of `barvinok`, or perhaps just its `spkg-install`. (It seems it needs to be linked with `-lpthread` as well).

It could also be that `libntl` is underlinked on Arch...



---

archive/issue_comments_397276.json:
```json
{
    "body": "Yes, this is a bug in ntl, which fails to link to libpthread when built with multi-thread support. It is caused by them using libtool as the build command, which adds -nostdlib to the gcc flags, which in turn overrides the -pthread flag.\n\nI reported this to Victor a long time ago (by private mail since he doesn't use a bug tracker) but hasn't been fixed yet. For a while I was linking it manually as a workaround but I stopped doing it a few releases ago since all official Arch packages that link to ntl were working fine - but this seems to be simply because they link to libpthread themselves so the issue was just being masked.\n\nI've restored the workaroung for now, so this should be fixed on Arch with ntl 11.3.2-2. But it will affect all distros that build ntl multi-threaded unless they apply a similar workaround.",
    "created_at": "2019-08-26T23:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397276",
    "user": "https://github.com/antonio-rojas"
}
```

Yes, this is a bug in ntl, which fails to link to libpthread when built with multi-thread support. It is caused by them using libtool as the build command, which adds -nostdlib to the gcc flags, which in turn overrides the -pthread flag.

I reported this to Victor a long time ago (by private mail since he doesn't use a bug tracker) but hasn't been fixed yet. For a while I was linking it manually as a workaround but I stopped doing it a few releases ago since all official Arch packages that link to ntl were working fine - but this seems to be simply because they link to libpthread themselves so the issue was just being masked.

I've restored the workaroung for now, so this should be fixed on Arch with ntl 11.3.2-2. But it will affect all distros that build ntl multi-threaded unless they apply a similar workaround.



---

archive/issue_comments_397277.json:
```json
{
    "body": "Replying to [comment:3 dimpase]:\n> Could you post the output of \n> {{{\n> ldd /usr/lib/libntl.so\n> }}}\n> it seems it's multi-threaded on Arch?\n\n\n```\n$ ldd /usr/lib/libntl.so\n\tlinux-vdso.so.1 (0x00007ffd54c8b000)\n\tlibgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007fb2c0643000)\n\tlibgf2x.so.1 => /usr/lib/libgf2x.so.1 (0x00007fb2c0626000)\n\tlibstdc++.so.6 => /usr/lib/libstdc++.so.6 (0x00007fb2c043e000)\n\tlibm.so.6 => /usr/lib/libm.so.6 (0x00007fb2c02f8000)\n\tlibc.so.6 => /usr/lib/libc.so.6 (0x00007fb2c0135000)\n\t/usr/lib64/ld-linux-x86-64.so.2 (0x00007fb2c09aa000)\n\tlibgcc_s.so.1 => /usr/lib/libgcc_s.so.1 (0x00007fb2c011b000)\n```\n",
    "created_at": "2019-08-27T08:34:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397277",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:3 dimpase]:
> Could you post the output of 
> {{{
> ldd /usr/lib/libntl.so
> }}}
> it seems it's multi-threaded on Arch?


```
$ ldd /usr/lib/libntl.so
	linux-vdso.so.1 (0x00007ffd54c8b000)
	libgmp.so.10 => /usr/lib/libgmp.so.10 (0x00007fb2c0643000)
	libgf2x.so.1 => /usr/lib/libgf2x.so.1 (0x00007fb2c0626000)
	libstdc++.so.6 => /usr/lib/libstdc++.so.6 (0x00007fb2c043e000)
	libm.so.6 => /usr/lib/libm.so.6 (0x00007fb2c02f8000)
	libc.so.6 => /usr/lib/libc.so.6 (0x00007fb2c0135000)
	/usr/lib64/ld-linux-x86-64.so.2 (0x00007fb2c09aa000)
	libgcc_s.so.1 => /usr/lib/libgcc_s.so.1 (0x00007fb2c011b000)
```




---

archive/issue_comments_397278.json:
```json
{
    "body": "If I read comment:6 correctly, you should be able to install an update to NTL that fixes the issue.",
    "created_at": "2019-08-27T08:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397278",
    "user": "https://github.com/dimpase"
}
```

If I read comment:6 correctly, you should be able to install an update to NTL that fixes the issue.



---

archive/issue_comments_397279.json:
```json
{
    "body": "Replying to [comment:8 dimpase]:\n> If I read comment:6 correctly, you should be able to install an update to NTL that fixes the issue. \n\nYes, I downloaded the latest version pushed by Antonio. However, in the meantime I installed Sage NTL and I have to rebuild everything from scratch... Needs some time before I confirm that this is fixed.",
    "created_at": "2019-08-27T08:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397279",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:8 dimpase]:
> If I read comment:6 correctly, you should be able to install an update to NTL that fixes the issue. 

Yes, I downloaded the latest version pushed by Antonio. However, in the meantime I installed Sage NTL and I have to rebuild everything from scratch... Needs some time before I confirm that this is fixed.



---

archive/issue_comments_397280.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-08-27T09:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397280",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_397281.json:
```json
{
    "body": "This is fixed! Thanks!",
    "created_at": "2019-08-27T09:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397281",
    "user": "https://github.com/videlec"
}
```

This is fixed! Thanks!



---

archive/issue_comments_397282.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-27T10:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397282",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_397283.json:
```json
{
    "body": "For what it's worth I had similar problems linking NTL into eclib.  I seem to have solved it but could not possibly explain properly; but looking at eclib's configure setup might help.",
    "created_at": "2019-08-27T14:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397283",
    "user": "https://github.com/JohnCremona"
}
```

For what it's worth I had similar problems linking NTL into eclib.  I seem to have solved it but could not possibly explain properly; but looking at eclib's configure setup might help.



---

archive/issue_comments_397284.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2019-09-02T07:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28169#issuecomment-397284",
    "user": "https://github.com/fchapoton"
}
```

Resolution: worksforme



---

archive/issue_events_026102.json:
```json
{
    "actor": "@fchapoton",
    "created_at": "2019-09-02T07:33:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28169",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28169#event-26102"
}
```
