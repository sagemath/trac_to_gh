# Issue 23105: Cython wrapper for Hein's ternary Birch code

archive/issues_023105.json:
```json
{
    "body": "CC:  jvoight tornaria\n\nKeywords: Hecke operators, quadratic forms\n\nOne product of Jeffery Hein's PhD thesis is some impressive C++ code for computing Hecke operators on spaces of modular forms, based on a method of Birch involving reduction of ternary quadratic forms. Besides being very fast, the code produces sparse integer matrices for individual Atkin-Lehner eigenspaces.\n\nThe code is available at\n\nhttps://github.com/jefferyphein/ternary-birch\n\nand it would be great to get it into Sage. This might require some better packaging on the upstream end, but for now I'm focusing on building a working Cython wrapper. I have some progress on that, but I'm new to the Cython/C++ interaction and that is holding things up.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23342\n\n",
    "created_at": "2017-06-30T05:46:48Z",
    "labels": [
        "modular forms",
        "minor",
        "enhancement"
    ],
    "title": "Cython wrapper for Hein's ternary Birch code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23105",
    "user": "kedlaya"
}
```
CC:  jvoight tornaria

Keywords: Hecke operators, quadratic forms

One product of Jeffery Hein's PhD thesis is some impressive C++ code for computing Hecke operators on spaces of modular forms, based on a method of Birch involving reduction of ternary quadratic forms. Besides being very fast, the code produces sparse integer matrices for individual Atkin-Lehner eigenspaces.

The code is available at

https://github.com/jefferyphein/ternary-birch

and it would be great to get it into Sage. This might require some better packaging on the upstream end, but for now I'm focusing on building a working Cython wrapper. I have some progress on that, but I'm new to the Cython/C++ interaction and that is holding things up.

Issue created by migration from https://trac.sagemath.org/ticket/23342





---

archive/issue_comments_323167.json:
```json
{
    "body": "Replying to [ticket:23342 kedlaya]:\n> This might require some better packaging on the upstream end\n\nI see that this package uses SCons unfortunately. I personally hate SCons because it is much less portable than other alternatives. We used to have a few packages in Sage using SCons, but we either got rid of them or we ported them to a different build system. Besides that, there is also the simple fact that SCons is not shipped with Sage. Luckily, the package is simple enough, so porting to autotools should not be too hard.",
    "created_at": "2017-06-30T10:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323167",
    "user": "jdemeyer"
}
```

Replying to [ticket:23342 kedlaya]:
> This might require some better packaging on the upstream end

I see that this package uses SCons unfortunately. I personally hate SCons because it is much less portable than other alternatives. We used to have a few packages in Sage using SCons, but we either got rid of them or we ported them to a different build system. Besides that, there is also the simple fact that SCons is not shipped with Sage. Luckily, the package is simple enough, so porting to autotools should not be too hard.



---

archive/issue_comments_323168.json:
```json
{
    "body": "Replying to [comment:1 jdemeyer]:\n> Replying to [ticket:23342 kedlaya]:\n> > This might require some better packaging on the upstream end\n> \n> I see that this package uses SCons unfortunately. I personally hate SCons because it is much less portable than other alternatives. We used to have a few packages in Sage using SCons, but we either got rid of them or we ported them to a different build system. Besides that, there is also the simple fact that SCons is not shipped with Sage. Luckily, the package is simple enough, so porting to autotools should not be too hard.\n\nWe may be able to get some help from upstream if it comes to that. Anyway, the purpose of this ticket is just the wrapper; I plan to open another ticket regarding packaging later if we get that far.",
    "created_at": "2017-06-30T16:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323168",
    "user": "kedlaya"
}
```

Replying to [comment:1 jdemeyer]:
> Replying to [ticket:23342 kedlaya]:
> > This might require some better packaging on the upstream end
> 
> I see that this package uses SCons unfortunately. I personally hate SCons because it is much less portable than other alternatives. We used to have a few packages in Sage using SCons, but we either got rid of them or we ported them to a different build system. Besides that, there is also the simple fact that SCons is not shipped with Sage. Luckily, the package is simple enough, so porting to autotools should not be too hard.

We may be able to get some help from upstream if it comes to that. Anyway, the purpose of this ticket is just the wrapper; I plan to open another ticket regarding packaging later if we get that far.



---

archive/issue_comments_323169.json:
```json
{
    "body": "Sage+Cython wrapper to Hein's C++ code",
    "created_at": "2017-08-25T20:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323169",
    "user": "kedlaya"
}
```

Sage+Cython wrapper to Hein's C++ code



---

archive/issue_comments_323170.json:
```json
{
    "body": "Attachment\n\nI've attached a working wrapper to Hein's code. The code itself may be of some independent interest besides what I've exposed (e.g., for dealing with quaternion algebras), but I'm not sure if it can easily be made 32-bit-safe. (This has been an issue with incorporating other packages; see for instance #965.)\n\nBy the way, the publicly available reference for Birch's method is Birch's 1991 article \"Hecke actions on classes of ternary quadratic forms\".",
    "created_at": "2017-08-25T20:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323170",
    "user": "kedlaya"
}
```

Attachment

I've attached a working wrapper to Hein's code. The code itself may be of some independent interest besides what I've exposed (e.g., for dealing with quaternion algebras), but I'm not sure if it can easily be made 32-bit-safe. (This has been an issue with incorporating other packages; see for instance #965.)

By the way, the publicly available reference for Birch's method is Birch's 1991 article "Hecke actions on classes of ternary quadratic forms".



---

archive/issue_comments_323171.json:
```json
{
    "body": "Changing keywords from \"Hecke operators, quadratic forms\" to \"Hecke operators, quadratic forms, days88\".",
    "created_at": "2017-08-25T20:06:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323171",
    "user": "kedlaya"
}
```

Changing keywords from "Hecke operators, quadratic forms" to "Hecke operators, quadratic forms, days88".



---

archive/issue_comments_323172.json:
```json
{
    "body": "It seems that I managed to include enough build directives in my Cython that there is no need for Scons (just tested this on a fresh copy).",
    "created_at": "2017-08-26T18:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323172",
    "user": "kedlaya"
}
```

It seems that I managed to include enough build directives in my Cython that there is no need for Scons (just tested this on a fresh copy).



---

archive/issue_comments_323173.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-09-18T16:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323173",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_323174.json:
```json
{
    "body": "Changing keywords from \"Hecke operators, quadratic forms, days88\" to \"Hecke operators, quadratic forms, days88, sd91\".",
    "created_at": "2017-09-30T22:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323174",
    "user": "roed"
}
```

Changing keywords from "Hecke operators, quadratic forms, days88" to "Hecke operators, quadratic forms, days88, sd91".



---

archive/issue_comments_323175.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-10T17:21:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323175",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323176.json:
```json
{
    "body": "Quick update: in light of the deprecation warnings, I changed the pragmas to use distutils.\n\nThis currently \"works\" in the following sense: if I put `hein_wrapper.pyx` in the same folder as the Hein code, then running `load(\"hein_wrapper.pyx\")` works in Sage 8.2. However, I haven't thought at all about packaging this to actually build as part of Sage.",
    "created_at": "2018-05-10T17:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323176",
    "user": "kedlaya"
}
```

Quick update: in light of the deprecation warnings, I changed the pragmas to use distutils.

This currently "works" in the following sense: if I put `hein_wrapper.pyx` in the same folder as the Hein code, then running `load("hein_wrapper.pyx")` works in Sage 8.2. However, I haven't thought at all about packaging this to actually build as part of Sage.



---

archive/issue_comments_323177.json:
```json
{
    "body": "I see two options:\n\n1. Simply \"fork\" the upstream into Sage, meaning copy the code.\n\n2. Add a proper build system to the upstream package (for example using autotools) and then add that to Sage as optional package.",
    "created_at": "2018-05-10T19:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323177",
    "user": "jdemeyer"
}
```

I see two options:

1. Simply "fork" the upstream into Sage, meaning copy the code.

2. Add a proper build system to the upstream package (for example using autotools) and then add that to Sage as optional package.



---

archive/issue_comments_323178.json:
```json
{
    "body": "My impression is that Hein would be willing to accept code upstream (he is not working in academia and may not be spending too much time on this anymore). So setting up a proper build system upstream might be the best plan here; but I'm not competent to do this myself.",
    "created_at": "2018-05-10T20:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323178",
    "user": "kedlaya"
}
```

My impression is that Hein would be willing to accept code upstream (he is not working in academia and may not be spending too much time on this anymore). So setting up a proper build system upstream might be the best plan here; but I'm not competent to do this myself.



---

archive/issue_comments_323179.json:
```json
{
    "body": "Update: Hein has released a 2.0 version of his code with a much better Sage wrapper than the one I wrote. So we might be able to get by with forking the upstream and discarding my previous code (which would be fine with me).\n----\nNew commits:",
    "created_at": "2019-01-26T18:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23105#issuecomment-323179",
    "user": "kedlaya"
}
```

Update: Hein has released a 2.0 version of his code with a much better Sage wrapper than the one I wrote. So we might be able to get by with forking the upstream and discarding my previous code (which would be fine with me).
----
New commits:
