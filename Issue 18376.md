# Issue 18376: Errors with is_isomorphic() for trivial cones

archive/issues_018376.json:
```json
{
    "body": "Random testing (from Ticket #18454) reveals the following. I'm not familiar with the `Fan` stuff, so this might not even be an issue mathematically.\n\n\n```\nsage: K = Cone([], ToricLattice(0))\nsage: K.is_isomorphic(K)\n...\nKeyError: (frozenset([]), frozenset([]))\n```\n\n\n\n```\nsage: K = Cone([(0,)])\nsage: K.is_isomorphic(K)\n...\nTypeError: 'bool' object has no attribute '__getitem__'\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18613\n\n",
    "created_at": "2015-06-04T21:25:05Z",
    "labels": [
        "geometry",
        "major",
        "bug"
    ],
    "title": "Errors with is_isomorphic() for trivial cones",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18376",
    "user": "mjo"
}
```
Random testing (from Ticket #18454) reveals the following. I'm not familiar with the `Fan` stuff, so this might not even be an issue mathematically.


```
sage: K = Cone([], ToricLattice(0))
sage: K.is_isomorphic(K)
...
KeyError: (frozenset([]), frozenset([]))
```



```
sage: K = Cone([(0,)])
sage: K.is_isomorphic(K)
...
TypeError: 'bool' object has no attribute '__getitem__'
```



Issue created by migration from https://trac.sagemath.org/ticket/18613





---

archive/issue_comments_249456.json:
```json
{
    "body": "Well, mathematically the cone consisting of the origin in a 0-dimensional space is certainly isomorphic to itself and correctly handling such cases is often important for algorithms that ran into corner cases on less trivial examples.\n\nOn an unrelated note it is sad I didn't notice this ticket before, looks like RSS on trac has changed.",
    "created_at": "2015-07-30T00:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249456",
    "user": "novoselt"
}
```

Well, mathematically the cone consisting of the origin in a 0-dimensional space is certainly isomorphic to itself and correctly handling such cases is often important for algorithms that ran into corner cases on less trivial examples.

On an unrelated note it is sad I didn't notice this ticket before, looks like RSS on trac has changed.



---

archive/issue_comments_249457.json:
```json
{
    "body": "So the problem is with constructing the cone lattice of a fan containing the trivial cone only. We probably should call/get\n\n```\nsage: list(sage.geometry.cone.Hasse_diagram_from_incidences([()], [()]))\n[((), (0,)), ((0,), ())]\n```\n\nfor the lattice with a single atom (fan) and single coatom (trivial cone). We seem to correctly pass the list of coatoms, but have no atoms at all.",
    "created_at": "2015-07-30T01:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249457",
    "user": "novoselt"
}
```

So the problem is with constructing the cone lattice of a fan containing the trivial cone only. We probably should call/get

```
sage: list(sage.geometry.cone.Hasse_diagram_from_incidences([()], [()]))
[((), (0,)), ((0,), ())]
```

for the lattice with a single atom (fan) and single coatom (trivial cone). We seem to correctly pass the list of coatoms, but have no atoms at all.



---

archive/issue_comments_249458.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-30T21:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249458",
    "user": "novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_249459.json:
```json
{
    "body": "Both problems are fixed, thanks for detecting them!\n----\nNew commits:",
    "created_at": "2015-07-30T21:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249459",
    "user": "novoselt"
}
```

Both problems are fixed, thanks for detecting them!
----
New commits:



---

archive/issue_comments_249460.json:
```json
{
    "body": "hum, what is this change in \"generic_graph\" doing in this branch ??",
    "created_at": "2015-07-31T11:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249460",
    "user": "chapoton"
}
```

hum, what is this change in "generic_graph" doing in this branch ??



---

archive/issue_comments_249461.json:
```json
{
    "body": "There were two reasons why cones could not check isomorphness: corner case handling in fans and getting isomorphism with maps from trivial graphs.",
    "created_at": "2015-07-31T18:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249461",
    "user": "novoselt"
}
```

There were two reasons why cones could not check isomorphness: corner case handling in fans and getting isomorphism with maps from trivial graphs.



---

archive/issue_comments_249462.json:
```json
{
    "body": "This ticket is a treasure chest of chained bugs, the latest one is\n\n```\nsage: K = Cone([(0,0)]); K.is_isomorphic(K)\n```\n\nwhich, after fixing a corner case in fan code, boils down to\n\n```\nsage: matrix(2, 1).echelon_form().is_mutable()\nFalse\nsage: matrix(2, 0).echelon_form().is_mutable()\nTrue\n```\n\nworking on it...",
    "created_at": "2015-07-31T23:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249462",
    "user": "novoselt"
}
```

This ticket is a treasure chest of chained bugs, the latest one is

```
sage: K = Cone([(0,0)]); K.is_isomorphic(K)
```

which, after fixing a corner case in fan code, boils down to

```
sage: matrix(2, 1).echelon_form().is_mutable()
False
sage: matrix(2, 0).echelon_form().is_mutable()
True
```

working on it...



---

archive/issue_comments_249463.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-07-31T23:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249463",
    "user": "novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_249464.json:
```json
{
    "body": "But since I am not quite sure what to do: https://groups.google.com/d/topic/sage-devel/rmQbBbddUwY/discussion",
    "created_at": "2015-07-31T23:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249464",
    "user": "novoselt"
}
```

But since I am not quite sure what to do: https://groups.google.com/d/topic/sage-devel/rmQbBbddUwY/discussion



---

archive/issue_comments_249465.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-01T00:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249465",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_249466.json:
```json
{
    "body": "found a typo:\n\n```\ntrac:`18613`\n```\n\nmissing the colon before trac",
    "created_at": "2015-08-03T18:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249466",
    "user": "chapoton"
}
```

found a typo:

```
trac:`18613`
```

missing the colon before trac



---

archive/issue_comments_249467.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-11T01:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249467",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_249468.json:
```json
{
    "body": "Fixed the typo and cleaned up `echelon_form` a bit.",
    "created_at": "2015-08-11T01:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249468",
    "user": "novoselt"
}
```

Fixed the typo and cleaned up `echelon_form` a bit.



---

archive/issue_comments_249469.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-11T01:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249469",
    "user": "novoselt"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_249470.json:
```json
{
    "body": "Changing keywords from \"\" to \"cone\".",
    "created_at": "2015-08-11T18:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249470",
    "user": "chapoton"
}
```

Changing keywords from "" to "cone".



---

archive/issue_comments_249471.json:
```json
{
    "body": "This seems to cause a lot of failing doctests now !",
    "created_at": "2015-08-11T18:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249471",
    "user": "chapoton"
}
```

This seems to cause a lot of failing doctests now !



---

archive/issue_comments_249472.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-08-11T18:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249472",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_249473.json:
```json
{
    "body": "Indeed, something is off with toric morphisms now (these are the only doctests I see failing). Investigating...",
    "created_at": "2015-08-11T21:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249473",
    "user": "novoselt"
}
```

Indeed, something is off with toric morphisms now (these are the only doctests I see failing). Investigating...



---

archive/issue_comments_249474.json:
```json
{
    "body": "Yet another bug uncovered by this ticket. In clean 6.9.beta0 I get\n\n```\nsage:             sage: polytope = LatticePolytope(\n....:             ...       [(-3,0,-1,-1),(-1,2,-1,-1),(0,-1,0,0),(0,0,0,1),(0,0,1,0),\n....:             ...        (0,1,0,0),(0,2,-1,-1),(1,0,0,0),(2,0,-1,-1)])\nsage:             sage: coarse_fan = FaceFan(polytope)\nsage:             sage: P2 = toric_varieties.P2()\nsage:             sage: proj24 = matrix([[0,0],[1,0],[0,0],[0,1]])\nsage: proj24\n[0 0]\n[1 0]\n[0 0]\n[0 1]\nsage: proj24.pivots()\n(0, 1)\nsage:             sage: fm = FanMorphism(proj24, coarse_fan, P2.fan(), subdivide=True)\nsage: fm.matrix()\n[0 0]\n[1 0]\n[0 0]\n[0 1]\nsage: fm.matrix().pivots()\n(0, 1, 2, 4)\n```\n\nso pivots are obviously screwed up somewhere. With my changes this affects the rank computation as well. Now to figure out the fix...",
    "created_at": "2015-08-11T21:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249474",
    "user": "novoselt"
}
```

Yet another bug uncovered by this ticket. In clean 6.9.beta0 I get

```
sage:             sage: polytope = LatticePolytope(
....:             ...       [(-3,0,-1,-1),(-1,2,-1,-1),(0,-1,0,0),(0,0,0,1),(0,0,1,0),
....:             ...        (0,1,0,0),(0,2,-1,-1),(1,0,0,0),(2,0,-1,-1)])
sage:             sage: coarse_fan = FaceFan(polytope)
sage:             sage: P2 = toric_varieties.P2()
sage:             sage: proj24 = matrix([[0,0],[1,0],[0,0],[0,1]])
sage: proj24
[0 0]
[1 0]
[0 0]
[0 1]
sage: proj24.pivots()
(0, 1)
sage:             sage: fm = FanMorphism(proj24, coarse_fan, P2.fan(), subdivide=True)
sage: fm.matrix()
[0 0]
[1 0]
[0 0]
[0 1]
sage: fm.matrix().pivots()
(0, 1, 2, 4)
```

so pivots are obviously screwed up somewhere. With my changes this affects the rank computation as well. Now to figure out the fix...



---

archive/issue_comments_249475.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-11T23:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249475",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_249476.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-08-11T23:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249476",
    "user": "novoselt"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_249477.json:
```json
{
    "body": "My latest attempt. grepping suggests that `hnf_with_transformation` was used in a single place and I think it is unlikely to be used by users directly, so I dropped pivots from its output. Even if somebody was using directly, they were getting wrong results for all matrices of not full rank. I have also tried to clean up the code of `echelon_form` a bit more and get rid of copypasta.",
    "created_at": "2015-08-11T23:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249477",
    "user": "novoselt"
}
```

My latest attempt. grepping suggests that `hnf_with_transformation` was used in a single place and I think it is unlikely to be used by users directly, so I dropped pivots from its output. Even if somebody was using directly, they were getting wrong results for all matrices of not full rank. I have also tried to clean up the code of `echelon_form` a bit more and get rid of copypasta.



---

archive/issue_comments_249478.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-12T20:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249478",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_249479.json:
```json
{
    "body": "The first few fixes look good, but I have no idea what's going on with the HNF stuff and I'm not sure we can just throw it out. Would you be willing to move that to another ticket where someone more qualified can look at it?\n\nI've attempted to fix the `is_immutable()` issue separately (basically dropped your last two commits and made a copy of the trivial matrix in `echelon_form`). The only other issues were leading whitespace and that new OUTPUT block that I tried to clarify a little. It passes a ptestlong but leaves the pivot stuff as Somebody Else's Problem.\n----\nNew commits:",
    "created_at": "2015-08-12T21:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249479",
    "user": "mjo"
}
```

The first few fixes look good, but I have no idea what's going on with the HNF stuff and I'm not sure we can just throw it out. Would you be willing to move that to another ticket where someone more qualified can look at it?

I've attempted to fix the `is_immutable()` issue separately (basically dropped your last two commits and made a copy of the trivial matrix in `echelon_form`). The only other issues were leading whitespace and that new OUTPUT block that I tried to clarify a little. It passes a ptestlong but leaves the pivot stuff as Somebody Else's Problem.
----
New commits:



---

archive/issue_comments_249480.json:
```json
{
    "body": "Oh and I obviously stole some of your code in that last commit -- I'm not trying to take credit for it, I just didn't want to have a separate commit removing everything just added.",
    "created_at": "2015-08-12T22:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249480",
    "user": "mjo"
}
```

Oh and I obviously stole some of your code in that last commit -- I'm not trying to take credit for it, I just didn't want to have a separate commit removing everything just added.



---

archive/issue_comments_249481.json:
```json
{
    "body": "Please don't throw away my last commits - they are fixing a real problem that depending on the way how `echelon_form` is called matrix cache may become corrupted! And that the trivial case was just not handled correctly at all.",
    "created_at": "2015-08-12T22:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249481",
    "user": "novoselt"
}
```

Please don't throw away my last commits - they are fixing a real problem that depending on the way how `echelon_form` is called matrix cache may become corrupted! And that the trivial case was just not handled correctly at all.



---

archive/issue_comments_249482.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-08-12T22:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249482",
    "user": "novoselt"
}
```

New commits:



---

archive/issue_comments_249483.json:
```json
{
    "body": "Figuring out how to revert...\n----\nNew commits:",
    "created_at": "2015-08-12T22:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249483",
    "user": "novoselt"
}
```

Figuring out how to revert...
----
New commits:



---

archive/issue_comments_249484.json:
```json
{
    "body": "Replying to [comment:21 novoselt]:\n> Please don't throw away my last commits - they are fixing a real problem that depending on the way how `echelon_form` is called matrix cache may become corrupted! And that the trivial case was just not handled correctly at all.\n\nI know, but it's all unrelated to this ticket, isn't it? I don't want to drop them -- I'm just not qualified to review them at the moment. The first half I've reviewed and tested already, so we could set that to positive_review and then move your remaining commits to another ticket where someone who knows the matrix stuff could look at it.",
    "created_at": "2015-08-12T22:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249484",
    "user": "mjo"
}
```

Replying to [comment:21 novoselt]:
> Please don't throw away my last commits - they are fixing a real problem that depending on the way how `echelon_form` is called matrix cache may become corrupted! And that the trivial case was just not handled correctly at all.

I know, but it's all unrelated to this ticket, isn't it? I don't want to drop them -- I'm just not qualified to review them at the moment. The first half I've reviewed and tested already, so we could set that to positive_review and then move your remaining commits to another ticket where someone who knows the matrix stuff could look at it.



---

archive/issue_comments_249485.json:
```json
{
    "body": "One of the problems why `is_isomorphic` was not working was that `echelon_form` was not working correctly. After my fix of \"just the mutability issue\" there were 20 errors in toric morphisms because a matrix of rank 2 was now claimed to be of rank 4. Because `echelon_form` was still not working correctly. And as I've finally realized after making all tests pass, the handling of the trivial case was wrong as well apart from mutability. All these things really go together and I'd rather not separate them, but I've ping the sage-devel thread in case someone else is willing to take a look.",
    "created_at": "2015-08-12T22:16:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249485",
    "user": "novoselt"
}
```

One of the problems why `is_isomorphic` was not working was that `echelon_form` was not working correctly. After my fix of "just the mutability issue" there were 20 errors in toric morphisms because a matrix of rank 2 was now claimed to be of rank 4. Because `echelon_form` was still not working correctly. And as I've finally realized after making all tests pass, the handling of the trivial case was wrong as well apart from mutability. All these things really go together and I'd rather not separate them, but I've ping the sage-devel thread in case someone else is willing to take a look.



---

archive/issue_comments_249486.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-08-13T18:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249486",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_249487.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-08-13T20:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249487",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_249488.json:
```json
{
    "body": "Thank you Volker!",
    "created_at": "2015-08-14T01:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18376",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18376#issuecomment-249488",
    "user": "novoselt"
}
```

Thank you Volker!
