# Issue 18376: Errors with is_isomorphic() for trivial cones

Issue created by migration from https://trac.sagemath.org/ticket/18613

Original creator: mjo

Original creation time: 2015-06-04 21:25:05

Random testing (from Ticket #18454) reveals the following. I'm not familiar with the `Fan` stuff, so this might not even be an issue mathematically.


```
sage: K = Cone([], ToricLattice(0))
sage: K.is_isomorphic(K)
...
KeyError: (frozenset([]), frozenset([]))
```



```
sage: K = Cone([(0,)])
sage: K.is_isomorphic(K)
...
TypeError: 'bool' object has no attribute '__getitem__'
```




---

Comment by novoselt created at 2015-07-30 00:16:09

Well, mathematically the cone consisting of the origin in a 0-dimensional space is certainly isomorphic to itself and correctly handling such cases is often important for algorithms that ran into corner cases on less trivial examples.

On an unrelated note it is sad I didn't notice this ticket before, looks like RSS on trac has changed.


---

Comment by novoselt created at 2015-07-30 01:33:09

So the problem is with constructing the cone lattice of a fan containing the trivial cone only. We probably should call/get

```
sage: list(sage.geometry.cone.Hasse_diagram_from_incidences([()], [()]))
[((), (0,)), ((0,), ())]
```

for the lattice with a single atom (fan) and single coatom (trivial cone). We seem to correctly pass the list of coatoms, but have no atoms at all.


---

Comment by novoselt created at 2015-07-30 21:46:23

Changing status from new to needs_review.


---

Comment by novoselt created at 2015-07-30 21:46:23

Both problems are fixed, thanks for detecting them!
----
New commits:


---

Comment by chapoton created at 2015-07-31 11:51:10

hum, what is this change in "generic_graph" doing in this branch ??


---

Comment by novoselt created at 2015-07-31 18:41:08

There were two reasons why cones could not check isomorphness: corner case handling in fans and getting isomorphism with maps from trivial graphs.


---

Comment by novoselt created at 2015-07-31 23:36:11

This ticket is a treasure chest of chained bugs, the latest one is

```
sage: K = Cone([(0,0)]); K.is_isomorphic(K)
```

which, after fixing a corner case in fan code, boils down to

```
sage: matrix(2, 1).echelon_form().is_mutable()
False
sage: matrix(2, 0).echelon_form().is_mutable()
True
```

working on it...


---

Comment by novoselt created at 2015-07-31 23:59:23

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2015-07-31 23:59:23

But since I am not quite sure what to do: https://groups.google.com/d/topic/sage-devel/rmQbBbddUwY/discussion


---

Comment by git created at 2015-08-01 00:01:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-08-03 18:40:47

found a typo:

```
trac:`18613`
```

missing the colon before trac


---

Comment by git created at 2015-08-11 01:44:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2015-08-11 01:45:27

Fixed the typo and cleaned up `echelon_form` a bit.


---

Comment by novoselt created at 2015-08-11 01:45:27

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-08-11 18:55:15

Changing keywords from "" to "cone".


---

Comment by chapoton created at 2015-08-11 18:55:15

This seems to cause a lot of failing doctests now !


---

Comment by chapoton created at 2015-08-11 18:55:15

Changing status from needs_review to needs_work.


---

Comment by novoselt created at 2015-08-11 21:01:18

Indeed, something is off with toric morphisms now (these are the only doctests I see failing). Investigating...


---

Comment by novoselt created at 2015-08-11 21:44:11

Yet another bug uncovered by this ticket. In clean 6.9.beta0 I get

```
sage:             sage: polytope = LatticePolytope(
....:             ...       [(-3,0,-1,-1),(-1,2,-1,-1),(0,-1,0,0),(0,0,0,1),(0,0,1,0),
....:             ...        (0,1,0,0),(0,2,-1,-1),(1,0,0,0),(2,0,-1,-1)])
sage:             sage: coarse_fan = FaceFan(polytope)
sage:             sage: P2 = toric_varieties.P2()
sage:             sage: proj24 = matrix([[0,0],[1,0],[0,0],[0,1]])
sage: proj24
[0 0]
[1 0]
[0 0]
[0 1]
sage: proj24.pivots()
(0, 1)
sage:             sage: fm = FanMorphism(proj24, coarse_fan, P2.fan(), subdivide=True)
sage: fm.matrix()
[0 0]
[1 0]
[0 0]
[0 1]
sage: fm.matrix().pivots()
(0, 1, 2, 4)
```

so pivots are obviously screwed up somewhere. With my changes this affects the rank computation as well. Now to figure out the fix...


---

Comment by git created at 2015-08-11 23:17:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2015-08-11 23:22:48

Changing status from needs_work to needs_review.


---

Comment by novoselt created at 2015-08-11 23:22:48

My latest attempt. grepping suggests that `hnf_with_transformation` was used in a single place and I think it is unlikely to be used by users directly, so I dropped pivots from its output. Even if somebody was using directly, they were getting wrong results for all matrices of not full rank. I have also tried to clean up the code of `echelon_form` a bit more and get rid of copypasta.


---

Comment by git created at 2015-08-12 20:25:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2015-08-12 21:57:51

The first few fixes look good, but I have no idea what's going on with the HNF stuff and I'm not sure we can just throw it out. Would you be willing to move that to another ticket where someone more qualified can look at it?

I've attempted to fix the `is_immutable()` issue separately (basically dropped your last two commits and made a copy of the trivial matrix in `echelon_form`). The only other issues were leading whitespace and that new OUTPUT block that I tried to clarify a little. It passes a ptestlong but leaves the pivot stuff as Somebody Else's Problem.
----
New commits:


---

Comment by mjo created at 2015-08-12 22:01:16

Oh and I obviously stole some of your code in that last commit -- I'm not trying to take credit for it, I just didn't want to have a separate commit removing everything just added.


---

Comment by novoselt created at 2015-08-12 22:02:31

Please don't throw away my last commits - they are fixing a real problem that depending on the way how `echelon_form` is called matrix cache may become corrupted! And that the trivial case was just not handled correctly at all.


---

Comment by novoselt created at 2015-08-12 22:05:07

New commits:


---

Comment by novoselt created at 2015-08-12 22:06:35

Figuring out how to revert...
----
New commits:


---

Comment by mjo created at 2015-08-12 22:09:54

Replying to [comment:21 novoselt]:
> Please don't throw away my last commits - they are fixing a real problem that depending on the way how `echelon_form` is called matrix cache may become corrupted! And that the trivial case was just not handled correctly at all.

I know, but it's all unrelated to this ticket, isn't it? I don't want to drop them -- I'm just not qualified to review them at the moment. The first half I've reviewed and tested already, so we could set that to positive_review and then move your remaining commits to another ticket where someone who knows the matrix stuff could look at it.


---

Comment by novoselt created at 2015-08-12 22:16:53

One of the problems why `is_isomorphic` was not working was that `echelon_form` was not working correctly. After my fix of "just the mutability issue" there were 20 errors in toric morphisms because a matrix of rank 2 was now claimed to be of rank 4. Because `echelon_form` was still not working correctly. And as I've finally realized after making all tests pass, the handling of the trivial case was wrong as well apart from mutability. All these things really go together and I'd rather not separate them, but I've ping the sage-devel thread in case someone else is willing to take a look.


---

Comment by vbraun created at 2015-08-13 18:34:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-08-13 20:21:17

Resolution: fixed


---

Comment by novoselt created at 2015-08-14 01:23:12

Thank you Volker!
