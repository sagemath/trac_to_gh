# Issue 22357: bug in cartesian product ?

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-03-13 15:01:41

CC:  tscrim nthiery

Something goes very wrong here:

```
sage: bring=ZZ
sage: for a in cartesian_product([This is the Trac macro *bring.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#bring.one-macro)):
....:     print a[0].parent()
....:     
Integer Ring
sage: bring=QQ
sage: for a in cartesian_product([This is the Trac macro *bring.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#bring.one-macro)):
....:     print a[0].parent()
....:     
Integer Ring
```



---

Comment by hivert created at 2017-03-13 22:21:45

Hi Frederic,

Replying to [ticket:22594 chapoton]:
Actually what goes very wrong is that:

```
cartesian_product([This is the Trac macro *ZZ.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#ZZ.one-macro)) is cartesian_product([This is the Trac macro *QQ.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#QQ.one-macro))
```

Note that if you relaunch a new sage, and ask the computation in the reverse order, you'll get:

```
sage: bring=QQ
sage: for a in cartesian_product([This is the Trac macro *bring.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#bring.one-macro)):
....:     print a[0].parent()
....:     
Rational Field
sage: bring=ZZ
sage: for a in cartesian_product([This is the Trac macro *bring.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#bring.one-macro)):
....:     print a[0].parent()
....:     
Rational Field
```

The main problem is that the construction of the `CartesianProduct` parent object is cached and Sage made the choice that `ZZ.one()` and `QQ.one()` are indistinguishable when put in a hash table. Its the same as 

```
sage: set([ZZ.one(), QQ.one()])
{1}
```

As a workaround, if you only needs the list, don't build the parent. I would then, suggest to use

```
sage: for a in cartesian_product_iterator([This is the Trac macro *ZZ.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#ZZ.one-macro)):
....:     print a[0].parent()
....:
Integer Ring
sage: for a in cartesian_product_iterator([This is the Trac macro *QQ.one* that was inherited from the migration called with arguments ())](https://trac.sagemath.org/wiki/WikiMacros#QQ.one-macro)):
....:     print a[0].parent()
....:     
Rational Field
```


Cheers,

Florent


---

Comment by chapoton created at 2017-03-14 09:17:12

This is a very simplified example. My use case is right in the middle of somthing more complicated. This breaks my program because it triggers the coercion failure in #22591.


---

Comment by tscrim created at 2017-03-14 09:27:34

Changing keywords from "" to "days85".


---

Comment by tscrim created at 2017-03-14 09:27:34

So what I'm thinking of doing is removing `UniqueRepresentation` from `FiniteEnumeratedSet`, which is the precise place where the caching problem is coming from. We might have to have a subclass that does have the `UniqueRepresentation` behavior for places where it is used, but at least the problem stems from instances of `FiniteEnumeratedSet` being used closer to elements than to parents. Florent or I will probably work on this today.


---

Comment by tscrim created at 2017-03-14 09:27:34

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by tscrim created at 2017-03-14 09:27:34

Changing type from PLEASE CHANGE to defect.
