# Issue 15664: doctest failures after moving sage installation

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2014-03-06 16:50:31

CC:  ppurka

Keywords: doctest, git, relocate

I've compiled sage in `/local/data/krenn/sage-dev/sage-6.1.1` and then moved it to another directory. I am getting the following when testing sage:

```
File "src/sage/dev/test/config.py", line 43, in sage.dev.test.config.DoctestConfig
Failed example:
    DoctestConfig()
Expected:
    Config('''
    [trac]
    username = doctest
    ticket_cache = ...
    [UI]
    log_level = 1
    [git]
    ssh_key_set = True
    repository_anonymous = remote_repository_undefined
    repository = remote_repository_undefined
    src = ...
    dot_git = ...
    [sagedev]
    ''')
Got:
    warning: templates not found /local/data/krenn/sage-dev/sage-6.1.1/local/share/git-core/templates
    Config('''
    [trac]
    username = doctest
    ticket_cache = /home/krenn/.sage/temp/brown/8826/dir_0ABZH9/ticket_cache
    [UI]
    log_level = 1
    [git]
    ssh_key_set = True
    repository_anonymous = remote_repository_undefined
    repository = remote_repository_undefined
    src = /home/blub/.sage/temp/brown/8826/dir_0ABZH9/repo
    dot_git = /home/blub/.sage/temp/brown/8826/dir_0ABZH9/repo/.git
    user.name = doctest
    user.email = doc`@`test.test
    user_email_set = True
    [sagedev]
    ''')
```

There are a couple of other files with similar warnings.


---

Comment by dkrenn created at 2014-03-26 16:59:33

FYI: A manual fix is to use

```
rm local/var/lib/sage/installed/git-1.8.4.4
make
```

to rebuild git.


---

Comment by leif created at 2014-04-03 23:38:32

Replying to [comment:1 dkrenn]:
> FYI: A manual fix is to use
> {{{
> rm local/var/lib/sage/installed/git-1.8.4.4
> make
> }}}
> to rebuild git.

Or just

```
./sage -f git
```



---

Comment by jhpalmieri created at 2014-05-02 20:15:51

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2014-05-02 20:15:51

Here's an attempt at a patch. Works for me.
----
New commits:


---

Comment by ppurka created at 2014-05-03 13:19:03

How do you compile sage after this?

```
sage --dev checkout --ticket 15901
sage -btp --long src/sage/dev
```

does not work.

Even the following doesn't work

```
cp {src,local}/bin/sage-env
sage -btp --long src/sage/dev
```



---

Comment by leif created at 2014-05-03 13:25:21

Replying to [comment:5 ppurka]:
> How do you compile sage after this?

You have to touch the `src/sage/dev/[test/]` Python files (or remove their `.pyc` files).

(I _think_.)


---

Comment by leif created at 2014-05-03 13:26:44

Ahem, or maybe something else... 8-)


---

Comment by jhpalmieri created at 2014-05-03 16:37:56

Hmm. I guess I should have said "Worked for me yesterday on one machine." I can't get it to work today on a different machine (and haven't tried on the first one yet).


---

Comment by git created at 2014-05-05 19:09:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2014-05-05 19:11:19

Okay, here's another attempt. Please try this one. (I hope that just `sage -tp src/sage/dev` works. There are no changes to Python files, so `sage -b` should be unnecessary.)


---

Comment by pbruin created at 2014-05-06 23:07:58

This must explain the failures in the first patchbot run of 6.2 (`http://patchbot.sagemath.org/ticket/0/`, 2014-05-06 20:45:32 +0100); I made a fresh Sage install for experimenting with the patchbot, but then decided to move it.  Patchbot is now running in the original location, but I'll try this patch on another copy.


---

Comment by pbruin created at 2014-05-06 23:27:28

The patchbot instance is now getting doctest failures in `sage/plot/plot.py`:

```
RuntimeError: Could not open facefile /home/pbruin/src/sage/local/lib/python2.7/site-packages/matplotlib-1.3.1-py2.7-linux-x86_64.egg/matplotlib/mpl-data/fonts/ttf/Vera.ttf; Cannot_Open_Resource
```

The directory it is looking in is where my _other_ Sage copy was before moving that copy to test this ticket!  The path seems to have been obtained from a cache living in my home directory: `~/.cache/matplotlib/fontList.cache`.  Does this mean that `sage-location` potentially has to worry about hardcoded paths existing in `$DOT_SAGE`?


---

Comment by pbruin created at 2014-05-06 23:38:29

Curiously, sometime after the above failures in `sage/plot`, my patchbot copy of Sage seems to have updated the paths in `~/.cache/matplotlib`.  Anyway, I can confirm that the failures in `sage/dev` are fixed by this patch.


---

Comment by pbruin created at 2014-05-07 19:17:43

Replying to [comment:14 pbruin]:
> I can confirm that the failures in `sage/dev` are fixed by this patch.
... which should be enough for a positive review.  If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.


---

Comment by pbruin created at 2014-05-07 19:17:43

Changing status from needs_review to positive_review.


---

Comment by leif created at 2014-05-07 19:22:28

Replying to [comment:15 pbruin]:
> Replying to [comment:14 pbruin]:
> > I can confirm that the failures in `sage/dev` are fixed by this patch.
> ... which should be enough for a positive review.  If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.

Then we should probably also change the ticket's title accordingly.


---

Comment by leif created at 2014-05-07 19:39:01

Replying to [comment:15 pbruin]:
> If there really is a problem with the `matplotlib` cache, it should be dealt with on a different ticket.

This really deserves its own ticket (and btw. is pretty unrelated to relocating Sage; just imagine having different versions of Sage running at the same time).

IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).


---

Comment by leif created at 2014-05-07 19:42:43

Replying to [comment:17 leif]:
> IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).

... or probably `$SAGE_LOCAL/var/{lib,tmp}/matplotlib/...`


---

Comment by jhpalmieri created at 2014-05-07 19:49:53

Does it need to be writeable? Anyway, it looks like we can modify this by setting the environment variable `XDG_CACHE_HOME`: see the functions `_get_cachedir` and `_get_xdg_cache_dir` in `sage/local/lib/python/site-packages/matplotlib-1.3.1-py2.7-macosx-10.8-x86_64.egg/matplotlib/__init__.py`. I also think this belongs on another ticket.


---

Comment by pbruin created at 2014-05-07 19:51:03

Replying to [comment:17 leif]:
> IMHO Sage's matplotlib must not put its cache into `$HOME` (if at all, it should be in `$DOT_SAGE/.cache/...`), and it should somehow be versioned (with matplotlib's and/or Sage's version in the folder name).
In fact that is where it used to be: I have an old directory `~/.sage/matplotlib-1.2.1/` lying around, containing `fontList.cache` and `tex.cache/`, just like `~/.cache/matplotlib/` looks now.


---

Comment by jhpalmieri created at 2014-05-07 19:56:15

By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.


---

Comment by leif created at 2014-05-07 20:11:04

Replying to [comment:21 jhpalmieri]:
> By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.

Well, setting up MPL's config dir based on its version in `sage-env` in turn can indeed break upon relocation... :-)

(as it calls Python before `sage-location` is called, and the Python interpreter may try to load libraries that have moved, as I already mentioned elsewhere).


---

Comment by leif created at 2014-05-07 20:21:41

Replying to [comment:22 leif]:
> Well, setting up MPL's config dir based on its version in `sage-env` in turn can indeed break upon relocation... :-)
> 
> (as it calls Python before `sage-location` is called, and the Python interpreter may try to load libraries that have moved, as I already mentioned elsewhere).

See for example http://trac.sagemath.org/ticket/16044#comment:7 ff.

(Note that IIRC `sage-location` currently wouldn't help there anyway, as  it doesn't mess with `install_name`s.)


---

Comment by pbruin created at 2014-05-07 20:25:46

Replying to [comment:21 jhpalmieri]:
> By default, Sage's matplotlib should write to `.sage/matplotlib-1.3.1`. Do you have any environment variables set, like `MPLCONFIGDIR`? On my OS X machine, I just checked: `MPLCONFIGDIR` (which Sage sets to `.sage/matplotlib-1.3.1` if it's unset) still gets `fontList.cache` and `tex.cache/` added to it when you call `plot` from Sage. My `$HOME/.cache` directory only contains `fontconfig/`.
On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.  This is despite `logs/pkgs/matplotlib-1.3.1.log saying

```
When Sage runs, MPLCONFIGDIR will be set to '$DOT_SAGE/matplotlib-1.3.1'.
```



---

Comment by leif created at 2014-05-07 20:31:59

Replying to [comment:24 pbruin]:
> On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.

True. B)


```sh
$ ./sage --sh -c 'env | grep MPL'; uname -sm
Linux x86_64
```



---

Comment by pbruin created at 2014-05-07 20:45:30

Replying to [comment:25 leif]:
> Replying to [comment:24 pbruin]:
> > On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.
> 
> True. B)
It turns out that this is because the following command in `sage-env` fails (I removed the `2>/dev/null` at the end:

```
"$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; pkg_resources.get_distribution("matplotlib").version'
Traceback (most recent call last):
  File "<string>", line 1, in <module>
zipimport.ZipImportError: can't decompress data; zlib not available
```



---

Comment by leif created at 2014-05-07 20:53:54

Replying to [comment:26 pbruin]:
> Replying to [comment:25 leif]:
> > Replying to [comment:24 pbruin]:
> > > On GNU/Linux x86_64, I don't seem to have any environment variables with names containing "MPL", neither in the normal shell nor in `sage -sh`.
> > 
> > True. B)
> It turns out that this is because the following command in `sage-env` fails (I removed the `2>/dev/null` at the end:
> {{{
> "$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; pkg_resources.get_distribution("matplotlib").version'
> Traceback (most recent call last):
>   File "<string>", line 1, in <module>
> zipimport.ZipImportError: can't decompress data; zlib not available
> }}}

I'm getting

```
.../local/bin/python: error while loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory
```


So apparently `LD_LIBRARY_PATH` isn't set up properly to that time.


---

Comment by pbruin created at 2014-05-07 20:57:19

The problem in comment:26 was on 6.2.rc0; with 6.2 on a different system I get

```
Traceback (most recent call last):
...
ImportError: cannot import name MAXREPEAT
```

I guess the `MPLCONFIGDIR`-relevant part of `sage-env` should be moved down to a point where all required setting up has been done.


---

Comment by leif created at 2014-05-07 20:57:59

Oh, just noticed:

```sh
# Use a matplotlib config directory specific to Sage and specific to
# the version number of matplotlib, by setting the environment
# variable MPLCONFIGDIR. Note that we can't find the version number by
# importing matplotlib, because that could create matplotlib's standard
# config directory. So we use pkg_resources.
"$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; pkg_resources.get_distribution("matplotlib").version' 2>/dev/null
if [ $? -eq 0 ]; then
    MPLVERSION=`"$SAGE_ROOT/local/bin/python" -c 'import pkg_resources; print pkg_resources.get_distribution("matplotlib").version'`
    MPLCONFIGDIR="$DOT_SAGE/matplotlib-$MPLVERSION"
    export MPLCONFIGDIR
    # The directory is created when Sage starts (see sage.misc.misc).
fi

# Add some directories to $LD_LIBRARY_PATH:
# * lib/openmpi is needed for openmpi.
# * lib/R/lib is needed for R in case the Sage install is moved.
# * lib32 and lib64 are needed for GCC, see #12405.
for d in lib/openmpi lib/R/lib lib32 lib64 lib; do
    libdir="$SAGE_LOCAL/$d"
    # Add only existing directories
    if [ -d "$libdir" ]; then
        [ -z "$LD_LIBRARY_PATH" ] || LD_LIBRARY_PATH=":${LD_LIBRARY_PATH}"
        LD_LIBRARY_PATH="${libdir}$LD_LIBRARY_PATH"
    fi
done
export LD_LIBRARY_PATH
```


`>8-O`


---

Comment by leif created at 2014-05-07 21:00:09

(I meant to say it's done right _after_ we try to call `python`; I've slightly edited the snippet.)


---

Comment by pbruin created at 2014-05-07 21:04:53

I created #16305 for this.


---

Comment by vbraun created at 2014-05-08 11:50:47

Resolution: fixed
