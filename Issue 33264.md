# Issue 33264: Getting rid of sqrt in spherical harmonics

Issue created by migration from https://trac.sagemath.org/ticket/33501

Original creator: egourgoulhon

Original creation time: 2022-03-14 19:48:25

CC:  slelievre @mjungmath tscrim

Keywords: spherical harmonics

After #33117, Sage's spherical harmonics agree with those of SymPy, SciPy, Mathematica and Wikipedia. But for odd order m, they contain `sqrt(sin(theta)^2)` terms, which should be simplified to `sin(theta)`, given that the colatitude angle `theta` lies in [0,pi] and hence fulfills `sin(theta)>=0`.
For instance, in Sage 9.6.beta5, we have

```
sage: theta, phi = var('theta phi')
sage: spherical_harmonic(1, 1, theta, phi)
-1/4*sqrt(3)*sqrt(2)*sqrt(sin(theta)^2)*e^(I*phi)/sqrt(pi)
```

whereas SymPy version has `sin(theta)` instead of `sqrt(sin(theta)^2)`:

```
sage: from sympy import Ynm
sage: Ynm(1, 1, theta, phi).expand(func=True) 
-sqrt(6)*exp(I*phi)*sin(theta)/(4*sqrt(pi))
```




---

Comment by egourgoulhon created at 2022-03-15 09:40:32

Here is the fix. Note that I have added some doctests to `_evalf_`, which, strickly speaking, do not pertain to the current ticket. Actually they should have been implemented in the preceding ticket, #33117, for they check the consistency between `_eval_` (implementing the new formulas with the Condon-Shortley phase) and `_evalf_` (where spherical harmonics are evaluated via `mpmath`).
----
New commits:


---

Comment by egourgoulhon created at 2022-03-15 09:40:32

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-03-15 18:55:50

LGTM


---

Comment by mkoeppe created at 2022-03-15 18:55:50

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2022-03-15 19:56:42

missing double colons at the end of line here:


```
+        Check that :trac:`33501` is fixed:
```



---

Comment by chapoton created at 2022-03-15 19:56:42

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-03-15 20:08:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-03-15 20:10:07

Replying to [comment:3 chapoton]:
> missing double colons at the end of line here:
> 
Thank you! Fixed in the above commit.


---

Comment by egourgoulhon created at 2022-03-15 20:10:07

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2022-03-15 21:03:49

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2022-03-16 08:14:25

Optionally one could condense the consistency tests as follows:

```diff
-            sage: sharm = spherical_harmonic
-            sage: abs(sharm(0, 0, 1., 2.) - sharm(0, 0, 1, 2).n())  # abs tol 1e-14
-            1.66533453693773e-16
-            sage: abs(sharm(1, -1, 1., 2.) - sharm(1, -1, 1, 2).n())  # abs tol 1e-14
-            5.72195849815280e-17
-            sage: abs(sharm(1, 0, 1., 2.) - sharm(1, 0, 1, 2).n())  # abs tol 1e-14
-            1.66533453693773e-16
-            sage: abs(sharm(1, 1, 1., 2.) - sharm(1, 1, 1, 2).n())  # abs tol 1e-14
-            5.72195849815280e-17
-            sage: abs(sharm(3, 2, 1., 2.) - sharm(3, 2, 1, 2).n())  # abs tol 1e-14
-            0.000000000000000
-            sage: abs(sharm(3, 3, 1., 2.) - sharm(3, 3, 1, 2).n())  # abs tol 1e-14
-            3.10316769155909e-17
+            sage: s = spherical_harmonic
+            sage: d = lambda a, b: abs(s(a, b, 1., 2.) - s(a, b, 1, 2).n())
+            sage: ab = [(0, 0), (1, -1), (1, 0), (1, 1), (3, 2), (3, 3)]
+            sage: all(d(a, b) < 1e-14 for a, b in ab)
+            True
```

It's also fine as is, of course.


---

Comment by git created at 2022-03-16 09:28:57

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-03-16 09:28:57

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by egourgoulhon created at 2022-03-16 09:29:58

Replying to [comment:7 slelievre]:
> Optionally one could condense the consistency tests as follows:

Much shorter indeed. Done in the latest commit.


---

Comment by slelievre created at 2022-03-16 10:01:41

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2022-03-16 10:30:06

Thank you all for the review!


---

Comment by vbraun created at 2022-03-27 15:43:48

Resolution: fixed
