# Issue 29785: sage.rings.integer, rational: Remove compile-time dependency on cypari2 and flint

archive/issues_029785.json:
```json
{
    "body": "CC:  vdelecroix @kliem tscrim\n\nFunctions such as `set_from_pari_gen` should probably be moved to `sage.libs.pari`.\n\nThe compile-time dependency on `sage.libs.flint.ulong_extras` is for the use of `n_factor`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30022\n\n",
    "created_at": "2020-06-29T18:36:30Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "title": "sage.rings.integer, rational: Remove compile-time dependency on cypari2 and flint",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29785",
    "user": "mkoeppe"
}
```
CC:  vdelecroix @kliem tscrim

Functions such as `set_from_pari_gen` should probably be moved to `sage.libs.pari`.

The compile-time dependency on `sage.libs.flint.ulong_extras` is for the use of `n_factor`.

Issue created by migration from https://trac.sagemath.org/ticket/30022





---

archive/issue_comments_423115.json:
```json
{
    "body": "Moving `set_from_pari_gen` in `sage.libs.pari` would make `cypari2` depends on `sage`. Wouldn't it?",
    "created_at": "2020-07-27T14:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423115",
    "user": "vdelecroix"
}
```

Moving `set_from_pari_gen` in `sage.libs.pari` would make `cypari2` depends on `sage`. Wouldn't it?



---

archive/issue_comments_423116.json:
```json
{
    "body": "`sage.libs.pari.convert_sage` already depends on sage (and on `cypari2`).",
    "created_at": "2020-07-27T15:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423116",
    "user": "mkoeppe"
}
```

`sage.libs.pari.convert_sage` already depends on sage (and on `cypari2`).



---

archive/issue_comments_423117.json:
```json
{
    "body": "I misunderstood the ticket description... I thought you wanted to move that to `cypari2`. Sorry.\n\nIt indeed makes sense to have it in `sage.libs` where all the low-level interfaces actually are.",
    "created_at": "2020-07-27T16:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423117",
    "user": "vdelecroix"
}
```

I misunderstood the ticket description... I thought you wanted to move that to `cypari2`. Sorry.

It indeed makes sense to have it in `sage.libs` where all the low-level interfaces actually are.



---

archive/issue_comments_423118.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423118",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_423119.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-08-28T06:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423119",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_423120.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-08-28T09:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423120",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_423121.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-28T09:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423121",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423122.json:
```json
{
    "body": "Thanks a lot for working on this!",
    "created_at": "2021-08-28T16:42:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423122",
    "user": "mkoeppe"
}
```

Thanks a lot for working on this!



---

archive/issue_comments_423123.json:
```json
{
    "body": "\n```\n+            try:\n+                from sage.libs.flint.ulong_extras import n_factor_to_list\n+                if proof is None:\n+                    from sage.structure.proof.proof import get_flag\n+                    proof = get_flag(proof, \"arithmetic\")\n+                F = n_factor_to_list(mpz_get_ui(n.value), proof)\n+                F = [(smallInteger(a), smallInteger(b)) for a, b in F]\n+                F.sort()\n+                return IntegerFactorization(F, unit=unit, unsafe=True,\n+                                               sort=False, simplify=False)\n+            except ImportError:\n+                pass\n```\n\nI think it's better to use `try: except: else` here, only wrapping the actual import in `try-`except`",
    "created_at": "2021-08-28T16:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423123",
    "user": "mkoeppe"
}
```


```
+            try:
+                from sage.libs.flint.ulong_extras import n_factor_to_list
+                if proof is None:
+                    from sage.structure.proof.proof import get_flag
+                    proof = get_flag(proof, "arithmetic")
+                F = n_factor_to_list(mpz_get_ui(n.value), proof)
+                F = [(smallInteger(a), smallInteger(b)) for a, b in F]
+                F.sort()
+                return IntegerFactorization(F, unit=unit, unsafe=True,
+                                               sort=False, simplify=False)
+            except ImportError:
+                pass
```

I think it's better to use `try: except: else` here, only wrapping the actual import in `try-`except`



---

archive/issue_comments_423124.json:
```json
{
    "body": "The next module that will need similar work is `sage.rings.fast_arith`",
    "created_at": "2021-08-28T19:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423124",
    "user": "mkoeppe"
}
```

The next module that will need similar work is `sage.rings.fast_arith`



---

archive/issue_comments_423125.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-28T19:13:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423125",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423126.json:
```json
{
    "body": "Also `sage.matrix.args` has the `cypari2` compile-time dep",
    "created_at": "2021-08-28T19:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423126",
    "user": "mkoeppe"
}
```

Also `sage.matrix.args` has the `cypari2` compile-time dep



---

archive/issue_comments_423127.json:
```json
{
    "body": "patchbot indicates docbuild failure\n\n```\n[dochtml] cd /home/sagemath/sage-9.1 && ./sage --docbuild --no-pdf-links reference/matrices inventory --no-prune-empty-dirs\n[dochtml] [libs     ] docstring of sage.libs.pari.convert_sage.pari_divisors_small:3: WARNING: Content block expected for the \"SEEALSO\" directive; none found.\n[dochtml] [libs     ] The inventory files are in local/share/doc/sage/inventory/en/reference/libs.\n[dochtml] Error building the documentation.\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/usr/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\n[dochtml]     \"__main__\", mod_spec)\n[dochtml]   File \"/usr/lib/python3.7/runpy.py\", line 85, in _run_code\n[dochtml]     exec(code, run_globals)\n[dochtml]   File \"/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n[dochtml]     main()\n[dochtml]   File \"/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py\", line 1813, in main\n[dochtml]     builder()\n[dochtml]   File \"/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py\", line 821, in _wrapper\n[dochtml]     getattr(DocBuilder, build_type)(self, *args, **kwds)\n[dochtml]   File \"/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py\", line 133, in f\n[dochtml]     runsphinx()\n[dochtml]   File \"/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/sphinxbuild.py\", line 323, in runsphinx\n[dochtml]     sys.stderr.raise_errors()\n[dochtml]   File \"/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/sphinxbuild.py\", line 258, in raise_errors\n[dochtml]     raise OSError(self._error)\n[dochtml] OSError: docstring of sage.libs.pari.convert_sage.pari_divisors_small:3: WARNING: Content block expected for the \"SEEALSO\" directive; none found.\n[dochtml] \n```\n",
    "created_at": "2021-08-29T21:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423127",
    "user": "mkoeppe"
}
```

patchbot indicates docbuild failure

```
[dochtml] cd /home/sagemath/sage-9.1 && ./sage --docbuild --no-pdf-links reference/matrices inventory --no-prune-empty-dirs
[dochtml] [libs     ] docstring of sage.libs.pari.convert_sage.pari_divisors_small:3: WARNING: Content block expected for the "SEEALSO" directive; none found.
[dochtml] [libs     ] The inventory files are in local/share/doc/sage/inventory/en/reference/libs.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
[dochtml]     "__main__", mod_spec)
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py", line 1813, in main
[dochtml]     builder()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py", line 821, in _wrapper
[dochtml]     getattr(DocBuilder, build_type)(self, *args, **kwds)
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py", line 133, in f
[dochtml]     runsphinx()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
[dochtml]     sys.stderr.raise_errors()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
[dochtml]     raise OSError(self._error)
[dochtml] OSError: docstring of sage.libs.pari.convert_sage.pari_divisors_small:3: WARNING: Content block expected for the "SEEALSO" directive; none found.
[dochtml] 
```




---

archive/issue_comments_423128.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-30T05:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423128",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_423129.json:
```json
{
    "body": "LGTM, let's get this in.",
    "created_at": "2021-08-31T19:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423129",
    "user": "mkoeppe"
}
```

LGTM, let's get this in.



---

archive/issue_comments_423130.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-31T19:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423130",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423131.json:
```json
{
    "body": "Follow-up in #32441",
    "created_at": "2021-08-31T19:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423131",
    "user": "mkoeppe"
}
```

Follow-up in #32441



---

archive/issue_comments_423132.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-01T20:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29785",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29785#issuecomment-423132",
    "user": "vbraun"
}
```

Resolution: fixed
