# Issue 29785: sage.rings.integer, rational: Remove compile-time dependency on cypari2 and flint

Issue created by migration from https://trac.sagemath.org/ticket/30022

Original creator: mkoeppe

Original creation time: 2020-06-29 18:36:30

CC:  vdelecroix @kliem tscrim

Functions such as `set_from_pari_gen` should probably be moved to `sage.libs.pari`.

The compile-time dependency on `sage.libs.flint.ulong_extras` is for the use of `n_factor`.


---

Comment by vdelecroix created at 2020-07-27 14:54:33

Moving `set_from_pari_gen` in `sage.libs.pari` would make `cypari2` depends on `sage`. Wouldn't it?


---

Comment by mkoeppe created at 2020-07-27 15:56:28

`sage.libs.pari.convert_sage` already depends on sage (and on `cypari2`).


---

Comment by vdelecroix created at 2020-07-27 16:05:28

I misunderstood the ticket description... I thought you wanted to move that to `cypari2`. Sorry.

It indeed makes sense to have it in `sage.libs` where all the low-level interfaces actually are.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-08-28 06:51:48

New commits:


---

Comment by @kliem created at 2021-08-28 09:39:35

New commits:


---

Comment by @kliem created at 2021-08-28 09:39:35

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-08-28 16:42:57

Thanks a lot for working on this!


---

Comment by mkoeppe created at 2021-08-28 16:44:08


```
+            try:
+                from sage.libs.flint.ulong_extras import n_factor_to_list
+                if proof is None:
+                    from sage.structure.proof.proof import get_flag
+                    proof = get_flag(proof, "arithmetic")
+                F = n_factor_to_list(mpz_get_ui(n.value), proof)
+                F = [(smallInteger(a), smallInteger(b)) for a, b in F]
+                F.sort()
+                return IntegerFactorization(F, unit=unit, unsafe=True,
+                                               sort=False, simplify=False)
+            except ImportError:
+                pass
```

I think it's better to use `try: except: else` here, only wrapping the actual import in `try-`except`


---

Comment by mkoeppe created at 2021-08-28 19:04:11

The next module that will need similar work is `sage.rings.fast_arith`


---

Comment by git created at 2021-08-28 19:13:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-28 19:33:30

Also `sage.matrix.args` has the `cypari2` compile-time dep


---

Comment by mkoeppe created at 2021-08-29 21:52:52

patchbot indicates docbuild failure

```
[dochtml] cd /home/sagemath/sage-9.1 && ./sage --docbuild --no-pdf-links reference/matrices inventory --no-prune-empty-dirs
[dochtml] [libs     ] docstring of sage.libs.pari.convert_sage.pari_divisors_small:3: WARNING: Content block expected for the "SEEALSO" directive; none found.
[dochtml] [libs     ] The inventory files are in local/share/doc/sage/inventory/en/reference/libs.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
[dochtml]     "__main__", mod_spec)
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py", line 1813, in main
[dochtml]     builder()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py", line 821, in _wrapper
[dochtml]     getattr(DocBuilder, build_type)(self, *args, **kwds)
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/__init__.py", line 133, in f
[dochtml]     runsphinx()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
[dochtml]     sys.stderr.raise_errors()
[dochtml]   File "/home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
[dochtml]     raise OSError(self._error)
[dochtml] OSError: docstring of sage.libs.pari.convert_sage.pari_divisors_small:3: WARNING: Content block expected for the "SEEALSO" directive; none found.
[dochtml] 
```



---

Comment by git created at 2021-08-30 05:42:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-31 19:27:23

LGTM, let's get this in.


---

Comment by mkoeppe created at 2021-08-31 19:27:23

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-08-31 19:30:49

Follow-up in #32441


---

Comment by vbraun created at 2021-09-01 20:55:18

Resolution: fixed
