# Issue 15357: use autotools for csage

Issue created by migration from https://trac.sagemath.org/ticket/15594

Original creator: ohanar

Original creation time: 2013-12-26 23:21:25

CC:  jdemeyer vbraun fbissey




---

Comment by ohanar created at 2013-12-26 23:29:00

Mainly threw this together to test python3 compatibility (since scons is not yet python3 compatible). I personally prefer autotools over scons, so I think it would be good to finish this, although I'm not sure what the best way to integrate it into the build system would be.


---

Comment by git created at 2013-12-26 23:32:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2013-12-26 23:45:47

Sounds good to me. I guess that would make polybori the only scons user (but C++ only)


---

Comment by jdemeyer created at 2013-12-27 09:59:04

One important question is the following: are you going to track the autotools-generated files with git? If yes, that will enlarge the git repo by a significant amount. If no, you will require Sage _developers_ to have _autotools_ installed.


---

Comment by ohanar created at 2013-12-28 09:22:03

Replying to [comment:4 jdemeyer]:
> One important question is the following: are you going to track the autotools-generated files with git?

No.

> If yes, that will enlarge the git repo by a significant amount. If no, you will require Sage _developers_ to have _autotools_ installed.

The source distribution will obviously have the autotools-generated output, but for those who are directly cloning the sage repository, they would need autotools (as is standard for most projects), or we would need to make autotools a standardish package (akin to gcc).

Integrating the prereq package runs into the same issue.


---

Comment by jdemeyer created at 2014-02-04 16:11:06

Working on this.


---

Comment by jdemeyer created at 2014-02-04 22:33:22

It probably needs further testing, but this version should work.
----
New commits:


---

Comment by git created at 2014-02-05 09:09:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-02-05 10:03:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-02-05 11:05:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-02-05 12:10:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-02-05 12:23:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-02-05 12:31:14

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-02-08 19:59:35

Despite what the plugin says, it merges cleanly for me...


---

Comment by vbraun created at 2014-02-08 21:50:42

Andrew: can you review this?


---

Comment by ohanar created at 2014-02-08 23:05:29

Replying to [comment:17 jdemeyer]:
> Despite what the plugin says, it merges cleanly for me...
Yes, I've been meaning to change that error message...

Replying to [comment:18 vbraun]:
> Andrew: can you review this?
Sure.


---

Comment by ohanar created at 2014-02-09 01:31:36

Mostly looks fine. I just added a commit to reflect that on OS X the libtoolize binary is almost aways renamed to glibtoolize (so as not to conflict with OS X's libtool).
----
New commits:


---

Comment by ohanar created at 2014-02-09 01:31:59

Changing status from needs_review to positive_review.


---

Comment by git created at 2014-02-09 11:48:24

Changing status from positive_review to needs_review.


---

Comment by git created at 2014-02-09 11:48:24

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by vbraun created at 2014-02-09 12:17:35

Doesn't work if you don't have autotools installed, e.g.: http://build.sagemath.org/sage/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.9%20x86_64%29%20incremental/builds/28/steps/compile/logs/stdio


---

Comment by jdemeyer created at 2014-02-10 09:14:30

New commits:


---

Comment by ohanar created at 2014-02-14 03:13:44

Changing status from needs_review to positive_review.


---

Comment by git created at 2014-02-21 16:04:15

Changing status from positive_review to needs_review.


---

Comment by git created at 2014-02-21 16:04:15

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-02-21 16:04:37

Since this keeps conflicting, I squashed the whole branch.
----
New commits:


---

Comment by jdemeyer created at 2014-02-21 16:06:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-03-02 16:51:26

Fails on snapperkob with

```
./bootstrap -d
make[1]: Entering directory `/home/buildbot/build/sage/snapperkob/sage_git/build'
rm -rf config configure build/Makefile-auto.in
cd src/c_lib && rm -f config.h.in* configure Makefile.in src/Makefile.in include/Makefile.in
make[1]: Leaving directory `/home/buildbot/build/sage/snapperkob/sage_git/build'
configure.ac:61: installing `config/config.guess'
configure.ac:61: installing `config/config.sub'
configure.ac:30: installing `config/install-sh'
configure.ac:30: installing `config/missing'
libtoolize: putting auxiliary files in AC_CONFIG_AUX_DIR, `../../config'.
libtoolize: copying file `../../config/ltmain.sh'
libtoolize: putting macros in AC_CONFIG_MACRO_DIR, `../../m4'.
libtoolize: copying file `../../m4/libtool.m4'
libtoolize: copying file `../../m4/ltoptions.m4'
libtoolize: copying file `../../m4/ltsugar.m4'
libtoolize: copying file `../../m4/ltversion.m4'
libtoolize: copying file `../../m4/lt~obsolete.m4'
configure.ac:8: require Automake 1.13, but have 1.11.3
make: *** [src/c_lib/configure] Error 1
make: Target `start' not remade because of errors.
program finished with exit code 2
```

and on eno

```
./bootstrap -d
make[1]: Entering directory `/home/buildbot/build/sage/eno-1/sage_git/build'
rm -rf config configure build/Makefile-auto.in
cd src/c_lib && rm -f config.h.in* configure Makefile.in src/Makefile.in include/Makefile.in
make[1]: Leaving directory `/home/buildbot/build/sage/eno-1/sage_git/build'
configure.ac:61: installing `config/config.guess'
configure.ac:61: installing `config/config.sub'
configure.ac:30: installing `config/install-sh'
configure.ac:30: installing `config/missing'
libtoolize: putting auxiliary files in AC_CONFIG_AUX_DIR, `../../config'.
libtoolize: copying file `../../config/ltmain.sh'
libtoolize: putting macros in AC_CONFIG_MACRO_DIR, `../../m4'.
libtoolize: copying file `../../m4/libtool.m4'
libtoolize: copying file `../../m4/ltoptions.m4'
libtoolize: copying file `../../m4/ltsugar.m4'
libtoolize: copying file `../../m4/ltversion.m4'
libtoolize: copying file `../../m4/lt~obsolete.m4'
configure.ac:22: warning: macro `AM_PROG_AR' not found in library
configure.ac:8: require Automake 1.13, but have 1.11.1
make: *** [src/c_lib/configure] Error 1
make: Target `start' not remade because of errors.
program finished with exit code 2
```

The confball version is 13.


---

Comment by git created at 2014-03-03 21:39:25

Changing status from positive_review to needs_review.


---

Comment by git created at 2014-03-03 21:39:25

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by jdemeyer created at 2014-03-04 09:23:12

Volker, can you please test this on the buildbots again?


---

Comment by vbraun created at 2014-03-07 11:37:20

Still doesn't work on most machines, though it fails later on in csage. E.g. on mod:

```
make[3]: Entering directory `/mnt/SSD1/mod_buildslave/sage_git/build/src/c_lib'
make[3]: warning: -jN forced in submake: disabling jobserver mode.
CDPATH="${ZSH_VERSION+.}:" && cd . && /bin/bash /mnt/SSD1/mod_buildslave/sage_git/build/config/missing aclocal-1.13 -I ../../m4
/mnt/SSD1/mod_buildslave/sage_git/build/config/missing: line 81: aclocal-1.13: command not found
WARNING: 'aclocal-1.13' is missing on your system.
         You should only need it if you modified 'acinclude.m4' or
         'configure.ac' or m4 files included by 'configure.ac'.
         The 'aclocal' program is part of the GNU Automake package:
         <http://www.gnu.org/software/automake>
         It also requires GNU Autoconf, GNU m4 and Perl in order to run:
         <http://www.gnu.org/software/autoconf>
         <http://www.gnu.org/software/m4/>
         <http://www.perl.org/>
make[3]: *** [aclocal.m4] Error 127
```

This was with configure-15.tar.gz


---

Comment by ohanar created at 2014-03-07 22:39:47

I think this could probably be resolved by disabling maintainer mode either in csage's configure.ac or in deps. Doing this with the top level configure script as well would make it so that we don't have to use tar with the m argument (I believe, haven't actually tested).


---

Comment by ohanar created at 2014-03-07 22:46:38

This has my proposed fix. It works for me when I remove autotools from my path.
----
New commits:


---

Comment by ohanar created at 2014-03-07 22:52:20

For reference, it looks like maintainer mode was disabled for the top level configure in [a38f919](http://git.sagemath.org/sage.git/commit/?id=a38f91911ace2a7dcd0cc49e77c31c3a25e0889d), but it never got re-disabled when it was merged into #15606.


---

Comment by vbraun created at 2014-03-08 00:00:33

Jeroen didn't like it back then... Really I don't want to disable it on *my* machine since I do have a working autotools install. In an ideal world we'd only disable maintainer mode if we had to download the confball. Not sure how to implement that, it seems like we would need some file whose existence acts as a flag. Though its probably not too much of a loss.


---

Comment by leif created at 2014-05-18 08:32:13

Cool.  How do we get the PolyBoRi guys to drop SCons? :P


---

Comment by fbissey created at 2014-05-18 11:07:08

Replying to [comment:43 leif]:
> Cool.  How do we get the PolyBoRi guys to drop SCons? :P

Wish I knew. It also hasn't been very active lately. While Alexander Drier wasn't the only active dev his departure seems to have left a big void. He was also the one who was fixing most of the problem we reported from sage-on-gentoo. If I had more free time I'd attempt a conversion to autotools myself.


---

Comment by fbissey created at 2014-05-18 11:20:22

I'd like to request one small change. Jean-Pierre Flori helped to make sure we could build against gmp instead of mpir at #12661.

```
libcsage_la_LIBADD = -lntl -lpari -lmpir $(PYTHON_LDFLAGS)
```

will just revert it completely to where we were before (but for different reasons). Can we replace -lmpir with -lgmp in that line please.


---

Comment by git created at 2014-05-21 23:20:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2014-05-22 01:50:36

Thanks! One more thing I just spotted:

```
diff --git a/src/c_lib/Makefile.am b/src/c_lib/Makefile.am
new file mode 100644
index 0000000..e91cd48
--- /dev/null
+++ b/src/c_lib/Makefile.am
@@ -0,0 +1,6 @@
+SUBDIRS = src include
+
+ACLOCAL_AMFLAGS = -I ../../m4
+
+clean-local:
+	rm -f .sconsign.dblite
```

.sconsign.dblite is a file generated by scons, now that we are ditching it, it shouldn't be present. I am guessing you are trying to cover the upgrade path. Is it necessary for us to provide this target. Furthermore, I do not see when it is called. So we have a target to clean some old scons rubbish but it doesn't look like it is run automatically. If it was always run I could see some value but if it is voluntary people may just as well use rm.


---

Comment by leif created at 2014-05-22 09:13:21

Replying to [comment:47 fbissey]:
> Thanks! One more thing I just spotted:
> {{{
> diff --git a/src/c_lib/Makefile.am b/src/c_lib/Makefile.am
> new file mode 100644
> index 0000000..e91cd48
> --- /dev/null
> +++ b/src/c_lib/Makefile.am
> `@``@` -0,0 +1,6 `@``@`
> +SUBDIRS = src include
> +
> +ACLOCAL_AMFLAGS = -I ../../m4
> +
> +clean-local:
> +	rm -f .sconsign.dblite
> }}}
> If it was always run I could see some value but if it is voluntary people may just as well use rm.

Well, it's a _hidden_ file... ;-)

(And we could run `make clean-local` from a script.)


---

Comment by fbissey created at 2014-05-22 09:31:22

We could, and in fact I looked to see if it was done within this ticket before writing.


---

Comment by leif created at 2014-05-22 09:44:09

In contrast to me, as I was assuming you did already.  So I was right.


---

Comment by jdemeyer created at 2014-12-11 09:21:24

Alternative: #17484


---

Comment by jdemeyer created at 2014-12-11 20:30:55

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-12-11 20:30:55

Close as wontfix...


---

Comment by vbraun created at 2014-12-11 20:31:38

Resolution: wontfix
