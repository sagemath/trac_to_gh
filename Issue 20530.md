# Issue 20530: Move coercion down to Element

Issue created by migration from https://trac.sagemath.org/ticket/20767

Original creator: jdemeyer

Original creation time: 2016-06-03 09:30:32

CC:  nthiery vdelecroix simonking

Move all coercion logic from `RingElement`, `ModuleElement` and the like down to `Element`.


---

Comment by jdemeyer created at 2016-07-26 09:38:09

New commits:


---

Comment by git created at 2016-07-26 13:37:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-07-26 15:07:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-07-27 15:38:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-07-29 13:27:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-07-29 13:34:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-01 09:30:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-01 15:51:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-01 17:37:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-01 21:23:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-01 21:35:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-02 14:39:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-02 15:38:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-02 21:41:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-03 10:52:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-03 13:57:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-08-03 13:59:34

Changing status from new to needs_review.


---

Comment by git created at 2016-08-03 14:02:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by SimonKing created at 2016-08-05 19:52:48

It would be interesting (to me) to see whether the coerce action business of #18756 can be used here as well.


---

Comment by SimonKing created at 2016-08-05 19:55:06

... and of #18758


---

Comment by jdemeyer created at 2016-08-05 20:20:00

Well, this ticket deals with the "other side" of the coercion framework: it changes how the coercion model is called, not how the coercion model implements arithmetic. It seems like the other tickets do the opposite. So the tickets look related but also quite independent.


---

Comment by jj created at 2016-08-06 11:25:18

Hi

Just as a reminder: There are situation where we need ring element operations in a parent resp. for an element which is not really considered a ring element.

Example:
- Take a graded ring.
- Take two elements from different weight-components.
- Note that the elements by themself are considered elements of vector spaces
  (which is what we want because we probably want to do operations that only make sense for the vector space, etc).
- However we still want to be able to "add" _and_ "multiply" such elements.
  - Add would result in a ring element (unless the components are the same).
  - Multiply would result in a vector in a higher weight-component.

I had to deal with this when I implemented the graded rings of modular forms.
See src/sage/modular/modform_hecketriangle/element.py for more details.
There I solved it as follows:
I derived the element from FormsRingElement (so it has the multiply methods) but the parent is still just a vector space. I also made sure that arithmetic operations with elements end up in the correct space.

Will this still work with this ticket?
Can you check the tests for this maybe?

Side note: At the moment I don't really have time to actively develop, so I can't really promise much help.


Best
Jonas


---

Comment by jdemeyer created at 2016-08-06 12:15:12

This ticket should not cause many functional differences for existing code, except for the fact that double-underscore methods can no longer be implemented in categories and some other minor things, like using `parent.one()` instead of `1`.

All doctests in Sage pass with this ticket (see for example the patchbot), so the code that you refer to should still work too.


---

Comment by jdemeyer created at 2016-08-29 05:38:10

Doctest failures with 7.4.beta2.


---

Comment by jdemeyer created at 2016-08-29 05:38:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-30 10:31:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-08-30 10:32:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-09-07 12:00:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-07 12:10:00

Nicolas, I took care of your comments. If you are missing something, feel free to notify me or to make the change yourself.


---

Comment by nthiery created at 2016-09-07 16:20:55

I read your new documentation; that's a very nice addition to the Sage documentation. I have done some changes here and there, and added a draft of explanation of the `cdef _add_` trick. Please proofread. The `_add_long` and `_mul_long` protocols need to be documented and tested in element.pyx; see the TODO there.

Other than this, I believe this is good to go. Thanks a lot Jeroen!
----
New commits:


---

Comment by git created at 2016-09-08 09:55:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-08 09:55:59

Done, needs review.


---

Comment by nthiery created at 2016-09-08 14:12:32

Thanks; I checked your commits and am happy with them.

Two small questions:
- The documentation currently seems to suggest that it's only possible to implement `_add_long` and `_mul_long` within a Cython class. Is that right? Of course, in a Python class it's probably rarely relevant to implement `_add_long`, but if this works there is no reason to hide it in the doc.

- ``Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right? Or is it because with cdef, a Python level call to `x._add_(y)` would fail?

Once you have made up your mind on the above, you can set a positive review on my behalf (assuming of course all tests keep passing).

Thanks!

Cheers,
                       Nicolas


---

Comment by jdemeyer created at 2016-09-08 14:21:50

Replying to [comment:53 nthiery]:
> - The documentation currently seems to suggest that it's only possible to implement `_add_long` and `_mul_long` within a Cython class. Is that right?

Yes, it's a `cdef` method, so it's Cython-only. Since it is only an optimization, it makes little sense to allow it to be a Python method. If you care about performance, you should be using Cython anyway.

> - ``Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right?
> Or is it because with cdef, a Python level call to `x._add_(y)` would fail?

It would work for `x + y` yes. But I think it is expected that `x._add_(y)` also works. Anyway, that is how things were historically.

Maybe one could argue that `x._add_(y)` should not be required to work from Python. But let's not change that in this ticket.


---

Comment by jdemeyer created at 2016-09-08 14:21:50

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-09-09 07:28:16

This ticket is suffering also from #21441 (see patchbot)


---

Comment by jdemeyer created at 2016-09-09 07:42:20

Replying to [comment:53 nthiery]:
> - Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right? Or is it because with cdef, a Python level call to `x._add_(y)` would fail?

A more complete answer: yes, they really should be `cpdef` or `def` methods because you want to allow Python subclasses to override them. A `cdef` method is Cython-only and cannot be overridden by a Python method. Of course, `Element._add_` is `cdef` but it "manually" checks for a Python `_add_` method.


---

Comment by nthiery created at 2016-09-09 07:47:47

Ah, yes, That's a good point indeed. Thanks!


---

Comment by vbraun created at 2016-10-03 22:41:54

Resolution: fixed
