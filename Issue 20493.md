# Issue 20493: Break up sage_setup.autogen.interpreters into a package

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-05-31 10:42:55

`sage_setup.autogen.interpreters` was getting a bit long (over 4000 lines) and it was hard to understand how some of it was organized.  So I split it up into several logical modules.  This seemed to have [some support](https://groups.google.com/d/msg/sage-devel/RB4-A-p5pRI/0T8ZtGpzCwAJ).

How exactly I chose to break it up is certainly up for debate, but I thought this was fairly logical to start.  In the `__init__.py` I still import all from all submodules so that the API for the `sage_setup.autogen.interpreters` module is unchanged.

I would like to get some version of this accepted soon, as I have a few tasks to work on in this module and it would be easier (though not necessary) to work on it on top of this change.


---

Comment by jdemeyer created at 2016-05-31 10:57:11

I suggest to add `from __future__ import absolute_import, print_function` to all those modules.


---

Comment by embray created at 2016-05-31 12:51:44

Replying to [comment:1 jdemeyer]:
> I suggest to add `from __future__ import absolute_import, print_function` to all those modules.

Funny, I actually did that at first but then took it out since it wasn't strictly needed.  No problem adding them back in though.


---

Comment by embray created at 2016-05-31 12:53:20

Changing status from new to needs_review.


---

Comment by embray created at 2016-05-31 12:53:20

Not sure what component to put this under.  There isn't one for `fast_callable`.


---

Comment by git created at 2016-05-31 12:57:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-06-01 00:54:18

Now there is ;-)


---

Comment by vdelecroix created at 2016-06-01 00:54:18

Changing component from PLEASE CHANGE to fast_callable.


---

Comment by vdelecroix created at 2016-06-01 00:57:26

Trying to play with your branch I got

```
[install] [sagelib-7.3.beta2] make[3]: Entering directory '/opt/sage/src'
[install] [sagelib-7.3.beta2] make[3]: warning: -jN forced in submake: disabling jobserver mode.
[install] [sagelib-7.3.beta2] make[3]: *** No rule to make target 'sage_setup/autogen/interpreters.py', needed by 'sage/ext/interpreters/__init__.py'.  Stop.
[install] [sagelib-7.3.beta2] make[3]: Leaving directory '/opt/sage/src'
```



---

Comment by embray created at 2016-06-01 11:53:12

Replying to [comment:6 vdelecroix]:
> Trying to play with your branch I got
> {{{
> [install] [sagelib-7.3.beta2] make[3]: Entering directory '/opt/sage/src'
> [install] [sagelib-7.3.beta2] make[3]: warning: -jN forced in submake: disabling jobserver mode.
> [install] [sagelib-7.3.beta2] make[3]: *** No rule to make target 'sage_setup/autogen/interpreters.py', needed by 'sage/ext/interpreters/__init__.py'.  Stop.
> [install] [sagelib-7.3.beta2] make[3]: Leaving directory '/opt/sage/src'
> }}}

Thanks. I don't run `make` that often for building sagelib (as opposed to just running `setup.py ` directly) so I didn't catch this.


---

Comment by git created at 2016-06-01 14:12:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-06-01 14:13:15

That should fix it.


---

Comment by jdemeyer created at 2016-06-01 15:12:21

Why did you make `src/Makefile` so complicated? I find it hard to understand what you're doing there.


---

Comment by embray created at 2016-06-02 09:07:43

Which part is hard to understand?  The most important change is that since there is not a single `interpreters.py`, if any file in the `sage.autogen.inteprreters` package is changed the interpreter sources should be regenerated.  Even that's a rough approximation :)


---

Comment by jdemeyer created at 2016-06-02 09:39:39

Replying to [comment:11 embray]:
> if any file in the `sage.autogen.intepreters` package is changed the interpreter sources should be regenerated.

That can be done with a single wildcard like we already do for the PARI stuff:

```
sage/libs/pari/auto_gen.pxi: $(SAGE_LOCAL)/share/pari/pari.desc \
        sage/libs/pari/decl.pxi sage_setup/autogen/pari/*.py
    python -c "from sage_setup.autogen.pari import rebuild; rebuild()"
```



---

Comment by embray created at 2016-06-02 13:03:21

The current layout I came up with has a `sage_setup.autogen.interpreters.specs` subpackage, so a single wildcard would not work.

I could do away with the subpackage and that's arguable.  I think it makes it easier to find the implementations for the individual interpreter specs, rather than intermingling them with support modules.


---

Comment by embray created at 2016-06-02 13:14:01

One thing I could do that would definitely simplify this a bit would be instead of the `interpreters.print_names()` function I added, the interpreters module could (and probably should) have a function that returns the names of all the files it generates.  That way this wouldn't have to be duplicated in the Makefile, and it would be made simpler.


---

Comment by jdemeyer created at 2016-06-02 13:20:46

Even with the subdirectory you could still use wildcards...

Anyway, there should be a solution which doesn't involve 20 new lines added to `src/Makefile`.


---

Comment by embray created at 2016-06-02 13:54:40

Well it's a difference of one `find` or two wildcard patterns.  I suppose the latter has the slight advantage of being more explicit.  I could try it and see how it looks.


---

Comment by git created at 2016-06-13 14:29:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-06-13 14:31:15

Simplified the Makefile a smidge.  It's actually better this way than I had it before, because now `sage_setup.autogen.interpreters` alone is responsible for knowing the names of the files it outputs, reducing the need to keep track of that information in multiple places.


---

Comment by git created at 2016-08-16 11:16:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-24 09:23:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2016-08-24 09:23:56

Rebased again (incorporating some small Python3-compat fixes that were made in the meantime) and fixed some issues that were causing some tests to fail in the sage_setup package.


---

Comment by tscrim created at 2016-09-09 13:40:56

Jeroen, are you going to be finishing the review of this ticket?


---

Comment by jdemeyer created at 2016-09-09 13:57:13

We should have talked about this ticket this week. I know I'm repeating myself, but I still don't like what you did to `src/Makefile`.

Anyway, I'll look at the rest.


---

Comment by jdemeyer created at 2016-09-09 13:58:32

What's the point of this:

```
# nodoctest -- __main__ modules are just for running the module from the
# command line and should not be doctested
```


It doesn't matter since the file doesn't have doctests anyway.


---

Comment by embray created at 2016-09-09 14:56:05

Replying to [comment:24 jdemeyer]:
> What's the point of this:
> {{{
> # nodoctest -- __main__ modules are just for running the module from the
> # command line and should not be doctested
> }}}
> 
> It doesn't matter since the file doesn't have doctests anyway.

If it didn't matter I wouldn't have even thought to put such a thing.  The doctest runner still imports a module to determine if there are any doctests in the module.  Since everything in a `__main__` module is is executed upon import, we don't want the doctest runner to even import it (there is no `if __name__ == '__main__'` equivalent since it's a tautology in this case).


---

Comment by mkoeppe created at 2016-09-16 04:04:14

I agree with Jeroen (comment 23) that these Makefile tricks seem unnecessarily complicated.
Just the list the few files that are there one by one in the Makefile.

By the way, #21480 puts this interpreter source generation business under control of setup.sh. So there would be an option to do these kind of things in Python, rather than in Makefile.


---

Comment by mkoeppe created at 2016-09-18 21:17:32

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-09-22 15:35:10

Sorry but I really need to push back on this one.  Earlier I did have a version of this that listed the files manually and then later one that was a little less manual but even then Jeroen complained that it made the file "too long" or something.

I also reject the characterization of this has Makefile "tricks".  These are standard features of make that have been around forever.  These objections just sound like you've never encountered a non-trivial makefile before (which I know isn't true).

Honestly I would just as soon get rid of this makefile entirely, but as long as it's there I see no problem here.


---

Comment by embray created at 2016-09-22 15:35:10

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-09-22 15:36:32

In the meantime you're holding up real work by bikeshedding over code that you arbitrarily think is "too complicated".


---

Comment by mkoeppe created at 2016-09-22 16:58:45

Replying to [comment:28 embray]:
> I also reject the characterization of this has Makefile "tricks".  These are standard features of make that have been around forever.  These objections just sound like you've never encountered a non-trivial makefile before (which I know isn't true).

I've encountered too many.


---

Comment by jdemeyer created at 2016-09-23 09:25:02

Replying to [comment:29 embray]:
> In the meantime you're holding up real work by bikeshedding over code that you arbitrarily think is "too complicated".

I understand but it's not just bikeshedding. It's also about readability. Every time I look at that `src/Makefile` I really have to think hard to understand what is going on. And usually, that is a bad sign.

If you convince me that all that extra complexity is really needed, then I don't mind to merge this. But at this point, I am not yet convinced.


---

Comment by embray created at 2016-09-23 11:25:01

I find that unconvincing--have you ever looked at sage's toplevel Makefile?  _That's_ confusing.  Given the other complexities of sage I do find nitpicking over the (highly subjective) "readability" of one makefile confusing.  Maybe you're just not used to reading makefiles that happen to make use of these features, but I have seen plenty before I don't think it's unreadable at all.

If we're going to remove this makefile eventually anyways, which we should, then just let it be.


---

Comment by embray created at 2016-09-23 11:27:44

And yes, it's needed, because the previous file was actually wrong.  I already demonstrated this to you before weeks ago.  If you're going to use make to require that generated files are up to date, then you have to actually provide the names of those generated files.  Most of the time that can be provided implicitly by a pattern (e.g. `%.c => %.o`) but that's not the case here.  In part because make was really not designed for stuff like this in the first place.


---

Comment by embray created at 2016-09-23 21:35:04

On further reflection, by my own logic if my preference is to remove the makefile entirely then it doesn't matter what's in there. So if it'll help get this done I'll remove the changes changes and focus on helping the efforts to improve Sage's build.


---

Comment by jdemeyer created at 2016-09-24 13:33:29

OK, maybe I already I asked you this, but why run a Python command to determine `INTERP_SOURCES`? Why not a simple wildcard?

Edit: never mind, this `INTERP_SOURCES` has *generated* sources.


---

Comment by jdemeyer created at 2016-09-24 13:37:06

Replying to [comment:33 embray]:
> And yes, it's needed, because the previous file was actually wrong.

Maybe _technically_ wrong but right for all practical purposes. Given that all these files are generated at the same time together, there is really nothing wrong with relying on the timestamp of just file.


---

Comment by jdemeyer created at 2016-09-24 13:42:45

Replying to [comment:25 embray]:
> The doctest runner still imports a module to determine if there are any doctests in the module.

Sorry to say this, but that can't be right. The Sage doctester looks at the files textually to determine the doctests. If what you say is true, we would have the same problem for the docbuilder (`src/sage_setup/docbuild/__main__.py`) but we don't...

For the sake of simplicity, I would remove that `nodoctests` block.


---

Comment by embray created at 2016-09-26 11:46:11

However the doctester determines the doctests, the fact remains that at some point it _imports_ the module.  That happens here: https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/doctest/sources.py#n670

The reason that isn't a problem for `src/sage_setup/docbuild/__main__.py` (and believe me, this had me pulling my hair out) is that it is listed in this insidious [`in_lib`](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/doctest/sources.py#n575) attribute.  I described more problems with this in #20729.

But if you don't believe me try removing it yourself and see.  Like I said, I wouldn't have even thought to add such a thing in the first place if I didn't have a good reason.


---

Comment by embray created at 2016-09-26 11:50:03

Replying to [comment:36 jdemeyer]:
> Replying to [comment:33 embray]:
> > And yes, it's needed, because the previous file was actually wrong.
> 
> Maybe _technically_ wrong but right for all practical purposes. Given that all these files are generated at the same time together, there is really nothing wrong with relying on the timestamp of just file.

I encountered cases in practice where this was not reliable.  But that was months ago now and I can't recall the specifics.  Like I said, it doesn't matter. I don't care anymore since I'm going to work on getting rid of the makefile anyways.


---

Comment by jdemeyer created at 2016-09-26 15:04:00

Replying to [comment:38 embray]:
> However the doctester determines the doctests, the fact remains that at some point it _imports_ the module.  That happens here: https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/doctest/sources.py#n670
> 
> The reason that isn't a problem for `src/sage_setup/docbuild/__main__.py` (and believe me, this had me pulling my hair out) is that it is listed in this insidious [`in_lib`](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/doctest/sources.py#n575) attribute.  I described more problems with this in #20729.

OK, I commented on that ticket. Let me know what you think.


---

Comment by embray created at 2017-01-09 09:03:42

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-03-03 13:59:07

Needs to be rebased again...

All the argument about the makefile is a moot point now that that makefile has been removed.


---

Comment by jdemeyer created at 2017-03-03 14:09:48

Also #20729 has been fixed in the mean time, so you shouldn't need to mess with the doctester anymore...


---

Comment by embray created at 2017-03-03 14:18:22

Right, thanks for the reminder.  I'll work on this when I get back from vacation.


---

Comment by git created at 2017-04-07 12:13:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-04-07 12:16:25

Rebased again, on top of current develop.  That made this ticket much simpler, now that it doesn't require any build system changes.

There's not much to this now other than refactoring and code reformatting--no real substantive changes.  I made sure to incorporate changes to the `interpreters` module that have been made since I last worked on this.


---

Comment by tscrim created at 2017-04-07 15:03:11

Back to needs review?


---

Comment by embray created at 2017-04-07 15:07:24

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-04-07 15:07:24

Yeah, meant to do that.


---

Comment by embray created at 2017-04-11 12:42:40

Would be nice to get this taken care of finally.


---

Comment by jdemeyer created at 2017-04-11 13:10:49

Conflicts with #20238 in various ways....


---

Comment by git created at 2017-04-11 13:42:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-04-11 13:43:57

Only minor conflicts.  I've rebased on your branch in #20238.


---

Comment by jpflori created at 2017-04-25 11:28:23

This looks like a good addition and will allow to close #21459 as a temporary but quick solution for Cygwin.

What about the dependency on #20238?
Can we make the dependency the other way around?
Or will #20238 be finished soon?


---

Comment by jdemeyer created at 2017-04-25 12:05:46

Replying to [comment:53 jpflori]:
> Or will #20238 be finished soon?

It is finished already since almost a month.


---

Comment by embray created at 2017-04-25 14:00:49

Now that you've given #20238 a positive review this should be fine as is.


---

Comment by jpflori created at 2017-04-27 11:51:13

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2017-04-27 11:51:13

The split here is a very good idea.
The autogenerating file was huge and a pain to parse for a human.


---

Comment by vbraun created at 2017-04-28 23:54:55

Resolution: fixed
