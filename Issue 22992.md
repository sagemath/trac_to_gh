# Issue 22992: Cache fraction_field() of p-adic extension rings

Issue created by migration from Trac.

Original creator: saraedum

Original creation time: 2017-06-13 09:25:17

CC:  roed

Note that `creduce` calls this a lot since it computes `inverse_of_unit` in the fraction field.

In a two-step extension, introduced in #23218, this is probably most significant:

```
sage: w=W.gen()
sage: %timeit u=-w
1000 loops, best of 3: 774 µs per loop # without caching
10000 loops, best of 3: 77.9 µs per loop # with caching
```



---

Comment by saraedum created at 2017-06-13 09:27:14

New commits:


---

Comment by saraedum created at 2017-06-13 09:27:14

Changing status from new to needs_review.


---

Comment by roed created at 2017-07-23 04:11:11

Looks good.  The doctest failures are due to a missing x-server on Julian's patchbot.


---

Comment by roed created at 2017-07-23 04:11:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-08-02 18:22:57

No, test failures are real...


---

Comment by vbraun created at 2017-08-02 18:22:57

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-08-04 03:58:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-08-04 04:42:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment

Diff against #23510 for ease of review


---

Comment by roed created at 2017-08-04 05:08:41

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-08-04 05:08:41

I've fixed the doctest and added deprecations for using a `print_mode` argument for `fraction_field`.  This will speed up the `cached_method` once we remove it, and the functionality is available through `change`.


---

Comment by git created at 2017-09-22 20:28:30

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2017-09-23 18:41:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2018-01-06 00:00:08

Looks good. The patchbots complain about lots of things. If this is just noise from somewhere else you can set this to positive review.


---

Comment by nbruin created at 2018-01-06 18:26:56

Did you check for memory leaks? From
`pAdicRing(7) is pAdicRing(7)`
I suspect there is at least some kind of unique representation for padics. This tends to combine very poorly with caching, since it makes unexpected strong global reference chains: Because the ring lives in the (weak value) unique rep. cache, any object it references is strongly globally referenced. If any of those objects now references the ring (for instance by having it in its construction parameters if it's unique rep. itself), you have a globally anchored reference cycle and hence a memory leak.

*EDIT:*
OK, it looks like it's OK, because it seems that the construction parameters of field of fractions or integer ring do not refer to the ring/field, but are both constructed as completions:

```
sage: R=pAdicRing(7)
sage: R.construction()
(Completion[7], Integer Ring)
sage: R.fraction_field().construction()
(Completion[7], Rational Field)
sage: K=pAdicField(7)
sage: K.construction()
(Completion[7], Rational Field)
sage: K.integer_ring().construction()
(Completion[7], Integer Ring)
```


It means that "completion" on number fields cannot be caching.


---

Comment by roed created at 2018-02-26 12:53:11

I agree that the patchbot failures are just noise, and it sounds like Nils is okay with the caching going on here.


---

Comment by roed created at 2018-02-26 12:53:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-03-06 23:23:57

Resolution: fixed
