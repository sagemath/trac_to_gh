# Issue 22992: Cache fraction_field() of p-adic extension rings

archive/issues_022992.json:
```json
{
    "body": "CC:  @roed314\n\nNote that `creduce` calls this a lot since it computes `inverse_of_unit` in the fraction field.\n\nIn a two-step extension, introduced in #23218, this is probably most significant:\n\n```\nsage: w=W.gen()\nsage: %timeit u=-w\n1000 loops, best of 3: 774 \u00b5s per loop # without caching\n10000 loops, best of 3: 77.9 \u00b5s per loop # with caching\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23229\n\n",
    "created_at": "2017-06-13T09:25:17Z",
    "labels": [
        "padics",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Cache fraction_field() of p-adic extension rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22992",
    "user": "@saraedum"
}
```
CC:  @roed314

Note that `creduce` calls this a lot since it computes `inverse_of_unit` in the fraction field.

In a two-step extension, introduced in #23218, this is probably most significant:

```
sage: w=W.gen()
sage: %timeit u=-w
1000 loops, best of 3: 774 µs per loop # without caching
10000 loops, best of 3: 77.9 µs per loop # with caching
```


Issue created by migration from https://trac.sagemath.org/ticket/23229





---

archive/issue_comments_321781.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-06-13T09:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321781",
    "user": "@saraedum"
}
```

New commits:



---

archive/issue_comments_321782.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-13T09:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321782",
    "user": "@saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_321783.json:
```json
{
    "body": "Looks good.  The doctest failures are due to a missing x-server on Julian's patchbot.",
    "created_at": "2017-07-23T04:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321783",
    "user": "@roed314"
}
```

Looks good.  The doctest failures are due to a missing x-server on Julian's patchbot.



---

archive/issue_comments_321784.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-23T04:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321784",
    "user": "@roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_321785.json:
```json
{
    "body": "No, test failures are real...",
    "created_at": "2017-08-02T18:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321785",
    "user": "@vbraun"
}
```

No, test failures are real...



---

archive/issue_comments_321786.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-08-02T18:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321786",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_321787.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-04T03:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321787",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321788.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-04T04:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321788",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321789.json:
```json
{
    "body": "Attachment [23229_over_23510.diff](tarball://root/attachments/some-uuid/ticket23229/23229_over_23510.diff) by @roed314 created at 2017-08-04 04:55:13\n\nDiff against #23510 for ease of review",
    "created_at": "2017-08-04T04:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321789",
    "user": "@roed314"
}
```

Attachment [23229_over_23510.diff](tarball://root/attachments/some-uuid/ticket23229/23229_over_23510.diff) by @roed314 created at 2017-08-04 04:55:13

Diff against #23510 for ease of review



---

archive/issue_comments_321790.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-08-04T05:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321790",
    "user": "@roed314"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_321791.json:
```json
{
    "body": "I've fixed the doctest and added deprecations for using a `print_mode` argument for `fraction_field`.  This will speed up the `cached_method` once we remove it, and the functionality is available through `change`.",
    "created_at": "2017-08-04T05:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321791",
    "user": "@roed314"
}
```

I've fixed the doctest and added deprecations for using a `print_mode` argument for `fraction_field`.  This will speed up the `cached_method` once we remove it, and the functionality is available through `change`.



---

archive/issue_comments_321792.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-09-22T20:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321792",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_321793.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-23T18:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321793",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321794.json:
```json
{
    "body": "Looks good. The patchbots complain about lots of things. If this is just noise from somewhere else you can set this to positive review.",
    "created_at": "2018-01-06T00:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321794",
    "user": "@saraedum"
}
```

Looks good. The patchbots complain about lots of things. If this is just noise from somewhere else you can set this to positive review.



---

archive/issue_comments_321795.json:
```json
{
    "body": "Did you check for memory leaks? From\n`pAdicRing(7) is pAdicRing(7)`\nI suspect there is at least some kind of unique representation for padics. This tends to combine very poorly with caching, since it makes unexpected strong global reference chains: Because the ring lives in the (weak value) unique rep. cache, any object it references is strongly globally referenced. If any of those objects now references the ring (for instance by having it in its construction parameters if it's unique rep. itself), you have a globally anchored reference cycle and hence a memory leak.\n\n**EDIT:**\nOK, it looks like it's OK, because it seems that the construction parameters of field of fractions or integer ring do not refer to the ring/field, but are both constructed as completions:\n\n```\nsage: R=pAdicRing(7)\nsage: R.construction()\n(Completion[7], Integer Ring)\nsage: R.fraction_field().construction()\n(Completion[7], Rational Field)\nsage: K=pAdicField(7)\nsage: K.construction()\n(Completion[7], Rational Field)\nsage: K.integer_ring().construction()\n(Completion[7], Integer Ring)\n```\n\n\nIt means that \"completion\" on number fields cannot be caching.",
    "created_at": "2018-01-06T18:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321795",
    "user": "@nbruin"
}
```

Did you check for memory leaks? From
`pAdicRing(7) is pAdicRing(7)`
I suspect there is at least some kind of unique representation for padics. This tends to combine very poorly with caching, since it makes unexpected strong global reference chains: Because the ring lives in the (weak value) unique rep. cache, any object it references is strongly globally referenced. If any of those objects now references the ring (for instance by having it in its construction parameters if it's unique rep. itself), you have a globally anchored reference cycle and hence a memory leak.

**EDIT:**
OK, it looks like it's OK, because it seems that the construction parameters of field of fractions or integer ring do not refer to the ring/field, but are both constructed as completions:

```
sage: R=pAdicRing(7)
sage: R.construction()
(Completion[7], Integer Ring)
sage: R.fraction_field().construction()
(Completion[7], Rational Field)
sage: K=pAdicField(7)
sage: K.construction()
(Completion[7], Rational Field)
sage: K.integer_ring().construction()
(Completion[7], Integer Ring)
```


It means that "completion" on number fields cannot be caching.



---

archive/issue_comments_321796.json:
```json
{
    "body": "I agree that the patchbot failures are just noise, and it sounds like Nils is okay with the caching going on here.",
    "created_at": "2018-02-26T12:53:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321796",
    "user": "@roed314"
}
```

I agree that the patchbot failures are just noise, and it sounds like Nils is okay with the caching going on here.



---

archive/issue_comments_321797.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-26T12:53:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321797",
    "user": "@roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_321798.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-03-06T23:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22992#issuecomment-321798",
    "user": "@vbraun"
}
```

Resolution: fixed
