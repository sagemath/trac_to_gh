# Issue 17687: Failure in doctest framework when running in docker

archive/issues_017687.json:
```json
{
    "body": "CC:  @vbraun @nthiery @hivert @jdemeyer\n\nKeywords: docker\n\nIn all cases, all tests pass smoothly, except for three files:\n\n    sage -t --warn-long 19.5 src/sage/interfaces/qsieve.py  # Bad exit: 1\n    sage -t --warn-long 19.5 local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/worksheet.py\n    # Bad exit: 1\n    sage -t --warn-long 19.5 local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/cell.py\n    # Bad exit: 1\n\nIn all three cases, it's actually the doctesting framework that fails,\nat the end of forker.py, where it seems to be a race condition.\n\n    Traceback (most recent call last):\n      File \"/home/sage/sage-6.4.1/local/lib/python/multiprocessing/process.py\", line 258, in _bootstrap\n        self.run()\n      File \"/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1839, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2159, in __call__\n        result_queue.put(result, False)\n      File \"/home/sage/sage-6.4.1/local/lib/python/multiprocessing/queues.py\", line 102, in put\n        raise Full\n    Full\n        Bad exit: 1\n\nIssue created by migration from https://trac.sagemath.org/ticket/17924\n\n",
    "created_at": "2015-03-10T08:59:17Z",
    "labels": [
        "doctest framework",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Failure in doctest framework when running in docker",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17687",
    "user": "Vincent.Neri"
}
```
CC:  @vbraun @nthiery @hivert @jdemeyer

Keywords: docker

In all cases, all tests pass smoothly, except for three files:

    sage -t --warn-long 19.5 src/sage/interfaces/qsieve.py  # Bad exit: 1
    sage -t --warn-long 19.5 local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/worksheet.py
    # Bad exit: 1
    sage -t --warn-long 19.5 local/lib/python2.7/site-packages/sagenb-0.11.4-py2.7.egg/sagenb/notebook/cell.py
    # Bad exit: 1

In all three cases, it's actually the doctesting framework that fails,
at the end of forker.py, where it seems to be a race condition.

    Traceback (most recent call last):
      File "/home/sage/sage-6.4.1/local/lib/python/multiprocessing/process.py", line 258, in _bootstrap
        self.run()
      File "/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1839, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/sage/sage-6.4.1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2159, in __call__
        result_queue.put(result, False)
      File "/home/sage/sage-6.4.1/local/lib/python/multiprocessing/queues.py", line 102, in put
        raise Full
    Full
        Bad exit: 1

Issue created by migration from https://trac.sagemath.org/ticket/17924





---

archive/issue_comments_236424.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-10T09:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236424",
    "user": "@nthiery"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_236425.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-03-10T09:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236425",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_236426.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-03-10T09:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236426",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_236427.json:
```json
{
    "body": "Let's first take some time to understand this problem before jumping to add workarounds.",
    "created_at": "2015-03-10T09:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236427",
    "user": "@jdemeyer"
}
```

Let's first take some time to understand this problem before jumping to add workarounds.



---

archive/issue_comments_236428.json:
```json
{
    "body": "What happens if you add this patch (just this one, not on top of the branch of this ticket)?\n\n```\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex fde65c3..91eb232 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):\n                             # would leave them open until we call\n                             # report(), parallel testing can easily fail\n                             # with a \"Too many open files\" error.\n+                            time.sleep(1)\n                             w.save_result_output()\n                             finished.append(w)\n                     workers = new_workers\n```\n",
    "created_at": "2015-03-10T10:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236428",
    "user": "@jdemeyer"
}
```

What happens if you add this patch (just this one, not on top of the branch of this ticket)?

```
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index fde65c3..91eb232 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):
                             # would leave them open until we call
                             # report(), parallel testing can easily fail
                             # with a "Too many open files" error.
+                            time.sleep(1)
                             w.save_result_output()
                             finished.append(w)
                     workers = new_workers
```




---

archive/issue_comments_236429.json:
```json
{
    "body": "Or even better, try this:\n\n```\ndiff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py\nindex fde65c3..d214dc2 100644\n--- a/src/sage/doctest/forker.py\n+++ b/src/sage/doctest/forker.py\n@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):\n                             # would leave them open until we call\n                             # report(), parallel testing can easily fail\n                             # with a \"Too many open files\" error.\n+                            time.sleep(1)\n                             w.save_result_output()\n                             finished.append(w)\n                     workers = new_workers\n@@ -2159,5 +2160,6 @@ class DocTestTask(object):\n             result = (0, DictAsObject(dict(err=exc_info[0], tb=tb)))\n \n         if result_queue is not None:\n+            print(\"Process %s writing to %r\"%(os.getpid(), result_queue))\n             result_queue.put(result, False)\n         return result\n```\n\n\nand run\n\n```\n./sage -bt src/sage/rings/integer.pyx      # or whatever test which normally works\n./sage -bt src/sage/interfaces/qsieve.py   # or whatever test which normally fails\n```\n",
    "created_at": "2015-03-10T10:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236429",
    "user": "@jdemeyer"
}
```

Or even better, try this:

```
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index fde65c3..d214dc2 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
@@ -1538,6 +1538,7 @@ class DocTestDispatcher(SageObject):
                             # would leave them open until we call
                             # report(), parallel testing can easily fail
                             # with a "Too many open files" error.
+                            time.sleep(1)
                             w.save_result_output()
                             finished.append(w)
                     workers = new_workers
@@ -2159,5 +2160,6 @@ class DocTestTask(object):
             result = (0, DictAsObject(dict(err=exc_info[0], tb=tb)))
 
         if result_queue is not None:
+            print("Process %s writing to %r"%(os.getpid(), result_queue))
             result_queue.put(result, False)
         return result
```


and run

```
./sage -bt src/sage/rings/integer.pyx      # or whatever test which normally works
./sage -bt src/sage/interfaces/qsieve.py   # or whatever test which normally fails
```




---

archive/issue_comments_236430.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Or even better, try this:\n\nVincent just tried, and indeed the error disappears. Funilly enough, for qsieve.py, but not for cell.py, it's actually enough to only insert a\n\n```\n      print(\"test\")\n```\n\n(without the sleep beforehand) to make the error disappear! Speak of an heisenbug.\n\nOk, now we would need to understand why there is a race condition ...",
    "created_at": "2015-03-10T10:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236430",
    "user": "@nthiery"
}
```

Replying to [comment:9 jdemeyer]:
> Or even better, try this:

Vincent just tried, and indeed the error disappears. Funilly enough, for qsieve.py, but not for cell.py, it's actually enough to only insert a

```
      print("test")
```

(without the sleep beforehand) to make the error disappear! Speak of an heisenbug.

Ok, now we would need to understand why there is a race condition ...



---

archive/issue_comments_236431.json:
```json
{
    "body": "Replying to [comment:10 nthiery]:\n> Replying to [comment:9 jdemeyer]:\n> > Or even better, try this:\n> \n> Vincent just tried, and indeed the error disappears.\n\nPlease report full output, all details...",
    "created_at": "2015-03-10T10:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236431",
    "user": "@jdemeyer"
}
```

Replying to [comment:10 nthiery]:
> Replying to [comment:9 jdemeyer]:
> > Or even better, try this:
> 
> Vincent just tried, and indeed the error disappears.

Please report full output, all details...



---

archive/issue_comments_236432.json:
```json
{
    "body": "I get the same error on my machine...",
    "created_at": "2015-03-14T19:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236432",
    "user": "@vbraun"
}
```

I get the same error on my machine...



---

archive/issue_comments_236433.json:
```json
{
    "body": "Just tried to increase the /dev/shm size to 2G using mount -o remount,size=2G /dev/shm in the (privileged) docker container and the failure still happens. Changing storage driver in docker from devicemapper to aufs, btrfs or overlay yields the same error.",
    "created_at": "2015-03-14T23:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236433",
    "user": "Vincent.Neri"
}
```

Just tried to increase the /dev/shm size to 2G using mount -o remount,size=2G /dev/shm in the (privileged) docker container and the failure still happens. Changing storage driver in docker from devicemapper to aufs, btrfs or overlay yields the same error.



---

archive/issue_comments_236434.json:
```json
{
    "body": "Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff.  Presumably the fork child needs to do something but isn't fast enough in this case.",
    "created_at": "2015-03-14T23:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236434",
    "user": "@vbraun"
}
```

Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff.  Presumably the fork child needs to do something but isn't fast enough in this case.



---

archive/issue_comments_236435.json:
```json
{
    "body": "> Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff\nWhy do you think that?\n\nGiven that people are ignoring my requests for more information, nothing is clear to me.",
    "created_at": "2015-03-15T10:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236435",
    "user": "@jdemeyer"
}
```

> Its pretty clear that its a race between the fork() inside qsieve and the python multiprocessing stuff
Why do you think that?

Given that people are ignoring my requests for more information, nothing is clear to me.



---

archive/issue_comments_236436.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2015-03-15T10:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236436",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_236437.json:
```json
{
    "body": "Attachment [report2](tarball://root/attachments/some-uuid/ticket17924/report2) by @nthiery created at 2015-03-15 11:30:24",
    "created_at": "2015-03-15T11:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236437",
    "user": "@nthiery"
}
```

Attachment [report2](tarball://root/attachments/some-uuid/ticket17924/report2) by @nthiery created at 2015-03-15 11:30:24



---

archive/issue_comments_236438.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> Given that people are ignoring my requests for more information, nothing is clear to me.\n\nSee the attached files [attachment:report1] and [attachment:report2].\nHopefully you can find something interesting besides what we reported.\n\nI very well know the importance of having all data when tracking down\nbugs, and how frustrating and time consuming it can be when you don't\nhave it under hand. And I appreciate that you are spending time on\nthis issue. But reciprocally, it's also time consuming to build\ninformative reports that reach the right balance of conciseness (so\nthat we can keep an overview of the ticket) while not losing any\nuseful information (for the record, I just spent 30 minutes on it).\n\nWith the issue at hand, it is really easy to reproduce everything. In\ncase you need to experiment further, may I recommend that you run the\ntests yourself?\n\nThanks,\n                                       Nicolas\n\nPS: If this can save you a couple minutes, please send me your public\nssh key, and I'll grant you access to the exact machine on which I ran\nthe tests which has docker and the sage image installed.",
    "created_at": "2015-03-15T11:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236438",
    "user": "@nthiery"
}
```

Replying to [comment:15 jdemeyer]:
> Given that people are ignoring my requests for more information, nothing is clear to me.

See the attached files [attachment:report1] and [attachment:report2].
Hopefully you can find something interesting besides what we reported.

I very well know the importance of having all data when tracking down
bugs, and how frustrating and time consuming it can be when you don't
have it under hand. And I appreciate that you are spending time on
this issue. But reciprocally, it's also time consuming to build
informative reports that reach the right balance of conciseness (so
that we can keep an overview of the ticket) while not losing any
useful information (for the record, I just spent 30 minutes on it).

With the issue at hand, it is really easy to reproduce everything. In
case you need to experiment further, may I recommend that you run the
tests yourself?

Thanks,
                                       Nicolas

PS: If this can save you a couple minutes, please send me your public
ssh key, and I'll grant you access to the exact machine on which I ran
the tests which has docker and the sage image installed.



---

archive/issue_comments_236439.json:
```json
{
    "body": "Replying to [comment:16 nthiery]:\n> In\n> case you need to experiment further, may I recommend that you run the\n> tests yourself?\nI have never used docker and I don't feel like installing docker just to help fix this issue.\n\n> PS: If this can save you a couple minutes, please send me your public\n> ssh key, and I'll grant you access to the exact machine on which I ran\n> the tests which has docker and the sage image installed.\nThat's by far the best solution.",
    "created_at": "2015-03-15T12:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236439",
    "user": "@jdemeyer"
}
```

Replying to [comment:16 nthiery]:
> In
> case you need to experiment further, may I recommend that you run the
> tests yourself?
I have never used docker and I don't feel like installing docker just to help fix this issue.

> PS: If this can save you a couple minutes, please send me your public
> ssh key, and I'll grant you access to the exact machine on which I ran
> the tests which has docker and the sage image installed.
That's by far the best solution.



---

archive/issue_comments_236440.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> That's by far the best solution.\n\nThanks for your key. You should now be able to:\n\n```\nssh root@onevm-92.lal.in2p3.fr\ndocker run -t -i sagemath/sage su - sage\n...                   # as in the ticket description\n```\n\nLet me know if you encounter any issue.\n\nAnyone else interested in investigating on this machine, just send me\nyour key. Otherwise installing docker boils down to:\n\n```\n     apt-get install docker.io    # on Ubuntu/Debian\n```\n\n\nI have updated the description to include this.\nCheers,\n                            Nicolas",
    "created_at": "2015-03-15T12:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236440",
    "user": "@nthiery"
}
```

Replying to [comment:17 jdemeyer]:
> That's by far the best solution.

Thanks for your key. You should now be able to:

```
ssh root@onevm-92.lal.in2p3.fr
docker run -t -i sagemath/sage su - sage
...                   # as in the ticket description
```

Let me know if you encounter any issue.

Anyone else interested in investigating on this machine, just send me
your key. Otherwise installing docker boils down to:

```
     apt-get install docker.io    # on Ubuntu/Debian
```


I have updated the description to include this.
Cheers,
                            Nicolas



---

archive/issue_comments_236441.json:
```json
{
    "body": "\n```\njdemeyer@tamiyo:/usr/local/src/sage-git$ ssh root@onevm-92.lal.in2p3.fr\nssh: connect to host onevm-92.lal.in2p3.fr port 22: Connection timed out\n```\n",
    "created_at": "2015-03-16T10:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236441",
    "user": "@jdemeyer"
}
```


```
jdemeyer@tamiyo:/usr/local/src/sage-git$ ssh root@onevm-92.lal.in2p3.fr
ssh: connect to host onevm-92.lal.in2p3.fr port 22: Connection timed out
```




---

archive/issue_comments_236442.json:
```json
{
    "body": "Hi!\n\nDuring PyCon 2015, I discussed this issue with a couple people, and filled up the following ticket:\n\nhttps://github.com/docker/docker/issues/12277\n\nOllie Walsh jumped in, investigated, and wrote an interesting report. It might actually be an issue on Sage's side. Could someone familiar with the peexpect interface and our doctest forker have a look at his report?\n\nIs the notebook also using queues in a way which could explain the similar looking issue appearing in the notebook tests?",
    "created_at": "2015-04-22T09:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236442",
    "user": "@nthiery"
}
```

Hi!

During PyCon 2015, I discussed this issue with a couple people, and filled up the following ticket:

https://github.com/docker/docker/issues/12277

Ollie Walsh jumped in, investigated, and wrote an interesting report. It might actually be an issue on Sage's side. Could someone familiar with the peexpect interface and our doctest forker have a look at his report?

Is the notebook also using queues in a way which could explain the similar looking issue appearing in the notebook tests?



---

archive/issue_comments_236443.json:
```json
{
    "body": "Hi,\n\nThere are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?\n\nCheers,\n                                Nicolas",
    "created_at": "2015-06-03T21:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236443",
    "user": "@nthiery"
}
```

Hi,

There are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?

Cheers,
                                Nicolas



---

archive/issue_comments_236444.json:
```json
{
    "body": "Replying to [comment:23 nthiery]:\n> There are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?\n\nI don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.\n\nFrom my initial investigation, I couldn't figure out what the problem was. If you're willing to re-install the docker image on that machine, I can have a second fresh look.",
    "created_at": "2015-06-14T20:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236444",
    "user": "@jdemeyer"
}
```

Replying to [comment:23 nthiery]:
> There are a couple other sites (including the math lab in Orsay) that would be happy to setup a patchbot if a docker container solution was available. Given that we are rather stuck, and unless someone is willing to dig in soon, I would be tempted to go for the workaround of [comment:6] for now. What do you think?

I don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.

From my initial investigation, I couldn't figure out what the problem was. If you're willing to re-install the docker image on that machine, I can have a second fresh look.



---

archive/issue_comments_236445.json:
```json
{
    "body": "Replying to [comment:24 jdemeyer]:\n> I don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.\n\nYes, that's why I called it a work around, not a fix :-)\n\n> From my initial investigation, I couldn't figure out what the\n> problem was. If you're willing to re-install the docker image on\n> that machine, I can have a second fresh look .\n\nGreat, thanks! I'll recreate the machine for you, presumably tomorrow.",
    "created_at": "2015-06-14T21:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236445",
    "user": "@nthiery"
}
```

Replying to [comment:24 jdemeyer]:
> I don't like fixing a problem with a work-around if one does not understand why the problem occurs or even why the fix works.

Yes, that's why I called it a work around, not a fix :-)

> From my initial investigation, I couldn't figure out what the
> problem was. If you're willing to re-install the docker image on
> that machine, I can have a second fresh look .

Great, thanks! I'll recreate the machine for you, presumably tomorrow.



---

archive/issue_comments_236446.json:
```json
{
    "body": "Hi Jeroen!\n\nThe machine is up and running for you. Note that the docker image\nslightly evolved since last time (there is a default entry point set\nto start sage automatically by default). I just updated the\ninstructions accordingly in the ticket description. If you want to be\nable to use strace & stuff in a privileged docker container this\nbecomes:\n\n\n```\n> ssh root@onevm-143.lal.in2p3.fr\n\nroot@onevm-143:~# docker run --privileged -t -i --entrypoint \"sudo\" sagemath/sage su -\n\n-bash-4.3# yum install strace\n\n-bash-4.3# su - sage\n\n... as in the ticket description ...\n```\n\n\nNote that in this docker image `sage` is sudoer without password.\n\nGood hunt!\n                                Nicolas",
    "created_at": "2015-06-16T14:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236446",
    "user": "@nthiery"
}
```

Hi Jeroen!

The machine is up and running for you. Note that the docker image
slightly evolved since last time (there is a default entry point set
to start sage automatically by default). I just updated the
instructions accordingly in the ticket description. If you want to be
able to use strace & stuff in a privileged docker container this
becomes:


```
> ssh root@onevm-143.lal.in2p3.fr

root@onevm-143:~# docker run --privileged -t -i --entrypoint "sudo" sagemath/sage su -

-bash-4.3# yum install strace

-bash-4.3# su - sage

... as in the ticket description ...
```


Note that in this docker image `sage` is sudoer without password.

Good hunt!
                                Nicolas



---

archive/issue_comments_236447.json:
```json
{
    "body": "Minimal testcase (run with `sage -python docker-semaphore.py`):\n\n```python\nimport multiprocessing, os, sys, time, signal, pexpect\n\n## Not importing Sage makes the bug go away                                                                                                              \nimport sage.all\n\n\nclass Subprocess(multiprocessing.Process):\n\n    def run(self):\n        result_queue = multiprocessing.Queue(1)\n\n        try:\n            print('run-pre: {0}'.format(result_queue._sem))\n            p = pexpect.spawn('QuadraticSieve')\n            p.sendline('100000000000000000050700000000000000004563\\n\\n\\n')\n            p.closed = True  # avoid surprises from p.__del__                                                                                            \n            print('run-post 1: {0}'.format(result_queue._sem))\n            os.kill(p.pid, signal.SIGHUP)\n            print('run-post 2: {0}'.format(result_queue._sem))\n            time.sleep(0.1)\n            print('run-post 3: {0}'.format(result_queue._sem))\n        except SystemExit as err:\n            # Not catching SystemExit makes the bug go away                                                                                              \n            print(err)\n\n        # Checking empty makes the bug go away                                                                                                           \n        # print(result_queue.empty())                                                                                                                    \n\n        # This is the bug, value should equal to one                                                                                                     \n        v = result_queue._sem.get_value()\n        if v == 0:\n            print('got the wrong value for the semaphore')\n\n        # Raises Full                                                                                                                                    \n        result_queue.put(123, False)\n\n\nif __name__ == '__main__':\n    w = Subprocess()\n    w.start()\n```\n\nOutput inside the docker container is \n\n```\nrun-pre: <BoundedSemaphore(value=1, count=0, maxvalue=1)>\nrun-post 1: <BoundedSemaphore(value=1, count=0, maxvalue=1)>\nrun-post 2: <BoundedSemaphore(value=1, count=0, maxvalue=1)>\nrun-post 3: <BoundedSemaphore(value=0, count=0, maxvalue=1)>\ngot the wrong value for the semaphore\n```\n\nThe value of the semaphore switches to zero a short while after the process is killed, but I don't understand why.  Must be something that we drag in with importing sage...",
    "created_at": "2015-06-16T21:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236447",
    "user": "@vbraun"
}
```

Minimal testcase (run with `sage -python docker-semaphore.py`):

```python
import multiprocessing, os, sys, time, signal, pexpect

## Not importing Sage makes the bug go away                                                                                                              
import sage.all


class Subprocess(multiprocessing.Process):

    def run(self):
        result_queue = multiprocessing.Queue(1)

        try:
            print('run-pre: {0}'.format(result_queue._sem))
            p = pexpect.spawn('QuadraticSieve')
            p.sendline('100000000000000000050700000000000000004563\n\n\n')
            p.closed = True  # avoid surprises from p.__del__                                                                                            
            print('run-post 1: {0}'.format(result_queue._sem))
            os.kill(p.pid, signal.SIGHUP)
            print('run-post 2: {0}'.format(result_queue._sem))
            time.sleep(0.1)
            print('run-post 3: {0}'.format(result_queue._sem))
        except SystemExit as err:
            # Not catching SystemExit makes the bug go away                                                                                              
            print(err)

        # Checking empty makes the bug go away                                                                                                           
        # print(result_queue.empty())                                                                                                                    

        # This is the bug, value should equal to one                                                                                                     
        v = result_queue._sem.get_value()
        if v == 0:
            print('got the wrong value for the semaphore')

        # Raises Full                                                                                                                                    
        result_queue.put(123, False)


if __name__ == '__main__':
    w = Subprocess()
    w.start()
```

Output inside the docker container is 

```
run-pre: <BoundedSemaphore(value=1, count=0, maxvalue=1)>
run-post 1: <BoundedSemaphore(value=1, count=0, maxvalue=1)>
run-post 2: <BoundedSemaphore(value=1, count=0, maxvalue=1)>
run-post 3: <BoundedSemaphore(value=0, count=0, maxvalue=1)>
got the wrong value for the semaphore
```

The value of the semaphore switches to zero a short while after the process is killed, but I don't understand why.  Must be something that we drag in with importing sage...



---

archive/issue_comments_236448.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2015-06-17T07:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236448",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_236449.json:
```json
{
    "body": "Changing component from doctest framework to interfaces.",
    "created_at": "2015-06-17T07:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236449",
    "user": "@jdemeyer"
}
```

Changing component from doctest framework to interfaces.



---

archive/issue_comments_236450.json:
```json
{
    "body": "Attached branch fixes the problem for `qsieve.py`, but not for the notebook.\n----\nNew commits:",
    "created_at": "2015-06-17T07:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236450",
    "user": "@jdemeyer"
}
```

Attached branch fixes the problem for `qsieve.py`, but not for the notebook.
----
New commits:



---

archive/issue_comments_236451.json:
```json
{
    "body": "Whats the race?",
    "created_at": "2015-06-17T07:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236451",
    "user": "@vbraun"
}
```

Whats the race?



---

archive/issue_comments_236452.json:
```json
{
    "body": "It's this from `sagespawn.pyx` (#17686):\n\n```\ntry:\n    spawn.__init__(self, *args, **kwds)\nfinally:\n    # Protect against a race condition where the child process\n    # is interrupted *before* calling execve(). Then the SIGINT\n    # signal will raise a Python KeyboardInterrupt and we end\n    # up here.\n    if self.pid == 0:\n        _exit(1)\n```\n",
    "created_at": "2015-06-17T07:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236452",
    "user": "@jdemeyer"
}
```

It's this from `sagespawn.pyx` (#17686):

```
try:
    spawn.__init__(self, *args, **kwds)
finally:
    # Protect against a race condition where the child process
    # is interrupted *before* calling execve(). Then the SIGINT
    # signal will raise a Python KeyboardInterrupt and we end
    # up here.
    if self.pid == 0:
        _exit(1)
```




---

archive/issue_comments_236453.json:
```json
{
    "body": "Replying to [comment:28 vbraun]:\n> Minimal testcase (run with `sage -python docker-semaphore.py`):\n\nThank you for this excellent analysis! It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.",
    "created_at": "2015-06-17T08:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236453",
    "user": "@jdemeyer"
}
```

Replying to [comment:28 vbraun]:
> Minimal testcase (run with `sage -python docker-semaphore.py`):

Thank you for this excellent analysis! It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.



---

archive/issue_comments_236454.json:
```json
{
    "body": "Attachment [test17924.patch](tarball://root/attachments/some-uuid/ticket17924/test17924.patch) by @jdemeyer created at 2015-06-17 08:03:52\n\nMake pexpect race condition reproducible",
    "created_at": "2015-06-17T08:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236454",
    "user": "@jdemeyer"
}
```

Attachment [test17924.patch](tarball://root/attachments/some-uuid/ticket17924/test17924.patch) by @jdemeyer created at 2015-06-17 08:03:52

Make pexpect race condition reproducible



---

archive/issue_comments_236455.json:
```json
{
    "body": "Adding Volker Braun as author as credit for [comment:28]",
    "created_at": "2015-06-17T08:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236455",
    "user": "@jdemeyer"
}
```

Adding Volker Braun as author as credit for [comment:28]



---

archive/issue_comments_236456.json:
```json
{
    "body": "Great job guys! Thanks so much.\n\nDo you think the issue with the notebook is of the same nature and could be fixed along the same lines?",
    "created_at": "2015-06-17T08:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236456",
    "user": "@nthiery"
}
```

Great job guys! Thanks so much.

Do you think the issue with the notebook is of the same nature and could be fixed along the same lines?



---

archive/issue_comments_236457.json:
```json
{
    "body": "Replying to [comment:39 nthiery]:\n> Do you think the issue with the notebook is of the same nature and could be fixed along the same lines?\n\nMost likely yes, except that the notebook is *supposed* to be independent of Sage (even though, in practice, it's not). There is also the non-trivial issue of actually getting a patch into `sagenb` and making a new `sagenb` release.",
    "created_at": "2015-06-17T08:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236457",
    "user": "@jdemeyer"
}
```

Replying to [comment:39 nthiery]:
> Do you think the issue with the notebook is of the same nature and could be fixed along the same lines?

Most likely yes, except that the notebook is *supposed* to be independent of Sage (even though, in practice, it's not). There is also the non-trivial issue of actually getting a patch into `sagenb` and making a new `sagenb` release.



---

archive/issue_comments_236458.json:
```json
{
    "body": "I wonder if we could somehow monkey-patch the `pexcept` module such that `pexpect.spawn` always refers to the Sage version?",
    "created_at": "2015-06-17T08:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236458",
    "user": "@jdemeyer"
}
```

I wonder if we could somehow monkey-patch the `pexcept` module such that `pexpect.spawn` always refers to the Sage version?



---

archive/issue_comments_236459.json:
```json
{
    "body": "Replying to [comment:35 jdemeyer]:\n> It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.\n\nI agree that it looks related, but there is actually no SystemExit caught. So I still don't understand how that race could have been responsible. Actually I don't understand at all why the SystemExit matters, it must be either a) coincidence, its just timing for the underlying race or b) catching SystemExit somehow changes how signals are handled.",
    "created_at": "2015-06-17T15:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236459",
    "user": "@vbraun"
}
```

Replying to [comment:35 jdemeyer]:
> It was in particular the `except SystemExit as err:` which made me recognize a potential bug I had fixed in #17686.

I agree that it looks related, but there is actually no SystemExit caught. So I still don't understand how that race could have been responsible. Actually I don't understand at all why the SystemExit matters, it must be either a) coincidence, its just timing for the underlying race or b) catching SystemExit somehow changes how signals are handled.



---

archive/issue_comments_236460.json:
```json
{
    "body": "Replying to [comment:42 vbraun]:\n> there is actually no SystemExit caught.\nWrong...\n\nHere is what really happens:\n1. `pexpect` calls `os.fork()`, creating 2 Python processes.\n2. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`. As a consequence, anything `print`ed by the child process is not seen.\n3. The child process receives a `SIGHUP`, which (due to the interrupt code in Sage) raises `SystemExit`.\n4. The child process catches `SystemExit` and runs the code which is really meant for the parent process (this is the bug that #17686 fixes).\n5. The child process puts something in the queue, filling it.\n6. The parent process also tries to put something in the queue, which fails.",
    "created_at": "2015-06-17T15:28:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236460",
    "user": "@jdemeyer"
}
```

Replying to [comment:42 vbraun]:
> there is actually no SystemExit caught.
Wrong...

Here is what really happens:
1. `pexpect` calls `os.fork()`, creating 2 Python processes.
2. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`. As a consequence, anything `print`ed by the child process is not seen.
3. The child process receives a `SIGHUP`, which (due to the interrupt code in Sage) raises `SystemExit`.
4. The child process catches `SystemExit` and runs the code which is really meant for the parent process (this is the bug that #17686 fixes).
5. The child process puts something in the queue, filling it.
6. The parent process also tries to put something in the queue, which fails.



---

archive/issue_comments_236461.json:
```json
{
    "body": "Replying to [comment:43 jdemeyer]:\n> 1. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`.\n\nArgh, true.",
    "created_at": "2015-06-17T17:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236461",
    "user": "@vbraun"
}
```

Replying to [comment:43 jdemeyer]:
> 1. In the child process, `pexpect` creates a `pty` and redirects stdin/stdout/stderr to this `pty`.

Argh, true.



---

archive/issue_comments_236462.json:
```json
{
    "body": "Assuming there is still a failure in sagenb: can you open a new ticket? Then I'll merge this one...\n\nLogging (optional, to a file, with high-resolution time stamps) would be nice. Not on this ticket, obviously.",
    "created_at": "2015-06-17T17:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236462",
    "user": "@vbraun"
}
```

Assuming there is still a failure in sagenb: can you open a new ticket? Then I'll merge this one...

Logging (optional, to a file, with high-resolution time stamps) would be nice. Not on this ticket, obviously.



---

archive/issue_comments_236463.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-06-17T17:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236463",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_236464.json:
```json
{
    "body": "Follow-up: #18721",
    "created_at": "2015-06-17T17:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236464",
    "user": "@jdemeyer"
}
```

Follow-up: #18721



---

archive/issue_comments_236465.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-19T08:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17687#issuecomment-236465",
    "user": "@vbraun"
}
```

Resolution: fixed
