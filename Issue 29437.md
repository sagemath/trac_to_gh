# Issue 29437: fedora-32: Building gcc (9.2.0) spkg fails with gcc 10

archive/issues_029437.json:
```json
{
    "body": "CC:  @dimpase @kiwifb @orlitzky @vbraun @enriqueartal\n\n\n```\nlibtool: compile:  /sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/./gcc/xgcc -shared-libgcc -B/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/./gcc -nostdinc++ -L/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/x86_64-pc-linux-gnu/libstdc++-v3/src -L/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/x86_64-pc-linux-gnu/libstdc++-v3/src/.libs -L/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/x86_64-pc-linux-gnu/libstdc++-v3/libsupc++/.libs -B/sage/local/x86_64-pc-linux-gnu/bin/ -B/sage/local/x86_64-pc-linux-gnu/lib/ -isystem /sage/local/x86_64-pc-linux-gnu/include -isystem /sage/local/x86_64-pc-linux-gnu/sys-include -D_GNU_SOURCE -D_DEBUG -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -DHAVE_RPC_XDR_H=0 -DHAVE_TIRPC_RPC_XDR_H=0 -I. -I../../../../src/libsanitizer/sanitizer_common -I.. -I ../../../../src/libsanitizer/include -isystem ../../../../src/libsanitizer/include/system -Wall -W -Wno-unused-parameter -Wwrite-strings -pedantic -Wno-long-long -fPIC -fno-builtin -fno-exceptions -fno-rtti -fomit-frame-pointer -funwind-tables -fvisibility=hidden -Wno-variadic-macros -I../../libstdc++-v3/include -I../../libstdc++-v3/include/x86_64-pc-linux-gnu -I../../../../src/libsanitizer/../libstdc++-v3/libsupc++ -std=gnu++11 -DSANITIZER_LIBBACKTRACE -DSANITIZER_CP_DEMANGLE -I ../../../../src/libsanitizer/../libbacktrace -I ../libbacktrace -I ../../../../src/libsanitizer/../include -include ../../../../src/libsanitizer/libbacktrace/backtrace-rename.h -g -O2 -D_GNU_SOURCE -MT sanitizer_posix.lo -MD -MP -MF .deps/sanitizer_posix.Tpo -c ../../../../src/libsanitizer/sanitizer_common/sanitizer_posix.cc  -fPIC -DPIC -o .libs/sanitizer_posix.o\nIn file included from ../../../../src/libsanitizer/sanitizer_common/sanitizer_platform_limits_posix.cc:193:\n../../../../src/libsanitizer/sanitizer_common/sanitizer_internal_defs.h:339:72: error: narrowing conversion of '-1' from 'int' to 'long unsigned int' [-Wnarrowing]\n  339 |     typedef char IMPL_PASTE(assertion_failed_##_, line)[2*(int)(pred)-1]\n      |                                                                        ^\n```\n\n\n\nTo reproduce:\n\n```\n  tox -e docker-fedora-32-standard-gcc_spkg\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29674\n\n",
    "created_at": "2020-05-10T21:20:18Z",
    "labels": [
        "component: packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "fedora-32: Building gcc (9.2.0) spkg fails with gcc 10",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29437",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @kiwifb @orlitzky @vbraun @enriqueartal


```
libtool: compile:  /sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/./gcc/xgcc -shared-libgcc -B/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/./gcc -nostdinc++ -L/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/x86_64-pc-linux-gnu/libstdc++-v3/src -L/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/x86_64-pc-linux-gnu/libstdc++-v3/src/.libs -L/sage/local/var/tmp/sage/build/gcc-9.2.0/gcc-build/x86_64-pc-linux-gnu/libstdc++-v3/libsupc++/.libs -B/sage/local/x86_64-pc-linux-gnu/bin/ -B/sage/local/x86_64-pc-linux-gnu/lib/ -isystem /sage/local/x86_64-pc-linux-gnu/include -isystem /sage/local/x86_64-pc-linux-gnu/sys-include -D_GNU_SOURCE -D_DEBUG -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -DHAVE_RPC_XDR_H=0 -DHAVE_TIRPC_RPC_XDR_H=0 -I. -I../../../../src/libsanitizer/sanitizer_common -I.. -I ../../../../src/libsanitizer/include -isystem ../../../../src/libsanitizer/include/system -Wall -W -Wno-unused-parameter -Wwrite-strings -pedantic -Wno-long-long -fPIC -fno-builtin -fno-exceptions -fno-rtti -fomit-frame-pointer -funwind-tables -fvisibility=hidden -Wno-variadic-macros -I../../libstdc++-v3/include -I../../libstdc++-v3/include/x86_64-pc-linux-gnu -I../../../../src/libsanitizer/../libstdc++-v3/libsupc++ -std=gnu++11 -DSANITIZER_LIBBACKTRACE -DSANITIZER_CP_DEMANGLE -I ../../../../src/libsanitizer/../libbacktrace -I ../libbacktrace -I ../../../../src/libsanitizer/../include -include ../../../../src/libsanitizer/libbacktrace/backtrace-rename.h -g -O2 -D_GNU_SOURCE -MT sanitizer_posix.lo -MD -MP -MF .deps/sanitizer_posix.Tpo -c ../../../../src/libsanitizer/sanitizer_common/sanitizer_posix.cc  -fPIC -DPIC -o .libs/sanitizer_posix.o
In file included from ../../../../src/libsanitizer/sanitizer_common/sanitizer_platform_limits_posix.cc:193:
../../../../src/libsanitizer/sanitizer_common/sanitizer_internal_defs.h:339:72: error: narrowing conversion of '-1' from 'int' to 'long unsigned int' [-Wnarrowing]
  339 |     typedef char IMPL_PASTE(assertion_failed_##_, line)[2*(int)(pred)-1]
      |                                                                        ^
```



To reproduce:

```
  tox -e docker-fedora-32-standard-gcc_spkg
```


Issue created by migration from https://trac.sagemath.org/ticket/29674





---

archive/issue_comments_417268.json:
```json
{
    "body": "Let's add the patches from gentoo",
    "created_at": "2020-05-10T21:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417268",
    "user": "https://github.com/mkoeppe"
}
```

Let's add the patches from gentoo



---

archive/issue_comments_417269.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-05-10T21:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417269",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_417270.json:
```json
{
    "body": "Tests of `-gcc_spkg` run at https://github.com/mkoeppe/sage/actions/runs/100892171\n----\nNew commits:",
    "created_at": "2020-05-10T22:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417270",
    "user": "https://github.com/mkoeppe"
}
```

Tests of `-gcc_spkg` run at https://github.com/mkoeppe/sage/actions/runs/100892171
----
New commits:



---

archive/issue_comments_417271.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-05-10T23:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417272.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-05-10T23:51:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417272",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_417273.json:
```json
{
    "body": "The test for IS_REALLY_GCC had bitrotted away and as a result the version check actually didn't run. Fixed.",
    "created_at": "2020-05-10T23:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417273",
    "user": "https://github.com/mkoeppe"
}
```

The test for IS_REALLY_GCC had bitrotted away and as a result the version check actually didn't run. Fixed.



---

archive/issue_comments_417274.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-05-11T01:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417274",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_417275.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-05-11T01:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417275",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417276.json:
```json
{
    "body": "New tests running at https://github.com/mkoeppe/sage/actions",
    "created_at": "2020-05-11T01:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417276",
    "user": "https://github.com/mkoeppe"
}
```

New tests running at https://github.com/mkoeppe/sage/actions



---

archive/issue_comments_417277.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-05-11T01:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417277",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_417278.json:
```json
{
    "body": "Some of the new tests for `-gcc_spkg` at https://github.com/mkoeppe/sage/runs/661787493?check_suite_focus=true have unrelated failures, for which I have opened #29675. These are not important to fix.",
    "created_at": "2020-05-11T05:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417278",
    "user": "https://github.com/mkoeppe"
}
```

Some of the new tests for `-gcc_spkg` at https://github.com/mkoeppe/sage/runs/661787493?check_suite_focus=true have unrelated failures, for which I have opened #29675. These are not important to fix.



---

archive/issue_comments_417279.json:
```json
{
    "body": "`fedora-32-standard-gcc_spkg` (https://github.com/mkoeppe/sage/runs/661787882), `fedora-32-standard-python2-gcc_spkg` (https://github.com/mkoeppe/sage/runs/661787887) work correctly with this fix. \n\n`fedora-32-minimal-gcc_spkg` (https://github.com/mkoeppe/sage/runs/661787878) is clean too but times out.",
    "created_at": "2020-05-11T14:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417279",
    "user": "https://github.com/mkoeppe"
}
```

`fedora-32-standard-gcc_spkg` (https://github.com/mkoeppe/sage/runs/661787882), `fedora-32-standard-python2-gcc_spkg` (https://github.com/mkoeppe/sage/runs/661787887) work correctly with this fix. 

`fedora-32-minimal-gcc_spkg` (https://github.com/mkoeppe/sage/runs/661787878) is clean too but times out.



---

archive/issue_comments_417280.json:
```json
{
    "body": "And `fedora-32-standard` (https://github.com/mkoeppe/sage/runs/661788407) shows the changes to the spkg-configure:\n\n```\nhecking whether SageMath should install SPKG gcc...\nchecking for C compiler vendor... gnu\nchecking whether g++ supports C++11 features with -std=gnu++11... yes\nchecking for gcc option to accept ISO C99... none needed\nchecking if gcc accepts -dumpversion option... yes\nchecking gcc version... 10\nchecking if g++ accepts -dumpversion option... yes\nchecking g++ version... 10\nconfigure: Installing GCC because g++ -std=gnu++11 is g++ version 10, which is too recent for this version of Sage\nconfigure: no suitable system package found for SPKG gcc\n```\n\nThe runs on systems other than `fedora-32` are unchanged (https://github.com/mkoeppe/sage/actions/runs/100987613).\n\n\nReady for review",
    "created_at": "2020-05-12T05:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417280",
    "user": "https://github.com/mkoeppe"
}
```

And `fedora-32-standard` (https://github.com/mkoeppe/sage/runs/661788407) shows the changes to the spkg-configure:

```
hecking whether SageMath should install SPKG gcc...
checking for C compiler vendor... gnu
checking whether g++ supports C++11 features with -std=gnu++11... yes
checking for gcc option to accept ISO C99... none needed
checking if gcc accepts -dumpversion option... yes
checking gcc version... 10
checking if g++ accepts -dumpversion option... yes
checking g++ version... 10
configure: Installing GCC because g++ -std=gnu++11 is g++ version 10, which is too recent for this version of Sage
configure: no suitable system package found for SPKG gcc
```

The runs on systems other than `fedora-32` are unchanged (https://github.com/mkoeppe/sage/actions/runs/100987613).


Ready for review



---

archive/issue_comments_417281.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-05-12T12:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417281",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_417282.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> The test for IS_REALLY_GCC had bitrotted away and as a result the version check actually didn't run. Fixed.\n\nI'm skeptical that this worked in the first place (that's a shell pipe, not a regex):\n\n\n```\nAS_CASE([\"$GXX_VERSION.0\"],\n                [[[0-3]].*|4.[[0-7]].*], [\n```\n\n\nI can't really test this but the changes are reasonable. The main risk with something like this is that the patches would break something with older glibc, but the fact that upstream backported these two patches to the 9.3 branch suggests that they wouldn't. The CI checks confirm that, and everyone else will be using their system GCC anyway, so let's try it.",
    "created_at": "2020-05-12T12:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417282",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:11 mkoeppe]:
> The test for IS_REALLY_GCC had bitrotted away and as a result the version check actually didn't run. Fixed.

I'm skeptical that this worked in the first place (that's a shell pipe, not a regex):


```
AS_CASE(["$GXX_VERSION.0"],
                [[[0-3]].*|4.[[0-7]].*], [
```


I can't really test this but the changes are reasonable. The main risk with something like this is that the patches would break something with older glibc, but the fact that upstream backported these two patches to the 9.3 branch suggests that they wouldn't. The CI checks confirm that, and everyone else will be using their system GCC anyway, so let's try it.



---

archive/issue_comments_417283.json:
```json
{
    "body": "Replying to [comment:20 mjo]:\n> \n> I'm skeptical that this worked in the first place (that's a shell pipe, not a regex):\n> \n> {{{\n> AS_CASE([\"$GXX_VERSION.0\"],\n>                 [This is the Trac macro *[0-3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[0-3-macro).*|4.[This is the Trac macro *0-7* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0-7-macro).*], [\n> }}}\n> \n\nApparently it does, even without bash's extglob. TIL.",
    "created_at": "2020-05-12T12:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417283",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:20 mjo]:
> 
> I'm skeptical that this worked in the first place (that's a shell pipe, not a regex):
> 
> {{{
> AS_CASE(["$GXX_VERSION.0"],
>                 [This is the Trac macro *[0-3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[0-3-macro).*|4.[This is the Trac macro *0-7* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0-7-macro).*], [
> }}}
> 

Apparently it does, even without bash's extglob. TIL.



---

archive/issue_comments_417284.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-05-12T15:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417284",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_417285.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-13T19:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29437#issuecomment-417285",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_075869.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-05-13T19:17:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29437",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29437#event-75869"
}
```
