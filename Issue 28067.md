# Issue 28067: add type information to _repr_ of Macaulay2 elements

Issue created by migration from https://trac.sagemath.org/ticket/28304

Original creator: @mwageringel

Original creation time: 2019-07-31 22:50:15

CC:  dimpase @antonleykin

Keywords: macaulay2

In Macaulay2, the `AfterPrint` is responsible for adding useful type information about computed results. Since this information generally cannot be obtained easily otherwise, it should be added to the `_repr_` of Macaulay2 elements. Compare for example

```
sage: macaulay2.eval('kernel matrix {{1, 2}, {3, 6}}')
image | 2  |
      | -1 |

                          2
ZZ-module, submodule of ZZ
```

to

```
sage: macaulay2(matrix([[1, 2], [3, 6]])).kernel()
image | 2  |
      | -1 |
sage: _.cls()  # this is much less informative
Module
```





---

Comment by @mwageringel created at 2019-07-31 23:08:44

With #28303, it would be easy to implement this as follows:

```diff
--- a/src/sage/interfaces/macaulay2.py
+++ b/src/sage/interfaces/macaulay2.py
@@ -802,9 +802,12 @@ class Macaulay2Element(ExtraTabCompletion, ExpectElement):
         """
         from sage.typeset.ascii_art import empty_ascii_art
         P = self.parent()
-        return P.eval('print(wrap(%d,"-",net %s))'
-                      % (empty_ascii_art._terminal_width(), self._name),
-                      strip=False)
+        # In M2, the wrapped output is indented by the width of the prompt,
+        # which we strip in Sage. We hardcode the width of the prompt to
+        # 14=len('o1000000001 = '), which is tested in the doctests by the
+        # output getting wrapped at 80 characters.
+        width = 14 + empty_ascii_art._terminal_width()
+        return P.eval('printWidth=%d;%s' % (width, self._name), strip=True)

     def external_string(self):
         """
```


This ticket would affect the repr of many Macaulay2 elements and consequently lots of doctests would need to be updated. I think this change is justified for its usefulness, but I welcome other ideas. Making this output optional would also be a possibility (`QQbar` has optional print options, too, for instance).


---

Comment by @mwageringel created at 2019-07-31 23:10:00

Changing type from PLEASE CHANGE to enhancement.


---

Comment by @mwageringel created at 2019-11-06 20:30:50

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-11-06 20:30:50

We discussed this issue at the IMA a few weeks ago. Dima suggested that including type information in the `repr` by default is not pythonic, but that Macaulay2 elements should have a method to access this kind of information instead. I think it would still be useful to be able to optionally enable printing this info, as this is what Macaulay2 does by default.

Here is a branch implementing both. It adds a method `after_print_text()` to obtain this type info from within Sage. Moreover, it adds an option `macaulay2.options.after_print='yes'` (`'no'` by default) to append the AfterPrint text to the `repr` of Macaulay2 elements. This option can then be enabled in the `init.sage` file, for example.

```
sage: m = macaulay2(matrix([[1, 2], [3, 6]])); m
sage: m.after_print_text()
         2        2
Matrix ZZ  <--- ZZ
sage: macaulay2.options.after_print = 'yes'
sage: m
| 1 2 |
| 3 6 |
| 1 2 |
| 3 6 |
         2        2
Matrix ZZ  <--- ZZ
```

----
New commits:


---

Comment by git created at 2019-11-06 20:42:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-11-06 22:32:28

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-11-06 22:32:28

in docstrings, the 1st line should be followed by an empty line.
So

```
+    def after_print_text(self):
+        r"""
+        Obtain the type information about this Macaulay2 element that is
+        displayed using ``AfterPrint`` in the Macaulay2 interpreter.
```

should become something like 


```
+    def after_print_text(self):
+        r"""
+        Macaulay2 type information for ``self``
+
+        Obtain the type information for ``self``, as
+        displayed by ``AfterPrint`` in Macaulay2 interpreter.
```


Also, please document `options` class.


---

Comment by git created at 2019-11-07 18:37:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2019-11-07 18:50:28

Thank you for the quick feedback. I have shortened the first sentence of the docstring, so that it fits on a single line, and moved the examples for the `after_print` option to the `options` class. The super class `GlobalOptions` actually generates the docstring if absent, but it is good to also have some examples there. (This is currently broken in HTML docs with Python 3 #28698.)

I have also moved the import of `deprecated_function_alias` to the top of the file, so that its docstring does not get added to [the HTML documentation](http://doc.sagemath.org/html/en/reference/interfaces/sage/interfaces/macaulay2.html#sage.interfaces.macaulay2.Macaulay2Element.deprecated_function_alias).


---

Comment by @mwageringel created at 2019-11-07 18:50:49

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-11-08 02:04:04

For the `after_print` option, IMO more natural values would be `True` and `False` rather than strings.


---

Comment by @mwageringel created at 2019-11-08 07:38:19

Replying to [comment:10 tscrim]:
> For the `after_print` option, IMO more natural values would be `True` and `False` rather than strings.

I completely agree with this. The problem is that `sage.structure.global_options` only seems to work with options of type string, but booleans do not work. I have not looked much into it yet, so cannot say how difficult it is to change this, but will report back once I know more.


---

Comment by tscrim created at 2019-11-08 07:53:18

Replying to [comment:11 gh-mwageringel]:
> Replying to [comment:10 tscrim]:
> > For the `after_print` option, IMO more natural values would be `True` and `False` rather than strings.
> 
> I completely agree with this. The problem is that `sage.structure.global_options` only seems to work with options of type string, but booleans do not work. I have not looked much into it yet, so cannot say how difficult it is to change this, but will report back once I know more.

That is wrong. See `combinat/partition.py`:

```
        diagram_str = dict(default="*",
                         description='The character used for the cells when printing Ferrers diagrams',
                         checker=lambda char: isinstance(char,str))
```

So use

```
        after_print = dict(default=True,
                           description='Print more stuff',
                           checker=lambda val: isinstance(val, bool))
```



---

Comment by git created at 2019-11-08 18:53:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2019-11-08 18:56:02

Replying to [comment:12 tscrim]:
> So use
> {{{
>         after_print = dict(default=True,
>                            description='Print more stuff',
>                            checker=lambda val: isinstance(val, bool))
> }}}

Awesome. Thanks for pointing this out. I have changed it.


---

Comment by tscrim created at 2019-11-15 18:11:03

Dima, are you going to finish the review here or do you want me to do it?


---

Comment by dimpase created at 2019-11-15 20:45:51

Hi Travis, please go ahead with your review. I am a bit pressed for time now.


---

Comment by tscrim created at 2019-11-16 08:15:20

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-11-16 08:15:20

Okay, LGTM.


---

Comment by vbraun created at 2019-11-24 16:58:56

Resolution: fixed
