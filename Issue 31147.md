# Issue 31147: cython_aliases: Do not fail if one of the listed libraries is not known to pkgconfig

Issue created by migration from https://trac.sagemath.org/ticket/31384

Original creator: mkoeppe

Original creation time: 2021-02-11 22:04:18

CC:  isuruf fbissey arojas @collares thansen infinity0

(split out from #30371)

This helps with the modularization effort.



---

Comment by git created at 2021-02-11 22:09:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-02-11 22:11:53

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-02-11 22:20:19

What did you need this for exactly in #30371?

For modularization we certainly need something like this; but I think when building all modules, with this patch the unresolved cython aliases will just stay as is and cause errors later.


---

Comment by mkoeppe created at 2021-02-12 01:06:11

Changing status from needs_review to needs_info.


---

Comment by @tobiasdiez created at 2021-02-12 17:42:16

I changed this during my experiments where I tried to have everything work without any previous built sage's packages. So it's not needed for #30371.


---

Comment by mkoeppe created at 2021-02-12 17:45:25

Thanks! Then I will rework this ticket for the purposes of modularization, making the list of needed libraries an input.


---

Comment by mkoeppe created at 2021-02-12 17:45:36

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-03-22 20:33:05

A version of this is needed for Sage 9.3: Since #29706, `cython_aliases` insists to find `lapack.pc` even though no `LAPACK_...` aliases are used anywhere in `src/`.
In the Sage distribution, of course, we have that; but it fails for example in conda when testing without build of the Sage distribution.


---

Comment by mkoeppe created at 2021-03-22 20:44:39

(Related previous ticket: #30706)


---

Comment by git created at 2021-03-22 20:50:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-03-22 21:41:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-22 21:44:07

If any changes in `cython_aliases` would eliminate downstream patching, now would be the time...


---

Comment by mkoeppe created at 2021-03-22 21:44:07

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2021-03-22 21:51:04

I don't know about other distros but Gentoo is good. This particular section hasn't needed patching in some time here.


---

Comment by mkoeppe created at 2021-03-23 06:09:27

Debian has a relevant patch: https://sources.debian.org/patches/sagemath/9.2-2/d0-gsl-cblas.patch/


---

Comment by fbissey created at 2021-03-23 07:25:18

They are enforcing using gslcblas as their cblas library. That's a bit surprising and shocking. Their own comment is confusing, they seem to think gslcblas should be used which is not the case.

I think it could be nice to provide them with a fallback option that could be provided by sage_conf.py if pkg-config cannot find a cblas module. Someone knowing more about what .pc files debian provides should comment.


---

Comment by thansen created at 2021-03-23 19:31:51

In Debian BLAS is managed with the alternatives system (update-alternatives), which allows to install multiple implementations at the same time and define one of them as default.
As a result, libblas.so.3, cblas.h and blas.pc are symlinks managed by the alternatives system, so these files do not show up in any package, but they are created as symlinks when any BLAS implementation is installed.

But no BLAS implementation installs a libcblas.so or cblas.pc. Could it be that this is not really needed and provided by libblas.so together with cblas.h?


---

Comment by arojas created at 2021-03-23 19:42:29

Replying to [comment:20 thansen]:
> But no BLAS implementation installs a libcblas.so or cblas.pc. Could it be that this is not really needed and provided by libblas.so together with cblas.h?

That's a Debian specific thing

https://salsa.debian.org/science-team/lapack/-/blob/master/debian/README.if-you-look-for-libcblas.so.3

The unpatched Netlib reference blas implementation does install a libcblas.so library.


---

Comment by thansen created at 2021-03-23 19:47:58

Ok, then the fallback for Debian should be to use blas.pc and link against libblas.


---

Comment by fbissey created at 2021-03-23 19:54:05

Sounds fair. If cblas.pc is not found, look for blas.pc instead. It should be doable.


---

Comment by mkoeppe created at 2021-03-23 19:55:23

You can do this already without patching sagelib by setting `CBLAS_PC_MODULES = "cblas:blas"` in `sage_conf.py`.


---

Comment by fbissey created at 2021-03-23 20:00:00

Yes, indeed the mechanics to do that is already there. So many good changes recently :)


---

Comment by mkoeppe created at 2021-03-23 20:13:15

Sounds like no further changes are needed on this ticket. Let's get this into 9.3 please


---

Comment by @kliem created at 2021-03-25 07:26:04

LGTM.


---

Comment by @kliem created at 2021-03-25 07:26:04

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-03-26 05:52:56

Thanks!


---

Comment by vbraun created at 2021-05-27 20:29:53

Resolution: fixed
