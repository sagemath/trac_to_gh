# Issue 20144: Patch to brial to get it building again on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-04-07 16:35:37

Keywords: cygwin windows brial

brial doesn't build on Cygwin due to some inconsistency of how `__STRICT_ANSI__` is handled by C++ on Cygwin.  Changing `-std=c++98` to `-std=gnu++98` works around this behavior--I don't think there's any reason brial _must_ be build with strict ANSI C++.

Nevertheless this is an issue more with Cygwin than anything else.
I don't know if this has been reported upstream to Cygwin but it seems to be a very old issue.  Likewise it would be good if a workaround were upstreamed to brial.


---

Comment by embray created at 2016-04-07 16:35:51

Changing status from new to needs_review.


---

Comment by embray created at 2016-04-07 16:49:30

That said, [this post](https://cygwin.com/ml/cygwin/2010-01/msg00791.html) seems to make a good argument that Cygwin's behavior is *more* correct than the standard gcc in this regard.  It's inconvenient but seemingly not wrong.  So maybe just forget about it and just bring the issue to brial.


---

Comment by jdemeyer created at 2016-04-07 17:25:37

In any case, I would prefer to apply this patch always, not only on Cygwin.


---

Comment by embray created at 2016-04-07 17:27:24

Oh? I have nothing against that I'm just curious why it would be preferable always?


---

Comment by vdelecroix created at 2016-04-07 18:49:57

Please add your name in the Author field.


---

Comment by git created at 2016-04-07 19:01:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by gouezel created at 2016-04-08 15:45:31

Changing status from needs_review to needs_work.


---

Comment by gouezel created at 2016-04-08 15:45:31

The patch is not enough for me: even with the patch, compilation lines still have `-std=c++98` and not `-std=gnu++98`. After `autoreconf`, however, eveything becomes fine, so I guess the patch is only missing the `autoreconf` output. (More details in #17622, comment:5)


---

Comment by gouezel created at 2016-04-08 18:45:05

I have added the necessary autoconfed bits. With the new branch, this works for me.
----
New commits:


---

Comment by gouezel created at 2016-04-08 18:45:05

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-04-11 12:13:51

Okay, I was a little confused by this before too.  Why is there a separate set of patches under `patches/build/`?  When are the "build" patches applied?  I didn't need this myself.


---

Comment by gouezel created at 2016-04-13 19:56:58

Copy/pasted from jpflori's comment at #17622:

The patches in build_system directory are those you need to apply to the brial build system before autotools automatically generate the full build system.
Once these patches are applied, one can invoke autotools to update the build system and deduce the full patches in the patches directory which don't need autotools invokation anymore and can be applied at build time.


To summarize it's good to ship two set of patches because:

* we can't rely on invoking autotools at build time because it is not a prerequisite and would not be manageable anyway, it's kind of impossible to make sure that the build system will be correctly regenarated with one of the random versions of autotools programs in the wild, therefore the build system has to be regenerated on a dev machine and full patches have to be distributed,
  
* the patches only touching the input to autotools are still of interest as these are the ones to be updated manually if we want to introduce further changes in the build system, and the ones to submit upstream for inclusion (and when upstream makes new releases it will regenerate the full build system)


---

Comment by jdemeyer created at 2016-04-13 20:01:00

Did you try dropping the `-std=gnu++98` argument completely? Is it a problem if C++03 or C++11 is used?


---

Comment by gouezel created at 2016-04-13 20:02:16

I should add that I am surprised that your patch was enough for you, since it wasn't for me and our settings should be comparable. Are you sure that you did not do `autoreconf` at some point manually, that was accidentally not included in the patch? To test that your patch was enough for you, could you start from a clean `develop`, then merge `u/embray/brial-cygwin-patch` and see if it builds without any additional tweaking?


---

Comment by jdemeyer created at 2016-04-13 20:03:23

Note that upstream for brial is really Sage. It's a Sage fork of the abandoned project PolyBoRi. So it might be best to just make a new release of brial and use that.


---

Comment by embray created at 2016-04-14 09:32:34

This all seems to be under the assumption that one would have already built "brial" once before and already have the autotools-generated files lying around. But I don't know why you would assume that to be the case in general.


---

Comment by gouezel created at 2016-04-14 09:49:00

Sorry, I don't get what you mean.

Again, `autotools` is *not* a requirement of Sagemath, and building a package does *not* run autotools: as is customary, it only does `./configure` and `make`. So the `autotools` steps should be done by the package maintainer, inside the `spkg`. If a patch changes a file used by `autotools`, then it should also include the subsequent modifications made by the `autotools` invocation.


---

Comment by embray created at 2016-04-14 10:14:45

> Again, autotools is not a requirement of Sagemath

Okay, that's what wasn't clear to me.  I think it's not always clear what sage does to modify source packages, versus what it does to modify extracted source packages at build time (or indeed, if sage publishes its own source packages, why even apply build-time patches at all?)


---

Comment by gouezel created at 2016-04-14 10:23:44

The idea is that source packages should be official source releases provided by upstream, without any modification. All modifications should come from patches. In this way, it is easy to keep sage's modifications when upstream releases a new version.


---

Comment by embray created at 2016-04-14 10:28:05

> The idea is that source packages should be official source releases provided by upstream, without any modification

I think we're talking past each other, or some terms aren't clearly defined. Because to me this directly contradicts what you wrote just previously (and also my own experience which is that sage builds its own modified source tarballs in some cases).  Is this all documented somewhere?


---

Comment by gouezel created at 2016-04-14 11:30:44

In general, to compile a program from source, you don't need autotools, just run `./configure` and `make`. This means its release manager will run autotools before releasing an official source tarball. 

Then this (official, already autotoolified) source tarball will be the sage source package, downloaded in the `upstream`directory. If some patches to this source package are needed for sage, they will be added just before build: the usual package installation process uncompresses the official source, incorporates the patches, then runs `./configure`, `make` and `make install`, with additional flags if necessary.


---

Comment by embray created at 2016-04-14 12:12:01

> In general, to compile a program from source, you don't need autotools, just run ./configure and make

It depends. My confusion perhaps stems from the fact that some (probably most?) projects include `./configure` in their source tarballs, but some don't.

> If some patches to this source package are needed for sage, they will be added just before build

There are some exceptions, which is another source of my confusion.  For example [ecl](http://git.sagemath.org/sage.git/tree/build/pkgs/ecl?h=develop) has patches that are applied to the source tarball before uploading to sage's package mirrors.  I guessed that maybe the same was being done for brial but I was wrong in this case.  What's further confusing is that although the separate `brial/patches/build/` patches _exist_ in the repository, nothing ever seems to apply them (I was expecting to find maybe an `spkg-src` script that applies them).  I sort of get the point though--it's just demonstrating what would be patched before running `autoreconf` or the like.  *shrug*


---

Comment by jdemeyer created at 2016-04-14 12:27:54

Replying to [comment:22 embray]:
> > In general, to compile a program from source, you don't need autotools, just run ./configure and make
> 
> It depends. My confusion perhaps stems from the fact that some (probably most?) projects include `./configure` in their source tarballs, but some don't.

If they don't include `./configure`, I consider that an upstream bug.


---

Comment by embray created at 2016-04-15 12:13:45

Maybe, maybe not.  Some projects just make their source tarballs by bundling what's in the VCS--sometimes this is done directly though [GitHub](GitHub) or other VCS interfaces.  I don't think it's wrong.  Slightly inconvenient but not wrong.


---

Comment by embray created at 2016-04-27 14:11:10

Above discussion aside this is good to go.  I  haven't tried outright dropping the `-std=gnu++98`. I doubt it's needed but leaving this as is is easier than testing and rewriting the patch since this definitely fixes the issue and we don't really care what C standard it prefers as long as it compiles.


---

Comment by embray created at 2016-04-27 14:11:15

Changing status from needs_review to positive_review.


---

Comment by gouezel created at 2016-04-27 14:16:38

I have tested without `-std=gnu++98`, it also works but I agree it is not worth rewriting the patch. I have submitted a pull request upstream fixing this issue and #19643, so hopefully we will be able to drop this patch with the next release of brial.


---

Comment by vbraun created at 2016-04-28 15:36:24

Resolution: fixed


---

Comment by dimpase created at 2016-05-18 11:49:32

Which this patch, one created a dependence on automake. 
See https://groups.google.com/d/msg/sage-support/6Xg1RXXw-S0/nKaaeLdrDAAJ

This should not have happened!


---

Comment by embray created at 2016-05-19 10:20:46

No, I don't believe so.  

What I mean to say is, I don't think it has to do with this ticket.  If you scrutinize the patch it's just making some trivial modifications to some lines that already exist.

It's possible that if a new package for brial was built it wasn't done properly, but I don't know who does that.


---

Comment by dimpase created at 2016-05-19 10:31:42

Replying to [comment:30 embray]:
> No, I don't believe so.  
> 
> What I mean to say is, I don't think it has to do with this ticket.  If you scrutinize the patch it's just making some trivial modifications to some lines that already exist.
> 
> It's possible that if a new package for brial was built it wasn't done properly, but I don't know who does that.

Hmm, OK, sorry. Perhaps it's a building issue, like a skew clock or something, that triggers automake run....


---

Comment by slelievre created at 2016-05-19 10:55:05

Replying to [comment:27 gouezel]:
> I have submitted a pull request upstream fixing this issue and #19643, so hopefully
> we will be able to drop this patch with the next release of brial.

For reference upstream the pull request is at
    https://github.com/BRiAl/BRiAl/pull/7


---

Comment by jdemeyer created at 2016-05-19 11:30:46

Replying to [comment:30 embray]:
> If you scrutinize the patch it's just making some trivial modifications to some lines that already exist.

The mere fact of applying a patch (whether or not it makes trivial modifications) is an important change. It affects timestamps of the patched files which can certainly influence whether automake is needed.


---

Comment by jdemeyer created at 2016-05-19 11:39:08

For the record: I'm not able to reproduce the automake issue with Sage 7.2 (Linux 3.17.7 on ext4 file system)


---

Comment by gouezel created at 2016-05-19 19:41:37

I could reproduce the issue on cygwin. Should be solved with #20634.


---

Comment by embray created at 2016-05-20 10:13:06

I see now, so maybe by patching common.mk for example it retriggered automake.


---

Comment by dimpase created at 2016-05-20 10:50:11

I think that the patch should have included the complete change (including `.ac`, etc., files), and not only changes to autogenerated files.


---

Comment by gouezel created at 2016-05-20 18:50:04

Replying to [comment:37 dimpase]:
> I think that the patch should have included the complete change (including `.ac`, etc., files), and not only changes to autogenerated files.

This is exactly what the patch does. The version in `/patches/build/` indicates the manual modification to configuration files (only `common.mk` needs to be changed), and the version in `/patches/` (the one that gets applied) includes both this manual modification and the subsequent changes to autogenerated files following from an autotools application.
