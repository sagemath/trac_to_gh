# Issue 10429: Add Weisfeiler-Leman algorithm to sage.graphs

archive/issues_010429.json:
```json
{
    "body": "Assignee: @kini\n\nKeywords: weisfeiler-leman algorithm, graphs, coherent configurations, refinement\n\nSee [this sage-devel thread](http://groups.google.com/group/sage-devel/browse_thread/thread/aae6ee93b11715c8).\n\nAdding an implementation of the Weisfeiler-Leman algorithm for partition / graph refinement.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10482\n\n",
    "created_at": "2010-12-16T11:40:35Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Add Weisfeiler-Leman algorithm to sage.graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10429",
    "user": "https://github.com/kini"
}
```
Assignee: @kini

Keywords: weisfeiler-leman algorithm, graphs, coherent configurations, refinement

See [this sage-devel thread](http://groups.google.com/group/sage-devel/browse_thread/thread/aae6ee93b11715c8).

Adding an implementation of the Weisfeiler-Leman algorithm for partition / graph refinement.

Issue created by migration from https://trac.sagemath.org/ticket/10482





---

archive/issue_comments_107246.json:
```json
{
    "body": "Attachment [trac_10482-wlrefine](tarball://root/attachments/some-uuid/ticket10482/trac_10482-wlrefine) by @kini created at 2010-12-16 11:45:49\n\npatch to be applied to sage-main repository",
    "created_at": "2010-12-16T11:45:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107246",
    "user": "https://github.com/kini"
}
```

Attachment [trac_10482-wlrefine](tarball://root/attachments/some-uuid/ticket10482/trac_10482-wlrefine) by @kini created at 2010-12-16 11:45:49

patch to be applied to sage-main repository



---

archive/issue_comments_107247.json:
```json
{
    "body": "Sorry, here it is with a \".patch\" extension. To be applied to sage-main.",
    "created_at": "2010-12-16T11:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107247",
    "user": "https://github.com/kini"
}
```

Sorry, here it is with a ".patch" extension. To be applied to sage-main.



---

archive/issue_comments_107248.json:
```json
{
    "body": "Attachment [trac_10482-wlrefine.patch](tarball://root/attachments/some-uuid/ticket10482/trac_10482-wlrefine.patch) by @dimpase created at 2010-12-16 12:38:16\n\nthis  all works OK (on sage 4.6.1.alpha3);\nwhat I do not know is whether GraphWL should be installed as a method for graphs.\n\nDima",
    "created_at": "2010-12-16T12:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107248",
    "user": "https://github.com/dimpase"
}
```

Attachment [trac_10482-wlrefine.patch](tarball://root/attachments/some-uuid/ticket10482/trac_10482-wlrefine.patch) by @dimpase created at 2010-12-16 12:38:16

this  all works OK (on sage 4.6.1.alpha3);
what I do not know is whether GraphWL should be installed as a method for graphs.

Dima



---

archive/issue_comments_107249.json:
```json
{
    "body": "Sorry, didn't realize I should have marked this as \"needs review\".\n\nBy the way, something I wasn't able to figure out - why (with this patch applied) does `sage.graphs.wlrefine.sage` alias to `sage` (the top-level module)? Why does `sage.graphs.wlrefine.sage` even appear in the first place?",
    "created_at": "2010-12-23T10:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107249",
    "user": "https://github.com/kini"
}
```

Sorry, didn't realize I should have marked this as "needs review".

By the way, something I wasn't able to figure out - why (with this patch applied) does `sage.graphs.wlrefine.sage` alias to `sage` (the top-level module)? Why does `sage.graphs.wlrefine.sage` even appear in the first place?



---

archive/issue_comments_107250.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-23T10:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107250",
    "user": "https://github.com/kini"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_107251.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-02-02T06:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107251",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_107252.json:
```json
{
    "body": "Can we have a mildly interesting example in the doctest, i.e. refining which does not produce an orbital-induced refinement?\nThe smallest non-directed example like this is the [Shrikhande strongly regular graph](http://en.wikipedia.org/wiki/Shrikhande_graph) on 16 vertices; a the smallest directed example a certain tournament on 15 vertices.\n\nShrikhande graph is mentioned on #9136.\nMaybe you can contribute its Sage implementation along the way!",
    "created_at": "2011-02-02T06:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107252",
    "user": "https://github.com/dimpase"
}
```

Can we have a mildly interesting example in the doctest, i.e. refining which does not produce an orbital-induced refinement?
The smallest non-directed example like this is the [Shrikhande strongly regular graph](http://en.wikipedia.org/wiki/Shrikhande_graph) on 16 vertices; a the smallest directed example a certain tournament on 15 vertices.

Shrikhande graph is mentioned on #9136.
Maybe you can contribute its Sage implementation along the way!



---

archive/issue_comments_107253.json:
```json
{
    "body": "just a reminder that this must be fixed soon...",
    "created_at": "2011-05-18T21:32:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107253",
    "user": "https://github.com/dimpase"
}
```

just a reminder that this must be fixed soon...



---

archive/issue_comments_107254.json:
```json
{
    "body": "Sorry about that - I was planning to rebase on 4.7 after it comes out (as this is clearly not getting into Sage by then). Is that OK? If not I'll rebase on 4.7.rc2 (there have been some changes to the patch since I created this ticket).",
    "created_at": "2011-05-19T07:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107254",
    "user": "https://github.com/kini"
}
```

Sorry about that - I was planning to rebase on 4.7 after it comes out (as this is clearly not getting into Sage by then). Is that OK? If not I'll rebase on 4.7.rc2 (there have been some changes to the patch since I created this ticket).



---

archive/issue_comments_107255.json:
```json
{
    "body": "Replying to [comment:6 kini]:\n> Sorry about that - I was planning to rebase on 4.7 after it comes out (as this is clearly not getting into Sage by then). Is that OK? If not I'll rebase on 4.7.rc2 (there have been some changes to the patch since I created this ticket).\n\nit works on 4.7.rc1, I didn't check rc2.",
    "created_at": "2011-05-19T08:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107255",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:6 kini]:
> Sorry about that - I was planning to rebase on 4.7 after it comes out (as this is clearly not getting into Sage by then). Is that OK? If not I'll rebase on 4.7.rc2 (there have been some changes to the patch since I created this ticket).

it works on 4.7.rc1, I didn't check rc2.



---

archive/issue_comments_107256.json:
```json
{
    "body": "Attachment [wl-bug](tarball://root/attachments/some-uuid/ticket10482/wl-bug) by @dimpase created at 2011-05-25 11:33:57\n\n64x64 matrix with automorphisms (16 of them), which WL does not see - returns all the 64^2 colours",
    "created_at": "2011-05-25T11:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107256",
    "user": "https://github.com/dimpase"
}
```

Attachment [wl-bug](tarball://root/attachments/some-uuid/ticket10482/wl-bug) by @dimpase created at 2011-05-25 11:33:57

64x64 matrix with automorphisms (16 of them), which WL does not see - returns all the 64^2 colours



---

archive/issue_comments_107257.json:
```json
{
    "body": "I attached an example of 64x64 matrix with nontrivial automorphisms, which WL does not see, and colours every matrix entry in its own colour.",
    "created_at": "2011-05-25T11:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107257",
    "user": "https://github.com/dimpase"
}
```

I attached an example of 64x64 matrix with nontrivial automorphisms, which WL does not see, and colours every matrix entry in its own colour.



---

archive/issue_comments_107258.json:
```json
{
    "body": "an optimal canonical labellling algorithm is described here: http://www.automata.rwth-aachen.de/~grohe/pub/berbongro13.pdf\nIt runs in O((n+m)log n) time, with n, resp. m, being #of vertices (resp. edges). (that's not the problem on this ticket though, it's a coarser classification of vertices)",
    "created_at": "2013-08-08T20:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107258",
    "user": "https://github.com/dimpase"
}
```

an optimal canonical labellling algorithm is described here: http://www.automata.rwth-aachen.de/~grohe/pub/berbongro13.pdf
It runs in O((n+m)log n) time, with n, resp. m, being #of vertices (resp. edges). (that's not the problem on this ticket though, it's a coarser classification of vertices)



---

archive/issue_comments_107259.json:
```json
{
    "body": "rebased for Sage 5.12 (the bug not fixed...)",
    "created_at": "2013-10-13T22:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107259",
    "user": "https://github.com/dimpase"
}
```

rebased for Sage 5.12 (the bug not fixed...)



---

archive/issue_comments_107260.json:
```json
{
    "body": "Attachment [trac_10482-wlrefine_rebased.patch](tarball://root/attachments/some-uuid/ticket10482/trac_10482-wlrefine_rebased.patch) by @dimpase created at 2013-10-13 22:08:45",
    "created_at": "2013-10-13T22:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107260",
    "user": "https://github.com/dimpase"
}
```

Attachment [trac_10482-wlrefine_rebased.patch](tarball://root/attachments/some-uuid/ticket10482/trac_10482-wlrefine_rebased.patch) by @dimpase created at 2013-10-13 22:08:45



---

archive/issue_comments_107261.json:
```json
{
    "body": "I'm not sure what to do with this now. As I recall, I did try stepping carefully through the code back in 2011, and it was doing what I expected it to do, and as far as I could tell it also matched what's written in the paper I based the code on. Yet the answer is wrong for the `wl-bug` case.\n\nSo either the code doesn't do what I thought it did after all (certainly possible), or I misread the paper or other resources in some subtle way, or the algorithm in the paper is wrong in some subtle way (I wrote `STABIL.c` more or less completely based on the description of the algorithm in the paper and not on the original code, which *does* work on `wl-bug`). I'm not sure which of these is the case, and now I don't any longer remember the code I wrote or the contents of the paper well enough to try to find out which of these is the case.\n\nPerhaps at this point the better solution is to just use the old code (which is what you originally suggested in 2010). My code was supposed to allow for a wider variety of input and more memory usage than made sense back in the 80s, but all of that is worthless if the output is not correct... :(",
    "created_at": "2013-10-14T00:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107261",
    "user": "https://github.com/kini"
}
```

I'm not sure what to do with this now. As I recall, I did try stepping carefully through the code back in 2011, and it was doing what I expected it to do, and as far as I could tell it also matched what's written in the paper I based the code on. Yet the answer is wrong for the `wl-bug` case.

So either the code doesn't do what I thought it did after all (certainly possible), or I misread the paper or other resources in some subtle way, or the algorithm in the paper is wrong in some subtle way (I wrote `STABIL.c` more or less completely based on the description of the algorithm in the paper and not on the original code, which *does* work on `wl-bug`). I'm not sure which of these is the case, and now I don't any longer remember the code I wrote or the contents of the paper well enough to try to find out which of these is the case.

Perhaps at this point the better solution is to just use the old code (which is what you originally suggested in 2010). My code was supposed to allow for a wider variety of input and more memory usage than made sense back in the 80s, but all of that is worthless if the output is not correct... :(



---

archive/issue_comments_107262.json:
```json
{
    "body": "Replying to [comment:12 kini]:\n> I'm not sure what to do with this now. As I recall, I did try stepping carefully through the code back in 2011, and it was doing what I expected it to do, and as far as I could tell it also matched what's written in the paper I based the code on. Yet the answer is wrong for the `wl-bug` case.\n\nThe strategy for debugging is obvious: what happens, mathematically, is that a basis of 0-1 matrices for a matrix algebra is built incrementally. One just has to trace this carefully: at some point instead of creating a minimal 0-1 basis, the procedure breaks.\nThis might need a bit of extra code, allowing outputting the current basis in some \"dumb\" machine-readable form at any iteration. Then you can compare what happens in the implementation (it computes the product A_i A_j of two (presumed-)basis elements {A_k}, each of them represented as a linked list, and tries to decompose it into a Z-linear combination of the A_k's. When it fails, this means that it has to locate an A_k that needs to be spit into a number of 0-1 matrices, do this splitting, etc).",
    "created_at": "2013-10-14T07:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107262",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:12 kini]:
> I'm not sure what to do with this now. As I recall, I did try stepping carefully through the code back in 2011, and it was doing what I expected it to do, and as far as I could tell it also matched what's written in the paper I based the code on. Yet the answer is wrong for the `wl-bug` case.

The strategy for debugging is obvious: what happens, mathematically, is that a basis of 0-1 matrices for a matrix algebra is built incrementally. One just has to trace this carefully: at some point instead of creating a minimal 0-1 basis, the procedure breaks.
This might need a bit of extra code, allowing outputting the current basis in some "dumb" machine-readable form at any iteration. Then you can compare what happens in the implementation (it computes the product A_i A_j of two (presumed-)basis elements {A_k}, each of them represented as a linked list, and tries to decompose it into a Z-linear combination of the A_k's. When it fails, this means that it has to locate an A_k that needs to be spit into a number of 0-1 matrices, do this splitting, etc).



---

archive/issue_comments_107263.json:
```json
{
    "body": "By the way, what about `STABIL-tests.h`, mentioned in `STABIL.c`? Is it available anywhere?",
    "created_at": "2013-10-14T21:19:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107263",
    "user": "https://github.com/dimpase"
}
```

By the way, what about `STABIL-tests.h`, mentioned in `STABIL.c`? Is it available anywhere?



---

archive/issue_comments_107264.json:
```json
{
    "body": "There was at one point a repository containing this code and the original files from stabprogs.tgz. I think it was on www1.spms.ntu.edu.sg, but my directory there has been cleaned out by now... I found an old clone of it on banana just now, though. I put it up at http://github.com/kini/stabprogs and gave you access to it. I added a testing script, and formatted the wl-bug adjacency matrix like the other input files and added that too. `STABIL-tests.h` is there as well and as you can see, it does something like what you described in comment 13. Well, not that machine-readable, I suppose...",
    "created_at": "2013-10-14T22:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107264",
    "user": "https://github.com/kini"
}
```

There was at one point a repository containing this code and the original files from stabprogs.tgz. I think it was on www1.spms.ntu.edu.sg, but my directory there has been cleaned out by now... I found an old clone of it on banana just now, though. I put it up at http://github.com/kini/stabprogs and gave you access to it. I added a testing script, and formatted the wl-bug adjacency matrix like the other input files and added that too. `STABIL-tests.h` is there as well and as you can see, it does something like what you described in comment 13. Well, not that machine-readable, I suppose...



---

archive/issue_comments_107265.json:
```json
{
    "body": "Changing keywords from \"weisfeiler-leman algorithm, graphs, coherent configurations, refinement\" to \"weisfeiler-lehman algorithm, graphs, coherent configurations, refinement\".",
    "created_at": "2018-12-17T20:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107265",
    "user": "https://github.com/fchapoton"
}
```

Changing keywords from "weisfeiler-leman algorithm, graphs, coherent configurations, refinement" to "weisfeiler-lehman algorithm, graphs, coherent configurations, refinement".



---

archive/issue_comments_107266.json:
```json
{
    "body": "The bug is not going to be fixed by the author. This is superseded by #25802, with a much better implementation.",
    "created_at": "2018-12-18T16:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107266",
    "user": "https://github.com/dimpase"
}
```

The bug is not going to be fixed by the author. This is superseded by #25802, with a much better implementation.



---

archive/issue_comments_107267.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-12-18T16:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107267",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_107268.json:
```json
{
    "body": "Presuming these are all correctly reviewed as either duplicate, invalid, or wontfix.",
    "created_at": "2019-02-26T13:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107268",
    "user": "https://github.com/embray"
}
```

Presuming these are all correctly reviewed as either duplicate, invalid, or wontfix.



---

archive/issue_comments_107269.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2019-02-26T13:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10429#issuecomment-107269",
    "user": "https://github.com/embray"
}
```

Resolution: invalid



---

archive/issue_events_010555.json:
```json
{
    "actor": "@embray",
    "created_at": "2019-02-26T13:58:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10429",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10429#event-10555"
}
```
