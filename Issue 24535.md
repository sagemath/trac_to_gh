# Issue 24535: Encoding fixes to the doctest module

archive/issues_024535.json:
```json
{
    "body": "CC:  @embray\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24772\n\n",
    "created_at": "2018-02-19T10:00:17Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Encoding fixes to the doctest module",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24535",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @embray



Issue created by migration from https://trac.sagemath.org/ticket/24772





---

archive/issue_comments_343878.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343878",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_343879.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-02-19T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343879",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_343880.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-19T10:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343880",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343881.json:
```json
{
    "body": "About\n\n```diff\n+            if not isinstance(got, six.text_type):\n+                # On Python 3 got should already be unicode text, but on Python\n+                # 2 it is not.  For comparison's sake we want the unicode text\n+                # decoded from UTF-8. If there was some error such that the\n+                # output is so malformed that it does not even decode from\n+                # UTF-8 at all there will be an error in the test framework\n+                # here. But this shouldn't happen at all, so we want it to be\n+                # understood as an error in the test framework, and no some\n+                # subtle error in the code under test.\n+                got = got.decode(locale.getpreferredencoding())\n```\n\nIn the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?\n\nAlso a typo: \"no some\" -> \"not some\"",
    "created_at": "2018-02-19T10:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343881",
    "user": "https://github.com/jdemeyer"
}
```

About

```diff
+            if not isinstance(got, six.text_type):
+                # On Python 3 got should already be unicode text, but on Python
+                # 2 it is not.  For comparison's sake we want the unicode text
+                # decoded from UTF-8. If there was some error such that the
+                # output is so malformed that it does not even decode from
+                # UTF-8 at all there will be an error in the test framework
+                # here. But this shouldn't happen at all, so we want it to be
+                # understood as an error in the test framework, and no some
+                # subtle error in the code under test.
+                got = got.decode(locale.getpreferredencoding())
```

In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?

Also a typo: "no some" -> "not some"



---

archive/issue_comments_343882.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-19T13:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343882",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343883.json:
```json
{
    "body": "I fixed your typo and reorganized the branch but there still remains the issue of locale vs utf-8.",
    "created_at": "2018-02-19T13:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343883",
    "user": "https://github.com/jdemeyer"
}
```

I fixed your typo and reorganized the branch but there still remains the issue of locale vs utf-8.



---

archive/issue_comments_343884.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> About\n> {{{\n> #!diff\n> +            if not isinstance(got, six.text_type):\n> +                # On Python 3 got should already be unicode text, but on Python\n> +                # 2 it is not.  For comparison's sake we want the unicode text\n> +                # decoded from UTF-8. If there was some error such that the\n> +                # output is so malformed that it does not even decode from\n> +                # UTF-8 at all there will be an error in the test framework\n> +                # here. But this shouldn't happen at all, so we want it to be\n> +                # understood as an error in the test framework, and no some\n> +                # subtle error in the code under test.\n> +                got = got.decode(locale.getpreferredencoding())\n> }}}\n> In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?\n\nI think the use of \"UTF-8\" in the comment is an artifact--I'm using it as a placeholder for \"whatever the correct encoding is\".  But actually I need to investigate that a bit more carefully.  I think what this really ought to be is whatever encoding Python is using for `sys.stdout` but it may be more complicated than that.",
    "created_at": "2018-02-19T13:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343884",
    "user": "https://github.com/embray"
}
```

Replying to [comment:3 jdemeyer]:
> About
> {{{
> #!diff
> +            if not isinstance(got, six.text_type):
> +                # On Python 3 got should already be unicode text, but on Python
> +                # 2 it is not.  For comparison's sake we want the unicode text
> +                # decoded from UTF-8. If there was some error such that the
> +                # output is so malformed that it does not even decode from
> +                # UTF-8 at all there will be an error in the test framework
> +                # here. But this shouldn't happen at all, so we want it to be
> +                # understood as an error in the test framework, and no some
> +                # subtle error in the code under test.
> +                got = got.decode(locale.getpreferredencoding())
> }}}
> In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?

I think the use of "UTF-8" in the comment is an artifact--I'm using it as a placeholder for "whatever the correct encoding is".  But actually I need to investigate that a bit more carefully.  I think what this really ought to be is whatever encoding Python is using for `sys.stdout` but it may be more complicated than that.



---

archive/issue_comments_343885.json:
```json
{
    "body": "It seems some of the patchbots in fact, however they happen to be configured, are returning `'ascii'` for `locale.getpreferredencoding()`.  I'll just make it UTF-8 for now and we can revisit locale-specific encodings if it comes up.",
    "created_at": "2018-02-23T14:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343885",
    "user": "https://github.com/embray"
}
```

It seems some of the patchbots in fact, however they happen to be configured, are returning `'ascii'` for `locale.getpreferredencoding()`.  I'll just make it UTF-8 for now and we can revisit locale-specific encodings if it comes up.



---

archive/issue_comments_343886.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343886",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_343887.json:
```json
{
    "body": "I just based this off your branch and incorporated the change to `UTF-8`.  I think this should be good enough for now; it's not worth overthinking until there's a concrete reason to.  Tests look good with this change.\n\nSetting \"positive review\" assuming you agree.\n----\nNew commits:",
    "created_at": "2018-02-23T15:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343887",
    "user": "https://github.com/embray"
}
```

I just based this off your branch and incorporated the change to `UTF-8`.  I think this should be good enough for now; it's not worth overthinking until there's a concrete reason to.  Tests look good with this change.

Setting "positive review" assuming you agree.
----
New commits:



---

archive/issue_comments_343888.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> Setting \"positive review\" assuming you agree.\n\nThat was my only complaint, so yes I agree.",
    "created_at": "2018-02-23T15:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343888",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 embray]:
> Setting "positive review" assuming you agree.

That was my only complaint, so yes I agree.



---

archive/issue_comments_343889.json:
```json
{
    "body": "Reviewer name...",
    "created_at": "2018-02-25T00:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343889",
    "user": "https://github.com/vbraun"
}
```

Reviewer name...



---

archive/issue_comments_343890.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-02-25T00:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343890",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_343891.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-25T11:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343891",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_343892.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-26T23:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24535#issuecomment-343892",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_022911.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-02-26T23:58:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24535",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24535#event-22911"
}
```
