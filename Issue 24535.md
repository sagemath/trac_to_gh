# Issue 24535: Encoding fixes to the doctest module

Issue created by migration from https://trac.sagemath.org/ticket/24772

Original creator: jdemeyer

Original creation time: 2018-02-19 10:00:17

CC:  embray




---

Comment by jdemeyer created at 2018-02-19 10:02:22

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-19 10:02:22

New commits:


---

Comment by jdemeyer created at 2018-02-19 10:05:24

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-19 10:05:24

About

```diff
+            if not isinstance(got, six.text_type):
+                # On Python 3 got should already be unicode text, but on Python
+                # 2 it is not.  For comparison's sake we want the unicode text
+                # decoded from UTF-8. If there was some error such that the
+                # output is so malformed that it does not even decode from
+                # UTF-8 at all there will be an error in the test framework
+                # here. But this shouldn't happen at all, so we want it to be
+                # understood as an error in the test framework, and no some
+                # subtle error in the code under test.
+                got = got.decode(locale.getpreferredencoding())
```

In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?

Also a typo: "no some" -> "not some"


---

Comment by git created at 2018-02-19 13:03:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-19 13:04:00

I fixed your typo and reorganized the branch but there still remains the issue of locale vs utf-8.


---

Comment by embray created at 2018-02-19 13:15:59

Replying to [comment:3 jdemeyer]:
> About
> {{{
> #!diff
> +            if not isinstance(got, six.text_type):
> +                # On Python 3 got should already be unicode text, but on Python
> +                # 2 it is not.  For comparison's sake we want the unicode text
> +                # decoded from UTF-8. If there was some error such that the
> +                # output is so malformed that it does not even decode from
> +                # UTF-8 at all there will be an error in the test framework
> +                # here. But this shouldn't happen at all, so we want it to be
> +                # understood as an error in the test framework, and no some
> +                # subtle error in the code under test.
> +                got = got.decode(locale.getpreferredencoding())
> }}}
> In the comment you are talking about UTF-8 but you actually decode using the locale. Wouldn't UTF-8 make the most sense here?

I think the use of "UTF-8" in the comment is an artifact--I'm using it as a placeholder for "whatever the correct encoding is".  But actually I need to investigate that a bit more carefully.  I think what this really ought to be is whatever encoding Python is using for `sys.stdout` but it may be more complicated than that.


---

Comment by embray created at 2018-02-23 14:56:32

It seems some of the patchbots in fact, however they happen to be configured, are returning `'ascii'` for `locale.getpreferredencoding()`.  I'll just make it UTF-8 for now and we can revisit locale-specific encodings if it comes up.


---

Comment by embray created at 2018-02-23 15:05:28

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-02-23 15:05:28

I just based this off your branch and incorporated the change to `UTF-8`.  I think this should be good enough for now; it's not worth overthinking until there's a concrete reason to.  Tests look good with this change.

Setting "positive review" assuming you agree.
----
New commits:


---

Comment by jdemeyer created at 2018-02-23 15:11:52

Replying to [comment:8 embray]:
> Setting "positive review" assuming you agree.

That was my only complaint, so yes I agree.


---

Comment by vbraun created at 2018-02-25 00:58:11

Reviewer name...


---

Comment by vbraun created at 2018-02-25 00:58:11

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2018-02-25 11:11:13

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-02-26 23:58:14

Resolution: fixed
