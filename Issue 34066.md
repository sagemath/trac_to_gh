# Issue 34066: √élu algorithm: asymptotically faster elliptic-curve isogenies

Issue created by migration from https://trac.sagemath.org/ticket/34303

Original creator: lorenz

Original creation time: 2022-08-08 10:19:09

CC:  defeo cremona wuthrich bensmith tanja tscrim vdelecroix slelievre klee

Sage currently computes an isogeny of prime degree `ℓ` using `ϴ(ℓ)` base-field operations. We can achieve the same task in `Õ(√ℓ)` operations using the **√élu algorithm**; see https://velusqrt.isogeny.org.


---

Comment by lorenz created at 2022-08-08 10:25:32

Changing status from new to needs_review.


---

Comment by cremona created at 2022-08-10 13:51:30

I have a question: although I know that the application of greatest interest involves curves over finite fields, I assume that the faster algorithm also works in characteristic 0, so that isogenies between curves defined over number fields will also be affected by this? I hope so.


---

Comment by lorenz created at 2022-08-16 16:06:57

That's a good question. The √élu speedup works best if you have an actual rational kernel point as input, which requires big field extensions for large isogeny degrees over number fields. There is a variant of the algorithm for rational kernels made up of irrational points, but the speedup is smaller in that case.

Do you have an application in mind? Which field and isogeny degree, and how is the input given? It shouldn't be hard to make this work for number fields, but I'm not sure if it helps at all, which is why I restricted the current implementation to finite fields.


---

Comment by lorenz created at 2022-08-18 17:35:18

I was hoping we could get this into the upcoming release so that other people can play around with it. This is opt-in and marked as experimental, so a minimum viable review basically consists of checking that it doesn't do any harm. Could someone please spare a few minutes to have a look?


---

Comment by cremona created at 2022-08-18 18:02:46

Replying to [comment:3 lorenz]:
> That's a good question. The √élu speedup works best if you have an actual rational kernel point as input, which requires big field extensions for large isogeny degrees over number fields. There is a variant of the algorithm for rational kernels made up of irrational points, but the speedup is smaller in that case.
> 
> Do you have an application in mind? Which field and isogeny degree, and how is the input given? It shouldn't be hard to make this work for number fields, but I'm not sure if it helps at all, which is why I restricted the current implementation to finite fields.

The isogenies I compute are mostly over number fields and of small prime degree ell, where "small" mostly means <50.  And for most of these ell, I have implemented special code for them (which works over finte fields too, except characteristic ell).  As for the input, it's just the curve and ell and I need all the ell-isogenous curves;  there are easy necessary conditions for an ell-isogeny to exist so I would rarely try to compute one when it does not exist.


---

Comment by cremona created at 2022-08-18 18:03:10

Replying to [comment:4 lorenz]:
> I was hoping we could get this into the upcoming release so that other people can play around with it. This is opt-in and marked as experimental, so a minimum viable review basically consists of checking that it doesn't do any harm. Could someone please spare a few minutes to have a look?

I had a first look, and will come back to it tomorrow.


---

Comment by cremona created at 2022-08-19 10:34:06

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2022-08-19 10:34:06

Here are some comments made as I read the code, so not in order of importance.  Point 4 about documenting parameters is the most important -- otherwise docstrings, examples ans tests are very good.

   1. Instead of 

```
    sage: sum(iso(psiQ) == phiQ for iso in isos)
    1
```

I would suggest

```
    sage: any(iso(psiQ) == phiQ for iso in isos)
    True
```


   2. There's a comment which says that the code works on "short Weierstrass curves", so I assume that menas that the characteristic should not be 2 (and perhaps also not 3).  This should probably be stated at the top of the file `hom_velusqrt.py`.  I haven't yet checked whether this condition is checked in the code.

   3. I see the comment about this implementation only being over finite fields.  I think that is fine, given that isogenies of high degree over number fields are rarely encountered (since the field would have to have high degree over `QQ`), as I said in an earlier comment.

   4. Methods' docstrings should have an INPUT block documenting all parameters (apart from `self`), for example the `_init_` method, of ProductTree and more (not itemised here!).

I see that the code here is not called from elsewhere -- in particular, not called by default by isogeny methods of elliptic curve classes -- so is certainly harmless to include.


---

Comment by git created at 2022-08-21 02:24:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-08-21 02:42:07

Thank you for the comments! I added `INPUT:` blocks to (I believe) all functions that need them.

I also made comparison work using the same code as for composite isogenies (by reducing to evaluation), and added a (purely opt-in) call path from the `.isogeny()` method for elliptic curves so that it's easy to use the new algorithm without typing long import statements.

About your other remarks:

1. `sum(...) == 1` is a stronger statement than `any(...)`, which is why I wrote it this way: The former checks unique existence, the latter just existence.

2. The implementation does work for some curves in characteristic 3, but not all of them. In the code, it simply tries converting the curve to short Weierstraß form and throws an exception if that fails. This is slightly more general than checking the characteristic.

3. Indeed, the situation over number fields mentioned in comment:5:ticket:34303 does not seem like it would benefit from this. Should it turn out that there's something we can do after all, this can of course be taken care of at a later time.


---

Comment by lorenz created at 2022-08-21 02:42:07

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-08-21 23:50:50

Replying to [comment:7 cremona]:
>    4. Methods' docstrings should have an INPUT block documenting all parameters (apart from `self`), for example the `_init_` method, of ProductTree and more (not itemised here!).

One comment on this: To make it more publicly visible, it can be useful to have the inputs for `__init__` to be at the class-level documentation and not (repeated) at the method-level since it does not appear in the docstrings. However, this is mostly a suggestion when you expect the user to directly call the class to build the object (rather than, e.g., an element of a parent which is through the parent's `_element_constructor_`).

One additional comment to John's, the `INPUT:` items should always be in code format, e.g.:

```diff
     INPUT:
 
-    - `n` -- odd integer `\geq 5`
+    - ``n`` -- odd integer `\geq 5`
```


In `_choose_IJK`, it would also be good to specify that this needs to be an `:class:`Integer`` otherwise the method will break. In fact, since you are just wanting the integer part, you could do

```python
(n-1).sqrtrem()[0] // 2
```

As a general programming note, I prefer to avoid similar variable names, such as `b` and `b_`. It is too easy to make a mistake with them.


---

Comment by git created at 2022-08-22 06:38:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-08-22 06:39:40

Thanks! All done.


---

Comment by cremona created at 2022-08-22 08:14:16

Thanks for making all these changes, and answering my comments.   I am happy with this, so if Travis is too he can add his name to the reviewers list and set it to "positive review".


---

Comment by tscrim created at 2022-08-22 08:29:04

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-08-22 08:29:04

Good with me too.


---

Comment by klee created at 2022-08-22 08:33:32

Sorry for being late. Let me have some time to write a comment and a question.


---

Comment by klee created at 2022-08-22 08:33:32

Changing status from positive_review to needs_work.


---

Comment by klee created at 2022-08-22 08:51:11

One minor comment

- You added a new option `short_weierstrass` to `compute_model`, but did not put it in `INPUT` section.

And one question. You added this 

```
.. WARNING::

    This module is currently considered experimental.
    It may change in a future release without prior warning.        
```

In what sense is this experimental? What change do you mean? (1) bug fixes (2) wrong result (3) performance improvement, or (4) removal?

I guess you mean only (3). In that case, you don't need to tag it as experimental. Any part of code in sage can be improved later without "prior warning". If this is the case, then I suggest to remove those scary "experimental" warnings.

If you mean (4), what is the condition of removal?


---

Comment by tscrim created at 2022-08-22 08:52:33

You have 2 (2)'s leading to a non-bijective map. `;)`


---

Comment by cremona created at 2022-08-22 10:41:34

Kwankyu Lee's question is a good one, and I agree that there is no need for such a tag, unless you really think that this code is likely to give incorrect answers.  If that was the case, it would be better not to allow it as an option visible from the elliptic curve class.  Otherwise, if it was one day removed you would have to give deprecation warnings etc.  If you believe the code to be correct (as I hope you do!) then you can just delete the warning.


---

Comment by git created at 2022-08-22 10:55:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-08-22 11:10:18

Thanks, done! I've also created #34409, which (inspired by your comments here) suggests to remove the experimental warning for composite elliptic-curve isogenies.


---

Comment by lorenz created at 2022-08-22 11:10:18

Changing status from needs_work to needs_review.


---

Comment by klee created at 2022-08-22 11:22:40

Replying to [comment:17 tscrim]:
> You have 2 (2)'s leading to a non-bijective map. `;)`

Fixed. Thanks. It was awful.


---

Comment by klee created at 2022-08-22 11:41:31

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-08-22 11:41:31

Replying to [comment:20 lorenz]:
> Thanks, done! I've also created #34409, which (inspired by your comments here) suggests to remove the experimental warning for composite elliptic-curve isogenies.

Thank you. It was perhaps your being modest. But Sage should always deliver reliable code, and I think we should avoid including experimental code in Sage.


---

Comment by lorenz created at 2022-08-22 13:58:17

Thanks a lot everyone!

(Indeed, I'm reasonably convinced that the code is correct. I added the experimental warning not because I feared things were broken, but because it'd make it easier to tweak the API later. Presumably though, this won't be necessary anyway.)


---

Comment by vbraun created at 2022-08-30 06:51:36

Resolution: fixed


---

Comment by arojas created at 2022-08-31 15:25:24

Got a test failure with a specific random seed

```
sage -t --long --random-seed=66297844331759291946775140613791774160 /usr/lib/python3.10/site-packages/sage/schemes/elliptic_curves/hom_velusqrt.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/schemes/elliptic_curves/hom_velusqrt.py", line 829, in sage.schemes.elliptic_curves.hom_velusqrt.EllipticCurveHom_velusqrt
Failed example:
    any(map(check, psi.codomain().isomorphisms(phi.codomain())))
Expected:
    True
Got:
    False
**********************************************************************
```



---

Comment by chapoton created at 2022-08-31 19:06:41

and the linter now requires a blank line before nested definitions


---

Comment by lorenz created at 2022-09-01 07:14:54

Thanks both of you. See #34467 and #34466.
