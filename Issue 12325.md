# Issue 12325: GeneralDiscreteDistribution can segv sage

Issue created by migration from Trac.

Original creator: ppurka

Original creation time: 2012-02-11 14:56:23

Assignee: amhou

CC:  kcrisman

Keywords: segfault GeneralDiscreteDistribution

Running the following segfaults sage.

```
GeneralDiscreteDistribution([0.1, -0.1]).get_random_element()
```

If you run it on a notebook then it segfaults sage silently in the background with no feedback to the nb.

```
~/tmp> snd a.sagenb
----------------------------------------------------------------------
----------------------------------------------------------------------
| Sage Version 4.7.2, Release Date: 2011-10-29                       |
| Type notebook() for the GUI, and license() for information.        |
Please wait while the Sage Notebook server starts...
...
notebook(directory=r*a.sagenb*)
The notebook files are stored in: a.sagenb
**************************************************
*                                                *
* Open your web browser to http://localhost:8080 *
*                                                *
**************************************************
2012-02-11 22:11:00+0800 [-] Log opened.
2012-02-11 22:11:00+0800 [-] twistd 11.1.0 (/home/punarbasu/Installations/sage-4.8/local/bin/python 2.6.4) starting up.
2012-02-11 22:11:00+0800 [-] reactor class: twisted.internet.pollreactor.PollReactor.
2012-02-11 22:11:00+0800 [-] QuietSite starting on 8080
2012-02-11 22:11:00+0800 [-] Starting factory <__builtin__.QuietSite instance at 0x4c86e18>
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] got EOF subprocess must have crashed...
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libcsage.so(print_backtrace+0x31)[0x7f6d900db9f1]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libcsage.so(sigdie+0x14)[0x7f6d900dba23]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libcsage.so(sage_signal_handler+0x20e)[0x7f6d900db670]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /lib64/libpthread.so.0[0x38630102e0]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libgsl.so.0(gsl_ran_discrete+0xe)[0x7f6d8a0bb82e]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/python2.6/site-packages/sage/gsl/probability_distribution.so(+0x6201)[0x7f6d6a8ad201]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4d68)[0x7f6d92ba5488]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x8ac)[0x7f6d92ba707c]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCode+0x32)[0x7f6d92ba7152]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x5392)[0x7f6d92ba5ab2]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x8ac)[0x7f6d92ba707c]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCode+0x32)[0x7f6d92ba7152]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyRun_FileExFlags+0xb0)[0x7f6d92bc8d80]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(+0xe3dde)[0x7f6d92b9ddde]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4ecc)[0x7f6d92ba55ec]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x8ac)[0x7f6d92ba707c]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCode+0x32)[0x7f6d92ba7152]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x5392)[0x7f6d92ba5ab2]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x8ac)[0x7f6d92ba707c]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCode+0x32)[0x7f6d92ba7152]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyRun_FileExFlags+0xb0)[0x7f6d92bc8d80]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(+0xe3dde)[0x7f6d92b9ddde]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4ecc)[0x7f6d92ba55ec]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x8ac)[0x7f6d92ba707c]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyEval_EvalCode+0x32)[0x7f6d92ba7152]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyRun_InteractiveOneFlags+0x182)[0x7f6d92bc9bf2]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyRun_InteractiveLoopFlags+0x4e)[0x7f6d92bc9dee]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(PyRun_AnyFileExFlags+0x4c)[0x7f6d92bca42c]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/lib/libpython2.6.so.1.0(Py_Main+0xb65)[0x7f6d92bd8665]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /lib64/libc.so.6(__libc_start_main+0xfd)[0x386242209d]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] /home/punarbasu/Installations/sage-4.8/local/bin/python[0x4006e9]
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] 
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] ------------------------------------------------------------------------
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] Unhandled SIGSEGV: A segmentation fault occurred in Sage.
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] This probably occurred because a *compiled* component of Sage has a bug
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] in it and is not properly wrapped with sig_on(), sig_off(). You might
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] want to run Sage under gdb with 'sage -gdb' to debug this.
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] Sage will now terminate.
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] ------------------------------------------------------------------------
2012-02-11 22:15:56+0800 [HTTPChannel,17,127.0.0.1] 
```

This type of invalid input should be caught and an appropriate error given to the user.

----


---

Comment by ppurka created at 2012-02-11 15:00:12

Apply to devel/sage


---

Attachment


---

Comment by ppurka created at 2012-02-11 15:01:22

Changing status from new to needs_review.


---

Comment by dsm created at 2012-02-13 02:38:04

Applies cleanly to 4.8 on ubuntu 11.04; has a doctest; prevents the segfault in a clean way with a good explanation to the user of the mistake.


---

Attachment

Apply to devel/sage of sage-5*


---

Comment by ppurka created at 2012-03-02 11:31:02

Updated patch so that it applies to sage-5.0beta2.


---

Comment by davidloeffler created at 2012-03-26 12:46:36

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2012-03-26 12:46:36

This is conflicting with something (see patchbot logs) -- I suspect #9770.


---

Comment by ppurka created at 2012-03-26 13:02:05

Apply only this to sage-5.0beta10


---

Attachment

Replying to [comment:7 davidloeffler]:
> This is conflicting with something (see patchbot logs) -- I suspect #9770.

Sigh. I thought I had rebased to recent enough beta. Updated another rebased patch.


---

Comment by ppurka created at 2012-03-26 13:04:03

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2012-03-26 13:45:56

Changing priority from major to critical.


---

Comment by davidloeffler created at 2012-03-26 13:45:56

Looks fine and passes doctests. Positive review. There used to be a rule that patches should have the ticket number in the commit message, but I think Jeroen's new merge script now puts it in automatically. I'm moving the priority up to "critical" -- I think any known bug that allows Sage notebook servers to be remotely crashed at will is pretty critical.


---

Comment by davidloeffler created at 2012-03-26 13:45:56

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-26 21:30:30

Replying to [comment:10 davidloeffler]:
> I think any known bug that allows Sage notebook servers to be remotely crashed at will is pretty critical.
This doesn't crash the notebook _server_, only the running _worksheet_.


---

Comment by jdemeyer created at 2012-03-28 10:05:12

Resolution: fixed
