# Issue 19953: Upgrade R to 3.2.4

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2016-03-11 07:54:18

CC:  leif jdemeyer vbraun

Keywords: r-project

It's this time of the year again...

Original tarball is here : [https://cran.r-project.org/src/base/R-3/R-3.2.4.tar.gz](https://cran.r-project.org/src/base/R-3/R-3.2.4.tar.gz)


---

Comment by charpent created at 2016-03-11 07:55:19

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by charpent created at 2016-03-11 08:51:34

Passes ptestlong with no error nor glitch ==> `needs_review`


---

Comment by charpent created at 2016-03-11 08:51:34

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-03-12 09:14:47

Changing status from needs_review to needs_work.


---

Attachment

I could not build it on Ubuntu 14.04 LTS by applying this on top of `7.1.rc0` and running `make build`. Log is attached.

My guess is it is related to the fuzz from applying the patches.


---

Comment by tscrim created at 2016-03-12 12:52:09

From building old versions of R, those logs say the command should be `rm -f liblzma.a` (which it what I was thinking it should be). I suspect it has to do with the `dont_lose_libz_libbz2_in_configure.patch`, but I'm not sure what to look for. Do one of you know what needs to be done (and do you also get a build failure)?


---

Comment by charpent created at 2016-03-12 13:07:51

Works for me on Debian (three instances of testing/amd64 w. 6, 7 and 16 Gb RAM : 7 Gb seems the bare acceptable minimum to install/run rstan under R (The 6 Gb machine starts to swap/trash on this one...)

I'll have a look tonight (maybe tomorrow), but on a smallish machine (Ubuntu 15.10/amd64) not well suited to debuging sage (4 GB RAM...).

HTH,


---

Comment by tscrim created at 2016-03-13 11:13:50

FYI - I just did a `make distclean && make build` (with `SAGE_NUM_THREADS=8` and `MAKE='make -j8'`) and I got the same problem.


---

Comment by charpent created at 2016-03-13 17:50:26

Compilation log on my (charpent's) machine


---

Attachment

Compilation on my machine(s) does not follow the same path as on yours. My compilation never reaches the point where yours goes.

I do not (yet) understand qwhy. Different installed software ?

HTH,


---

Comment by tscrim created at 2016-03-13 23:56:06

I believe it has to do with `(lib)lzma` being present on the system (FYI, I have a Core i7). In particular, your log has

```
checking for lzma_version_number in -llzma... yes
```

whereas my in `no`. So it probably has to do with `dont_lose_libz_libbz2_in_configure.patch` and changes in the configure script for R (there was similar fuzz when building `R-3.2.3.p1` on my machine as well).

Although I have no idea what to look for on how to fix this, but perhaps this will allow you to reproduce my build error?


---

Comment by tscrim created at 2016-03-22 03:01:54

Were you able to reproduce the build failure?


---

Comment by charpent created at 2016-04-01 12:59:23

**Eureka ! ** (maybe...)

Sorry for the delay : my schedule is a little bit busy nowadays...

I found this :


```
charpent`@`SAP5057241:~/Temporaire/DemeRde$ diff -ur R-3.2.3/src/extra/xz R-3.2.4/src/extra/xz
diff -ur R-3.2.3/src/extra/xz/Makefile.in R-3.2.4/src/extra/xz/Makefile.in
--- R-3.2.3/src/extra/xz/Makefile.in	2010-11-09 00:05:05.000000000 +0100
+++ R-3.2.4/src/extra/xz/Makefile.in	2015-12-11 00:15:12.000000000 +0100
`@``@` -58,8 +58,8 `@``@`
 	touch stamp
 
 liblzma.a: $(liblzma_a_OBJECTS)
-	rm -f $`@`
-	$(AR) cr $`@` $(liblzma_a_OBJECTS)
+	$rm -f $`@`
+	$(AR) -cr $`@` $(liblzma_a_OBJECTS)
 	$(RANLIB) $`@`
 
 mostlyclean: clean
```


I'll ask around in the R mailing list to know what was intended by this (highly suspicious) change.

Do you want an (interim) patch to revert it ?


---

Comment by charpent created at 2016-04-01 14:44:01

Replying to myself :

This is indeed an upstream bug. See the `r-devel` thread starting at [this posting](https://stat.ethz.ch/pipermail/r-devel/2016-March/072447.html) : it's ultimately a Makefile typo.

However, this thread [says](https://stat.ethz.ch/pipermail/r-devel/2016-March/072449.html) that :

> Notice that in 3.3.x, the included xz & al. will disappear.

This might mean that the prerequisites for `R` may change at 3.3.0 time (which was announced to take place on 2016-04-11 last time I looked...).

Furthermore, `r-devel` also had this announcement (that I missed) :

> The 3.2.4 release had two annoyances which we would rather not have in an "ultra-stable" release, designed to hang around for the duration of the 3.3 series. One was a relatively minor Makefile issue affecting system using R's bundled lzma library. The other, rather more serious, affected printing and formatting of POSIXlt objects, which would unpredictably get the Daylight Savings Time wrong.

A new tarball fixing this issue in 3.2.4 (+ another relevant to Posix time printing) has been released as [http://cran.r-project.org/src/base/R-3/R-3.2.4-revised.tar.gz](http://cran.r-project.org/src/base/R-3/R-3.2.4-revised.tar.gz).

So it seems to me that the best "interim" solution is :
* to get the "revised" tarball from CRAN
* to document its renaming in `spkg-src`

and to revise the whole situation at R 3.3.0 release.

Unless I hear contrary opinions before Sun April 3, 2016, I'll do that (and also fix the patches fuzz, which is not incorrect but unaesthetic...).

Your opinions/advice urgently required...


---

Comment by jdemeyer created at 2016-04-01 14:53:49

Replying to [comment:12 charpent]:
> * to document its renaming in `spkg-src`

Which renaming?


---

Comment by charpent created at 2016-04-01 14:56:30

Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 charpent]:
> > * to document its renaming in `spkg-src`
> 
> Which renaming?

R-3.2.4-revised.tar.gz ==> R-3.2.4.tar.gz


---

Comment by jdemeyer created at 2016-04-01 15:00:22

-1 to renaming it. I know that 3.2.4-revised is a really silly version number, but that's what upstream chose, so Sage should just use that.

By the way, I wonder why upstream didn't just name it version 3.2.5.


---

Comment by charpent created at 2016-04-01 15:03:17

Replying to [comment:15 jdemeyer]:
> -1 to renaming it. I know that 3.2.4-revised is a really silly version number, but that's what upstream chose, so Sage should just use that.

Okay (unless I hear other opinions by Sunday). But that's really silly...

> By the way, I wonder why upstream didn't just name it version 3.2.5.

//De gustibus coloribusque...//


---

Comment by tscrim created at 2016-04-02 13:58:51

My 2 cents are with Jeroen, let us try and keep it as close to upstream as we can.


---

Comment by charpent created at 2016-04-04 09:18:18

I'm wondering how to do this : upstream has adopted a curious name for this release ; furthermore, it has done it inconsistently :

* the tarball is named `R-3.2.4-revised`, but
* the source tree is named `R-revised`.

Sage's build system chokes on this ; short of renaming the tarball and/or rebuilding it with a sensible source tree name, I don't see how to get Sage's building system accept this.

We can either :

* rename/rebuild this tarball consistently //via// spkg-src, or
* skip this one-week wonder entierely (last time I looked, R 3.3.0 was scheduled in Apr 11, 2016).

Your thoughts ?


---

Comment by jdemeyer created at 2016-04-04 09:22:09

Replying to [comment:18 charpent]:
> Sage's build system chokes on this
Can you be more specific?


---

Comment by charpent created at 2016-04-04 09:32:42

Replying to [comment:19 jdemeyer]:
> Replying to [comment:18 charpent]:
> > Sage's build system chokes on this
> Can you be more specific?

At the start of the package build log, I see that the script tries to `mv` to the source tree, but fails to stat it (the script nevertheless continues and fails other steps such as patching and `MAKE`ing it.


---

Comment by jdemeyer created at 2016-04-04 09:37:04

Replying to [comment:20 charpent]:
> At the start of the package build log, I see that the script tries to `mv` to the source tree, but fails to stat it

Full log please.


---

Comment by charpent created at 2016-04-04 09:47:00

Replying to [comment:21 jdemeyer]:
 
> Full log please.

This will have to wait : I'm not on my development machine, and have ti reproduce it on a (much slower) work machine...


---

Comment by charpent created at 2016-04-04 10:36:34

(Unsuccessfull) compilation log of the "revised" package


---

Attachment

As requested, log added.

HTH,


---

Comment by jdemeyer created at 2016-04-04 11:05:14

Easy fix: replace the `cd src` in `spkg-install` by the correct directory name.


---

Comment by charpent created at 2016-04-04 12:04:55

Replying to [comment:24 jdemeyer]:
> Easy fix: replace the `cd src` in `spkg-install` by the correct directory name.

Nope : `src` is a subdirectory of the source tree. The point is that the source tree name is nowhere to be seen in `spkg-install` : the current Sage building architecture is supposed to create a build directory for that.

It currently fails to do this in a useable way (see the top of the log).


---

Comment by jdemeyer created at 2016-04-04 13:05:40

Replying to [comment:25 charpent]:
> Replying to [comment:24 jdemeyer]:
> > Easy fix: replace the `cd src` in `spkg-install` by the correct directory name.
> 
> Nope : `src` is a subdirectory of the source tree. The point is that the source tree name is nowhere to be seen in `spkg-install` : the current Sage building architecture is supposed to create a build directory for that.

Nobody is forcing the directory to be called `src`. Like I said: just replace the `cd src` in `spkg-install` by the correct directory name and it will work.


---

Comment by tscrim created at 2016-04-04 15:11:21

How much work do you think it will be to upgrade to 3.3.0? If you think it will take some work/time, then we should push this in. Otherwise, I am okay with waiting another week or so.


---

Comment by charpent created at 2016-04-04 21:15:41

Replying to [comment:26 jdemeyer]:
> Replying to [comment:25 charpent]:
> > Replying to [comment:24 jdemeyer]:
> > > Easy fix: replace the `cd src` in `spkg-install` by the correct directory name.
> > 
> > Nope : `src` is a subdirectory of the source tree. The point is that the source tree name is nowhere to be seen in `spkg-install` : the current Sage building architecture is supposed to create a build directory for that.
> 
> Nobody is forcing the directory to be called `src`. Like I said: just replace the `cd src` in `spkg-install` by the correct directory name and it will work.

Nope : the error at the top of the log happens **before** the start of `spkg-install`. `spkg-install` **cannot** intercept it.

And, again, the `src` names designates the directory `src` of the source tree (which should be called `R-3.2.4-revised` and **not** `R-revised`), and **not** the source tree itself.

I tried :
* changing `cd src` to `cd R-revised/src`
* adding (at the top of `spkg-src`) `ln -s R-revised R-3.2.4-revised`
to no avail.

The only way out I'm able to see would be to document in `spkg-src` :
* untar `R-3.2.4-revised.tar.gz`
* in the resulting tree, `mv R-revised R-3.2.4-revised`
* retar the resulting tree

Do you **really** want that ?


---

Comment by charpent created at 2016-04-04 21:19:10

Replying to [comment:27 tscrim]:
> How much work do you think it will be to upgrade to 3.3.0? If you think it will take some work/time, then we should push this in. Otherwise, I am okay with waiting another week or so.

I do not know the Sage build system well enough to understand what is really needed to fix it. Short of fixing the (inconsistent) source tree, I see no way.

Since R.3.3.0 release (which may entail significant work) is less tan one week away, I'm a bit reluctant to produce a patch that will become irrelevant so soon...


---

Comment by jdemeyer created at 2016-04-04 21:27:53

Replying to [comment:28 charpent]:
> * changing `cd src` to `cd R-revised/src`

You should change `cd src` to `cd R-revised` (or whatever the name is of the top-level directory in the R tarball).


---

Comment by git created at 2016-04-05 07:12:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2016-04-05 07:15:26

I do not (yet)understand how this works, but it worked.

Passes ptestlong with no error nor glitches ==> `needs_review`


---

Comment by charpent created at 2016-04-05 07:15:26

Changing priority from major to minor.


---

Comment by charpent created at 2016-04-05 07:15:26

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-04-05 15:27:41

Ditto. Thanks.


---

Comment by tscrim created at 2016-04-05 15:27:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-04-05 20:19:51

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-04-05 20:19:51


```
Successfully installed r-3.2.4-revised.p0
Running the test suite for r-3.2.4-revised.p0...
./spkg-check: line 8: cd: src: No such file or directory
make[3]: Entering directory '/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/r-3.2.4-revised.p0'
make[3]: *** No rule to make target 'check'.
make[3]: Leaving directory '/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/r-3.2.4-revised.p0'
Error while running the R testsuite ... exiting
```



---

Attachment

Log of a successfull compilation without testing.


---

Comment by git created at 2016-04-05 22:20:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2016-04-05 22:27:26

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2016-04-05 22:27:26

Replying to [comment:34 vbraun]:

Damn ! I forgot even the existence of this...

> {{{
> Successfully installed r-3.2.4-revised.p0
> Running the test suite for r-3.2.4-revised.p0...
> ./spkg-check: line 8: cd: src: No such file or directory
> make[3]: Entering directory '/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/r-3.2.4-revised.p0'
> make[3]: *** No rule to make target 'check'.
> make[3]: Leaving directory '/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/r-3.2.4-revised.p0'
> Error while running the R testsuite ... exiting
> }}}

Huh ! I think that the fix is as trivial (and as mysterious) as the preceding one.

I tried it, but I can't seemingly test it. Whereas in my "develop" (7.2beta2 IIRC) setup, testing (of the current R-3.2.3) goes well, it does not start in this branch, which is based on 7.1rc0 :

After `SAGE_CHECK_PACKAGES="yes" ./sage -f -c r`, the build system rebuilds the packages, and says it has been built successfully. It does **NOT** attempt to test anything, nor does give an error (see uploaded log).

Nevertheless, I pushed the resulting patch (since it lo longer raises an error in the test suite...) and positioned `needs_review`. Feel free to send me to hell if you think that this cover-up is not acceptable.


---

Comment by jdemeyer created at 2016-04-06 14:38:42

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-04-06 14:38:42

It's running the test suite for me, not sure what you did wrong...


---

Comment by vbraun created at 2016-04-08 22:40:22

Resolution: fixed
