# Issue 11980: Maxima fails to properly convert some floats to rationals

Issue created by migration from Trac.

Original creator: ddrake

Original creation time: 2011-12-14 00:56:29

Assignee: burcin

CC:  kcrisman

Keywords: maxima keepfloat integration

From https://groups.google.com/d/topic/sage-devel/JZ54xk51F-E/discussion :

```
sage: a, b, t = var('a b t')
sage: f(a,b,t) = sin(t)^2/(a + b*cos(t))^2
sage: integrate(f(3/2,1,t), (t,0,2*pi))
-2/5*(sqrt(5) - 3)*pi*sqrt(5)
```

Works properly, but:

```
sage: integrate(f(1.5,1,t), (t,0,2*pi))
```

blows up with 

```
RuntimeError: ECL says: Error executing code in Maxima: CRECIP:
attempted inverse of zero (mod 3)
```

From the discussion there, this seems to be related to Maxima's attempts to convert floats to rationals, and that Sage turns off such conversion with `keepfloat:true`.


---

Comment by kcrisman created at 2011-12-14 02:39:54

See the thread above for some additional discussion, in particular about whether to not consider this a bug, and whether one should just disallow integrals with decimal points.


---

Comment by kcrisman created at 2012-11-29 15:40:49

Here we go - another such report.

```

(%i1) keepfloat:true;
(%o1)                                true
(%i2) integrate(exp(-5.3*x),x,0,1);

Maxima encountered a Lisp error:

 Argument V is not a INTEGER: 1.0

Automatically continuing.
```

Based on [this ask.sagemath.org post](http://ask.sagemath.org/question/2028/def-fx-evaluvates-individually-but-not-inside-plot).

I've reported several similar things upstream at [this Maxima bug](https://sourceforge.net/p/maxima/bugs/2510/).


---

Comment by kcrisman created at 2012-11-29 16:41:14

Interestingly, we never considered the following from an old sage-devel conversation.

```
No, it means that you have not noticed the value set for ratepsilon,
which governs the tolerance
for conversion of floats to rationals.  It is by default set to
2.0e-8, presumably for "single float"
systems.  It should probably be set to something more like 10e-16 for
double float systems.

Ah, that is very helpful.  In this case the numerical approximations
do indeed agree up to the output of n().  Perhaps we could potentially
go back to keepfloat:false but with whatever the standard precision in
Sage would equate to - Jason, would that help things with matrices?
```

This would probably keep a lot of problems away, especially since, as Nils says elsewhere, floats and symbolic integrals don't really mix.

Anyway, see also https://sourceforge.net/p/maxima/bugs/2510/#fd1d
