# Issue 11980: Maxima fails to properly convert some floats to rationals

archive/issues_011980.json:
```json
{
    "body": "Assignee: @burcin\n\nCC:  @kcrisman\n\nKeywords: maxima keepfloat integration\n\nFrom https://groups.google.com/d/topic/sage-devel/JZ54xk51F-E/discussion :\n\n```\nsage: a, b, t = var('a b t')\nsage: f(a,b,t) = sin(t)^2/(a + b*cos(t))^2\nsage: integrate(f(3/2,1,t), (t,0,2*pi))\n-2/5*(sqrt(5) - 3)*pi*sqrt(5)\n```\n\nWorks properly, but:\n\n```\nsage: integrate(f(1.5,1,t), (t,0,2*pi))\n```\n\nblows up with \n\n```\nRuntimeError: ECL says: Error executing code in Maxima: CRECIP:\nattempted inverse of zero (mod 3)\n```\n\nFrom the discussion there, this seems to be related to Maxima's attempts to convert floats to rationals, and that Sage turns off such conversion with `keepfloat:true`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12152\n\n",
    "created_at": "2011-12-14T00:56:29Z",
    "labels": [
        "calculus",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Maxima fails to properly convert some floats to rationals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11980",
    "user": "@dandrake"
}
```
Assignee: @burcin

CC:  @kcrisman

Keywords: maxima keepfloat integration

From https://groups.google.com/d/topic/sage-devel/JZ54xk51F-E/discussion :

```
sage: a, b, t = var('a b t')
sage: f(a,b,t) = sin(t)^2/(a + b*cos(t))^2
sage: integrate(f(3/2,1,t), (t,0,2*pi))
-2/5*(sqrt(5) - 3)*pi*sqrt(5)
```

Works properly, but:

```
sage: integrate(f(1.5,1,t), (t,0,2*pi))
```

blows up with 

```
RuntimeError: ECL says: Error executing code in Maxima: CRECIP:
attempted inverse of zero (mod 3)
```

From the discussion there, this seems to be related to Maxima's attempts to convert floats to rationals, and that Sage turns off such conversion with `keepfloat:true`.

Issue created by migration from https://trac.sagemath.org/ticket/12152





---

archive/issue_comments_137897.json:
```json
{
    "body": "See the thread above for some additional discussion, in particular about whether to not consider this a bug, and whether one should just disallow integrals with decimal points.",
    "created_at": "2011-12-14T02:39:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11980",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11980#issuecomment-137897",
    "user": "@kcrisman"
}
```

See the thread above for some additional discussion, in particular about whether to not consider this a bug, and whether one should just disallow integrals with decimal points.



---

archive/issue_comments_137898.json:
```json
{
    "body": "Here we go - another such report.\n\n```\n\n(%i1) keepfloat:true;\n(%o1)                                true\n(%i2) integrate(exp(-5.3*x),x,0,1);\n\nMaxima encountered a Lisp error:\n\n Argument V is not a INTEGER: 1.0\n\nAutomatically continuing.\n```\n\nBased on [this ask.sagemath.org post](http://ask.sagemath.org/question/2028/def-fx-evaluvates-individually-but-not-inside-plot).\n\nI've reported several similar things upstream at [this Maxima bug](https://sourceforge.net/p/maxima/bugs/2510/).",
    "created_at": "2012-11-29T15:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11980",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11980#issuecomment-137898",
    "user": "@kcrisman"
}
```

Here we go - another such report.

```

(%i1) keepfloat:true;
(%o1)                                true
(%i2) integrate(exp(-5.3*x),x,0,1);

Maxima encountered a Lisp error:

 Argument V is not a INTEGER: 1.0

Automatically continuing.
```

Based on [this ask.sagemath.org post](http://ask.sagemath.org/question/2028/def-fx-evaluvates-individually-but-not-inside-plot).

I've reported several similar things upstream at [this Maxima bug](https://sourceforge.net/p/maxima/bugs/2510/).



---

archive/issue_comments_137899.json:
```json
{
    "body": "Interestingly, we never considered the following from an old sage-devel conversation.\n\n```\nNo, it means that you have not noticed the value set for ratepsilon,\nwhich governs the tolerance\nfor conversion of floats to rationals.  It is by default set to\n2.0e-8, presumably for \"single float\"\nsystems.  It should probably be set to something more like 10e-16 for\ndouble float systems.\n\nAh, that is very helpful.  In this case the numerical approximations\ndo indeed agree up to the output of n().  Perhaps we could potentially\ngo back to keepfloat:false but with whatever the standard precision in\nSage would equate to - Jason, would that help things with matrices?\n```\n\nThis would probably keep a lot of problems away, especially since, as Nils says elsewhere, floats and symbolic integrals don't really mix.\n\nAnyway, see also https://sourceforge.net/p/maxima/bugs/2510/#fd1d",
    "created_at": "2012-11-29T16:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11980",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11980#issuecomment-137899",
    "user": "@kcrisman"
}
```

Interestingly, we never considered the following from an old sage-devel conversation.

```
No, it means that you have not noticed the value set for ratepsilon,
which governs the tolerance
for conversion of floats to rationals.  It is by default set to
2.0e-8, presumably for "single float"
systems.  It should probably be set to something more like 10e-16 for
double float systems.

Ah, that is very helpful.  In this case the numerical approximations
do indeed agree up to the output of n().  Perhaps we could potentially
go back to keepfloat:false but with whatever the standard precision in
Sage would equate to - Jason, would that help things with matrices?
```

This would probably keep a lot of problems away, especially since, as Nils says elsewhere, floats and symbolic integrals don't really mix.

Anyway, see also https://sourceforge.net/p/maxima/bugs/2510/#fd1d
