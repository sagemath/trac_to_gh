# Issue 31178: GH Actions workflow that deploys built documentation

Issue created by migration from https://trac.sagemath.org/ticket/31415

Original creator: mkoeppe

Original creation time: 2021-02-18 22:42:40

CC:  slelievre jhpalmieri schilly was @tobiasdiez klee vbraun

On each release tag pushed to `sagemath/sage`, it would build the HTML and PDF documentation and commit it to https://github.com/sagemath/documentation

as discussed in https://github.com/sagemath/documentation/issues/24


---

Comment by schilly created at 2021-02-19 17:35:57

I'm the one creating the documentation pages in the last few years. It's more than just building the files, because the output requires post-processing to make the pages fit for the CDN and I also have a script to create index pages. I'm also maintaining patches on top of Sage. So, all I want to add is that this task can't be automated right now.


---

Comment by mkoeppe created at 2021-02-19 18:35:34

Are these patches available somewhere, and should we look into whether they should be integrated into Sage?


---

Comment by slelievre created at 2021-03-27 20:56:12

Related:

- #29576: Missing js objects on doc search page


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by mkoeppe created at 2022-02-06 18:56:44

Looks like you are working on this, Tobias?


---

Comment by @tobiasdiez created at 2022-02-06 20:10:22

Yes, here is what I have for now.

On each push, it builds the documentation and deploys it to netlify. Example: https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/

However, what Harald says above is still true. Currently, there are symlinks in the documentation tree (to import static files), which yields to display errors. I have the same display problems locally (because I'm using WSL and Windows is not resolving the Linux symlinks). So that's something that still needs fixing. Any ideas how to remove the symlinks?
----
New commits:


---

Comment by klee created at 2022-02-07 02:47:21

Replying to [comment:12 gh-tobiasdiez]:
> Yes, here is what I have for now.
> 
> On each push, it builds the documentation and deploys it to netlify. Example: https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/
> 
> However, what Harald says above is still true. Currently, there are symlinks in the documentation tree (to import static files), which yields to display errors. 

Where and how can I see the display errors?


---

Attachment

Sorry, should have provided an example. I think all subpages that are not `index.html` are affected, for example https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/reference/structure/sage/structure/sage_object.html. The problem is the symlink that normally resolves `_static` to the correct path. This doesn't work on netlify (nor github pages) and leads to the following error:
<img src="ticket:31415:Screenshot 2022-02-07 134004.png" width=800px>


---

Comment by klee created at 2022-02-07 14:28:47

Replying to [comment:15 gh-tobiasdiez]:
> Sorry, should have provided an example. I think all subpages that are not `index.html` are affected, for example https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/reference/structure/sage/structure/sage_object.html. The problem is the symlink that normally resolves `_static` to the correct path. This doesn't work on netlify (nor github pages) and leads to the following error:

I see. Thanks. The symlinks are there to save disk space. But for CDN, it seems that the best option is just to copy files to resolve symlinks. See this:

https://superuser.com/questions/216919/how-to-copy-symlinks-to-target-as-normal-folders


---

Comment by @tobiasdiez created at 2022-02-07 14:50:26

That would work indeed, thanks for the idea! Will try it this evening.

Why are symlinks actually needed in the first place? Is there no easy way to specify the correct path to the static files from these pages? (For example, in webpack you have `~` which resolves to the root of the project regardless from where it is accessed.)


---

Comment by klee created at 2022-02-07 15:33:50

Replying to [comment:17 gh-tobiasdiez]:
> That would work indeed, thanks for the idea! Will try it this evening.
> 
> Why are symlinks actually needed in the first place? Is there no easy way to specify the correct path to the static files from these pages? (For example, in webpack you have `~` which resolves to the root of the project regardless from where it is accessed.)

Sphinx might have dictated hard-coded location of static files directory. But I don't know if this location can be changed.


---

Comment by git created at 2022-02-07 18:11:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-07 18:22:45

merge #33309?


---

Comment by git created at 2022-02-07 19:22:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-07 19:51:23

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-02-07 19:55:22

Probably should conditionalize the deployment step on the presence of the secrets


---

Comment by mkoeppe created at 2022-02-07 19:55:40

Also typo "neflify" -> "netlify"


---

Comment by mkoeppe created at 2022-02-07 19:57:54

Also since the first steps are identical to the `build.yml` workflow added in #33263, could this not just be an additional, conditional step of that?


---

Comment by @tobiasdiez created at 2022-02-07 21:36:42

Replying to [comment:20 mkoeppe]:
> merge #33309?

I think this is pretty independent.


---

Comment by @tobiasdiez created at 2022-02-07 21:37:39

Replying to [comment:23 mkoeppe]:
> Probably should conditionalize the deployment step on the presence of the secrets

Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.


---

Comment by @tobiasdiez created at 2022-02-07 21:37:52

Replying to [comment:24 mkoeppe]:
> Also typo "neflify" -> "netlify"

Thanks, corrected.


---

Comment by @tobiasdiez created at 2022-02-07 21:42:51

Replying to [comment:25 mkoeppe]:
> Also since the first steps are identical to the `build.yml` workflow added in #33263, could this not just be an additional, conditional step of that?

Thought about this as well. If we would use github PRs then I would definitely merge the workflows and provide feedback in form of different status checks. But since we awkwardly need to link to github through the badge. And as badges are workflow-specific this is the only way to make the distinction between "tests failed" and "documentation didn't build". Also the idea was to link the "documentation badge" link directly to the preview url. Another advantage is that you get quicker feedback since tests and doc build run in parallel.


---

Comment by git created at 2022-02-07 22:02:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-07 22:15:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-07 22:55:12

Replying to [comment:29 gh-tobiasdiez]:
> since we awkwardly need to link to github through the badge. And as badges are workflow-specific this is the only way to make the distinction between "tests failed" and "documentation didn't build". 

OK, this certainly makes sense.


---

Comment by mkoeppe created at 2022-02-07 22:56:11

Replying to [comment:27 gh-tobiasdiez]:
> Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.

People who clone the repo do not want to see failing workflows


---

Comment by @tobiasdiez created at 2022-02-07 23:42:40

Replying to [comment:39 mkoeppe]:
> Replying to [comment:27 gh-tobiasdiez]:
> > Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.
> 
> People who clone the repo do not want to see failing workflows

Workflows are not run on forks by default, and you can disable a particular workflow in a fork. I think its more important that the workflow fails if it's not able to do what its supposed to do in the main repo.


---

Comment by mkoeppe created at 2022-02-08 00:19:47

It's clearly a bad default to have deployment run & fail if there is exactly one fork on which it is supposed to run.


---

Comment by @tobiasdiez created at 2022-02-08 11:32:49

I don't understand you. Deployment workflows should by design only work in the main repo and should be disabled on forks. This is the default on github. If someone enables actions for a fork, then it's this persons responsibility to configure the actions according to her preferences. It's not our responsibility to think about how forks handle actions. (I know that some sage devs have forks whose only purpose is to more easily run the actions; but in this case you can disable the documentation workflow very easily in the ui and be done with it or just ignore the failed run).

The alternative is checking for the existence of the secrets. But if the secrets are misconfigured in the main repo, then the workflow would still succeed although its clearly not doing what its supposed to do. I think a robust main workflow is more important than no red workflow runs on forks.


---

Comment by git created at 2022-02-08 16:35:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-08 20:52:07

Replying to [comment:42 gh-tobiasdiez]:
> Deployment workflows should by design only work in the main repo and should be disabled on forks. 

Exactly -- and this can be implemented by not running it when no deployment secrets are deposited.


---

Comment by mkoeppe created at 2022-02-08 20:53:02

Replying to [comment:42 gh-tobiasdiez]:
> It's not our responsibility to think about how forks handle actions.

Yes it is because we document creating forks & running actions as part of portability work.


---

Comment by mkoeppe created at 2022-02-08 20:53:43

Replying to [comment:42 gh-tobiasdiez]:
> if the secrets are misconfigured in the main repo, then the workflow would still succeed although its clearly not doing what its supposed to do. 

You can still make it an error if bad secrets are deposited. 

But please no error if no secrets are present.


---

Comment by git created at 2022-02-08 23:28:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-08 23:29:36

Replying to [comment:45 mkoeppe]:
> Replying to [comment:42 gh-tobiasdiez]:
> > Deployment workflows should by design only work in the main repo and should be disabled on forks. 
> 
> Exactly -- and this can be implemented by not running it when no deployment secrets are deposited.

Now it runs only in the sagemath/sagetrac-mirror repo. Is this what you wanted?


---

Comment by mkoeppe created at 2022-02-08 23:36:36

That's a good solution, thanks


---

Comment by @tobiasdiez created at 2022-02-09 08:54:45

Okay, anything else to do here?


---

Comment by mkoeppe created at 2022-02-09 18:04:17

I don't understand the discussion of the `preview-netlify` stuff, maybe you could expand on this in ticket description or comments in the yml?

Could this not just deploy to a directory name that depends on the `ref_name`?


---

Comment by @tobiasdiez created at 2022-02-09 18:44:26

What I wanted to achieve is to deploy the branch `xyz` to `xyz-sagemath.netlify.app`. For this, you normally use their branch-deployment github integration, which would automatically rebuild the site for every change in the branch and deploys it to the correct url. However, this doesn't work for us since building the documentation is too involved, as sage has to be built first etc. Alternatively, there is an `--alias` switch to their `deploy` command which almost does the same thing. However, there is currently a bug which prevents that further deployments with the same alias update the deployed site. So you would always see the initial deployment of the branch.

As long as this bug is not fixed the workflow will look as follows:
- Click on the "Documentation" badge in the trac ticket, which opens the github workflow page
- Copy the preview url from the overview.

Once this bug is fixed, we can directly link the "Documentation" badge to the preview url (which is then derived from the branch name). Or we just switch to a github-based workflow, where the action can simply post a message to the PR or add it as a status check.


---

Comment by @tobiasdiez created at 2022-02-09 18:45:52

Replying to [comment:52 mkoeppe]:
> Could this not just deploy to a directory name that depends on the `ref_name`?

The only stable url we have is the "production" webpage. And each deploy to this overrides the complete page. So it's not possible to only update one directory in the deployed page.


---

Comment by mkoeppe created at 2022-02-09 18:49:18

Replying to [comment:53 gh-tobiasdiez]:
> there is currently a bug which prevents that further deployments with the same alias update the deployed site. So you would always see the initial deployment of the branch.

Then why not just use the commit sha as the key instead of the branch name?


---

Comment by @tobiasdiez created at 2022-02-09 20:10:51

That's a good idea and should work. Is the commit sha easily available on the trac side? The relevant part should be https://github.com/sagemath/sage_trac_plugin/blob/1d644a16ea89f9ed8232c92de6302d0622ec466d/sage_trac/ticket_box.py#L151-L158.


---

Comment by mkoeppe created at 2022-02-09 20:19:47

It's displayed in the ticket box


---

Comment by git created at 2022-02-10 13:28:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-10 13:28:45

Okay, it is now using the commit sha. Thanks for the suggestion.


---

Comment by mkoeppe created at 2022-02-10 18:10:20

Can you update the ticket description please?


---

Comment by mkoeppe created at 2022-02-10 18:11:57

I don't think the ticket and the comments in the yml file need to apologize for not using the branch name. Branch names are not very important in Sage - all branches are short-lived ticket branches.


---

Comment by mkoeppe created at 2022-02-10 18:13:57

Replying to [ticket:31415 mkoeppe]:
> - For pushes with tags (or to master), publish it on docs.sagemath.org website (for example using https://github.com/marketplace/actions/deploy-to-github-pages or by completely migrating to netlify).

How about adding another `alias` for the tag name?


---

Comment by @tobiasdiez created at 2022-02-10 19:17:10

Replying to [comment:60 mkoeppe]:
> Can you update the ticket description please?

Done.


---

Comment by @tobiasdiez created at 2022-02-10 19:21:16

Replying to [comment:61 mkoeppe]:
> I don't think the ticket and the comments in the yml file need to apologize for not using the branch name. Branch names are not very important in Sage - all branches are short-lived ticket branches.

It's the same spirit in netlify. It would be just nicer to have branch-based urls, since then you can easily refer to the latest version of the documentation of a ticket (e.g. if you share it with others). Netlify in addition would create a unique url for each deployment, so if you want to refer to a particular deploy this would still possible.


---

Comment by mkoeppe created at 2022-02-10 19:23:01

Even if fixed, it would make more sense for us to have URLs keyed to ticket numbers, not branch names


---

Comment by @tobiasdiez created at 2022-02-10 19:23:15

Replying to [comment:62 mkoeppe]:
> Replying to [ticket:31415 mkoeppe]:
> > - For pushes with tags (or to master), publish it on docs.sagemath.org website (for example using https://github.com/marketplace/actions/deploy-to-github-pages or by completely migrating to netlify).
> 
> How about adding another `alias` for the tag name?

I would prefer to keep this ticket for documentation previews for tickets; lets leave the CD of the main docs for another ticket.


---

Comment by @tobiasdiez created at 2022-02-10 19:24:15

Replying to [comment:66 mkoeppe]:
> Even if fixed, it would make more sense for us to have URLs keyed to ticket numbers, not branch names

Agreed.


---

Comment by mkoeppe created at 2022-02-10 20:01:16

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-02-10 20:01:16

OK


---

Comment by @tobiasdiez created at 2022-02-10 20:01:39

Thanks!


---

Comment by mkoeppe created at 2022-02-11 19:50:49

Changing priority from major to critical.


---

Comment by vbraun created at 2022-02-13 10:17:57

Resolution: fixed


---

Comment by mkoeppe created at 2022-02-13 16:21:59

Replying to [ticket:31415 mkoeppe]:
> - Change the deployment url to something more official. For this reason, I've created the site `sagemath-tobias.netlify.org`, so if you want to create an official sage account, `sagemath.netlify.org` is still available. Then one just needs to change the secrets in the github repo.

Ticket is merged now - should provide the secrets now


---

Comment by @tobiasdiez created at 2022-02-13 17:07:23

Replying to [comment:73 mkoeppe]:
> Replying to [ticket:31415 mkoeppe]:
> > - Change the deployment url to something more official. For this reason, I've created the site `sagemath-tobias.netlify.org`, so if you want to create an official sage account, `sagemath.netlify.org` is still available. Then one just needs to change the secrets in the github repo.
> 
> Ticket is merged now - should provide the secrets now

Secrets are in place already, it just uses `branchxyz--sagemath-tobias.netlify.org`. This can stay for now (from my side). Depending on where and how you want to host the documentation in the future, it might make sense to completely migrate to netlify and register the `docs.sagemath.org` domain there, probably with a new netlify account. Netlify also has a free open source plan that should suffice for sage. https://www.netlify.com/legal/open-source-policy


---

Comment by mkoeppe created at 2022-02-13 17:24:33

Ah, thanks, I guess that's good enough for now.


---

Comment by mkoeppe created at 2022-02-13 19:59:33

I see that you have added the badge now to the ticket box. When the docbuild fails and nothing is deployed, would it be possible to link to the Actions run instead of the failed deployment - https://2ed27f1014ad0db190c370210e54b99b9ea8a3e1--sagemath-tobias.netlify.app/ ?


---

Comment by @tobiasdiez created at 2022-02-13 21:02:20

Not easily. One could use the github api to query the workflow status and then decide about which link to use...


---

Comment by mkoeppe created at 2022-02-13 21:24:17

then maybe just add a second link for the docbuild logs?
