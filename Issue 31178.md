# Issue 31178: GH Actions workflow that deploys built documentation

archive/issues_031178.json:
```json
{
    "body": "CC:  slelievre jhpalmieri schilly was @tobiasdiez klee vbraun\n\nOn each release tag pushed to `sagemath/sage`, it would build the HTML and PDF documentation and commit it to https://github.com/sagemath/documentation\n\nas discussed in https://github.com/sagemath/documentation/issues/24\n\nIssue created by migration from https://trac.sagemath.org/ticket/31415\n\n",
    "created_at": "2021-02-18T22:42:40Z",
    "labels": [
        "website/wiki",
        "major",
        "enhancement"
    ],
    "title": "GH Actions workflow that deploys built documentation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31178",
    "user": "mkoeppe"
}
```
CC:  slelievre jhpalmieri schilly was @tobiasdiez klee vbraun

On each release tag pushed to `sagemath/sage`, it would build the HTML and PDF documentation and commit it to https://github.com/sagemath/documentation

as discussed in https://github.com/sagemath/documentation/issues/24

Issue created by migration from https://trac.sagemath.org/ticket/31415





---

archive/issue_comments_445720.json:
```json
{
    "body": "I'm the one creating the documentation pages in the last few years. It's more than just building the files, because the output requires post-processing to make the pages fit for the CDN and I also have a script to create index pages. I'm also maintaining patches on top of Sage. So, all I want to add is that this task can't be automated right now.",
    "created_at": "2021-02-19T17:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445720",
    "user": "schilly"
}
```

I'm the one creating the documentation pages in the last few years. It's more than just building the files, because the output requires post-processing to make the pages fit for the CDN and I also have a script to create index pages. I'm also maintaining patches on top of Sage. So, all I want to add is that this task can't be automated right now.



---

archive/issue_comments_445721.json:
```json
{
    "body": "Are these patches available somewhere, and should we look into whether they should be integrated into Sage?",
    "created_at": "2021-02-19T18:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445721",
    "user": "mkoeppe"
}
```

Are these patches available somewhere, and should we look into whether they should be integrated into Sage?



---

archive/issue_comments_445722.json:
```json
{
    "body": "Related:\n\n- #29576: Missing js objects on doc search page",
    "created_at": "2021-03-27T20:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445722",
    "user": "slelievre"
}
```

Related:

- #29576: Missing js objects on doc search page



---

archive/issue_comments_445723.json:
```json
{
    "body": "Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage",
    "created_at": "2021-04-02T20:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445723",
    "user": "mkoeppe"
}
```

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage



---

archive/issue_comments_445724.json:
```json
{
    "body": "Looks like you are working on this, Tobias?",
    "created_at": "2022-02-06T18:56:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445724",
    "user": "mkoeppe"
}
```

Looks like you are working on this, Tobias?



---

archive/issue_comments_445725.json:
```json
{
    "body": "Yes, here is what I have for now.\n\nOn each push, it builds the documentation and deploys it to netlify. Example: https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/\n\nHowever, what Harald says above is still true. Currently, there are symlinks in the documentation tree (to import static files), which yields to display errors. I have the same display problems locally (because I'm using WSL and Windows is not resolving the Linux symlinks). So that's something that still needs fixing. Any ideas how to remove the symlinks?\n----\nNew commits:",
    "created_at": "2022-02-06T20:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445725",
    "user": "@tobiasdiez"
}
```

Yes, here is what I have for now.

On each push, it builds the documentation and deploys it to netlify. Example: https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/

However, what Harald says above is still true. Currently, there are symlinks in the documentation tree (to import static files), which yields to display errors. I have the same display problems locally (because I'm using WSL and Windows is not resolving the Linux symlinks). So that's something that still needs fixing. Any ideas how to remove the symlinks?
----
New commits:



---

archive/issue_comments_445726.json:
```json
{
    "body": "Replying to [comment:12 gh-tobiasdiez]:\n> Yes, here is what I have for now.\n> \n> On each push, it builds the documentation and deploys it to netlify. Example: https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/\n> \n> However, what Harald says above is still true. Currently, there are symlinks in the documentation tree (to import static files), which yields to display errors. \n\nWhere and how can I see the display errors?",
    "created_at": "2022-02-07T02:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445726",
    "user": "klee"
}
```

Replying to [comment:12 gh-tobiasdiez]:
> Yes, here is what I have for now.
> 
> On each push, it builds the documentation and deploys it to netlify. Example: https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/
> 
> However, what Harald says above is still true. Currently, there are symlinks in the documentation tree (to import static files), which yields to display errors. 

Where and how can I see the display errors?



---

archive/issue_comments_445727.json:
```json
{
    "body": "Attachment [Screenshot 2022-02-07 134004.png](tarball://root/attachments/some-uuid/ticket31415/Screenshot 2022-02-07 134004.png) by @tobiasdiez created at 2022-02-07 12:44:15\n\nSorry, should have provided an example. I think all subpages that are not `index.html` are affected, for example https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/reference/structure/sage/structure/sage_object.html. The problem is the symlink that normally resolves `_static` to the correct path. This doesn't work on netlify (nor github pages) and leads to the following error:\n<img src=\"ticket:31415:Screenshot 2022-02-07 134004.png\" width=800px>",
    "created_at": "2022-02-07T12:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445727",
    "user": "@tobiasdiez"
}
```

Attachment [Screenshot 2022-02-07 134004.png](tarball://root/attachments/some-uuid/ticket31415/Screenshot 2022-02-07 134004.png) by @tobiasdiez created at 2022-02-07 12:44:15

Sorry, should have provided an example. I think all subpages that are not `index.html` are affected, for example https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/reference/structure/sage/structure/sage_object.html. The problem is the symlink that normally resolves `_static` to the correct path. This doesn't work on netlify (nor github pages) and leads to the following error:
<img src="ticket:31415:Screenshot 2022-02-07 134004.png" width=800px>



---

archive/issue_comments_445728.json:
```json
{
    "body": "Replying to [comment:15 gh-tobiasdiez]:\n> Sorry, should have provided an example. I think all subpages that are not `index.html` are affected, for example https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/reference/structure/sage/structure/sage_object.html. The problem is the symlink that normally resolves `_static` to the correct path. This doesn't work on netlify (nor github pages) and leads to the following error:\n\nI see. Thanks. The symlinks are there to save disk space. But for CDN, it seems that the best option is just to copy files to resolve symlinks. See this:\n\nhttps://superuser.com/questions/216919/how-to-copy-symlinks-to-target-as-normal-folders",
    "created_at": "2022-02-07T14:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445728",
    "user": "klee"
}
```

Replying to [comment:15 gh-tobiasdiez]:
> Sorry, should have provided an example. I think all subpages that are not `index.html` are affected, for example https://61ffda629c2d6f02653112ff--sagemath-tobias.netlify.app/reference/structure/sage/structure/sage_object.html. The problem is the symlink that normally resolves `_static` to the correct path. This doesn't work on netlify (nor github pages) and leads to the following error:

I see. Thanks. The symlinks are there to save disk space. But for CDN, it seems that the best option is just to copy files to resolve symlinks. See this:

https://superuser.com/questions/216919/how-to-copy-symlinks-to-target-as-normal-folders



---

archive/issue_comments_445729.json:
```json
{
    "body": "That would work indeed, thanks for the idea! Will try it this evening.\n\nWhy are symlinks actually needed in the first place? Is there no easy way to specify the correct path to the static files from these pages? (For example, in webpack you have `~` which resolves to the root of the project regardless from where it is accessed.)",
    "created_at": "2022-02-07T14:50:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445729",
    "user": "@tobiasdiez"
}
```

That would work indeed, thanks for the idea! Will try it this evening.

Why are symlinks actually needed in the first place? Is there no easy way to specify the correct path to the static files from these pages? (For example, in webpack you have `~` which resolves to the root of the project regardless from where it is accessed.)



---

archive/issue_comments_445730.json:
```json
{
    "body": "Replying to [comment:17 gh-tobiasdiez]:\n> That would work indeed, thanks for the idea! Will try it this evening.\n> \n> Why are symlinks actually needed in the first place? Is there no easy way to specify the correct path to the static files from these pages? (For example, in webpack you have `~` which resolves to the root of the project regardless from where it is accessed.)\n\nSphinx might have dictated hard-coded location of static files directory. But I don't know if this location can be changed.",
    "created_at": "2022-02-07T15:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445730",
    "user": "klee"
}
```

Replying to [comment:17 gh-tobiasdiez]:
> That would work indeed, thanks for the idea! Will try it this evening.
> 
> Why are symlinks actually needed in the first place? Is there no easy way to specify the correct path to the static files from these pages? (For example, in webpack you have `~` which resolves to the root of the project regardless from where it is accessed.)

Sphinx might have dictated hard-coded location of static files directory. But I don't know if this location can be changed.



---

archive/issue_comments_445731.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-07T18:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445731",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445732.json:
```json
{
    "body": "merge #33309?",
    "created_at": "2022-02-07T18:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445732",
    "user": "mkoeppe"
}
```

merge #33309?



---

archive/issue_comments_445733.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-07T19:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445733",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445734.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-07T19:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445734",
    "user": "@tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_445735.json:
```json
{
    "body": "Probably should conditionalize the deployment step on the presence of the secrets",
    "created_at": "2022-02-07T19:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445735",
    "user": "mkoeppe"
}
```

Probably should conditionalize the deployment step on the presence of the secrets



---

archive/issue_comments_445736.json:
```json
{
    "body": "Also typo \"neflify\" -> \"netlify\"",
    "created_at": "2022-02-07T19:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445736",
    "user": "mkoeppe"
}
```

Also typo "neflify" -> "netlify"



---

archive/issue_comments_445737.json:
```json
{
    "body": "Also since the first steps are identical to the `build.yml` workflow added in #33263, could this not just be an additional, conditional step of that?",
    "created_at": "2022-02-07T19:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445737",
    "user": "mkoeppe"
}
```

Also since the first steps are identical to the `build.yml` workflow added in #33263, could this not just be an additional, conditional step of that?



---

archive/issue_comments_445738.json:
```json
{
    "body": "Replying to [comment:20 mkoeppe]:\n> merge #33309?\n\nI think this is pretty independent.",
    "created_at": "2022-02-07T21:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445738",
    "user": "@tobiasdiez"
}
```

Replying to [comment:20 mkoeppe]:
> merge #33309?

I think this is pretty independent.



---

archive/issue_comments_445739.json:
```json
{
    "body": "Replying to [comment:23 mkoeppe]:\n> Probably should conditionalize the deployment step on the presence of the secrets\n\nWhy do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.",
    "created_at": "2022-02-07T21:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445739",
    "user": "@tobiasdiez"
}
```

Replying to [comment:23 mkoeppe]:
> Probably should conditionalize the deployment step on the presence of the secrets

Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.



---

archive/issue_comments_445740.json:
```json
{
    "body": "Replying to [comment:24 mkoeppe]:\n> Also typo \"neflify\" -> \"netlify\"\n\nThanks, corrected.",
    "created_at": "2022-02-07T21:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445740",
    "user": "@tobiasdiez"
}
```

Replying to [comment:24 mkoeppe]:
> Also typo "neflify" -> "netlify"

Thanks, corrected.



---

archive/issue_comments_445741.json:
```json
{
    "body": "Replying to [comment:25 mkoeppe]:\n> Also since the first steps are identical to the `build.yml` workflow added in #33263, could this not just be an additional, conditional step of that?\n\nThought about this as well. If we would use github PRs then I would definitely merge the workflows and provide feedback in form of different status checks. But since we awkwardly need to link to github through the badge. And as badges are workflow-specific this is the only way to make the distinction between \"tests failed\" and \"documentation didn't build\". Also the idea was to link the \"documentation badge\" link directly to the preview url. Another advantage is that you get quicker feedback since tests and doc build run in parallel.",
    "created_at": "2022-02-07T21:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445741",
    "user": "@tobiasdiez"
}
```

Replying to [comment:25 mkoeppe]:
> Also since the first steps are identical to the `build.yml` workflow added in #33263, could this not just be an additional, conditional step of that?

Thought about this as well. If we would use github PRs then I would definitely merge the workflows and provide feedback in form of different status checks. But since we awkwardly need to link to github through the badge. And as badges are workflow-specific this is the only way to make the distinction between "tests failed" and "documentation didn't build". Also the idea was to link the "documentation badge" link directly to the preview url. Another advantage is that you get quicker feedback since tests and doc build run in parallel.



---

archive/issue_comments_445742.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-07T22:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445742",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-07T22:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445743",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445744.json:
```json
{
    "body": "Replying to [comment:29 gh-tobiasdiez]:\n> since we awkwardly need to link to github through the badge. And as badges are workflow-specific this is the only way to make the distinction between \"tests failed\" and \"documentation didn't build\". \n\nOK, this certainly makes sense.",
    "created_at": "2022-02-07T22:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445744",
    "user": "mkoeppe"
}
```

Replying to [comment:29 gh-tobiasdiez]:
> since we awkwardly need to link to github through the badge. And as badges are workflow-specific this is the only way to make the distinction between "tests failed" and "documentation didn't build". 

OK, this certainly makes sense.



---

archive/issue_comments_445745.json:
```json
{
    "body": "Replying to [comment:27 gh-tobiasdiez]:\n> Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.\n\nPeople who clone the repo do not want to see failing workflows",
    "created_at": "2022-02-07T22:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445745",
    "user": "mkoeppe"
}
```

Replying to [comment:27 gh-tobiasdiez]:
> Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.

People who clone the repo do not want to see failing workflows



---

archive/issue_comments_445746.json:
```json
{
    "body": "Replying to [comment:39 mkoeppe]:\n> Replying to [comment:27 gh-tobiasdiez]:\n> > Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.\n> \n> People who clone the repo do not want to see failing workflows\n\nWorkflows are not run on forks by default, and you can disable a particular workflow in a fork. I think its more important that the workflow fails if it's not able to do what its supposed to do in the main repo.",
    "created_at": "2022-02-07T23:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445746",
    "user": "@tobiasdiez"
}
```

Replying to [comment:39 mkoeppe]:
> Replying to [comment:27 gh-tobiasdiez]:
> > Why do you think so? If the secrets are not provided or missconfigured, then this workflow fails at this step, which I think is what you want.
> 
> People who clone the repo do not want to see failing workflows

Workflows are not run on forks by default, and you can disable a particular workflow in a fork. I think its more important that the workflow fails if it's not able to do what its supposed to do in the main repo.



---

archive/issue_comments_445747.json:
```json
{
    "body": "It's clearly a bad default to have deployment run & fail if there is exactly one fork on which it is supposed to run.",
    "created_at": "2022-02-08T00:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445747",
    "user": "mkoeppe"
}
```

It's clearly a bad default to have deployment run & fail if there is exactly one fork on which it is supposed to run.



---

archive/issue_comments_445748.json:
```json
{
    "body": "I don't understand you. Deployment workflows should by design only work in the main repo and should be disabled on forks. This is the default on github. If someone enables actions for a fork, then it's this persons responsibility to configure the actions according to her preferences. It's not our responsibility to think about how forks handle actions. (I know that some sage devs have forks whose only purpose is to more easily run the actions; but in this case you can disable the documentation workflow very easily in the ui and be done with it or just ignore the failed run).\n\nThe alternative is checking for the existence of the secrets. But if the secrets are misconfigured in the main repo, then the workflow would still succeed although its clearly not doing what its supposed to do. I think a robust main workflow is more important than no red workflow runs on forks.",
    "created_at": "2022-02-08T11:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445748",
    "user": "@tobiasdiez"
}
```

I don't understand you. Deployment workflows should by design only work in the main repo and should be disabled on forks. This is the default on github. If someone enables actions for a fork, then it's this persons responsibility to configure the actions according to her preferences. It's not our responsibility to think about how forks handle actions. (I know that some sage devs have forks whose only purpose is to more easily run the actions; but in this case you can disable the documentation workflow very easily in the ui and be done with it or just ignore the failed run).

The alternative is checking for the existence of the secrets. But if the secrets are misconfigured in the main repo, then the workflow would still succeed although its clearly not doing what its supposed to do. I think a robust main workflow is more important than no red workflow runs on forks.



---

archive/issue_comments_445749.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-08T16:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445749",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445750.json:
```json
{
    "body": "Replying to [comment:42 gh-tobiasdiez]:\n> Deployment workflows should by design only work in the main repo and should be disabled on forks. \n\nExactly -- and this can be implemented by not running it when no deployment secrets are deposited.",
    "created_at": "2022-02-08T20:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445750",
    "user": "mkoeppe"
}
```

Replying to [comment:42 gh-tobiasdiez]:
> Deployment workflows should by design only work in the main repo and should be disabled on forks. 

Exactly -- and this can be implemented by not running it when no deployment secrets are deposited.



---

archive/issue_comments_445751.json:
```json
{
    "body": "Replying to [comment:42 gh-tobiasdiez]:\n> It's not our responsibility to think about how forks handle actions.\n\nYes it is because we document creating forks & running actions as part of portability work.",
    "created_at": "2022-02-08T20:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445751",
    "user": "mkoeppe"
}
```

Replying to [comment:42 gh-tobiasdiez]:
> It's not our responsibility to think about how forks handle actions.

Yes it is because we document creating forks & running actions as part of portability work.



---

archive/issue_comments_445752.json:
```json
{
    "body": "Replying to [comment:42 gh-tobiasdiez]:\n> if the secrets are misconfigured in the main repo, then the workflow would still succeed although its clearly not doing what its supposed to do. \n\nYou can still make it an error if bad secrets are deposited. \n\nBut please no error if no secrets are present.",
    "created_at": "2022-02-08T20:53:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445752",
    "user": "mkoeppe"
}
```

Replying to [comment:42 gh-tobiasdiez]:
> if the secrets are misconfigured in the main repo, then the workflow would still succeed although its clearly not doing what its supposed to do. 

You can still make it an error if bad secrets are deposited. 

But please no error if no secrets are present.



---

archive/issue_comments_445753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-08T23:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445753",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445754.json:
```json
{
    "body": "Replying to [comment:45 mkoeppe]:\n> Replying to [comment:42 gh-tobiasdiez]:\n> > Deployment workflows should by design only work in the main repo and should be disabled on forks. \n> \n> Exactly -- and this can be implemented by not running it when no deployment secrets are deposited.\n\nNow it runs only in the sagemath/sagetrac-mirror repo. Is this what you wanted?",
    "created_at": "2022-02-08T23:29:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445754",
    "user": "@tobiasdiez"
}
```

Replying to [comment:45 mkoeppe]:
> Replying to [comment:42 gh-tobiasdiez]:
> > Deployment workflows should by design only work in the main repo and should be disabled on forks. 
> 
> Exactly -- and this can be implemented by not running it when no deployment secrets are deposited.

Now it runs only in the sagemath/sagetrac-mirror repo. Is this what you wanted?



---

archive/issue_comments_445755.json:
```json
{
    "body": "That's a good solution, thanks",
    "created_at": "2022-02-08T23:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445755",
    "user": "mkoeppe"
}
```

That's a good solution, thanks



---

archive/issue_comments_445756.json:
```json
{
    "body": "Okay, anything else to do here?",
    "created_at": "2022-02-09T08:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445756",
    "user": "@tobiasdiez"
}
```

Okay, anything else to do here?



---

archive/issue_comments_445757.json:
```json
{
    "body": "I don't understand the discussion of the `preview-netlify` stuff, maybe you could expand on this in ticket description or comments in the yml?\n\nCould this not just deploy to a directory name that depends on the `ref_name`?",
    "created_at": "2022-02-09T18:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445757",
    "user": "mkoeppe"
}
```

I don't understand the discussion of the `preview-netlify` stuff, maybe you could expand on this in ticket description or comments in the yml?

Could this not just deploy to a directory name that depends on the `ref_name`?



---

archive/issue_comments_445758.json:
```json
{
    "body": "What I wanted to achieve is to deploy the branch `xyz` to `xyz-sagemath.netlify.app`. For this, you normally use their branch-deployment github integration, which would automatically rebuild the site for every change in the branch and deploys it to the correct url. However, this doesn't work for us since building the documentation is too involved, as sage has to be built first etc. Alternatively, there is an `--alias` switch to their `deploy` command which almost does the same thing. However, there is currently a bug which prevents that further deployments with the same alias update the deployed site. So you would always see the initial deployment of the branch.\n\nAs long as this bug is not fixed the workflow will look as follows:\n- Click on the \"Documentation\" badge in the trac ticket, which opens the github workflow page\n- Copy the preview url from the overview.\n\nOnce this bug is fixed, we can directly link the \"Documentation\" badge to the preview url (which is then derived from the branch name). Or we just switch to a github-based workflow, where the action can simply post a message to the PR or add it as a status check.",
    "created_at": "2022-02-09T18:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445758",
    "user": "@tobiasdiez"
}
```

What I wanted to achieve is to deploy the branch `xyz` to `xyz-sagemath.netlify.app`. For this, you normally use their branch-deployment github integration, which would automatically rebuild the site for every change in the branch and deploys it to the correct url. However, this doesn't work for us since building the documentation is too involved, as sage has to be built first etc. Alternatively, there is an `--alias` switch to their `deploy` command which almost does the same thing. However, there is currently a bug which prevents that further deployments with the same alias update the deployed site. So you would always see the initial deployment of the branch.

As long as this bug is not fixed the workflow will look as follows:
- Click on the "Documentation" badge in the trac ticket, which opens the github workflow page
- Copy the preview url from the overview.

Once this bug is fixed, we can directly link the "Documentation" badge to the preview url (which is then derived from the branch name). Or we just switch to a github-based workflow, where the action can simply post a message to the PR or add it as a status check.



---

archive/issue_comments_445759.json:
```json
{
    "body": "Replying to [comment:52 mkoeppe]:\n> Could this not just deploy to a directory name that depends on the `ref_name`?\n\nThe only stable url we have is the \"production\" webpage. And each deploy to this overrides the complete page. So it's not possible to only update one directory in the deployed page.",
    "created_at": "2022-02-09T18:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445759",
    "user": "@tobiasdiez"
}
```

Replying to [comment:52 mkoeppe]:
> Could this not just deploy to a directory name that depends on the `ref_name`?

The only stable url we have is the "production" webpage. And each deploy to this overrides the complete page. So it's not possible to only update one directory in the deployed page.



---

archive/issue_comments_445760.json:
```json
{
    "body": "Replying to [comment:53 gh-tobiasdiez]:\n> there is currently a bug which prevents that further deployments with the same alias update the deployed site. So you would always see the initial deployment of the branch.\n\nThen why not just use the commit sha as the key instead of the branch name?",
    "created_at": "2022-02-09T18:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445760",
    "user": "mkoeppe"
}
```

Replying to [comment:53 gh-tobiasdiez]:
> there is currently a bug which prevents that further deployments with the same alias update the deployed site. So you would always see the initial deployment of the branch.

Then why not just use the commit sha as the key instead of the branch name?



---

archive/issue_comments_445761.json:
```json
{
    "body": "That's a good idea and should work. Is the commit sha easily available on the trac side? The relevant part should be https://github.com/sagemath/sage_trac_plugin/blob/1d644a16ea89f9ed8232c92de6302d0622ec466d/sage_trac/ticket_box.py#L151-L158.",
    "created_at": "2022-02-09T20:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445761",
    "user": "@tobiasdiez"
}
```

That's a good idea and should work. Is the commit sha easily available on the trac side? The relevant part should be https://github.com/sagemath/sage_trac_plugin/blob/1d644a16ea89f9ed8232c92de6302d0622ec466d/sage_trac/ticket_box.py#L151-L158.



---

archive/issue_comments_445762.json:
```json
{
    "body": "It's displayed in the ticket box",
    "created_at": "2022-02-09T20:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445762",
    "user": "mkoeppe"
}
```

It's displayed in the ticket box



---

archive/issue_comments_445763.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-10T13:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445763",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445764.json:
```json
{
    "body": "Okay, it is now using the commit sha. Thanks for the suggestion.",
    "created_at": "2022-02-10T13:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445764",
    "user": "@tobiasdiez"
}
```

Okay, it is now using the commit sha. Thanks for the suggestion.



---

archive/issue_comments_445765.json:
```json
{
    "body": "Can you update the ticket description please?",
    "created_at": "2022-02-10T18:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445765",
    "user": "mkoeppe"
}
```

Can you update the ticket description please?



---

archive/issue_comments_445766.json:
```json
{
    "body": "I don't think the ticket and the comments in the yml file need to apologize for not using the branch name. Branch names are not very important in Sage - all branches are short-lived ticket branches.",
    "created_at": "2022-02-10T18:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445766",
    "user": "mkoeppe"
}
```

I don't think the ticket and the comments in the yml file need to apologize for not using the branch name. Branch names are not very important in Sage - all branches are short-lived ticket branches.



---

archive/issue_comments_445767.json:
```json
{
    "body": "Replying to [ticket:31415 mkoeppe]:\n> - For pushes with tags (or to master), publish it on docs.sagemath.org website (for example using https://github.com/marketplace/actions/deploy-to-github-pages or by completely migrating to netlify).\n\nHow about adding another `alias` for the tag name?",
    "created_at": "2022-02-10T18:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445767",
    "user": "mkoeppe"
}
```

Replying to [ticket:31415 mkoeppe]:
> - For pushes with tags (or to master), publish it on docs.sagemath.org website (for example using https://github.com/marketplace/actions/deploy-to-github-pages or by completely migrating to netlify).

How about adding another `alias` for the tag name?



---

archive/issue_comments_445768.json:
```json
{
    "body": "Replying to [comment:60 mkoeppe]:\n> Can you update the ticket description please?\n\nDone.",
    "created_at": "2022-02-10T19:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445768",
    "user": "@tobiasdiez"
}
```

Replying to [comment:60 mkoeppe]:
> Can you update the ticket description please?

Done.



---

archive/issue_comments_445769.json:
```json
{
    "body": "Replying to [comment:61 mkoeppe]:\n> I don't think the ticket and the comments in the yml file need to apologize for not using the branch name. Branch names are not very important in Sage - all branches are short-lived ticket branches.\n\nIt's the same spirit in netlify. It would be just nicer to have branch-based urls, since then you can easily refer to the latest version of the documentation of a ticket (e.g. if you share it with others). Netlify in addition would create a unique url for each deployment, so if you want to refer to a particular deploy this would still possible.",
    "created_at": "2022-02-10T19:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445769",
    "user": "@tobiasdiez"
}
```

Replying to [comment:61 mkoeppe]:
> I don't think the ticket and the comments in the yml file need to apologize for not using the branch name. Branch names are not very important in Sage - all branches are short-lived ticket branches.

It's the same spirit in netlify. It would be just nicer to have branch-based urls, since then you can easily refer to the latest version of the documentation of a ticket (e.g. if you share it with others). Netlify in addition would create a unique url for each deployment, so if you want to refer to a particular deploy this would still possible.



---

archive/issue_comments_445770.json:
```json
{
    "body": "Even if fixed, it would make more sense for us to have URLs keyed to ticket numbers, not branch names",
    "created_at": "2022-02-10T19:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445770",
    "user": "mkoeppe"
}
```

Even if fixed, it would make more sense for us to have URLs keyed to ticket numbers, not branch names



---

archive/issue_comments_445771.json:
```json
{
    "body": "Replying to [comment:62 mkoeppe]:\n> Replying to [ticket:31415 mkoeppe]:\n> > - For pushes with tags (or to master), publish it on docs.sagemath.org website (for example using https://github.com/marketplace/actions/deploy-to-github-pages or by completely migrating to netlify).\n> \n> How about adding another `alias` for the tag name?\n\nI would prefer to keep this ticket for documentation previews for tickets; lets leave the CD of the main docs for another ticket.",
    "created_at": "2022-02-10T19:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445771",
    "user": "@tobiasdiez"
}
```

Replying to [comment:62 mkoeppe]:
> Replying to [ticket:31415 mkoeppe]:
> > - For pushes with tags (or to master), publish it on docs.sagemath.org website (for example using https://github.com/marketplace/actions/deploy-to-github-pages or by completely migrating to netlify).
> 
> How about adding another `alias` for the tag name?

I would prefer to keep this ticket for documentation previews for tickets; lets leave the CD of the main docs for another ticket.



---

archive/issue_comments_445772.json:
```json
{
    "body": "Replying to [comment:66 mkoeppe]:\n> Even if fixed, it would make more sense for us to have URLs keyed to ticket numbers, not branch names\n\nAgreed.",
    "created_at": "2022-02-10T19:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445772",
    "user": "@tobiasdiez"
}
```

Replying to [comment:66 mkoeppe]:
> Even if fixed, it would make more sense for us to have URLs keyed to ticket numbers, not branch names

Agreed.



---

archive/issue_comments_445773.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-10T20:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445773",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_445774.json:
```json
{
    "body": "OK",
    "created_at": "2022-02-10T20:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445774",
    "user": "mkoeppe"
}
```

OK



---

archive/issue_comments_445775.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-02-10T20:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445775",
    "user": "@tobiasdiez"
}
```

Thanks!



---

archive/issue_comments_445776.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-02-11T19:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445776",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_445777.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-13T10:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445777",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_445778.json:
```json
{
    "body": "Replying to [ticket:31415 mkoeppe]:\n> - Change the deployment url to something more official. For this reason, I've created the site `sagemath-tobias.netlify.org`, so if you want to create an official sage account, `sagemath.netlify.org` is still available. Then one just needs to change the secrets in the github repo.\n\nTicket is merged now - should provide the secrets now",
    "created_at": "2022-02-13T16:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445778",
    "user": "mkoeppe"
}
```

Replying to [ticket:31415 mkoeppe]:
> - Change the deployment url to something more official. For this reason, I've created the site `sagemath-tobias.netlify.org`, so if you want to create an official sage account, `sagemath.netlify.org` is still available. Then one just needs to change the secrets in the github repo.

Ticket is merged now - should provide the secrets now



---

archive/issue_comments_445779.json:
```json
{
    "body": "Replying to [comment:73 mkoeppe]:\n> Replying to [ticket:31415 mkoeppe]:\n> > - Change the deployment url to something more official. For this reason, I've created the site `sagemath-tobias.netlify.org`, so if you want to create an official sage account, `sagemath.netlify.org` is still available. Then one just needs to change the secrets in the github repo.\n> \n> Ticket is merged now - should provide the secrets now\n\nSecrets are in place already, it just uses `branchxyz--sagemath-tobias.netlify.org`. This can stay for now (from my side). Depending on where and how you want to host the documentation in the future, it might make sense to completely migrate to netlify and register the `docs.sagemath.org` domain there, probably with a new netlify account. Netlify also has a free open source plan that should suffice for sage. https://www.netlify.com/legal/open-source-policy",
    "created_at": "2022-02-13T17:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445779",
    "user": "@tobiasdiez"
}
```

Replying to [comment:73 mkoeppe]:
> Replying to [ticket:31415 mkoeppe]:
> > - Change the deployment url to something more official. For this reason, I've created the site `sagemath-tobias.netlify.org`, so if you want to create an official sage account, `sagemath.netlify.org` is still available. Then one just needs to change the secrets in the github repo.
> 
> Ticket is merged now - should provide the secrets now

Secrets are in place already, it just uses `branchxyz--sagemath-tobias.netlify.org`. This can stay for now (from my side). Depending on where and how you want to host the documentation in the future, it might make sense to completely migrate to netlify and register the `docs.sagemath.org` domain there, probably with a new netlify account. Netlify also has a free open source plan that should suffice for sage. https://www.netlify.com/legal/open-source-policy



---

archive/issue_comments_445780.json:
```json
{
    "body": "Ah, thanks, I guess that's good enough for now.",
    "created_at": "2022-02-13T17:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445780",
    "user": "mkoeppe"
}
```

Ah, thanks, I guess that's good enough for now.



---

archive/issue_comments_445781.json:
```json
{
    "body": "I see that you have added the badge now to the ticket box. When the docbuild fails and nothing is deployed, would it be possible to link to the Actions run instead of the failed deployment - https://2ed27f1014ad0db190c370210e54b99b9ea8a3e1--sagemath-tobias.netlify.app/ ?",
    "created_at": "2022-02-13T19:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445781",
    "user": "mkoeppe"
}
```

I see that you have added the badge now to the ticket box. When the docbuild fails and nothing is deployed, would it be possible to link to the Actions run instead of the failed deployment - https://2ed27f1014ad0db190c370210e54b99b9ea8a3e1--sagemath-tobias.netlify.app/ ?



---

archive/issue_comments_445782.json:
```json
{
    "body": "Not easily. One could use the github api to query the workflow status and then decide about which link to use...",
    "created_at": "2022-02-13T21:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445782",
    "user": "@tobiasdiez"
}
```

Not easily. One could use the github api to query the workflow status and then decide about which link to use...



---

archive/issue_comments_445783.json:
```json
{
    "body": "then maybe just add a second link for the docbuild logs?",
    "created_at": "2022-02-13T21:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31178#issuecomment-445783",
    "user": "mkoeppe"
}
```

then maybe just add a second link for the docbuild logs?
