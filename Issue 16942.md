# Issue 16942: TIDES interface should convert exact parameters to floating points.

archive/issues_016942.json:
```json
{
    "body": "CC:  imark\n\nTIDES interface admits expressions like pi or 2^(1/7) as parameters. They should be converted to floating point numbers of the appropiate precission.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17179\n\n",
    "created_at": "2014-10-19T18:31:21Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "TIDES interface should convert exact parameters to floating points.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16942",
    "user": "https://github.com/miguelmarco"
}
```
CC:  imark

TIDES interface admits expressions like pi or 2^(1/7) as parameters. They should be converted to floating point numbers of the appropiate precission.

Issue created by migration from https://trac.sagemath.org/ticket/17179





---

archive/issue_comments_224222.json:
```json
{
    "body": "Could you please give an example of something which works/doesn't work?",
    "created_at": "2014-10-19T18:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224222",
    "user": "https://github.com/jdemeyer"
}
```

Could you please give an example of something which works/doesn't work?



---

archive/issue_comments_224223.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2014-10-19T18:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224223",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_224224.json:
```json
{
    "body": "Yes, sorry, i am working in a patch. I will include a branch in a few hours.\n\nThe idea is that, for instance, if you pass pi as an initial condition, the .c code created will have the string \"pi\" instead of \"3.141592\", and then the compiler would complain.",
    "created_at": "2014-10-19T19:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224224",
    "user": "https://github.com/miguelmarco"
}
```

Yes, sorry, i am working in a patch. I will include a branch in a few hours.

The idea is that, for instance, if you pass pi as an initial condition, the .c code created will have the string "pi" instead of "3.141592", and then the compiler would complain.



---

archive/issue_comments_224225.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-10-19T21:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224225",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_224226.json:
```json
{
    "body": "This branch converts expressions like \"pi\" to their floating point literals.\n\nThis should take care of the issues in #16025\n----\nNew commits:",
    "created_at": "2014-10-19T21:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224226",
    "user": "https://github.com/miguelmarco"
}
```

This branch converts expressions like "pi" to their floating point literals.

This should take care of the issues in #16025
----
New commits:



---

archive/issue_comments_224227.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-10-20T07:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224227",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_224228.json:
```json
{
    "body": "Some comments:\n* Instead of `mkdtemp()`, you can use `tmp_dir()` from `sage.misc.temporary_file`. That gets cleaned automatically.\n\n* Instead of `TIDES_RND`, I would use an explicit `MPFR_RNDN` instead in the `mpfr_set_str()` calls.\n\n* Remove the unused imports of `SAGE_ROOT`, `os`, `shutil` and `N`.\n\n* Do you really need `RR(SR(foo))`, isn't `RR(foo)` sufficient?\n\n* Tides uses\n\n```\nint binary_precision(int prec) {\n    return ceil(prec * 3.3219);\n}\n```\n\nto convert from decimal to binary precision, perhaps you should use the same formula?\n\n* You should use the `.str(truncate=False)` method to convert a `RealNumber` to a string, because by default Sage prints reals with less digits. Compare\n\n```\nsage: RR(pi).str(truncate=False)\n'3.1415926535897931'\nsage: RR(pi).str()\n'3.14159265358979'\n```\n\n\n* Then something unrelated to this ticket: `exp()` in an expression currently doesn't work.\n\n* Finally, fill in your real name as author on this ticket.",
    "created_at": "2014-10-20T07:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224228",
    "user": "https://github.com/jdemeyer"
}
```

Some comments:
* Instead of `mkdtemp()`, you can use `tmp_dir()` from `sage.misc.temporary_file`. That gets cleaned automatically.

* Instead of `TIDES_RND`, I would use an explicit `MPFR_RNDN` instead in the `mpfr_set_str()` calls.

* Remove the unused imports of `SAGE_ROOT`, `os`, `shutil` and `N`.

* Do you really need `RR(SR(foo))`, isn't `RR(foo)` sufficient?

* Tides uses

```
int binary_precision(int prec) {
    return ceil(prec * 3.3219);
}
```

to convert from decimal to binary precision, perhaps you should use the same formula?

* You should use the `.str(truncate=False)` method to convert a `RealNumber` to a string, because by default Sage prints reals with less digits. Compare

```
sage: RR(pi).str(truncate=False)
'3.1415926535897931'
sage: RR(pi).str()
'3.14159265358979'
```


* Then something unrelated to this ticket: `exp()` in an expression currently doesn't work.

* Finally, fill in your real name as author on this ticket.



---

archive/issue_comments_224229.json:
```json
{
    "body": "`RR(SR(foo))` is used because strings like `\"pi\"` or `\"-3/2\"` are not accepted by the element constructor of real fields. They are accepted by the element constructor of SR though. So it was the best way i could find to create a RealField element from these strings.\n\nThe real value of log(10)/log(2) is between 3.3219 and 3.322, so i prefeared to be conservative in this aspect. \n\nThis commit addresses mostly all your comments, but i think that the code could be greatly improved if we pass the domain to fast_callable, which would directly convert all constants, avoiding us the work of converting the exact expressions to the strings that represent them in floating point.\n\nBesides, there is also some room for improvement in the performance of `remove_repeated` .\n\nI will work on that, but i am not sure if it should be done in this ticket (maybe we should change the title?)",
    "created_at": "2014-10-20T12:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224229",
    "user": "https://github.com/miguelmarco"
}
```

`RR(SR(foo))` is used because strings like `"pi"` or `"-3/2"` are not accepted by the element constructor of real fields. They are accepted by the element constructor of SR though. So it was the best way i could find to create a RealField element from these strings.

The real value of log(10)/log(2) is between 3.3219 and 3.322, so i prefeared to be conservative in this aspect. 

This commit addresses mostly all your comments, but i think that the code could be greatly improved if we pass the domain to fast_callable, which would directly convert all constants, avoiding us the work of converting the exact expressions to the strings that represent them in floating point.

Besides, there is also some room for improvement in the performance of `remove_repeated` .

I will work on that, but i am not sure if it should be done in this ticket (maybe we should change the title?)



---

archive/issue_comments_224230.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-20T12:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_224231.json:
```json
{
    "body": "Replying to [comment:6 mmarco]:\n> `RR(SR(foo))` is used because strings like `\"pi\"` or `\"-3/2\"` are not accepted by the element constructor of real fields.\nI would say that's a good thing! Why *should* strings like that be accepted as input? I think it's reasonable to accept the elements `pi` (element of `SR`) and `3/2` (element of `QQ`) but not the strings `\"pi\"` or `\"-3/2\"`.\n\n> The real value of log(10)/log(2) is between 3.3219 and 3.322, so i prefeared to be conservative in this aspect.\nIf your precision doesn't agree with `TIDES_PREC`, the result might actually be *less precise*: mpfr guarantees that the string representation (with `truncate=False` in Sage) is such that the exact same real number will be created by `mpfr_set_str(string, MPFR_RNDN)` *provided that the precision is the same*.\n\nI understand that you prefer to round `log(10)/log(2)` up, but then `TIDES_PREC` should agree with this:\n\n```\nprec = ceil(dig * 3.322)\nRR = RealField(prec)\n...\noutfile.write('\\tTIDES_PREC = {};'.format(prec))   # instead of set_precision_digits()\n```\n\n\n> This commit addresses mostly all your comments, but i think that the code could be greatly improved if we pass the domain to fast_callable, which would directly convert all constants, avoiding us the work of converting the exact expressions to the strings that represent them in floating point.\nI have no experience with `fast_callable`, so I cannot judge.\n\n> Besides, there is also some room for improvement in the performance of `remove_repeated` .\n> \n> I will work on that, but i am not sure if it should be done in this ticket\nNot on this ticket.",
    "created_at": "2014-10-20T18:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224231",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 mmarco]:
> `RR(SR(foo))` is used because strings like `"pi"` or `"-3/2"` are not accepted by the element constructor of real fields.
I would say that's a good thing! Why *should* strings like that be accepted as input? I think it's reasonable to accept the elements `pi` (element of `SR`) and `3/2` (element of `QQ`) but not the strings `"pi"` or `"-3/2"`.

> The real value of log(10)/log(2) is between 3.3219 and 3.322, so i prefeared to be conservative in this aspect.
If your precision doesn't agree with `TIDES_PREC`, the result might actually be *less precise*: mpfr guarantees that the string representation (with `truncate=False` in Sage) is such that the exact same real number will be created by `mpfr_set_str(string, MPFR_RNDN)` *provided that the precision is the same*.

I understand that you prefer to round `log(10)/log(2)` up, but then `TIDES_PREC` should agree with this:

```
prec = ceil(dig * 3.322)
RR = RealField(prec)
...
outfile.write('\tTIDES_PREC = {};'.format(prec))   # instead of set_precision_digits()
```


> This commit addresses mostly all your comments, but i think that the code could be greatly improved if we pass the domain to fast_callable, which would directly convert all constants, avoiding us the work of converting the exact expressions to the strings that represent them in floating point.
I have no experience with `fast_callable`, so I cannot judge.

> Besides, there is also some room for improvement in the performance of `remove_repeated` .
> 
> I will work on that, but i am not sure if it should be done in this ticket
Not on this ticket.



---

archive/issue_comments_224232.json:
```json
{
    "body": "You are right. I was trying to make an unnecessary extra conversion to string. This should address the issues for this ticket. I will open another one for the mentiones improvements in the future.\n\nJust out of curiosity: do you actually use TIDES?",
    "created_at": "2014-10-20T21:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224232",
    "user": "https://github.com/miguelmarco"
}
```

You are right. I was trying to make an unnecessary extra conversion to string. This should address the issues for this ticket. I will open another one for the mentiones improvements in the future.

Just out of curiosity: do you actually use TIDES?



---

archive/issue_comments_224233.json:
```json
{
    "body": "Replying to [comment:9 mmarco]:\n> Just out of curiosity: do you actually use TIDES?\nNo, I don't. I only posted a comment on the TIDES ticket because it didn't work anymore with #16025.",
    "created_at": "2014-10-21T06:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224233",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 mmarco]:
> Just out of curiosity: do you actually use TIDES?
No, I don't. I only posted a comment on the TIDES ticket because it didn't work anymore with #16025.



---

archive/issue_comments_224234.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-10-22T21:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224234",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_224235.json:
```json
{
    "body": "Is this supposed to be ready for review?",
    "created_at": "2014-10-23T15:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224235",
    "user": "https://github.com/jdemeyer"
}
```

Is this supposed to be ready for review?



---

archive/issue_comments_224236.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-10-23T16:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224236",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_224237.json:
```json
{
    "body": "Yes, sorry",
    "created_at": "2014-10-23T16:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224237",
    "user": "https://github.com/miguelmarco"
}
```

Yes, sorry



---

archive/issue_comments_224238.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-10-28T20:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224238",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_224239.json:
```json
{
    "body": "Positive review, provided that tests pass.",
    "created_at": "2014-10-28T20:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224239",
    "user": "https://github.com/jdemeyer"
}
```

Positive review, provided that tests pass.



---

archive/issue_comments_224240.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-29T10:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16942#issuecomment-224240",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_016389.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-29T10:38:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16942",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16942#event-16389"
}
```
