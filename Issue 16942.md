# Issue 16942: TIDES interface should convert exact parameters to floating points.

Issue created by migration from Trac.

Original creator: mmarco

Original creation time: 2014-10-19 18:31:21

CC:  imark

TIDES interface admits expressions like pi or 2^(1/7) as parameters. They should be converted to floating point numbers of the appropiate precission.


---

Comment by jdemeyer created at 2014-10-19 18:55:41

Could you please give an example of something which works/doesn't work?


---

Comment by jdemeyer created at 2014-10-19 18:55:41

Changing type from PLEASE CHANGE to defect.


---

Comment by mmarco created at 2014-10-19 19:46:39

Yes, sorry, i am working in a patch. I will include a branch in a few hours.

The idea is that, for instance, if you pass pi as an initial condition, the .c code created will have the string "pi" instead of "3.141592", and then the compiler would complain.


---

Comment by mmarco created at 2014-10-19 21:17:19

Changing status from new to needs_review.


---

Comment by mmarco created at 2014-10-19 21:17:19

This branch converts expressions like "pi" to their floating point literals.

This should take care of the issues in #16025
----
New commits:


---

Comment by jdemeyer created at 2014-10-20 07:17:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-10-20 07:17:06

Some comments:
* Instead of `mkdtemp()`, you can use `tmp_dir()` from `sage.misc.temporary_file`. That gets cleaned automatically.

* Instead of `TIDES_RND`, I would use an explicit `MPFR_RNDN` instead in the `mpfr_set_str()` calls.

* Remove the unused imports of `SAGE_ROOT`, `os`, `shutil` and `N`.

* Do you really need `RR(SR(foo))`, isn't `RR(foo)` sufficient?

* Tides uses

```
int binary_precision(int prec) {
    return ceil(prec * 3.3219);
}
```

to convert from decimal to binary precision, perhaps you should use the same formula?

* You should use the `.str(truncate=False)` method to convert a `RealNumber` to a string, because by default Sage prints reals with less digits. Compare

```
sage: RR(pi).str(truncate=False)
'3.1415926535897931'
sage: RR(pi).str()
'3.14159265358979'
```


* Then something unrelated to this ticket: `exp()` in an expression currently doesn't work.

* Finally, fill in your real name as author on this ticket.


---

Comment by mmarco created at 2014-10-20 12:35:11

`RR(SR(foo))` is used because strings like `"pi"` or `"-3/2"` are not accepted by the element constructor of real fields. They are accepted by the element constructor of SR though. So it was the best way i could find to create a RealField element from these strings.

The real value of log(10)/log(2) is between 3.3219 and 3.322, so i prefeared to be conservative in this aspect. 

This commit addresses mostly all your comments, but i think that the code could be greatly improved if we pass the domain to fast_callable, which would directly convert all constants, avoiding us the work of converting the exact expressions to the strings that represent them in floating point.

Besides, there is also some room for improvement in the performance of `remove_repeated` .

I will work on that, but i am not sure if it should be done in this ticket (maybe we should change the title?)


---

Comment by git created at 2014-10-20 12:36:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-20 18:14:36

Replying to [comment:6 mmarco]:
> `RR(SR(foo))` is used because strings like `"pi"` or `"-3/2"` are not accepted by the element constructor of real fields.
I would say that's a good thing! Why _should_ strings like that be accepted as input? I think it's reasonable to accept the elements `pi` (element of `SR`) and `3/2` (element of `QQ`) but not the strings `"pi"` or `"-3/2"`.

> The real value of log(10)/log(2) is between 3.3219 and 3.322, so i prefeared to be conservative in this aspect.
If your precision doesn't agree with `TIDES_PREC`, the result might actually be _less precise_: mpfr guarantees that the string representation (with `truncate=False` in Sage) is such that the exact same real number will be created by `mpfr_set_str(string, MPFR_RNDN)` _provided that the precision is the same_.

I understand that you prefer to round `log(10)/log(2)` up, but then `TIDES_PREC` should agree with this:

```
prec = ceil(dig * 3.322)
RR = RealField(prec)
...
outfile.write('\tTIDES_PREC = {};'.format(prec))   # instead of set_precision_digits()
```


> This commit addresses mostly all your comments, but i think that the code could be greatly improved if we pass the domain to fast_callable, which would directly convert all constants, avoiding us the work of converting the exact expressions to the strings that represent them in floating point.
I have no experience with `fast_callable`, so I cannot judge.

> Besides, there is also some room for improvement in the performance of `remove_repeated` .
> 
> I will work on that, but i am not sure if it should be done in this ticket
Not on this ticket.


---

Comment by mmarco created at 2014-10-20 21:20:29

You are right. I was trying to make an unnecessary extra conversion to string. This should address the issues for this ticket. I will open another one for the mentiones improvements in the future.

Just out of curiosity: do you actually use TIDES?


---

Comment by jdemeyer created at 2014-10-21 06:35:12

Replying to [comment:9 mmarco]:
> Just out of curiosity: do you actually use TIDES?
No, I don't. I only posted a comment on the TIDES ticket because it didn't work anymore with #16025.


---

Comment by git created at 2014-10-22 21:34:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-23 15:55:41

Is this supposed to be ready for review?


---

Comment by mmarco created at 2014-10-23 16:00:40

Changing status from needs_work to needs_review.


---

Comment by mmarco created at 2014-10-23 16:00:40

Yes, sorry


---

Comment by jdemeyer created at 2014-10-28 20:06:17

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-10-28 20:06:17

Positive review, provided that tests pass.


---

Comment by vbraun created at 2014-10-29 10:38:04

Resolution: fixed
