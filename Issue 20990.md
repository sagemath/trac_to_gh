# Issue 20990: sage_mode for emacs has display problem in sage 7.4 beta0

Issue created by migration from https://trac.sagemath.org/ticket/21227

Original creator: mantepse

Original creation time: 2016-08-11 21:45:45

CC:  darthandrus@gmail.com jsrn vbraun dimpase fbissey charpent stakemori

Keywords: sage_mode

On sage 7.4 beta0, emacs GNU Emacs 24.3.1 (x86_64-pc-linux-gnu, GTK+ Version 3.10.7) of 2014-03-07 on lamiak, modified by Debian, beloved sage_mode 0.14 is broken.  All in and output except the banner is unreadable!

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.4.beta0, Release Date: 2016-08-10               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
[?12l [?25h1+1
[J [?7h [?12l [?25h [?2004l [?7h2
[?12l [?25h
```



---

Comment by mantepse created at 2016-08-11 21:49:39

Leif mentioned on sage-devel:


```
3) Probably disable the color mode. 
```


I'm not sure what he means with that, but just typing ```%colors NoColor``` after the weird sage prompt doesn't help.


---

Comment by leif created at 2016-08-11 22:15:47

You may play with (settings in)

```
sage: %config SageTerminalInteractiveShell
```



---

Comment by leif created at 2016-08-11 22:17:54

(Sage 7.4.beta0 upgraded IPython to 5.0, see #21006.)


---

Comment by mkoeppe created at 2016-08-18 19:50:13

Here's a simple change that enables "simple prompts" when sage is run within an Emacs inferior shell. 
However, as has been noted [here](http://emacs.stackexchange.com/questions/24453/weird-shell-output-when-using-ipython-5), the "simple prompts" mode lacks multi-line support, so one gets this:

```
In [1]: def f(x):
  File "<ipython-input-1-cde3fd95d55b>", line 1
    def f(x):
             ^
SyntaxError: unexpected EOF while parsing
```



```diff
diff --git a/src/sage/repl/interpreter.py b/src/sage/repl/interpreter.py
index 1f4eda7..1d69829 100644
--- a/src/sage/repl/interpreter.py
+++ b/src/sage/repl/interpreter.py
@@ -248,6 +248,14 @@ class SageTerminalInteractiveShell(SageShellOverride, TerminalInteractiveShell):
         <sage.repl.interpreter.SageNotebookInteractiveShell object at 0x...>
     """
 
+    def init_prompt_toolkit_cli(self):
+        """
+        Use plain non-interactive output if TERM=dumb (as in an Emacs inferior shell)
+        """
+        if os.environ['TERM'] == 'dumb':
+            self.simple_prompt = True
+        return super(SageTerminalInteractiveShell, self).init_prompt_toolkit_cli()
+
     def init_display_formatter(self):
         """
         Switch to the Sage IPython commandline rich output backend
```



---

Comment by mantepse created at 2016-08-18 20:12:04

Thank you for this!  At least I can work again!


---

Comment by mkoeppe created at 2016-08-18 21:32:48

I've opened an IPython issue for this:
https://github.com/ipython/ipython/issues/9886
----
New commits:


---

Comment by charpent created at 2016-08-22 15:47:00

A few remarks :

* The [current patch](https://git.sagemath.org/sage.git/commit?id=92378caa0c1a030b9399e889f42edb5afc8c6d87) waits endlessly for a prompt.
* When interrupted (C-G), it gives a functional prompt : the Sage REPL is working.
* When inline plots are enabled, they are displayed, but the sustems claims (falsely) to have launced a png viewer.
* When tyepeset output is enabled in the menu, the output is displayed as text :

```
In [24]: integrate(arctan(x),x)


BEGIN_TEXT:x*arctan(x) - 1/2*log(x^2 + 1):END_TEXT
BEGIN_LATEX:\newcommand{\Bold}[1]{\mathbf{#1}}x \arctan\left(x\right) - \frac{1}{2} \, \log\left(x^{2} + 1\right):END_LATEX
```

* Ditto when using the `%display typeset` magic...

//"Oooohhh, so clooose..."//

HTH,


---

Comment by mantepse created at 2016-08-30 07:33:51

Changing priority from major to blocker.


---

Comment by mantepse created at 2016-08-30 07:33:51

I'm making this a blocker, because without fix sage would loose a frontend which is used by not so few.  I also tried the ipython 5.0 branch of https://github.com/stakemori/sage-shell-mode, but could not (yet) get it to work.  (Install went OK, but I cannot even evaluate 1+1.)


---

Comment by stakemori created at 2016-09-06 22:54:20

I've pushed fixes to the master branch of sage-shell-mode. sage-shell-mode was fixed. To use sage-shell-mode with Sage7.4 beta0, please set `sage-shell:use-prompt-toolkit` to `t`.

As for the patch, could you use an environment variable other than `TERM`? (IPython uses `IPY_TEST_SIMPLE_PROMPT` for the same purpose). If this is merged, `sage-shell-mode` is forced to use the simple prompt. And I don't want to use the simple prompt inside Emacs.

I think sage-mode (or inferior-python-mode) has to implement its own process filter function to fix this bug (without using simple prompt). IPython sends escape sequences that delete text or move the cursor position. So just ignoring escape sequences doesn't work. `comint-mode` cannot handle escape sequences well, but `term-mode` can handle them very well. So I imitated `term-mode`.


---

Comment by mkoeppe created at 2016-09-06 23:03:45

Replying to [comment:14 stakemori]:
> I've pushed fixes to the master branch of sage-shell-mode. sage-shell-mode was fixed. To use sage-shell-mode with Sage7.4 beta0, please set `sage-shell:use-prompt-toolkit` to `t`.
> 
> As for the patch, could you use an environment variable other than `TERM`? (IPython uses `IPY_TEST_SIMPLE_PROMPT` for the same purpose). If this is merged, `sage-shell-mode` is forced to use the simple prompt. And I don't want to use the simple prompt inside Emacs.
> 
> I think sage-mode (or inferior-python-mode) has to implement its own process filter function to fix this bug (without using simple prompt). IPython sends escape sequences that delete text or move the cursor position. So just ignoring escape sequences doesn't work. `comint-mode` cannot handle escape sequences well, but `term-mode` can handle them very well. So I imitated `term-mode`.

Well, term-mode does not set `TERM=dumb`. It sets `TERM=eterm-color`. So?


---

Comment by stakemori created at 2016-09-06 23:19:17

Sorry. I don't understand your question. What I meant is that the process filter function in `term-mode` (`term-emulate-terminal`) handles escape sequences very well. `sage-shell-mode` is also derived from `comint-mode`.


---

Comment by mkoeppe created at 2016-09-06 23:30:34

Replying to [comment:17 stakemori]:
> Sorry. I don't understand your question. What I meant is that the process filter function in `term-mode` (`term-emulate-terminal`) handles escape sequences very well. `sage-shell-mode` is also derived from `comint-mode`.

What I'm saying is that:
 - term-mode sets `TERM=eterm-color` and so, even with the patch on this ticket, no "simple prompts" are used.
 - `comint-mode` does not handle escape sequences. Therefore it sets `TERM=dumb` to inform the applications running under it about this fact. 
 - If your mode, derived from `comint-mode`, handles escape sequences, then it should not be using `TERM=dumb` but rather something else; perhaps `TERM=vt100`.


---

Comment by stakemori created at 2016-09-06 23:40:43

Thanks for your explanation. I will change it to other than `dumb`.


---

Comment by mkoeppe created at 2016-09-06 23:49:10

Unfortunately IPython/Prompt Toolkit don't handle the TERM variable. I've just reported another upstream issue here (in addition to the IPython one, which so far has been ignored): https://github.com/jonathanslenders/python-prompt-toolkit/issues/390


---

Comment by mantepse created at 2016-09-07 07:17:59

I am so grateful that you are working on this!  I'm documenting here how it went, following `Installation and Setup` in `README.org`:

1. perfect
2. perfect
3. `set sage-shell:use-prompt-toolkit to non-nil` I wanted to use customize, but it complains:

```
Creating customization items...
widget-apply: Symbol's function definition is void: nil
```

4. doing `M-x sage-shell:run-sage` I get `sage-shell:-window-max-chars-per-line: Wrong number of arguments: window-body-width, 2`


---

Comment by stakemori created at 2016-09-07 07:51:40

Thanks. I've pushed fix to master. But it will take a few hours for Melpa to rebuild the recipe.
As for 3, please put `(setq sage-shell:use-prompt-toolkit t)` in your configuration file.

According to the error message, it seems that you are using Emacs older than 24.4. Please use Emacs 24.4 or later.


---

Comment by mantepse created at 2016-09-07 08:03:45

Replying to [comment:22 stakemori]:
> Thanks. I've pushed fix to master. But it will take a few hours for Melpa to rebuild the recipe.
> As for 3, please put `(setq sage-shell:use-prompt-toolkit t)` in your configuration file.
> 
> According to the error message, it seems that you are using Emacs older than 24.4. Please use Emacs 24.4 or later.

Indeed, 24.3.1...

I'm a bit afraid of upgrading, but I guess I'll do it :-)


---

Comment by mantepse created at 2016-09-07 13:17:55

I did it (not quite sure yet whether I like Ubuntu 16.04...)

Anyway: `M-x sage-shell:run-sage` starts sage and I can evaluate stuff.

* I have no tab-completion (the modeline says: "No match")
* sending a buffer to the `*sage*` buffer breaks emacs `(Error running timer: (wrong-type-argument bufferp nil)` occupies the modeline and won't go away anymore.

thanks for helping!


---

Comment by stakemori created at 2016-09-07 15:06:04

`tab-completion` and sending buffer work for me (http://i.imgur.com/LL6vm3b.png). I am not sure why such an error occurs.


---

Comment by stakemori created at 2016-09-07 15:36:02

Can you reproduce this even if only `sage-shell-mode` is loaded? If so, could you tell me the Emacs version and a recipe for reproducing?


---

Comment by mantepse created at 2016-09-07 15:46:42

I am using sage 7.4.beta1 with the patch on this ticket applied, emacs is 24.5.1.  Running `emacs -q` and then in `*scratch*`:

```
(require 'package)
package

(add-to-list 'package-archives
             '("melpa" . "https://melpa.org/packages/"))
(("melpa" . "https://melpa.org/packages/") ("gnu" . "http://elpa.gnu.org/packages/"))

(package-initialize)
t
(setq sage-shell:use-prompt-toolkit 'T)
T
(setq sage-shell:sage-root "~/SAGE")
"~/SAGE"
```

and finally

```
M-x sage-shell:run-sage
```

gives

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 7.4.beta1, Release Date: 2016-08-17               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
In [1]: 12.is
```

but no tab-completion.


---

Comment by stakemori created at 2016-09-07 22:03:52

Thanks. I have not implemented the simple prompts feature. So `sage-shell-mode` does not work well with the patch. The latest `sage-shell-mode` in MELPA sets `TERM` to `emacs`. Please upgrade `sage-shell-mode` by `M-x package-list-packages`, `U` and `x`. The problem still persists?


---

Comment by stakemori created at 2016-09-07 23:44:59

It seems that `sage-shell-mode` must set `TERM` to `dumb`. `sage-shell-mode` is not a full terminal emulator. It can handle a part of escape sequences but not all. Also it doesn't handle pager. I set `TERM` to `emacs`, but the `clear` command shows an error message. Again, could you use an environment variable other than `TERM` in the patch?


---

Comment by mantepse created at 2016-09-08 04:29:29

I'm confused now.  Is `sage-shell-mode` working on your computer without the patch in this ticket?  (I thought that "simple prompts" is not a feature, but a workaround.)


---

Comment by stakemori created at 2016-09-08 04:43:05

Replying to [comment:30 mantepse]:
> I'm confused now.  Is `sage-shell-mode` working on your computer without the patch in this ticket?  (I thought that "simple prompts" is not a feature, but a workaround.)

Yes. So `sage-shell-mode` support multi-line input (though there exits a minor issue. See https://github.com/stakemori/sage-shell-mode/issues/7).

`sage-shell-mode` can handle a part of escape sequences related to text modification and cursor movement. If `sage-shell:use-prompt-toolkit` is non-nil, then I assume Sage is not using `simple prompt` or `GNU readline`. I will also support `simple prompt` in future.


---

Comment by mantepse created at 2016-09-08 06:55:37

Wow!  I think you are getting very close!

* tab completion works
* sending a buffer with `C-c C-c` to the sage buffer works, also loading a file with `C-c C-l` works.
A little suggestion: if the current buffer is a visited file in sage mode, it would be nice to have `C-c C-c` load the file instead, asking whether to save the buffer if necessary.  Because:

```
sage: load('/tmp/sage_shell_mode17030j9Q/sage_shell_mode_temp.sage')
```

doesn't give me a clue which file I actually loaded!

* unfortunately, sending a line to sage does not work correctly:

```
sage: load('/tmp/sage_shell_mode17030j9Q/sage_shell_mode_temp.py')
  File "/tmp/sage_shell_mode17030j9Q/sage_shell_mode_temp.py", line 3
    sage: fricas('3 * 5')                                                       # optional - fricas
        ^
SyntaxError: invalid syntax
```

I think it doesn't strip the "sage:" anymore - was this done by ipython before?


---

Comment by stakemori created at 2016-09-08 07:22:35

Thank you for trying.

To fix this issue, I had to changed basic functions of this mode. So there may be such problems. Sorry.

> unfortunately, sending a line to sage does not work correctly:

`M-x sage-shell-edit:send-line*` doesn't work? If it works, I will replace the command.

> A little suggestion: if the current buffer is a visited file in sage mode, it would be nice to have C-c C-c load the file instead, asking whether to save the buffer if necessary.

Thank you for the suggestion. I will consider about it.


---

Comment by mantepse created at 2016-09-08 07:37:09

Replying to [comment:33 stakemori]:
> Thank you for trying.
> 
> To fix this issue, I had to changed basic functions of this mode. So there may be such problems. Sorry.

Hey, your work is fantastic!  I have no idea what I would have done without you!

> > unfortunately, sending a line to sage does not work correctly:
> 
> `M-x sage-shell-edit:send-line*` doesn't work? If it works, I will replace the command.

Great! `M-x sage-shell-edit:send-line*` (with the asterisk!) does the right thing!


---

Comment by stakemori created at 2016-09-08 08:00:20

> Hey, your work is fantastic! I have no idea what I would have done without you!

Thank you very much! I am very glad that `sage-shell-mode` works on your computer.

By the way, it would be great if I (or someone) could write a process filter function for `sage-mode` (or `python-mode`) that handles escape sequence. In future, I may write one (but to be honest, I do not want to fix this twice. It was harder than I thought).


---

Comment by mantepse created at 2016-09-08 08:16:01

why would you want to handle escape sequences?


---

Comment by jsrn created at 2016-09-08 08:40:31

Replying to [comment:35 stakemori]:
> By the way, it would be great if I (or someone) could write a process filter function for `sage-mode` (or `python-mode`) that handles escape sequence. In future, I may write one (but to be honest, I do not want to fix this twice. It was harder than I thought).

I'm currently a `sage-mode` user and would be interested in getting it to work again. But my knowledge of terminals and the details of `comint-mode` is not very extensive, and I've lost track of what changes were necessary to make `sage-shell-mode` work again. How difficult would you estimate porting your fixes would be?

But perhaps rather: should we take this as a cue to merge the efforts of `sage-shell-mode` and `sage-mode`; after all, they're trying to do more or less the same. The current maintainer of `sage-mode` is Ivan Andrus but my impression is that he is really only maintaining - not developing. `sage-shell-mode` is much more vibrant in comparison! My impression is that `sage-shell-mode` currently does completion better than `sage-mode`, but `sage-mode` can render latex and images. There might also be small differences in how editing directly in the shell works?

My own contributions to `sage-mode` are modest: I've written the current help file/landing page, I wrote a small set of functions, `sage-blocks.el`, for giving light-weight notebook-like editing, and I've helped report and track down some bugs. Rather than porting fixes to `sage-mode`, I would be interested in trying out `sage-shell-mode` and lending a hand on implementing the features that would make it a great alternative for current `sage-mode` users. I'm also an `eVil`-user, so I would naturally be testing/modding `sage-shell-mode` to work under those conditions.

Best,
Johan


---

Comment by stakemori created at 2016-09-08 11:32:25

Replying to [comment:36 mantepse]:
> why would you want to handle escape sequences?

I don't want to handle escape sequences if possible. But developers of IPython choose `prompt_toolkit` rather than `readline` and `prompt_toolkit` uses a lot of escape sequences. Therefore I think `sage-shell-mode` should handle them. And I don't want to use the simple prompt workaround at the moment.


---

Comment by stakemori created at 2016-09-08 11:38:40

> I'm currently a sage-mode user and would be interested in getting it to work again. But my knowledge of terminals and the details of comint-mode is not very extensive, and I've lost track of what changes were necessary to make sage-shell-mode work again. How difficult would you estimate porting your fixes would be?

If you use the simple prompt workaround, then I guess it would be easy to fix `sage-mode`. But you might lose some features because of the workaround (Above, charpent remarked that
  "When inline plots are enabled, they are displayed, but the sustems claims (falsely) to have launced a png viewer."
I am not sure if it is because of the workaround).

If you don't use the workaround, then it would be not so easy to fix it. Most important point is to implement a process filter function. `comint-output-filter` doesn't work. If you want to implement it, you could copy code in `sage-shell-mode` and I could help you.


> But perhaps rather: should we take this as a cue to merge the efforts of sage-shell-mode and sage-mode; after all, they're trying to do more or less the same. The current maintainer of sage-mode is Ivan Andrus but my impression is that he is really only maintaining - not developing. sage-shell-mode is much more vibrant in comparison! My impression is that sage-shell-mode currently does completion better than sage-mode, but sage-mode can render latex and images. There might also be small differences in how editing directly in the shell works?

I am OK with merging. I would be glad if `sage-shell-mode` could render latex and images. I have exchanged email with Ivan Andrus a few years ago. He was also writing about merging. I guess he also might agree with merging.

I do not understand `sage-blocks.el` very well. Is it similar to ob-sagemath (https://github.com/stakemori/ob-sagemath)? And I would be very happy if you contributed to `sage-shell-mode`.


---

Comment by jsrn created at 2016-09-08 13:08:21

Replying to [comment:39 stakemori]:
> If you don't use the workaround, then it would be not so easy to fix it. Most important point is to implement a process filter function. `comint-output-filter` doesn't work. If you want to implement it, you could copy code in `sage-shell-mode` and I could help you.

OK, thanks. I'll first try to see if `sage-shell-mode` could be a replacement for me.

> I am OK with merging. I would be glad if `sage-shell-mode` could render latex and images. I have exchanged email with Ivan Andrus a few years ago. He was also writing about merging. I guess he also might agree with merging.

OK.

> I do not understand `sage-blocks.el` very well. Is it similar to ob-sagemath (https://github.com/stakemori/ob-sagemath)?

It's much simpler than that: it simply assumes that the user has logically separated his source file using markers (`###` by default), each of which we call a "block". Then there are keybindings for dealing with these: moving up/down block-wise and sending the current block to the shell. This is extremely handy for the way I develop Sage. It's so simple that it would be easy to port to `sage-shell-mode`, I'm sure.

> And I would be very happy if you contributed to `sage-shell-mode`.

As a first approximation, I've cloned `sage-shell-mode` and I'm trying it out. As you've already seen I'll post Issues when I hit funky behaviour ;-)

Thanks for your hard work on this!

Best,
Johan


---

Comment by mantepse created at 2016-09-08 15:40:43

> > unfortunately, sending a line to sage does not work correctly:
> 
> `M-x sage-shell-edit:send-line*` doesn't work? If it works, I will replace the command.

That would be great!

Another tiny problem: saying

```
(sage-shell:define-alias)
```

in `.emacs` doesn't work - must it be in `.emacs.d/init.el`?

```
Warning (initialization): An error occurred while loading `/home/martin/.emacs':

Symbol's function definition is void: sage-shell:define-alias
```



---

Comment by mkoeppe created at 2016-09-08 17:08:56

Replying to [comment:29 stakemori]:
> It seems that `sage-shell-mode` must set `TERM` to `dumb`. `sage-shell-mode` is not a full terminal emulator. It can handle a part of escape sequences but not all. Also it doesn't handle pager. I set `TERM` to `emacs`, but the `clear` command shows an error message. Again, could you use an environment variable other than `TERM` in the patch?

But I don't have control over the environment variables that are set within a `M-x shell` in emacs.


---

Comment by mkoeppe created at 2016-09-08 17:30:53

Replying to [comment:42 mkoeppe]:
> Replying to [comment:29 stakemori]:
> > It seems that `sage-shell-mode` must set `TERM` to `dumb`. `sage-shell-mode` is not a full terminal emulator. It can handle a part of escape sequences but not all. Also it doesn't handle pager. I set `TERM` to `emacs`, but the `clear` command shows an error message. Again, could you use an environment variable other than `TERM` in the patch?
> 
> But I don't have control over the environment variables that are set within a `M-x shell` in emacs.

Here's a reference that may be helpful in choosing the right TERM that reflects what you implemented. http://invisible-island.net/ncurses/terminfo.src.html


---

Comment by stakemori created at 2016-09-08 23:35:07

> It's much simpler than that: it simply assumes that the user has logically separated his source file using markers (### by default), each of which we call a "block". Then there are keybindings for dealing with these: moving up/down block-wise and sending the current block to the shell. This is extremely handy for the way I develop Sage. It's so simple that it would be easy to port to sage-shell-mode, I'm sure.

Thank you for explanation. It looks very convenient.


---

Comment by stakemori created at 2016-09-08 23:41:42

Replying to [comment:41 mantepse]:
> > > unfortunately, sending a line to sage does not work correctly:
> > 
> > `M-x sage-shell-edit:send-line*` doesn't work? If it works, I will replace the command.
> 
> That would be great!
> 
> Another tiny problem: saying
> {{{
> (sage-shell:define-alias)
> }}}
> in `.emacs` doesn't work - must it be in `.emacs.d/init.el`?
> {{{
> Warning (initialization): An error occurred while loading `/home/martin/.emacs':
> 
> Symbol's function definition is void: sage-shell:define-alias
> }}}

It is OK to use `.emacs`. Place is not a problem, the order of evaluation is a problem. You should evaluate `(package-initialize)` before evaluating `(sage-shell:define-alias)`. I hope this helps.


---

Comment by stakemori created at 2016-09-08 23:43:23

> Here's a reference that may be helpful in choosing the right TERM that reflects what you implemented. ​http://invisible-island.net/ncurses/terminfo.src.html

Thank you. It looks very helpful. I will read it carefully.


---

Comment by mantepse created at 2016-09-09 06:05:50

Replying to [comment:45 stakemori]:

> It is OK to use `.emacs`. Place is not a problem, the order of evaluation is a problem. You should evaluate `(package-initialize)` before evaluating `(sage-shell:define-alias)`. I hope this helps.

Yes, it does!  You are my emacs 24 hero!

Martin


---

Comment by iandrus created at 2016-09-12 15:54:14

I would be happy to combine sage-mode and sage-shell-mode.  I quite like sage-mode, but I haven't had much time for working on it, and don't forsee that I will in the future either.  Sage users deserve something that's maintained.  

Long ago I wrote a feature comparison at https://wiki.sagemath.org/SageModeComparison but it's probably out of date.  For example, I think sage-shell-mode recently got blocks.  If that's the case then the things to port from sage-mode to 

- AUCTeX integration 
  - This can probably be copied as-is or moved to a separate package entirely.  I think it only references sage-mode once.
- Inline plots and typeset output
  - This is somewhat intricate, but could probably be simplified by dropping support for ancient versions of Sage.
- Doctesting and Building help
  - I'm less sure about how much work this will be.

If I get some time I'll start looking at sage-shell-mode's code to see if I can submit a pull request or something.


---

Comment by stakemori created at 2016-09-13 04:51:51

Replying to [comment:48 iandrus]:

Thank you very much! I also would be very glad if you could port those features to `sage-shell-mode`.


---

Comment by mantepse created at 2016-09-14 17:34:18

I suggest to close the ticket, since `sage-shell-mode` now works very well, as far as I can tell.

**Thank you stakemori!

The optional package `sage-mode` does not work anymore, so it probably should be moved to experimental or something similar.

I have no idea how to do any of this, though.


---

Comment by mkoeppe created at 2016-09-14 18:27:40

Let's keep this ticket open to keep track of the issues that I reported upstream with IPython and python-prompt-toolkit.


---

Comment by jsrn created at 2016-09-15 06:51:04

Considering the excellent state of `sage-shell-mode` and the Comment 48 by Ivan, perhaps we should also open a ticket for making `sage-shell-mode` the default package in Sage for Emacs, and move `sage-mode` to experimental or remove it.


---

Comment by stakemori created at 2016-09-15 09:05:52

mantepse, you are welcome!

jsrn, thanks for the suggestion. 

> making sage-shell-mode the default package in Sage for Emacs

What does it exactly mean? It means editing the wiki or the link in http://www.sagemath.org/download-linux.html?


---

Comment by jsrn created at 2016-09-15 12:16:42

> > making sage-shell-mode the default package in Sage for Emacs
> 
> What does it exactly mean? It means editing the wiki or the link in http://www.sagemath.org/download-linux.html? 

Yes, something like:

1. Modify the link http://www.sagemath.org/download-linux.html.
1. Modify any other mention of `sage-mode` on sagemath.org.
1. Modify any mention of `sage-mode` on the Sage wiki.
1. Don't ship `sage-mode` together with Sage.
1. Start shipping `sage-emacs-mode` with Sage? I vote yes.
1. Modify references to `sage-mode` in source code (a grep found e.g. `src/sage/repl/rich_output/backend_emacs.py` which might be necessary for porting `sage-view` to `sage-shell-mode`).

Apart from that one could consider:

1. In future `sage-shell-mode` releases, consider activating the aliases by default.
1. Put a warning on the `sage-mode` bitbucket page that it no longer works?


---

Comment by mantepse created at 2016-09-15 12:26:55

Actually, given that iandrus agrees and is interested in having the remaining features of `sage-mode` merged into `sage-shell-mode`, and given that `sage-mode` is unlikely to be resurrected, wouldn't it be easier to make `sage-mode` an alias for `sage-shell-mode`?


---

Comment by stakemori created at 2016-09-15 22:34:57

Thanks for making the list, jsrn.

> Modify any other mention of sage-mode on sagemath.org.
Do you know how to do this? I don't know.

> In future sage-shell-mode releases, consider activating the aliases by default.
To do this, `sage-shell-mode` has to renamed to `sage-mode` or `sage`. This is convention of elisp.

> given that sage-mode is unlikely to be resurrected

If mkoeppe's request to `prompt_toolkit` is accepted, `sage-mode` will be resurrected. So concerning with alias or renaming, I will see how it goes for a while.


---

Comment by mkoeppe created at 2016-09-15 22:57:22

Renaming software is usually not a good idea, because it causes confusion.


---

Comment by mkoeppe created at 2016-09-16 07:03:57

Is sage-shell-mode available on MELPA?


---

Comment by stakemori created at 2016-09-16 07:06:17

Replying to [comment:58 mkoeppe]:
> Is sage-shell-mode available on MELPA?

Yes. https://melpa.org/#/sage-shell-mode


---

Comment by mkoeppe created at 2016-09-16 07:09:25

Great. Then there's probably no need to ship it with Sage (step 5 above), as installing via MELPA is probably the easiest way for users.


---

Comment by stakemori created at 2016-09-16 07:10:45

Replying to [comment:60 mkoeppe]:
I agree.


---

Comment by jsrn created at 2016-09-19 06:48:14

> > Modify any other mention of sage-mode on sagemath.org.
> Do you know how to do this? I don't know.

Hmm, no, sorry.


---

Comment by stakemori created at 2016-09-19 07:42:56

Replying to [comment:62 jsrn]:

There is no need to apologize. Thanks.

I will ask how to do it at sage-devel. But before doing this, I would like iandrus's agreement with making `sage-shell-mode` the default package.


---

Comment by dimpase created at 2016-09-20 22:19:44

to request updates to sagemath.org, submit a pull request with the proposed changes at https://github.com/sagemath/website


---

Comment by stakemori created at 2016-09-21 01:29:56

Replying to [comment:64 dimpase]:
> to request updates to sagemath.org, submit a pull request with the proposed changes at https://github.com/sagemath/website
> 
Thank you very much for your information!


---

Comment by jsrn created at 2016-09-21 07:36:11

I think that Ivan was pretty clear on his stance: "Sage users deserve something that's maintained". In any case, thank you for your hard work on maintaining `sage-mode` these years, Ivan!

Replying to [comment:54 jsrn]:
> 3. Modify any mention of `sage-mode` on the Sage wiki.

I modified the pages [https://wiki.sagemath.org/sage-mode](https://wiki.sagemath.org/sage-mode), [https://wiki.sagemath.org/Emacs](https://wiki.sagemath.org/Emacs) and [https://wiki.sagemath.org/SageModeComparison](https://wiki.sagemath.org/SageModeComparison), but kept all of them for now. Later on we might prune and/or clean them further.

> 4. Don't ship `sage-mode` together with Sage.
> 5. Start shipping `sage-emacs-mode` with Sage? I vote yes.

I opened #21549 for this.

> 6. Modify references to `sage-mode` in source code (a grep found e.g. `src/sage/repl/rich_output/backend_emacs.py` which might be necessary for porting `sage-view` to `sage-shell-mode`).

Until the `sage-view` features of `sage-mode` have been ported to `sage-shell-mode`, it is unclear to me how much of this will be used. I vote for just leaving it for now.

> Apart from that one could consider:
> 
> 1. In future `sage-shell-mode` releases, consider activating the aliases by default.

As pointed out by stakemori, this is against Elisp conventions.

Best,
Johan


---

Comment by jsrn created at 2016-09-21 07:39:33

Changing priority from blocker to major.


---

Comment by jsrn created at 2016-09-21 07:39:33

I removed the "blocker" status since stakemori's hard work means we have a Sage mode again!

I also updated the title of the ticket. Perhaps this ticket will contain the changes to Sage documentation for making `sage-shell-mode` the official Emacs mode?


---

Comment by mantepse created at 2016-09-21 07:48:06

Changing keywords from "sage_mode" to "sage_mode, sage-mode".


---

Comment by mantepse created at 2016-09-21 07:50:15

I am quite sure it would be good (with iandrus permission, of course) to make sage-shell-mode the successor of sage-mode and rename it.  The current function names are terrible to type.


---

Comment by stakemori created at 2016-09-21 10:48:10

Thank you for your good work, Johan!

I sent a PR (https://github.com/sagemath/website/pull/95) to https://github.com/sagemath/website.

> The current function names are terrible to type.

I try to make interactive function names shorter or define more aliases.


---

Comment by mantepse created at 2016-09-21 11:31:03

Replying to [comment:70 stakemori]:

> > The current function names are terrible to type.
> 
> I try to make interactive function names shorter or define more aliases.

Sorry, I was unclear.  What I meant is: without the aliases it's terrible, and it's easier for the user if she doesn't need to modify `.emacs`.  But it's only a suggestion, personally I have no problem.  Indeed, I am very happy.  (special thanks for `send-doctest`, which I immediately bound to `C-c C-j` :-)


---

Comment by mkoeppe created at 2016-09-21 23:00:44

Replying to [comment:51 mkoeppe]:
> Let's keep this ticket open to keep track of the issues that I reported upstream with IPython and python-prompt-toolkit.

I've actually created a new ticket #21558 for that purpose. 
So it's OK with me if the present ticket is closed when items 1--3 are done.


---

Comment by mkoeppe created at 2020-04-25 02:10:15

time to close this ticket


---

Comment by mkoeppe created at 2020-04-25 02:10:15

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-04-25 02:24:13

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-05-22 09:51:06

Resolution: invalid
