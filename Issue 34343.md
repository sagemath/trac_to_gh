# Issue 34343: Shorter and faster implementation of combinat.combination.from_rank

archive/issues_034343.json:
```json
{
    "body": "CC:  @agenitrini\n\nThis patch implements a simpler algorithm for combination unranking.\n\nIt is based on the paper following the pre-print on which the previous implementation was based. The new algorithm is Algorithm 6 (page 20) in https://www.mdpi.com/1999-4893/14/3/97 (I'm an author).\n\nIn addition\n- it removes some redundant checks at the beginning of the function;\n- and it ensures the check that `0 <= rank < binomial(n, k)` happens **before** the special case:\n\n```\nif k == 0:\n    return ()\n```\nThere is a bug with the current implementation where you can call\n`from_rank(dummy_rank, n, 0)` and you will always get `from_rank(0, n, 0)`.\n\n---\n\nVery quick performance comparison:\n\nBefore the patch:\n\n```sage\nsage: set_random_seed(0)\nsage: test_args = [(randint(0, binomial(n, n // 2) - 1), n, n // 2) for n in [100, 1000, 10000, 50000, 100000]]\nsage: from sage.combinat.combination import from_rank\nsage: %time _ = from_rank(*test_args[0])\nCPU times: user 485 \u00b5s, sys: 20 \u00b5s, total: 505 \u00b5s\nWall time: 510 \u00b5s\nsage: %time _ = from_rank(*test_args[1])\nCPU times: user 3.85 ms, sys: 24 \u00b5s, total: 3.87 ms\nWall time: 3.9 ms\nsage: %time _ = from_rank(*test_args[2])\nCPU times: user 47.5 ms, sys: 53 \u00b5s, total: 47.5 ms\nWall time: 46.7 ms\nsage: %time _ = from_rank(*test_args[3])\nCPU times: user 329 ms, sys: 142 \u00b5s, total: 330 ms\nWall time: 335 ms\nsage: %time _ = from_rank(*test_args[4])\nCPU times: user 890 ms, sys: 132 \u00b5s, total: 890 ms\nWall time: 890 ms\n```\n\nAfter the patch:\n\n```sage\nsage: set_random_seed(0)\nsage: test_args = [(randint(0, binomial(n, n // 2) - 1), n, n // 2) for n in [100, 1000, 10000, 50000, 100000]]\nsage: from sage.combinat.combination import from_rank\nsage: %time _ = from_rank(*test_args[0])\nCPU times: user 440 \u00b5s, sys: 42 \u00b5s, total: 482 \u00b5s\nWall time: 488 \u00b5s\nsage: %time _ = from_rank(*test_args[1])\nCPU times: user 2.43 ms, sys: 0 ns, total: 2.43 ms\nWall time: 2.73 ms\nsage: %time _ = from_rank(*test_args[2])\nCPU times: user 26.9 ms, sys: 3.04 ms, total: 30 ms\nWall time: 29.6 ms\nsage: %time _ = from_rank(*test_args[3])\nCPU times: user 198 ms, sys: 116 \u00b5s, total: 198 ms\nWall time: 198 ms\nsage: %time _ = from_rank(*test_args[4])\nCPU times: user 573 ms, sys: 600 \u00b5s, total: 573 ms\nWall time: 573 ms\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/34580\n\n",
    "created_at": "2022-09-24T15:03:26Z",
    "labels": [
        "component: combinatorics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Shorter and faster implementation of combinat.combination.from_rank",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34343",
    "user": "https://github.com/Kerl13"
}
```
CC:  @agenitrini

This patch implements a simpler algorithm for combination unranking.

It is based on the paper following the pre-print on which the previous implementation was based. The new algorithm is Algorithm 6 (page 20) in https://www.mdpi.com/1999-4893/14/3/97 (I'm an author).

In addition
- it removes some redundant checks at the beginning of the function;
- and it ensures the check that `0 <= rank < binomial(n, k)` happens **before** the special case:

```
if k == 0:
    return ()
```
There is a bug with the current implementation where you can call
`from_rank(dummy_rank, n, 0)` and you will always get `from_rank(0, n, 0)`.

---

Very quick performance comparison:

Before the patch:

```sage
sage: set_random_seed(0)
sage: test_args = [(randint(0, binomial(n, n // 2) - 1), n, n // 2) for n in [100, 1000, 10000, 50000, 100000]]
sage: from sage.combinat.combination import from_rank
sage: %time _ = from_rank(*test_args[0])
CPU times: user 485 µs, sys: 20 µs, total: 505 µs
Wall time: 510 µs
sage: %time _ = from_rank(*test_args[1])
CPU times: user 3.85 ms, sys: 24 µs, total: 3.87 ms
Wall time: 3.9 ms
sage: %time _ = from_rank(*test_args[2])
CPU times: user 47.5 ms, sys: 53 µs, total: 47.5 ms
Wall time: 46.7 ms
sage: %time _ = from_rank(*test_args[3])
CPU times: user 329 ms, sys: 142 µs, total: 330 ms
Wall time: 335 ms
sage: %time _ = from_rank(*test_args[4])
CPU times: user 890 ms, sys: 132 µs, total: 890 ms
Wall time: 890 ms
```

After the patch:

```sage
sage: set_random_seed(0)
sage: test_args = [(randint(0, binomial(n, n // 2) - 1), n, n // 2) for n in [100, 1000, 10000, 50000, 100000]]
sage: from sage.combinat.combination import from_rank
sage: %time _ = from_rank(*test_args[0])
CPU times: user 440 µs, sys: 42 µs, total: 482 µs
Wall time: 488 µs
sage: %time _ = from_rank(*test_args[1])
CPU times: user 2.43 ms, sys: 0 ns, total: 2.43 ms
Wall time: 2.73 ms
sage: %time _ = from_rank(*test_args[2])
CPU times: user 26.9 ms, sys: 3.04 ms, total: 30 ms
Wall time: 29.6 ms
sage: %time _ = from_rank(*test_args[3])
CPU times: user 198 ms, sys: 116 µs, total: 198 ms
Wall time: 198 ms
sage: %time _ = from_rank(*test_args[4])
CPU times: user 573 ms, sys: 600 µs, total: 573 ms
Wall time: 573 ms
```

Issue created by migration from https://trac.sagemath.org/ticket/34580





---

archive/issue_comments_486368.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-24T15:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486368",
    "user": "https://github.com/Kerl13"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_486369.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-09-24T19:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486369",
    "user": "https://github.com/Kerl13"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_486370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-24T19:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486370",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486371.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-01T14:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486371",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486372.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-10-01T14:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486372",
    "user": "https://github.com/Kerl13"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_486373.json:
```json
{
    "body": "Forgot to mention in the description that I added a few docstrings and doctests",
    "created_at": "2022-10-01T14:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486373",
    "user": "https://github.com/Kerl13"
}
```

Forgot to mention in the description that I added a few docstrings and doctests



---

archive/issue_comments_486374.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-10-02T13:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486374",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_486375.json:
```json
{
    "body": "Rather than `Compute` in a docstring use `Return`. The fact that a function computes is good to know but not very relevant for its specification.",
    "created_at": "2022-10-26T20:27:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486375",
    "user": "https://github.com/videlec"
}
```

Rather than `Compute` in a docstring use `Return`. The fact that a function computes is good to know but not very relevant for its specification.



---

archive/issue_comments_486376.json:
```json
{
    "body": "Why removing  `[DGH2020]` completely from the references?",
    "created_at": "2022-10-26T20:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486376",
    "user": "https://github.com/videlec"
}
```

Why removing  `[DGH2020]` completely from the references?



---

archive/issue_comments_486377.json:
```json
{
    "body": "Instead of\n\n```\n        # The first combination is the empty set\n        sage: c.unrank(0)\n        []\n```\nDo\n\n```\n    The first combination is the empty set::\n\n        sage: c.unrank(0)\n        []\n```\nThe syntax of documentation string is rather well described at https://doc.sagemath.org/html/en/developer/coding_basics.html",
    "created_at": "2022-10-26T20:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486377",
    "user": "https://github.com/videlec"
}
```

Instead of

```
        # The first combination is the empty set
        sage: c.unrank(0)
        []
```
Do

```
    The first combination is the empty set::

        sage: c.unrank(0)
        []
```
The syntax of documentation string is rather well described at https://doc.sagemath.org/html/en/developer/coding_basics.html



---

archive/issue_comments_486378.json:
```json
{
    "body": "Why is there a `*` introduced in front of \"McCaffrey\" here\n\n```diff\n@@ -546,8 +611,13 @@ def rank(comb, n, check=True):\n     Return the rank of ``comb`` in the subsets of ``range(n)`` of size ``k``\n     where ``k`` is the length of ``comb``.\n \n-    The algorithm used is based on combinadics and James McCaffrey's\n-    MSDN article. See: :wikipedia:`Combinadic`.\n+    The algorithm used is based on combinadics and is adapted from James\n+    *McCaffrey's MSDN article. It differs from McCaffrey's algorithm in the\n+    computation of binomial coefficients. Instead of calling `binomial` every\n+    time a binomial coefficientis needed, we use [GP2021]_'s trick of reusing\n+    the previous coefficient.\n+\n+    See: :wikipedia:`Combinadic`.\n```",
    "created_at": "2022-10-26T20:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486378",
    "user": "https://github.com/videlec"
}
```

Why is there a `*` introduced in front of "McCaffrey" here

```diff
@@ -546,8 +611,13 @@ def rank(comb, n, check=True):
     Return the rank of ``comb`` in the subsets of ``range(n)`` of size ``k``
     where ``k`` is the length of ``comb``.
 
-    The algorithm used is based on combinadics and James McCaffrey's
-    MSDN article. See: :wikipedia:`Combinadic`.
+    The algorithm used is based on combinadics and is adapted from James
+    *McCaffrey's MSDN article. It differs from McCaffrey's algorithm in the
+    computation of binomial coefficients. Instead of calling `binomial` every
+    time a binomial coefficientis needed, we use [GP2021]_'s trick of reusing
+    the previous coefficient.
+
+    See: :wikipedia:`Combinadic`.
```



---

archive/issue_comments_486379.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-12-20T19:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34343",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34343#issuecomment-486379",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.
