# Issue 34343: Shorter and faster implementation of combinat.combination.from_rank

Issue created by migration from https://trac.sagemath.org/ticket/34580

Original creator: MartinPepin

Original creation time: 2022-09-24 15:03:26

CC:  @agenitrini

This patch implements a simpler algorithm for combination unranking.

It is based on the paper following the pre-print on which the previous implementation was based. The new algorithm is Algorithm 6 (page 20) in https://www.mdpi.com/1999-4893/14/3/97 (I'm an author).

In addition
- it removes some redundant checks at the beginning of the function;
- and it ensures the check that `0 <= rank < binomial(n, k)` happens **before** the special case:

```
if k == 0:
    return ()
```

There is a bug with the current implementation where you can call
`from_rank(dummy_rank, n, 0)` and you will always get `from_rank(0, n, 0)`.

----

Very quick performance comparison:

Before the patch:

```sage
sage: set_random_seed(0)
sage: test_args = [(randint(0, binomial(n, n // 2) - 1), n, n // 2) for n in [100, 1000, 10000, 50000, 100000]]
sage: from sage.combinat.combination import from_rank
sage: %time _ = from_rank(*test_args[0])
CPU times: user 485 µs, sys: 20 µs, total: 505 µs
Wall time: 510 µs
sage: %time _ = from_rank(*test_args[1])
CPU times: user 3.85 ms, sys: 24 µs, total: 3.87 ms
Wall time: 3.9 ms
sage: %time _ = from_rank(*test_args[2])
CPU times: user 47.5 ms, sys: 53 µs, total: 47.5 ms
Wall time: 46.7 ms
sage: %time _ = from_rank(*test_args[3])
CPU times: user 329 ms, sys: 142 µs, total: 330 ms
Wall time: 335 ms
sage: %time _ = from_rank(*test_args[4])
CPU times: user 890 ms, sys: 132 µs, total: 890 ms
Wall time: 890 ms
```


After the patch:

```sage
sage: set_random_seed(0)
sage: test_args = [(randint(0, binomial(n, n // 2) - 1), n, n // 2) for n in [100, 1000, 10000, 50000, 100000]]
sage: from sage.combinat.combination import from_rank
sage: %time _ = from_rank(*test_args[0])
CPU times: user 440 µs, sys: 42 µs, total: 482 µs
Wall time: 488 µs
sage: %time _ = from_rank(*test_args[1])
CPU times: user 2.43 ms, sys: 0 ns, total: 2.43 ms
Wall time: 2.73 ms
sage: %time _ = from_rank(*test_args[2])
CPU times: user 26.9 ms, sys: 3.04 ms, total: 30 ms
Wall time: 29.6 ms
sage: %time _ = from_rank(*test_args[3])
CPU times: user 198 ms, sys: 116 µs, total: 198 ms
Wall time: 198 ms
sage: %time _ = from_rank(*test_args[4])
CPU times: user 573 ms, sys: 600 µs, total: 573 ms
Wall time: 573 ms
```



---

Comment by MartinPepin created at 2022-09-24 15:04:03

Changing status from new to needs_review.


---

Comment by MartinPepin created at 2022-09-24 19:19:47

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-09-24 19:32:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-10-01 14:32:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by MartinPepin created at 2022-10-01 14:49:22

Changing status from needs_work to needs_review.


---

Comment by MartinPepin created at 2022-10-01 14:50:38

Forgot to mention in the description that I added a few docstrings and doctests


---

Comment by git created at 2022-10-02 13:24:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2022-10-26 20:27:31

Rather than `Compute` in a docstring use `Return`. The fact that a function computes is good to know but not very relevant for its specification.


---

Comment by vdelecroix created at 2022-10-26 20:28:00

Why removing  `[DGH2020]` completely from the references?


---

Comment by vdelecroix created at 2022-10-26 20:30:27

Instead of

```
        # The first combination is the empty set
        sage: c.unrank(0)
        []
```

Do

```
    The first combination is the empty set::

        sage: c.unrank(0)
        []
```

The syntax of documentation string is rather well described at https://doc.sagemath.org/html/en/developer/coding_basics.html


---

Comment by vdelecroix created at 2022-10-26 20:32:19

Why is there a `*` introduced in front of "McCaffrey" here

```diff
@@ -546,8 +611,13 @@ def rank(comb, n, check=True):
     Return the rank of ``comb`` in the subsets of ``range(n)`` of size ``k``
     where ``k`` is the length of ``comb``.
 
-    The algorithm used is based on combinadics and James McCaffrey's
-    MSDN article. See: :wikipedia:`Combinadic`.
+    The algorithm used is based on combinadics and is adapted from James
+    *McCaffrey's MSDN article. It differs from McCaffrey's algorithm in the
+    computation of binomial coefficients. Instead of calling `binomial` every
+    time a binomial coefficientis needed, we use [GP2021]_'s trick of reusing
+    the previous coefficient.
+
+    See: :wikipedia:`Combinadic`.
```



---

Comment by mkoeppe created at 2022-12-20 19:42:45

Changing status from needs_review to needs_work.
