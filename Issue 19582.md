# Issue 19582: Update to pynac-0.5.4

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2016-01-01 16:40:52

New in 0.5.4:
* fix expansion of `abs(power)` (#19797)
* fix a wrong function option with `zeta/zeta2` (#19799)
* fix wrong formula for `tan(...).imag()` (#19791)
* fix `mpq_pythonhash` (#19310)
* change hash type to `int64_t` (#19310)
* expand `exp(m/n*pi*I)` with trig functions if they can be expanded (#19738)
* start changing libtool version with each release
* performance: in `exp_eval` check for `Pi` and `I` before trying to divide
* performance: much less canonicalizations of GMP rationals
* performance: cache pseries coeff accesses in `pseries::mul_series`
* performance: `GinacFunction`s for `cot/acot`
* C++11: add `override` where possible

https://github.com/pynac/pynac/releases/download/pynac-0.5.4/pynac-0.5.4.tar.bz2


---

Comment by jdemeyer created at 2016-01-01 17:50:42

Replying to [ticket:19819 rws]:
> * change hash type to `int64_t` (#19310)

Why `int64_t`? The type should be `long`.


---

Comment by fbissey created at 2016-01-01 22:25:21

Replying to [comment:1 jdemeyer]:
> Replying to [ticket:19819 rws]:
> > * change hash type to `int64_t` (#19310)
> 
> Why `int64_t`? The type should be `long`.
`long` doesn't guarantee anything in term of width. If you want something that is 64bit wide, you better be explicit about it. The `C` standard is rather annoying when it comes to variable size, especially `long` types - unless I missed something in a newer version of the standard.


---

Comment by jdemeyer created at 2016-01-01 22:47:46

Replying to [comment:2 fbissey]:
> If you want something that is 64bit wide
We don't.


---

Comment by rws created at 2016-01-02 06:32:50

Replying to [comment:3 jdemeyer]:
> Replying to [comment:2 fbissey]:
> > If you want something that is 64bit wide
> We don't.
You will get doctest fails (#19310) on 32-bit.


---

Comment by rws created at 2016-01-02 07:42:04

And if you don't care about 32bit: `int64_t` is typedefed to `long` on 64bit. I won't rewrite this just because you don't like the look of `int64_t`.


---

Comment by jdemeyer created at 2016-01-02 09:05:38

Replying to [comment:5 rws]:
> And if you don't care about 32bit
I care about 32 bit and about 64 bit.

> I won't rewrite this just because you don't like the look of `int64_t`.
I don't think you need to rewrite anything. A simple search-and-replace `int64_t` -> `long` would probably work.


---

Comment by jdemeyer created at 2016-01-02 09:05:59

Replying to [comment:4 rws]:
> You will get doctest fails (#19310) on 32-bit.

I don't understand this, can you elaborate?


---

Comment by rws created at 2016-01-02 09:22:38


```
sage: hash(SR(2^32))
0
```

This will be the result on 32bit if I use `long` and so pickles won't be usable on 64bit.


---

Comment by jdemeyer created at 2016-01-02 09:27:02

Replying to [comment:8 rws]:
> so pickles won't be usable on 64bit.

What has hashing to do with pickling?


---

Comment by jdemeyer created at 2016-01-02 09:29:24

Replying to [comment:8 rws]:
> {{{
> sage: hash(SR(2^32))
> 0
> }}}
> This will be the result on 32bit if I use `long`

That's also what the result _should_ be on 32 bit. Are you implying that this is somehow wrong?


---

Comment by rws created at 2016-01-02 09:40:39

I always love this. So that corrects some misunderstanding with me, many thanks. Before I do the next release could you please have a look at the branch? I'm sure I have made more mistakes.
----
New commits:


---

Comment by jdemeyer created at 2016-01-02 09:55:51

This is certainly right:

```
            sage: hash(SR(19/23)) == hash(19/23)
            True
            sage: hash(SR(2^32)) == hash(ZZ(2^32))
            True
```

and it's exactly the reason why you want `hash(SR(2^32)) == 0` on 32-bit.


---

Comment by jdemeyer created at 2016-01-02 09:56:32

I don't really understand the doctest changes of the form

```diff
-        sage: QQbar(e^(pi*I/3))
+        sage: QQbar(exp(pi*I/3, hold=True))
```



---

Comment by jdemeyer created at 2016-01-02 09:58:19

Nor this one:

```diff
-        sage: N(integrate(sin(x^2)/(x^2), x, 1, infinity))
-        0.285736646322853
+        sage: N(integrate(sin(x^2)/(x^2), x, 1, infinity), prec=40)
+        0.28573664632
```



---

Comment by jdemeyer created at 2016-01-02 10:03:04

I would keep this doctest and mark it as `# not implemented` (it's a case where the original simplification was safe to do).

```diff
             sage: a,b = var('a b', domain='real')
             sage: A = abs((a+I*b))^2
-            sage: A.canonicalize_radical()
-            a^2 + b^2
```



---

Comment by jdemeyer created at 2016-01-02 10:04:31

Like I already said, this should be `long`:

```
int64_t gethash()
```



---

Comment by jdemeyer created at 2016-01-02 10:18:53

That's it on first sight.

By the way, I think that this should be pynac-0.6.0 instead of pynax-0.5.4.


---

Comment by rws created at 2016-01-02 13:47:36

Replying to [comment:14 jdemeyer]:
> I don't really understand the doctest changes of the form
> {{{
> #!diff
> -        sage: QQbar(e^(pi*I/3))
> +        sage: QQbar(exp(pi*I/3, hold=True))
> }}}
These I did mindlessly to preserve the result:

```
Failed example:
    QQbar(e^(pi*I/3))
Expected:
    0.500000000000000? + 0.866025403784439?*I
Got:
    0.50000000000000000? + 0.866025403784439?*I
```

This one cannot be fixed otherwise:

```
Failed example:
    a.composition(exp(I*pi/3), exp)
Exception raised:
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py", line 866, in composition
        operand, = ex.operands()
    ValueError: too many values to unpack
```


Replying to [comment:15 jdemeyer]:
> Nor this one:
> {{{
> #!diff
> -        sage: N(integrate(sin(x<sup>2)/(x</sup>2), x, 1, infinity))
> -        0.285736646322853
> +        sage: N(integrate(sin(x<sup>2)/(x</sup>2), x, 1, infinity), prec=40)
> +        0.28573664632
> }}}
How do you let the original succeed? Attempts with tolerance didn't work:

```
sage: N(integrate(sin(x^2)/(x^2), x, 1, infinity))
0.285736646322853 + 6.93889390390723e-18*I
```


> By the way, I think that this should be pynac-0.6.0 instead of pynax-0.5.4.
Because of the interface change or the amount of changes?


---

Comment by jdemeyer created at 2016-01-02 14:03:46

Replying to [comment:19 rws]:
> These I did mindlessly to preserve the result:
I think it's better to keep the test and change the result. That would be a more effective test.

> > By the way, I think that this should be pynac-0.6.0 instead of pynax-0.5.4.
> Because of the interface change or the amount of changes?
Because of backward-incompatible changes.


---

Comment by jdemeyer created at 2016-01-02 14:07:11

Replying to [comment:19 rws]:
> {{{
> sage: N(integrate(sin(x<sup>2)/(x</sup>2), x, 1, infinity))
> 0.285736646322853 + 6.93889390390723e-18*I
> }}}

That's clearly a bug. You should *never* change a test in order to hide a bug. If you cannot make it work, use `# known bug` for this.


---

Comment by rws created at 2016-01-02 15:57:32

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-01-02 16:25:45

Replying to [comment:21 jdemeyer]:
> That's clearly a bug. You should *never* change a test in order to hide a bug. If you cannot make it work, use `# known bug` for this.

Tiny detail: you should keep the correct output (without imag part).
----
New commits:


---

Comment by git created at 2016-01-02 16:36:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-03 12:36:20

New commits:


---

Comment by jdemeyer created at 2016-01-03 12:43:08

I am currently testing this on 32-bit. If that passes and you are happy with my last commit, then this is good to go.


---

Comment by rws created at 2016-01-03 13:25:46

The changes are fine.


---

Comment by jdemeyer created at 2016-01-03 18:22:51

On 32-bit:

```
sage -t --long --warn-long 133.0 src/sage/functions/other.py
**********************************************************************
File "src/sage/functions/other.py", line 1684, in sage.functions.other.Function_beta.__init__
Failed example:
    beta(x/2,3)
Expected:
    beta(3, 1/2*x)
Got:
    beta(1/2*x, 3)
**********************************************************************
```

and

```
sage -t --long --warn-long 133.0 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 11113, in sage.symbolic.expression.Expression._plot_fast_callable
Failed example:
    b
Expected:
    10201.0
Got:
    10200.999999999998
**********************************************************************
```



---

Comment by jdemeyer created at 2016-01-03 18:22:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-01-03 19:04:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-03 19:13:06

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-01-03 19:13:06

For me, this is good to go now.


---

Comment by rws created at 2016-01-04 07:48:30

Changing status from needs_review to positive_review.


---

Comment by rws created at 2016-01-04 07:48:47

Thanks!


---

Comment by vbraun created at 2016-01-04 17:29:17

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-01-04 17:29:17

on OSX:

```
sage -t --long src/sage/functions/trig.py
**********************************************************************
File "src/sage/functions/trig.py", line 618, in sage.functions.trig.Function_arccot.__init__
Failed example:
    RDF(arccot(1/2))
Expected:
    1.1071487177940904
Got:
    1.1071487177940906
**********************************************************************
1 item had failures:
   1 of  11 in sage.functions.trig.Function_arccot.__init__
    [209 tests, 1 failure, 2.88 s]
```



---

Comment by rws created at 2016-01-05 07:58:10

The actual value is `1.10714871779409050301` so on Linux it isn't right either. I'm not a FP expert, I guess that changing to `...905` and allowing some tolerance should suffice.


---

Comment by rws created at 2016-01-05 08:06:10

Changing status from needs_work to needs_review.


---

Comment by rws created at 2016-01-05 08:06:10

New commits:


---

Comment by rws created at 2016-01-05 08:11:01

Doesn't seem to work.


---

Comment by rws created at 2016-01-05 08:20:29

Changing status from needs_review to needs_info.


---

Comment by rws created at 2016-01-05 08:20:29

I have no idea why changing `abs/rel`, `1e-14/2e-16`, or adding tabs won't work.


---

Comment by rws created at 2016-01-05 08:24:57

I also cannot pull Jeroen's patches into my branch with `git trac pull u/jdemeyer/19819-2` so I set the branch back to his.

EDIT: ok the pull works now
----
New commits:


---

Comment by jdemeyer created at 2016-01-05 09:01:00

I'll look into the tolerance.


---

Comment by git created at 2016-01-05 09:15:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-01-05 09:16:04

Changing status from needs_info to positive_review.


---

Comment by jdemeyer created at 2016-01-05 09:16:04

The `# abs tol` should be on the doctest line, not on the result line.


---

Comment by rws created at 2016-01-05 10:03:27

Thanks. One could argue the doctest consists of both lines but...


---

Comment by vbraun created at 2016-01-06 00:05:38

I also found this with the previous version some machine, its unlikely to be fixed in the latest commit but I'm running it right now anyways:

```
sage -t --long src/sage/functions/other.py
**********************************************************************
File "src/sage/functions/other.py", line 1684, in sage.functions.other.Function_beta.__init__
Failed example:
    beta(x/2,3)
Expected:
    beta(1/2*x, 3)  
Got:
    beta(3, 1/2*x)
**********************************************************************
File "src/sage/functions/other.py", line 1691, in sage.functions.other.Function_beta.__init__
Failed example:
    beta(3,x+I)
Expected:
    beta(3, x + I)
Got:
    beta(x + I, 3)
**********************************************************************
1 item had failures:
   2 of  16 in sage.functions.other.Function_beta.__init__
    [491 tests, 2 failures, 16.51 s]
```



---

Comment by rws created at 2016-01-06 06:13:30

While it would certainly be interesting but difficult to find out why this happens, it might also be an idea to write the doctests in a way that ignores order, like using sets.


---

Comment by jdemeyer created at 2016-01-06 08:35:51

Replying to [comment:47 rws]:
> While it would certainly be interesting but difficult to find out why this happens

I think it has to do with hashes. Something like `beta(a, b)` gets reordered such that `hash(a) < hash(b)`.


---

Comment by vbraun created at 2016-01-06 09:13:37

I guess ginac orders the beta arguments, which probably makes numerical sense but not with symbolic arguments. Really it should only sort arguments if they are numeric, though thats a minor bug. I'm also fine with just fixing up the doctests.


---

Comment by vbraun created at 2016-01-06 12:04:29

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2016-01-06 12:27:38

Log files please...


---

Comment by vbraun created at 2016-01-06 12:51:06

http://build.sagedev.org/release/builders/%20%20slow%20AIMS%20bu1510_32s02%20%28Ubuntu%2015.10%2032%20bit%29%20incremental/builds/41/steps/shell_4/logs/stdio


---

Comment by vbraun created at 2016-01-06 12:51:44

http://build.sagedev.org/release/builders/%20%20slow%20Oxford%20ARM%20%28Ubuntu%2012.10%29%20incremental/builds/410/steps/shell_4/logs/stdio


---

Comment by rws created at 2016-01-06 13:47:09

Changing status from needs_work to needs_review.


---

Comment by rws created at 2016-01-06 13:47:09

This would be the order-independence solution. 
----
New commits:


---

Comment by vbraun created at 2016-01-06 13:49:07

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-01-06 15:14:33

I just looked into this a bit more and the re-ordering of `beta(a,b)` indeed depends on the hashes of `a` and `b`. Unfortunately, the hashes of expressions are random. So, in the case of

```
beta(1/2*x, 3)
```

we know that `hash(3) = 3` but the value of `hash(1/2*x)` is just random.


---

Comment by vbraun created at 2016-01-07 22:40:58

Resolution: fixed
