# Issue 30035: Mixed Forms: set_comp, add_comp, comp

Issue created by migration from https://trac.sagemath.org/ticket/30272

Original creator: @mjungmath

Original creation time: 2020-08-02 16:07:57

CC:  egourgoulhon tscrim mkoeppe

In the upcoming changes we want to allow mixed differential forms, among other things, being made immutable (see #30181, #30261).

However, the current implementation would not support that behavior properly, namely:


```
sage: M = Manifold(2, 'M')
sage: A = M.mixed_form()
sage: a = M.diff_form(2)
sage: A[2] = a
sage: A[2] is a
True
```


If `A` would be set immutable and `a` is not, this would contradict the behavior of an immutable element. Even if `a` would be set immutable as soon as `A` had been set immutable, this might happen not on the behalf of the user.

I'd propose a similar approach as I had done in #30208 for bundle connections, and as it is already known for tensor fields, namely by introducing methods `set_comp` and `comp` (`add_comp` would not be necessary). Then each instance representing a homogeneous component is bound only to the mixed differential form.

As always, suggestions and opinions are welcome.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-04-12 23:31:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-04-12 23:44:15

First approach.

**What I did:**

- homogeneous components are bound to mixed form and a priori detached from other instances; in particular

```
sage: A[0] = f
sage: A[0] is f
```

   yields `False` now.

- components are only initialized on demand (not on initialization of the mixed form)
- by default, homogeneous components are named according to the mixed form's name: `A = A_0, A_1, ...`
- `set_comp` method similar to tensor fields

I tried to maintain as much backwards compatibility as possible. For example, even if copies now, the names are still applied if `A[:] = [f, omega, eta]` syntax is used. But the long-term idea is to favor `set_comp(i)[:] = ...` syntax instead of `omega[:] = ...` plus `A[i] = omega` syntax.

Comments are appreciated.


---

Comment by git created at 2021-04-13 10:23:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-04-13 10:25:41

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-04-13 10:25:41

Here we go, that should be it. Please take a close look whether this is (at least) halfway consistent and transparent to the user.

In a next step, mixed forms will be equipped with an immutability switch.


---

Comment by @mjungmath created at 2021-04-13 10:26:20

If desired so, I will squash the commits for final merge.


---

Comment by egourgoulhon created at 2021-04-18 19:30:32

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-04-18 19:30:32

LGTM.


---

Comment by vbraun created at 2021-06-07 21:42:34

Merge conflict


---

Comment by vbraun created at 2021-06-07 21:42:34

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-06-27 10:18:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-06-27 10:20:45

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2021-06-27 16:31:01

When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3?


---

Attachment


---

Comment by @mjungmath created at 2021-06-27 17:34:35

That's odd. For me the branch against the current beta looks just fine:

![](https://trac.sagemath.org/raw-attachment/ticket/30272/Screenshot%202021-06-27%20193218.png)


---

Comment by tscrim created at 2021-06-27 23:23:39

Replying to [comment:20 egourgoulhon]:
> When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3? 

That sometimes happens with the trac git helper. You don't have to worry too much about it as long as it pulls okay (a la comment:21).


---

Comment by egourgoulhon created at 2021-06-28 07:58:00

Replying to [comment:22 tscrim]:
> Replying to [comment:20 egourgoulhon]:
> > When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3? 
> 
> That sometimes happens with the trac git helper. You don't have to worry too much about it as long as it pulls okay (a la comment:21).

Indeed, this seems erratic: it looks good now, while the branch has not been changed.


---

Comment by egourgoulhon created at 2021-06-28 07:58:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-06-29 19:58:53


```
[release@zen Sage]$ sage -t --long --warn-long 49.3 --random-seed=0 src/sage/manifolds/differentiable/mixed_form.py  # 4 doctests failed
 
Running doctests with ID 2021-06-29-21-56-39-c62006fe.
Git branch: develop
Using --optional=build,dochtml,fedora,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 49.3 --random-seed=0 src/sage/manifolds/differentiable/mixed_form.py
**********************************************************************
File "src/sage/manifolds/differentiable/mixed_form.py", line 90, in sage.manifolds.differentiable.mixed_form.MixedForm
Failed example:
    A.display_expansion() # display expansion in basis
Expected:
    A = [x] + [x*y dx] + [x*y^2 dx/\dy]
Got:
    A = x + x*y dx + x*y^2 dx/\dy
**********************************************************************
File "src/sage/manifolds/differentiable/mixed_form.py", line 113, in sage.manifolds.differentiable.mixed_form.MixedForm
Failed example:
    B.display_expansion()
Expected:
    B = [x] + [x*y dx] + [x*y^2 dx/\dy]
Got:
    B = x + x*y dx + x*y^2 dx/\dy
**********************************************************************
[...]
```



---

Comment by vbraun created at 2021-06-29 19:58:53

Changing status from positive_review to needs_work.


---

Comment by @mjungmath created at 2021-06-29 20:50:05

Ah damn, I mis-resolved the merge conflict.

Let's wait for #30473 anyway.


---

Comment by git created at 2021-07-06 11:43:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by @mjungmath created at 2021-07-06 11:44:06

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-07-06 11:54:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-07-07 06:26:36

Ready for review again.


---

Comment by egourgoulhon created at 2021-07-09 15:19:22

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-07-09 15:19:22

The patchbot reports doctest failures that all pertain to the dependency #30473. They are all fixed in the latest version of that ticket. But I don't think it necessary to merge it here to move on.


---

Comment by vbraun created at 2021-07-23 20:11:33

Resolution: fixed
