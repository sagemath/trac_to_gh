# Issue 30035: Mixed Forms: set_comp, add_comp, comp

archive/issues_030035.json:
```json
{
    "body": "CC:  egourgoulhon tscrim mkoeppe\n\nIn the upcoming changes we want to allow mixed differential forms, among other things, being made immutable (see #30181, #30261).\n\nHowever, the current implementation would not support that behavior properly, namely:\n\n\n```\nsage: M = Manifold(2, 'M')\nsage: A = M.mixed_form()\nsage: a = M.diff_form(2)\nsage: A[2] = a\nsage: A[2] is a\nTrue\n```\n\n\nIf `A` would be set immutable and `a` is not, this would contradict the behavior of an immutable element. Even if `a` would be set immutable as soon as `A` had been set immutable, this might happen not on the behalf of the user.\n\nI'd propose a similar approach as I had done in #30208 for bundle connections, and as it is already known for tensor fields, namely by introducing methods `set_comp` and `comp` (`add_comp` would not be necessary). Then each instance representing a homogeneous component is bound only to the mixed differential form.\n\nAs always, suggestions and opinions are welcome.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30272\n\n",
    "created_at": "2020-08-02T16:07:57Z",
    "labels": [
        "manifolds",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Mixed Forms: set_comp, add_comp, comp",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30035",
    "user": "@mjungmath"
}
```
CC:  egourgoulhon tscrim mkoeppe

In the upcoming changes we want to allow mixed differential forms, among other things, being made immutable (see #30181, #30261).

However, the current implementation would not support that behavior properly, namely:


```
sage: M = Manifold(2, 'M')
sage: A = M.mixed_form()
sage: a = M.diff_form(2)
sage: A[2] = a
sage: A[2] is a
True
```


If `A` would be set immutable and `a` is not, this would contradict the behavior of an immutable element. Even if `a` would be set immutable as soon as `A` had been set immutable, this might happen not on the behalf of the user.

I'd propose a similar approach as I had done in #30208 for bundle connections, and as it is already known for tensor fields, namely by introducing methods `set_comp` and `comp` (`add_comp` would not be necessary). Then each instance representing a homogeneous component is bound only to the mixed differential form.

As always, suggestions and opinions are welcome.

Issue created by migration from https://trac.sagemath.org/ticket/30272





---

archive/issue_comments_426922.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426922",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_426923.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-12T23:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426923",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426924.json:
```json
{
    "body": "First approach.\n\n**What I did:**\n\n- homogeneous components are bound to mixed form and a priori detached from other instances; in particular\n\n```\nsage: A[0] = f\nsage: A[0] is f\n```\n\n   yields `False` now.\n\n- components are only initialized on demand (not on initialization of the mixed form)\n- by default, homogeneous components are named according to the mixed form's name: `A = A_0, A_1, ...`\n- `set_comp` method similar to tensor fields\n\nI tried to maintain as much backwards compatibility as possible. For example, even if copies now, the names are still applied if `A[:] = [f, omega, eta]` syntax is used. But the long-term idea is to favor `set_comp(i)[:] = ...` syntax instead of `omega[:] = ...` plus `A[i] = omega` syntax.\n\nComments are appreciated.",
    "created_at": "2021-04-12T23:44:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426924",
    "user": "@mjungmath"
}
```

First approach.

**What I did:**

- homogeneous components are bound to mixed form and a priori detached from other instances; in particular

```
sage: A[0] = f
sage: A[0] is f
```

   yields `False` now.

- components are only initialized on demand (not on initialization of the mixed form)
- by default, homogeneous components are named according to the mixed form's name: `A = A_0, A_1, ...`
- `set_comp` method similar to tensor fields

I tried to maintain as much backwards compatibility as possible. For example, even if copies now, the names are still applied if `A[:] = [f, omega, eta]` syntax is used. But the long-term idea is to favor `set_comp(i)[:] = ...` syntax instead of `omega[:] = ...` plus `A[i] = omega` syntax.

Comments are appreciated.



---

archive/issue_comments_426925.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-13T10:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426925",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426926.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-13T10:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426926",
    "user": "@mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_426927.json:
```json
{
    "body": "Here we go, that should be it. Please take a close look whether this is (at least) halfway consistent and transparent to the user.\n\nIn a next step, mixed forms will be equipped with an immutability switch.",
    "created_at": "2021-04-13T10:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426927",
    "user": "@mjungmath"
}
```

Here we go, that should be it. Please take a close look whether this is (at least) halfway consistent and transparent to the user.

In a next step, mixed forms will be equipped with an immutability switch.



---

archive/issue_comments_426928.json:
```json
{
    "body": "If desired so, I will squash the commits for final merge.",
    "created_at": "2021-04-13T10:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426928",
    "user": "@mjungmath"
}
```

If desired so, I will squash the commits for final merge.



---

archive/issue_comments_426929.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-18T19:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426929",
    "user": "egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_426930.json:
```json
{
    "body": "LGTM.",
    "created_at": "2021-04-18T19:30:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426930",
    "user": "egourgoulhon"
}
```

LGTM.



---

archive/issue_comments_426931.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2021-06-07T21:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426931",
    "user": "vbraun"
}
```

Merge conflict



---

archive/issue_comments_426932.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-06-07T21:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426932",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_426933.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-27T10:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426933",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426934.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-27T10:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426934",
    "user": "@mjungmath"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_426935.json:
```json
{
    "body": "When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3?",
    "created_at": "2021-06-27T16:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426935",
    "user": "egourgoulhon"
}
```

When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3?



---

archive/issue_comments_426936.json:
```json
{
    "body": "Attachment [Screenshot 2021-06-27 193218.png](tarball://root/attachments/some-uuid/ticket30272/Screenshot 2021-06-27 193218.png) by @mjungmath created at 2021-06-27 17:32:51",
    "created_at": "2021-06-27T17:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426936",
    "user": "@mjungmath"
}
```

Attachment [Screenshot 2021-06-27 193218.png](tarball://root/attachments/some-uuid/ticket30272/Screenshot 2021-06-27 193218.png) by @mjungmath created at 2021-06-27 17:32:51



---

archive/issue_comments_426937.json:
```json
{
    "body": "That's odd. For me the branch against the current beta looks just fine:\n\n![](https://trac.sagemath.org/raw-attachment/ticket/30272/Screenshot%202021-06-27%20193218.png)",
    "created_at": "2021-06-27T17:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426937",
    "user": "@mjungmath"
}
```

That's odd. For me the branch against the current beta looks just fine:

![](https://trac.sagemath.org/raw-attachment/ticket/30272/Screenshot%202021-06-27%20193218.png)



---

archive/issue_comments_426938.json:
```json
{
    "body": "Replying to [comment:20 egourgoulhon]:\n> When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3? \n\nThat sometimes happens with the trac git helper. You don't have to worry too much about it as long as it pulls okay (a la comment:21).",
    "created_at": "2021-06-27T23:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426938",
    "user": "tscrim"
}
```

Replying to [comment:20 egourgoulhon]:
> When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3? 

That sometimes happens with the trac git helper. You don't have to worry too much about it as long as it pulls okay (a la comment:21).



---

archive/issue_comments_426939.json:
```json
{
    "body": "Replying to [comment:22 tscrim]:\n> Replying to [comment:20 egourgoulhon]:\n> > When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3? \n> \n> That sometimes happens with the trac git helper. You don't have to worry too much about it as long as it pulls okay (a la comment:21).\n\nIndeed, this seems erratic: it looks good now, while the branch has not been changed.",
    "created_at": "2021-06-28T07:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426939",
    "user": "egourgoulhon"
}
```

Replying to [comment:22 tscrim]:
> Replying to [comment:20 egourgoulhon]:
> > When clicking on the new branch, one gets a huge diff, which seems to be the whole 9.4.beta3 w.r.t 9.4.beta2. Wouldn't it be better to merge the previous ticket branch into a clean 9.4.beta3? 
> 
> That sometimes happens with the trac git helper. You don't have to worry too much about it as long as it pulls okay (a la comment:21).

Indeed, this seems erratic: it looks good now, while the branch has not been changed.



---

archive/issue_comments_426940.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-28T07:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426940",
    "user": "egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_426941.json:
```json
{
    "body": "\n```\n[release@zen Sage]$ sage -t --long --warn-long 49.3 --random-seed=0 src/sage/manifolds/differentiable/mixed_form.py  # 4 doctests failed\n \nRunning doctests with ID 2021-06-29-21-56-39-c62006fe.\nGit branch: develop\nUsing --optional=build,dochtml,fedora,pip,sage,sage_spkg\nDoctesting 1 file.\nsage -t --long --warn-long 49.3 --random-seed=0 src/sage/manifolds/differentiable/mixed_form.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/mixed_form.py\", line 90, in sage.manifolds.differentiable.mixed_form.MixedForm\nFailed example:\n    A.display_expansion() # display expansion in basis\nExpected:\n    A = [x] + [x*y dx] + [x*y^2 dx/\\dy]\nGot:\n    A = x + x*y dx + x*y^2 dx/\\dy\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/mixed_form.py\", line 113, in sage.manifolds.differentiable.mixed_form.MixedForm\nFailed example:\n    B.display_expansion()\nExpected:\n    B = [x] + [x*y dx] + [x*y^2 dx/\\dy]\nGot:\n    B = x + x*y dx + x*y^2 dx/\\dy\n**********************************************************************\n[...]\n```\n",
    "created_at": "2021-06-29T19:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426941",
    "user": "vbraun"
}
```


```
[release@zen Sage]$ sage -t --long --warn-long 49.3 --random-seed=0 src/sage/manifolds/differentiable/mixed_form.py  # 4 doctests failed
 
Running doctests with ID 2021-06-29-21-56-39-c62006fe.
Git branch: develop
Using --optional=build,dochtml,fedora,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --warn-long 49.3 --random-seed=0 src/sage/manifolds/differentiable/mixed_form.py
**********************************************************************
File "src/sage/manifolds/differentiable/mixed_form.py", line 90, in sage.manifolds.differentiable.mixed_form.MixedForm
Failed example:
    A.display_expansion() # display expansion in basis
Expected:
    A = [x] + [x*y dx] + [x*y^2 dx/\dy]
Got:
    A = x + x*y dx + x*y^2 dx/\dy
**********************************************************************
File "src/sage/manifolds/differentiable/mixed_form.py", line 113, in sage.manifolds.differentiable.mixed_form.MixedForm
Failed example:
    B.display_expansion()
Expected:
    B = [x] + [x*y dx] + [x*y^2 dx/\dy]
Got:
    B = x + x*y dx + x*y^2 dx/\dy
**********************************************************************
[...]
```




---

archive/issue_comments_426942.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-06-29T19:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426942",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_426943.json:
```json
{
    "body": "Ah damn, I mis-resolved the merge conflict.\n\nLet's wait for #30473 anyway.",
    "created_at": "2021-06-29T20:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426943",
    "user": "@mjungmath"
}
```

Ah damn, I mis-resolved the merge conflict.

Let's wait for #30473 anyway.



---

archive/issue_comments_426944.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-07-06T11:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426944",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_426945.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-06T11:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426945",
    "user": "@mjungmath"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_426946.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-06T11:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426946",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426947.json:
```json
{
    "body": "Ready for review again.",
    "created_at": "2021-07-07T06:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426947",
    "user": "@mjungmath"
}
```

Ready for review again.



---

archive/issue_comments_426948.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-09T15:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426948",
    "user": "egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_426949.json:
```json
{
    "body": "The patchbot reports doctest failures that all pertain to the dependency #30473. They are all fixed in the latest version of that ticket. But I don't think it necessary to merge it here to move on.",
    "created_at": "2021-07-09T15:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426949",
    "user": "egourgoulhon"
}
```

The patchbot reports doctest failures that all pertain to the dependency #30473. They are all fixed in the latest version of that ticket. But I don't think it necessary to merge it here to move on.



---

archive/issue_comments_426950.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30035",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30035#issuecomment-426950",
    "user": "vbraun"
}
```

Resolution: fixed
