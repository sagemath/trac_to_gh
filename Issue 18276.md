# Issue 18276: Make <package>/type file mandatory

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2015-05-26 09:01:51

CC:  jdemeyer vbraun

With this branch, "make" is interrupted if some package does not define a 'type' file, or if its content is unexpected.

Nathann


---

Comment by ncohen created at 2015-05-26 09:02:06

Changing status from new to needs_review.


---

Comment by git created at 2015-05-26 09:02:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-26 09:06:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2015-05-26 09:08:26

lgtm but can we also have an error message?


---

Comment by ncohen created at 2015-05-26 09:10:07

Well, there is one generated by 'cat' when the file does not exist, and it prints something specific about what the content of the 'type' file should be when it is invalid.

Do you want something 'hand-made' when the file does not exist?

Nathann


---

Comment by vbraun created at 2015-05-26 09:18:48

If I just see cat erroring out then it looks like a bug in the build system. And you catch the error anyways, so why not print something like "the package type must declare its 'type' file"?


---

Comment by jdemeyer created at 2015-05-26 09:28:03

Needs to be rebased over #17607.


---

Comment by jdemeyer created at 2015-05-26 09:28:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-26 09:31:41

I actually think that this is pretty clear, it explicitly says which file is missing:

```
$ rm build/pkgs/r/type  # Just for testing
$ make
cd build && \
"../build/pipestatus" \
        "env SAGE_PARALLEL_SPKG_BUILD='' ./install all 2>&1" \
        "tee -a ../logs/install.log"
cat: /usr/local/src/sage-config/build/pkgs/r/type: No such file or directory
Makefile:19: recipe for target 'build' failed
make: *** [build] Error 1
```

However, to reduce confusion, it doesn't hurt to add an extra error message.


---

Comment by ncohen created at 2015-05-26 09:43:33

> Needs to be rebased over #17607.

What the hell is this? You created a `python2standard` and `python3standard` package type?


---

Comment by git created at 2015-05-26 09:49:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-05-26 09:58:15

Replying to [comment:9 ncohen]:
> You created a `python2standard` and `python3standard` package type?
Well, I hope the _You_ doesn't refer to me, since I am innocent.


---

Comment by ncohen created at 2015-05-26 10:00:02

There does not seem to be a conflict with #17607. But I find what was done there *VERY* dirty. A 'clean' way out would have been to
1) Create a 'standard' virtual 'Python' package with dependency on 'python_2_or_3'
2) Make python2 and python3 optional
3) Create in build/install a rule 'python_2_or_3' depending on python2 or python3.

There would have been no need of adding two new types, and no need to change filtered_packages_list.

Nathann


---

Comment by ncohen created at 2015-05-26 10:00:35

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-05-26 10:00:35

> Well, I hope the _You_ doesn't refer to me, since I am innocent.
So you are innocent.

I set this ticket back to needs_review, as there is apaprently no conflict with #17607.

Nathann


---

Comment by jdemeyer created at 2015-05-26 12:58:35

Can you replace

```
filtered_packages_list all > /dev/null
```

by

```
filtered_packages_list none
```

because of efficiency reasons? With the first variant, you are executing a lot of stuff which you don't use.


---

Comment by jdemeyer created at 2015-05-26 13:01:27

Even simpler: you can replace

```
filtered_packages_list all > /dev/null
if [ $? -ne 0 ]; then
    exit 1
fi
```

by

```
filtered_packages_list none || exit $?
```



---

Comment by git created at 2015-05-26 13:01:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-05-26 13:02:22

> With the first variant, you are executing a lot of stuff which you don't use.

Done. In my first version of that function an error was raised when the argument was anything which is not a valid type.

Nathann


---

Comment by ncohen created at 2015-05-26 13:03:14

> Even simpler: you can replace

Sigh ....


---

Comment by git created at 2015-05-26 13:07:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-05-26 20:06:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-27 20:03:16

Resolution: fixed
