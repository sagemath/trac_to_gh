# Issue 28420: Build Sage without "python"

Issue created by migration from https://trac.sagemath.org/ticket/28657

Original creator: jhpalmieri

Original creation time: 2019-10-25 21:08:44

CC:  isuruf fbissey @timokau arojas

Some new linux releases don't seem to include a `python` executable. They have `python3` but no `python` or `python2`. Sage should build on such systems.



---

Comment by jhpalmieri created at 2019-10-25 21:09:43

Here is an attempt. It probably needs work, but please test it.
----
New commits:


---

Comment by jhpalmieri created at 2019-10-25 21:09:48

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-10-25 21:10:45

See https://wiki.ubuntu.com/BionicBeaver/ReleaseNotes, for example: "Python 2 is no longer installed by default."


---

Comment by vbraun created at 2019-10-26 23:51:01

Changing priority from major to blocker.


---

Comment by dimpase created at 2019-10-28 17:24:07

Are you sure there really are Linuxes without `python` (but with `python3`) ? E.g. in Gentoo `python` equals `python3` since few years...


---

Comment by jhpalmieri created at 2019-10-28 18:38:32

I just installed an Ubuntu 19.10 virtual machine. I opened a terminal, typed "pyt" and hit the TAB key: it completed to "python3". There is no command "python".


---

Comment by dimpase created at 2019-10-28 19:08:15

does 

```
apt install python 
```

provide Python(3) ?


---

Comment by jhpalmieri created at 2019-10-28 20:11:27

It provides `python2`. (Edit: and `python`, symlinked to `python2`.)


---

Comment by dimpase created at 2019-10-28 20:32:11

hmm, but that's insane that all the scripts needing just python need to be changed, no? 

I would just install a symbolic link to python3 somewhere...


---

Comment by jhpalmieri created at 2019-10-28 21:00:09

I am not an Ubuntu expert, but I think that they were worried that old Python scripts might not be compatible with Python 3, so better not to make a symbolic link: just let people install Python 2 if they need it.


---

Comment by dimpase created at 2019-10-30 08:06:01

Why not just create a link to python3 at `build/bin/python` ?

This patch is very invasive for no good reason I can see, and would make future use of Sage with system Python harder.


---

Comment by git created at 2019-10-30 17:04:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-10-30 17:36:50

Removed changes to `ipython/spkg-install` which would have conflicted with #28673.

Replying to [comment:12 dimpase]:
> Why not just create a link to python3 at `build/bin/python` ?

That's basically what `sage-system-python` is already.
 
> This patch is very invasive for no good reason I can see, and would make future use of Sage with system Python harder.

When installing a package, should we be using Sage's Python or the system Python? There are three established choices: during Sage's build use `sage-system-python` or `sage-python23` (which means the Python that Sage builds: it uses either `python2` or `python3` from `$SAGE_LOCAL/bin/`). During runtime, There is also the script `sage-python`, which just runs `python2` or `python3`. We should probably use that one more and `sage-python23` less.


---

Comment by jhpalmieri created at 2019-10-30 17:37:47

I'm testing a branch which uses `sage-python` more and `sage-python23` less. If it works, I'll push it.


---

Comment by git created at 2019-10-30 18:42:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-10-30 18:44:21

CC'ing some of the packaging people to see what they think.


---

Comment by dimpase created at 2019-10-30 18:45:29

IMHO there is no reason to use Sage's python during installation of a package, unless we are installing a Python/Cython module for Sage's Python.

Now, think of a situation where Sage's Python and system Python are the same thing.
It is actually not too far-fetched; since PEP 370 it's prefectly possible to install Python modules (for a system-wide Python) into ~/.
And long-term it is probably the only viable option for Sage.

So, the fewer different Pythons we have around, the better...


---

Comment by jhpalmieri created at 2019-10-30 18:53:03

Replying to [comment:18 dimpase]:
> IMHO there is no reason to use Sage's python during installation of a package, unless we are installing a Python/Cython module for Sage's Python.

I agree, and that's why my changes in `build/pkgs` are almost exclusively to use `sage-system-python`. The one exception is `entrypoints`, which installs a Python module. 

> Now, think of a situation where Sage's Python and system Python are the same thing.
> It is actually not too far-fetched; since PEP 370 it's prefectly possible to install Python modules (for a system-wide Python) into ~/.
> And long-term it is probably the only viable option for Sage.
> 
> So, the fewer different Pythons we have around, the better...

Right now we are using four different ones: `python`, `sage-system-python`, `sage-python23`, and `sage-python`. The main point here is to eliminate the use of `python`. I also wonder if we should avoid `sage-python23`, since it explicitly calls `SAGE_LOCAL/bin/python[2 or 3]`, and instead use `sage-python`, which runs `exec python2` or `exec python3`, letting the PATH determine where to find the program. I've done a little in that direction (changing `sage-python23` to `sage-python`), but more could be done. It doesn't need to be done on this ticket.


---

Comment by isuruf created at 2019-10-30 18:56:01

Replying to [comment:10 dimpase]:
> hmm, but that's insane that all the scripts needing just python need to be changed, no? 
> 
> I would just install a symbolic link to python3 somewhere...

This was because `python` -> `python3` link was explicitly recommended against in PEP-0394. In April 2018, this was changed to make it okay for virtual envs and in June 2019, it was okay for the distributor to decide.


---

Comment by @timokau created at 2019-10-30 19:41:52

Replying to [comment:18 dimpase]:
> IMHO there is no reason to use Sage's python during installation of a package, unless we are installing a Python/Cython module for Sage's Python.

Right, on distro all the python versions resolve to the system python anyway. So this change is close to a no-op from a distro perspective.


---

Comment by jhpalmieri created at 2019-10-30 19:51:59

Replying to [comment:21 gh-timokau]:
> Replying to [comment:18 dimpase]:
> > IMHO there is no reason to use Sage's python during installation of a package, unless we are installing a Python/Cython module for Sage's Python.
> 
> Right, on distro all the python versions resolve to the system python anyway. So this change is close to a no-op from a distro perspective.

How are you handling systems which have no `python` executable, like the most recent Ubuntu distributions? Or has that issue not come up yet?


---

Comment by @timokau created at 2019-10-30 21:43:50

Replying to [comment:22 jhpalmieri]:
> Replying to [comment:21 gh-timokau]:
> > Replying to [comment:18 dimpase]:
> > > IMHO there is no reason to use Sage's python during installation of a package, unless we are installing a Python/Cython module for Sage's Python.
> > 
> > Right, on distro all the python versions resolve to the system python anyway. So this change is close to a no-op from a distro perspective.
> 
> How are you handling systems which have no `python` executable, like the most recent Ubuntu distributions? Or has that issue not come up yet?

The distro *is* the "system", so I can just add python to the dependency list and the package manager will make sure it's available. `python` is not installed by default on ubuntu, but if  the sage package depends on it it will still be installed for sage users.


---

Comment by jhpalmieri created at 2019-10-30 21:54:04

Replying to [comment:23 gh-timokau]:
> The distro *is* the "system", so I can just add python to the dependency list and the package manager will make sure it's available. `python` is not installed by default on ubuntu, but if  the sage package depends on it it will still be installed for sage users.

Then you can interpret this ticket as being an effort to allow the use of either `python` or `python3` as dependencies, rather than insisting on `python`. Or just change the dependency to `python3`.


---

Comment by vbraun created at 2019-11-07 23:40:41

Are we good here? It seems like its a step in the right direction, even if it may not solve all problems for all time.


---

Comment by vbraun created at 2019-11-07 23:40:52

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-11-07 23:51:57

Replying to [comment:25 vbraun]:
> Are we good here? It seems like its a step in the right direction, even if it may not solve all problems for all time.

Well, I was trying to solve all problems for all time, but I'll take what I can get.


---

Comment by fbissey created at 2019-11-07 23:52:39

Should have looked at this more closely earlier. This is 0 improvement for sage-on-distro that don't want to install `sage-system-python` or `sage-python` or `sage-python23`. Possibly it requires more patching. I only see this as a transition period hopefully.


---

Comment by jhpalmieri created at 2019-11-07 23:55:28

It doesn't make anything worse for distros, I hope, and it should allow you to set the dependency to `python3` instead of `python`, for systems where those are different.


---

Comment by fbissey created at 2019-11-08 00:03:04

I don't know about other distros but Gentoo has its own mechanism to switch between python versions. Without having to worry about `python` being `python2` or `python3`, this is switched at a more fundamental level and there are ways to maintain "exceptions". So stuff like replacing `python` by `sage-python` in `src/sage/doctest/control.py` is actually harmful. I install sage for python2.7, python3.6 and python3.7 simultaneously and I don't need to patch anything for it know which `python` it is currently running.


---

Comment by jhpalmieri created at 2019-11-08 00:07:03

What do you do with all of the scripts in `src/bin` or `local/bin` which call `sage-python23`?


---

Comment by fbissey created at 2019-11-08 00:13:06

Replying to [comment:31 jhpalmieri]:
> What do you do with all of the scripts in `src/bin` or `local/bin` which call `sage-python23`? 

https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/sage/sage-9999.ebuild#L178

and thanks to your work I have now noticed there is one file in `src/ext` with the stuff.

The link above is only part of the solution anyway. Gentoo has an install helper called `python_doscript` that will wrap python scripts so multiple python versions are not a problem. So yes, I'll admit it, I don't have to have a sage-python thingy because I already have a better solution and you don't have one.


---

Comment by jhpalmieri created at 2019-11-08 00:31:13

If you have a suggestion for what else to do with `doctest/control.py`, we can open a follow-up ticket.


---

Comment by fbissey created at 2019-11-08 00:33:24

To be honest I think we should wait for the dust about python2/3 to clear out. Once python2 is out of support the incentive to keep it will be reduced drastically.


---

Comment by fbissey created at 2019-11-08 04:26:13

Replying to [comment:33 jhpalmieri]:
> If you have a suggestion for what else to do with `doctest/control.py`, we can open a follow-up ticket.

Actually in the end I may have some :)
* line 643: use `sys.executable` so it is always the python you are currently using.
* line 1034 and associated doctests. Again `sys.executable` could be used and `...` be put in doctest since we don't know what that particular result is. But there is a first simplification `sage-runtests` is executable and already starts with `#!/usr/bin/env sage-python` in your case why do you need to override the `#!` here? In fact why do you even need the full path? It is already in your `$PATH` at this stage.


---

Comment by jhpalmieri created at 2019-11-08 18:39:15

See #28709 for a followup incorporating these ideas.


---

Comment by vbraun created at 2019-11-08 20:31:40

Resolution: fixed


---

Comment by saraedum created at 2019-11-17 21:59:42

It seems that this broke the docker images, see #28738.

Is it intentional that we now need a system Python to be installed to run Sage? Or is the situation in the docker image somehow special and other users won't be affected by this?

What confuses me is the following in `sage`:

```
# Check to see if the whole Sage install tree has moved.  If so,
# change various hardcoded paths.  Skip this if we don't have write
# access to $SAGE_LOCAL (e.g. when running as a different user) or
# if Python and sage-location haven't been installed yet.
maybe_sage_location()
{
    if [ -w "$SAGE_LOCAL" ]; then
        if [ -x "$SAGE_LOCAL/bin/python" ] && [ -x "$SAGE_LOCAL/bin/sage-location" ]; then
            sage-location || exit $?
        fi
    fi
}
```


But `sage-location` uses the system Python, so the check for `$SAGE_LOCAL/bin/python` seems to be wrong.


---

Comment by jhpalmieri created at 2019-11-18 01:05:58

It's explained in the comment, at least somewhat: I think the point is, don't bother to do this check if `local/bin/python` doesn't exist, because the Sage install tree is incomplete. 

In any case, it would be better to check for the existence of `local/bin/python` or `local/bin/python3`.


---

Comment by @timokau created at 2019-11-18 10:36:26

Isn't moving the sage tree after build long deprecated?


---

Comment by jhpalmieri created at 2019-11-18 19:41:11

You can move the Sage tree at most once. This is how (for example) OS X binary distributions work: they are built with a placeholder for SAGE_ROOT, and then the first time it runs, the placeholder gets replaced with the permanent home. The script `sage-location` should print an error most of the time if you try to move the Sage tree.


---

Comment by dimpase created at 2019-11-18 19:48:27

I don't think you can move a "normal" Sage tree at all. It needs to be specially prepared to be movable, and such a prepared tree does not work without first being moved.
