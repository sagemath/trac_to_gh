# Issue 31082: Partitions parts_in vs WeightedIntegerVectors

archive/issues_031082.json:
```json
{
    "body": "CC:  slelievre vdelecroix slabbe\n\nKeywords: Partitions\n\nCreating the integer partitions of an integer N with parts restricted to a list L takes much longer than creating the weighted integer vectors of N with weights in L. In principle one should be able to translate between these two constructions, so perhaps it would be better to compute Partitions(N, parts_in = L) by calling WeightedIntegerVectors(N, L) and then transferring the results accordingly? Below are two examples where this manifests:\n\nThis code sees how far Sage can compute in 100 seconds with respect to both functions:\n\n```\nimport time\na = time.time()\ni = 0\nL = []\nwhile time.time()-a < 100:\n    i+=1\n    L.append(len(WeightedIntegerVectors(i,[1000,1001])))\nprint(len(L))\n######################################\na = time.time()\ni = 0\nL = []\nwhile time.time()-a < 100:\n    i+=1\n    L.append(len(Partitions(i,parts_in = [1000,1001])))\nprint(len(L))\n```\n\nThe result of the first block is 321269, whereas the second is 41686 (for me).\n\nAnother example: this code computes the Frobenius number of [1000,1001] (https://en.wikipedia.org/wiki/Coin_problem) by starting at the naive upper bound and working downwards: \n\n\n\n```\nimport time\na = time.time()\nfor i in range(1000*1001, 0, -1):\n    if any(_ for _ in WeightedIntegerVectors(i, parts_in = [1000,1001])):\n        pass\n    else:\n        print(i)\n        break\n\n###################################\na = time.time()\nfor i in range(1000*1001, 0, -1):\n    if any(_ for _ in Partitions(i, parts_in = [1000,1001])):\n        pass\n    else:\n        print(i)\n        break\n```\n\n\n\nThe first code block runs in 0.8315746784210205 seconds whereas the second takes 249.9559507369995 seconds to evaluate (for me).\n\nA very basic attempt at a fix for this would be something like \n\n```\ndef PartitionPartsIn(N, L):\n    sortL = sorted(L, reverse=True)\n    for wIV in WeightedIntegerVectors(N,sortL):\n        a = []\n        for i in range(len(sortL)):\n            a+=[sortL[i]]*wIV[i]\n        yield(a)\n```\n\nOf course this would have to be adapted into the Partitions class, but it seems like that should be no issue as long as the parts_in flag is taken into account. Even this crude fix gives me much better performance on the two tasks above.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31319\n\n",
    "created_at": "2021-02-01T17:38:00Z",
    "labels": [
        "number theory",
        "minor",
        "enhancement"
    ],
    "title": "Partitions parts_in vs WeightedIntegerVectors",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31082",
    "user": "@tomgrubbmath"
}
```
CC:  slelievre vdelecroix slabbe

Keywords: Partitions

Creating the integer partitions of an integer N with parts restricted to a list L takes much longer than creating the weighted integer vectors of N with weights in L. In principle one should be able to translate between these two constructions, so perhaps it would be better to compute Partitions(N, parts_in = L) by calling WeightedIntegerVectors(N, L) and then transferring the results accordingly? Below are two examples where this manifests:

This code sees how far Sage can compute in 100 seconds with respect to both functions:

```
import time
a = time.time()
i = 0
L = []
while time.time()-a < 100:
    i+=1
    L.append(len(WeightedIntegerVectors(i,[1000,1001])))
print(len(L))
######################################
a = time.time()
i = 0
L = []
while time.time()-a < 100:
    i+=1
    L.append(len(Partitions(i,parts_in = [1000,1001])))
print(len(L))
```

The result of the first block is 321269, whereas the second is 41686 (for me).

Another example: this code computes the Frobenius number of [1000,1001] (https://en.wikipedia.org/wiki/Coin_problem) by starting at the naive upper bound and working downwards: 



```
import time
a = time.time()
for i in range(1000*1001, 0, -1):
    if any(_ for _ in WeightedIntegerVectors(i, parts_in = [1000,1001])):
        pass
    else:
        print(i)
        break

###################################
a = time.time()
for i in range(1000*1001, 0, -1):
    if any(_ for _ in Partitions(i, parts_in = [1000,1001])):
        pass
    else:
        print(i)
        break
```



The first code block runs in 0.8315746784210205 seconds whereas the second takes 249.9559507369995 seconds to evaluate (for me).

A very basic attempt at a fix for this would be something like 

```
def PartitionPartsIn(N, L):
    sortL = sorted(L, reverse=True)
    for wIV in WeightedIntegerVectors(N,sortL):
        a = []
        for i in range(len(sortL)):
            a+=[sortL[i]]*wIV[i]
        yield(a)
```

Of course this would have to be adapted into the Partitions class, but it seems like that should be no issue as long as the parts_in flag is taken into account. Even this crude fix gives me much better performance on the two tasks above.

Issue created by migration from https://trac.sagemath.org/ticket/31319





---

archive/issue_comments_443933.json:
```json
{
    "body": "Thanks for opening this ticket and suggesting an approach.",
    "created_at": "2021-02-01T20:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443933",
    "user": "slelievre"
}
```

Thanks for opening this ticket and suggesting an approach.



---

archive/issue_comments_443934.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-02-11T16:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443934",
    "user": "chapoton"
}
```

New commits:



---

archive/issue_comments_443935.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-11T16:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443935",
    "user": "chapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_443936.json:
```json
{
    "body": "You can make this even faster by using the `iterator_fast` function in `integer_vector_weighted.py`. That way you don't have an additional transient element, just lists being returned. So I would do it like this:\n\n```python\n        from sage.combinat.integer_vector_weighted import iterator_fast\n        sorted_parts = sorted(parts, reverse=True)\n        for vec in iterator_fast(n, sorted_parts):\n            yield sum([pi] *  multi for pi, multi in zip(sorted_parts, vec), []\n```\n\nThis should be the fastest way to do things.\n\nThis probably can be easily modified to work for k-regular/restricted partitions as well, but that can be a separate ticket.",
    "created_at": "2021-02-17T07:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443936",
    "user": "tscrim"
}
```

You can make this even faster by using the `iterator_fast` function in `integer_vector_weighted.py`. That way you don't have an additional transient element, just lists being returned. So I would do it like this:

```python
        from sage.combinat.integer_vector_weighted import iterator_fast
        sorted_parts = sorted(parts, reverse=True)
        for vec in iterator_fast(n, sorted_parts):
            yield sum([pi] *  multi for pi, multi in zip(sorted_parts, vec), []
```

This should be the fastest way to do things.

This probably can be easily modified to work for k-regular/restricted partitions as well, but that can be a separate ticket.



---

archive/issue_comments_443937.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-17T09:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443937",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_443938.json:
```json
{
    "body": "Thanks, Travis. I made the suggested changes.",
    "created_at": "2021-02-17T09:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443938",
    "user": "chapoton"
}
```

Thanks, Travis. I made the suggested changes.



---

archive/issue_comments_443939.json:
```json
{
    "body": "Thank you. LGTM.",
    "created_at": "2021-02-17T23:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443939",
    "user": "tscrim"
}
```

Thank you. LGTM.



---

archive/issue_comments_443940.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-17T23:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443940",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443941.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-14T15:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31082",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31082#issuecomment-443941",
    "user": "vbraun"
}
```

Resolution: fixed
