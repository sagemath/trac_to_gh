# Issue 32366: Update symengine, symengine_py; drop dependency on nose

archive/issues_032366.json:
```json
{
    "body": "CC:  isuruf tmonteil\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32603\n\n",
    "created_at": "2021-09-30T22:53:13Z",
    "labels": [
        "packages: optional",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Update symengine, symengine_py; drop dependency on nose",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32366",
    "user": "mkoeppe"
}
```
CC:  isuruf tmonteil



Issue created by migration from https://trac.sagemath.org/ticket/32603





---

archive/issue_comments_461828.json:
```json
{
    "body": "The pytest does not go through for me, but it's possible that my installation is messed up\n\n```\n[symengine_py-0.8.1] Running the test suite for symengine_py-0.8.1...\n[symengine_py-0.8.1] ============================= test session starts ==============================\n[symengine_py-0.8.1] platform darwin -- Python 3.9.7, pytest-6.2.5, py-1.10.0, pluggy-1.0.0 -- /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-3.9/bin/python3\n[symengine_py-0.8.1] cachedir: .pytest_cache\n[symengine_py-0.8.1] rootdir: /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-3.9/var/tmp/sage/build/symengine_py-0.8.1/src\n[symengine_py-0.8.1] collecting ... collected 0 items / 23 errors\n[symengine_py-0.8.1] \n[symengine_py-0.8.1] ==================================== ERRORS ====================================\n[symengine_py-0.8.1] ________________ ERROR collecting symengine/tests/test_arit.py _________________\n[symengine_py-0.8.1] ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-3.9/var/tmp/sage/build/symengine_py-0.8.1/src/symengine/tests/test_arit.py'.\n[symengine_py-0.8.1] Hint: make sure your test modules/packages have valid Python names.\n[symengine_py-0.8.1] Traceback:\n[symengine_py-0.8.1] /usr/local/Cellar/python@3.9/3.9.7/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module\n[symengine_py-0.8.1]     return _bootstrap._gcd_import(name[level:], package, level)\n[symengine_py-0.8.1] symengine/__init__.py:12: in <module>\n[symengine_py-0.8.1]     import symengine.lib.symengine_wrapper as wrapper\n[symengine_py-0.8.1] E   ModuleNotFoundError: No module named 'symengine.lib.symengine_wrapper'\n[symengine_py-0.8.1] _________________ ERROR collecting symengine/tests/test_cse.py _________________\n```\n\n----\nNew commits:",
    "created_at": "2021-10-01T01:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461828",
    "user": "mkoeppe"
}
```

The pytest does not go through for me, but it's possible that my installation is messed up

```
[symengine_py-0.8.1] Running the test suite for symengine_py-0.8.1...
[symengine_py-0.8.1] ============================= test session starts ==============================
[symengine_py-0.8.1] platform darwin -- Python 3.9.7, pytest-6.2.5, py-1.10.0, pluggy-1.0.0 -- /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-3.9/bin/python3
[symengine_py-0.8.1] cachedir: .pytest_cache
[symengine_py-0.8.1] rootdir: /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-3.9/var/tmp/sage/build/symengine_py-0.8.1/src
[symengine_py-0.8.1] collecting ... collected 0 items / 23 errors
[symengine_py-0.8.1] 
[symengine_py-0.8.1] ==================================== ERRORS ====================================
[symengine_py-0.8.1] ________________ ERROR collecting symengine/tests/test_arit.py _________________
[symengine_py-0.8.1] ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-3.9/var/tmp/sage/build/symengine_py-0.8.1/src/symengine/tests/test_arit.py'.
[symengine_py-0.8.1] Hint: make sure your test modules/packages have valid Python names.
[symengine_py-0.8.1] Traceback:
[symengine_py-0.8.1] /usr/local/Cellar/python@3.9/3.9.7/Frameworks/Python.framework/Versions/3.9/lib/python3.9/importlib/__init__.py:127: in import_module
[symengine_py-0.8.1]     return _bootstrap._gcd_import(name[level:], package, level)
[symengine_py-0.8.1] symengine/__init__.py:12: in <module>
[symengine_py-0.8.1]     import symengine.lib.symengine_wrapper as wrapper
[symengine_py-0.8.1] E   ModuleNotFoundError: No module named 'symengine.lib.symengine_wrapper'
[symengine_py-0.8.1] _________________ ERROR collecting symengine/tests/test_cse.py _________________
```

----
New commits:



---

archive/issue_comments_461829.json:
```json
{
    "body": "I can reproduce the error.",
    "created_at": "2021-10-01T10:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461829",
    "user": "tmonteil"
}
```

I can reproduce the error.



---

archive/issue_comments_461830.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-01T17:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461830",
    "user": "isuruf"
}
```

New commits:



---

archive/issue_comments_461831.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-01T17:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461831",
    "user": "isuruf"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461832.json:
```json
{
    "body": "It does not work for me, see the attached log.",
    "created_at": "2021-10-01T19:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461832",
    "user": "tmonteil"
}
```

It does not work for me, see the attached log.



---

archive/issue_comments_461833.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-01T19:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461833",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_461834.json:
```json
{
    "body": "Attachment [symengine_py-0.8.1.log](tarball://root/attachments/some-uuid/ticket32603/symengine_py-0.8.1.log) by tmonteil created at 2021-10-01 19:13:45",
    "created_at": "2021-10-01T19:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461834",
    "user": "tmonteil"
}
```

Attachment [symengine_py-0.8.1.log](tarball://root/attachments/some-uuid/ticket32603/symengine_py-0.8.1.log) by tmonteil created at 2021-10-01 19:13:45



---

archive/issue_comments_461835.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-02T02:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461835",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461836.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-02T02:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461836",
    "user": "isuruf"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_461837.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-02T11:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461837",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_461838.json:
```json
{
    "body": "Still some problem, see the attached log.",
    "created_at": "2021-10-02T11:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461838",
    "user": "tmonteil"
}
```

Still some problem, see the attached log.



---

archive/issue_comments_461839.json:
```json
{
    "body": "Attachment [symengine_py-0.8.1.2.log](tarball://root/attachments/some-uuid/ticket32603/symengine_py-0.8.1.2.log) by tmonteil created at 2021-10-02 11:52:13",
    "created_at": "2021-10-02T11:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461839",
    "user": "tmonteil"
}
```

Attachment [symengine_py-0.8.1.2.log](tarball://root/attachments/some-uuid/ticket32603/symengine_py-0.8.1.2.log) by tmonteil created at 2021-10-02 11:52:13



---

archive/issue_comments_461840.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-02T13:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461840",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461841.json:
```json
{
    "body": "I think the issue was that symengine_py was not rebuilt. I've bumped the version to trigger a rebuild",
    "created_at": "2021-10-02T13:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461841",
    "user": "isuruf"
}
```

I think the issue was that symengine_py was not rebuilt. I've bumped the version to trigger a rebuild



---

archive/issue_comments_461842.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-02T15:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461842",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_461843.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-02T17:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461843",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_461844.json:
```json
{
    "body": "The issue persists. The reason is that the doctest look at files in `$SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/` but when Sage tests a spkg, it only installs the spkg AFTER the test succeeds. So, if you install the spkg first and then install/test the spkg, currently what is tested is the previous installation.\n\nSo, changing package version may not fix the issue. In `spkg-check.in`, we should ask the testing framework to test files in `$SAGE_ROOT/local/var/tmp/sage/build/symengine_py-0.8.1/src/symengine/tests` not in `$SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/`\n\nBy the way, looking at `symengine.py-0.8.1/bin/test_travis.sh` (in the tarball), it seems that tests from `pytest` and tests from `test_python.py` are not the same (both are run one after the other), so we should perhaps test both.",
    "created_at": "2021-10-02T17:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461844",
    "user": "tmonteil"
}
```

The issue persists. The reason is that the doctest look at files in `$SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/` but when Sage tests a spkg, it only installs the spkg AFTER the test succeeds. So, if you install the spkg first and then install/test the spkg, currently what is tested is the previous installation.

So, changing package version may not fix the issue. In `spkg-check.in`, we should ask the testing framework to test files in `$SAGE_ROOT/local/var/tmp/sage/build/symengine_py-0.8.1/src/symengine/tests` not in `$SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/`

By the way, looking at `symengine.py-0.8.1/bin/test_travis.sh` (in the tarball), it seems that tests from `pytest` and tests from `test_python.py` are not the same (both are run one after the other), so we should perhaps test both.



---

archive/issue_comments_461845.json:
```json
{
    "body": "> By the way, looking at symengine.py-0.8.1/bin/test_travis.sh (in the tarball), it seems that tests from pytest and tests from test_python.py are not the same (both are run one after the other), so we should perhaps test both. \n\nNot really. They check that the tests run fine on inplace builds and on installed symengine.\nSince sage is not doing inplace builds, it doesn't matter.\n\nThanks for the info. I'll try to fix this.",
    "created_at": "2021-10-02T17:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461845",
    "user": "isuruf"
}
```

> By the way, looking at symengine.py-0.8.1/bin/test_travis.sh (in the tarball), it seems that tests from pytest and tests from test_python.py are not the same (both are run one after the other), so we should perhaps test both. 

Not really. They check that the tests run fine on inplace builds and on installed symengine.
Since sage is not doing inplace builds, it doesn't matter.

Thanks for the info. I'll try to fix this.



---

archive/issue_comments_461846.json:
```json
{
    "body": "> The reason is that the doctest look at files in $SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/ but when Sage tests a spkg, it only installs the spkg AFTER the test succeeds. So, if you install the spkg first and then install/test the spkg, currently what is tested is the previous installation.\n\nAt this point where is symengine_py installed to?",
    "created_at": "2021-10-02T17:33:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461846",
    "user": "isuruf"
}
```

> The reason is that the doctest look at files in $SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/ but when Sage tests a spkg, it only installs the spkg AFTER the test succeeds. So, if you install the spkg first and then install/test the spkg, currently what is tested is the previous installation.

At this point where is symengine_py installed to?



---

archive/issue_comments_461847.json:
```json
{
    "body": "Replying to [comment:14 tmonteil]:\n> The reason is that the doctest look at files in `$SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/` but when Sage tests a spkg, it only installs the spkg AFTER the test succeeds. So, if you install the spkg first and then install/test the spkg, currently what is tested is the previous installation.\n\nThat's not true. Take a look at `build/bin/sage-spkg`: `spkg-check` is run after the staged installation has been copied to the final installation directory.",
    "created_at": "2021-10-02T18:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461847",
    "user": "mkoeppe"
}
```

Replying to [comment:14 tmonteil]:
> The reason is that the doctest look at files in `$SAGE_ROOT/local/lib/python3.9/site-packages/symengine/tests/` but when Sage tests a spkg, it only installs the spkg AFTER the test succeeds. So, if you install the spkg first and then install/test the spkg, currently what is tested is the previous installation.

That's not true. Take a look at `build/bin/sage-spkg`: `spkg-check` is run after the staged installation has been copied to the final installation directory.



---

archive/issue_comments_461848.json:
```json
{
    "body": "(Also note that since #32361, Python packages are not actually staged using `SAGE_DESTDIR` any more. We just build and then install a wheel. This happens before running `spkg-check`.)",
    "created_at": "2021-10-02T18:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461848",
    "user": "mkoeppe"
}
```

(Also note that since #32361, Python packages are not actually staged using `SAGE_DESTDIR` any more. We just build and then install a wheel. This happens before running `spkg-check`.)



---

archive/issue_comments_461849.json:
```json
{
    "body": "I'm confused as to how the issue mentioned by `@`tmonteil happens then.",
    "created_at": "2021-10-03T18:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461849",
    "user": "isuruf"
}
```

I'm confused as to how the issue mentioned by `@`tmonteil happens then.



---

archive/issue_comments_461850.json:
```json
{
    "body": "In #32595 I am currently running portability testing on GH Actions, including this ticket. We'll see if these tests can reproduce the issue.",
    "created_at": "2021-10-03T18:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461850",
    "user": "mkoeppe"
}
```

In #32595 I am currently running portability testing on GH Actions, including this ticket. We'll see if these tests can reproduce the issue.



---

archive/issue_comments_461851.json:
```json
{
    "body": "This has run successfully on https://github.com/mkoeppe/sage/actions/runs/1298853742; so I am setting this to positive review",
    "created_at": "2021-10-04T19:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461851",
    "user": "mkoeppe"
}
```

This has run successfully on https://github.com/mkoeppe/sage/actions/runs/1298853742; so I am setting this to positive review



---

archive/issue_comments_461852.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-04T19:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461852",
    "user": "mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_461853.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-13T22:50:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32366",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32366#issuecomment-461853",
    "user": "vbraun"
}
```

Resolution: fixed
