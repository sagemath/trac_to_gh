# Issue 23359: Update GLPK to 4.63

Issue created by migration from https://trac.sagemath.org/ticket/23596

Original creator: fbissey

Original creation time: 2017-08-08 01:56:38

CC:  dcoudert

Routine upgrade glpk 4.61 and over break a debugging doctest as a source file has changed location and name.

tarball: [https://ftp.gnu.org/gnu/glpk/glpk-4.63.tar.gz](https://ftp.gnu.org/gnu/glpk/glpk-4.63.tar.gz)


---

Comment by fbissey created at 2017-08-08 02:20:57

New commits:


---

Comment by fbissey created at 2017-08-08 02:20:57

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-08-08 19:50:34

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-08-11 13:07:30

There is something strange happening when re-installing GLPK 4.60 (the current version in Sage) after installing 4.63. The libraries look like this:

```
lrwxrwxrwx 1 jdemeyer jdemeyer      17 Aug 11 14:19 local/lib/libglpk.so -> libglpk.so.40.1.0
lrwxrwxrwx 1 jdemeyer jdemeyer      17 Aug 11 14:19 local/lib/libglpk.so.40 -> libglpk.so.40.2.2
-rwxr-xr-x 1 jdemeyer jdemeyer 3592384 Aug 11 14:19 local/lib/libglpk.so.40.1.0
-rwxr-xr-x 1 jdemeyer jdemeyer 3626448 Aug  8 20:45 local/lib/libglpk.so.40.2.2
```

Note how both versions are installed and how `local/lib/libglpk.so.40` points to the _new_ version instead of the old.

This leads to doctest failures because the _new_ version is still used by Sage.

Since this might mask other problems, I am unsetting positive_review until this is clarified.


---

Comment by jdemeyer created at 2017-08-11 13:07:30

Changing status from positive_review to needs_info.


---

Comment by vbraun created at 2017-08-11 18:17:30

Resolution: fixed


---

Comment by vbraun created at 2017-08-11 18:19:27

Changing status from closed to new.


---

Comment by vbraun created at 2017-08-11 18:19:27

Resolution changed from fixed to 


---

Comment by fbissey created at 2017-08-11 20:25:38

Yes, this is curious. Is there anything interesting in your log of glpk-4.60 when you downgrade? It may be a quirk from libtool, but we can deal with that with a removal of old libraries first.


---

Comment by jdemeyer created at 2017-08-11 21:36:08

Replying to [comment:7 fbissey]:
> we can deal with that with a removal of old libraries first.

Not quite, we cannot retroactively patch the current version of GLPK.


---

Comment by vbraun created at 2017-08-11 22:11:16

We don't really make any promises about downgrades, so I wouldn't be overly concerned...


---

Comment by fbissey created at 2017-08-11 22:29:29

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 fbissey]:
> > we can deal with that with a removal of old libraries first.
> 
> Not quite, we cannot retroactively patch the current version of GLPK.

Right. I didn't think of that obviously. Anything interesting in the log saying the linking failed?


---

Comment by fbissey created at 2017-08-14 00:22:24

OK, I can reproduce the issue and it is weird.

```
[glpk-4.60.p0] libtool: install: (cd /home/fbissey/sandbox/git-fork/sage/local/lib && { ln -s -f libglpk.so.40.1.0 libglpk.so.40 || { rm -f libglpk.so.40 && ln -s libglpk.so.40.1.0 libglpk.so.40; }; })
[glpk-4.60.p0] libtool: install: (cd /home/fbissey/sandbox/git-fork/sage/local/lib && { ln -s -f libglpk.so.40.1.0 libglpk.so || { rm -f libglpk.so && ln -s libglpk.so.40.1.0 libglpk.so; }; })
```

So the first operation silently fails but the second one succeeds. In fact I would say the first one is not executed.


---

Comment by fbissey created at 2017-08-14 01:54:23

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 fbissey]:
> > we can deal with that with a removal of old libraries first.
> 
> Not quite, we cannot retroactively patch the current version of GLPK.

Going back to this one. We cannot make `glpk-4.60` behave retro-actively. But we can prevent the problem to happen again in the future.

I have suspicions other libtool packages may behave the same way. Apart from future proofing at the spkg level, Erik's work in #22509 is probably the only thing that will enable a working downgrade path for that case. Again all this is for future improvements.


---

Comment by fbissey created at 2017-08-20 22:58:14

`@`Jeroen: As I said I don't think we can fix the downgrade to 4.60[1]. I added a commit to remove old libraries, so that problem won't happen after glpk 4.63.

[1] All right, we could push a 4.60.p1 and then upgrade. But I don't think that's worth the extra work.
----
New commits:


---

Comment by fbissey created at 2017-08-20 22:58:14

Changing status from new to needs_review.


---

Comment by jpflori created at 2017-08-21 16:59:36

I think we can live without going back to 4.60.


---

Comment by jpflori created at 2017-08-21 16:59:36

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2017-08-21 17:02:45

By the way were our patches ever forwarded upstream?
I think I tried but don't remember what happened.


---

Comment by jdemeyer created at 2017-08-21 19:25:54

Replying to [comment:14 jpflori]:
> I think we can live without going back to 4.60.

Of course. My concern wasn't particularly about 4.60, but there might be a general problem which would occur for every version.


---

Comment by jdemeyer created at 2017-08-21 19:26:42

Replying to [comment:15 jpflori]:
> By the way were our patches ever forwarded upstream?

`error_recovery.patch` was forwarded upstream but rejected.


---

Comment by vbraun created at 2017-08-26 09:57:59

Resolution: fixed


---

Comment by vbraun created at 2017-09-04 06:07:52

Changing status from closed to new.


---

Comment by vbraun created at 2017-09-04 06:07:52

I'm getting crashes on 32-bit...


---

Comment by vbraun created at 2017-09-04 06:07:52

Resolution changed from fixed to 


---

Comment by vbraun created at 2017-09-04 06:09:23

Also, with SAGE_DEBUG=yes 

```
**********************************************************************
File "src/sage/numerical/backends/glpk_backend.pyx", line 544, in sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint
Failed example:
    q.add_constraint(p.new_variable()[0] <= 1)
Expected:
    Traceback (most recent call last):
    ...
    GLPKError: glp_set_mat_row: i = 1; len = 1; invalid row length
    Error detected in file glpapi01.c at line ...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint[10]>", line 1, in <module>
        q.add_constraint(p.new_variable()[Integer(0)] <= Integer(1))
      File "sage/numerical/mip.pyx", line 1816, in sage.numerical.mip.MixedIntegerLinearProgram.add_constraint (/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/numerical/mip.c:13640)
        self.add_constraint(lhs-rhs, max=0, name=name)
      File "sage/numerical/mip.pyx", line 1804, in sage.numerical.mip.MixedIntegerLinearProgram.add_constraint (/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/numerical/mip.c:13065)
        self._backend.add_linear_constraint(constraint.items(), min, max, name)
      File "sage/numerical/backends/glpk_backend.pyx", line 569, in sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint (/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/numerical/backends/glpk_backend.c:6697)
        sig_on()
    GLPKError: glp_set_mat_row: i = 1; len = 1; invalid row length 
    Error detected in file api/prob1.c at line 763
**********************************************************************
1 item had failures:
   1 of  12 in sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint
    [535 tests, 1 failure, 4.87 s]
```



---

Comment by fbissey created at 2017-09-04 06:39:52

Replying to [comment:20 vbraun]:
> Also, with SAGE_DEBUG=yes 
> {{{
> **********************************************************************
> File "src/sage/numerical/backends/glpk_backend.pyx", line 544, in sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint
> Failed example:
>     q.add_constraint(p.new_variable()[0] <= 1)
> Expected:
>     Traceback (most recent call last):
>     ...
>     GLPKError: glp_set_mat_row: i = 1; len = 1; invalid row length
>     Error detected in file glpapi01.c at line ...
> Got:
>     <BLANKLINE>
>     Traceback (most recent call last):
>       File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/mnt/disk/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint[10]>", line 1, in <module>
>         q.add_constraint(p.new_variable()[Integer(0)] <= Integer(1))
>       File "sage/numerical/mip.pyx", line 1816, in sage.numerical.mip.MixedIntegerLinearProgram.add_constraint (/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/numerical/mip.c:13640)
>         self.add_constraint(lhs-rhs, max=0, name=name)
>       File "sage/numerical/mip.pyx", line 1804, in sage.numerical.mip.MixedIntegerLinearProgram.add_constraint (/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/numerical/mip.c:13065)
>         self._backend.add_linear_constraint(constraint.items(), min, max, name)
>       File "sage/numerical/backends/glpk_backend.pyx", line 569, in sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint (/mnt/disk/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/numerical/backends/glpk_backend.c:6697)
>         sig_on()
>     GLPKError: glp_set_mat_row: i = 1; len = 1; invalid row length 
>     Error detected in file api/prob1.c at line 763
> **********************************************************************
> 1 item had failures:
>    1 of  12 in sage.numerical.backends.glpk_backend.GLPKBackend.add_linear_constraint
>     [535 tests, 1 failure, 4.87 s]
> }}}

That's the error you would get if the patch to `sage/numerical/backends/glpk_backend.pyx` is not applied. So for that one at least, it looks like something didn't apply cleanly. 

Could we have some access to errors on 32bits?


---

Comment by jdemeyer created at 2017-09-04 09:24:34

I'm doing a 32bit build now. But I agree that in [comment:20] something went wrong in applying this branch. Or possibly, you weren't trying to test this branch at all and you are hitting [comment:4].


---

Comment by vbraun created at 2017-09-04 22:48:44

Yes, thats probably whats going on in :comment:20 

But the 32-issue is real, I just don't have the logs any more as the buildbot ran out of disks space


---

Comment by jdemeyer created at 2017-09-05 15:42:31

Replying to [comment:23 vbraun]:
> But the 32-issue is real, I just don't have the logs any more as the buildbot ran out of disks space

I cannot reproduce this on `arando` (32-bit Linux). Could you please try again, if you are running out of disk space, maybe that could explain why stuff breaks too.


---

Comment by jdemeyer created at 2017-09-05 15:42:31

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-09-05 15:42:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-07 06:55:41


```
sage: g = graphs.CycleGraph(5) ## line 4750 ##
sage: g.fractional_chromatic_index() ## line 4751 ##
2.5
sage: g.fractional_chromatic_index(solver="PPL") ## line 4756 ##
5/2
sage: g = graphs.PetersenGraph() ## line 4763 ##
sage: g.fractional_chromatic_index(solver='GLPK') ## line 4764 ##
------------------------------------------------------------------------
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x44e8)[0xf6acc4e8]
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x455f)[0xf6acc55f]
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x69a7)[0xf6ace9a7]
[0xf772ecb0]
/home/buildbot/slave/sage_git/build/local/lib/libglpk.so.40(+0x20e89)[0xc593ce89]
/home/buildbot/slave/sage_git/build/local/lib/libglpk.so.40(+0x2914c)[0xc594514c]
/home/buildbot/slave/sage_git/build/local/lib/libglpk.so.40(+0x29473)[0xc5945473]
/home/buildbot/slave/sage_git/build/local/lib/libglpk.so.40(+0x295dc)[0xc59455dc]
/home/buildbot/slave/sage_git/build/local/lib/libglpk.so.40(glp_intopt+0x5f5)[0xc59258a5]
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/numerical/backends/glpk_backend.so(+0x127d5)[0xc60c97d5]
/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/numerical/mip.so(+0xcbf7)[0xcb7e4bf7]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyCFunction_Call+0x109)[0xf75c7299]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x9089)[0xf76357d9]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7c4)[0xf76360e4]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8f05)[0xf7635655]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7c4)[0xf76360e4]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCode+0x63)[0xf7636253]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x78e3)[0xf7634033]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7c4)[0xf76360e4]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalFrameEx+0x8f05)[0xf7635655]
/home/buildbot/slave/sage_git/build/local/lib/libpython2.7.so.1.0(PyEval_EvalCodeEx+0x7c4)[0xf76360e4]
```

* http://build.sagemath.org/#/builders/64/builds/3/steps/9/logs/stdio
* http://build.sagemath.org/#/builders/22/builds/3/steps/9/logs/stdio
* http://build.sagemath.org/#/builders/16/builds/3/steps/9/logs/stdio


---

Comment by vbraun created at 2017-09-07 06:55:41

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2017-09-07 07:17:28

Ok, so this it is timing out. `PetersenGraph` that rings a bell, there was something about that recently I think.


---

Comment by fbissey created at 2017-09-07 08:20:17

It is "caused" by #23658 that just got merged in 8.1.beta4.  It seem the test was added to check a similar issue was fixed. Copying David Coudert.


---

Comment by dcoudert created at 2017-09-07 09:14:38

Can someone tell me the procedure to test this ticket? I don't know how to do it. Thanks.


---

Comment by fbissey created at 2017-09-07 09:22:45

Replying to [comment:29 dcoudert]:
> Can someone tell me the procedure to test this ticket? I don't know how to do it. Thanks.
> 

Hi David, the problem only seem to be happen on 32bits platforms. You should be able to test it on top of 8.1.beta4 which includes #23658 in which you introduced the test that is now failing. Follow the usual procedure from http://doc.sagemath.org/html/en/developer/manual_git.html#chapter-manual-git . The problem is only with `src/sage/graphs/graph.py` on line 1372.


---

Comment by dcoudert created at 2017-09-07 09:52:01

I follwed the [manual_git.html](http://doc.sagemath.org/html/en/developer/manual_git.html#chapter-manual-git) page and got the following (git is not my friend).

```
confetti:sage dcoudert$  git fetch trac 30c496f
fatal: Couldn't find remote ref 30c496f
confetti:sage dcoudert$ git fetch trac 30c496fb7ab510df7b0a88e0ccae3050799ebdc6
confetti:sage dcoudert$ git checkout -b my_branch FETCH_HEAD
fatal: Cannot update paths and switch to branch 'my_branch' at the same time.
Did you intend to checkout 'FETCH_HEAD' which can not be resolved as commit?
```


Anyway, I don't have access to a 32bit machine. So I don't know how to test and help solving the issue.


---

Comment by jdemeyer created at 2017-09-07 11:52:35

I marked the problematic test as `# known bug`. This should allow use to move forward with this ticket.
----
New commits:


---

Comment by jdemeyer created at 2017-09-07 11:52:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-07 11:55:48

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2017-09-07 11:55:48

Changing priority to blocker because the patchbots are all posting doctest failures due to the downgrade bug [comment:4].


---

Comment by dcoudert created at 2017-09-07 13:19:17

I succeed to install and test the patch (thank you Jeroen for the change in the branch name. It ease my life).
For me it's working well, no infinite loop.


---

Comment by jdemeyer created at 2017-09-08 09:27:04

This minor change still needs review:

Replying to [comment:33 jdemeyer]:
> ||[a6e1d23](https://git.sagemath.org/sage.git/commit?id=a6e1d232142c8e7c6a2746ec64c04793b9e763ec)||`Mark failing test as "known bug"`||


---

Comment by fbissey created at 2017-09-08 10:02:26

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-09-08 10:02:26

Sure, let's get this show back on the road.


---

Comment by vbraun created at 2017-09-10 22:06:08

Resolution: fixed
