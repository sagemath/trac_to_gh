# Issue 23181: put number fields in Fields().Infinite()

archive/issues_023181.json:
```json
{
    "body": "CC:  @nthiery @tscrim\n\nand the same for QQ of course\n\nIssue created by migration from https://trac.sagemath.org/ticket/23418\n\n",
    "created_at": "2017-07-13T07:01:58Z",
    "labels": [
        "component: number fields",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "put number fields in Fields().Infinite()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23181",
    "user": "https://github.com/fchapoton"
}
```
CC:  @nthiery @tscrim

and the same for QQ of course

Issue created by migration from https://trac.sagemath.org/ticket/23418





---

archive/issue_comments_323940.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-07-13T07:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323940",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_323941.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-13T10:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323941",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323942.json:
```json
{
    "body": "This triggers some problem here:\n\n```\nsage -t --long src/sage/structure/parent.pyx  # 6 doctests failed\n```",
    "created_at": "2017-07-13T10:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323942",
    "user": "https://github.com/fchapoton"
}
```

This triggers some problem here:

```
sage -t --long src/sage/structure/parent.pyx  # 6 doctests failed
```



---

archive/issue_comments_323943.json:
```json
{
    "body": "It seems that the morphisms from Sets take over the morphisms from Rings..",
    "created_at": "2017-07-13T11:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323943",
    "user": "https://github.com/fchapoton"
}
```

It seems that the morphisms from Sets take over the morphisms from Rings..



---

archive/issue_comments_323944.json:
```json
{
    "body": "Failures are related to this:\n\n```\nsage: x = QQ['x'].0\nsage: t = abs(ZZ.random_element(10^6))\nsage: K = NumberField(x^2 + 2*3*7*11, \"a\"+str(t))\nsage: a = K.gen()\n\nsage: Hom(K, a.matrix().parent())\nSet of Morphisms from Number Field in a791947 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field in Category of infinite rings\n<class 'sage.categories.homset.Homset_with_category'>\n```\ncompared to vanilla Sage:\n\n```\nsage: Hom(K, a.matrix().parent())\nSet of Homomorphisms from Number Field in a395598 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field\nsage: type(Hom(K, a.matrix().parent()))\n<class 'sage.rings.homset.RingHomset_generic_with_category'>\n```\n\nThis differences comes from the fact that the category becomes a join category (in the branch) because that is the meet category computed by `Hom`:\n\n```\nsage: K.category()._meet_(a.matrix().parent().category())\nCategory of infinite rings\nsage: type(_)\n<class 'sage.categories.category.JoinCategory_with_category'>\n```\nversus vanilla:\n\n```\nsage: K.category()._meet_(a.matrix().parent().category())\nCategory of rings\nsage: type(_)\n<class 'sage.categories.rings.Rings_with_category'>\n```\nNow, `K` is not a subclass of the meet category's `parent_class`, which causes the `Cat.parent_class._Hom_` method to now raise an error:\n\n```\nsage: Cat = K.category()._meet_(a.matrix().parent().category())\nsage: Cat.parent_class\n<class 'sage.categories.category.JoinCategory.parent_class'>\nsage: Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-6-aa7f8d9cdf73> in <module>()\n----> 1 Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)\nTypeError: unbound method _Hom_() must be called with JoinCategory.parent_class instance as first argument (got NumberField_quadratic_with_category instance instead)\n```\nversus vanilla\n\n```\nsage: Cat = K.category()._meet_(a.matrix().parent().category())\nsage: Cat.parent_class\n<class 'sage.categories.rings.Rings.parent_class'>\nsage: Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)\nSet of Homomorphisms from Number Field in a395598 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field\n```",
    "created_at": "2017-08-30T21:45:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323944",
    "user": "https://github.com/tscrim"
}
```

Failures are related to this:

```
sage: x = QQ['x'].0
sage: t = abs(ZZ.random_element(10^6))
sage: K = NumberField(x^2 + 2*3*7*11, "a"+str(t))
sage: a = K.gen()

sage: Hom(K, a.matrix().parent())
Set of Morphisms from Number Field in a791947 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field in Category of infinite rings
<class 'sage.categories.homset.Homset_with_category'>
```
compared to vanilla Sage:

```
sage: Hom(K, a.matrix().parent())
Set of Homomorphisms from Number Field in a395598 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field
sage: type(Hom(K, a.matrix().parent()))
<class 'sage.rings.homset.RingHomset_generic_with_category'>
```

This differences comes from the fact that the category becomes a join category (in the branch) because that is the meet category computed by `Hom`:

```
sage: K.category()._meet_(a.matrix().parent().category())
Category of infinite rings
sage: type(_)
<class 'sage.categories.category.JoinCategory_with_category'>
```
versus vanilla:

```
sage: K.category()._meet_(a.matrix().parent().category())
Category of rings
sage: type(_)
<class 'sage.categories.rings.Rings_with_category'>
```
Now, `K` is not a subclass of the meet category's `parent_class`, which causes the `Cat.parent_class._Hom_` method to now raise an error:

```
sage: Cat = K.category()._meet_(a.matrix().parent().category())
sage: Cat.parent_class
<class 'sage.categories.category.JoinCategory.parent_class'>
sage: Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-6-aa7f8d9cdf73> in <module>()
----> 1 Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)
TypeError: unbound method _Hom_() must be called with JoinCategory.parent_class instance as first argument (got NumberField_quadratic_with_category instance instead)
```
versus vanilla

```
sage: Cat = K.category()._meet_(a.matrix().parent().category())
sage: Cat.parent_class
<class 'sage.categories.rings.Rings.parent_class'>
sage: Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)
Set of Homomorphisms from Number Field in a395598 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field
```



---

archive/issue_comments_323945.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-09-21T09:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323945",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_323946.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-21T09:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323946",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323947.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-21T11:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323947",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323948.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-31T13:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323948",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_323949.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-12-31T13:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323949",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_events_060181.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2017-12-31T13:19:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "milestone": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23181#event-60181"
}
```



---

archive/issue_comments_323950.json:
```json
{
    "body": "the problem from [This is the Trac macro *comment:5* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:5-macro) is solved in `d2bf048` via\n\n```diff\n--- a/src/sage/categories/homset.py\n+++ b/src/sage/categories/homset.py\n@@ -402,7 +402,7 @@ def Hom(X, Y, category=None, check=True):\n                 #   will be called twice.\n                 # - This is bound to fail if X is an extension type and\n                 #   does not actually inherit from category.parent_class\n-                H = category.parent_class._Hom_(X, Y, category = category)\n+                H = X.category().parent_class._Hom_(X, Y, category = category)\n             except (AttributeError, TypeError):\n                 # By default, construct a plain homset.\n                 H = Homset(X, Y, category = category, check=check)\n```",
    "created_at": "2017-12-31T13:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323950",
    "user": "https://github.com/videlec"
}
```

the problem from [This is the Trac macro *comment:5* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:5-macro) is solved in `d2bf048` via

```diff
--- a/src/sage/categories/homset.py
+++ b/src/sage/categories/homset.py
@@ -402,7 +402,7 @@ def Hom(X, Y, category=None, check=True):
                 #   will be called twice.
                 # - This is bound to fail if X is an extension type and
                 #   does not actually inherit from category.parent_class
-                H = category.parent_class._Hom_(X, Y, category = category)
+                H = X.category().parent_class._Hom_(X, Y, category = category)
             except (AttributeError, TypeError):
                 # By default, construct a plain homset.
                 H = Homset(X, Y, category = category, check=check)
```



---

archive/issue_comments_323951.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-12-31T14:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323951",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_323952.json:
```json
{
    "body": "Looks good to me. Maybe Travis can confirm ?",
    "created_at": "2017-12-31T18:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323952",
    "user": "https://github.com/fchapoton"
}
```

Looks good to me. Maybe Travis can confirm ?



---

archive/issue_comments_323953.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-12-31T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323953",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_323954.json:
```json
{
    "body": "No, I don't think this is correct because now it ignores the `category` input, and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`). So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is *because* of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?",
    "created_at": "2017-12-31T22:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323954",
    "user": "https://github.com/tscrim"
}
```

No, I don't think this is correct because now it ignores the `category` input, and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`). So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is *because* of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?



---

archive/issue_comments_323955.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> No, I don't think this is correct because now it ignores the `category` input\n\n\nStrictly speaking it does not, since the `category` argument is passed in the call\n\n```\nH = X.category().parent_class._Hom_(X, Y, category = category)\n```\n\n> and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).\n\n\nDo you have any example of this? I might understand the objection, but my \"cheap fix\" is indeed fixing problems and not creating new ones (as far as doctesting is complete).\n\n> So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is *because* of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?\n\n\nAs you might have noticed, the call line 405 in `categories/homset.py` is already hackish. Parents implementing their own `_Hom_` method should by themselves call a super (or equivalent). Before doing my \"cheap fix\", I thought that the good solution would be to remove this line 405 and fix the parents. Do you agree that this would be **the** solution?\n\nIf you agree with the above, there are two concrete ways of doing this:\n- let my cheap fix pass and remove line 405 afterwards\n- remove line 405 in a dependency ticket",
    "created_at": "2018-01-01T10:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323955",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:13 tscrim]:
> No, I don't think this is correct because now it ignores the `category` input


Strictly speaking it does not, since the `category` argument is passed in the call

```
H = X.category().parent_class._Hom_(X, Y, category = category)
```

> and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).


Do you have any example of this? I might understand the objection, but my "cheap fix" is indeed fixing problems and not creating new ones (as far as doctesting is complete).

> So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is *because* of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?


As you might have noticed, the call line 405 in `categories/homset.py` is already hackish. Parents implementing their own `_Hom_` method should by themselves call a super (or equivalent). Before doing my "cheap fix", I thought that the good solution would be to remove this line 405 and fix the parents. Do you agree that this would be **the** solution?

If you agree with the above, there are two concrete ways of doing this:
- let my cheap fix pass and remove line 405 afterwards
- remove line 405 in a dependency ticket



---

archive/issue_comments_323956.json:
```json
{
    "body": "Replying to [comment:14 vdelecroix]:\n> Replying to [comment:13 tscrim]:\n> > No, I don't think this is correct because now it ignores the `category` input\n\n> \n> Strictly speaking it does not, since the `category` argument is passed in the call\n> \n> ```\n> H = X.category().parent_class._Hom_(X, Y, category = category)\n> ```\n\n\nNo, `_Hom_` ignores the category input.\n\n> > and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).\n\n> \n> Do you have any example of this? I might understand the objection, but my \"cheap fix\" is indeed fixing problems and not creating new ones (as far as doctesting is complete).\n\n\nNo, your hack is creating new problems. For example, suppose `X` is an algebra with:\n\n- basis `{a, b}`,\n- multiplication `a^2 = b^2 = ab = a`.\n\nIf we want to construct a map `f: X -> X` given by `a,b |-> b`. This is not an algebra morphism, but instead only a module morphism. If we have `Algebras._Hom_`, which expects the category to be algebras (as it should), then this will break horribly and there is no way to use a `Modules._Hom_` (assuming it is also implemented).\n\nFor an example where this is currently implemented, we can replace `Algebras` with `HighestWeightCrystals` and `Modules` with `Crystals`. I have also constructed similar morphisms as above for my research.\n\n> > So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is *because* of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?\n\n> \n> As you might have noticed, the call line 405 in `categories/homset.py` is already hackish. Parents implementing their own `_Hom_` method should by themselves call a super (or equivalent).\n\n\nI am not sure this would be the same behavior. There are two different things going on:\n\n1. If a parent does not implement a `_Hom_` method, then it should fall back to the specified category. Continuing my above example, this would only default to `Algebras._Hom_`, which would be wrong.\n2. The other behavior is if the homset returned by `X._Hom_` does not support the more general category, say, because it takes advantage of the extra structure (say, is only uses the algebra generating set and not the [possibly infinite] basis). One should expect that `X.category()._Hom_` would also take advantage of that extra structure as well and would similarly forbid more general categories.\n\n> Before doing my \"cheap fix\", I thought that the good solution would be to remove this line 405 and fix the parents. Do you agree that this would be **the** solution?\n\n\nIt doesn't make sense to me for the parent/category implementation of `_Hom_` to do super calls when something fails. I think it would create a lot of redundant logic (the error handling). Also, everything in between `X.category()` and the specified `category` would likely (needlessly) fail, making these calls significantly slower when there is a large category difference. While this is a solution, I think it is a very bad solution.\n\nI think special handling the join categories is going to be the proper fix as join categories are somewhat special in the category framework. While it may be just fixing the symptoms, it does not have the drawbacks that the other approaches have. I will push something today.",
    "created_at": "2018-01-02T18:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323956",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:14 vdelecroix]:
> Replying to [comment:13 tscrim]:
> > No, I don't think this is correct because now it ignores the `category` input

> 
> Strictly speaking it does not, since the `category` argument is passed in the call
> 
> ```
> H = X.category().parent_class._Hom_(X, Y, category = category)
> ```


No, `_Hom_` ignores the category input.

> > and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).

> 
> Do you have any example of this? I might understand the objection, but my "cheap fix" is indeed fixing problems and not creating new ones (as far as doctesting is complete).


No, your hack is creating new problems. For example, suppose `X` is an algebra with:

- basis `{a, b}`,
- multiplication `a^2 = b^2 = ab = a`.

If we want to construct a map `f: X -> X` given by `a,b |-> b`. This is not an algebra morphism, but instead only a module morphism. If we have `Algebras._Hom_`, which expects the category to be algebras (as it should), then this will break horribly and there is no way to use a `Modules._Hom_` (assuming it is also implemented).

For an example where this is currently implemented, we can replace `Algebras` with `HighestWeightCrystals` and `Modules` with `Crystals`. I have also constructed similar morphisms as above for my research.

> > So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is *because* of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?

> 
> As you might have noticed, the call line 405 in `categories/homset.py` is already hackish. Parents implementing their own `_Hom_` method should by themselves call a super (or equivalent).


I am not sure this would be the same behavior. There are two different things going on:

1. If a parent does not implement a `_Hom_` method, then it should fall back to the specified category. Continuing my above example, this would only default to `Algebras._Hom_`, which would be wrong.
2. The other behavior is if the homset returned by `X._Hom_` does not support the more general category, say, because it takes advantage of the extra structure (say, is only uses the algebra generating set and not the [possibly infinite] basis). One should expect that `X.category()._Hom_` would also take advantage of that extra structure as well and would similarly forbid more general categories.

> Before doing my "cheap fix", I thought that the good solution would be to remove this line 405 and fix the parents. Do you agree that this would be **the** solution?


It doesn't make sense to me for the parent/category implementation of `_Hom_` to do super calls when something fails. I think it would create a lot of redundant logic (the error handling). Also, everything in between `X.category()` and the specified `category` would likely (needlessly) fail, making these calls significantly slower when there is a large category difference. While this is a solution, I think it is a very bad solution.

I think special handling the join categories is going to be the proper fix as join categories are somewhat special in the category framework. While it may be just fixing the symptoms, it does not have the drawbacks that the other approaches have. I will push something today.



---

archive/issue_comments_323957.json:
```json
{
    "body": "Replying to [comment:15 tscrim]:\n> Replying to [comment:14 vdelecroix]:\n> > Replying to [comment:13 tscrim]:\n> > > No, I don't think this is correct because now it ignores the `category` input\n\n> > \n> > Strictly speaking it does not, since the `category` argument is passed in the call\n> > \n> > ```\n> > H = X.category().parent_class._Hom_(X, Y, category = category)\n> > ```\n\n> \n> No, `_Hom_` ignores the category input.\n> \n> > > and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).\n\n> > \n> > Do you have any example of this? I might understand the objection, but my \"cheap fix\" is indeed fixing problems and not creating new ones (as far as doctesting is complete).\n\n> \n> No, your hack is creating new problems. [SNIP]\n\n\nThis would better be doctested! Could you come up with concrete examples to be added to the branch? Especially because we are going to play with the `_Hom_` code.\n \n>>> So this change is a regression [...]\n\n> I will push something today.\n\nThanks! You might want to use another ticket or update the description of this one.",
    "created_at": "2018-01-02T20:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323957",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:15 tscrim]:
> Replying to [comment:14 vdelecroix]:
> > Replying to [comment:13 tscrim]:
> > > No, I don't think this is correct because now it ignores the `category` input

> > 
> > Strictly speaking it does not, since the `category` argument is passed in the call
> > 
> > ```
> > H = X.category().parent_class._Hom_(X, Y, category = category)
> > ```

> 
> No, `_Hom_` ignores the category input.
> 
> > > and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).

> > 
> > Do you have any example of this? I might understand the objection, but my "cheap fix" is indeed fixing problems and not creating new ones (as far as doctesting is complete).

> 
> No, your hack is creating new problems. [SNIP]


This would better be doctested! Could you come up with concrete examples to be added to the branch? Especially because we are going to play with the `_Hom_` code.
 
>>> So this change is a regression [...]

> I will push something today.

Thanks! You might want to use another ticket or update the description of this one.



---

archive/issue_comments_323958.json:
```json
{
    "body": "Replying to [comment:16 vdelecroix]:\n> This would better be doctested! Could you come up with concrete examples to be added to the branch? Especially because we are going to play with the `_Hom_` code.\n\n\nI believe I have a concrete example and will add it.\n\n> >>> So this change is a regression [...]\n\n> > I will push something today.\n> \n> Thanks! You might want to use another ticket or update the description of this one.\n\n\nNo problem. Thanks for your work on this.",
    "created_at": "2018-01-03T00:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323958",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:16 vdelecroix]:
> This would better be doctested! Could you come up with concrete examples to be added to the branch? Especially because we are going to play with the `_Hom_` code.


I believe I have a concrete example and will add it.

> >>> So this change is a regression [...]

> > I will push something today.
> 
> Thanks! You might want to use another ticket or update the description of this one.


No problem. Thanks for your work on this.



---

archive/issue_comments_323959.json:
```json
{
    "body": "Actually, from looking at it and thinking about it more, the category of highest weight crystals is a full subcategory, so it does not quite work (in contrast to algebras and modules). So instead I just manufactured a minimal example that fails with your change.\n\nHere is a branch that does special handling of `JoinCategory`. It passes all the tests that were previously failing.\n\n---\nNew commits:",
    "created_at": "2018-01-03T07:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323959",
    "user": "https://github.com/tscrim"
}
```

Actually, from looking at it and thinking about it more, the category of highest weight crystals is a full subcategory, so it does not quite work (in contrast to algebras and modules). So instead I just manufactured a minimal example that fails with your change.

Here is a branch that does special handling of `JoinCategory`. It passes all the tests that were previously failing.

---
New commits:



---

archive/issue_comments_323960.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-03T07:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323960",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_323961.json:
```json
{
    "body": "The following loop is randomly choosing the last working call.\n\n```\nfor C in cats:\n    try:\n        H = C.parent_class._Hom_(X, Y, category=category)\n    except (AttributeError, TypeError):\n        pass\n```\nIf you want to keep this hack, wouldn't it be better this way\n\n```\nfor C in cats:\n    try:\n        H = C.parent_class._Hom_(X, Y, category=category)\n    except (AttributeError, TypeError):\n        pass\n    else:\n        break\n```",
    "created_at": "2018-01-03T15:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323961",
    "user": "https://github.com/videlec"
}
```

The following loop is randomly choosing the last working call.

```
for C in cats:
    try:
        H = C.parent_class._Hom_(X, Y, category=category)
    except (AttributeError, TypeError):
        pass
```
If you want to keep this hack, wouldn't it be better this way

```
for C in cats:
    try:
        H = C.parent_class._Hom_(X, Y, category=category)
    except (AttributeError, TypeError):
        pass
    else:
        break
```



---

archive/issue_comments_323962.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-03T16:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323963.json:
```json
{
    "body": "Good point; fixed.",
    "created_at": "2018-01-03T16:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323963",
    "user": "https://github.com/tscrim"
}
```

Good point; fixed.



---

archive/issue_comments_323964.json:
```json
{
    "body": "Green bot.",
    "created_at": "2018-01-12T18:58:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323964",
    "user": "https://github.com/tscrim"
}
```

Green bot.



---

archive/issue_comments_323965.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-12T19:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323965",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_323966.json:
```json
{
    "body": "Sorry to have forgotten!",
    "created_at": "2018-01-12T19:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323966",
    "user": "https://github.com/videlec"
}
```

Sorry to have forgotten!



---

archive/issue_comments_323967.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-01-14T13:14:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323967",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_323968.json:
```json
{
    "body": "```\ngit reset --hard Hsage -t --long --warn-long 69.0 src/sage/structure/parent.pyx\n**********************************************************************\nFile \"src/sage/structure/parent.pyx\", line 1855, in sage.structure.parent.Parent.hom._generic_coerce_map\nFailed example:\n    QQ['x', 'y']._generic_coerce_map(QQ).category_for()\nExpected:\n    Category of unique factorization domains\nGot:\n    Category of infinite unique factorization domains\nEAD~\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.parent.Parent.hom._generic_coerce_map\n    [407 tests, 1 failure, 3.07 s]\n```",
    "created_at": "2018-01-14T13:14:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323968",
    "user": "https://github.com/vbraun"
}
```

```
git reset --hard Hsage -t --long --warn-long 69.0 src/sage/structure/parent.pyx
**********************************************************************
File "src/sage/structure/parent.pyx", line 1855, in sage.structure.parent.Parent.hom._generic_coerce_map
Failed example:
    QQ['x', 'y']._generic_coerce_map(QQ).category_for()
Expected:
    Category of unique factorization domains
Got:
    Category of infinite unique factorization domains
EAD~
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.parent.Parent.hom._generic_coerce_map
    [407 tests, 1 failure, 3.07 s]
```



---

archive/issue_comments_323969.json:
```json
{
    "body": "I cannot reproduce this locally, so we might have to wait for the next beta. The doctest failure output should be the correct output. Yet, the test after it should probably also be `Category of infinite euclidean domains`, so something subtle might be going on too...",
    "created_at": "2018-01-15T16:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323969",
    "user": "https://github.com/tscrim"
}
```

I cannot reproduce this locally, so we might have to wait for the next beta. The doctest failure output should be the correct output. Yet, the test after it should probably also be `Category of infinite euclidean domains`, so something subtle might be going on too...



---

archive/issue_comments_323970.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-19T19:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323970",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_323971.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-19T19:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323971",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_323972.json:
```json
{
    "body": "I fixed the doctest",
    "created_at": "2018-01-19T19:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323972",
    "user": "https://github.com/fchapoton"
}
```

I fixed the doctest



---

archive/issue_comments_323973.json:
```json
{
    "body": "So the failure was because of #24413, whereas the second test would need a similar treatment for power series rings. This is good enough for now.",
    "created_at": "2018-01-20T06:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323973",
    "user": "https://github.com/tscrim"
}
```

So the failure was because of #24413, whereas the second test would need a similar treatment for power series rings. This is good enough for now.



---

archive/issue_comments_323974.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-20T06:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323974",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_060182.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-01-20T20:20:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23181#event-60182"
}
```



---

archive/issue_comments_323975.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-20T20:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23181#issuecomment-323975",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
