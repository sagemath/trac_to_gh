# Issue 23181: put number fields in Fields().Infinite()

Issue created by migration from https://trac.sagemath.org/ticket/23418

Original creator: chapoton

Original creation time: 2017-07-13 07:01:58

CC:  nthiery tscrim

and the same for QQ of course


---

Comment by chapoton created at 2017-07-13 07:08:32

New commits:


---

Comment by git created at 2017-07-13 10:02:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-13 10:02:50

This triggers some problem here:

```
sage -t --long src/sage/structure/parent.pyx  # 6 doctests failed
```



---

Comment by chapoton created at 2017-07-13 11:42:54

It seems that the morphisms from Sets take over the morphisms from Rings..


---

Comment by tscrim created at 2017-08-30 21:45:08

Failures are related to this:

```
sage: x = QQ['x'].0
sage: t = abs(ZZ.random_element(10^6))
sage: K = NumberField(x^2 + 2*3*7*11, "a"+str(t))
sage: a = K.gen()

sage: Hom(K, a.matrix().parent())
Set of Morphisms from Number Field in a791947 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field in Category of infinite rings
<class 'sage.categories.homset.Homset_with_category'>
```

compared to vanilla Sage:

```
sage: Hom(K, a.matrix().parent())
Set of Homomorphisms from Number Field in a395598 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field
sage: type(Hom(K, a.matrix().parent()))
<class 'sage.rings.homset.RingHomset_generic_with_category'>
```


This differences comes from the fact that the category becomes a join category (in the branch) because that is the meet category computed by `Hom`:

```
sage: K.category()._meet_(a.matrix().parent().category())
Category of infinite rings
sage: type(_)
<class 'sage.categories.category.JoinCategory_with_category'>
```

versus vanilla:

```
sage: K.category()._meet_(a.matrix().parent().category())
Category of rings
sage: type(_)
<class 'sage.categories.rings.Rings_with_category'>
```

Now, `K` is not a subclass of the meet category's `parent_class`, which causes the `Cat.parent_class._Hom_` method to now raise an error:

```
sage: Cat = K.category()._meet_(a.matrix().parent().category())
sage: Cat.parent_class
<class 'sage.categories.category.JoinCategory.parent_class'>
sage: Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-6-aa7f8d9cdf73> in <module>()
----> 1 Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)
TypeError: unbound method _Hom_() must be called with JoinCategory.parent_class instance as first argument (got NumberField_quadratic_with_category instance instead)
```

versus vanilla

```
sage: Cat = K.category()._meet_(a.matrix().parent().category())
sage: Cat.parent_class
<class 'sage.categories.rings.Rings.parent_class'>
sage: Cat.parent_class._Hom_(K, a.matrix().parent(), Cat)
Set of Homomorphisms from Number Field in a395598 with defining polynomial x^2 + 462 to Full MatrixSpace of 2 by 2 dense matrices over Rational Field
```



---

Comment by chapoton created at 2017-09-21 09:55:16

New commits:


---

Comment by git created at 2017-09-21 09:57:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-21 11:42:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-12-31 13:19:30

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-12-31 13:19:30

New commits:


---

Comment by vdelecroix created at 2017-12-31 13:20:43

the problem from [This is the Trac macro *comment:5* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:5-macro) is solved in `d2bf048` via

```diff
--- a/src/sage/categories/homset.py
+++ b/src/sage/categories/homset.py
@@ -402,7 +402,7 @@ def Hom(X, Y, category=None, check=True):
                 #   will be called twice.
                 # - This is bound to fail if X is an extension type and
                 #   does not actually inherit from category.parent_class
-                H = category.parent_class._Hom_(X, Y, category = category)
+                H = X.category().parent_class._Hom_(X, Y, category = category)
             except (AttributeError, TypeError):
                 # By default, construct a plain homset.
                 H = Homset(X, Y, category = category, check=check)
```



---

Comment by git created at 2017-12-31 14:28:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-12-31 18:40:40

Looks good to me. Maybe Travis can confirm ?


---

Comment by tscrim created at 2017-12-31 22:49:07

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-12-31 22:49:07

No, I don't think this is correct because now it ignores the `category` input, and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`). So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is _because_ of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?


---

Comment by vdelecroix created at 2018-01-01 10:49:39

Replying to [comment:13 tscrim]:
> No, I don't think this is correct because now it ignores the `category` input

Strictly speaking it does not, since the `category` argument is passed in the call

```
H = X.category().parent_class._Hom_(X, Y, category = category)
```


> and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).

Do you have any example of this? I might understand the objection, but my "cheap fix" is indeed fixing problems and not creating new ones (as far as doctesting is complete).

> So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is _because_ of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?

As you might have noticed, the call line 405 in `categories/homset.py` is already hackish. Parents implementing their own `_Hom_` method should by themselves call a super (or equivalent). Before doing my "cheap fix", I thought that the good solution would be to remove this line 405 and fix the parents. Do you agree that this would be *the* solution?

If you agree with the above, there are two concrete ways of doing this:
- let my cheap fix pass and remove line 405 afterwards
- remove line 405 in a dependency ticket


---

Comment by tscrim created at 2018-01-02 18:10:34

Replying to [comment:14 vdelecroix]:
> Replying to [comment:13 tscrim]:
> > No, I don't think this is correct because now it ignores the `category` input
> 
> Strictly speaking it does not, since the `category` argument is passed in the call
> {{{
> H = X.category().parent_class._Hom_(X, Y, category = category)
> }}}

No, `_Hom_` ignores the category input.

> > and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).
> 
> Do you have any example of this? I might understand the objection, but my "cheap fix" is indeed fixing problems and not creating new ones (as far as doctesting is complete).

No, your hack is creating new problems. For example, suppose `X` is an algebra with:

- basis `{a, b}`,
- multiplication `a^2 = b^2 = ab = a`.

If we want to construct a map `f: X -> X` given by `a,b |-> b`. This is not an algebra morphism, but instead only a module morphism. If we have `Algebras._Hom_`, which expects the category to be algebras (as it should), then this will break horribly and there is no way to use a `Modules._Hom_` (assuming it is also implemented).

For an example where this is currently implemented, we can replace `Algebras` with `HighestWeightCrystals` and `Modules` with `Crystals`. I have also constructed similar morphisms as above for my research.

> > So this change is a regression in my mind because the Homset classes do not have the inheritance of the categories. (In fact, in some ways, the error is _because_ of this desired behavior.) Perhaps what we can do is do something special for join categories and testing its `super_categories`?
> 
> As you might have noticed, the call line 405 in `categories/homset.py` is already hackish. Parents implementing their own `_Hom_` method should by themselves call a super (or equivalent).

I am not sure this would be the same behavior. There are two different things going on:

1. If a parent does not implement a `_Hom_` method, then it should fall back to the specified category. Continuing my above example, this would only default to `Algebras._Hom_`, which would be wrong.
2. The other behavior is if the homset returned by `X._Hom_` does not support the more general category, say, because it takes advantage of the extra structure (say, is only uses the algebra generating set and not the [possibly infinite] basis). One should expect that `X.category()._Hom_` would also take advantage of that extra structure as well and would similarly forbid more general categories.

> Before doing my "cheap fix", I thought that the good solution would be to remove this line 405 and fix the parents. Do you agree that this would be *the* solution?

It doesn't make sense to me for the parent/category implementation of `_Hom_` to do super calls when something fails. I think it would create a lot of redundant logic (the error handling). Also, everything in between `X.category()` and the specified `category` would likely (needlessly) fail, making these calls significantly slower when there is a large category difference. While this is a solution, I think it is a very bad solution.

I think special handling the join categories is going to be the proper fix as join categories are somewhat special in the category framework. While it may be just fixing the symptoms, it does not have the drawbacks that the other approaches have. I will push something today.


---

Comment by vdelecroix created at 2018-01-02 20:18:14

Replying to [comment:15 tscrim]:
> Replying to [comment:14 vdelecroix]:
> > Replying to [comment:13 tscrim]:
> > > No, I don't think this is correct because now it ignores the `category` input
> > 
> > Strictly speaking it does not, since the `category` argument is passed in the call
> > {{{
> > H = X.category().parent_class._Hom_(X, Y, category = category)
> > }}}
> 
> No, `_Hom_` ignores the category input.
> 
> > > and there might be a situation where this works with `category` being passed in (say, `Modules()` instead of `Algebras()`).
> > 
> > Do you have any example of this? I might understand the objection, but my "cheap fix" is indeed fixing problems and not creating new ones (as far as doctesting is complete).
> 
> No, your hack is creating new problems. [SNIP]

This would better be doctested! Could you come up with concrete examples to be added to the branch? Especially because we are going to play with the `_Hom_` code.
 
>>> So this change is a regression [...]
> I will push something today.

Thanks! You might want to use another ticket or update the description of this one.


---

Comment by tscrim created at 2018-01-03 00:21:16

Replying to [comment:16 vdelecroix]:
> This would better be doctested! Could you come up with concrete examples to be added to the branch? Especially because we are going to play with the `_Hom_` code.

I believe I have a concrete example and will add it.

> >>> So this change is a regression [...]
> > I will push something today.
> 
> Thanks! You might want to use another ticket or update the description of this one.

No problem. Thanks for your work on this.


---

Comment by tscrim created at 2018-01-03 07:32:15

Actually, from looking at it and thinking about it more, the category of highest weight crystals is a full subcategory, so it does not quite work (in contrast to algebras and modules). So instead I just manufactured a minimal example that fails with your change.

Here is a branch that does special handling of `JoinCategory`. It passes all the tests that were previously failing.
----
New commits:


---

Comment by tscrim created at 2018-01-03 07:32:15

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-01-03 15:56:19

The following loop is randomly choosing the last working call.

```
for C in cats:
    try:
        H = C.parent_class._Hom_(X, Y, category=category)
    except (AttributeError, TypeError):
        pass
```

If you want to keep this hack, wouldn't it be better this way

```
for C in cats:
    try:
        H = C.parent_class._Hom_(X, Y, category=category)
    except (AttributeError, TypeError):
        pass
    else:
        break
```



---

Comment by git created at 2018-01-03 16:25:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-01-03 16:27:34

Good point; fixed.


---

Comment by tscrim created at 2018-01-12 18:58:33

Green bot.


---

Comment by vdelecroix created at 2018-01-12 19:17:50

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2018-01-12 19:17:50

Sorry to have forgotten!


---

Comment by vbraun created at 2018-01-14 13:14:24

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-01-14 13:14:24


```
git reset --hard Hsage -t --long --warn-long 69.0 src/sage/structure/parent.pyx
**********************************************************************
File "src/sage/structure/parent.pyx", line 1855, in sage.structure.parent.Parent.hom._generic_coerce_map
Failed example:
    QQ['x', 'y']._generic_coerce_map(QQ).category_for()
Expected:
    Category of unique factorization domains
Got:
    Category of infinite unique factorization domains
EAD~
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.parent.Parent.hom._generic_coerce_map
    [407 tests, 1 failure, 3.07 s]
```



---

Comment by tscrim created at 2018-01-15 16:23:16

I cannot reproduce this locally, so we might have to wait for the next beta. The doctest failure output should be the correct output. Yet, the test after it should probably also be `Category of infinite euclidean domains`, so something subtle might be going on too...


---

Comment by git created at 2018-01-19 19:21:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-01-19 19:21:54

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-01-19 19:21:54

I fixed the doctest


---

Comment by tscrim created at 2018-01-20 06:20:13

So the failure was because of #24413, whereas the second test would need a similar treatment for power series rings. This is good enough for now.


---

Comment by tscrim created at 2018-01-20 06:20:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-20 20:20:11

Resolution: fixed
