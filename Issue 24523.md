# Issue 24523: convert cluster interact to jupyter notebook

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2018-02-16 16:51:08

CC:  sage-combinat stumpc5 jason etn40ff

to avoid importing sagenb


---

Comment by jdemeyer created at 2018-02-16 16:54:23

What is the "cluster interact"?


---

Comment by chapoton created at 2018-02-16 17:00:11

one second, branch coming


---

Comment by chapoton created at 2018-02-16 17:00:28

and help would be welcome..
----
New commits:


---

Comment by chapoton created at 2018-02-16 17:01:08

I failed to make it work. This is related to #24595


---

Comment by jdemeyer created at 2018-02-16 19:00:18

Just a few comments:

1. Ideally, you would return the interact instead of displaying it. This means replacing ``@`interact` by ``@`interact.widget` and then returning `player`.

2. I wouldn't bother checking for Jupyter. In the worst case, you get a warning like

```
[SageTerminalApp] WARNING | Widget Javascript not detected.  It may not be installed or enabled properly.
Widget Javascript not detected.  It may not be installed or enabled properly.
```



---

Comment by git created at 2018-02-16 19:28:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-16 19:32:43

Thanks for the hints. I have changed the code accordingly.

But alas, this is still not doing what it should. Namely, I would like to use a global variable, but of course this does not make much sense..

The problem is that it must distinguish between clicks on the numbers at top (first parameter k) that means 'doing a mutation at vertex k" (changing the displayed graph) to clicks on the other checkboxes, that just mean display or not a few additional fixes, but do not perform any mutation.


---

Comment by jdemeyer created at 2018-02-16 19:51:56

Pro tip: if you are thinking about using ipywidgets interacts non-trivially, you shouldn't be using interacts.

There is a difference in philosophy between sagenb interact and ipywidgets interacts: with sagenb, the only way to do anything with widgets is to use ``@`interact`. This leads to ugly solutions such as the old code for the cluster interact (did you see how it abuses the lists `sft, sss, ssv ssm, ssl`?)

With ipywidgets on the other hand, the widgets are the basic building blocks. There is a lot of stuff you can do with widgets without using ``@`interact`. They do provide an interact function for convenience, but it's really just a wrapper over the underlying widgets. You might as well wrap the widgets yourself.

In more detail: when you add ``@`interact` to a function, it gets an attribute `.widget` which is an instance of `ipywidgets.widgets.interaction.interactive`:

```
sage: from ipywidgets import interact
sage: `@`interact
....: def f(x=0, y=True, z=range(4)): pass
[SageTerminalApp] WARNING | Widget Javascript not detected.  It may not be installed or enabled properly.
Widget Javascript not detected.  It may not be installed or enabled properly.
sage: widget = f.widget
sage: type(widget)
<class 'ipywidgets.widgets.interaction.interactive'>
```

This widget is really just a special vertical box of widgets:

```
sage: type(f.widget).__bases__
(<class 'ipywidgets.widgets.widget_box.VBox'>,)
sage: f.widget.children
(IntSlider(value=0, min=0, max=1, step=1, description=u'x'),
 Checkbox(value=True, description=u'y'),
 Dropdown(value=0, options=[0, 1, 2, 3], description=u'z'),
 Output())
```

If you would manually construct a `VBox` of those 4 widgets, you would already get the interact but without the callbacks to make it interactive and to display the output.


---

Comment by chapoton created at 2018-02-16 20:01:39

Hmm. I understand, sort of. But I am going to have a hard time if I ever try to do something like that. I guess it will require widgets-communication somewhere.


---

Comment by git created at 2018-02-16 20:40:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-16 20:41:15

ok, I made a tentative use of widgets. But this is not quite working.


---

Comment by jdemeyer created at 2018-02-17 09:11:50

I meant not using `interact` at all.


---

Comment by git created at 2018-02-17 09:13:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-17 09:13:34

Here is my latest try..


---

Comment by git created at 2018-02-17 13:59:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-17 14:00:02

Damn. This sort of works, but the output accumulates instead of being replaced..


---

Comment by git created at 2018-02-18 07:58:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-02-18 08:00:06

now works quite well, except that one cannot perform the same action twice (related to #24595)


---

Comment by git created at 2018-02-19 13:20:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-19 13:21:44

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-02-19 13:21:44

now looks good. Except that it is very easy to have repeated clicks without wanting them.


---

Comment by stumpc5 created at 2018-02-20 11:31:57

Great, thanks for making this work again! -- everything seems to work as expected.

Concerning the usage, I have two issues that I believe had worked better before:

1. currently nothing is shown when initially running `S.interact()`. The quiver and the additional info only show after the first mutation.

2. the "window" showing the buttons and the info seems to be of a fixed height, so I have to do a mutation and then scroll down inside this window as shown in https://screenshots.firefox.com/nTDuxI5z46neAILs/localhost

I cannot review the code whatsoever, but the usage is fine (and the two issues are only worth solving if they are easily fixed).


---

Comment by git created at 2018-02-20 13:18:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-20 13:19:45

This is not yet working as expected...


---

Comment by jdemeyer created at 2018-02-20 14:20:37

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-20 14:20:37

Regarding

```
        # not clear how to get the right behaviour here
        # doing both has some side effects (one click : two mutations)
        mut_buttons.on_msg(do_mutation)
        mut_buttons.observe(do_mutation, 'value')
```

is it not sufficient to keep only the `on_msg()` call?


---

Comment by chapoton created at 2018-02-20 14:24:32

With on_msg only, the button 0 seems to be always on (darker), and triggers a mutation at the previous vertex which is not 0. Like if the button 0 does not change the value, but triggers a msg.. I see really strange effects..


---

Comment by git created at 2018-02-20 14:39:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-20 16:41:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-21 13:02:17

Is the `ToggleButtons` widget broken or what ? When trying

```
n=5
widgets.ToggleButtons(options=list(range(n)),
                                            button_style='',
                                            description='Mutate at: ')
```

in my notebook (using chrome) the selection always remains on 0.

EDIT: same wrong behaviour with python2 kernel.


---

Comment by git created at 2018-02-28 15:10:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-02-28 15:52:22

I have opened an issue: https://github.com/jupyter-widgets/ipywidgets/issues/1987


---

Comment by chapoton created at 2018-02-28 18:59:27

Changing keywords from "" to "cluster".


---

Comment by git created at 2018-03-02 09:37:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-03-02 09:40:10

Jason, may you please help with the ipywidgets upstream issue ?


---

Comment by chapoton created at 2018-03-05 10:54:14

This will have to wait for ipywidgets 7.1.3, probably.


---

Comment by chapoton created at 2018-03-08 19:26:22

Now this is fully ready, but will not work perfectly until ipywidgets is updated to a version including the upstream changes.

Should we wait, give that the actual interact is currently fully broken ?


---

Comment by chapoton created at 2018-03-08 19:26:22

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-03-09 08:21:25

doctest does not pass.. sigh...


---

Comment by chapoton created at 2018-03-09 08:21:25

Changing status from needs_review to needs_work.


---

Comment by stumpc5 created at 2018-03-12 10:19:44

fyi: when clicking the "0" button, it still gets mutated at vertex "1", this might be part of the bug in the widget though.


---

Comment by stumpc5 created at 2018-03-12 10:36:24

For future work reference: this seems to work only for `ClusterQuiver` but not for `ClusterSeed` (I get an error that it works only in the notebook when doing

```
sage: Q = ClusterQuiver(['A',3])
sage: Q.interact()
```

and I also get an error if the vertex labels are "a","b","c":

```
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
/home/stumpc5/Programs/sage/local/lib/python2.7/site-packages/sage/combinat/cluster_algebra_quiver/cluster_seed.pyc in refresh(w)
   1111                 clear_output(wait=True)
   1112                 if show_lastmutation.value:
-> 1113                     self.show(fig_size=fig_size, circular=circular, mark=k)
   1114                 else:
   1115                     self.show(fig_size=fig_size, circular=circular)

/home/stumpc5/Programs/sage/local/lib/python2.7/site-packages/sage/combinat/cluster_algebra_quiver/cluster_seed.pyc in show(self, fig_size, circular, mark, save_pos, force_c, with_greens, add_labels)
   1043             quiver = self.quiver()
   1044 
-> 1045         quiver.show(fig_size=fig_size, circular=circular,mark=mark,save_pos=save_pos, greens=greens)
   1046 
   1047     def interact(self, fig_size=1, circular=True):

/home/stumpc5/Programs/sage/local/lib/python2.7/site-packages/sage/combinat/cluster_algebra_quiver/quiver.pyc in show(self, fig_size, circular, directed, mark, save_pos, greens)
    671         """
    672         n, m = self._n, self._m
--> 673         plot = self.plot( circular=circular, directed=directed, mark=mark, save_pos=save_pos, greens=greens)
    674         if circular:
    675             plot.show( figsize=[fig_size*3*(n+m)/4+1,fig_size*3*(n+m)/4+1] )

/home/stumpc5/Programs/sage/local/lib/python2.7/site-packages/sage/combinat/cluster_algebra_quiver/quiver.pyc in plot(self, circular, center, directed, mark, save_pos, greens)
    611                 partition = (nlist, mlist, [mark])
    612             else:
--> 613                 raise ValueError("The given mark is not a vertex of self.")
    614         else:
    615 

ValueError: The given mark is not a vertex of self.
```



---

Comment by git created at 2018-03-16 07:57:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-03-16 13:33:07

I have done a copy-paste for the `ClusterQuiver` interact, but removing the variables.

Clicking on 0 will work when ipywidgets is updated.

For labels, maybe this can wait. I propose to keep more enhancements for a later ticket. The really important task done here is to get rid of the import of sagenb, to move towards python3. 

EDIT: bot is morally green


---

Comment by chapoton created at 2018-03-17 15:02:56

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-19 20:18:54

Replying to [comment:42 chapoton]:
> I have done a copy-paste for the `ClusterQuiver` interact, but removing the variables.

If you need to copy/paste code, you're doing it wrong.

Why not factor this out into a subclass or separate function?

> Clicking on 0 will work when ipywidgets is updated.

Could we not backport the upstream patch?


---

Comment by jdemeyer created at 2018-03-19 20:19:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-19 20:19:33

Changing component from combinatorics to notebook.


---

Comment by jdemeyer created at 2018-03-19 20:21:13

Replying to [comment:44 jdemeyer]:
> Could we not backport the upstream patch?

Answering my own question... It's using typescript, which needs to be compiled at packaging-time (I guess), so that is not so trivial.


---

Comment by jason created at 2018-03-19 21:40:21

I'm going through ipywidgets issues today in preparation for our next release. There are a few issues I want to address, and hope to have a new release (or at least an RC) out today or tomorrow.


---

Comment by jason created at 2018-03-19 21:42:16

(Next time, feel free to ping me on an ipywidgets issue, as I see those more often than trac notifications)


---

Comment by jdemeyer created at 2018-03-20 07:04:46

Replying to [comment:47 jason]:
> There are a few issues I want to address, and hope to have a new release (or at least an RC) out today or tomorrow.

In this case, I would rather wait with this ticket until the new release.


---

Comment by jason created at 2018-03-20 07:22:04

I've created a milestone for the release: https://github.com/jupyter-widgets/ipywidgets/milestone/25

Given the number of issues to review from the work today, it may be a few more days before a release, but hopefully by the end of the week.


---

Comment by git created at 2018-03-21 16:49:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2018-03-22 17:37:37

I just recompiled your newest version and get

```
AttributeError: 'ClusterQuiver' object has no attribute 'cluster_variable'
```

so the `ClusterQuiver` interact still hopes for variables to exist...


---

Comment by git created at 2018-03-23 08:44:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by stumpc5 created at 2018-03-23 10:47:13

thanks for taking care of this!


---

Comment by chapoton created at 2018-04-01 07:28:06

I opened #25074 for the necessary upgrade of ipywidgets.


---

Comment by chapoton created at 2018-04-01 07:28:06

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-05-15 15:38:46

ipywidgets has been updated in the latest beta 8.3.b1

Can someone please re-check that this is ready to go ?


---

Comment by chapoton created at 2018-05-16 09:51:42

This now works fine for me, both for seeds and quivers. Please confirm.


---

Comment by stumpc5 created at 2018-05-16 10:53:07

I will only be able to test on Tuesday next week, but if it works for you feel free to give it set it to positive!


---

Comment by chapoton created at 2018-05-17 06:12:10

ok. I am setting to positive now.


---

Comment by chapoton created at 2018-05-17 06:12:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-18 17:50:01

Resolution: fixed
