# Issue 26699: WordMorphism should support unsortable codomain

archive/issues_026699.json:
```json
{
    "body": "CC:  vdelecroix\n\nThis breaks with #22029:\n\n```\n        return FiniteWords(sorted(codom_alphabet))\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26936\n\n",
    "created_at": "2018-12-21T15:32:49Z",
    "labels": [
        "combinatorics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "WordMorphism should support unsortable codomain",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26699",
    "user": "jdemeyer"
}
```
CC:  vdelecroix

This breaks with #22029:

```
        return FiniteWords(sorted(codom_alphabet))
```


Issue created by migration from https://trac.sagemath.org/ticket/26936





---

archive/issue_comments_375471.json:
```json
{
    "body": "This one is not trivial. Simply replacing the `sorted()` by `list()` gives a lot of doctest failures.",
    "created_at": "2018-12-22T13:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375471",
    "user": "jdemeyer"
}
```

This one is not trivial. Simply replacing the `sorted()` by `list()` gives a lot of doctest failures.



---

archive/issue_comments_375472.json:
```json
{
    "body": "Does something like this work?\n----\nNew commits:",
    "created_at": "2018-12-23T15:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375472",
    "user": "slabbe"
}
```

Does something like this work?
----
New commits:



---

archive/issue_comments_375473.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-23T15:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375473",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_375474.json:
```json
{
    "body": "I put `except TypeError` clauses if I understand #22029 correctly.",
    "created_at": "2018-12-23T15:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375474",
    "user": "slabbe"
}
```

I put `except TypeError` clauses if I understand #22029 correctly.



---

archive/issue_comments_375475.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-23T15:14:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375475",
    "user": "slabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_375476.json:
```json
{
    "body": "The problem with this `try`/`except` approach is that some methods/algorithms actually assume sorting. For example, `is_endomorphism()` will return `False` if the domain and codomain are the same, but in a different order.",
    "created_at": "2018-12-24T11:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375476",
    "user": "jdemeyer"
}
```

The problem with this `try`/`except` approach is that some methods/algorithms actually assume sorting. For example, `is_endomorphism()` will return `False` if the domain and codomain are the same, but in a different order.



---

archive/issue_comments_375477.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-12-24T11:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375477",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_375478.json:
```json
{
    "body": "For `codom_alphabet`, you need to convert to a `list` in any case.",
    "created_at": "2018-12-24T11:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375478",
    "user": "jdemeyer"
}
```

For `codom_alphabet`, you need to convert to a `list` in any case.



---

archive/issue_comments_375479.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-31T12:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375479",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375480.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-12-31T12:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375480",
    "user": "slabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_375481.json:
```json
{
    "body": "As explained in [comment:8], I still don't agree with this approach. It may be sufficient to fix existing doctests, but it doesn't address the real problem. This ticket simply replaces an obvious problem by a much more hidden problem.",
    "created_at": "2018-12-31T12:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375481",
    "user": "jdemeyer"
}
```

As explained in [comment:8], I still don't agree with this approach. It may be sufficient to fix existing doctests, but it doesn't address the real problem. This ticket simply replaces an obvious problem by a much more hidden problem.



---

archive/issue_comments_375482.json:
```json
{
    "body": "If such a problem happen, that is an alphabet with uncomparable elements, the user can define the domain and cododmain himself by doing for instance `WordMorphism(data, domain=domain, codomain=domain)`. Would you like to add such a suggestion to the user for example within the error message for `is_endomorphism`?\n\nAlso, I think the best thing we should do with the move to Python 3 is to make it so that using alphabet with uncomparable letters is not desirable anymore.",
    "created_at": "2018-12-31T14:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375482",
    "user": "slabbe"
}
```

If such a problem happen, that is an alphabet with uncomparable elements, the user can define the domain and cododmain himself by doing for instance `WordMorphism(data, domain=domain, codomain=domain)`. Would you like to add such a suggestion to the user for example within the error message for `is_endomorphism`?

Also, I think the best thing we should do with the move to Python 3 is to make it so that using alphabet with uncomparable letters is not desirable anymore.



---

archive/issue_comments_375483.json:
```json
{
    "body": "Replying to [comment:13 slabbe]:\n> Also, I think the best thing we should do with the move to Python 3 is to make it so that using alphabet with uncomparable letters is not desirable anymore.\n\nI don't really understand what you mean here.",
    "created_at": "2019-01-01T09:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375483",
    "user": "jdemeyer"
}
```

Replying to [comment:13 slabbe]:
> Also, I think the best thing we should do with the move to Python 3 is to make it so that using alphabet with uncomparable letters is not desirable anymore.

I don't really understand what you mean here.



---

archive/issue_comments_375484.json:
```json
{
    "body": "Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?",
    "created_at": "2019-01-02T16:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375484",
    "user": "jdemeyer"
}
```

Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?



---

archive/issue_comments_375485.json:
```json
{
    "body": "For reference, the failing doctests are\n\n```\nsage -t --long src/sage/combinat/words/morphism.py\n**********************************************************************\nFile \"src/sage/combinat/words/morphism.py\", line 340, in sage.combinat.words.morphism.WordMorphism.__init__\nFailed example:\n    WordMorphism({'a':['a',6,'a'],6:[6,6,6,'a']})\nException raised:\n    Traceback (most recent call last):\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.words.morphism.WordMorphism.__init__[13]>\", line 1, in <module>\n        WordMorphism({'a':['a',Integer(6),'a'],Integer(6):[Integer(6),Integer(6),Integer(6),'a']})\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py\", line 380, in __init__\n        codomain = self._build_codomain(data)\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py\", line 478, in _build_codomain\n        return FiniteWords(sorted(codom_alphabet))\n      File \"sage/rings/integer.pyx\", line 952, in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7789)\n        return coercion_model.richcmp(left, right, op)\n      File \"sage/structure/coerce.pyx\", line 1967, in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:19675)\n        raise bin_op_exception('<', x, y)\n    TypeError: unsupported operand parent(s) for <: 'Integer Ring' and '<type 'str'>'\n**********************************************************************\nFile \"src/sage/combinat/words/morphism.py\", line 1266, in sage.combinat.words.morphism.WordMorphism.image\nFailed example:\n    s = WordMorphism({0:[1,2], 'a':(2,3,4), 'z':[9,8,7]})\nException raised:\n    Traceback (most recent call last):\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.words.morphism.WordMorphism.image[4]>\", line 1, in <module>\n        s = WordMorphism({Integer(0):[Integer(1),Integer(2)], 'a':(Integer(2),Integer(3),Integer(4)), 'z':[Integer(9),Integer(8),Integer(7)]})\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py\", line 404, in __init__\n        dom_alph.sort()\n      File \"sage/rings/integer.pyx\", line 952, in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7789)\n        return coercion_model.richcmp(left, right, op)\n      File \"sage/structure/coerce.pyx\", line 1971, in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:19739)\n        raise bin_op_exception('>', x, y)\n    TypeError: unsupported operand parent(s) for >: 'Integer Ring' and '<type 'str'>'\n**********************************************************************\n```\n",
    "created_at": "2019-01-02T17:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375485",
    "user": "jdemeyer"
}
```

For reference, the failing doctests are

```
sage -t --long src/sage/combinat/words/morphism.py
**********************************************************************
File "src/sage/combinat/words/morphism.py", line 340, in sage.combinat.words.morphism.WordMorphism.__init__
Failed example:
    WordMorphism({'a':['a',6,'a'],6:[6,6,6,'a']})
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.words.morphism.WordMorphism.__init__[13]>", line 1, in <module>
        WordMorphism({'a':['a',Integer(6),'a'],Integer(6):[Integer(6),Integer(6),Integer(6),'a']})
      File "/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py", line 380, in __init__
        codomain = self._build_codomain(data)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py", line 478, in _build_codomain
        return FiniteWords(sorted(codom_alphabet))
      File "sage/rings/integer.pyx", line 952, in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7789)
        return coercion_model.richcmp(left, right, op)
      File "sage/structure/coerce.pyx", line 1967, in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:19675)
        raise bin_op_exception('<', x, y)
    TypeError: unsupported operand parent(s) for <: 'Integer Ring' and '<type 'str'>'
**********************************************************************
File "src/sage/combinat/words/morphism.py", line 1266, in sage.combinat.words.morphism.WordMorphism.image
Failed example:
    s = WordMorphism({0:[1,2], 'a':(2,3,4), 'z':[9,8,7]})
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.words.morphism.WordMorphism.image[4]>", line 1, in <module>
        s = WordMorphism({Integer(0):[Integer(1),Integer(2)], 'a':(Integer(2),Integer(3),Integer(4)), 'z':[Integer(9),Integer(8),Integer(7)]})
      File "/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py", line 404, in __init__
        dom_alph.sort()
      File "sage/rings/integer.pyx", line 952, in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7789)
        return coercion_model.richcmp(left, right, op)
      File "sage/structure/coerce.pyx", line 1971, in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:19739)
        raise bin_op_exception('>', x, y)
    TypeError: unsupported operand parent(s) for >: 'Integer Ring' and '<type 'str'>'
**********************************************************************
```




---

archive/issue_comments_375486.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-01-02T20:44:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375486",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_375487.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-01-02T22:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375487",
    "user": "slabbe"
}
```

New commits:



---

archive/issue_comments_375488.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-01-02T22:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375488",
    "user": "slabbe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_375489.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?\n\nDo you mean \"with a *sortable* alphabet\" ?\n\nI updated a branch which fixes the 2 doctests. I also updated the class documentation: INPUT block was missing, the example block of the class doc was the same as the module doc, I erased it and replaced that by examples better suited for what is seen with `WordMorphism?` showing the different way of using the inputs. I also added a note block about the sortable expectation when the domain and codomain are not explicitely given.\n\nNeeds review.",
    "created_at": "2019-01-02T22:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375489",
    "user": "slabbe"
}
```

Replying to [comment:15 jdemeyer]:
> Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?

Do you mean "with a *sortable* alphabet" ?

I updated a branch which fixes the 2 doctests. I also updated the class documentation: INPUT block was missing, the example block of the class doc was the same as the module doc, I erased it and replaced that by examples better suited for what is seen with `WordMorphism?` showing the different way of using the inputs. I also added a note block about the sortable expectation when the domain and codomain are not explicitely given.

Needs review.



---

archive/issue_comments_375490.json:
```json
{
    "body": "Replying to [comment:19 slabbe]:\n> Replying to [comment:15 jdemeyer]:\n> > Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?\n> \n> Do you mean \"with a *sortable* alphabet\" ?\n\nIf `X` is any permutation of the alphabet, then `sorted(X)` always succeeds (not raising an exception) and always returns the same thing (independent of the chosen permutation)",
    "created_at": "2019-01-03T07:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375490",
    "user": "jdemeyer"
}
```

Replying to [comment:19 slabbe]:
> Replying to [comment:15 jdemeyer]:
> > Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?
> 
> Do you mean "with a *sortable* alphabet" ?

If `X` is any permutation of the alphabet, then `sorted(X)` always succeeds (not raising an exception) and always returns the same thing (independent of the chosen permutation)



---

archive/issue_comments_375491.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-03T09:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375491",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375492.json:
```json
{
    "body": "I readded an example with a non-sortable alphabet showing how to deal with it by giving explicitely the domain and codomain.\n\nI did not check yet if it is okay with #22029.",
    "created_at": "2019-01-03T09:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375492",
    "user": "slabbe"
}
```

I readded an example with a non-sortable alphabet showing how to deal with it by giving explicitely the domain and codomain.

I did not check yet if it is okay with #22029.



---

archive/issue_comments_375493.json:
```json
{
    "body": "> I did not check yet if it is okay with #22029.\n\nIt is okay, I just checked.\n\nNeeds review.",
    "created_at": "2019-01-03T10:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375493",
    "user": "slabbe"
}
```

> I did not check yet if it is okay with #22029.

It is okay, I just checked.

Needs review.



---

archive/issue_comments_375494.json:
```json
{
    "body": "I'll merge this into the testing branch #22029 and see what the patchbot gives. Hang on...",
    "created_at": "2019-01-04T09:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375494",
    "user": "jdemeyer"
}
```

I'll merge this into the testing branch #22029 and see what the patchbot gives. Hang on...



---

archive/issue_comments_375495.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-04T18:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375495",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_375496.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375496",
    "user": "embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_375497.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-23T14:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26699",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26699#issuecomment-375497",
    "user": "vbraun"
}
```

Resolution: fixed
