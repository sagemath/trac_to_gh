# Issue 26699: WordMorphism should support unsortable codomain

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-12-21 15:32:49

CC:  vdelecroix

This breaks with #22029:

```
        return FiniteWords(sorted(codom_alphabet))
```



---

Comment by jdemeyer created at 2018-12-22 13:51:52

This one is not trivial. Simply replacing the `sorted()` by `list()` gives a lot of doctest failures.


---

Comment by slabbe created at 2018-12-23 15:05:23

Does something like this work?
----
New commits:


---

Comment by git created at 2018-12-23 15:11:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-12-23 15:12:07

I put `except TypeError` clauses if I understand #22029 correctly.


---

Comment by slabbe created at 2018-12-23 15:14:02

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-12-24 11:02:22

The problem with this `try`/`except` approach is that some methods/algorithms actually assume sorting. For example, `is_endomorphism()` will return `False` if the domain and codomain are the same, but in a different order.


---

Comment by jdemeyer created at 2018-12-24 11:04:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-12-24 11:04:06

For `codom_alphabet`, you need to convert to a `list` in any case.


---

Comment by git created at 2018-12-31 12:17:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2018-12-31 12:20:54

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-12-31 12:50:59

As explained in [comment:8], I still don't agree with this approach. It may be sufficient to fix existing doctests, but it doesn't address the real problem. This ticket simply replaces an obvious problem by a much more hidden problem.


---

Comment by slabbe created at 2018-12-31 14:28:07

If such a problem happen, that is an alphabet with uncomparable elements, the user can define the domain and cododmain himself by doing for instance `WordMorphism(data, domain=domain, codomain=domain)`. Would you like to add such a suggestion to the user for example within the error message for `is_endomorphism`?

Also, I think the best thing we should do with the move to Python 3 is to make it so that using alphabet with uncomparable letters is not desirable anymore.


---

Comment by jdemeyer created at 2019-01-01 09:27:46

Replying to [comment:13 slabbe]:
> Also, I think the best thing we should do with the move to Python 3 is to make it so that using alphabet with uncomparable letters is not desirable anymore.

I don't really understand what you mean here.


---

Comment by jdemeyer created at 2019-01-02 16:32:57

Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?


---

Comment by jdemeyer created at 2019-01-02 17:34:09

For reference, the failing doctests are

```
sage -t --long src/sage/combinat/words/morphism.py
**********************************************************************
File "src/sage/combinat/words/morphism.py", line 340, in sage.combinat.words.morphism.WordMorphism.__init__
Failed example:
    WordMorphism({'a':['a',6,'a'],6:[6,6,6,'a']})
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.words.morphism.WordMorphism.__init__[13]>", line 1, in <module>
        WordMorphism({'a':['a',Integer(6),'a'],Integer(6):[Integer(6),Integer(6),Integer(6),'a']})
      File "/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py", line 380, in __init__
        codomain = self._build_codomain(data)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py", line 478, in _build_codomain
        return FiniteWords(sorted(codom_alphabet))
      File "sage/rings/integer.pyx", line 952, in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7789)
        return coercion_model.richcmp(left, right, op)
      File "sage/structure/coerce.pyx", line 1967, in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:19675)
        raise bin_op_exception('<', x, y)
    TypeError: unsupported operand parent(s) for <: 'Integer Ring' and '<type 'str'>'
**********************************************************************
File "src/sage/combinat/words/morphism.py", line 1266, in sage.combinat.words.morphism.WordMorphism.image
Failed example:
    s = WordMorphism({0:[1,2], 'a':(2,3,4), 'z':[9,8,7]})
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.words.morphism.WordMorphism.image[4]>", line 1, in <module>
        s = WordMorphism({Integer(0):[Integer(1),Integer(2)], 'a':(Integer(2),Integer(3),Integer(4)), 'z':[Integer(9),Integer(8),Integer(7)]})
      File "/opt/sage/local/lib/python2.7/site-packages/sage/combinat/words/morphism.py", line 404, in __init__
        dom_alph.sort()
      File "sage/rings/integer.pyx", line 952, in sage.rings.integer.Integer.__richcmp__ (build/cythonized/sage/rings/integer.c:7789)
        return coercion_model.richcmp(left, right, op)
      File "sage/structure/coerce.pyx", line 1971, in sage.structure.coerce.CoercionModel_cache_maps.richcmp (build/cythonized/sage/structure/coerce.c:19739)
        raise bin_op_exception('>', x, y)
    TypeError: unsupported operand parent(s) for >: 'Integer Ring' and '<type 'str'>'
**********************************************************************
```



---

Comment by jdemeyer created at 2019-01-02 20:44:54

Changing status from needs_review to needs_info.


---

Comment by slabbe created at 2019-01-02 22:28:49

New commits:


---

Comment by slabbe created at 2019-01-02 22:34:49

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2019-01-02 22:34:49

Replying to [comment:15 jdemeyer]:
> Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?

Do you mean "with a *sortable* alphabet" ?

I updated a branch which fixes the 2 doctests. I also updated the class documentation: INPUT block was missing, the example block of the class doc was the same as the module doc, I erased it and replaced that by examples better suited for what is seen with `WordMorphism?` showing the different way of using the inputs. I also added a note block about the sortable expectation when the domain and codomain are not explicitely given.

Needs review.


---

Comment by jdemeyer created at 2019-01-03 07:22:55

Replying to [comment:19 slabbe]:
> Replying to [comment:15 jdemeyer]:
> > Maybe the simplest solution for now would be to simply document that the alphabet must be sortable, and change the doctests with a non-sortable alphabet. Do you agree?
> 
> Do you mean "with a *sortable* alphabet" ?

If `X` is any permutation of the alphabet, then `sorted(X)` always succeeds (not raising an exception) and always returns the same thing (independent of the chosen permutation)


---

Comment by git created at 2019-01-03 09:49:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2019-01-03 09:53:51

I readded an example with a non-sortable alphabet showing how to deal with it by giving explicitely the domain and codomain.

I did not check yet if it is okay with #22029.


---

Comment by slabbe created at 2019-01-03 10:01:04

> I did not check yet if it is okay with #22029.

It is okay, I just checked.

Needs review.


---

Comment by jdemeyer created at 2019-01-04 09:57:40

I'll merge this into the testing branch #22029 and see what the patchbot gives. Hang on...


---

Comment by jdemeyer created at 2019-01-04 18:30:54

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-15 18:16:10

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by vbraun created at 2019-01-23 14:17:41

Resolution: fixed
