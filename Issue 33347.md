# Issue 33347: Adapt Mathics interface to SymPy upgrade from 1.8 to 1.10 (resp.1.9)

Issue created by migration from https://trac.sagemath.org/ticket/33584

Original creator: soehms

Original creation time: 2022-03-28 16:14:41

Keywords: Mathics inteface SymPy

Since this upgrade of SymPy (especially by [this commit](https://github.com/sympy/sympy/commit/72420537f320d333b5302040adfe94f0c335af93)) the Mathics interface is broken:


```
sage: slist = [[1, 2], 3., 4 + I]
sage: mlist = mathics(slist)
sage: mlist.sage()
Traceback (most recent call last):
...
NotImplementedError: conversion to SageMath is not implemented
```


Here we implement a fix of that.


---

Comment by soehms created at 2022-03-28 16:28:18

Changing status from new to needs_review.


---

Comment by soehms created at 2022-03-28 16:28:18

No additional tests needed, since they are already there!


---

Comment by mkoeppe created at 2022-03-28 16:45:02

LGTM


---

Comment by mkoeppe created at 2022-03-28 16:45:02

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-03-28 16:45:02

Changing priority from major to critical.


---

Comment by soehms created at 2022-03-28 20:35:53

Thanks!


---

Comment by @sheerluck created at 2022-03-28 22:16:55

I use this patch

```diff
--- a/sage/interfaces/sympy.py
+++ b/sage/interfaces/sympy.py
@@ -259,6 +259,12 @@
         return SR.var(str(self))
 
 
+def _sympysage_mathics_expression(self):
+    from sage.interfaces.mathics import reduce_load
+    return [reduce_load(x)._sage_()
+            for x in self.expr.to_python()]
+
+
 def _sympysage_Subs(self):
     """
     EXAMPLES::
@@ -302,7 +308,7 @@
 
         else:
             # the function defined in sympy is not known in sage
-            raise AttributeError
+            raise AttributeError(fname)
     return func
 
 # the convoluted class structure with metaclasses and stuff sympy uses
@@ -941,6 +947,8 @@
     from sympy.polys.rootoftools import CRootOf
     from sympy.series.order import Order
     from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix
+    from mathics.core.convert import SympyExpression
+    SympyExpression._sage_ = _sympysage_mathics_expression
 
     Float._sage_ = _sympysage_float
     Integer._sage_ = _sympysage_integer
```

but I am not saying that it's correct so I couldn't show it to anybody


---

Comment by soehms created at 2022-03-29 15:20:43

Replying to [comment:5 gh-sheerluck]:
> I use this patch
> {{{#!diff
> --- a/sage/interfaces/sympy.py
> +++ b/sage/interfaces/sympy.py
> `@``@` -259,6 +259,12 `@``@`
>          return SR.var(str(self))
>  
>  
> +def _sympysage_mathics_expression(self):
> +    from sage.interfaces.mathics import reduce_load
> +    return [reduce_load(x)._sage_()
> +            for x in self.expr.to_python()]
> +
> +
>  def _sympysage_Subs(self):
>      """
>      EXAMPLES::
> `@``@` -302,7 +308,7 `@``@`
>  
>          else:
>              # the function defined in sympy is not known in sage
> -            raise AttributeError
> +            raise AttributeError(fname)
>      return func
>  
>  # the convoluted class structure with metaclasses and stuff sympy uses
> `@``@` -941,6 +947,8 `@``@`
>      from sympy.polys.rootoftools import CRootOf
>      from sympy.series.order import Order
>      from sympy.matrices import ImmutableMatrix, ImmutableSparseMatrix, Matrix, SparseMatrix
> +    from mathics.core.convert import SympyExpression
> +    SympyExpression._sage_ = _sympysage_mathics_expression
>  
>      Float._sage_ = _sympysage_float
>      Integer._sage_ = _sympysage_integer
> }}}
> but I am not saying that it's correct so I couldn't show it to anybody


I agree that this fixes the issue, as well. Probably you know better about Mathics than I do, but it seems to be more restrictive, since it converts each instance of SympyExpression to a list. Furthermore, the import statement may fail, since Mathics is an optional package. Thus, it has to be checked that the feature is present.

Anyway, you are welcome to contribute to the code. But I would prefer to do that on a separate ticket, to have the issue fixed, as soon as possible.


---

Comment by @sheerluck created at 2022-03-29 15:44:40

I agree that my patch is a dirty hack :)

I agree that proper work with SympyExpression should be on on a separate ticket.

I agree that this ticket should be merged ASAP.


---

Comment by vbraun created at 2022-04-02 10:53:28

Resolution: fixed
