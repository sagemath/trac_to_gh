# Issue 33335: sage -pytest

Issue created by migration from https://trac.sagemath.org/ticket/33572

Original creator: mkoeppe

Original creation time: 2022-03-26 18:39:31

CC:  tornaria @tobiasdiez soehms

Thin wrapper around `pytest` for running it in the Sage environment.

as suggested in #31924#comment:94


Similar to our existing wrapper `sage -tox`.





---

Comment by mkoeppe created at 2022-03-26 19:06:02

Here's an attempt at this command, but I think I'll need some help here to make it actually work:

```
$ ./sage -pytest src/sage/numerical/
============================================================================================================ test session starts ============================================================================================================
platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
collected 0 items / 5 errors                                                                                                                                                                                                                

================================================================================================================== ERRORS ===================================================================================================================
______________________________________________________________________________________ ERROR collecting sage/numerical/backends/cvxopt_backend_test.py ______________________________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/numerical/backends/cvxopt_backend_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/numerical/backends/cvxopt_backend_test.py:5: in <module>
    from sage.numerical.mip import MixedIntegerLinearProgram
sage/numerical/mip.pyx:242: in init sage.numerical.mip
    ???
sage/rings/integer_ring.pyx:1: in init sage.rings.integer_ring
    ???
sage/rings/integer.pyx:1: in init sage.rings.integer
    ???
sage/rings/rational.pyx:79: in init sage.rings.rational
    ???
E   ImportError: cannot import name ZZ
```


----
New commits:


---

Comment by @tobiasdiez created at 2022-03-27 12:05:31

That looks like a typical cyclic import that relies on `sage.all` to be broken. It is also not specific to pytest as the following example fails with the same error (when run through `./sage src/test_module_load.py`).


```
import importlib.util
spec = importlib.util.spec_from_file_location("module.name", "src/sage/numerical/backends/cvxopt_backend_test.py")
module = importlib.util.module_from_spec(spec)
spec.loader.exec_module(module)
```



---

Comment by @tobiasdiez created at 2022-03-27 12:15:33

Moreover, there are a few dozens of such import errors:

```
import importlib.util
import pathlib
for file in pathlib.Path().glob("src/sage/**/*.py"):
    try: 
        spec = importlib.util.spec_from_file_location("module.name", file)
        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
    except:
        print(file)
```



---

Comment by mkoeppe created at 2022-03-27 15:07:46

Can't you just add `import sage.all` in `conftest.py`?


---

Comment by @tobiasdiez created at 2022-03-27 15:17:54

There is already a hook which adds `sage.all`, but that one is only executed after the collection phase.


---

Comment by git created at 2022-03-27 15:42:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-27 15:43:06

Changing status from new to needs_review.


---

Comment by @tobiasdiez created at 2022-03-27 16:17:18

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-27 16:17:18

Ah that's what you had in mind. Seems to work indeed. Can you please add a comment that prevents pyright to complain about the unused import and add a link to #33580. Thanks!


---

Comment by git created at 2022-03-27 16:32:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-27 16:35:04

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-27 17:58:44

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-27 17:58:44


```
$ ./sage -pytest
========================================================================================================= test session starts ==========================================================================================================
platform linux -- Python 3.8.10, pytest-7.0.1, pluggy-1.0.0
rootdir: /workspace/sagetrac-mirror/src
collected 0 items / 1 error                                                                                                                                                                                                            

================================================================================================================ ERRORS ================================================================================================================
____________________________________________________________________________________________________ ERROR collecting test session _____________________________________________________________________________________________________
local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/IPython/conftest.py:9: in <module>
    from .testing import tools
E   ModuleNotFoundError: No module named 'workspace'
```

should probably fallback to `./sage -pytest src`


---

Comment by git created at 2022-03-27 18:20:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-27 18:20:38

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-27 19:10:33

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-03-27 19:10:33

Seems to work, thanks!


---

Comment by mkoeppe created at 2022-03-27 19:12:47

Thanks


---

Comment by @tobiasdiez created at 2022-03-29 14:34:39

merge conflict


---

Comment by @tobiasdiez created at 2022-03-29 14:34:39

Changing status from positive_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-29 14:40:52

And while you are at it, can you please move the import mode cmd flag to `addopts = --import-mode importlib` in `tox.ini`. https://docs.pytest.org/en/6.2.x/customize.html#tox-ini Thanks!


---

Comment by @tobiasdiez created at 2022-03-29 15:42:15

While playing around, I've also discovered the following error:

```
$ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py
========================================================================================================= test session starts ==========================================================================================================
platform linux -- Python 3.8.10, pytest-7.0.1, pluggy-1.0.0
rootdir: /workspace/sagetrac-mirror/src, configfile: tox.ini
collected 0 items / 1 error                                                                                                                                                                                                            

================================================================================================================ ERRORS ================================================================================================================
_______________________________________________________________________________________ ERROR collecting sage/ext_data/nbconvert/postprocess.py ________________________________________________________________________________________
src/sage/ext_data/nbconvert/postprocess.py:20: in <module>
    with open(file_name, 'r') as f:
E   FileNotFoundError: [Errno 2] No such file or directory: '--rootdir=/workspace/sagetrac-mirror/src'
======================================================================================================= short test summary info ========================================================================================================
ERROR src/sage/ext_data/nbconvert/postprocess.py - FileNotFoundError: [Errno 2] No such file or directory: '--rootdir=/workspace/sagetrac-mirror/src'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
=========================================================================================================== 1 error in 0.19s ===========================================================================================================
```

which seems to be introduced in this ticket.


---

Comment by git created at 2022-03-29 23:47:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-29 23:51:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-29 23:53:44

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-29 23:54:37

Replying to [comment:19 gh-tobiasdiez]:
> While playing around, I've also discovered the following error:
> {{{
> $ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py

This file is to be considered a data file; it's not a module of the Sage library


---

Comment by @tobiasdiez created at 2022-03-30 12:31:01

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-03-30 12:31:01

Thanks for the follow-up. However, during the merge something seems to went wrong. The collect_ignore in the test config shouldn't be readded.


---

Comment by @tobiasdiez created at 2022-03-30 12:32:57

Replying to [comment:23 mkoeppe]:
> Replying to [comment:19 gh-tobiasdiez]:
> > While playing around, I've also discovered the following error:
> > {{{
> > $ ./sage --pytest src/sage/ext_data/nbconvert/postprocess.py
> 
> This file is to be considered a data file; it's not a module of the Sage library

So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.


---

Comment by git created at 2022-03-30 16:07:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-03-30 16:08:32

Indeed. Thanks for catching the mistake in rebasing


---

Comment by mkoeppe created at 2022-03-30 16:12:27

Replying to [comment:25 gh-tobiasdiez]:
> So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.

The directories marked by the presence of a `nodoctest` file are ignored by the doctester. 

```
$ find src -name nodoctest
src/sage/ext_data/nodoctest
src/sage/doctest/tests/nodoctest
```

Not sure if we want to use this mechanism somehow or just hardcode it in `conftest.py`


---

Comment by mkoeppe created at 2022-03-30 16:12:41

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-03-30 18:33:39

Replying to [comment:28 mkoeppe]:
> Replying to [comment:25 gh-tobiasdiez]:
> > So you are saying it should be removed during collection? Then please do so by adding a filter in pytest_collect_file similar to  #33560.
> 
> The directories marked by the presence of a `nodoctest` file are ignored by the doctester. 
> {{{
> $ find src -name nodoctest
> src/sage/ext_data/nodoctest
> src/sage/doctest/tests/nodoctest
> }}}
> Not sure if we want to use this mechanism somehow or just hardcode it in `conftest.py`

I would say its simpler to exclude these two directories in conftest. As you already know, I'm not a big fan of such marker files in general.


---

Comment by mkoeppe created at 2022-03-30 18:36:27

OK, sounds good.


---

Comment by mkoeppe created at 2022-03-30 23:52:37

Given that `./sage --pytest src/sage/ext_data/nbconvert/` collects nothing, I don't think we need to do anything about `./sage --pytest src/sage/ext_data/nbconvert/postprocess.py`.


---

Comment by @tobiasdiez created at 2022-03-31 08:33:59

Why not?
It's the same issue as with `sage -t` and #33560. It works if you specify a folder and let pytest do the collection, but doesn't work correctly if you overwrite the collection by specifying the complete path.


---

Comment by mkoeppe created at 2022-03-31 14:08:35

Not the same because there is no existing practice of running pytest on that file.


---

Comment by git created at 2022-03-31 14:11:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-31 14:28:02

Replying to [comment:34 mkoeppe]:
> Not the same because there is no existing practice of running pytest on that file.

That applies to Cython files as well, or not? We still exclude them in #33560.


---

Comment by mkoeppe created at 2022-03-31 14:33:22

There is very much existing practice of running `sage -t` on Cython files.


---

Comment by mkoeppe created at 2022-04-01 16:37:37

Let's get this in please


---

Comment by @tobiasdiez created at 2022-04-01 17:00:03

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-04-01 17:00:03

Okay. I still think these folders with `nodoctest` files should be skipped; but that can be done in a follow-up ticket. (The sagebot issues don't seem to be related to this ticket.)


---

Comment by mkoeppe created at 2022-04-01 17:37:39

Thanks!


---

Comment by vbraun created at 2022-04-03 11:13:45

Resolution: fixed
