# Issue 28395: Implement Eulerian Polynomials and Numbers

archive/issues_028395.json:
```json
{
    "body": "CC:  @jplab @tscrim\n\nIn combinatorics, the Eulerian number A(n, m), is the number of permutations of the numbers 1 to n in which exactly m elements are greater than the previous element (permutations with m \"ascents\"). They are the coefficients of the Eulerian polynomials -[https://en.wikipedia.org/wiki/Eulerian_number](https://en.wikipedia.org/wiki/Eulerian_number)\n\nIt would be nice to have Eulerian polynomials and numbers available in Sage. \nTwo possible ways to do this are::\n\n```\nsage: @cached_function\n....: def eulerian_polynomial(n):\n....:     R = PolynomialRing(ZZ, 't')\n....:     if n == 0:\n....:         return R.one()\n....:     t = R.gen()\n....:     return R.sum(binomial(n,k) * eulerian_polynomial(k) * (t-1)**(n-1-k) for k in range(n))\n```\nor using another recurrence relation\n\n```\nsage: def eulerian_numbers(n):\n....:     A = zero_matrix(n+1,n+1)\n....:     A[0,0] = 1\n....:     for i in range(1,n+1):\n....:         A[i,0] = 0\n....:         A[i,1] = 1\n....:     for j in range(2,n+1):                                                      \n....:         for k in range(2,j+1):                                                  \n....:             if j == k:                                                          \n....:                 A[j,k] = 1                                                      \n....:             else:                                                               \n....:                 A[j,k] = (j-k+1)*A[j-1,k-1] +k*A[j-1,k]\n....:     return(A)\n....: \n....: def eulerian_polynomial(n):\n....:     R = PolynomialRing(ZZ, 't')\n....:     t = R.gen()\n....:     A = eulerian_numbers(n)\n....:     return(R.sum( A[n,i]*t**i for i in range(n+1)))\n```\n\nI'm not sure what the best output of the eulerian_numbers function is.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28632\n\n",
    "created_at": "2019-10-19T08:46:02Z",
    "labels": [
        "component: combinatorics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Implement Eulerian Polynomials and Numbers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28395",
    "user": "https://github.com/sophiasage"
}
```
CC:  @jplab @tscrim

In combinatorics, the Eulerian number A(n, m), is the number of permutations of the numbers 1 to n in which exactly m elements are greater than the previous element (permutations with m "ascents"). They are the coefficients of the Eulerian polynomials -[https://en.wikipedia.org/wiki/Eulerian_number](https://en.wikipedia.org/wiki/Eulerian_number)

It would be nice to have Eulerian polynomials and numbers available in Sage. 
Two possible ways to do this are::

```
sage: @cached_function
....: def eulerian_polynomial(n):
....:     R = PolynomialRing(ZZ, 't')
....:     if n == 0:
....:         return R.one()
....:     t = R.gen()
....:     return R.sum(binomial(n,k) * eulerian_polynomial(k) * (t-1)**(n-1-k) for k in range(n))
```
or using another recurrence relation

```
sage: def eulerian_numbers(n):
....:     A = zero_matrix(n+1,n+1)
....:     A[0,0] = 1
....:     for i in range(1,n+1):
....:         A[i,0] = 0
....:         A[i,1] = 1
....:     for j in range(2,n+1):                                                      
....:         for k in range(2,j+1):                                                  
....:             if j == k:                                                          
....:                 A[j,k] = 1                                                      
....:             else:                                                               
....:                 A[j,k] = (j-k+1)*A[j-1,k-1] +k*A[j-1,k]
....:     return(A)
....: 
....: def eulerian_polynomial(n):
....:     R = PolynomialRing(ZZ, 't')
....:     t = R.gen()
....:     A = eulerian_numbers(n)
....:     return(R.sum( A[n,i]*t**i for i in range(n+1)))
```

I'm not sure what the best output of the eulerian_numbers function is.


Issue created by migration from https://trac.sagemath.org/ticket/28632





---

archive/issue_comments_400613.json:
```json
{
    "body": "Looking into the source, I believe a good place to go would be in `sage.combinat.combinat`. That's where Stirling numbers and other similar sequences of numbers are.\n\nIt would be nice to have access to both the numbers and the polynomials:\n\n- `eulerian_polynomial(n)` would return the `n`-th Eulerian polynomial (recursively defined)\n- `eulerian_number(i,n)` would return the `i`-th coefficient of the `n`-th Eulerian polynomial. (or `(n,i)` whatever fits the actual conventions best).\n\nI guess both would benefit from recursive functions. I would look at Stirling numbers for inspiration.\n\nI would say that `eulerian_number` should just return an integer. It is then easy to create array if one want...\n\n```\nsage: [eulerian_number(i,5) for i in range(6)]\n```\n\nfor example.",
    "created_at": "2019-10-19T10:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400613",
    "user": "https://github.com/jplab"
}
```

Looking into the source, I believe a good place to go would be in `sage.combinat.combinat`. That's where Stirling numbers and other similar sequences of numbers are.

It would be nice to have access to both the numbers and the polynomials:

- `eulerian_polynomial(n)` would return the `n`-th Eulerian polynomial (recursively defined)
- `eulerian_number(i,n)` would return the `i`-th coefficient of the `n`-th Eulerian polynomial. (or `(n,i)` whatever fits the actual conventions best).

I guess both would benefit from recursive functions. I would look at Stirling numbers for inspiration.

I would say that `eulerian_number` should just return an integer. It is then easy to create array if one want...

```
sage: [eulerian_number(i,5) for i in range(6)]
```

for example.



---

archive/issue_comments_400614.json:
```json
{
    "body": "see #22313 for something else, that could be confused with the present ticket",
    "created_at": "2019-11-26T12:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400614",
    "user": "https://github.com/fchapoton"
}
```

see #22313 for something else, that could be confused with the present ticket



---

archive/issue_comments_400615.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-05T13:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400615",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_400616.json:
```json
{
    "body": "Here is a proposal, with the Narayana numbers as a bonus\n\n---\nNew commits:",
    "created_at": "2019-12-05T13:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400616",
    "user": "https://github.com/fchapoton"
}
```

Here is a proposal, with the Narayana numbers as a bonus

---
New commits:



---

archive/issue_comments_400617.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-05T19:59:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400617",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_400618.json:
```json
{
    "body": "+1 for also adding the Narayama numbers.\n\nHave you run some tests of the different implementations to see which one is faster? I am a little worried about that derivative and the products being slow compared to one multiplication in the proposed first implementation above (after expanding `(t-1)**(n-1-k)` within the code). Granted, this will likely not need to be such a speed critical implementation, so we shouldn't spend too much time on this. However, I think we should at least take a moment to look at it. (Since it is a univariate polynomial ring, we might also be faster at creating things by passing a list of coefficients.)\n\nAlso, we might want to consider using the implementation of the closed formula for the Eulerian numbers and a separate algorithm for the polynomial using them as that would be much better in terms of memory usage (and possibly creation time) when starting from large `n`.",
    "created_at": "2019-12-05T22:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400618",
    "user": "https://github.com/tscrim"
}
```

+1 for also adding the Narayama numbers.

Have you run some tests of the different implementations to see which one is faster? I am a little worried about that derivative and the products being slow compared to one multiplication in the proposed first implementation above (after expanding `(t-1)**(n-1-k)` within the code). Granted, this will likely not need to be such a speed critical implementation, so we shouldn't spend too much time on this. However, I think we should at least take a moment to look at it. (Since it is a univariate polynomial ring, we might also be faster at creating things by passing a list of coefficients.)

Also, we might want to consider using the implementation of the closed formula for the Eulerian numbers and a separate algorithm for the polynomial using them as that would be much better in terms of memory usage (and possibly creation time) when starting from large `n`.



---

archive/issue_comments_400619.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-06T09:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400619",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_400620.json:
```json
{
    "body": "I have added a recursive computation for single coefficients. Maybe one could also have the direct formula for the coefficients.\n\nThe other recurrence for the polynomials seems to be wrong, unless I missed something.\n\n**EDIT**: maybe speed is not the first concern here..",
    "created_at": "2019-12-06T10:02:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400620",
    "user": "https://github.com/fchapoton"
}
```

I have added a recursive computation for single coefficients. Maybe one could also have the direct formula for the coefficients.

The other recurrence for the polynomials seems to be wrong, unless I missed something.

**EDIT**: maybe speed is not the first concern here..



---

archive/issue_comments_400621.json:
```json
{
    "body": "Replying to [comment:7 chapoton]:\n> I have added a recursive computation for single coefficients. Maybe one could also have the direct formula for the coefficients.\n\n\nThis is on the wikipedia page as an alternating sum of binomials.\n\n> The other recurrence for the polynomials seems to be wrong, unless I missed something.\n\n\nIt seems to agree with the Wikipedia page, so if it is wrong, then Wikipedia is also wrong here. (Which is always possible.) Unfortunately it sounds like we need to check to see which parts of the page are correct. `:/` I can do this tomorrow.\n\n> **EDIT**: maybe speed is not the first concern here..\n\n\nAgreed, but I was hoping it would be a simple thing to check/implement (at most an hour). I can do this in more detail tomorrow once I get back. (I am finishing up a conference this week.)",
    "created_at": "2019-12-06T21:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400621",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:7 chapoton]:
> I have added a recursive computation for single coefficients. Maybe one could also have the direct formula for the coefficients.


This is on the wikipedia page as an alternating sum of binomials.

> The other recurrence for the polynomials seems to be wrong, unless I missed something.


It seems to agree with the Wikipedia page, so if it is wrong, then Wikipedia is also wrong here. (Which is always possible.) Unfortunately it sounds like we need to check to see which parts of the page are correct. `:/` I can do this tomorrow.

> **EDIT**: maybe speed is not the first concern here..


Agreed, but I was hoping it would be a simple thing to check/implement (at most an hour). I can do this in more detail tomorrow once I get back. (I am finishing up a conference this week.)



---

archive/issue_comments_400622.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-07T10:38:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400622",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_400623.json:
```json
{
    "body": "i have added the alternative algo for Eulerian numbers\n\n---\nNew commits:\n|                                                                                                                                          |                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[cd01ead](https://git.sagemath.org/sage.git/commit?id=cd01eadda35829610e2287bc296c788af2868a34)|`trac 28632 alternative algo for eulerian numbers`|\n---\nNew commits:",
    "created_at": "2019-12-07T10:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400623",
    "user": "https://github.com/fchapoton"
}
```

i have added the alternative algo for Eulerian numbers

---
New commits:
|                                                                                                                                          |                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[cd01ead](https://git.sagemath.org/sage.git/commit?id=cd01eadda35829610e2287bc296c788af2868a34)|`trac 28632 alternative algo for eulerian numbers`|
---
New commits:



---

archive/issue_comments_400624.json:
```json
{
    "body": "Thank you.\n\nI think it would be better for the cache key not to depend on the algorithm, so\n\n```python\n@cached_function(key=lambda n,k,a: (n,k))\ndef eulerian_number(n, k, algorithm='recursive'):\n```\nand similarly for the polynomial (although this will mean you need a new test case for the `\"coeffs\"` algorithm). Also, I think the `\"coeffs\"` should not use the recursive algorithm for the Eulerian numbers.",
    "created_at": "2019-12-08T09:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400624",
    "user": "https://github.com/tscrim"
}
```

Thank you.

I think it would be better for the cache key not to depend on the algorithm, so

```python
@cached_function(key=lambda n,k,a: (n,k))
def eulerian_number(n, k, algorithm='recursive'):
```
and similarly for the polynomial (although this will mean you need a new test case for the `"coeffs"` algorithm). Also, I think the `"coeffs"` should not use the recursive algorithm for the Eulerian numbers.



---

archive/issue_comments_400625.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-08T12:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_400626.json:
```json
{
    "body": "ok, thx. All done.\n\nI also replaced one doctest for Catalan by a faster one.",
    "created_at": "2019-12-08T12:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400626",
    "user": "https://github.com/fchapoton"
}
```

ok, thx. All done.

I also replaced one doctest for Catalan by a faster one.



---

archive/issue_comments_400627.json:
```json
{
    "body": "One last little doc tweak. If that is good, then positive review.\n\n---\nNew commits:",
    "created_at": "2019-12-09T02:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400627",
    "user": "https://github.com/tscrim"
}
```

One last little doc tweak. If that is good, then positive review.

---
New commits:



---

archive/issue_comments_400628.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-09T07:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400628",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_400629.json:
```json
{
    "body": "ok, indeed, I forgot that. Thx. Setting to positive",
    "created_at": "2019-12-09T07:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400629",
    "user": "https://github.com/fchapoton"
}
```

ok, indeed, I forgot that. Thx. Setting to positive



---

archive/issue_events_072081.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-12-11T21:46:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28395#event-72081"
}
```



---

archive/issue_comments_400630.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-11T21:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28395#issuecomment-400630",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
