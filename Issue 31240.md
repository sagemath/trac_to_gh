# Issue 31240: Error in pynac's numeric::gcd method

archive/issues_031240.json:
```json
{
    "body": "Keywords: gcd, pynac\n\nFunctions in pynac expect the `gcd` of two rational numbers `p` and `q` to be the largest number `d`, such that `p/d` and `q/d` are integers (except that `gcd(0,0) = 0`). But pynac's `numeric::gcd` method says that `gcd(p,1) = 1` for all `p`, which does not have to be true when `p` is not an integer.\n\nRelated ticket: #24880\n\nIssue created by migration from https://trac.sagemath.org/ticket/31477\n\n",
    "created_at": "2021-03-10T06:19:09Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Error in pynac's numeric::gcd method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31240",
    "user": "@DaveWitteMorris"
}
```
Keywords: gcd, pynac

Functions in pynac expect the `gcd` of two rational numbers `p` and `q` to be the largest number `d`, such that `p/d` and `q/d` are integers (except that `gcd(0,0) = 0`). But pynac's `numeric::gcd` method says that `gcd(p,1) = 1` for all `p`, which does not have to be true when `p` is not an integer.

Related ticket: #24880

Issue created by migration from https://trac.sagemath.org/ticket/31477





---

archive/issue_comments_446524.json:
```json
{
    "body": "This is part of metaticket #31478.\n----\nNew commits:",
    "created_at": "2021-03-10T06:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446524",
    "user": "@DaveWitteMorris"
}
```

This is part of metaticket #31478.
----
New commits:



---

archive/issue_comments_446525.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-10T06:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446525",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_446526.json:
```json
{
    "body": "Wouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?",
    "created_at": "2021-04-19T00:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446526",
    "user": "tscrim"
}
```

Wouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?



---

archive/issue_comments_446527.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446527",
    "user": "mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_446528.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-28T04:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446528",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_446529.json:
```json
{
    "body": "Replying to [comment:3 tscrim]:\n> Wouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?\n\nThat seems reasonable, but needs some thought, because it will change the value of the function in some cases. Without the change you suggest, I think `1.gcd(b)` will return `1` whenever `b` is a `PyObject` (such as a complex number), even if the denominator of `b` is not `1` (for example, if `b` is a rational multiple of `I`). \n\nI think your change is probably correct (so the rest of the `numeric::gcd` code should be modified to match this), but this should be verified by looking at the uses of the `gcd` function to see what behaviour is expected.\n\nRelated ticket: #31884.\n\nPS. Once the correct behaviour has been implemented, the description of the `gcd(const numeric &a, const numeric &b)` function (in this same file) should be corrected. It currently says \"return  The GCD of two numbers if both are integer, a numerical 1 if they are not.\"",
    "created_at": "2021-06-28T04:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446529",
    "user": "@DaveWitteMorris"
}
```

Replying to [comment:3 tscrim]:
> Wouldn't it make sense to check that if `a.is_one()` you return the denominator of `b` (and vice versa) so you don't completely loose the special case optimizations?

That seems reasonable, but needs some thought, because it will change the value of the function in some cases. Without the change you suggest, I think `1.gcd(b)` will return `1` whenever `b` is a `PyObject` (such as a complex number), even if the denominator of `b` is not `1` (for example, if `b` is a rational multiple of `I`). 

I think your change is probably correct (so the rest of the `numeric::gcd` code should be modified to match this), but this should be verified by looking at the uses of the `gcd` function to see what behaviour is expected.

Related ticket: #31884.

PS. Once the correct behaviour has been implemented, the description of the `gcd(const numeric &a, const numeric &b)` function (in this same file) should be corrected. It currently says "return  The GCD of two numbers if both are integer, a numerical 1 if they are not."



---

archive/issue_comments_446530.json:
```json
{
    "body": "With #32386, the new patch can just be applied to the merged-in sources",
    "created_at": "2021-08-16T22:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446530",
    "user": "mkoeppe"
}
```

With #32386, the new patch can just be applied to the merged-in sources



---

archive/issue_comments_446531.json:
```json
{
    "body": "... by doing `(cd src/sage/symbolic && patch -p1) < build/pkgs/pynac/patches/gcd1.patch`",
    "created_at": "2021-09-04T01:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446531",
    "user": "mkoeppe"
}
```

... by doing `(cd src/sage/symbolic && patch -p1) < build/pkgs/pynac/patches/gcd1.patch`



---

archive/issue_comments_446532.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-09-26T17:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446532",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_446533.json:
```json
{
    "body": "9.5.beta2 has merged #32386, so I have applied your patch as indicated in comment:8",
    "created_at": "2021-09-26T17:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31240#issuecomment-446533",
    "user": "mkoeppe"
}
```

9.5.beta2 has merged #32386, so I have applied your patch as indicated in comment:8
