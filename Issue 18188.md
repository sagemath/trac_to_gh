# Issue 18188: new-style Nauty package

Issue created by migration from https://trac.sagemath.org/ticket/18425

Original creator: ncohen

Original creation time: 2015-05-15 09:12:46

CC:  tmonteil vdelecroix dcoudert azi borassi

This branch creates a new-style nauty package from the latest spkg. The code is also updated to the latest release.

Nathann

http://www.steinertriples.fr/ncohen/tmp/nauty-25r9.tar.bz2


---

Comment by ncohen created at 2015-05-15 09:13:16

New commits:


---

Comment by ncohen created at 2015-05-15 09:13:16

Changing status from new to needs_review.


---

Comment by tmonteil created at 2015-05-15 16:01:04

I would prefer us to ship the unmodified upstream tarball which can be found at http://cs.anu.edu.au/~bdm/nauty/nauty25r9.tar.gz since the gain in the recompression is less than 100K, see for example #17529. I will upload a patch while ptestlong is finishing.


---

Comment by git created at 2015-05-15 21:23:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-05-15 21:29:29

I modified the install script to allow building with an unmodified tarball. Also, the `# optional - nauty` flag should be applied on a whole doctest, to allow `sage -t --optional=nauty` work (my computer is currently very slow hence i can not run with `sage -t --optional=sage,nauty` right now, only test nauty-specific doctests).

Tell if it is OK like that.


---

Comment by git created at 2015-05-15 21:46:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2015-05-15 21:56:03

According to the mercurial history of `nauty-25.spkg`, the "patch" (actually a file to overwrite the existing one) `gtools-h.in` was introduced in 2010 for version 2.4 of nauty in order "to compile on Ubuntu and other systems". Inbetween, the file `gtools-h.in` has evolved, so keeping it does not let us benefit from the evolution, hence i propose to simply remove it and test to see if some problem appears on some machines.

Note that nauty builds and passes tests without the patch.


---

Comment by git created at 2015-05-15 22:51:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-05-16 09:46:44

I disagree with the change you made to keep the original tarball. I initially did the same, then decided against it when I noticed the directory name problem that you avoided with:

```
+NAUTY_VERSION="$(cat ${SAGE_ROOT}/build/pkgs/nauty/package-version.txt)"
+SRC="nauty${NAUTY_VERSION}"
```


I do not think that it is a good idea to do this, as we could very well imagine that other scripts be written that apply to the packages, and those would expect a correctly named package.

Furthermore, I consider it very bad manners to go on somebody else's ticket, change the branch name and change the commits without even getting the ticket's author's agreement. Please do not do this again.

I set the ticket to its original content. If you have requests to make as a reviewer, please do.

Nathann


---

Comment by tmonteil created at 2015-05-16 10:44:43

Replying to [comment:9 ncohen]:
> Furthermore, I consider it very bad manners to go on somebody else's ticket, change the branch name and change the commits without even getting the ticket's author's agreement.

What does "Tell if it is OK like that." mean ?

I don't understand your point at all. I did not remove your branch, i just propose some modifications for discussion. I guess in that case it is easier to propose changes that people could download to test (e.g. does nauty still work without the old patch), than asking the author of the previous commits to remove the patch themselves so that i can download their changes to see what happens. Same with requesting a spkg-check, then have to inspect it to filnally request some output parsing because it may fail silently if coded as the other similar files.

I understand that trac `Branch` field is not well designed since it does not allow to show various branches, but i do not see what can i do else than `git trac push` to show the proposed modifications on the ticket.

More generally, i do not understand why the people that opens a ticket owns it, Sage is a common goods that people try to improve collectively, not a staked territory. If you want to own a ticket, please write it explicitely by fillind the related field, i will not bother you on those.


---

Comment by ncohen created at 2015-05-16 10:53:47

> I don't understand your point at all.

If you want to propose a commit as a reviewer, please push them on a new branch. Add a comment to tell the other guy what you did and where to find the branch, and that he can add them to the ticket's branch if he agrees.

> More generally, i do not understand why the people that opens a ticket owns it,

Just picture several guys talking around a table. Guy '1' has an idea, and begins to explain it. Midway, you tell him to shut up and you explain to the others what you think that his idea is. That's how I see it.

> If you want to own a ticket, please write it explicitely by fillind the related field, i will not bother you on those.

I did. The branch is named `u/ncohen/18425`, to which you have no write access. When I create branches to which anybody is welcome to contribute (e.g. reorganization of the doc, which cover all domains at once), I use a branch named `public/something`.

Nathann


---

Comment by fbissey created at 2015-05-16 20:25:35

Can someone explain to me why all the installed programs have been prefixed with `nauty-`. What's the big idea? Does it clash with something? If you cannot justify it, I will remove it and patch every place that call a `nauty-*` program (and I already know where those are) as a review.


---

Comment by ncohen created at 2015-05-16 20:27:36

probably because the executables' names are not very meaningful if you don't know that they are nauty routines? I don't see any objection to the removal of that 'nauty-' in front of them, but then they should probably be in a nauty subfolder.

Nathann


---

Comment by fbissey created at 2015-05-16 20:37:47

Very little is meaningful if you don't know what it is in advance on a unix system. I don't see why `nauty` routines should have a special treatment.


---

Comment by ncohen created at 2015-05-16 20:40:49

> Very little is meaningful if you don't know what it is in advance on a unix system. I don't see why `nauty` routines should have a special treatment. 

Sooo... your goal is to lose information for the sake of consistency?


---

Comment by fbissey created at 2015-05-16 20:59:38

There are two points:
 1) if you would like the shipped binaries to be prefixed like other nice software like sage, complain upstream
 2) if the information you are worried about is the content of the nauty package, its binaries in particular, that's a defect of the sage packaging system that it doesn't have a database of the files installed by its various packages. This is a more advanced feature that has always been out of scope.

And about consistency, it is actually a good thing. Suppose that someone has some program or script that uses `nauty` and wants to use them in sage. I think they will be surprised when their scripts/programs don't work out of the box after installing sage's nauty package. It may actually take them time to figure out that they have to prefix everything.

Adding a prefix specifically in sage goes against the principle of least surprise because you modify what is expected from upstream. The only case where it is justified is a clash in name (in which case it is proper to involve both upstreams if possible).


---

Comment by fbissey created at 2015-05-16 22:12:46

And unfortunately for my last argument because `nauty` has been in sage prefixed for so long, we may have old user expecting it prefixed. So now we need to have both prefixed and non prefixed binaries. At the minimum the prefixed one should link to the non-prefixed ones. Better would be to have the prefixed one link to a wrapper that would execute the appropriate binary and output a deprecation message. But we shouldn't use prefixed version in sage in the future.


---

Comment by ncohen created at 2015-05-17 06:23:52

I still believe that a nauty/ folder would respect the original filenames wihout being less informative. If you must do these changes, however, please open a ticket depending on this one.

I only want to make nauty a new-style package because Thierry needed one.

Nathann


---

Comment by fbissey created at 2015-05-17 06:39:26

I accept to do it in a separate ticket once this is one done.


---

Comment by jdemeyer created at 2015-05-18 07:11:52

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-18 07:11:52

Use `patch` to patch packages instead of copying files.


---

Comment by jdemeyer created at 2015-05-18 07:13:39

Also, the license should be clarified: it's not just a military restriction:

```
*   Nauty is copyright (1984-2013) Brendan McKay.  All rights reserved.      *
*   Permission 
*   is hereby given for use and/or distribution with the exception of        *
*   sale for profit or application with nontrivial military significance.    *
*   You must not remove this copyright notice, and you must document any     *
*   changes that you make to this program.                                   *
*   This software is subject to this copyright only, irrespective of         *
*   any copyright attached to any package of which this is a part.           *
*                                                                            *
*   This program is only provided "as is".  No responsibility will be taken  *
*   by the author, his employer or his pet rabbit* for any misfortune which  *
*   befalls you because of its use.  I don't think it will delete all your   *
*   files, burn down your computer room or turn your children against you,   *
*   but if it does: stiff cheddar.  On the other hand, I very much welcome   *
*   bug reports, or at least I would if there were any bugs.                 *
*                                                       * RIP, 1989          *
*   Traces is copyright Adolfo Piperno (2011-).                              *
```



---

Comment by jdemeyer created at 2015-05-18 07:14:26

Use `$MAKE` instead of `make`.


---

Comment by jdemeyer created at 2015-05-18 07:15:25

I also agree that the prefixing is bad: just install stuff as-is in `$SAGE_LOCAL/bin`.


---

Comment by jdemeyer created at 2015-05-18 07:16:13

Then a final minor thing: it's best if you use indents of 4 spaces also in shell scripts.


---

Comment by git created at 2015-05-18 12:21:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-05-18 12:27:09

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-05-18 12:27:09

I added a commit that updates the "license" section of `SPKG.txt` in a more faithful way.

This being said, I opened this ticket to turn the old spkg into a new-style package, and this is what it does: nothing more. If you have style issues related to tabulations, `$MAKE` instead of `make` or the name of packages I obviously cannot blame you, but please do not abuse your position as a reviewer to make me implement them for you.

This ticket addresses and problem and fixes it. If you see something wrong which I did not introduce, add a commit or open a ticket.

Nathann


---

Comment by jdemeyer created at 2015-05-18 12:59:53

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2015-05-18 12:59:53

These two statements are inconsistent:

> I opened this ticket to turn the old spkg into a new-style package, and this is what it does: nothing more.

> The code is also updated to the latest release.

Now which one is true? (if the second is true, I certainly have some right to complain about `spkg-install`, especially the patching)


---

Comment by ncohen created at 2015-05-18 13:11:30

> Now which one is true?

The tarball contains the latest release. That does not involve anything related to the branch. The patching is what the current spkg does.

> (if the second is true, I certainly have some right to complain about `spkg-install`, especially the patching)

You certainly have the right to complain. You can also add a commit if that bothers you.

Nathann


---

Comment by ncohen created at 2015-05-18 13:11:36

Changing status from needs_info to needs_review.


---

Comment by tmonteil created at 2015-05-18 17:16:03

Replying to [comment:11 ncohen]:
> > I don't understand your point at all.
> 
> If you want to propose a commit as a reviewer, please push them on a new branch.

This is precisely what i did, i created `u/tmonteil/18425`. I did not touch the branch `u/ncohen/18425`, it is still here, unmodified.

> Add a comment to tell the other guy what you did and where to find the branch, and that he can add them to the ticket's branch if he agrees.

Again, which word didn't you understand in "Tell if it is OK like that." ?

I still do not get your point about detached branches, there is zero benefits from detached branches over attached ones provided by `git trac push`. The `git trac push` command pushes the branch to git and let trac know about this, this is why both git and trac are on the same host, so that there is an additional information that links a branch to a particular ticket. The branch `u/tmonteil/18425` is about this ticket, so `git trac push` let trac know about it. In particular, the commits and their description will appear on the trac ticket as cliquable links so that people regisered on the ticket will know about it, and anyone can easily browse them. Please read http://doc.sagemath.org/html/en/developer/git_trac.html

> > More generally, i do not understand why the people that opens a ticket owns it,
> 
> Just picture several guys talking around a table. Guy '1' has an idea, and begins to explain it. Midway, you tell him to shut up and you explain to the others what you think that his idea is. That's how I see it.


I am very sorry about your interpretation, here is how things happened actually:

- we were discussing the opportunity to remove the old-stlye bitrotting spkgs, and the difficulty to know which of them could be safely removed, and i was mentioning that nauty was the only one that i still use to build Sage Debian Live,
- you asked me to send you nauty-25.spkg because you could not find it elsewhere,
- i looked for it, and find it on the remote server that was used to build SDL and sent you the file,
- you copy/paste its content into a commit on this ticket without looking further, set the ticket to needs_review and added myself and four other people in CC.

So, what picture talking around a table should i interpret with what happened ?

1. you put a raw copy of an old unmaintained spkg on the git to move the process from discussion to action, and added all of us in CC so that we could work together on the migration, since Sage has some coding standards that were not satisfied by the bitrotting sage-25.spkg.

2. you did not read the developer manual and are not able to write packages stasfying medium standards, you do not care if custom files coming from an older version of the package (2.4) overwrite the newer ones, you do not care to implement self-tests while they exist, you consider the raw copy/paste as a perfectly valid commit ready for review.

3. you knows all those standards very well, but prefers the other to do all the checks during the review, but at the same time require them not to implement the changes on the ticket, but on an hidden branch.

I am very sorry that i interpreted what happened in the first constructive collective way and could not even think of some other possibilities, i will be far more careful next time and think that 2. or 3. could happen, but then my comment would have been "please do not waste reviewer's time by letting far-below-standards packaging into needs_rewiew". Or perhaps should i open a new ticket with the same purpose and a cleaner package so that the territories are respected ?


---

Comment by ncohen created at 2015-05-18 17:23:16

Okay guys. This ticket is yours, I am out. I just wanted to help, but this is getting very out-of-hands for an initially straightforward change.

Nathann


---

Comment by ncohen created at 2015-05-18 17:23:16

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2015-05-19 02:50:20

OK, Nathann took his marbles (literally) and walked away. While the package obviously needed some love I was partisan not to alienate him. But never mind I will re-start off from Thierry's branch.


---

Comment by fbissey created at 2015-05-19 04:58:19

New branch but same tarball. Upstream tarball unfortunately has the bad taste of not having a `-` between the name and the version number which confuses `sage-fix-pkg-cheksums`. So I used the repackaged tarball. I am quite open to improvement in this area. I used `$MAKE` and removed the prefix from the binaries. Inserted a few comments in `spkg-install` and checked it passed its own tests.
----
New commits:


---

Comment by fbissey created at 2015-05-19 04:58:19

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2015-05-19 08:46:46

Changing status from needs_review to needs_work.


---

Comment by tmonteil created at 2015-05-19 08:46:46

I don't know how you did to import my branch (e.g. `self-check`), but you forgot commit `e23db009d555c3cb3019e560ccd67bc4f5dd32de` that adds a missing `# optional - nauty` so that we can do `sage -t --optional=nauty`.

Concerning upstream tarball, the less we touch upstream source, the best it is. Here, we have the possibility to keep it intact (as done in `247b6a6d17aa9db788e73ab27f5966f3c08e0666`). It is much less intrusive to just rename `nauty25r9.tar.gz` into `nauty-25r9.tar.gz` (the file itself is untouched and we get the same hash than upstream) than to unpack it, change internal directory, and recompress it (which should require an additional `spkg-src`). See http://doc.sagemath.org/html/en/developer/packaging.html#modified-tarballs


---

Comment by jdemeyer created at 2015-05-19 08:48:46

Replying to [comment:34 tmonteil]:
> so that we can do `sage -t --optional=nauty`.

Why would you want to do that? I disagree with adding `# optional` tags unless strictly required.


---

Comment by jdemeyer created at 2015-05-19 08:52:42

Replying to [comment:33 fbissey]:
> I used `$MAKE`
You should do this also in `spkg-check`.


---

Comment by fbissey created at 2015-05-19 08:55:08

You are right about the re-packing. It would need a spkg-src, a renaming probably can just be a mention in `SPKG.txt`.

I cannot believe I left a `make` out there. I guess I was annoyed by something else will I was finishing the branch.


---

Comment by jdemeyer created at 2015-05-19 09:00:49

Shell tip: instead of running `runalltests` and parsing the output, you can instead `source ./runalltests` and just read the variable `$fails`.


---

Comment by jdemeyer created at 2015-05-19 09:01:40

And in `spkg-check`, this can be removed:

```
echo "Tests suite for nauty passed without errors."
exit 0
```



---

Comment by jdemeyer created at 2015-05-19 09:05:40

For installing, I would use `cp -p` instead of plain `cp`.


---

Comment by fbissey created at 2015-05-19 09:16:55

`@`tmontiel I did some copying to rebase stuff on top of 6.7 quick and dirty and I completely missed that you touched other files. I am not quite sure how to see the details of that commit from the command line.

`@`jeroen I'll have a quick look to see if I can add an install target, that would care of the permissions.


---

Comment by jdemeyer created at 2015-05-19 09:17:16

That's all my comments for now. If you make the edits, I will do a final review.

And I don't care much about renaming/repacking/changing the tarball, just document what you did.


---

Comment by jdemeyer created at 2015-05-19 09:18:16

Replying to [comment:41 fbissey]:
> `@`jeroen I'll have a quick look to see if I can add an install target, that would care of the permissions.

I don't think that's needed, just copying with `cp -p` in `spkg-install` should work.


---

Comment by fbissey created at 2015-05-19 09:18:30

And should I do something to put it in conformance with #18431?


---

Comment by jdemeyer created at 2015-05-19 09:21:41

Replying to [comment:44 fbissey]:
> And should I do something to put it in conformance with #18431?
Ah yes, I think you need to add a file `build/pkgs/nauty/type` containing `optional` (although this might not be strictly required)


---

Comment by git created at 2015-05-19 09:54:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-05-19 09:59:13

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-19 10:11:24

Replace the arcane `cd $SRC` stuff by a much simpler `cd nauty*`.

And `$SAGE_LOCAL` -> `"$SAGE_LOCAL"` in shell scripts.


---

Comment by jdemeyer created at 2015-05-19 10:14:39

And obviously, this comment needs updating:

```
# Unfortunately, runalltests script does not exit with a nonzero status if some
# tests failed, so we parse the last line of the log to decide whether all
# tests passed or not, in order to exit with the correct status.
```



---

Comment by jdemeyer created at 2015-05-19 10:18:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-19 10:22:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-19 10:23:11

Replying to [comment:51 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[032648d](http://git.sagemath.org/sage.git/commit/?id=032648d0008a1f81181f9c5900e4e546a1f83a95)||`Further simplification and sliming`||

sliming???


---

Comment by git created at 2015-05-19 10:26:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-05-19 10:31:46

I'd say that was too much sliming :) - OK I'll remember that should be slimming for next time (may be, I have always been terrible at spelling).

I didn't know you could do the `cd nauty*` thing.
----
New commits:


---

Comment by fbissey created at 2015-05-19 10:31:46

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-19 11:57:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-19 22:07:27

Resolution: fixed
