# Issue 15768: Waste of time in iterator_edges 2

Issue created by migration from https://trac.sagemath.org/ticket/16005

Original creator: ncohen

Original creation time: 2014-03-24 13:48:45

CC:  azi mmezzarobba

As reported by Marc in #15978, `iterator_edges` wastes a lot of time. Computationally, returning all edges of a graph currently works this way:


```
for each edge E of the graph: # Okay, linear time
    <Something equivalent to checking that E is an edge> # Totally useless
    return E

```


This can be solved by creating a function that is somehow between 
- Returning all neighbors of a vertex (which is not sufficient to find the edges incident to this vertex)
- Work directly with the data structure, i.e. a binary tree

This function is named `out_neighbors_BTNode_unsafe` and does what some part of the code already did, before throwing the information away. It builds the list of `BTNodes` describing the [neighbors of/edges incident to] a vertex, from which all that we need can be deduced.

As a result, the useless computations reported above can be removed.

Nathann


---

Comment by ncohen created at 2014-03-24 14:10:47

Getting better ...


```
sage: %time _=g.to_dictionary()     
CPU times: user 1.07 s, sys: 0 ns, total: 1.07 s
Wall time: 1.08 s
sage: %time _=g.edges()        
CPU times: user 2.94 s, sys: 4 ms, total: 2.95 s
Wall time: 2.96 s
sage: %time _=g.edges(labels=False)
CPU times: user 2.7 s, sys: 0 ns, total: 2.7 s
Wall time: 2.73 s
```


Nathann


---

Comment by ncohen created at 2014-03-24 14:10:47

Changing component from PLEASE CHANGE to graph theory.


---

Comment by ncohen created at 2014-03-24 14:10:47

Changing status from new to needs_review.


---

Comment by git created at 2014-03-24 14:11:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-04-22 13:15:54

on 6.2.beta8:

```
CONFLICT (content): Merge conflict in src/sage/graphs/base/sparse_graph.pyx
```



---

Comment by vdelecroix created at 2014-04-22 13:15:54

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-04-22 13:26:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-04-22 13:26:39

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-04-22 13:26:39

Done !

Nathann


---

Comment by vdelecroix created at 2014-04-22 15:16:50

Hi Nathann,

Some old timings

```
sage: g=graphs.RandomGNP(1500,.4)
sage: timeit('for e in g.edge_iterator(): pass')
5 loops, best of 3: 684 ms per loop
```

Some new timings

```
sage: g=graphs.RandomGNP(1500,.4)
sage: timeit('for e in g.edge_iterator(): pass')
5 loops, best of 3: 317 ms per loop
```

This is definitely cool!

Question for further optimization: why in the `SparseGraphBackend` the methods `iterator_edges`, `iterator_in_edges` and `iterator_out_edges` do not use the `out_neighbors_unsafe`/`in_neighbors_unsafe` of `SparseGraph` with an array `int * neighbors` allocated once for all to the maximum of the degrees? That would avoid as many "malloc"+"list creation" as there are number of vertices in the call.


---

Comment by ncohen created at 2014-04-22 21:40:19

No reason that I can see. It will be a bit faster, it will make the code sligthly harder to read.. Comparing with an iterator could be nice, too. Do you feel like giving it a try ?

Nathann


---

Comment by vdelecroix created at 2014-04-23 05:41:07

Replying to [comment:7 ncohen]:
> No reason that I can see. It will be a bit faster, it will make the code sligthly harder to read.. Comparing with an iterator could be nice, too. Do you feel like giving it a try ?

Yeeeeeeeeeees. Let me try.


---

Comment by vdelecroix created at 2014-04-23 09:39:59

Hi Nathann,

I update the branch to sage.6.2.rc0 and implement what I said. There is still one `sage_malloc` that can be avoided in `out_neighbors_BTNode_unsafe` (it is documented in a `TODO` bloc). The timings are a bit better with this new implementation. Please have a look.

Vincent
----
New commits:


---

Comment by ncohen created at 2014-04-23 12:31:31

Do you have a problem with getting this patch merged and dealing with your optimisations in a different ticket ? You wrote a lot of code which will take time to review, and there will probably be some design choice to discuss ?...

Nathann


---

Comment by vdelecroix created at 2014-04-23 13:33:40

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2014-04-23 13:33:40

Replying to [comment:10 ncohen]:
> Do you have a problem with getting this patch merged and dealing with your optimisations in a different ticket ? You wrote a lot of code which will take time to review, and there will probably be some design choice to discuss ?...

My commit is mainly documentation, and the code is copy/paste of the very same 10 lines... so I do not agree with "You wrote a lot of code". Did you read it or ran

```
if [ $(git log -p -1|grep ^[\+-]|wc -l) -ge 300 ];
   then echo "This f******g patch is toooooooo long";
fi
```

But for sure I agree that there are some design discussions to have. The follow up is in #16220.

More seriously, there are many malformations in the documentation (especially the INPUT/OUTPUT blocks). They concern cdef functions so as soon as only the reference manual is concerned everything is fine.

Good enough for positive review.


---

Comment by ncohen created at 2014-04-23 13:45:34

> My commit is mainly documentation, and the code is copy/paste of the very same 10 lines... so I do not agree with "You wrote a lot of code". Did you read it or ran

Well, by just reading it I did not get immediately that it was only copy/paste. And it is code that should be looked at carefully. Don't worry, in the Graph realm it is not because something is settled "in a different ticket" that it is buried forever.

I just remembered today that the conversation died on https://groups.google.com/forum/#!topic/sage-devel/q5uy_lI11jg, and this is the kind of stuff that needs attention. Burying these things is criminal.

> But for sure I agree that there are some design discussions to have. The follow up is in #16220.

Yepyep. I'll go there next, though I believe I still have some answers to give you on other tickets.

> More seriously, there are many malformations in the documentation (especially the INPUT/OUTPUT blocks). They concern cdef functions so as soon as only the reference manual is concerned everything is fine.

Well, it's old code I guess. We'll fix that on the way.

> Good enough for positive review.

Thanks ! If you are looking for things to review, #12867 is getting old too `:-P`

Nathann


---

Comment by vbraun created at 2014-05-08 11:51:14

Resolution: fixed
