# Issue 20469: fallback site.getsitepackages in virtualenv

Issue created by migration from https://trac.sagemath.org/ticket/20706

Original creator: chapoton

Original creation time: 2016-05-29 15:59:52

CC:  jdemeyer embray

when run inside a virtualenv,

site has not attribute getsitepackages

This is a quick and dirty fallback in that case.


---

Comment by chapoton created at 2016-05-29 16:00:21

New commits:


---

Comment by chapoton created at 2016-05-29 16:00:21

Changing status from new to needs_review.


---

Comment by embray created at 2016-05-30 09:30:27

That's annoying about virtualenv.  I never ran into it before, I guess because using `site.getsitepackages` isn't very common.  But it ought to work.  I'm surprised it hasn't been fixed by now.

Unfortunately I think this workaround is incomplete, because if you're using a virtualenv with `--system-site-packages` this will still be incorrect.  Maybe for Sage's purposes it doesn't matter though.  I'd have to look at how `SITE_PACKAGES` is being used.


---

Comment by fbissey created at 2016-05-30 10:14:01

Mostly `SAGE_LIB` is used except in `src/sage/doctest/sources.py` for no real good reason

```
sp = os.path.join(SAGE_LOCAL, 'lib', 'python', 'site-packages')
```

I replaced it by `SAGE_LIB` in sage-on-gentoo but never pushed it because it is bundled with a bunch of other stuff.


---

Comment by chapoton created at 2016-05-30 13:38:04

I am trying to do `from sage.all import *` in an ipython3 session in a python3 virtualenv. This is the first failing point.

Then come problems with importing cython modules, but this is maybe another story.


---

Comment by embray created at 2016-05-30 14:40:52

I've never seen any particular problem with importing Cython modules when using virtualenv...?


---

Comment by chapoton created at 2016-05-30 14:43:43

I am probably doing something stupid. If you know the correct way to try importing sage in
an ipython3 session, please tell me.


---

Comment by embray created at 2016-05-30 16:04:39

Replying to [comment:6 chapoton]:
> I am probably doing something stupid. If you know the correct way to try importing sage in
> an ipython3 session, please tell me.

I don't know that it's you necessarily.  The key words might be "importing sage".  I haven't even tried using sage in a virtualenv, much less on Python 3.  Normally there'd be nothing special to it.


---

Comment by vbraun created at 2016-06-10 18:21:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-06-10 18:21:04

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2016-06-11 22:28:20

Resolution: fixed
