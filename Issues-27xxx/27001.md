# Issue 27001: py3: fix pip_installed_packages

archive/issues_026764.json:
```json
{
    "body": "by using pip3 when appropriate\n\nCC:  @embray @jdemeyer\n\nBranch/Commit: b3722ac58a78ff4ab30111da4d6a895c18b63211\n\nReviewer: Erik Bray\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27001\n\n",
    "closed_at": "2019-03-02T09:38:26Z",
    "created_at": "2019-01-02T15:42:10Z",
    "labels": [
        "component: python3",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "py3: fix pip_installed_packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27001",
    "user": "https://github.com/fchapoton"
}
```
by using pip3 when appropriate

CC:  @embray @jdemeyer

Branch/Commit: b3722ac58a78ff4ab30111da4d6a895c18b63211

Reviewer: Erik Bray

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27001





---

archive/issue_comments_400853.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-01-02T15:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400853",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_400854.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-02T15:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400854",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_400855.json:
```json
{
    "body": "<a id='comment:2'></a>This should really be\n\n```diff\ndiff --git a/src/sage/misc/package.py b/src/sage/misc/package.py\nindex 689e5a2..f7bfbc4 100644\n--- a/src/sage/misc/package.py\n+++ b/src/sage/misc/package.py\n@@ -48,6 +48,7 @@ from sage.env import SAGE_ROOT, SAGE_PKGS\n import json\n import os\n import subprocess\n+import sys\n try:\n     # Python 3.3+\n     from urllib.request import urlopen\n@@ -142,9 +143,12 @@ def pip_installed_packages():\n         sage: d['beautifulsoup']   # optional - beautifulsoup\n         u'...'\n     \"\"\"\n-    proc = subprocess.Popen([\"pip\", \"list\", \"--no-index\", \"--format\", \"json\"],\n+    proc = subprocess.Popen([sys.executable, \"-m\", \"pip\", \"list\", \"--no-index\",\n+                             \"--format\", \"json\"], stdout=subprocess.PIPE)\n     stdout = proc.communicate()[0].decode()\n-    return {package['name'].lower():package['version'] for package in json.load\n+    return {package['name'].lower(): package['version']\n+            for package in json.loads(stdout)}\n+\n\n def list_packages(*pkg_types, **opts):\n     r\"\"\"\n```\n\nApparently I already had this fix in my python3 branch: I apologize for forgetting to make a ticket for it.",
    "created_at": "2019-01-02T15:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400855",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>This should really be

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 689e5a2..f7bfbc4 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -48,6 +48,7 @@ from sage.env import SAGE_ROOT, SAGE_PKGS
 import json
 import os
 import subprocess
+import sys
 try:
     # Python 3.3+
     from urllib.request import urlopen
@@ -142,9 +143,12 @@ def pip_installed_packages():
         sage: d['beautifulsoup']   # optional - beautifulsoup
         u'...'
     """
-    proc = subprocess.Popen(["pip", "list", "--no-index", "--format", "json"],
+    proc = subprocess.Popen([sys.executable, "-m", "pip", "list", "--no-index",
+                             "--format", "json"], stdout=subprocess.PIPE)
     stdout = proc.communicate()[0].decode()
-    return {package['name'].lower():package['version'] for package in json.load
+    return {package['name'].lower(): package['version']
+            for package in json.loads(stdout)}
+

 def list_packages(*pkg_types, **opts):
     r"""
```

Apparently I already had this fix in my python3 branch: I apologize for forgetting to make a ticket for it.



---

archive/issue_comments_400856.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-02T15:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400856",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_400857.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-02T15:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400857",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_400858.json:
```json
{
    "body": "<a id='comment:4'></a>done",
    "created_at": "2019-01-02T15:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400858",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>done



---

archive/issue_comments_400859.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-02T15:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400859",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_400860.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2019-01-02T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400860",
    "user": "https://github.com/embray"
}
```

Changing priority from major to minor.



---

archive/issue_comments_400861.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-02T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400861",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_400862.json:
```json
{
    "body": "Changing type from enhancement to defect.",
    "created_at": "2019-01-02T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400862",
    "user": "https://github.com/embray"
}
```

Changing type from enhancement to defect.



---

archive/issue_comments_400863.json:
```json
{
    "body": "<a id='comment:5'></a>Ok thanks!",
    "created_at": "2019-01-02T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400863",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Ok thanks!



---

archive/issue_events_067003.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:16:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27001#event-67003"
}
```



---

archive/issue_comments_400864.json:
```json
{
    "body": "<a id='comment:6'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400864",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_400865.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-01-26T15:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400865",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_400866.json:
```json
{
    "body": "<a id='comment:7'></a>\n```\nsage -t --long src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 412, in sage.tests.cmdline.test_executable\nFailed example:\n    print(err)\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: refusing to run doctests...\nGot:\n    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.\n    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests\", line 163, in <module>\n        err = DC.run()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1200, in run\n        self.test_safe_directory()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 643, in test_safe_directory\n        .format(os.getcwd()))\n    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from\n    <BLANKLINE>\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 417, in sage.tests.cmdline.test_executable\nFailed example:\n    print(err)\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: refusing to run doctests...\nGot:\n    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.\n    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests\", line 163, in <module>\n        err = DC.run()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1200, in run\n        self.test_safe_directory()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 643, in test_safe_directory\n        .format(os.getcwd()))\n    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from\n    <BLANKLINE>\n**********************************************************************\n1 item had failures:\n   2 of 251 in sage.tests.cmdline.test_executable\n    [250 tests, 2 failures, 41.92 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/tests/cmdline.py  # 2 doctests failed\n----------------------------------------------------------------------\n```",
    "created_at": "2019-01-26T15:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400866",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>
```
sage -t --long src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 412, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
File "src/sage/tests/cmdline.py", line 417, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
1 item had failures:
   2 of 251 in sage.tests.cmdline.test_executable
    [250 tests, 2 failures, 41.92 s]
----------------------------------------------------------------------
sage -t --long src/sage/tests/cmdline.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

archive/issue_comments_400867.json:
```json
{
    "body": "<a id='comment:8'></a>Erik or Jeroen, any idea on how to fix that ?",
    "created_at": "2019-01-27T19:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400867",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>Erik or Jeroen, any idea on how to fix that ?



---

archive/issue_comments_400868.json:
```json
{
    "body": "<a id='comment:9'></a>should I just add `...` before the actual doctest ?",
    "created_at": "2019-01-29T08:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400868",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>should I just add `...` before the actual doctest ?



---

archive/issue_comments_400869.json:
```json
{
    "body": "<a id='comment:10'></a>#26457 has discussion about rewriting, if not entirely removing that test.",
    "created_at": "2019-01-29T17:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400869",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>#26457 has discussion about rewriting, if not entirely removing that test.



---

archive/issue_comments_400870.json:
```json
{
    "body": "<a id='comment:11'></a>so what should we do here ?",
    "created_at": "2019-02-05T19:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400870",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>so what should we do here ?



---

archive/issue_comments_400871.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 chapoton]:\n> so what should we do here ?\n\n\n(edited because original answer was wrong)\n\nIt seems that the doctest framework is using `pip_installed_packages` which is now causing Python to be run from an artificially unsafe directory. In this case, it's fine to just change the doctest output.",
    "created_at": "2019-02-06T09:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400871",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:11 chapoton]:
> so what should we do here ?


(edited because original answer was wrong)

It seems that the doctest framework is using `pip_installed_packages` which is now causing Python to be run from an artificially unsafe directory. In this case, it's fine to just change the doctest output.



---

archive/issue_comments_400872.json:
```json
{
    "body": "<a id='comment:13'></a>If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).",
    "created_at": "2019-02-17T02:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400872",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).



---

archive/issue_comments_400873.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-21T17:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400873",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_400874.json:
```json
{
    "body": "<a id='comment:15'></a>I see two options: either\n\n```diff\ndiff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py\nindex df938c8211..a5e2e6fbbf 100644\n--- a/src/sage/tests/cmdline.py\n+++ b/src/sage/tests/cmdline.py\n@@ -409,12 +409,21 @@ def test_executable(args, input=\"\", timeout=100.0, **kwds):\n         sage: os.mkdir(d)\n         sage: os.chmod(d, 0o777)\n         sage: (out, err, ret) = test_executable([\"sage\", \"-t\", \"nonexisting.py\"], cwd=d)\n-        sage: print(err)\n+        sage: print(err) # py2\n+        ...\n+        Traceback (most recent call last):\n+        ...\n+        sage: print(err) # py3\n         Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n         sage: (out, err, ret) = test_executable([\"sage\", \"-tp\", \"1\", \"nonexisting.py\"], cwd=d)\n-        sage: print(err)\n+        sage: print(err) # py2\n+        ...\n+        Traceback (most recent call last):\n+        ...\n+        RuntimeError: refusing to run doctests...\n+        sage: print(err) # py3\n         Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n```\nor\n\n```diff\ndiff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py\nindex df938c8211..08bda7c435 100644\n--- a/src/sage/tests/cmdline.py\n+++ b/src/sage/tests/cmdline.py\n@@ -410,12 +410,10 @@ def test_executable(args, input=\"\", timeout=100.0, **kwds):\n         sage: os.chmod(d, 0o777)\n         sage: (out, err, ret) = test_executable([\"sage\", \"-t\", \"nonexisting.py\"], cwd=d)\n         sage: print(err)\n-        Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n         sage: (out, err, ret) = test_executable([\"sage\", \"-tp\", \"1\", \"nonexisting.py\"], cwd=d)\n         sage: print(err)\n-        Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n \n```\nHere is a branch using the second version.\n\n---\nNew commits:",
    "created_at": "2019-02-21T17:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400874",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>I see two options: either

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index df938c8211..a5e2e6fbbf 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -409,12 +409,21 @@ def test_executable(args, input="", timeout=100.0, **kwds):
         sage: os.mkdir(d)
         sage: os.chmod(d, 0o777)
         sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
-        sage: print(err)
+        sage: print(err) # py2
+        ...
+        Traceback (most recent call last):
+        ...
+        sage: print(err) # py3
         Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
         sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
-        sage: print(err)
+        sage: print(err) # py2
+        ...
+        Traceback (most recent call last):
+        ...
+        RuntimeError: refusing to run doctests...
+        sage: print(err) # py3
         Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
```
or

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index df938c8211..08bda7c435 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -410,12 +410,10 @@ def test_executable(args, input="", timeout=100.0, **kwds):
         sage: os.chmod(d, 0o777)
         sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
         sage: print(err)
-        Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
         sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
         sage: print(err)
-        Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
 
```
Here is a branch using the second version.

---
New commits:



---

archive/issue_comments_400875.json:
```json
{
    "body": "<a id='comment:16'></a>ok, looks good to me. Jeroen, do you approve ?",
    "created_at": "2019-02-22T19:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400875",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>ok, looks good to me. Jeroen, do you approve ?



---

archive/issue_comments_400876.json:
```json
{
    "body": "<a id='comment:17'></a>I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?",
    "created_at": "2019-02-26T14:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400876",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?



---

archive/issue_comments_400877.json:
```json
{
    "body": "<a id='comment:18'></a>It passes tests for me with Python 2 and Python 3, so I guess we fixed it.",
    "created_at": "2019-02-26T18:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400877",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>It passes tests for me with Python 2 and Python 3, so I guess we fixed it.



---

archive/issue_comments_400878.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-28T15:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400878",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_400879.json:
```json
{
    "body": "<a id='comment:19'></a>I don't remember that, but I guess so!",
    "created_at": "2019-02-28T15:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400879",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>I don't remember that, but I guess so!



---

archive/issue_comments_400880.json:
```json
{
    "body": "<a id='comment:20'></a>(I'm not Jeroen, obviously, but I think this seems to reflect his suggestion)",
    "created_at": "2019-02-28T15:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400880",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>(I'm not Jeroen, obviously, but I think this seems to reflect his suggestion)



---

archive/issue_comments_400881.json:
```json
{
    "body": "<a id='comment:21'></a>I am slightly worried by comment:17 too.\n\nMaybe we should make sure that this is fixed and the doctests are run ?",
    "created_at": "2019-02-28T15:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400881",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>I am slightly worried by comment:17 too.

Maybe we should make sure that this is fixed and the doctests are run ?



---

archive/issue_comments_400882.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:17 embray]:\n> I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?\n\n\nI somehow seem to recall that this was fixed and that now a `....:` continuation is required after a `sage:` prompt.",
    "created_at": "2019-02-28T15:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400882",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Replying to [comment:17 embray]:
> I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?


I somehow seem to recall that this was fixed and that now a `....:` continuation is required after a `sage:` prompt.



---

archive/issue_comments_400883.json:
```json
{
    "body": "<a id='comment:23'></a>ok, then let's go.",
    "created_at": "2019-02-28T15:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400883",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'></a>ok, then let's go.



---

archive/issue_comments_400884.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:13 jhpalmieri]:\n> If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).\n\n\nI just posted a new topic on sage-devel `What to do with the sys.path security patch?` referring this.",
    "created_at": "2019-02-28T15:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400884",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Replying to [comment:13 jhpalmieri]:
> If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).


I just posted a new topic on sage-devel `What to do with the sys.path security patch?` referring this.



---

archive/issue_comments_400885.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:21 chapoton]:\n> I am slightly worried by comment:17 too.\n> \n> Maybe we should make sure that this is fixed and the doctests are run ?\n\n\nI will confirm that the tests are run: they fail if I change the text.",
    "created_at": "2019-02-28T16:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400885",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>Replying to [comment:21 chapoton]:
> I am slightly worried by comment:17 too.
> 
> Maybe we should make sure that this is fixed and the doctests are run ?


I will confirm that the tests are run: they fail if I change the text.



---

archive/issue_events_067004.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-02T09:38:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27001#event-67004"
}
```



---

archive/issue_comments_400886.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-02T09:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-400886",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
