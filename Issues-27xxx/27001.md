# Issue 27001: py3: fix pip_installed_packages

archive/issues_026764.json:
```json
{
    "body": "by using pip3 when appropriate\n\n**CC:**  @embray @jdemeyer\n\n**Branch/Commit:** [b3722ac58a78ff4ab30111da4d6a895c18b63211](https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211)\n\n**Reviewer:** Erik Bray\n\n**Author:** Fr\u00e9d\u00e9ric Chapoton\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27001\n\n",
    "closed_at": "2019-03-02T09:38:26Z",
    "created_at": "2019-01-02T15:42:10Z",
    "labels": [
        "component: python3",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "py3: fix pip_installed_packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27001",
    "user": "https://github.com/fchapoton"
}
```
by using pip3 when appropriate

**CC:**  @embray @jdemeyer

**Branch/Commit:** [b3722ac58a78ff4ab30111da4d6a895c18b63211](https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211)

**Reviewer:** Erik Bray

**Author:** Frédéric Chapoton

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/27001





---

archive/issue_comments_520771.json:
```json
{
    "body": "<a id='comment:1'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a06f005ecdf70d790b104c314aaee5cf8427a216\">a06f005</a></td><td><code>fix choice of pip in pip_installed_packages</code></td></tr></table>\n",
    "created_at": "2019-01-02T15:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520771",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a06f005ecdf70d790b104c314aaee5cf8427a216">a06f005</a></td><td><code>fix choice of pip in pip_installed_packages</code></td></tr></table>




---

archive/issue_comments_520772.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2019-01-02T15:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520772",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_520773.json:
```json
{
    "body": "**Commit:** [a06f005ecdf70d790b104c314aaee5cf8427a216](https://github.com/sagemath/sagetrac-mirror/commit/a06f005ecdf70d790b104c314aaee5cf8427a216)",
    "created_at": "2019-01-02T15:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520773",
    "user": "https://github.com/fchapoton"
}
```

**Commit:** [a06f005ecdf70d790b104c314aaee5cf8427a216](https://github.com/sagemath/sagetrac-mirror/commit/a06f005ecdf70d790b104c314aaee5cf8427a216)



---

archive/issue_comments_520774.json:
```json
{
    "body": "**Branch:** [u/chapoton/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27001)",
    "created_at": "2019-01-02T15:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520774",
    "user": "https://github.com/fchapoton"
}
```

**Branch:** [u/chapoton/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27001)



---

archive/issue_comments_520775.json:
```json
{
    "body": "<a id='comment:2'></a>\nThis should really be\n\n```diff\ndiff --git a/src/sage/misc/package.py b/src/sage/misc/package.py\nindex 689e5a2..f7bfbc4 100644\n--- a/src/sage/misc/package.py\n+++ b/src/sage/misc/package.py\n@@ -48,6 +48,7 @@ from sage.env import SAGE_ROOT, SAGE_PKGS\n import json\n import os\n import subprocess\n+import sys\n try:\n     # Python 3.3+\n     from urllib.request import urlopen\n@@ -142,9 +143,12 @@ def pip_installed_packages():\n         sage: d['beautifulsoup']   # optional - beautifulsoup\n         u'...'\n     \"\"\"\n-    proc = subprocess.Popen([\"pip\", \"list\", \"--no-index\", \"--format\", \"json\"],\n+    proc = subprocess.Popen([sys.executable, \"-m\", \"pip\", \"list\", \"--no-index\",\n+                             \"--format\", \"json\"], stdout=subprocess.PIPE)\n     stdout = proc.communicate()[0].decode()\n-    return {package['name'].lower():package['version'] for package in json.load\n+    return {package['name'].lower(): package['version']\n+            for package in json.loads(stdout)}\n+\n\n def list_packages(*pkg_types, **opts):\n     r\"\"\"\n```\n\nApparently I already had this fix in my python3 branch: I apologize for forgetting to make a ticket for it.",
    "created_at": "2019-01-02T15:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520775",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
This should really be

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 689e5a2..f7bfbc4 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -48,6 +48,7 @@ from sage.env import SAGE_ROOT, SAGE_PKGS
 import json
 import os
 import subprocess
+import sys
 try:
     # Python 3.3+
     from urllib.request import urlopen
@@ -142,9 +143,12 @@ def pip_installed_packages():
         sage: d['beautifulsoup']   # optional - beautifulsoup
         u'...'
     """
-    proc = subprocess.Popen(["pip", "list", "--no-index", "--format", "json"],
+    proc = subprocess.Popen([sys.executable, "-m", "pip", "list", "--no-index",
+                             "--format", "json"], stdout=subprocess.PIPE)
     stdout = proc.communicate()[0].decode()
-    return {package['name'].lower():package['version'] for package in json.load
+    return {package['name'].lower(): package['version']
+            for package in json.loads(stdout)}
+

 def list_packages(*pkg_types, **opts):
     r"""
```

Apparently I already had this fix in my python3 branch: I apologize for forgetting to make a ticket for it.



---

archive/issue_comments_520776.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2019-01-02T15:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520776",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_520777.json:
```json
{
    "body": "**Changing commit** from \"[a06f005ecdf70d790b104c314aaee5cf8427a216](https://github.com/sagemath/sagetrac-mirror/commit/a06f005ecdf70d790b104c314aaee5cf8427a216)\" to \"[d5040c0b4ad10323909d0642143d3a16bea41b54](https://github.com/sagemath/sagetrac-mirror/commit/d5040c0b4ad10323909d0642143d3a16bea41b54)\".",
    "created_at": "2019-01-02T15:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520777",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[a06f005ecdf70d790b104c314aaee5cf8427a216](https://github.com/sagemath/sagetrac-mirror/commit/a06f005ecdf70d790b104c314aaee5cf8427a216)" to "[d5040c0b4ad10323909d0642143d3a16bea41b54](https://github.com/sagemath/sagetrac-mirror/commit/d5040c0b4ad10323909d0642143d3a16bea41b54)".



---

archive/issue_comments_520778.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d5040c0b4ad10323909d0642143d3a16bea41b54\">d5040c0</a></td><td><code>fix choice of pip in pip_installed_packages</code></td></tr></table>\n",
    "created_at": "2019-01-02T15:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520778",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d5040c0b4ad10323909d0642143d3a16bea41b54">d5040c0</a></td><td><code>fix choice of pip in pip_installed_packages</code></td></tr></table>




---

archive/issue_comments_520779.json:
```json
{
    "body": "<a id='comment:4'></a>\ndone",
    "created_at": "2019-01-02T15:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520779",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
done



---

archive/issue_comments_520780.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2019-01-02T15:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520780",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_520781.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2019-01-02T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520781",
    "user": "https://github.com/embray"
}
```

**Reviewer:** Erik Bray



---

archive/issue_comments_520782.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2019-01-02T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520782",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_520783.json:
```json
{
    "body": "<a id='comment:5'></a>\nOk thanks!",
    "created_at": "2019-01-02T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520783",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Ok thanks!



---

archive/issue_events_076038.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:16:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27001#event-76038"
}
```



---

archive/issue_comments_520784.json:
```json
{
    "body": "<a id='comment:6'></a>\nRetarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520784",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_520785.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2019-01-26T15:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520785",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_520786.json:
```json
{
    "body": "<a id='comment:7'></a>\n\n```\nsage -t --long src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 412, in sage.tests.cmdline.test_executable\nFailed example:\n    print(err)\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: refusing to run doctests...\nGot:\n    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.\n    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests\", line 163, in <module>\n        err = DC.run()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1200, in run\n        self.test_safe_directory()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 643, in test_safe_directory\n        .format(os.getcwd()))\n    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from\n    <BLANKLINE>\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 417, in sage.tests.cmdline.test_executable\nFailed example:\n    print(err)\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: refusing to run doctests...\nGot:\n    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.\n    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests\", line 163, in <module>\n        err = DC.run()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1200, in run\n        self.test_safe_directory()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 643, in test_safe_directory\n        .format(os.getcwd()))\n    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from\n    <BLANKLINE>\n**********************************************************************\n1 item had failures:\n   2 of 251 in sage.tests.cmdline.test_executable\n    [250 tests, 2 failures, 41.92 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/tests/cmdline.py  # 2 doctests failed\n----------------------------------------------------------------------\n```",
    "created_at": "2019-01-26T15:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520786",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:7'></a>

```
sage -t --long src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 412, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
File "src/sage/tests/cmdline.py", line 417, in sage.tests.cmdline.test_executable
Failed example:
    print(err)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    sys:1: RuntimeWarning: not adding directory '' to sys.path since everybody can write to it.
    Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/src/bin/sage-runtests", line 163, in <module>
        err = DC.run()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1200, in run
        self.test_safe_directory()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/control.py", line 643, in test_safe_directory
        .format(os.getcwd()))
    RuntimeError: refusing to run doctests from the current directory '/var/lib/buildbot/.sage/temp/kucalc/160488/dir_OqlYHZ/test' since untrusted users could put files in this directory, making it unsafe to run Sage code from
    <BLANKLINE>
**********************************************************************
1 item had failures:
   2 of 251 in sage.tests.cmdline.test_executable
    [250 tests, 2 failures, 41.92 s]
----------------------------------------------------------------------
sage -t --long src/sage/tests/cmdline.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

archive/issue_comments_520787.json:
```json
{
    "body": "<a id='comment:8'></a>\nErik or Jeroen, any idea on how to fix that ?",
    "created_at": "2019-01-27T19:22:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520787",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>
Erik or Jeroen, any idea on how to fix that ?



---

archive/issue_comments_520788.json:
```json
{
    "body": "<a id='comment:9'></a>\nshould I just add `...` before the actual doctest ?",
    "created_at": "2019-01-29T08:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520788",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>
should I just add `...` before the actual doctest ?



---

archive/issue_comments_520789.json:
```json
{
    "body": "<a id='comment:10'></a>\n#26457 has discussion about rewriting, if not entirely removing that test.",
    "created_at": "2019-01-29T17:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520789",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
#26457 has discussion about rewriting, if not entirely removing that test.



---

archive/issue_comments_520790.json:
```json
{
    "body": "<a id='comment:11'></a>\nso what should we do here ?",
    "created_at": "2019-02-05T19:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520790",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>
so what should we do here ?



---

archive/issue_comments_520791.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [chapoton](#comment%3A11):\n> so what should we do here ?\n\n\n(edited because original answer was wrong)\n\nIt seems that the doctest framework is using `pip_installed_packages` which is now causing Python to be run from an artificially unsafe directory. In this case, it's fine to just change the doctest output.",
    "created_at": "2019-02-06T09:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520791",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [chapoton](#comment%3A11):
> so what should we do here ?


(edited because original answer was wrong)

It seems that the doctest framework is using `pip_installed_packages` which is now causing Python to be run from an artificially unsafe directory. In this case, it's fine to just change the doctest output.



---

archive/issue_comments_520792.json:
```json
{
    "body": "<a id='comment:13'></a>\nIf I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).",
    "created_at": "2019-02-17T02:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520792",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>
If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).



---

archive/issue_comments_520793.json:
```json
{
    "body": "**Changing branch** from \"[u/chapoton/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27001)\" to \"[u/jhpalmieri/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/27001)\".",
    "created_at": "2019-02-21T17:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520793",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing branch** from "[u/chapoton/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27001)" to "[u/jhpalmieri/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/27001)".



---

archive/issue_comments_520794.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2019-02-21T17:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520794",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_520795.json:
```json
{
    "body": "<a id='comment:15'></a>\nI see two options: either\n\n```diff\ndiff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py\nindex df938c8211..a5e2e6fbbf 100644\n--- a/src/sage/tests/cmdline.py\n+++ b/src/sage/tests/cmdline.py\n@@ -409,12 +409,21 @@ def test_executable(args, input=\"\", timeout=100.0, **kwds):\n         sage: os.mkdir(d)\n         sage: os.chmod(d, 0o777)\n         sage: (out, err, ret) = test_executable([\"sage\", \"-t\", \"nonexisting.py\"], cwd=d)\n-        sage: print(err)\n+        sage: print(err) # py2\n+        ...\n+        Traceback (most recent call last):\n+        ...\n+        sage: print(err) # py3\n         Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n         sage: (out, err, ret) = test_executable([\"sage\", \"-tp\", \"1\", \"nonexisting.py\"], cwd=d)\n-        sage: print(err)\n+        sage: print(err) # py2\n+        ...\n+        Traceback (most recent call last):\n+        ...\n+        RuntimeError: refusing to run doctests...\n+        sage: print(err) # py3\n         Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n```\nor\n\n```diff\ndiff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py\nindex df938c8211..08bda7c435 100644\n--- a/src/sage/tests/cmdline.py\n+++ b/src/sage/tests/cmdline.py\n@@ -410,12 +410,10 @@ def test_executable(args, input=\"\", timeout=100.0, **kwds):\n         sage: os.chmod(d, 0o777)\n         sage: (out, err, ret) = test_executable([\"sage\", \"-t\", \"nonexisting.py\"], cwd=d)\n         sage: print(err)\n-        Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n         sage: (out, err, ret) = test_executable([\"sage\", \"-tp\", \"1\", \"nonexisting.py\"], cwd=d)\n         sage: print(err)\n-        Traceback (most recent call last):\n         ...\n         RuntimeError: refusing to run doctests...\n \n```\nHere is a branch using the second version.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cfefd2ee31b3dc2fccb05d4d660a687f8765a67e\">cfefd2e</a></td><td><code>fix choice of pip in pip_installed_packages</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211\">b3722ac</a></td><td><code>trac 27001: fix doctest</code></td></tr></table>\n",
    "created_at": "2019-02-21T17:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520795",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>
I see two options: either

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index df938c8211..a5e2e6fbbf 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -409,12 +409,21 @@ def test_executable(args, input="", timeout=100.0, **kwds):
         sage: os.mkdir(d)
         sage: os.chmod(d, 0o777)
         sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
-        sage: print(err)
+        sage: print(err) # py2
+        ...
+        Traceback (most recent call last):
+        ...
+        sage: print(err) # py3
         Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
         sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
-        sage: print(err)
+        sage: print(err) # py2
+        ...
+        Traceback (most recent call last):
+        ...
+        RuntimeError: refusing to run doctests...
+        sage: print(err) # py3
         Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
```
or

```diff
diff --git a/src/sage/tests/cmdline.py b/src/sage/tests/cmdline.py
index df938c8211..08bda7c435 100644
--- a/src/sage/tests/cmdline.py
+++ b/src/sage/tests/cmdline.py
@@ -410,12 +410,10 @@ def test_executable(args, input="", timeout=100.0, **kwds):
         sage: os.chmod(d, 0o777)
         sage: (out, err, ret) = test_executable(["sage", "-t", "nonexisting.py"], cwd=d)
         sage: print(err)
-        Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
         sage: (out, err, ret) = test_executable(["sage", "-tp", "1", "nonexisting.py"], cwd=d)
         sage: print(err)
-        Traceback (most recent call last):
         ...
         RuntimeError: refusing to run doctests...
 
```
Here is a branch using the second version.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cfefd2ee31b3dc2fccb05d4d660a687f8765a67e">cfefd2e</a></td><td><code>fix choice of pip in pip_installed_packages</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211">b3722ac</a></td><td><code>trac 27001: fix doctest</code></td></tr></table>




---

archive/issue_comments_520796.json:
```json
{
    "body": "**Changing commit** from \"[d5040c0b4ad10323909d0642143d3a16bea41b54](https://github.com/sagemath/sagetrac-mirror/commit/d5040c0b4ad10323909d0642143d3a16bea41b54)\" to \"[b3722ac58a78ff4ab30111da4d6a895c18b63211](https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211)\".",
    "created_at": "2019-02-21T17:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520796",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing commit** from "[d5040c0b4ad10323909d0642143d3a16bea41b54](https://github.com/sagemath/sagetrac-mirror/commit/d5040c0b4ad10323909d0642143d3a16bea41b54)" to "[b3722ac58a78ff4ab30111da4d6a895c18b63211](https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211)".



---

archive/issue_comments_520797.json:
```json
{
    "body": "<a id='comment:16'></a>\nok, looks good to me. Jeroen, do you approve ?",
    "created_at": "2019-02-22T19:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520797",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'></a>
ok, looks good to me. Jeroen, do you approve ?



---

archive/issue_comments_520798.json:
```json
{
    "body": "<a id='comment:17'></a>\nI thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?",
    "created_at": "2019-02-26T14:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520798",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?



---

archive/issue_comments_520799.json:
```json
{
    "body": "<a id='comment:18'></a>\nIt passes tests for me with Python 2 and Python 3, so I guess we fixed it.",
    "created_at": "2019-02-26T18:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520799",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>
It passes tests for me with Python 2 and Python 3, so I guess we fixed it.



---

archive/issue_comments_520800.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2019-02-28T15:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520800",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_520801.json:
```json
{
    "body": "<a id='comment:19'></a>\nI don't remember that, but I guess so!",
    "created_at": "2019-02-28T15:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520801",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>
I don't remember that, but I guess so!



---

archive/issue_comments_520802.json:
```json
{
    "body": "<a id='comment:20'></a>\n(I'm not Jeroen, obviously, but I think this seems to reflect his suggestion)",
    "created_at": "2019-02-28T15:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520802",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
(I'm not Jeroen, obviously, but I think this seems to reflect his suggestion)



---

archive/issue_comments_520803.json:
```json
{
    "body": "<a id='comment:21'></a>\nI am slightly worried by [comment:17](#comment%3A17) too.\n\nMaybe we should make sure that this is fixed and the doctests are run ?",
    "created_at": "2019-02-28T15:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520803",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>
I am slightly worried by [comment:17](#comment%3A17) too.

Maybe we should make sure that this is fixed and the doctests are run ?



---

archive/issue_comments_520804.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [embray](#comment%3A17):\n> I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?\n\n\nI somehow seem to recall that this was fixed and that now a `....:` continuation is required after a `sage:` prompt.",
    "created_at": "2019-02-28T15:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520804",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Replying to [embray](#comment%3A17):
> I thought that the doctest parser got confused if we started a line with `...` (it would get confused with a continuation prompt like `....:`).  Or did we fix that?


I somehow seem to recall that this was fixed and that now a `....:` continuation is required after a `sage:` prompt.



---

archive/issue_comments_520805.json:
```json
{
    "body": "<a id='comment:23'></a>\nok, then let's go.",
    "created_at": "2019-02-28T15:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520805",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'></a>
ok, then let's go.



---

archive/issue_comments_520806.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [jhpalmieri](#comment%3A13):\n> If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).\n\n\nI just posted a new topic on sage-devel `What to do with the sys.path security patch?` referring this.",
    "created_at": "2019-02-28T15:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520806",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
Replying to [jhpalmieri](#comment%3A13):
> If I add `...` at the beginning of the doctest output, then it passes with Python 2 but not Python 3 (which doesn't print the extra line `sys:1: RuntimeWarning: ...`).


I just posted a new topic on sage-devel `What to do with the sys.path security patch?` referring this.



---

archive/issue_comments_520807.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [chapoton](#comment%3A21):\n> I am slightly worried by [comment:17](#comment%3A17) too.\n> \n> Maybe we should make sure that this is fixed and the doctests are run ?\n\n\nI will confirm that the tests are run: they fail if I change the text.",
    "created_at": "2019-02-28T16:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520807",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>
Replying to [chapoton](#comment%3A21):
> I am slightly worried by [comment:17](#comment%3A17) too.
> 
> Maybe we should make sure that this is fixed and the doctests are run ?


I will confirm that the tests are run: they fail if I change the text.



---

archive/issue_events_076039.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-02T09:38:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27001#event-76039"
}
```



---

archive/issue_comments_520808.json:
```json
{
    "body": "**Changing branch** from \"[u/jhpalmieri/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/27001)\" to \"[b3722ac58a78ff4ab30111da4d6a895c18b63211](https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211)\".",
    "created_at": "2019-03-02T09:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520808",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jhpalmieri/27001](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/27001)" to "[b3722ac58a78ff4ab30111da4d6a895c18b63211](https://github.com/sagemath/sagetrac-mirror/commit/b3722ac58a78ff4ab30111da4d6a895c18b63211)".



---

archive/issue_comments_520809.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2019-03-02T09:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27001",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27001#issuecomment-520809",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed
