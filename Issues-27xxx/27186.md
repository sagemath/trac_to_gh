# Issue 27186: spkg-configure.m4 for libpng

archive/issues_026949.json:
```json
{
    "body": "Also should be done for #27168\n\nNote libpng comes in a number of different ABI versions, usually indicated in the library filename as a suffix like \"12\" (for 1.2.x) up through \"16\" (for 1.6.x), where 16 is the most current and currently supported by Sage.  Distros like Debian has separate packages for each libpng ABI version.\n\nI think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.\n\nconfigure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz\n\n**CC:**  @kiwifb\n\n**Keywords:** spkg-configure\n\n**Branch:** [adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)\n\n**Reviewer:** Fran\u00e7ois Bissey\n\n**Author:** Dima Pasechnik\n\nIssue created by migration from https://trac.sagemath.org/ticket/27186\n\n",
    "closed_at": "2019-05-21T12:15:55Z",
    "created_at": "2019-01-31T14:10:58Z",
    "labels": [
        "component: packages: standard",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.8",
    "title": "spkg-configure.m4 for libpng",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/27186",
    "user": "https://github.com/embray"
}
```
Also should be done for #27168

Note libpng comes in a number of different ABI versions, usually indicated in the library filename as a suffix like "12" (for 1.2.x) up through "16" (for 1.6.x), where 16 is the most current and currently supported by Sage.  Distros like Debian has separate packages for each libpng ABI version.

I think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.

configure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz

**CC:**  @kiwifb

**Keywords:** spkg-configure

**Branch:** [adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)

**Reviewer:** Fran√ßois Bissey

**Author:** Dima Pasechnik

Issue created by migration from https://trac.sagemath.org/ticket/27186





---

archive/issue_comments_422172.json:
```json
{
    "body": "<a id='comment:1'></a>\nThat said, my Ubuntu build machine has a kinda old libpng12, and while I'm not saying we *should* support that, I'm curious to see if it will work...",
    "created_at": "2019-01-31T14:32:25Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422172",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
That said, my Ubuntu build machine has a kinda old libpng12, and while I'm not saying we *should* support that, I'm curious to see if it will work...



---

archive/issue_comments_422173.json:
```json
{
    "body": "<a id='comment:2'></a>\nAlso, we should probably not use the system libpng at all on OSX (unless in homebrew or something, but I don't know if we explicitly support that yet...)",
    "created_at": "2019-01-31T14:38:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422173",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Also, we should probably not use the system libpng at all on OSX (unless in homebrew or something, but I don't know if we explicitly support that yet...)



---

archive/issue_comments_422174.json:
```json
{
    "body": "<a id='comment:3'></a>\nWhat's wrong with OSX's system libpng?",
    "created_at": "2019-01-31T14:40:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422174",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
What's wrong with OSX's system libpng?



---

archive/issue_comments_422175.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt's unusable.  See the SPKG.txt for libpng.",
    "created_at": "2019-01-31T14:56:52Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422175",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
It's unusable.  See the SPKG.txt for libpng.



---

archive/issue_comments_422176.json:
```json
{
    "body": "<a id='comment:5'></a>\nOkay, at least on my Ubuntu 14.04 machine libpng 1.2 worked just fine actually.  Did a full `make ptestlong` from scratch.  Nothing complained.  So maybe we can afford a bit more flexibility here.",
    "created_at": "2019-01-31T16:04:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422176",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Okay, at least on my Ubuntu 14.04 machine libpng 1.2 worked just fine actually.  Did a full `make ptestlong` from scratch.  Nothing complained.  So maybe we can afford a bit more flexibility here.



---

archive/issue_comments_422177.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [embray](#comment%3A4):\n> It's unusable.  See the SPKG.txt for libpng.\n\n\nI don't read it this way. I read it as \"it won't conflict with the one built by Sage\".\nWell, maybe I am wrong - it's perhaps worth trying on OSX.",
    "created_at": "2019-01-31T16:35:06Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422177",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
Replying to [embray](#comment%3A4):
> It's unusable.  See the SPKG.txt for libpng.


I don't read it this way. I read it as "it won't conflict with the one built by Sage".
Well, maybe I am wrong - it's perhaps worth trying on OSX.



---

archive/issue_comments_422178.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think you are misreading.  The point is that if you just blindly link `-lpng` on OSX without an alternative libpng on the linker path you'll get the `libPng.dylib` used by the system which is not compatible with anything we build that wants to link with libpng.\n\nOne workaround is to explicitly ask for one of the ABI-specific names like `-lpng12` or `-lpng16`, at least on OSX.  That way you might be able to pick up, say, a version from homebrew, but you won't accidentally link to the unusable OSX system lib.",
    "created_at": "2019-01-31T16:38:26Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422178",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
I think you are misreading.  The point is that if you just blindly link `-lpng` on OSX without an alternative libpng on the linker path you'll get the `libPng.dylib` used by the system which is not compatible with anything we build that wants to link with libpng.

One workaround is to explicitly ask for one of the ABI-specific names like `-lpng12` or `-lpng16`, at least on OSX.  That way you might be able to pick up, say, a version from homebrew, but you won't accidentally link to the unusable OSX system lib.



---

archive/issue_comments_422179.json:
```json
{
    "body": "<a id='comment:8'></a>\nAlthough I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.",
    "created_at": "2019-01-31T16:45:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422179",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Although I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.



---

archive/issue_comments_422180.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [embray](#comment%3A8):\n> Although I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.\n\n\nThis still sounds as if using system's libPng would lead to various library conflicts (with other Sage-installed versions of stuff also available on the system), i.e. if we go far enough with our plan it would not matter...\n\nAnyhow, I just checked that Homebrew also does not use system's libPng, but installs its own libpng16.dylib.\n\nOne way or another, I think we should not block the usage of Homebrew (or conda) libs, i.e. there should not be a rule saying \"we're on OSX! install from source\").\n\nPS. Last time I checked (few months ago), it's possible to build and run Sage under Homebrew. Basically, it's an environment where lots of stuff lives in /usr/local...",
    "created_at": "2019-01-31T17:04:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422180",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
Replying to [embray](#comment%3A8):
> Although I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.


This still sounds as if using system's libPng would lead to various library conflicts (with other Sage-installed versions of stuff also available on the system), i.e. if we go far enough with our plan it would not matter...

Anyhow, I just checked that Homebrew also does not use system's libPng, but installs its own libpng16.dylib.

One way or another, I think we should not block the usage of Homebrew (or conda) libs, i.e. there should not be a rule saying "we're on OSX! install from source").

PS. Last time I checked (few months ago), it's possible to build and run Sage under Homebrew. Basically, it's an environment where lots of stuff lives in /usr/local...



---

archive/issue_comments_422181.json:
```json
{
    "body": "<a id='comment:10'></a>\nVolker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?",
    "created_at": "2019-01-31T17:13:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422181",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Volker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?



---

archive/issue_comments_422182.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [embray](#comment%3A10):\n> Volker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?\n\n\nNot since 2010 or so, I guess :-)",
    "created_at": "2019-01-31T17:20:46Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422182",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
Replying to [embray](#comment%3A10):
> Volker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?


Not since 2010 or so, I guess :-)



---

archive/issue_comments_422183.json:
```json
{
    "body": "<a id='comment:12'></a>\nthe following works:\n\n```bash\nSAGE_SPKG_CONFIGURE([libpng], [\n    dnl First try checking for libpng with pkg-config\n    PKG_CHECK_MODULES([LIBPNG], [libpng16], [], [\n        dnl Fallback to manually grubbing around for headers and libs\n        AC_CHECK_HEADERS([libpng16/png.h], [sage_spkg_install_libpng=no; break], [sage_spkg_install_libpng=yes])\n        AC_SEARCH_LIBS([png_get_io_ptr], [libpng16], [], [sage_spkg_install_libpng=yes])\n    ])\n])\n```",
    "created_at": "2019-02-09T00:21:39Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422183",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>
the following works:

```bash
SAGE_SPKG_CONFIGURE([libpng], [
    dnl First try checking for libpng with pkg-config
    PKG_CHECK_MODULES([LIBPNG], [libpng16], [], [
        dnl Fallback to manually grubbing around for headers and libs
        AC_CHECK_HEADERS([libpng16/png.h], [sage_spkg_install_libpng=no; break], [sage_spkg_install_libpng=yes])
        AC_SEARCH_LIBS([png_get_io_ptr], [libpng16], [], [sage_spkg_install_libpng=yes])
    ])
])
```



---

archive/issue_comments_422184.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"spkg-configure\".",
    "created_at": "2019-02-12T09:15:58Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422184",
    "user": "https://github.com/dimpase"
}
```

**Changing keywords** from "" to "spkg-configure".



---

archive/issue_comments_422185.json:
```json
{
    "body": "<a id='comment:14'></a>\nI found that there is no reason to require libpng16 specifically (unless I'm wrong / there is some optional package I'm missing that requires a newer version)?\n\nI was thinking we might do something pretty similar to this, but instead of *just* `libpng16` we would check first for `libpng16`, and if not found try `libpng14`, then `libpng12`, and then just plain `libpng` (except on macOS where that conflicts with the system's incompatible \"libPng\").",
    "created_at": "2019-02-12T10:19:20Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422185",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
I found that there is no reason to require libpng16 specifically (unless I'm wrong / there is some optional package I'm missing that requires a newer version)?

I was thinking we might do something pretty similar to this, but instead of *just* `libpng16` we would check first for `libpng16`, and if not found try `libpng14`, then `libpng12`, and then just plain `libpng` (except on macOS where that conflicts with the system's incompatible "libPng").



---

archive/issue_comments_422186.json:
```json
{
    "body": "<a id='comment:15'></a>\nIf that overcomplicates things though, the above is fine.  libpng just tends to be problematic, so I thought it would be good to be flexible in which versions we accept so long as there is no explicit need for 1.6.",
    "created_at": "2019-02-12T10:20:34Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422186",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
If that overcomplicates things though, the above is fine.  libpng just tends to be problematic, so I thought it would be good to be flexible in which versions we accept so long as there is no explicit need for 1.6.



---

archive/issue_comments_422187.json:
```json
{
    "body": "<a id='comment:16'></a>\nin `build/pkgs/tachyon/patches/Make-config.patch` you see\n\n```\n+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng16 -lz\n-#PNGLIB= -L/usr/local/lib -lpng -lz\n```\nIt suggests that libpng16 is needed.",
    "created_at": "2019-02-12T10:23:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422187",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>
in `build/pkgs/tachyon/patches/Make-config.patch` you see

```
+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng16 -lz
-#PNGLIB= -L/usr/local/lib -lpng -lz
```
It suggests that libpng16 is needed.



---

archive/issue_comments_422188.json:
```json
{
    "body": "<a id='comment:17'></a>\nI don't think so: This patch was made because the libpng package in Sage delete the normal `libpng.so -> libpng16.so` symlink that is installed, specifically so as to not conflict with the macOS \"libPng\", but in turn that means that if you compile tachyon in Sage you have to specify `-lpng16`, since `-lpng` does not exist in Sage's lib directory.\n\nI don't think it has to be libpng16 specifically; that patch just specifies `-lpng16` because that's what's in Sage.  I was able to replace this with `-lpng12` and it worked fine.",
    "created_at": "2019-02-12T10:44:17Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422188",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
I don't think so: This patch was made because the libpng package in Sage delete the normal `libpng.so -> libpng16.so` symlink that is installed, specifically so as to not conflict with the macOS "libPng", but in turn that means that if you compile tachyon in Sage you have to specify `-lpng16`, since `-lpng` does not exist in Sage's lib directory.

I don't think it has to be libpng16 specifically; that patch just specifies `-lpng16` because that's what's in Sage.  I was able to replace this with `-lpng12` and it worked fine.



---

archive/issue_comments_422189.json:
```json
{
    "body": "<a id='comment:18'></a>\nRemoving most of the rest of my open tickets out of the 8.7 milestone, which should be closed.",
    "created_at": "2019-03-25T10:44:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422189",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.



---

archive/issue_events_240012.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:44:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240012"
}
```



---

archive/issue_events_240013.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:44:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240013"
}
```



---

archive/issue_comments_422190.json:
```json
{
    "body": "<a id='comment:19'></a>\nI looked a bit into OSX libPng, and I see no trace of it on OSX 10.14.\nSo it's probably quite obsolete into in libpng's SPKG.",
    "created_at": "2019-04-14T23:21:37Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422190",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
I looked a bit into OSX libPng, and I see no trace of it on OSX 10.14.
So it's probably quite obsolete into in libpng's SPKG.



---

archive/issue_comments_422191.json:
```json
{
    "body": "**Author:** Dima Pasechnik",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422191",
    "user": "https://github.com/dimpase"
}
```

**Author:** Dima Pasechnik



---

archive/issue_events_240014.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-15T07:33:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240014"
}
```



---

archive/issue_events_240015.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-15T07:33:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240015"
}
```



---

archive/issue_comments_422192.json:
```json
{
    "body": "**Branch:** [u/dimpase/packages/png-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/png-config)",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422192",
    "user": "https://github.com/dimpase"
}
```

**Branch:** [u/dimpase/packages/png-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/png-config)



---

archive/issue_comments_422193.json:
```json
{
    "body": "**Commit:** [590b3833197f436d1e6fec95916d32527e373ec6](https://github.com/sagemath/sagetrac-mirror/commit/590b3833197f436d1e6fec95916d32527e373ec6)",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422193",
    "user": "https://github.com/dimpase"
}
```

**Commit:** [590b3833197f436d1e6fec95916d32527e373ec6](https://github.com/sagemath/sagetrac-mirror/commit/590b3833197f436d1e6fec95916d32527e373ec6)



---

archive/issue_comments_422194.json:
```json
{
    "body": "<a id='comment:20'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/590b3833197f436d1e6fec95916d32527e373ec6\">590b383</a></td><td><code>spkg-configure for libpng</code></td></tr></table>\n",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422194",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/590b3833197f436d1e6fec95916d32527e373ec6">590b383</a></td><td><code>spkg-configure for libpng</code></td></tr></table>




---

archive/issue_comments_422195.json:
```json
{
    "body": "<a id='comment:21'></a>\nI need to re-review this, but I'm okay with just throwing my hands up and saying to hell with OSX.  If there *is* still an issue we'll find out, and now that we have `--without-system-libpng` at least there's a workaround in place.",
    "created_at": "2019-04-15T16:05:14Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422195",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>
I need to re-review this, but I'm okay with just throwing my hands up and saying to hell with OSX.  If there *is* still an issue we'll find out, and now that we have `--without-system-libpng` at least there's a workaround in place.



---

archive/issue_comments_422196.json:
```json
{
    "body": "<a id='comment:22'></a>\nI think Apple's library won't be known to pkg-config, and then AC_SEARCH_LIBS would filter it out. Anyhow it's probably only some post-EOL OSX versions that might potentially be problematic...",
    "created_at": "2019-04-15T18:54:42Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422196",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>
I think Apple's library won't be known to pkg-config, and then AC_SEARCH_LIBS would filter it out. Anyhow it's probably only some post-EOL OSX versions that might potentially be problematic...



---

archive/issue_comments_422197.json:
```json
{
    "body": "**Changing commit** from \"[590b3833197f436d1e6fec95916d32527e373ec6](https://github.com/sagemath/sagetrac-mirror/commit/590b3833197f436d1e6fec95916d32527e373ec6)\" to \"[cce4eef79a3e6f40f45d385ea754ad50f9d2de88](https://github.com/sagemath/sagetrac-mirror/commit/cce4eef79a3e6f40f45d385ea754ad50f9d2de88)\".",
    "created_at": "2019-04-15T20:32:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422197",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[590b3833197f436d1e6fec95916d32527e373ec6](https://github.com/sagemath/sagetrac-mirror/commit/590b3833197f436d1e6fec95916d32527e373ec6)" to "[cce4eef79a3e6f40f45d385ea754ad50f9d2de88](https://github.com/sagemath/sagetrac-mirror/commit/cce4eef79a3e6f40f45d385ea754ad50f9d2de88)".



---

archive/issue_comments_422198.json:
```json
{
    "body": "<a id='comment:23'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cce4eef79a3e6f40f45d385ea754ad50f9d2de88\">cce4eef</a></td><td><code>spkg-configure for libpng</code></td></tr></table>\n",
    "created_at": "2019-04-15T20:32:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422198",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cce4eef79a3e6f40f45d385ea754ad50f9d2de88">cce4eef</a></td><td><code>spkg-configure for libpng</code></td></tr></table>




---

archive/issue_events_240016.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-15T20:33:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240016"
}
```



---

archive/issue_comments_422199.json:
```json
{
    "body": "<a id='comment:25'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4e9fca1dd163c19116521bffce526f57162b35a9\">4e9fca1</a></td><td><code>spkg-configure for libpng</code></td></tr></table>\n",
    "created_at": "2019-04-15T20:52:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422199",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4e9fca1dd163c19116521bffce526f57162b35a9">4e9fca1</a></td><td><code>spkg-configure for libpng</code></td></tr></table>




---

archive/issue_comments_422200.json:
```json
{
    "body": "**Changing commit** from \"[cce4eef79a3e6f40f45d385ea754ad50f9d2de88](https://github.com/sagemath/sagetrac-mirror/commit/cce4eef79a3e6f40f45d385ea754ad50f9d2de88)\" to \"[4e9fca1dd163c19116521bffce526f57162b35a9](https://github.com/sagemath/sagetrac-mirror/commit/4e9fca1dd163c19116521bffce526f57162b35a9)\".",
    "created_at": "2019-04-15T20:52:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422200",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[cce4eef79a3e6f40f45d385ea754ad50f9d2de88](https://github.com/sagemath/sagetrac-mirror/commit/cce4eef79a3e6f40f45d385ea754ad50f9d2de88)" to "[4e9fca1dd163c19116521bffce526f57162b35a9](https://github.com/sagemath/sagetrac-mirror/commit/4e9fca1dd163c19116521bffce526f57162b35a9)".



---

archive/issue_comments_422201.json:
```json
{
    "body": "<a id='comment:26'></a>\nwe also need to check that zlib, the dependency, comes from the system.",
    "created_at": "2019-04-15T20:53:23Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422201",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>
we also need to check that zlib, the dependency, comes from the system.



---

archive/issue_comments_422202.json:
```json
{
    "body": "<a id='comment:27'></a>\nbut zlib does not need to satisfy the requirements for Sages's libpng.",
    "created_at": "2019-04-16T08:16:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422202",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
but zlib does not need to satisfy the requirements for Sages's libpng.



---

archive/issue_events_240017.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-16T08:16:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240017"
}
```



---

archive/issue_events_240018.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-16T08:16:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240018"
}
```



---

archive/issue_comments_422203.json:
```json
{
    "body": "**Changing commit** from \"[4e9fca1dd163c19116521bffce526f57162b35a9](https://github.com/sagemath/sagetrac-mirror/commit/4e9fca1dd163c19116521bffce526f57162b35a9)\" to \"[2f5aaa77a5e880069733d2dbd4db9b3b696f6e48](https://github.com/sagemath/sagetrac-mirror/commit/2f5aaa77a5e880069733d2dbd4db9b3b696f6e48)\".",
    "created_at": "2019-04-16T16:32:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422203",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[4e9fca1dd163c19116521bffce526f57162b35a9](https://github.com/sagemath/sagetrac-mirror/commit/4e9fca1dd163c19116521bffce526f57162b35a9)" to "[2f5aaa77a5e880069733d2dbd4db9b3b696f6e48](https://github.com/sagemath/sagetrac-mirror/commit/2f5aaa77a5e880069733d2dbd4db9b3b696f6e48)".



---

archive/issue_comments_422204.json:
```json
{
    "body": "<a id='comment:28'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d20b81b518d505c95d4e70b289b9147409bfdbf0\">d20b81b</a></td><td><code>spkg-configure for libpng</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f5aaa77a5e880069733d2dbd4db9b3b696f6e48\">2f5aaa7</a></td><td><code>don't check unneeded requirements for system libpng</code></td></tr></table>\n",
    "created_at": "2019-04-16T16:32:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422204",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d20b81b518d505c95d4e70b289b9147409bfdbf0">d20b81b</a></td><td><code>spkg-configure for libpng</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f5aaa77a5e880069733d2dbd4db9b3b696f6e48">2f5aaa7</a></td><td><code>don't check unneeded requirements for system libpng</code></td></tr></table>




---

archive/issue_events_240019.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-16T16:34:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240019"
}
```



---

archive/issue_events_240020.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-16T16:34:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240020"
}
```



---

archive/issue_comments_422205.json:
```json
{
    "body": "<a id='comment:29'></a>\nnow we do not try to check for unneeded new functionality in zlib for older libpng's",
    "created_at": "2019-04-16T16:34:35Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422205",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>
now we do not try to check for unneeded new functionality in zlib for older libpng's



---

archive/issue_comments_422206.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f4d89709cd432fa048fa5bb978943ceedfd4c8ca\">f4d8970</a></td><td><code>spkg-configure for libpng</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f5fa38e5cf37358667af98562983919664e07503\">f5fa38e</a></td><td><code>don't check unneeded requirements for system libpng</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716\">1e8b1a2</a></td><td><code>bumped up configure spkg</code></td></tr></table>\n",
    "created_at": "2019-04-19T11:19:07Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422206",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f4d89709cd432fa048fa5bb978943ceedfd4c8ca">f4d8970</a></td><td><code>spkg-configure for libpng</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f5fa38e5cf37358667af98562983919664e07503">f5fa38e</a></td><td><code>don't check unneeded requirements for system libpng</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716">1e8b1a2</a></td><td><code>bumped up configure spkg</code></td></tr></table>




---

archive/issue_comments_422207.json:
```json
{
    "body": "**Changing commit** from \"[2f5aaa77a5e880069733d2dbd4db9b3b696f6e48](https://github.com/sagemath/sagetrac-mirror/commit/2f5aaa77a5e880069733d2dbd4db9b3b696f6e48)\" to \"[1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716](https://github.com/sagemath/sagetrac-mirror/commit/1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716)\".",
    "created_at": "2019-04-19T11:19:07Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422207",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[2f5aaa77a5e880069733d2dbd4db9b3b696f6e48](https://github.com/sagemath/sagetrac-mirror/commit/2f5aaa77a5e880069733d2dbd4db9b3b696f6e48)" to "[1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716](https://github.com/sagemath/sagetrac-mirror/commit/1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716)".



---

archive/issue_comments_422208.json:
```json
{
    "body": "updated configure spkg",
    "created_at": "2019-04-19T11:19:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422208",
    "user": "https://github.com/dimpase"
}
```

updated configure spkg



---

archive/attachments_021170.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "configure-318.tar.gz",
    "asset_url": "tarball://root/attachments/ticket27186/configure-318.tar.gz",
    "created_at": "2019-04-19T11:21:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket27186/configure-318.tar.gz",
    "user": "https://github.com/dimpase"
}
```



---

archive/issue_comments_422209.json:
```json
{
    "body": "<a id='comment:31'></a>\nAttachment [configure-318.tar.gz](https://github.com/sagemath/sage/files/ticket27186/configure-318.tar.gz) by @dimpase created at 2019-04-19 11:21:11",
    "created_at": "2019-04-19T11:21:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422209",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>
Attachment [configure-318.tar.gz](https://github.com/sagemath/sage/files/ticket27186/configure-318.tar.gz) by @dimpase created at 2019-04-19 11:21:11



---

archive/issue_comments_422210.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,3 +3,5 @@\n Note libpng comes in a number of different ABI versions, usually indicated in the library filename as a suffix like \"12\" (for 1.2.x) up through \"16\" (for 1.6.x), where 16 is the most current and currently supported by Sage.  Distros like Debian has separate packages for each libpng ABI version.\n \n I think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.\n+\n+configure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz\n``````\n",
    "created_at": "2019-04-19T11:21:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422210",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,3 +3,5 @@
 Note libpng comes in a number of different ABI versions, usually indicated in the library filename as a suffix like "12" (for 1.2.x) up through "16" (for 1.6.x), where 16 is the most current and currently supported by Sage.  Distros like Debian has separate packages for each libpng ABI version.
 
 I think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.
+
+configure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz
``````




---

archive/issue_comments_422211.json:
```json
{
    "body": "<a id='comment:32'></a>\nI guess should have #27265 as a dependency?",
    "created_at": "2019-04-19T16:10:09Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422211",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>
I guess should have #27265 as a dependency?



---

archive/issue_comments_422212.json:
```json
{
    "body": "<a id='comment:33'></a>\nno, why? neither is a dependency of the other.",
    "created_at": "2019-04-19T16:11:30Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422212",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>
no, why? neither is a dependency of the other.



---

archive/issue_comments_422213.json:
```json
{
    "body": "<a id='comment:34'></a>\nbut there is the bloody mess with configure package versions I am complaining about, sure.",
    "created_at": "2019-04-19T16:12:31Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422213",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>
but there is the bloody mess with configure package versions I am complaining about, sure.



---

archive/issue_comments_422214.json:
```json
{
    "body": "<a id='comment:35'></a>\nonce you start depending on generated stuff, it's like crack ;-)",
    "created_at": "2019-04-19T16:14:00Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422214",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>
once you start depending on generated stuff, it's like crack ;-)



---

archive/issue_comments_422215.json:
```json
{
    "body": "<a id='comment:36'></a>\n\\\\\nWell, this branch contains the diff:\n\n```diff\ndiff --git a/build/pkgs/configure/package-version.txt b/build/pkgs/configure/package-version.txt\nindex 4dab36b..dda3451 100644\n--- a/build/pkgs/configure/package-version.txt\n+++ b/build/pkgs/configure/package-version.txt\n@@ -1 +1 @@\n-317\n+318\n```\n\nwhich to make sense I thought would need #27265, which supplies configure-317.",
    "created_at": "2019-04-19T16:28:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422215",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>
\\
Well, this branch contains the diff:

```diff
diff --git a/build/pkgs/configure/package-version.txt b/build/pkgs/configure/package-version.txt
index 4dab36b..dda3451 100644
--- a/build/pkgs/configure/package-version.txt
+++ b/build/pkgs/configure/package-version.txt
@@ -1 +1 @@
-317
+318
```

which to make sense I thought would need #27265, which supplies configure-317.



---

archive/issue_comments_422216.json:
```json
{
    "body": "<a id='comment:37'></a>\nwell, one has no control over version numbers of configure spkg. for different branches they may clash, be unrelated, etc.",
    "created_at": "2019-04-19T17:54:32Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422216",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>
well, one has no control over version numbers of configure spkg. for different branches they may clash, be unrelated, etc.



---

archive/issue_comments_422217.json:
```json
{
    "body": "<a id='comment:38'></a>\nFor that reason, if nothing else, maybe we should do like I suggested elsewhere and combine several of these together into a single ticket (once we're satisfied that they work individually).",
    "created_at": "2019-04-24T14:23:20Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422217",
    "user": "https://github.com/embray"
}
```

<a id='comment:38'></a>
For that reason, if nothing else, maybe we should do like I suggested elsewhere and combine several of these together into a single ticket (once we're satisfied that they work individually).



---

archive/issue_comments_422218.json:
```json
{
    "body": "<a id='comment:39'></a>\nsure, I'm all for it - but we need more of these actually positively reviewed ;-)",
    "created_at": "2019-04-24T15:20:35Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422218",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>
sure, I'm all for it - but we need more of these actually positively reviewed ;-)



---

archive/issue_comments_422219.json:
```json
{
    "body": "**Changing commit** from \"[1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716](https://github.com/sagemath/sagetrac-mirror/commit/1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716)\" to \"[adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)\".",
    "created_at": "2019-05-13T13:34:17Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422219",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716](https://github.com/sagemath/sagetrac-mirror/commit/1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716)" to "[adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)".



---

archive/issue_comments_422220.json:
```json
{
    "body": "<a id='comment:40'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a6e554f8755a08140b67ccad28f72d5c30d1d207\">a6e554f</a></td><td><code>spkg-configure for libpng</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc\">adc901c</a></td><td><code>don't check unneeded requirements for system libpng</code></td></tr></table>\n",
    "created_at": "2019-05-13T13:34:17Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422220",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a6e554f8755a08140b67ccad28f72d5c30d1d207">a6e554f</a></td><td><code>spkg-configure for libpng</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc">adc901c</a></td><td><code>don't check unneeded requirements for system libpng</code></td></tr></table>




---

archive/issue_comments_422221.json:
```json
{
    "body": "<a id='comment:41'></a>\nremoved configure bump and rebased over 8.8.beta5 for the ease of reviewing.",
    "created_at": "2019-05-13T13:36:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422221",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>
removed configure bump and rebased over 8.8.beta5 for the ease of reviewing.



---

archive/issue_comments_422222.json:
```json
{
    "body": "**Reviewer:** Fran\u00e7ois Bissey",
    "created_at": "2019-05-15T08:22:43Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422222",
    "user": "https://github.com/kiwifb"
}
```

**Reviewer:** Fran√ßois Bissey



---

archive/issue_events_240021.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-05-15T08:22:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240021"
}
```



---

archive/issue_events_240022.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-05-15T08:22:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240022"
}
```



---

archive/issue_comments_422223.json:
```json
{
    "body": "<a id='comment:42'></a>\nPart of series of ticket.",
    "created_at": "2019-05-15T08:22:43Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422223",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:42'></a>
Part of series of ticket.



---

archive/issue_comments_422224.json:
```json
{
    "body": "<a id='comment:43'></a>\nPlease merge together with #27825",
    "created_at": "2019-05-15T08:32:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422224",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'></a>
Please merge together with #27825



---

archive/issue_comments_422225.json:
```json
{
    "body": "<a id='comment:44'></a>\nI think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:\n\n```\nif test x$sage_spkg_install_zlib = xyes; then\n```\n\nNow, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:\n\n```\n#if ZLIB_VERNUM >= 0x1290 && \\\n   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)\n      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)\n         /* Turn off validation of the ADLER32 checksum in IDAT chunks */\n         ret = inflateValidate(&png_ptr->zstream, 0);\n#endif\n```\n\nIt's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?",
    "created_at": "2019-05-15T15:14:25Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422225",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:44'></a>
I think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:

```
if test x$sage_spkg_install_zlib = xyes; then
```

Now, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:

```
#if ZLIB_VERNUM >= 0x1290 && \
   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)
      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)
         /* Turn off validation of the ADLER32 checksum in IDAT chunks */
         ret = inflateValidate(&png_ptr->zstream, 0);
#endif
```

It's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?



---

archive/issue_comments_422226.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [mjo](#comment%3A44):\n> I think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:\n> \n> ```\n> if test x$sage_spkg_install_zlib = xyes; then\n> ```\n> \n\n`sage_spkg_install_zlib` is an internal, taking a controlled set of values.\n(`yes`, `no`, `''`, I suppose)\n\n\n> Now, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:\n> \n> ```\n> #if ZLIB_VERNUM >= 0x1290 && \\\n>    defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)\n>       if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)\n>          /* Turn off validation of the ADLER32 checksum in IDAT chunks */\n>          ret = inflateValidate(&png_ptr->zstream, 0);\n> #endif\n> ```\n> \n> It's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?\n\n\n\nWe only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it. This allows us to get away with using older versions of system's libpng/zlib, which are perfectly fine for our purposes.\n\nPS. I think it's a good example of how vendoring of everything leads to a relentless upgrading spiral (cause a vendored version gets broken on one particular system, or due to conflicts with system libraries that happens for one or another reason...)",
    "created_at": "2019-05-15T15:40:29Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422226",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:45'></a>
Replying to [mjo](#comment%3A44):
> I think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:
> 
> ```
> if test x$sage_spkg_install_zlib = xyes; then
> ```
> 

`sage_spkg_install_zlib` is an internal, taking a controlled set of values.
(`yes`, `no`, `''`, I suppose)


> Now, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:
> 
> ```
> #if ZLIB_VERNUM >= 0x1290 && \
>    defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)
>       if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)
>          /* Turn off validation of the ADLER32 checksum in IDAT chunks */
>          ret = inflateValidate(&png_ptr->zstream, 0);
> #endif
> ```
> 
> It's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?



We only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it. This allows us to get away with using older versions of system's libpng/zlib, which are perfectly fine for our purposes.

PS. I think it's a good example of how vendoring of everything leads to a relentless upgrading spiral (cause a vendored version gets broken on one particular system, or due to conflicts with system libraries that happens for one or another reason...)



---

archive/issue_comments_422227.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [dimpase](#comment%3A45):\n> We only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it.\n\n\nBut are you sure? This code is taken *from sage's libpng*:\n\n```\n#if ZLIB_VERNUM >= 0x1290 && \\\n   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)\n      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)\n         /* Turn off validation of the ADLER32 checksum in IDAT chunks */\n         ret = inflateValidate(&png_ptr->zstream, 0);\n#endif\n```\n\nand that's the only occurrence of \"inflateValidate\" in the libpng source code. Since that whole block will be ignored for old zlib, I don't think we actually need `inflateValidate` for our libpng.\n\n(inflateValidate was introduced in zlib commit 9852c209 on 2016-09-20, and ZLIB_VERNUM was set to 0x1290 in commit 2fa463bacf on 2016-12-31, so the check above in libpng should work)",
    "created_at": "2019-05-15T15:48:50Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422227",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:46'></a>
Replying to [dimpase](#comment%3A45):
> We only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it.


But are you sure? This code is taken *from sage's libpng*:

```
#if ZLIB_VERNUM >= 0x1290 && \
   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)
      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)
         /* Turn off validation of the ADLER32 checksum in IDAT chunks */
         ret = inflateValidate(&png_ptr->zstream, 0);
#endif
```

and that's the only occurrence of "inflateValidate" in the libpng source code. Since that whole block will be ignored for old zlib, I don't think we actually need `inflateValidate` for our libpng.

(inflateValidate was introduced in zlib commit 9852c209 on 2016-09-20, and ZLIB_VERNUM was set to 0x1290 in commit 2fa463bacf on 2016-12-31, so the check above in libpng should work)



---

archive/issue_comments_422228.json:
```json
{
    "body": "<a id='comment:47'></a>\nOh, I see what you're saying now, thanks.\n\nWell, assuming there is one and only zlib, so that  ZLIB_VERNUM correctly identifies the presence of `inflateValidate`, and assuming that a future libpng will not drop this version test for some reason, this test can be dropped.",
    "created_at": "2019-05-15T15:56:52Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422228",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:47'></a>
Oh, I see what you're saying now, thanks.

Well, assuming there is one and only zlib, so that  ZLIB_VERNUM correctly identifies the presence of `inflateValidate`, and assuming that a future libpng will not drop this version test for some reason, this test can be dropped.



---

archive/issue_events_240023.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-21T12:15:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240023"
}
```



---

archive/issue_events_240024.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "3e1cf317f4d9d8f10d4ac4785619830a07dd56b3",
    "created_at": "2019-05-21T12:15:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27186#event-240024"
}
```



---

archive/issue_comments_422229.json:
```json
{
    "body": "**Changing branch** from \"[u/dimpase/packages/png-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/png-config)\" to \"[adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)\".",
    "created_at": "2019-05-21T12:15:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422229",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/dimpase/packages/png-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/png-config)" to "[adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)".



---

archive/issue_comments_422230.json:
```json
{
    "body": "**Changing commit** from \"[adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)\" to \"\".",
    "created_at": "2019-07-05T07:55:01Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422230",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Changing commit** from "[adc901cdcb4ae4850a9dcc4a009add6c569903fc](https://github.com/sagemath/sagetrac-mirror/commit/adc901cdcb4ae4850a9dcc4a009add6c569903fc)" to "".



---

archive/issue_comments_422231.json:
```json
{
    "body": "<a id='comment:49'></a>\nLet me point that there is an issue with `inflateValidate` in #27319.",
    "created_at": "2019-07-05T07:55:01Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422231",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:49'></a>
Let me point that there is an issue with `inflateValidate` in #27319.



---

archive/issue_comments_422232.json:
```json
{
    "body": "<a id='comment:50'></a>\nIt appears to me that this does not work for tachyon. In tachyon's `Make-config.patch`, we do the following:\n\n```\n-USEPNG=\n-PNGINC=\n-PNGLIB=\n+USEPNG= -DUSEPNG\n+PNGINC= -I$(SAGE_LOCAL)/include\n+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng -lz\n```\n\nThis won't work if libpng's headers have not been installed to `$SAGE_LOCAL`. See [#28745 comment:33](https://github.com/sagemath/sage/issues/28745#comment:33).",
    "created_at": "2019-11-21T23:12:04Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422232",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:50'></a>
It appears to me that this does not work for tachyon. In tachyon's `Make-config.patch`, we do the following:

```
-USEPNG=
-PNGINC=
-PNGLIB=
+USEPNG= -DUSEPNG
+PNGINC= -I$(SAGE_LOCAL)/include
+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng -lz
```

This won't work if libpng's headers have not been installed to `$SAGE_LOCAL`. See [#28745 comment:33](https://github.com/sagemath/sage/issues/28745#comment:33).



---

archive/issue_comments_422233.json:
```json
{
    "body": "<a id='comment:51'></a>\nIt appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.",
    "created_at": "2019-11-21T23:14:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422233",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:51'></a>
It appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.



---

archive/issue_comments_422234.json:
```json
{
    "body": "<a id='comment:52'></a>\nwhat is \u201cnot working\u201d? it certainly is possible to use system libpng everywhere in sage.\ntachyon had to be patched a bit more, iirc, to allow this.\n\n---\nAll I did I  changed `-lpng16` to `-lpng` in `a6e554f8755`\nto accommodate variations in versions. Note that indeed if libpng is not in the default linker path, i.e. a specific `-L` argument must be supplied, then one might need to patch more...\n\nBut otherwise it works, e.g. I have\n\n```\n$ ldd local/bin/tachyon \n\tlinux-vdso.so.1 (0x00007ffc721f4000)\n\tlibpng16.so.16 => /usr/lib64/libpng16.so.16 (0x00007f0c0a62e000)\n\tlibz.so.1 => /lib64/libz.so.1 (0x00007f0c0a610000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f0c0a4d3000)\n\tlibmvec.so.1 => /lib64/libmvec.so.1 (0x00007f0c0a4a7000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007f0c0a484000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f0c0a2b4000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f0c0a716000)\n```\non Gentoo",
    "created_at": "2019-11-21T23:49:57Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422234",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:52'></a>
what is ‚Äúnot working‚Äù? it certainly is possible to use system libpng everywhere in sage.
tachyon had to be patched a bit more, iirc, to allow this.

---
All I did I  changed `-lpng16` to `-lpng` in `a6e554f8755`
to accommodate variations in versions. Note that indeed if libpng is not in the default linker path, i.e. a specific `-L` argument must be supplied, then one might need to patch more...

But otherwise it works, e.g. I have

```
$ ldd local/bin/tachyon 
	linux-vdso.so.1 (0x00007ffc721f4000)
	libpng16.so.16 => /usr/lib64/libpng16.so.16 (0x00007f0c0a62e000)
	libz.so.1 => /lib64/libz.so.1 (0x00007f0c0a610000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f0c0a4d3000)
	libmvec.so.1 => /lib64/libmvec.so.1 (0x00007f0c0a4a7000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f0c0a484000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f0c0a2b4000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f0c0a716000)
```
on Gentoo



---

archive/issue_comments_422235.json:
```json
{
    "body": "<a id='comment:53'></a>\nReplying to [saraedum](#comment%3A51):\n> It appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.\n\n\nright. It's quite a mess indeed.",
    "created_at": "2019-11-22T00:05:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27186#issuecomment-422235",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:53'></a>
Replying to [saraedum](#comment%3A51):
> It appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.


right. It's quite a mess indeed.
