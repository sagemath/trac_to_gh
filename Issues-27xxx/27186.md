# Issue 27186: spkg-configure.m4 for libpng

archive/issues_026949.json:
```json
{
    "body": "Also should be done for #27168\n\nNote libpng comes in a number of different ABI versions, usually indicated in the library filename as a suffix like \"12\" (for 1.2.x) up through \"16\" (for 1.6.x), where 16 is the most current and currently supported by Sage.  Distros like Debian has separate packages for each libpng ABI version.\n\nI think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.\n\nconfigure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz\n\nCC:  @kiwifb\n\nKeywords: spkg-configure\n\nReviewer: Fran\u00e7ois Bissey\n\nAuthor: Dima Pasechnik\n\nBranch: adc901cdcb4ae4850a9dcc4a009add6c569903fc\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27186\n\n",
    "closed_at": "2019-05-21T12:15:55Z",
    "created_at": "2019-01-31T14:10:58Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "spkg-configure.m4 for libpng",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27186",
    "user": "https://github.com/embray"
}
```
Also should be done for #27168

Note libpng comes in a number of different ABI versions, usually indicated in the library filename as a suffix like "12" (for 1.2.x) up through "16" (for 1.6.x), where 16 is the most current and currently supported by Sage.  Distros like Debian has separate packages for each libpng ABI version.

I think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.

configure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz

CC:  @kiwifb

Keywords: spkg-configure

Reviewer: François Bissey

Author: Dima Pasechnik

Branch: adc901cdcb4ae4850a9dcc4a009add6c569903fc

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27186





---

archive/issue_comments_522987.json:
```json
{
    "body": "<a id='comment:1'></a>That said, my Ubuntu build machine has a kinda old libpng12, and while I'm not saying we *should* support that, I'm curious to see if it will work...",
    "created_at": "2019-01-31T14:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522987",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>That said, my Ubuntu build machine has a kinda old libpng12, and while I'm not saying we *should* support that, I'm curious to see if it will work...



---

archive/issue_comments_522988.json:
```json
{
    "body": "<a id='comment:2'></a>Also, we should probably not use the system libpng at all on OSX (unless in homebrew or something, but I don't know if we explicitly support that yet...)",
    "created_at": "2019-01-31T14:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522988",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Also, we should probably not use the system libpng at all on OSX (unless in homebrew or something, but I don't know if we explicitly support that yet...)



---

archive/issue_comments_522989.json:
```json
{
    "body": "<a id='comment:3'></a>What's wrong with OSX's system libpng?",
    "created_at": "2019-01-31T14:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522989",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>What's wrong with OSX's system libpng?



---

archive/issue_comments_522990.json:
```json
{
    "body": "<a id='comment:4'></a>It's unusable.  See the SPKG.txt for libpng.",
    "created_at": "2019-01-31T14:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522990",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>It's unusable.  See the SPKG.txt for libpng.



---

archive/issue_comments_522991.json:
```json
{
    "body": "<a id='comment:5'></a>Okay, at least on my Ubuntu 14.04 machine libpng 1.2 worked just fine actually.  Did a full `make ptestlong` from scratch.  Nothing complained.  So maybe we can afford a bit more flexibility here.",
    "created_at": "2019-01-31T16:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522991",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Okay, at least on my Ubuntu 14.04 machine libpng 1.2 worked just fine actually.  Did a full `make ptestlong` from scratch.  Nothing complained.  So maybe we can afford a bit more flexibility here.



---

archive/issue_comments_522992.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 embray]:\n> It's unusable.  See the SPKG.txt for libpng.\n\n\nI don't read it this way. I read it as \"it won't conflict with the one built by Sage\".\nWell, maybe I am wrong - it's perhaps worth trying on OSX.",
    "created_at": "2019-01-31T16:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522992",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>Replying to [comment:4 embray]:
> It's unusable.  See the SPKG.txt for libpng.


I don't read it this way. I read it as "it won't conflict with the one built by Sage".
Well, maybe I am wrong - it's perhaps worth trying on OSX.



---

archive/issue_comments_522993.json:
```json
{
    "body": "<a id='comment:7'></a>I think you are misreading.  The point is that if you just blindly link `-lpng` on OSX without an alternative libpng on the linker path you'll get the `libPng.dylib` used by the system which is not compatible with anything we build that wants to link with libpng.\n\nOne workaround is to explicitly ask for one of the ABI-specific names like `-lpng12` or `-lpng16`, at least on OSX.  That way you might be able to pick up, say, a version from homebrew, but you won't accidentally link to the unusable OSX system lib.",
    "created_at": "2019-01-31T16:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522993",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>I think you are misreading.  The point is that if you just blindly link `-lpng` on OSX without an alternative libpng on the linker path you'll get the `libPng.dylib` used by the system which is not compatible with anything we build that wants to link with libpng.

One workaround is to explicitly ask for one of the ABI-specific names like `-lpng12` or `-lpng16`, at least on OSX.  That way you might be able to pick up, say, a version from homebrew, but you won't accidentally link to the unusable OSX system lib.



---

archive/issue_comments_522994.json:
```json
{
    "body": "<a id='comment:8'></a>Although I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.",
    "created_at": "2019-01-31T16:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522994",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Although I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.



---

archive/issue_comments_522995.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 embray]:\n> Although I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.\n\n\nThis still sounds as if using system's libPng would lead to various library conflicts (with other Sage-installed versions of stuff also available on the system), i.e. if we go far enough with our plan it would not matter...\n\nAnyhow, I just checked that Homebrew also does not use system's libPng, but installs its own libpng16.dylib.\n\nOne way or another, I think we should not block the usage of Homebrew (or conda) libs, i.e. there should not be a rule saying \"we're on OSX! install from source\").\n\nPS. Last time I checked (few months ago), it's possible to build and run Sage under Homebrew. Basically, it's an environment where lots of stuff lives in /usr/local...",
    "created_at": "2019-01-31T17:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522995",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>Replying to [comment:8 embray]:
> Although I may also be misreading some too.  ISTM the libPng.dylib on OSX only comes from the ImageIO framework, whatever that is, so I don't know if it on the linker path by default in the first place.  The problem is just that we can't use the SONAME (or whatever the OSX equivalent is) of libpng when linking modules in our own packages because then it will conflict with anything that uses the ImageIO framework.  This goes to show how little I understand about OSX.


This still sounds as if using system's libPng would lead to various library conflicts (with other Sage-installed versions of stuff also available on the system), i.e. if we go far enough with our plan it would not matter...

Anyhow, I just checked that Homebrew also does not use system's libPng, but installs its own libpng16.dylib.

One way or another, I think we should not block the usage of Homebrew (or conda) libs, i.e. there should not be a rule saying "we're on OSX! install from source").

PS. Last time I checked (few months ago), it's possible to build and run Sage under Homebrew. Basically, it's an environment where lots of stuff lives in /usr/local...



---

archive/issue_comments_522996.json:
```json
{
    "body": "<a id='comment:10'></a>Volker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?",
    "created_at": "2019-01-31T17:13:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522996",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>Volker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?



---

archive/issue_comments_522997.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 embray]:\n> Volker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?\n\n\nNot since 2010 or so, I guess :-)",
    "created_at": "2019-01-31T17:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522997",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>Replying to [comment:10 embray]:
> Volker's OSX buildbot also has a libpng16 that lives in the `/opt/X11` prefix, but I don't think that's a normal thing to have...  OSX doesn't normally have an X installed, does it?


Not since 2010 or so, I guess :-)



---

archive/issue_comments_522998.json:
```json
{
    "body": "<a id='comment:12'></a>the following works:\n\n```bash\nSAGE_SPKG_CONFIGURE([libpng], [\n    dnl First try checking for libpng with pkg-config\n    PKG_CHECK_MODULES([LIBPNG], [libpng16], [], [\n        dnl Fallback to manually grubbing around for headers and libs\n        AC_CHECK_HEADERS([libpng16/png.h], [sage_spkg_install_libpng=no; break], [sage_spkg_install_libpng=yes])\n        AC_SEARCH_LIBS([png_get_io_ptr], [libpng16], [], [sage_spkg_install_libpng=yes])\n    ])\n])\n```",
    "created_at": "2019-02-09T00:21:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522998",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>the following works:

```bash
SAGE_SPKG_CONFIGURE([libpng], [
    dnl First try checking for libpng with pkg-config
    PKG_CHECK_MODULES([LIBPNG], [libpng16], [], [
        dnl Fallback to manually grubbing around for headers and libs
        AC_CHECK_HEADERS([libpng16/png.h], [sage_spkg_install_libpng=no; break], [sage_spkg_install_libpng=yes])
        AC_SEARCH_LIBS([png_get_io_ptr], [libpng16], [], [sage_spkg_install_libpng=yes])
    ])
])
```



---

archive/issue_comments_522999.json:
```json
{
    "body": "Changing keywords from \"\" to \"spkg-configure\".",
    "created_at": "2019-02-12T09:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-522999",
    "user": "https://github.com/dimpase"
}
```

Changing keywords from "" to "spkg-configure".



---

archive/issue_comments_523000.json:
```json
{
    "body": "<a id='comment:14'></a>I found that there is no reason to require libpng16 specifically (unless I'm wrong / there is some optional package I'm missing that requires a newer version)?\n\nI was thinking we might do something pretty similar to this, but instead of *just* `libpng16` we would check first for `libpng16`, and if not found try `libpng14`, then `libpng12`, and then just plain `libpng` (except on macOS where that conflicts with the system's incompatible \"libPng\").",
    "created_at": "2019-02-12T10:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523000",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>I found that there is no reason to require libpng16 specifically (unless I'm wrong / there is some optional package I'm missing that requires a newer version)?

I was thinking we might do something pretty similar to this, but instead of *just* `libpng16` we would check first for `libpng16`, and if not found try `libpng14`, then `libpng12`, and then just plain `libpng` (except on macOS where that conflicts with the system's incompatible "libPng").



---

archive/issue_comments_523001.json:
```json
{
    "body": "<a id='comment:15'></a>If that overcomplicates things though, the above is fine.  libpng just tends to be problematic, so I thought it would be good to be flexible in which versions we accept so long as there is no explicit need for 1.6.",
    "created_at": "2019-02-12T10:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523001",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>If that overcomplicates things though, the above is fine.  libpng just tends to be problematic, so I thought it would be good to be flexible in which versions we accept so long as there is no explicit need for 1.6.



---

archive/issue_comments_523002.json:
```json
{
    "body": "<a id='comment:16'></a>in `build/pkgs/tachyon/patches/Make-config.patch` you see\n\n```\n+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng16 -lz\n-#PNGLIB= -L/usr/local/lib -lpng -lz\n```\nIt suggests that libpng16 is needed.",
    "created_at": "2019-02-12T10:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523002",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>in `build/pkgs/tachyon/patches/Make-config.patch` you see

```
+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng16 -lz
-#PNGLIB= -L/usr/local/lib -lpng -lz
```
It suggests that libpng16 is needed.



---

archive/issue_comments_523003.json:
```json
{
    "body": "<a id='comment:17'></a>I don't think so: This patch was made because the libpng package in Sage delete the normal `libpng.so -> libpng16.so` symlink that is installed, specifically so as to not conflict with the macOS \"libPng\", but in turn that means that if you compile tachyon in Sage you have to specify `-lpng16`, since `-lpng` does not exist in Sage's lib directory.\n\nI don't think it has to be libpng16 specifically; that patch just specifies `-lpng16` because that's what's in Sage.  I was able to replace this with `-lpng12` and it worked fine.",
    "created_at": "2019-02-12T10:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523003",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>I don't think so: This patch was made because the libpng package in Sage delete the normal `libpng.so -> libpng16.so` symlink that is installed, specifically so as to not conflict with the macOS "libPng", but in turn that means that if you compile tachyon in Sage you have to specify `-lpng16`, since `-lpng` does not exist in Sage's lib directory.

I don't think it has to be libpng16 specifically; that patch just specifies `-lpng16` because that's what's in Sage.  I was able to replace this with `-lpng12` and it worked fine.



---

archive/issue_comments_523004.json:
```json
{
    "body": "<a id='comment:18'></a>Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.",
    "created_at": "2019-03-25T10:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523004",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.



---

archive/issue_events_067488.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:44:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27186#event-67488"
}
```



---

archive/issue_comments_523005.json:
```json
{
    "body": "<a id='comment:19'></a>I looked a bit into OSX libPng, and I see no trace of it on OSX 10.14.\nSo it's probably quite obsolete into in libpng's SPKG.",
    "created_at": "2019-04-14T23:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523005",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>I looked a bit into OSX libPng, and I see no trace of it on OSX 10.14.
So it's probably quite obsolete into in libpng's SPKG.



---

archive/issue_comments_523006.json:
```json
{
    "body": "Changing author from \"\" to \"Dima Pasechnik\"",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523006",
    "user": "https://github.com/dimpase"
}
```

Changing author from "" to "Dima Pasechnik"



---

archive/issue_events_067489.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-15T07:33:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27186#event-67489"
}
```



---

archive/issue_events_067490.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-04-15T07:33:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27186#event-67490"
}
```



---

archive/issue_comments_523007.json:
```json
{
    "body": "Changing branch from \"\" to \"u/dimpase/packages/png-config\"",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523007",
    "user": "https://github.com/dimpase"
}
```

Changing branch from "" to "u/dimpase/packages/png-config"



---

archive/issue_comments_523008.json:
```json
{
    "body": "Changing commit from \"\" to \"590b3833197f436d1e6fec95916d32527e373ec6\"",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523008",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "" to "590b3833197f436d1e6fec95916d32527e373ec6"



---

archive/issue_comments_523009.json:
```json
{
    "body": "<a id='comment:20'></a>New commits:",
    "created_at": "2019-04-15T07:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523009",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>New commits:



---

archive/issue_comments_523010.json:
```json
{
    "body": "<a id='comment:21'></a>I need to re-review this, but I'm okay with just throwing my hands up and saying to hell with OSX.  If there *is* still an issue we'll find out, and now that we have `--without-system-libpng` at least there's a workaround in place.",
    "created_at": "2019-04-15T16:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523010",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>I need to re-review this, but I'm okay with just throwing my hands up and saying to hell with OSX.  If there *is* still an issue we'll find out, and now that we have `--without-system-libpng` at least there's a workaround in place.



---

archive/issue_comments_523011.json:
```json
{
    "body": "<a id='comment:22'></a>I think Apple's library won't be known to pkg-config, and then AC_SEARCH_LIBS would filter it out. Anyhow it's probably only some post-EOL OSX versions that might potentially be problematic...",
    "created_at": "2019-04-15T18:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523011",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>I think Apple's library won't be known to pkg-config, and then AC_SEARCH_LIBS would filter it out. Anyhow it's probably only some post-EOL OSX versions that might potentially be problematic...



---

archive/issue_comments_523012.json:
```json
{
    "body": "Changing commit from \"590b3833197f436d1e6fec95916d32527e373ec6\" to \"cce4eef79a3e6f40f45d385ea754ad50f9d2de88\"",
    "created_at": "2019-04-15T20:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523012",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "590b3833197f436d1e6fec95916d32527e373ec6" to "cce4eef79a3e6f40f45d385ea754ad50f9d2de88"



---

archive/issue_comments_523013.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-15T20:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523013",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_523014.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-15T20:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523014",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_523015.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-15T20:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_523016.json:
```json
{
    "body": "Changing commit from \"cce4eef79a3e6f40f45d385ea754ad50f9d2de88\" to \"4e9fca1dd163c19116521bffce526f57162b35a9\"",
    "created_at": "2019-04-15T20:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523016",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cce4eef79a3e6f40f45d385ea754ad50f9d2de88" to "4e9fca1dd163c19116521bffce526f57162b35a9"



---

archive/issue_comments_523017.json:
```json
{
    "body": "<a id='comment:26'></a>we also need to check that zlib, the dependency, comes from the system.",
    "created_at": "2019-04-15T20:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523017",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>we also need to check that zlib, the dependency, comes from the system.



---

archive/issue_comments_523018.json:
```json
{
    "body": "<a id='comment:27'></a>but zlib does not need to satisfy the requirements for Sages's libpng.",
    "created_at": "2019-04-16T08:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523018",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>but zlib does not need to satisfy the requirements for Sages's libpng.



---

archive/issue_comments_523019.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-04-16T08:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523019",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_523020.json:
```json
{
    "body": "Changing commit from \"4e9fca1dd163c19116521bffce526f57162b35a9\" to \"2f5aaa77a5e880069733d2dbd4db9b3b696f6e48\"",
    "created_at": "2019-04-16T16:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523020",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4e9fca1dd163c19116521bffce526f57162b35a9" to "2f5aaa77a5e880069733d2dbd4db9b3b696f6e48"



---

archive/issue_comments_523021.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-16T16:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523021",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_523022.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-04-16T16:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523022",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_523023.json:
```json
{
    "body": "<a id='comment:29'></a>now we do not try to check for unneeded new functionality in zlib for older libpng's",
    "created_at": "2019-04-16T16:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523023",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>now we do not try to check for unneeded new functionality in zlib for older libpng's



---

archive/issue_comments_523024.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-19T11:19:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_523025.json:
```json
{
    "body": "Changing commit from \"2f5aaa77a5e880069733d2dbd4db9b3b696f6e48\" to \"1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716\"",
    "created_at": "2019-04-19T11:19:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523025",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2f5aaa77a5e880069733d2dbd4db9b3b696f6e48" to "1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716"



---

archive/issue_comments_523026.json:
```json
{
    "body": "updated configure spkg",
    "created_at": "2019-04-19T11:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523026",
    "user": "https://github.com/dimpase"
}
```

updated configure spkg



---

archive/issue_comments_523027.json:
```json
{
    "body": "<a id='comment:31'></a>Attachment [configure-318.tar.gz](tarball://root/attachments/some-uuid/ticket27186/configure-318.tar.gz) by @dimpase created at 2019-04-19 11:21:11",
    "created_at": "2019-04-19T11:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523027",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>Attachment [configure-318.tar.gz](tarball://root/attachments/some-uuid/ticket27186/configure-318.tar.gz) by @dimpase created at 2019-04-19 11:21:11



---

archive/issue_comments_523028.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,6 +4,8 @@\n \n I think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.\n \n+configure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/27186\n``````\n",
    "created_at": "2019-04-19T11:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523028",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,6 +4,8 @@
 
 I think to keep it simple we should specifically check for and require libpng16.  I don't know if all of Sage's dependencies support older libpngs.
 
+configure tarball: https://trac.sagemath.org/raw-attachment/ticket/27186/configure-318.tar.gz
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/27186
``````




---

archive/issue_comments_523029.json:
```json
{
    "body": "<a id='comment:32'></a>I guess should have #27265 as a dependency?",
    "created_at": "2019-04-19T16:10:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523029",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>I guess should have #27265 as a dependency?



---

archive/issue_comments_523030.json:
```json
{
    "body": "<a id='comment:33'></a>no, why? neither is a dependency of the other.",
    "created_at": "2019-04-19T16:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523030",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>no, why? neither is a dependency of the other.



---

archive/issue_comments_523031.json:
```json
{
    "body": "<a id='comment:34'></a>but there is the bloody mess with configure package versions I am complaining about, sure.",
    "created_at": "2019-04-19T16:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523031",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>but there is the bloody mess with configure package versions I am complaining about, sure.



---

archive/issue_comments_523032.json:
```json
{
    "body": "<a id='comment:35'></a>once you start depending on generated stuff, it's like crack ;-)",
    "created_at": "2019-04-19T16:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523032",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>once you start depending on generated stuff, it's like crack ;-)



---

archive/issue_comments_523033.json:
```json
{
    "body": "<a id='comment:36'></a>\\\\\nWell, this branch contains the diff:\n\n```diff\ndiff --git a/build/pkgs/configure/package-version.txt b/build/pkgs/configure/package-version.txt\nindex 4dab36b..dda3451 100644\n--- a/build/pkgs/configure/package-version.txt\n+++ b/build/pkgs/configure/package-version.txt\n@@ -1 +1 @@\n-317\n+318\n```\n\nwhich to make sense I thought would need #27265, which supplies configure-317.",
    "created_at": "2019-04-19T16:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523033",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>\\
Well, this branch contains the diff:

```diff
diff --git a/build/pkgs/configure/package-version.txt b/build/pkgs/configure/package-version.txt
index 4dab36b..dda3451 100644
--- a/build/pkgs/configure/package-version.txt
+++ b/build/pkgs/configure/package-version.txt
@@ -1 +1 @@
-317
+318
```

which to make sense I thought would need #27265, which supplies configure-317.



---

archive/issue_comments_523034.json:
```json
{
    "body": "<a id='comment:37'></a>well, one has no control over version numbers of configure spkg. for different branches they may clash, be unrelated, etc.",
    "created_at": "2019-04-19T17:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523034",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>well, one has no control over version numbers of configure spkg. for different branches they may clash, be unrelated, etc.



---

archive/issue_comments_523035.json:
```json
{
    "body": "<a id='comment:38'></a>For that reason, if nothing else, maybe we should do like I suggested elsewhere and combine several of these together into a single ticket (once we're satisfied that they work individually).",
    "created_at": "2019-04-24T14:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523035",
    "user": "https://github.com/embray"
}
```

<a id='comment:38'></a>For that reason, if nothing else, maybe we should do like I suggested elsewhere and combine several of these together into a single ticket (once we're satisfied that they work individually).



---

archive/issue_comments_523036.json:
```json
{
    "body": "<a id='comment:39'></a>sure, I'm all for it - but we need more of these actually positively reviewed ;-)",
    "created_at": "2019-04-24T15:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523036",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>sure, I'm all for it - but we need more of these actually positively reviewed ;-)



---

archive/issue_comments_523037.json:
```json
{
    "body": "Changing commit from \"1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716\" to \"adc901cdcb4ae4850a9dcc4a009add6c569903fc\"",
    "created_at": "2019-05-13T13:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523037",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1e8b1a23a0316eb3d34e7c7a80fc6b95f054d716" to "adc901cdcb4ae4850a9dcc4a009add6c569903fc"



---

archive/issue_comments_523038.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-05-13T13:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523038",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_523039.json:
```json
{
    "body": "<a id='comment:41'></a>removed configure bump and rebased over 8.8.beta5 for the ease of reviewing.",
    "created_at": "2019-05-13T13:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523039",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>removed configure bump and rebased over 8.8.beta5 for the ease of reviewing.



---

archive/issue_comments_523040.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fran\u00e7ois Bissey\"",
    "created_at": "2019-05-15T08:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523040",
    "user": "https://github.com/kiwifb"
}
```

Changing reviewer from "" to "François Bissey"



---

archive/issue_comments_523041.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-15T08:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523041",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_523042.json:
```json
{
    "body": "<a id='comment:42'></a>Part of series of ticket.",
    "created_at": "2019-05-15T08:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523042",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:42'></a>Part of series of ticket.



---

archive/issue_comments_523043.json:
```json
{
    "body": "<a id='comment:43'></a>Please merge together with #27825",
    "created_at": "2019-05-15T08:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523043",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'></a>Please merge together with #27825



---

archive/issue_comments_523044.json:
```json
{
    "body": "<a id='comment:44'></a>I think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:\n\n```\nif test x$sage_spkg_install_zlib = xyes; then\n```\n\nNow, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:\n\n```\n#if ZLIB_VERNUM >= 0x1290 && \\\n   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)\n      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)\n         /* Turn off validation of the ADLER32 checksum in IDAT chunks */\n         ret = inflateValidate(&png_ptr->zstream, 0);\n#endif\n```\n\nIt's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?",
    "created_at": "2019-05-15T15:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523044",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:44'></a>I think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:

```
if test x$sage_spkg_install_zlib = xyes; then
```

Now, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:

```
#if ZLIB_VERNUM >= 0x1290 && \
   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)
      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)
         /* Turn off validation of the ADLER32 checksum in IDAT chunks */
         ret = inflateValidate(&png_ptr->zstream, 0);
#endif
```

It's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?



---

archive/issue_comments_523045.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:44 mjo]:\n> I think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:\n> \n> \n> ```\n> if test x$sage_spkg_install_zlib = xyes; then\n> ```\n> \n\n`sage_spkg_install_zlib` is an internal, taking a controlled set of values.\n(`yes`, `no`, `''`, I suppose)\n\n\n> Now, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:\n> \n> \n> ```\n> #if ZLIB_VERNUM >= 0x1290 && \\\n>    defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)\n>       if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)\n>          /* Turn off validation of the ADLER32 checksum in IDAT chunks */\n>          ret = inflateValidate(&png_ptr->zstream, 0);\n> #endif\n> ```\n> \n> It's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?\n\n\n\nWe only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it. This allows us to get away with using older versions of system's libpng/zlib, which are perfectly fine for our purposes.\n\nPS. I think it's a good example of how vendoring of everything leads to a relentless upgrading spiral (cause a vendored version gets broken on one particular system, or due to conflicts with system libraries that happens for one or another reason...)",
    "created_at": "2019-05-15T15:40:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523045",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:45'></a>Replying to [comment:44 mjo]:
> I think the zlib <-> libpng stuff here could still be improved. First, trivia; this should be quoted to avoid syntax errors if the variable has a space in it:
> 
> 
> ```
> if test x$sage_spkg_install_zlib = xyes; then
> ```
> 

`sage_spkg_install_zlib` is an internal, taking a controlled set of values.
(`yes`, `no`, `''`, I suppose)


> Now, the only reason we're checking for `inflateValidate` in zlib is for the benefit of libpng, correct? Because the only place `inflateValidate` is used in our copy of libpng is the following, in `pngrutil.c`:
> 
> 
> ```
> #if ZLIB_VERNUM >= 0x1290 && \
>    defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)
>       if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)
>          /* Turn off validation of the ADLER32 checksum in IDAT chunks */
>          ret = inflateValidate(&png_ptr->zstream, 0);
> #endif
> ```
> 
> It's wrapped in a zlib version check, so... does anything bad happen if we simply ignore the matter? That is, drop the `inflateValidate` check from the zlib macro, and eliminate the libpng <-> zlib weirdness as a bonus?



We only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it. This allows us to get away with using older versions of system's libpng/zlib, which are perfectly fine for our purposes.

PS. I think it's a good example of how vendoring of everything leads to a relentless upgrading spiral (cause a vendored version gets broken on one particular system, or due to conflicts with system libraries that happens for one or another reason...)



---

archive/issue_comments_523046.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:45 dimpase]:\n> We only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it.\n\n\nBut are you sure? This code is taken *from sage's libpng*:\n\n```\n#if ZLIB_VERNUM >= 0x1290 && \\\n   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)\n      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)\n         /* Turn off validation of the ADLER32 checksum in IDAT chunks */\n         ret = inflateValidate(&png_ptr->zstream, 0);\n#endif\n```\n\nand that's the only occurrence of \"inflateValidate\" in the libpng source code. Since that whole block will be ignored for old zlib, I don't think we actually need `inflateValidate` for our libpng.\n\n(inflateValidate was introduced in zlib commit 9852c209 on 2016-09-20, and ZLIB_VERNUM was set to 0x1290 in commit 2fa463bacf on 2016-12-31, so the check above in libpng should work)",
    "created_at": "2019-05-15T15:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523046",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:46'></a>Replying to [comment:45 dimpase]:
> We only check for `inflateValidate` in system's zlib if we cannot use the system's libpng. In this case we need it, as Sage's libpng requires it.


But are you sure? This code is taken *from sage's libpng*:

```
#if ZLIB_VERNUM >= 0x1290 && \
   defined(PNG_SET_OPTION_SUPPORTED) && defined(PNG_IGNORE_ADLER32)
      if (((png_ptr->options >> PNG_IGNORE_ADLER32) & 3) == PNG_OPTION_ON)
         /* Turn off validation of the ADLER32 checksum in IDAT chunks */
         ret = inflateValidate(&png_ptr->zstream, 0);
#endif
```

and that's the only occurrence of "inflateValidate" in the libpng source code. Since that whole block will be ignored for old zlib, I don't think we actually need `inflateValidate` for our libpng.

(inflateValidate was introduced in zlib commit 9852c209 on 2016-09-20, and ZLIB_VERNUM was set to 0x1290 in commit 2fa463bacf on 2016-12-31, so the check above in libpng should work)



---

archive/issue_comments_523047.json:
```json
{
    "body": "<a id='comment:47'></a>Oh, I see what you're saying now, thanks.\n\nWell, assuming there is one and only zlib, so that  ZLIB_VERNUM correctly identifies the presence of `inflateValidate`, and assuming that a future libpng will not drop this version test for some reason, this test can be dropped.",
    "created_at": "2019-05-15T15:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523047",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:47'></a>Oh, I see what you're saying now, thanks.

Well, assuming there is one and only zlib, so that  ZLIB_VERNUM correctly identifies the presence of `inflateValidate`, and assuming that a future libpng will not drop this version test for some reason, this test can be dropped.



---

archive/issue_events_067491.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-21T12:15:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27186#event-67491"
}
```



---

archive/issue_comments_523048.json:
```json
{
    "body": "Changing branch from \"u/dimpase/packages/png-config\" to \"adc901cdcb4ae4850a9dcc4a009add6c569903fc\"",
    "created_at": "2019-05-21T12:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523048",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/dimpase/packages/png-config" to "adc901cdcb4ae4850a9dcc4a009add6c569903fc"



---

archive/issue_comments_523049.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-21T12:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523049",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_523050.json:
```json
{
    "body": "Changing commit from \"adc901cdcb4ae4850a9dcc4a009add6c569903fc\" to \"\"",
    "created_at": "2019-07-05T07:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523050",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing commit from "adc901cdcb4ae4850a9dcc4a009add6c569903fc" to ""



---

archive/issue_comments_523051.json:
```json
{
    "body": "<a id='comment:49'></a>Let me point that there is an issue with `inflateValidate` in #27319.",
    "created_at": "2019-07-05T07:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523051",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:49'></a>Let me point that there is an issue with `inflateValidate` in #27319.



---

archive/issue_comments_523052.json:
```json
{
    "body": "<a id='comment:50'></a>It appears to me that this does not work for tachyon. In tachyon's `Make-config.patch`, we do the following:\n\n```\n-USEPNG=\n-PNGINC=\n-PNGLIB=\n+USEPNG= -DUSEPNG\n+PNGINC= -I$(SAGE_LOCAL)/include\n+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng -lz\n```\n\nThis won't work if libpng's headers have not been installed to `$SAGE_LOCAL`. See #28745#comment:33.",
    "created_at": "2019-11-21T23:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523052",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:50'></a>It appears to me that this does not work for tachyon. In tachyon's `Make-config.patch`, we do the following:

```
-USEPNG=
-PNGINC=
-PNGLIB=
+USEPNG= -DUSEPNG
+PNGINC= -I$(SAGE_LOCAL)/include
+PNGLIB= -L$(SAGE_LOCAL)/lib -lpng -lz
```

This won't work if libpng's headers have not been installed to `$SAGE_LOCAL`. See #28745#comment:33.



---

archive/issue_comments_523053.json:
```json
{
    "body": "<a id='comment:51'></a>It appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.",
    "created_at": "2019-11-21T23:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523053",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:51'></a>It appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.



---

archive/issue_comments_523054.json:
```json
{
    "body": "<a id='comment:52'></a>what is \u201cnot working\u201d? it certainly is possible to use system libpng everywhere in sage.\ntachyon had to be patched a bit more, iirc, to allow this.\n\n---\nAll I did I  changed `-lpng16` to `-lpng` in `a6e554f8755`\nto accommodate variations in versions. Note that indeed if libpng is not in the default linker path, i.e. a specific `-L` argument must be supplied, then one might need to patch more...\n\nBut otherwise it works, e.g. I have\n\n```\n$ ldd local/bin/tachyon \n\tlinux-vdso.so.1 (0x00007ffc721f4000)\n\tlibpng16.so.16 => /usr/lib64/libpng16.so.16 (0x00007f0c0a62e000)\n\tlibz.so.1 => /lib64/libz.so.1 (0x00007f0c0a610000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f0c0a4d3000)\n\tlibmvec.so.1 => /lib64/libmvec.so.1 (0x00007f0c0a4a7000)\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007f0c0a484000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f0c0a2b4000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f0c0a716000)\n```\non Gentoo",
    "created_at": "2019-11-21T23:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523054",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:52'></a>what is “not working”? it certainly is possible to use system libpng everywhere in sage.
tachyon had to be patched a bit more, iirc, to allow this.

---
All I did I  changed `-lpng16` to `-lpng` in `a6e554f8755`
to accommodate variations in versions. Note that indeed if libpng is not in the default linker path, i.e. a specific `-L` argument must be supplied, then one might need to patch more...

But otherwise it works, e.g. I have

```
$ ldd local/bin/tachyon 
	linux-vdso.so.1 (0x00007ffc721f4000)
	libpng16.so.16 => /usr/lib64/libpng16.so.16 (0x00007f0c0a62e000)
	libz.so.1 => /lib64/libz.so.1 (0x00007f0c0a610000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f0c0a4d3000)
	libmvec.so.1 => /lib64/libmvec.so.1 (0x00007f0c0a4a7000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f0c0a484000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f0c0a2b4000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f0c0a716000)
```
on Gentoo



---

archive/issue_comments_523055.json:
```json
{
    "body": "<a id='comment:53'></a>Replying to [comment:51 saraedum]:\n> It appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.\n\n\nright. It's quite a mess indeed.",
    "created_at": "2019-11-22T00:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27186",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27186#issuecomment-523055",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:53'></a>Replying to [comment:51 saraedum]:
> It appears that tachyon is ignoring the CFLAGS that were used when ./configure ran.


right. It's quite a mess indeed.
