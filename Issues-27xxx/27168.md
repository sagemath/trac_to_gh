# Issue 27168: spkg-configure.m4 for freetype

archive/issues_026931.json:
```json
{
    "body": "It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.\n\nTicket closed as duplicate after the corresponding changes were integrated in #27825.\n\nCC:  @embray @mkoeppe @orlitzky\n\nKeywords: spkg-configure freetype\n\nReviewer: Fran\u00e7ois Bissey, Erik Bray\n\nAuthor: Dima Pasechnik\n\nBranch: public/packages/freetype-config\n\nDependencies: #27186\n\nCommit: 8b2cf94e4d041d0bbe4d27bf98af5c7dbbed1c59\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/27168\n\n",
    "closed_at": "2019-07-05T07:52:59Z",
    "created_at": "2019-01-29T16:54:06Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "spkg-configure.m4 for freetype",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27168",
    "user": "https://github.com/dimpase"
}
```
It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.

Ticket closed as duplicate after the corresponding changes were integrated in #27825.

CC:  @embray @mkoeppe @orlitzky

Keywords: spkg-configure freetype

Reviewer: Fran√ßois Bissey, Erik Bray

Author: Dima Pasechnik

Branch: public/packages/freetype-config

Dependencies: #27186

Commit: 8b2cf94e4d041d0bbe4d27bf98af5c7dbbed1c59

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/27168





---

archive/issue_comments_403458.json:
```json
{
    "body": "<a id='comment:1'></a>I think we already have a generic ticket about this, so let's have this one just focus specifically on freetype.",
    "created_at": "2019-01-29T16:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403458",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>I think we already have a generic ticket about this, so let's have this one just focus specifically on freetype.



---

archive/issue_comments_403459.json:
```json
{
    "body": "<a id='comment:2'></a>Perhaps of interest, from cairo's own `configure.ac`: https://cgit.freedesktop.org/cairo/tree/configure.ac#n489\n\nWe can probably reuse much of this.",
    "created_at": "2019-01-29T17:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403459",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Perhaps of interest, from cairo's own `configure.ac`: https://cgit.freedesktop.org/cairo/tree/configure.ac#n489

We can probably reuse much of this.



---

archive/issue_comments_403460.json:
```json
{
    "body": "<a id='comment:3'></a>I actually do not know how to deal with freetype's deps: bzip2, libpng (and zlib - not explicitly listed, but a dep of libpng).\n\nNaturally, if we have to build any of these, we cannot use a system's freetype.\n\nWhich brings up the need for a proper dependencies resolver, and raises the question whether we are doing all this right. \n\nIMHO a better plan would be to spin off some, and then all,\nnon-python deps of Sage into a separate (auto-tools) project/package, which builds and installs them into SAGE_LOCAL (just the autotools `--prefix` parameter).\nThis would allow this to be gradual, once the initial setup, with just a handful already `spkg-configure.m4`-ed packages spun off.\nThe advantage is that the dependency resolution would be a natural top-down thing.",
    "created_at": "2019-01-30T10:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403460",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>I actually do not know how to deal with freetype's deps: bzip2, libpng (and zlib - not explicitly listed, but a dep of libpng).

Naturally, if we have to build any of these, we cannot use a system's freetype.

Which brings up the need for a proper dependencies resolver, and raises the question whether we are doing all this right. 

IMHO a better plan would be to spin off some, and then all,
non-python deps of Sage into a separate (auto-tools) project/package, which builds and installs them into SAGE_LOCAL (just the autotools `--prefix` parameter).
This would allow this to be gradual, once the initial setup, with just a handful already `spkg-configure.m4`-ed packages spun off.
The advantage is that the dependency resolution would be a natural top-down thing.



---

archive/issue_comments_403461.json:
```json
{
    "body": "<a id='comment:4'></a>I understand what you're saying and have thought about this problem as well, albeit without a completely clear solution. On the one hand I think it should be possible to use a system package regardless of its dependencies. On the other hand it is asking for trouble doing something like, as in your example, building a bz2 for Sage, but then using a libfreetype from the system which was compiled against its system libbz2. This may \"just work\" but mostly only by luck.\n\nThis was less of a problem when this mechanism was used only for a handful of packages that didn't live somewhere deep in the package dependency graph (the old configure.ac checked for these packages in more or less arbitrary order, and that is still the case unfortunately.\n\nI don't agree with your idea of bundling a bunch of packages together but I'm not sure I understand it either. I think there are a couple things to do here:\n\nUsing the freetype/bz2 example again: if we add a spkg-configure.m4 for one package, we should also do so for all its build dependencies. That way, assuming they are detected properly, it will properly use the system packages for the entire dependency tree rooted at freetype.\n\nHowever, I should also add some logic to SAGE_SPKG_COLLECT (likely with an external helper script) to actually load the package dependency graph and do these checks in a reasonable such that we don't even try to use a package from the system unless we've already detected all its dependencies from the system.",
    "created_at": "2019-01-30T12:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403461",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>I understand what you're saying and have thought about this problem as well, albeit without a completely clear solution. On the one hand I think it should be possible to use a system package regardless of its dependencies. On the other hand it is asking for trouble doing something like, as in your example, building a bz2 for Sage, but then using a libfreetype from the system which was compiled against its system libbz2. This may "just work" but mostly only by luck.

This was less of a problem when this mechanism was used only for a handful of packages that didn't live somewhere deep in the package dependency graph (the old configure.ac checked for these packages in more or less arbitrary order, and that is still the case unfortunately.

I don't agree with your idea of bundling a bunch of packages together but I'm not sure I understand it either. I think there are a couple things to do here:

Using the freetype/bz2 example again: if we add a spkg-configure.m4 for one package, we should also do so for all its build dependencies. That way, assuming they are detected properly, it will properly use the system packages for the entire dependency tree rooted at freetype.

However, I should also add some logic to SAGE_SPKG_COLLECT (likely with an external helper script) to actually load the package dependency graph and do these checks in a reasonable such that we don't even try to use a package from the system unless we've already detected all its dependencies from the system.



---

archive/issue_comments_403462.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 embray]:\n> I understand what you're saying and have thought about this problem as well, albeit without a completely clear solution. On the one hand I think it should be possible to use a system package regardless of its dependencies. On the other hand it is asking for trouble doing something like, as in your example, building a bz2 for Sage, but then using a libfreetype from the system which was compiled against its system libbz2. This may \"just work\" but mostly only by luck.\n> \n> This was less of a problem when this mechanism was used only for a handful of packages that didn't live somewhere deep in the package dependency graph (the old configure.ac checked for these packages in more or less arbitrary order, and that is still the case unfortunately.\n> \n> I don't agree with your idea of bundling a bunch of packages together but I'm not sure I understand it either. \n\n\nWell, perhaps bundling is a wrong word, but the idea is that once you removed a lot of stuff from Sage, you need means to build few missing pieces in a coherent way.\nThe complexity of doing this inside Sage is too much, in particular due to inflexible and a bit broken dependency resolution we have.\n \n> I think there are a couple things to do here:\n> \n> Using the freetype/bz2 example again: if we add a spkg-configure.m4 for one package, we should also do so for all its build dependencies. That way, assuming they are detected properly, it will properly use the system packages for the entire dependency tree rooted at freetype.\n\n\nI don't see why this always be the case. E.g. our current libgd is pretty old, and \nit does not need dependencies as new as provided by Sage (e.g. bz2). So the host system might have its own libgd, matching our version requirements, and spkg-configure.m4 would tell Sage to stay with the system's libgd. Yet, a newer libgd dependency, bz2, required by Sage for some reason, gets built by Sage. Oops, now we have system's libgd that might get mis-linked to Sage's bz2, or, worse, stuff gets broken during loading at runtime\n(or, even worse, gets subtly broken and result in wrong results).\nThis is really playing with fire.\n\nOften (freetype is a good example) Sage dependencies get updated just because something breaks on version N of BlaFoo OS, without much regard to whether this might break\nSage on version N-1 of BlaFoo OS (often, but by no means always, it is meant to continue working...).",
    "created_at": "2019-01-30T12:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403462",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>Replying to [comment:4 embray]:
> I understand what you're saying and have thought about this problem as well, albeit without a completely clear solution. On the one hand I think it should be possible to use a system package regardless of its dependencies. On the other hand it is asking for trouble doing something like, as in your example, building a bz2 for Sage, but then using a libfreetype from the system which was compiled against its system libbz2. This may "just work" but mostly only by luck.
> 
> This was less of a problem when this mechanism was used only for a handful of packages that didn't live somewhere deep in the package dependency graph (the old configure.ac checked for these packages in more or less arbitrary order, and that is still the case unfortunately.
> 
> I don't agree with your idea of bundling a bunch of packages together but I'm not sure I understand it either. 


Well, perhaps bundling is a wrong word, but the idea is that once you removed a lot of stuff from Sage, you need means to build few missing pieces in a coherent way.
The complexity of doing this inside Sage is too much, in particular due to inflexible and a bit broken dependency resolution we have.
 
> I think there are a couple things to do here:
> 
> Using the freetype/bz2 example again: if we add a spkg-configure.m4 for one package, we should also do so for all its build dependencies. That way, assuming they are detected properly, it will properly use the system packages for the entire dependency tree rooted at freetype.


I don't see why this always be the case. E.g. our current libgd is pretty old, and 
it does not need dependencies as new as provided by Sage (e.g. bz2). So the host system might have its own libgd, matching our version requirements, and spkg-configure.m4 would tell Sage to stay with the system's libgd. Yet, a newer libgd dependency, bz2, required by Sage for some reason, gets built by Sage. Oops, now we have system's libgd that might get mis-linked to Sage's bz2, or, worse, stuff gets broken during loading at runtime
(or, even worse, gets subtly broken and result in wrong results).
This is really playing with fire.

Often (freetype is a good example) Sage dependencies get updated just because something breaks on version N of BlaFoo OS, without much regard to whether this might break
Sage on version N-1 of BlaFoo OS (often, but by no means always, it is meant to continue working...).



---

archive/issue_comments_403463.json:
```json
{
    "body": "<a id='comment:6'></a>Thinking more about it, I should take a part of my comments above back - I have not quite understood the whole scheme of things. \nIt now seems to me that as soon as an spkg blah gets an spkg-configure.m4, all of its dependencies must have get it too, and then autoconf would do its magic just fine.\n\nThat is, for freetype this means that also libpng and bzip2 must also get spkg-configure.m4's. Thus the title change.",
    "created_at": "2019-01-30T13:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403463",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>Thinking more about it, I should take a part of my comments above back - I have not quite understood the whole scheme of things. 
It now seems to me that as soon as an spkg blah gets an spkg-configure.m4, all of its dependencies must have get it too, and then autoconf would do its magic just fine.

That is, for freetype this means that also libpng and bzip2 must also get spkg-configure.m4's. Thus the title change.



---

archive/issue_comments_403464.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.\n+\n+Also, its dependencies libpng and bzip2 must get their spkg-configure.m4's, to avoid misconfigurations (see discussion below in comments).\n \n Comment: 1\n \n```\n",
    "created_at": "2019-01-30T13:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403464",
    "user": "https://github.com/dimpase"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
 It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.
+
+Also, its dependencies libpng and bzip2 must get their spkg-configure.m4's, to avoid misconfigurations (see discussion below in comments).
 
 Comment: 1
 
```




---

archive/issue_comments_403465.json:
```json
{
    "body": "<a id='comment:7'></a>Here is 1st try for bzip2, appears working:\n\n```m4\nSAGE_SPKG_CONFIGURE([bzip2], [\n    AC_SEARCH_LIBS([BZ2_bzCompress], [bz2], [], [sage_spkg_install_bzip2=yes])\n    AC_CHECK_HEADER(bzlib.h, [], [sage_spkg_install_bzip2=yes])\n    AC_CHECK_PROG(bzip2, [break], [sage_spkg_install_bzip2=yes])\n])\n```",
    "created_at": "2019-01-31T12:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403465",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>Here is 1st try for bzip2, appears working:

```m4
SAGE_SPKG_CONFIGURE([bzip2], [
    AC_SEARCH_LIBS([BZ2_bzCompress], [bz2], [], [sage_spkg_install_bzip2=yes])
    AC_CHECK_HEADER(bzlib.h, [], [sage_spkg_install_bzip2=yes])
    AC_CHECK_PROG(bzip2, [break], [sage_spkg_install_bzip2=yes])
])
```



---

archive/issue_comments_403466.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:5 dimpase]:\n> Replying to [comment:4 embray]:\n> > Using the freetype/bz2 example again: if we add a spkg-configure.m4 for one package, we should also do so for all its build dependencies. That way, assuming they are detected properly, it will properly use the system packages for the entire dependency tree rooted at freetype.\n\n> \n> I don't see why this always be the case. E.g. our current libgd is pretty old, and \n> it does not need dependencies as new as provided by Sage (e.g. bz2). So the host system might have its own libgd, matching our version requirements, and spkg-configure.m4 would tell Sage to stay with the system's libgd. Yet, a newer libgd dependency, bz2, required by Sage for some reason, gets built by Sage. Oops, now we have system's libgd that might get mis-linked to Sage's bz2, or, worse, stuff gets broken during loading at runtime\n> (or, even worse, gets subtly broken and result in wrong results).\n> This is really playing with fire.\n\n\nI agree with this ofc.  If for some reason Sage (or really some other dependency of Sage) specifically needs some recent-enough libbz2 (for example) then we really need to check for that version on the system (either by actual version number, though better by feature checks if possible).  If not found, then we have to build our own copy.  And my point is that in that case we then need to also, at least by default, build all other dependencies that depend on that libbz2, regardless whether they can otherwise be found on the system.",
    "created_at": "2019-01-31T12:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403466",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Replying to [comment:5 dimpase]:
> Replying to [comment:4 embray]:
> > Using the freetype/bz2 example again: if we add a spkg-configure.m4 for one package, we should also do so for all its build dependencies. That way, assuming they are detected properly, it will properly use the system packages for the entire dependency tree rooted at freetype.

> 
> I don't see why this always be the case. E.g. our current libgd is pretty old, and 
> it does not need dependencies as new as provided by Sage (e.g. bz2). So the host system might have its own libgd, matching our version requirements, and spkg-configure.m4 would tell Sage to stay with the system's libgd. Yet, a newer libgd dependency, bz2, required by Sage for some reason, gets built by Sage. Oops, now we have system's libgd that might get mis-linked to Sage's bz2, or, worse, stuff gets broken during loading at runtime
> (or, even worse, gets subtly broken and result in wrong results).
> This is really playing with fire.


I agree with this ofc.  If for some reason Sage (or really some other dependency of Sage) specifically needs some recent-enough libbz2 (for example) then we really need to check for that version on the system (either by actual version number, though better by feature checks if possible).  If not found, then we have to build our own copy.  And my point is that in that case we then need to also, at least by default, build all other dependencies that depend on that libbz2, regardless whether they can otherwise be found on the system.



---

archive/issue_comments_403467.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 dimpase]:\n> Here is 1st try for bzip2, appears working:\n> \n> ```m4\n> SAGE_SPKG_CONFIGURE([bzip2], [\n>     AC_SEARCH_LIBS([BZ2_bzCompress], [bz2], [], [sage_spkg_install_bzip2=yes])\n>     AC_CHECK_HEADER(bzlib.h, [], [sage_spkg_install_bzip2=yes])\n>     AC_CHECK_PROG(bzip2, [break], [sage_spkg_install_bzip2=yes])\n> ])\n> ```\n\n\nThat looks good, though I think we need to switch the order of `AC_CHECK_HEADER` and `AC_SEARCH_LIBS`.  I've found that the result of `AC_CHECK_HEADER` can be used by `AC_SEARCH_LIBS` so that it can find the correct headers when building test programs.  I'm not entirely sure how that mechanism works, but I did find that to be the case with libffi for example...",
    "created_at": "2019-01-31T12:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403467",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Replying to [comment:7 dimpase]:
> Here is 1st try for bzip2, appears working:
> 
> ```m4
> SAGE_SPKG_CONFIGURE([bzip2], [
>     AC_SEARCH_LIBS([BZ2_bzCompress], [bz2], [], [sage_spkg_install_bzip2=yes])
>     AC_CHECK_HEADER(bzlib.h, [], [sage_spkg_install_bzip2=yes])
>     AC_CHECK_PROG(bzip2, [break], [sage_spkg_install_bzip2=yes])
> ])
> ```


That looks good, though I think we need to switch the order of `AC_CHECK_HEADER` and `AC_SEARCH_LIBS`.  I've found that the result of `AC_CHECK_HEADER` can be used by `AC_SEARCH_LIBS` so that it can find the correct headers when building test programs.  I'm not entirely sure how that mechanism works, but I did find that to be the case with libffi for example...



---

archive/issue_comments_403468.json:
```json
{
    "body": "<a id='comment:10'></a>OK. Do you think we need to check the version of bzip2 (it's been 1.0.6 for 5+ years already)?",
    "created_at": "2019-01-31T12:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403468",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>OK. Do you think we need to check the version of bzip2 (it's been 1.0.6 for 5+ years already)?



---

archive/issue_comments_403469.json:
```json
{
    "body": "<a id='comment:11'></a>I'll make a specific ticket for adding an spkg-configure.m4 for bzip2 and add it as a dependency of this ticket.\n\nI'm testing this out right now.  My general feeling about version checks is to avoid it until and unless we know a specific reason we need it.",
    "created_at": "2019-01-31T12:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403469",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>I'll make a specific ticket for adding an spkg-configure.m4 for bzip2 and add it as a dependency of this ticket.

I'm testing this out right now.  My general feeling about version checks is to avoid it until and unless we know a specific reason we need it.



---

archive/issue_comments_403470.json:
```json
{
    "body": "<a id='comment:12'></a>Here the reason would be to avoid nasty surprises for people installing Sage in weird places. \n\nActually, while I was at it\n\n```\n$ bzip2 --version 2>&1 | sed -n -e 's/bzip2.* Version *\\([[0-9]]*\\.[[0-9]]*\\.[[0-9]]*\\).*/\\1/p'\n```\noutputs 1.0.6, as needed. (then one can steal the rest of version-checking from spkg-configure.m4 of patch spkg, say, to check the version).",
    "created_at": "2019-01-31T13:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403470",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>Here the reason would be to avoid nasty surprises for people installing Sage in weird places. 

Actually, while I was at it

```
$ bzip2 --version 2>&1 | sed -n -e 's/bzip2.* Version *\([[0-9]]*\.[[0-9]]*\.[[0-9]]*\).*/\1/p'
```
outputs 1.0.6, as needed. (then one can steal the rest of version-checking from spkg-configure.m4 of patch spkg, say, to check the version).



---

archive/issue_comments_403471.json:
```json
{
    "body": "<a id='comment:13'></a>I'm not sure what nasty surprises you have in mind.  I don't think many people use this package directly.",
    "created_at": "2019-01-31T14:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403471",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>I'm not sure what nasty surprises you have in mind.  I don't think many people use this package directly.



---

archive/issue_comments_403472.json:
```json
{
    "body": "<a id='comment:14'></a>Forgot to add here: #27182",
    "created_at": "2019-01-31T14:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403472",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Forgot to add here: #27182



---

archive/issue_comments_403473.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:13 embray]:\n> I'm not sure what nasty surprises you have in mind.  I don't think many people use this package directly.\n\n\nSomebody starts installing Sage on an HPC cluster with typical semi-obsolete 10 years-old Linux version, and it fails as it picks up system's bzlib2 from previous century...",
    "created_at": "2019-01-31T14:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403473",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>Replying to [comment:13 embray]:
> I'm not sure what nasty surprises you have in mind.  I don't think many people use this package directly.


Somebody starts installing Sage on an HPC cluster with typical semi-obsolete 10 years-old Linux version, and it fails as it picks up system's bzlib2 from previous century...



---

archive/issue_comments_403474.json:
```json
{
    "body": "<a id='comment:17'></a>I mean, that's fine.  If it doesn't pick it up then it doesn't, and installs Sage's instead.",
    "created_at": "2019-01-31T14:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403474",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>I mean, that's fine.  If it doesn't pick it up then it doesn't, and installs Sage's instead.



---

archive/issue_comments_403475.json:
```json
{
    "body": "Changing keywords from \"\" to \"spkg-configure\".",
    "created_at": "2019-02-12T09:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403475",
    "user": "https://github.com/dimpase"
}
```

Changing keywords from "" to "spkg-configure".



---

archive/issue_comments_403476.json:
```json
{
    "body": "<a id='comment:19'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403476",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_067463.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27168#event-67463"
}
```



---

archive/issue_comments_403477.json:
```json
{
    "body": "<a id='comment:20'></a>New commits:",
    "created_at": "2019-04-16T19:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403477",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>New commits:



---

archive/issue_comments_403478.json:
```json
{
    "body": "<a id='comment:21'></a>`libgd` configure needs `--with-freetype=yes` if one goes for system's freetype,\ninstead of `--with-freetype=\"$SAGE_LOCAL\"`.",
    "created_at": "2019-04-16T19:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403478",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>`libgd` configure needs `--with-freetype=yes` if one goes for system's freetype,
instead of `--with-freetype="$SAGE_LOCAL"`.



---

archive/issue_comments_403479.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-16T20:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403479",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_403480.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-16T21:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403480",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_403481.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-04-16T21:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403481",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_403482.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n+It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.\n \n \n Comment: 1\n```\n",
    "created_at": "2019-04-16T21:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403482",
    "user": "https://github.com/dimpase"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,4 @@
+It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.
 
 
 Comment: 1
```




---

archive/issue_comments_403483.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-16T21:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403483",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_403484.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-30T17:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403484",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403485.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-05-13T13:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403485",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403486.json:
```json
{
    "body": "<a id='comment:28'></a>can we get this through? (I deliberately not do a configure bump here, to lessen the rebasing hell...)",
    "created_at": "2019-05-13T13:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403486",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>can we get this through? (I deliberately not do a configure bump here, to lessen the rebasing hell...)



---

archive/issue_comments_403487.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-15T08:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403487",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403488.json:
```json
{
    "body": "<a id='comment:30'></a>LGTM",
    "created_at": "2019-05-15T08:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403488",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:30'></a>LGTM



---

archive/issue_comments_403489.json:
```json
{
    "body": "<a id='comment:31'></a>Thanks! And how about its dependency, #27186 ?",
    "created_at": "2019-05-15T08:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403489",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>Thanks! And how about its dependency, #27186 ?



---

archive/issue_comments_403490.json:
```json
{
    "body": "<a id='comment:32'></a>Please merge together with #27825",
    "created_at": "2019-05-15T08:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403490",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>Please merge together with #27825



---

archive/issue_comments_403491.json:
```json
{
    "body": "Changing keywords from \"spkg-configure\" to \"spkg-configure freetype\".",
    "created_at": "2019-05-17T09:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403491",
    "user": "https://github.com/embray"
}
```

Changing keywords from "spkg-configure" to "spkg-configure freetype".



---

archive/issue_comments_403492.json:
```json
{
    "body": "<a id='comment:33'></a>Please never set these to positive review until I've had a chance to OK them on Cygwin.",
    "created_at": "2019-05-17T09:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403492",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>Please never set these to positive review until I've had a chance to OK them on Cygwin.



---

archive/issue_comments_403493.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-05-17T09:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403493",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_403494.json:
```json
{
    "body": "Changing component from packages: standard to build: configure.",
    "created_at": "2019-05-17T09:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403494",
    "user": "https://github.com/embray"
}
```

Changing component from packages: standard to build: configure.



---

archive/issue_comments_403495.json:
```json
{
    "body": "<a id='comment:34'></a>I don't like this:\n\n```\n+    if test x$sage_spkg_install_freetype = xyes; then\n+      AC_SUBST(SAGE_FREETYPE_PREFIX, ['$SAGE_LOCAL'])\n+    else\n+      AC_SUBST(SAGE_FREETYPE_PREFIX, [yes])\n+    fi\n```\n\nI think if we need this variable at all (which it seems we do currently for building libgd) it should either be an actual filesystem path or empty for consistency's sake.  If some random package (like again, libgd) requires you to pass `--with-freetype=yes` that should be handled in its spkg-install, e.g. like\n\n```\nif [ -n \"$SAGE_FREETYPE_PREFIX\" ]; then\n    CONFIGURE_LIBGD=\"$CONFIGURE_LIBGD --with-freetype=$SAGE_FREETYPE_PREFIX\"\nelse\n    CONFIGURE_LIBGD=\"$CONFIGURE_LIBGD --with-freetype=yes\"\nfi\n```\n\nor something along those lines.",
    "created_at": "2019-05-17T09:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403495",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>I don't like this:

```
+    if test x$sage_spkg_install_freetype = xyes; then
+      AC_SUBST(SAGE_FREETYPE_PREFIX, ['$SAGE_LOCAL'])
+    else
+      AC_SUBST(SAGE_FREETYPE_PREFIX, [yes])
+    fi
```

I think if we need this variable at all (which it seems we do currently for building libgd) it should either be an actual filesystem path or empty for consistency's sake.  If some random package (like again, libgd) requires you to pass `--with-freetype=yes` that should be handled in its spkg-install, e.g. like

```
if [ -n "$SAGE_FREETYPE_PREFIX" ]; then
    CONFIGURE_LIBGD="$CONFIGURE_LIBGD --with-freetype=$SAGE_FREETYPE_PREFIX"
else
    CONFIGURE_LIBGD="$CONFIGURE_LIBGD --with-freetype=yes"
fi
```

or something along those lines.



---

archive/issue_comments_403496.json:
```json
{
    "body": "<a id='comment:35'></a>Yep, I agree that it's inconsistent with way such an inconsistency is dealt with in Flint, I'll fix this.",
    "created_at": "2019-05-17T10:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403496",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>Yep, I agree that it's inconsistent with way such an inconsistency is dealt with in Flint, I'll fix this.



---

archive/issue_comments_403497.json:
```json
{
    "body": "<a id='comment:36'></a>I also noticed some inconsistencies in the formatting of some of the messages, as compared to the stuff in #27822 since I change the messages in those ticket to be more consistent with the style of other autoconf messages (e.g. using mostly lower-case, like \"no\" instead of \"No.\").  This is just trivial nitpick though.  I can fix those up if you want.",
    "created_at": "2019-05-17T11:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403497",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>I also noticed some inconsistencies in the formatting of some of the messages, as compared to the stuff in #27822 since I change the messages in those ticket to be more consistent with the style of other autoconf messages (e.g. using mostly lower-case, like "no" instead of "No.").  This is just trivial nitpick though.  I can fix those up if you want.



---

archive/issue_comments_403498.json:
```json
{
    "body": "<a id='comment:37'></a>Please do the fixes (and do not forget about mpfr/mpc/ntl bunch, #27822 and #27265, which is currently not moving forward, too).",
    "created_at": "2019-05-17T11:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403498",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>Please do the fixes (and do not forget about mpfr/mpc/ntl bunch, #27822 and #27265, which is currently not moving forward, too).



---

archive/issue_comments_403499.json:
```json
{
    "body": "<a id='comment:38'></a>Here are some minor updates that incorporate my review comments from earlier in this ticket, and a few other minor tweaks that seemed worth including.  Please review.\n\n---\nNew commits:",
    "created_at": "2019-05-23T13:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403499",
    "user": "https://github.com/embray"
}
```

<a id='comment:38'></a>Here are some minor updates that incorporate my review comments from earlier in this ticket, and a few other minor tweaks that seemed worth including.  Please review.

---
New commits:



---

archive/issue_comments_403500.json:
```json
{
    "body": "<a id='comment:39'></a>this ought to be rebased over 8.8.beta6...",
    "created_at": "2019-05-23T21:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403500",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>this ought to be rebased over 8.8.beta6...



---

archive/issue_comments_403501.json:
```json
{
    "body": "<a id='comment:40'></a>OK, this looks good, I've cherry-picked these into `u/dimpase/packages/libgd-config`.\nLet's continue on #27825.",
    "created_at": "2019-05-24T09:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403501",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:40'></a>OK, this looks good, I've cherry-picked these into `u/dimpase/packages/libgd-config`.
Let's continue on #27825.



---

archive/issue_comments_403502.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-24T09:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403502",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_067464.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-05-24T09:06:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27168#event-67464"
}
```



---

archive/issue_events_067465.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-05-24T09:06:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27168#event-67465"
}
```



---

archive/issue_comments_403503.json:
```json
{
    "body": "<a id='comment:41'></a>ideally, we should be adding an extra parameter to `SAGE_SPKG_CONFIGURE` to list dependencies that must be verified to come from the system, instead of this monotonous\ncopypastes for these checks.\n\n(It could even be the 2nd parameter, and we then mass-edit all the spkg-configure.m4 to make use of it)",
    "created_at": "2019-05-25T07:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403503",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>ideally, we should be adding an extra parameter to `SAGE_SPKG_CONFIGURE` to list dependencies that must be verified to come from the system, instead of this monotonous
copypastes for these checks.

(It could even be the 2nd parameter, and we then mass-edit all the spkg-configure.m4 to make use of it)



---

archive/issue_comments_403504.json:
```json
{
    "body": "<a id='comment:42'></a>It doesn't necessarily have to be an argument to `SAGE_SPKG_CONFIGURE`, although that could be nice.  It could also be a macro similar to `AC_REQUIRE` that you would put at the top.  I agree it should be made less repetitive either way.",
    "created_at": "2019-05-31T16:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403504",
    "user": "https://github.com/embray"
}
```

<a id='comment:42'></a>It doesn't necessarily have to be an argument to `SAGE_SPKG_CONFIGURE`, although that could be nice.  It could also be a macro similar to `AC_REQUIRE` that you would put at the top.  I agree it should be made less repetitive either way.



---

archive/issue_events_067466.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-07-05T07:52:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27168#event-67466"
}
```



---

archive/issue_comments_403505.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-07-05T07:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403505",
    "user": "https://github.com/fchapoton"
}
```

Resolution: duplicate



---

archive/issue_comments_403506.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.\n \n+Ticket closed as duplicate after the corresponding changes were integrated in #27825.\n \n Comment: 1\n \n```\n",
    "created_at": "2019-07-08T14:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27168",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27168#issuecomment-403506",
    "user": "https://github.com/slel"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+It gets ugly with library conflicts, so more libraries available on the system should be used instead of ones shipped by Sage, e.g. `freetype` is a good example. Freetype may be used by R packages, and they in turn might depend on other system libraries we don't even know about, cf. e.g. #27163.
 
+Ticket closed as duplicate after the corresponding changes were integrated in #27825.
 
 Comment: 1
 
```

