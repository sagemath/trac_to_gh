# Issue 27840: Bug in the ppl backend of polyhedron

archive/issues_027603.json:
```json
{
    "body": "The following line throws a conversion error only with the (default) backend `ppl`:\n\n```\nsage: Q = Polyhedron(backend='ppl', vertices=[(1, 2, 3), (1, 3, 2), (2, 1, 3), (2, 3, 1), (3, 1, 2), (3, 2, 1)],rays=[[1,1,1]],lines=[[1,2,3]])\nTraceback (most recent call last):\n...\nTypeError: no conversion of this rational to integer\n```\n\nReplacing the backend by any other goes through without problems.\n\nCC:  @mkoeppe @videlec @tscrim\n\nKeywords: polytopes, ppl\n\nBranch/Commit: [17895a6256b490db70d3758eef2938417295980d](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)\n\nReviewer: Vincent Delecroix\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27840\n\n",
    "closed_at": "2019-05-24T18:29:52Z",
    "created_at": "2019-05-16T12:07:46Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Bug in the ppl backend of polyhedron",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27840",
    "user": "https://github.com/jplab"
}
```
The following line throws a conversion error only with the (default) backend `ppl`:

```
sage: Q = Polyhedron(backend='ppl', vertices=[(1, 2, 3), (1, 3, 2), (2, 1, 3), (2, 3, 1), (3, 1, 2), (3, 2, 1)],rays=[[1,1,1]],lines=[[1,2,3]])
Traceback (most recent call last):
...
TypeError: no conversion of this rational to integer
```

Replacing the backend by any other goes through without problems.

CC:  @mkoeppe @videlec @tscrim

Keywords: polytopes, ppl

Branch/Commit: [17895a6256b490db70d3758eef2938417295980d](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)

Reviewer: Vincent Delecroix

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27840





---

archive/issue_comments_539726.json:
```json
{
    "body": "<a id='comment:1'></a>\nInteresting. Here the heuristic that guesses the parent and base ring goes wrong. If one passes `base_ring=QQ`, then one can see that PPL chooses a representation using a fractional \"vertex\".",
    "created_at": "2019-05-16T13:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539726",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
Interesting. Here the heuristic that guesses the parent and base ring goes wrong. If one passes `base_ring=QQ`, then one can see that PPL chooses a representation using a fractional "vertex".



---

archive/issue_comments_539727.json:
```json
{
    "body": "<a id='comment:2'></a>\nWhat should be done? Set `base_ring=QQ` when there is rays or lines?\n\nDo you have any idea why PPL prefers a presentation with vertices with non-trivial denominators?",
    "created_at": "2019-05-19T13:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539727",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>
What should be done? Set `base_ring=QQ` when there is rays or lines?

Do you have any idea why PPL prefers a presentation with vertices with non-trivial denominators?



---

archive/issue_comments_539728.json:
```json
{
    "body": "Branch: [u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron)",
    "created_at": "2019-05-20T04:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539728",
    "user": "https://github.com/mkoeppe"
}
```

Branch: [u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron)



---

archive/issue_comments_539729.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539729",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_539730.json:
```json
{
    "body": "Author: Matthias Koeppe",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539730",
    "user": "https://github.com/mkoeppe"
}
```

Author: Matthias Koeppe



---

archive/issue_comments_539731.json:
```json
{
    "body": "Commit: [40737833f88e5fc8f373954da89ef36ccfcf530c](https://github.com/sagemath/sagetrac-mirror/commit/40737833f88e5fc8f373954da89ef36ccfcf530c)",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539731",
    "user": "https://github.com/mkoeppe"
}
```

Commit: [40737833f88e5fc8f373954da89ef36ccfcf530c](https://github.com/sagemath/sagetrac-mirror/commit/40737833f88e5fc8f373954da89ef36ccfcf530c)



---

archive/issue_comments_539732.json:
```json
{
    "body": "<a id='comment:4'></a>\nNew commits:\n|                                                                                                                                          |                                                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|\n|[4073783](https://github.com/sagemath/sagetrac-mirror/commit/40737833f88e5fc8f373954da89ef36ccfcf530c)|`Guess base_ring of non-compact V-polyhedra with integer data as QQ, not ZZ`|",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539732",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
New commits:
|                                                                                                                                          |                                                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|
|[4073783](https://github.com/sagemath/sagetrac-mirror/commit/40737833f88e5fc8f373954da89ef36ccfcf530c)|`Guess base_ring of non-compact V-polyhedra with integer data as QQ, not ZZ`|



---

archive/issue_comments_539733.json:
```json
{
    "body": "Reviewer: Vincent Delecroix",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539733",
    "user": "https://github.com/videlec"
}
```

Reviewer: Vincent Delecroix



---

archive/issue_comments_539734.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539734",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_539735.json:
```json
{
    "body": "<a id='comment:5'></a>\nFailures in\n\n```\nsage -t --long src/sage/geometry/cone.py  # 3 doctests failed\nsage -t --long src/sage/doctest/control.py  # 4 doctests failed\nsage -t --long src/sage/doctest/forker.py  # 6 doctests failed\nsage -t --long src/sage/combinat/root_system/plot.py  # 1 doctest failed\n```\n(see patchbot report)\n\nI believe that when the polytope is a cone (namely with a unique vertex at 0) then everything should be fine. No? Don't we want `base_ring=ZZ` in this case?\n\nAlso, the constructor should be tested when the user enforces `base_ring=ZZ`.",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539735",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>
Failures in

```
sage -t --long src/sage/geometry/cone.py  # 3 doctests failed
sage -t --long src/sage/doctest/control.py  # 4 doctests failed
sage -t --long src/sage/doctest/forker.py  # 6 doctests failed
sage -t --long src/sage/combinat/root_system/plot.py  # 1 doctest failed
```
(see patchbot report)

I believe that when the polytope is a cone (namely with a unique vertex at 0) then everything should be fine. No? Don't we want `base_ring=ZZ` in this case?

Also, the constructor should be tested when the user enforces `base_ring=ZZ`.



---

archive/issue_comments_539736.json:
```json
{
    "body": "Changing commit from \"[40737833f88e5fc8f373954da89ef36ccfcf530c](https://github.com/sagemath/sagetrac-mirror/commit/40737833f88e5fc8f373954da89ef36ccfcf530c)\" to \"[a08167121554477f85e14cc2ce25819f87a4fb48](https://github.com/sagemath/sagetrac-mirror/commit/a08167121554477f85e14cc2ce25819f87a4fb48)\"",
    "created_at": "2019-05-20T13:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539736",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[40737833f88e5fc8f373954da89ef36ccfcf530c](https://github.com/sagemath/sagetrac-mirror/commit/40737833f88e5fc8f373954da89ef36ccfcf530c)" to "[a08167121554477f85e14cc2ce25819f87a4fb48](https://github.com/sagemath/sagetrac-mirror/commit/a08167121554477f85e14cc2ce25819f87a4fb48)"



---

archive/issue_comments_539737.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|\n|[cb66a1e](https://github.com/sagemath/sagetrac-mirror/commit/cb66a1e49238490cd937bb8c404d09020c14bab4)|`However, guess base_ring of cones with integer data as ZZ`|\n|[a081671](https://github.com/sagemath/sagetrac-mirror/commit/a08167121554477f85e14cc2ce25819f87a4fb48)|`Add a doctest`|",
    "created_at": "2019-05-20T13:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539737",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|
|[cb66a1e](https://github.com/sagemath/sagetrac-mirror/commit/cb66a1e49238490cd937bb8c404d09020c14bab4)|`However, guess base_ring of cones with integer data as ZZ`|
|[a081671](https://github.com/sagemath/sagetrac-mirror/commit/a08167121554477f85e14cc2ce25819f87a4fb48)|`Add a doctest`|



---

archive/issue_comments_539738.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-20T13:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539738",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_539739.json:
```json
{
    "body": "<a id='comment:8'></a>\nI like more this less intrusive version. Though it is a pity that the second commit cancels some edits of the first...",
    "created_at": "2019-05-20T15:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539739",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>
I like more this less intrusive version. Though it is a pity that the second commit cancels some edits of the first...



---

archive/issue_comments_539740.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                                      |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------|\n|[27b98b5](https://github.com/sagemath/sagetrac-mirror/commit/27b98b5eb870850a9424c7d4b4b419ddf060ab96)|`Guess base_ring of non-compact, non-cone V-polyhedra with integer data as QQ, not ZZ`|\n|[17895a6](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)|`Add a doctest`|",
    "created_at": "2019-05-20T16:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539740",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
|[27b98b5](https://github.com/sagemath/sagetrac-mirror/commit/27b98b5eb870850a9424c7d4b4b419ddf060ab96)|`Guess base_ring of non-compact, non-cone V-polyhedra with integer data as QQ, not ZZ`|
|[17895a6](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)|`Add a doctest`|



---

archive/issue_comments_539741.json:
```json
{
    "body": "Changing commit from \"[a08167121554477f85e14cc2ce25819f87a4fb48](https://github.com/sagemath/sagetrac-mirror/commit/a08167121554477f85e14cc2ce25819f87a4fb48)\" to \"[17895a6256b490db70d3758eef2938417295980d](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)\"",
    "created_at": "2019-05-20T16:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539741",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[a08167121554477f85e14cc2ce25819f87a4fb48](https://github.com/sagemath/sagetrac-mirror/commit/a08167121554477f85e14cc2ce25819f87a4fb48)" to "[17895a6256b490db70d3758eef2938417295980d](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)"



---

archive/issue_comments_539742.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [vdelecroix](#comment%3A8):\n> it is a pity that the second commit cancels some edits of the first...\n\nI've squashed the two commits.",
    "created_at": "2019-05-20T16:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539742",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
Replying to [vdelecroix](#comment%3A8):
> it is a pity that the second commit cancels some edits of the first...

I've squashed the two commits.



---

archive/issue_comments_539743.json:
```json
{
    "body": "<a id='comment:11'></a>\nNice Thx.",
    "created_at": "2019-05-20T19:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539743",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>
Nice Thx.



---

archive/issue_comments_539744.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-20T19:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539744",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_539745.json:
```json
{
    "body": "Changing branch from \"[u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron)\" to \"[17895a6256b490db70d3758eef2938417295980d](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)\"",
    "created_at": "2019-05-24T18:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539745",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "[u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron)" to "[17895a6256b490db70d3758eef2938417295980d](https://github.com/sagemath/sagetrac-mirror/commit/17895a6256b490db70d3758eef2938417295980d)"



---

archive/issue_comments_539746.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-24T18:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-539746",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_078225.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-24T18:29:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27840#event-78225"
}
```
