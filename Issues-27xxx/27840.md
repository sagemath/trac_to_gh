# Issue 27840: Bug in the ppl backend of polyhedron

archive/issues_027603.json:
```json
{
    "body": "The following line throws a conversion error only with the (default) backend `ppl`:\n\n```\nsage: Q = Polyhedron(backend='ppl', vertices=[(1, 2, 3), (1, 3, 2), (2, 1, 3), (2, 3, 1), (3, 1, 2), (3, 2, 1)],rays=[[1,1,1]],lines=[[1,2,3]])\nTraceback (most recent call last):\n...\nTypeError: no conversion of this rational to integer\n```\n\nReplacing the backend by any other goes through without problems.\n\nCC:  @mkoeppe @videlec @tscrim\n\nKeywords: polytopes, ppl\n\nBranch/Commit: 17895a6256b490db70d3758eef2938417295980d\n\nReviewer: Vincent Delecroix\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27840\n\n",
    "closed_at": "2019-05-24T18:29:52Z",
    "created_at": "2019-05-16T12:07:46Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Bug in the ppl backend of polyhedron",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27840",
    "user": "https://github.com/jplab"
}
```
The following line throws a conversion error only with the (default) backend `ppl`:

```
sage: Q = Polyhedron(backend='ppl', vertices=[(1, 2, 3), (1, 3, 2), (2, 1, 3), (2, 3, 1), (3, 1, 2), (3, 2, 1)],rays=[[1,1,1]],lines=[[1,2,3]])
Traceback (most recent call last):
...
TypeError: no conversion of this rational to integer
```

Replacing the backend by any other goes through without problems.

CC:  @mkoeppe @videlec @tscrim

Keywords: polytopes, ppl

Branch/Commit: 17895a6256b490db70d3758eef2938417295980d

Reviewer: Vincent Delecroix

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27840





---

archive/issue_comments_538260.json:
```json
{
    "body": "<a id='comment:1'></a>Interesting. Here the heuristic that guesses the parent and base ring goes wrong. If one passes `base_ring=QQ`, then one can see that PPL chooses a representation using a fractional \"vertex\".",
    "created_at": "2019-05-16T13:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538260",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>Interesting. Here the heuristic that guesses the parent and base ring goes wrong. If one passes `base_ring=QQ`, then one can see that PPL chooses a representation using a fractional "vertex".



---

archive/issue_comments_538261.json:
```json
{
    "body": "<a id='comment:2'></a>What should be done? Set `base_ring=QQ` when there is rays or lines?\n\nDo you have any idea why PPL prefers a presentation with vertices with non-trivial denominators?",
    "created_at": "2019-05-19T13:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538261",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>What should be done? Set `base_ring=QQ` when there is rays or lines?

Do you have any idea why PPL prefers a presentation with vertices with non-trivial denominators?



---

archive/issue_comments_538262.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron\"",
    "created_at": "2019-05-20T04:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538262",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron"



---

archive/issue_comments_538263.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538263",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_538264.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538264",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_538265.json:
```json
{
    "body": "Changing commit from \"\" to \"40737833f88e5fc8f373954da89ef36ccfcf530c\"",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538265",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "40737833f88e5fc8f373954da89ef36ccfcf530c"



---

archive/issue_comments_538266.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538266",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_538267.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538267",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_538268.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538268",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_538269.json:
```json
{
    "body": "<a id='comment:5'></a>Failures in\n\n```\nsage -t --long src/sage/geometry/cone.py  # 3 doctests failed\nsage -t --long src/sage/doctest/control.py  # 4 doctests failed\nsage -t --long src/sage/doctest/forker.py  # 6 doctests failed\nsage -t --long src/sage/combinat/root_system/plot.py  # 1 doctest failed\n```\n(see patchbot report)\n\nI believe that when the polytope is a cone (namely with a unique vertex at 0) then everything should be fine. No? Don't we want `base_ring=ZZ` in this case?\n\nAlso, the constructor should be tested when the user enforces `base_ring=ZZ`.",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538269",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Failures in

```
sage -t --long src/sage/geometry/cone.py  # 3 doctests failed
sage -t --long src/sage/doctest/control.py  # 4 doctests failed
sage -t --long src/sage/doctest/forker.py  # 6 doctests failed
sage -t --long src/sage/combinat/root_system/plot.py  # 1 doctest failed
```
(see patchbot report)

I believe that when the polytope is a cone (namely with a unique vertex at 0) then everything should be fine. No? Don't we want `base_ring=ZZ` in this case?

Also, the constructor should be tested when the user enforces `base_ring=ZZ`.



---

archive/issue_comments_538270.json:
```json
{
    "body": "Changing commit from \"40737833f88e5fc8f373954da89ef36ccfcf530c\" to \"a08167121554477f85e14cc2ce25819f87a4fb48\"",
    "created_at": "2019-05-20T13:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538270",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "40737833f88e5fc8f373954da89ef36ccfcf530c" to "a08167121554477f85e14cc2ce25819f87a4fb48"



---

archive/issue_comments_538271.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-20T13:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_538272.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-20T13:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538272",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_538273.json:
```json
{
    "body": "<a id='comment:8'></a>I like more this less intrusive version. Though it is a pity that the second commit cancels some edits of the first...",
    "created_at": "2019-05-20T15:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538273",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>I like more this less intrusive version. Though it is a pity that the second commit cancels some edits of the first...



---

archive/issue_comments_538274.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-05-20T16:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538274",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_538275.json:
```json
{
    "body": "Changing commit from \"a08167121554477f85e14cc2ce25819f87a4fb48\" to \"17895a6256b490db70d3758eef2938417295980d\"",
    "created_at": "2019-05-20T16:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538275",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a08167121554477f85e14cc2ce25819f87a4fb48" to "17895a6256b490db70d3758eef2938417295980d"



---

archive/issue_comments_538276.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 vdelecroix]:\n> it is a pity that the second commit cancels some edits of the first...\n\nI've squashed the two commits.",
    "created_at": "2019-05-20T16:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538276",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Replying to [comment:8 vdelecroix]:
> it is a pity that the second commit cancels some edits of the first...

I've squashed the two commits.



---

archive/issue_comments_538277.json:
```json
{
    "body": "<a id='comment:11'></a>Nice Thx.",
    "created_at": "2019-05-20T19:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538277",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Nice Thx.



---

archive/issue_comments_538278.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-20T19:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538278",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_538279.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron\" to \"17895a6256b490db70d3758eef2938417295980d\"",
    "created_at": "2019-05-24T18:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538279",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/bug_in_the_ppl_backend_of_polyhedron" to "17895a6256b490db70d3758eef2938417295980d"



---

archive/issue_comments_538280.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-24T18:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-538280",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069006.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-24T18:29:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27840#event-69006"
}
```
