# Issue 27840: Bug in the ppl backend of polyhedron

archive/issues_027603.json:
```json
{
    "body": "The following line throws a conversion error only with the (default) backend `ppl`:\n\n```\nsage: Q = Polyhedron(backend='ppl', vertices=[(1, 2, 3), (1, 3, 2), (2, 1, 3), (2, 3, 1), (3, 1, 2), (3, 2, 1)],rays=[[1,1,1]],lines=[[1,2,3]])\nTraceback (most recent call last):\n...\nTypeError: no conversion of this rational to integer\n```\n\nReplacing the backend by any other goes through without problems.\n\nCC:  @mkoeppe @videlec @tscrim\n\nKeywords: polytopes, ppl\n\nBranch/Commit: 17895a6256b490db70d3758eef2938417295980d\n\nReviewer: Vincent Delecroix\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27840\n\n",
    "closed_at": "2019-05-24T18:29:52Z",
    "created_at": "2019-05-16T12:07:46Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Bug in the ppl backend of polyhedron",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27840",
    "user": "https://github.com/jplab"
}
```
The following line throws a conversion error only with the (default) backend `ppl`:

```
sage: Q = Polyhedron(backend='ppl', vertices=[(1, 2, 3), (1, 3, 2), (2, 1, 3), (2, 3, 1), (3, 1, 2), (3, 2, 1)],rays=[[1,1,1]],lines=[[1,2,3]])
Traceback (most recent call last):
...
TypeError: no conversion of this rational to integer
```

Replacing the backend by any other goes through without problems.

CC:  @mkoeppe @videlec @tscrim

Keywords: polytopes, ppl

Branch/Commit: 17895a6256b490db70d3758eef2938417295980d

Reviewer: Vincent Delecroix

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27840





---

archive/issue_comments_414700.json:
```json
{
    "body": "<a id='comment:1'></a>Interesting. Here the heuristic that guesses the parent and base ring goes wrong. If one passes `base_ring=QQ`, then one can see that PPL chooses a representation using a fractional \"vertex\".",
    "created_at": "2019-05-16T13:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414700",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>Interesting. Here the heuristic that guesses the parent and base ring goes wrong. If one passes `base_ring=QQ`, then one can see that PPL chooses a representation using a fractional "vertex".



---

archive/issue_comments_414701.json:
```json
{
    "body": "<a id='comment:2'></a>What should be done? Set `base_ring=QQ` when there is rays or lines?\n\nDo you have any idea why PPL prefers a presentation with vertices with non-trivial denominators?",
    "created_at": "2019-05-19T13:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414701",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>What should be done? Set `base_ring=QQ` when there is rays or lines?

Do you have any idea why PPL prefers a presentation with vertices with non-trivial denominators?



---

archive/issue_comments_414702.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414702",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_414703.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2019-05-20T04:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414703",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_414704.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414704",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_414705.json:
```json
{
    "body": "<a id='comment:5'></a>Failures in\n\n```\nsage -t --long src/sage/geometry/cone.py  # 3 doctests failed\nsage -t --long src/sage/doctest/control.py  # 4 doctests failed\nsage -t --long src/sage/doctest/forker.py  # 6 doctests failed\nsage -t --long src/sage/combinat/root_system/plot.py  # 1 doctest failed\n```\n(see patchbot report)\n\nI believe that when the polytope is a cone (namely with a unique vertex at 0) then everything should be fine. No? Don't we want `base_ring=ZZ` in this case?\n\nAlso, the constructor should be tested when the user enforces `base_ring=ZZ`.",
    "created_at": "2019-05-20T06:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414705",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Failures in

```
sage -t --long src/sage/geometry/cone.py  # 3 doctests failed
sage -t --long src/sage/doctest/control.py  # 4 doctests failed
sage -t --long src/sage/doctest/forker.py  # 6 doctests failed
sage -t --long src/sage/combinat/root_system/plot.py  # 1 doctest failed
```
(see patchbot report)

I believe that when the polytope is a cone (namely with a unique vertex at 0) then everything should be fine. No? Don't we want `base_ring=ZZ` in this case?

Also, the constructor should be tested when the user enforces `base_ring=ZZ`.



---

archive/issue_comments_414706.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-20T13:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414706",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414707.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-20T13:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414707",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_414708.json:
```json
{
    "body": "<a id='comment:8'></a>I like more this less intrusive version. Though it is a pity that the second commit cancels some edits of the first...",
    "created_at": "2019-05-20T15:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414708",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>I like more this less intrusive version. Though it is a pity that the second commit cancels some edits of the first...



---

archive/issue_comments_414709.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-05-20T16:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414709",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_414710.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 vdelecroix]:\n> it is a pity that the second commit cancels some edits of the first...\n\nI've squashed the two commits.",
    "created_at": "2019-05-20T16:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414710",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Replying to [comment:8 vdelecroix]:
> it is a pity that the second commit cancels some edits of the first...

I've squashed the two commits.



---

archive/issue_comments_414711.json:
```json
{
    "body": "<a id='comment:11'></a>Nice Thx.",
    "created_at": "2019-05-20T19:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414711",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Nice Thx.



---

archive/issue_comments_414712.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-20T19:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414712",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_414713.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-24T18:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27840#issuecomment-414713",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_069006.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-24T18:29:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27840",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27840#event-69006"
}
```
