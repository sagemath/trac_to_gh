# Issue 27016: DESTDIR support for gcc, improvements to gfortran

archive/issues_026779.json:
```json
{
    "body": "This does a few things:\n\n* Updates the gcc SPKG to support DESTDIR installation so that it can now be uninstalled as well\n\n* This includes a patch (adapted from Debian) to make gcc install libraries to `${prefix}/lib` instead of `${prefix}/lib64` on Linux (this does not appear to be a problem on Cygwin, macOS, or FreeBSD that I'm aware of).\n\n* Additional refactoring to reduce duplication between the gcc and gfortran SPKGs: This includes the patches from gcc as the can also be relevant to gfortran.\n\nI've tested this a good bit on Linux (being able to uninstall gcc now is nice), but it needs more testing on other platforms, particularly macOS since it's the primary case for installing this package in the first place, and involves additional workarounds.\n\nThis would also fix #26996 for the case of installing gfortran on Linux.\n\nCC:  @vbraun @dimpase @jdemeyer konrad127123\n\nKeywords: destdir gcc\n\nBranch/Commit: a1d8ce92b02596d9291e0a58f2376b53c628acdc\n\nReviewer: Dima Pasechnik\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27016\n\n",
    "closed_at": "2019-02-22T22:01:08Z",
    "created_at": "2019-01-04T11:19:11Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "DESTDIR support for gcc, improvements to gfortran",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27016",
    "user": "https://github.com/embray"
}
```
This does a few things:

* Updates the gcc SPKG to support DESTDIR installation so that it can now be uninstalled as well

* This includes a patch (adapted from Debian) to make gcc install libraries to `${prefix}/lib` instead of `${prefix}/lib64` on Linux (this does not appear to be a problem on Cygwin, macOS, or FreeBSD that I'm aware of).

* Additional refactoring to reduce duplication between the gcc and gfortran SPKGs: This includes the patches from gcc as the can also be relevant to gfortran.

I've tested this a good bit on Linux (being able to uninstall gcc now is nice), but it needs more testing on other platforms, particularly macOS since it's the primary case for installing this package in the first place, and involves additional workarounds.

This would also fix #26996 for the case of installing gfortran on Linux.

CC:  @vbraun @dimpase @jdemeyer konrad127123

Keywords: destdir gcc

Branch/Commit: a1d8ce92b02596d9291e0a58f2376b53c628acdc

Reviewer: Dima Pasechnik

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27016





---

archive/issue_comments_401007.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-04T11:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401007",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401008.json:
```json
{
    "body": "<a id='comment:2'></a>Pinging a few people who might be interested in reviewing this ticket.  If not, sorry for the noise--you can remove yourself from the CC field.",
    "created_at": "2019-01-22T12:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401008",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>Pinging a few people who might be interested in reviewing this ticket.  If not, sorry for the noise--you can remove yourself from the CC field.



---

archive/issue_comments_401009.json:
```json
{
    "body": "<a id='comment:4'></a>test, please ignore",
    "created_at": "2019-01-22T18:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401009",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>test, please ignore



---

archive/issue_comments_401010.json:
```json
{
    "body": "<a id='comment:5'></a>I only have access to OS X, so I have removed myself. \n\nBy the way, once you are on the cc list, there is no apparent way to remove yourself. I removed myself and asked Dima to send a test message, which I received. (Thanks, Dima!) I don't mind, I can handle a few extra email messages. But I wonder if there is a way to fix this aspect of trac's configuration for those who are actually bothered by extra trac messages.\n\nI suppose one other thing to try is to have someone else do the removal from the cc list: it may be that once someone displays any activity on the ticket, they are automatically cc'ed after that, even if their only activity was to remove their name from the cc list. If someone else has to do it, that's a lot of effort to be removed from the cc list.",
    "created_at": "2019-01-22T18:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401010",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>I only have access to OS X, so I have removed myself. 

By the way, once you are on the cc list, there is no apparent way to remove yourself. I removed myself and asked Dima to send a test message, which I received. (Thanks, Dima!) I don't mind, I can handle a few extra email messages. But I wonder if there is a way to fix this aspect of trac's configuration for those who are actually bothered by extra trac messages.

I suppose one other thing to try is to have someone else do the removal from the cc list: it may be that once someone displays any activity on the ticket, they are automatically cc'ed after that, even if their only activity was to remove their name from the cc list. If someone else has to do it, that's a lot of effort to be removed from the cc list.



---

archive/issue_comments_401011.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jhpalmieri]:\n> I only have access to OS X, so I have removed myself. \n\n\nActually that's a large part of why I pinged you.  Although this was motivated by fixing an issue on Linux, OSX is the primary reason we package gcc and gfortran at all.  And since this reworks those packages a bit it needs OSX testing.  Plus, whatever disagreements we've had in the past, your reviews are always thorough and thoughtful.  If you don't have time though no problem--I have SSH access to an OSX machine now too (10.14 I believe).\n\n> By the way, once you are on the cc list, there is no apparent way to remove yourself. I removed myself and asked Dima to send a test message, which I received. (Thanks, Dima!) I don't mind, I can handle a few extra email messages. But I wonder if there is a way to fix this aspect of trac's configuration for those who are actually bothered by extra trac messages.\n\n\nHmm, that is annoying.  I believe that once you comment on a trac ticket you're \"subscribed\" to it, even if your only interaction was to remove yourself from the CC list.  \n\nNotification settings are on https://trac.sagemath.org/prefs/notification and you want to make sure to *not* have \"Ticket that I previously updated is modified\" selected.  Unfortunately I don't think there's otherwise a built-in way to \"unsubscribe\" from a specific ticket.",
    "created_at": "2019-01-23T12:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401011",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Replying to [comment:5 jhpalmieri]:
> I only have access to OS X, so I have removed myself. 


Actually that's a large part of why I pinged you.  Although this was motivated by fixing an issue on Linux, OSX is the primary reason we package gcc and gfortran at all.  And since this reworks those packages a bit it needs OSX testing.  Plus, whatever disagreements we've had in the past, your reviews are always thorough and thoughtful.  If you don't have time though no problem--I have SSH access to an OSX machine now too (10.14 I believe).

> By the way, once you are on the cc list, there is no apparent way to remove yourself. I removed myself and asked Dima to send a test message, which I received. (Thanks, Dima!) I don't mind, I can handle a few extra email messages. But I wonder if there is a way to fix this aspect of trac's configuration for those who are actually bothered by extra trac messages.


Hmm, that is annoying.  I believe that once you comment on a trac ticket you're "subscribed" to it, even if your only interaction was to remove yourself from the CC list.  

Notification settings are on https://trac.sagemath.org/prefs/notification and you want to make sure to *not* have "Ticket that I previously updated is modified" selected.  Unfortunately I don't think there's otherwise a built-in way to "unsubscribe" from a specific ticket.



---

archive/issue_comments_401012.json:
```json
{
    "body": "<a id='comment:7'></a>The un-cc-ing problem has been discussed before.\n\nI just opened a wiki page here with pointers to relevant pages on Trac's Trac:\n\n- [SageTracNotification](SageTracNotification)",
    "created_at": "2019-01-24T16:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401012",
    "user": "https://github.com/slel"
}
```

<a id='comment:7'></a>The un-cc-ing problem has been discussed before.

I just opened a wiki page here with pointers to relevant pages on Trac's Trac:

- [SageTracNotification](SageTracNotification)



---

archive/issue_comments_401013.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 embray]:\n> Replying to [comment:5 jhpalmieri]:\n> > I only have access to OS X, so I have removed myself. \n\n> \n> Actually that's a large part of why I pinged you.  Although this was motivated by fixing an issue on Linux, OSX is the primary reason we package gcc and gfortran at all.  And since this reworks those packages a bit it needs OSX testing.  Plus, whatever disagreements we've had in the past, your reviews are always thorough and thoughtful.  If you don't have time though no problem--I have SSH access to an OSX machine now too (10.14 I believe).\n\n\nSorry, I misread something in the ticket description so I thought it didn't apply.\n\nI don't know if I will have the time. I have installed gfortran on all of my OS X machines precisely so I don't have to build Sage's gcc each time I build Sage, so I would have to temporarily hide gfortran, build with and without this branch, making sure everything works as advertised. If I stumble on some free time soon I will try to do it, but it may not happen.",
    "created_at": "2019-01-24T20:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401013",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Replying to [comment:6 embray]:
> Replying to [comment:5 jhpalmieri]:
> > I only have access to OS X, so I have removed myself. 

> 
> Actually that's a large part of why I pinged you.  Although this was motivated by fixing an issue on Linux, OSX is the primary reason we package gcc and gfortran at all.  And since this reworks those packages a bit it needs OSX testing.  Plus, whatever disagreements we've had in the past, your reviews are always thorough and thoughtful.  If you don't have time though no problem--I have SSH access to an OSX machine now too (10.14 I believe).


Sorry, I misread something in the ticket description so I thought it didn't apply.

I don't know if I will have the time. I have installed gfortran on all of my OS X machines precisely so I don't have to build Sage's gcc each time I build Sage, so I would have to temporarily hide gfortran, build with and without this branch, making sure everything works as advertised. If I stumble on some free time soon I will try to do it, but it may not happen.



---

archive/issue_comments_401014.json:
```json
{
    "body": "<a id='comment:9'></a>I've tested this on OSX and had success.  As I had hoped it doesn't ultimately change anything about how gcc is built and installed on OSX. In other words, nothing changed functionality-wise as intended.  This is just mostly refactoring.",
    "created_at": "2019-01-31T12:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401014",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>I've tested this on OSX and had success.  As I had hoped it doesn't ultimately change anything about how gcc is built and installed on OSX. In other words, nothing changed functionality-wise as intended.  This is just mostly refactoring.



---

archive/issue_comments_401015.json:
```json
{
    "body": "<a id='comment:10'></a>I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).",
    "created_at": "2019-01-31T16:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401015",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).



---

archive/issue_comments_401016.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 dimpase]:\n> I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).\n\n\nIs that true, I'm guessing, even without this patch?",
    "created_at": "2019-01-31T16:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401016",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Replying to [comment:10 dimpase]:
> I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).


Is that true, I'm guessing, even without this patch?



---

archive/issue_comments_401017.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 embray]:\n> Replying to [comment:10 dimpase]:\n> > I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).\n\n> \n> Is that true, I'm guessing, even without this patch?\n\n\nCorrect. Sorry for not saying this right.",
    "created_at": "2019-01-31T17:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401017",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>Replying to [comment:11 embray]:
> Replying to [comment:10 dimpase]:
> > I found out I cannot really test this on FreeBSD 12.0, as building of gfortran fails due to some cryptic linker-related problem I don't want to look into (it's not a problem for that platform per se, as it has a luxurious choice of two free fortran compilers, gfortran and flang).

> 
> Is that true, I'm guessing, even without this patch?


Correct. Sorry for not saying this right.



---

archive/issue_comments_401018.json:
```json
{
    "body": "<a id='comment:13'></a>That's okay, I just wanted to make sure that was the case.  Even if FreeBSD support is still not 100% I wouldn't want to make it *worse* somehow.",
    "created_at": "2019-02-01T14:27:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401018",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>That's okay, I just wanted to make sure that was the case.  Even if FreeBSD support is still not 100% I wouldn't want to make it *worse* somehow.



---

archive/issue_comments_401019.json:
```json
{
    "body": "<a id='comment:14'></a>let me check that you don't break using FC=flang",
    "created_at": "2019-02-11T10:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401019",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>let me check that you don't break using FC=flang



---

archive/issue_comments_401020.json:
```json
{
    "body": "<a id='comment:15'></a>Hahah ^^; should that work at all in the first place?  When you say \"using FC=flang\" do you mean just `export FC=flang` to the environment?\n\nTo be clear, I don't think this changes anything in what happens when you run `./configure`.  It does mainly two things:\n\n* Refactors the `spkg-build`/`spkg-install` for the gfortran package so that it does not duplicate much effort from the gcc SPKG.\n\n* Adds the Debian-inspired patch for gcc so that it doesn't install libraries to `${prefix}/lib64` on Linux",
    "created_at": "2019-02-11T10:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401020",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Hahah ^^; should that work at all in the first place?  When you say "using FC=flang" do you mean just `export FC=flang` to the environment?

To be clear, I don't think this changes anything in what happens when you run `./configure`.  It does mainly two things:

* Refactors the `spkg-build`/`spkg-install` for the gfortran package so that it does not duplicate much effort from the gcc SPKG.

* Adds the Debian-inspired patch for gcc so that it doesn't install libraries to `${prefix}/lib64` on Linux



---

archive/issue_comments_401021.json:
```json
{
    "body": "<a id='comment:17'></a>Lgtm",
    "created_at": "2019-02-18T16:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401021",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>Lgtm



---

archive/issue_comments_401022.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-19T13:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401022",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401023.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-22T22:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27016#issuecomment-401023",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_067055.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-22T22:01:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27016",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27016#event-67055"
}
```
