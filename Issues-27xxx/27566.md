# Issue 27566: Unhandled configure error when multiple installation records exist for the same SPKG

archive/issues_027329.json:
```json
{
    "body": "If, by some accident, one ends up with multiple stamp files for the same package in `local/var/lib/sage/installed`, an error occurs when running `./configure`.\n\nFor example, in my case, in the course of development I somehow accidentally wound up with two install records for different versions of mpir.  This results in an error appearing during `./configure` like:\n\n```\n...\n    mpc-1.1.0\n    mpfi-1.5.2\n    mpfr-4.0.1.p0\n    mpfrcx-0.5\n./configure: line 10692: test: local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868: binary operator expected\n    mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0\n    mpmath-1.1.0\n    nauty-26r1.p0\n```\n\nOf course, this should never happen during normal development or usage, but apparently it *can* since I somehow made it happen.\n\nAttached is a possible fix: The configure script now detects this condition as an error, and aborts with an error message that's at least a bit more useful than none at all:\n\n```\n...\n    mpfr-4.0.1.p0\n    mpfrcx-0.5\nconfigure: error: multiple installation records for mpir at\nlocal/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868\nlocal/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0\nonly one should exist so please delete one or both files and re-configure\n```\n\nIt's impossible to know for sure what the best course of action is here, so we give the user a hint and leave it up to them to make a decision and retry.\n\nThe branch is on top of #28788.\n\nCC:  @dimpase @jhpalmieri @saraedum @orlitzky\n\nReviewer: Michael Orlitzky\n\nAuthor: Erik Bray, Matthias Koeppe\n\nBranch: ec9ab87bfdde7f14176d875d74feda838894a0e9\n\nCommit: ec9ab87bfdde7f14176d875d74feda838894a0e9\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27566\n\n",
    "closed_at": "2020-03-18T22:40:36Z",
    "created_at": "2019-03-29T15:41:02Z",
    "labels": [
        "component: build: configure",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Unhandled configure error when multiple installation records exist for the same SPKG",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27566",
    "user": "https://github.com/embray"
}
```
If, by some accident, one ends up with multiple stamp files for the same package in `local/var/lib/sage/installed`, an error occurs when running `./configure`.

For example, in my case, in the course of development I somehow accidentally wound up with two install records for different versions of mpir.  This results in an error appearing during `./configure` like:

```
...
    mpc-1.1.0
    mpfi-1.5.2
    mpfr-4.0.1.p0
    mpfrcx-0.5
./configure: line 10692: test: local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868: binary operator expected
    mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0
    mpmath-1.1.0
    nauty-26r1.p0
```

Of course, this should never happen during normal development or usage, but apparently it *can* since I somehow made it happen.

Attached is a possible fix: The configure script now detects this condition as an error, and aborts with an error message that's at least a bit more useful than none at all:

```
...
    mpfr-4.0.1.p0
    mpfrcx-0.5
configure: error: multiple installation records for mpir at
local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868
local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0
only one should exist so please delete one or both files and re-configure
```

It's impossible to know for sure what the best course of action is here, so we give the user a hint and leave it up to them to make a decision and retry.

The branch is on top of #28788.

CC:  @dimpase @jhpalmieri @saraedum @orlitzky

Reviewer: Michael Orlitzky

Author: Erik Bray, Matthias Koeppe

Branch: ec9ab87bfdde7f14176d875d74feda838894a0e9

Commit: ec9ab87bfdde7f14176d875d74feda838894a0e9

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27566





---

archive/issue_comments_384834.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-03-29T15:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384834",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_384835.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-29T15:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384835",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_384836.json:
```json
{
    "body": "Changing component from build to build: configure.",
    "created_at": "2019-03-29T15:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384836",
    "user": "https://github.com/embray"
}
```

Changing component from build to build: configure.



---

archive/issue_comments_384837.json:
```json
{
    "body": "<a id='comment:3'></a>Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384837",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_events_068474.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27566#event-68474"
}
```



---

archive/issue_comments_384838.json:
```json
{
    "body": "<a id='comment:4'></a>Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384838",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Ticket retargeted after milestone closed



---

archive/issue_events_068475.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27566#event-68475"
}
```



---

archive/issue_events_068476.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27566#event-68476"
}
```



---

archive/issue_comments_384839.json:
```json
{
    "body": "<a id='comment:5'></a>This should be rebased on top of #28788 because it touches the same code.",
    "created_at": "2020-02-09T23:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384839",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>This should be rebased on top of #28788 because it touches the same code.



---

archive/issue_comments_384840.json:
```json
{
    "body": "<a id='comment:7'></a>Last 10 new commits:",
    "created_at": "2020-02-09T23:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384840",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Last 10 new commits:



---

archive/issue_comments_384841.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-16T20:28:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384841",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_384842.json:
```json
{
    "body": "<a id='comment:10'></a>Needs review",
    "created_at": "2020-03-01T00:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384842",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Needs review



---

archive/issue_comments_384843.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-02T01:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384843",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_384844.json:
```json
{
    "body": "<a id='comment:12'></a>New commits:",
    "created_at": "2020-03-02T01:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384844",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>New commits:



---

archive/issue_comments_384845.json:
```json
{
    "body": "<a id='comment:13'></a>`@`embray please take a look.",
    "created_at": "2020-03-06T16:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384845",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>`@`embray please take a look.



---

archive/issue_comments_384846.json:
```json
{
    "body": "<a id='comment:15'></a>Waiting for review",
    "created_at": "2020-03-15T23:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384846",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Waiting for review



---

archive/issue_comments_384847.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-15T23:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384847",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_384848.json:
```json
{
    "body": "<a id='comment:16'></a>I hate to slow down the configure script even more to display a message about a one-in-a-million error condition. The change to `sage_spkg_enable.m4` alone avoids the error. But everything works as advertised.",
    "created_at": "2020-03-15T23:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384848",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:16'></a>I hate to slow down the configure script even more to display a message about a one-in-a-million error condition. The change to `sage_spkg_enable.m4` alone avoids the error. But everything works as advertised.



---

archive/issue_comments_384849.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks!",
    "created_at": "2020-03-15T23:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384849",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Thanks!



---

archive/issue_events_068477.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-18T22:40:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27566#event-68477"
}
```



---

archive/issue_comments_384850.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-18T22:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27566#issuecomment-384850",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
