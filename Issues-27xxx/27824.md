# Issue 27824: spkg-configure.m4 for python3

archive/issues_027587.json:
```json
{
    "body": "Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.\n\nAs suggested in #29032, we make $SAGE_LOCAL a venv (https://docs.python.org/3/library/venv.html) over the system python3 -- if a suitable system python3 is found -- by using the `venv.EnvBuilder` API. \n\nThis is done by the new script `build/bin/sage-venv`, which we use both during `configure` (to make sure that we select a system python3 for which venvs work correctly) and during `make`.\n\nThe venv does not include the system site-packages: We continue to install all Python packages into our venv using the existing build infrastructure. We keep the task of using system site-packages for the follow-up ticket #29023.\n\n(Note, we use `venv` (new since Python 3.3), not `virtualenv`. So this change is limited to Python 3 builds of Sage.)\n\n\n\nCC:  @jdemeyer @embray @vbraun @kiwifb @jhpalmieri @videlec\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe, Erik Bray\n\nBranch: 1c845a4169769157787cdc3e2df37c08a6914891\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27824\n\n",
    "closed_at": "2020-03-29T00:24:15Z",
    "created_at": "2019-05-13T15:52:41Z",
    "labels": [
        "component: build: configure"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "spkg-configure.m4 for python3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27824",
    "user": "https://github.com/dimpase"
}
```
Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.

As suggested in #29032, we make $SAGE_LOCAL a venv (https://docs.python.org/3/library/venv.html) over the system python3 -- if a suitable system python3 is found -- by using the `venv.EnvBuilder` API. 

This is done by the new script `build/bin/sage-venv`, which we use both during `configure` (to make sure that we select a system python3 for which venvs work correctly) and during `make`.

The venv does not include the system site-packages: We continue to install all Python packages into our venv using the existing build infrastructure. We keep the task of using system site-packages for the follow-up ticket #29023.

(Note, we use `venv` (new since Python 3.3), not `virtualenv`. So this change is limited to Python 3 builds of Sage.)



CC:  @jdemeyer @embray @vbraun @kiwifb @jhpalmieri @videlec

Reviewer: Dima Pasechnik

Author: Matthias Koeppe, Erik Bray

Branch: 1c845a4169769157787cdc3e2df37c08a6914891

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27824





---

archive/issue_comments_414348.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,6 +1,19 @@\n do not install pythonX if we are in the virtenv of pythonX.\n \n At the moment I don't know how feasible it is - one small obstacle might be that we really do not want to mess with two pythons at the same time.\n+\n+while it should be possible/desirable to use a system python, any additional Python packages should optionally be installable into a virtualenv instead of the system site-packages, including sagelib itself unless the system *happens* to meet all of sagelib's Python dependencies already.  Listing some relevant Python packages below:\n+* cysignals\n+* cython\n+* ipython\n+* jinja2\n+* jupyter_core\n+* numpy\n+* scipy\n+* sympy\n+* pip\n+* setuptools\n+* six\n \n Comment: 1\n \n```\n",
    "created_at": "2019-05-13T15:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414348",
    "user": "https://github.com/dimpase"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,6 +1,19 @@
 do not install pythonX if we are in the virtenv of pythonX.
 
 At the moment I don't know how feasible it is - one small obstacle might be that we really do not want to mess with two pythons at the same time.
+
+while it should be possible/desirable to use a system python, any additional Python packages should optionally be installable into a virtualenv instead of the system site-packages, including sagelib itself unless the system *happens* to meet all of sagelib's Python dependencies already.  Listing some relevant Python packages below:
+* cysignals
+* cython
+* ipython
+* jinja2
+* jupyter_core
+* numpy
+* scipy
+* sympy
+* pip
+* setuptools
+* six
 
 Comment: 1
 
```




---

archive/issue_comments_414349.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,20 @@\n+do not install pythonX if we are in the virtenv of pythonX.\n \n+At the moment I don't know how feasible it is - one small obstacle might be that we really do not want to mess with two pythons at the same time.\n+\n+while it should be possible/desirable to use a system python, any additional Python packages should optionally be installable into a virtualenv instead of the system site-packages, including sagelib itself unless the system *happens* to meet all of sagelib's Python dependencies already.  Listing some relevant Python packages below:\n+* cysignals\n+* cython\n+* ipython\n+* jinja2\n+* jupyter_core\n+* numpy\n+* scipy\n+* sympy\n+* pip\n+* setuptools\n+* pkgconfig\n+* six\n \n Comment: 1\n \n```\n",
    "created_at": "2019-05-13T21:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414349",
    "user": "https://github.com/dimpase"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,20 @@
+do not install pythonX if we are in the virtenv of pythonX.
 
+At the moment I don't know how feasible it is - one small obstacle might be that we really do not want to mess with two pythons at the same time.
+
+while it should be possible/desirable to use a system python, any additional Python packages should optionally be installable into a virtualenv instead of the system site-packages, including sagelib itself unless the system *happens* to meet all of sagelib's Python dependencies already.  Listing some relevant Python packages below:
+* cysignals
+* cython
+* ipython
+* jinja2
+* jupyter_core
+* numpy
+* scipy
+* sympy
+* pip
+* setuptools
+* pkgconfig
+* six
 
 Comment: 1
 
```




---

archive/issue_comments_414350.json:
```json
{
    "body": "<a id='comment:3'></a>As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414350",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_414351.json:
```json
{
    "body": "<a id='comment:4'></a>For Python packages when installing using the system Python we definitely need a well thought out approach, likely with different options for handling questions such as where to install additional Python packages.\n\n`$SAGE_LOCAL` *already* acts as a sort-of virtualenv, but we might still consider using virtualenv/venv in `$SAGE_LOCAL` (with the `--system-site-packages` option) as a way of extending `sys.path` while still using as many system Python packages as possible.",
    "created_at": "2019-08-14T11:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414351",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>For Python packages when installing using the system Python we definitely need a well thought out approach, likely with different options for handling questions such as where to install additional Python packages.

`$SAGE_LOCAL` *already* acts as a sort-of virtualenv, but we might still consider using virtualenv/venv in `$SAGE_LOCAL` (with the `--system-site-packages` option) as a way of extending `sys.path` while still using as many system Python packages as possible.



---

archive/issue_comments_414352.json:
```json
{
    "body": "<a id='comment:5'></a>See #29013 - \"In a python3 build, install all Python packages into a venv\"",
    "created_at": "2020-01-14T22:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414352",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>See #29013 - "In a python3 build, install all Python packages into a venv"



---

archive/issue_comments_414353.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,7 @@\n+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.\n+\n+Via #29013, we install all of our own Python packages into a separate venv that includes the system site-packages.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-01-15T02:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414353",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,7 @@
+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.
+
+Via #29013, we install all of our own Python packages into a separate venv that includes the system site-packages.
+
 
 
 Comment: 1
```




---

archive/issue_comments_414354.json:
```json
{
    "body": "<a id='comment:6'></a>Narrowed the ticket to py3.",
    "created_at": "2020-01-15T02:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414354",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Narrowed the ticket to py3.



---

archive/issue_comments_414355.json:
```json
{
    "body": "<a id='comment:8'></a>Here's a version that works. The venv is created in `build/make/Makefile` target (in #29013, I created the venv in the `spkg-postinst` script of the `python3` spkg.) \n\n---\nNew commits:",
    "created_at": "2020-01-15T04:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414355",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Here's a version that works. The venv is created in `build/make/Makefile` target (in #29013, I created the venv in the `spkg-postinst` script of the `python3` spkg.) 

---
New commits:



---

archive/issue_events_068973.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-15T04:48:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27824#event-68973"
}
```



---

archive/issue_comments_414356.json:
```json
{
    "body": "<a id='comment:10'></a>how about checking for Py3 deps: `sqlite libpng bzip2 xz libffi` ?\n(I skipped in this list ones that are 2nd order, so no need to check them)",
    "created_at": "2020-01-15T10:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414356",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>how about checking for Py3 deps: `sqlite libpng bzip2 xz libffi` ?
(I skipped in this list ones that are 2nd order, so no need to check them)



---

archive/issue_comments_414357.json:
```json
{
    "body": "<a id='comment:11'></a>On Gentoo Python 3 does not have sqlite module by default. I had to do\n`$ pip install pysqlite3 --user`, and still `elliptic_curves` spkg installation errors out.",
    "created_at": "2020-01-15T11:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414357",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>On Gentoo Python 3 does not have sqlite module by default. I had to do
`$ pip install pysqlite3 --user`, and still `elliptic_curves` spkg installation errors out.



---

archive/issue_comments_414358.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T14:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414358",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414359.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T14:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414359",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414360.json:
```json
{
    "body": "<a id='comment:14'></a>I've reduced the scope of the ticket, excluding the use of system site packages.",
    "created_at": "2020-01-15T14:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414360",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>I've reduced the scope of the ticket, excluding the use of system site packages.



---

archive/issue_comments_414361.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.\n+\n+Via #29013, we install all of our own Python packages into a separate venv.\n+\n+The venv does not include the system site-packages; we keep that task for a follow-up ticket.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-01-15T14:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414361",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,9 @@
+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.
+
+Via #29013, we install all of our own Python packages into a separate venv.
+
+The venv does not include the system site-packages; we keep that task for a follow-up ticket.
+
 
 
 Comment: 1
```




---

archive/issue_comments_414362.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T16:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414362",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414363.json:
```json
{
    "body": "<a id='comment:16'></a>I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)\nand it broke at docbuild, with\n\n```\nRuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work\n```\neven though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)",
    "created_at": "2020-01-15T18:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414363",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)
and it broke at docbuild, with

```
RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
```
even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)



---

archive/issue_comments_414364.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks for testing!",
    "created_at": "2020-01-15T18:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414364",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Thanks for testing!



---

archive/issue_comments_414365.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:14 mkoeppe]:\n> I've reduced the scope of the ticket, excluding the use of system site packages.\n\n\ndo you mean pip/etc-installed `site-packages` of system's Python?",
    "created_at": "2020-01-15T18:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414365",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>Replying to [comment:14 mkoeppe]:
> I've reduced the scope of the ticket, excluding the use of system site packages.


do you mean pip/etc-installed `site-packages` of system's Python?



---

archive/issue_comments_414366.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 dimpase]:\n> Replying to [comment:14 mkoeppe]:\n> > I've reduced the scope of the ticket, excluding the use of system site packages.\n\n> \n> do you mean pip/etc-installed `site-packages` of system's Python?\n\n\nYes.",
    "created_at": "2020-01-15T18:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414366",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Replying to [comment:18 dimpase]:
> Replying to [comment:14 mkoeppe]:
> > I've reduced the scope of the ticket, excluding the use of system site packages.

> 
> do you mean pip/etc-installed `site-packages` of system's Python?


Yes.



---

archive/issue_comments_414367.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-01-15T20:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414367",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_414368.json:
```json
{
    "body": "<a id='comment:22'></a>Now this is giving\n\n```\n[pillow-5.3.0.p0] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk/usr/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers -g -DHAVE_OPENJPEG -DHAVE_LIBZ -DHAVE_LIBTIFF -DPILLOW_VERSION=\"5.3.0\" -I/usr/local/Cellar/openjpeg/2.3.1/include/openjpeg-2.3 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/var/tmp/sage/build/pillow-5.3.0.p0/src/src/libImaging -I/usr/local/Cellar/jpeg/9c/include -I/usr/local/Cellar/libtiff/4.1.0/include -I/usr/local/Cellar/freetype/2.10.1/include/freetype2 -I/usr/local/Cellar/little-cms2/2.9/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/lib/sage/venv/sage/include -I/usr/local/include -I/usr/local/Cellar/freetype/2.10.1/include -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/lib/sage/venv/sage/include -I/usr/local/Cellar/python/3.7.6_1/Frameworks/Python.framework/Versions/3.7/include/python3.7m -c src/_imaging.c -o build/temp.macosx-10.15-x86_64-3.7/src/_imaging.o\n[pillow-5.3.0.p0] error: $MACOSX_DEPLOYMENT_TARGET mismatch: now \"10.9\" but \"10.15\" during configure\n[pillow-5.3.0.p0] ********************************************************************************\n```\nThis is coming from the fake `MACOSX_DEPLOYMENT_TARGET` set in `sage-env`. See #18272, #7095, #18254, #16312.",
    "created_at": "2020-01-15T21:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414368",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Now this is giving

```
[pillow-5.3.0.p0] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk/usr/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers -g -DHAVE_OPENJPEG -DHAVE_LIBZ -DHAVE_LIBTIFF -DPILLOW_VERSION="5.3.0" -I/usr/local/Cellar/openjpeg/2.3.1/include/openjpeg-2.3 -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/var/tmp/sage/build/pillow-5.3.0.p0/src/src/libImaging -I/usr/local/Cellar/jpeg/9c/include -I/usr/local/Cellar/libtiff/4.1.0/include -I/usr/local/Cellar/freetype/2.10.1/include/freetype2 -I/usr/local/Cellar/little-cms2/2.9/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/lib/sage/venv/sage/include -I/usr/local/include -I/usr/local/Cellar/freetype/2.10.1/include -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-venv/local/lib/sage/venv/sage/include -I/usr/local/Cellar/python/3.7.6_1/Frameworks/Python.framework/Versions/3.7/include/python3.7m -c src/_imaging.c -o build/temp.macosx-10.15-x86_64-3.7/src/_imaging.o
[pillow-5.3.0.p0] error: $MACOSX_DEPLOYMENT_TARGET mismatch: now "10.9" but "10.15" during configure
[pillow-5.3.0.p0] ********************************************************************************
```
This is coming from the fake `MACOSX_DEPLOYMENT_TARGET` set in `sage-env`. See #18272, #7095, #18254, #16312.



---

archive/issue_comments_414369.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-15T22:08:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414369",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414370.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:16 dimpase]:\n> I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)\n> and it broke at docbuild, with\n> \n> ```\n> RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work\n> ```\n> even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)\n\nFixed now.",
    "created_at": "2020-01-15T22:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414370",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Replying to [comment:16 dimpase]:
> I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)
> and it broke at docbuild, with
> 
> ```
> RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
> ```
> even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)

Fixed now.



---

archive/issue_comments_414371.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.\n+\n+Via #29013, we install all of our own Python packages into a separate venv.\n+\n+The venv does not include the system site-packages; we keep that task for the follow-up ticket #29023.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-01-15T23:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414371",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,9 @@
+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.
+
+Via #29013, we install all of our own Python packages into a separate venv.
+
+The venv does not include the system site-packages; we keep that task for the follow-up ticket #29023.
+
 
 
 Comment: 1
```




---

archive/issue_comments_414372.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-16T00:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414372",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_414373.json:
```json
{
    "body": "<a id='comment:27'></a>Compiles OK on macOS with homebrew. `make ptestlong` mostly good except for\n- GLPK output (spkg-configure should really reject a libglpk that talks too much) - it makes it hard to see actual failures\n- and numerical failures in `src/sage/matrix/matrix2.pyx`, `src/sage/finance/time_series.pyx`, and `src/sage/schemes/affine/affine_homset.py` as reported in #29013\n\n```\nsage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed\nsage -t --long src/sage/finance/time_series.pyx  # 5 doctests failed\nsage -t --long src/sage/schemes/affine/affine_homset.py  # 1 doctest failed\n```",
    "created_at": "2020-01-16T02:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414373",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Compiles OK on macOS with homebrew. `make ptestlong` mostly good except for
- GLPK output (spkg-configure should really reject a libglpk that talks too much) - it makes it hard to see actual failures
- and numerical failures in `src/sage/matrix/matrix2.pyx`, `src/sage/finance/time_series.pyx`, and `src/sage/schemes/affine/affine_homset.py` as reported in #29013

```
sage -t --long src/sage/matrix/matrix2.pyx  # 2 doctests failed
sage -t --long src/sage/finance/time_series.pyx  # 5 doctests failed
sage -t --long src/sage/schemes/affine/affine_homset.py  # 1 doctest failed
```



---

archive/issue_comments_414374.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T03:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414374",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414375.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:24 mkoeppe]:\n> Replying to [comment:16 dimpase]:\n> > I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)\n> > and it broke at docbuild, with\n> > \n> > ```\n> > RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work\n> > ```\n> > even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)\n\n> Fixed now.\n\nafter this fix, it builds and passes most tests on Gentoo (some errors related to cryptominisat that I had installed, and it probably got broken in some way)",
    "created_at": "2020-01-16T08:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414375",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>Replying to [comment:24 mkoeppe]:
> Replying to [comment:16 dimpase]:
> > I tried this on gentoo (after a usual struggle to get sqlite3 module built in Python)
> > and it broke at docbuild, with
> > 
> > ```
> > RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
> > ```
> > even though `libSingular` has built just fine (it's some magic with `from sage.env import SINGULAR_SO` that is broken, so `SINGULAR_SO` is `None`)

> Fixed now.

after this fix, it builds and passes most tests on Gentoo (some errors related to cryptominisat that I had installed, and it probably got broken in some way)



---

archive/issue_comments_414376.json:
```json
{
    "body": "<a id='comment:30'></a>I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)\n\n```\nsage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py\n**********************************************************************\nFile \"src/sage/sat/solvers/cryptominisat.py\", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat\nFailed example:\n    solver = CryptoMiniSat()                                  # optional - cryptominisat\nException raised:\n    Traceback (most recent call last):\n      File \"/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py\", line 69, in __init__\n        from pycryptosat import Solver\n    ModuleNotFoundError: No module named 'pycryptosat'\n```\nI wonder whether it uses a convoluted way to create python extensions, which got broken.",
    "created_at": "2020-01-16T09:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414376",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>I see a problem with cryptominisat spkg on this branch (which otherwise builds and passes most tests (not related to this packages) on Gentoo)

```
sage -t --warn-long 88.1 src/sage/sat/solvers/cryptominisat.py
**********************************************************************
File "src/sage/sat/solvers/cryptominisat.py", line 49, in sage.sat.solvers.cryptominisat.CryptoMiniSat
Failed example:
    solver = CryptoMiniSat()                                  # optional - cryptominisat
Exception raised:
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/sage/venv/sage/lib/python3.7/site-packages/sage/sat/solvers/cryptominisat.py", line 69, in __init__
        from pycryptosat import Solver
    ModuleNotFoundError: No module named 'pycryptosat'
```
I wonder whether it uses a convoluted way to create python extensions, which got broken.



---

archive/issue_comments_414377.json:
```json
{
    "body": "<a id='comment:31'></a>I see (on a system where cryptominisat package works) that it is one of few packages that get installed without a sub-directory named the same as package in site-packages:\n\n```\nsage: import pycryptosat\nsage: print(pycryptosat.__file__)\n/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/pycryptosat.cpython-37m-x86_64-linux-gnu.so\nsage: import numpy\nsage: print(numpy.__file__)\n/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/numpy/__init__.py\n```\n\nNot sure whether this is a bug on the package, or a bug in this branch.\nOn this branch I see (with `local=SAGE_LOCAL`)\n\n```\n$ ls local/lib/python3.7/site-packages/*\nlocal/lib/python3.7/site-packages/pycryptosat-0.2.0-py3.7.egg-info  local/lib/python3.7/site-packages/pycryptosat.cpython-37m-x86_64-linux-gnu.so\n```\nSo it seems that this branch does not pick up anything from that location.",
    "created_at": "2020-01-16T09:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414377",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>I see (on a system where cryptominisat package works) that it is one of few packages that get installed without a sub-directory named the same as package in site-packages:

```
sage: import pycryptosat
sage: print(pycryptosat.__file__)
/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/pycryptosat.cpython-37m-x86_64-linux-gnu.so
sage: import numpy
sage: print(numpy.__file__)
/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/numpy/__init__.py
```

Not sure whether this is a bug on the package, or a bug in this branch.
On this branch I see (with `local=SAGE_LOCAL`)

```
$ ls local/lib/python3.7/site-packages/*
local/lib/python3.7/site-packages/pycryptosat-0.2.0-py3.7.egg-info  local/lib/python3.7/site-packages/pycryptosat.cpython-37m-x86_64-linux-gnu.so
```
So it seems that this branch does not pick up anything from that location.



---

archive/issue_comments_414378.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T14:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414378",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414379.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T16:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414379",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414380.json:
```json
{
    "body": "<a id='comment:34'></a>What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear.  It seems to me another reason to avoid all the venv stuff...",
    "created_at": "2020-01-16T18:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414380",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear.  It seems to me another reason to avoid all the venv stuff...



---

archive/issue_comments_414381.json:
```json
{
    "body": "<a id='comment:35'></a>So, all that `$VIRTUAL_ENV/bin/activate` does, essentially, is to set 3 environment variables: `PATH` (to which it inserts `$VIRTUAL_ENV/bin` in the front), `PS1` (which Sage also already sets when activating the sage environment), and the `$VIRTUAL_ENV` environment variable itself.\n\nOther than that, the only thing that really makes a directory a virtualenv (with Python 3 + venv, I'm not counting the old virtualenv) is the presence of `pyvenv.cfg` in the install prefix.  The format of this file is more-or-less documented (albeit not very clearly) in https://docs.python.org/3/library/venv.html.  So all we really need to do to turn `$SAGE_LOCAL` into a virtualenv of a system Python 3 is to write the appropriate `pyvenv.cfg` into `$SAGE_LOCAL`, and not mess around with the full `venv` command at all.  That, and make `$SAGE_LOCAL/bin/python3` a symlink to the real python3.\n\nAlthough not strictly necessary, it is also possibly helpful to third-party tools to set the `$VIRTUAL_ENV` environment variable.",
    "created_at": "2020-01-16T18:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414381",
    "user": "https://github.com/embray"
}
```

<a id='comment:35'></a>So, all that `$VIRTUAL_ENV/bin/activate` does, essentially, is to set 3 environment variables: `PATH` (to which it inserts `$VIRTUAL_ENV/bin` in the front), `PS1` (which Sage also already sets when activating the sage environment), and the `$VIRTUAL_ENV` environment variable itself.

Other than that, the only thing that really makes a directory a virtualenv (with Python 3 + venv, I'm not counting the old virtualenv) is the presence of `pyvenv.cfg` in the install prefix.  The format of this file is more-or-less documented (albeit not very clearly) in https://docs.python.org/3/library/venv.html.  So all we really need to do to turn `$SAGE_LOCAL` into a virtualenv of a system Python 3 is to write the appropriate `pyvenv.cfg` into `$SAGE_LOCAL`, and not mess around with the full `venv` command at all.  That, and make `$SAGE_LOCAL/bin/python3` a symlink to the real python3.

Although not strictly necessary, it is also possibly helpful to third-party tools to set the `$VIRTUAL_ENV` environment variable.



---

archive/issue_comments_414382.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:34 embray]:\n> What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear. \n\n\nIt is used in a configure test, `build/pkgs/python3/spkg-configure.m4` to make sure that the system python has all optional modules that we need.",
    "created_at": "2020-01-16T18:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414382",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Replying to [comment:34 embray]:
> What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear. 


It is used in a configure test, `build/pkgs/python3/spkg-configure.m4` to make sure that the system python has all optional modules that we need.



---

archive/issue_comments_414383.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:35 embray]:\n> So all we really need to do to turn `$SAGE_LOCAL` into a virtualenv of a system Python 3 is to write the appropriate `pyvenv.cfg` into `$SAGE_LOCAL`, and not mess around with the full `venv` command at all.  \n\n\nThis amounts to trying to upgrade python3's `venv` to something like a conda environment. This is what I avoid in #29013 on purpose - the `venv` is only used in a clean, documented way, using the documented tools.",
    "created_at": "2020-01-16T18:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414383",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Replying to [comment:35 embray]:
> So all we really need to do to turn `$SAGE_LOCAL` into a virtualenv of a system Python 3 is to write the appropriate `pyvenv.cfg` into `$SAGE_LOCAL`, and not mess around with the full `venv` command at all.  


This amounts to trying to upgrade python3's `venv` to something like a conda environment. This is what I avoid in #29013 on purpose - the `venv` is only used in a clean, documented way, using the documented tools.



---

archive/issue_comments_414384.json:
```json
{
    "body": "<a id='comment:38'></a>writing `pyvenv.cfg` by hand is bound to be broken at some point, as it's an implementation detail of venv.\nThe correct interface to `venv` is to use `venv`, I think.\n\n(By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))",
    "created_at": "2020-01-16T18:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414384",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'></a>writing `pyvenv.cfg` by hand is bound to be broken at some point, as it's an implementation detail of venv.
The correct interface to `venv` is to use `venv`, I think.

(By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))



---

archive/issue_comments_414385.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:38 dimpase]:\n> (By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))\n\nGlad we have this on record now for the software historians/archaeologists to discover :)",
    "created_at": "2020-01-16T18:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414385",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Replying to [comment:38 dimpase]:
> (By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))

Glad we have this on record now for the software historians/archaeologists to discover :)



---

archive/issue_comments_414386.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:38 dimpase]:\n> writing `pyvenv.cfg` by hand is bound to be broken at some point, as it's an implementation detail of venv.\n> The correct interface to `venv` is to use `venv`, I think.\n\n\nThat's not true.  It's documented both in the documentation for the `venv` module and the `site` module.  If you really want to avoid writing it by hand the `venv` module includes code for that as well.  This (with the *system* Python 3) is effectively the same (albeit more opaque).  From within SAGE_ROOT, but without the sage environment activated:\n\n```\n$ python3 -c 'import venv; b = venv.EnvBuilder(); c = b.ensure_directories(\"local\"); b.create_configuration(c)'\n$ cat local/pyvenv.cfg\nhome = /usr/bin\ninclude-system-site-packages = false\nversion = 3.6.8\n```\n\nbut I think even that's overkill for now.",
    "created_at": "2020-01-16T19:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414386",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'></a>Replying to [comment:38 dimpase]:
> writing `pyvenv.cfg` by hand is bound to be broken at some point, as it's an implementation detail of venv.
> The correct interface to `venv` is to use `venv`, I think.


That's not true.  It's documented both in the documentation for the `venv` module and the `site` module.  If you really want to avoid writing it by hand the `venv` module includes code for that as well.  This (with the *system* Python 3) is effectively the same (albeit more opaque).  From within SAGE_ROOT, but without the sage environment activated:

```
$ python3 -c 'import venv; b = venv.EnvBuilder(); c = b.ensure_directories("local"); b.create_configuration(c)'
$ cat local/pyvenv.cfg
home = /usr/bin
include-system-site-packages = false
version = 3.6.8
```

but I think even that's overkill for now.



---

archive/issue_comments_414387.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:36 mkoeppe]:\n> Replying to [comment:34 embray]:\n> > What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear. \n\n> \n> It is used in a configure test, `build/pkgs/python3/spkg-configure.m4` to make sure that the system python has all optional modules that we need.\n\n\nBut why do you need to make a virtualenv for that?  Why not run the system python directly?",
    "created_at": "2020-01-16T19:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414387",
    "user": "https://github.com/embray"
}
```

<a id='comment:41'></a>Replying to [comment:36 mkoeppe]:
> Replying to [comment:34 embray]:
> > What's the deal with `config_venv`?  Why is any of that necessary?  I looked at the commit that added it but it wasn't clear. 

> 
> It is used in a configure test, `build/pkgs/python3/spkg-configure.m4` to make sure that the system python has all optional modules that we need.


But why do you need to make a virtualenv for that?  Why not run the system python directly?



---

archive/issue_comments_414388.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 embray]:\n> But why do you need to make a virtualenv for that?  Why not run the system python directly?\n\nOn this ticket, the system python is not used directly but rather in a venv without site-packages.\nTherefore the correct test is to test whether the module will be available in a venv.",
    "created_at": "2020-01-16T19:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414388",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>Replying to [comment:41 embray]:
> But why do you need to make a virtualenv for that?  Why not run the system python directly?

On this ticket, the system python is not used directly but rather in a venv without site-packages.
Therefore the correct test is to test whether the module will be available in a venv.



---

archive/issue_comments_414389.json:
```json
{
    "body": "<a id='comment:43'></a>I'll add this documentation to the branch.",
    "created_at": "2020-01-16T19:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414389",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'></a>I'll add this documentation to the branch.



---

archive/issue_comments_414390.json:
```json
{
    "body": "<a id='comment:44'></a>Replying to [comment:39 mkoeppe]:\n> Replying to [comment:38 dimpase]:\n> > (By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))\n\n> Glad we have this on record now for the software historians/archaeologists to discover :)\nit's here:\nhttps://trac.sagemath.org/ticket/27824?version=0",
    "created_at": "2020-01-16T19:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414390",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:44'></a>Replying to [comment:39 mkoeppe]:
> Replying to [comment:38 dimpase]:
> > (By the way, the idea of using venv/virtualenv is probably mine, IIRC I put it in the original version of this ticket :-))

> Glad we have this on record now for the software historians/archaeologists to discover :)
it's here:
https://trac.sagemath.org/ticket/27824?version=0



---

archive/issue_comments_414391.json:
```json
{
    "body": "<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T19:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414391",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414392.json:
```json
{
    "body": "<a id='comment:46'></a>By the way, should I be checking for the ssl module too?",
    "created_at": "2020-01-16T19:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414392",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>By the way, should I be checking for the ssl module too?



---

archive/issue_comments_414393.json:
```json
{
    "body": "<a id='comment:47'></a>Replying to [comment:42 mkoeppe]:\n> Replying to [comment:41 embray]:\n> > But why do you need to make a virtualenv for that?  Why not run the system python directly?\n\n> On this ticket, the system python is not used directly but rather in a venv without site-packages.\n> Therefore the correct test is to test whether the module will be available in a venv.\n\n\nBut why?",
    "created_at": "2020-01-16T19:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414393",
    "user": "https://github.com/embray"
}
```

<a id='comment:47'></a>Replying to [comment:42 mkoeppe]:
> Replying to [comment:41 embray]:
> > But why do you need to make a virtualenv for that?  Why not run the system python directly?

> On this ticket, the system python is not used directly but rather in a venv without site-packages.
> Therefore the correct test is to test whether the module will be available in a venv.


But why?



---

archive/issue_comments_414394.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:47 embray]:\n> Replying to [comment:42 mkoeppe]:\n> > Replying to [comment:41 embray]:\n> > > But why do you need to make a virtualenv for that?  Why not run the system python directly?\n\n> > On this ticket, the system python is not used directly but rather in a venv without site-packages.\n> > Therefore the correct test is to test whether the module will be available in a venv.\n\n> \n> But why?\n\n\nWait, I misunderstood what you wrote at first.  I know why it uses a virtualenv.  What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?",
    "created_at": "2020-01-16T19:52:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414394",
    "user": "https://github.com/embray"
}
```

<a id='comment:48'></a>Replying to [comment:47 embray]:
> Replying to [comment:42 mkoeppe]:
> > Replying to [comment:41 embray]:
> > > But why do you need to make a virtualenv for that?  Why not run the system python directly?

> > On this ticket, the system python is not used directly but rather in a venv without site-packages.
> > Therefore the correct test is to test whether the module will be available in a venv.

> 
> But why?


Wait, I misunderstood what you wrote at first.  I know why it uses a virtualenv.  What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?



---

archive/issue_comments_414395.json:
```json
{
    "body": "<a id='comment:49'></a>Replying to [comment:48 embray]:\n> What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?\n\nBecause system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.",
    "created_at": "2020-01-16T19:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414395",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>Replying to [comment:48 embray]:
> What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?

Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.



---

archive/issue_comments_414396.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:46 mkoeppe]:\n> By the way, should I be checking for the ssl module too?\n\nI think I'll check for all modules mentioned in #27705.",
    "created_at": "2020-01-16T20:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414396",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>Replying to [comment:46 mkoeppe]:
> By the way, should I be checking for the ssl module too?

I think I'll check for all modules mentioned in #27705.



---

archive/issue_comments_414397.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 mkoeppe]:\n> Replying to [comment:48 embray]:\n> > What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?\n\n> Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.\n\nSo use `python3 -S` if you really want to be sure.  That disables site-packages.",
    "created_at": "2020-01-16T20:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414397",
    "user": "https://github.com/embray"
}
```

<a id='comment:51'></a>Replying to [comment:49 mkoeppe]:
> Replying to [comment:48 embray]:
> > What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?

> Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.

So use `python3 -S` if you really want to be sure.  That disables site-packages.



---

archive/issue_comments_414398.json:
```json
{
    "body": "<a id='comment:52'></a>An interesting discovery while playing around with this:  By default Ubuntu's Python does not have distutils.  You have to explicitly `apt-get install python3-distutils`.  So this is something we also need to check for at configure time or else it wont be possible to install Python packages.",
    "created_at": "2020-01-16T20:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414398",
    "user": "https://github.com/embray"
}
```

<a id='comment:52'></a>An interesting discovery while playing around with this:  By default Ubuntu's Python does not have distutils.  You have to explicitly `apt-get install python3-distutils`.  So this is something we also need to check for at configure time or else it wont be possible to install Python packages.



---

archive/issue_comments_414399.json:
```json
{
    "body": "<a id='comment:53'></a>FWIW I'm experimenting with an alternative solution based on my comments here (albeit with significant pieces taken from this ticket!)  I'll update when I have something that I think works...",
    "created_at": "2020-01-16T20:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414399",
    "user": "https://github.com/embray"
}
```

<a id='comment:53'></a>FWIW I'm experimenting with an alternative solution based on my comments here (albeit with significant pieces taken from this ticket!)  I'll update when I have something that I think works...



---

archive/issue_comments_414400.json:
```json
{
    "body": "<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T21:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414400",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414401.json:
```json
{
    "body": "<a id='comment:55'></a>Replying to [comment:52 embray]:\n>  By default Ubuntu's Python does not have distutils.  You have to explicitly `apt-get install python3-distutils`.  So this is something we also need to check for at configure time or else it wont be possible to install Python packages.\n\nThanks! I'll add this test.",
    "created_at": "2020-01-16T22:10:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414401",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:55'></a>Replying to [comment:52 embray]:
>  By default Ubuntu's Python does not have distutils.  You have to explicitly `apt-get install python3-distutils`.  So this is something we also need to check for at configure time or else it wont be possible to install Python packages.

Thanks! I'll add this test.



---

archive/issue_comments_414402.json:
```json
{
    "body": "<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-16T22:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414402",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414403.json:
```json
{
    "body": "<a id='comment:57'></a>Also, of course, one needs the Python headers, on Ubuntu from `libpython3.7-dev`.",
    "created_at": "2020-01-16T22:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414403",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:57'></a>Also, of course, one needs the Python headers, on Ubuntu from `libpython3.7-dev`.



---

archive/issue_comments_414404.json:
```json
{
    "body": "<a id='comment:58'></a>So I'll add a check that the distutils can actually build an extension.",
    "created_at": "2020-01-16T23:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414404",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>So I'll add a check that the distutils can actually build an extension.



---

archive/issue_comments_414405.json:
```json
{
    "body": "<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-17T01:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414405",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414406.json:
```json
{
    "body": "Attachment [Dockerfile-ubuntu-minimal](tarball://root/attachments/some-uuid/ticket27824/Dockerfile-ubuntu-minimal) by @mkoeppe created at 2020-01-17 03:57:53",
    "created_at": "2020-01-17T03:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414406",
    "user": "https://github.com/mkoeppe"
}
```

Attachment [Dockerfile-ubuntu-minimal](tarball://root/attachments/some-uuid/ticket27824/Dockerfile-ubuntu-minimal) by @mkoeppe created at 2020-01-17 03:57:53



---

archive/issue_comments_414407.json:
```json
{
    "body": "<a id='comment:60'></a>Testing with the attached Dockerfile on ubuntu bionic.\n\nmodule and distutils checking seems to work correctly.\n\nGot stuck at `scipy` install. \n\n```\n[scipy-1.2.0]     numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.\n```\n\nLooks like `scipy` would need a sitecfg as well so that it finds BLAS. It's strange that we build numpy with providing `site.cfg` (which we just had to correct in #29025), but `scipy` without `site.cfg`.",
    "created_at": "2020-01-17T04:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414407",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:60'></a>Testing with the attached Dockerfile on ubuntu bionic.

module and distutils checking seems to work correctly.

Got stuck at `scipy` install. 

```
[scipy-1.2.0]     numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.
```

Looks like `scipy` would need a sitecfg as well so that it finds BLAS. It's strange that we build numpy with providing `site.cfg` (which we just had to correct in #29025), but `scipy` without `site.cfg`.



---

archive/issue_comments_414408.json:
```json
{
    "body": "<a id='comment:61'></a>Replying to [comment:60 mkoeppe]:\n> Testing with the attached Dockerfile on ubuntu bionic.\n> \n> module and distutils checking seems to work correctly.\n> \n> Got stuck at `scipy` install. \n> \n> ```\n> [scipy-1.2.0]     numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.\n> ```\n> \n> Looks like `scipy` would need a sitecfg as well so that it finds BLAS. It's strange that we build numpy with providing `site.cfg` (which we just had to correct in #29025), but `scipy` without `site.cfg`.\n\n\n`@`fbissey, based on your work on scipy configuration in #20157, would you be able to help with this?",
    "created_at": "2020-01-17T04:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414408",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:61'></a>Replying to [comment:60 mkoeppe]:
> Testing with the attached Dockerfile on ubuntu bionic.
> 
> module and distutils checking seems to work correctly.
> 
> Got stuck at `scipy` install. 
> 
> ```
> [scipy-1.2.0]     numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.
> ```
> 
> Looks like `scipy` would need a sitecfg as well so that it finds BLAS. It's strange that we build numpy with providing `site.cfg` (which we just had to correct in #29025), but `scipy` without `site.cfg`.


`@`fbissey, based on your work on scipy configuration in #20157, would you be able to help with this?



---

archive/issue_comments_414409.json:
```json
{
    "body": "<a id='comment:62'></a>You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.",
    "created_at": "2020-01-17T04:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414409",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:62'></a>You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.



---

archive/issue_comments_414410.json:
```json
{
    "body": "<a id='comment:63'></a>Replying to [comment:49 mkoeppe]:\n> Replying to [comment:48 embray]:\n> > What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?\n\n> Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.\n\nI wonder about rationale for disabling system's `site-packages`.\nIs this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?",
    "created_at": "2020-01-17T10:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414410",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:63'></a>Replying to [comment:49 mkoeppe]:
> Replying to [comment:48 embray]:
> > What I don't get is why you need to make a venv to test features of the system python when you can just call the system python directly here?

> Because system python could have a module named `sqlite3` in its `site-packages`; but then when we try to use it in a venv, it won't be there.

I wonder about rationale for disabling system's `site-packages`.
Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?



---

archive/issue_comments_414411.json:
```json
{
    "body": "<a id='comment:64'></a>> I wonder about rationale for disabling system's `site-packages`.\n> Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?\n\n\nIt\u2019s strictly for making this ticket easier because I don\u2019t have to worry about getting the correct versions of all Python packages.\nSee #29023 for the next step - let\u2019s discuss any issues regarding use of system site packages there.",
    "created_at": "2020-01-17T12:16:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414411",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:64'></a>> I wonder about rationale for disabling system's `site-packages`.
> Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?


Its strictly for making this ticket easier because I dont have to worry about getting the correct versions of all Python packages.
See #29023 for the next step - lets discuss any issues regarding use of system site packages there.



---

archive/issue_comments_414412.json:
```json
{
    "body": "<a id='comment:65'></a>Replying to [comment:64 mkoeppe]:\n> \n> > I wonder about rationale for disabling system's `site-packages`.\n> > Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?\n\n> \n> It\u2019s strictly for making this ticket easier because I don\u2019t have to worry about getting the correct versions of all Python packages.\n> See #29023 for the next step - let\u2019s discuss any issues regarding use of system site packages there.\n\n\nI agree here, it's much simpler for now to focus on using a \"bare\" Python as much as possible.  I think detecting and using system Python packages *is* where we want to go, but it can get a bit hairier...",
    "created_at": "2020-01-17T12:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414412",
    "user": "https://github.com/embray"
}
```

<a id='comment:65'></a>Replying to [comment:64 mkoeppe]:
> 
> > I wonder about rationale for disabling system's `site-packages`.
> > Is this the only way to install custom versions of packages in venv (which can conflict with ones is system's `site-packages`)?

> 
> Its strictly for making this ticket easier because I dont have to worry about getting the correct versions of all Python packages.
> See #29023 for the next step - lets discuss any issues regarding use of system site packages there.


I agree here, it's much simpler for now to focus on using a "bare" Python as much as possible.  I think detecting and using system Python packages *is* where we want to go, but it can get a bit hairier...



---

archive/issue_comments_414413.json:
```json
{
    "body": "<a id='comment:66'></a>For the heck of it, I'm seeing how far I can get with a system Python 3.6.  I think anything less than 3.6 is almost definitely too old, but I have a feeling 3.6 might still be usable as a minimum.  The only major hassle I've had so far is ensuring that it uses UTF-8 encoding by default.",
    "created_at": "2020-01-17T14:08:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414413",
    "user": "https://github.com/embray"
}
```

<a id='comment:66'></a>For the heck of it, I'm seeing how far I can get with a system Python 3.6.  I think anything less than 3.6 is almost definitely too old, but I have a feeling 3.6 might still be usable as a minimum.  The only major hassle I've had so far is ensuring that it uses UTF-8 encoding by default.



---

archive/issue_comments_414414.json:
```json
{
    "body": "<a id='comment:68'></a>Replying to [comment:62 fbissey]:\n> You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.\n\nThank you! The file is installed. I'll investigate why it is not enough.",
    "created_at": "2020-01-17T15:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414414",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:68'></a>Replying to [comment:62 fbissey]:
> You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.

Thank you! The file is installed. I'll investigate why it is not enough.



---

archive/issue_comments_414415.json:
```json
{
    "body": "<a id='comment:69'></a>Replying to [comment:53 embray]:\n> FWIW I'm experimenting with an alternative solution based on my comments here (albeit with significant pieces taken from this ticket!)  I'll update when I have something that I think works...\n\n\nHere's a prototype of my alternative approach: #29032\n\nI admit it does not yet address as many issues as this ticket does, like all the site.cfg fixes with Numpy.  Personally I didn't need it, but if those fixes are necessary they can easily be applied to my ticket as well.",
    "created_at": "2020-01-17T17:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414415",
    "user": "https://github.com/embray"
}
```

<a id='comment:69'></a>Replying to [comment:53 embray]:
> FWIW I'm experimenting with an alternative solution based on my comments here (albeit with significant pieces taken from this ticket!)  I'll update when I have something that I think works...


Here's a prototype of my alternative approach: #29032

I admit it does not yet address as many issues as this ticket does, like all the site.cfg fixes with Numpy.  Personally I didn't need it, but if those fixes are necessary they can easily be applied to my ticket as well.



---

archive/issue_comments_414416.json:
```json
{
    "body": "<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-17T18:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414416",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414417.json:
```json
{
    "body": "<a id='comment:71'></a>(extracted from Erik's commit at #29032.)",
    "created_at": "2020-01-17T18:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414417",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:71'></a>(extracted from Erik's commit at #29032.)



---

archive/issue_comments_414418.json:
```json
{
    "body": "<a id='comment:72'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-01-17T18:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414418",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:72'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_414419.json:
```json
{
    "body": "<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-17T21:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414419",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414420.json:
```json
{
    "body": "<a id='comment:75'></a>Replying to [comment:68 mkoeppe]:\n> Replying to [comment:62 fbissey]:\n> > You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.\n\n> Thank you! The file is installed. I'll investigate why it is not enough.\n\nI've created ticket #29051 for this (Paths configured in installed numpy `site.cfg [DEFAULT/ALL]` do not affect scipy)",
    "created_at": "2020-01-20T14:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414420",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:75'></a>Replying to [comment:68 mkoeppe]:
> Replying to [comment:62 fbissey]:
> > You could provide an identical `site.cfg` for scipy. The reason you shouldn't technically have to do it, is that the one from numpy is actually shipped. You should have a file `numpy/distutils/site.cfg` in your numpy install and it should be the one you used to configure numpy. If it is missing you'll run into the trouble above I am sure.

> Thank you! The file is installed. I'll investigate why it is not enough.

I've created ticket #29051 for this (Paths configured in installed numpy `site.cfg [DEFAULT/ALL]` do not affect scipy)



---

archive/issue_comments_414421.json:
```json
{
    "body": "<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-03-18T00:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414421",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_414422.json:
```json
{
    "body": "<a id='comment:78'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-18T01:12:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414422",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:78'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414423.json:
```json
{
    "body": "<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-18T01:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414423",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414424.json:
```json
{
    "body": "<a id='comment:80'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-03-18T01:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414424",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:80'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_414425.json:
```json
{
    "body": "<a id='comment:81'></a>(pushed to wrong ticket, corrected)",
    "created_at": "2020-03-18T01:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414425",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:81'></a>(pushed to wrong ticket, corrected)



---

archive/issue_comments_414426.json:
```json
{
    "body": "<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-18T23:43:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414426",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414427.json:
```json
{
    "body": "<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-18T23:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414427",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414428.json:
```json
{
    "body": "<a id='comment:84'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-03-19T15:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414428",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:84'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_events_068974.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-19T15:56:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27824#event-68974"
}
```



---

archive/issue_events_068975.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-03-19T15:56:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27824#event-68975"
}
```



---

archive/issue_comments_414429.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.\n+\n+As suggested in #29032, we make $SAGE_LOCAL a venv (https://docs.python.org/3/library/venv.html) over the system python3 -- if a suitable system python3 is found -- by using the `venv.EnvBuilder` API. \n+\n+This is done by the new script `build/bin/sage-venv`, which we use both during `configure` (to make sure that we select a system python3 for which venvs work correctly) and during `make`.\n+\n+The venv does not include the system site-packages: We continue to install all Python packages into our venv using the existing build infrastructure. We keep the task of using system site-packages for the follow-up ticket #29023.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-03-19T15:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414429",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,11 @@
+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.
+
+As suggested in #29032, we make $SAGE_LOCAL a venv (https://docs.python.org/3/library/venv.html) over the system python3 -- if a suitable system python3 is found -- by using the `venv.EnvBuilder` API. 
+
+This is done by the new script `build/bin/sage-venv`, which we use both during `configure` (to make sure that we select a system python3 for which venvs work correctly) and during `make`.
+
+The venv does not include the system site-packages: We continue to install all Python packages into our venv using the existing build infrastructure. We keep the task of using system site-packages for the follow-up ticket #29023.
+
 
 
 Comment: 1
```




---

archive/issue_comments_414430.json:
```json
{
    "body": "<a id='comment:85'></a>This ticket is no longer on top of #29013.",
    "created_at": "2020-03-19T15:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414430",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:85'></a>This ticket is no longer on top of #29013.



---

archive/issue_comments_414431.json:
```json
{
    "body": "<a id='comment:86'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/58992626 and \nhttps://github.com/mkoeppe/sage/actions/runs/58992623",
    "created_at": "2020-03-19T16:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414431",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:86'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/58992626 and 
https://github.com/mkoeppe/sage/actions/runs/58992623



---

archive/issue_comments_414432.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-19T16:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414432",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_414433.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,13 @@\n+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.\n+\n+As suggested in #29032, we make $SAGE_LOCAL a venv (https://docs.python.org/3/library/venv.html) over the system python3 -- if a suitable system python3 is found -- by using the `venv.EnvBuilder` API. \n+\n+This is done by the new script `build/bin/sage-venv`, which we use both during `configure` (to make sure that we select a system python3 for which venvs work correctly) and during `make`.\n+\n+The venv does not include the system site-packages: We continue to install all Python packages into our venv using the existing build infrastructure. We keep the task of using system site-packages for the follow-up ticket #29023.\n+\n+(Note, we use `venv` (new since Python 3.3), not `virtualenv`. So this change is limited to Python 3 builds of Sage.)\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-03-19T16:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414433",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,13 @@
+Do not install python3 if a sufficiently new version is available in `$PATH`. This could be a system python3, or the python3 from within a venv.
+
+As suggested in #29032, we make $SAGE_LOCAL a venv (https://docs.python.org/3/library/venv.html) over the system python3 -- if a suitable system python3 is found -- by using the `venv.EnvBuilder` API. 
+
+This is done by the new script `build/bin/sage-venv`, which we use both during `configure` (to make sure that we select a system python3 for which venvs work correctly) and during `make`.
+
+The venv does not include the system site-packages: We continue to install all Python packages into our venv using the existing build infrastructure. We keep the task of using system site-packages for the follow-up ticket #29023.
+
+(Note, we use `venv` (new since Python 3.3), not `virtualenv`. So this change is limited to Python 3 builds of Sage.)
+
 
 
 Comment: 1
```




---

archive/issue_comments_414434.json:
```json
{
    "body": "<a id='comment:88'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-19T20:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414434",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:88'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414435.json:
```json
{
    "body": "<a id='comment:89'></a>A successful test at: https://github.com/mkoeppe/sage/runs/520449412",
    "created_at": "2020-03-20T01:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414435",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:89'></a>A successful test at: https://github.com/mkoeppe/sage/runs/520449412



---

archive/issue_comments_414436.json:
```json
{
    "body": "<a id='comment:92'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138",
    "created_at": "2020-03-22T03:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414436",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:92'></a>Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138



---

archive/issue_comments_414437.json:
```json
{
    "body": "<a id='comment:93'></a>Breaks python 2 builds",
    "created_at": "2020-03-22T09:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414437",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:93'></a>Breaks python 2 builds



---

archive/issue_comments_414438.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-22T09:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414438",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_414439.json:
```json
{
    "body": "<a id='comment:94'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-22T16:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414439",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:94'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414440.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-22T16:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414440",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_414441.json:
```json
{
    "body": "<a id='comment:96'></a>Ready for review",
    "created_at": "2020-03-22T17:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414441",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:96'></a>Ready for review



---

archive/issue_comments_414442.json:
```json
{
    "body": "<a id='comment:97'></a>New tests at https://github.com/mkoeppe/sage/actions/runs/60877259; see also #29367",
    "created_at": "2020-03-22T19:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414442",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:97'></a>New tests at https://github.com/mkoeppe/sage/actions/runs/60877259; see also #29367



---

archive/issue_comments_414443.json:
```json
{
    "body": "<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-23T00:47:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414443",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414444.json:
```json
{
    "body": "<a id='comment:99'></a>Tests at https://github.com/mkoeppe/sage/actions/runs/61077298",
    "created_at": "2020-03-23T00:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414444",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:99'></a>Tests at https://github.com/mkoeppe/sage/actions/runs/61077298



---

archive/issue_comments_414445.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-23T14:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414445",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_414446.json:
```json
{
    "body": "<a id='comment:0'></a>Let's move this, looks good to me.",
    "created_at": "2020-03-23T14:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414446",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:0'></a>Let's move this, looks good to me.



---

archive/issue_comments_414447.json:
```json
{
    "body": "<a id='comment:1'></a>Thanks!",
    "created_at": "2020-03-23T16:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414447",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>Thanks!



---

archive/issue_comments_414448.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-29T00:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414448",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_068976.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-29T00:24:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27824#event-68976"
}
```



---

archive/issue_comments_414449.json:
```json
{
    "body": "<a id='comment:3'></a>Hello everyone,\n\nWhen trying to upgrade to 9.1.rc5, I'm seeing an issue that I suspect could be a side effect of this ticket.\n\nFor some reason my `sage/local/bin/python3.7` was a symlink to the system python binary. Sage decided it wanted to install its own python-3.7.3.p1, but that failed with a permission error on the symlink. After deleting the symlink, python builds and installs correctly. (I let the logs be overwritten, so I won't be able to provide much details \u2014 sorry.)\n\nThe overall Sage build still fails with an error about six not being found while building setuptools that I haven't yet investigated.",
    "created_at": "2020-05-18T14:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414449",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:3'></a>Hello everyone,

When trying to upgrade to 9.1.rc5, I'm seeing an issue that I suspect could be a side effect of this ticket.

For some reason my `sage/local/bin/python3.7` was a symlink to the system python binary. Sage decided it wanted to install its own python-3.7.3.p1, but that failed with a permission error on the symlink. After deleting the symlink, python builds and installs correctly. (I let the logs be overwritten, so I won't be able to provide much details  sorry.)

The overall Sage build still fails with an error about six not being found while building setuptools that I haven't yet investigated.



---

archive/issue_comments_414450.json:
```json
{
    "body": "<a id='comment:4'></a>if you switch to py3 from py2, you probably need to run `./configure --with-python=3`\n\nit is not clear what version you were on, but the changes to the build system were very substantial, so ymmv.",
    "created_at": "2020-05-18T17:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414450",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>if you switch to py3 from py2, you probably need to run `./configure --with-python=3`

it is not clear what version you were on, but the changes to the build system were very substantial, so ymmv.



---

archive/issue_comments_414451.json:
```json
{
    "body": "<a id='comment:105'></a>Yes, this is a known limitation. I have created #29708 (Fix switching between --with-system-python3 and --without-system-python3) for it. We shall fix it in 9.2.",
    "created_at": "2020-05-18T17:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-414451",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:105'></a>Yes, this is a known limitation. I have created #29708 (Fix switching between --with-system-python3 and --without-system-python3) for it. We shall fix it in 9.2.
