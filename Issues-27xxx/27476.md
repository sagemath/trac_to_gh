# Issue 27476: Add patch to zn_poly for support for Python 2.6

archive/issues_027239.json:
```json
{
    "body": "We change the string `format()` calls in `makemakefile.py` to be the explicit `{0}` instead of `{}` to support Python 2.6.\n\n[Upstream merge request](https://gitlab.com/sagemath/zn_poly/merge_requests/3)\n\nCC:  @jdemeyer @embray\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Jeroen Demeyer\n\nAuthor: Travis Scrimshaw\n\nBranch: af21bf9e00c64bc673b88a6d50a140489a2031d0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27476\n\n",
    "closed_at": "2019-03-15T08:09:34Z",
    "created_at": "2019-03-12T23:12:41Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Add patch to zn_poly for support for Python 2.6",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27476",
    "user": "https://github.com/tscrim"
}
```
We change the string `format()` calls in `makemakefile.py` to be the explicit `{0}` instead of `{}` to support Python 2.6.

[Upstream merge request](https://gitlab.com/sagemath/zn_poly/merge_requests/3)

CC:  @jdemeyer @embray

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Jeroen Demeyer

Author: Travis Scrimshaw

Branch: af21bf9e00c64bc673b88a6d50a140489a2031d0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27476





---

archive/issue_comments_408703.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-03-12T23:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408703",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_408704.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-12T23:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408704",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_408705.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n We change the string `format()` calls in `makemakefile.py` to be the explicit `{0}` instead of `{}` to support Python 2.6.\n+\n+[Upstream merge request](https://gitlab.com/sagemath/zn_poly/merge_requests/3)\n \n Author: Travis Scrimshaw\n \n``````\n",
    "created_at": "2019-03-12T23:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408705",
    "user": "https://github.com/tscrim"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 We change the string `format()` calls in `makemakefile.py` to be the explicit `{0}` instead of `{}` to support Python 2.6.
+
+[Upstream merge request](https://gitlab.com/sagemath/zn_poly/merge_requests/3)
 
 Author: Travis Scrimshaw
 
``````




---

archive/issue_comments_408706.json:
```json
{
    "body": "<a id='comment:3'></a>Travis, can you please confirm that this actually works with Python 2.6?",
    "created_at": "2019-03-13T06:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408706",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Travis, can you please confirm that this actually works with Python 2.6?



---

archive/issue_comments_408707.json:
```json
{
    "body": "<a id='comment:4'></a>Yes, I rebuilt it on my university's cluster.",
    "created_at": "2019-03-13T07:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408707",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>Yes, I rebuilt it on my university's cluster.



---

archive/issue_comments_408708.json:
```json
{
    "body": "<a id='comment:5'></a>I also built it on a different machine that also did not have Python 2.7.",
    "created_at": "2019-03-14T02:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408708",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>I also built it on a different machine that also did not have Python 2.7.



---

archive/issue_comments_408709.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-14T09:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408709",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_068229.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-15T08:09:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27476#event-68229"
}
```



---

archive/issue_comments_408710.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-15T08:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408710",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_408711.json:
```json
{
    "body": "<a id='comment:8'></a>This breaks the build with python3 on my machine, apparently.\n\n```\n[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] Finished extraction\n[zn_poly-0.9.1.p0] Applying patches from ../patches...\n[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch\n[zn_poly-0.9.1.p0] patching file makemakefile.py\n[zn_poly-0.9.1.p0] Hunk #1 FAILED at 151.\n[zn_poly-0.9.1.p0] Hunk #2 FAILED at 161.\n[zn_poly-0.9.1.p0] Hunk #3 FAILED at 177.\n[zn_poly-0.9.1.p0] Hunk #4 FAILED at 205.\n[zn_poly-0.9.1.p0] 4 out of 4 hunks FAILED -- saving rejects to file makemakefile.py.rej\n[zn_poly-0.9.1.p0] Error applying '../patches/python_2_6_format_support.patch'\n```\nEDIT: maybe a conflict between patches with `build/pkgs/zn_poly/patches/python3.patch`",
    "created_at": "2019-03-20T08:37:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408711",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>This breaks the build with python3 on my machine, apparently.

```
[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Finished extraction
[zn_poly-0.9.1.p0] Applying patches from ../patches...
[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] Hunk #1 FAILED at 151.
[zn_poly-0.9.1.p0] Hunk #2 FAILED at 161.
[zn_poly-0.9.1.p0] Hunk #3 FAILED at 177.
[zn_poly-0.9.1.p0] Hunk #4 FAILED at 205.
[zn_poly-0.9.1.p0] 4 out of 4 hunks FAILED -- saving rejects to file makemakefile.py.rej
[zn_poly-0.9.1.p0] Error applying '../patches/python_2_6_format_support.patch'
```
EDIT: maybe a conflict between patches with `build/pkgs/zn_poly/patches/python3.patch`



---

archive/issue_comments_408712.json:
```json
{
    "body": "<a id='comment:9'></a>Building with Python 2 or Python 3 wouldn't make any difference in that: The patches are applied the same way to the same sources either way, and Python doesn't enter into it.",
    "created_at": "2019-03-20T08:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408712",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>Building with Python 2 or Python 3 wouldn't make any difference in that: The patches are applied the same way to the same sources either way, and Python doesn't enter into it.



---

archive/issue_comments_408713.json:
```json
{
    "body": "<a id='comment:10'></a>So any other idea ?",
    "created_at": "2019-03-20T08:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408713",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:10'></a>So any other idea ?



---

archive/issue_comments_408714.json:
```json
{
    "body": "<a id='comment:11'></a>The python3 builds works on another machine..",
    "created_at": "2019-03-20T08:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408714",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>The python3 builds works on another machine..



---

archive/issue_comments_408715.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 chapoton]:\n> So any other idea ? \n\n\nDo you happen to have patched `zn_poly` yourself? What does `git status` say?",
    "created_at": "2019-03-20T09:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408715",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>Replying to [comment:10 chapoton]:
> So any other idea ? 


Do you happen to have patched `zn_poly` yourself? What does `git status` say?



---

archive/issue_comments_408716.json:
```json
{
    "body": "<a id='comment:13'></a>Let's see what the release manager says...",
    "created_at": "2019-03-20T09:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408716",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Let's see what the release manager says...



---

archive/issue_comments_408717.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:10 chapoton]:\n> So any other idea ? \n\n\nIt worked fine on my python3 build:\n\n```\n[zn_poly-0.9.1.p0] Found local metadata for zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] Using cached file /home/embray/src/sagemath/sage-python3/upstream/zn_poly-0.9.1.tar.gz\n[zn_poly-0.9.1.p0] zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] ====================================================\n[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0\n[zn_poly-0.9.1.p0] Finished extraction\n[zn_poly-0.9.1.p0] Applying patches from ../patches...\n[zn_poly-0.9.1.p0] Applying ../patches/python3.patch\n[zn_poly-0.9.1.p0] patching file makemakefile.py\n[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch\n[zn_poly-0.9.1.p0] patching file makemakefile.py\n[zn_poly-0.9.1.p0] ****************************************************\n```\n\nIn your log snippet it didn't show `Applying ../patches/python3.patch` first.  Was it present?  I wonder if it's possible t was missing for you somehow, or if the patches were being applied in a different order.",
    "created_at": "2019-03-20T09:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408717",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Replying to [comment:10 chapoton]:
> So any other idea ? 


It worked fine on my python3 build:

```
[zn_poly-0.9.1.p0] Found local metadata for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Using cached file /home/embray/src/sagemath/sage-python3/upstream/zn_poly-0.9.1.tar.gz
[zn_poly-0.9.1.p0] zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] ====================================================
[zn_poly-0.9.1.p0] Setting up build directory for zn_poly-0.9.1.p0
[zn_poly-0.9.1.p0] Finished extraction
[zn_poly-0.9.1.p0] Applying patches from ../patches...
[zn_poly-0.9.1.p0] Applying ../patches/python3.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] Applying ../patches/python_2_6_format_support.patch
[zn_poly-0.9.1.p0] patching file makemakefile.py
[zn_poly-0.9.1.p0] ****************************************************
```

In your log snippet it didn't show `Applying ../patches/python3.patch` first.  Was it present?  I wonder if it's possible t was missing for you somehow, or if the patches were being applied in a different order.



---

archive/issue_comments_408718.json:
```json
{
    "body": "<a id='comment:15'></a>I have not patched zn_poly myself.\n\nThe python3 patch is not present in my log snippet, indeed. How is the order of patches determined ?\n\nEDIT: the python3 patch is present in the patches subdirectory\n\nEDIT: monkey-skipping the patch-apply failure, the build of zn_poly works..",
    "created_at": "2019-03-20T09:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408718",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:15'></a>I have not patched zn_poly myself.

The python3 patch is not present in my log snippet, indeed. How is the order of patches determined ?

EDIT: the python3 patch is present in the patches subdirectory

EDIT: monkey-skipping the patch-apply failure, the build of zn_poly works..



---

archive/issue_comments_408719.json:
```json
{
    "body": "<a id='comment:16'></a>There *is* something strange going on here I think.  Alphanumerically, python3 should come before python_2_6_format_patch since ascii '3' is less than ascii '_'.  \n\nAnd indeed, when I run `./sage -f zn_poly` any number of times it always applies these patches in the correct order.  But if I manually cd into the build directory and run `sage-apply-patches` it applies them in the wrong order.  Maybe a shell option somewhere?",
    "created_at": "2019-03-20T10:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408719",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>There *is* something strange going on here I think.  Alphanumerically, python3 should come before python_2_6_format_patch since ascii '3' is less than ascii '_'.  

And indeed, when I run `./sage -f zn_poly` any number of times it always applies these patches in the correct order.  But if I manually cd into the build directory and run `sage-apply-patches` it applies them in the wrong order.  Maybe a shell option somewhere?



---

archive/issue_comments_408720.json:
```json
{
    "body": "<a id='comment:17'></a>You might want to check your `LC_COLLATE` environment variable, or possibly other related LC_ variables.  To be in the safe side it might be best if `sage-apply-patches` explicitly called `sort` over the patches.",
    "created_at": "2019-03-20T10:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408720",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>You might want to check your `LC_COLLATE` environment variable, or possibly other related LC_ variables.  To be in the safe side it might be best if `sage-apply-patches` explicitly called `sort` over the patches.



---

archive/issue_comments_408721.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:13 jdemeyer]:\n> Let's see what the release manager says...\n\n\nThis is already merged (I missed that) so it passes on the buildbot...",
    "created_at": "2019-03-20T10:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408721",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [comment:13 jdemeyer]:
> Let's see what the release manager says...


This is already merged (I missed that) so it passes on the buildbot...



---

archive/issue_comments_408722.json:
```json
{
    "body": "<a id='comment:19'></a>Try this patch and see if it fixes for you.  If so, we'll make a ticket for it\n\n```diff\ndiff --git a/build/bin/sage-apply-patches b/build/bin/sage-apply-patches\nindex 522116e..88d0601 100755\n--- a/build/bin/sage-apply-patches\n+++ b/build/bin/sage-apply-patches\n@@ -57,6 +57,11 @@ while [[ $# > 0 ]]; do\n     shift\n done\n\n+# The locale can have some strange effects on how filename are sorted depending\n+# on the LC_COLLATE variable, so ensure that it's \"C\" (basically ASCII order)\n+# so that patches are applied in a sensible roder\n+export LC_COLLATE=\"C\"\n+\n patchdir=\"${patchdir}/${patch_subdir}\"\n patchdir=\"${patchdir%/}\"\n patches=( \"${patchdir}\"/*.patch )\n```",
    "created_at": "2019-03-20T10:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408722",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Try this patch and see if it fixes for you.  If so, we'll make a ticket for it

```diff
diff --git a/build/bin/sage-apply-patches b/build/bin/sage-apply-patches
index 522116e..88d0601 100755
--- a/build/bin/sage-apply-patches
+++ b/build/bin/sage-apply-patches
@@ -57,6 +57,11 @@ while [[ $# > 0 ]]; do
     shift
 done

+# The locale can have some strange effects on how filename are sorted depending
+# on the LC_COLLATE variable, so ensure that it's "C" (basically ASCII order)
+# so that patches are applied in a sensible roder
+export LC_COLLATE="C"
+
 patchdir="${patchdir}/${patch_subdir}"
 patchdir="${patchdir%/}"
 patches=( "${patchdir}"/*.patch )
```



---

archive/issue_comments_408723.json:
```json
{
    "body": "<a id='comment:20'></a>Another option might be to combine the two patches into 1 so there is no possibility of conflicts due to ordering.",
    "created_at": "2019-03-20T10:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408723",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>Another option might be to combine the two patches into 1 so there is no possibility of conflicts due to ordering.



---

archive/issue_comments_408724.json:
```json
{
    "body": "<a id='comment:21'></a>There is no LC_COLLATE variable in this machine bash configuration. I get very standard\n\n```\n~$ echo $LC_ALL \nen_US.UTF-8\n~$ echo $LANG\nen_US.UTF-8\n```\nand\n\n```\n~$ lsb_release -a \nNo LSB modules are available.\nDistributor ID:\tUbuntu\nDescription:\tUbuntu 16.04.5 LTS\nRelease:\t16.04\nCodename:\txenial\n```",
    "created_at": "2019-03-20T12:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408724",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>There is no LC_COLLATE variable in this machine bash configuration. I get very standard

```
~$ echo $LC_ALL 
en_US.UTF-8
~$ echo $LANG
en_US.UTF-8
```
and

```
~$ lsb_release -a 
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 16.04.5 LTS
Release:	16.04
Codename:	xenial
```



---

archive/issue_comments_408725.json:
```json
{
    "body": "<a id='comment:22'></a>New ticket, guys",
    "created_at": "2019-03-20T14:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408725",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>New ticket, guys



---

archive/issue_comments_408726.json:
```json
{
    "body": "<a id='comment:23'></a>I made #28322 for the patch-related problem.",
    "created_at": "2019-08-04T14:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27476",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27476#issuecomment-408726",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:23'></a>I made #28322 for the patch-related problem.
