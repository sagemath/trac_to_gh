# Issue 27422: local/bin/sage-env-config may not be up to date

archive/issues_027185.json:
```json
{
    "assignees": [],
    "body": "The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n\nA very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.\n\nCC:  @kiwifb @embray\n\nBranch/Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**\n\nReviewer: **Volker Braun**\n\nAuthor: **Jeroen Demeyer**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27422_\n\n",
    "closed_at": "2019-03-25T19:43:05Z",
    "created_at": "2019-03-04T16:38:37Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "local/bin/sage-env-config may not be up to date",
    "type": "issue",
    "updated_at": "2019-03-25T19:43:05Z",
    "url": "https://github.com/sagemath/sage/issues/27422",
    "user": "https://github.com/jdemeyer"
}
```
The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.

A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.

CC:  @kiwifb @embray

Branch/Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**

Reviewer: **Volker Braun**

Author: **Jeroen Demeyer**

_Issue created by migration from https://trac.sagemath.org/ticket/27422_





---

archive/issue_events_358459.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358459"
}
```



---

archive/issue_events_358460.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358460"
}
```



---

archive/issue_events_358461.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358461"
}
```



---

archive/issue_events_358462.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358462"
}
```



---

archive/issue_events_358463.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:40:10Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "title_is": "gfan and lcalc no longer build with old g++",
    "title_was": "gfan and lcalc no longer build with old gcc",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358463"
}
```



---

archive/issue_comments_427159.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nBut the `auto` is new C++, how did it work before? Is it because this sets C++ to too old a standard?",
    "created_at": "2019-03-04T16:43:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427159",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'>Comment 3:</a>
But the `auto` is new C++, how did it work before? Is it because this sets C++ to too old a standard?



---

archive/issue_comments_427160.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@dimpase](#comment%3A3):\n> But the `auto` is new C++, how did it work before?\n\nBefore #26787, these packages were compiled with `-std=c++11`. So the obvious fix is simply to put back those flags which were removed in #26787.",
    "created_at": "2019-03-04T17:18:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427160",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@dimpase](#comment%3A3):
> But the `auto` is new C++, how did it work before?

Before #26787, these packages were compiled with `-std=c++11`. So the obvious fix is simply to put back those flags which were removed in #26787.



---

archive/issue_comments_427161.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nFrancois says on #26787 that it's meant to be that CXX becomes `$CXX -std=gnu++11` But somehow this does not happen here for some reason.\n\nCould you post the `sage-env-config` from one of these broken systems here?",
    "created_at": "2019-03-04T17:25:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427161",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'>Comment 6:</a>
Francois says on #26787 that it's meant to be that CXX becomes `$CXX -std=gnu++11` But somehow this does not happen here for some reason.

Could you post the `sage-env-config` from one of these broken systems here?



---

archive/issue_comments_427162.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nAfter trying again, it now works correctly...\n\nSo maybe there is a problem with dependency checking, that the settings for `CXX` are not propagated correctly?",
    "created_at": "2019-03-04T17:41:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427162",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
After trying again, it now works correctly...

So maybe there is a problem with dependency checking, that the settings for `CXX` are not propagated correctly?



---

archive/issue_comments_427163.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nPerhaps for some reason `./configure` didn't get run (or perhaps `./bootstrap`)? My understanding is that it `./configure` would fill in the template in  `sage-env-config.in`, producing `sage-env-config` with the correct settings, and `sage-env` will set `CXX` to the right value.",
    "created_at": "2019-03-04T17:57:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427163",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'>Comment 8:</a>
Perhaps for some reason `./configure` didn't get run (or perhaps `./bootstrap`)? My understanding is that it `./configure` would fill in the template in  `sage-env-config.in`, producing `sage-env-config` with the correct settings, and `sage-env` will set `CXX` to the right value.



---

archive/issue_comments_427164.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nThis happened when upgrading from 8.6. I can try to again to see if I can reproduce it.",
    "created_at": "2019-03-04T19:13:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427164",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'>Comment 9:</a>
This happened when upgrading from 8.6. I can try to again to see if I can reproduce it.



---

archive/issue_comments_427165.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nI can think of a number of ways to interpret  \"upgrading\". Please be more specific.",
    "created_at": "2019-03-04T19:15:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427165",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'>Comment 10:</a>
I can think of a number of ways to interpret  "upgrading". Please be more specific.



---

archive/issue_comments_427166.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nI am guessing just doing `make` after synchronising didn't run `configure`.",
    "created_at": "2019-03-04T19:51:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427166",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'>Comment 11:</a>
I am guessing just doing `make` after synchronising didn't run `configure`.



---

archive/issue_events_358464.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358464"
}
```



---

archive/issue_events_358465.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/worksforme",
    "label_color": "a6a6a6",
    "label_name": "worksforme",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358465"
}
```



---

archive/issue_comments_427167.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nI cannot reproduce this.",
    "created_at": "2019-03-08T14:24:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427167",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'>Comment 12:</a>
I cannot reproduce this.



---

archive/issue_events_358466.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358466"
}
```



---

archive/issue_events_358467.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358467"
}
```



---

archive/issue_events_358468.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358468"
}
```



---

archive/issue_comments_427168.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nI just got this issue again. This time, I remember better which steps I took, so I'll try to reproduce it.",
    "created_at": "2019-03-11T09:33:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427168",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'>Comment 13:</a>
I just got this issue again. This time, I remember better which steps I took, so I'll try to reproduce it.



---

archive/issue_comments_427169.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@kiwifb](#comment%3A11):\n> I am guessing just doing `make` after synchronising didn't run `configure`.\n\nBut it should according to the top-level `Makefile`.",
    "created_at": "2019-03-11T09:34:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427169",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@kiwifb](#comment%3A11):
> I am guessing just doing `make` after synchronising didn't run `configure`.

But it should according to the top-level `Makefile`.



---

archive/issue_comments_427170.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [@jdemeyer](#comment%3A14):\n> Replying to [@kiwifb](#comment%3A11):\n> > I am guessing just doing `make` after synchronising didn't run `configure`.\n\n> \n> But it should according to the top-level `Makefile`.\n\nThe glob `build/pkgs/*/*` in the `build/make/Makefile` target should indeed trigger it. At least that's what we expect. But you should have logs showing whether it happened or not.",
    "created_at": "2019-03-11T09:44:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427170",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [@jdemeyer](#comment%3A14):
> Replying to [@kiwifb](#comment%3A11):
> > I am guessing just doing `make` after synchronising didn't run `configure`.

> 
> But it should according to the top-level `Makefile`.

The glob `build/pkgs/*/*` in the `build/make/Makefile` target should indeed trigger it. At least that's what we expect. But you should have logs showing whether it happened or not.



---

archive/issue_comments_427171.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nIf I recall correctly, then both this time and the last time, the build worked on the third invocation of `make build`. So there were 2 failed builds of `gfan` and the third one worked. So somewhere in between, `./configure` was run correctly.",
    "created_at": "2019-03-11T09:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427171",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'>Comment 16:</a>
If I recall correctly, then both this time and the last time, the build worked on the third invocation of `make build`. So there were 2 failed builds of `gfan` and the third one worked. So somewhere in between, `./configure` was run correctly.



---

archive/issue_comments_427172.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nI guess that's all that toolchain things that should have been removed from Sage proper many years ago. Now the build system is so complicated that it slows the development down.\n\nOnce #27212, #27258, and #27259 are in, every toolchain part can come from the system (or an external custom package), and I see no reason for not moving the toolchain and its deps into a separate custom package.",
    "created_at": "2019-03-11T11:12:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427172",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'>Comment 17:</a>
I guess that's all that toolchain things that should have been removed from Sage proper many years ago. Now the build system is so complicated that it slows the development down.

Once #27212, #27258, and #27259 are in, every toolchain part can come from the system (or an external custom package), and I see no reason for not moving the toolchain and its deps into a separate custom package.



---

archive/issue_comments_427173.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nI tried to reproduce, but again I didn't manage.",
    "created_at": "2019-03-11T11:20:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427173",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'>Comment 18:</a>
I tried to reproduce, but again I didn't manage.



---

archive/issue_comments_427174.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nReplying to [@dimpase](#comment%3A17):\n> Once #27212, #27258, and #27259 are in\n\nWhy are you bringing up mpir/mpfr/mpc? There is no evidence that these packages have anything to do with the problem that I'm seeing here.",
    "created_at": "2019-03-11T11:21:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427174",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'>Comment 19:</a>
Replying to [@dimpase](#comment%3A17):
> Once #27212, #27258, and #27259 are in

Why are you bringing up mpir/mpfr/mpc? There is no evidence that these packages have anything to do with the problem that I'm seeing here.



---

archive/issue_comments_427175.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nI am bringing this up as our build system badly needs to be simplified. We waste time on things that should just work. See #27462.",
    "created_at": "2019-03-11T11:26:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427175",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'>Comment 20:</a>
I am bringing this up as our build system badly needs to be simplified. We waste time on things that should just work. See #27462.



---

archive/issue_events_358469.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:48:45Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "title_is": "local/bin/sage-env-config may not be up to date",
    "title_was": "gfan and lcalc no longer build with old g++",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358469"
}
```



---

archive/issue_comments_427176.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nI think I finally figured out the root cause, I updated the description.",
    "created_at": "2019-03-21T12:48:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427176",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'>Comment 21:</a>
I think I finally figured out the root cause, I updated the description.



---

archive/issue_events_358470.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:48:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358470"
}
```



---

archive/issue_comments_427177.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,26 +1 @@\n-Since the removal of C++11 flags from the `gfan` and `lcalc` packages, these no longer build with gcc-4.9.3:\n-\n-```\n-make[4]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/gfan-0.6.2.p1/src'\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/polynomialgcd.cpp -o src/polynomialgcd.o\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/lp_cdd.cpp -o src/lp_cdd.o\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/parser.cpp -o src/parser.o\n-src/polynomialgcd.cpp: In function 'bool simplifyPolynomialsForGCD(const PolynomialSet&, PolynomialSet&, IntegerVector&)':\n-src/polynomialgcd.cpp:286:11: error: 'i' does not name a type\n-  for(auto i=p.begin();i!=p.end();i++)dv=min(dv,i->degreeVector());\n-```\n-and\n-\n-```\n-make[5]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/lcalc-1.23.p18/src/src'\n-g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc\n-g++ -O3   -ffast-math -fPIC   -I../include -c Lgamma.cc\n-In file included from ../include/Lglobals.h:48:0,\n-                 from Lglobals.cc:23:\n-../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':\n-../include/Lcommon.h:71:8: error: 'i' does not name a type\n-   loop(i,this->N,N)\n-        ^\n-../include/Lcommon.h:51:30: note: in definition of macro 'loop'\n- #define loop(i,m,n) for(auto i=(m); i!=(n); i++)\n-```\n+The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n``````\n",
    "created_at": "2019-03-21T12:48:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427177",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,26 +1 @@
-Since the removal of C++11 flags from the `gfan` and `lcalc` packages, these no longer build with gcc-4.9.3:
-
-```
-make[4]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/gfan-0.6.2.p1/src'
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/polynomialgcd.cpp -o src/polynomialgcd.o
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/lp_cdd.cpp -o src/lp_cdd.o
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/parser.cpp -o src/parser.o
-src/polynomialgcd.cpp: In function 'bool simplifyPolynomialsForGCD(const PolynomialSet&, PolynomialSet&, IntegerVector&)':
-src/polynomialgcd.cpp:286:11: error: 'i' does not name a type
-  for(auto i=p.begin();i!=p.end();i++)dv=min(dv,i->degreeVector());
-```
-and
-
-```
-make[5]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/lcalc-1.23.p18/src/src'
-g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc
-g++ -O3   -ffast-math -fPIC   -I../include -c Lgamma.cc
-In file included from ../include/Lglobals.h:48:0,
-                 from Lglobals.cc:23:
-../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':
-../include/Lcommon.h:71:8: error: 'i' does not name a type
-   loop(i,this->N,N)
-        ^
-../include/Lcommon.h:51:30: note: in definition of macro 'loop'
- #define loop(i,m,n) for(auto i=(m); i!=(n); i++)
-```
+The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
``````




---

archive/issue_events_358471.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:49:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/worksforme",
    "label_color": "a6a6a6",
    "label_name": "worksforme",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358471"
}
```



---

archive/issue_comments_427178.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n+\n+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.\n``````\n",
    "created_at": "2019-03-21T12:51:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427178",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
+
+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.
``````




---

archive/issue_comments_427179.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n \n-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.\n+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.\n``````\n",
    "created_at": "2019-03-21T12:53:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427179",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
 
-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.
+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.
``````




---

archive/issue_comments_427180.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2019-03-21T13:02:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427180",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_427181.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n \n-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.\n+A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.\n``````\n",
    "created_at": "2019-03-21T13:02:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427181",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
 
-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.
+A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.
``````




---

archive/issue_comments_427182.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nI haven't actually looked at the code, but if what you write in the description is the case then that's definitely a bug.  It should only use the one in `$SAGE_ROOT/src/bin` when it's present.",
    "created_at": "2019-03-21T13:10:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427182",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'>Comment 26:</a>
I haven't actually looked at the code, but if what you write in the description is the case then that's definitely a bug.  It should only use the one in `$SAGE_ROOT/src/bin` when it's present.



---

archive/issue_comments_427183.json:
```json
{
    "body": "Branch: **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)**",
    "created_at": "2019-03-21T13:57:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427183",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)**



---

archive/issue_events_358472.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T14:00:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358472"
}
```



---

archive/issue_comments_427184.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nReplying to [@embray](#comment%3A26):\n> It should only use the one in `$SAGE_ROOT/src/bin` when it's present.\n\nI think there is a misunderstanding.\n\nThe problem is when *both* `local/bin/sage-env-config` and `src/bin/sage-env-config` are present. It used to prefer `local/bin/sage-env-config` which is not guaranteed to be up-to-date. Instead, it should prefer `src/bin/sage-env-config` which is directly generated by `configure`.\n\nI went for the most simple solution here. There are probably better solutions, for example having only one such file. But those require bigger changes and I didn't want to do that for a blocker ticket.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb\">939177a</a></td><td><code>Look for src/bin/sage-env-config first</code></td></tr></table>\n",
    "created_at": "2019-03-21T14:00:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427184",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'>Comment 28:</a>
Replying to [@embray](#comment%3A26):
> It should only use the one in `$SAGE_ROOT/src/bin` when it's present.

I think there is a misunderstanding.

The problem is when *both* `local/bin/sage-env-config` and `src/bin/sage-env-config` are present. It used to prefer `local/bin/sage-env-config` which is not guaranteed to be up-to-date. Instead, it should prefer `src/bin/sage-env-config` which is directly generated by `configure`.

I went for the most simple solution here. There are probably better solutions, for example having only one such file. But those require bigger changes and I didn't want to do that for a blocker ticket.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb">939177a</a></td><td><code>Look for src/bin/sage-env-config first</code></td></tr></table>




---

archive/issue_comments_427185.json:
```json
{
    "body": "Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**",
    "created_at": "2019-03-21T14:00:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427185",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**



---

archive/issue_comments_427186.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nImho its better to ship 8.7 now, realistically we can't make any promises about upgrading from old versions.",
    "created_at": "2019-03-23T22:18:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427186",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'>Comment 29:</a>
Imho its better to ship 8.7 now, realistically we can't make any promises about upgrading from old versions.



---

archive/issue_comments_427187.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nIt's true that we can't make promises, but in general upgrades do work quite well. But this ticket has broken upgrading builds several times for me. It's also a regression since 8.6, so it's very sensible to make it a blocker. Moreover, this fix is easy, why not apply it?\n\nIn the end, you have the last word, but I would like you to reconsider this ticket.",
    "created_at": "2019-03-23T22:28:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427187",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'>Comment 30:</a>
It's true that we can't make promises, but in general upgrades do work quite well. But this ticket has broken upgrading builds several times for me. It's also a regression since 8.6, so it's very sensible to make it a blocker. Moreover, this fix is easy, why not apply it?

In the end, you have the last word, but I would like you to reconsider this ticket.



---

archive/issue_comments_427188.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nIf you don't like the fix itself, there are plenty of other ways to fix the same problem. But I do think that the problem must be fixed for 8.7.",
    "created_at": "2019-03-23T22:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427188",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'>Comment 31:</a>
If you don't like the fix itself, there are plenty of other ways to fix the same problem. But I do think that the problem must be fixed for 8.7.



---

archive/issue_events_358473.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-24T00:53:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358473"
}
```



---

archive/issue_events_358474.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-24T00:53:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358474"
}
```



---

archive/issue_comments_427189.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nI see your point, but I also think its fairly low impact. The perfect is the enemy of the good...",
    "created_at": "2019-03-24T00:53:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427189",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'>Comment 32:</a>
I see your point, but I also think its fairly low impact. The perfect is the enemy of the good...



---

archive/issue_comments_427190.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2019-03-24T07:00:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427190",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Volker Braun**



---

archive/issue_comments_427191.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nAmusingly, I just got bitten by this myself, but only because I copied an existing source tree to a new location.",
    "created_at": "2019-03-25T10:08:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427191",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'>Comment 34:</a>
Amusingly, I just got bitten by this myself, but only because I copied an existing source tree to a new location.



---

archive/issue_comments_427192.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nThis whole thing is totally insane - does it support `./configure --prefix=` ?\n\nShouldn't it be possible to have a number of build trees, with potentially different `sage-env-config` ? Shouldn't `src/bin/sage-env-config` actually not be there at all?!\nWhy do we keep mixing up build trees with source...",
    "created_at": "2019-03-25T10:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427192",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'>Comment 35:</a>
This whole thing is totally insane - does it support `./configure --prefix=` ?

Shouldn't it be possible to have a number of build trees, with potentially different `sage-env-config` ? Shouldn't `src/bin/sage-env-config` actually not be there at all?!
Why do we keep mixing up build trees with source...



---

archive/issue_events_358475.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358475"
}
```



---

archive/issue_events_358476.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358476"
}
```



---

archive/issue_events_358477.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358477"
}
```



---

archive/issue_events_358478.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358478"
}
```



---

archive/issue_events_358479.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-25T10:23:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358479"
}
```



---

archive/issue_events_358480.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-25T10:23:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358480"
}
```



---

archive/issue_comments_427193.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nReplying to [@dimpase](#comment%3A35):\n> This whole thing is totally insane - does it support `./configure --prefix=` ?\n\nOf course it does, why should it not?\n\n> Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\nBut then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\nI'm setting this back to needs_review since I don't really understand your complaint.",
    "created_at": "2019-03-25T10:23:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427193",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'>Comment 36:</a>
Replying to [@dimpase](#comment%3A35):
> This whole thing is totally insane - does it support `./configure --prefix=` ?

Of course it does, why should it not?

> Shouldn't `src/bin/sage-env-config` actually not be there at all?!

But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

I'm setting this back to needs_review since I don't really understand your complaint.



---

archive/issue_comments_427194.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nReplying to [@jdemeyer](#comment%3A36):\n> Replying to [@dimpase](#comment%3A35):\n> > This whole thing is totally insane - does it support `./configure --prefix=` ?\n\n> \n> Of course it does, why should it not?\n> \n> > Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\n> \n> But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\nOK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?\n\nIts place is not there, not in somewhere that is in the `$PATH`.\nbut rather in something like `$SAGE_LOCAL/config/` or so...\n\nI hope this explains.\n\n> \n> I'm setting this back to needs_review since I don't really understand your complaint.",
    "created_at": "2019-03-25T10:30:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427194",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'>Comment 37:</a>
Replying to [@jdemeyer](#comment%3A36):
> Replying to [@dimpase](#comment%3A35):
> > This whole thing is totally insane - does it support `./configure --prefix=` ?

> 
> Of course it does, why should it not?
> 
> > Shouldn't `src/bin/sage-env-config` actually not be there at all?!

> 
> But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?

Its place is not there, not in somewhere that is in the `$PATH`.
but rather in something like `$SAGE_LOCAL/config/` or so...

I hope this explains.

> 
> I'm setting this back to needs_review since I don't really understand your complaint.



---

archive/issue_comments_427195.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nReplying to [@dimpase](#comment%3A37):\n> Its place is not there, not in somewhere that is in the `$PATH`.\n> but rather in something like `$SAGE_LOCAL/config/` or so...\n\nBut then you have a circular problem:\n\n1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`\n\n2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`",
    "created_at": "2019-03-25T10:32:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427195",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'>Comment 38:</a>
Replying to [@dimpase](#comment%3A37):
> Its place is not there, not in somewhere that is in the `$PATH`.
> but rather in something like `$SAGE_LOCAL/config/` or so...

But then you have a circular problem:

1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`

2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`



---

archive/issue_comments_427196.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nSage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\nHaving a file that is loaded from one place when running out of the source, but a different place when \"installed\" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.",
    "created_at": "2019-03-25T10:33:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427196",
    "user": "https://github.com/embray"
}
```

<a id='comment:39'>Comment 39:</a>
Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.



---

archive/issue_events_358481.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:33:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358481"
}
```



---

archive/issue_events_358482.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:33:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358482"
}
```



---

archive/issue_comments_427197.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nReplying to [@dimpase](#comment%3A37):\n> Replying to [@jdemeyer](#comment%3A36):\n> > Replying to [@dimpase](#comment%3A35):\n> > > This whole thing is totally insane - does it support `./configure --prefix=` ?\n\n> > \n> > Of course it does, why should it not?\n> > \n> > > Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\n> > \n> > But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\n> \n> OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?\n\nWhen running `$SAGE_LOCAL/bin/sage` for example, it uses `$SAGE_LOCAL/bin/sage-env`, which in turn should source `$SAGE_LOCAL/bin/sage-env-config` (which just sets a few variables that are determined by `./configure` and are placed in a separate file from the main `sage-env` mostly for clarity's sake...)",
    "created_at": "2019-03-25T10:36:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427197",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'>Comment 40:</a>
Replying to [@dimpase](#comment%3A37):
> Replying to [@jdemeyer](#comment%3A36):
> > Replying to [@dimpase](#comment%3A35):
> > > This whole thing is totally insane - does it support `./configure --prefix=` ?

> > 
> > Of course it does, why should it not?
> > 
> > > Shouldn't `src/bin/sage-env-config` actually not be there at all?!

> > 
> > But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

> 
> OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?

When running `$SAGE_LOCAL/bin/sage` for example, it uses `$SAGE_LOCAL/bin/sage-env`, which in turn should source `$SAGE_LOCAL/bin/sage-env-config` (which just sets a few variables that are determined by `./configure` and are placed in a separate file from the main `sage-env` mostly for clarity's sake...)



---

archive/issue_comments_427198.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nI should also note that *after installation* the contents of `$SAGE_SRC/bin/sage-env-config` and `$SAGE_LOCAL/bin/sage-env-config` are identical. But this ticket is meant to fix `sage-env-config` at *build time*, possibly before `$SAGE_SRC/bin/sage-env-config` is copied `$SAGE_LOCAL/bin/sage-env-config`.",
    "created_at": "2019-03-25T10:38:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427198",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'>Comment 41:</a>
I should also note that *after installation* the contents of `$SAGE_SRC/bin/sage-env-config` and `$SAGE_LOCAL/bin/sage-env-config` are identical. But this ticket is meant to fix `sage-env-config` at *build time*, possibly before `$SAGE_SRC/bin/sage-env-config` is copied `$SAGE_LOCAL/bin/sage-env-config`.



---

archive/issue_comments_427199.json:
```json
{
    "body": "<a id='comment:42'>Comment 42:</a>\nReplying to [@jdemeyer](#comment%3A38):\n> Replying to [@dimpase](#comment%3A37):\n> > Its place is not there, not in somewhere that is in the `$PATH`.\n> > but rather in something like `$SAGE_LOCAL/config/` or so...\n\n> \n> But then you have a circular problem:\n> \n> 1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`\n\n\nYou just said that this is available from `src/bin/sage-env-config`, no?\n\n\n> \n> 2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`\n\nNo, this is in `src/bin/sage-env-config`, that's how you can find it.\n\nWell, maybe there is my aversion to changing the environment without running `./configure` that speaks here, but this is really the same issue as in #27373.",
    "created_at": "2019-03-25T10:41:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427199",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'>Comment 42:</a>
Replying to [@jdemeyer](#comment%3A38):
> Replying to [@dimpase](#comment%3A37):
> > Its place is not there, not in somewhere that is in the `$PATH`.
> > but rather in something like `$SAGE_LOCAL/config/` or so...

> 
> But then you have a circular problem:
> 
> 1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`


You just said that this is available from `src/bin/sage-env-config`, no?


> 
> 2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`

No, this is in `src/bin/sage-env-config`, that's how you can find it.

Well, maybe there is my aversion to changing the environment without running `./configure` that speaks here, but this is really the same issue as in #27373.



---

archive/issue_comments_427200.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\nReplying to [@embray](#comment%3A39):\n> Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\nDo you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?\n\n\n\n> \n> Having a file that is loaded from one place when running out of the source, but a different place when \"installed\" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.\n\nIn this case \"installed\" ought to happen at the end, after the build is done and dusted.",
    "created_at": "2019-03-25T10:48:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427200",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'>Comment 43:</a>
Replying to [@embray](#comment%3A39):
> Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?



> 
> Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.

In this case "installed" ought to happen at the end, after the build is done and dusted.



---

archive/issue_comments_427201.json:
```json
{
    "body": "<a id='comment:44'>Comment 44:</a>\nReplying to [@dimpase](#comment%3A43):\n> Replying to [@embray](#comment%3A39):\n> > Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\n> \n> Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?\n\nNo, that has nothing to do with it.  I'm just saying it doesn't work if you don't run Sage out of a source tree, because manually installing packages still depends on the whole sage-the-distribution machinery which does not get \"installed\" in any sense.  It was just an aside; I'm sorry if my mentioning it confused matters.",
    "created_at": "2019-03-25T10:59:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427201",
    "user": "https://github.com/embray"
}
```

<a id='comment:44'>Comment 44:</a>
Replying to [@dimpase](#comment%3A43):
> Replying to [@embray](#comment%3A39):
> > Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

> 
> Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?

No, that has nothing to do with it.  I'm just saying it doesn't work if you don't run Sage out of a source tree, because manually installing packages still depends on the whole sage-the-distribution machinery which does not get "installed" in any sense.  It was just an aside; I'm sorry if my mentioning it confused matters.



---

archive/issue_events_358483.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-25T19:43:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358483"
}
```



---

archive/issue_events_358484.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "7b075a74b536fd1ef64f5cb10bfb53bfb31f9c81",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-03-25T19:43:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-358484"
}
```



---

archive/issue_comments_427202.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)** to **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**",
    "created_at": "2019-03-25T19:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-427202",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)** to **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**
