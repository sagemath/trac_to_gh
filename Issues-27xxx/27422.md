# Issue 27422: local/bin/sage-env-config may not be up to date

archive/issues_027185.json:
```json
{
    "assignees": [],
    "body": "The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n\nA very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.\n\nCC:  @kiwifb @embray\n\nBranch/Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**\n\nReviewer: **Volker Braun**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27422_\n\n",
    "closed_at": "2019-03-25T19:43:05Z",
    "created_at": "2019-03-04T16:38:37Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "local/bin/sage-env-config may not be up to date",
    "type": "issue",
    "updated_at": "2019-03-25T19:43:05Z",
    "url": "https://github.com/sagemath/sage/issues/27422",
    "user": "https://github.com/jdemeyer"
}
```
The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.

A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.

CC:  @kiwifb @embray

Branch/Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**

Reviewer: **Volker Braun**

Author: **Jeroen Demeyer**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/27422_





---

archive/issue_events_376632.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376632"
}
```



---

archive/issue_events_376633.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376633"
}
```



---

archive/issue_events_376634.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376634"
}
```



---

archive/issue_events_376635.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:38:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376635"
}
```



---

archive/issue_events_376636.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:40:10Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "title_is": "gfan and lcalc no longer build with old g++",
    "title_was": "gfan and lcalc no longer build with old gcc",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376636"
}
```



---

archive/issue_comments_424347.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nBut the `auto` is new C++, how did it work before? Is it because this sets C++ to too old a standard?",
    "created_at": "2019-03-04T16:43:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424347",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:3" align="right">comment:3</div>

But the `auto` is new C++, how did it work before? Is it because this sets C++ to too old a standard?



---

archive/issue_comments_424348.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@dimpase](#comment:3):\n> But the `auto` is new C++, how did it work before?\n\nBefore #26787, these packages were compiled with `-std=c++11`. So the obvious fix is simply to put back those flags which were removed in #26787.",
    "created_at": "2019-03-04T17:18:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424348",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@dimpase](#comment:3):
> But the `auto` is new C++, how did it work before?

Before #26787, these packages were compiled with `-std=c++11`. So the obvious fix is simply to put back those flags which were removed in #26787.



---

archive/issue_comments_424349.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nFrancois says on #26787 that it's meant to be that CXX becomes `$CXX -std=gnu++11` But somehow this does not happen here for some reason.\n\nCould you post the `sage-env-config` from one of these broken systems here?",
    "created_at": "2019-03-04T17:25:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424349",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:6" align="right">comment:6</div>

Francois says on #26787 that it's meant to be that CXX becomes `$CXX -std=gnu++11` But somehow this does not happen here for some reason.

Could you post the `sage-env-config` from one of these broken systems here?



---

archive/issue_comments_424350.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAfter trying again, it now works correctly...\n\nSo maybe there is a problem with dependency checking, that the settings for `CXX` are not propagated correctly?",
    "created_at": "2019-03-04T17:41:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424350",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

After trying again, it now works correctly...

So maybe there is a problem with dependency checking, that the settings for `CXX` are not propagated correctly?



---

archive/issue_comments_424351.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nPerhaps for some reason `./configure` didn't get run (or perhaps `./bootstrap`)? My understanding is that it `./configure` would fill in the template in  `sage-env-config.in`, producing `sage-env-config` with the correct settings, and `sage-env` will set `CXX` to the right value.",
    "created_at": "2019-03-04T17:57:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424351",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

Perhaps for some reason `./configure` didn't get run (or perhaps `./bootstrap`)? My understanding is that it `./configure` would fill in the template in  `sage-env-config.in`, producing `sage-env-config` with the correct settings, and `sage-env` will set `CXX` to the right value.



---

archive/issue_comments_424352.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThis happened when upgrading from 8.6. I can try to again to see if I can reproduce it.",
    "created_at": "2019-03-04T19:13:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424352",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

This happened when upgrading from 8.6. I can try to again to see if I can reproduce it.



---

archive/issue_comments_424353.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI can think of a number of ways to interpret  \"upgrading\". Please be more specific.",
    "created_at": "2019-03-04T19:15:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424353",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:10" align="right">comment:10</div>

I can think of a number of ways to interpret  "upgrading". Please be more specific.



---

archive/issue_comments_424354.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI am guessing just doing `make` after synchronising didn't run `configure`.",
    "created_at": "2019-03-04T19:51:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424354",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:11" align="right">comment:11</div>

I am guessing just doing `make` after synchronising didn't run `configure`.



---

archive/issue_events_376637.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376637"
}
```



---

archive/issue_events_376638.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/worksforme",
    "label_color": "a6a6a6",
    "label_name": "worksforme",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376638"
}
```



---

archive/issue_comments_424355.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI cannot reproduce this.",
    "created_at": "2019-03-08T14:24:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424355",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

I cannot reproduce this.



---

archive/issue_events_376639.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376639"
}
```



---

archive/issue_events_376640.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376640"
}
```



---

archive/issue_comments_424356.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI just got this issue again. This time, I remember better which steps I took, so I'll try to reproduce it.",
    "created_at": "2019-03-11T09:33:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424356",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

I just got this issue again. This time, I remember better which steps I took, so I'll try to reproduce it.



---

archive/issue_comments_424357.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@kiwifb](#comment:11):\n> I am guessing just doing `make` after synchronising didn't run `configure`.\n\nBut it should according to the top-level `Makefile`.",
    "created_at": "2019-03-11T09:34:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424357",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@kiwifb](#comment:11):
> I am guessing just doing `make` after synchronising didn't run `configure`.

But it should according to the top-level `Makefile`.



---

archive/issue_comments_424358.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jdemeyer](#comment:14):\n> Replying to [@kiwifb](#comment:11):\n> > I am guessing just doing `make` after synchronising didn't run `configure`.\n\n> \n> But it should according to the top-level `Makefile`.\n\nThe glob `build/pkgs/*/*` in the `build/make/Makefile` target should indeed trigger it. At least that's what we expect. But you should have logs showing whether it happened or not.",
    "created_at": "2019-03-11T09:44:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424358",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jdemeyer](#comment:14):
> Replying to [@kiwifb](#comment:11):
> > I am guessing just doing `make` after synchronising didn't run `configure`.

> 
> But it should according to the top-level `Makefile`.

The glob `build/pkgs/*/*` in the `build/make/Makefile` target should indeed trigger it. At least that's what we expect. But you should have logs showing whether it happened or not.



---

archive/issue_comments_424359.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nIf I recall correctly, then both this time and the last time, the build worked on the third invocation of `make build`. So there were 2 failed builds of `gfan` and the third one worked. So somewhere in between, `./configure` was run correctly.",
    "created_at": "2019-03-11T09:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424359",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

If I recall correctly, then both this time and the last time, the build worked on the third invocation of `make build`. So there were 2 failed builds of `gfan` and the third one worked. So somewhere in between, `./configure` was run correctly.



---

archive/issue_comments_424360.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI guess that's all that toolchain things that should have been removed from Sage proper many years ago. Now the build system is so complicated that it slows the development down.\n\nOnce #27212, #27258, and #27259 are in, every toolchain part can come from the system (or an external custom package), and I see no reason for not moving the toolchain and its deps into a separate custom package.",
    "created_at": "2019-03-11T11:12:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424360",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

I guess that's all that toolchain things that should have been removed from Sage proper many years ago. Now the build system is so complicated that it slows the development down.

Once #27212, #27258, and #27259 are in, every toolchain part can come from the system (or an external custom package), and I see no reason for not moving the toolchain and its deps into a separate custom package.



---

archive/issue_comments_424361.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI tried to reproduce, but again I didn't manage.",
    "created_at": "2019-03-11T11:20:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424361",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

I tried to reproduce, but again I didn't manage.



---

archive/issue_comments_424362.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@dimpase](#comment:17):\n> Once #27212, #27258, and #27259 are in\n\nWhy are you bringing up mpir/mpfr/mpc? There is no evidence that these packages have anything to do with the problem that I'm seeing here.",
    "created_at": "2019-03-11T11:21:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424362",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@dimpase](#comment:17):
> Once #27212, #27258, and #27259 are in

Why are you bringing up mpir/mpfr/mpc? There is no evidence that these packages have anything to do with the problem that I'm seeing here.



---

archive/issue_comments_424363.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI am bringing this up as our build system badly needs to be simplified. We waste time on things that should just work. See #27462.",
    "created_at": "2019-03-11T11:26:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424363",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:20" align="right">comment:20</div>

I am bringing this up as our build system badly needs to be simplified. We waste time on things that should just work. See #27462.



---

archive/issue_events_376641.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:48:45Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "title_is": "local/bin/sage-env-config may not be up to date",
    "title_was": "gfan and lcalc no longer build with old g++",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376641"
}
```



---

archive/issue_comments_424364.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI think I finally figured out the root cause, I updated the description.",
    "created_at": "2019-03-21T12:48:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424364",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

I think I finally figured out the root cause, I updated the description.



---

archive/issue_events_376642.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:48:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376642"
}
```



---

archive/issue_comments_424365.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,26 +1 @@\n-Since the removal of C++11 flags from the `gfan` and `lcalc` packages, these no longer build with gcc-4.9.3:\n-\n-```\n-make[4]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/gfan-0.6.2.p1/src'\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/polynomialgcd.cpp -o src/polynomialgcd.o\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/lp_cdd.cpp -o src/lp_cdd.o\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/parser.cpp -o src/parser.o\n-src/polynomialgcd.cpp: In function 'bool simplifyPolynomialsForGCD(const PolynomialSet&, PolynomialSet&, IntegerVector&)':\n-src/polynomialgcd.cpp:286:11: error: 'i' does not name a type\n-  for(auto i=p.begin();i!=p.end();i++)dv=min(dv,i->degreeVector());\n-```\n-and\n-\n-```\n-make[5]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/lcalc-1.23.p18/src/src'\n-g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc\n-g++ -O3   -ffast-math -fPIC   -I../include -c Lgamma.cc\n-In file included from ../include/Lglobals.h:48:0,\n-                 from Lglobals.cc:23:\n-../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':\n-../include/Lcommon.h:71:8: error: 'i' does not name a type\n-   loop(i,this->N,N)\n-        ^\n-../include/Lcommon.h:51:30: note: in definition of macro 'loop'\n- #define loop(i,m,n) for(auto i=(m); i!=(n); i++)\n-```\n+The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n``````\n",
    "created_at": "2019-03-21T12:48:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424365",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,26 +1 @@
-Since the removal of C++11 flags from the `gfan` and `lcalc` packages, these no longer build with gcc-4.9.3:
-
-```
-make[4]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/gfan-0.6.2.p1/src'
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/polynomialgcd.cpp -o src/polynomialgcd.o
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/lp_cdd.cpp -o src/lp_cdd.o
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/parser.cpp -o src/parser.o
-src/polynomialgcd.cpp: In function 'bool simplifyPolynomialsForGCD(const PolynomialSet&, PolynomialSet&, IntegerVector&)':
-src/polynomialgcd.cpp:286:11: error: 'i' does not name a type
-  for(auto i=p.begin();i!=p.end();i++)dv=min(dv,i->degreeVector());
-```
-and
-
-```
-make[5]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/lcalc-1.23.p18/src/src'
-g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc
-g++ -O3   -ffast-math -fPIC   -I../include -c Lgamma.cc
-In file included from ../include/Lglobals.h:48:0,
-                 from Lglobals.cc:23:
-../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':
-../include/Lcommon.h:71:8: error: 'i' does not name a type
-   loop(i,this->N,N)
-        ^
-../include/Lcommon.h:51:30: note: in definition of macro 'loop'
- #define loop(i,m,n) for(auto i=(m); i!=(n); i++)
-```
+The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
``````




---

archive/issue_events_376643.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:49:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/worksforme",
    "label_color": "a6a6a6",
    "label_name": "worksforme",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376643"
}
```



---

archive/issue_comments_424366.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n+\n+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.\n``````\n",
    "created_at": "2019-03-21T12:51:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424366",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
+
+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.
``````




---

archive/issue_comments_424367.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n \n-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.\n+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.\n``````\n",
    "created_at": "2019-03-21T12:53:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424367",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
 
-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.
+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.
``````




---

archive/issue_comments_424368.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2019-03-21T13:02:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424368",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_424369.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n \n-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.\n+A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.\n``````\n",
    "created_at": "2019-03-21T13:02:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424369",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
 
-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.
+A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.
``````




---

archive/issue_comments_424370.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI haven't actually looked at the code, but if what you write in the description is the case then that's definitely a bug.  It should only use the one in `$SAGE_ROOT/src/bin` when it's present.",
    "created_at": "2019-03-21T13:10:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424370",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

I haven't actually looked at the code, but if what you write in the description is the case then that's definitely a bug.  It should only use the one in `$SAGE_ROOT/src/bin` when it's present.



---

archive/issue_comments_424371.json:
```json
{
    "body": "Branch: **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)**",
    "created_at": "2019-03-21T13:57:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424371",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)**



---

archive/issue_events_376644.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T14:00:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376644"
}
```



---

archive/issue_comments_424372.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@embray](#comment:26):\n> It should only use the one in `$SAGE_ROOT/src/bin` when it's present.\n\nI think there is a misunderstanding.\n\nThe problem is when *both* `local/bin/sage-env-config` and `src/bin/sage-env-config` are present. It used to prefer `local/bin/sage-env-config` which is not guaranteed to be up-to-date. Instead, it should prefer `src/bin/sage-env-config` which is directly generated by `configure`.\n\nI went for the most simple solution here. There are probably better solutions, for example having only one such file. But those require bigger changes and I didn't want to do that for a blocker ticket.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb\">939177a</a></td><td><code>Look for src/bin/sage-env-config first</code></td></tr></table>\n",
    "created_at": "2019-03-21T14:00:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424372",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@embray](#comment:26):
> It should only use the one in `$SAGE_ROOT/src/bin` when it's present.

I think there is a misunderstanding.

The problem is when *both* `local/bin/sage-env-config` and `src/bin/sage-env-config` are present. It used to prefer `local/bin/sage-env-config` which is not guaranteed to be up-to-date. Instead, it should prefer `src/bin/sage-env-config` which is directly generated by `configure`.

I went for the most simple solution here. There are probably better solutions, for example having only one such file. But those require bigger changes and I didn't want to do that for a blocker ticket.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb">939177a</a></td><td><code>Look for src/bin/sage-env-config first</code></td></tr></table>




---

archive/issue_comments_424373.json:
```json
{
    "body": "Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**",
    "created_at": "2019-03-21T14:00:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424373",
    "user": "https://github.com/jdemeyer"
}
```

Commit: **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**



---

archive/issue_events_376645.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-23T22:18:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376645"
}
```



---

archive/issue_comments_424374.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nImho its better to ship 8.7 now, realistically we can't make any promises about upgrading from old versions.",
    "created_at": "2019-03-23T22:18:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424374",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:29" align="right">comment:29</div>

Imho its better to ship 8.7 now, realistically we can't make any promises about upgrading from old versions.



---

archive/issue_comments_424375.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nIt's true that we can't make promises, but in general upgrades do work quite well. But this ticket has broken upgrading builds several times for me. It's also a regression since 8.6, so it's very sensible to make it a blocker. Moreover, this fix is easy, why not apply it?\n\nIn the end, you have the last word, but I would like you to reconsider this ticket.",
    "created_at": "2019-03-23T22:28:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424375",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

It's true that we can't make promises, but in general upgrades do work quite well. But this ticket has broken upgrading builds several times for me. It's also a regression since 8.6, so it's very sensible to make it a blocker. Moreover, this fix is easy, why not apply it?

In the end, you have the last word, but I would like you to reconsider this ticket.



---

archive/issue_events_376646.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-23T22:28:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376646"
}
```



---

archive/issue_events_376647.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-23T22:28:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376647"
}
```



---

archive/issue_comments_424376.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nIf you don't like the fix itself, there are plenty of other ways to fix the same problem. But I do think that the problem must be fixed for 8.7.",
    "created_at": "2019-03-23T22:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424376",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

If you don't like the fix itself, there are plenty of other ways to fix the same problem. But I do think that the problem must be fixed for 8.7.



---

archive/issue_events_376648.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-24T00:53:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376648"
}
```



---

archive/issue_events_376649.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-24T00:53:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376649"
}
```



---

archive/issue_comments_424377.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI see your point, but I also think its fairly low impact. The perfect is the enemy of the good...",
    "created_at": "2019-03-24T00:53:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424377",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:32" align="right">comment:32</div>

I see your point, but I also think its fairly low impact. The perfect is the enemy of the good...



---

archive/issue_comments_424378.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2019-03-24T07:00:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424378",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Volker Braun**



---

archive/issue_comments_424379.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nAmusingly, I just got bitten by this myself, but only because I copied an existing source tree to a new location.",
    "created_at": "2019-03-25T10:08:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424379",
    "user": "https://github.com/embray"
}
```

<div id="comment:34" align="right">comment:34</div>

Amusingly, I just got bitten by this myself, but only because I copied an existing source tree to a new location.



---

archive/issue_comments_424380.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nThis whole thing is totally insane - does it support `./configure --prefix=` ?\n\nShouldn't it be possible to have a number of build trees, with potentially different `sage-env-config` ? Shouldn't `src/bin/sage-env-config` actually not be there at all?!\nWhy do we keep mixing up build trees with source...",
    "created_at": "2019-03-25T10:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424380",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:35" align="right">comment:35</div>

This whole thing is totally insane - does it support `./configure --prefix=` ?

Shouldn't it be possible to have a number of build trees, with potentially different `sage-env-config` ? Shouldn't `src/bin/sage-env-config` actually not be there at all?!
Why do we keep mixing up build trees with source...



---

archive/issue_events_376650.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376650"
}
```



---

archive/issue_events_376651.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376651"
}
```



---

archive/issue_events_376652.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376652"
}
```



---

archive/issue_events_376653.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376653"
}
```



---

archive/issue_events_376654.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-25T10:23:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376654"
}
```



---

archive/issue_events_376655.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-25T10:23:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376655"
}
```



---

archive/issue_comments_424381.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@dimpase](#comment:35):\n> This whole thing is totally insane - does it support `./configure --prefix=` ?\n\nOf course it does, why should it not?\n\n> Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\nBut then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\nI'm setting this back to needs_review since I don't really understand your complaint.",
    "created_at": "2019-03-25T10:23:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424381",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@dimpase](#comment:35):
> This whole thing is totally insane - does it support `./configure --prefix=` ?

Of course it does, why should it not?

> Shouldn't `src/bin/sage-env-config` actually not be there at all?!

But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

I'm setting this back to needs_review since I don't really understand your complaint.



---

archive/issue_comments_424382.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@jdemeyer](#comment:36):\n> Replying to [@dimpase](#comment:35):\n> > This whole thing is totally insane - does it support `./configure --prefix=` ?\n\n> \n> Of course it does, why should it not?\n> \n> > Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\n> \n> But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\nOK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?\n\nIts place is not there, not in somewhere that is in the `$PATH`.\nbut rather in something like `$SAGE_LOCAL/config/` or so...\n\nI hope this explains.\n\n> \n> I'm setting this back to needs_review since I don't really understand your complaint.",
    "created_at": "2019-03-25T10:30:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424382",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@jdemeyer](#comment:36):
> Replying to [@dimpase](#comment:35):
> > This whole thing is totally insane - does it support `./configure --prefix=` ?

> 
> Of course it does, why should it not?
> 
> > Shouldn't `src/bin/sage-env-config` actually not be there at all?!

> 
> But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?

Its place is not there, not in somewhere that is in the `$PATH`.
but rather in something like `$SAGE_LOCAL/config/` or so...

I hope this explains.

> 
> I'm setting this back to needs_review since I don't really understand your complaint.



---

archive/issue_comments_424383.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@dimpase](#comment:37):\n> Its place is not there, not in somewhere that is in the `$PATH`.\n> but rather in something like `$SAGE_LOCAL/config/` or so...\n\nBut then you have a circular problem:\n\n1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`\n\n2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`",
    "created_at": "2019-03-25T10:32:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424383",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@dimpase](#comment:37):
> Its place is not there, not in somewhere that is in the `$PATH`.
> but rather in something like `$SAGE_LOCAL/config/` or so...

But then you have a circular problem:

1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`

2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`



---

archive/issue_comments_424384.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nSage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\nHaving a file that is loaded from one place when running out of the source, but a different place when \"installed\" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.",
    "created_at": "2019-03-25T10:33:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424384",
    "user": "https://github.com/embray"
}
```

<div id="comment:39" align="right">comment:39</div>

Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.



---

archive/issue_events_376656.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:33:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376656"
}
```



---

archive/issue_events_376657.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:33:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376657"
}
```



---

archive/issue_comments_424385.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@dimpase](#comment:37):\n> Replying to [@jdemeyer](#comment:36):\n> > Replying to [@dimpase](#comment:35):\n> > > This whole thing is totally insane - does it support `./configure --prefix=` ?\n\n> > \n> > Of course it does, why should it not?\n> > \n> > > Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\n> > \n> > But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\n> \n> OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?\n\nWhen running `$SAGE_LOCAL/bin/sage` for example, it uses `$SAGE_LOCAL/bin/sage-env`, which in turn should source `$SAGE_LOCAL/bin/sage-env-config` (which just sets a few variables that are determined by `./configure` and are placed in a separate file from the main `sage-env` mostly for clarity's sake...)",
    "created_at": "2019-03-25T10:36:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424385",
    "user": "https://github.com/embray"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@dimpase](#comment:37):
> Replying to [@jdemeyer](#comment:36):
> > Replying to [@dimpase](#comment:35):
> > > This whole thing is totally insane - does it support `./configure --prefix=` ?

> > 
> > Of course it does, why should it not?
> > 
> > > Shouldn't `src/bin/sage-env-config` actually not be there at all?!

> > 
> > But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

> 
> OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?

When running `$SAGE_LOCAL/bin/sage` for example, it uses `$SAGE_LOCAL/bin/sage-env`, which in turn should source `$SAGE_LOCAL/bin/sage-env-config` (which just sets a few variables that are determined by `./configure` and are placed in a separate file from the main `sage-env` mostly for clarity's sake...)



---

archive/issue_comments_424386.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nI should also note that *after installation* the contents of `$SAGE_SRC/bin/sage-env-config` and `$SAGE_LOCAL/bin/sage-env-config` are identical. But this ticket is meant to fix `sage-env-config` at *build time*, possibly before `$SAGE_SRC/bin/sage-env-config` is copied `$SAGE_LOCAL/bin/sage-env-config`.",
    "created_at": "2019-03-25T10:38:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424386",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:41" align="right">comment:41</div>

I should also note that *after installation* the contents of `$SAGE_SRC/bin/sage-env-config` and `$SAGE_LOCAL/bin/sage-env-config` are identical. But this ticket is meant to fix `sage-env-config` at *build time*, possibly before `$SAGE_SRC/bin/sage-env-config` is copied `$SAGE_LOCAL/bin/sage-env-config`.



---

archive/issue_comments_424387.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@jdemeyer](#comment:38):\n> Replying to [@dimpase](#comment:37):\n> > Its place is not there, not in somewhere that is in the `$PATH`.\n> > but rather in something like `$SAGE_LOCAL/config/` or so...\n\n> \n> But then you have a circular problem:\n> \n> 1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`\n\n\nYou just said that this is available from `src/bin/sage-env-config`, no?\n\n\n> \n> 2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`\n\nNo, this is in `src/bin/sage-env-config`, that's how you can find it.\n\nWell, maybe there is my aversion to changing the environment without running `./configure` that speaks here, but this is really the same issue as in #27373.",
    "created_at": "2019-03-25T10:41:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424387",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@jdemeyer](#comment:38):
> Replying to [@dimpase](#comment:37):
> > Its place is not there, not in somewhere that is in the `$PATH`.
> > but rather in something like `$SAGE_LOCAL/config/` or so...

> 
> But then you have a circular problem:
> 
> 1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`


You just said that this is available from `src/bin/sage-env-config`, no?


> 
> 2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`

No, this is in `src/bin/sage-env-config`, that's how you can find it.

Well, maybe there is my aversion to changing the environment without running `./configure` that speaks here, but this is really the same issue as in #27373.



---

archive/issue_comments_424388.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@embray](#comment:39):\n> Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\nDo you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?\n\n\n\n> \n> Having a file that is loaded from one place when running out of the source, but a different place when \"installed\" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.\n\nIn this case \"installed\" ought to happen at the end, after the build is done and dusted.",
    "created_at": "2019-03-25T10:48:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424388",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@embray](#comment:39):
> Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?



> 
> Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.

In this case "installed" ought to happen at the end, after the build is done and dusted.



---

archive/issue_comments_424389.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@dimpase](#comment:43):\n> Replying to [@embray](#comment:39):\n> > Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\n> \n> Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?\n\nNo, that has nothing to do with it.  I'm just saying it doesn't work if you don't run Sage out of a source tree, because manually installing packages still depends on the whole sage-the-distribution machinery which does not get \"installed\" in any sense.  It was just an aside; I'm sorry if my mentioning it confused matters.",
    "created_at": "2019-03-25T10:59:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424389",
    "user": "https://github.com/embray"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@dimpase](#comment:43):
> Replying to [@embray](#comment:39):
> > Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

> 
> Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?

No, that has nothing to do with it.  I'm just saying it doesn't work if you don't run Sage out of a source tree, because manually installing packages still depends on the whole sage-the-distribution machinery which does not get "installed" in any sense.  It was just an aside; I'm sorry if my mentioning it confused matters.



---

archive/issue_events_376658.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-25T19:43:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376658"
}
```



---

archive/issue_events_376659.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "7b075a74b536fd1ef64f5cb10bfb53bfb31f9c81",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-03-25T19:43:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27422#event-376659"
}
```



---

archive/issue_comments_424390.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)** to **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**",
    "created_at": "2019-03-25T19:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27422#issuecomment-424390",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)** to **[939177a](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)**
