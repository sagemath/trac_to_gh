# Issue 27422: local/bin/sage-env-config may not be up to date

archive/issues_027185.json:
```json
{
    "body": "The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n\nA very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.\n\n**CC:**  @kiwifb @embray\n\n**Branch/Commit:** [939177af6646f9c91c32444ed5da1104d43655fb](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)\n\n**Reviewer:** Volker Braun\n\n**Author:** Jeroen Demeyer\n\nIssue created by migration from https://trac.sagemath.org/ticket/27422\n\n",
    "closed_at": "2019-03-25T19:43:05Z",
    "created_at": "2019-03-04T16:38:37Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "local/bin/sage-env-config may not be up to date",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27422",
    "user": "https://github.com/jdemeyer"
}
```
The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.

A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.

**CC:**  @kiwifb @embray

**Branch/Commit:** [939177af6646f9c91c32444ed5da1104d43655fb](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)

**Reviewer:** Volker Braun

**Author:** Jeroen Demeyer

Issue created by migration from https://trac.sagemath.org/ticket/27422





---

archive/issue_events_242164.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-04T16:40:10Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "rename": {
        "from": "gfan and lcalc no longer build with old gcc",
        "to": "gfan and lcalc no longer build with old g++"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242164"
}
```



---

archive/issue_comments_426950.json:
```json
{
    "body": "<a id='comment:3'></a>\nBut the `auto` is new C++, how did it work before? Is it because this sets C++ to too old a standard?",
    "created_at": "2019-03-04T16:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426950",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
But the `auto` is new C++, how did it work before? Is it because this sets C++ to too old a standard?



---

archive/issue_comments_426951.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [dimpase](#comment%3A3):\n> But the `auto` is new C++, how did it work before?\n\n\nBefore #26787, these packages were compiled with `-std=c++11`. So the obvious fix is simply to put back those flags which were removed in #26787.",
    "created_at": "2019-03-04T17:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426951",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Replying to [dimpase](#comment%3A3):
> But the `auto` is new C++, how did it work before?


Before #26787, these packages were compiled with `-std=c++11`. So the obvious fix is simply to put back those flags which were removed in #26787.



---

archive/issue_comments_426952.json:
```json
{
    "body": "<a id='comment:6'></a>\nFrancois says on #26787 that it's meant to be that CXX becomes `$CXX -std=gnu++11` But somehow this does not happen here for some reason.\n\nCould you post the `sage-env-config` from one of these broken systems here?",
    "created_at": "2019-03-04T17:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426952",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
Francois says on #26787 that it's meant to be that CXX becomes `$CXX -std=gnu++11` But somehow this does not happen here for some reason.

Could you post the `sage-env-config` from one of these broken systems here?



---

archive/issue_comments_426953.json:
```json
{
    "body": "<a id='comment:7'></a>\nAfter trying again, it now works correctly...\n\nSo maybe there is a problem with dependency checking, that the settings for `CXX` are not propagated correctly?",
    "created_at": "2019-03-04T17:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426953",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
After trying again, it now works correctly...

So maybe there is a problem with dependency checking, that the settings for `CXX` are not propagated correctly?



---

archive/issue_comments_426954.json:
```json
{
    "body": "<a id='comment:8'></a>\nPerhaps for some reason `./configure` didn't get run (or perhaps `./bootstrap`)? My understanding is that it `./configure` would fill in the template in  `sage-env-config.in`, producing `sage-env-config` with the correct settings, and `sage-env` will set `CXX` to the right value.",
    "created_at": "2019-03-04T17:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426954",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
Perhaps for some reason `./configure` didn't get run (or perhaps `./bootstrap`)? My understanding is that it `./configure` would fill in the template in  `sage-env-config.in`, producing `sage-env-config` with the correct settings, and `sage-env` will set `CXX` to the right value.



---

archive/issue_comments_426955.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis happened when upgrading from 8.6. I can try to again to see if I can reproduce it.",
    "created_at": "2019-03-04T19:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426955",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
This happened when upgrading from 8.6. I can try to again to see if I can reproduce it.



---

archive/issue_comments_426956.json:
```json
{
    "body": "<a id='comment:10'></a>\nI can think of a number of ways to interpret  \"upgrading\". Please be more specific.",
    "created_at": "2019-03-04T19:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426956",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
I can think of a number of ways to interpret  "upgrading". Please be more specific.



---

archive/issue_comments_426957.json:
```json
{
    "body": "<a id='comment:11'></a>\nI am guessing just doing `make` after synchronising didn't run `configure`.",
    "created_at": "2019-03-04T19:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426957",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:11'></a>
I am guessing just doing `make` after synchronising didn't run `configure`.



---

archive/issue_events_242165.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "worksforme",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242165"
}
```



---

archive/issue_comments_426958.json:
```json
{
    "body": "<a id='comment:12'></a>\nI cannot reproduce this.",
    "created_at": "2019-03-08T14:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426958",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
I cannot reproduce this.



---

archive/issue_events_242166.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242166"
}
```



---

archive/issue_events_242167.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242167"
}
```



---

archive/issue_events_242168.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-08T14:24:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "invalid",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242168"
}
```



---

archive/issue_comments_426959.json:
```json
{
    "body": "<a id='comment:13'></a>\nI just got this issue again. This time, I remember better which steps I took, so I'll try to reproduce it.",
    "created_at": "2019-03-11T09:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426959",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
I just got this issue again. This time, I remember better which steps I took, so I'll try to reproduce it.



---

archive/issue_comments_426960.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [fbissey](#comment%3A11):\n> I am guessing just doing `make` after synchronising didn't run `configure`.\n\n\nBut it should according to the top-level `Makefile`.",
    "created_at": "2019-03-11T09:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426960",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [fbissey](#comment%3A11):
> I am guessing just doing `make` after synchronising didn't run `configure`.


But it should according to the top-level `Makefile`.



---

archive/issue_comments_426961.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [jdemeyer](#comment%3A14):\n> Replying to [fbissey](#comment%3A11):\n> > I am guessing just doing `make` after synchronising didn't run `configure`.\n\n> \n> But it should according to the top-level `Makefile`.\n\n\nThe glob `build/pkgs/*/*` in the `build/make/Makefile` target should indeed trigger it. At least that's what we expect. But you should have logs showing whether it happened or not.",
    "created_at": "2019-03-11T09:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426961",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:15'></a>
Replying to [jdemeyer](#comment%3A14):
> Replying to [fbissey](#comment%3A11):
> > I am guessing just doing `make` after synchronising didn't run `configure`.

> 
> But it should according to the top-level `Makefile`.


The glob `build/pkgs/*/*` in the `build/make/Makefile` target should indeed trigger it. At least that's what we expect. But you should have logs showing whether it happened or not.



---

archive/issue_comments_426962.json:
```json
{
    "body": "<a id='comment:16'></a>\nIf I recall correctly, then both this time and the last time, the build worked on the third invocation of `make build`. So there were 2 failed builds of `gfan` and the third one worked. So somewhere in between, `./configure` was run correctly.",
    "created_at": "2019-03-11T09:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426962",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
If I recall correctly, then both this time and the last time, the build worked on the third invocation of `make build`. So there were 2 failed builds of `gfan` and the third one worked. So somewhere in between, `./configure` was run correctly.



---

archive/issue_comments_426963.json:
```json
{
    "body": "<a id='comment:17'></a>\nI guess that's all that toolchain things that should have been removed from Sage proper many years ago. Now the build system is so complicated that it slows the development down.\n\nOnce #27212, #27258, and #27259 are in, every toolchain part can come from the system (or an external custom package), and I see no reason for not moving the toolchain and its deps into a separate custom package.",
    "created_at": "2019-03-11T11:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426963",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
I guess that's all that toolchain things that should have been removed from Sage proper many years ago. Now the build system is so complicated that it slows the development down.

Once #27212, #27258, and #27259 are in, every toolchain part can come from the system (or an external custom package), and I see no reason for not moving the toolchain and its deps into a separate custom package.



---

archive/issue_comments_426964.json:
```json
{
    "body": "<a id='comment:18'></a>\nI tried to reproduce, but again I didn't manage.",
    "created_at": "2019-03-11T11:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426964",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
I tried to reproduce, but again I didn't manage.



---

archive/issue_comments_426965.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [dimpase](#comment%3A17):\n> Once #27212, #27258, and #27259 are in\n\n\nWhy are you bringing up mpir/mpfr/mpc? There is no evidence that these packages have anything to do with the problem that I'm seeing here.",
    "created_at": "2019-03-11T11:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426965",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
Replying to [dimpase](#comment%3A17):
> Once #27212, #27258, and #27259 are in


Why are you bringing up mpir/mpfr/mpc? There is no evidence that these packages have anything to do with the problem that I'm seeing here.



---

archive/issue_comments_426966.json:
```json
{
    "body": "<a id='comment:20'></a>\nI am bringing this up as our build system badly needs to be simplified. We waste time on things that should just work. See #27462.",
    "created_at": "2019-03-11T11:26:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426966",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>
I am bringing this up as our build system badly needs to be simplified. We waste time on things that should just work. See #27462.



---

archive/issue_events_242169.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:48:45Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "rename": {
        "from": "gfan and lcalc no longer build with old g++",
        "to": "local/bin/sage-env-config may not be up to date"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242169"
}
```



---

archive/issue_comments_426967.json:
```json
{
    "body": "<a id='comment:21'></a>\nI think I finally figured out the root cause, I updated the description.",
    "created_at": "2019-03-21T12:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426967",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
I think I finally figured out the root cause, I updated the description.



---

archive/issue_events_242170.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:48:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242170"
}
```



---

archive/issue_comments_426968.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,26 +1 @@\n-Since the removal of C++11 flags from the `gfan` and `lcalc` packages, these no longer build with gcc-4.9.3:\n-\n-```\n-make[4]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/gfan-0.6.2.p1/src'\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/polynomialgcd.cpp -o src/polynomialgcd.o\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/lp_cdd.cpp -o src/lp_cdd.o\n-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/parser.cpp -o src/parser.o\n-src/polynomialgcd.cpp: In function 'bool simplifyPolynomialsForGCD(const PolynomialSet&, PolynomialSet&, IntegerVector&)':\n-src/polynomialgcd.cpp:286:11: error: 'i' does not name a type\n-  for(auto i=p.begin();i!=p.end();i++)dv=min(dv,i->degreeVector());\n-```\n-and\n-\n-```\n-make[5]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/lcalc-1.23.p18/src/src'\n-g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc\n-g++ -O3   -ffast-math -fPIC   -I../include -c Lgamma.cc\n-In file included from ../include/Lglobals.h:48:0,\n-                 from Lglobals.cc:23:\n-../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':\n-../include/Lcommon.h:71:8: error: 'i' does not name a type\n-   loop(i,this->N,N)\n-        ^\n-../include/Lcommon.h:51:30: note: in definition of macro 'loop'\n- #define loop(i,m,n) for(auto i=(m); i!=(n); i++)\n-```\n+The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n``````\n",
    "created_at": "2019-03-21T12:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426968",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,26 +1 @@
-Since the removal of C++11 flags from the `gfan` and `lcalc` packages, these no longer build with gcc-4.9.3:
-
-```
-make[4]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/gfan-0.6.2.p1/src'
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/polynomialgcd.cpp -o src/polynomialgcd.o
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/lp_cdd.cpp -o src/lp_cdd.o
-g++  -DNOCDDPREFIX -DGMPRATIONAL -Wuninitialized -fno-omit-frame-pointer -O2      -g     -c src/parser.cpp -o src/parser.o
-src/polynomialgcd.cpp: In function 'bool simplifyPolynomialsForGCD(const PolynomialSet&, PolynomialSet&, IntegerVector&)':
-src/polynomialgcd.cpp:286:11: error: 'i' does not name a type
-  for(auto i=p.begin();i!=p.end();i++)dv=min(dv,i->degreeVector());
-```
-and
-
-```
-make[5]: Entering directory '/home/jdemeyer/sage/local/var/tmp/sage/build/lcalc-1.23.p18/src/src'
-g++ -O3   -ffast-math -fPIC   -I../include -c Lglobals.cc
-g++ -O3   -ffast-math -fPIC   -I../include -c Lgamma.cc
-In file included from ../include/Lglobals.h:48:0,
-                 from Lglobals.cc:23:
-../include/Lcommon.h: In member function 'void smallPoly<T>::resize(int)':
-../include/Lcommon.h:71:8: error: 'i' does not name a type
-   loop(i,this->N,N)
-        ^
-../include/Lcommon.h:51:30: note: in definition of macro 'loop'
- #define loop(i,m,n) for(auto i=(m); i!=(n); i++)
-```
+The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
``````




---

archive/issue_events_242171.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T12:49:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "worksforme",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242171"
}
```



---

archive/issue_comments_426969.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n+\n+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.\n``````\n",
    "created_at": "2019-03-21T12:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426969",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
+
+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.
``````




---

archive/issue_comments_426970.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n \n-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.\n+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.\n``````\n",
    "created_at": "2019-03-21T12:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426970",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
 
-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`.
+An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.
``````




---

archive/issue_comments_426971.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2019-03-21T13:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426971",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_426972.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.\n \n-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.\n+A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.\n``````\n",
    "created_at": "2019-03-21T13:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426972",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 The top-level `configure` writes `src/bin/sage-env-config`. However, the file `local/bin/sage-env-config` is what is actually used by the build system. At some point during the build, `src/bin/sage-env-config` is copied to `local/bin/sage-env-config` but this does not happen immediately. This leads to race conditions where packages may be built with the wrong `sage-env-config`.
 
-An obvious solution is not to create the file `src/bin/sage-env-config` but to create `local/bin/sage-env-config` directly in `configure`. This makes sense for another reason: ideally, we shouldn't write anything in `src` in the first place.
+A very simple solution is to prefer `src/bin/sage-env-config` in case that both are present.
``````




---

archive/issue_comments_426973.json:
```json
{
    "body": "<a id='comment:26'></a>\nI haven't actually looked at the code, but if what you write in the description is the case then that's definitely a bug.  It should only use the one in `$SAGE_ROOT/src/bin` when it's present.",
    "created_at": "2019-03-21T13:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426973",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>
I haven't actually looked at the code, but if what you write in the description is the case then that's definitely a bug.  It should only use the one in `$SAGE_ROOT/src/bin` when it's present.



---

archive/issue_comments_426974.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)",
    "created_at": "2019-03-21T13:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426974",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)



---

archive/issue_events_242172.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-21T14:00:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242172"
}
```



---

archive/issue_comments_426975.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [embray](#comment%3A26):\n> It should only use the one in `$SAGE_ROOT/src/bin` when it's present.\n\n\nI think there is a misunderstanding.\n\nThe problem is when *both* `local/bin/sage-env-config` and `src/bin/sage-env-config` are present. It used to prefer `local/bin/sage-env-config` which is not guaranteed to be up-to-date. Instead, it should prefer `src/bin/sage-env-config` which is directly generated by `configure`.\n\nI went for the most simple solution here. There are probably better solutions, for example having only one such file. But those require bigger changes and I didn't want to do that for a blocker ticket.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb\">939177a</a></td><td><code>Look for src/bin/sage-env-config first</code></td></tr></table>\n",
    "created_at": "2019-03-21T14:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426975",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Replying to [embray](#comment%3A26):
> It should only use the one in `$SAGE_ROOT/src/bin` when it's present.


I think there is a misunderstanding.

The problem is when *both* `local/bin/sage-env-config` and `src/bin/sage-env-config` are present. It used to prefer `local/bin/sage-env-config` which is not guaranteed to be up-to-date. Instead, it should prefer `src/bin/sage-env-config` which is directly generated by `configure`.

I went for the most simple solution here. There are probably better solutions, for example having only one such file. But those require bigger changes and I didn't want to do that for a blocker ticket.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb">939177a</a></td><td><code>Look for src/bin/sage-env-config first</code></td></tr></table>




---

archive/issue_comments_426976.json:
```json
{
    "body": "**Commit:** [939177af6646f9c91c32444ed5da1104d43655fb](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)",
    "created_at": "2019-03-21T14:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426976",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [939177af6646f9c91c32444ed5da1104d43655fb](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)



---

archive/issue_events_242173.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-23T22:18:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242173"
}
```



---

archive/issue_comments_426977.json:
```json
{
    "body": "<a id='comment:29'></a>\nImho its better to ship 8.7 now, realistically we can't make any promises about upgrading from old versions.",
    "created_at": "2019-03-23T22:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426977",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>
Imho its better to ship 8.7 now, realistically we can't make any promises about upgrading from old versions.



---

archive/issue_comments_426978.json:
```json
{
    "body": "<a id='comment:30'></a>\nIt's true that we can't make promises, but in general upgrades do work quite well. But this ticket has broken upgrading builds several times for me. It's also a regression since 8.6, so it's very sensible to make it a blocker. Moreover, this fix is easy, why not apply it?\n\nIn the end, you have the last word, but I would like you to reconsider this ticket.",
    "created_at": "2019-03-23T22:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426978",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>
It's true that we can't make promises, but in general upgrades do work quite well. But this ticket has broken upgrading builds several times for me. It's also a regression since 8.6, so it's very sensible to make it a blocker. Moreover, this fix is easy, why not apply it?

In the end, you have the last word, but I would like you to reconsider this ticket.



---

archive/issue_events_242174.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-23T22:28:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242174"
}
```



---

archive/issue_comments_426979.json:
```json
{
    "body": "<a id='comment:31'></a>\nIf you don't like the fix itself, there are plenty of other ways to fix the same problem. But I do think that the problem must be fixed for 8.7.",
    "created_at": "2019-03-23T22:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426979",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
If you don't like the fix itself, there are plenty of other ways to fix the same problem. But I do think that the problem must be fixed for 8.7.



---

archive/issue_events_242175.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-24T00:53:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242175"
}
```



---

archive/issue_events_242176.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-24T00:53:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242176"
}
```



---

archive/issue_comments_426980.json:
```json
{
    "body": "<a id='comment:32'></a>\nI see your point, but I also think its fairly low impact. The perfect is the enemy of the good...",
    "created_at": "2019-03-24T00:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426980",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'></a>
I see your point, but I also think its fairly low impact. The perfect is the enemy of the good...



---

archive/issue_comments_426981.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2019-03-24T07:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426981",
    "user": "https://github.com/fchapoton"
}
```

**Reviewer:** Volker Braun



---

archive/issue_comments_426982.json:
```json
{
    "body": "<a id='comment:34'></a>\nAmusingly, I just got bitten by this myself, but only because I copied an existing source tree to a new location.",
    "created_at": "2019-03-25T10:08:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426982",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>
Amusingly, I just got bitten by this myself, but only because I copied an existing source tree to a new location.



---

archive/issue_comments_426983.json:
```json
{
    "body": "<a id='comment:35'></a>\nThis whole thing is totally insane - does it support `./configure --prefix=` ?\n\nShouldn't it be possible to have a number of build trees, with potentially different `sage-env-config` ? Shouldn't `src/bin/sage-env-config` actually not be there at all?!\nWhy do we keep mixing up build trees with source...",
    "created_at": "2019-03-25T10:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426983",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>
This whole thing is totally insane - does it support `./configure --prefix=` ?

Shouldn't it be possible to have a number of build trees, with potentially different `sage-env-config` ? Shouldn't `src/bin/sage-env-config` actually not be there at all?!
Why do we keep mixing up build trees with source...



---

archive/issue_events_242177.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242177"
}
```



---

archive/issue_events_242178.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242178"
}
```



---

archive/issue_events_242179.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242179"
}
```



---

archive/issue_events_242180.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-25T10:17:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242180"
}
```



---

archive/issue_events_242181.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-25T10:23:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242181"
}
```



---

archive/issue_events_242182.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-25T10:23:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242182"
}
```



---

archive/issue_comments_426984.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [dimpase](#comment%3A35):\n> This whole thing is totally insane - does it support `./configure --prefix=` ?\n\n\nOf course it does, why should it not?\n\n> Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\n\nBut then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\nI'm setting this back to needs_review since I don't really understand your complaint.",
    "created_at": "2019-03-25T10:23:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426984",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>
Replying to [dimpase](#comment%3A35):
> This whole thing is totally insane - does it support `./configure --prefix=` ?


Of course it does, why should it not?

> Shouldn't `src/bin/sage-env-config` actually not be there at all?!


But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

I'm setting this back to needs_review since I don't really understand your complaint.



---

archive/issue_comments_426985.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [jdemeyer](#comment%3A36):\n> Replying to [dimpase](#comment%3A35):\n> > This whole thing is totally insane - does it support `./configure --prefix=` ?\n\n> \n> Of course it does, why should it not?\n> \n> > Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\n> \n> But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\n\nOK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?\n\nIts place is not there, not in somewhere that is in the `$PATH`.\nbut rather in something like `$SAGE_LOCAL/config/` or so...\n\nI hope this explains.\n\n> \n> I'm setting this back to needs_review since I don't really understand your complaint.\n",
    "created_at": "2019-03-25T10:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426985",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>
Replying to [jdemeyer](#comment%3A36):
> Replying to [dimpase](#comment%3A35):
> > This whole thing is totally insane - does it support `./configure --prefix=` ?

> 
> Of course it does, why should it not?
> 
> > Shouldn't `src/bin/sage-env-config` actually not be there at all?!

> 
> But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.


OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?

Its place is not there, not in somewhere that is in the `$PATH`.
but rather in something like `$SAGE_LOCAL/config/` or so...

I hope this explains.

> 
> I'm setting this back to needs_review since I don't really understand your complaint.




---

archive/issue_comments_426986.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [dimpase](#comment%3A37):\n> Its place is not there, not in somewhere that is in the `$PATH`.\n> but rather in something like `$SAGE_LOCAL/config/` or so...\n\n\nBut then you have a circular problem:\n\n1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`\n\n2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`",
    "created_at": "2019-03-25T10:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426986",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:38'></a>
Replying to [dimpase](#comment%3A37):
> Its place is not there, not in somewhere that is in the `$PATH`.
> but rather in something like `$SAGE_LOCAL/config/` or so...


But then you have a circular problem:

1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`

2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`



---

archive/issue_comments_426987.json:
```json
{
    "body": "<a id='comment:39'></a>\nSage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\nHaving a file that is loaded from one place when running out of the source, but a different place when \"installed\" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.",
    "created_at": "2019-03-25T10:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426987",
    "user": "https://github.com/embray"
}
```

<a id='comment:39'></a>
Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.



---

archive/issue_events_242183.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:33:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242183"
}
```



---

archive/issue_events_242184.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:33:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242184"
}
```



---

archive/issue_comments_426988.json:
```json
{
    "body": "<a id='comment:40'></a>\nReplying to [dimpase](#comment%3A37):\n> Replying to [jdemeyer](#comment%3A36):\n> > Replying to [dimpase](#comment%3A35):\n> > > This whole thing is totally insane - does it support `./configure --prefix=` ?\n\n> > \n> > Of course it does, why should it not?\n> > \n> > > Shouldn't `src/bin/sage-env-config` actually not be there at all?!\n\n> > \n> > But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.\n\n> \n> OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?\n\n\nWhen running `$SAGE_LOCAL/bin/sage` for example, it uses `$SAGE_LOCAL/bin/sage-env`, which in turn should source `$SAGE_LOCAL/bin/sage-env-config` (which just sets a few variables that are determined by `./configure` and are placed in a separate file from the main `sage-env` mostly for clarity's sake...)",
    "created_at": "2019-03-25T10:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426988",
    "user": "https://github.com/embray"
}
```

<a id='comment:40'></a>
Replying to [dimpase](#comment%3A37):
> Replying to [jdemeyer](#comment%3A36):
> > Replying to [dimpase](#comment%3A35):
> > > This whole thing is totally insane - does it support `./configure --prefix=` ?

> > 
> > Of course it does, why should it not?
> > 
> > > Shouldn't `src/bin/sage-env-config` actually not be there at all?!

> > 
> > But then how is `$SAGE_LOCAL` determined? If you use `--prefix`, there needs to be at least one place where the location of `$SAGE_LOCAL` is stored and that place is `src/bin/sage-env-config`.

> 
> OK, fine, but why does this even get copied into `$SAGE_LOCAL/bin/`?


When running `$SAGE_LOCAL/bin/sage` for example, it uses `$SAGE_LOCAL/bin/sage-env`, which in turn should source `$SAGE_LOCAL/bin/sage-env-config` (which just sets a few variables that are determined by `./configure` and are placed in a separate file from the main `sage-env` mostly for clarity's sake...)



---

archive/issue_comments_426989.json:
```json
{
    "body": "<a id='comment:41'></a>\nI should also note that *after installation* the contents of `$SAGE_SRC/bin/sage-env-config` and `$SAGE_LOCAL/bin/sage-env-config` are identical. But this ticket is meant to fix `sage-env-config` at *build time*, possibly before `$SAGE_SRC/bin/sage-env-config` is copied `$SAGE_LOCAL/bin/sage-env-config`.",
    "created_at": "2019-03-25T10:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426989",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
I should also note that *after installation* the contents of `$SAGE_SRC/bin/sage-env-config` and `$SAGE_LOCAL/bin/sage-env-config` are identical. But this ticket is meant to fix `sage-env-config` at *build time*, possibly before `$SAGE_SRC/bin/sage-env-config` is copied `$SAGE_LOCAL/bin/sage-env-config`.



---

archive/issue_comments_426990.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [jdemeyer](#comment%3A38):\n> Replying to [dimpase](#comment%3A37):\n> > Its place is not there, not in somewhere that is in the `$PATH`.\n> > but rather in something like `$SAGE_LOCAL/config/` or so...\n\n> \n> But then you have a circular problem:\n> \n> 1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`\n\n\n\nYou just said that this is available from `src/bin/sage-env-config`, no?\n\n\n> \n> 2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`\n\n\nNo, this is in `src/bin/sage-env-config`, that's how you can find it.\n\nWell, maybe there is my aversion to changing the environment without running `./configure` that speaks here, but this is really the same issue as in #27373.",
    "created_at": "2019-03-25T10:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426990",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'></a>
Replying to [jdemeyer](#comment%3A38):
> Replying to [dimpase](#comment%3A37):
> > Its place is not there, not in somewhere that is in the `$PATH`.
> > but rather in something like `$SAGE_LOCAL/config/` or so...

> 
> But then you have a circular problem:
> 
> 1. you need to know `$SAGE_LOCAL` in order to find the file `$SAGE_LOCAL/config/sage-env-config`



You just said that this is available from `src/bin/sage-env-config`, no?


> 
> 2. you need to read `$SAGE_LOCAL/config/sage-env-config` to know `$SAGE_LOCAL`


No, this is in `src/bin/sage-env-config`, that's how you can find it.

Well, maybe there is my aversion to changing the environment without running `./configure` that speaks here, but this is really the same issue as in #27373.



---

archive/issue_comments_426991.json:
```json
{
    "body": "<a id='comment:43'></a>\nReplying to [embray](#comment%3A39):\n> Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\n\nDo you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?\n\n\n\n> \n> Having a file that is loaded from one place when running out of the source, but a different place when \"installed\" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.\n\n\nIn this case \"installed\" ought to happen at the end, after the build is done and dusted.",
    "created_at": "2019-03-25T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426991",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'></a>
Replying to [embray](#comment%3A39):
> Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).


Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?



> 
> Having a file that is loaded from one place when running out of the source, but a different place when "installed" is normal, and there are many cases like that in Sage.  This makes perfect sense to me as-is.


In this case "installed" ought to happen at the end, after the build is done and dusted.



---

archive/issue_comments_426992.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [dimpase](#comment%3A43):\n> Replying to [embray](#comment%3A39):\n> > Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).\n\n> \n> Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?\n\n\nNo, that has nothing to do with it.  I'm just saying it doesn't work if you don't run Sage out of a source tree, because manually installing packages still depends on the whole sage-the-distribution machinery which does not get \"installed\" in any sense.  It was just an aside; I'm sorry if my mentioning it confused matters.",
    "created_at": "2019-03-25T10:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426992",
    "user": "https://github.com/embray"
}
```

<a id='comment:44'></a>
Replying to [dimpase](#comment%3A43):
> Replying to [embray](#comment%3A39):
> > Sage is traditionally built/run out of its source tree by many users, who are also developers.  But it can also be run, for the most part, outside of its source tree (running `sage -i` doesn't work outside the source tree, which is something I believe should be fixed, but that's a bigger topic).

> 
> Do you say that `sage -i` doesn't work if `./configure --prefix=X` was run with `X != $SAGE_LOCAL`?


No, that has nothing to do with it.  I'm just saying it doesn't work if you don't run Sage out of a source tree, because manually installing packages still depends on the whole sage-the-distribution machinery which does not get "installed" in any sense.  It was just an aside; I'm sorry if my mentioning it confused matters.



---

archive/issue_events_242185.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-25T19:43:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242185"
}
```



---

archive/issue_events_242186.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-25T19:43:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27422#event-242186"
}
```



---

archive/issue_comments_426993.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)\" to \"[939177af6646f9c91c32444ed5da1104d43655fb](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)\".",
    "created_at": "2019-03-25T19:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27422",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27422#issuecomment-426993",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/local_bin_sage_env_config_may_not_be_up_to_date)" to "[939177af6646f9c91c32444ed5da1104d43655fb](https://github.com/sagemath/sagetrac-mirror/commit/939177af6646f9c91c32444ed5da1104d43655fb)".
