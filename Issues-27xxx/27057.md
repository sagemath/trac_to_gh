# Issue 27057: speedup crystal weight and spin e/f

archive/issues_026820.json:
```json
{
    "body": "\n\nCC:  @tscrim @anneschilling\n\nReviewer: Travis Scrimshaw, Martin Rubey\n\nAuthor: Travis Scrimshaw\n\nBranch: d2fe93d9fb8a2fd8051c266e23724519c77e8fdf\n\nCommit: d2fe93d9fb8a2fd8051c266e23724519c77e8fdf\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27057\n\n",
    "closed_at": "2019-01-26T15:55:41Z",
    "created_at": "2019-01-14T23:33:47Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "speedup crystal weight and spin e/f",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27057",
    "user": "https://github.com/mantepse"
}
```


CC:  @tscrim @anneschilling

Reviewer: Travis Scrimshaw, Martin Rubey

Author: Travis Scrimshaw

Branch: d2fe93d9fb8a2fd8051c266e23724519c77e8fdf

Commit: d2fe93d9fb8a2fd8051c266e23724519c77e8fdf

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27057





---

archive/issue_comments_376852.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-01-14T23:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376852",
    "user": "https://github.com/mantepse"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_376853.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2019-01-14T23:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376853",
    "user": "https://github.com/mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_376854.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2019-01-14T23:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376854",
    "user": "https://github.com/mantepse"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_376855.json:
```json
{
    "body": "<a id='comment:2'></a>I need faster crystals, but I am not sure how to go about it.  Here is a first try - old:\n\n```\nsage: n = 3; r = 7; C = crystals.Spins(CartanType([\"B\", n])); T = crystals.TensorProduct(*[C for i in range(r)])\nsage: hi = T.highest_weight_vectors()\nsage: %timeit [v.weight() for v in T.highest_weight_vectors()]\n1 loop, best of 3: 6.52 s per loop\n```\nnew:\n\n```\nsage: n = 3; r = 7; C = crystals.Spins(CartanType([\"B\", n])); T = crystals.TensorProduct(*[C for i in range(r)])\nsage: hi = T.highest_weight_vectors()\nsage: %timeit [v.weight() for v in T.highest_weight_vectors()]\n1 loop, best of 3: 4.22 s per loop\n```\n\nRemoving the assertions `assert i in self.index_set()` in `spins.py` would also save some time, I don't know how useful they are.  Perhaps they can be replaced with `assert 0 < i <= rank`?\n\nSomewhat surprisingly, a large amount of time is used in recomputing `root_system` of a Cartan type, in `weight_lattice_realization`.  I think it makes sense to cache it, but maybe I am overlooking something better.\n\n---\nNew commits:",
    "created_at": "2019-01-14T23:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376855",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:2'></a>I need faster crystals, but I am not sure how to go about it.  Here is a first try - old:

```
sage: n = 3; r = 7; C = crystals.Spins(CartanType(["B", n])); T = crystals.TensorProduct(*[C for i in range(r)])
sage: hi = T.highest_weight_vectors()
sage: %timeit [v.weight() for v in T.highest_weight_vectors()]
1 loop, best of 3: 6.52 s per loop
```
new:

```
sage: n = 3; r = 7; C = crystals.Spins(CartanType(["B", n])); T = crystals.TensorProduct(*[C for i in range(r)])
sage: hi = T.highest_weight_vectors()
sage: %timeit [v.weight() for v in T.highest_weight_vectors()]
1 loop, best of 3: 4.22 s per loop
```

Removing the assertions `assert i in self.index_set()` in `spins.py` would also save some time, I don't know how useful they are.  Perhaps they can be replaced with `assert 0 < i <= rank`?

Somewhat surprisingly, a large amount of time is used in recomputing `root_system` of a Cartan type, in `weight_lattice_realization`.  I think it makes sense to cache it, but maybe I am overlooking something better.

---
New commits:



---

archive/issue_comments_376856.json:
```json
{
    "body": "<a id='comment:3'></a>I am worried that caching `root_system` would lead to a memory leak since `RootSystem` is a `UniqueRepresentation` (there already is a memory leak for root systems IIRC, but this will likely make the problem worse).\n\nWe do not want to do `assert` for validating user input (they should only be used for serious problems); instead raise a, e.g., `ValueError`. (This is a holdover from older code.) However, generically, the `index_set()` does not have to be `[n]`. Granted, many of the crystals are using this as an assumption (e.g., `CrystalOfLetters`) for various reasons. I probably would not remove the check within Sage itself because it is already there. If this does become a serious bottleneck in the computations you need, I would simply remove them from the code for your computation.\n\nTo really get a good speedup, I would cythonize the spin crystals (use some sort of bitset or bint array) and implement a custom `weight` function. You probably also want to have a better check for `epsilon` and `phi` too.",
    "created_at": "2019-01-15T00:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376856",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>I am worried that caching `root_system` would lead to a memory leak since `RootSystem` is a `UniqueRepresentation` (there already is a memory leak for root systems IIRC, but this will likely make the problem worse).

We do not want to do `assert` for validating user input (they should only be used for serious problems); instead raise a, e.g., `ValueError`. (This is a holdover from older code.) However, generically, the `index_set()` does not have to be `[n]`. Granted, many of the crystals are using this as an assumption (e.g., `CrystalOfLetters`) for various reasons. I probably would not remove the check within Sage itself because it is already there. If this does become a serious bottleneck in the computations you need, I would simply remove them from the code for your computation.

To really get a good speedup, I would cythonize the spin crystals (use some sort of bitset or bint array) and implement a custom `weight` function. You probably also want to have a better check for `epsilon` and `phi` too.



---

archive/issue_comments_376857.json:
```json
{
    "body": "<a id='comment:4'></a>Thank you for looking into this!  One question: I realize that the index set does not need to be `[n]` generically, but it does it have to be `[n]` within `spins.py`?  (I think otherwise `ret[i] = 1` shouldn't work, right?)\n\nSince `weight` is currently the worst offender, I'll try implementing a custom weight function first.\n\nI'll keep pushing to this ticket, but leave it as `needs info` - in case anything is good to keep.",
    "created_at": "2019-01-15T05:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376857",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:4'></a>Thank you for looking into this!  One question: I realize that the index set does not need to be `[n]` generically, but it does it have to be `[n]` within `spins.py`?  (I think otherwise `ret[i] = 1` shouldn't work, right?)

Since `weight` is currently the worst offender, I'll try implementing a custom weight function first.

I'll keep pushing to this ticket, but leave it as `needs info` - in case anything is good to keep.



---

archive/issue_comments_376858.json:
```json
{
    "body": "<a id='comment:5'></a>Yea, it seems to be that way for `spins.py` (but also for `letters.pyx`, and subsequently all tableaux).",
    "created_at": "2019-01-15T05:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376858",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Yea, it seems to be that way for `spins.py` (but also for `letters.pyx`, and subsequently all tableaux).



---

archive/issue_comments_376859.json:
```json
{
    "body": "<a id='comment:6'></a>#18426 is the ticket concerning a memory leak involving root systems.",
    "created_at": "2019-01-15T06:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376859",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:6'></a>#18426 is the ticket concerning a memory leak involving root systems.



---

archive/issue_comments_376860.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 mantepse]:\n> #25560 is the ticket concerining a memory leak involving root systems.\n\n\n#18426",
    "created_at": "2019-01-15T06:29:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376860",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Replying to [comment:6 mantepse]:
> #25560 is the ticket concerining a memory leak involving root systems.


#18426



---

archive/issue_comments_376861.json:
```json
{
    "body": "<a id='comment:8'></a>Besides, is there a good reason to cache `highest_weight_vectors`?\n\nI am frequently iterating over the highest weight vectors of tensor powers.  In fact, I would prefer it to be an iterator, but that's probably asking for too much.",
    "created_at": "2019-01-15T10:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376861",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:8'></a>Besides, is there a good reason to cache `highest_weight_vectors`?

I am frequently iterating over the highest weight vectors of tensor powers.  In fact, I would prefer it to be an iterator, but that's probably asking for too much.



---

archive/issue_comments_376862.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-15T11:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376862",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_376863.json:
```json
{
    "body": "<a id='comment:10'></a>Caching `Crystals.ParentMethods.weight_lattice_realization` yields an even greater speedup.  But maybe it would be even better if crystal elements would know (and cache) their `weight_lattice_realization`, because then we wouldn't constantly need to redirect via the parent.  Note for example that there is `Crystals.ElementMethods.cartan_type`.  Is there a good reason not to do this?",
    "created_at": "2019-01-15T11:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376863",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:10'></a>Caching `Crystals.ParentMethods.weight_lattice_realization` yields an even greater speedup.  But maybe it would be even better if crystal elements would know (and cache) their `weight_lattice_realization`, because then we wouldn't constantly need to redirect via the parent.  Note for example that there is `Crystals.ElementMethods.cartan_type`.  Is there a good reason not to do this?



---

archive/issue_comments_376864.json:
```json
{
    "body": "<a id='comment:11'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376864",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_events_067207.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:15:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27057#event-67207"
}
```



---

archive/issue_comments_376865.json:
```json
{
    "body": "<a id='comment:12'></a>So I am not fully convinced of the elements having a `cartan_type`, but that is, in a way, data associated to the element. However, the weight lattice realization is definitely not. So I am -1 on caching it in the elements.\n\nHow much of a speedup do you get with caching it? I am probably in favor of caching it, but I would be interested in seeing how performance critical it is first (at least, I do not think computing the weight is the slow part).\n\nWe cache the `highest_weight_vectors` because it is an (relatively) expensive computation that can be used in some other computations. If you make it into an iterator, you loose that part or have to add a second method. Again, if you find it better for your computations, you can just make local changes.\n\nAlso, I think if you really need speed, you should cythonize this. I might be able to do that soon, but it is a little lower on the priority list for me right now.",
    "created_at": "2019-01-19T17:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376865",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>So I am not fully convinced of the elements having a `cartan_type`, but that is, in a way, data associated to the element. However, the weight lattice realization is definitely not. So I am -1 on caching it in the elements.

How much of a speedup do you get with caching it? I am probably in favor of caching it, but I would be interested in seeing how performance critical it is first (at least, I do not think computing the weight is the slow part).

We cache the `highest_weight_vectors` because it is an (relatively) expensive computation that can be used in some other computations. If you make it into an iterator, you loose that part or have to add a second method. Again, if you find it better for your computations, you can just make local changes.

Also, I think if you really need speed, you should cythonize this. I might be able to do that soon, but it is a little lower on the priority list for me right now.



---

archive/issue_comments_376866.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks for looking into this!\n\nI can only answer to your comment on the `highest_weight_vectors` caching: my (very minor) problem is that after computing\n\n```\nsage: C = crystals.Letters(\"A5\")\nsage: T = crystals.TensorProduct(*([C]*14))\nsage: hi = T.highest_weight_vectors()\n# do some stuff\nsage: C = crystals.Letters(\"C5\")\nsage: T = crystals.TensorProduct(*([C]*14))\nsage: hi = T.highest_weight_vectors()\n# do some stuff\nsage: C = crystals.Spins(\"B5\")\nsage: T = crystals.TensorProduct(*([C]*14))\nsage: hi = T.highest_weight_vectors()\n```\nI do not know how to free the memory - and until very recently, I did not understand why my computer became unusable...",
    "created_at": "2019-01-19T18:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376866",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:13'></a>Thanks for looking into this!

I can only answer to your comment on the `highest_weight_vectors` caching: my (very minor) problem is that after computing

```
sage: C = crystals.Letters("A5")
sage: T = crystals.TensorProduct(*([C]*14))
sage: hi = T.highest_weight_vectors()
# do some stuff
sage: C = crystals.Letters("C5")
sage: T = crystals.TensorProduct(*([C]*14))
sage: hi = T.highest_weight_vectors()
# do some stuff
sage: C = crystals.Spins("B5")
sage: T = crystals.TensorProduct(*([C]*14))
sage: hi = T.highest_weight_vectors()
```
I do not know how to free the memory - and until very recently, I did not understand why my computer became unusable...



---

archive/issue_comments_376867.json:
```json
{
    "body": "<a id='comment:14'></a>That is a misrepresenation. It is not the ``@`cached_method` that is the problem. If the memory is not being freed, then there is a memory leak. If so, then my guess is it is a side effect of #18426.",
    "created_at": "2019-01-19T18:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376867",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>That is a misrepresenation. It is not the ``@`cached_method` that is the problem. If the memory is not being freed, then there is a memory leak. If so, then my guess is it is a side effect of #18426.



---

archive/issue_comments_376868.json:
```json
{
    "body": "<a id='comment:15'></a>Are you saying that the highest weight vectors shouldn't take up so much space?\nI just tried\n\n```\nsage: C = crystals.Letters(\"A5\")\nsage: for d in range(2, 14):\n....:     T = crystals.TensorProduct(*([C]*d))\n....:     hi = T.highest_weight_vectors()\n....:     print len(hi)\n```\nafter which, according to htop, a big portion of the available memory on my laptop was used.\n\nIt is not a big problem for me, because I can do such experiments with \"large\" tensor powers (eg., yesterday I had to check something for `crystals.Spins(5)` with `d=16`) in a separate sage process, and not on my laptop.",
    "created_at": "2019-01-19T18:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376868",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:15'></a>Are you saying that the highest weight vectors shouldn't take up so much space?
I just tried

```
sage: C = crystals.Letters("A5")
sage: for d in range(2, 14):
....:     T = crystals.TensorProduct(*([C]*d))
....:     hi = T.highest_weight_vectors()
....:     print len(hi)
```
after which, according to htop, a big portion of the available memory on my laptop was used.

It is not a big problem for me, because I can do such experiments with "large" tensor powers (eg., yesterday I had to check something for `crystals.Spins(5)` with `d=16`) in a separate sage process, and not on my laptop.



---

archive/issue_comments_376869.json:
```json
{
    "body": "<a id='comment:16'></a>No. I am asking you what you observed. Are you seeing a memory leak or is it just high usage in that specific computation?\n\nIt is almost certainly not the caching of the highest weight vectors that is causing the high memory usage. The highest weight vectors requires a certain amount of iteration over the crystal, which is not O(1) in memory (I am not sure of an algorithm that could be). So you might get some memory improvement for your particular computation by storing the list of elements in the crystal (currently I believe it regenerates them for each factor, a by-product of being an iterator).",
    "created_at": "2019-01-19T19:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376869",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>No. I am asking you what you observed. Are you seeing a memory leak or is it just high usage in that specific computation?

It is almost certainly not the caching of the highest weight vectors that is causing the high memory usage. The highest weight vectors requires a certain amount of iteration over the crystal, which is not O(1) in memory (I am not sure of an algorithm that could be). So you might get some memory improvement for your particular computation by storing the list of elements in the crystal (currently I believe it regenerates them for each factor, a by-product of being an iterator).



---

archive/issue_comments_376870.json:
```json
{
    "body": "<a id='comment:17'></a>I don't really understand the question.  I am observing that after the sequence of instructions above the memory of my computer is used up, and it doesn't go down anymore.  \n\nIn numbers:\n\n```\nsage: C = crystals.Letters(\"A5\")\nsage: for d in range(2, 13):\n....:     T = crystals.TensorProduct(*([C]*d))\n....:     hi = T.highest_weight_vectors()\n....:     print get_memory_usage(), len(hi)\n\n4192.42578125 2\n4192.42578125 4\n4192.67578125 10\n4192.67578125 26\n4192.67578125 76\n4192.92578125 231\n4193.17578125 756\n4195.19140625 2556\n4201.953125 9096\n4226.99609375 33231\n4320.625 126060\nsage: \n```",
    "created_at": "2019-01-19T20:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376870",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:17'></a>I don't really understand the question.  I am observing that after the sequence of instructions above the memory of my computer is used up, and it doesn't go down anymore.  

In numbers:

```
sage: C = crystals.Letters("A5")
sage: for d in range(2, 13):
....:     T = crystals.TensorProduct(*([C]*d))
....:     hi = T.highest_weight_vectors()
....:     print get_memory_usage(), len(hi)

4192.42578125 2
4192.42578125 4
4192.67578125 10
4192.67578125 26
4192.67578125 76
4192.92578125 231
4193.17578125 756
4195.19140625 2556
4201.953125 9096
4226.99609375 33231
4320.625 126060
sage: 
```



---

archive/issue_comments_376871.json:
```json
{
    "body": "<a id='comment:18'></a>By doing a cythonization, I get the following:\n\n```\nsage: C = crystals.SpinsMinus(['D',4])\nsage: D = crystals.SpinsPlus(['D',4])\nsage: T = tensor([C,D,C,D,C,D])\nsage: T.cardinality()\n262144\nsage: %time for x in T: pass\nCPU times: user 2.31 s, sys: 5.79 ms, total: 2.31 s\nWall time: 2.29 s\nsage: %time hw = T.highest_weight_vectors()\nCPU times: user 16.6 ms, sys: 135 \u00b5s, total: 16.8 ms\nWall time: 14.5 ms\nsage: %time for x in T: _ = x.weight()\nCPU times: user 32.9 s, sys: 34 ms, total: 33 s\nWall time: 32.9 s\nsage: %time for x in T: _ = x.weight()    # with caching weight_lattice_realization()\nCPU times: user 19.3 s, sys: 23.1 ms, total: 19.3 s\nWall time: 19.3 s\n```\nvs Sage 8.6:\n\n```\nsage: C = crystals.SpinsMinus(['D',4])\nsage: D = crystals.SpinsPlus(['D',4])\nsage: T = tensor([C,D,C,D,C,D])\nsage: T.cardinality()\n262144\nsage: %time for x in T: pass\nCPU times: user 5.21 s, sys: 30.5 ms, total: 5.24 s\nWall time: 5.19 s\nsage: %time hw = T.highest_weight_vectors()\nCPU times: user 93.4 ms, sys: 8.53 ms, total: 102 ms\nWall time: 82.5 ms\nsage: %time for x in T: _ = x.weight()\n> 1 minute\n```\n\nHowever, there is a definite memory leak with the tensor product:\n\n```\nsage: C = crystals.Letters('A5')\nsage: T = tensor([C]*12)\nsage: T._dummy = True\nsage: del T\nsage: import gc\nsage: gc.collect()\nsage: T = tensor([C]*12)\nsage: T._dummy\nTrue\n```\nI get the same when just doing for `C`. So that is one step closer to the memory leak, but that is a separate issue.\n\n---\nNew commits:",
    "created_at": "2019-01-20T01:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376871",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>By doing a cythonization, I get the following:

```
sage: C = crystals.SpinsMinus(['D',4])
sage: D = crystals.SpinsPlus(['D',4])
sage: T = tensor([C,D,C,D,C,D])
sage: T.cardinality()
262144
sage: %time for x in T: pass
CPU times: user 2.31 s, sys: 5.79 ms, total: 2.31 s
Wall time: 2.29 s
sage: %time hw = T.highest_weight_vectors()
CPU times: user 16.6 ms, sys: 135 Âµs, total: 16.8 ms
Wall time: 14.5 ms
sage: %time for x in T: _ = x.weight()
CPU times: user 32.9 s, sys: 34 ms, total: 33 s
Wall time: 32.9 s
sage: %time for x in T: _ = x.weight()    # with caching weight_lattice_realization()
CPU times: user 19.3 s, sys: 23.1 ms, total: 19.3 s
Wall time: 19.3 s
```
vs Sage 8.6:

```
sage: C = crystals.SpinsMinus(['D',4])
sage: D = crystals.SpinsPlus(['D',4])
sage: T = tensor([C,D,C,D,C,D])
sage: T.cardinality()
262144
sage: %time for x in T: pass
CPU times: user 5.21 s, sys: 30.5 ms, total: 5.24 s
Wall time: 5.19 s
sage: %time hw = T.highest_weight_vectors()
CPU times: user 93.4 ms, sys: 8.53 ms, total: 102 ms
Wall time: 82.5 ms
sage: %time for x in T: _ = x.weight()
> 1 minute
```

However, there is a definite memory leak with the tensor product:

```
sage: C = crystals.Letters('A5')
sage: T = tensor([C]*12)
sage: T._dummy = True
sage: del T
sage: import gc
sage: gc.collect()
sage: T = tensor([C]*12)
sage: T._dummy
True
```
I get the same when just doing for `C`. So that is one step closer to the memory leak, but that is a separate issue.

---
New commits:



---

archive/issue_comments_376872.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-01-20T01:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376872",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_376873.json:
```json
{
    "body": "<a id='comment:19'></a>That looks wonderful!\n\nI'll be playing with this until (something like) tomorrow!\n\n1+1/2 immediate questions:\n\n```\nsage: C = crystals.Spins(\"B3\")\nsage: C[0].value\n```\ndoesn't exist anymore.\n\n1) is this intentional, should there be a deprecation?\n2) I used it to identify particular elements of the crystal when it needs to be really fast.  Should I be using something else anyway?\n\nI created #27083 for the memory leak.",
    "created_at": "2019-01-20T11:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376873",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:19'></a>That looks wonderful!

I'll be playing with this until (something like) tomorrow!

1+1/2 immediate questions:

```
sage: C = crystals.Spins("B3")
sage: C[0].value
```
doesn't exist anymore.

1) is this intentional, should there be a deprecation?
2) I used it to identify particular elements of the crystal when it needs to be really fast.  Should I be using something else anyway?

I created #27083 for the memory leak.



---

archive/issue_comments_376874.json:
```json
{
    "body": "<a id='comment:20'></a>1) Yes it is intentional as it has be repurposed as an array of `bint` (booleans), but is only available using Cython code. I can make it public, but it will behave completely differently. For 2), you should be using the normal `==` to compare two crystal elements. It should not really be much slower than comparing by `value` (and any speedup you saw before should now be erased as the internal data structure has changed).\n\nAfter some thought, I think it is best for now to have a `value` ``@`property`. I am not sure about fully deprecating it at this point, but I am leaning towards it. Something else that might be worthwhile is adding a `__getitem__`. Thoughts?",
    "created_at": "2019-01-20T17:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376874",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>1) Yes it is intentional as it has be repurposed as an array of `bint` (booleans), but is only available using Cython code. I can make it public, but it will behave completely differently. For 2), you should be using the normal `==` to compare two crystal elements. It should not really be much slower than comparing by `value` (and any speedup you saw before should now be erased as the internal data structure has changed).

After some thought, I think it is best for now to have a `value` ``@`property`. I am not sure about fully deprecating it at this point, but I am leaning towards it. Something else that might be worthwhile is adding a `__getitem__`. Thoughts?



---

archive/issue_comments_376875.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-20T17:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_376876.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-20T17:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376876",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_376877.json:
```json
{
    "body": "<a id='comment:23'></a>Excellent!  Many thanks!",
    "created_at": "2019-01-23T11:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376877",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:23'></a>Excellent!  Many thanks!



---

archive/issue_comments_376878.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-23T11:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376878",
    "user": "https://github.com/mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_067208.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-26T15:55:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27057#event-67208"
}
```



---

archive/issue_comments_376879.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-26T15:55:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27057",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27057#issuecomment-376879",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
