# Issue 27878: Remove the "-r" option in calling gap in the pexpect interface

archive/issues_027641.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nCurrently the pexpect interface to gap call gap with the \"-r\" option.\nFrom `sage/interfaces/gap.py`\n\n```\ngap_cmd = \"gap -r\"\n```\nThis is a remnant of gap 4.8 and under where it enabled gap to be started in a quieter mode if I am not mistaken. There is no visible effect in starting gap with or without \"-r\" in gap 4.10 and over.\n\n```\nfbissey@moonloop ~ $ gap\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   GAP 4.10.1 of 23-Feb-2019\n \u2502  GAP  \u2502   https://www.gap-system.org\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   Architecture: amd64\n Configuration:  gmp 6.1.2, readline\n Loading the library and packages ...\n Packages:   AClib 1.3.1, Alnuth 3.1.0, AtlasRep 1.5.1, AutoDoc 2019.02.22, AutPGrp 1.10, CRISP 1.4.4, Cryst 4.1.18, CrystCat 1.1.8, CTblLib 1.2.2, FactInt 1.6.2, FGA 1.4.0, \n             GAPDoc 1.6.2, IO 4.5.4, IRREDSOL 1.4, LAGUNA 3.9.2, Polenta 1.3.8, Polycyclic 2.14, PrimGrp 3.3.2, RadiRoot 2.8, ResClasses 4.7.1, SmallGrp 1.3, Sophus 1.24, \n             TomLib 1.2.7, TransGrp 2.0.4, utils 0.61\n Try '??help' for help. See also '?copyright', '?cite' and '?authors'\ngap> \nfbissey@moonloop ~ $ gap -r\n \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   GAP 4.10.1 of 23-Feb-2019\n \u2502  GAP  \u2502   https://www.gap-system.org\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   Architecture: amd64\n Configuration:  gmp 6.1.2, readline\n Loading the library and packages ...\n Packages:   AClib 1.3.1, Alnuth 3.1.0, AtlasRep 1.5.1, AutoDoc 2019.02.22, AutPGrp 1.10, CRISP 1.4.4, Cryst 4.1.18, CrystCat 1.1.8, CTblLib 1.2.2, FactInt 1.6.2, FGA 1.4.0, \n             GAPDoc 1.6.2, IO 4.5.4, IRREDSOL 1.4, LAGUNA 3.9.2, Polenta 1.3.8, Polycyclic 2.14, PrimGrp 3.3.2, RadiRoot 2.8, ResClasses 4.7.1, SmallGrp 1.3, Sophus 1.24, \n             TomLib 1.2.7, TransGrp 2.0.4, utils 0.61\n Try '??help' for help. See also '?copyright', '?cite' and '?authors'\ngap> \n```\nThe only effect is more subtle. `~/.gap` and its equivalent on non linux system is not added to the list of paths where gap looks for packages. This means in turn that the option `ignore_dot_gap` in the function `all_installed_packages` (in `sage/tests/gap_packages.py`) is meaningless when a pexpect gap instance is selected. And a doctest introduced in #27681 will fail if you have something in `~/.gap`. \n\nComponent: **interfaces**\n\nAuthor: **Fran\u00e7ois Bissey**\n\nBranch/Commit: **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r) @ [`474b365`](https://github.com/sagemath/sagetrac-mirror/commit/474b3657371e9334cbdafbbdf6763a032c89a9f2)**\n\nReviewer: **Steven Trogdon**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27878_\n\n",
    "created_at": "2019-05-27T23:59:56Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/pending",
        "https://github.com/sagemath/sage/labels/needs%20info"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Remove the \"-r\" option in calling gap in the pexpect interface",
    "type": "issue",
    "updated_at": "2019-12-23T11:29:31Z",
    "url": "https://github.com/sagemath/sage/issues/27878",
    "user": "https://github.com/kiwifb"
}
```
<div id="comment:0"></div>

Currently the pexpect interface to gap call gap with the "-r" option.
From `sage/interfaces/gap.py`

```
gap_cmd = "gap -r"
```
This is a remnant of gap 4.8 and under where it enabled gap to be started in a quieter mode if I am not mistaken. There is no visible effect in starting gap with or without "-r" in gap 4.10 and over.

```
fbissey@moonloop ~ $ gap
 ┌───────┐   GAP 4.10.1 of 23-Feb-2019
 │  GAP  │   https://www.gap-system.org
 └───────┘   Architecture: amd64
 Configuration:  gmp 6.1.2, readline
 Loading the library and packages ...
 Packages:   AClib 1.3.1, Alnuth 3.1.0, AtlasRep 1.5.1, AutoDoc 2019.02.22, AutPGrp 1.10, CRISP 1.4.4, Cryst 4.1.18, CrystCat 1.1.8, CTblLib 1.2.2, FactInt 1.6.2, FGA 1.4.0, 
             GAPDoc 1.6.2, IO 4.5.4, IRREDSOL 1.4, LAGUNA 3.9.2, Polenta 1.3.8, Polycyclic 2.14, PrimGrp 3.3.2, RadiRoot 2.8, ResClasses 4.7.1, SmallGrp 1.3, Sophus 1.24, 
             TomLib 1.2.7, TransGrp 2.0.4, utils 0.61
 Try '??help' for help. See also '?copyright', '?cite' and '?authors'
gap> 
fbissey@moonloop ~ $ gap -r
 ┌───────┐   GAP 4.10.1 of 23-Feb-2019
 │  GAP  │   https://www.gap-system.org
 └───────┘   Architecture: amd64
 Configuration:  gmp 6.1.2, readline
 Loading the library and packages ...
 Packages:   AClib 1.3.1, Alnuth 3.1.0, AtlasRep 1.5.1, AutoDoc 2019.02.22, AutPGrp 1.10, CRISP 1.4.4, Cryst 4.1.18, CrystCat 1.1.8, CTblLib 1.2.2, FactInt 1.6.2, FGA 1.4.0, 
             GAPDoc 1.6.2, IO 4.5.4, IRREDSOL 1.4, LAGUNA 3.9.2, Polenta 1.3.8, Polycyclic 2.14, PrimGrp 3.3.2, RadiRoot 2.8, ResClasses 4.7.1, SmallGrp 1.3, Sophus 1.24, 
             TomLib 1.2.7, TransGrp 2.0.4, utils 0.61
 Try '??help' for help. See also '?copyright', '?cite' and '?authors'
gap> 
```
The only effect is more subtle. `~/.gap` and its equivalent on non linux system is not added to the list of paths where gap looks for packages. This means in turn that the option `ignore_dot_gap` in the function `all_installed_packages` (in `sage/tests/gap_packages.py`) is meaningless when a pexpect gap instance is selected. And a doctest introduced in #27681 will fail if you have something in `~/.gap`. 

Component: **interfaces**

Author: **François Bissey**

Branch/Commit: **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r) @ [`474b365`](https://github.com/sagemath/sagetrac-mirror/commit/474b3657371e9334cbdafbbdf6763a032c89a9f2)**

Reviewer: **Steven Trogdon**

_Issue created by migration from https://trac.sagemath.org/ticket/27878_





---

archive/issue_events_379420.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-05-27T23:59:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379420"
}
```



---

archive/issue_events_379421.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-05-27T23:59:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379421"
}
```



---

archive/issue_events_379422.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-05-27T23:59:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379422"
}
```



---

archive/issue_events_379423.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-05-27T23:59:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379423"
}
```



---

archive/issue_comments_433021.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -30,4 +30,4 @@\n  Try '??help' for help. See also '?copyright', '?cite' and '?authors'\n gap> \n ```\n-The only effect is more subtle. `~/.gap` and its equivalent on non linux system is not added to the list of paths where gap looks for packages. This means in turn that the option `ignore_dot_gap` in the function `all_installed_packages` is meaningless when a pexpect gap instance is selected. And a doctest introduced in #27681 will fail if you have something in `~/.gap`. \n+The only effect is more subtle. `~/.gap` and its equivalent on non linux system is not added to the list of paths where gap looks for packages. This means in turn that the option `ignore_dot_gap` in the function `all_installed_packages` (in `sage/tests/gap_packages.py`) is meaningless when a pexpect gap instance is selected. And a doctest introduced in #27681 will fail if you have something in `~/.gap`. \n``````\n",
    "created_at": "2019-05-28T00:01:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433021",
    "user": "https://github.com/kiwifb"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -30,4 +30,4 @@
  Try '??help' for help. See also '?copyright', '?cite' and '?authors'
 gap> 
 ```
-The only effect is more subtle. `~/.gap` and its equivalent on non linux system is not added to the list of paths where gap looks for packages. This means in turn that the option `ignore_dot_gap` in the function `all_installed_packages` is meaningless when a pexpect gap instance is selected. And a doctest introduced in #27681 will fail if you have something in `~/.gap`. 
+The only effect is more subtle. `~/.gap` and its equivalent on non linux system is not added to the list of paths where gap looks for packages. This means in turn that the option `ignore_dot_gap` in the function `all_installed_packages` (in `sage/tests/gap_packages.py`) is meaningless when a pexpect gap instance is selected. And a doctest introduced in #27681 will fail if you have something in `~/.gap`. 
``````




---

archive/issue_comments_433022.json:
```json
{
    "body": "Commit: **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)**",
    "created_at": "2019-05-28T01:11:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433022",
    "user": "https://github.com/kiwifb"
}
```

Commit: **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)**



---

archive/issue_events_379424.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-05-28T01:11:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379424"
}
```



---

archive/issue_comments_433023.json:
```json
{
    "body": "Branch: **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r)**",
    "created_at": "2019-05-28T01:11:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433023",
    "user": "https://github.com/kiwifb"
}
```

Branch: **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r)**



---

archive/issue_comments_433024.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nTrivial change.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca\"><code>8958e4d</code></a></td><td><code>remove extraneous -r from gap_cmd</code></td></tr></table>\n",
    "created_at": "2019-05-28T01:11:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433024",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:2" align="right">comment:2</div>

Trivial change.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca"><code>8958e4d</code></a></td><td><code>remove extraneous -r from gap_cmd</code></td></tr></table>




---

archive/issue_comments_433025.json:
```json
{
    "body": "Author: **Fran\u00e7ois Bissey**",
    "created_at": "2019-05-28T01:11:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433025",
    "user": "https://github.com/kiwifb"
}
```

Author: **François Bissey**



---

archive/issue_comments_433026.json:
```json
{
    "body": "Reviewer: **Steven Trogdon**",
    "created_at": "2019-05-28T04:09:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433026",
    "user": "https://github.com/strogdon"
}
```

Reviewer: **Steven Trogdon**



---

archive/issue_comments_433027.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nHere I have\n\n```\n$ ls -R ~/.gap\n/home/volj/27/strogdon/.gap:\npkg\n\n/home/volj/27/strogdon/.gap/pkg:\nAtlasRep\n\n/home/volj/27/strogdon/.gap/pkg/AtlasRep:\ndatagens  dataword\n\n/home/volj/27/strogdon/.gap/pkg/AtlasRep/datagens:\n\n/home/volj/27/strogdon/.gap/pkg/AtlasRep/dataword:\n```\n\nThe doctest `./sage -t --long src/sage/tests/gap_packages.py`, with this branch, passes which would fail without the fix.\n\nHopefully the positive review will prompt someone to notice if there is any side effect.",
    "created_at": "2019-05-28T04:09:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433027",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:3" align="right">comment:3</div>

Here I have

```
$ ls -R ~/.gap
/home/volj/27/strogdon/.gap:
pkg

/home/volj/27/strogdon/.gap/pkg:
AtlasRep

/home/volj/27/strogdon/.gap/pkg/AtlasRep:
datagens  dataword

/home/volj/27/strogdon/.gap/pkg/AtlasRep/datagens:

/home/volj/27/strogdon/.gap/pkg/AtlasRep/dataword:
```

The doctest `./sage -t --long src/sage/tests/gap_packages.py`, with this branch, passes which would fail without the fix.

Hopefully the positive review will prompt someone to notice if there is any side effect.



---

archive/issue_events_379425.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2019-05-28T04:09:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379425"
}
```



---

archive/issue_events_379426.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2019-05-28T04:09:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379426"
}
```



---

archive/issue_comments_433028.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\n\n```\n$ gap -h\n...\n -r                           disable/enable user GAP root dir\n                              GAPInfo.UserGapRoot\n```\nalso\n\n```\n  The  root  directories  are  specified via one or several of the -l paths command line options, see 3.1. Furthermore, by default GAP automatically prepends a user\n  specific GAP root directory to the list; this can be avoided by calling GAP with the -r option. The name of this user specific directory depends on your operating\n  system, it can be found in GAPInfo.UserGapRoot. This directory can be used to tell GAP about personal preferences, to always load some additional code, to install\n  additional packages, or to overwrite some GAP files. See 3.2 for more information how to do this.\n```",
    "created_at": "2019-05-28T09:09:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433028",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:4" align="right">comment:4</div>


```
$ gap -h
...
 -r                           disable/enable user GAP root dir
                              GAPInfo.UserGapRoot
```
also

```
  The  root  directories  are  specified via one or several of the -l paths command line options, see 3.1. Furthermore, by default GAP automatically prepends a user
  specific GAP root directory to the list; this can be avoided by calling GAP with the -r option. The name of this user specific directory depends on your operating
  system, it can be found in GAPInfo.UserGapRoot. This directory can be used to tell GAP about personal preferences, to always load some additional code, to install
  additional packages, or to overwrite some GAP files. See 3.2 for more information how to do this.
```



---

archive/issue_comments_433029.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI don't quite understand the intention behind this change.  When using the pexpect interface to GAP, which much of Sage still (sadly) relies on (I am making progress fixing that) we *want* the `-r` flag because we *don't* want random stuff a user might have in their `~/.gap` interfering with Sage functionality.",
    "created_at": "2019-05-31T15:41:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433029",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

I don't quite understand the intention behind this change.  When using the pexpect interface to GAP, which much of Sage still (sadly) relies on (I am making progress fixing that) we *want* the `-r` flag because we *don't* want random stuff a user might have in their `~/.gap` interfering with Sage functionality.



---

archive/issue_events_379427.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-31T15:41:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379427"
}
```



---

archive/issue_events_379428.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-31T15:41:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379428"
}
```



---

archive/issue_comments_433030.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nISTM the problem is not that we pass `-r` in the pexpect interface, but that we *aren't* passing `-r` to the libgap interface.",
    "created_at": "2019-05-31T15:48:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433030",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

ISTM the problem is not that we pass `-r` in the pexpect interface, but that we *aren't* passing `-r` to the libgap interface.



---

archive/issue_comments_433031.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nMy problem with putting `-r` is that we are removing some capabilities from `gap`. Of course for other packages where the user can make changes the custom space is moved, usually by environment variables, to `.sage`. And we aren't quite able to do that with gap. Anyway the big concern is for protect the user from themselves and limit our debugging. I am not in favor of protecting the user from themselves to that degree, but we should have a way to a safe mode for debugging..",
    "created_at": "2019-05-31T19:58:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433031",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:7" align="right">comment:7</div>

My problem with putting `-r` is that we are removing some capabilities from `gap`. Of course for other packages where the user can make changes the custom space is moved, usually by environment variables, to `.sage`. And we aren't quite able to do that with gap. Anyway the big concern is for protect the user from themselves and limit our debugging. I am not in favor of protecting the user from themselves to that degree, but we should have a way to a safe mode for debugging..



---

archive/issue_comments_433032.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIndeed, as a user, I would be annoyed if I could not use from Sage the GAP packages I installed in my gap directory (e.g. by GAP's PackageManager). The GAP devs have decided to include the user's .gap directory by default; I would tend to follow that decision to have a GAP that's as close as possible from a normal gap.\n\nThat being said, maybe we should indeed set -r whenever running Sage's test, to make them less context-dependent? With the annoying side effect that behavior may change between tests and normal usage.",
    "created_at": "2019-06-01T05:05:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433032",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:8" align="right">comment:8</div>

Indeed, as a user, I would be annoyed if I could not use from Sage the GAP packages I installed in my gap directory (e.g. by GAP's PackageManager). The GAP devs have decided to include the user's .gap directory by default; I would tend to follow that decision to have a GAP that's as close as possible from a normal gap.

That being said, maybe we should indeed set -r whenever running Sage's test, to make them less context-dependent? With the annoying side effect that behavior may change between tests and normal usage.



---

archive/issue_events_379429.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-02T22:04:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379429"
}
```



---

archive/issue_events_379430.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-02T22:04:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379430"
}
```



---

archive/issue_comments_433033.json:
```json
{
    "body": "Changed branch from **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r)** to **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)**",
    "created_at": "2019-06-02T22:04:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433033",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r)** to **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)**



---

archive/issue_events_379431.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-02T22:05:27Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379431"
}
```



---

archive/issue_comments_433034.json:
```json
{
    "body": "Changed commit from **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)** to none",
    "created_at": "2019-06-02T22:05:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433034",
    "user": "https://github.com/vbraun"
}
```

Changed commit from **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)** to none



---

archive/issue_events_379432.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-02T22:05:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379432"
}
```



---

archive/issue_comments_433035.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAs I wrote on the other ticket (#27913):\n\n> I believe the opposite should be the case: By default the GAP interfaces in Sage should ignore a user .gap because it could potentially interfere with the functionality of Sage itself.\n\nThe problem is there is a tension here between Sage embedding GAP for its own uses, and users of Sage wanting to use GAP from within Sage and have it work the same as if they used GAP directly.\n\nI think for the latter case, users should initialize their own GAP via the pexpect interface, and perhaps we should change things so that it's not necessarily the same GAP that Sage is using internally.\n\nIn the latter case I've also made very good progress getting the pexpect interface out of Sage's internal use cases (in this case for permutation groups) and porting it to libgap.  I'll have some tickets for that soon; I've just been very otherwise occupied.",
    "created_at": "2019-06-03T06:30:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433035",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

As I wrote on the other ticket (#27913):

> I believe the opposite should be the case: By default the GAP interfaces in Sage should ignore a user .gap because it could potentially interfere with the functionality of Sage itself.

The problem is there is a tension here between Sage embedding GAP for its own uses, and users of Sage wanting to use GAP from within Sage and have it work the same as if they used GAP directly.

I think for the latter case, users should initialize their own GAP via the pexpect interface, and perhaps we should change things so that it's not necessarily the same GAP that Sage is using internally.

In the latter case I've also made very good progress getting the pexpect interface out of Sage's internal use cases (in this case for permutation groups) and porting it to libgap.  I'll have some tickets for that soon; I've just been very otherwise occupied.



---

archive/issue_comments_433036.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIn any case, while this clearly needs to be discussed further the right answer is definitely *not* to just disable use of `-r` completely, as that is only likely to break more things when testing.\n\nI agree with nthiery that one way or other ignoring the user's `.gap` should *definitely* be the default when running the test suite.  The rest is debatable.",
    "created_at": "2019-06-03T06:32:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433036",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

In any case, while this clearly needs to be discussed further the right answer is definitely *not* to just disable use of `-r` completely, as that is only likely to break more things when testing.

I agree with nthiery that one way or other ignoring the user's `.gap` should *definitely* be the default when running the test suite.  The rest is debatable.



---

archive/issue_comments_433037.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI used the occasion of being in St Andrews to discuss the matter with GAP developers (namely Alex Konovolov and Michael Torpey). When running GAP tests, they disable the `.gap` directory with  `-r` and suggest, as we discussed, to do the same in Sage. Otherwise, they recommend to not set the option `-r` by default. Here is their rationale:\n\n- Principle of less surprise: keep GAP in Sage as similar as possible to GAP outside of Sage.\n\n- People that have a .gap directory most certainly know about GAP. They will that much expect a given behavior, while being more capable of tracking issues.\n\n- Without `-r`, GAP's package manager becomes harder to use, since its default is to install in `.gap`.\n\n- About the risk of personal GAP packages breaking Sage pieces that depend on GAP. This is not intrinsically different from GAP: they also have packages depending on packages; packages in .gap could potentially break them as well. In practice, this risk has not materialized enough to question their default choice for `-r` in GAP.\n\n- About potential binary incompatiblities between packages installed for Sage's GAP and another GAP: this is no different than for two simultaneous installations of GAP. They have partial support for multi arch / multi version installations, and will push further in this direction, notably in the package manager (our discussion made for one more motivation point for theim).\n\nCheers,",
    "created_at": "2019-06-03T22:53:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433037",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:14" align="right">comment:14</div>

I used the occasion of being in St Andrews to discuss the matter with GAP developers (namely Alex Konovolov and Michael Torpey). When running GAP tests, they disable the `.gap` directory with  `-r` and suggest, as we discussed, to do the same in Sage. Otherwise, they recommend to not set the option `-r` by default. Here is their rationale:

- Principle of less surprise: keep GAP in Sage as similar as possible to GAP outside of Sage.

- People that have a .gap directory most certainly know about GAP. They will that much expect a given behavior, while being more capable of tracking issues.

- Without `-r`, GAP's package manager becomes harder to use, since its default is to install in `.gap`.

- About the risk of personal GAP packages breaking Sage pieces that depend on GAP. This is not intrinsically different from GAP: they also have packages depending on packages; packages in .gap could potentially break them as well. In practice, this risk has not materialized enough to question their default choice for `-r` in GAP.

- About potential binary incompatiblities between packages installed for Sage's GAP and another GAP: this is no different than for two simultaneous installations of GAP. They have partial support for multi arch / multi version installations, and will push further in this direction, notably in the package manager (our discussion made for one more motivation point for theim).

Cheers,



---

archive/issue_comments_433038.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nWe may want to have an option to inject `-r` for diagnostics. Which to my mind is one of its use. It gives you a rescue mode. If things works once you enter that mode then you know you messed up your `.gap` folder.\n\ngap is behaving a bit differently than say `R` where you have to explicitly load packages rather than them being loaded, mostly, on presence. This is more of a question for upstream I guess.",
    "created_at": "2019-06-03T22:59:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433038",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:15" align="right">comment:15</div>

We may want to have an option to inject `-r` for diagnostics. Which to my mind is one of its use. It gives you a rescue mode. If things works once you enter that mode then you know you messed up your `.gap` folder.

gap is behaving a bit differently than say `R` where you have to explicitly load packages rather than them being loaded, mostly, on presence. This is more of a question for upstream I guess.



---

archive/issue_comments_433039.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@kiwifb](#comment%3A15):\n> We may want to have an option to inject `-r` for diagnostics. Which to my mind is one of its use. It gives you a rescue mode. If things works once you enter that mode then you know you messed up your `.gap` folder.\n\nIndeed! I forgot to mention that the GAP dev recommended that too.\n\n> gap is behaving a bit differently than say `R` where you have to explicitly load packages rather than them being loaded, mostly, on presence. This is more of a question for upstream I guess.\n\nGood point. Same for Python packages: nothing happens until you explicitly import them. I'll chat with Michael Torpey tomorrow about when GAP packages installed with `PackageManager` shall be autoloaded or not.",
    "created_at": "2019-06-03T23:28:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433039",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@kiwifb](#comment%3A15):
> We may want to have an option to inject `-r` for diagnostics. Which to my mind is one of its use. It gives you a rescue mode. If things works once you enter that mode then you know you messed up your `.gap` folder.

Indeed! I forgot to mention that the GAP dev recommended that too.

> gap is behaving a bit differently than say `R` where you have to explicitly load packages rather than them being loaded, mostly, on presence. This is more of a question for upstream I guess.

Good point. Same for Python packages: nothing happens until you explicitly import them. I'll chat with Michael Torpey tomorrow about when GAP packages installed with `PackageManager` shall be autoloaded or not.



---

archive/issue_comments_433040.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nFeedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.",
    "created_at": "2019-06-04T19:45:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433040",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:17" align="right">comment:17</div>

Feedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.



---

archive/issue_comments_433041.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThat's nice. So it we can expect things to settle down slowly on that front. We just have to bear it for a little while. So now we need a mechanism to insert `-r` on request. There is already some mechanism for some other options I think, so it should just be modeled on them.",
    "created_at": "2019-06-04T20:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433041",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:18" align="right">comment:18</div>

That's nice. So it we can expect things to settle down slowly on that front. We just have to bear it for a little while. So now we need a mechanism to insert `-r` on request. There is already some mechanism for some other options I think, so it should just be modeled on them.



---

archive/issue_comments_433042.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nOK wanting some feedback on this. So I still make the default to be run without `-r` but I introduce an option `no_dotgap` which default to `False` to enable it. I also fixed the doctest that triggered the issue in the first place so that `~/.gap` is always ignored in that test.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca\"><code>8958e4d</code></a></td><td><code>remove extraneous -r from gap_cmd</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cab2211040528270ec93f3505fdfbb920fcda76f\"><code>cab2211</code></a></td><td><code>Add an option to restore -r and document it</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/474b3657371e9334cbdafbbdf6763a032c89a9f2\"><code>474b365</code></a></td><td><code>Make the all_installed_package test ignore .gap content.</code></td></tr></table>\n",
    "created_at": "2019-06-04T23:54:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433042",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:19" align="right">comment:19</div>

OK wanting some feedback on this. So I still make the default to be run without `-r` but I introduce an option `no_dotgap` which default to `False` to enable it. I also fixed the doctest that triggered the issue in the first place so that `~/.gap` is always ignored in that test.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca"><code>8958e4d</code></a></td><td><code>remove extraneous -r from gap_cmd</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cab2211040528270ec93f3505fdfbb920fcda76f"><code>cab2211</code></a></td><td><code>Add an option to restore -r and document it</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/474b3657371e9334cbdafbbdf6763a032c89a9f2"><code>474b365</code></a></td><td><code>Make the all_installed_package test ignore .gap content.</code></td></tr></table>




---

archive/issue_comments_433043.json:
```json
{
    "body": "Changed branch from **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)** to **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r)**",
    "created_at": "2019-06-04T23:54:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433043",
    "user": "https://github.com/kiwifb"
}
```

Changed branch from **[`8958e4d`](https://github.com/sagemath/sagetrac-mirror/commit/8958e4dcc53243d2702615482c30c82400a6b5ca)** to **[u/fbissey/gap_r](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gap_r)**



---

archive/issue_comments_433044.json:
```json
{
    "body": "Commit: **[`474b365`](https://github.com/sagemath/sagetrac-mirror/commit/474b3657371e9334cbdafbbdf6763a032c89a9f2)**",
    "created_at": "2019-06-04T23:54:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433044",
    "user": "https://github.com/kiwifb"
}
```

Commit: **[`474b365`](https://github.com/sagemath/sagetrac-mirror/commit/474b3657371e9334cbdafbbdf6763a032c89a9f2)**



---

archive/issue_comments_433045.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThanks Fran\u00e7ois! This sounds very reasonable to me. There remains to force `-r` whenever running doctests, as discussed above.\n\nFor the option configuration, I am hesitating between two approaches. With the current commits, \nwe abstract away from the user the specifics of how to tell gap to ignore `.gap`. This has some merit.\n\nAn alternative would be to provide a mean for the user to configure the arguments to the gap command; something like `gap_options = '-r', '-t', ...`. And to put in the documentation an example: \"if you want GAP to ignore the .gap directory, you can use its `-r` option\". This has the merit of being more flexible, and to empower GAP users that may already know of this option or others.\n\nWhat do you think?",
    "created_at": "2019-06-05T08:05:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433045",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:20" align="right">comment:20</div>

Thanks François! This sounds very reasonable to me. There remains to force `-r` whenever running doctests, as discussed above.

For the option configuration, I am hesitating between two approaches. With the current commits, 
we abstract away from the user the specifics of how to tell gap to ignore `.gap`. This has some merit.

An alternative would be to provide a mean for the user to configure the arguments to the gap command; something like `gap_options = '-r', '-t', ...`. And to put in the documentation an example: "if you want GAP to ignore the .gap directory, you can use its `-r` option". This has the merit of being more flexible, and to empower GAP users that may already know of this option or others.

What do you think?



---

archive/issue_comments_433046.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI am not sure. First we are only talking about the pexpect interface in this ticket, Erik already mentioned there is currently no way to force libgap to ignore `~/.gap`. In the pexpect interface we already feed gap many options to get exactly what we want and a quiet interface - I was looking at the code in details earlier today. So dabbling with options is really reserved to people who know what they are doing.\n\nLastly, I introduced an option because this is something we want to have some programmatic control over. But it could have been achieved some different way. The documentation just over the one I introduced for `no_dotgap` reads\n\n```\nUse this code to change which GAP interpreter is run. E.g.,\n::\n       import sage.interfaces.gap\n       sage.interfaces.gap.gap_cmd = \"/usr/local/bin/gap\"\n```\nThis could be used to pass any options to gap\n\n```\nsage.interfaces.gap.gap_cmd = \"gap -r -X -Y -myweirdoption\"\n```\nrather than a gap in a different path.",
    "created_at": "2019-06-05T08:24:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433046",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:21" align="right">comment:21</div>

I am not sure. First we are only talking about the pexpect interface in this ticket, Erik already mentioned there is currently no way to force libgap to ignore `~/.gap`. In the pexpect interface we already feed gap many options to get exactly what we want and a quiet interface - I was looking at the code in details earlier today. So dabbling with options is really reserved to people who know what they are doing.

Lastly, I introduced an option because this is something we want to have some programmatic control over. But it could have been achieved some different way. The documentation just over the one I introduced for `no_dotgap` reads

```
Use this code to change which GAP interpreter is run. E.g.,
::
       import sage.interfaces.gap
       sage.interfaces.gap.gap_cmd = "/usr/local/bin/gap"
```
This could be used to pass any options to gap

```
sage.interfaces.gap.gap_cmd = "gap -r -X -Y -myweirdoption"
```
rather than a gap in a different path.



---

archive/issue_comments_433047.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\n> Principle of less surprise: keep GAP in Sage as similar as possible to GAP outside of Sage.\n\nYou have to be clear here what you mean by \"GAP in Sage\".  The GAP interpreter included in the Sage distribution should work as similarly as possibly to a GAP distributed by the GAP project.  I.e. when you run `gap` directly (I'll call this case A).\n\nThen there's the use of GAP within the Sage library itself which as I've mentioned has competing use-cases:  the GAP interface in Sage used directly by users as an interface to GAP without leaving the Sage interpreter (B), and then there's GAP used directly by Sage for internal use (C).\n\nThis principle applies to A and B, but emphatically *not* for C (even if there are ostensibly benefits to doing so, such as packages that provide alternative implementations of some algorithms that happen to be used by Sage; if that capability exists it should be enabled explicitly through Sage).\n\nI think that the `gap` global made available to users in Sage should not be the same as that used internally by Sage.  I think a lot of problems like this can be resolved cleanly by not crossing these use-cases where it isn't necessary to.",
    "created_at": "2019-06-07T08:58:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433047",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

> Principle of less surprise: keep GAP in Sage as similar as possible to GAP outside of Sage.

You have to be clear here what you mean by "GAP in Sage".  The GAP interpreter included in the Sage distribution should work as similarly as possibly to a GAP distributed by the GAP project.  I.e. when you run `gap` directly (I'll call this case A).

Then there's the use of GAP within the Sage library itself which as I've mentioned has competing use-cases:  the GAP interface in Sage used directly by users as an interface to GAP without leaving the Sage interpreter (B), and then there's GAP used directly by Sage for internal use (C).

This principle applies to A and B, but emphatically *not* for C (even if there are ostensibly benefits to doing so, such as packages that provide alternative implementations of some algorithms that happen to be used by Sage; if that capability exists it should be enabled explicitly through Sage).

I think that the `gap` global made available to users in Sage should not be the same as that used internally by Sage.  I think a lot of problems like this can be resolved cleanly by not crossing these use-cases where it isn't necessary to.



---

archive/issue_comments_433048.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nIf I had my way I would also be more aggressive about controlling exactly what GAP packages are loaded by the GAP interpreter used by Sage, because my experience has been that random GAP packages being loaded can lead to *very* difficult to trace bugs or differences in results.",
    "created_at": "2019-06-07T09:00:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433048",
    "user": "https://github.com/embray"
}
```

<div id="comment:23" align="right">comment:23</div>

If I had my way I would also be more aggressive about controlling exactly what GAP packages are loaded by the GAP interpreter used by Sage, because my experience has been that random GAP packages being loaded can lead to *very* difficult to trace bugs or differences in results.



---

archive/issue_comments_433049.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@nthiery](#comment%3A17):\n> Feedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.\n\nYep--in particular autoloading of the xgap package has been a real problem for Sage's pexpect interface.",
    "created_at": "2019-06-07T09:03:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433049",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@nthiery](#comment%3A17):
> Feedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.

Yep--in particular autoloading of the xgap package has been a real problem for Sage's pexpect interface.



---

archive/issue_comments_433050.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\n\n```diff\ndiff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py\nindex a7a9fab..43c957b 100644\n--- a/src/sage/interfaces/gap.py\n+++ b/src/sage/interfaces/gap.py\n@@ -150,6 +150,12 @@ Use this code to change which GAP interpreter is run. E.g.,\n        import sage.interfaces.gap\n        sage.interfaces.gap.gap_cmd = \"/usr/local/bin/gap\"\n \n+Disabling the use of ~/.gap - no personal packages or settings used.\n+\n+::\n+       import sage.interfaces.gap\n+       sage.interfaces.gap.no_dotgap = True\n+\n```\n\nI might be missing something (or maybe this is only a proposal?) but this doesn't look right.\n\nThe instructions above would only create a global variable `no_dotgap` in the `sage.interfaces.gap` module, which isn't used.  Instead, one would call something like:\n\n```\nsage: g = Gap(no_dotgap=True)\n```\n\nto initialize a GAP interface with that option set.\n\nI'm also not sure about the name `no_dotgap`.  I've been trying (and sometimes it's hard) to avoid predicates with a negative proposition, which leads to confusing double-negatives (`no_dotgap=False` to *enable* the `.gap` directory).  I would instead call it something like `enable_dotgap=True` (and enable it by default).  Therefore any `Gap()` initialized by a user *would* use `.gap` which I absolutely agree is the desirable *default* behavior.\n\nOnly the GAP interface used internally for Sage would set `enable_dotgap=False`).\n\nFor libgap we're in a bit of a bind, but I *think* that the most important use case for the libgap interface in Sage is for interfacing with GAP internally (to replace the pexpect interface as much as possible), so this should disable .gap by default.",
    "created_at": "2019-06-07T09:12:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433050",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">comment:25</div>


```diff
diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py
index a7a9fab..43c957b 100644
--- a/src/sage/interfaces/gap.py
+++ b/src/sage/interfaces/gap.py
@@ -150,6 +150,12 @@ Use this code to change which GAP interpreter is run. E.g.,
        import sage.interfaces.gap
        sage.interfaces.gap.gap_cmd = "/usr/local/bin/gap"
 
+Disabling the use of ~/.gap - no personal packages or settings used.
+
+::
+       import sage.interfaces.gap
+       sage.interfaces.gap.no_dotgap = True
+
```

I might be missing something (or maybe this is only a proposal?) but this doesn't look right.

The instructions above would only create a global variable `no_dotgap` in the `sage.interfaces.gap` module, which isn't used.  Instead, one would call something like:

```
sage: g = Gap(no_dotgap=True)
```

to initialize a GAP interface with that option set.

I'm also not sure about the name `no_dotgap`.  I've been trying (and sometimes it's hard) to avoid predicates with a negative proposition, which leads to confusing double-negatives (`no_dotgap=False` to *enable* the `.gap` directory).  I would instead call it something like `enable_dotgap=True` (and enable it by default).  Therefore any `Gap()` initialized by a user *would* use `.gap` which I absolutely agree is the desirable *default* behavior.

Only the GAP interface used internally for Sage would set `enable_dotgap=False`).

For libgap we're in a bit of a bind, but I *think* that the most important use case for the libgap interface in Sage is for interfacing with GAP internally (to replace the pexpect interface as much as possible), so this should disable .gap by default.



---

archive/issue_comments_433051.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@embray](#comment%3A24):\n> Replying to [@nthiery](#comment%3A17):\n> > Feedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.\n> \n> \n> Yep--in particular autoloading of the xgap package has been a real problem for Sage's pexpect interface.\n\nNow that's a painful flashback from before you started being involved with sage Erik. It took me a while to figure out what was happening to my sage-on-gentoo install where I had installed the whole gap distribution.\n\nI'll concede that your point (C) sounds reasonable but has the after taste of the package you customise specifically for sage (or some other software). \n\nOff course we want to move all of the use of point (C) to libgap I would imagine , which leaves the pexpect interface at your point (B). But having upstream giving you the tools to get to (C) would be nice.\n\nI'll note that gap packages have the concept of recommended packages. Those are not dependencies but considered helpful but automatically loaded on presence which is harmful in our case (xgap is recommended in several packages).",
    "created_at": "2019-06-07T09:13:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433051",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@embray](#comment%3A24):
> Replying to [@nthiery](#comment%3A17):
> > Feedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.
> 
> 
> Yep--in particular autoloading of the xgap package has been a real problem for Sage's pexpect interface.

Now that's a painful flashback from before you started being involved with sage Erik. It took me a while to figure out what was happening to my sage-on-gentoo install where I had installed the whole gap distribution.

I'll concede that your point (C) sounds reasonable but has the after taste of the package you customise specifically for sage (or some other software). 

Off course we want to move all of the use of point (C) to libgap I would imagine , which leaves the pexpect interface at your point (B). But having upstream giving you the tools to get to (C) would be nice.

I'll note that gap packages have the concept of recommended packages. Those are not dependencies but considered helpful but automatically loaded on presence which is harmful in our case (xgap is recommended in several packages).



---

archive/issue_comments_433052.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@embray](#comment%3A25):\n> \n> ```diff\n> diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py\n> index a7a9fab..43c957b 100644\n> --- a/src/sage/interfaces/gap.py\n> +++ b/src/sage/interfaces/gap.py\n> @@ -150,6 +150,12 @@ Use this code to change which GAP interpreter is run. E.g.,\n>         import sage.interfaces.gap\n>         sage.interfaces.gap.gap_cmd = \"/usr/local/bin/gap\"\n>  \n> +Disabling the use of ~/.gap - no personal packages or settings used.\n> +\n> +::\n> +       import sage.interfaces.gap\n> +       sage.interfaces.gap.no_dotgap = True\n> +\n> ```\n> \n> I might be missing something (or maybe this is only a proposal?) but this doesn't look right.\n> \n> The instructions above would only create a global variable `no_dotgap` in the `sage.interfaces.gap` module, which isn't used.  Instead, one would call something like:\n> \n> ```\n> sage: g = Gap(no_dotgap=True)\n> ```\n> \n> to initialize a GAP interface with that option set.\n> \n> I'm also not sure about the name `no_dotgap`.  I've been trying (and sometimes it's hard) to avoid predicates with a negative proposition, which leads to confusing double-negatives (`no_dotgap=False` to *enable* the `.gap` directory).  I would instead call it something like `enable_dotgap=True` (and enable it by default).  Therefore any `Gap()` initialized by a user *would* use `.gap` which I absolutely agree is the desirable *default* behavior.\n> \n> Only the GAP interface used internally for Sage would set `enable_dotgap=False`).\n> \n> For libgap we're in a bit of a bind, but I *think* that the most important use case for the libgap interface in Sage is for interfacing with GAP internally (to replace the pexpect interface as much as possible), so this should disable .gap by default.\n\nProposal at this stage. I must say I have been a bit confused and modeled my documentation on the wrong model now that I look back at it. \n\nThe name. At first I was going for `use_dotgap` (similar to `enable_dotgap`) but I had to use it negatively which I didn't like at all. What about `disable_dotgap`?",
    "created_at": "2019-06-07T09:17:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433052",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@embray](#comment%3A25):
> 
> ```diff
> diff --git a/src/sage/interfaces/gap.py b/src/sage/interfaces/gap.py
> index a7a9fab..43c957b 100644
> --- a/src/sage/interfaces/gap.py
> +++ b/src/sage/interfaces/gap.py
> @@ -150,6 +150,12 @@ Use this code to change which GAP interpreter is run. E.g.,
>         import sage.interfaces.gap
>         sage.interfaces.gap.gap_cmd = "/usr/local/bin/gap"
>  
> +Disabling the use of ~/.gap - no personal packages or settings used.
> +
> +::
> +       import sage.interfaces.gap
> +       sage.interfaces.gap.no_dotgap = True
> +
> ```
> 
> I might be missing something (or maybe this is only a proposal?) but this doesn't look right.
> 
> The instructions above would only create a global variable `no_dotgap` in the `sage.interfaces.gap` module, which isn't used.  Instead, one would call something like:
> 
> ```
> sage: g = Gap(no_dotgap=True)
> ```
> 
> to initialize a GAP interface with that option set.
> 
> I'm also not sure about the name `no_dotgap`.  I've been trying (and sometimes it's hard) to avoid predicates with a negative proposition, which leads to confusing double-negatives (`no_dotgap=False` to *enable* the `.gap` directory).  I would instead call it something like `enable_dotgap=True` (and enable it by default).  Therefore any `Gap()` initialized by a user *would* use `.gap` which I absolutely agree is the desirable *default* behavior.
> 
> Only the GAP interface used internally for Sage would set `enable_dotgap=False`).
> 
> For libgap we're in a bit of a bind, but I *think* that the most important use case for the libgap interface in Sage is for interfacing with GAP internally (to replace the pexpect interface as much as possible), so this should disable .gap by default.

Proposal at this stage. I must say I have been a bit confused and modeled my documentation on the wrong model now that I look back at it. 

The name. At first I was going for `use_dotgap` (similar to `enable_dotgap`) but I had to use it negatively which I didn't like at all. What about `disable_dotgap`?



---

archive/issue_comments_433053.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI am trying to answer too fast. I see you are trying to avoid negative settings and I can understand that. I guess we just have to bear the negative use internally.",
    "created_at": "2019-06-07T09:20:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433053",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:28" align="right">comment:28</div>

I am trying to answer too fast. I see you are trying to avoid negative settings and I can understand that. I guess we just have to bear the negative use internally.



---

archive/issue_comments_433054.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI am testing an alternative based on my comments.",
    "created_at": "2019-06-07T09:33:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433054",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">comment:29</div>

I am testing an alternative based on my comments.



---

archive/issue_comments_433055.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@kiwifb](#comment%3A28):\n> I am trying to answer too fast. I see you are trying to avoid negative settings and I can understand that. I guess we just have to bear the negative use internally.\n\nYeah; the sense of the command-line parameter is negative, so this can be documented internally; but that doesn't mean the user-interface in Sage needs to be as well :)",
    "created_at": "2019-06-07T09:33:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433055",
    "user": "https://github.com/embray"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@kiwifb](#comment%3A28):
> I am trying to answer too fast. I see you are trying to avoid negative settings and I can understand that. I guess we just have to bear the negative use internally.

Yeah; the sense of the command-line parameter is negative, so this can be documented internally; but that doesn't mean the user-interface in Sage needs to be as well :)



---

archive/issue_comments_433056.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@kiwifb](#comment%3A26):\n> Replying to [@embray](#comment%3A24):\n> > Replying to [@nthiery](#comment%3A17):\n> > > Feedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.\n> > \n> > \n> > Yep--in particular autoloading of the xgap package has been a real problem for Sage's pexpect interface.\n> \n> \n> Now that's a painful flashback from before you started being involved with sage Erik. It took me a while to figure out what was happening to my sage-on-gentoo install where I had installed the whole gap distribution.\n> \n> I'll concede that your point (C) sounds reasonable but has the after taste of the package you customise specifically for sage (or some other software). \n> \n> Off course we want to move all of the use of point (C) to libgap I would imagine , which leaves the pexpect interface at your point (B). But having upstream giving you the tools to get to (C) would be nice.\n\nIndeed it would be nice; but it's admittedly not easy.  I've been watching the efforts over the last few years to make multiple parallel embedded Python interpreters possible from libpython, and while it mostly works now it was not a trivial effort.  I think it's maybe a little easier for GAP than it was for Python, especially with HPC-GAP, where most of the important interpreter globals have been moved into thread-local variables.  But it's still non-trivial, especially when you involve things like C extension modules :/\n\nIt's something I would gladly help work on if I had the time to do so, which I don't (and I doubt most of the GAP developers do either, even if it would likely be a desirable goal).",
    "created_at": "2019-06-07T09:37:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433056",
    "user": "https://github.com/embray"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@kiwifb](#comment%3A26):
> Replying to [@embray](#comment%3A24):
> > Replying to [@nthiery](#comment%3A17):
> > > Feedback from Alex and Michael: it used to be that GAP package authors could control whether their package was loaded automatically, and many if not most did. Nowadays, the normal behavior is not to autoload (like in e.g. Python or R), unless GAP core or some other autoloaded package requires it. So most recent packages don't autoload. But many old packages still autoload, for backward compatibility.
> > 
> > 
> > Yep--in particular autoloading of the xgap package has been a real problem for Sage's pexpect interface.
> 
> 
> Now that's a painful flashback from before you started being involved with sage Erik. It took me a while to figure out what was happening to my sage-on-gentoo install where I had installed the whole gap distribution.
> 
> I'll concede that your point (C) sounds reasonable but has the after taste of the package you customise specifically for sage (or some other software). 
> 
> Off course we want to move all of the use of point (C) to libgap I would imagine , which leaves the pexpect interface at your point (B). But having upstream giving you the tools to get to (C) would be nice.

Indeed it would be nice; but it's admittedly not easy.  I've been watching the efforts over the last few years to make multiple parallel embedded Python interpreters possible from libpython, and while it mostly works now it was not a trivial effort.  I think it's maybe a little easier for GAP than it was for Python, especially with HPC-GAP, where most of the important interpreter globals have been moved into thread-local variables.  But it's still non-trivial, especially when you involve things like C extension modules :/

It's something I would gladly help work on if I had the time to do so, which I don't (and I doubt most of the GAP developers do either, even if it would likely be a desirable goal).



---

archive/issue_comments_433057.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThe other complication to this that I haven't addressed yet is that GAP should probably also load a different workspace (if any) for when it's running with or without the .gap directory loaded, or this could lead to even more confusing inconsistencies :/\n\nPerhaps the arguments passed when starting GAP should be hashed into the hash in the workspace filename, or something?  I'm not confident about this part as I still don't fully understand how GAP workspaces work (just enough to know that they can definitely be influenced heavily by what pakages and globals are loaded).",
    "created_at": "2019-06-07T09:51:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433057",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

The other complication to this that I haven't addressed yet is that GAP should probably also load a different workspace (if any) for when it's running with or without the .gap directory loaded, or this could lead to even more confusing inconsistencies :/

Perhaps the arguments passed when starting GAP should be hashed into the hash in the workspace filename, or something?  I'm not confident about this part as I still don't fully understand how GAP workspaces work (just enough to know that they can definitely be influenced heavily by what pakages and globals are loaded).



---

archive/issue_comments_433058.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@embray](#comment%3A22):\n> > Principle of less surprise: keep GAP in Sage as similar as possible to GAP outside of Sage.\n> \n> I think that the `gap` global made available to users in Sage should not be the same as that used internally by Sage.  I think a lot of problems like this can be resolved cleanly by not crossing these use-cases where it isn't necessary to.\n\nI see now, after experimenting with this, that there is a technical challenge to it (I still think it is the right approach in principle).  The problem is that although it is possible to have multiple Gap interpreter instances, much of the code in Sage makes inconsistent assumptions that you are *only* using the \"main\" instance, currently the global variable named `gap`.\n\nFor example, SageObjects can have both a `_gap_` method, and a `_gap_init_` method.  The former returns the object's GAP representation wrapped in a `GapElement`.  It can take an *optional* `Gap` instance as an argument: The GAP interpreter instance in which to create the element.  The latter, `_gap_init_`, only returns a string of GAP code to be evaluated in the GAP interpreter to instantiate the object.  This is consistent with how other interfaces work.\n\nThe problem (or one of them) is that `_gap_init_` does *not* take an optional `Gap` instance, and just always assumes you're using the \"main\" `gap` instance.  This can lead to all kinds of inconsistencies, as sometimes the `_gap_init_` methods themselves query the Gap instance (e.g. what is the current `$sage` variable number) for details on how to evaluate the object.  So if you use one Gap instance in the `_gap_init_` call, but then pass the result of that call to a different `Gap` instance it is not guaranteed to work.\n\nFor this reason, among others, I would propose that we keep the current status quo w.r.t. disabling `.gap` by default *for now*, but add the `enable_dotgap` option, so that it's easy to create a new `Gap` instance that uses it.  Then change the default behavior only once further refactoring is done to maintain better separation between the (B) and (C) use cases.",
    "created_at": "2019-06-07T13:59:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433058",
    "user": "https://github.com/embray"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@embray](#comment%3A22):
> > Principle of less surprise: keep GAP in Sage as similar as possible to GAP outside of Sage.
> 
> I think that the `gap` global made available to users in Sage should not be the same as that used internally by Sage.  I think a lot of problems like this can be resolved cleanly by not crossing these use-cases where it isn't necessary to.

I see now, after experimenting with this, that there is a technical challenge to it (I still think it is the right approach in principle).  The problem is that although it is possible to have multiple Gap interpreter instances, much of the code in Sage makes inconsistent assumptions that you are *only* using the "main" instance, currently the global variable named `gap`.

For example, SageObjects can have both a `_gap_` method, and a `_gap_init_` method.  The former returns the object's GAP representation wrapped in a `GapElement`.  It can take an *optional* `Gap` instance as an argument: The GAP interpreter instance in which to create the element.  The latter, `_gap_init_`, only returns a string of GAP code to be evaluated in the GAP interpreter to instantiate the object.  This is consistent with how other interfaces work.

The problem (or one of them) is that `_gap_init_` does *not* take an optional `Gap` instance, and just always assumes you're using the "main" `gap` instance.  This can lead to all kinds of inconsistencies, as sometimes the `_gap_init_` methods themselves query the Gap instance (e.g. what is the current `$sage` variable number) for details on how to evaluate the object.  So if you use one Gap instance in the `_gap_init_` call, but then pass the result of that call to a different `Gap` instance it is not guaranteed to work.

For this reason, among others, I would propose that we keep the current status quo w.r.t. disabling `.gap` by default *for now*, but add the `enable_dotgap` option, so that it's easy to create a new `Gap` instance that uses it.  Then change the default behavior only once further refactoring is done to maintain better separation between the (B) and (C) use cases.



---

archive/issue_comments_433059.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nAll right. I think it is also important to have the doctest that started it all to be fixed quickly.",
    "created_at": "2019-06-10T23:41:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433059",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:34" align="right">comment:34</div>

All right. I think it is also important to have the doctest that started it all to be fixed quickly.



---

archive/issue_comments_433060.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@embray](#comment%3A25):\n> For libgap we're in a bit of a bind, but I *think* that the most important use case for the libgap interface in Sage is for interfacing with GAP internally (to replace the pexpect interface as much as possible), so this should disable .gap by default.\n\nIn my research code (and in packages such as sage-semigroups), I really need to be using libgap (rather than a pexpect interface) for efficiency. I believe that's a common use case.\n\nI see the rationale for aiming two separate gap instances, an incorruptible one for internal use, and a more flexible one for direct access by users. I don't know whether that's technically feasible at this stage though with libgap. Also we still want to be able to pass gap objects efficiently from internal code to user code.",
    "created_at": "2019-06-11T08:14:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433060",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@embray](#comment%3A25):
> For libgap we're in a bit of a bind, but I *think* that the most important use case for the libgap interface in Sage is for interfacing with GAP internally (to replace the pexpect interface as much as possible), so this should disable .gap by default.

In my research code (and in packages such as sage-semigroups), I really need to be using libgap (rather than a pexpect interface) for efficiency. I believe that's a common use case.

I see the rationale for aiming two separate gap instances, an incorruptible one for internal use, and a more flexible one for direct access by users. I don't know whether that's technically feasible at this stage though with libgap. Also we still want to be able to pass gap objects efficiently from internal code to user code.



---

archive/issue_comments_433061.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nthe sooneer a complete switch to libgap happens in sagelib, the better.\n\nI don't quite understand what \"pass gap objects efficiently from internal code to user code\" means here. IMHO this all fine in libgap, no?",
    "created_at": "2019-06-11T08:26:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433061",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:36" align="right">comment:36</div>

the sooneer a complete switch to libgap happens in sagelib, the better.

I don't quite understand what "pass gap objects efficiently from internal code to user code" means here. IMHO this all fine in libgap, no?



---

archive/issue_comments_433062.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\n> the sooneer a complete switch to libgap happens in sagelib, the better.\n\nYes, indeed!\n\n> I don't quite understand what \"pass gap objects efficiently from internal code to user code\" means here. IMHO this all fine in libgap, no? \n\nCurrently yes, indeed. Now assume we were to have two separate instances of libgap, one for sagelib and one user-facing, to protect the former from corruption by e.g. user packages; then, it may become costly to move one object from one instance to the other.",
    "created_at": "2019-06-11T21:22:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433062",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:37" align="right">comment:37</div>

> the sooneer a complete switch to libgap happens in sagelib, the better.

Yes, indeed!

> I don't quite understand what "pass gap objects efficiently from internal code to user code" means here. IMHO this all fine in libgap, no? 

Currently yes, indeed. Now assume we were to have two separate instances of libgap, one for sagelib and one user-facing, to protect the former from corruption by e.g. user packages; then, it may become costly to move one object from one instance to the other.



---

archive/issue_comments_433063.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nI'm not sure many instances of libgap loaded as python extensions are technically feasible; this seem to mean that one would have to mangle names in the dlls to avoid clashes etc.\n\nWhat might be feasible are several libgap workspaces.",
    "created_at": "2019-06-11T22:01:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433063",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:38" align="right">comment:38</div>

I'm not sure many instances of libgap loaded as python extensions are technically feasible; this seem to mean that one would have to mangle names in the dlls to avoid clashes etc.

What might be feasible are several libgap workspaces.



---

archive/issue_comments_433064.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nTickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433064",
    "user": "https://github.com/embray"
}
```

<div id="comment:39" align="right">comment:39</div>

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_events_379433.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379433"
}
```



---

archive/issue_events_379434.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379434"
}
```



---

archive/issue_comments_433065.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nI am opening a new ticket to fix the doctest in `gap_packages` under all scenario #28233. Let's keep this ticket for the serious stuff about how we are supposed to run gap.",
    "created_at": "2019-07-23T02:11:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27878#issuecomment-433065",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:40" align="right">comment:40</div>

I am opening a new ticket to fix the doctest in `gap_packages` under all scenario #28233. Let's keep this ticket for the serious stuff about how we are supposed to run gap.



---

archive/issue_events_379435.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-23T11:29:31Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379435"
}
```



---

archive/issue_events_379436.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-23T11:29:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27878",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27878#event-379436"
}
```
