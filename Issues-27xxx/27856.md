# Issue 27856: Tangent vectors should act as derivations on scalar fields

archive/issues_027619.json:
```json
{
    "body": "In Sage 8.7, we have\n\n```\nsage: M = Manifold(2, 'M')\nsage: X.<x,y> = M.chart()\nsage: p = M((2,-1), name='p')\nsage: TpM = M.tangent_space(p)\nsage: v = TpM((-2, 3), name='v'); v\nTangent vector v at Point p on the 2-dimensional differentiable manifold M\nsage: f = M.scalar_field(x*y^2, name='f')\nsage: v(f)\nTraceback (most recent call last):\n...\nTypeError: the argument no. 1 must be a linear form\n```\nNote that this works for vector *fields*:\n\n```\nsage: w = M.vector_field(name='w')\nsage: w[:] = -y, x\nsage: w.display()\nw = -y d/dx + x d/dy\nsage: w(f)\nScalar field w(f) on the 2-dimensional differentiable manifold M\nsage: w(f).display()\nw(f): M --> R\n   (x, y) |--> 2*x^2*y - y^3\n```\nThis issue has been reported in this [ask.sagemath question](https://ask.sagemath.org/question/46593/tangent-space-vector-mapping/).\n\nCC:  @tscrim\n\nKeywords: vector, derivation\n\nBranch/Commit: [4c0abd75065fae7820988a6eb8c2a0ebcb3091f9](https://github.com/sagemath/sagetrac-mirror/commit/4c0abd75065fae7820988a6eb8c2a0ebcb3091f9)\n\nReviewer: Travis Scrimshaw\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27856\n\n",
    "closed_at": "2019-06-02T22:04:31Z",
    "created_at": "2019-05-21T19:47:22Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Tangent vectors should act as derivations on scalar fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27856",
    "user": "https://github.com/egourgoulhon"
}
```
In Sage 8.7, we have

```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: p = M((2,-1), name='p')
sage: TpM = M.tangent_space(p)
sage: v = TpM((-2, 3), name='v'); v
Tangent vector v at Point p on the 2-dimensional differentiable manifold M
sage: f = M.scalar_field(x*y^2, name='f')
sage: v(f)
Traceback (most recent call last):
...
TypeError: the argument no. 1 must be a linear form
```
Note that this works for vector *fields*:

```
sage: w = M.vector_field(name='w')
sage: w[:] = -y, x
sage: w.display()
w = -y d/dx + x d/dy
sage: w(f)
Scalar field w(f) on the 2-dimensional differentiable manifold M
sage: w(f).display()
w(f): M --> R
   (x, y) |--> 2*x^2*y - y^3
```
This issue has been reported in this [ask.sagemath question](https://ask.sagemath.org/question/46593/tangent-space-vector-mapping/).

CC:  @tscrim

Keywords: vector, derivation

Branch/Commit: [4c0abd75065fae7820988a6eb8c2a0ebcb3091f9](https://github.com/sagemath/sagetrac-mirror/commit/4c0abd75065fae7820988a6eb8c2a0ebcb3091f9)

Reviewer: Travis Scrimshaw

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27856





---

archive/issue_comments_540085.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[50bc6da](https://github.com/sagemath/sagetrac-mirror/commit/50bc6da98b97fe2104f670c0cc7412211f87be7f)|`Add action of tangent vectors on scalar fields`|",
    "created_at": "2019-05-26T16:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540085",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[50bc6da](https://github.com/sagemath/sagetrac-mirror/commit/50bc6da98b97fe2104f670c0cc7412211f87be7f)|`Add action of tangent vectors on scalar fields`|



---

archive/issue_comments_540086.json:
```json
{
    "body": "Changing branch from \"\" to \"public/manifolds/vector_derivation-27856\"",
    "created_at": "2019-05-26T16:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540086",
    "user": "https://github.com/egourgoulhon"
}
```

Changing branch from "" to "public/manifolds/vector_derivation-27856"



---

archive/issue_comments_540087.json:
```json
{
    "body": "Changing commit from \"\" to \"50bc6da98b97fe2104f670c0cc7412211f87be7f\"",
    "created_at": "2019-05-26T16:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540087",
    "user": "https://github.com/egourgoulhon"
}
```

Changing commit from "" to "50bc6da98b97fe2104f670c0cc7412211f87be7f"



---

archive/issue_comments_540088.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-26T16:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540088",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_540089.json:
```json
{
    "body": "<a id='comment:3'></a>\nA good general rule that you should follow is to not overwrite `__call__`. Instead, the typical thing to do is implement an `_act_on_` (or `_acted_upon_`), and let the coercion framework handle the dispatching.",
    "created_at": "2019-05-26T23:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540089",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>
A good general rule that you should follow is to not overwrite `__call__`. Instead, the typical thing to do is implement an `_act_on_` (or `_acted_upon_`), and let the coercion framework handle the dispatching.



---

archive/issue_comments_540090.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [tscrim](#comment%3A3):\n> A good general rule that you should follow is to not overwrite `__call__`. Instead, the typical thing to do is implement an `_act_on_` (or `_acted_upon_`), and let the coercion framework handle the dispatching.\n\nI am a little bit puzzled by this: looking at lines 1154-1184 of `src/sage/structure/coerce.pyx`, I have the impression that `_act_on_` is used for actions denoted by `__mul__`, not by `__call__`. This seems confirmed from the doctest examples one can get from `grep -r \"def _act_on_\" src/sage`. Now, in the current setting, we do want to write `v(f)` for the action of a tangent vector `v` on a scalar function `f`, not `v*f`. For instance, we can form the derivation law that looks very much the textbook formula (`p` being the point at which `v` is defined):\n\n```\nv(f*g) == v(f)*g(p) + f(p)*v(g)\n```\nThere is no redefinition of `__call__` in `src/sage/structure/element.pyx`, contrary to `__add__`, `__mul__`, etc., which leads one to think that `__call__` is not delt via the coercion framework. Supporting this, we can note that overwriting `__call__` is much used in Sage library: `grep -r \"def __call__\" src/sage | wc -l` returns 496 instances (on the contrary, `grep -r \"def _act_on_\" src/sage | wc -l` returns only 16 instances). Am I missing something?",
    "created_at": "2019-05-27T15:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540090",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:4'></a>
Replying to [tscrim](#comment%3A3):
> A good general rule that you should follow is to not overwrite `__call__`. Instead, the typical thing to do is implement an `_act_on_` (or `_acted_upon_`), and let the coercion framework handle the dispatching.

I am a little bit puzzled by this: looking at lines 1154-1184 of `src/sage/structure/coerce.pyx`, I have the impression that `_act_on_` is used for actions denoted by `__mul__`, not by `__call__`. This seems confirmed from the doctest examples one can get from `grep -r "def _act_on_" src/sage`. Now, in the current setting, we do want to write `v(f)` for the action of a tangent vector `v` on a scalar function `f`, not `v*f`. For instance, we can form the derivation law that looks very much the textbook formula (`p` being the point at which `v` is defined):

```
v(f*g) == v(f)*g(p) + f(p)*v(g)
```
There is no redefinition of `__call__` in `src/sage/structure/element.pyx`, contrary to `__add__`, `__mul__`, etc., which leads one to think that `__call__` is not delt via the coercion framework. Supporting this, we can note that overwriting `__call__` is much used in Sage library: `grep -r "def __call__" src/sage | wc -l` returns 496 instances (on the contrary, `grep -r "def _act_on_" src/sage | wc -l` returns only 16 instances). Am I missing something?



---

archive/issue_comments_540091.json:
```json
{
    "body": "<a id='comment:5'></a>\nAh, I see. I saw act in the ticket and was thinking it should behave like a normal action (and be written with a binary operation such as multiplication). So sorry about that noise there. I guess this is fine since it is done on an element and not a parent. (As a side note, it is actually `__call__` that starts the dispatch to the coercion framework, not something that is dealt out from it.)\n\nOnly other thing you need to address is changing `EXAMPLES::` -> `EXAMPLES:` to get a positive review.",
    "created_at": "2019-05-28T13:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540091",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Ah, I see. I saw act in the ticket and was thinking it should behave like a normal action (and be written with a binary operation such as multiplication). So sorry about that noise there. I guess this is fine since it is done on an element and not a parent. (As a side note, it is actually `__call__` that starts the dispatch to the coercion framework, not something that is dealt out from it.)

Only other thing you need to address is changing `EXAMPLES::` -> `EXAMPLES:` to get a positive review.



---

archive/issue_comments_540092.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[4c0abd7](https://github.com/sagemath/sagetrac-mirror/commit/4c0abd75065fae7820988a6eb8c2a0ebcb3091f9)|`Correct EXAMPLES statement in tangent_vector`|",
    "created_at": "2019-05-28T13:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540092",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[4c0abd7](https://github.com/sagemath/sagetrac-mirror/commit/4c0abd75065fae7820988a6eb8c2a0ebcb3091f9)|`Correct EXAMPLES statement in tangent_vector`|



---

archive/issue_comments_540093.json:
```json
{
    "body": "Changing commit from \"50bc6da98b97fe2104f670c0cc7412211f87be7f\" to \"4c0abd75065fae7820988a6eb8c2a0ebcb3091f9\"",
    "created_at": "2019-05-28T13:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540093",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "50bc6da98b97fe2104f670c0cc7412211f87be7f" to "4c0abd75065fae7820988a6eb8c2a0ebcb3091f9"



---

archive/issue_comments_540094.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [tscrim](#comment%3A5):\n> Ah, I see. I saw act in the ticket and was thinking it should behave like a normal action (and be written with a binary operation such as multiplication). So sorry about that noise there. \n\n\nNo problem. Actually I should have used \"behave\" instead of \"act\" to avoid any confusion (there is indeed no group action here). \n\n>I guess this is fine since it is done on an element and not a parent. \n\n\n>(As a side note, it is actually `__call__` that starts the dispatch to the coercion framework, not >something that is dealt out from it.)\n\n\nFor my own instruction, can you tell by which magic this is done (given that `__call__` is not redefined in the base class `Element`)?\n\n> \n> Only other thing you need to address is changing `EXAMPLES::` -> `EXAMPLES:` to get a positive review.\n\n\nDone in the above commit.",
    "created_at": "2019-05-28T13:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540094",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:7'></a>
Replying to [tscrim](#comment%3A5):
> Ah, I see. I saw act in the ticket and was thinking it should behave like a normal action (and be written with a binary operation such as multiplication). So sorry about that noise there. 


No problem. Actually I should have used "behave" instead of "act" to avoid any confusion (there is indeed no group action here). 

>I guess this is fine since it is done on an element and not a parent. 


>(As a side note, it is actually `__call__` that starts the dispatch to the coercion framework, not >something that is dealt out from it.)


For my own instruction, can you tell by which magic this is done (given that `__call__` is not redefined in the base class `Element`)?

> 
> Only other thing you need to address is changing `EXAMPLES::` -> `EXAMPLES:` to get a positive review.


Done in the above commit.



---

archive/issue_comments_540095.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [egourgoulhon](#comment%3A7):\n> Replying to [tscrim](#comment%3A5):\n> >I guess this is fine since it is done on an element and not a parent. \n\n> \n> >(As a side note, it is actually `__call__` that starts the dispatch to the coercion framework, not >something that is dealt out from it.)\n\n> \n> For my own instruction, can you tell by which magic this is done (given that `__call__` is not redefined in the base class `Element`)?\n\n\nIt is `Parent.__call__` that starts the process off. However, you can explicit invoke the coercion framework by importing the `coercion_model` within your own class. There are also things like ``@`coerce_binop` as helpers too.\n\n> > Only other thing you need to address is changing `EXAMPLES::` -> `EXAMPLES:` to get a positive review.\n\n> \n> Done in the above commit.\n> \n\nThanks, LGTM.",
    "created_at": "2019-05-28T14:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540095",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
Replying to [egourgoulhon](#comment%3A7):
> Replying to [tscrim](#comment%3A5):
> >I guess this is fine since it is done on an element and not a parent. 

> 
> >(As a side note, it is actually `__call__` that starts the dispatch to the coercion framework, not >something that is dealt out from it.)

> 
> For my own instruction, can you tell by which magic this is done (given that `__call__` is not redefined in the base class `Element`)?


It is `Parent.__call__` that starts the process off. However, you can explicit invoke the coercion framework by importing the `coercion_model` within your own class. There are also things like ``@`coerce_binop` as helpers too.

> > Only other thing you need to address is changing `EXAMPLES::` -> `EXAMPLES:` to get a positive review.

> 
> Done in the above commit.
> 

Thanks, LGTM.



---

archive/issue_comments_540096.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2019-05-28T14:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540096",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_540097.json:
```json
{
    "body": "Changing author from \"\" to \"Eric Gourgoulhon\"",
    "created_at": "2019-05-28T14:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540097",
    "user": "https://github.com/tscrim"
}
```

Changing author from "" to "Eric Gourgoulhon"



---

archive/issue_comments_540098.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-28T14:07:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540098",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_540099.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [tscrim](#comment%3A8):\n> \n> It is `Parent.__call__` that starts the process off. However, you can explicit invoke the coercion framework by importing the `coercion_model` within your own class. There are also things like ``@`coerce_binop` as helpers too.\n> \n\n\nThanks for these explanations and thanks for the review!",
    "created_at": "2019-05-28T14:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540099",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>
Replying to [tscrim](#comment%3A8):
> 
> It is `Parent.__call__` that starts the process off. However, you can explicit invoke the coercion framework by importing the `coercion_model` within your own class. There are also things like ``@`coerce_binop` as helpers too.
> 


Thanks for these explanations and thanks for the review!



---

archive/issue_comments_540100.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-02T22:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540100",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_078273.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-02T22:04:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27856#event-78273"
}
```



---

archive/issue_comments_540101.json:
```json
{
    "body": "Changing branch from \"public/manifolds/vector_derivation-27856\" to \"4c0abd75065fae7820988a6eb8c2a0ebcb3091f9\"",
    "created_at": "2019-06-02T22:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27856",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27856#issuecomment-540101",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/manifolds/vector_derivation-27856" to "4c0abd75065fae7820988a6eb8c2a0ebcb3091f9"
