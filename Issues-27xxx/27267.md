# Issue 27267: Segfaults in cypari2 when running out of stack during deep object deallocation

archive/issues_027030.json:
```json
{
    "body": "Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?) but it can be provoked easily on other systems too with\n\n```\npari.allocatemem(2^28); L = [pari(i) for i in range(2^20)]; x = pari.Pi(); del L; del x\n```\n\nFor reference, this is the test failure on Cygwin:\n\n```\nsage -t --long src/sage/rings/number_field/totallyreal.pyx\n**********************************************************************\nFile \"src/sage/rings/number_field/totallyreal.pyx\", line 243, in sage.rings.number_field.totallyreal.?\nFailed example:\n    len(enumerate_totallyreal_fields_prim(2,2**15)) # long time\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.number_field.totallyreal.?[3]>\", line 1, in <module>\n        len(enumerate_totallyreal_fields_prim(Integer(2),Integer(2)**Integer(15))) # long time\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3683)\n        return self.get_object()(*args, **kwds)\n      File \"sage/rings/number_field/totallyreal.pyx\", line 393, in sage.rings.number_field.totallyreal.enumerate_totallyreal_fields_prim (build/cythonized/sage/rings/number_field/totallyreal.c:5753)\n        ng = <pari_gen>((<pari_gen>(pari([nf,zk]))).polredabs())\n      File \"cypari2/auto_gen.pxi\", line 22098, in cypari2.gen.Gen_base.polredabs\n      File \"cypari2/stack.pyx\", line 156, in cypari2.stack.new_gen\n      File \"cypari2/stack.pyx\", line 194, in cypari2.stack.new_gen_noclear\n      File \"cypari2/stack.pyx\", line 128, in cypari2.stack.move_gens_to_heap\n    SignalError: Segmentation fault\n```\n\nIt turns out that CPython's \"trashcan\" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2. While we're at it, we upgrade to the latest Cython release\n\n**Tarball**: https://files.pythonhosted.org/packages/e0/31/4a166556f92c469d8291d4b03a187f325c773c330fffc1e798bf83d947f2/Cython-0.29.5.tar.gz\n\n**Upstream tickets**:\n- https://github.com/cython/cython/pull/2842 \n- https://github.com/sagemath/cypari2/pull/77\n\n**CC:**  @jdemeyer\n\n**Keywords:** upgrade, cython, cypari2\n\n**Branch/Commit:** [b6ea17ef8e4d652de0a85047bac8d41e90b25555](https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555)\n\n**Upstream:** Fixed upstream, but not in a stable release.\n\n**Reviewer:** Erik Bray\n\n**Author:** Jeroen Demeyer\n\nIssue created by migration from https://trac.sagemath.org/ticket/27267\n\n",
    "closed_at": "2019-02-28T17:54:12Z",
    "created_at": "2019-02-12T16:52:38Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "title": "Segfaults in cypari2 when running out of stack during deep object deallocation",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/27267",
    "user": "https://github.com/embray"
}
```
Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?) but it can be provoked easily on other systems too with

```
pari.allocatemem(2^28); L = [pari(i) for i in range(2^20)]; x = pari.Pi(); del L; del x
```

For reference, this is the test failure on Cygwin:

```
sage -t --long src/sage/rings/number_field/totallyreal.pyx
**********************************************************************
File "src/sage/rings/number_field/totallyreal.pyx", line 243, in sage.rings.number_field.totallyreal.?
Failed example:
    len(enumerate_totallyreal_fields_prim(2,2**15)) # long time
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.number_field.totallyreal.?[3]>", line 1, in <module>
        len(enumerate_totallyreal_fields_prim(Integer(2),Integer(2)**Integer(15))) # long time
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3683)
        return self.get_object()(*args, **kwds)
      File "sage/rings/number_field/totallyreal.pyx", line 393, in sage.rings.number_field.totallyreal.enumerate_totallyreal_fields_prim (build/cythonized/sage/rings/number_field/totallyreal.c:5753)
        ng = <pari_gen>((<pari_gen>(pari([nf,zk]))).polredabs())
      File "cypari2/auto_gen.pxi", line 22098, in cypari2.gen.Gen_base.polredabs
      File "cypari2/stack.pyx", line 156, in cypari2.stack.new_gen
      File "cypari2/stack.pyx", line 194, in cypari2.stack.new_gen_noclear
      File "cypari2/stack.pyx", line 128, in cypari2.stack.move_gens_to_heap
    SignalError: Segmentation fault
```

It turns out that CPython's "trashcan" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2. While we're at it, we upgrade to the latest Cython release

**Tarball**: https://files.pythonhosted.org/packages/e0/31/4a166556f92c469d8291d4b03a187f325c773c330fffc1e798bf83d947f2/Cython-0.29.5.tar.gz

**Upstream tickets**:
- https://github.com/cython/cython/pull/2842 
- https://github.com/sagemath/cypari2/pull/77

**CC:**  @jdemeyer

**Keywords:** upgrade, cython, cypari2

**Branch/Commit:** [b6ea17ef8e4d652de0a85047bac8d41e90b25555](https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555)

**Upstream:** Fixed upstream, but not in a stable release.

**Reviewer:** Erik Bray

**Author:** Jeroen Demeyer

Issue created by migration from https://trac.sagemath.org/ticket/27267





---

archive/issue_comments_424054.json:
```json
{
    "body": "<a id='comment:1'></a>\nI have no further information to add at this point, but CC-ing you in case anything about this is obvious to you.",
    "created_at": "2019-02-12T16:53:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424054",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
I have no further information to add at this point, but CC-ing you in case anything about this is obvious to you.



---

archive/issue_comments_424055.json:
```json
{
    "body": "<a id='comment:2'></a>\nAre these problems reproducible? Do they occur when running the tests individually?\n\nIt would also be good to know the precise value of the pari stack size (`pari.default(\"parisizemax\")`). Does changing the value of `sizemax` in `src/sage/libs/pari/__init__.py` affect the crashes?",
    "created_at": "2019-02-12T22:11:40Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424055",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Are these problems reproducible? Do they occur when running the tests individually?

It would also be good to know the precise value of the pari stack size (`pari.default("parisizemax")`). Does changing the value of `sizemax` in `src/sage/libs/pari/__init__.py` affect the crashes?



---

archive/issue_comments_424056.json:
```json
{
    "body": "<a id='comment:3'></a>\nIt's completely reproducible and deterministic, at least when running the test suite.  I haven't tried putting together a simpler way to reproduce it.  But it was definitely introduced by #26442, and it's caused by an infinite recursion, apparently, in `remove_from_pari_stack()`:\n\n```\n#17155 0x0000000398b9e477 in __pyx_pw_4sage_4misc_11lazy_import_10LazyImport_17__call__ ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.dll\n(gdb)\n#17154 0x0000000398b915fd in __Pyx_PyObject_Call ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.dll\n(gdb)\n#17153 0x00000003933faf4a in __pyx_pw_4sage_5rings_12number_field_11totallyreal_3enumerate_totallyreal_fields_prim ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal.dll\n(gdb)\n#17152 0x00000003933e47d5 in __Pyx_PyObject_CallOneArg ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal.dll\n(gdb)\n#17151 0x00000003933e2a36 in __Pyx__PyObject_CallOneArg ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal.dll\n(gdb)\n#17150 0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll\n(gdb)\n#17149 0x00000003b277220e in __pyx_pw_7cypari2_3gen_8Gen_base_1255polredabs ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n(gdb)\n#17148 0x00000003b26a2eb9 in __pyx_pf_7cypari2_3gen_8Gen_base_1254polredabs ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n(gdb)\n#17147 0x00000003b1c69540 in __pyx_f_7cypari2_5stack_new_gen ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll\n#17147 0x00000003b1c69540 in __pyx_f_7cypari2_5stack_new_gen ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll\n(gdb) \n#17146 0x00000003b1c68871 in __pyx_f_7cypari2_5stack_new_gen_noclear ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll\n(gdb) \n#17145 0x00000003b1c67dc8 in __pyx_f_7cypari2_5stack_move_gens_to_heap ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll\n(gdb) \n#17144 0x00000003b1c6693d in __pyx_f_7cypari2_5stack_remove_from_pari_stack ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll\n(gdb) \n#17143 0x00000003b2692095 in __pyx_tp_dealloc_7cypari2_3gen_Gen ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n(gdb) \n#17142 0x00000003b1c6693d in __pyx_f_7cypari2_5stack_remove_from_pari_stack ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll\n(gdb) \n#17141 0x00000003b2692095 in __pyx_tp_dealloc_7cypari2_3gen_Gen ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n...\n```",
    "created_at": "2019-02-13T01:43:37Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424056",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
It's completely reproducible and deterministic, at least when running the test suite.  I haven't tried putting together a simpler way to reproduce it.  But it was definitely introduced by #26442, and it's caused by an infinite recursion, apparently, in `remove_from_pari_stack()`:

```
#17155 0x0000000398b9e477 in __pyx_pw_4sage_4misc_11lazy_import_10LazyImport_17__call__ ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.dll
(gdb)
#17154 0x0000000398b915fd in __Pyx_PyObject_Call ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.dll
(gdb)
#17153 0x00000003933faf4a in __pyx_pw_4sage_5rings_12number_field_11totallyreal_3enumerate_totallyreal_fields_prim ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal.dll
(gdb)
#17152 0x00000003933e47d5 in __Pyx_PyObject_CallOneArg ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal.dll
(gdb)
#17151 0x00000003933e2a36 in __Pyx__PyObject_CallOneArg ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/number_field/totallyreal.dll
(gdb)
#17150 0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll
(gdb)
#17149 0x00000003b277220e in __pyx_pw_7cypari2_3gen_8Gen_base_1255polredabs ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
(gdb)
#17148 0x00000003b26a2eb9 in __pyx_pf_7cypari2_3gen_8Gen_base_1254polredabs ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
(gdb)
#17147 0x00000003b1c69540 in __pyx_f_7cypari2_5stack_new_gen ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll
#17147 0x00000003b1c69540 in __pyx_f_7cypari2_5stack_new_gen ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll
(gdb) 
#17146 0x00000003b1c68871 in __pyx_f_7cypari2_5stack_new_gen_noclear ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll
(gdb) 
#17145 0x00000003b1c67dc8 in __pyx_f_7cypari2_5stack_move_gens_to_heap ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll
(gdb) 
#17144 0x00000003b1c6693d in __pyx_f_7cypari2_5stack_remove_from_pari_stack ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll
(gdb) 
#17143 0x00000003b2692095 in __pyx_tp_dealloc_7cypari2_3gen_Gen ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
(gdb) 
#17142 0x00000003b1c6693d in __pyx_f_7cypari2_5stack_remove_from_pari_stack ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/stack.dll
(gdb) 
#17141 0x00000003b2692095 in __pyx_tp_dealloc_7cypari2_3gen_Gen ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
...
```



---

archive/issue_comments_424057.json:
```json
{
    "body": "<a id='comment:4'></a>\nWould it be possible to check if it's an *infinite* recursion or just a very deep recursion, for example by increasing the process stack size (if this is possible on Cygwin)? GC is known to introduce deep-but-finite recursions (the Python trashcan mechanism was invented to deal with that).",
    "created_at": "2019-02-13T08:11:43Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424057",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Would it be possible to check if it's an *infinite* recursion or just a very deep recursion, for example by increasing the process stack size (if this is possible on Cygwin)? GC is known to introduce deep-but-finite recursions (the Python trashcan mechanism was invented to deal with that).



---

archive/issue_events_240832.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-13T08:50:00Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "rename": {
        "from": "Cygwin: Segfaults in cypari2 and/or PARI",
        "to": "Cygwin: Segfaults in cypari2"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27267#event-240832"
}
```



---

archive/issue_comments_424058.json:
```json
{
    "body": "<a id='comment:6'></a>\nConfirmed on Linux with `ulimit -s 1000` (1MB stack size).",
    "created_at": "2019-02-13T09:10:34Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424058",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
Confirmed on Linux with `ulimit -s 1000` (1MB stack size).



---

archive/issue_comments_424059.json:
```json
{
    "body": "**Upstream:** Reported upstream. Developers acknowledge bug.",
    "created_at": "2019-02-13T09:58:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424059",
    "user": "https://github.com/jdemeyer"
}
```

**Upstream:** Reported upstream. Developers acknowledge bug.



---

archive/issue_comments_424060.json:
```json
{
    "body": "<a id='comment:8'></a>\nDigging deep in the CPython trashcan mechanism...",
    "created_at": "2019-02-13T11:03:13Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424060",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Digging deep in the CPython trashcan mechanism...



---

archive/issue_comments_424061.json:
```json
{
    "body": "<a id='comment:9'></a>\nIdeally, this would be fixed by Cython upstream in https://github.com/cython/cython/pull/2842",
    "created_at": "2019-02-14T22:41:00Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424061",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Ideally, this would be fixed by Cython upstream in https://github.com/cython/cython/pull/2842



---

archive/issue_comments_424062.json:
```json
{
    "body": "<a id='comment:10'></a>\nThis all seems interesting and I want to take a closer look.  But fixing this issue obviously cannot rely, at least in the short term, on both a patch to CPython and a new feature in Cython.  That begins to feel like there must be a simpler approach by just reworking how cypari2 is handling these deallocations.",
    "created_at": "2019-02-18T11:37:02Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424062",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
This all seems interesting and I want to take a closer look.  But fixing this issue obviously cannot rely, at least in the short term, on both a patch to CPython and a new feature in Cython.  That begins to feel like there must be a simpler approach by just reworking how cypari2 is handling these deallocations.



---

archive/issue_comments_424063.json:
```json
{
    "body": "<a id='comment:11'></a>\nJust for the record: the fix does not depend on the CPython patch. The CPython patch is meant to fix an issue in the trashcan when subclassing is involved. But the trashcan would work without that patch.",
    "created_at": "2019-02-18T11:40:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424063",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
Just for the record: the fix does not depend on the CPython patch. The CPython patch is meant to fix an issue in the trashcan when subclassing is involved. But the trashcan would work without that patch.



---

archive/issue_comments_424064.json:
```json
{
    "body": "<a id='comment:12'></a>\nAnd yes, this could be fixed without any Cython patch but I'd rather not bother.",
    "created_at": "2019-02-18T11:42:02Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424064",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
And yes, this could be fixed without any Cython patch but I'd rather not bother.



---

archive/issue_comments_424065.json:
```json
{
    "body": "<a id='comment:13'></a>\nRegardless, it's quite an integration hassle to depend on a new feature in Cython which does not exist yet, and a new release of Cython, in order to build this in such a way that it does not easily cause stack overflows.  I'd rather revert the upgrade to cypari2 until this can be resolved.",
    "created_at": "2019-02-18T11:46:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424065",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
Regardless, it's quite an integration hassle to depend on a new feature in Cython which does not exist yet, and a new release of Cython, in order to build this in such a way that it does not easily cause stack overflows.  I'd rather revert the upgrade to cypari2 until this can be resolved.



---

archive/issue_comments_424066.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A11):\n> Just for the record: the fix does not depend on the CPython patch. The CPython patch is meant to fix an issue in the trashcan when subclassing is involved. But the trashcan would work without that patch.\n\nIt depends on what you mean by \"subclassing is involved\".  In this case subclassing *is* involved, as `Gen` is a subclass of `Gen_base`.  But maybe this is not what you mean, as there is no subclassing at the Python level (currently), and `Gen_base` does not implement a custom `tp_dealloc`, nor use the \"trashcan\" mechanism.  So I don't *think* the issue is immediately in effect here, but I wanted to be sure about that.  It's not obvious.",
    "created_at": "2019-02-18T11:51:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424066",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A11):
> Just for the record: the fix does not depend on the CPython patch. The CPython patch is meant to fix an issue in the trashcan when subclassing is involved. But the trashcan would work without that patch.

It depends on what you mean by "subclassing is involved".  In this case subclassing *is* involved, as `Gen` is a subclass of `Gen_base`.  But maybe this is not what you mean, as there is no subclassing at the Python level (currently), and `Gen_base` does not implement a custom `tp_dealloc`, nor use the "trashcan" mechanism.  So I don't *think* the issue is immediately in effect here, but I wanted to be sure about that.  It's not obvious.



---

archive/issue_comments_424067.json:
```json
{
    "body": "<a id='comment:15'></a>\nWould it be possible (as interim work-around) to run Sage with a larger stack size (`ulimit -s 8192` for example)?",
    "created_at": "2019-02-18T12:31:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424067",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
Would it be possible (as interim work-around) to run Sage with a larger stack size (`ulimit -s 8192` for example)?



---

archive/issue_comments_424068.json:
```json
{
    "body": "<a id='comment:16'></a>\nWith \"subclassing is involved\", I mean more precisely a class inheriting from a base class, where the base class uses the trashcan. This is broken in CPython (for example, for subclasses of `list`) but that bug is unrelated to this ticket here.",
    "created_at": "2019-02-18T12:34:29Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424068",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
With "subclassing is involved", I mean more precisely a class inheriting from a base class, where the base class uses the trashcan. This is broken in CPython (for example, for subclasses of `list`) but that bug is unrelated to this ticket here.



---

archive/issue_comments_424069.json:
```json
{
    "body": "<a id='comment:17'></a>\nI did a build of Python 2 with a 16 MB stack for the Python executable, and it fixed some of the segfaulting tests, but not others.  E.g.\n\n```\n$ ./sage -t --long src/sage/libs/libecm.pyx\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2019-02-18-14-30-03-ccffc1e9.\nGit branch: HEAD\nUsing --optional=dochtml,mpir,python2,sage\nDoctesting 1 file.\nsage -t --long src/sage/libs/libecm.pyx\n**********************************************************************\nFile \"src/sage/libs/libecm.pyx\", line 111, in sage.libs.libecm.ecmfactor\nFailed example:\n    N.is_prime()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.libecm.ecmfactor[8]>\", line 1, in <module>\n        N.is_prime()\n      File \"sage/rings/integer.pyx\", line 5129, in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32101)\n        return self.__pari__().isprime()\n      File \"cypari2/gen.pyx\", line 2077, in cypari2.gen.Gen.isprime\n    SignalError: Segmentation fault\n**********************************************************************\n1 item had failures:\n   1 of  21 in sage.libs.libecm.ecmfactor\n    [28 tests, 1 failure, 1.53 s]\n```\n\nAmong others.  What should the stack size be so that this doesn't blow up?  16MB seems like plenty...",
    "created_at": "2019-02-18T13:36:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424069",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
I did a build of Python 2 with a 16 MB stack for the Python executable, and it fixed some of the segfaulting tests, but not others.  E.g.

```
$ ./sage -t --long src/sage/libs/libecm.pyx
too many failed tests, not using stored timings
Running doctests with ID 2019-02-18-14-30-03-ccffc1e9.
Git branch: HEAD
Using --optional=dochtml,mpir,python2,sage
Doctesting 1 file.
sage -t --long src/sage/libs/libecm.pyx
**********************************************************************
File "src/sage/libs/libecm.pyx", line 111, in sage.libs.libecm.ecmfactor
Failed example:
    N.is_prime()
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.libecm.ecmfactor[8]>", line 1, in <module>
        N.is_prime()
      File "sage/rings/integer.pyx", line 5129, in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32101)
        return self.__pari__().isprime()
      File "cypari2/gen.pyx", line 2077, in cypari2.gen.Gen.isprime
    SignalError: Segmentation fault
**********************************************************************
1 item had failures:
   1 of  21 in sage.libs.libecm.ecmfactor
    [28 tests, 1 failure, 1.53 s]
```

Among others.  What should the stack size be so that this doesn't blow up?  16MB seems like plenty...



---

archive/issue_comments_424070.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [jdemeyer](#comment%3A16):\n> With \"subclassing is involved\", I mean more precisely a class inheriting from a base class, where the base class uses the trashcan. This is broken in CPython (for example, for subclasses of `list`) but that bug is unrelated to this ticket here.\n\nI see that now.  Would a class that uses `@cython.trashcan` have the same problem if it were subclassed?  Or does your implementation take care of working around that bug?",
    "created_at": "2019-02-18T13:37:15Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424070",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
Replying to [jdemeyer](#comment%3A16):
> With "subclassing is involved", I mean more precisely a class inheriting from a base class, where the base class uses the trashcan. This is broken in CPython (for example, for subclasses of `list`) but that bug is unrelated to this ticket here.

I see that now.  Would a class that uses `@cython.trashcan` have the same problem if it were subclassed?  Or does your implementation take care of working around that bug?



---

archive/issue_comments_424071.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [jdemeyer](#comment%3A15):\n> Would it be possible (as interim work-around) to run Sage with a larger stack size (`ulimit -s 8192` for example)?\n\nSetting `ulimit -s` doesn't work on Cygwin: You have to actually link executables with a fixed maximum stack size, which is a field in the binary's headers.  In this case it should suffice to link the python interpreter executable with a large enough stack that it at least doesn't crash on the tests.  That would be acceptable to me as a *temporary* workaround.  But I've gone now up to 32 MB and it's still crashing.  I wonder if there is something else at play here.",
    "created_at": "2019-02-18T14:00:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424071",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>
Replying to [jdemeyer](#comment%3A15):
> Would it be possible (as interim work-around) to run Sage with a larger stack size (`ulimit -s 8192` for example)?

Setting `ulimit -s` doesn't work on Cygwin: You have to actually link executables with a fixed maximum stack size, which is a field in the binary's headers.  In this case it should suffice to link the python interpreter executable with a large enough stack that it at least doesn't crash on the tests.  That would be acceptable to me as a *temporary* workaround.  But I've gone now up to 32 MB and it's still crashing.  I wonder if there is something else at play here.



---

archive/issue_events_240833.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-18T14:01:09Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "rename": {
        "from": "Cygwin: Segfaults in cypari2",
        "to": "Segfaults in cypari2 when running out of stack during deep object deallocation"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27267#event-240833"
}
```



---

archive/issue_comments_424072.json:
```json
{
    "body": "<a id='comment:20'></a>\nChanged title since this does not just affect Cygwin.",
    "created_at": "2019-02-18T14:01:09Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424072",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
Changed title since this does not just affect Cygwin.



---

archive/issue_comments_424073.json:
```json
{
    "body": "<a id='comment:21'></a>\nOn Linux (at least the laptop that I'm writing this on), the default stack size is 8MB. So either programs under Cygwin use much more stack or there is indeed something else.",
    "created_at": "2019-02-18T18:49:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424073",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
On Linux (at least the laptop that I'm writing this on), the default stack size is 8MB. So either programs under Cygwin use much more stack or there is indeed something else.



---

archive/issue_comments_424074.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [embray](#comment%3A18):\n> Or does your implementation take care of working around that bug?\n\nThe current Cython PR uses the same code that I proposed to CPython. So yes, it works around that bug.",
    "created_at": "2019-02-18T18:50:59Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424074",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Replying to [embray](#comment%3A18):
> Or does your implementation take care of working around that bug?

The current Cython PR uses the same code that I proposed to CPython. So yes, it works around that bug.



---

archive/issue_comments_424075.json:
```json
{
    "body": "<a id='comment:23'></a>\nThe Cython PR is merged.",
    "created_at": "2019-02-18T19:26:22Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424075",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
The Cython PR is merged.



---

archive/issue_comments_424076.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. Developers acknowledge bug.\" to \"Fixed upstream, but not in a stable release.\".",
    "created_at": "2019-02-18T19:26:22Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424076",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Reported upstream. Developers acknowledge bug." to "Fixed upstream, but not in a stable release.".



---

archive/issue_comments_424077.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-I have started getting a handful of Segfaults on Cygwin.  Most of them look like this, in `isprime`:\n+Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?):\n \n ```\n sage -t --long src/sage/libs/libecm.pyx\n@@ -47,4 +47,4 @@\n     SignalError: Segmentation fault\n ```\n \n-This probably started with #26442 but I'm still confirming.\n+It turns out that CPython's \"trashcan\" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan`, see https://github.com/cython/cython/pull/2842\n``````\n",
    "created_at": "2019-02-18T19:26:22Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424077",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-I have started getting a handful of Segfaults on Cygwin.  Most of them look like this, in `isprime`:
+Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?):
 
 ```
 sage -t --long src/sage/libs/libecm.pyx
@@ -47,4 +47,4 @@
     SignalError: Segmentation fault
 ```
 
-This probably started with #26442 but I'm still confirming.
+It turns out that CPython's "trashcan" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan`, see https://github.com/cython/cython/pull/2842
``````




---

archive/issue_comments_424078.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n-Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?):\n+Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?) but it can be provoked easily on other systems too with\n+\n+```\n+pari.allocatemem(2^28); L = [pari(i) for i in range(2^20)]; x = pari.Pi(); del L; del x\n+```\n+\n+For reference, these are the test failures on Cygwin:\n \n ```\n sage -t --long src/sage/libs/libecm.pyx\n``````\n",
    "created_at": "2019-02-19T10:46:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424078",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,10 @@
-Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?):
+Since cypari2-2 (#26442), the `__dealloc__` for `Gen` may cause deep (but finite) recursions, causing a stack overflow. This happens in particular on Cygwin which has a smallish stack by default (and maybe it also uses more stack space?) but it can be provoked easily on other systems too with
+
+```
+pari.allocatemem(2^28); L = [pari(i) for i in range(2^20)]; x = pari.Pi(); del L; del x
+```
+
+For reference, these are the test failures on Cygwin:
 
 ```
 sage -t --long src/sage/libs/libecm.pyx
``````




---

archive/issue_comments_424079.json:
```json
{
    "body": "<a id='comment:25'></a>\nI created a new branch for cypari2 to use the trashcan (and other new Cython features): https://github.com/sagemath/cypari2/pull/77",
    "created_at": "2019-02-19T13:05:52Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424079",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
I created a new branch for cypari2 to use the trashcan (and other new Cython features): https://github.com/sagemath/cypari2/pull/77



---

archive/issue_comments_424080.json:
```json
{
    "body": "<a id='comment:26'></a>\nThis is essentially fixed upstream, both in Cython and in cypari2 (the latter is WIP but should be fixed soon).\n\nThe question is what should be done in Sage right now. I see 3 possibilities:\n\n1. Do nothing for now and wait until a new version of Cython and cypari2 is released (the latter is easy since I'm the maintainer of cypari2).\n\n2. Apply patches to both Cython and cypari2 in Sage.\n\n3. Somehow work around the issue in a different way.\n\nI prefer 2 since it properly fixes the actual problem. I believe that these patches are acceptable for distributions since they don't change doctest output of anything in Sage on Linux.",
    "created_at": "2019-02-19T13:46:48Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424080",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
This is essentially fixed upstream, both in Cython and in cypari2 (the latter is WIP but should be fixed soon).

The question is what should be done in Sage right now. I see 3 possibilities:

1. Do nothing for now and wait until a new version of Cython and cypari2 is released (the latter is easy since I'm the maintainer of cypari2).

2. Apply patches to both Cython and cypari2 in Sage.

3. Somehow work around the issue in a different way.

I prefer 2 since it properly fixes the actual problem. I believe that these patches are acceptable for distributions since they don't change doctest output of anything in Sage on Linux.



---

archive/issue_comments_424081.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [jdemeyer](#comment%3A21):\n> On Linux (at least the laptop that I'm writing this on), the default stack size is 8MB. So either programs under Cygwin use much more stack or there is indeed something else.\n\nJust to compare I compiled / ran this little program on Linux and Windows:\n\n```c\n#include <stdio.h>\n\n\nvoid recurse() {\n    static int depth = 0;\n    char c;\n    printf(\"recursion depth: %d; stack at: %p\\n\", depth, &c);\n    depth += 1;\n    recurse();\n}\n\n\nint main(void) {\n    recurse();\n    return 0;\n}\n```\n\nThe major difference, between minor calling convention details, is that on Linux the `recurse` function has the preamble:\n\n```\n  40052d:       55                      push   %rbp\n  40052e:       48 89 e5                mov    %rsp,%rbp\n  400531:       48 83 ec 10             sub    $0x10,%rsp\n```\n\nwhereas on Windows it begins:\n\n```\n   1004010e0:   55                      push   %rbp\n   1004010e1:   48 89 e5                mov    %rsp,%rbp\n   1004010e4:   48 83 ec 30             sub    $0x30,%rsp\n```\n\nwhere the extra 32 bytes reserved on the stack are a requirement of the Microsoft x64 calling convention.  And indeed, when I run the program on both systems with the stack limit set to 2MB, the Linux version was able to get just a little over 2 times deeper before overflowing.\n\nThat's just a trivial example though; not sure exactly how the numbers shake out with `Gen.__dealloc__()`/`remove_from_pari_stack()` recursions.  I would think the difference would e less extreme in that case.\n\nSo, 32MB should have been more than enough, and yet it wasn't.  I'll try once more with 64 MB just out of curiosity, but then I'll check if it's something else that's wrong...",
    "created_at": "2019-02-19T14:02:23Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424081",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'></a>
Replying to [jdemeyer](#comment%3A21):
> On Linux (at least the laptop that I'm writing this on), the default stack size is 8MB. So either programs under Cygwin use much more stack or there is indeed something else.

Just to compare I compiled / ran this little program on Linux and Windows:

```c
#include <stdio.h>


void recurse() {
    static int depth = 0;
    char c;
    printf("recursion depth: %d; stack at: %p\n", depth, &c);
    depth += 1;
    recurse();
}


int main(void) {
    recurse();
    return 0;
}
```

The major difference, between minor calling convention details, is that on Linux the `recurse` function has the preamble:

```
  40052d:       55                      push   %rbp
  40052e:       48 89 e5                mov    %rsp,%rbp
  400531:       48 83 ec 10             sub    $0x10,%rsp
```

whereas on Windows it begins:

```
   1004010e0:   55                      push   %rbp
   1004010e1:   48 89 e5                mov    %rsp,%rbp
   1004010e4:   48 83 ec 30             sub    $0x30,%rsp
```

where the extra 32 bytes reserved on the stack are a requirement of the Microsoft x64 calling convention.  And indeed, when I run the program on both systems with the stack limit set to 2MB, the Linux version was able to get just a little over 2 times deeper before overflowing.

That's just a trivial example though; not sure exactly how the numbers shake out with `Gen.__dealloc__()`/`remove_from_pari_stack()` recursions.  I would think the difference would e less extreme in that case.

So, 32MB should have been more than enough, and yet it wasn't.  I'll try once more with 64 MB just out of curiosity, but then I'll check if it's something else that's wrong...



---

archive/issue_comments_424082.json:
```json
{
    "body": "<a id='comment:28'></a>\nWith optimization level did you compile with? There might be a difference between `-O0` and `-O3`.",
    "created_at": "2019-02-19T14:27:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424082",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
With optimization level did you compile with? There might be a difference between `-O0` and `-O3`.



---

archive/issue_comments_424083.json:
```json
{
    "body": "<a id='comment:29'></a>\nIt's with `-O3` by default, so that shouldn't be it.  I'm still getting segfaults even with the stack set to 64MB.  Let me confirm whether it's actually using all those 64MB, and then I'll see if there's something else going on here...",
    "created_at": "2019-02-19T14:40:08Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424083",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>
It's with `-O3` by default, so that shouldn't be it.  I'm still getting segfaults even with the stack set to 64MB.  Let me confirm whether it's actually using all those 64MB, and then I'll see if there's something else going on here...



---

archive/issue_comments_424084.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [jdemeyer](#comment%3A26):\n> This is essentially fixed upstream, both in Cython and in cypari2 (the latter is WIP but should be fixed soon).\n> \n> The question is what should be done in Sage right now. I see 3 possibilities:\n> \n> 1. Do nothing for now and wait until a new version of Cython and cypari2 is released (the latter is easy since I'm the maintainer of cypari2).\n> \n> 2. Apply patches to both Cython and cypari2 in Sage.\n> \n> 3. Somehow work around the issue in a different way.\n> \n> I prefer 2 since it properly fixes the actual problem. I believe that these patches are acceptable for distributions since they don't change doctest output of anything in Sage on Linux.\n\nI'll see if it fixes the problem here, and if so I can accept option 2 as well.",
    "created_at": "2019-02-19T14:44:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424084",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>
Replying to [jdemeyer](#comment%3A26):
> This is essentially fixed upstream, both in Cython and in cypari2 (the latter is WIP but should be fixed soon).
> 
> The question is what should be done in Sage right now. I see 3 possibilities:
> 
> 1. Do nothing for now and wait until a new version of Cython and cypari2 is released (the latter is easy since I'm the maintainer of cypari2).
> 
> 2. Apply patches to both Cython and cypari2 in Sage.
> 
> 3. Somehow work around the issue in a different way.
> 
> I prefer 2 since it properly fixes the actual problem. I believe that these patches are acceptable for distributions since they don't change doctest output of anything in Sage on Linux.

I'll see if it fixes the problem here, and if so I can accept option 2 as well.



---

archive/issue_comments_424085.json:
```json
{
    "body": "<a id='comment:31'></a>\nOkay, right. Increasing the stack size did appear to fix the crash in a few tests, such as\n\n```\nsage -t --long src/sage/rings/number_field/totallyreal.pyx\n```\n\nwhich now works, but did not with a smaller stack.\n\nHowever, I'm still getting segfaults in `Gen.isprime` like\n\n```\nFile \"src/sage/libs/libecm.pyx\", line 111, in sage.libs.libecm.ecmfactor\nFailed example:\n    N.is_prime()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.libecm.ecmfactor[8]>\", line 1, in <module>\n        N.is_prime()\n      File \"sage/rings/integer.pyx\", line 5129, in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32101)\n        return self.__pari__().isprime()\n      File \"cypari2/gen.pyx\", line 2077, in cypari2.gen.Gen.isprime\n    SignalError: Segmentation fault\n```\n\nthis appears to be a totally separate issue from the stack overflow issue.  Here's the \"interesting\" part of the stack trace.  I'll have to build a debug version of PARI to find out more:\n\n```\nProgram received signal SIGSEGV, Segmentation fault.\n0x00000003b598daf4 in red_montgomery ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n(gdb) where\n#0  0x00000003b598daf4 in red_montgomery ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#1  0x00000003b5bd482f in gen_pow_i ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#2  0x00000003b5b58d1e in Fp_pow ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#3  0x00000003b5e77644 in pl831 ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#5  0x00000003b5e7acb2 in isprime ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#6  0x00000003b5d0d4cf in map_proto_lG ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll\n#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime\n    ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()\n   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll\n```\n\nI will probably open a new ticket for this since it seems to be a separate issue.  Nevertheless I've never seen this bug before the cypari2 upgrade, so if you have any ideas...",
    "created_at": "2019-02-19T14:54:13Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424085",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>
Okay, right. Increasing the stack size did appear to fix the crash in a few tests, such as

```
sage -t --long src/sage/rings/number_field/totallyreal.pyx
```

which now works, but did not with a smaller stack.

However, I'm still getting segfaults in `Gen.isprime` like

```
File "src/sage/libs/libecm.pyx", line 111, in sage.libs.libecm.ecmfactor
Failed example:
    N.is_prime()
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.libecm.ecmfactor[8]>", line 1, in <module>
        N.is_prime()
      File "sage/rings/integer.pyx", line 5129, in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32101)
        return self.__pari__().isprime()
      File "cypari2/gen.pyx", line 2077, in cypari2.gen.Gen.isprime
    SignalError: Segmentation fault
```

this appears to be a totally separate issue from the stack overflow issue.  Here's the "interesting" part of the stack trace.  I'll have to build a debug version of PARI to find out more:

```
Program received signal SIGSEGV, Segmentation fault.
0x00000003b598daf4 in red_montgomery ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
(gdb) where
#0  0x00000003b598daf4 in red_montgomery ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#1  0x00000003b5bd482f in gen_pow_i ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#2  0x00000003b5b58d1e in Fp_pow ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#3  0x00000003b5e77644 in pl831 ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#5  0x00000003b5e7acb2 in isprime ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#6  0x00000003b5d0d4cf in map_proto_lG ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll
#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime
    ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()
   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll
```

I will probably open a new ticket for this since it seems to be a separate issue.  Nevertheless I've never seen this bug before the cypari2 upgrade, so if you have any ideas...



---

archive/issue_comments_424086.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,29 +4,7 @@\n pari.allocatemem(2^28); L = [pari(i) for i in range(2^20)]; x = pari.Pi(); del L; del x\n ```\n \n-For reference, these are the test failures on Cygwin:\n-\n-```\n-sage -t --long src/sage/libs/libecm.pyx\n-**********************************************************************\n-File \"src/sage/libs/libecm.pyx\", line 111, in sage.libs.libecm.ecmfactor\n-Failed example:\n-    N.is_prime()\n-Exception raised:\n-    Traceback (most recent call last):\n-      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n-        self.compile_and_execute(example, compiler, test.globs)\n-      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n-        exec(compiled, globs)\n-      File \"<doctest sage.libs.libecm.ecmfactor[8]>\", line 1, in <module>\n-        N.is_prime()\n-      File \"sage/rings/integer.pyx\", line 5143, in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32102)\n-        return self.__pari__().isprime()\n-      File \"cypari2/gen.pyx\", line 2077, in cypari2.gen.Gen.isprime\n-    SignalError: Segmentation fault\n-```\n-\n-I also get this one:\n+For reference, this is the test failure on Cygwin:\n \n ```\n sage -t --long src/sage/rings/number_field/totallyreal.pyx\n``````\n",
    "created_at": "2019-02-19T15:10:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424086",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,29 +4,7 @@
 pari.allocatemem(2^28); L = [pari(i) for i in range(2^20)]; x = pari.Pi(); del L; del x
 ```
 
-For reference, these are the test failures on Cygwin:
-
-```
-sage -t --long src/sage/libs/libecm.pyx
-**********************************************************************
-File "src/sage/libs/libecm.pyx", line 111, in sage.libs.libecm.ecmfactor
-Failed example:
-    N.is_prime()
-Exception raised:
-    Traceback (most recent call last):
-      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
-        self.compile_and_execute(example, compiler, test.globs)
-      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
-        exec(compiled, globs)
-      File "<doctest sage.libs.libecm.ecmfactor[8]>", line 1, in <module>
-        N.is_prime()
-      File "sage/rings/integer.pyx", line 5143, in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32102)
-        return self.__pari__().isprime()
-      File "cypari2/gen.pyx", line 2077, in cypari2.gen.Gen.isprime
-    SignalError: Segmentation fault
-```
-
-I also get this one:
+For reference, this is the test failure on Cygwin:
 
 ```
 sage -t --long src/sage/rings/number_field/totallyreal.pyx
``````




---

archive/issue_comments_424087.json:
```json
{
    "body": "<a id='comment:33'></a>\nYou could try `pari(2^127 - 1).isprime()` in Sage and see whether that crashes.",
    "created_at": "2019-02-19T15:12:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424087",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>
You could try `pari(2^127 - 1).isprime()` in Sage and see whether that crashes.



---

archive/issue_comments_424088.json:
```json
{
    "body": "<a id='comment:34'></a>\nI mean yes, that example crashes outside the test suite as well.",
    "created_at": "2019-02-19T15:28:49Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424088",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>
I mean yes, that example crashes outside the test suite as well.



---

archive/issue_comments_424089.json:
```json
{
    "body": "<a id='comment:35'></a>\nAnd in GP? Run `./sage --gp` and then\n\n```\nisprime(2^127 - 1)\n```",
    "created_at": "2019-02-19T15:39:02Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424089",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>
And in GP? Run `./sage --gp` and then

```
isprime(2^127 - 1)
```



---

archive/issue_comments_424090.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -31,4 +31,8 @@\n     SignalError: Segmentation fault\n ```\n \n-It turns out that CPython's \"trashcan\" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan`, see https://github.com/cython/cython/pull/2842\n+It turns out that CPython's \"trashcan\" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2.\n+\n+Upstream tickets:\n+- https://github.com/cython/cython/pull/2842 \n+- https://github.com/sagemath/cypari2/pull/77\n``````\n",
    "created_at": "2019-02-19T15:39:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424090",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -31,4 +31,8 @@
     SignalError: Segmentation fault
 ```
 
-It turns out that CPython's "trashcan" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan`, see https://github.com/cython/cython/pull/2842
+It turns out that CPython's "trashcan" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2.
+
+Upstream tickets:
+- https://github.com/cython/cython/pull/2842 
+- https://github.com/sagemath/cypari2/pull/77
``````




---

archive/issue_comments_424091.json:
```json
{
    "body": "<a id='comment:37'></a>\nIt works in plain GP.",
    "created_at": "2019-02-19T17:50:30Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424091",
    "user": "https://github.com/embray"
}
```

<a id='comment:37'></a>
It works in plain GP.



---

archive/issue_comments_424092.json:
```json
{
    "body": "<a id='comment:38'></a>\nI get 5 or 6 test module segfaulting, all in `Gen.isprime`, so there's something specifically odd about that function more than others (or maybe it's just that it's used very commonly)?\n\nI don't get any segfaults anywhere else.",
    "created_at": "2019-02-19T17:56:39Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424092",
    "user": "https://github.com/embray"
}
```

<a id='comment:38'></a>
I get 5 or 6 test module segfaulting, all in `Gen.isprime`, so there's something specifically odd about that function more than others (or maybe it's just that it's used very commonly)?

I don't get any segfaults anywhere else.



---

archive/issue_comments_424093.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [jdemeyer](#comment%3A33):\n> You could try `pari(2^127 - 1).isprime()` in Sage and see whether that crashes.\n\nWhat about `pari.isprime(2^127 - 1)`?",
    "created_at": "2019-02-19T20:30:42Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424093",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>
Replying to [jdemeyer](#comment%3A33):
> You could try `pari(2^127 - 1).isprime()` in Sage and see whether that crashes.

What about `pari.isprime(2^127 - 1)`?



---

archive/issue_comments_424094.json:
```json
{
    "body": "<a id='comment:40'></a>\nAnd also try `pari(\"isprime(2^127 - 1)\")`",
    "created_at": "2019-02-19T22:04:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424094",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>
And also try `pari("isprime(2^127 - 1)")`



---

archive/issue_comments_424095.json:
```json
{
    "body": "<a id='comment:41'></a>\nAnd `pari(\"2^127 - 1\").isprime()`",
    "created_at": "2019-02-20T06:58:41Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424095",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:41'></a>
And `pari("2^127 - 1").isprime()`



---

archive/issue_comments_424096.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2019-02-20T11:14:10Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424096",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_424097.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -31,8 +31,10 @@\n     SignalError: Segmentation fault\n ```\n \n-It turns out that CPython's \"trashcan\" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2.\n+It turns out that CPython's \"trashcan\" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2. While we're at it, we upgrade to the latest Cython release\n \n-Upstream tickets:\n+**Tarball**: https://files.pythonhosted.org/packages/e0/31/4a166556f92c469d8291d4b03a187f325c773c330fffc1e798bf83d947f2/Cython-0.29.5.tar.gz\n+\n+**Upstream tickets**:\n - https://github.com/cython/cython/pull/2842 \n - https://github.com/sagemath/cypari2/pull/77\n``````\n",
    "created_at": "2019-02-20T11:14:10Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424097",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -31,8 +31,10 @@
     SignalError: Segmentation fault
 ```
 
-It turns out that CPython's "trashcan" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2.
+It turns out that CPython's "trashcan" mechanism was precisely designed to solve this problem. So we added support upstream in Cython for `@cython.trashcan` and then use that in cypari2. While we're at it, we upgrade to the latest Cython release
 
-Upstream tickets:
+**Tarball**: https://files.pythonhosted.org/packages/e0/31/4a166556f92c469d8291d4b03a187f325c773c330fffc1e798bf83d947f2/Cython-0.29.5.tar.gz
+
+**Upstream tickets**:
 - https://github.com/cython/cython/pull/2842 
 - https://github.com/sagemath/cypari2/pull/77
``````




---

archive/issue_comments_424098.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation)",
    "created_at": "2019-02-20T11:24:23Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424098",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation)



---

archive/issue_comments_424099.json:
```json
{
    "body": "**Commit:** [b6ea17ef8e4d652de0a85047bac8d41e90b25555](https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555)",
    "created_at": "2019-02-20T11:25:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424099",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [b6ea17ef8e4d652de0a85047bac8d41e90b25555](https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555)



---

archive/issue_comments_424100.json:
```json
{
    "body": "<a id='comment:44'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4569a839f070a1a38d5dbce2a4d19233d25aeed2\">4569a83</a></td><td><code>Cython 0.29.5; add trashcan patch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555\">b6ea17e</a></td><td><code>cypari2: use trashcan for Gen</code></td></tr></table>\n",
    "created_at": "2019-02-20T11:25:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424100",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:44'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4569a839f070a1a38d5dbce2a4d19233d25aeed2">4569a83</a></td><td><code>Cython 0.29.5; add trashcan patch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555">b6ea17e</a></td><td><code>cypari2: use trashcan for Gen</code></td></tr></table>




---

archive/issue_events_240834.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-20T11:25:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27267#event-240834"
}
```



---

archive/issue_comments_424101.json:
```json
{
    "body": "<a id='comment:45'></a>\nI'm a little confused by the attached tarball.  Is a Cython upgrade needed for this, or just applying the patch?",
    "created_at": "2019-02-20T12:56:42Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424101",
    "user": "https://github.com/embray"
}
```

<a id='comment:45'></a>
I'm a little confused by the attached tarball.  Is a Cython upgrade needed for this, or just applying the patch?



---

archive/issue_comments_424102.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [embray](#comment%3A45):\n> Is a Cython upgrade needed for this\n\nNo, only the patch is needed. But I thought that it would make sense to upgrade from 0.29.2 to 0.29.5 while we're updating Cython anyway.",
    "created_at": "2019-02-20T13:00:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424102",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>
Replying to [embray](#comment%3A45):
> Is a Cython upgrade needed for this

No, only the patch is needed. But I thought that it would make sense to upgrade from 0.29.2 to 0.29.5 while we're updating Cython anyway.



---

archive/issue_comments_424103.json:
```json
{
    "body": "<a id='comment:47'></a>\nI've confirmed to my satisfaction that this does fix the recursion depth issue with deallocations.  The `isprime` segfault persists, but appears to be orthogonal so I'll open a separate ticket for that.\n\nI just want to do one run of the full test suite to ensure that no other new failures occur, but otherwise this LGTM.",
    "created_at": "2019-02-21T11:24:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424103",
    "user": "https://github.com/embray"
}
```

<a id='comment:47'></a>
I've confirmed to my satisfaction that this does fix the recursion depth issue with deallocations.  The `isprime` segfault persists, but appears to be orthogonal so I'll open a separate ticket for that.

I just want to do one run of the full test suite to ensure that no other new failures occur, but otherwise this LGTM.



---

archive/issue_comments_424104.json:
```json
{
    "body": "<a id='comment:48'></a>\nOpened #27335 for the `Gen.isprime` bug.",
    "created_at": "2019-02-21T11:37:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424104",
    "user": "https://github.com/embray"
}
```

<a id='comment:48'></a>
Opened #27335 for the `Gen.isprime` bug.



---

archive/issue_comments_424105.json:
```json
{
    "body": "<a id='comment:49'></a>\nI just upgraded my Linux build to 8.7.beta5 and now I'm getting this crash in tons of places, even with \n\n```\n$ ulimit -s\n8192\n```\n\nwithout even having to try.  I will try rebasing this ticket on 8.7.beta5 and resuming...\n\nI'm pretty satisfied now that it works on Cygwin as well.",
    "created_at": "2019-02-25T14:06:38Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424105",
    "user": "https://github.com/embray"
}
```

<a id='comment:49'></a>
I just upgraded my Linux build to 8.7.beta5 and now I'm getting this crash in tons of places, even with 

```
$ ulimit -s
8192
```

without even having to try.  I will try rebasing this ticket on 8.7.beta5 and resuming...

I'm pretty satisfied now that it works on Cygwin as well.



---

archive/issue_comments_424106.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"upgrade, cython, cypari2\".",
    "created_at": "2019-02-25T17:27:38Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424106",
    "user": "https://github.com/slel"
}
```

**Changing keywords** from "" to "upgrade, cython, cypari2".



---

archive/issue_comments_424107.json:
```json
{
    "body": "<a id='comment:50'></a>\nAdding \"upgrade\" to keywords so release manager knows to upload tarball.",
    "created_at": "2019-02-25T17:27:38Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424107",
    "user": "https://github.com/slel"
}
```

<a id='comment:50'></a>
Adding "upgrade" to keywords so release manager knows to upload tarball.



---

archive/issue_comments_424108.json:
```json
{
    "body": "<a id='comment:51'></a>\n(this comment is only triggered by the mention of `cython.trashcan` -- your expertise with it here may be useful elsewhere!)\n\nI know of at least one place where cpython's trashcan is necessary in sagelib: for entries in `MonoDict` and `TripleDict` in `sage/structure/coerce_dict.pyx`. There we use `extract_mono_cell` and `extract_triple_cell` to move the relevant references to a fresh tuple and then rely on the trashcan mechanism for the deletion of tuples to avoid stack overflow. That means we are incurring the penalty of allocating an extra tuple there for deletion. If cython now exposes a way of participating in the trashcan directly, it may be worth moving that code over as well.",
    "created_at": "2019-02-25T18:01:56Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424108",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:51'></a>
(this comment is only triggered by the mention of `cython.trashcan` -- your expertise with it here may be useful elsewhere!)

I know of at least one place where cpython's trashcan is necessary in sagelib: for entries in `MonoDict` and `TripleDict` in `sage/structure/coerce_dict.pyx`. There we use `extract_mono_cell` and `extract_triple_cell` to move the relevant references to a fresh tuple and then rely on the trashcan mechanism for the deletion of tuples to avoid stack overflow. That means we are incurring the penalty of allocating an extra tuple there for deletion. If cython now exposes a way of participating in the trashcan directly, it may be worth moving that code over as well.



---

archive/issue_comments_424109.json:
```json
{
    "body": "<a id='comment:52'></a>\nFor the sake of supporting distributions, we should wait until Cython 3.0 is actually released before we use `@cython.trashcan` in the Sage library.",
    "created_at": "2019-02-25T18:55:14Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424109",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>
For the sake of supporting distributions, we should wait until Cython 3.0 is actually released before we use `@cython.trashcan` in the Sage library.



---

archive/issue_events_240835.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-26T12:35:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27267#event-240835"
}
```



---

archive/issue_events_240836.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-26T12:35:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27267#event-240836"
}
```



---

archive/issue_comments_424110.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2019-02-26T12:35:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424110",
    "user": "https://github.com/embray"
}
```

**Reviewer:** Erik Bray



---

archive/issue_comments_424111.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [jdemeyer](#comment%3A52):\n> For the sake of supporting distributions, we should wait until Cython 3.0 is actually released before we use `@cython.trashcan` in the Sage library.\n\nI agree, but how does that impact cypari2 which is a dependency of Sage anyways?",
    "created_at": "2019-02-26T12:56:17Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424111",
    "user": "https://github.com/embray"
}
```

<a id='comment:54'></a>
Replying to [jdemeyer](#comment%3A52):
> For the sake of supporting distributions, we should wait until Cython 3.0 is actually released before we use `@cython.trashcan` in the Sage library.

I agree, but how does that impact cypari2 which is a dependency of Sage anyways?



---

archive/issue_comments_424112.json:
```json
{
    "body": "<a id='comment:55'></a>\nReplying to [embray](#comment%3A54):\n> I agree, but how does that impact cypari2 which is a dependency of Sage anyways?\n\nThis ticket adds patches for both cypari2 and Cython. Distros will probably add patches to neither. Both are acceptable.",
    "created_at": "2019-02-26T13:01:15Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424112",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>
Replying to [embray](#comment%3A54):
> I agree, but how does that impact cypari2 which is a dependency of Sage anyways?

This ticket adds patches for both cypari2 and Cython. Distros will probably add patches to neither. Both are acceptable.



---

archive/issue_events_240837.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-28T17:54:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27267#event-240837"
}
```



---

archive/issue_events_240838.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "b58cc7859497d24b063c749ab9a467fb51f6ddec",
    "created_at": "2019-02-28T17:54:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27267#event-240838"
}
```



---

archive/issue_comments_424113.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation)\" to \"[b6ea17ef8e4d652de0a85047bac8d41e90b25555](https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555)\".",
    "created_at": "2019-02-28T17:54:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27267",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27267#issuecomment-424113",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/segfaults_in_cypari2_when_running_out_of_stack_during_deep_object_deallocation)" to "[b6ea17ef8e4d652de0a85047bac8d41e90b25555](https://github.com/sagemath/sagetrac-mirror/commit/b6ea17ef8e4d652de0a85047bac8d41e90b25555)".
