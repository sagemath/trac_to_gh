# Issue 27724: GAP Bernoulli function crashes on Cygwin with system GMP

archive/issues_027487.json:
```json
{
    "assignees": [
        "https://github.com/embray"
    ],
    "body": "It is crashing in various different (depending on the arguments I give) GMP functions for large integers, with segmentation faults in the assembly code.\n\nThe situation is bad enough that it causes irrecoverable stack corruption and the process dies without Cygwin's exception handling even able to run.  I don't know that the problem is likely anything specifically to do with the `Bernoulli` function--that's just the context in which I've been able to reproduce the problem reliably.\n\nFor the most part GAP otherwise works fine and most operations do not cause any problems at all, so it is likely a narrow case.  Also strangely, if I remove the `-m 64m` flag when running GAP (a default argument used when running `sage -gap`) the crash does not occur.  Likewise if I provide a larger value like `-m 128m` it does not occur.  I need to double-check exactly what the effect of this argument is.\n\nIn the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.\n\n**Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434\n\n**Upstream PR for GAP:** https://github.com/gap-system/gap/pull/3435\n\nCC:  @slel\n\nKeywords: **cygwin gap gmp**\n\nBranch/Commit: **[`1077f3d`](https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42)**\n\nUpstream: **Fixed upstream, in a later stable release.**\n\nReviewer: **Samuel Leli\u00e8vre**\n\nAuthor: **Erik Bray**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27724_\n\n",
    "closed_at": "2019-08-16T22:26:39Z",
    "created_at": "2019-04-25T12:08:14Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "GAP Bernoulli function crashes on Cygwin with system GMP",
    "type": "issue",
    "updated_at": "2019-08-16T22:26:39Z",
    "url": "https://github.com/sagemath/sage/issues/27724",
    "user": "https://github.com/embray"
}
```
It is crashing in various different (depending on the arguments I give) GMP functions for large integers, with segmentation faults in the assembly code.

The situation is bad enough that it causes irrecoverable stack corruption and the process dies without Cygwin's exception handling even able to run.  I don't know that the problem is likely anything specifically to do with the `Bernoulli` function--that's just the context in which I've been able to reproduce the problem reliably.

For the most part GAP otherwise works fine and most operations do not cause any problems at all, so it is likely a narrow case.  Also strangely, if I remove the `-m 64m` flag when running GAP (a default argument used when running `sage -gap`) the crash does not occur.  Likewise if I provide a larger value like `-m 128m` it does not occur.  I need to double-check exactly what the effect of this argument is.

In the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.

**Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434

**Upstream PR for GAP:** https://github.com/gap-system/gap/pull/3435

CC:  @slel

Keywords: **cygwin gap gmp**

Branch/Commit: **[`1077f3d`](https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42)**

Upstream: **Fixed upstream, in a later stable release.**

Reviewer: **Samuel Leli√®vre**

Author: **Erik Bray**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/27724_





---

archive/issue_events_377388.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-25T12:08:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377388"
}
```



---

archive/issue_events_377389.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-25T12:08:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "0000b0",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377389"
}
```



---

archive/issue_events_377390.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-25T12:08:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377390"
}
```



---

archive/issue_events_377391.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-25T12:08:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377391"
}
```



---

archive/issue_events_377392.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-25T12:08:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377392"
}
```



---

archive/issue_events_377393.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-25T12:08:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377393"
}
```



---

archive/issue_comments_429687.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nThe reason this occurs specifically with `Bernoulli` makes sense to me now, as does the interaction with the `-m` flag.  GAP memoizes each subresult, so computing something like `Bernoulli(1724)` probably hits GAP's initial workspace size requiring some reallocation (though I'm not sure what the implication of this is in the context of it using an mmap'd memory pool.\n\nThis is the point at which it crashes. Still not sure why though, since any memory allocation would be happening at the point of trying to allocate a new Bag, at which point it should just work.  But the crashes are happening inside GMP functions.  Maybe somehow reallocating moves some bags around that contain data still being used by GMP? I'm not sure.",
    "created_at": "2019-04-26T16:04:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429687",
    "user": "https://github.com/embray"
}
```

<div id="comment:2" align="right">comment:2</div>

The reason this occurs specifically with `Bernoulli` makes sense to me now, as does the interaction with the `-m` flag.  GAP memoizes each subresult, so computing something like `Bernoulli(1724)` probably hits GAP's initial workspace size requiring some reallocation (though I'm not sure what the implication of this is in the context of it using an mmap'd memory pool.

This is the point at which it crashes. Still not sure why though, since any memory allocation would be happening at the point of trying to allocate a new Bag, at which point it should just work.  But the crashes are happening inside GMP functions.  Maybe somehow reallocating moves some bags around that contain data still being used by GMP? I'm not sure.



---

archive/issue_comments_429688.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI think this might be a reprise of #27214.  The problem, *I think* seems to be that GMP's assembly routines are confusing Windows' stack unwinding on exceptions, and thus preventing the Cygwin exception handler from being called.",
    "created_at": "2019-04-29T10:38:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429688",
    "user": "https://github.com/embray"
}
```

<div id="comment:3" align="right">comment:3</div>

I think this might be a reprise of #27214.  The problem, *I think* seems to be that GMP's assembly routines are confusing Windows' stack unwinding on exceptions, and thus preventing the Cygwin exception handler from being called.



---

archive/issue_comments_429689.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIndeed, I can demonstrate the problem with this example code:\n\n```\n$ cat test.c\n```\n\n```c\n#include <gmp.h>\n#include <stdlib.h>\n\n\nint main(void) {\n    mp_limb_t *rlp;\n    mp_size_t qxn = 0;\n    mp_limb_t s2p[1] = {0};\n    mp_size_t s2n = 1;\n    mp_limb_t s3limb = 1;\n\n    /* Use of this function in particular is arbitrary aside from\n     * the fact that it is known to demonstrate the problem on my\n     * system (my system uses an assembly implementation for it)\n     */\n\n    /* Just set to something that will segfault when accessed */\n    rlp = (mp_limb_t*)0x1234;\n    mpn_divrem_1(rlp, qxn, s2p, s2n, s3limb);\n    return 1;\n}\n```\n\n```\n$ gcc test.c -lgmp\n$ ./a.exe && echo $?\n0\n```\n\nIt *should* print that it got a SIGSEGV and exit with the corresponding exit code (139).  A \"normal\" program dereferencing an invalid pointer will do this just fine on Cygwin.  Instead, it just exits 0, which is the (somewhat unfortunate) behavior when a program crashes outside Cygwin's control.  If I run it in gdb I do see that an access violation occurs inside the assembly implementation of `mpn_divrem_1` when it first tries to write something to `*rlp`.\n\nI've been experimenting with this a bit further trying to understand exactly where things are going wrong, and while it's still not 100% clear to me it might actually be a bug in the NT kernel, or at least tripping some exceptional behavior *in* exception handling (or maybe a subtle bug in Cygwin related to this).\n\nWhat I found so far is that in GMP's assembly code it's actually using the `%rbp` register just as a normal register in its calculations.  It saves the old value on the stack and pops it at the end, but this obviously doesn't help if an exception occurs in the function body.  It seems that the NT exception handling code *hates* this.  Indeed I can take a relatively \"innocent\" program that generates a segfault like:\n\n```\n$cat test3.c\n```\n\n```c\n#include <stdlib.h>\n\n\nvoid foo() {\n    volatile int *i = (int *)0xffffffff;\n    *i = 0;\n}\n\n\nint main(void) {\n    foo();\n    return 1;\n}\n```\n\nand modify it like\n\n```\n$cat test4.c\n```\n\n```c\n#include <stdlib.h>\n\n\nvoid foo() {\n    volatile int *i = (int *)0xffffffff;\n    /* First let's do something weird to rbp, just to check a theory... */\n    asm(\"mov $0, %rbp\");\n    *i = 0;\n}\n\n\nint main(void) {\n    foo();\n    return 1;\n}\n```\n\nI compile this like\n\n```\n$ gcc -fomit-frame-pointer test4.c\n```\n\nso that it doesn't even use `%rbp` in the function prologue and doesn't use it to address local variables, so the disassembly of `foo` in this case looks like:\n\n```\n0000000000000000 <foo>:\n   0:   48 83 ec 18             sub    $0x18,%rsp\n   4:   b8 ff ff ff ff          mov    $0xffffffff,%eax\n   9:   48 89 44 24 08          mov    %rax,0x8(%rsp)\n   e:   48 c7 c5 00 00 00 00    mov    $0x0,%rbp\n  15:   48 8b 44 24 08          mov    0x8(%rsp),%rax\n  1a:   c7 00 00 00 00 00       movl   $0x0,(%rax)\n  20:   90                      nop\n  21:   48 83 c4 18             add    $0x18,%rsp\n  25:   c3                      retq\n```\n\nso it's not even using `%rbp` (ditto in `main`) except where I set it to zero.\n\nOf course, in Cygwin, by the time the `main` function is called there are actually several layers of initialization before that which are quite complex, at the top of which is where Cygwin's exception handler is installed. So of course when entering `main` the value of `%rbp` is certainly meaningful for walking back up the stack to the frame the exception handler is installed for.\n\nHow exactly Windows does this I'm not sure, but what I do know is when setting `%rbp` to some bogus value I actually get a second access violation somewhere in a kernel function called `RtlWalkFrameChain` which is called by `KiUserExceptionDispatcher` (this I know is the function that locates and dispatches user-mode exception handlers, hence the name).  The fact that `RtlWalkFrameChain` itself blows up feels like a bug to me, though obviously by messing with `%rbp` we're violating some assumption it's making.  This in turn results in re-entering `KiUserExceptionDispatcher` in an infinite recursion, because it keeps blowing up in `RtlWalkFrameChain`, until I guess the stack overflows and the kernel gives up on user-mode exception handling and just kills the process. I need to refresh my memory on how exactly this works, as I know a lot of it has been reverse-engineered.\n\nRegardless, the moral of the story is don't abuse `%rbp` if you expect exception handling to work properly.  This is a problem for GMP...",
    "created_at": "2019-04-29T18:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429689",
    "user": "https://github.com/embray"
}
```

<div id="comment:4" align="right">comment:4</div>

Indeed, I can demonstrate the problem with this example code:

```
$ cat test.c
```

```c
#include <gmp.h>
#include <stdlib.h>


int main(void) {
    mp_limb_t *rlp;
    mp_size_t qxn = 0;
    mp_limb_t s2p[1] = {0};
    mp_size_t s2n = 1;
    mp_limb_t s3limb = 1;

    /* Use of this function in particular is arbitrary aside from
     * the fact that it is known to demonstrate the problem on my
     * system (my system uses an assembly implementation for it)
     */

    /* Just set to something that will segfault when accessed */
    rlp = (mp_limb_t*)0x1234;
    mpn_divrem_1(rlp, qxn, s2p, s2n, s3limb);
    return 1;
}
```

```
$ gcc test.c -lgmp
$ ./a.exe && echo $?
0
```

It *should* print that it got a SIGSEGV and exit with the corresponding exit code (139).  A "normal" program dereferencing an invalid pointer will do this just fine on Cygwin.  Instead, it just exits 0, which is the (somewhat unfortunate) behavior when a program crashes outside Cygwin's control.  If I run it in gdb I do see that an access violation occurs inside the assembly implementation of `mpn_divrem_1` when it first tries to write something to `*rlp`.

I've been experimenting with this a bit further trying to understand exactly where things are going wrong, and while it's still not 100% clear to me it might actually be a bug in the NT kernel, or at least tripping some exceptional behavior *in* exception handling (or maybe a subtle bug in Cygwin related to this).

What I found so far is that in GMP's assembly code it's actually using the `%rbp` register just as a normal register in its calculations.  It saves the old value on the stack and pops it at the end, but this obviously doesn't help if an exception occurs in the function body.  It seems that the NT exception handling code *hates* this.  Indeed I can take a relatively "innocent" program that generates a segfault like:

```
$cat test3.c
```

```c
#include <stdlib.h>


void foo() {
    volatile int *i = (int *)0xffffffff;
    *i = 0;
}


int main(void) {
    foo();
    return 1;
}
```

and modify it like

```
$cat test4.c
```

```c
#include <stdlib.h>


void foo() {
    volatile int *i = (int *)0xffffffff;
    /* First let's do something weird to rbp, just to check a theory... */
    asm("mov $0, %rbp");
    *i = 0;
}


int main(void) {
    foo();
    return 1;
}
```

I compile this like

```
$ gcc -fomit-frame-pointer test4.c
```

so that it doesn't even use `%rbp` in the function prologue and doesn't use it to address local variables, so the disassembly of `foo` in this case looks like:

```
0000000000000000 <foo>:
   0:   48 83 ec 18             sub    $0x18,%rsp
   4:   b8 ff ff ff ff          mov    $0xffffffff,%eax
   9:   48 89 44 24 08          mov    %rax,0x8(%rsp)
   e:   48 c7 c5 00 00 00 00    mov    $0x0,%rbp
  15:   48 8b 44 24 08          mov    0x8(%rsp),%rax
  1a:   c7 00 00 00 00 00       movl   $0x0,(%rax)
  20:   90                      nop
  21:   48 83 c4 18             add    $0x18,%rsp
  25:   c3                      retq
```

so it's not even using `%rbp` (ditto in `main`) except where I set it to zero.

Of course, in Cygwin, by the time the `main` function is called there are actually several layers of initialization before that which are quite complex, at the top of which is where Cygwin's exception handler is installed. So of course when entering `main` the value of `%rbp` is certainly meaningful for walking back up the stack to the frame the exception handler is installed for.

How exactly Windows does this I'm not sure, but what I do know is when setting `%rbp` to some bogus value I actually get a second access violation somewhere in a kernel function called `RtlWalkFrameChain` which is called by `KiUserExceptionDispatcher` (this I know is the function that locates and dispatches user-mode exception handlers, hence the name).  The fact that `RtlWalkFrameChain` itself blows up feels like a bug to me, though obviously by messing with `%rbp` we're violating some assumption it's making.  This in turn results in re-entering `KiUserExceptionDispatcher` in an infinite recursion, because it keeps blowing up in `RtlWalkFrameChain`, until I guess the stack overflows and the kernel gives up on user-mode exception handling and just kills the process. I need to refresh my memory on how exactly this works, as I know a lot of it has been reverse-engineered.

Regardless, the moral of the story is don't abuse `%rbp` if you expect exception handling to work properly.  This is a problem for GMP...



---

archive/issue_comments_429690.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI think I see now why it's so hell-bent on RBP: For every the compiler generates an entry in the `.xdata` section (\"x\" for \"exception\" I guess) of the PE32 binary, which is a table of `UNWIND_INFO` structures explained here: https://docs.microsoft.com/en-us/cpp/build/exception-handling-x64?view=vs-2019#raw-pseudo-operations\n\nEach `UNWIND_INFO` includes an array of special opcodes that explains how that function's frame is set up:\n\n> An array of items that explains the effect of the prolog on the nonvolatile registers and RSP.\n\nIt also has a \"frame register\" field which is non-zero if the function does use a frame pointer like RBP:\n\n> If nonzero, then the function uses a frame pointer (FP), and this field is the number of the nonvolatile register used as the frame pointer, using the same encoding for the operation info field of UNWIND_CODE nodes.\n\nYou can use the `dumpbin` utility to view these sections, and indeed running it on `cygwin1.dll` and finding the `UNWIND_INFO` structure for `_cygtls::call` (which is essentially the entrypoint to a Cygwin executable's main thread, and where the exception handler is installed) shows:\n\n```\n  00000618 00006E70 00006F77 0026A51C  _ZN7_cygtls5call2EPFjPvS0_ES0_S0_\n    Unwind version: 1\n    Unwind flags: None\n    Size of prologue: 0x0D\n    Count of codes: 7\n    Frame register: rbp\n    Frame offset: 0x0\n    Unwind codes:\n      0D: ALLOC_SMALL, size=0x20\n      09: SET_FPREG, register=rbp, offset=0x00\n      06: PUSH_NONVOL, register=rbx\n      05: PUSH_NONVOL, register=rsi\n      04: PUSH_NONVOL, register=rdi\n      03: PUSH_NONVOL, register=r12\n      01: PUSH_NONVOL, register=rbp\n```\n\nThese opcodes basically tell the stack unwinder exactly what it needs to back out of each function on stack until it gets back to the frame where the exception will be handled.\n\nIn GCC there are equivalent pseudo-operations that can be used in assembly (I have seen these before but wasn't really sure how they work) named `.seh_*` which are used for generating these `.pdata` and `.xdata` entries for each function in the object file.  You can see these directly in the GCC assembly output on Windows.  For example for my `test3.c` above it outputs:\n\n```\n        .globl  foo\n        .def    foo;    .scl    2;      .type   32;     .endef\n        .seh_proc       foo\nfoo:\n        pushq   %rbp\n        .seh_pushreg    %rbp\n        movq    %rsp, %rbp\n        .seh_setframe   %rbp, 0\n        subq    $16, %rsp\n        .seh_stackalloc 16\n        .seh_endprologue\n        movl    $4294967295, %eax\n...\n```\n\nThis explicitly delineates which instructions comprise the function's prologue and what they do: push register RBP on the stack, set a frame pointer at 0 offst from RBP, allocate 16 bytes on the stack.\n\nIf assembled with the `-fomit-frame-pointer` flag it's even simpler, as to be expected:\n\n```\n        .globl  foo\n        .def    foo;    .scl    2;      .type   32;     .endef\n        .seh_proc       foo\nfoo:\n        subq    $24, %rsp\n        .seh_stackalloc 24\n        .seh_endprologue\n        movl    $4294967295, %eax\n...\n```\n\ni.e. just allocate 24 bytes on the stack.\n\nI hand modified the assembly for `test4.c` above so that `foo` is defined:\n\n```\n        .globl  foo\n        .def    foo;    .scl    2;      .type   32;     .endef\n        .seh_proc       foo\nfoo:\n        pushq   %rbp\n        .seh_pushreg    %rbp\n        subq    $24, %rsp\n        .seh_stackalloc 24\n        .seh_endprologue\n        movl    $4294967295, %eax\n        movq    %rax, 8(%rsp)\n        mov $0, %rbp\n        movq    8(%rsp), %rax\n        movl    $0, (%rax)\n        nop\n        addq    $24, %rsp\n        popq    %rbp\n        ret\n        .seh_endproc\n```\n\nSo it notes explicitly that `%rbp` is a non-volatile register that should be saved (it doesn't say anything about it serving in this function as a frame pointer in the case of this function).\n\nBut with this bit in place (and it *must* include the `.seh_pushreg` or else it doesn't work) the kernel can successfully unwind the stack to where the exception is handled by Cygwin.\n\nSo this is what the assembly code in GMP should be doing, but isn't.  I'll propose a patch for that and see if I can get it into Cygwin's GMP package if nothing else.  In the meantime I'd need another workaround...",
    "created_at": "2019-04-30T09:17:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429690",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

I think I see now why it's so hell-bent on RBP: For every the compiler generates an entry in the `.xdata` section ("x" for "exception" I guess) of the PE32 binary, which is a table of `UNWIND_INFO` structures explained here: https://docs.microsoft.com/en-us/cpp/build/exception-handling-x64?view=vs-2019#raw-pseudo-operations

Each `UNWIND_INFO` includes an array of special opcodes that explains how that function's frame is set up:

> An array of items that explains the effect of the prolog on the nonvolatile registers and RSP.

It also has a "frame register" field which is non-zero if the function does use a frame pointer like RBP:

> If nonzero, then the function uses a frame pointer (FP), and this field is the number of the nonvolatile register used as the frame pointer, using the same encoding for the operation info field of UNWIND_CODE nodes.

You can use the `dumpbin` utility to view these sections, and indeed running it on `cygwin1.dll` and finding the `UNWIND_INFO` structure for `_cygtls::call` (which is essentially the entrypoint to a Cygwin executable's main thread, and where the exception handler is installed) shows:

```
  00000618 00006E70 00006F77 0026A51C  _ZN7_cygtls5call2EPFjPvS0_ES0_S0_
    Unwind version: 1
    Unwind flags: None
    Size of prologue: 0x0D
    Count of codes: 7
    Frame register: rbp
    Frame offset: 0x0
    Unwind codes:
      0D: ALLOC_SMALL, size=0x20
      09: SET_FPREG, register=rbp, offset=0x00
      06: PUSH_NONVOL, register=rbx
      05: PUSH_NONVOL, register=rsi
      04: PUSH_NONVOL, register=rdi
      03: PUSH_NONVOL, register=r12
      01: PUSH_NONVOL, register=rbp
```

These opcodes basically tell the stack unwinder exactly what it needs to back out of each function on stack until it gets back to the frame where the exception will be handled.

In GCC there are equivalent pseudo-operations that can be used in assembly (I have seen these before but wasn't really sure how they work) named `.seh_*` which are used for generating these `.pdata` and `.xdata` entries for each function in the object file.  You can see these directly in the GCC assembly output on Windows.  For example for my `test3.c` above it outputs:

```
        .globl  foo
        .def    foo;    .scl    2;      .type   32;     .endef
        .seh_proc       foo
foo:
        pushq   %rbp
        .seh_pushreg    %rbp
        movq    %rsp, %rbp
        .seh_setframe   %rbp, 0
        subq    $16, %rsp
        .seh_stackalloc 16
        .seh_endprologue
        movl    $4294967295, %eax
...
```

This explicitly delineates which instructions comprise the function's prologue and what they do: push register RBP on the stack, set a frame pointer at 0 offst from RBP, allocate 16 bytes on the stack.

If assembled with the `-fomit-frame-pointer` flag it's even simpler, as to be expected:

```
        .globl  foo
        .def    foo;    .scl    2;      .type   32;     .endef
        .seh_proc       foo
foo:
        subq    $24, %rsp
        .seh_stackalloc 24
        .seh_endprologue
        movl    $4294967295, %eax
...
```

i.e. just allocate 24 bytes on the stack.

I hand modified the assembly for `test4.c` above so that `foo` is defined:

```
        .globl  foo
        .def    foo;    .scl    2;      .type   32;     .endef
        .seh_proc       foo
foo:
        pushq   %rbp
        .seh_pushreg    %rbp
        subq    $24, %rsp
        .seh_stackalloc 24
        .seh_endprologue
        movl    $4294967295, %eax
        movq    %rax, 8(%rsp)
        mov $0, %rbp
        movq    8(%rsp), %rax
        movl    $0, (%rax)
        nop
        addq    $24, %rsp
        popq    %rbp
        ret
        .seh_endproc
```

So it notes explicitly that `%rbp` is a non-volatile register that should be saved (it doesn't say anything about it serving in this function as a frame pointer in the case of this function).

But with this bit in place (and it *must* include the `.seh_pushreg` or else it doesn't work) the kernel can successfully unwind the stack to where the exception is handled by Cygwin.

So this is what the assembly code in GMP should be doing, but isn't.  I'll propose a patch for that and see if I can get it into Cygwin's GMP package if nothing else.  In the meantime I'd need another workaround...



---

archive/issue_comments_429691.json:
```json
{
    "body": "Changed keywords from none to **cygwin gap gmp**",
    "created_at": "2019-05-02T11:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429691",
    "user": "https://github.com/embray"
}
```

Changed keywords from none to **cygwin gap gmp**



---

archive/issue_events_377394.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-02T11:19:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting%3A%20cygwin",
    "label_color": "0000b0",
    "label_name": "c: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377394"
}
```



---

archive/issue_comments_429692.json:
```json
{
    "body": "Upstream: **Reported upstream. Developers acknowledge bug.**",
    "created_at": "2019-05-02T11:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429692",
    "user": "https://github.com/embray"
}
```

Upstream: **Reported upstream. Developers acknowledge bug.**



---

archive/issue_comments_429693.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,3 +5,5 @@\n For the most part GAP otherwise works fine and most operations do not cause any problems at all, so it is likely a narrow case.  Also strangely, if I remove the `-m 64m` flag when running GAP (a default argument used when running `sage -gap`) the crash does not occur.  Likewise if I provide a larger value like `-m 128m` it does not occur.  I need to double-check exactly what the effect of this argument is.\n \n In the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.\n+\n+**Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434\n``````\n",
    "created_at": "2019-05-02T11:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429693",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,3 +5,5 @@
 For the most part GAP otherwise works fine and most operations do not cause any problems at all, so it is likely a narrow case.  Also strangely, if I remove the `-m 64m` flag when running GAP (a default argument used when running `sage -gap`) the crash does not occur.  Likewise if I provide a larger value like `-m 128m` it does not occur.  I need to double-check exactly what the effect of this argument is.
 
 In the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.
+
+**Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434
``````




---

archive/issue_comments_429694.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nAdded an issue for this on GAP.  Have already discussed the issue on Slack some with Chris Jefferson who acknowledges the bug and that it would be good to try to work around in GAP, although we haven't actually attempted a workaround yet.",
    "created_at": "2019-05-02T11:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429694",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

Added an issue for this on GAP.  Have already discussed the issue on Slack some with Chris Jefferson who acknowledges the bug and that it would be good to try to work around in GAP, although we haven't actually attempted a workaround yet.



---

archive/issue_comments_429695.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nHere is a branch that adds my latest patch to GAP for Cygwin.\n\nIt is based on my PR, but backported for the 4.10-stable branch so that it applies to the current GAP used in Sage.  This approach to fixing the issue hasn't been approved upstream yet so I would hold off on merging this until there's been more time for things to settle.\n\nBut I can confirm that this does fix (or at least successfully work around) the problem for me in all known cases so it would still be good to include this if it is not fixed soon in GAP.\n\nI'll also note that this patch has no impact on other platforms, so it is not a runtime requirement for GAP on any other platform.",
    "created_at": "2019-05-02T16:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429695",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Here is a branch that adds my latest patch to GAP for Cygwin.

It is based on my PR, but backported for the 4.10-stable branch so that it applies to the current GAP used in Sage.  This approach to fixing the issue hasn't been approved upstream yet so I would hold off on merging this until there's been more time for things to settle.

But I can confirm that this does fix (or at least successfully work around) the problem for me in all known cases so it would still be good to include this if it is not fixed soon in GAP.

I'll also note that this patch has no impact on other platforms, so it is not a runtime requirement for GAP on any other platform.



---

archive/issue_comments_429696.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2019-05-02T16:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429696",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_comments_429697.json:
```json
{
    "body": "Branch: **[u/embray/cygwin/ticket-27724](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-27724)**",
    "created_at": "2019-05-02T16:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429697",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/cygwin/ticket-27724](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-27724)**



---

archive/issue_events_377395.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-02T16:39:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377395"
}
```



---

archive/issue_comments_429698.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,3 +7,4 @@\n In the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.\n \n **Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434\n+**Upstream PR for GAP:** https://github.com/gap-system/gap/pull/3435\n``````\n",
    "created_at": "2019-05-02T16:39:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429698",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,3 +7,4 @@
 In the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.
 
 **Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434
+**Upstream PR for GAP:** https://github.com/gap-system/gap/pull/3435
``````




---

archive/issue_comments_429699.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,4 +7,5 @@\n In the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.\n \n **Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434\n+\n **Upstream PR for GAP:** https://github.com/gap-system/gap/pull/3435\n``````\n",
    "created_at": "2019-05-02T16:40:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429699",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,4 +7,5 @@
 In the meantime, between this and #27721 it might be a good idea to disable use of the system GMP on Cygwin altogether until and unless I can get to the bottom of this.
 
 **Upstream issue for GAP:** https://github.com/gap-system/gap/issues/3434
+
 **Upstream PR for GAP:** https://github.com/gap-system/gap/pull/3435
``````




---

archive/issue_comments_429700.json:
```json
{
    "body": "Commit: **[`067183f`](https://github.com/sagemath/sagetrac-mirror/commit/067183f76791cf218fa2d4f32fea9bcade5fd427)**",
    "created_at": "2019-05-02T16:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429700",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`067183f`](https://github.com/sagemath/sagetrac-mirror/commit/067183f76791cf218fa2d4f32fea9bcade5fd427)**



---

archive/issue_comments_429701.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/067183f76791cf218fa2d4f32fea9bcade5fd427\"><code>067183f</code></a></td><td><code>Trac #27724: Include patch from upstream PR to workaround possible</code></td></tr></table>\n",
    "created_at": "2019-05-02T16:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429701",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/067183f76791cf218fa2d4f32fea9bcade5fd427"><code>067183f</code></a></td><td><code>Trac #27724: Include patch from upstream PR to workaround possible</code></td></tr></table>




---

archive/issue_comments_429702.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nJust as a note, it turns out this problem is long-since fixed in MPIR due in large part to its adoption of YASM, which in turn has implicit support for SEH on x64 Windows (which MPIR makes proper use of).\n\nWhile I would like to get this problem fixed back in the original GMP as well and am willing to work on it, it might be easier just to package MPIR for Cygwin (and furthermore, try to convince Cygwin to use MPIR as its default GMP implementation).  Part of the reason MPIR exists has always been its dedicated Windows support so this might make sense.",
    "created_at": "2019-05-02T17:18:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429702",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

Just as a note, it turns out this problem is long-since fixed in MPIR due in large part to its adoption of YASM, which in turn has implicit support for SEH on x64 Windows (which MPIR makes proper use of).

While I would like to get this problem fixed back in the original GMP as well and am willing to work on it, it might be easier just to package MPIR for Cygwin (and furthermore, try to convince Cygwin to use MPIR as its default GMP implementation).  Part of the reason MPIR exists has always been its dedicated Windows support so this might make sense.



---

archive/issue_comments_429703.json:
```json
{
    "body": "Changed upstream from **Reported upstream. Developers acknowledge bug.** to **Fixed upstream, in a later stable release.**",
    "created_at": "2019-05-08T08:57:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429703",
    "user": "https://github.com/dimpase"
}
```

Changed upstream from **Reported upstream. Developers acknowledge bug.** to **Fixed upstream, in a later stable release.**



---

archive/issue_comments_429704.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nupstream says OK, as far as I can see. Should we go ahead and merge this?",
    "created_at": "2019-05-08T08:57:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429704",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:11" align="right">comment:11</div>

upstream says OK, as far as I can see. Should we go ahead and merge this?



---

archive/issue_comments_429705.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI need to update the patch to match the version that was accepted, but then yes, it would be good to merge this.",
    "created_at": "2019-05-09T15:23:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429705",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

I need to update the patch to match the version that was accepted, but then yes, it would be good to merge this.



---

archive/issue_events_377396.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-09T15:23:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377396"
}
```



---

archive/issue_events_377397.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-09T15:23:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377397"
}
```



---

archive/issue_events_377398.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-09T15:23:57Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "subject": "https://github.com/embray",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377398"
}
```



---

archive/issue_comments_429706.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/13e17989753443bf8a5b46334c59e472eeacce7c\"><code>13e1798</code></a></td><td><code>Trac #27724: Include patch from upstream PR to workaround possible</code></td></tr></table>\n",
    "created_at": "2019-06-07T15:09:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429706",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/13e17989753443bf8a5b46334c59e472eeacce7c"><code>13e1798</code></a></td><td><code>Trac #27724: Include patch from upstream PR to workaround possible</code></td></tr></table>




---

archive/issue_comments_429707.json:
```json
{
    "body": "Changed commit from **[`067183f`](https://github.com/sagemath/sagetrac-mirror/commit/067183f76791cf218fa2d4f32fea9bcade5fd427)** to **[`13e1798`](https://github.com/sagemath/sagetrac-mirror/commit/13e17989753443bf8a5b46334c59e472eeacce7c)**",
    "created_at": "2019-06-07T15:09:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429707",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`067183f`](https://github.com/sagemath/sagetrac-mirror/commit/067183f76791cf218fa2d4f32fea9bcade5fd427)** to **[`13e1798`](https://github.com/sagemath/sagetrac-mirror/commit/13e17989753443bf8a5b46334c59e472eeacce7c)**



---

archive/issue_events_377399.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-07T15:10:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377399"
}
```



---

archive/issue_events_377400.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-07T15:10:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377400"
}
```



---

archive/issue_comments_429708.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nUpdated patch to the version accepted upstream.  This should be ready to go.",
    "created_at": "2019-06-07T15:10:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429708",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

Updated patch to the version accepted upstream.  This should be ready to go.



---

archive/issue_events_377401.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377401"
}
```



---

archive/issue_events_377402.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377402"
}
```



---

archive/issue_comments_429709.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nMoving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429709",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_events_377403.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2019-08-08T13:40:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377403"
}
```



---

archive/issue_events_377404.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2019-08-08T13:40:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377404"
}
```



---

archive/issue_comments_429710.json:
```json
{
    "body": "Reviewer: **Samuel Leli\u00e8vre**",
    "created_at": "2019-08-08T13:40:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429710",
    "user": "https://github.com/slel"
}
```

Reviewer: **Samuel Leli√®vre**



---

archive/issue_comments_429711.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThis will be in GAP 4.11 but was not backported to GAP 4.10.2, see:\n\n- https://github.com/gap-system/gap/pull/3435/files\n- https://github.com/gap-system/gap/blob/stable-4.10/src/integer.c#L144\n- https://github.com/gap-system/gap/blob/master/src/integer.c#L144\n\nso let's get this in here. Positive review.",
    "created_at": "2019-08-08T13:40:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429711",
    "user": "https://github.com/slel"
}
```

<div id="comment:18" align="right">comment:18</div>

This will be in GAP 4.11 but was not backported to GAP 4.10.2, see:

- https://github.com/gap-system/gap/pull/3435/files
- https://github.com/gap-system/gap/blob/stable-4.10/src/integer.c#L144
- https://github.com/gap-system/gap/blob/master/src/integer.c#L144

so let's get this in here. Positive review.



---

archive/issue_events_377405.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-08T22:52:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377405"
}
```



---

archive/issue_events_377406.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-08T22:52:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377406"
}
```



---

archive/issue_comments_429712.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nMerge conflict",
    "created_at": "2019-08-08T22:52:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429712",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

Merge conflict



---

archive/issue_comments_429713.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nSorry I missed one detail. The branch refers to GAP 4.10.1 but we now have GAP 4.10.2,\nso the file `build/pkgs/gap/package-version.txt` should read `4.10.2.p1` instead of `4.10.1.p1`.\n\nI tested on Cygwin on Windows 7 that Sage builds fine if that change is made. Please @embray\ncan you make that change? You can then set to positive review on my behalf.",
    "created_at": "2019-08-11T10:05:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429713",
    "user": "https://github.com/slel"
}
```

<div id="comment:20" align="right">comment:20</div>

Sorry I missed one detail. The branch refers to GAP 4.10.1 but we now have GAP 4.10.2,
so the file `build/pkgs/gap/package-version.txt` should read `4.10.2.p1` instead of `4.10.1.p1`.

I tested on Cygwin on Windows 7 that Sage builds fine if that change is made. Please @embray
can you make that change? You can then set to positive review on my behalf.



---

archive/issue_comments_429714.json:
```json
{
    "body": "Changed commit from **[`13e1798`](https://github.com/sagemath/sagetrac-mirror/commit/13e17989753443bf8a5b46334c59e472eeacce7c)** to **[`1077f3d`](https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42)**",
    "created_at": "2019-08-15T13:57:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429714",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`13e1798`](https://github.com/sagemath/sagetrac-mirror/commit/13e17989753443bf8a5b46334c59e472eeacce7c)** to **[`1077f3d`](https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42)**



---

archive/issue_comments_429715.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42\"><code>1077f3d</code></a></td><td><code>Trac #27724: Include patch from upstream PR to workaround possible</code></td></tr></table>\n",
    "created_at": "2019-08-15T13:57:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429715",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42"><code>1077f3d</code></a></td><td><code>Trac #27724: Include patch from upstream PR to workaround possible</code></td></tr></table>




---

archive/issue_events_377407.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-08-15T13:57:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377407"
}
```



---

archive/issue_events_377408.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-08-15T13:57:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377408"
}
```



---

archive/issue_comments_429716.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nRebased, and confirmed that the patch still applies.",
    "created_at": "2019-08-15T13:57:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429716",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

Rebased, and confirmed that the patch still applies.



---

archive/issue_comments_429717.json:
```json
{
    "body": "Changed branch from **[u/embray/cygwin/ticket-27724](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-27724)** to **[`1077f3d`](https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42)**",
    "created_at": "2019-08-16T22:26:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27724#issuecomment-429717",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/cygwin/ticket-27724](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/cygwin/ticket-27724)** to **[`1077f3d`](https://github.com/sagemath/sagetrac-mirror/commit/1077f3d0fc76bbfba36327f703762caf3f731c42)**



---

archive/issue_events_377409.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-16T22:26:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377409"
}
```



---

archive/issue_events_377410.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "2ea8fa1d964666feb1a16fb49655f54a8635dd01",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-08-16T22:26:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27724",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27724#event-377410"
}
```
