# Issue 27635: Allow tests that are specific to Sage's build system to be skipped

archive/issues_027398.json:
```json
{
    "assignees": [],
    "body": "Adds an 'optional' tag called 'build' (name to be bikeshedded if necessary) specifically for tests related to sage-the-distribution and Sage's build system.\n\nThis allows downstream distributions that package Sage differently to skip these tests, but they are enabled by default when the tests are run from a build in Sage's source repository.\n\nThis provides a possible solution to #27621.\n\nCC:  @antonio-rojas @kiwifb @timokau @jhpalmieri\n\nBranch: **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)**\n\nReviewer: **Fran\u00e7ois Bissey**\n\nAuthor: **Erik Bray**\n\nComponent: **doctest framework**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27635_\n\n",
    "closed_at": "2019-04-27T17:44:12Z",
    "created_at": "2019-04-10T13:37:25Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Allow tests that are specific to Sage's build system to be skipped",
    "type": "issue",
    "updated_at": "2019-05-09T11:31:27Z",
    "url": "https://github.com/sagemath/sage/issues/27635",
    "user": "https://github.com/embray"
}
```
Adds an 'optional' tag called 'build' (name to be bikeshedded if necessary) specifically for tests related to sage-the-distribution and Sage's build system.

This allows downstream distributions that package Sage differently to skip these tests, but they are enabled by default when the tests are run from a build in Sage's source repository.

This provides a possible solution to #27621.

CC:  @antonio-rojas @kiwifb @timokau @jhpalmieri

Branch: **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)**

Reviewer: **François Bissey**

Author: **Erik Bray**

Component: **doctest framework**

_Issue created by migration from https://trac.sagemath.org/ticket/27635_





---

archive/issue_events_379241.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-10T13:37:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379241"
}
```



---

archive/issue_events_379242.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-10T13:37:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379242"
}
```



---

archive/issue_events_379243.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-10T13:37:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379243"
}
```



---

archive/issue_events_379244.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-10T13:37:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379244"
}
```



---

archive/issue_comments_428192.json:
```json
{
    "body": "Branch: **[u/embray/doctest/optional-build](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/doctest/optional-build)**",
    "created_at": "2019-04-10T13:49:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428192",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/doctest/optional-build](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/doctest/optional-build)**



---

archive/issue_events_379245.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-04-10T13:49:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379245"
}
```



---

archive/issue_comments_428193.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nAdded `# optional - build` to several tests in `sage.misc.package`, but perhaps some of the downstream packagers could mention some other problem test if there are any.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/99699e284569b71717717f236e4c2257a1073949\"><code>99699e2</code></a></td><td><code>Trac #27635: Add the --optional=build tag by default when run out of the Sage source repository.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c424acf474885d861544c3d13bfb11eaedb2cdc7\"><code>c424acf</code></a></td><td><code>fixup</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d4ba44467b3ea398e297f6a7e1f83108fe600c3b\"><code>d4ba444</code></a></td><td><code>Trac #27635: Add 'optional - build' to several sage-the-distribution related tests.</code></td></tr></table>\n",
    "created_at": "2019-04-10T13:49:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428193",
    "user": "https://github.com/embray"
}
```

<div id="comment:2" align="right">comment:2</div>

Added `# optional - build` to several tests in `sage.misc.package`, but perhaps some of the downstream packagers could mention some other problem test if there are any.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/99699e284569b71717717f236e4c2257a1073949"><code>99699e2</code></a></td><td><code>Trac #27635: Add the --optional=build tag by default when run out of the Sage source repository.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c424acf474885d861544c3d13bfb11eaedb2cdc7"><code>c424acf</code></a></td><td><code>fixup</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d4ba44467b3ea398e297f6a7e1f83108fe600c3b"><code>d4ba444</code></a></td><td><code>Trac #27635: Add 'optional - build' to several sage-the-distribution related tests.</code></td></tr></table>




---

archive/issue_comments_428194.json:
```json
{
    "body": "Commit: **[`d4ba444`](https://github.com/sagemath/sagetrac-mirror/commit/d4ba44467b3ea398e297f6a7e1f83108fe600c3b)**",
    "created_at": "2019-04-10T13:49:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428194",
    "user": "https://github.com/embray"
}
```

Commit: **[`d4ba444`](https://github.com/sagemath/sagetrac-mirror/commit/d4ba44467b3ea398e297f6a7e1f83108fe600c3b)**



---

archive/issue_comments_428195.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2019-04-10T13:49:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428195",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_comments_428196.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d96a08164d62a9d324cbf8010f50b84598beaeba\"><code>d96a081</code></a></td><td><code>Trac #27635: Add the --optional=build tag by default when run out of the Sage source repository.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76fae85020e052d6c732aedbea76672ed4b33183\"><code>76fae85</code></a></td><td><code>Trac #27635: Add 'optional - build' to several sage-the-distribution related tests.</code></td></tr></table>\n",
    "created_at": "2019-04-10T13:53:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428196",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d96a08164d62a9d324cbf8010f50b84598beaeba"><code>d96a081</code></a></td><td><code>Trac #27635: Add the --optional=build tag by default when run out of the Sage source repository.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76fae85020e052d6c732aedbea76672ed4b33183"><code>76fae85</code></a></td><td><code>Trac #27635: Add 'optional - build' to several sage-the-distribution related tests.</code></td></tr></table>




---

archive/issue_comments_428197.json:
```json
{
    "body": "Changed commit from **[`d4ba444`](https://github.com/sagemath/sagetrac-mirror/commit/d4ba44467b3ea398e297f6a7e1f83108fe600c3b)** to **[`76fae85`](https://github.com/sagemath/sagetrac-mirror/commit/76fae85020e052d6c732aedbea76672ed4b33183)**",
    "created_at": "2019-04-10T13:53:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428197",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d4ba444`](https://github.com/sagemath/sagetrac-mirror/commit/d4ba44467b3ea398e297f6a7e1f83108fe600c3b)** to **[`76fae85`](https://github.com/sagemath/sagetrac-mirror/commit/76fae85020e052d6c732aedbea76672ed4b33183)**



---

archive/issue_comments_428198.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThank you! The only possible issue I can see with this (and the reason why I still create empty dummy files in `installed`) is that people may use `is_package_installed` in scripts to gate certain features.\n\nThey really *should* be using the `features` feature ( :) ) for that though, so maybe that's okay. Definitively net positive overall.",
    "created_at": "2019-04-10T14:14:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428198",
    "user": "https://github.com/timokau"
}
```

<div id="comment:4" align="right">comment:4</div>

Thank you! The only possible issue I can see with this (and the reason why I still create empty dummy files in `installed`) is that people may use `is_package_installed` in scripts to gate certain features.

They really *should* be using the `features` feature ( :) ) for that though, so maybe that's okay. Definitively net positive overall.



---

archive/issue_comments_428199.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOther tests that should have this flag:\n\n- The `os.path.isfile(started_file)` test in sage/all.py:288\n- Tests that involve `sage --root` and `sage --info` in tests/cmdline.py:198-234",
    "created_at": "2019-04-10T15:38:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428199",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:5" align="right">comment:5</div>

Other tests that should have this flag:

- The `os.path.isfile(started_file)` test in sage/all.py:288
- Tests that involve `sage --root` and `sage --info` in tests/cmdline.py:198-234



---

archive/issue_comments_428200.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@timokau](#comment:4):\n> Thank you! The only possible issue I can see with this (and the reason why I still create empty dummy files in `installed`) is that people may use `is_package_installed` in scripts to gate certain features.\n\nThat's interesting... One thing that is definitely on my todo list, though I have no idea when I'll get to it, is to have an easy way for distros to plug into sage's `configure` script, so that it can use the distro's packaging system to check for the required dependencies, and possibly also output these files (although they are of less interest in that case).\n \n> They really *should* be using the `features` feature ( :) ) for that though, so maybe that's okay. Definitively net positive overall.\n\nYep!",
    "created_at": "2019-04-10T15:42:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428200",
    "user": "https://github.com/embray"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@timokau](#comment:4):
> Thank you! The only possible issue I can see with this (and the reason why I still create empty dummy files in `installed`) is that people may use `is_package_installed` in scripts to gate certain features.

That's interesting... One thing that is definitely on my todo list, though I have no idea when I'll get to it, is to have an easy way for distros to plug into sage's `configure` script, so that it can use the distro's packaging system to check for the required dependencies, and possibly also output these files (although they are of less interest in that case).
 
> They really *should* be using the `features` feature ( :) ) for that though, so maybe that's okay. Definitively net positive overall.

Yep!



---

archive/issue_comments_428201.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@antonio-rojas](#comment:5):\n> Other tests that should have this flag:\n> \n> - The `os.path.isfile(started_file)` test in sage/all.py:288\n> - Tests that involve `sage --root` and `sage --info` in tests/cmdline.py:198-234 \n\nThank you for pointing them out. I'll add them.",
    "created_at": "2019-04-10T15:43:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428201",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@antonio-rojas](#comment:5):
> Other tests that should have this flag:
> 
> - The `os.path.isfile(started_file)` test in sage/all.py:288
> - Tests that involve `sage --root` and `sage --info` in tests/cmdline.py:198-234 

Thank you for pointing them out. I'll add them.



---

archive/issue_comments_428202.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nRight now the doctesting flags are set both in the main Makefile and in `sage-runtests`. Should the same happen here? At #27124, @timokau suggested not even trying to guess whether to use the `build` flag but just make it the default, for example via the existing variable `TESTALL_FLAGS`. Then people can modify that variable as they like, perhaps as they already do to omit `dochtml`.\n\nThe `build` flag should probably also be documented in the parser help in `sage-runtests`: `if \"build\" is listed, will also run the tests relying on Sage's packaging system` or something like that.",
    "created_at": "2019-04-10T18:14:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428202",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:8" align="right">comment:8</div>

Right now the doctesting flags are set both in the main Makefile and in `sage-runtests`. Should the same happen here? At #27124, @timokau suggested not even trying to guess whether to use the `build` flag but just make it the default, for example via the existing variable `TESTALL_FLAGS`. Then people can modify that variable as they like, perhaps as they already do to omit `dochtml`.

The `build` flag should probably also be documented in the parser help in `sage-runtests`: `if "build" is listed, will also run the tests relying on Sage's packaging system` or something like that.



---

archive/issue_comments_428203.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@embray](#comment:6):\n> Replying to [@timokau](#comment:4):\n> > Thank you! The only possible issue I can see with this (and the reason why I still create empty dummy files in `installed`) is that people may use `is_package_installed` in scripts to gate certain features.\n\n> \n> That's interesting... One thing that is definitely on my todo list, though I have no idea when I'll get to it, is to have an easy way for distros to plug into sage's `configure` script, so that it can use the distro's packaging system to check for the required dependencies, and possibly also output these files (although they are of less interest in that case).\n\n\nSimilarly I have `is_package_installed` returning `False` in sage-on-gentoo so as not to remove it everywhere. That used to be a big patch. I only remove it from code where Gentoo can offer a replacement.\n\n>  \n> > They really *should* be using the `features` feature ( :) ) for that though, so maybe that's okay. Definitively net positive overall.\n\n> \n> Yep!\n\nYes at runtime definitely.\n\nAt configure time it is still used for optional bindings that have code. At the moment I replace it by querying environment variables in `sage_setup/optional_extension.py`. If it could be replaced by a `setup.cfg` that could be generated by `configure` - or the package building system - that would be great. On the other hand that would mean people couldn't just do a `sage -i ....` followed by `sage -b` to rebuild for the package they have just added.\n\nLastly the doctesting system relies on `is_package_installed` to figure some of the options you have enabled when passed `--optional=all`. I just cannot think of how to replace that.",
    "created_at": "2019-04-10T20:50:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428203",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@embray](#comment:6):
> Replying to [@timokau](#comment:4):
> > Thank you! The only possible issue I can see with this (and the reason why I still create empty dummy files in `installed`) is that people may use `is_package_installed` in scripts to gate certain features.

> 
> That's interesting... One thing that is definitely on my todo list, though I have no idea when I'll get to it, is to have an easy way for distros to plug into sage's `configure` script, so that it can use the distro's packaging system to check for the required dependencies, and possibly also output these files (although they are of less interest in that case).


Similarly I have `is_package_installed` returning `False` in sage-on-gentoo so as not to remove it everywhere. That used to be a big patch. I only remove it from code where Gentoo can offer a replacement.

>  
> > They really *should* be using the `features` feature ( :) ) for that though, so maybe that's okay. Definitively net positive overall.

> 
> Yep!

Yes at runtime definitely.

At configure time it is still used for optional bindings that have code. At the moment I replace it by querying environment variables in `sage_setup/optional_extension.py`. If it could be replaced by a `setup.cfg` that could be generated by `configure` - or the package building system - that would be great. On the other hand that would mean people couldn't just do a `sage -i ....` followed by `sage -b` to rebuild for the package they have just added.

Lastly the doctesting system relies on `is_package_installed` to figure some of the options you have enabled when passed `--optional=all`. I just cannot think of how to replace that.



---

archive/issue_comments_428204.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a01588849d4bde2d3036a82a61b9f6f5f79fddd7\"><code>a015888</code></a></td><td><code>Trac #27635: Skip more tests that may not make sense outside a Sage build from</code></td></tr></table>\n",
    "created_at": "2019-04-11T14:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428204",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a01588849d4bde2d3036a82a61b9f6f5f79fddd7"><code>a015888</code></a></td><td><code>Trac #27635: Skip more tests that may not make sense outside a Sage build from</code></td></tr></table>




---

archive/issue_comments_428205.json:
```json
{
    "body": "Changed commit from **[`76fae85`](https://github.com/sagemath/sagetrac-mirror/commit/76fae85020e052d6c732aedbea76672ed4b33183)** to **[`a015888`](https://github.com/sagemath/sagetrac-mirror/commit/a01588849d4bde2d3036a82a61b9f6f5f79fddd7)**",
    "created_at": "2019-04-11T14:02:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428205",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`76fae85`](https://github.com/sagemath/sagetrac-mirror/commit/76fae85020e052d6c732aedbea76672ed4b33183)** to **[`a015888`](https://github.com/sagemath/sagetrac-mirror/commit/a01588849d4bde2d3036a82a61b9f6f5f79fddd7)**



---

archive/issue_comments_428206.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jhpalmieri](#comment:8):\n> Right now the doctesting flags are set both in the main Makefile and in `sage-runtests`. Should the same happen here? At #27124, @timokau suggested not even trying to guess whether to use the `build` flag but just make it the default, for example via the existing variable `TESTALL_FLAGS`. Then people can modify that variable as they like, perhaps as they already do to omit `dochtml`.\n\nI think I see what you're saying. I'll add it to `TESTALL_FLAGS`: It would have to be since otherwise it is only appended if running `sage -t` directly without explicitly providing an `--optional` flag.  I think the default guessing behavior is pretty good as-is though unless someone can find a strong counter-example.\n\n> The `build` flag should probably also be documented in the parser help in `sage-runtests`: `if \"build\" is listed, will also run the tests relying on Sage's packaging system` or something like that.\n\nDone.",
    "created_at": "2019-04-11T14:06:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428206",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jhpalmieri](#comment:8):
> Right now the doctesting flags are set both in the main Makefile and in `sage-runtests`. Should the same happen here? At #27124, @timokau suggested not even trying to guess whether to use the `build` flag but just make it the default, for example via the existing variable `TESTALL_FLAGS`. Then people can modify that variable as they like, perhaps as they already do to omit `dochtml`.

I think I see what you're saying. I'll add it to `TESTALL_FLAGS`: It would have to be since otherwise it is only appended if running `sage -t` directly without explicitly providing an `--optional` flag.  I think the default guessing behavior is pretty good as-is though unless someone can find a strong counter-example.

> The `build` flag should probably also be documented in the parser help in `sage-runtests`: `if "build" is listed, will also run the tests relying on Sage's packaging system` or something like that.

Done.



---

archive/issue_comments_428207.json:
```json
{
    "body": "Changed commit from **[`a015888`](https://github.com/sagemath/sagetrac-mirror/commit/a01588849d4bde2d3036a82a61b9f6f5f79fddd7)** to **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)**",
    "created_at": "2019-04-11T14:08:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428207",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a015888`](https://github.com/sagemath/sagetrac-mirror/commit/a01588849d4bde2d3036a82a61b9f6f5f79fddd7)** to **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)**



---

archive/issue_comments_428208.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a282e098824e2b2dec8d0e4369939ec22d6a2a6b\"><code>a282e09</code></a></td><td><code>Trac #27635: Add 'build' to the default TESTALL_FLAGS in the main Makefile</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712\"><code>2533f32</code></a></td><td><code>Trac #27635: Document the 'build' option flag in the documentation for sage-runtests</code></td></tr></table>\n",
    "created_at": "2019-04-11T14:08:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428208",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a282e098824e2b2dec8d0e4369939ec22d6a2a6b"><code>a282e09</code></a></td><td><code>Trac #27635: Add 'build' to the default TESTALL_FLAGS in the main Makefile</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712"><code>2533f32</code></a></td><td><code>Trac #27635: Document the 'build' option flag in the documentation for sage-runtests</code></td></tr></table>




---

archive/issue_comments_428209.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nWhat about replacing\n\n```\n    if (SAGE_ROOT and os.path.isdir(SAGE_ROOT) and\n            os.path.exists(os.path.join(SAGE_ROOT, '.git')) and\n            os.path.isfile(os.path.join(SAGE_ROOT, 'sage'))):\n```\nby\n\n```\n    if (SAGE_ROOT and os.path.isdir(os.path.join(SAGE_ROOT, 'build'))):\n```\n\nThis way, we don't check for `.git` which we don't actually need. Second, you *do* need the `build` directory for the `build` tests to succeed (and this happens to align with the name `--optional=build`). Third, the check for `os.path.isdir(SAGE_ROOT)` is superfluous: if a file inside that directory exists, then surely the directory itself exists.",
    "created_at": "2019-04-12T12:45:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428209",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

What about replacing

```
    if (SAGE_ROOT and os.path.isdir(SAGE_ROOT) and
            os.path.exists(os.path.join(SAGE_ROOT, '.git')) and
            os.path.isfile(os.path.join(SAGE_ROOT, 'sage'))):
```
by

```
    if (SAGE_ROOT and os.path.isdir(os.path.join(SAGE_ROOT, 'build'))):
```

This way, we don't check for `.git` which we don't actually need. Second, you *do* need the `build` directory for the `build` tests to succeed (and this happens to align with the name `--optional=build`). Third, the check for `os.path.isdir(SAGE_ROOT)` is superfluous: if a file inside that directory exists, then surely the directory itself exists.



---

archive/issue_comments_428210.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI agree, there is no reason a distro build can't happen from a git checkout.\n\nHow about marking the python safe directory test (src/sage/doctest/control.py) as `build`? Its not strictly about the sage build system, but it is specific to the way sage builds its python. I still don't think that should be tested at all, but that way at least packagers don't have to patch it out anymore.",
    "created_at": "2019-04-14T19:46:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428210",
    "user": "https://github.com/timokau"
}
```

<div id="comment:14" align="right">comment:14</div>

I agree, there is no reason a distro build can't happen from a git checkout.

How about marking the python safe directory test (src/sage/doctest/control.py) as `build`? Its not strictly about the sage build system, but it is specific to the way sage builds its python. I still don't think that should be tested at all, but that way at least packagers don't have to patch it out anymore.



---

archive/issue_comments_428211.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThere is nothing to stop anyone from opening up a new ticket and marking more tests as `build`. Let's test this ticket thoroughly and make sure it works; that's more important than marking every one of them here.",
    "created_at": "2019-04-14T23:20:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428211",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:15" align="right">comment:15</div>

There is nothing to stop anyone from opening up a new ticket and marking more tests as `build`. Let's test this ticket thoroughly and make sure it works; that's more important than marking every one of them here.



---

archive/issue_comments_428212.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI abstained from asking for more stuff to be added myself because I thought `build` would become a misnomer. If we want to extend we can re-name and add more stuff in a follow up - once we are sure the concept is sound. I certainly have my own laundry list.",
    "created_at": "2019-04-14T23:23:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428212",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:16" align="right">comment:16</div>

I abstained from asking for more stuff to be added myself because I thought `build` would become a misnomer. If we want to extend we can re-name and add more stuff in a follow up - once we are sure the concept is sound. I certainly have my own laundry list.



---

archive/issue_comments_428213.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nAny other ideas besides \"build\"? \"packaging\"? \"infrastructure\"? \"buildsystem\"?",
    "created_at": "2019-04-15T02:20:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428213",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:17" align="right">comment:17</div>

Any other ideas besides "build"? "packaging"? "infrastructure"? "buildsystem"?



---

archive/issue_comments_428214.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\n\"selfhosted\" but I recon it is not as intuitive as \"build\". On the other hand\n\n```\n+        sage: (out, err, ret) = test_executable([\"sage\", \"--root\"])  # optional - build\n+        sage: len(out) >= 2   # at least one character + newline; optional - build\n```\nis not exactly related to the build system. It happens to not necessarily be defined on sage-on-distro.",
    "created_at": "2019-04-15T02:40:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428214",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:18" align="right">comment:18</div>

"selfhosted" but I recon it is not as intuitive as "build". On the other hand

```
+        sage: (out, err, ret) = test_executable(["sage", "--root"])  # optional - build
+        sage: len(out) >= 2   # at least one character + newline; optional - build
```
is not exactly related to the build system. It happens to not necessarily be defined on sage-on-distro.



---

archive/issue_comments_428215.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nSpeaking of stuff that is not self evident, we may want to add a bit of documentation somewhere to explain what it is.",
    "created_at": "2019-04-15T02:43:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428215",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:19" align="right">comment:19</div>

Speaking of stuff that is not self evident, we may want to add a bit of documentation somewhere to explain what it is.



---

archive/issue_comments_428216.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@kiwifb](#comment:19):\n> Speaking of stuff that is not self evident, we may want to add a bit of documentation somewhere to explain what it is.\n\nForget that. I re-read the branch and it is documented well enough.",
    "created_at": "2019-04-15T02:51:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428216",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@kiwifb](#comment:19):
> Speaking of stuff that is not self evident, we may want to add a bit of documentation somewhere to explain what it is.

Forget that. I re-read the branch and it is documented well enough.



---

archive/issue_comments_428217.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI'm a little lost in the bikeshedding.  Does this need work or not? And if so please transition the ticket's state.",
    "created_at": "2019-04-16T16:10:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428217",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">comment:21</div>

I'm a little lost in the bikeshedding.  Does this need work or not? And if so please transition the ticket's state.



---

archive/issue_comments_428218.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nLet's move the stuff that's already done here merged. We can do more bikeshedding some other place.",
    "created_at": "2019-04-18T04:31:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428218",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:22" align="right">comment:22</div>

Let's move the stuff that's already done here merged. We can do more bikeshedding some other place.



---

archive/issue_comments_428219.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2019-04-18T04:31:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428219",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **François Bissey**



---

archive/issue_events_379246.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-04-18T04:31:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379246"
}
```



---

archive/issue_events_379247.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2019-04-18T04:31:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379247"
}
```



---

archive/issue_comments_428220.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nSounds good to me.  If anyone has follow-up concerns please open tickets for them and CC me.",
    "created_at": "2019-04-19T16:50:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428220",
    "user": "https://github.com/embray"
}
```

<div id="comment:23" align="right">comment:23</div>

Sounds good to me.  If anyone has follow-up concerns please open tickets for them and CC me.



---

archive/issue_comments_428221.json:
```json
{
    "body": "Changed branch from **[u/embray/doctest/optional-build](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/doctest/optional-build)** to **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)**",
    "created_at": "2019-04-27T17:44:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428221",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/doctest/optional-build](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/doctest/optional-build)** to **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)**



---

archive/issue_events_379248.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-27T17:44:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379248"
}
```



---

archive/issue_events_379249.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "9ef37ae1797ffaac330fa825f36e763804c59c99",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-04-27T17:44:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27635#event-379249"
}
```



---

archive/issue_comments_428222.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nFew \"build\" tags were missing. Follow-up at #27781.",
    "created_at": "2019-05-09T11:31:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428222",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:25" align="right">comment:25</div>

Few "build" tags were missing. Follow-up at #27781.



---

archive/issue_comments_428223.json:
```json
{
    "body": "Changed commit from **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)** to none",
    "created_at": "2019-05-09T11:31:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27635#issuecomment-428223",
    "user": "https://github.com/seblabbe"
}
```

Changed commit from **[`2533f32`](https://github.com/sagemath/sagetrac-mirror/commit/2533f32e2752773f66d015ca991ead9695ccb712)** to none
