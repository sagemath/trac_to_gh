# Issue 27655: Ease the display of tensor fields in a coordinate frame

archive/issues_027418.json:
```json
{
    "assignees": [],
    "body": "Consider a manifold covered by two coordinate charts:\n\n```\nsage: M = Manifold(2, 'M')\nsage: X.<x,y> = M.chart()\nsage: Y.<u,v> = M.chart()\nsage: X_to_Y = X.transition_map(Y, [x+y, x-y])\nsage: Y_to_X = X_to_Y.inverse()\n```\nand define a vector field from its components in the manifold's default vector frame:\n\n```\nsage: M.default_frame()\nCoordinate frame (M, (d/dx,d/dy))\nsage: M.default_chart()\nChart (M, (x, y))\nsage: v = M.vector_field(-y, x, name='v')\nsage: v.display()\nv = -y d/dx + x d/dy\n```\nCurrently (Sage 8.7), if we would like to express `v` in terms of the coordinates `(u,v)`, we have to write\n\n```\nsage: v.display(Y.frame(), Y)\nv = v d/du - u d/dv\n```\nThis is because the first argument of `display` is the vector frame with respect to which the expansion of `v` is performed and the second argument is the chart in which the components are expressed. If the latter is omitted, the default chart is assumed:\n\n```\nsage: v.display(Y.frame())\nv = (x - y) d/du + (-x - y) d/dv\n```\n\nNow, it occurs quite often that one wants to express a tensor field entirely in terms of a given chart, i.e. with the components w.r.t. the coordinate frame associated to the chart and each component being expressed in terms of the coordinates of the chart. In Sage 8.7, if `Y` is not the default chart, this is possible only through `v.display(Y.frame(), Y)`. This ticket introduces the possibility to pass only the chart to  `display`, with the understanding that the vector frame with respect to which the expansion is to be performed is the coordinate frame associated with this chart. In other words, `v.display(Y.frame(), Y)` can now be shorten to `v.display(Y)`:\n\n```\nsage: v.display(Y)\nv = v d/du - u d/dv\n```\n\nCC:  @tscrim\n\nKeywords: **tensor field, coordinate frame, manifolds**\n\nBranch/Commit: **[4060557](https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Eric Gourgoulhon**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27655_\n\n",
    "closed_at": "2019-04-18T19:56:39Z",
    "created_at": "2019-04-12T15:47:24Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20geometry",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Ease the display of tensor fields in a coordinate frame",
    "type": "issue",
    "updated_at": "2019-04-18T19:56:39Z",
    "url": "https://github.com/sagemath/sage/issues/27655",
    "user": "https://github.com/egourgoulhon"
}
```
Consider a manifold covered by two coordinate charts:

```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: Y.<u,v> = M.chart()
sage: X_to_Y = X.transition_map(Y, [x+y, x-y])
sage: Y_to_X = X_to_Y.inverse()
```
and define a vector field from its components in the manifold's default vector frame:

```
sage: M.default_frame()
Coordinate frame (M, (d/dx,d/dy))
sage: M.default_chart()
Chart (M, (x, y))
sage: v = M.vector_field(-y, x, name='v')
sage: v.display()
v = -y d/dx + x d/dy
```
Currently (Sage 8.7), if we would like to express `v` in terms of the coordinates `(u,v)`, we have to write

```
sage: v.display(Y.frame(), Y)
v = v d/du - u d/dv
```
This is because the first argument of `display` is the vector frame with respect to which the expansion of `v` is performed and the second argument is the chart in which the components are expressed. If the latter is omitted, the default chart is assumed:

```
sage: v.display(Y.frame())
v = (x - y) d/du + (-x - y) d/dv
```

Now, it occurs quite often that one wants to express a tensor field entirely in terms of a given chart, i.e. with the components w.r.t. the coordinate frame associated to the chart and each component being expressed in terms of the coordinates of the chart. In Sage 8.7, if `Y` is not the default chart, this is possible only through `v.display(Y.frame(), Y)`. This ticket introduces the possibility to pass only the chart to  `display`, with the understanding that the vector frame with respect to which the expansion is to be performed is the coordinate frame associated with this chart. In other words, `v.display(Y.frame(), Y)` can now be shorten to `v.display(Y)`:

```
sage: v.display(Y)
v = v d/du - u d/dv
```

CC:  @tscrim

Keywords: **tensor field, coordinate frame, manifolds**

Branch/Commit: **[4060557](https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94)**

Reviewer: **Travis Scrimshaw**

Author: **Eric Gourgoulhon**

_Issue created by migration from https://trac.sagemath.org/ticket/27655_





---

archive/issue_events_348518.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-12T15:47:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348518"
}
```



---

archive/issue_events_348519.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-12T15:47:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20geometry",
    "label_color": "0000ff",
    "label_name": "component: geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348519"
}
```



---

archive/issue_events_348520.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-12T15:47:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348520"
}
```



---

archive/issue_events_348521.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-12T15:47:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348521"
}
```



---

archive/issue_comments_431504.json:
```json
{
    "body": "Branch: **[public/manifolds/display_from_chart](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/display_from_chart)**",
    "created_at": "2019-04-12T15:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431504",
    "user": "https://github.com/egourgoulhon"
}
```

Branch: **[public/manifolds/display_from_chart](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/display_from_chart)**



---

archive/issue_comments_431505.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5b2c1abd219754b78c692425589905a1c2df4425\">5b2c1ab</a></td><td><code>Display of tensor fields with only a chart given as argument</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/91553126483bc1e91f910e0af7813bbea0c44ad5\">9155312</a></td><td><code>Merge branch 'public/manifolds/display_from_chart' of git://trac.sagemath.org/sage into Sage 8.8.beta1.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d975e8599f22a73f6ba371e8491592e06c9d0c53\">d975e85</a></td><td><code>Update documentation with display of tensor fields with only a chart given as argument</code></td></tr></table>\n",
    "created_at": "2019-04-12T15:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431505",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5b2c1abd219754b78c692425589905a1c2df4425">5b2c1ab</a></td><td><code>Display of tensor fields with only a chart given as argument</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/91553126483bc1e91f910e0af7813bbea0c44ad5">9155312</a></td><td><code>Merge branch 'public/manifolds/display_from_chart' of git://trac.sagemath.org/sage into Sage 8.8.beta1.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d975e8599f22a73f6ba371e8491592e06c9d0c53">d975e85</a></td><td><code>Update documentation with display of tensor fields with only a chart given as argument</code></td></tr></table>




---

archive/issue_comments_431506.json:
```json
{
    "body": "Commit: **[d975e85](https://github.com/sagemath/sagetrac-mirror/commit/d975e8599f22a73f6ba371e8491592e06c9d0c53)**",
    "created_at": "2019-04-12T15:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431506",
    "user": "https://github.com/egourgoulhon"
}
```

Commit: **[d975e85](https://github.com/sagemath/sagetrac-mirror/commit/d975e8599f22a73f6ba371e8491592e06c9d0c53)**



---

archive/issue_events_348522.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-12T15:52:50Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "title_is": "Ease the display of tensor fields in a coordinate frame",
    "title_was": "Improve the display of tensor fields in a coordinate frame",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348522"
}
```



---

archive/issue_events_348523.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-12T15:53:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348523"
}
```



---

archive/issue_comments_431507.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nIs there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`? This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).",
    "created_at": "2019-04-12T22:56:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431507",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'>Comment 4:</a>
Is there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`? This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).



---

archive/issue_comments_431508.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6\">b97afe2</a></td><td><code>Check of chart with isinstance(basis, Chart) in FreeModuleTensor._preparse_display</code></td></tr></table>\n",
    "created_at": "2019-04-14T12:53:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431508",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:5'>Comment 5:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6">b97afe2</a></td><td><code>Check of chart with isinstance(basis, Chart) in FreeModuleTensor._preparse_display</code></td></tr></table>




---

archive/issue_comments_431509.json:
```json
{
    "body": "Changed commit from **[d975e85](https://github.com/sagemath/sagetrac-mirror/commit/d975e8599f22a73f6ba371e8491592e06c9d0c53)** to **[b97afe2](https://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6)**",
    "created_at": "2019-04-14T12:53:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431509",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[d975e85](https://github.com/sagemath/sagetrac-mirror/commit/d975e8599f22a73f6ba371e8491592e06c9d0c53)** to **[b97afe2](https://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6)**



---

archive/issue_comments_431510.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@tscrim](#comment%3A4):\n> Is there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`?\n\nDone in the above commit.\n\n> This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).\n\nIndeed.",
    "created_at": "2019-04-14T12:54:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431510",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@tscrim](#comment%3A4):
> Is there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`?

Done in the above commit.

> This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).

Indeed.



---

archive/issue_events_348524.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-04-14T14:09:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348524"
}
```



---

archive/issue_events_348525.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-04-14T14:09:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348525"
}
```



---

archive/issue_comments_431511.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2019-04-14T14:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431511",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_431512.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nThank you. LGTM.",
    "created_at": "2019-04-14T14:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431512",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'>Comment 7:</a>
Thank you. LGTM.



---

archive/issue_comments_431513.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nThanks for the review!",
    "created_at": "2019-04-14T14:35:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431513",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'>Comment 8:</a>
Thanks for the review!



---

archive/issue_events_348526.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-14T22:32:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348526"
}
```



---

archive/issue_events_348527.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-14T22:32:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348527"
}
```



---

archive/issue_comments_431514.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nThat causes quite a lot of breakage, see patchbot",
    "created_at": "2019-04-14T22:32:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431514",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'>Comment 9:</a>
That causes quite a lot of breakage, see patchbot



---

archive/issue_comments_431515.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nReplying to [@vbraun](#comment%3A9):\n> That causes quite a lot of breakage, see patchbot\n\nSorry for what is likely a dumb question, but are you sure it is this ticket? I just have absolutely no idea how those failures could be related to this ticket. I agree that all the patchbots for what seems to be just ticket have massive breakage, but it seems to come from the `mpmath` library, which is not touched by this ticket.",
    "created_at": "2019-04-14T23:23:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431515",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'>Comment 10:</a>
Replying to [@vbraun](#comment%3A9):
> That causes quite a lot of breakage, see patchbot

Sorry for what is likely a dumb question, but are you sure it is this ticket? I just have absolutely no idea how those failures could be related to this ticket. I agree that all the patchbots for what seems to be just ticket have massive breakage, but it seems to come from the `mpmath` library, which is not touched by this ticket.



---

archive/issue_comments_431516.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nIt went away after unmerging this ticket, so seems to be the case",
    "created_at": "2019-04-15T11:52:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431516",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'>Comment 11:</a>
It went away after unmerging this ticket, so seems to be the case



---

archive/issue_comments_431517.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [@vbraun](#comment%3A11):\n> It went away after unmerging this ticket, so seems to be the case\n\nI confirm the errors reported by the patchbot: on my computer, after merging the ticket branch in Sage 8.8.beta2, I get \n\n```\nsage: complex(erf(3*I))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-1-af6acac02c0b> in <module>()\n----> 1 complex(erf(Integer(3)*I))\n\n/home/eric/sage/8.8.develop/local/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__complex__ (build/cythonized/sage/symbolic/expression.cpp:11230)()\n   1441             return self._eval_self(complex)\n   1442         except TypeError:\n-> 1443             raise TypeError(\"unable to simplify to complex approximation\")\n   1444 \n   1445     def _sympy_(self):\n\nTypeError: unable to simplify to complex approximation\n```\nThe error raised in `self._eval_self(complex)` seems related to mpmath, as pointed in [comment:10](#comment%3A10):\n\n```\nsage: erf(3*I)._eval_self(complex)\n...\nTypeError: Cannot convert mpz to sage.rings.integer.Integer\n```\nHowever I am completely puzzled: how could possibly the code in this branch alter mpmath?\nWe have \n\n```\n./sage -tp --long src/sage/manifolds/\n```\nreturns \"All tests passed!\", but the other parts of Sage are impacted as the patchbot says, for instance \n\n```\n./sage -t --long --warn-long 48.3 src/sage/functions/exp_integral.py  \n```\nreturns \"93 doctests failed\"...",
    "created_at": "2019-04-15T12:03:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431517",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [@vbraun](#comment%3A11):
> It went away after unmerging this ticket, so seems to be the case

I confirm the errors reported by the patchbot: on my computer, after merging the ticket branch in Sage 8.8.beta2, I get 

```
sage: complex(erf(3*I))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-af6acac02c0b> in <module>()
----> 1 complex(erf(Integer(3)*I))

/home/eric/sage/8.8.develop/local/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__complex__ (build/cythonized/sage/symbolic/expression.cpp:11230)()
   1441             return self._eval_self(complex)
   1442         except TypeError:
-> 1443             raise TypeError("unable to simplify to complex approximation")
   1444 
   1445     def _sympy_(self):

TypeError: unable to simplify to complex approximation
```
The error raised in `self._eval_self(complex)` seems related to mpmath, as pointed in [comment:10](#comment%3A10):

```
sage: erf(3*I)._eval_self(complex)
...
TypeError: Cannot convert mpz to sage.rings.integer.Integer
```
However I am completely puzzled: how could possibly the code in this branch alter mpmath?
We have 

```
./sage -tp --long src/sage/manifolds/
```
returns "All tests passed!", but the other parts of Sage are impacted as the patchbot says, for instance 

```
./sage -t --long --warn-long 48.3 src/sage/functions/exp_integral.py  
```
returns "93 doctests failed"...



---

archive/issue_comments_431518.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nIt touches free modules so presumably something screws up mpmath as free module over integers...",
    "created_at": "2019-04-15T12:54:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431518",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'>Comment 13:</a>
It touches free modules so presumably something screws up mpmath as free module over integers...



---

archive/issue_comments_431519.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nThe culprit is the commit \nhttps://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6\nadded in [comment:5](#comment%3A5). It seems rather inoffensive, but if one displaces the import \n\n```\nfrom sage.manifolds.chart import Chart\n```\nfrom the top of the module `src/sage/tensor/modules/free_module_tensor.py` to the body of the method `FreeModuleTensor._preparse_display`, where `Chart` is actually required, then everything is OK. Could this be some clash with the name `Chart` and mpmath?",
    "created_at": "2019-04-15T13:53:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431519",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:14'>Comment 14:</a>
The culprit is the commit 
https://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6
added in [comment:5](#comment%3A5). It seems rather inoffensive, but if one displaces the import 

```
from sage.manifolds.chart import Chart
```
from the top of the module `src/sage/tensor/modules/free_module_tensor.py` to the body of the method `FreeModuleTensor._preparse_display`, where `Chart` is actually required, then everything is OK. Could this be some clash with the name `Chart` and mpmath?



---

archive/issue_comments_431520.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c529eb5ce1c1121c9d13bfbaec723739f921d3e4\">c529eb5</a></td><td><code>Merge branch 'public/manifolds/display_from_chart' of git://trac.sagemath.org/sage into Sage 8.8.beta2</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5106067e6b4c30f6167ef3f2531232b94f99184d\">5106067</a></td><td><code>Make the import of Chart local to FreeModuleTensor._preparse_display</code></td></tr></table>\n",
    "created_at": "2019-04-15T14:03:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431520",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:15'>Comment 15:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c529eb5ce1c1121c9d13bfbaec723739f921d3e4">c529eb5</a></td><td><code>Merge branch 'public/manifolds/display_from_chart' of git://trac.sagemath.org/sage into Sage 8.8.beta2</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5106067e6b4c30f6167ef3f2531232b94f99184d">5106067</a></td><td><code>Make the import of Chart local to FreeModuleTensor._preparse_display</code></td></tr></table>




---

archive/issue_comments_431521.json:
```json
{
    "body": "Changed commit from **[b97afe2](https://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6)** to **[5106067](https://github.com/sagemath/sagetrac-mirror/commit/5106067e6b4c30f6167ef3f2531232b94f99184d)**",
    "created_at": "2019-04-15T14:03:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431521",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b97afe2](https://github.com/sagemath/sagetrac-mirror/commit/b97afe2304d8dcfa4c41a2c6d5b68685373839c6)** to **[5106067](https://github.com/sagemath/sagetrac-mirror/commit/5106067e6b4c30f6167ef3f2531232b94f99184d)**



---

archive/issue_comments_431522.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nI am setting the ticket to \"needs review\" to draw the attention of the patchbot. The above commit, which simply makes the import of `Chart` local to `FreeModuleTensor._preparse_display`, seems to solve the issue. There remains to understand why the import at the module level caused such a mess with mpmath...",
    "created_at": "2019-04-15T14:06:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431522",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:16'>Comment 16:</a>
I am setting the ticket to "needs review" to draw the attention of the patchbot. The above commit, which simply makes the import of `Chart` local to `FreeModuleTensor._preparse_display`, seems to solve the issue. There remains to understand why the import at the module level caused such a mess with mpmath...



---

archive/issue_events_348528.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-15T14:06:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348528"
}
```



---

archive/issue_events_348529.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2019-04-15T14:06:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348529"
}
```



---

archive/issue_comments_431523.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5536b9431def2dce5a78f90a9b2a33c495192060\">5536b94</a></td><td><code>Lazy import of FiniteRankFreeModule + import of Chart at the module level in free_module_tensor.py</code></td></tr></table>\n",
    "created_at": "2019-04-15T15:15:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431523",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>Comment 17:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5536b9431def2dce5a78f90a9b2a33c495192060">5536b94</a></td><td><code>Lazy import of FiniteRankFreeModule + import of Chart at the module level in free_module_tensor.py</code></td></tr></table>




---

archive/issue_comments_431524.json:
```json
{
    "body": "Changed commit from **[5106067](https://github.com/sagemath/sagetrac-mirror/commit/5106067e6b4c30f6167ef3f2531232b94f99184d)** to **[5536b94](https://github.com/sagemath/sagetrac-mirror/commit/5536b9431def2dce5a78f90a9b2a33c495192060)**",
    "created_at": "2019-04-15T15:15:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431524",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5106067](https://github.com/sagemath/sagetrac-mirror/commit/5106067e6b4c30f6167ef3f2531232b94f99184d)** to **[5536b94](https://github.com/sagemath/sagetrac-mirror/commit/5536b9431def2dce5a78f90a9b2a33c495192060)**



---

archive/issue_comments_431525.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nI think I found the real culprit: in `src/sage/tensor/modules/all.py` there was a direct import of `FiniteRankFreeModule`, which caused `src/sage/tensor/modules/free_module_tensor` to be loaded at Sage startup, and hence `src/sage/manifolds/chart` when the import of `Chart` was at the module level. I've changed the import of `FiniteRankFreeModule` to be a lazy one, so that `src/sage/manifolds/chart` (and all its imports) is no longer imported at Sage startup. Everything seems fixed now. \n\nSince it is now harmless, I've restored the import of `Chart` at the module level in `src/sage/tensor/modules/free_module_tensor.py`, reverting what was done in the commit in [comment:15](#comment%3A15). I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?",
    "created_at": "2019-04-15T15:26:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431525",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:18'>Comment 18:</a>
I think I found the real culprit: in `src/sage/tensor/modules/all.py` there was a direct import of `FiniteRankFreeModule`, which caused `src/sage/tensor/modules/free_module_tensor` to be loaded at Sage startup, and hence `src/sage/manifolds/chart` when the import of `Chart` was at the module level. I've changed the import of `FiniteRankFreeModule` to be a lazy one, so that `src/sage/manifolds/chart` (and all its imports) is no longer imported at Sage startup. Everything seems fixed now. 

Since it is now harmless, I've restored the import of `Chart` at the module level in `src/sage/tensor/modules/free_module_tensor.py`, reverting what was done in the commit in [comment:15](#comment%3A15). I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?



---

archive/issue_comments_431526.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nIMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.\n\nI am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).",
    "created_at": "2019-04-16T01:14:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431526",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'>Comment 19:</a>
IMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.

I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).



---

archive/issue_comments_431527.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/093bd082a9d1129444e7fa5085796cac39fc881d\">093bd08</a></td><td><code>Check basis against a FreeModuleBasis in FreeModuleTensor._preparse_display</code></td></tr></table>\n",
    "created_at": "2019-04-16T13:26:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431527",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:20'>Comment 20:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/093bd082a9d1129444e7fa5085796cac39fc881d">093bd08</a></td><td><code>Check basis against a FreeModuleBasis in FreeModuleTensor._preparse_display</code></td></tr></table>




---

archive/issue_comments_431528.json:
```json
{
    "body": "Changed commit from **[5536b94](https://github.com/sagemath/sagetrac-mirror/commit/5536b9431def2dce5a78f90a9b2a33c495192060)** to **[093bd08](https://github.com/sagemath/sagetrac-mirror/commit/093bd082a9d1129444e7fa5085796cac39fc881d)**",
    "created_at": "2019-04-16T13:26:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431528",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5536b94](https://github.com/sagemath/sagetrac-mirror/commit/5536b9431def2dce5a78f90a9b2a33c495192060)** to **[093bd08](https://github.com/sagemath/sagetrac-mirror/commit/093bd082a9d1129444e7fa5085796cac39fc881d)**



---

archive/issue_comments_431529.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nReplying to [@egourgoulhon](#comment%3A18):\n> I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?\n\nThe more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in [comment:5](#comment%3A5), namely by\n\n```\nelif not isinstance(basis, FreeModuleBasis):\n```\ninstead of\n\n```\nelif isinstance(basis, Chart):\n``` \nIn this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`.",
    "created_at": "2019-04-16T13:39:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431529",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:21'>Comment 21:</a>
Replying to [@egourgoulhon](#comment%3A18):
> I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?

The more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in [comment:5](#comment%3A5), namely by

```
elif not isinstance(basis, FreeModuleBasis):
```
instead of

```
elif isinstance(basis, Chart):
``` 
In this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`.



---

archive/issue_comments_431530.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nReplying to [@tscrim](#comment%3A19):\n> IMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.\n> \n\nIndeed. \n\n> I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).\n\nIn the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?",
    "created_at": "2019-04-16T13:51:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431530",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:22'>Comment 22:</a>
Replying to [@tscrim](#comment%3A19):
> IMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.
> 

Indeed. 

> I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).

In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?



---

archive/issue_comments_431531.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nReplying to [@egourgoulhon](#comment%3A21):\n> Replying to [@egourgoulhon](#comment%3A18):\n> > I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?\n\n> \n> The more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in [comment:5](#comment%3A5), namely by\n> \n> ```\n> elif not isinstance(basis, FreeModuleBasis):\n> ```\n> instead of\n> \n> ```\n> elif isinstance(basis, Chart):\n> ``` \n> In this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`. \n\nI think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`. Thus, I think importing it is the correct thing to do. IMO, this falls under the \"explicit is better than implicit\" rule.",
    "created_at": "2019-04-17T01:37:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431531",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'>Comment 23:</a>
Replying to [@egourgoulhon](#comment%3A21):
> Replying to [@egourgoulhon](#comment%3A18):
> > I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?

> 
> The more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in [comment:5](#comment%3A5), namely by
> 
> ```
> elif not isinstance(basis, FreeModuleBasis):
> ```
> instead of
> 
> ```
> elif isinstance(basis, Chart):
> ``` 
> In this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`. 

I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`. Thus, I think importing it is the correct thing to do. IMO, this falls under the "explicit is better than implicit" rule.



---

archive/issue_comments_431532.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nReplying to [@egourgoulhon](#comment%3A22):\n> Replying to [@tscrim](#comment%3A19):\n> > I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).\n\n> \n> In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?\n\nIt has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.",
    "created_at": "2019-04-17T01:39:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431532",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:24'>Comment 24:</a>
Replying to [@egourgoulhon](#comment%3A22):
> Replying to [@tscrim](#comment%3A19):
> > I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).

> 
> In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?

It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.



---

archive/issue_comments_431533.json:
```json
{
    "body": "Changed commit from **[093bd08](https://github.com/sagemath/sagetrac-mirror/commit/093bd082a9d1129444e7fa5085796cac39fc881d)** to **[4060557](https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94)**",
    "created_at": "2019-04-17T08:28:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431533",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[093bd08](https://github.com/sagemath/sagetrac-mirror/commit/093bd082a9d1129444e7fa5085796cac39fc881d)** to **[4060557](https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94)**



---

archive/issue_comments_431534.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94\">4060557</a></td><td><code>Check basis against a Chart in FreeModuleTensor._preparse_display</code></td></tr></table>\n",
    "created_at": "2019-04-17T08:28:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431534",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:25'>Comment 25:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94">4060557</a></td><td><code>Check basis against a Chart in FreeModuleTensor._preparse_display</code></td></tr></table>




---

archive/issue_comments_431535.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nReplying to [@tscrim](#comment%3A23):\n> \n> I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.\n\nTrue. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have \n\n```\nclass VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)\n```\nso that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead\n\n```\nclass VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)\n```\nClearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in [comment:19](#comment%3A19). \n\n> Thus, I think importing it is the correct thing to do. IMO, this falls under the \"explicit is better than implicit\" rule.\n\nOK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization.",
    "created_at": "2019-04-17T08:55:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431535",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:26'>Comment 26:</a>
Replying to [@tscrim](#comment%3A23):
> 
> I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.

True. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have 

```
class VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)
```
so that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead

```
class VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)
```
Clearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in [comment:19](#comment%3A19). 

> Thus, I think importing it is the correct thing to do. IMO, this falls under the "explicit is better than implicit" rule.

OK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization.



---

archive/issue_comments_431536.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nReplying to [@tscrim](#comment%3A24):\n> Replying to [@egourgoulhon](#comment%3A22):\n> > \n> > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?\n\n> \n> It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.\n\nThanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion).",
    "created_at": "2019-04-17T09:04:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431536",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:27'>Comment 27:</a>
Replying to [@tscrim](#comment%3A24):
> Replying to [@egourgoulhon](#comment%3A22):
> > 
> > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?

> 
> It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.

Thanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion).



---

archive/issue_comments_431537.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nReplying to [@egourgoulhon](#comment%3A27):\n> Replying to [@tscrim](#comment%3A24):\n> > Replying to [@egourgoulhon](#comment%3A22):\n> > > \n> > > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?\n\n> > \n> > It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.\n\n> \n> Thanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion). \n\nThis is not something of any real benefit as just that file is loaded (all of the other imports are done within the functions). The bigger things that need to be lazily imported are a lot of things in `combinat` (IIRC, Nicolas did a big lazy import and startup time dropped by a third) and some of the other highly specialized features that are not performance critical.\n\nTL;DR. I wouldn't do that.",
    "created_at": "2019-04-17T10:44:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431537",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:28'>Comment 28:</a>
Replying to [@egourgoulhon](#comment%3A27):
> Replying to [@tscrim](#comment%3A24):
> > Replying to [@egourgoulhon](#comment%3A22):
> > > 
> > > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?

> > 
> > It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.

> 
> Thanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion). 

This is not something of any real benefit as just that file is loaded (all of the other imports are done within the functions). The bigger things that need to be lazily imported are a lot of things in `combinat` (IIRC, Nicolas did a big lazy import and startup time dropped by a third) and some of the other highly specialized features that are not performance critical.

TL;DR. I wouldn't do that.



---

archive/issue_comments_431538.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nReplying to [@egourgoulhon](#comment%3A26):\n> Replying to [@tscrim](#comment%3A23):\n> > \n> > I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.\n\n> \n> True. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have \n> \n> ```\n> class VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)\n> ```\n> so that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead\n> \n> ```\n> class VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)\n> ```\n> Clearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in [comment:19](#comment%3A19). \n\nI will leave the higher level decisions to you on that. Just let me know what you want me to review. `;)`\n\n> > Thus, I think importing it is the correct thing to do. IMO, this falls under the \"explicit is better than implicit\" rule.\n\n> \n> OK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization. \n\nThank you. LGTM.",
    "created_at": "2019-04-17T10:52:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431538",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:29'>Comment 29:</a>
Replying to [@egourgoulhon](#comment%3A26):
> Replying to [@tscrim](#comment%3A23):
> > 
> > I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.

> 
> True. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have 
> 
> ```
> class VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)
> ```
> so that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead
> 
> ```
> class VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)
> ```
> Clearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in [comment:19](#comment%3A19). 

I will leave the higher level decisions to you on that. Just let me know what you want me to review. `;)`

> > Thus, I think importing it is the correct thing to do. IMO, this falls under the "explicit is better than implicit" rule.

> 
> OK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization. 

Thank you. LGTM.



---

archive/issue_events_348530.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-04-17T10:52:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348530"
}
```



---

archive/issue_events_348531.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-04-17T10:52:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348531"
}
```



---

archive/issue_comments_431539.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nThanks for the review and the discussion!",
    "created_at": "2019-04-17T12:43:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431539",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:30'>Comment 30:</a>
Thanks for the review and the discussion!



---

archive/issue_events_348532.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-18T19:56:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348532"
}
```



---

archive/issue_events_348533.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "cdde0b26607c1a5cadd121208998cb6fcd3486f8",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-04-18T19:56:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27655#event-348533"
}
```



---

archive/issue_comments_431540.json:
```json
{
    "body": "Changed branch from **[public/manifolds/display_from_chart](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/display_from_chart)** to **[4060557](https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94)**",
    "created_at": "2019-04-18T19:56:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27655#issuecomment-431540",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/manifolds/display_from_chart](https://github.com/sagemath/sagetrac-mirror/tree/public/manifolds/display_from_chart)** to **[4060557](https://github.com/sagemath/sagetrac-mirror/commit/4060557d205263fd5c8a2ce2e1d0e0e96e5baa94)**
