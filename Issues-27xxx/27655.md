# Issue 27655: Ease the display of tensor fields in a coordinate frame

archive/issues_027418.json:
```json
{
    "body": "Consider a manifold covered by two coordinate charts:\n\n```\nsage: M = Manifold(2, 'M')\nsage: X.<x,y> = M.chart()\nsage: Y.<u,v> = M.chart()\nsage: X_to_Y = X.transition_map(Y, [x+y, x-y])\nsage: Y_to_X = X_to_Y.inverse()\n```\nand define a vector field from its components in the manifold's default vector frame:\n\n```\nsage: M.default_frame()\nCoordinate frame (M, (d/dx,d/dy))\nsage: M.default_chart()\nChart (M, (x, y))\nsage: v = M.vector_field(-y, x, name='v')\nsage: v.display()\nv = -y d/dx + x d/dy\n```\nCurrently (Sage 8.7), if we would like to express `v` in terms of the coordinates `(u,v)`, we have to write\n\n```\nsage: v.display(Y.frame(), Y)\nv = v d/du - u d/dv\n```\nThis is because the first argument of `display` is the vector frame with respect to which the expansion of `v` is performed and the second argument is the chart in which the components are expressed. If the latter is omitted, the default chart is assumed:\n\n```\nsage: v.display(Y.frame())\nv = (x - y) d/du + (-x - y) d/dv\n```\n\nNow, it occurs quite often that one wants to express a tensor field entirely in terms of a given chart, i.e. with the components w.r.t. the coordinate frame associated to the chart and each component being expressed in terms of the coordinates of the chart. In Sage 8.7, if `Y` is not the default chart, this is possible only through `v.display(Y.frame(), Y)`. This ticket introduces the possibility to pass only the chart to  `display`, with the understanding that the vector frame with respect to which the expansion is to be performed is the coordinate frame associated with this chart. In other words, `v.display(Y.frame(), Y)` can now be shorten to `v.display(Y)`:\n\n```\nsage: v.display(Y)\nv = v d/du - u d/dv\n```\n\nCC:  @tscrim\n\nKeywords: tensor field, coordinate frame, manifolds\n\nBranch/Commit: 4060557d205263fd5c8a2ce2e1d0e0e96e5baa94\n\nReviewer: Travis Scrimshaw\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27655\n\n",
    "closed_at": "2019-04-18T19:56:39Z",
    "created_at": "2019-04-12T15:47:24Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Ease the display of tensor fields in a coordinate frame",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27655",
    "user": "https://github.com/egourgoulhon"
}
```
Consider a manifold covered by two coordinate charts:

```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: Y.<u,v> = M.chart()
sage: X_to_Y = X.transition_map(Y, [x+y, x-y])
sage: Y_to_X = X_to_Y.inverse()
```
and define a vector field from its components in the manifold's default vector frame:

```
sage: M.default_frame()
Coordinate frame (M, (d/dx,d/dy))
sage: M.default_chart()
Chart (M, (x, y))
sage: v = M.vector_field(-y, x, name='v')
sage: v.display()
v = -y d/dx + x d/dy
```
Currently (Sage 8.7), if we would like to express `v` in terms of the coordinates `(u,v)`, we have to write

```
sage: v.display(Y.frame(), Y)
v = v d/du - u d/dv
```
This is because the first argument of `display` is the vector frame with respect to which the expansion of `v` is performed and the second argument is the chart in which the components are expressed. If the latter is omitted, the default chart is assumed:

```
sage: v.display(Y.frame())
v = (x - y) d/du + (-x - y) d/dv
```

Now, it occurs quite often that one wants to express a tensor field entirely in terms of a given chart, i.e. with the components w.r.t. the coordinate frame associated to the chart and each component being expressed in terms of the coordinates of the chart. In Sage 8.7, if `Y` is not the default chart, this is possible only through `v.display(Y.frame(), Y)`. This ticket introduces the possibility to pass only the chart to  `display`, with the understanding that the vector frame with respect to which the expansion is to be performed is the coordinate frame associated with this chart. In other words, `v.display(Y.frame(), Y)` can now be shorten to `v.display(Y)`:

```
sage: v.display(Y)
v = v d/du - u d/dv
```

CC:  @tscrim

Keywords: tensor field, coordinate frame, manifolds

Branch/Commit: 4060557d205263fd5c8a2ce2e1d0e0e96e5baa94

Reviewer: Travis Scrimshaw

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27655





---

archive/issue_comments_533956.json:
```json
{
    "body": "Changing branch from \"\" to \"public/manifolds/display_from_chart\"",
    "created_at": "2019-04-12T15:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533956",
    "user": "https://github.com/egourgoulhon"
}
```

Changing branch from "" to "public/manifolds/display_from_chart"



---

archive/issue_comments_533957.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2019-04-12T15:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533957",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_533958.json:
```json
{
    "body": "Changing commit from \"\" to \"d975e8599f22a73f6ba371e8491592e06c9d0c53\"",
    "created_at": "2019-04-12T15:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533958",
    "user": "https://github.com/egourgoulhon"
}
```

Changing commit from "" to "d975e8599f22a73f6ba371e8491592e06c9d0c53"



---

archive/issue_comments_533959.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-12T15:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533959",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_533960.json:
```json
{
    "body": "<a id='comment:4'></a>Is there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`? This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).",
    "created_at": "2019-04-12T22:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533960",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>Is there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`? This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).



---

archive/issue_comments_533961.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-14T12:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533961",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_533962.json:
```json
{
    "body": "Changing commit from \"d975e8599f22a73f6ba371e8491592e06c9d0c53\" to \"b97afe2304d8dcfa4c41a2c6d5b68685373839c6\"",
    "created_at": "2019-04-14T12:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d975e8599f22a73f6ba371e8491592e06c9d0c53" to "b97afe2304d8dcfa4c41a2c6d5b68685373839c6"



---

archive/issue_comments_533963.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 tscrim]:\n> Is there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`?\n\n\nDone in the above commit.\n\n> This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).\n\n\nIndeed.",
    "created_at": "2019-04-14T12:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533963",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:6'></a>Replying to [comment:4 tscrim]:
> Is there a better way than ducktyping to check if `frame` is a coordinate chart? IIRC, there is a base class for all coordinate charts, why not check `isinstance(frame, CoordinateChartBaseClass)`?


Done in the above commit.

> This is more robust as a test since if `frame` ever has a method `frame`, then the code would break (likely in a very strange way).


Indeed.



---

archive/issue_comments_533964.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-14T14:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533964",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_533965.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2019-04-14T14:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533965",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_533966.json:
```json
{
    "body": "<a id='comment:7'></a>Thank you. LGTM.",
    "created_at": "2019-04-14T14:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533966",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Thank you. LGTM.



---

archive/issue_comments_533967.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks for the review!",
    "created_at": "2019-04-14T14:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533967",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>Thanks for the review!



---

archive/issue_comments_533968.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-04-14T22:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533968",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_533969.json:
```json
{
    "body": "<a id='comment:9'></a>That causes quite a lot of breakage, see patchbot",
    "created_at": "2019-04-14T22:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533969",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>That causes quite a lot of breakage, see patchbot



---

archive/issue_comments_533970.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 vbraun]:\n> That causes quite a lot of breakage, see patchbot\n\n\nSorry for what is likely a dumb question, but are you sure it is this ticket? I just have absolutely no idea how those failures could be related to this ticket. I agree that all the patchbots for what seems to be just ticket have massive breakage, but it seems to come from the `mpmath` library, which is not touched by this ticket.",
    "created_at": "2019-04-14T23:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533970",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Replying to [comment:9 vbraun]:
> That causes quite a lot of breakage, see patchbot


Sorry for what is likely a dumb question, but are you sure it is this ticket? I just have absolutely no idea how those failures could be related to this ticket. I agree that all the patchbots for what seems to be just ticket have massive breakage, but it seems to come from the `mpmath` library, which is not touched by this ticket.



---

archive/issue_comments_533971.json:
```json
{
    "body": "<a id='comment:11'></a>It went away after unmerging this ticket, so seems to be the case",
    "created_at": "2019-04-15T11:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533971",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>It went away after unmerging this ticket, so seems to be the case



---

archive/issue_comments_533972.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 vbraun]:\n> It went away after unmerging this ticket, so seems to be the case\n\n\nI confirm the errors reported by the patchbot: on my computer, after merging the ticket branch in Sage 8.8.beta2, I get \n\n```\nsage: complex(erf(3*I))\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-1-af6acac02c0b> in <module>()\n----> 1 complex(erf(Integer(3)*I))\n\n/home/eric/sage/8.8.develop/local/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__complex__ (build/cythonized/sage/symbolic/expression.cpp:11230)()\n   1441             return self._eval_self(complex)\n   1442         except TypeError:\n-> 1443             raise TypeError(\"unable to simplify to complex approximation\")\n   1444 \n   1445     def _sympy_(self):\n\nTypeError: unable to simplify to complex approximation\n```\nThe error raised in `self._eval_self(complex)` seems related to mpmath, as pointed in comment:10:\n\n```\nsage: erf(3*I)._eval_self(complex)\n...\nTypeError: Cannot convert mpz to sage.rings.integer.Integer\n```\nHowever I am completely puzzled: how could possibly the code in this branch alter mpmath?\nWe have \n\n```\n./sage -tp --long src/sage/manifolds/\n```\nreturns \"All tests passed!\", but the other parts of Sage are impacted as the patchbot says, for instance \n\n```\n./sage -t --long --warn-long 48.3 src/sage/functions/exp_integral.py  \n```\nreturns \"93 doctests failed\"...",
    "created_at": "2019-04-15T12:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533972",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>Replying to [comment:11 vbraun]:
> It went away after unmerging this ticket, so seems to be the case


I confirm the errors reported by the patchbot: on my computer, after merging the ticket branch in Sage 8.8.beta2, I get 

```
sage: complex(erf(3*I))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-1-af6acac02c0b> in <module>()
----> 1 complex(erf(Integer(3)*I))

/home/eric/sage/8.8.develop/local/lib/python2.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.__complex__ (build/cythonized/sage/symbolic/expression.cpp:11230)()
   1441             return self._eval_self(complex)
   1442         except TypeError:
-> 1443             raise TypeError("unable to simplify to complex approximation")
   1444 
   1445     def _sympy_(self):

TypeError: unable to simplify to complex approximation
```
The error raised in `self._eval_self(complex)` seems related to mpmath, as pointed in comment:10:

```
sage: erf(3*I)._eval_self(complex)
...
TypeError: Cannot convert mpz to sage.rings.integer.Integer
```
However I am completely puzzled: how could possibly the code in this branch alter mpmath?
We have 

```
./sage -tp --long src/sage/manifolds/
```
returns "All tests passed!", but the other parts of Sage are impacted as the patchbot says, for instance 

```
./sage -t --long --warn-long 48.3 src/sage/functions/exp_integral.py  
```
returns "93 doctests failed"...



---

archive/issue_comments_533973.json:
```json
{
    "body": "<a id='comment:13'></a>It touches free modules so presumably something screws up mpmath as free module over integers...",
    "created_at": "2019-04-15T12:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533973",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>It touches free modules so presumably something screws up mpmath as free module over integers...



---

archive/issue_comments_533974.json:
```json
{
    "body": "<a id='comment:14'></a>The culprit is the commit \nhttps://git.sagemath.org/sage.git/commit/?id=b97afe2304d8dcfa4c41a2c6d5b68685373839c6\nadded in comment:5. It seems rather inoffensive, but if one displaces the import \n\n```\nfrom sage.manifolds.chart import Chart\n```\nfrom the top of the module `src/sage/tensor/modules/free_module_tensor.py` to the body of the method `FreeModuleTensor._preparse_display`, where `Chart` is actually required, then everything is OK. Could this be some clash with the name `Chart` and mpmath?",
    "created_at": "2019-04-15T13:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533974",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:14'></a>The culprit is the commit 
https://git.sagemath.org/sage.git/commit/?id=b97afe2304d8dcfa4c41a2c6d5b68685373839c6
added in comment:5. It seems rather inoffensive, but if one displaces the import 

```
from sage.manifolds.chart import Chart
```
from the top of the module `src/sage/tensor/modules/free_module_tensor.py` to the body of the method `FreeModuleTensor._preparse_display`, where `Chart` is actually required, then everything is OK. Could this be some clash with the name `Chart` and mpmath?



---

archive/issue_comments_533975.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-15T14:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533975",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_533976.json:
```json
{
    "body": "Changing commit from \"b97afe2304d8dcfa4c41a2c6d5b68685373839c6\" to \"5106067e6b4c30f6167ef3f2531232b94f99184d\"",
    "created_at": "2019-04-15T14:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533976",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b97afe2304d8dcfa4c41a2c6d5b68685373839c6" to "5106067e6b4c30f6167ef3f2531232b94f99184d"



---

archive/issue_comments_533977.json:
```json
{
    "body": "<a id='comment:16'></a>I am setting the ticket to \"needs review\" to draw the attention of the patchbot. The above commit, which simply makes the import of `Chart` local to `FreeModuleTensor._preparse_display`, seems to solve the issue. There remains to understand why the import at the module level caused such a mess with mpmath...",
    "created_at": "2019-04-15T14:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533977",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:16'></a>I am setting the ticket to "needs review" to draw the attention of the patchbot. The above commit, which simply makes the import of `Chart` local to `FreeModuleTensor._preparse_display`, seems to solve the issue. There remains to understand why the import at the module level caused such a mess with mpmath...



---

archive/issue_comments_533978.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-15T14:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533978",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_533979.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-15T15:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533979",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_533980.json:
```json
{
    "body": "Changing commit from \"5106067e6b4c30f6167ef3f2531232b94f99184d\" to \"5536b9431def2dce5a78f90a9b2a33c495192060\"",
    "created_at": "2019-04-15T15:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533980",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5106067e6b4c30f6167ef3f2531232b94f99184d" to "5536b9431def2dce5a78f90a9b2a33c495192060"



---

archive/issue_comments_533981.json:
```json
{
    "body": "<a id='comment:18'></a>I think I found the real culprit: in `src/sage/tensor/modules/all.py` there was a direct import of `FiniteRankFreeModule`, which caused `src/sage/tensor/modules/free_module_tensor` to be loaded at Sage startup, and hence `src/sage/manifolds/chart` when the import of `Chart` was at the module level. I've changed the import of `FiniteRankFreeModule` to be a lazy one, so that `src/sage/manifolds/chart` (and all its imports) is no longer imported at Sage startup. Everything seems fixed now. \n\nSince it is now harmless, I've restored the import of `Chart` at the module level in `src/sage/tensor/modules/free_module_tensor.py`, reverting what was done in the commit in comment:15. I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?",
    "created_at": "2019-04-15T15:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533981",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:18'></a>I think I found the real culprit: in `src/sage/tensor/modules/all.py` there was a direct import of `FiniteRankFreeModule`, which caused `src/sage/tensor/modules/free_module_tensor` to be loaded at Sage startup, and hence `src/sage/manifolds/chart` when the import of `Chart` was at the module level. I've changed the import of `FiniteRankFreeModule` to be a lazy one, so that `src/sage/manifolds/chart` (and all its imports) is no longer imported at Sage startup. Everything seems fixed now. 

Since it is now harmless, I've restored the import of `Chart` at the module level in `src/sage/tensor/modules/free_module_tensor.py`, reverting what was done in the commit in comment:15. I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?



---

archive/issue_comments_533982.json:
```json
{
    "body": "<a id='comment:19'></a>IMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.\n\nI am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).",
    "created_at": "2019-04-16T01:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533982",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>IMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.

I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).



---

archive/issue_comments_533983.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-16T13:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533983",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_533984.json:
```json
{
    "body": "Changing commit from \"5536b9431def2dce5a78f90a9b2a33c495192060\" to \"093bd082a9d1129444e7fa5085796cac39fc881d\"",
    "created_at": "2019-04-16T13:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533984",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5536b9431def2dce5a78f90a9b2a33c495192060" to "093bd082a9d1129444e7fa5085796cac39fc881d"



---

archive/issue_comments_533985.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:18 egourgoulhon]:\n> I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?\n\n\nThe more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in comment:5, namely by\n\n```\nelif not isinstance(basis, FreeModuleBasis):\n```\ninstead of\n\n```\nelif isinstance(basis, Chart):\n``` \nIn this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`.",
    "created_at": "2019-04-16T13:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533985",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:21'></a>Replying to [comment:18 egourgoulhon]:
> I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?


The more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in comment:5, namely by

```
elif not isinstance(basis, FreeModuleBasis):
```
instead of

```
elif isinstance(basis, Chart):
``` 
In this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`.



---

archive/issue_comments_533986.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:19 tscrim]:\n> IMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.\n> \nIndeed. \n\n> I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).\n\n\nIn the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?",
    "created_at": "2019-04-16T13:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533986",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:22'></a>Replying to [comment:19 tscrim]:
> IMO, that is still somewhat of a hack fix, but far less of one that the other. I am wondering if what is going on is this is changing the overall import order of things into Sage, and somehow things are more sensitive to this ordering than we thought. That means dealing with Sage's import hell.
> 
Indeed. 

> I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).


In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?



---

archive/issue_comments_533987.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:21 egourgoulhon]:\n> Replying to [comment:18 egourgoulhon]:\n> > I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?\n\n> \n> The more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in comment:5, namely by\n> \n> ```\n> elif not isinstance(basis, FreeModuleBasis):\n> ```\n> instead of\n> \n> ```\n> elif isinstance(basis, Chart):\n> ``` \n> In this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`. \n\n\nI think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`. Thus, I think importing it is the correct thing to do. IMO, this falls under the \"explicit is better than implicit\" rule.",
    "created_at": "2019-04-17T01:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533987",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>Replying to [comment:21 egourgoulhon]:
> Replying to [comment:18 egourgoulhon]:
> > I am wondering however if this is a good thing... i.e. shall we keep the import of `Chart` at the level of the function ` FreeModuleTensor._preparse_display`, in order not to mix (too much) the algebraic part (`src/sage/tensor/modules`) and the topological one (`src/sage/manifolds`)?

> 
> The more I think about it, the more I am convinced that we shall not import anything from `src/sage/manifolds` into `src/sage/tensor/modules` in order to keep the pure algebraic part completely separated from the manifold one. In the above commit, I propose to restore the ducktyping in the check of the basis nature of the first argument of `FreeModuleTensor._preparse_display` but in a much safer way than what was done previous to the commit in comment:5, namely by
> 
> ```
> elif not isinstance(basis, FreeModuleBasis):
> ```
> instead of
> 
> ```
> elif isinstance(basis, Chart):
> ``` 
> In this way, we do not have to import `Chart` from the manifold part, but only `FreeModuleBasis`, which pertains to the algebraic part. Moreover, it is much safer: if `basis` is a true module basis and (for some reason) has an attribute `frame()`, it will never mistakenly be replaced by `basis.frame()`. 


I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`. Thus, I think importing it is the correct thing to do. IMO, this falls under the "explicit is better than implicit" rule.



---

archive/issue_comments_533988.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 egourgoulhon]:\n> Replying to [comment:19 tscrim]:\n> > I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).\n\n> \n> In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?\n\n\nIt has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.",
    "created_at": "2019-04-17T01:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533988",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:24'></a>Replying to [comment:22 egourgoulhon]:
> Replying to [comment:19 tscrim]:
> > I am okay with the current state modulo an additional comment at the lazy import referencing this ticket and the general issue. Once done, positive review since it now passes on the patchbot (modulo one test which is unrelated).

> 
> In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?


It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.



---

archive/issue_comments_533989.json:
```json
{
    "body": "Changing commit from \"093bd082a9d1129444e7fa5085796cac39fc881d\" to \"4060557d205263fd5c8a2ce2e1d0e0e96e5baa94\"",
    "created_at": "2019-04-17T08:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533989",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "093bd082a9d1129444e7fa5085796cac39fc881d" to "4060557d205263fd5c8a2ce2e1d0e0e96e5baa94"



---

archive/issue_comments_533990.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-17T08:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533990",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_533991.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:23 tscrim]:\n> \n> I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.\n\n\nTrue. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have \n\n```\nclass VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)\n```\nso that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead\n\n```\nclass VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)\n```\nClearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in comment:19. \n\n> Thus, I think importing it is the correct thing to do. IMO, this falls under the \"explicit is better than implicit\" rule.\n\n\nOK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization.",
    "created_at": "2019-04-17T08:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533991",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:26'></a>Replying to [comment:23 tscrim]:
> 
> I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.


True. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have 

```
class VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)
```
so that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead

```
class VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)
```
Clearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in comment:19. 

> Thus, I think importing it is the correct thing to do. IMO, this falls under the "explicit is better than implicit" rule.


OK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization.



---

archive/issue_comments_533992.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:24 tscrim]:\n> Replying to [comment:22 egourgoulhon]:\n> > \n> > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?\n\n> \n> It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.\n\n\nThanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion).",
    "created_at": "2019-04-17T09:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533992",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:27'></a>Replying to [comment:24 tscrim]:
> Replying to [comment:22 egourgoulhon]:
> > 
> > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?

> 
> It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.


Thanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion).



---

archive/issue_comments_533993.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 egourgoulhon]:\n> Replying to [comment:24 tscrim]:\n> > Replying to [comment:22 egourgoulhon]:\n> > > \n> > > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?\n\n> > \n> > It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.\n\n> \n> Thanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion). \n\n\nThis is not something of any real benefit as just that file is loaded (all of the other imports are done within the functions). The bigger things that need to be lazily imported are a lot of things in `combinat` (IIRC, Nicolas did a big lazy import and startup time dropped by a third) and some of the other highly specialized features that are not performance critical.\n\nTL;DR. I wouldn't do that.",
    "created_at": "2019-04-17T10:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533993",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:28'></a>Replying to [comment:27 egourgoulhon]:
> Replying to [comment:24 tscrim]:
> > Replying to [comment:22 egourgoulhon]:
> > > 
> > > In the current setting, the lazy import is no longer necessary (I have however kept it). Do you think the comment is still appropriate? Shall we revert to the direct import? What is the policy about lazy imports vs. direct imports. I've noticed that in the manifold part, all imports are lazy ones, except for the catalog, while here (`src/sage/tensor/modules/all.py`) it was a true import. I don't remember the reason about this... Was it a matter of performance?

> > 
> > It has to do with startup time. A lazy import means that it will not get resolved right away, which means things that are not needed at startup are not loaded. Since the manifolds has a lot of imports internally, we want to lazily import the block rather than do it at startup. While the import is usually not something we typically notice as humans, the startup time issue has a lot of these and is death by a 1000 needles.

> 
> Thanks for your reply. It's clearly a good thing to set a lazy import for `FiniteRankFreeModule` to decrease Sage startup time. Shouldn't we do the same thing for `sage.manifolds.catalog` in `src/sage/manifolds/all.py`? (I plan to work on the manifold catalog soon anyway, so that I could perform this change at this occasion). 


This is not something of any real benefit as just that file is loaded (all of the other imports are done within the functions). The bigger things that need to be lazily imported are a lot of things in `combinat` (IIRC, Nicolas did a big lazy import and startup time dropped by a third) and some of the other highly specialized features that are not performance critical.

TL;DR. I wouldn't do that.



---

archive/issue_comments_533994.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:26 egourgoulhon]:\n> Replying to [comment:23 tscrim]:\n> > \n> > I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.\n\n> \n> True. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have \n> \n> ```\n> class VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)\n> ```\n> so that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead\n> \n> ```\n> class VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)\n> ```\n> Clearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in comment:19. \n\n\nI will leave the higher level decisions to you on that. Just let me know what you want me to review. `;)`\n\n> > Thus, I think importing it is the correct thing to do. IMO, this falls under the \"explicit is better than implicit\" rule.\n\n> \n> OK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization. \n\n\nThank you. LGTM.",
    "created_at": "2019-04-17T10:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533994",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:29'></a>Replying to [comment:26 egourgoulhon]:
> Replying to [comment:23 tscrim]:
> > 
> > I think that is a bad to false argument. The fact that this code means there is some interaction between the two. It is not that you want everything else to behave like a `Chart`, but you want specific behavior for a `Chart`.

> 
> True. Having to deal with a `Chart` object at this level is a sign of bad design. A clean solution would be to redefine `_preparse_display` in the manifold part, i.e. as `TensorFieldParal._preparse_display`. But this would require to rearrange the inheritance structure of tensor fields. For instance, at the moment we have 
> 
> ```
> class VectorFieldParal(FiniteRankFreeModuleElement, MultivectorFieldParal, VectorField)
> ```
> so that for a vector field `v`, `v._preparse_display` will invoke `FreeModuleTensor._preparse_display`, not `TensorFieldParal._preparse_display`. We need the MRO to be instead
> 
> ```
> class VectorFieldParal(MultivectorFieldParal, FiniteRankFreeModuleElement, VectorField)
> ```
> Clearly, such a reorganization is beyond the scope of the current ticket and deserves its own ticket. So, for the time being, I've kept the import of `Chart` in `free_module_tensor.py` and have added a TODO comment to it. I've also added a comment about the lazy import in `all.py`, as suggested in comment:19. 


I will leave the higher level decisions to you on that. Just let me know what you want me to review. `;)`

> > Thus, I think importing it is the correct thing to do. IMO, this falls under the "explicit is better than implicit" rule.

> 
> OK. As said above, we have now the explicit import of `Chart`, along with a TODO comment for a future reorganization. 


Thank you. LGTM.



---

archive/issue_comments_533995.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-17T10:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533995",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_533996.json:
```json
{
    "body": "<a id='comment:30'></a>Thanks for the review and the discussion!",
    "created_at": "2019-04-17T12:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533996",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:30'></a>Thanks for the review and the discussion!



---

archive/issue_comments_533997.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-18T19:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533997",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_068631.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-18T19:56:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27655#event-68631"
}
```



---

archive/issue_comments_533998.json:
```json
{
    "body": "Changing branch from \"public/manifolds/display_from_chart\" to \"4060557d205263fd5c8a2ce2e1d0e0e96e5baa94\"",
    "created_at": "2019-04-18T19:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27655",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27655#issuecomment-533998",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/manifolds/display_from_chart" to "4060557d205263fd5c8a2ce2e1d0e0e96e5baa94"
