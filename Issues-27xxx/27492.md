# Issue 27492: Bug in parallelized computations involving symbolic functions

archive/issues_027255.json:
```json
{
    "body": "Sage fails in parallelized computations on tensor fields involving symbolic functions (without any symbolic function in the tensor components, everything is OK). Here is an example with Sage 9.3.beta6 (`...` indicates truncated output, see the attachment for the full log):\n\n```\nsage: Parallelism().set(nproc=2)                                                                    \nsage: M = Manifold(2, 'M')                                                                          \nsage: X.<x,y> = M.chart()                                                                           \nsage: t = M.tensor_field(0, 2)                                                                      \nsage: t[0,0], t[0,1], t[1,1] = function('f')(x), x+y, x-y                                           \nsage: v = M.vector_field(1 + x*y, -x^2)                                                             \nsage: s = t.contract(v)  # parallelized computation occurs here\n---------------------------------------------------------------------------\nRemoteTraceback                           Traceback (most recent call last)\nRemoteTraceback: \n\"\"\"\nTraceback (most recent call last):\n  File \"/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py\", line 718, in __init__\n    self._name = parent._create(value, name=name)\n  File \"/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/maxima_lib.py\", line 604, in _create\n    self.set(name, value)\n...\n  File \"sage/libs/ecl.pyx\", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5735)\n    raise RuntimeError(\"ECL says: {}\".format(\nRuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/usr/lib/python3.8/multiprocessing/pool.py\", line 125, in worker\n    result = (True, func(*args, **kwds))\n  File \"sage/misc/fpickle.pyx\", line 104, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2384)\n    res = eval(\"f(*args, **kwds)\",sage.all.__dict__, {'args':args, 'kwds':kwds, 'f':f})\n  File \"<string>\", line 1, in <module>\n  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/tensor/modules/comp.py\", line 2329, in make_Contraction\n    sm += this[[ind_s]] * other[[ind_o]]\n...\n File \"/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py\", line 720, in __init__\n    raise TypeError(x)\nTypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n\"\"\"\n\nThe above exception was the direct cause of the following exception:\n\nTypeError                                 Traceback (most recent call last)\n<ipython-input-9-d1a8f1c47ea1> in <module>\n----> 1 s = t.contract(v)  # parallelized computation occurs here\n...\n/usr/lib/python3.8/multiprocessing/pool.py in next(self, timeout)\n    866         if success:\n    867             return value\n--> 868         raise value\n    869 \n    870     __next__ = next                    # XXX\n\nTypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n```\n\n\nThe full error message is attached.\n\nThis issue has been reported in various places previously. With old Python-2 Sage it resulted in a silent error, see\nthis [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)).\n\n**CC:**  @man74cio @rwst @mkoeppe @tscrim\n\n**Keywords:** parallelization, symbolic functions\n\nIssue created by migration from https://trac.sagemath.org/ticket/27492\n\n",
    "created_at": "2019-03-15T13:21:59Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "title": "Bug in parallelized computations involving symbolic functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27492",
    "user": "https://github.com/egourgoulhon"
}
```
Sage fails in parallelized computations on tensor fields involving symbolic functions (without any symbolic function in the tensor components, everything is OK). Here is an example with Sage 9.3.beta6 (`...` indicates truncated output, see the attachment for the full log):

```
sage: Parallelism().set(nproc=2)                                                                    
sage: M = Manifold(2, 'M')                                                                          
sage: X.<x,y> = M.chart()                                                                           
sage: t = M.tensor_field(0, 2)                                                                      
sage: t[0,0], t[0,1], t[1,1] = function('f')(x), x+y, x-y                                           
sage: v = M.vector_field(1 + x*y, -x^2)                                                             
sage: s = t.contract(v)  # parallelized computation occurs here
---------------------------------------------------------------------------
RemoteTraceback                           Traceback (most recent call last)
RemoteTraceback: 
"""
Traceback (most recent call last):
  File "/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py", line 718, in __init__
    self._name = parent._create(value, name=name)
  File "/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/maxima_lib.py", line 604, in _create
    self.set(name, value)
...
  File "sage/libs/ecl.pyx", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5735)
    raise RuntimeError("ECL says: {}".format(
RuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.8/multiprocessing/pool.py", line 125, in worker
    result = (True, func(*args, **kwds))
  File "sage/misc/fpickle.pyx", line 104, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2384)
    res = eval("f(*args, **kwds)",sage.all.__dict__, {'args':args, 'kwds':kwds, 'f':f})
  File "<string>", line 1, in <module>
  File "/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/tensor/modules/comp.py", line 2329, in make_Contraction
    sm += this[[ind_s]] * other[[ind_o]]
...
 File "/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py", line 720, in __init__
    raise TypeError(x)
TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
"""

The above exception was the direct cause of the following exception:

TypeError                                 Traceback (most recent call last)
<ipython-input-9-d1a8f1c47ea1> in <module>
----> 1 s = t.contract(v)  # parallelized computation occurs here
...
/usr/lib/python3.8/multiprocessing/pool.py in next(self, timeout)
    866         if success:
    867             return value
--> 868         raise value
    869 
    870     __next__ = next                    # XXX

TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
```


The full error message is attached.

This issue has been reported in various places previously. With old Python-2 Sage it resulted in a silent error, see
this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)).

**CC:**  @man74cio @rwst @mkoeppe @tscrim

**Keywords:** parallelization, symbolic functions

Issue created by migration from https://trac.sagemath.org/ticket/27492





---

archive/attachments_021183.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "error_message_py3.txt",
    "asset_url": "tarball://root/attachments/some-uuid/ticket27492/error_message_py3.txt",
    "created_at": "2019-03-15T13:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.txt",
    "user": "https://github.com/egourgoulhon"
}
```



---

archive/issue_comments_428259.json:
```json
{
    "body": "<a id='comment:1'></a>\n",
    "created_at": "2019-03-15T13:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428259",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>




---

archive/issue_comments_428260.json:
```json
{
    "body": "<a id='comment:2'></a>\nTicket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428260",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_242749.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27492#event-242749"
}
```



---

archive/issue_events_242750.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27492#event-242750"
}
```



---

archive/issue_events_242751.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:55:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27492#event-242751"
}
```



---

archive/issue_comments_428261.json:
```json
{
    "body": "<a id='comment:3'></a>\nAs the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428261",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_428262.json:
```json
{
    "body": "<a id='comment:4'></a>\nTo help you along with this: it's probably a matter that the existence of the symbolic function 'f' isn't properly coordinated across the inter-process communication, so that a new symbolic function, also called 'f' is created at some point:\n\n```\nsage: a_new=s0.operands()[2]\nsage: a\nf(x)\nsage: a_new\nf(x)\nsage: a - a\n0\nsage: a - a_new #this indicates something fishy\n-f(x) + f(x)\nsage: bool( a==a_new)\nTrue\nsage: s0.subs({a_new: a})\n-x^3 - (x^2 - x*f(x))*y + f(x)\nsage: s0.subs({a_new: a}).coefficient(a,1)\nx*y + 1\n```\nIf may pickling that's (part of) the problem:\n\n```\nsage: function('f')(x)-function('f')(x)\n0\nsage: function('f')(x)-SR('f(x)')\n0\nsage: loads(dumps(SR('f(x)')))-SR('f(x)')\n0\nsage: function('f')(x)-SR('f(x)')\nf(x) - f(x)\nsage: loads(dumps(function('f')(x)))-function('f')(x)\n-f(x) + f(x)\nsage: loads(dumps(function('f')(x)))-SR('f(x)')\n0\n```\nas you can see, the different ways of creating a symbolic function start out as giving the same result. However, as soon as pickling has been involved, something changes, and results are not compatible any more. from that point onwards, `SR('f(x)')` seems to produce results consistent with pickling, but `function('f')(x)` is reliably not compatible (and in fact, further investigation shows that `function('f')(x)` across different invocations of pickle returns unidentical results. So there's some naste cache wiping/corruption going on somewhere.\n\nYou can see part of it here:\n\n```\nsage: explain_pickle(dumps(function('f')(x)))\npg_Expression = unpickle_global('sage.symbolic.expression', 'Expression')\nsi = unpickle_newobj(pg_Expression, ())\nunpickle_build(si, (0r, ['x'], 'GARC\\x03\\tfunction\\x00class\\x00symbol\\x00x\\x00name\\x00seq\\x00python\\x00f\\x00sage_ex\\x00\\x01\\x08\\x01\\x02\\x02\\n\\x02\"\\x03\\x04\\n\\x00+\\x001\\x00\"\\x07'))\nsi\n```\nAs you can see, there's a rather opague string involved. The `unpickle_build` is part of the getstate/setstate protocol, and reading `sage.symbolic.expression.Expression.__setstate__` and `sage.symbolic.expression.Expression.__getstate__` shows you that a Pynac archive is involved. It's not hard to imagine the coordination problems that can arise when using such low-level tools. This needs a pynac expert. See https://github.com/pynac/pynac/issues/349 (if github is preferred for tracking pynac)",
    "created_at": "2019-10-27T18:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428262",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>
To help you along with this: it's probably a matter that the existence of the symbolic function 'f' isn't properly coordinated across the inter-process communication, so that a new symbolic function, also called 'f' is created at some point:

```
sage: a_new=s0.operands()[2]
sage: a
f(x)
sage: a_new
f(x)
sage: a - a
0
sage: a - a_new #this indicates something fishy
-f(x) + f(x)
sage: bool( a==a_new)
True
sage: s0.subs({a_new: a})
-x^3 - (x^2 - x*f(x))*y + f(x)
sage: s0.subs({a_new: a}).coefficient(a,1)
x*y + 1
```
If may pickling that's (part of) the problem:

```
sage: function('f')(x)-function('f')(x)
0
sage: function('f')(x)-SR('f(x)')
0
sage: loads(dumps(SR('f(x)')))-SR('f(x)')
0
sage: function('f')(x)-SR('f(x)')
f(x) - f(x)
sage: loads(dumps(function('f')(x)))-function('f')(x)
-f(x) + f(x)
sage: loads(dumps(function('f')(x)))-SR('f(x)')
0
```
as you can see, the different ways of creating a symbolic function start out as giving the same result. However, as soon as pickling has been involved, something changes, and results are not compatible any more. from that point onwards, `SR('f(x)')` seems to produce results consistent with pickling, but `function('f')(x)` is reliably not compatible (and in fact, further investigation shows that `function('f')(x)` across different invocations of pickle returns unidentical results. So there's some naste cache wiping/corruption going on somewhere.

You can see part of it here:

```
sage: explain_pickle(dumps(function('f')(x)))
pg_Expression = unpickle_global('sage.symbolic.expression', 'Expression')
si = unpickle_newobj(pg_Expression, ())
unpickle_build(si, (0r, ['x'], 'GARC\x03\tfunction\x00class\x00symbol\x00x\x00name\x00seq\x00python\x00f\x00sage_ex\x00\x01\x08\x01\x02\x02\n\x02"\x03\x04\n\x00+\x001\x00"\x07'))
si
```
As you can see, there's a rather opague string involved. The `unpickle_build` is part of the getstate/setstate protocol, and reading `sage.symbolic.expression.Expression.__setstate__` and `sage.symbolic.expression.Expression.__getstate__` shows you that a Pynac archive is involved. It's not hard to imagine the coordination problems that can arise when using such low-level tools. This needs a pynac expert. See https://github.com/pynac/pynac/issues/349 (if github is preferred for tracking pynac)



---

archive/issue_comments_428263.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with \n+As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with \n Sage 8.7.beta7 (**python2** version) is\n \n ```\n``````\n",
    "created_at": "2019-11-06T11:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428263",
    "user": "https://github.com/egourgoulhon"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with 
+As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with 
 Sage 8.7.beta7 (**python2** version) is
 
 ```
``````




---

archive/issue_comments_428264.json:
```json
{
    "body": "<a id='comment:7'></a>\nSince false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.",
    "created_at": "2019-11-21T12:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428264",
    "user": "https://github.com/DeRhamSource"
}
```

<a id='comment:7'></a>
Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.



---

archive/issue_comments_428265.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [gh-DeRhamSource](#comment%3A7):\n> Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.\n\nFortunately, with Python 3 (and hence Sage 9.0), there is no longer any silent error: a `TypeError` exception is raised instead. So there is no need to disable a feature (parallelization) that is massively used in tensor calculus on manifolds (see e.g. many of [these examples](https://sagemanifolds.obspm.fr/examples.html)).",
    "created_at": "2019-11-21T13:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428265",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>
Replying to [gh-DeRhamSource](#comment%3A7):
> Since false results are produced, it seems to be a severe bug. On this, I'd suggest either to solve it for milestone 9 or at least to disable the feature or give it a warning in the documentation until a solution is found.

Fortunately, with Python 3 (and hence Sage 9.0), there is no longer any silent error: a `TypeError` exception is raised instead. So there is no need to disable a feature (parallelization) that is massively used in tensor calculus on manifolds (see e.g. many of [these examples](https://sagemanifolds.obspm.fr/examples.html)).



---

archive/issue_comments_428266.json:
```json
{
    "body": "<a id='comment:9'></a>\nAh I see. And in conclusion, python2 will not even be supported anymore?\n\nSorry for interfering then. :)",
    "created_at": "2019-11-21T13:50:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428266",
    "user": "https://github.com/DeRhamSource"
}
```

<a id='comment:9'></a>
Ah I see. And in conclusion, python2 will not even be supported anymore?

Sorry for interfering then. :)



---

archive/issue_comments_428267.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [gh-DeRhamSource](#comment%3A9):\n> Ah I see. And in conclusion, python2 will not even be supported anymore?\n> \n\n\nPython 2 is almost dead: https://pythonclock.org/",
    "created_at": "2019-11-21T15:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428267",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>
Replying to [gh-DeRhamSource](#comment%3A9):
> Ah I see. And in conclusion, python2 will not even be supported anymore?
> 


Python 2 is almost dead: https://pythonclock.org/



---

archive/issue_comments_428268.json:
```json
{
    "body": "<a id='comment:13'></a>\nWhat about this ticket?",
    "created_at": "2020-08-01T13:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428268",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
What about this ticket?



---

archive/issue_comments_428269.json:
```json
{
    "body": "<a id='comment:14'></a>\nThis bug is really annoying in terms of applications. You need parallelization to speed things up, especially in this case. I thought maybe you have some ideas to contribute. If not, my apologies.",
    "created_at": "2020-08-01T13:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428269",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:14'></a>
This bug is really annoying in terms of applications. You need parallelization to speed things up, especially in this case. I thought maybe you have some ideas to contribute. If not, my apologies.



---

archive/issue_comments_428270.json:
```json
{
    "body": "<a id='comment:15'></a>\nCould you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.",
    "created_at": "2020-08-01T15:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428270",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.



---

archive/issue_comments_428271.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -42,3 +42,49 @@\n TypeError: expected str, bytes found\n ```\n The full error message is attached. \n+\n+**UPDATE** (1 Aug. 2020): the parallel computation still fails in Sage 9.2.beta6, but this time the error message is different:\n+\n+```\n+sage: s = t.contract(v) \n+---------------------------------------------------------------------------\n+RemoteTraceback                           Traceback (most recent call last)\n+RemoteTraceback: \n+\"\"\"\n+Traceback (most recent call last):\n+  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 718, in __init__\n+...\n+  File \"sage/libs/ecl.pyx\", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5707)\n+    raise RuntimeError(\"ECL says: {}\".format(\n+RuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n+\n+During handling of the above exception, another exception occurred:\n+\n+Traceback (most recent call last):\n+  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py\", line 121, in worker\n+    result = (True, func(*args, **kwds))\n+  File \"sage/misc/fpickle.pyx\", line 100, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2313)\n+    res = eval(\"f(*args, **kwds)\",sage.all.__dict__, {'args':args, 'kwds':kwds, 'f':f})\n+  File \"<string>\", line 1, in <module>\n+  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/tensor/modules/comp.py\", line 2329, in make_Contraction\n+    sm += this[[ind_s]] * other[[ind_o]]\n+...\n+  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 720, in __init__\n+    raise TypeError(x)\n+TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n+\"\"\"\n+\n+The above exception was the direct cause of the following exception:\n+\n+TypeError                                 Traceback (most recent call last)\n+...\n+/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py in next(self, timeout)\n+    746         if success:\n+    747             return value\n+--> 748         raise value\n+    749 \n+    750     __next__ = next                    # XXX\n+\n+TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n+```\n+The full error message is attached.\n``````\n",
    "created_at": "2020-08-01T21:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428271",
    "user": "https://github.com/egourgoulhon"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -42,3 +42,49 @@
 TypeError: expected str, bytes found
 ```
 The full error message is attached. 
+
+**UPDATE** (1 Aug. 2020): the parallel computation still fails in Sage 9.2.beta6, but this time the error message is different:
+
+```
+sage: s = t.contract(v) 
+---------------------------------------------------------------------------
+RemoteTraceback                           Traceback (most recent call last)
+RemoteTraceback: 
+"""
+Traceback (most recent call last):
+  File "/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 718, in __init__
+...
+  File "sage/libs/ecl.pyx", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5707)
+    raise RuntimeError("ECL says: {}".format(
+RuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
+
+During handling of the above exception, another exception occurred:
+
+Traceback (most recent call last):
+  File "/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py", line 121, in worker
+    result = (True, func(*args, **kwds))
+  File "sage/misc/fpickle.pyx", line 100, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2313)
+    res = eval("f(*args, **kwds)",sage.all.__dict__, {'args':args, 'kwds':kwds, 'f':f})
+  File "<string>", line 1, in <module>
+  File "/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/tensor/modules/comp.py", line 2329, in make_Contraction
+    sm += this[[ind_s]] * other[[ind_o]]
+...
+  File "/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 720, in __init__
+    raise TypeError(x)
+TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
+"""
+
+The above exception was the direct cause of the following exception:
+
+TypeError                                 Traceback (most recent call last)
+...
+/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py in next(self, timeout)
+    746         if success:
+    747             return value
+--> 748         raise value
+    749 
+    750     __next__ = next                    # XXX
+
+TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
+```
+The full error message is attached.
``````




---

archive/attachments_021184.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "error_message_Sage_9.2.beta6.txt",
    "asset_url": "tarball://root/attachments/some-uuid/ticket27492/error_message_Sage_9.2.beta6.txt",
    "created_at": "2020-08-01T21:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.txt",
    "user": "https://github.com/egourgoulhon"
}
```



---

archive/issue_comments_428272.json:
```json
{
    "body": "",
    "created_at": "2020-08-01T21:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428272",
    "user": "https://github.com/egourgoulhon"
}
```





---

archive/issue_comments_428273.json:
```json
{
    "body": "<a id='comment:17'></a>\nWell, there are lots of libraries involved in symbolics, so lots of questions.\n\nI guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.\n\nThe reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)",
    "created_at": "2020-08-04T19:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428273",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
Well, there are lots of libraries involved in symbolics, so lots of questions.

I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.

The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)



---

archive/issue_comments_428274.json:
```json
{
    "body": "<a id='comment:18'></a>\nSee #31047 for a related issue.",
    "created_at": "2020-12-16T10:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428274",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:18'></a>
See #31047 for a related issue.



---

archive/issue_comments_428275.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,4 @@\n-As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with \n-Sage 8.7.beta7 (**python2** version) is\n+Sage fails in parallelized computations on tensor fields involving symbolic functions: \n \n ```\n sage: Parallelism().set(nproc=2)\n@@ -11,42 +10,6 @@\n sage: v = M.vector_field()\n sage: v[0], v[1] = 1 + x*y, -x^2\n sage: s = t.contract(v)  # parallelized computation occurs here\n-sage: s0 = s[0].expr(); s0  # symbolic expression OK\n--x^3 - (x^2 - x*f(x))*y + f(x)\n-sage: s0.coefficient(a, 1)  # incorrect output\n-0\n-```\n-The correct result should be `x*y + 1`. The latter is obtained if one sets `nproc=1` in the first line (i.e. no parallelization). Furthermore, if one replaces the line\n-\n-```\n-sage: a = function('f')(x)\n-```\n-by \n-\n-```\n-sage: a = sin(x)\n-```\n-one gets a correct result as well.\n-\n-With the **python3** version of Sage 8.7.beta7, one does not get a silent failure but an error message when the parallel computation is performed, i.e. at the line `s = t.contract(v)`: \n-\n-```\n-TypeError                                 Traceback (most recent call last)\n-/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/symbolic/function_factory.py in function_factory(name, nargs, latex_name, conversions, evalf_params_first, eval_func, evalf_func, conjugate_func, real_part_func, imag_part_func, derivative_func, tderivative_func, power_func, series_func, print_func, print_latex_func)\n-    109             setattr(NewSymbolicFunction, '_%s_'%func_name, func)\n-    110 \n---> 111     return NewSymbolicFunction()\n-    112 \n-    113 \n-...\n-TypeError: expected str, bytes found\n-```\n-The full error message is attached. \n-\n-**UPDATE** (1 Aug. 2020): the parallel computation still fails in Sage 9.2.beta6, but this time the error message is different:\n-\n-```\n-sage: s = t.contract(v) \n ---------------------------------------------------------------------------\n RemoteTraceback                           Traceback (most recent call last)\n RemoteTraceback: \n@@ -88,3 +51,6 @@\n TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n ```\n The full error message is attached.\n+\n+This issue has been reported in various places previously. With old Python-2 Sage it resulted in a silent error, see\n+this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)).\n``````\n",
    "created_at": "2020-12-16T10:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428275",
    "user": "https://github.com/egourgoulhon"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,4 @@
-As reported in this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)), Sage fails silently on some parallelized computations involving symbolic functions. A minimal example with 
-Sage 8.7.beta7 (**python2** version) is
+Sage fails in parallelized computations on tensor fields involving symbolic functions: 
 
 ```
 sage: Parallelism().set(nproc=2)
@@ -11,42 +10,6 @@
 sage: v = M.vector_field()
 sage: v[0], v[1] = 1 + x*y, -x^2
 sage: s = t.contract(v)  # parallelized computation occurs here
-sage: s0 = s[0].expr(); s0  # symbolic expression OK
--x^3 - (x^2 - x*f(x))*y + f(x)
-sage: s0.coefficient(a, 1)  # incorrect output
-0
-```
-The correct result should be `x*y + 1`. The latter is obtained if one sets `nproc=1` in the first line (i.e. no parallelization). Furthermore, if one replaces the line
-
-```
-sage: a = function('f')(x)
-```
-by 
-
-```
-sage: a = sin(x)
-```
-one gets a correct result as well.
-
-With the **python3** version of Sage 8.7.beta7, one does not get a silent failure but an error message when the parallel computation is performed, i.e. at the line `s = t.contract(v)`: 
-
-```
-TypeError                                 Traceback (most recent call last)
-/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/symbolic/function_factory.py in function_factory(name, nargs, latex_name, conversions, evalf_params_first, eval_func, evalf_func, conjugate_func, real_part_func, imag_part_func, derivative_func, tderivative_func, power_func, series_func, print_func, print_latex_func)
-    109             setattr(NewSymbolicFunction, '_%s_'%func_name, func)
-    110 
---> 111     return NewSymbolicFunction()
-    112 
-    113 
-...
-TypeError: expected str, bytes found
-```
-The full error message is attached. 
-
-**UPDATE** (1 Aug. 2020): the parallel computation still fails in Sage 9.2.beta6, but this time the error message is different:
-
-```
-sage: s = t.contract(v) 
 ---------------------------------------------------------------------------
 RemoteTraceback                           Traceback (most recent call last)
 RemoteTraceback: 
@@ -88,3 +51,6 @@
 TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
 ```
 The full error message is attached.
+
+This issue has been reported in various places previously. With old Python-2 Sage it resulted in a silent error, see
+this [sage-devel post](https://groups.google.com/forum/#!topic/sage-devel/k4W5eo4nQ50) (see also [this one](https://groups.google.com/d/msg/sage-devel/I00PGgyIZYo/RkCYmlmZEAAJ)).
``````




---

archive/issue_comments_428276.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [mkoeppe](#comment%3A15):\n> Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.\n\n\nDone.",
    "created_at": "2020-12-16T10:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428276",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:20'></a>
Replying to [mkoeppe](#comment%3A15):
> Could you try to update & clarify the ticket description please? It's OK to delete everything related to python2. We no longer support it.


Done.



---

archive/issue_comments_428277.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [mkoeppe](#comment%3A17):\n> Well, there are lots of libraries involved in symbolics, so lots of questions.\n> \n> I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.\n\n\nThe parallelization is based on the Python module [multiprocessing](https://docs.python.org/3/library/multiprocessing.html), so it involves several processes. \n> \n> The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)\n\n\nThere is no error when the involved symbolic expressions do not contain any symbolic function, so I would say that is not an issue with Maxima and parallelization, but rather an issue with Sage's symbolic functions (cf. [comment:4](#comment%3A4) and #31047).",
    "created_at": "2020-12-16T10:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428277",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:21'></a>
Replying to [mkoeppe](#comment%3A17):
> Well, there are lots of libraries involved in symbolics, so lots of questions.
> 
> I guess the first question to ask is whether the parallelization that you use involves several threads in one process, or several processes.


The parallelization is based on the Python module [multiprocessing](https://docs.python.org/3/library/multiprocessing.html), so it involves several processes. 
> 
> The reported error comes from Maxima, which runs in ECL. Is ECL prepared and configured for threadsafe operation? Are the parts of Maxima that the symbolics code uses threadsafe? (The assumptions code that I touched in #30074 is definitely not threadsafe.)


There is no error when the involved symbolic expressions do not contain any symbolic function, so I would say that is not an issue with Maxima and parallelization, but rather an issue with Sage's symbolic functions (cf. [comment:4](#comment%3A4) and #31047).



---

archive/issue_comments_428278.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,38 +1,39 @@\n-Sage fails in parallelized computations on tensor fields involving symbolic functions: \n+Sage fails in parallelized computations on tensor fields involving symbolic functions (without any symbolic function in the tensor components, everything is OK). Here is an example with Sage 9.3.beta6 (`...` indicates truncated output, see the attachment for the full log):\n \n ```\n-sage: Parallelism().set(nproc=2)\n-sage: M = Manifold(2, 'M')\n-sage: X.<x,y> = M.chart()\n-sage: a = function('f')(x)\n-sage: t = M.tensor_field(0, 2)\n-sage: t[0,0], t[0,1], t[1,1] = a, x+y, x-y\n-sage: v = M.vector_field()\n-sage: v[0], v[1] = 1 + x*y, -x^2\n+sage: Parallelism().set(nproc=2)                                                                    \n+sage: M = Manifold(2, 'M')                                                                          \n+sage: X.<x,y> = M.chart()                                                                           \n+sage: t = M.tensor_field(0, 2)                                                                      \n+sage: t[0,0], t[0,1], t[1,1] = function('f')(x), x+y, x-y                                           \n+sage: v = M.vector_field(1 + x*y, -x^2)                                                             \n sage: s = t.contract(v)  # parallelized computation occurs here\n ---------------------------------------------------------------------------\n RemoteTraceback                           Traceback (most recent call last)\n RemoteTraceback: \n \"\"\"\n Traceback (most recent call last):\n-  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 718, in __init__\n+  File \"/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py\", line 718, in __init__\n+    self._name = parent._create(value, name=name)\n+  File \"/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/maxima_lib.py\", line 604, in _create\n+    self.set(name, value)\n ...\n-  File \"sage/libs/ecl.pyx\", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5707)\n+  File \"sage/libs/ecl.pyx\", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5735)\n     raise RuntimeError(\"ECL says: {}\".format(\n RuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n \n During handling of the above exception, another exception occurred:\n \n Traceback (most recent call last):\n-  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py\", line 121, in worker\n+  File \"/usr/lib/python3.8/multiprocessing/pool.py\", line 125, in worker\n     result = (True, func(*args, **kwds))\n-  File \"sage/misc/fpickle.pyx\", line 100, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2313)\n+  File \"sage/misc/fpickle.pyx\", line 104, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2384)\n     res = eval(\"f(*args, **kwds)\",sage.all.__dict__, {'args':args, 'kwds':kwds, 'f':f})\n   File \"<string>\", line 1, in <module>\n   File \"/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/tensor/modules/comp.py\", line 2329, in make_Contraction\n     sm += this[[ind_s]] * other[[ind_o]]\n ...\n-  File \"/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py\", line 720, in __init__\n+ File \"/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py\", line 720, in __init__\n     raise TypeError(x)\n TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n \"\"\"\n@@ -40,16 +41,20 @@\n The above exception was the direct cause of the following exception:\n \n TypeError                                 Traceback (most recent call last)\n+<ipython-input-9-d1a8f1c47ea1> in <module>\n+----> 1 s = t.contract(v)  # parallelized computation occurs here\n ...\n-/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py in next(self, timeout)\n-    746         if success:\n-    747             return value\n---> 748         raise value\n-    749 \n-    750     __next__ = next                    # XXX\n+/usr/lib/python3.8/multiprocessing/pool.py in next(self, timeout)\n+    866         if success:\n+    867             return value\n+--> 868         raise value\n+    869 \n+    870     __next__ = next                    # XXX\n \n TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n ```\n+\n+\n The full error message is attached.\n \n This issue has been reported in various places previously. With old Python-2 Sage it resulted in a silent error, see\n``````\n",
    "created_at": "2021-01-18T09:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428278",
    "user": "https://github.com/egourgoulhon"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,38 +1,39 @@
-Sage fails in parallelized computations on tensor fields involving symbolic functions: 
+Sage fails in parallelized computations on tensor fields involving symbolic functions (without any symbolic function in the tensor components, everything is OK). Here is an example with Sage 9.3.beta6 (`...` indicates truncated output, see the attachment for the full log):
 
 ```
-sage: Parallelism().set(nproc=2)
-sage: M = Manifold(2, 'M')
-sage: X.<x,y> = M.chart()
-sage: a = function('f')(x)
-sage: t = M.tensor_field(0, 2)
-sage: t[0,0], t[0,1], t[1,1] = a, x+y, x-y
-sage: v = M.vector_field()
-sage: v[0], v[1] = 1 + x*y, -x^2
+sage: Parallelism().set(nproc=2)                                                                    
+sage: M = Manifold(2, 'M')                                                                          
+sage: X.<x,y> = M.chart()                                                                           
+sage: t = M.tensor_field(0, 2)                                                                      
+sage: t[0,0], t[0,1], t[1,1] = function('f')(x), x+y, x-y                                           
+sage: v = M.vector_field(1 + x*y, -x^2)                                                             
 sage: s = t.contract(v)  # parallelized computation occurs here
 ---------------------------------------------------------------------------
 RemoteTraceback                           Traceback (most recent call last)
 RemoteTraceback: 
 """
 Traceback (most recent call last):
-  File "/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 718, in __init__
+  File "/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py", line 718, in __init__
+    self._name = parent._create(value, name=name)
+  File "/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/maxima_lib.py", line 604, in _create
+    self.set(name, value)
 ...
-  File "sage/libs/ecl.pyx", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5707)
+  File "sage/libs/ecl.pyx", line 352, in sage.libs.ecl.ecl_safe_funcall (build/cythonized/sage/libs/ecl.c:5735)
     raise RuntimeError("ECL says: {}".format(
 RuntimeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
 
 During handling of the above exception, another exception occurred:
 
 Traceback (most recent call last):
-  File "/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py", line 121, in worker
+  File "/usr/lib/python3.8/multiprocessing/pool.py", line 125, in worker
     result = (True, func(*args, **kwds))
-  File "sage/misc/fpickle.pyx", line 100, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2313)
+  File "sage/misc/fpickle.pyx", line 104, in sage.misc.fpickle.call_pickled_function (build/cythonized/sage/misc/fpickle.c:2384)
     res = eval("f(*args, **kwds)",sage.all.__dict__, {'args':args, 'kwds':kwds, 'f':f})
   File "<string>", line 1, in <module>
   File "/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/tensor/modules/comp.py", line 2329, in make_Contraction
     sm += this[[ind_s]] * other[[ind_o]]
 ...
-  File "/home/eric/sage/9.2.develop/local/lib/python3.7/site-packages/sage/interfaces/interface.py", line 720, in __init__
+ File "/home/eric/sage/9.3.develop/local/lib/python3.8/site-packages/sage/interfaces/interface.py", line 720, in __init__
     raise TypeError(x)
 TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
 """
@@ -40,16 +41,20 @@
 The above exception was the direct cause of the following exception:
 
 TypeError                                 Traceback (most recent call last)
+<ipython-input-9-d1a8f1c47ea1> in <module>
+----> 1 s = t.contract(v)  # parallelized computation occurs here
 ...
-/home/eric/sage/9.2.develop/local/lib/python3.7/multiprocessing/pool.py in next(self, timeout)
-    746         if success:
-    747             return value
---> 748         raise value
-    749 
-    750     __next__ = next                    # XXX
+/usr/lib/python3.8/multiprocessing/pool.py in next(self, timeout)
+    866         if success:
+    867             return value
+--> 868         raise value
+    869 
+    870     __next__ = next                    # XXX
 
 TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
 ```
+
+
 The full error message is attached.
 
 This issue has been reported in various places previously. With old Python-2 Sage it resulted in a silent error, see
``````




---

archive/attachments_021185.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "error_message_Sage_9.3.beta6.txt",
    "asset_url": "tarball://root/attachments/some-uuid/ticket27492/error_message_Sage_9.3.beta6.txt",
    "created_at": "2021-01-18T09:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.txt",
    "user": "https://github.com/egourgoulhon"
}
```



---

archive/issue_comments_428279.json:
```json
{
    "body": "",
    "created_at": "2021-01-18T09:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27492",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27492#issuecomment-428279",
    "user": "https://github.com/egourgoulhon"
}
```


