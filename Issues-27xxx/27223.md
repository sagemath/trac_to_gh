# Issue 27223: Fix legacy uninstall

archive/issues_026986.json:
```json
{
    "body": "It turns out that the legacy uninstallers `spkg-legacy-uninstall` are never actually run due to an always-false executable-bit check.\n\nAlso, it happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted. This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.\n\n**CC:**  @embray\n\n**Branch/Commit:** [3c97621ba148c17490b1e326e7d33d38ebb234ae](https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae)\n\n**Reviewer:** Erik Bray\n\n**Author:** Jeroen Demeyer\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27223\n\n",
    "closed_at": "2019-02-08T12:35:57Z",
    "created_at": "2019-02-05T09:01:21Z",
    "labels": [
        "component: build",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Fix legacy uninstall",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27223",
    "user": "https://github.com/jdemeyer"
}
```
It turns out that the legacy uninstallers `spkg-legacy-uninstall` are never actually run due to an always-false executable-bit check.

Also, it happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted. This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.

**CC:**  @embray

**Branch/Commit:** [3c97621ba148c17490b1e326e7d33d38ebb234ae](https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae)

**Reviewer:** Erik Bray

**Author:** Jeroen Demeyer

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/27223





---

archive/issue_comments_525749.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n It happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.\n \n This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.\n+\n+We also remove the misleading executable-bit check which causes some uninstallers to be silently skipped.\n``````\n",
    "created_at": "2019-02-05T09:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525749",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 It happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.
 
 This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.
+
+We also remove the misleading executable-bit check which causes some uninstallers to be silently skipped.
``````




---

archive/issue_comments_525750.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2019-02-05T09:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525750",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_525751.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,4 +2,4 @@\n \n This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.\n \n-We also remove the misleading executable-bit check which causes some uninstallers to be silently skipped.\n+We also remove the misleading executable-bit check and run the uninstallers as `bash` script.\n``````\n",
    "created_at": "2019-02-05T09:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525751",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,4 +2,4 @@
 
 This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.
 
-We also remove the misleading executable-bit check which causes some uninstallers to be silently skipped.
+We also remove the misleading executable-bit check and run the uninstallers as `bash` script.
``````




---

archive/issue_comments_525752.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present)",
    "created_at": "2019-02-05T09:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525752",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present)



---

archive/issue_events_076670.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "rename": {
        "from": "Legacy uninstaller should be run if no stamp file is present",
        "to": "Fix legacy uninstall"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27223#event-76670"
}
```



---

archive/issue_comments_525753.json:
```json
{
    "body": "**Commit:** [0cf4613f76fbdfe902f053b05b5a378e4b209299](https://github.com/sagemath/sagetrac-mirror/commit/0cf4613f76fbdfe902f053b05b5a378e4b209299)",
    "created_at": "2019-02-05T09:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525753",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [0cf4613f76fbdfe902f053b05b5a378e4b209299](https://github.com/sagemath/sagetrac-mirror/commit/0cf4613f76fbdfe902f053b05b5a378e4b209299)



---

archive/issue_comments_525754.json:
```json
{
    "body": "<a id='comment:4'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0cf4613f76fbdfe902f053b05b5a378e4b209299\">0cf4613</a></td><td><code>Fix legacy uninstall</code></td></tr></table>\n",
    "created_at": "2019-02-05T09:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525754",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0cf4613f76fbdfe902f053b05b5a378e4b209299">0cf4613</a></td><td><code>Fix legacy uninstall</code></td></tr></table>




---

archive/issue_comments_525755.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,3 @@\n-It happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.\n+It turns out that the legacy uninstallers `spkg-legacy-uninstall` are never actually run due to an always-false executable-bit check.\n \n-This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.\n-\n-We also remove the misleading executable-bit check and run the uninstallers as `bash` script.\n+Also, it happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted. This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.\n``````\n",
    "created_at": "2019-02-05T09:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525755",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,3 @@
-It happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.
+It turns out that the legacy uninstallers `spkg-legacy-uninstall` are never actually run due to an always-false executable-bit check.
 
-This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.
-
-We also remove the misleading executable-bit check and run the uninstallers as `bash` script.
+Also, it happens regularly that the stamp file `$SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION` is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted. This can lead to problems like #26996. As a solution, we suggest to always run the legacy uninstaller as fallback if there is no stamp file. This is more in line with how installation worked before the introduction of the new-style stamp files.
``````




---

archive/issue_comments_525756.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2019-02-05T09:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525756",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_525757.json:
```json
{
    "body": "**Changing commit** from \"[0cf4613f76fbdfe902f053b05b5a378e4b209299](https://github.com/sagemath/sagetrac-mirror/commit/0cf4613f76fbdfe902f053b05b5a378e4b209299)\" to \"[bcef97ee2da641cff8f3d904db721bb8a8b9acef](https://github.com/sagemath/sagetrac-mirror/commit/bcef97ee2da641cff8f3d904db721bb8a8b9acef)\".",
    "created_at": "2019-02-05T09:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525757",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[0cf4613f76fbdfe902f053b05b5a378e4b209299](https://github.com/sagemath/sagetrac-mirror/commit/0cf4613f76fbdfe902f053b05b5a378e4b209299)" to "[bcef97ee2da641cff8f3d904db721bb8a8b9acef](https://github.com/sagemath/sagetrac-mirror/commit/bcef97ee2da641cff8f3d904db721bb8a8b9acef)".



---

archive/issue_comments_525758.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bcef97ee2da641cff8f3d904db721bb8a8b9acef\">bcef97e</a></td><td><code>rm -rf never fails; can't use sdh_die here anyway</code></td></tr></table>\n",
    "created_at": "2019-02-05T09:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525758",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bcef97ee2da641cff8f3d904db721bb8a8b9acef">bcef97e</a></td><td><code>rm -rf never fails; can't use sdh_die here anyway</code></td></tr></table>




---

archive/issue_comments_525759.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis is what I found as well.  I was going to post a fix to this last night but didn't have time.",
    "created_at": "2019-02-05T12:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525759",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
This is what I found as well.  I was going to post a fix to this last night but didn't have time.



---

archive/issue_comments_525760.json:
```json
{
    "body": "<a id='comment:8'></a>\nI'm not sure why you changed this message:\n\n```diff\n     if keep_files:\n-        print(\"Removing stamp file '{0}' but keeping package files\".format(\n-            stamp_file))\n+        print(\"Removing stamp file but keeping package files\")\n         remove_stamp_files(stamp_files)\n         return\n```\n\nIsn't it a little bit more helpful to actually specify what file the message is referring to?",
    "created_at": "2019-02-05T12:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525760",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
I'm not sure why you changed this message:

```diff
     if keep_files:
-        print("Removing stamp file '{0}' but keeping package files".format(
-            stamp_file))
+        print("Removing stamp file but keeping package files")
         remove_stamp_files(stamp_files)
         return
```

Isn't it a little bit more helpful to actually specify what file the message is referring to?



---

archive/issue_comments_525761.json:
```json
{
    "body": "<a id='comment:9'></a>\nOther than that, this is just a slightly different formatted version of what I did, so you can set positive review after addressing my one question.",
    "created_at": "2019-02-05T12:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525761",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
Other than that, this is just a slightly different formatted version of what I did, so you can set positive review after addressing my one question.



---

archive/issue_comments_525762.json:
```json
{
    "body": "**Reviewer:** Erik Bray",
    "created_at": "2019-02-05T12:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525762",
    "user": "https://github.com/embray"
}
```

**Reviewer:** Erik Bray



---

archive/issue_comments_525763.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [embray](#comment%3A8):\n> Isn't it a little bit more helpful to actually specify what file the message is referring to?\n\n\nMainly because it's not guaranteed that there is exactly one stamp file.\n\nAlso, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.",
    "created_at": "2019-02-05T12:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525763",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [embray](#comment%3A8):
> Isn't it a little bit more helpful to actually specify what file the message is referring to?


Mainly because it's not guaranteed that there is exactly one stamp file.

Also, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.



---

archive/issue_comments_525764.json:
```json
{
    "body": "<a id='comment:11'></a>\n> Also, it happens regularly that the stamp file $SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.\n\n\nI do consider this a separate issue.  I would like to eventually remove the `spkg-legacy-uninstall` files entirely.  Most of them are not well maintained and their use at all is inconsistent (this is true before the idea of moving that functionality into a separate file).\n\nIn other words, even `spkg-legacy-uninstall` scripts are not a reliable way to deal with partial/failed installations.  I would rather fix this more directly.  For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the \"installation\" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.\n\nThere should also be better error/interrupt handling in the sage-spkg script so that \"partial installs\" can be immediately rolled back when possible.\n\nThe downside to this approach is if an install is interrupted before it's complete, you still have a valid stamp file suggesting the installation was completed.  To address this, maybe it should be written first to a different location (after all, in this case it is serving merely as a file manifest) and then moved into its final location after the successful installation.",
    "created_at": "2019-02-05T12:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525764",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
> Also, it happens regularly that the stamp file $SAGE_LOCAL/var/lib/sage/installed/$PKG-$VERSION is inconsistent with what is actually installed. This can happen for example when package installation failed or was interrupted.


I do consider this a separate issue.  I would like to eventually remove the `spkg-legacy-uninstall` files entirely.  Most of them are not well maintained and their use at all is inconsistent (this is true before the idea of moving that functionality into a separate file).

In other words, even `spkg-legacy-uninstall` scripts are not a reliable way to deal with partial/failed installations.  I would rather fix this more directly.  For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the "installation" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.

There should also be better error/interrupt handling in the sage-spkg script so that "partial installs" can be immediately rolled back when possible.

The downside to this approach is if an install is interrupted before it's complete, you still have a valid stamp file suggesting the installation was completed.  To address this, maybe it should be written first to a different location (after all, in this case it is serving merely as a file manifest) and then moved into its final location after the successful installation.



---

archive/issue_comments_525765.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [jdemeyer](#comment%3A10):\n> Replying to [embray](#comment%3A8):\n> > Isn't it a little bit more helpful to actually specify what file the message is referring to?\n\n> \n> Mainly because it's not guaranteed that there is exactly one stamp file.\n\n\nThat is rarely the case though.  And in any case the message still says \"Removing stamp file\", singular.\n\n> Also, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.\n\n\nThat's fine; I don't care where it goes.",
    "created_at": "2019-02-05T12:58:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525765",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
Replying to [jdemeyer](#comment%3A10):
> Replying to [embray](#comment%3A8):
> > Isn't it a little bit more helpful to actually specify what file the message is referring to?

> 
> Mainly because it's not guaranteed that there is exactly one stamp file.


That is rarely the case though.  And in any case the message still says "Removing stamp file", singular.

> Also, why should the filename of the stamp file be printed in this code path but not in other code paths? If you really want to see a message for removing stamp files, it would better be in the `remove_stamp_files()` function.


That's fine; I don't care where it goes.



---

archive/issue_comments_525766.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [embray](#comment%3A11):\n> For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the \"installation\" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.\n\n\nI think it's too hard to ensure that the stamp file is consistent with the actual installed files. I've had similar issues with `pip` too where `pip` would think that a package is not installed but still some files belonging to that package are installed.\n\nSo rather than improving the stamp files, I would rather improve installation in the case that the stamp files are missing or wrong.",
    "created_at": "2019-02-05T15:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525766",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Replying to [embray](#comment%3A11):
> For example, I think the stamp file could be written *before* copying files into `$SAGE_LOCAL`.  That way, even if the "installation" (which at this point is just copying files) fails, there is at least still a manifest of what files were expected to be in place, so a partial installation can be rolled back.


I think it's too hard to ensure that the stamp file is consistent with the actual installed files. I've had similar issues with `pip` too where `pip` would think that a package is not installed but still some files belonging to that package are installed.

So rather than improving the stamp files, I would rather improve installation in the case that the stamp files are missing or wrong.



---

archive/issue_comments_525767.json:
```json
{
    "body": "<a id='comment:14'></a>\nUnder normal circumstances it's actually exactly consistent, except in the cases of files that are created post-installation which are handled differently.  So I think you'd have to be more specific what you think the problem is.\n\nI'm also not talking about \"improving stamp files\", but rather strategies for managing broken installations.  The \"stamp file\" here is really serving two purposes (where previously it served only one):\n\n* It is an indication that a package installed successfully.\n* It is a manifest of (expected) installed files.\n\nInstallation, when done correctly, is just copying a tree of files from one place to another.  In order to roll back a partial/unsuccessful installation you want to have that manifest somewhere, but not in the actual \"stamp file\" as its existence indicates a successful install.  So what I'm suggesting is instead writing it to something like \".<pkg-name>-<version>.tmp\" prior to installation, and then following a successful installing moving it to \"<pkg-name>-<version>\".\n\nThe uninstall program would also be able to look for these \".<pkg-name>-<version>.tmp\" files in order to clean up broken installations.",
    "created_at": "2019-02-05T15:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525767",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
Under normal circumstances it's actually exactly consistent, except in the cases of files that are created post-installation which are handled differently.  So I think you'd have to be more specific what you think the problem is.

I'm also not talking about "improving stamp files", but rather strategies for managing broken installations.  The "stamp file" here is really serving two purposes (where previously it served only one):

* It is an indication that a package installed successfully.
* It is a manifest of (expected) installed files.

Installation, when done correctly, is just copying a tree of files from one place to another.  In order to roll back a partial/unsuccessful installation you want to have that manifest somewhere, but not in the actual "stamp file" as its existence indicates a successful install.  So what I'm suggesting is instead writing it to something like ".<pkg-name>-<version>.tmp" prior to installation, and then following a successful installing moving it to "<pkg-name>-<version>".

The uninstall program would also be able to look for these ".<pkg-name>-<version>.tmp" files in order to clean up broken installations.



---

archive/issue_comments_525768.json:
```json
{
    "body": "**Changing commit** from \"[bcef97ee2da641cff8f3d904db721bb8a8b9acef](https://github.com/sagemath/sagetrac-mirror/commit/bcef97ee2da641cff8f3d904db721bb8a8b9acef)\" to \"[3c97621ba148c17490b1e326e7d33d38ebb234ae](https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae)\".",
    "created_at": "2019-02-05T16:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525768",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[bcef97ee2da641cff8f3d904db721bb8a8b9acef](https://github.com/sagemath/sagetrac-mirror/commit/bcef97ee2da641cff8f3d904db721bb8a8b9acef)" to "[3c97621ba148c17490b1e326e7d33d38ebb234ae](https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae)".



---

archive/issue_comments_525769.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae\">3c97621</a></td><td><code>Always print message when removing stamp file</code></td></tr></table>\n",
    "created_at": "2019-02-05T16:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525769",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae">3c97621</a></td><td><code>Always print message when removing stamp file</code></td></tr></table>




---

archive/issue_comments_525770.json:
```json
{
    "body": "<a id='comment:16'></a>\nLooks good to me.  I'm sorry I didn't say anything sooner, though I will say your fix is a little cleaner than mine--you restructured things a bit such that there was less duplication than what I had.",
    "created_at": "2019-02-05T16:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525770",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>
Looks good to me.  I'm sorry I didn't say anything sooner, though I will say your fix is a little cleaner than mine--you restructured things a bit such that there was less duplication than what I had.



---

archive/issue_comments_525771.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2019-02-05T16:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525771",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_525772.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present)\" to \"[3c97621ba148c17490b1e326e7d33d38ebb234ae](https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae)\".",
    "created_at": "2019-02-08T12:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525772",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/legacy_uninstaller_should_be_run_if_no_stamp_file_is_present)" to "[3c97621ba148c17490b1e326e7d33d38ebb234ae](https://github.com/sagemath/sagetrac-mirror/commit/3c97621ba148c17490b1e326e7d33d38ebb234ae)".



---

archive/issue_comments_525773.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2019-02-08T12:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27223#issuecomment-525773",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_events_076671.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-08T12:35:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27223",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27223#event-76671"
}
```
