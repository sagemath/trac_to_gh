# Issue 27755: some fixes and pep cleanup in number fields orders

archive/issues_027518.json:
```json
{
    "assignees": [],
    "body": "most important change:\n\nSome orders are built inside a smaller number field.\n\nCC:  @roed314 @tscrim @JohnCremona @jdemeyer\n\nBranch/Commit: **[`e053068`](https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Fr\u00e9d\u00e9ric Chapoton**\n\nComponent: **number fields**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27755_\n\n",
    "closed_at": "2019-05-12T21:30:16Z",
    "created_at": "2019-05-01T09:20:18Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20number%20fields",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "some fixes and pep cleanup in number fields orders",
    "type": "issue",
    "updated_at": "2019-05-12T21:30:16Z",
    "url": "https://github.com/sagemath/sage/issues/27755",
    "user": "https://github.com/fchapoton"
}
```
most important change:

Some orders are built inside a smaller number field.

CC:  @roed314 @tscrim @JohnCremona @jdemeyer

Branch/Commit: **[`e053068`](https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d)**

Reviewer: **Travis Scrimshaw**

Author: **Frédéric Chapoton**

Component: **number fields**

_Issue created by migration from https://trac.sagemath.org/ticket/27755_





---

archive/issue_events_377825.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-05-01T09:20:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377825"
}
```



---

archive/issue_events_377826.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-05-01T09:20:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20number%20fields",
    "label_color": "0000ff",
    "label_name": "c: number fields",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377826"
}
```



---

archive/issue_events_377827.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-05-01T09:20:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377827"
}
```



---

archive/issue_events_377828.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-05-01T09:20:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377828"
}
```



---

archive/issue_comments_430563.json:
```json
{
    "body": "Branch: **[u/chapoton/27755](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27755)**",
    "created_at": "2019-05-01T09:21:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430563",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[u/chapoton/27755](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27755)**



---

archive/issue_comments_430564.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ab206f2d5eea080700b3a0cc3810e1d7103df058\"><code>ab206f2</code></a></td><td><code>some fixes and pep cleanup in number fields orders</code></td></tr></table>\n",
    "created_at": "2019-05-01T09:21:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430564",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ab206f2d5eea080700b3a0cc3810e1d7103df058"><code>ab206f2</code></a></td><td><code>some fixes and pep cleanup in number fields orders</code></td></tr></table>




---

archive/issue_comments_430565.json:
```json
{
    "body": "Commit: **[`ab206f2`](https://github.com/sagemath/sagetrac-mirror/commit/ab206f2d5eea080700b3a0cc3810e1d7103df058)**",
    "created_at": "2019-05-01T09:21:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430565",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[`ab206f2`](https://github.com/sagemath/sagetrac-mirror/commit/ab206f2d5eea080700b3a0cc3810e1d7103df058)**



---

archive/issue_events_377829.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-05-01T09:21:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377829"
}
```



---

archive/issue_comments_430566.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d\"><code>e053068</code></a></td><td><code>fixes for 27755</code></td></tr></table>\n",
    "created_at": "2019-05-01T09:25:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430566",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d"><code>e053068</code></a></td><td><code>fixes for 27755</code></td></tr></table>




---

archive/issue_comments_430567.json:
```json
{
    "body": "Changed commit from **[`ab206f2`](https://github.com/sagemath/sagetrac-mirror/commit/ab206f2d5eea080700b3a0cc3810e1d7103df058)** to **[`e053068`](https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d)**",
    "created_at": "2019-05-01T09:25:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430567",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ab206f2`](https://github.com/sagemath/sagetrac-mirror/commit/ab206f2d5eea080700b3a0cc3810e1d7103df058)** to **[`e053068`](https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d)**



---

archive/issue_comments_430568.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\ngreen bot, please review",
    "created_at": "2019-05-01T12:08:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430568",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:3" align="right">comment:3</div>

green bot, please review



---

archive/issue_comments_430569.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2019-05-01T12:19:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430569",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_430570.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nWhy did it change from `V` to `W` here?\n\n```diff\n-                z = V.random_element()\n-                alpha = from_V(z)\n+                alpha = from_V(W.random_element())\n```\nSo I can say every other change is good except for the behavior change noted in the ticket description, which is this change:\n\n```diff\n-            # We move each element of W to this subfield.\n-            c = alpha.coordinates_in_terms_of_powers()\n+            # We move each generator of W to this subfield.\n+            K, _ = K.subfield(alpha, 'beta')\n+            gens = [K(x) for x in gens]\n+            V, from_V, to_V = K.vector_space()\n+            mod_gens = [to_V(x) for x in gens]\n+            ambient = ZZ**V.dimension()\n+            W = ambient.span(mod_gens)\n```\nFor this, I would like someone who knows the theory to look at this change.",
    "created_at": "2019-05-01T12:19:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430570",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:4" align="right">comment:4</div>

Why did it change from `V` to `W` here?

```diff
-                z = V.random_element()
-                alpha = from_V(z)
+                alpha = from_V(W.random_element())
```
So I can say every other change is good except for the behavior change noted in the ticket description, which is this change:

```diff
-            # We move each element of W to this subfield.
-            c = alpha.coordinates_in_terms_of_powers()
+            # We move each generator of W to this subfield.
+            K, _ = K.subfield(alpha, 'beta')
+            gens = [K(x) for x in gens]
+            V, from_V, to_V = K.vector_space()
+            mod_gens = [to_V(x) for x in gens]
+            ambient = ZZ**V.dimension()
+            W = ambient.span(mod_gens)
```
For this, I would like someone who knows the theory to look at this change.



---

archive/issue_comments_430571.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWell, I agree that an expert's eye is welcome, but this is just linear algebra.\n\nThis part of the code was just unused and plain wrong.\n\nDo you know who we should put in cc ?",
    "created_at": "2019-05-01T12:21:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430571",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:5" align="right">comment:5</div>

Well, I agree that an expert's eye is welcome, but this is just linear algebra.

This part of the code was just unused and plain wrong.

Do you know who we should put in cc ?



---

archive/issue_comments_430572.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nJohn, Jeroen, could one of you have a quick look at this to make sure the change mentioned in [comment:4](#comment:4) is okay (if you know about this part that is)?\n\n@fchapoton This is a little too far outside my area to say confidently enough that it was wrong and this is the fix. However, if it is unused, then maybe this discussion is moot since that code will never be called.",
    "created_at": "2019-05-01T12:28:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430572",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:6" align="right">comment:6</div>

John, Jeroen, could one of you have a quick look at this to make sure the change mentioned in [comment:4](#comment:4) is okay (if you know about this part that is)?

@fchapoton This is a little too far outside my area to say confidently enough that it was wrong and this is the fix. However, if it is unused, then maybe this discussion is moot since that code will never be called.



---

archive/issue_comments_430573.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nWell, now it is being used by the doctest whose output changed. Previously, the option `allow_subfield=True` was never changing the field at all.",
    "created_at": "2019-05-01T12:31:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430573",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:7" align="right">comment:7</div>

Well, now it is being used by the doctest whose output changed. Previously, the option `allow_subfield=True` was never changing the field at all.



---

archive/issue_comments_430574.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@fchapoton](#comment:7):\n> Well, now it is being used by the doctest whose output changed. Previously, the option `change_field=True` was never changing the field at all.\n\nI see. I was misinterpreting what you meant by \"unused\".",
    "created_at": "2019-05-01T12:36:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430574",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@fchapoton](#comment:7):
> Well, now it is being used by the doctest whose output changed. Previously, the option `change_field=True` was never changing the field at all.

I see. I was misinterpreting what you meant by "unused".



---

archive/issue_comments_430575.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThe changed code looks good to me but I have not tested it on examples.  The first change in Comment 4 is certainly necessary:  alpha must be an element whose coordinate vector lies in W as that is the span of the gens provided.  Otherwise it would be a random element of the big field K, and the whole point of this block of code is that the gens provided may lie in a proper subfield in which case the order returned is an order in that subfield.\n\nOne point caught my eye:  the coordinate vectors of the gens need not be vectors of integers (this is *not* the same as checking that the egns are algebraic integers since there is no reason to suppose that the vector space basis of K is an integral basis).  So W is defined to be the ZZ_span in ZZ^n of vectors which lie in QQ^n but not necessarily ZZ^n.  I hope that works as expected.",
    "created_at": "2019-05-01T15:09:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430575",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:9" align="right">comment:9</div>

The changed code looks good to me but I have not tested it on examples.  The first change in Comment 4 is certainly necessary:  alpha must be an element whose coordinate vector lies in W as that is the span of the gens provided.  Otherwise it would be a random element of the big field K, and the whole point of this block of code is that the gens provided may lie in a proper subfield in which case the order returned is an order in that subfield.

One point caught my eye:  the coordinate vectors of the gens need not be vectors of integers (this is *not* the same as checking that the egns are algebraic integers since there is no reason to suppose that the vector space basis of K is an integral basis).  So W is defined to be the ZZ_span in ZZ^n of vectors which lie in QQ^n but not necessarily ZZ^n.  I hope that works as expected.



---

archive/issue_comments_430576.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nSeems to work fine:\n\n```\nsage: ambient=ZZ**2\nsage: ambient.span([vector(QQ,[1/2,1/2])])\nFree module of degree 2 and rank 1 over Integer Ring\nEchelon basis matrix:\n[1/2 1/2]\nsage: ambient.span([vector(QQ,[1/2,1/2]),vector(QQ,[1/2,-1/2])])\nFree module of degree 2 and rank 2 over Integer Ring\nEchelon basis matrix:\n[1/2 1/2]\n[  0   1]\n```",
    "created_at": "2019-05-01T18:33:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430576",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:10" align="right">comment:10</div>

Seems to work fine:

```
sage: ambient=ZZ**2
sage: ambient.span([vector(QQ,[1/2,1/2])])
Free module of degree 2 and rank 1 over Integer Ring
Echelon basis matrix:
[1/2 1/2]
sage: ambient.span([vector(QQ,[1/2,1/2]),vector(QQ,[1/2,-1/2])])
Free module of degree 2 and rank 2 over Integer Ring
Echelon basis matrix:
[1/2 1/2]
[  0   1]
```



---

archive/issue_comments_430577.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nreview, please ?",
    "created_at": "2019-05-08T07:18:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430577",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:11" align="right">comment:11</div>

review, please ?



---

archive/issue_events_377830.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2019-05-08T07:54:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377830"
}
```



---

archive/issue_events_377831.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2019-05-08T07:54:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377831"
}
```



---

archive/issue_comments_430578.json:
```json
{
    "body": "Changed branch from **[u/chapoton/27755](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27755)** to **[`e053068`](https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d)**",
    "created_at": "2019-05-12T21:30:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27755#issuecomment-430578",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/chapoton/27755](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/27755)** to **[`e053068`](https://github.com/sagemath/sagetrac-mirror/commit/e053068b002e5b1a8eb56b624e507ce5de2db71d)**



---

archive/issue_events_377832.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-12T21:30:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377832"
}
```



---

archive/issue_events_377833.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "41b531ebb0afa99ddcc0117d4a1b5c994b7cb8fb",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-05-12T21:30:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27755",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27755#event-377833"
}
```
