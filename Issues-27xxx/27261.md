# Issue 27261: Memory leaks in libsingular polynomial evaluation and substitution

archive/issues_027024.json:
```json
{
    "assignees": [],
    "body": "The following two examples leak memory (in sagemath from 8.9 to 9.3.rc5)\n\n```\nsage: R = PolynomialRing(ZZ, 'x', 50)\nsage: d = {str(g): g for g in R.gens()}\nsage: p = sum(d.values())\nsage: import gc\nsage: mem0 = get_memory_usage()\nsage: for i in range(20):\n....:     for _ in range(50):\n....:         _ = p.subs(**d)\n....:     _ = gc.collect()\n....:     mem1 = get_memory_usage()\n....:     if mem1 > mem0:\n....:         print(i, mem1-mem0)\n....:         mem0 = mem1\n```\nand\n\n```\nsage: R.<x, y> = ZZ[]\nsage: p = (x + y)**100\nsage: mem0 = get_memory_usage()\nsage: for i in range(20):\n....:     _ = p(x + y, y)\n....:     _ = gc.collect()\n....:     mem1 = get_memory_usage()\n....:     if mem1 > mem0:\n....:         print(i, mem1-mem0)\n```\n\nThis was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).\n\nWe fix `.subs` (the first example above) by modifying the appropriate singular call. We identified two possibly related memory leaks in singular\n- [singular issue #1089](https://github.com/Singular/Singular/issues/1089)\n- [singular issue #1090](https://github.com/Singular/Singular/issues/1090)\n\nIn the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.\n\nSee also #13447 also related to memory handling in singular.\n\nCC:  @nbruin @malb\n\nKeywords: **libsingular polynomial memleak**\n\nBranch/Commit: **[u/vdelecroix/27261](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/27261) @ [edf8847](https://github.com/sagemath/sagetrac-mirror/commit/edf88477b9986b2d476f08101f92450ac57bf58e)**\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Vincent Delecroix, \u200bDima Pasechnik**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27261_\n\n",
    "created_at": "2019-02-12T14:48:34Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20memleak",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Memory leaks in libsingular polynomial evaluation and substitution",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/27261",
    "user": "https://github.com/simon-king-jena"
}
```
The following two examples leak memory (in sagemath from 8.9 to 9.3.rc5)

```
sage: R = PolynomialRing(ZZ, 'x', 50)
sage: d = {str(g): g for g in R.gens()}
sage: p = sum(d.values())
sage: import gc
sage: mem0 = get_memory_usage()
sage: for i in range(20):
....:     for _ in range(50):
....:         _ = p.subs(**d)
....:     _ = gc.collect()
....:     mem1 = get_memory_usage()
....:     if mem1 > mem0:
....:         print(i, mem1-mem0)
....:         mem0 = mem1
```
and

```
sage: R.<x, y> = ZZ[]
sage: p = (x + y)**100
sage: mem0 = get_memory_usage()
sage: for i in range(20):
....:     _ = p(x + y, y)
....:     _ = gc.collect()
....:     mem1 = get_memory_usage()
....:     if mem1 > mem0:
....:         print(i, mem1-mem0)
```

This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).

We fix `.subs` (the first example above) by modifying the appropriate singular call. We identified two possibly related memory leaks in singular
- [singular issue #1089](https://github.com/Singular/Singular/issues/1089)
- [singular issue #1090](https://github.com/Singular/Singular/issues/1090)

In the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.

See also #13447 also related to memory handling in singular.

CC:  @nbruin @malb

Keywords: **libsingular polynomial memleak**

Branch/Commit: **[u/vdelecroix/27261](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/27261) @ [edf8847](https://github.com/sagemath/sagetrac-mirror/commit/edf88477b9986b2d476f08101f92450ac57bf58e)**

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **Dima Pasechnik**

Author: **Vincent Delecroix, â€‹Dima Pasechnik**

_Issue created by migration from https://trac.sagemath.org/ticket/27261_





---

archive/issue_events_343739.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-12T14:48:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343739"
}
```



---

archive/issue_events_343740.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-12T14:48:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20memleak",
    "label_color": "000080",
    "label_name": "component: memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343740"
}
```



---

archive/issue_events_343741.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-12T14:48:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343741"
}
```



---

archive/issue_events_343742.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-12T14:48:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343742"
}
```



---

archive/issue_comments_423978.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nFor testing, I changed the code so that the `id()` of any newly created `MPolynomial_libsingular` instance is stored in some set, and is removed from the set as soon as it becomes garbage collected.\n\nResult: In the above examples, the `MPolynomial_libsingular` instances are correctly garbage collected.\n\nConclusion: The memleak occurs in Sage's usage of libsingular. Apparently the underlying data of a polynomial are not correctly freed when it is deallocated.",
    "created_at": "2019-02-12T16:21:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423978",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'>Comment 1:</a>
For testing, I changed the code so that the `id()` of any newly created `MPolynomial_libsingular` instance is stored in some set, and is removed from the set as soon as it becomes garbage collected.

Result: In the above examples, the `MPolynomial_libsingular` instances are correctly garbage collected.

Conclusion: The memleak occurs in Sage's usage of libsingular. Apparently the underlying data of a polynomial are not correctly freed when it is deallocated.



---

archive/issue_comments_423979.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nOr, another possibility: Some temporary libsingular data created during the computation of Q is not freed.\n\nTo detect this, I will try to make the example more fine-grained: Test if the leak occurs if the only arithmetic operation involved is `_add_`, `_mul_` or `__pow__`, respectively. `(X+Y)<sup>120*Y</sup>100` mixes these three operations.",
    "created_at": "2019-02-12T16:34:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423979",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'>Comment 2:</a>
Or, another possibility: Some temporary libsingular data created during the computation of Q is not freed.

To detect this, I will try to make the example more fine-grained: Test if the leak occurs if the only arithmetic operation involved is `_add_`, `_mul_` or `__pow__`, respectively. `(X+Y)<sup>120*Y</sup>100` mixes these three operations.



---

archive/issue_comments_423980.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nInterestingly, creating a copy of P from scratch does *not* leak:\n\n```\nsage: import gc\nsage: R.<X,Y> = ZZ[]\nsage: P = (X+Y)^120*Y^100\nsage: mem0 = get_memory_usage()\nsage: for i in range(500):\n....:     Q = (X+Y)^120*Y^100\n....:     del Q\n....:     _ = gc.collect()\n....:     mem1 = get_memory_usage()\n....:     if mem1>mem0:\n....:         print(i, mem1-mem0)\n....:         mem0 = mem1\n....:         \n(0, 0.1484375)\nsage: \n```\nSo, it seems that calling the polynomial (i.e., `P(X,Y)`) is what is leaking!",
    "created_at": "2019-02-12T16:44:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423980",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'>Comment 3:</a>
Interestingly, creating a copy of P from scratch does *not* leak:

```
sage: import gc
sage: R.<X,Y> = ZZ[]
sage: P = (X+Y)^120*Y^100
sage: mem0 = get_memory_usage()
sage: for i in range(500):
....:     Q = (X+Y)^120*Y^100
....:     del Q
....:     _ = gc.collect()
....:     mem1 = get_memory_usage()
....:     if mem1>mem0:
....:         print(i, mem1-mem0)
....:         mem0 = mem1
....:         
(0, 0.1484375)
sage: 
```
So, it seems that calling the polynomial (i.e., `P(X,Y)`) is what is leaking!



---

archive/issue_comments_423981.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nNote that there previously was a leak in polynomial evaluation, as by comment in `sage.libs.singular.polynomial.singular_polynomial_call` - see #16958. So, perhaps it didn't get completely fixed?",
    "created_at": "2019-02-12T16:54:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423981",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'>Comment 4:</a>
Note that there previously was a leak in polynomial evaluation, as by comment in `sage.libs.singular.polynomial.singular_polynomial_call` - see #16958. So, perhaps it didn't get completely fixed?



---

archive/issue_comments_423982.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\n`singular_polynomial_call` copies the input data before doing the actual call. This, I think, is a waste of time. I tested that taking the copy is *not* causing the leak, but while we are at it, it could as well be improved, too.",
    "created_at": "2019-02-12T17:07:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423982",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'>Comment 5:</a>
`singular_polynomial_call` copies the input data before doing the actual call. This, I think, is a waste of time. I tested that taking the copy is *not* causing the leak, but while we are at it, it could as well be improved, too.



---

archive/issue_comments_423983.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nAlso, `singular_polynomial_call` has an argument `poly *(*get_element)(object)` that is (at least in the Sage library) always assigned with the function `MPolynomial_libsingular_get_element`, which does nothing more than return the `._poly` of an `MPolynomial_libsingular`.\n\nSo, basically the `get_element` argument is void. Should it be removed?",
    "created_at": "2019-02-12T17:16:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423983",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'>Comment 6:</a>
Also, `singular_polynomial_call` has an argument `poly *(*get_element)(object)` that is (at least in the Sage library) always assigned with the function `MPolynomial_libsingular_get_element`, which does nothing more than return the `._poly` of an `MPolynomial_libsingular`.

So, basically the `get_element` argument is void. Should it be removed?



---

archive/issue_events_343743.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-12T18:37:16Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "title_is": "Fix a memory leak in libsingular polynomial evaluation",
    "title_was": "Fix a memory leak in libsingular polynomial arithmetic",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343743"
}
```



---

archive/issue_comments_423984.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nTicket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423984",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'>Comment 8:</a>
Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_343744.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343744"
}
```



---

archive/issue_events_343745.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343745"
}
```



---

archive/issue_events_343746.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:54:19Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343746"
}
```



---

archive/issue_comments_423985.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nAs the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:54:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423985",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'>Comment 9:</a>
As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_423986.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nStumble upon a similar problem using `.subs()`\n\n```\nsage: R.<X,Y> = ZZ[] \n....: import gc \n....: mem0 = get_memory_usage() \n....: for i in range(1000): \n....:     for _ in range(100): \n....:         _ = (X + Y).subs(X=X, Y=Y) \n....:     _ = gc.collect() \n....:     mem1 = get_memory_usage() \n....:     if mem1>mem0: \n....:         print(i, mem1-mem0) \n....:         mem0 = mem1                                                                                                                                                                      \n78 0.1328125\n100 0.1328125\n121 0.12890625\n142 0.12890625\n164 0.1328125\n172 2.0\n185 0.12890625\n206 0.12890625\n228 0.1328125\n...\n```\nSee also https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/",
    "created_at": "2021-05-06T17:19:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423986",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'>Comment 10:</a>
Stumble upon a similar problem using `.subs()`

```
sage: R.<X,Y> = ZZ[] 
....: import gc 
....: mem0 = get_memory_usage() 
....: for i in range(1000): 
....:     for _ in range(100): 
....:         _ = (X + Y).subs(X=X, Y=Y) 
....:     _ = gc.collect() 
....:     mem1 = get_memory_usage() 
....:     if mem1>mem0: 
....:         print(i, mem1-mem0) 
....:         mem0 = mem1                                                                                                                                                                      
78 0.1328125
100 0.1328125
121 0.12890625
142 0.12890625
164 0.1328125
172 2.0
185 0.12890625
206 0.12890625
228 0.1328125
...
```
See also https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/



---

archive/issue_comments_423987.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nSince `__call__` calls `subs()` I gues the latter is the culprit.",
    "created_at": "2021-05-06T17:22:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423987",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'>Comment 11:</a>
Since `__call__` calls `subs()` I gues the latter is the culprit.



---

archive/issue_comments_423988.json:
```json
{
    "body": "Commit: **[ee9a54a](https://github.com/sagemath/sagetrac-mirror/commit/ee9a54a8467c6f6824a192ae7029af1c25feb4e6)**",
    "created_at": "2021-05-07T08:05:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423988",
    "user": "https://github.com/videlec"
}
```

Commit: **[ee9a54a](https://github.com/sagemath/sagetrac-mirror/commit/ee9a54a8467c6f6824a192ae7029af1c25feb4e6)**



---

archive/issue_comments_423989.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ee9a54a8467c6f6824a192ae7029af1c25feb4e6\">ee9a54a</a></td><td><code>27261: fix memory leak in polynomial substitution</code></td></tr></table>\n",
    "created_at": "2021-05-07T08:05:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423989",
    "user": "https://github.com/videlec"
}
```

<a id='comment:12'>Comment 12:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ee9a54a8467c6f6824a192ae7029af1c25feb4e6">ee9a54a</a></td><td><code>27261: fix memory leak in polynomial substitution</code></td></tr></table>




---

archive/issue_comments_423990.json:
```json
{
    "body": "Changed dependencies from **#13447** to none",
    "created_at": "2021-05-07T08:05:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423990",
    "user": "https://github.com/videlec"
}
```

Changed dependencies from **#13447** to none



---

archive/issue_events_343747.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-07T08:05:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343747"
}
```



---

archive/issue_comments_423991.json:
```json
{
    "body": "Branch: **[u/vdelecroix/27261](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/27261)**",
    "created_at": "2021-05-07T08:05:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423991",
    "user": "https://github.com/videlec"
}
```

Branch: **[u/vdelecroix/27261](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/27261)**



---

archive/issue_events_343748.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-07T08:05:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343748"
}
```



---

archive/issue_events_343749.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-07T08:05:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343749"
}
```



---

archive/issue_events_343750.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-07T08:05:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343750"
}
```



---

archive/issue_comments_423992.json:
```json
{
    "body": "Changed commit from **[ee9a54a](https://github.com/sagemath/sagetrac-mirror/commit/ee9a54a8467c6f6824a192ae7029af1c25feb4e6)** to **[00b85c8](https://github.com/sagemath/sagetrac-mirror/commit/00b85c82ee84dee8d4f5b7637e2c9b1080421610)**",
    "created_at": "2021-05-07T08:20:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423992",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[ee9a54a](https://github.com/sagemath/sagetrac-mirror/commit/ee9a54a8467c6f6824a192ae7029af1c25feb4e6)** to **[00b85c8](https://github.com/sagemath/sagetrac-mirror/commit/00b85c82ee84dee8d4f5b7637e2c9b1080421610)**



---

archive/issue_comments_423993.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/00b85c82ee84dee8d4f5b7637e2c9b1080421610\">00b85c8</a></td><td><code>27261: doctest subs leak</code></td></tr></table>\n",
    "created_at": "2021-05-07T08:20:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423993",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:13'>Comment 13:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/00b85c82ee84dee8d4f5b7637e2c9b1080421610">00b85c8</a></td><td><code>27261: doctest subs leak</code></td></tr></table>




---

archive/issue_comments_423994.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd4d41f86fb1a83761029666c5f90220355977f4\">bd4d41f</a></td><td><code>27261: doctest subs and `__call__` leak</code></td></tr></table>\n",
    "created_at": "2021-05-07T08:27:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423994",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:14'>Comment 14:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd4d41f86fb1a83761029666c5f90220355977f4">bd4d41f</a></td><td><code>27261: doctest subs and `__call__` leak</code></td></tr></table>




---

archive/issue_comments_423995.json:
```json
{
    "body": "Changed commit from **[00b85c8](https://github.com/sagemath/sagetrac-mirror/commit/00b85c82ee84dee8d4f5b7637e2c9b1080421610)** to **[bd4d41f](https://github.com/sagemath/sagetrac-mirror/commit/bd4d41f86fb1a83761029666c5f90220355977f4)**",
    "created_at": "2021-05-07T08:27:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423995",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[00b85c8](https://github.com/sagemath/sagetrac-mirror/commit/00b85c82ee84dee8d4f5b7637e2c9b1080421610)** to **[bd4d41f](https://github.com/sagemath/sagetrac-mirror/commit/bd4d41f86fb1a83761029666c5f90220355977f4)**



---

archive/issue_comments_423996.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,138 +1,36 @@\n-The following leaks (I tested in Py3, but in Py2 it's the same):\n+The following two examples leak memory (in sagemath from 8.9 to 9.3.rc5)\n \n ```\n-sage: R.<X,Y> = ZZ[]\n-sage: P = (X+Y)^120*Y^100\n+sage: R = PolynomialRing(ZZ, 'x', 50)\n+sage: d = {str(g): g for g in R.gens()}\n+sage: p = sum(d.values())\n sage: import gc\n sage: mem0 = get_memory_usage()\n-sage: for i in range(1000):\n-....:     Q = P(X,Y)\n-....:     del Q\n+sage: for i in range(20):\n+....:     for _ in range(50):\n+....:         _ = p.subs(**d)\n ....:     _ = gc.collect()\n ....:     mem1 = get_memory_usage()\n-....:     if mem1>mem0:\n+....:     if mem1 > mem0:\n ....:         print(i, mem1-mem0)\n ....:         mem0 = mem1\n-....:         \n-0 0.25\n-98 0.12890625\n-128 0.12890625\n-157 0.12890625\n-187 0.12890625\n-216 0.12890625\n-246 0.12890625\n-275 0.12890625\n-305 0.12890625\n-329 2.0\n-331 0.12890625\n-360 0.12890625\n-390 0.12890625\n-420 0.1328125\n-450 0.12890625\n-479 0.12890625\n-509 0.12890625\n-539 0.1328125\n-569 0.12890625\n-599 0.1328125\n-629 0.12890625\n-659 0.1328125\n-673 2.0\n-689 0.12890625\n-718 0.12890625\n-748 0.12890625\n-778 0.1328125\n-808 0.12890625\n-822 0.1953125\n-866 0.12890625\n-896 0.12890625\n-925 0.12890625\n-955 0.12890625\n-984 0.12890625\n+```\n+and\n+\n+```\n+sage: R.<x, y> = ZZ[]\n+sage: p = (x + y)**100\n+sage: mem0 = get_memory_usage()\n+sage: for i in range(20):\n+....:     _ = p(x + y, y)\n+....:     _ = gc.collect()\n+....:     mem1 = get_memory_usage()\n+....:     if mem1 > mem0:\n+....:         print(i, mem1-mem0)\n ```\n \n-With #13447 in Py2, the leak is reduced, but still present:\n+This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).\n \n-```\n-sage: mem0 = get_memory_usage()\n-sage: for i in range(1000):\n-....:     Q = P(X,Y)\n-....:     del Q\n-....:     _ = gc.collect()\n-....:     mem1 = get_memory_usage()\n-....:     if mem1>mem0:\n-....:         print(i, mem1-mem0)\n-....:         mem0 = mem1\n-....:         \n-(147, 0.03125)\n-(176, 0.12890625)\n-(206, 0.12890625)\n-(235, 0.12890625)\n-(265, 0.12890625)\n-(294, 0.12890625)\n-(324, 0.12890625)\n-(329, 2.0)\n-(350, 0.12890625)\n-(379, 0.12890625)\n-(409, 0.12890625)\n-(438, 0.12890625)\n-(468, 0.12890625)\n-(497, 0.12890625)\n-(527, 0.12890625)\n-(556, 0.12890625)\n-(586, 0.12890625)\n-(615, 0.12890625)\n-(645, 0.12890625)\n-(672, 0.1328125)\n-(673, 2.0)\n-(705, 0.12890625)\n-(734, 0.12890625)\n-(764, 0.12890625)\n-(793, 0.12890625)\n-(823, 0.12890625)\n-(852, 0.12890625)\n-(882, 0.12890625)\n-(911, 0.12890625)\n-(941, 0.12890625)\n-(970, 0.12890625)\n-```\n+A way to get rid of this problem is to use naive substitution in Python and avoid using low-level calls to singular library.\n \n-There is a worse leak (even with #13447):\n-\n-```\n-sage: for i in range(1000):\n-....:     Q = P(X+Y,Y)\n-....:     del Q\n-....:     _ = gc.collect()\n-....:     mem1 = get_memory_usage()\n-....:     if mem1>mem0:\n-....:         print(i, mem1-mem0)\n-....:         mem0 = mem1\n-....:         \n-(0, 0.546875)\n-(2, 0.12890625)\n-(3, 0.2578125)\n-(4, 0.12890625)\n-(5, 0.2578125)\n-(6, 2.2578125)\n-(7, 0.12890625)\n-(8, 0.2578125)\n-(9, 0.2578125)\n-(10, 0.2578125)\n-(11, 0.12890625)\n-(12, 0.2578125)\n-(13, 2.265625)\n-(14, 0.12890625)\n-(15, 0.2578125)\n-(16, 0.2578125)\n-(17, 0.12890625)\n-(18, 0.2578125)\n-(19, 0.2578125)\n-(20, 0.12890625)\n-(21, 2.265625)\n-(22, 0.2578125)\n-(23, 0.12890625)\n-(24, 0.2578125)\n-(25, 0.2578125)\n-```\n-\n-This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw)\n+See also #13447 also related to memory handling in singular.\n``````\n",
    "created_at": "2021-05-07T08:32:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423996",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,138 +1,36 @@
-The following leaks (I tested in Py3, but in Py2 it's the same):
+The following two examples leak memory (in sagemath from 8.9 to 9.3.rc5)
 
 ```
-sage: R.<X,Y> = ZZ[]
-sage: P = (X+Y)^120*Y^100
+sage: R = PolynomialRing(ZZ, 'x', 50)
+sage: d = {str(g): g for g in R.gens()}
+sage: p = sum(d.values())
 sage: import gc
 sage: mem0 = get_memory_usage()
-sage: for i in range(1000):
-....:     Q = P(X,Y)
-....:     del Q
+sage: for i in range(20):
+....:     for _ in range(50):
+....:         _ = p.subs(**d)
 ....:     _ = gc.collect()
 ....:     mem1 = get_memory_usage()
-....:     if mem1>mem0:
+....:     if mem1 > mem0:
 ....:         print(i, mem1-mem0)
 ....:         mem0 = mem1
-....:         
-0 0.25
-98 0.12890625
-128 0.12890625
-157 0.12890625
-187 0.12890625
-216 0.12890625
-246 0.12890625
-275 0.12890625
-305 0.12890625
-329 2.0
-331 0.12890625
-360 0.12890625
-390 0.12890625
-420 0.1328125
-450 0.12890625
-479 0.12890625
-509 0.12890625
-539 0.1328125
-569 0.12890625
-599 0.1328125
-629 0.12890625
-659 0.1328125
-673 2.0
-689 0.12890625
-718 0.12890625
-748 0.12890625
-778 0.1328125
-808 0.12890625
-822 0.1953125
-866 0.12890625
-896 0.12890625
-925 0.12890625
-955 0.12890625
-984 0.12890625
+```
+and
+
+```
+sage: R.<x, y> = ZZ[]
+sage: p = (x + y)**100
+sage: mem0 = get_memory_usage()
+sage: for i in range(20):
+....:     _ = p(x + y, y)
+....:     _ = gc.collect()
+....:     mem1 = get_memory_usage()
+....:     if mem1 > mem0:
+....:         print(i, mem1-mem0)
 ```
 
-With #13447 in Py2, the leak is reduced, but still present:
+This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).
 
-```
-sage: mem0 = get_memory_usage()
-sage: for i in range(1000):
-....:     Q = P(X,Y)
-....:     del Q
-....:     _ = gc.collect()
-....:     mem1 = get_memory_usage()
-....:     if mem1>mem0:
-....:         print(i, mem1-mem0)
-....:         mem0 = mem1
-....:         
-(147, 0.03125)
-(176, 0.12890625)
-(206, 0.12890625)
-(235, 0.12890625)
-(265, 0.12890625)
-(294, 0.12890625)
-(324, 0.12890625)
-(329, 2.0)
-(350, 0.12890625)
-(379, 0.12890625)
-(409, 0.12890625)
-(438, 0.12890625)
-(468, 0.12890625)
-(497, 0.12890625)
-(527, 0.12890625)
-(556, 0.12890625)
-(586, 0.12890625)
-(615, 0.12890625)
-(645, 0.12890625)
-(672, 0.1328125)
-(673, 2.0)
-(705, 0.12890625)
-(734, 0.12890625)
-(764, 0.12890625)
-(793, 0.12890625)
-(823, 0.12890625)
-(852, 0.12890625)
-(882, 0.12890625)
-(911, 0.12890625)
-(941, 0.12890625)
-(970, 0.12890625)
-```
+A way to get rid of this problem is to use naive substitution in Python and avoid using low-level calls to singular library.
 
-There is a worse leak (even with #13447):
-
-```
-sage: for i in range(1000):
-....:     Q = P(X+Y,Y)
-....:     del Q
-....:     _ = gc.collect()
-....:     mem1 = get_memory_usage()
-....:     if mem1>mem0:
-....:         print(i, mem1-mem0)
-....:         mem0 = mem1
-....:         
-(0, 0.546875)
-(2, 0.12890625)
-(3, 0.2578125)
-(4, 0.12890625)
-(5, 0.2578125)
-(6, 2.2578125)
-(7, 0.12890625)
-(8, 0.2578125)
-(9, 0.2578125)
-(10, 0.2578125)
-(11, 0.12890625)
-(12, 0.2578125)
-(13, 2.265625)
-(14, 0.12890625)
-(15, 0.2578125)
-(16, 0.2578125)
-(17, 0.12890625)
-(18, 0.2578125)
-(19, 0.2578125)
-(20, 0.12890625)
-(21, 2.265625)
-(22, 0.2578125)
-(23, 0.12890625)
-(24, 0.2578125)
-(25, 0.2578125)
-```
-
-This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw)
+See also #13447 also related to memory handling in singular.
``````




---

archive/issue_comments_423997.json:
```json
{
    "body": "Author: **Vincent Delecroix**",
    "created_at": "2021-05-07T08:32:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423997",
    "user": "https://github.com/videlec"
}
```

Author: **Vincent Delecroix**



---

archive/issue_comments_423998.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nDoes `gc.collect()` trigger Singular's GC - does it even have such an option?\nIt does its own memory management.",
    "created_at": "2021-05-07T08:37:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423998",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'>Comment 16:</a>
Does `gc.collect()` trigger Singular's GC - does it even have such an option?
It does its own memory management.



---

archive/issue_comments_423999.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@dimpase](#comment%3A16):\n> Does `gc.collect()` trigger Singular's GC - does it even have such an option?\n> It does its own memory management.\n\nWhat does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with\n\n```\nsage: R = PolynomialRing(ZZ, 'x', 50)\nsage: d = {str(g): g for g in R.gens()}\nsage: p = sum(d.values())\nsage: while True:\n....:     _ = p.subs(**d)\n```",
    "created_at": "2021-05-07T08:46:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-423999",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@dimpase](#comment%3A16):
> Does `gc.collect()` trigger Singular's GC - does it even have such an option?
> It does its own memory management.

What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with

```
sage: R = PolynomialRing(ZZ, 'x', 50)
sage: d = {str(g): g for g in R.gens()}
sage: p = sum(d.values())
sage: while True:
....:     _ = p.subs(**d)
```



---

archive/issue_events_343751.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-07T12:20:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343751"
}
```



---

archive/issue_events_343752.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-07T12:20:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343752"
}
```



---

archive/issue_comments_424000.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nThe following 1-line patch fixes the leak from [comment:10](#comment%3A10) and the 1st leak reported on the ticket.\n\n```diff\n--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n@@ -3620,9 +3620,8 @@ cdef class MPolynomial_libsingular(MPolynomial):\n                 res_id = fast_map_common_subexp(from_id, _ring, to_id, _ring)\n                 _p = res_id.m[0]\n \n-                from_id.m[0] = NULL\n+                p_Delete(&from_id.m[0], _ring)\n                 res_id.m[0] = NULL\n-\n                 id_Delete(&from_id, _ring)\n                 id_Delete(&res_id, _ring)\n ```\n\nit does not fix the 2nd leak on the ticket, but I guess it might be that one needs to clean more of these `from_id` parts...",
    "created_at": "2021-05-07T12:20:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424000",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'>Comment 18:</a>
The following 1-line patch fixes the leak from [comment:10](#comment%3A10) and the 1st leak reported on the ticket.

```diff
--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
@@ -3620,9 +3620,8 @@ cdef class MPolynomial_libsingular(MPolynomial):
                 res_id = fast_map_common_subexp(from_id, _ring, to_id, _ring)
                 _p = res_id.m[0]
 
-                from_id.m[0] = NULL
+                p_Delete(&from_id.m[0], _ring)
                 res_id.m[0] = NULL
-
                 id_Delete(&from_id, _ring)
                 id_Delete(&res_id, _ring)
 ```

it does not fix the 2nd leak on the ticket, but I guess it might be that one needs to clean more of these `from_id` parts...



---

archive/issue_comments_424001.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nIt'd be good to have more eyes on this, `subs()` code, preferably of people who wrote chunks of it.",
    "created_at": "2021-05-07T12:43:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424001",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'>Comment 19:</a>
It'd be good to have more eyes on this, `subs()` code, preferably of people who wrote chunks of it.



---

archive/issue_comments_424002.json:
```json
{
    "body": "Changed commit from **[bd4d41f](https://github.com/sagemath/sagetrac-mirror/commit/bd4d41f86fb1a83761029666c5f90220355977f4)** to **[b4e22a4](https://github.com/sagemath/sagetrac-mirror/commit/b4e22a43dfa4eb2bec4b7317a13b5d019153c6eb)**",
    "created_at": "2021-05-07T12:43:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424002",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[bd4d41f](https://github.com/sagemath/sagetrac-mirror/commit/bd4d41f86fb1a83761029666c5f90220355977f4)** to **[b4e22a4](https://github.com/sagemath/sagetrac-mirror/commit/b4e22a43dfa4eb2bec4b7317a13b5d019153c6eb)**



---

archive/issue_comments_424003.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/19881aab88014ac6d535e2d5b176915961106de7\">19881aa</a></td><td><code>27261: fix memory leak in polynomial substitution</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4e22a43dfa4eb2bec4b7317a13b5d019153c6eb\">b4e22a4</a></td><td><code>27261: doctest subs and `__call__` leak</code></td></tr></table>\n",
    "created_at": "2021-05-07T12:43:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424003",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:20'>Comment 20:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/19881aab88014ac6d535e2d5b176915961106de7">19881aa</a></td><td><code>27261: fix memory leak in polynomial substitution</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4e22a43dfa4eb2bec4b7317a13b5d019153c6eb">b4e22a4</a></td><td><code>27261: doctest subs and `__call__` leak</code></td></tr></table>




---

archive/issue_comments_424004.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nthx for your input!",
    "created_at": "2021-05-07T12:44:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424004",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'>Comment 21:</a>
thx for your input!



---

archive/issue_events_343753.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-07T12:44:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343753"
}
```



---

archive/issue_events_343754.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-07T12:44:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343754"
}
```



---

archive/issue_comments_424005.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nReplying to [@videlec](#comment%3A17):\n> Replying to [@dimpase](#comment%3A16):\n> > Does `gc.collect()` trigger Singular's GC - does it even have such an option?\n> > It does its own memory management.\n\n> \n> What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with\n> \n> ```\n> sage: R = PolynomialRing(ZZ, 'x', 50)\n> sage: d = {str(g): g for g in R.gens()}\n> sage: p = sum(d.values())\n> sage: while True:\n> ....:     _ = p.subs(**d)\n> ```\n\nwith the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.",
    "created_at": "2021-05-07T12:46:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424005",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'>Comment 22:</a>
Replying to [@videlec](#comment%3A17):
> Replying to [@dimpase](#comment%3A16):
> > Does `gc.collect()` trigger Singular's GC - does it even have such an option?
> > It does its own memory management.

> 
> What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with
> 
> ```
> sage: R = PolynomialRing(ZZ, 'x', 50)
> sage: d = {str(g): g for g in R.gens()}
> sage: p = sum(d.values())
> sage: while True:
> ....:     _ = p.subs(**d)
> ```

with the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.



---

archive/issue_comments_424006.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fbc22ce52ee92231520303b8d90a58fb1464833f\">fbc22ce</a></td><td><code>27261: fix leak tests</code></td></tr></table>\n",
    "created_at": "2021-05-07T12:55:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424006",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:23'>Comment 23:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fbc22ce52ee92231520303b8d90a58fb1464833f">fbc22ce</a></td><td><code>27261: fix leak tests</code></td></tr></table>




---

archive/issue_comments_424007.json:
```json
{
    "body": "Changed commit from **[b4e22a4](https://github.com/sagemath/sagetrac-mirror/commit/b4e22a43dfa4eb2bec4b7317a13b5d019153c6eb)** to **[fbc22ce](https://github.com/sagemath/sagetrac-mirror/commit/fbc22ce52ee92231520303b8d90a58fb1464833f)**",
    "created_at": "2021-05-07T12:55:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424007",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b4e22a4](https://github.com/sagemath/sagetrac-mirror/commit/b4e22a43dfa4eb2bec4b7317a13b5d019153c6eb)** to **[fbc22ce](https://github.com/sagemath/sagetrac-mirror/commit/fbc22ce52ee92231520303b8d90a58fb1464833f)**



---

archive/issue_comments_424008.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nReplying to [@dimpase](#comment%3A22):\n> Replying to [@videlec](#comment%3A17):\n> > Replying to [@dimpase](#comment%3A16):\n> > > Does `gc.collect()` trigger Singular's GC - does it even have such an option?\n> > > It does its own memory management.\n\n> > \n> > What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with\n> > \n> > ```\n> > sage: R = PolynomialRing(ZZ, 'x', 50)\n> > sage: d = {str(g): g for g in R.gens()}\n> > sage: p = sum(d.values())\n> > sage: while True:\n> > ....:     _ = p.subs(**d)\n> > ```\n\n> \n> with the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.\n\nVery good. This is implemented in commit 19881aa.",
    "created_at": "2021-05-07T12:56:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424008",
    "user": "https://github.com/videlec"
}
```

<a id='comment:24'>Comment 24:</a>
Replying to [@dimpase](#comment%3A22):
> Replying to [@videlec](#comment%3A17):
> > Replying to [@dimpase](#comment%3A16):
> > > Does `gc.collect()` trigger Singular's GC - does it even have such an option?
> > > It does its own memory management.

> > 
> > What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with
> > 
> > ```
> > sage: R = PolynomialRing(ZZ, 'x', 50)
> > sage: d = {str(g): g for g in R.gens()}
> > sage: p = sum(d.values())
> > sage: while True:
> > ....:     _ = p.subs(**d)
> > ```

> 
> with the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.

Very good. This is implemented in commit 19881aa.



---

archive/issue_comments_424009.json:
```json
{
    "body": "Changed author from **Vincent Delecroix** to **Vincent Delecroix, \u200bDima Pasechnik**",
    "created_at": "2021-05-07T12:56:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424009",
    "user": "https://github.com/videlec"
}
```

Changed author from **Vincent Delecroix** to **Vincent Delecroix, â€‹Dima Pasechnik**



---

archive/issue_comments_424010.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nseems to be a similar bug, from_id, to_id stuff  in `singular_polynomial_call`.\nHere is how to trigger it there, (needs `--long`) \n\n```diff\n--- a/src/sage/libs/singular/polynomial.pyx\n+++ b/src/sage/libs/singular/polynomial.pyx\n@@ -167,12 +167,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n         sage: import gc\n         sage: F.<a> = GF(7^2)\n         sage: R.<x,y> = F[]\n-        sage: p = x+2*y\n+        sage: p = (x+2*y)^3\n         sage: def leak(N):\n         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     gc.collect()\n         ....:     for i in range(N):\n-        ....:         _ = p(a, a)\n+        ....:         _ = p(a+x, a)\n         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes\n```\n\ngives\n\n```\nFile \"src/sage/libs/singular/polynomial.pyx\", line 187, in sage.libs.singular.polynomial.singular_polynomial_call\nFailed example:\n    for i in range(30):  # long time\n        n = leak(10000)\n        print(\"Leaked {} bytes\".format(n))\n        if n == 0:\n            zeros += 1\n            if zeros >= 6:\n                break\n        else:\n            zeros = 0\nExpected:\n    Leaked...\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\nGot:\n    Leaked 6180864 bytes\n    Leaked 3956736 bytes\n    Leaked 3923968 bytes\n    Leaked 3923968 bytes\n...\n```",
    "created_at": "2021-05-07T13:35:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424010",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'>Comment 25:</a>
seems to be a similar bug, from_id, to_id stuff  in `singular_polynomial_call`.
Here is how to trigger it there, (needs `--long`) 

```diff
--- a/src/sage/libs/singular/polynomial.pyx
+++ b/src/sage/libs/singular/polynomial.pyx
@@ -167,12 +167,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
         sage: import gc
         sage: F.<a> = GF(7^2)
         sage: R.<x,y> = F[]
-        sage: p = x+2*y
+        sage: p = (x+2*y)^3
         sage: def leak(N):
         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     gc.collect()
         ....:     for i in range(N):
-        ....:         _ = p(a, a)
+        ....:         _ = p(a+x, a)
         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes
```

gives

```
File "src/sage/libs/singular/polynomial.pyx", line 187, in sage.libs.singular.polynomial.singular_polynomial_call
Failed example:
    for i in range(30):  # long time
        n = leak(10000)
        print("Leaked {} bytes".format(n))
        if n == 0:
            zeros += 1
            if zeros >= 6:
                break
        else:
            zeros = 0
Expected:
    Leaked...
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 0 bytes
Got:
    Leaked 6180864 bytes
    Leaked 3956736 bytes
    Leaked 3923968 bytes
    Leaked 3923968 bytes
...
```



---

archive/issue_comments_424011.json:
```json
{
    "body": "Changed commit from **[fbc22ce](https://github.com/sagemath/sagetrac-mirror/commit/fbc22ce52ee92231520303b8d90a58fb1464833f)** to **[3ffc6dd](https://github.com/sagemath/sagetrac-mirror/commit/3ffc6dd98efc7375429839b36c338a59580bd6c2)**",
    "created_at": "2021-05-07T13:56:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424011",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[fbc22ce](https://github.com/sagemath/sagetrac-mirror/commit/fbc22ce52ee92231520303b8d90a58fb1464833f)** to **[3ffc6dd](https://github.com/sagemath/sagetrac-mirror/commit/3ffc6dd98efc7375429839b36c338a59580bd6c2)**



---

archive/issue_comments_424012.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3ffc6dd98efc7375429839b36c338a59580bd6c2\">3ffc6dd</a></td><td><code>27261: move call test in sage/libs/singular</code></td></tr></table>\n",
    "created_at": "2021-05-07T13:56:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424012",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:26'>Comment 26:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3ffc6dd98efc7375429839b36c338a59580bd6c2">3ffc6dd</a></td><td><code>27261: move call test in sage/libs/singular</code></td></tr></table>




---

archive/issue_comments_424013.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nTrue. I moved my test over ZZ in the same file.",
    "created_at": "2021-05-07T13:57:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424013",
    "user": "https://github.com/videlec"
}
```

<a id='comment:27'>Comment 27:</a>
True. I moved my test over ZZ in the same file.



---

archive/issue_comments_424014.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nunfortunately I don't know how to fix the leak in `singular_polynomial_call()`. Trying to do something similar leads tp segfaults.",
    "created_at": "2021-05-07T15:55:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424014",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'>Comment 28:</a>
unfortunately I don't know how to fix the leak in `singular_polynomial_call()`. Trying to do something similar leads tp segfaults.



---

archive/issue_events_343755.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-05-07T16:42:30Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "title_is": "Memory leaks in libsingular polynomial evaluation and substitution",
    "title_was": "Fix a memory leak in libsingular polynomial evaluation",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343755"
}
```



---

archive/issue_comments_424015.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nThanks for trying. I update the description. Should we agree on the current status? Should we make it for sage-9.3?",
    "created_at": "2021-05-07T16:42:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424015",
    "user": "https://github.com/videlec"
}
```

<a id='comment:29'>Comment 29:</a>
Thanks for trying. I update the description. Should we agree on the current status? Should we make it for sage-9.3?



---

archive/issue_comments_424016.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,6 +31,6 @@\n \n This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).\n \n-A way to get rid of this problem is to use naive substitution in Python and avoid using low-level calls to singular library.\n+We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__` however we use the non-satisfactory solution of going via naive substitution in Python.\n \n See also #13447 also related to memory handling in singular.\n``````\n",
    "created_at": "2021-05-07T16:42:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424016",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,6 +31,6 @@
 
 This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).
 
-A way to get rid of this problem is to use naive substitution in Python and avoid using low-level calls to singular library.
+We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__` however we use the non-satisfactory solution of going via naive substitution in Python.
 
 See also #13447 also related to memory handling in singular.
``````




---

archive/issue_comments_424017.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1bf94f436804e6cbf34772c771353217cac9e6c8\">1bf94f4</a></td><td><code>27261: coerce argument to parent if possible</code></td></tr></table>\n",
    "created_at": "2021-05-07T16:59:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424017",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:30'>Comment 30:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1bf94f436804e6cbf34772c771353217cac9e6c8">1bf94f4</a></td><td><code>27261: coerce argument to parent if possible</code></td></tr></table>




---

archive/issue_comments_424018.json:
```json
{
    "body": "Changed commit from **[3ffc6dd](https://github.com/sagemath/sagetrac-mirror/commit/3ffc6dd98efc7375429839b36c338a59580bd6c2)** to **[1bf94f4](https://github.com/sagemath/sagetrac-mirror/commit/1bf94f436804e6cbf34772c771353217cac9e6c8)**",
    "created_at": "2021-05-07T16:59:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424018",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[3ffc6dd](https://github.com/sagemath/sagetrac-mirror/commit/3ffc6dd98efc7375429839b36c338a59580bd6c2)** to **[1bf94f4](https://github.com/sagemath/sagetrac-mirror/commit/1bf94f436804e6cbf34772c771353217cac9e6c8)**



---

archive/issue_comments_424019.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nI believe this indicates that the problem is upstream, in `fast_map_common_subexp`. I have replaced the function by one that does nothing but return a copy of the original polynomial.\n\n```diff\n--- a/src/sage/libs/singular/polynomial.pyx\n+++ b/src/sage/libs/singular/polynomial.pyx\n@@ -173,8 +173,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n         ....:     for i in range(N):\n         ....:         _ = p(x, y)\n         ....:         _ = p(x + y, y)\n-        ....:         _ = p(1, -1)\n-        ....:         _ = p(0, 0)\n         ....:     gc.collect()\n         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes\n@@ -185,7 +183,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n         ....:     gc.collect()\n         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     for i in range(N):\n-        ....:         _ = p(a, a)\n         ....:         _ = p(x, y)\n         ....:         _ = p(x + y, y)\n         ....:         _ = p(a + x, a)\n@@ -228,7 +225,7 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n     from_id.m[0] = p\n\n     rChangeCurrRing(r)\n-    cdef ideal *res_id = fast_map_common_subexp(from_id, r, to_id, r)\n+    cdef ideal *res_id = dummy_map_common_subexp(from_id, r, to_id)\n     ret[0] = res_id.m[0]\n\n     # Unsure why we have to normalize here. See #16958\n@@ -243,6 +240,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n\n     return 0\n\n+# can fail if the result is expected to be constant\n+cdef ideal *dummy_map_common_subexp(ideal *from_id, ring *r, ideal *to_id):\n+    cdef ideal *res_id = idInit(1, 1)\n+    res_id.m[0] = p_Copy(from_id.m[0], r)\n+    return res_id\n+\n cdef int singular_polynomial_cmp(poly *p, poly *q, ring *r):\n     \"\"\"\n     Compare two Singular elements ``p`` and ``q`` in ``r``.\n```\n\n```\nGot:\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n```",
    "created_at": "2021-05-08T12:51:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424019",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:31'>Comment 31:</a>
I believe this indicates that the problem is upstream, in `fast_map_common_subexp`. I have replaced the function by one that does nothing but return a copy of the original polynomial.

```diff
--- a/src/sage/libs/singular/polynomial.pyx
+++ b/src/sage/libs/singular/polynomial.pyx
@@ -173,8 +173,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
         ....:     for i in range(N):
         ....:         _ = p(x, y)
         ....:         _ = p(x + y, y)
-        ....:         _ = p(1, -1)
-        ....:         _ = p(0, 0)
         ....:     gc.collect()
         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes
@@ -185,7 +183,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
         ....:     gc.collect()
         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     for i in range(N):
-        ....:         _ = p(a, a)
         ....:         _ = p(x, y)
         ....:         _ = p(x + y, y)
         ....:         _ = p(a + x, a)
@@ -228,7 +225,7 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
     from_id.m[0] = p

     rChangeCurrRing(r)
-    cdef ideal *res_id = fast_map_common_subexp(from_id, r, to_id, r)
+    cdef ideal *res_id = dummy_map_common_subexp(from_id, r, to_id)
     ret[0] = res_id.m[0]

     # Unsure why we have to normalize here. See #16958
@@ -243,6 +240,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly

     return 0

+# can fail if the result is expected to be constant
+cdef ideal *dummy_map_common_subexp(ideal *from_id, ring *r, ideal *to_id):
+    cdef ideal *res_id = idInit(1, 1)
+    res_id.m[0] = p_Copy(from_id.m[0], r)
+    return res_id
+
 cdef int singular_polynomial_cmp(poly *p, poly *q, ring *r):
     """
     Compare two Singular elements ``p`` and ``q`` in ``r``.
```

```
Got:
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
```



---

archive/issue_comments_424020.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nHow does one convince the upstream? \nWould writing a C++ program using libsingular suffice?\nOr a Singular example would be required?\nIt could be that Singular does not use this function the way it's used here.\nIn fact, in Singular it's only called at one place, once, in in `maMapIdeal()`\nAnd the latter is only called once:\n\n```\n./Singular/ipshell.cc:  v->data=maMapIdeal(IDIDEAL(w), src_ring, (ideal)theMap, currRing,nMap);\n```\nin Singular's  shell, so it's probably not too hard to figure out the Singular command calling it.",
    "created_at": "2021-05-08T13:33:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424020",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'>Comment 32:</a>
How does one convince the upstream? 
Would writing a C++ program using libsingular suffice?
Or a Singular example would be required?
It could be that Singular does not use this function the way it's used here.
In fact, in Singular it's only called at one place, once, in in `maMapIdeal()`
And the latter is only called once:

```
./Singular/ipshell.cc:  v->data=maMapIdeal(IDIDEAL(w), src_ring, (ideal)theMap, currRing,nMap);
```
in Singular's  shell, so it's probably not too hard to figure out the Singular command calling it.



---

archive/issue_comments_424021.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f90202c7ef1d9926cc6a9bb5df2811e169fbbb4f\">f90202c</a></td><td><code>27261: be more careful about parent of result</code></td></tr></table>\n",
    "created_at": "2021-05-08T15:05:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424021",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:33'>Comment 33:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f90202c7ef1d9926cc6a9bb5df2811e169fbbb4f">f90202c</a></td><td><code>27261: be more careful about parent of result</code></td></tr></table>




---

archive/issue_comments_424022.json:
```json
{
    "body": "Changed commit from **[1bf94f4](https://github.com/sagemath/sagetrac-mirror/commit/1bf94f436804e6cbf34772c771353217cac9e6c8)** to **[f90202c](https://github.com/sagemath/sagetrac-mirror/commit/f90202c7ef1d9926cc6a9bb5df2811e169fbbb4f)**",
    "created_at": "2021-05-08T15:05:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424022",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[1bf94f4](https://github.com/sagemath/sagetrac-mirror/commit/1bf94f436804e6cbf34772c771353217cac9e6c8)** to **[f90202c](https://github.com/sagemath/sagetrac-mirror/commit/f90202c7ef1d9926cc6a9bb5df2811e169fbbb4f)**



---

archive/issue_comments_424023.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nSingular's `subst()` leaks memory very fast, I don't know why we expect anything better from `libsingular`.\nE.g.\n\n```\nring r=0,(x,y),dp;\npoly p=(x+y)^10;\nwhile (1) {\nsubst(p,x,x+y);\n}\n```\n\ntakes 30 sec to reach many gigabytes.",
    "created_at": "2021-05-08T22:48:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424023",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'>Comment 34:</a>
Singular's `subst()` leaks memory very fast, I don't know why we expect anything better from `libsingular`.
E.g.

```
ring r=0,(x,y),dp;
poly p=(x+y)^10;
while (1) {
subst(p,x,x+y);
}
```

takes 30 sec to reach many gigabytes.



---

archive/issue_comments_424024.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2021-05-09T07:54:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424024",
    "user": "https://github.com/videlec"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_424025.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,6 +31,6 @@\n \n This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).\n \n-We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__` however we use the non-satisfactory solution of going via naive substitution in Python.\n+We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python.\n \n See also #13447 also related to memory handling in singular.\n``````\n",
    "created_at": "2021-05-09T07:54:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424025",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,6 +31,6 @@
 
 This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).
 
-We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__` however we use the non-satisfactory solution of going via naive substitution in Python.
+We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python.
 
 See also #13447 also related to memory handling in singular.
``````




---

archive/issue_comments_424026.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nI opened an issue on the singular side https://github.com/Singular/Singular/issues/1089.",
    "created_at": "2021-05-09T07:54:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424026",
    "user": "https://github.com/videlec"
}
```

<a id='comment:35'>Comment 35:</a>
I opened an issue on the singular side https://github.com/Singular/Singular/issues/1089.



---

archive/issue_comments_424027.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nSage allows some weird things\n\n```\nsage: R.<x,y> = ZZ[]\nsage: S.<q> = ZZ[]\nsage: (x+y).subs(x=q)  # expected\nTraceback (most recent call last):\n...\nTypeError: unsupported operand parent(s) for +:\n  'Univariate Polynomial Ring in q over Integer Ring' and\n  'Multivariate Polynomial Ring in x, y over Integer Ring'\nsage: x.subs(x=q)  # why does it work!?\nq\n```",
    "created_at": "2021-05-09T08:24:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424027",
    "user": "https://github.com/videlec"
}
```

<a id='comment:36'>Comment 36:</a>
Sage allows some weird things

```
sage: R.<x,y> = ZZ[]
sage: S.<q> = ZZ[]
sage: (x+y).subs(x=q)  # expected
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for +:
  'Univariate Polynomial Ring in q over Integer Ring' and
  'Multivariate Polynomial Ring in x, y over Integer Ring'
sage: x.subs(x=q)  # why does it work!?
q
```



---

archive/issue_comments_424028.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nReplying to [@videlec](#comment%3A36):\n> Sage allows some weird things\n> \n> ```\n> sage: R.<x,y> = ZZ[]\n> sage: S.<q> = ZZ[]\n> sage: (x+y).subs(x=q)  # expected\n> Traceback (most recent call last):\n> ...\n> TypeError: unsupported operand parent(s) for +:\n>   'Univariate Polynomial Ring in q over Integer Ring' and\n>   'Multivariate Polynomial Ring in x, y over Integer Ring'\n> sage: x.subs(x=q)  # why does it work!?\n> q\n> ```\n\nand even worse\n\n```\nsage: x(q, y)\nq\n```",
    "created_at": "2021-05-09T08:25:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424028",
    "user": "https://github.com/videlec"
}
```

<a id='comment:37'>Comment 37:</a>
Replying to [@videlec](#comment%3A36):
> Sage allows some weird things
> 
> ```
> sage: R.<x,y> = ZZ[]
> sage: S.<q> = ZZ[]
> sage: (x+y).subs(x=q)  # expected
> Traceback (most recent call last):
> ...
> TypeError: unsupported operand parent(s) for +:
>   'Univariate Polynomial Ring in q over Integer Ring' and
>   'Multivariate Polynomial Ring in x, y over Integer Ring'
> sage: x.subs(x=q)  # why does it work!?
> q
> ```

and even worse

```
sage: x(q, y)
q
```



---

archive/issue_comments_424029.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nReplying to [@videlec](#comment%3A37):\n> Replying to [@videlec](#comment%3A36):\n> > Sage allows some weird things\n> > \n> > ```\n> > sage: R.<x,y> = ZZ[]\n> > sage: S.<q> = ZZ[]\n> > sage: (x+y).subs(x=q)  # expected\n> > Traceback (most recent call last):\n> > ...\n> > TypeError: unsupported operand parent(s) for +:\n> >   'Univariate Polynomial Ring in q over Integer Ring' and\n> >   'Multivariate Polynomial Ring in x, y over Integer Ring'\n> > sage: x.subs(x=q)  # why does it work!?\n> > q\n> > ```\n\n> \n> and even worse\n> \n> ```\n> sage: x(q, y)\n> q\n> ```\n\nhttps://groups.google.com/g/sage-devel/c/vGzNJKAQWbs",
    "created_at": "2021-05-09T08:51:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424029",
    "user": "https://github.com/videlec"
}
```

<a id='comment:38'>Comment 38:</a>
Replying to [@videlec](#comment%3A37):
> Replying to [@videlec](#comment%3A36):
> > Sage allows some weird things
> > 
> > ```
> > sage: R.<x,y> = ZZ[]
> > sage: S.<q> = ZZ[]
> > sage: (x+y).subs(x=q)  # expected
> > Traceback (most recent call last):
> > ...
> > TypeError: unsupported operand parent(s) for +:
> >   'Univariate Polynomial Ring in q over Integer Ring' and
> >   'Multivariate Polynomial Ring in x, y over Integer Ring'
> > sage: x.subs(x=q)  # why does it work!?
> > q
> > ```

> 
> and even worse
> 
> ```
> sage: x(q, y)
> q
> ```

https://groups.google.com/g/sage-devel/c/vGzNJKAQWbs



---

archive/issue_comments_424030.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/01ea16f66779cc51ba944b76bcb2056e8db990ee\">01ea16f</a></td><td><code>27261: fix memory leak in polynomial substitution</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f9a218c1b3a35f77c7878eab774a6fd80086a85\">2f9a218</a></td><td><code>27261: doctest subs and `__call__` leak</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26f694745a997916d6390321833d94b230fd70d4\">26f6947</a></td><td><code>27261: fix misformed doctests</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/796e85480c55e3cccec5acbfb88ebf92e111ae4b\">796e854</a></td><td><code>27261: fix modforms</code></td></tr></table>\n",
    "created_at": "2021-05-19T06:29:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424030",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:39'>Comment 39:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/01ea16f66779cc51ba944b76bcb2056e8db990ee">01ea16f</a></td><td><code>27261: fix memory leak in polynomial substitution</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f9a218c1b3a35f77c7878eab774a6fd80086a85">2f9a218</a></td><td><code>27261: doctest subs and `__call__` leak</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26f694745a997916d6390321833d94b230fd70d4">26f6947</a></td><td><code>27261: fix misformed doctests</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/796e85480c55e3cccec5acbfb88ebf92e111ae4b">796e854</a></td><td><code>27261: fix modforms</code></td></tr></table>




---

archive/issue_comments_424031.json:
```json
{
    "body": "Changed commit from **[f90202c](https://github.com/sagemath/sagetrac-mirror/commit/f90202c7ef1d9926cc6a9bb5df2811e169fbbb4f)** to **[796e854](https://github.com/sagemath/sagetrac-mirror/commit/796e85480c55e3cccec5acbfb88ebf92e111ae4b)**",
    "created_at": "2021-05-19T06:29:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424031",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[f90202c](https://github.com/sagemath/sagetrac-mirror/commit/f90202c7ef1d9926cc6a9bb5df2811e169fbbb4f)** to **[796e854](https://github.com/sagemath/sagetrac-mirror/commit/796e85480c55e3cccec5acbfb88ebf92e111ae4b)**



---

archive/issue_comments_424032.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nRebased on 9.3.\n\nI implemented the proposal of Nils Bruin from the sage-devel thread to implement the generic `__call__`. The behaviour is doctested but it would even be better if it was part of the `TestSuite` (see #31668). The doctest fixes from 796e854 (modular forms on Hecke triangle groups) look a bit weird. But at least the output is still correct.",
    "created_at": "2021-05-19T06:33:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424032",
    "user": "https://github.com/videlec"
}
```

<a id='comment:40'>Comment 40:</a>
Rebased on 9.3.

I implemented the proposal of Nils Bruin from the sage-devel thread to implement the generic `__call__`. The behaviour is doctested but it would even be better if it was part of the `TestSuite` (see #31668). The doctest fixes from 796e854 (modular forms on Hecke triangle groups) look a bit weird. But at least the output is still correct.



---

archive/issue_comments_424033.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ed83ed3ae94bd64502891ec6f2b1ac4759179d3f\">ed83ed3</a></td><td><code>27261: more robust doctest in polynomial.pyx</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/394d1734d7b939737bd8549558cc41cde91e59b4\">394d173</a></td><td><code>27261: fix error message in __call</code></td></tr></table>\n",
    "created_at": "2021-05-19T08:46:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424033",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:41'>Comment 41:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ed83ed3ae94bd64502891ec6f2b1ac4759179d3f">ed83ed3</a></td><td><code>27261: more robust doctest in polynomial.pyx</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/394d1734d7b939737bd8549558cc41cde91e59b4">394d173</a></td><td><code>27261: fix error message in __call</code></td></tr></table>




---

archive/issue_comments_424034.json:
```json
{
    "body": "Changed commit from **[796e854](https://github.com/sagemath/sagetrac-mirror/commit/796e85480c55e3cccec5acbfb88ebf92e111ae4b)** to **[394d173](https://github.com/sagemath/sagetrac-mirror/commit/394d1734d7b939737bd8549558cc41cde91e59b4)**",
    "created_at": "2021-05-19T08:46:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424034",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[796e854](https://github.com/sagemath/sagetrac-mirror/commit/796e85480c55e3cccec5acbfb88ebf92e111ae4b)** to **[394d173](https://github.com/sagemath/sagetrac-mirror/commit/394d1734d7b939737bd8549558cc41cde91e59b4)**



---

archive/issue_comments_424035.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,6 +31,6 @@\n \n This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).\n \n-We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python.\n+We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.\n \n See also #13447 also related to memory handling in singular.\n``````\n",
    "created_at": "2021-05-19T10:43:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424035",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,6 +31,6 @@
 
 This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).
 
-We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python.
+We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.
 
 See also #13447 also related to memory handling in singular.
``````




---

archive/issue_comments_424036.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\ntesting https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now",
    "created_at": "2021-05-19T13:20:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424036",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'>Comment 43:</a>
testing https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now



---

archive/issue_comments_424037.json:
```json
{
    "body": "<a id='comment:44'>Comment 44:</a>\nReplying to [@dimpase](#comment%3A43):\n> testing https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now\n\nGood idea. Thanks.",
    "created_at": "2021-05-19T13:41:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424037",
    "user": "https://github.com/videlec"
}
```

<a id='comment:44'>Comment 44:</a>
Replying to [@dimpase](#comment%3A43):
> testing https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now

Good idea. Thanks.



---

archive/issue_comments_424038.json:
```json
{
    "body": "Changed upstream from **Reported upstream. No feedback yet.** to **Fixed upstream, but not in a stable release.**",
    "created_at": "2021-05-19T13:48:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424038",
    "user": "https://github.com/videlec"
}
```

Changed upstream from **Reported upstream. No feedback yet.** to **Fixed upstream, but not in a stable release.**



---

archive/issue_comments_424039.json:
```json
{
    "body": "<a id='comment:46'>Comment 46:</a>\nUnfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.",
    "created_at": "2021-05-19T13:54:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424039",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:46'>Comment 46:</a>
Unfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.



---

archive/issue_comments_424040.json:
```json
{
    "body": "Changed upstream from **Fixed upstream, but not in a stable release.** to **Reported upstream. No feedback yet.**",
    "created_at": "2021-05-19T13:54:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424040",
    "user": "https://github.com/dimpase"
}
```

Changed upstream from **Fixed upstream, but not in a stable release.** to **Reported upstream. No feedback yet.**



---

archive/issue_comments_424041.json:
```json
{
    "body": "<a id='comment:47'>Comment 47:</a>\nReplying to [@dimpase](#comment%3A46):\n> Unfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.\n\nIt would be nice to track the underlying singular issue. However, this should not hold the ticket any longer.",
    "created_at": "2021-05-19T17:06:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424041",
    "user": "https://github.com/videlec"
}
```

<a id='comment:47'>Comment 47:</a>
Replying to [@dimpase](#comment%3A46):
> Unfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.

It would be nice to track the underlying singular issue. However, this should not hold the ticket any longer.



---

archive/issue_comments_424042.json:
```json
{
    "body": "<a id='comment:48'>Comment 48:</a>\nare the leaks in the ticket text now fixed?",
    "created_at": "2021-05-19T21:42:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424042",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:48'>Comment 48:</a>
are the leaks in the ticket text now fixed?



---

archive/issue_comments_424043.json:
```json
{
    "body": "<a id='comment:49'>Comment 49:</a>\nReplying to [@dimpase](#comment%3A48):\n> are the leaks in the ticket text now fixed?\n\nBoth of them as explained in the ticket description (`subs` thanks to you and `__call__` via naive symbolic evaluation). Also they are both doctested.",
    "created_at": "2021-05-20T06:24:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424043",
    "user": "https://github.com/videlec"
}
```

<a id='comment:49'>Comment 49:</a>
Replying to [@dimpase](#comment%3A48):
> are the leaks in the ticket text now fixed?

Both of them as explained in the ticket description (`subs` thanks to you and `__call__` via naive symbolic evaluation). Also they are both doctested.



---

archive/issue_comments_424044.json:
```json
{
    "body": "<a id='comment:50'>Comment 50:</a>\nShould we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?",
    "created_at": "2021-05-20T09:32:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424044",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:50'>Comment 50:</a>
Should we add the patch from  â€‹https://github.com/Singular/Singular/issues/1089  here?



---

archive/issue_comments_424045.json:
```json
{
    "body": "<a id='comment:51'>Comment 51:</a>\nReplying to [@dimpase](#comment%3A50):\n> Should we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?\n\nAccording to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?",
    "created_at": "2021-05-20T11:54:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424045",
    "user": "https://github.com/videlec"
}
```

<a id='comment:51'>Comment 51:</a>
Replying to [@dimpase](#comment%3A50):
> Should we add the patch from  â€‹https://github.com/Singular/Singular/issues/1089  here?

According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?



---

archive/issue_comments_424046.json:
```json
{
    "body": "<a id='comment:52'>Comment 52:</a>\nReplying to [@videlec](#comment%3A51):\n> Replying to [@dimpase](#comment%3A50):\n> > Should we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?\n\n> \n> According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?\n\nisn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?",
    "created_at": "2021-05-20T12:15:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424046",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:52'>Comment 52:</a>
Replying to [@videlec](#comment%3A51):
> Replying to [@dimpase](#comment%3A50):
> > Should we add the patch from  â€‹https://github.com/Singular/Singular/issues/1089  here?

> 
> According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?

isn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?



---

archive/issue_comments_424047.json:
```json
{
    "body": "<a id='comment:53'>Comment 53:</a>\nReplying to [@dimpase](#comment%3A52):\n> Replying to [@videlec](#comment%3A51):\n> > Replying to [@dimpase](#comment%3A50):\n> > > Should we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?\n\n> > \n> > According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?\n\n> \n> isn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?\n\nMaybe. I don't quite see the link with this ticket about `subs` and `__call__`. If you think it is worth adding this patch to singular, please open a ticket mentionning which issue it does solve on the sage side and create a branch.",
    "created_at": "2021-05-20T12:24:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424047",
    "user": "https://github.com/videlec"
}
```

<a id='comment:53'>Comment 53:</a>
Replying to [@dimpase](#comment%3A52):
> Replying to [@videlec](#comment%3A51):
> > Replying to [@dimpase](#comment%3A50):
> > > Should we add the patch from  â€‹https://github.com/Singular/Singular/issues/1089  here?

> > 
> > According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?

> 
> isn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?

Maybe. I don't quite see the link with this ticket about `subs` and `__call__`. If you think it is worth adding this patch to singular, please open a ticket mentionning which issue it does solve on the sage side and create a branch.



---

archive/issue_comments_424048.json:
```json
{
    "body": "<a id='comment:54'>Comment 54:</a>\nhere is another Singular leak demo, not fixed by the patch we discuss:\n\n```\nring r;\nmap F=r,x+y+z3,y+z+x2z3,z+1+xyz;\npoly f=(x+y+z+xz)^10;\nmatrix m=f;\nmatrix mm;\nwhile (1) {mm=F(m);}\n``` \n\nhere I checked that the code path goes through `fast_map_common_subexp()`, so this is another leak, hopefully just what we are fighting on this ticket.",
    "created_at": "2021-05-20T16:03:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424048",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:54'>Comment 54:</a>
here is another Singular leak demo, not fixed by the patch we discuss:

```
ring r;
map F=r,x+y+z3,y+z+x2z3,z+1+xyz;
poly f=(x+y+z+xz)^10;
matrix m=f;
matrix mm;
while (1) {mm=F(m);}
``` 

here I checked that the code path goes through `fast_map_common_subexp()`, so this is another leak, hopefully just what we are fighting on this ticket.



---

archive/issue_comments_424049.json:
```json
{
    "body": "<a id='comment:55'>Comment 55:</a>\nI've opened  https://github.com/Singular/Singular/issues/1090",
    "created_at": "2021-05-20T16:07:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424049",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:55'>Comment 55:</a>
I've opened  https://github.com/Singular/Singular/issues/1090



---

archive/issue_comments_424050.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,6 +31,10 @@\n \n This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).\n \n-We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.\n+We fix `.subs` (the first example above) by modifying the appropriate singular call. We identified two possibly related memory leaks in singular\n+- [singular issue #1089](https://github.com/Singular/Singular/issues/1089)\n+- [singular issue #1090](https://github.com/Singular/Singular/issues/1090)\n+\n+In the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.\n \n See also #13447 also related to memory handling in singular.\n``````\n",
    "created_at": "2021-05-20T17:47:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424050",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,6 +31,10 @@
 
 This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw) and [ask.sagemath.org](https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/).
 
-We fix `.subs` (the first example above) by modifying the appropriate singular call. For `__call__`, we identified a memory leak in singular, see [singular issue #1089](https://github.com/Singular/Singular/issues/1089). In the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.
+We fix `.subs` (the first example above) by modifying the appropriate singular call. We identified two possibly related memory leaks in singular
+- [singular issue #1089](https://github.com/Singular/Singular/issues/1089)
+- [singular issue #1090](https://github.com/Singular/Singular/issues/1090)
+
+In the mean time, we use the non-satisfactory solution of going via naive substitution in Python. To do so, we moved the generic implementation on the base class `MPolynomial`.
 
 See also #13447 also related to memory handling in singular.
``````




---

archive/issue_comments_424051.json:
```json
{
    "body": "Changed commit from **[394d173](https://github.com/sagemath/sagetrac-mirror/commit/394d1734d7b939737bd8549558cc41cde91e59b4)** to **[58ba726](https://github.com/sagemath/sagetrac-mirror/commit/58ba726c305e9c8136d15173e5cab2e9b55cc9fd)**",
    "created_at": "2021-05-23T07:41:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424051",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[394d173](https://github.com/sagemath/sagetrac-mirror/commit/394d1734d7b939737bd8549558cc41cde91e59b4)** to **[58ba726](https://github.com/sagemath/sagetrac-mirror/commit/58ba726c305e9c8136d15173e5cab2e9b55cc9fd)**



---

archive/issue_comments_424052.json:
```json
{
    "body": "<a id='comment:57'>Comment 57:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/58ba726c305e9c8136d15173e5cab2e9b55cc9fd\">58ba726</a></td><td><code>27261: more robust leak test</code></td></tr></table>\n",
    "created_at": "2021-05-23T07:41:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424052",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:57'>Comment 57:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/58ba726c305e9c8136d15173e5cab2e9b55cc9fd">58ba726</a></td><td><code>27261: more robust leak test</code></td></tr></table>




---

archive/issue_comments_424053.json:
```json
{
    "body": "<a id='comment:58'>Comment 58:</a>\nReplying to [@dimpase](#comment%3A55):\n> I've opened  https://github.com/Singular/Singular/issues/1090\n\nApparently, partially fixed in [b983a8a](https://github.com/Singular/Singular/commit/b983a8a3c4c9303d054079a944ecab5d165f88d4).",
    "created_at": "2021-05-23T19:12:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424053",
    "user": "https://github.com/videlec"
}
```

<a id='comment:58'>Comment 58:</a>
Replying to [@dimpase](#comment%3A55):
> I've opened  https://github.com/Singular/Singular/issues/1090

Apparently, partially fixed in [b983a8a](https://github.com/Singular/Singular/commit/b983a8a3c4c9303d054079a944ecab5d165f88d4).



---

archive/issue_comments_424054.json:
```json
{
    "body": "<a id='comment:59'>Comment 59:</a>\nThis [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.",
    "created_at": "2021-05-27T18:26:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424054",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:59'>Comment 59:</a>
This [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.



---

archive/issue_comments_424055.json:
```json
{
    "body": "<a id='comment:60'>Comment 60:</a>\nReplying to [@mwageringel](#comment%3A59):\n> This [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.\n\nThis ticket is not about performance issue. But as I mentioned in the ask question switching to naive Python evaluation as done in my branch actually speeds up the evaluation.",
    "created_at": "2021-05-27T19:09:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424055",
    "user": "https://github.com/videlec"
}
```

<a id='comment:60'>Comment 60:</a>
Replying to [@mwageringel](#comment%3A59):
> This [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.

This ticket is not about performance issue. But as I mentioned in the ask question switching to naive Python evaluation as done in my branch actually speeds up the evaluation.



---

archive/issue_comments_424056.json:
```json
{
    "body": "<a id='comment:61'>Comment 61:</a>\nping?",
    "created_at": "2021-05-28T07:33:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424056",
    "user": "https://github.com/videlec"
}
```

<a id='comment:61'>Comment 61:</a>
ping?



---

archive/issue_comments_424057.json:
```json
{
    "body": "<a id='comment:62'>Comment 62:</a>\ntesting...",
    "created_at": "2021-05-28T09:05:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424057",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:62'>Comment 62:</a>
testing...



---

archive/issue_comments_424058.json:
```json
{
    "body": "<a id='comment:63'>Comment 63:</a>\nlgtm",
    "created_at": "2021-05-28T12:05:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424058",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:63'>Comment 63:</a>
lgtm



---

archive/issue_events_343756.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-28T12:05:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343756"
}
```



---

archive/issue_events_343757.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-28T12:05:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343757"
}
```



---

archive/issue_comments_424059.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-05-28T12:05:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424059",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_424060.json:
```json
{
    "body": "<a id='comment:64'>Comment 64:</a>\nthx",
    "created_at": "2021-05-28T13:41:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424060",
    "user": "https://github.com/videlec"
}
```

<a id='comment:64'>Comment 64:</a>
thx



---

archive/issue_comments_424061.json:
```json
{
    "body": "<a id='comment:65'>Comment 65:</a>\none test broken on macOS:\n\n```\nFile \"src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\", line 153, in sage.rings.polynomial.multi_polynomial_libsingular\nFailed example:\n    for i in range(30):\n        n = leak_subs(20)\n        print(\"Leaked {} bytes\".format(n))\n        if n == 0:\n            zeros += 1\n            if zeros >= 6:\n                print(\"done\")\n                break\n        else:\n            zeros = 0\nExpected:\n    Leaked ...\n    ...\n    Leaked 0 bytes\n    done\nGot:\n    Leaked 184549376 bytes\n    Leaked 12582912 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 8388608 bytes\n    Leaked 0 bytes\n    Leaked 37748736 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 37748736 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 37748736 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n**********************************************************************\n1 item had failures:\n   1 of  55 in sage.rings.polynomial.multi_polynomial_libsingular\n```\n(tested together with #30801, but I guess it doesn't matter.",
    "created_at": "2021-05-28T18:14:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424061",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:65'>Comment 65:</a>
one test broken on macOS:

```
File "src/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 153, in sage.rings.polynomial.multi_polynomial_libsingular
Failed example:
    for i in range(30):
        n = leak_subs(20)
        print("Leaked {} bytes".format(n))
        if n == 0:
            zeros += 1
            if zeros >= 6:
                print("done")
                break
        else:
            zeros = 0
Expected:
    Leaked ...
    ...
    Leaked 0 bytes
    done
Got:
    Leaked 184549376 bytes
    Leaked 12582912 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 8388608 bytes
    Leaked 0 bytes
    Leaked 37748736 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 37748736 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 37748736 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
**********************************************************************
1 item had failures:
   1 of  55 in sage.rings.polynomial.multi_polynomial_libsingular
```
(tested together with #30801, but I guess it doesn't matter.



---

archive/issue_events_343758.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-28T18:14:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343758"
}
```



---

archive/issue_events_343759.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-05-28T18:14:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343759"
}
```



---

archive/issue_comments_424062.json:
```json
{
    "body": "<a id='comment:66'>Comment 66:</a>\nThe sagemath-singular interface is worse than what I thought. Switching to a generic `subs` function also leak!",
    "created_at": "2021-05-28T19:11:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424062",
    "user": "https://github.com/videlec"
}
```

<a id='comment:66'>Comment 66:</a>
The sagemath-singular interface is worse than what I thought. Switching to a generic `subs` function also leak!



---

archive/issue_comments_424063.json:
```json
{
    "body": "Changed commit from **[58ba726](https://github.com/sagemath/sagetrac-mirror/commit/58ba726c305e9c8136d15173e5cab2e9b55cc9fd)** to **[edf8847](https://github.com/sagemath/sagetrac-mirror/commit/edf88477b9986b2d476f08101f92450ac57bf58e)**",
    "created_at": "2021-05-28T20:30:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424063",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[58ba726](https://github.com/sagemath/sagetrac-mirror/commit/58ba726c305e9c8136d15173e5cab2e9b55cc9fd)** to **[edf8847](https://github.com/sagemath/sagetrac-mirror/commit/edf88477b9986b2d476f08101f92450ac57bf58e)**



---

archive/issue_comments_424064.json:
```json
{
    "body": "<a id='comment:67'>Comment 67:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ddc9a6bdf8db7f049530cfc62a762213894bcd71\">ddc9a6b</a></td><td><code>27261: use generic subs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/edf88477b9986b2d476f08101f92450ac57bf58e\">edf8847</a></td><td><code>27261: move tests in an independent file</code></td></tr></table>\n",
    "created_at": "2021-05-28T20:30:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424064",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:67'>Comment 67:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ddc9a6bdf8db7f049530cfc62a762213894bcd71">ddc9a6b</a></td><td><code>27261: use generic subs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/edf88477b9986b2d476f08101f92450ac57bf58e">edf8847</a></td><td><code>27261: move tests in an independent file</code></td></tr></table>




---

archive/issue_comments_424065.json:
```json
{
    "body": "<a id='comment:68'>Comment 68:</a>\nhow about adding latest upstream fixes as patches?",
    "created_at": "2021-05-29T00:13:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27261#issuecomment-424065",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:68'>Comment 68:</a>
how about adding latest upstream fixes as patches?



---

archive/issue_events_343760.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343760"
}
```



---

archive/issue_events_343761.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343761"
}
```



---

archive/issue_events_343762.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343762"
}
```



---

archive/issue_events_343763.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343763"
}
```



---

archive/issue_events_343764.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343764"
}
```



---

archive/issue_events_343765.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343765"
}
```



---

archive/issue_events_343766.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343766"
}
```



---

archive/issue_events_343767.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27261",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27261#event-343767"
}
```
