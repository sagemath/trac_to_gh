# Issue 27575: Three.js: Fix CDN Fallback

archive/issues_027338.json:
```json
{
    "body": "The Three.js viewer for notebooks already had a fallback to the online CDN when the local files are not loaded, which was silently failing. This small change fixes that.\n\nRenders [this discussion](https://groups.google.com/forum/?nomobile=true#!topic/sage-devel/QC5-9rexyJo) moot.\n\nCC:  @egourgoulhon @novoselt @slel\n\nKeywords: threejs\n\nBranch/Commit: a355a67151634944683c4f987630cd03f33f4417\n\nReviewer: Julian R\u00fcth\n\nAuthor: Paul Masson\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27575\n\n",
    "closed_at": "2019-04-03T18:38:35Z",
    "created_at": "2019-03-30T19:42:56Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Three.js: Fix CDN Fallback",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27575",
    "user": "https://github.com/paulmasson"
}
```
The Three.js viewer for notebooks already had a fallback to the online CDN when the local files are not loaded, which was silently failing. This small change fixes that.

Renders [this discussion](https://groups.google.com/forum/?nomobile=true#!topic/sage-devel/QC5-9rexyJo) moot.

CC:  @egourgoulhon @novoselt @slel

Keywords: threejs

Branch/Commit: a355a67151634944683c4f987630cd03f33f4417

Reviewer: Julian Rüth

Author: Paul Masson

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27575





---

archive/issue_comments_410464.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graphics.",
    "created_at": "2019-03-30T19:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410464",
    "user": "https://github.com/paulmasson"
}
```

Changing component from PLEASE CHANGE to graphics.



---

archive/issue_comments_410465.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2019-03-30T19:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410465",
    "user": "https://github.com/paulmasson"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_410466.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2019-03-30T19:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410466",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_410467.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-30T19:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410467",
    "user": "https://github.com/paulmasson"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_410468.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+The Three.js viewer for notebooks already had a fallback to the online CDN when the local files are not loaded which was silently failing. This small change fixes that for most browsers, but it will not work for Internet Explorer. The fix to cover this old browser would be much more clumsy and not encourage users to move to better browser options.\n \n+Renders [this discussion](https://groups.google.com/forum/?nomobile=true#!topic/sage-devel/QC5-9rexyJo) moot.\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-03-30T19:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410468",
    "user": "https://github.com/paulmasson"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
+The Three.js viewer for notebooks already had a fallback to the online CDN when the local files are not loaded which was silently failing. This small change fixes that for most browsers, but it will not work for Internet Explorer. The fix to cover this old browser would be much more clumsy and not encourage users to move to better browser options.
 
+Renders [this discussion](https://groups.google.com/forum/?nomobile=true#!topic/sage-devel/QC5-9rexyJo) moot.
 
 Comment: 1
 
``````




---

archive/issue_comments_410469.json:
```json
{
    "body": "<a id='comment:3'></a>The \"mooted\" discussion is about such a fallback should be on by default. Do I get it right that the fallback was simply broken, and the branch here fixes it, so that it silently works?",
    "created_at": "2019-03-31T15:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410469",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>The "mooted" discussion is about such a fallback should be on by default. Do I get it right that the fallback was simply broken, and the branch here fixes it, so that it silently works?



---

archive/issue_comments_410470.json:
```json
{
    "body": "<a id='comment:4'></a>Could you explain why this makes a difference? I.e., I don't understand why this change would make a difference to the browser.\n\nAlso, how does this compare to #26434?",
    "created_at": "2019-03-31T15:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410470",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:4'></a>Could you explain why this makes a difference? I.e., I don't understand why this change would make a difference to the browser.

Also, how does this compare to #26434?



---

archive/issue_comments_410471.json:
```json
{
    "body": "<a id='comment:5'></a>I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?",
    "created_at": "2019-03-31T15:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410471",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:5'></a>I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?



---

archive/issue_comments_410472.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-31T21:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410472",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410473.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+The Three.js viewer for notebooks already had a fallback to the online CDN when the local files are not loaded, which was silently failing. This small change fixes that.\n \n+Renders [this discussion](https://groups.google.com/forum/?nomobile=true#!topic/sage-devel/QC5-9rexyJo) moot.\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-03-31T21:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410473",
    "user": "https://github.com/paulmasson"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
+The Three.js viewer for notebooks already had a fallback to the online CDN when the local files are not loaded, which was silently failing. This small change fixes that.
 
+Renders [this discussion](https://groups.google.com/forum/?nomobile=true#!topic/sage-devel/QC5-9rexyJo) moot.
 
 Comment: 1
 
``````




---

archive/issue_comments_410474.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:3 dimpase]:\n> The \"mooted\" discussion is about such a fallback should be on by default. Do I get it right that the fallback was simply broken, and the branch here fixes it, so that it silently works? \n\nIt only silently works when the notebook is moved to a remote location. A locally served notebook should not have any problem finding the JS files and the the fallback will not be activated.",
    "created_at": "2019-03-31T21:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410474",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:8'></a>Replying to [comment:3 dimpase]:
> The "mooted" discussion is about such a fallback should be on by default. Do I get it right that the fallback was simply broken, and the branch here fixes it, so that it silently works? 

It only silently works when the notebook is moved to a remote location. A locally served notebook should not have any problem finding the JS files and the the fallback will not be activated.



---

archive/issue_comments_410475.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:5 saraedum]:\n> I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?\n\nA regular string in JS needs line continuation markers. The back ticks turn the string into a template literal, which is allowed to include new lines.\n\nAfter reviewing the code in #22670 that added this fallback, I reverted to a normal JS string. That way older browsers and other environments should be supported.",
    "created_at": "2019-03-31T21:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410475",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:9'></a>Replying to [comment:5 saraedum]:
> I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?

A regular string in JS needs line continuation markers. The back ticks turn the string into a template literal, which is allowed to include new lines.

After reviewing the code in #22670 that added this fallback, I reverted to a normal JS string. That way older browsers and other environments should be supported.



---

archive/issue_comments_410476.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:4 saraedum]:\n> Also, how does this compare to #26434?\n\nAs a JS person, I would never think of copying an entire library into every file I create. While it is a possible solution, it just doesn't seem elegant. This fallback is intended for files shared on the web, which implies internet access to a CDN.\n\nPlease describe what problems you encountered at Luminy. Was there any lack of internet access? If this fallback had been working properly, then perhaps there would have been no issues.",
    "created_at": "2019-03-31T21:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410476",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:10'></a>Replying to [comment:4 saraedum]:
> Also, how does this compare to #26434?

As a JS person, I would never think of copying an entire library into every file I create. While it is a possible solution, it just doesn't seem elegant. This fallback is intended for files shared on the web, which implies internet access to a CDN.

Please describe what problems you encountered at Luminy. Was there any lack of internet access? If this fallback had been working properly, then perhaps there would have been no issues.



---

archive/issue_comments_410477.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 paulmasson]:\n> Replying to [comment:5 saraedum]:\n> > I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?\n\n> A regular string in JS needs line continuation markers. The back ticks turn the string into a template literal, which is allowed to include new lines.\n\nSure. That makes sense.",
    "created_at": "2019-03-31T22:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410477",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:11'></a>Replying to [comment:9 paulmasson]:
> Replying to [comment:5 saraedum]:
> > I thought I had understood, but I think I don't. The online scripts don't seem to contain a `'`. So why did it not work before?

> A regular string in JS needs line continuation markers. The back ticks turn the string into a template literal, which is allowed to include new lines.

Sure. That makes sense.



---

archive/issue_comments_410478.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 paulmasson]:\n> Replying to [comment:4 saraedum]:\n> > Also, how does this compare to #26434?\n\n> As a JS person, I would never think of copying an entire library into every file I create. While it is a possible solution, it just doesn't seem elegant.\n\nI agree that it's not elegant. But you probably wouldn't dynamically emit script tags, would you?\n\n> This fallback is intended for files shared on the web, which implies internet access to a CDN.\n\n\nPersonally, I really don't mind if this code contacts a CDN but one could argue that this could also run in a local webserver that is not meant to access the internet.\n\n> Please describe what problems you encountered at Luminy. Was there any lack of internet access? If this fallback had been working properly, then perhaps there would have been no issues.\n\n\nThere was no lack of internet access. I forget what the setup was unfortunately. Somehow this was served through an interface/web server that could not resolve the path to the local three.js assets. I assume that this fallback would have fixed the problem.\n\nSo, I'll set this to positive review as this definitely fixes an existing bug (currently, we are emitting JavaScript code with a Syntax Error.) Whether this is a privacy issue in the first place can be discussed in a new issue imho. Feel free to set that one to critical if you have strong feelings about it.",
    "created_at": "2019-03-31T22:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410478",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:12'></a>Replying to [comment:10 paulmasson]:
> Replying to [comment:4 saraedum]:
> > Also, how does this compare to #26434?

> As a JS person, I would never think of copying an entire library into every file I create. While it is a possible solution, it just doesn't seem elegant.

I agree that it's not elegant. But you probably wouldn't dynamically emit script tags, would you?

> This fallback is intended for files shared on the web, which implies internet access to a CDN.


Personally, I really don't mind if this code contacts a CDN but one could argue that this could also run in a local webserver that is not meant to access the internet.

> Please describe what problems you encountered at Luminy. Was there any lack of internet access? If this fallback had been working properly, then perhaps there would have been no issues.


There was no lack of internet access. I forget what the setup was unfortunately. Somehow this was served through an interface/web server that could not resolve the path to the local three.js assets. I assume that this fallback would have fixed the problem.

So, I'll set this to positive review as this definitely fixes an existing bug (currently, we are emitting JavaScript code with a Syntax Error.) Whether this is a privacy issue in the first place can be discussed in a new issue imho. Feel free to set that one to critical if you have strong feelings about it.



---

archive/issue_comments_410479.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-31T22:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410479",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410480.json:
```json
{
    "body": "<a id='comment:13'></a>Ah, so the place where this does not work without the CDN is CoCalc btw. Let me build Sage there to check that it is actually fixed with this.",
    "created_at": "2019-03-31T22:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410480",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:13'></a>Ah, so the place where this does not work without the CDN is CoCalc btw. Let me build Sage there to check that it is actually fixed with this.



---

archive/issue_comments_410481.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2019-03-31T22:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410481",
    "user": "https://github.com/saraedum"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_410482.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-03-31T22:36:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410482",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_410483.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-01T02:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410483",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_410484.json:
```json
{
    "body": "<a id='comment:17'></a>This final commit does not change functionality, but produces cleaner HTML output. The inserted script tags will now appear on separate lines. Sorry for any inconvenience this change might cause.",
    "created_at": "2019-04-01T02:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410484",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:17'></a>This final commit does not change functionality, but produces cleaner HTML output. The inserted script tags will now appear on separate lines. Sorry for any inconvenience this change might cause.



---

archive/issue_comments_410485.json:
```json
{
    "body": "<a id='comment:18'></a>I currently waiting for my upgrade on CoCalc. Somehow, I cannot build Sage there anymore\u2026",
    "created_at": "2019-04-01T02:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410485",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:18'></a>I currently waiting for my upgrade on CoCalc. Somehow, I cannot build Sage there anymore…



---

archive/issue_comments_410486.json:
```json
{
    "body": "<a id='comment:20'></a>slelievre: Could you test this on CoCalc (or share one of your many upgrades with me so I can try myself?)",
    "created_at": "2019-04-01T02:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410486",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:20'></a>slelievre: Could you test this on CoCalc (or share one of your many upgrades with me so I can try myself?)



---

archive/issue_comments_410487.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:13 saraedum]:\n> Ah, so the place where this does not work without the CDN is CoCalc btw.\n\n\nAnother place where this does not work without the CDN is nbviewer.jupyter.org. With the code in this ticket branch, one can indeed get threejs rendering without having to add the option `online=True`, as [this example](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/test_dodecahedron_threejs.ipynb) demonstrates. Accordingly, I am +1 for a positive review!",
    "created_at": "2019-04-01T16:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410487",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:21'></a>Replying to [comment:13 saraedum]:
> Ah, so the place where this does not work without the CDN is CoCalc btw.


Another place where this does not work without the CDN is nbviewer.jupyter.org. With the code in this ticket branch, one can indeed get threejs rendering without having to add the option `online=True`, as [this example](https://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/test_dodecahedron_threejs.ipynb) demonstrates. Accordingly, I am +1 for a positive review!



---

archive/issue_comments_410488.json:
```json
{
    "body": "<a id='comment:22'></a>Building on CoCalc failed somehow. Since it works on the nbviewer, I assume it also works on CoCalc; at least it certainly won't make the situation worse.",
    "created_at": "2019-04-01T16:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410488",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:22'></a>Building on CoCalc failed somehow. Since it works on the nbviewer, I assume it also works on CoCalc; at least it certainly won't make the situation worse.



---

archive/issue_comments_410489.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-01T16:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410489",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410490.json:
```json
{
    "body": "Changing keywords from \"\" to \"threejs\".",
    "created_at": "2019-04-02T13:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410490",
    "user": "https://github.com/embray"
}
```

Changing keywords from "" to "threejs".



---

archive/issue_events_068488.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-03T18:38:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27575#event-68488"
}
```



---

archive/issue_comments_410491.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-03T18:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27575#issuecomment-410491",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
