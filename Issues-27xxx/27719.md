# Issue 27719: Preparser for file.sage: treat "from __future__ import ..." properly

archive/issues_027482.json:
```json
{
    "body": "If a file `file.sage` has a line `from `__future__` import ...`, the preparser should put it at the top of the file [where it needs to be](https://docs.python.org/2/reference/simple_stmts.html#future).\n\n**Branch:** [5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)\n\n**Reviewer:** Nils Bruin, John Palmieri\n\n**Author:** John Palmieri, Nils Bruin\n\nIssue created by migration from https://trac.sagemath.org/ticket/27719\n\n",
    "closed_at": "2019-04-29T11:50:48Z",
    "created_at": "2019-04-25T02:55:59Z",
    "labels": [
        "component: misc",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Preparser for file.sage: treat \"from __future__ import ...\" properly",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27719",
    "user": "https://github.com/jhpalmieri"
}
```
If a file `file.sage` has a line `from `__future__` import ...`, the preparser should put it at the top of the file [where it needs to be](https://docs.python.org/2/reference/simple_stmts.html#future).

**Branch:** [5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)

**Reviewer:** Nils Bruin, John Palmieri

**Author:** John Palmieri, Nils Bruin

Issue created by migration from https://trac.sagemath.org/ticket/27719





---

archive/issue_comments_433995.json:
```json
{
    "body": "**Branch:** [u/jhpalmieri/future](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/future)",
    "created_at": "2019-04-25T03:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-433995",
    "user": "https://github.com/jhpalmieri"
}
```

**Branch:** [u/jhpalmieri/future](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/future)



---

archive/issue_events_248946.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2019-04-25T03:28:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27719#event-248946"
}
```



---

archive/issue_comments_433996.json:
```json
{
    "body": "**Commit:** [4b627ff0c0a01359ced204a5d9c38680d9abe5b5](https://github.com/sagemath/sagetrac-mirror/commit/4b627ff0c0a01359ced204a5d9c38680d9abe5b5)",
    "created_at": "2019-04-25T03:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-433996",
    "user": "https://github.com/jhpalmieri"
}
```

**Commit:** [4b627ff0c0a01359ced204a5d9c38680d9abe5b5](https://github.com/sagemath/sagetrac-mirror/commit/4b627ff0c0a01359ced204a5d9c38680d9abe5b5)



---

archive/issue_comments_433997.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4b627ff0c0a01359ced204a5d9c38680d9abe5b5\">4b627ff</a></td><td><code>trac 27719: preparser handling of \"from `__future__` import ...\"</code></td></tr></table>\n",
    "created_at": "2019-04-25T03:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-433997",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4b627ff0c0a01359ced204a5d9c38680d9abe5b5">4b627ff</a></td><td><code>trac 27719: preparser handling of "from `__future__` import ..."</code></td></tr></table>




---

archive/issue_comments_433998.json:
```json
{
    "body": "**Author:** John Palmieri",
    "created_at": "2019-04-25T03:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-433998",
    "user": "https://github.com/jhpalmieri"
}
```

**Author:** John Palmieri



---

archive/issue_comments_433999.json:
```json
{
    "body": "<a id='comment:3'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/74c2e3babf01e516a4fd19ba8702e03e06a8dca6\">74c2e3b</a></td><td><code>trac 27719: preparser handling of \"from `__future__` import ...\"</code></td></tr></table>\n",
    "created_at": "2019-04-25T03:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-433999",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/74c2e3babf01e516a4fd19ba8702e03e06a8dca6">74c2e3b</a></td><td><code>trac 27719: preparser handling of "from `__future__` import ..."</code></td></tr></table>




---

archive/issue_comments_434000.json:
```json
{
    "body": "**Changing commit** from \"[4b627ff0c0a01359ced204a5d9c38680d9abe5b5](https://github.com/sagemath/sagetrac-mirror/commit/4b627ff0c0a01359ced204a5d9c38680d9abe5b5)\" to \"[74c2e3babf01e516a4fd19ba8702e03e06a8dca6](https://github.com/sagemath/sagetrac-mirror/commit/74c2e3babf01e516a4fd19ba8702e03e06a8dca6)\".",
    "created_at": "2019-04-25T03:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434000",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[4b627ff0c0a01359ced204a5d9c38680d9abe5b5](https://github.com/sagemath/sagetrac-mirror/commit/4b627ff0c0a01359ced204a5d9c38680d9abe5b5)" to "[74c2e3babf01e516a4fd19ba8702e03e06a8dca6](https://github.com/sagemath/sagetrac-mirror/commit/74c2e3babf01e516a4fd19ba8702e03e06a8dca6)".



---

archive/issue_comments_434001.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8d8e713d2787037c2ef6bb131adfcee8e4f39ad4\">8d8e713</a></td><td><code>trac 27719: preparser handling of \"from `__future__` import ...\"</code></td></tr></table>\n",
    "created_at": "2019-04-25T05:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434001",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8d8e713d2787037c2ef6bb131adfcee8e4f39ad4">8d8e713</a></td><td><code>trac 27719: preparser handling of "from `__future__` import ..."</code></td></tr></table>




---

archive/issue_comments_434002.json:
```json
{
    "body": "**Changing commit** from \"[74c2e3babf01e516a4fd19ba8702e03e06a8dca6](https://github.com/sagemath/sagetrac-mirror/commit/74c2e3babf01e516a4fd19ba8702e03e06a8dca6)\" to \"[8d8e713d2787037c2ef6bb131adfcee8e4f39ad4](https://github.com/sagemath/sagetrac-mirror/commit/8d8e713d2787037c2ef6bb131adfcee8e4f39ad4)\".",
    "created_at": "2019-04-25T05:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[74c2e3babf01e516a4fd19ba8702e03e06a8dca6](https://github.com/sagemath/sagetrac-mirror/commit/74c2e3babf01e516a4fd19ba8702e03e06a8dca6)" to "[8d8e713d2787037c2ef6bb131adfcee8e4f39ad4](https://github.com/sagemath/sagetrac-mirror/commit/8d8e713d2787037c2ef6bb131adfcee8e4f39ad4)".



---

archive/issue_comments_434003.json:
```json
{
    "body": "<a id='comment:5'></a>\n- I think in principle a \"from `__future__` import\" directive CAN use parentheses and thus cover multiple lines (I guess they could escape newlines as well to cover multiple lines). I think that's sufficiently rare that we can afford to miss the case, but perhaps we should document that we don't deal with it.\n\n  - It would be quite a bit more efficient if we use a regexp that we can apply on the string as a whole, so that we can avoid splitting the file into lines and concatenating it later. We can then split the string on the index where the statement was found and do surgery that way. Then we only incur string manipulation overhead when we encounter a `__future__`.\n\n  - If we're going to stick with splitting, then do the reordering manipulations on the list of lines and later assemble the string via a `\"\\n\".join(list of lines)`. That's O(n) rather than the O(n^2) you get from repeatedly adding strings.",
    "created_at": "2019-04-25T05:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434003",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'></a>
- I think in principle a "from `__future__` import" directive CAN use parentheses and thus cover multiple lines (I guess they could escape newlines as well to cover multiple lines). I think that's sufficiently rare that we can afford to miss the case, but perhaps we should document that we don't deal with it.

  - It would be quite a bit more efficient if we use a regexp that we can apply on the string as a whole, so that we can avoid splitting the file into lines and concatenating it later. We can then split the string on the index where the statement was found and do surgery that way. Then we only incur string manipulation overhead when we encounter a `__future__`.

  - If we're going to stick with splitting, then do the reordering manipulations on the list of lines and later assemble the string via a `"\n".join(list of lines)`. That's O(n) rather than the O(n^2) you get from repeatedly adding strings.



---

archive/issue_comments_434004.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d81351873c2e2132379389dbdaba91f07d0a972a\">d813518</a></td><td><code>trac 27719: preparser handling of \"from `__future__` import ...\"</code></td></tr></table>\n",
    "created_at": "2019-04-25T15:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d81351873c2e2132379389dbdaba91f07d0a972a">d813518</a></td><td><code>trac 27719: preparser handling of "from `__future__` import ..."</code></td></tr></table>




---

archive/issue_comments_434005.json:
```json
{
    "body": "**Changing commit** from \"[8d8e713d2787037c2ef6bb131adfcee8e4f39ad4](https://github.com/sagemath/sagetrac-mirror/commit/8d8e713d2787037c2ef6bb131adfcee8e4f39ad4)\" to \"[d81351873c2e2132379389dbdaba91f07d0a972a](https://github.com/sagemath/sagetrac-mirror/commit/d81351873c2e2132379389dbdaba91f07d0a972a)\".",
    "created_at": "2019-04-25T15:58:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434005",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[8d8e713d2787037c2ef6bb131adfcee8e4f39ad4](https://github.com/sagemath/sagetrac-mirror/commit/8d8e713d2787037c2ef6bb131adfcee8e4f39ad4)" to "[d81351873c2e2132379389dbdaba91f07d0a972a](https://github.com/sagemath/sagetrac-mirror/commit/d81351873c2e2132379389dbdaba91f07d0a972a)".



---

archive/issue_comments_434006.json:
```json
{
    "body": "<a id='comment:7'></a>\nHere is a different version which searches the whole string instead of splitting, and it does some crude error-checking looking for multi-line `from `__future__` import ...` statements. If it finds them, it raises an error. I don't know how to do anything more sophisticated without actually parsing the Python code in the file, and that seems like overkill.",
    "created_at": "2019-04-25T16:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434006",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
Here is a different version which searches the whole string instead of splitting, and it does some crude error-checking looking for multi-line `from `__future__` import ...` statements. If it finds them, it raises an error. I don't know how to do anything more sophisticated without actually parsing the Python code in the file, and that seems like overkill.



---

archive/issue_comments_434007.json:
```json
{
    "body": "**Changing branch** from \"[u/jhpalmieri/future](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/future)\" to \"[u/nbruin/future](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/future)\".",
    "created_at": "2019-04-27T02:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434007",
    "user": "https://github.com/nbruin"
}
```

**Changing branch** from "[u/jhpalmieri/future](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/future)" to "[u/nbruin/future](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/future)".



---

archive/issue_comments_434008.json:
```json
{
    "body": "<a id='comment:9'></a>\nMade a tiny update: appending a few items to a list should be quite cheap (extra room should be available). The pythonic way of joining strings together is via \"join\" (it's faster; not that it matters here)\n\nLet's see what the patchbots say. The previous reports had some failures (perhaps spurious). Otherwise: I'm OK with your changes. If you're OK with mine you can set it to positive on my behalf.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee\">5d014bc</a></td><td><code>Use a slightly more pythonic way of joining multiple strings together</code></td></tr></table>\n",
    "created_at": "2019-04-27T02:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434008",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>
Made a tiny update: appending a few items to a list should be quite cheap (extra room should be available). The pythonic way of joining strings together is via "join" (it's faster; not that it matters here)

Let's see what the patchbots say. The previous reports had some failures (perhaps spurious). Otherwise: I'm OK with your changes. If you're OK with mine you can set it to positive on my behalf.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee">5d014bc</a></td><td><code>Use a slightly more pythonic way of joining multiple strings together</code></td></tr></table>




---

archive/issue_comments_434009.json:
```json
{
    "body": "**Changing commit** from \"[d81351873c2e2132379389dbdaba91f07d0a972a](https://github.com/sagemath/sagetrac-mirror/commit/d81351873c2e2132379389dbdaba91f07d0a972a)\" to \"[5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)\".",
    "created_at": "2019-04-27T02:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434009",
    "user": "https://github.com/nbruin"
}
```

**Changing commit** from "[d81351873c2e2132379389dbdaba91f07d0a972a](https://github.com/sagemath/sagetrac-mirror/commit/d81351873c2e2132379389dbdaba91f07d0a972a)" to "[5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)".



---

archive/issue_comments_434010.json:
```json
{
    "body": "<a id='comment:10'></a>\nI see the same patchbot doctest errors here as on several other tickets, so they look spurious.",
    "created_at": "2019-04-27T16:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434010",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>
I see the same patchbot doctest errors here as on several other tickets, so they look spurious.



---

archive/issue_events_248947.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2019-04-27T16:46:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27719#event-248947"
}
```



---

archive/issue_events_248948.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2019-04-27T16:46:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27719#event-248948"
}
```



---

archive/issue_comments_434011.json:
```json
{
    "body": "**Changing author** from \"John Palmieri\" to \"John Palmieri, Nils Bruin\".",
    "created_at": "2019-04-27T16:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434011",
    "user": "https://github.com/jhpalmieri"
}
```

**Changing author** from "John Palmieri" to "John Palmieri, Nils Bruin".



---

archive/issue_comments_434012.json:
```json
{
    "body": "**Reviewer:** Nils Bruin, John Palmieri",
    "created_at": "2019-04-27T16:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434012",
    "user": "https://github.com/jhpalmieri"
}
```

**Reviewer:** Nils Bruin, John Palmieri



---

archive/issue_comments_434013.json:
```json
{
    "body": "**Changing branch** from \"[u/nbruin/future](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/future)\" to \"[5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)\".",
    "created_at": "2019-04-29T11:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434013",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/nbruin/future](https://github.com/sagemath/sagetrac-mirror/tree/u/nbruin/future)" to "[5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)".



---

archive/issue_events_248949.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-29T11:50:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27719#event-248949"
}
```



---

archive/issue_events_248950.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-29T11:50:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27719#event-248950"
}
```



---

archive/issue_comments_434014.json:
```json
{
    "body": "<a id='comment:12'></a>\nWhew, this looks fine, but we really need to replace this code with a real parser... :(",
    "created_at": "2019-06-07T18:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434014",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
Whew, this looks fine, but we really need to replace this code with a real parser... :(



---

archive/issue_comments_434015.json:
```json
{
    "body": "**Changing commit** from \"[5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)\" to \"\".",
    "created_at": "2019-06-07T18:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27719",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27719#issuecomment-434015",
    "user": "https://github.com/embray"
}
```

**Changing commit** from "[5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee](https://github.com/sagemath/sagetrac-mirror/commit/5d014bc3aa72d7e2b3a95254fa23ca9a0318cbee)" to "".
