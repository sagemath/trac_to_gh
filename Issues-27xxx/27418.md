# Issue 27418: Global function fields: completions

archive/issues_027181.json:
```json
{
    "assignees": [],
    "body": "This is part of the meta-ticket #22982.\n\nThe goal of the present ticket is to add code for computing with higher derivations and completions of global function fields.\n\nBranch/Commit: **[`13ce935`](https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Kwankyu Lee**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27418_\n\n",
    "closed_at": "2019-03-15T08:09:41Z",
    "created_at": "2019-03-04T09:09:21Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Global function fields: completions",
    "type": "issue",
    "updated_at": "2019-03-15T08:09:41Z",
    "url": "https://github.com/sagemath/sage/issues/27418",
    "user": "https://github.com/kwankyu"
}
```
This is part of the meta-ticket #22982.

The goal of the present ticket is to add code for computing with higher derivations and completions of global function fields.

Branch/Commit: **[`13ce935`](https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b)**

Reviewer: **Travis Scrimshaw**

Author: **Kwankyu Lee**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/27418_





---

archive/issue_events_373615.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2019-03-04T09:09:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373615"
}
```



---

archive/issue_events_373616.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2019-03-04T09:09:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373616"
}
```



---

archive/issue_events_373617.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2019-03-04T09:09:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373617"
}
```



---

archive/issue_events_373618.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2019-03-04T09:09:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373618"
}
```



---

archive/issue_comments_424093.json:
```json
{
    "body": "Author: **Kwankyu Lee**",
    "created_at": "2019-03-11T03:53:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424093",
    "user": "https://github.com/kwankyu"
}
```

Author: **Kwankyu Lee**



---

archive/issue_comments_424094.json:
```json
{
    "body": "Branch: **[u/klee/27418](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/27418)**",
    "created_at": "2019-03-11T03:53:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424094",
    "user": "https://github.com/kwankyu"
}
```

Branch: **[u/klee/27418](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/27418)**



---

archive/issue_comments_424095.json:
```json
{
    "body": "Commit: **[`06d41fd`](https://github.com/sagemath/sagetrac-mirror/commit/06d41fd4eeba447383ecb4b7e5a1691737cab5b3)**",
    "created_at": "2019-03-11T04:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424095",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`06d41fd`](https://github.com/sagemath/sagetrac-mirror/commit/06d41fd4eeba447383ecb4b7e5a1691737cab5b3)**



---

archive/issue_comments_424096.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06d41fd4eeba447383ecb4b7e5a1691737cab5b3\"><code>06d41fd</code></a></td><td><code>Add higher-derivations and completions</code></td></tr></table>\n",
    "created_at": "2019-03-11T04:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424096",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06d41fd4eeba447383ecb4b7e5a1691737cab5b3"><code>06d41fd</code></a></td><td><code>Add higher-derivations and completions</code></td></tr></table>




---

archive/issue_events_373619.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2019-03-11T09:13:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373619"
}
```



---

archive/issue_comments_424097.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nSome comments:\n\n`FunctionFieldHigherDerivation.__init__` is missing a doctest (add a `TestSuite(foo).run()` here `;)`, if something is failing, add a `skip=\"_test_failed\"` or `skip=[\"_test_failed\", \"_test_failure\"]`).\n\nSame for `FunctionFieldHigherDerivation_rational`.\n\nI think you should include a definition of the Cartier operation (unless this is something anyone who has ever learned about function fields will know about it; pardon my ignorance here)?\n\nIn `_pth_root`, I would avoid the import `from .element import FunctionFieldElement_rational` as this can really slow things down more than you expect (in my experience). If you need to put it in the method because of circular imports, then I would instead make it a `lazy_import`.\n\nThis seems like the better (i.e., faster) way to do it instead of dividing by `x.derivative() in the lambda function:\n\n```\nxderinv = ~(x.derivative())\nderivative = lambda f: xderinv * f.derivative()\n```\n\nI am not sure this comparison `if prec < infinity:` for `prec=None` will always work on Python3. So I think you are better changing the order of the tests to be\n\n```python\nif prec is None or prec == infinity:\n    raise NotImplementedErorr\n# continue with init\n```\n\n---\n\nSome nitpicks:\n\n`R(0)` -> `R.zero()` (unless you expect `R` to be a Python type like `int`, but I don't see that happening here).\n\nMicro-optimization for when the basis is empty:\n\n```diff\n+        if not basis:\n+            return [],[]\n         d = len(basis)\n-\n-        if d == 0:\n-            return [],[]\n```\n\nThe one-line sentence for `completion()` is missing a period/full-stop.\n\n```diff\n-Return i-th derivative of f with respect to the separating element.\n+Return ``i``-th derivative of ``f`` with respect to the separating element.\n```\n\nI think doing `pth_root = self._pth_root` obfuscates the code at little bit. I doubt that one additional indirection matters that much for speed (but maybe I am wrong).\n\nA little more clarity on the message:\n\n```diff\n-raise NotImplementedError('not yet supported')\n+raise NotImplementedError('exact results not yet supported')\n```\n\nInstead of checking `while len(gaps) < g:`, you could instead decrement `g` when adding to `gaps` and test `while g:`. This should be faster.",
    "created_at": "2019-03-11T23:26:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424097",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:4" align="right">comment:4</div>

Some comments:

`FunctionFieldHigherDerivation.__init__` is missing a doctest (add a `TestSuite(foo).run()` here `;)`, if something is failing, add a `skip="_test_failed"` or `skip=["_test_failed", "_test_failure"]`).

Same for `FunctionFieldHigherDerivation_rational`.

I think you should include a definition of the Cartier operation (unless this is something anyone who has ever learned about function fields will know about it; pardon my ignorance here)?

In `_pth_root`, I would avoid the import `from .element import FunctionFieldElement_rational` as this can really slow things down more than you expect (in my experience). If you need to put it in the method because of circular imports, then I would instead make it a `lazy_import`.

This seems like the better (i.e., faster) way to do it instead of dividing by `x.derivative() in the lambda function:

```
xderinv = ~(x.derivative())
derivative = lambda f: xderinv * f.derivative()
```

I am not sure this comparison `if prec < infinity:` for `prec=None` will always work on Python3. So I think you are better changing the order of the tests to be

```python
if prec is None or prec == infinity:
    raise NotImplementedErorr
# continue with init
```

---

Some nitpicks:

`R(0)` -> `R.zero()` (unless you expect `R` to be a Python type like `int`, but I don't see that happening here).

Micro-optimization for when the basis is empty:

```diff
+        if not basis:
+            return [],[]
         d = len(basis)
-
-        if d == 0:
-            return [],[]
```

The one-line sentence for `completion()` is missing a period/full-stop.

```diff
-Return i-th derivative of f with respect to the separating element.
+Return ``i``-th derivative of ``f`` with respect to the separating element.
```

I think doing `pth_root = self._pth_root` obfuscates the code at little bit. I doubt that one additional indirection matters that much for speed (but maybe I am wrong).

A little more clarity on the message:

```diff
-raise NotImplementedError('not yet supported')
+raise NotImplementedError('exact results not yet supported')
```

Instead of checking `while len(gaps) < g:`, you could instead decrement `g` when adding to `gaps` and test `while g:`. This should be faster.



---

archive/issue_comments_424098.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nSo why the pickling isn't working is this:\n\n```\nsage: F.<x> = FunctionField(GF(2))\nsage: d = F.higher_derivation()\nsage: d.__reduce__()\n(<built-in function unpickle_map>,\n (<class 'sage.rings.function_field.maps.FunctionFieldHigherDerivation_rational'>,\n  Set of Homomorphisms from Rational function field in x over Finite Field of size 2 to Rational function field in x over Finite Field of size 2,\n  {'_field': Rational function field in x over Finite Field of size 2,\n   '_p': 2,\n   '_pth_root_in_finite_field': <function <lambda> at 0x7f01f807f230>,\n   '_separating_element': x},\n  {'_codomain': Rational function field in x over Finite Field of size 2,\n   '_domain': Rational function field in x over Finite Field of size 2,\n   '_is_coercion': False,\n   '_repr_type_str': None}))\n```\nThe lambda function cannot be pickled. This was indicated by trying to do\n\n```\nsage: dumps(d)\n...\nPicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed\n```\nSo the simple solution would be to remove `_pth_root_in_finite_field` and just inline the checks. I did that, but then the pickling still failed because equality was not implemented.\n\nThus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.",
    "created_at": "2019-03-13T02:13:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424098",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">comment:5</div>

So why the pickling isn't working is this:

```
sage: F.<x> = FunctionField(GF(2))
sage: d = F.higher_derivation()
sage: d.__reduce__()
(<built-in function unpickle_map>,
 (<class 'sage.rings.function_field.maps.FunctionFieldHigherDerivation_rational'>,
  Set of Homomorphisms from Rational function field in x over Finite Field of size 2 to Rational function field in x over Finite Field of size 2,
  {'_field': Rational function field in x over Finite Field of size 2,
   '_p': 2,
   '_pth_root_in_finite_field': <function <lambda> at 0x7f01f807f230>,
   '_separating_element': x},
  {'_codomain': Rational function field in x over Finite Field of size 2,
   '_domain': Rational function field in x over Finite Field of size 2,
   '_is_coercion': False,
   '_repr_type_str': None}))
```
The lambda function cannot be pickled. This was indicated by trying to do

```
sage: dumps(d)
...
PicklingError: Can't pickle <type 'function'>: attribute lookup __builtin__.function failed
```
So the simple solution would be to remove `_pth_root_in_finite_field` and just inline the checks. I did that, but then the pickling still failed because equality was not implemented.

Thus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.



---

archive/issue_comments_424099.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\n> So the simple solution would be to remove `_pth_root_in_finite_field` and just inline the checks. I did that, but then the pickling still failed because equality was not implemented.\n\nI already have done both. \n\n> Thus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.\n\nI also have tried this :-) But adding `UniqueRepresentation` also raises an exception complaining of multiple metaclasses...",
    "created_at": "2019-03-13T03:59:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424099",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:6" align="right">comment:6</div>

> So the simple solution would be to remove `_pth_root_in_finite_field` and just inline the checks. I did that, but then the pickling still failed because equality was not implemented.

I already have done both. 

> Thus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.

I also have tried this :-) But adding `UniqueRepresentation` also raises an exception complaining of multiple metaclasses...



---

archive/issue_comments_424100.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@kwankyu](#comment%3A6):\n> > Thus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.\n\n> \n> I also have tried this :-) But adding `UniqueRepresentation` also raises an exception complaining of multiple metaclasses...\n\nWhat you need to do is use is the metaclass that is a combination of the two being passed:\n\n```\nfrom six import with_metaclass\nfrom sage.structure.unique_representation import UniqueRepresentation\nfrom sage.misc.inherit_comparison import InheritComparisonClasscallMetaclass\nclass FunctionFieldDerivation(with_metaclass(InheritComparisonClasscallMetaclass, UniqueRepresentation, Map)):\n```\nWith the appropriate change, I get the pickling test to pass.",
    "created_at": "2019-03-13T06:01:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424100",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@kwankyu](#comment%3A6):
> > Thus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.

> 
> I also have tried this :-) But adding `UniqueRepresentation` also raises an exception complaining of multiple metaclasses...

What you need to do is use is the metaclass that is a combination of the two being passed:

```
from six import with_metaclass
from sage.structure.unique_representation import UniqueRepresentation
from sage.misc.inherit_comparison import InheritComparisonClasscallMetaclass
class FunctionFieldDerivation(with_metaclass(InheritComparisonClasscallMetaclass, UniqueRepresentation, Map)):
```
With the appropriate change, I get the pickling test to pass.



---

archive/issue_comments_424101.json:
```json
{
    "body": "Changed commit from **[`06d41fd`](https://github.com/sagemath/sagetrac-mirror/commit/06d41fd4eeba447383ecb4b7e5a1691737cab5b3)** to **[`6ece364`](https://github.com/sagemath/sagetrac-mirror/commit/6ece364586eaf8c95b026568745dae92d68e0a34)**",
    "created_at": "2019-03-13T08:09:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424101",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`06d41fd`](https://github.com/sagemath/sagetrac-mirror/commit/06d41fd4eeba447383ecb4b7e5a1691737cab5b3)** to **[`6ece364`](https://github.com/sagemath/sagetrac-mirror/commit/6ece364586eaf8c95b026568745dae92d68e0a34)**



---

archive/issue_comments_424102.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6ece364586eaf8c95b026568745dae92d68e0a34\"><code>6ece364</code></a></td><td><code>Fixes to respond to reviewer comments</code></td></tr></table>\n",
    "created_at": "2019-03-13T08:09:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424102",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6ece364586eaf8c95b026568745dae92d68e0a34"><code>6ece364</code></a></td><td><code>Fixes to respond to reviewer comments</code></td></tr></table>




---

archive/issue_comments_424103.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\n> `FunctionFieldHigherDerivation.__init__` is missing a doctest (add a `TestSuite(foo).run()` here `;)`, if something is failing, add a `skip=\"_test_failed\"` or `skip=[\"_test_failed\", \"_test_failure\"]`).\n> \n> Same for `FunctionFieldHigherDerivation_rational`.\n\nDone, but I made some changes as efforts to pass the tests.\n \n> I think you should include a definition of the Cartier operation (unless this is something anyone who has ever learned about function fields will know about it)?\n\nDone. It seems not a standard material. \n> \n> In `_pth_root`, I would avoid the import `from .element import FunctionFieldElement_rational` as this can really slow things down more than you expect (in my experience). If you need to put it in the method because of circular imports, then I would instead make it a `lazy_import`.\n\nDone. I could use `.element_class`\n\n> This seems like the better (i.e., faster) way to do it instead of dividing by `x.derivative() in the lambda function:\n> \n> ```\n> xderinv = ~(x.derivative())\n> derivative = lambda f: xderinv * f.derivative()\n> ```\n\nDone. I forgot that I did it elsewhere.\n \n> I am not sure this comparison `if prec < infinity:` for `prec=None` will always work on Python3. So I think you are better changing the order of the tests to be\n> \n> ```python\n> if prec is None or prec == infinity:\n>     raise NotImplementedErorr\n> # continue with init\n> ```\n\nNote that `None < infinity` is `True`. If `prec` is `None`, a default precision is used. \n\nI plan to (but did not yet) support `prec=infinity` for infinite precision, once after #27347 (lazy laurent series) is merged.\n\n> `R(0)` -> `R.zero()` (unless you expect `R` to be a Python type like `int`, but I don't see that happening here).\n\nDone.\n \n> Micro-optimization for when the basis is empty:\n> \n> ```diff\n> +        if not basis:\n> +            return [],[]\n>          d = len(basis)\n> -\n> -        if d == 0:\n> -            return [],[]\n> ```\n\nDone.\n \n> The one-line sentence for `completion()` is missing a period/full-stop.\n\nFixed.\n\n> ```diff\n> -Return i-th derivative of f with respect to the separating element.\n> +Return ``i``-th derivative of ``f`` with respect to the separating element.\n> ```\n\nDone.\n\n> I think doing `pth_root = self._pth_root` obfuscates the code at little bit. I doubt that one additional indirection matters that much for speed (but maybe I am wrong).\n\nRight. I removed these evil optimizations.\n\n> A little more clarity on the message:\n> \n> ```diff\n> -raise NotImplementedError('not yet supported')\n> +raise NotImplementedError('exact results not yet supported')\n> ```\n\nDone. It is now `infinite precision is not yet supported`.\n\n> Instead of checking `while len(gaps) < g:`, you could instead decrement `g` when adding to `gaps` and test `while g:`. This should be faster.\n\nGood idea. Done.",
    "created_at": "2019-03-13T08:23:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424103",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:9" align="right">comment:9</div>

> `FunctionFieldHigherDerivation.__init__` is missing a doctest (add a `TestSuite(foo).run()` here `;)`, if something is failing, add a `skip="_test_failed"` or `skip=["_test_failed", "_test_failure"]`).
> 
> Same for `FunctionFieldHigherDerivation_rational`.

Done, but I made some changes as efforts to pass the tests.
 
> I think you should include a definition of the Cartier operation (unless this is something anyone who has ever learned about function fields will know about it)?

Done. It seems not a standard material. 
> 
> In `_pth_root`, I would avoid the import `from .element import FunctionFieldElement_rational` as this can really slow things down more than you expect (in my experience). If you need to put it in the method because of circular imports, then I would instead make it a `lazy_import`.

Done. I could use `.element_class`

> This seems like the better (i.e., faster) way to do it instead of dividing by `x.derivative() in the lambda function:
> 
> ```
> xderinv = ~(x.derivative())
> derivative = lambda f: xderinv * f.derivative()
> ```

Done. I forgot that I did it elsewhere.
 
> I am not sure this comparison `if prec < infinity:` for `prec=None` will always work on Python3. So I think you are better changing the order of the tests to be
> 
> ```python
> if prec is None or prec == infinity:
>     raise NotImplementedErorr
> # continue with init
> ```

Note that `None < infinity` is `True`. If `prec` is `None`, a default precision is used. 

I plan to (but did not yet) support `prec=infinity` for infinite precision, once after #27347 (lazy laurent series) is merged.

> `R(0)` -> `R.zero()` (unless you expect `R` to be a Python type like `int`, but I don't see that happening here).

Done.
 
> Micro-optimization for when the basis is empty:
> 
> ```diff
> +        if not basis:
> +            return [],[]
>          d = len(basis)
> -
> -        if d == 0:
> -            return [],[]
> ```

Done.
 
> The one-line sentence for `completion()` is missing a period/full-stop.

Fixed.

> ```diff
> -Return i-th derivative of f with respect to the separating element.
> +Return ``i``-th derivative of ``f`` with respect to the separating element.
> ```

Done.

> I think doing `pth_root = self._pth_root` obfuscates the code at little bit. I doubt that one additional indirection matters that much for speed (but maybe I am wrong).

Right. I removed these evil optimizations.

> A little more clarity on the message:
> 
> ```diff
> -raise NotImplementedError('not yet supported')
> +raise NotImplementedError('exact results not yet supported')
> ```

Done. It is now `infinite precision is not yet supported`.

> Instead of checking `while len(gaps) < g:`, you could instead decrement `g` when adding to `gaps` and test `while g:`. This should be faster.

Good idea. Done.



---

archive/issue_comments_424104.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@tscrim](#comment%3A7):\n> Replying to [@kwankyu](#comment%3A6):\n> > > Thus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.\n\n> > \n> > I also have tried this :-) But adding `UniqueRepresentation` also raises an exception complaining of multiple metaclasses...\n\n> \n> What you need to do is use is the metaclass that is a combination of the two being passed:\n> \n> ```\n> from six import with_metaclass\n> from sage.structure.unique_representation import UniqueRepresentation\n> from sage.misc.inherit_comparison import InheritComparisonClasscallMetaclass\n> class FunctionFieldDerivation(with_metaclass(InheritComparisonClasscallMetaclass, UniqueRepresentation, Map)):\n> ```\n> With the appropriate change, I get the pickling test to pass.\n\nUgh.. I prefer just to avoid the pickling test :-)",
    "created_at": "2019-03-13T08:26:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424104",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@tscrim](#comment%3A7):
> Replying to [@kwankyu](#comment%3A6):
> > > Thus, hat I would suggest doing is making these `Map` classes also inherit from `UniqueRepresentation`. I don't think this will introduce any reference cycles (i.e., a memory leak) considering your input parameter is just the `field`.

> > 
> > I also have tried this :-) But adding `UniqueRepresentation` also raises an exception complaining of multiple metaclasses...

> 
> What you need to do is use is the metaclass that is a combination of the two being passed:
> 
> ```
> from six import with_metaclass
> from sage.structure.unique_representation import UniqueRepresentation
> from sage.misc.inherit_comparison import InheritComparisonClasscallMetaclass
> class FunctionFieldDerivation(with_metaclass(InheritComparisonClasscallMetaclass, UniqueRepresentation, Map)):
> ```
> With the appropriate change, I get the pickling test to pass.

Ugh.. I prefer just to avoid the pickling test :-)



---

archive/issue_comments_424105.json:
```json
{
    "body": "Changed commit from **[`6ece364`](https://github.com/sagemath/sagetrac-mirror/commit/6ece364586eaf8c95b026568745dae92d68e0a34)** to **[`917149b`](https://github.com/sagemath/sagetrac-mirror/commit/917149bfa57a9d380b715439a3692b98a6cb0110)**",
    "created_at": "2019-03-13T09:38:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424105",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6ece364`](https://github.com/sagemath/sagetrac-mirror/commit/6ece364586eaf8c95b026568745dae92d68e0a34)** to **[`917149b`](https://github.com/sagemath/sagetrac-mirror/commit/917149bfa57a9d380b715439a3692b98a6cb0110)**



---

archive/issue_comments_424106.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/917149bfa57a9d380b715439a3692b98a6cb0110\"><code>917149b</code></a></td><td><code>Fix the broken lambda and pass _test_pickling</code></td></tr></table>\n",
    "created_at": "2019-03-13T09:38:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424106",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/917149bfa57a9d380b715439a3692b98a6cb0110"><code>917149b</code></a></td><td><code>Fix the broken lambda and pass _test_pickling</code></td></tr></table>




---

archive/issue_comments_424107.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nSomehow, I managed to pass the `_test_pickling`.",
    "created_at": "2019-03-13T09:39:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424107",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:12" align="right">comment:12</div>

Somehow, I managed to pass the `_test_pickling`.



---

archive/issue_comments_424108.json:
```json
{
    "body": "<div id=\"comment:13\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bc476cfbacf3aac139a0319633e20392de81989d\"><code>bc476cf</code></a></td><td><code>Prevent coverage degradation</code></td></tr></table>\n",
    "created_at": "2019-03-13T14:07:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424108",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:13"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bc476cfbacf3aac139a0319633e20392de81989d"><code>bc476cf</code></a></td><td><code>Prevent coverage degradation</code></td></tr></table>




---

archive/issue_comments_424109.json:
```json
{
    "body": "Changed commit from **[`917149b`](https://github.com/sagemath/sagetrac-mirror/commit/917149bfa57a9d380b715439a3692b98a6cb0110)** to **[`bc476cf`](https://github.com/sagemath/sagetrac-mirror/commit/bc476cfbacf3aac139a0319633e20392de81989d)**",
    "created_at": "2019-03-13T14:07:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424109",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`917149b`](https://github.com/sagemath/sagetrac-mirror/commit/917149bfa57a9d380b715439a3692b98a6cb0110)** to **[`bc476cf`](https://github.com/sagemath/sagetrac-mirror/commit/bc476cfbacf3aac139a0319633e20392de81989d)**



---

archive/issue_comments_424110.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dc4a852c44507de9e25fa36636eb548c9f1e91e8\"><code>dc4a852</code></a></td><td><code>A trivial fix in a doctest</code></td></tr></table>\n",
    "created_at": "2019-03-13T14:10:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424110",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dc4a852c44507de9e25fa36636eb548c9f1e91e8"><code>dc4a852</code></a></td><td><code>A trivial fix in a doctest</code></td></tr></table>




---

archive/issue_comments_424111.json:
```json
{
    "body": "Changed commit from **[`bc476cf`](https://github.com/sagemath/sagetrac-mirror/commit/bc476cfbacf3aac139a0319633e20392de81989d)** to **[`dc4a852`](https://github.com/sagemath/sagetrac-mirror/commit/dc4a852c44507de9e25fa36636eb548c9f1e91e8)**",
    "created_at": "2019-03-13T14:10:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424111",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`bc476cf`](https://github.com/sagemath/sagetrac-mirror/commit/bc476cfbacf3aac139a0319633e20392de81989d)** to **[`dc4a852`](https://github.com/sagemath/sagetrac-mirror/commit/dc4a852c44507de9e25fa36636eb548c9f1e91e8)**



---

archive/issue_comments_424112.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThank you for the fixes. I have made a few more (see below).\n\nReplying to [@kwankyu](#comment%3A9):\n> \n> > `FunctionFieldHigherDerivation.__init__` is missing a doctest (add a `TestSuite(foo).run()` here `;)`, if something is failing, add a `skip=\"_test_failed\"` or `skip=[\"_test_failed\", \"_test_failure\"]`).\n> > \n> > Same for `FunctionFieldHigherDerivation_rational`.\n\n> \n> Done, but I made some changes as efforts to pass the tests.\n\nThank you. I also got rid of some code duplication. Personally, I think what we should do is add a `pth_root` method to a prime field to get rid of this hack. Anyways, this will work for now as that should be on a separate ticket.\n\n> > This seems like the better (i.e., faster) way to do it instead of dividing by `x.derivative() in the lambda function:\n> > \n> > ```\n> > xderinv = ~(x.derivative())\n> > derivative = lambda f: xderinv * f.derivative()\n> > ```\n\n> \n> Done. I forgot that I did it elsewhere.\n\nI fixed one more of these.\n\n> > I am not sure this comparison `if prec < infinity:` for `prec=None` will always work on Python3. So I think you are better changing the order of the tests to be\n> > \n> > ```python\n> > if prec is None or prec == infinity:\n> >     raise NotImplementedErorr\n> > # continue with init\n> > ```\n\n> \n> Note that `None < infinity` is `True`. If `prec` is `None`, a default precision is used. \n\nAh, right. However, this is something that should be addressed because there is no guarantee that this will remain this way (or not raise an error). So I have changed it to be what should be equivalent code (as `None == infinity` should always return `False`).\n\nI also made a few other trivial tweaks for PEP8. If my changes are good, then you can set a positive review.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/985f44eef169da164cb572fb6014467f3b4a50f8\"><code>985f44e</code></a></td><td><code>One more xderinv added.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/79d6eef4adea276429541418661136a5c75734a0\"><code>79d6eef</code></a></td><td><code>Removing some code duplication for __pth_root (changed to _pth_root_func).</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a6affc4578e5f04212d60f5940a7f0437f1dc90e\"><code>a6affc4</code></a></td><td><code>Some last little tidbits for uniformity.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b\"><code>13ce935</code></a></td><td><code>Replacing None < infinity comparison with equivalent code.</code></td></tr></table>\n",
    "created_at": "2019-03-14T00:46:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424112",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

Thank you for the fixes. I have made a few more (see below).

Replying to [@kwankyu](#comment%3A9):
> 
> > `FunctionFieldHigherDerivation.__init__` is missing a doctest (add a `TestSuite(foo).run()` here `;)`, if something is failing, add a `skip="_test_failed"` or `skip=["_test_failed", "_test_failure"]`).
> > 
> > Same for `FunctionFieldHigherDerivation_rational`.

> 
> Done, but I made some changes as efforts to pass the tests.

Thank you. I also got rid of some code duplication. Personally, I think what we should do is add a `pth_root` method to a prime field to get rid of this hack. Anyways, this will work for now as that should be on a separate ticket.

> > This seems like the better (i.e., faster) way to do it instead of dividing by `x.derivative() in the lambda function:
> > 
> > ```
> > xderinv = ~(x.derivative())
> > derivative = lambda f: xderinv * f.derivative()
> > ```

> 
> Done. I forgot that I did it elsewhere.

I fixed one more of these.

> > I am not sure this comparison `if prec < infinity:` for `prec=None` will always work on Python3. So I think you are better changing the order of the tests to be
> > 
> > ```python
> > if prec is None or prec == infinity:
> >     raise NotImplementedErorr
> > # continue with init
> > ```

> 
> Note that `None < infinity` is `True`. If `prec` is `None`, a default precision is used. 

Ah, right. However, this is something that should be addressed because there is no guarantee that this will remain this way (or not raise an error). So I have changed it to be what should be equivalent code (as `None == infinity` should always return `False`).

I also made a few other trivial tweaks for PEP8. If my changes are good, then you can set a positive review.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/985f44eef169da164cb572fb6014467f3b4a50f8"><code>985f44e</code></a></td><td><code>One more xderinv added.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/79d6eef4adea276429541418661136a5c75734a0"><code>79d6eef</code></a></td><td><code>Removing some code duplication for __pth_root (changed to _pth_root_func).</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a6affc4578e5f04212d60f5940a7f0437f1dc90e"><code>a6affc4</code></a></td><td><code>Some last little tidbits for uniformity.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b"><code>13ce935</code></a></td><td><code>Replacing None < infinity comparison with equivalent code.</code></td></tr></table>




---

archive/issue_comments_424113.json:
```json
{
    "body": "Changed commit from **[`dc4a852`](https://github.com/sagemath/sagetrac-mirror/commit/dc4a852c44507de9e25fa36636eb548c9f1e91e8)** to **[`13ce935`](https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b)**",
    "created_at": "2019-03-14T00:46:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424113",
    "user": "https://github.com/tscrim"
}
```

Changed commit from **[`dc4a852`](https://github.com/sagemath/sagetrac-mirror/commit/dc4a852c44507de9e25fa36636eb548c9f1e91e8)** to **[`13ce935`](https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b)**



---

archive/issue_comments_424114.json:
```json
{
    "body": "Changed branch from **[u/klee/27418](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/27418)** to **[u/tscrim/function_fields_completions-27418](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/function_fields_completions-27418)**",
    "created_at": "2019-03-14T00:46:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424114",
    "user": "https://github.com/tscrim"
}
```

Changed branch from **[u/klee/27418](https://github.com/sagemath/sagetrac-mirror/tree/u/klee/27418)** to **[u/tscrim/function_fields_completions-27418](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/function_fields_completions-27418)**



---

archive/issue_comments_424115.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2019-03-14T00:46:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424115",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_events_373620.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2019-03-14T05:03:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373620"
}
```



---

archive/issue_events_373621.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2019-03-14T05:03:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373621"
}
```



---

archive/issue_comments_424116.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nVery nice! Thank you :-)",
    "created_at": "2019-03-14T05:03:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424116",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:16" align="right">comment:16</div>

Very nice! Thank you :-)



---

archive/issue_comments_424117.json:
```json
{
    "body": "Changed branch from **[u/tscrim/function_fields_completions-27418](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/function_fields_completions-27418)** to **[`13ce935`](https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b)**",
    "created_at": "2019-03-15T08:09:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27418#issuecomment-424117",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/tscrim/function_fields_completions-27418](https://github.com/sagemath/sagetrac-mirror/tree/u/tscrim/function_fields_completions-27418)** to **[`13ce935`](https://github.com/sagemath/sagetrac-mirror/commit/13ce9355e549247c17a0ed83cc1be0df08545d7b)**



---

archive/issue_events_373622.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-15T08:09:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373622"
}
```



---

archive/issue_events_373623.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d0b17b1c6f6e7f757756fa52459edc988aaa3034",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-03-15T08:09:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27418",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27418#event-373623"
}
```
