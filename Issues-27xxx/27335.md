# Issue 27335: Out-of-bounds memory access in PARI isprime() function

archive/issues_027098.json:
```json
{
    "assignees": [],
    "body": "This was originally reported in #27267, but determined to be a distinct issue from another crash reported on that ticket.\n\nThis is easily reproduced on Cygwin:\n\n```\nsage: (2^127 - 1).is_prime()\n\n*** SIG 11 *** inside sig_on\ndo_raise_exception(sig=11)\nPyErr_Occurred() = 0x0\nRaising Python exception 0 ms after signal...\n---------------------------------------------------------------------------\nSignalError                               Traceback (most recent call last)\n<ipython-input-1-714806c14b73> in <module>()\n----> 1 (Integer(2)**Integer(127) - Integer(1)).is_prime()\n\n/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32034)()\n   5141             proof = get_flag(proof, \"arithmetic\")\n   5142         if proof:\n-> 5143             return self.__pari__().isprime()\n   5144         else:\n   5145             return self.__pari__().ispseudoprime()\n\ncypari2/gen.pyx in cypari2.gen.Gen.isprime()\n\nSignalError: Segmentation fault\n```\n\nThe C stack trace in the case of these crashes looks like:\n\n```\nProgram received signal SIGSEGV, Segmentation fault.\n0x00000003b598daf4 in red_montgomery ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n(gdb) where\n#0  0x00000003b598daf4 in red_montgomery ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#1  0x00000003b5bd482f in gen_pow_i ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#2  0x00000003b5b58d1e in Fp_pow ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#3  0x00000003b5e77644 in pl831 ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#5  0x00000003b5e7acb2 in isprime ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#6  0x00000003b5d0d4cf in map_proto_lG ()\n   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll\n#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime\n    ()\n   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()\n   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll\n```\n\nIt can also be reproduced on Linux, but only after forcing some unaccessible memory:\n\n```\n>>> import os, mmap; from cypari2 import Pari; pari = Pari()\n>>> z = open(\"/dev/zero\"); m = mmap.mmap(z.fileno(), 2**30, prot=0)\n>>> pari.allocatemem(2**32)\nPARI stack size set to 4294967296 bytes, maximum size set to 4294967296\n>>> pari(2**127 - 1).isprime()\nsys:1: RuntimeWarning: cypari2 leaked 5704 bytes on the PARI stack\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"cypari2/gen.pyx\", line 2077, in cypari2.gen.Gen.isprime\ncysignals.signals.SignalError: Segmentation fault\n```\n\nCC:  @jdemeyer\n\nBranch/Commit: **[`6e680ff`](https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b)**\n\nUpstream: **Fixed upstream, but not in a stable release.**\n\nReviewer: **Erik Bray**\n\nAuthor: **Jeroen Demeyer**\n\nComponent: **interfaces**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27335_\n\n",
    "closed_at": "2019-02-28T17:54:09Z",
    "created_at": "2019-02-21T11:37:30Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Out-of-bounds memory access in PARI isprime() function",
    "type": "issue",
    "updated_at": "2019-02-28T17:54:09Z",
    "url": "https://github.com/sagemath/sage/issues/27335",
    "user": "https://github.com/embray"
}
```
This was originally reported in #27267, but determined to be a distinct issue from another crash reported on that ticket.

This is easily reproduced on Cygwin:

```
sage: (2^127 - 1).is_prime()

*** SIG 11 *** inside sig_on
do_raise_exception(sig=11)
PyErr_Occurred() = 0x0
Raising Python exception 0 ms after signal...
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-1-714806c14b73> in <module>()
----> 1 (Integer(2)**Integer(127) - Integer(1)).is_prime()

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.is_prime (build/cythonized/sage/rings/integer.c:32034)()
   5141             proof = get_flag(proof, "arithmetic")
   5142         if proof:
-> 5143             return self.__pari__().isprime()
   5144         else:
   5145             return self.__pari__().ispseudoprime()

cypari2/gen.pyx in cypari2.gen.Gen.isprime()

SignalError: Segmentation fault
```

The C stack trace in the case of these crashes looks like:

```
Program received signal SIGSEGV, Segmentation fault.
0x00000003b598daf4 in red_montgomery ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
(gdb) where
#0  0x00000003b598daf4 in red_montgomery ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#1  0x00000003b5bd482f in gen_pow_i ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#2  0x00000003b5b58d1e in Fp_pow ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#3  0x00000003b5e77644 in pl831 ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#5  0x00000003b5e7acb2 in isprime ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#6  0x00000003b5d0d4cf in map_proto_lG ()
   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll
#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime
    ()
   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()
   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll
```

It can also be reproduced on Linux, but only after forcing some unaccessible memory:

```
>>> import os, mmap; from cypari2 import Pari; pari = Pari()
>>> z = open("/dev/zero"); m = mmap.mmap(z.fileno(), 2**30, prot=0)
>>> pari.allocatemem(2**32)
PARI stack size set to 4294967296 bytes, maximum size set to 4294967296
>>> pari(2**127 - 1).isprime()
sys:1: RuntimeWarning: cypari2 leaked 5704 bytes on the PARI stack
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "cypari2/gen.pyx", line 2077, in cypari2.gen.Gen.isprime
cysignals.signals.SignalError: Segmentation fault
```

CC:  @jdemeyer

Branch/Commit: **[`6e680ff`](https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b)**

Upstream: **Fixed upstream, but not in a stable release.**

Reviewer: **Erik Bray**

Author: **Jeroen Demeyer**

Component: **interfaces**

_Issue created by migration from https://trac.sagemath.org/ticket/27335_





---

archive/issue_events_375552.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-21T11:37:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375552"
}
```



---

archive/issue_events_375553.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-21T11:37:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375553"
}
```



---

archive/issue_events_375554.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-21T11:37:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375554"
}
```



---

archive/issue_events_375555.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-21T11:37:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375555"
}
```



---

archive/issue_comments_422719.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nPlease also check `pari.isprime(2^127 - 1)`.",
    "created_at": "2019-02-21T11:40:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422719",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:1" align="right">comment:1</div>

Please also check `pari.isprime(2^127 - 1)`.



---

archive/issue_comments_422720.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nWhat happens in pure Python (the Python in Sage):\n\n```\n>>> from cypari2 import Pari; pari = Pari(); pari(\"2^127 - 1\").isprime()\nTrue\n```",
    "created_at": "2019-02-21T12:07:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422720",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:2" align="right">comment:2</div>

What happens in pure Python (the Python in Sage):

```
>>> from cypari2 import Pari; pari = Pari(); pari("2^127 - 1").isprime()
True
```



---

archive/issue_comments_422721.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI meant to add: It's the same problem.  The bug is somewhere in pari or cypari2, not Sage itself.  So you meant want to open an issue over there too.",
    "created_at": "2019-02-21T13:12:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422721",
    "user": "https://github.com/embray"
}
```

<div id="comment:3" align="right">comment:3</div>

I meant to add: It's the same problem.  The bug is somewhere in pari or cypari2, not Sage itself.  So you meant want to open an issue over there too.



---

archive/issue_comments_422722.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nWhen I do that I also see a `RuntimeWarning` that for some reason is being squelched in the normal sage repl?\n\n```\n>>> from cypari2 import Pari; pari = Pari(); pari(\"2^127 - 1\").isprime()\n\n*** SIG 11 *** inside sig_on\ndo_raise_exception(sig=11)\nPyErr_Occurred() = 0x0\nRaising Python exception 0 ms after signal...\nsys:1: RuntimeWarning: cypari2 leaked 5704 bytes on the PARI stack\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"cypari2/gen.pyx\", line 2078, in cypari2.gen.Gen.isprime\ncysignals.signals.SignalError: Segmentation fault\n```",
    "created_at": "2019-02-21T13:13:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422722",
    "user": "https://github.com/embray"
}
```

<div id="comment:4" align="right">comment:4</div>

When I do that I also see a `RuntimeWarning` that for some reason is being squelched in the normal sage repl?

```
>>> from cypari2 import Pari; pari = Pari(); pari("2^127 - 1").isprime()

*** SIG 11 *** inside sig_on
do_raise_exception(sig=11)
PyErr_Occurred() = 0x0
Raising Python exception 0 ms after signal...
sys:1: RuntimeWarning: cypari2 leaked 5704 bytes on the PARI stack
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "cypari2/gen.pyx", line 2078, in cypari2.gen.Gen.isprime
cysignals.signals.SignalError: Segmentation fault
```



---

archive/issue_comments_422723.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI wouldn't worry too much about that `RuntimeWarning` (which clearly happens after the segmentation fault, so it can't be the cause).",
    "created_at": "2019-02-21T13:28:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422723",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

I wouldn't worry too much about that `RuntimeWarning` (which clearly happens after the segmentation fault, so it can't be the cause).



---

archive/issue_comments_422724.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nDon't forget to check `pari.isprime(2^127 - 1)`.",
    "created_at": "2019-02-21T13:33:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422724",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Don't forget to check `pari.isprime(2^127 - 1)`.



---

archive/issue_comments_422725.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI think it should be fairly obvious at this point that it's the same (though `s/^/**/` in plain Python).",
    "created_at": "2019-02-21T13:42:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422725",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

I think it should be fairly obvious at this point that it's the same (though `s/^/**/` in plain Python).



---

archive/issue_comments_422726.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -78,6 +78,10 @@\n sage: pari(\"2^127 - 1\").isprime()\n ```\n \n+```\n+pari.isprime(2^127 - 1)\n+```\n+\n But *not* as a pure gp expression like:\n \n ```\n``````\n",
    "created_at": "2019-02-21T13:45:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422726",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -78,6 +78,10 @@
 sage: pari("2^127 - 1").isprime()
 ```
 
+```
+pari.isprime(2^127 - 1)
+```
+
 But *not* as a pure gp expression like:
 
 ```
``````




---

archive/issue_comments_422727.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -79,7 +79,7 @@\n ```\n \n ```\n-pari.isprime(2^127 - 1)\n+sage: pari.isprime(2^127 - 1)\n ```\n \n But *not* as a pure gp expression like:\n``````\n",
    "created_at": "2019-02-21T13:45:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422727",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -79,7 +79,7 @@
 ```
 
 ```
-pari.isprime(2^127 - 1)
+sage: pari.isprime(2^127 - 1)
 ```
 
 But *not* as a pure gp expression like:
``````




---

archive/issue_comments_422728.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@embray](#comment:7):\n> I think it should be fairly obvious at this point that it's the same (though `s/^/**/` in plain Python).\n\nIt's not obvious at all to me... but it's good to know that this also crashes.",
    "created_at": "2019-02-21T13:46:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422728",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@embray](#comment:7):
> I think it should be fairly obvious at this point that it's the same (though `s/^/**/` in plain Python).

It's not obvious at all to me... but it's good to know that this also crashes.



---

archive/issue_comments_422729.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -89,4 +89,4 @@\n 1\n ```\n \n-In other words, it occurs explicitly when one goes through `Gen.isprime`.  Incidentally, after calling `pari(\"isprime(2^127 - 1)\")`, all the other examples begin to work.  Presumably this is because the result is cached somewhere in PARI resulting in going down a different code path that does not crash.\n+In other words, it occurs explicitly when one goes through `Gen.isprime` or `PariInstance.isprime`.  Incidentally, after calling `pari(\"isprime(2^127 - 1)\")`, all the other examples begin to work.  Presumably this is because the result is cached somewhere in PARI resulting in going down a different code path that does not crash.\n``````\n",
    "created_at": "2019-02-21T13:52:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422729",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -89,4 +89,4 @@
 1
 ```
 
-In other words, it occurs explicitly when one goes through `Gen.isprime`.  Incidentally, after calling `pari("isprime(2^127 - 1)")`, all the other examples begin to work.  Presumably this is because the result is cached somewhere in PARI resulting in going down a different code path that does not crash.
+In other words, it occurs explicitly when one goes through `Gen.isprime` or `PariInstance.isprime`.  Incidentally, after calling `pari("isprime(2^127 - 1)")`, all the other examples begin to work.  Presumably this is because the result is cached somewhere in PARI resulting in going down a different code path that does not crash.
``````




---

archive/issue_comments_422730.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI really have no clue what could be the problem here. There shouldn't be anything special about wrapping the `isprime()` function.",
    "created_at": "2019-02-21T13:58:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422730",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

I really have no clue what could be the problem here. There shouldn't be anything special about wrapping the `isprime()` function.



---

archive/issue_comments_422731.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI think either way it's creating a `GEN` from the integer (whether it's a Sage Integer or a Python int) and passing it to `gisprime`.\n\nI suspect the bug is somewhere in Pari, but is only invoked as a result of whatever weird manipulations the wrapper is doing to Pari's stack.  Some assumption that is made somewhere that does not hold up in that context.  I'm not sure what though.  I'll be able to investigate more once I'm done testing against #27267",
    "created_at": "2019-02-21T14:02:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422731",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

I think either way it's creating a `GEN` from the integer (whether it's a Sage Integer or a Python int) and passing it to `gisprime`.

I suspect the bug is somewhere in Pari, but is only invoked as a result of whatever weird manipulations the wrapper is doing to Pari's stack.  Some assumption that is made somewhere that does not hold up in that context.  I'm not sure what though.  I'll be able to investigate more once I'm done testing against #27267



---

archive/issue_comments_422732.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nSince the fault is in libpari-gmp.dll, it's possible GMP/MPIR is also suspect.  I'll see if I can invoke the same bug without GMP support.",
    "created_at": "2019-02-21T14:03:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422732",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

Since the fault is in libpari-gmp.dll, it's possible GMP/MPIR is also suspect.  I'll see if I can invoke the same bug without GMP support.



---

archive/issue_comments_422733.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nMaybe it's accessing memory beyond the PARI stack. You mention that after things work correctly after `pari(\"isprime(2^127 - 1)\")`. But maybe things work correctly after any PARI computation?\n\nSo please try:\n\n```\na = pari(3)\nb = pari(2^127 - 1).isprime()\n```",
    "created_at": "2019-02-21T14:10:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422733",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Maybe it's accessing memory beyond the PARI stack. You mention that after things work correctly after `pari("isprime(2^127 - 1)")`. But maybe things work correctly after any PARI computation?

So please try:

```
a = pari(3)
b = pari(2^127 - 1).isprime()
```



---

archive/issue_comments_422734.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nGood call--that seems to work.  I had guessed (and it was just a guess) that it was caching some results related to the isprime computation, but that probably isn't it.",
    "created_at": "2019-02-21T14:19:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422734",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

Good call--that seems to work.  I had guessed (and it was just a guess) that it was caching some results related to the isprime computation, but that probably isn't it.



---

archive/issue_comments_422735.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nIs there any chance to get from GDB the precise point where the segfault is raised?",
    "created_at": "2019-02-21T14:22:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422735",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Is there any chance to get from GDB the precise point where the segfault is raised?



---

archive/issue_comments_422736.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThe `red_montgomery` function does do some suspicious looking manipulations with `avma` that I'll be able to debug more carefully soon.  To summarize some relevant bits:\n\n```\nred_montgomery(GEN T, GEN N, ulong inv)\n{\n  pari_sp av;\n  ...\n  av = avma; scratch = new_chunk(k<<1); /* >= k + 2: result fits */\n  ...\n  /// The next line that uses av looks like: ///\n  Td = (GEN)av - 1; /* *Td = high word of final result */\n  /// segfault here, maybe??? ///\n  while (*Td == 0 && Te < Td) Td--; /* strip leading 0s */\n  ...\n}\n```",
    "created_at": "2019-02-21T14:28:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422736",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">comment:18</div>

The `red_montgomery` function does do some suspicious looking manipulations with `avma` that I'll be able to debug more carefully soon.  To summarize some relevant bits:

```
red_montgomery(GEN T, GEN N, ulong inv)
{
  pari_sp av;
  ...
  av = avma; scratch = new_chunk(k<<1); /* >= k + 2: result fits */
  ...
  /// The next line that uses av looks like: ///
  Td = (GEN)av - 1; /* *Td = high word of final result */
  /// segfault here, maybe??? ///
  while (*Td == 0 && Te < Td) Td--; /* strip leading 0s */
  ...
}
```



---

archive/issue_comments_422737.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jdemeyer](#comment:17):\n> Is there any chance to get from GDB the precise point where the segfault is raised?\n\nYes, obviously that would be better than just speculating.  I'm waiting for this test run to finish so I can do a debug build of PARI for easier debugging.  Though I suppose I could go ahead and try it now and see how easily I can decipher the assembly.",
    "created_at": "2019-02-21T14:30:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422737",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jdemeyer](#comment:17):
> Is there any chance to get from GDB the precise point where the segfault is raised?

Yes, obviously that would be better than just speculating.  I'm waiting for this test run to finish so I can do a debug build of PARI for easier debugging.  Though I suppose I could go ahead and try it now and see how easily I can decipher the assembly.



---

archive/issue_comments_422738.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@embray](#comment:19):\n> decipher the assembly.\n\nAlways fun!",
    "created_at": "2019-02-21T14:34:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422738",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@embray](#comment:19):
> decipher the assembly.

Always fun!



---

archive/issue_comments_422739.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOn Linux, I'm trying to add some assertions inside the `red_montgomery` function to check for potential problems but everything is OK so far.",
    "created_at": "2019-02-21T14:35:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422739",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

On Linux, I'm trying to add some assertions inside the `red_montgomery` function to check for potential problems but everything is OK so far.



---

archive/issue_comments_422740.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI noticed that it gets called many times in a loop, and each time `avma` goes down a little bit, as though there's (maybe?) a memory leak on the PARI stack.  So you might be right that I'm just hitting the bottom of the stack.  Wouldn't this normally be protected against?\n\nI have no idea what this algorithm is either so I can't speak too intelligently about what it should or shouldn't be doing.",
    "created_at": "2019-02-21T14:48:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422740",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

I noticed that it gets called many times in a loop, and each time `avma` goes down a little bit, as though there's (maybe?) a memory leak on the PARI stack.  So you might be right that I'm just hitting the bottom of the stack.  Wouldn't this normally be protected against?

I have no idea what this algorithm is either so I can't speak too intelligently about what it should or shouldn't be doing.



---

archive/issue_comments_422741.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@embray](#comment:22):\n> I noticed that it gets called many times in a loop, and each time `avma` goes down a little bit, as though there's (maybe?) a memory leak on the PARI stack.\n\nWhat you describe is completely normal and just normal usage of the stack by `cypari2`. If you run it even more times in a loop, you should see that the stack is actually cleared completely at regular times.",
    "created_at": "2019-02-21T14:51:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422741",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@embray](#comment:22):
> I noticed that it gets called many times in a loop, and each time `avma` goes down a little bit, as though there's (maybe?) a memory leak on the PARI stack.

What you describe is completely normal and just normal usage of the stack by `cypari2`. If you run it even more times in a loop, you should see that the stack is actually cleared completely at regular times.



---

archive/issue_comments_422742.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@embray](#comment:22):\n> So you might be right that I'm just hitting the bottom of the stack.\n\nI actually meant hitting the *top* of the stack. With cypari2, when doing `pari.isprime(2^127 - 1)` right after startup, the number `2^127 - 1` is literally the very first thing on the stack. When evaluating the GP expression `isprime(2^127 - 1)`, this is not true since computing `2^127 - 1` also needs a bit of stack. Also when first computing `pari(3)` (or whatever), the number `2^127 - 1` is no longer the first thing on the stack. So we have a 100% correlation between the number being the first thing on the stack and the crash.\n\nBut we don't know yet why things are different on Cygwin. This is crashing in pure C code, where the OS shouldn't matter.",
    "created_at": "2019-02-21T14:58:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422742",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@embray](#comment:22):
> So you might be right that I'm just hitting the bottom of the stack.

I actually meant hitting the *top* of the stack. With cypari2, when doing `pari.isprime(2^127 - 1)` right after startup, the number `2^127 - 1` is literally the very first thing on the stack. When evaluating the GP expression `isprime(2^127 - 1)`, this is not true since computing `2^127 - 1` also needs a bit of stack. Also when first computing `pari(3)` (or whatever), the number `2^127 - 1` is no longer the first thing on the stack. So we have a 100% correlation between the number being the first thing on the stack and the crash.

But we don't know yet why things are different on Cygwin. This is crashing in pure C code, where the OS shouldn't matter.



---

archive/issue_comments_422743.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI see, thank you for your analysis.  That does make sense given the overall behavior we're seeing (where it doesn't crash if I do something else first).\n\nAs for why things are different, it may very well be that the bug exists on Linux too, but just happens to be accessing memory that is allocated to the process for some other purpose, or perhaps that's within some page alignment?  I'm not sure.  It will help once I can find the exact line it's crashing on.",
    "created_at": "2019-02-21T15:02:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422743",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">comment:25</div>

I see, thank you for your analysis.  That does make sense given the overall behavior we're seeing (where it doesn't crash if I do something else first).

As for why things are different, it may very well be that the bug exists on Linux too, but just happens to be accessing memory that is allocated to the process for some other purpose, or perhaps that's within some page alignment?  I'm not sure.  It will help once I can find the exact line it's crashing on.



---

archive/issue_comments_422744.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nFWIW I built a PARI/gp and cypari2 outside of sage and was able to reproduce the problem with that as well, with my normal system Python.  I have to go home for now so I probably can't look at it any more today, but I think I'll be able to have a closer look in gdb tomorrow.",
    "created_at": "2019-02-21T15:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422744",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

FWIW I built a PARI/gp and cypari2 outside of sage and was able to reproduce the problem with that as well, with my normal system Python.  I have to go home for now so I probably can't look at it any more today, but I think I'll be able to have a closer look in gdb tomorrow.



---

archive/issue_comments_422745.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2019-02-21T18:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422745",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_comments_422746.json:
```json
{
    "body": "Commit: **[`7b8044b`](https://github.com/sagemath/sagetrac-mirror/commit/7b8044b45f63cf8fccda4bc6f72d437fa6c24b61)**",
    "created_at": "2019-02-21T18:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422746",
    "user": "https://github.com/embray"
}
```

Commit: **[`7b8044b`](https://github.com/sagemath/sagetrac-mirror/commit/7b8044b45f63cf8fccda4bc6f72d437fa6c24b61)**



---

archive/issue_comments_422747.json:
```json
{
    "body": "Branch: **[u/embray/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-27335)**",
    "created_at": "2019-02-21T18:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422747",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-27335)**



---

archive/issue_events_375556.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-21T18:44:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375556"
}
```



---

archive/issue_comments_422748.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@embray](#comment:25):\n> or perhaps that's within some page alignment?\n\nI think I was on to something with this conjecture.\n\n```\nOn Cygwin sysconf(_SC_PAGE_SIZE) cannot be relied on to accurately\npage-align the top of the PARI stack, because it does not actually give\nthe correct physical page size (this is intentional, as a compromise\nwith POSIX requirements that are incompatible with most Windows\nversions; see\nhttps://www.cygwin.com/ml/cygwin-patches/2016-q4/msg00002.html)\n\nNormally, the value returned by sysconf(_SC_PAGE_SIZE) is actually\nlarger than the physical page size, which can result in placing the\ntop of the pari_mainstack a little past the real end of the allocated\nmemory region.\n\nAs it happens, the mem_unit member returned by sysinfo() does, however,\ngive the correct page size on Cygwin.\n```\n\nI want to run a full build/test of Sage with this patch, but at least in isolation it appears to do the trick.\n\nWhat I still don't fully understand is why I never saw this bug before cypari2.  Is it possible that it just plays closer to the top of the stack when doing operations in a freshly initialized `Pari`?\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b8044b45f63cf8fccda4bc6f72d437fa6c24b61\"><code>7b8044b</code></a></td><td><code>Trac #27335: Patch PARI to align the top of the pari_mainstack using the</code></td></tr></table>\n",
    "created_at": "2019-02-21T18:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422748",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@embray](#comment:25):
> or perhaps that's within some page alignment?

I think I was on to something with this conjecture.

```
On Cygwin sysconf(_SC_PAGE_SIZE) cannot be relied on to accurately
page-align the top of the PARI stack, because it does not actually give
the correct physical page size (this is intentional, as a compromise
with POSIX requirements that are incompatible with most Windows
versions; see
https://www.cygwin.com/ml/cygwin-patches/2016-q4/msg00002.html)

Normally, the value returned by sysconf(_SC_PAGE_SIZE) is actually
larger than the physical page size, which can result in placing the
top of the pari_mainstack a little past the real end of the allocated
memory region.

As it happens, the mem_unit member returned by sysinfo() does, however,
give the correct page size on Cygwin.
```

I want to run a full build/test of Sage with this patch, but at least in isolation it appears to do the trick.

What I still don't fully understand is why I never saw this bug before cypari2.  Is it possible that it just plays closer to the top of the stack when doing operations in a freshly initialized `Pari`?

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b8044b45f63cf8fccda4bc6f72d437fa6c24b61"><code>7b8044b</code></a></td><td><code>Trac #27335: Patch PARI to align the top of the pari_mainstack using the</code></td></tr></table>




---

archive/issue_comments_422749.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI don't think that this patch is related to the bug we're seeing here. In particular, I don't believe this:\n\n```\nwhich can result in placing the\ntop of the pari_mainstack a little past the real end of the allocated\nmemory region.\n```\nIf this were true, then we would be hitting segmentation faults all the time, not just in this particular `isprime()` function.\n\nThe patch might just accidentally work around the bug by changing memory locations or something, but I don't see how it would fix anything.",
    "created_at": "2019-02-22T09:18:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422749",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

I don't think that this patch is related to the bug we're seeing here. In particular, I don't believe this:

```
which can result in placing the
top of the pari_mainstack a little past the real end of the allocated
memory region.
```
If this were true, then we would be hitting segmentation faults all the time, not just in this particular `isprime()` function.

The patch might just accidentally work around the bug by changing memory locations or something, but I don't see how it would fix anything.



---

archive/issue_comments_422750.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nNow that I knew better what to look for, I can reliably reproduce this on Linux too (see ticket description). The missing bit was forcing a `PROT_NONE` mmap region right after the PARI stack.",
    "created_at": "2019-02-22T09:49:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422750",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">comment:29</div>

Now that I knew better what to look for, I can reliably reproduce this on Linux too (see ticket description). The missing bit was forcing a `PROT_NONE` mmap region right after the PARI stack.



---

archive/issue_events_375557.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-22T09:49:12Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "title_is": "Out-of-bounds memory access in PARI isprime() function",
    "title_was": "Segmentation fault in Gen.isprime on Cygwin",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375557"
}
```



---

archive/issue_comments_422751.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n This was originally reported in #27267, but determined to be a distinct issue from another crash reported on that ticket.\n+\n+This is easily reproduced on Cygwin:\n \n ```\n sage: (2^127 - 1).is_prime()\n@@ -62,31 +64,17 @@\n    from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll\n ```\n \n-(I need to apply some debugging fixups in order to see what the function arguments look like).\n-\n-This can be reproduced with any one of:\n+It can also be reproduced on Linux, but only after forcing some unaccessible memory:\n \n ```\n-sage: (2^127 - 1).is_prime()\n+>>> import os, mmap; from cypari2 import Pari; pari = Pari()\n+>>> z = open(\"/dev/zero\"); m = mmap.mmap(z.fileno(), 2**30, prot=0)\n+>>> pari.allocatemem(2**32)\n+PARI stack size set to 4294967296 bytes, maximum size set to 4294967296\n+>>> pari(2**127 - 1).isprime()\n+sys:1: RuntimeWarning: cypari2 leaked 5704 bytes on the PARI stack\n+Traceback (most recent call last):\n+  File \"<stdin>\", line 1, in <module>\n+  File \"cypari2/gen.pyx\", line 2077, in cypari2.gen.Gen.isprime\n+cysignals.signals.SignalError: Segmentation fault\n ```\n-\n-```\n-sage: pari(2^127 - 1).isprime()\n-```\n-\n-```\n-sage: pari(\"2^127 - 1\").isprime()\n-```\n-\n-```\n-sage: pari.isprime(2^127 - 1)\n-```\n-\n-But *not* as a pure gp expression like:\n-\n-```\n-sage: pari(\"isprime(2^127 - 1)\")\n-1\n-```\n-\n-In other words, it occurs explicitly when one goes through `Gen.isprime` or `PariInstance.isprime`.  Incidentally, after calling `pari(\"isprime(2^127 - 1)\")`, all the other examples begin to work.  Presumably this is because the result is cached somewhere in PARI resulting in going down a different code path that does not crash.\n``````\n",
    "created_at": "2019-02-22T09:49:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422751",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 This was originally reported in #27267, but determined to be a distinct issue from another crash reported on that ticket.
+
+This is easily reproduced on Cygwin:
 
 ```
 sage: (2^127 - 1).is_prime()
@@ -62,31 +64,17 @@
    from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll
 ```
 
-(I need to apply some debugging fixups in order to see what the function arguments look like).
-
-This can be reproduced with any one of:
+It can also be reproduced on Linux, but only after forcing some unaccessible memory:
 
 ```
-sage: (2^127 - 1).is_prime()
+>>> import os, mmap; from cypari2 import Pari; pari = Pari()
+>>> z = open("/dev/zero"); m = mmap.mmap(z.fileno(), 2**30, prot=0)
+>>> pari.allocatemem(2**32)
+PARI stack size set to 4294967296 bytes, maximum size set to 4294967296
+>>> pari(2**127 - 1).isprime()
+sys:1: RuntimeWarning: cypari2 leaked 5704 bytes on the PARI stack
+Traceback (most recent call last):
+  File "<stdin>", line 1, in <module>
+  File "cypari2/gen.pyx", line 2077, in cypari2.gen.Gen.isprime
+cysignals.signals.SignalError: Segmentation fault
 ```
-
-```
-sage: pari(2^127 - 1).isprime()
-```
-
-```
-sage: pari("2^127 - 1").isprime()
-```
-
-```
-sage: pari.isprime(2^127 - 1)
-```
-
-But *not* as a pure gp expression like:
-
-```
-sage: pari("isprime(2^127 - 1)")
-1
-```
-
-In other words, it occurs explicitly when one goes through `Gen.isprime` or `PariInstance.isprime`.  Incidentally, after calling `pari("isprime(2^127 - 1)")`, all the other examples begin to work.  Presumably this is because the result is cached somewhere in PARI resulting in going down a different code path that does not crash.
``````




---

archive/issue_comments_422752.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nHave to go now. After lunch, I'll try to get a good GDB trace of this.",
    "created_at": "2019-02-22T09:53:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422752",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Have to go now. After lunch, I'll try to get a good GDB trace of this.



---

archive/issue_comments_422753.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReported upstream: https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117",
    "created_at": "2019-02-22T11:16:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422753",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

Reported upstream: https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117



---

archive/issue_comments_422754.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2019-02-22T11:16:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422754",
    "user": "https://github.com/jdemeyer"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_422755.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -26,44 +26,6 @@\n SignalError: Segmentation fault\n ```\n \n-The C stack trace in the case of these crashes looks like:\n-\n-```\n-Program received signal SIGSEGV, Segmentation fault.\n-0x00000003b598daf4 in red_montgomery ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-(gdb) where\n-#0  0x00000003b598daf4 in red_montgomery ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-#1  0x00000003b5bd482f in gen_pow_i ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-#2  0x00000003b5b58d1e in Fp_pow ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-#3  0x00000003b5e77644 in pl831 ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-#5  0x00000003b5e7acb2 in isprime ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-#6  0x00000003b5d0d4cf in map_proto_lG ()\n-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n-#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()\n-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n-#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()\n-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n-#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()\n-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll\n-#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()\n-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n-#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()\n-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n-#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime\n-    ()\n-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n-#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()\n-   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll\n-```\n-\n It can also be reproduced on Linux, but only after forcing some unaccessible memory:\n \n ```\n@@ -78,3 +40,5 @@\n   File \"cypari2/gen.pyx\", line 2077, in cypari2.gen.Gen.isprime\n cysignals.signals.SignalError: Segmentation fault\n ```\n+\n+**Upstream bug**: https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117\n``````\n",
    "created_at": "2019-02-22T11:16:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422755",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -26,44 +26,6 @@
 SignalError: Segmentation fault
 ```
 
-The C stack trace in the case of these crashes looks like:
-
-```
-Program received signal SIGSEGV, Segmentation fault.
-0x00000003b598daf4 in red_montgomery ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-(gdb) where
-#0  0x00000003b598daf4 in red_montgomery ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-#1  0x00000003b5bd482f in gen_pow_i ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-#2  0x00000003b5b58d1e in Fp_pow ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-#3  0x00000003b5e77644 in pl831 ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-#5  0x00000003b5e7acb2 in isprime ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-#6  0x00000003b5d0d4cf in map_proto_lG ()
-   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
-#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()
-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
-#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()
-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
-#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()
-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll
-#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()
-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
-#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()
-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
-#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime
-    ()
-   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
-#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()
-   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll
-```
-
 It can also be reproduced on Linux, but only after forcing some unaccessible memory:
 
 ```
@@ -78,3 +40,5 @@
   File "cypari2/gen.pyx", line 2077, in cypari2.gen.Gen.isprime
 cysignals.signals.SignalError: Segmentation fault
 ```
+
+**Upstream bug**: https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117
``````




---

archive/issue_events_375558.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-22T11:16:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375558"
}
```



---

archive/issue_events_375559.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-22T11:16:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "000080",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375559"
}
```



---

archive/issue_comments_422756.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -26,6 +26,44 @@\n SignalError: Segmentation fault\n ```\n \n+The C stack trace in the case of these crashes looks like:\n+\n+```\n+Program received signal SIGSEGV, Segmentation fault.\n+0x00000003b598daf4 in red_montgomery ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+(gdb) where\n+#0  0x00000003b598daf4 in red_montgomery ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+#1  0x00000003b5bd482f in gen_pow_i ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+#2  0x00000003b5b58d1e in Fp_pow ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+#3  0x00000003b5e77644 in pl831 ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+#5  0x00000003b5e7acb2 in isprime ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+#6  0x00000003b5d0d4cf in map_proto_lG ()\n+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll\n+#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()\n+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n+#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()\n+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll\n+#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()\n+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll\n+#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()\n+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n+#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()\n+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n+#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime\n+    ()\n+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll\n+#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()\n+   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll\n+```\n+\n It can also be reproduced on Linux, but only after forcing some unaccessible memory:\n \n ```\n@@ -40,5 +78,3 @@\n   File \"cypari2/gen.pyx\", line 2077, in cypari2.gen.Gen.isprime\n cysignals.signals.SignalError: Segmentation fault\n ```\n-\n-**Upstream bug**: https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117\n``````\n",
    "created_at": "2019-02-22T11:25:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422756",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -26,6 +26,44 @@
 SignalError: Segmentation fault
 ```
 
+The C stack trace in the case of these crashes looks like:
+
+```
+Program received signal SIGSEGV, Segmentation fault.
+0x00000003b598daf4 in red_montgomery ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+(gdb) where
+#0  0x00000003b598daf4 in red_montgomery ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+#1  0x00000003b5bd482f in gen_pow_i ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+#2  0x00000003b5b58d1e in Fp_pow ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+#3  0x00000003b5e77644 in pl831 ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+#4  0x00000003b5e7a8f4 in BPSW_isprime.part.15 ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+#5  0x00000003b5e7acb2 in isprime ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+#6  0x00000003b5d0d4cf in map_proto_lG ()
+   from /home/embray/src/sagemath/sage/local/lib/libpari-gmp.dll
+#7  0x00000003b269a455 in __pyx_pf_7cypari2_3gen_3Gen_118isprime.isra.124 ()
+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
+#8  0x00000003b277765f in __pyx_pw_7cypari2_3gen_3Gen_119isprime ()
+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cypari2/gen.dll
+#9  0x000000039881394c in __Pyx_CyFunction_CallAsMethod ()
+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/persist.dll
+#10 0x0000000393e55486 in __Pyx__PyObject_CallOneArg ()
+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
+#11 0x0000000393e645c5 in __Pyx_PyObject_CallOneArg ()
+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
+#12 0x0000000393e6bccc in __pyx_pw_4sage_5rings_7integer_7Integer_203is_prime
+    ()
+   from /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/integer.dll
+#13 0x00000003c1548bfa in PyEval_EvalFrameEx ()
+   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll
+```
+
 It can also be reproduced on Linux, but only after forcing some unaccessible memory:
 
 ```
@@ -40,5 +78,3 @@
   File "cypari2/gen.pyx", line 2077, in cypari2.gen.Gen.isprime
 cysignals.signals.SignalError: Segmentation fault
 ```
-
-**Upstream bug**: https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117
``````




---

archive/issue_comments_422757.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nYep. FWIW the line it crashes on in `red_montgomery` is the last line of this block:\n\n```\n1008   if (carry)\n1009   { /* Td > N overflows (k+1 words), set Td := Td - N */\n1010     GEN NE = N + k+2;\n1011     Td = Te;\n1012     Nd = Ne;\n1013     t = subll(*++Td, *++Nd); *Td = t;\n1014     while (Nd < NE) { t = subllx(*++Td, *++Nd); *Td = t; }\n1015   }\n```\n\nIt crashes here after a few hundred calls to the function.  On the last call where it crashes `N` is top-most GEN on the stack, the value `(2^127 - 1)` itself, in this case, and it so happens then that `NE = N + k + 2` is the top of the stack.  So in the `while` loop the last `*++Nd` attempts to dereference the address at the top of the stack and this is where it segfaults.\n\nNow, this *should* work, and my patch fixes that.  I'm less certain exactly why though, and am beginning to suspect some bug/subtlety in Cygwin with page boundaries and mmap.  This is the test program that led me to my fix:\n\n```c\n#include <unistd.h>\n#include <sys/types.h>\n#include <sys/mman.h>\n#include <sys/resource.h>\n#include <stdio.h>\n#include <sys/errno.h>\n#include <string.h>\n#include <stdlib.h>\n\n\nsize_t PARI_STACK_ALIGN = 4096;\n#define SIZE 1000000\n\n\nstatic void mainstack_mreset(void*, void*);\n\n\nstatic size_t fix_size(size_t a)\n{\n    size_t ps = PARI_STACK_ALIGN;\n    size_t b = a & ~(ps - 1);\n    if (b < a && b < ~(ps - 1)) b += ps;\n    return b;\n}\n\n\nint main(int argc, char** argv) {\n    void *b;\n    size_t align;\n    size_t size;\n    if (argc == 2 && atoi(argv[1]) == 1) {\n        PARI_STACK_ALIGN = sysconf(_SC_PAGESIZE);\n    }\n\n    size = fix_size(SIZE);\n\n    b = mmap(NULL, size, PROT_READ|PROT_WRITE,\n             MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0);\n\n    printf(\"PARI_STACK_ALIGN = 0x%lx\\n\", PARI_STACK_ALIGN);\n    printf(\"size = 0x%lx\\n\", size);\n    printf(\"bot = 0x%lx\\n\", b);\n    printf(\"top = 0x%lx\\n\", b + size);\n    printf(\"*(char*)bot = 0x%lx\\n\", *(char*)(b));\n    printf(\"*(char*)(top - 1) = 0x%lx\\n\", *(char*)((b + size) - 1));\n    printf(\"*(char*)top = 0x%lx\\n\", *(char*)(b + size));\n    printf(\"*(int*)top = 0x%lx\\n\", *(int*)(b + size));\n    return 0;\n}\n```\n\nWhen run like `./test 0` it uses 4096 as the page size (which the actual value on Windows):\n\n```\n$ ./test.exe 0\nPARI_STACK_ALIGN = 0x1000\nsize = 0xf5000\nbot = 0x6fffff00000\ntop = 0x6ffffff5000\n*(char*)bot = 0x0\n*(char*)(top - 1) = 0x0\n*(char*)top = 0x0\n*(int*)top = 0x0\n```\n\nWhen run like `./test 1` it uses `sysconf(_SC_PAGE_SIZE)` (which is 64k):\n\n```\n$ ./test.exe 1\nPARI_STACK_ALIGN = 0x10000\nsize = 0x100000\nbot = 0x6fffff00000\ntop = 0x70000000000\n*(char*)bot = 0x0\n*(char*)(top - 1) = 0x0\nSegmentation fault (core dumped)\n```\n\nSomewhat to my surprise this also holds with or without `MAP_NORESERVE` so I don't think that's related, though it could have been.",
    "created_at": "2019-02-22T11:25:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422757",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

Yep. FWIW the line it crashes on in `red_montgomery` is the last line of this block:

```
1008   if (carry)
1009   { /* Td > N overflows (k+1 words), set Td := Td - N */
1010     GEN NE = N + k+2;
1011     Td = Te;
1012     Nd = Ne;
1013     t = subll(*++Td, *++Nd); *Td = t;
1014     while (Nd < NE) { t = subllx(*++Td, *++Nd); *Td = t; }
1015   }
```

It crashes here after a few hundred calls to the function.  On the last call where it crashes `N` is top-most GEN on the stack, the value `(2^127 - 1)` itself, in this case, and it so happens then that `NE = N + k + 2` is the top of the stack.  So in the `while` loop the last `*++Nd` attempts to dereference the address at the top of the stack and this is where it segfaults.

Now, this *should* work, and my patch fixes that.  I'm less certain exactly why though, and am beginning to suspect some bug/subtlety in Cygwin with page boundaries and mmap.  This is the test program that led me to my fix:

```c
#include <unistd.h>
#include <sys/types.h>
#include <sys/mman.h>
#include <sys/resource.h>
#include <stdio.h>
#include <sys/errno.h>
#include <string.h>
#include <stdlib.h>


size_t PARI_STACK_ALIGN = 4096;
#define SIZE 1000000


static void mainstack_mreset(void*, void*);


static size_t fix_size(size_t a)
{
    size_t ps = PARI_STACK_ALIGN;
    size_t b = a & ~(ps - 1);
    if (b < a && b < ~(ps - 1)) b += ps;
    return b;
}


int main(int argc, char** argv) {
    void *b;
    size_t align;
    size_t size;
    if (argc == 2 && atoi(argv[1]) == 1) {
        PARI_STACK_ALIGN = sysconf(_SC_PAGESIZE);
    }

    size = fix_size(SIZE);

    b = mmap(NULL, size, PROT_READ|PROT_WRITE,
             MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0);

    printf("PARI_STACK_ALIGN = 0x%lx\n", PARI_STACK_ALIGN);
    printf("size = 0x%lx\n", size);
    printf("bot = 0x%lx\n", b);
    printf("top = 0x%lx\n", b + size);
    printf("*(char*)bot = 0x%lx\n", *(char*)(b));
    printf("*(char*)(top - 1) = 0x%lx\n", *(char*)((b + size) - 1));
    printf("*(char*)top = 0x%lx\n", *(char*)(b + size));
    printf("*(int*)top = 0x%lx\n", *(int*)(b + size));
    return 0;
}
```

When run like `./test 0` it uses 4096 as the page size (which the actual value on Windows):

```
$ ./test.exe 0
PARI_STACK_ALIGN = 0x1000
size = 0xf5000
bot = 0x6fffff00000
top = 0x6ffffff5000
*(char*)bot = 0x0
*(char*)(top - 1) = 0x0
*(char*)top = 0x0
*(int*)top = 0x0
```

When run like `./test 1` it uses `sysconf(_SC_PAGE_SIZE)` (which is 64k):

```
$ ./test.exe 1
PARI_STACK_ALIGN = 0x10000
size = 0x100000
bot = 0x6fffff00000
top = 0x70000000000
*(char*)bot = 0x0
*(char*)(top - 1) = 0x0
Segmentation fault (core dumped)
```

Somewhat to my surprise this also holds with or without `MAP_NORESERVE` so I don't think that's related, though it could have been.



---

archive/issue_comments_422758.json:
```json
{
    "body": "Changed upstream from **Reported upstream. No feedback yet.** to none",
    "created_at": "2019-02-22T11:25:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422758",
    "user": "https://github.com/embray"
}
```

Changed upstream from **Reported upstream. No feedback yet.** to none



---

archive/issue_events_375560.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-22T11:25:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "000080",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375560"
}
```



---

archive/issue_events_375561.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-22T11:25:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375561"
}
```



---

archive/issue_comments_422759.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nOkay, I see you found the same issue in `red_montgomery`.  Actually I'm not sure if normally I *should* be able to dereference `(b + size)` or if I'm mentally making an off-by-one.  Need more coffee.",
    "created_at": "2019-02-22T11:28:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422759",
    "user": "https://github.com/embray"
}
```

<div id="comment:33" align="right">comment:33</div>

Okay, I see you found the same issue in `red_montgomery`.  Actually I'm not sure if normally I *should* be able to dereference `(b + size)` or if I'm mentally making an off-by-one.  Need more coffee.



---

archive/issue_comments_422760.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nYes, that's it. Internally, Cygwin's `mmap` uses the larger \"allocation granularity\" (64k) as the \"page size\" for mmap'd regions, since each `VirtualAlloc` has to be aligned to multiple of 64k anyways, so there's no point in making a mmap that is less than a multiple of 64k. So the behavior I was originally getting was actually correct, but when I used a 4k `PARI_STACK_ALIGN` it was putting the stack top below the end of a larger 64k range of memory, so that \"fixed\" the problem, sort of by chance, as you surmised. Similarly on Linux I guess it just happened that you had readable memory at that location unless you forcibly do a `MAP_FIXED` mmap there with `PROT_NONE` or something.",
    "created_at": "2019-02-22T11:51:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422760",
    "user": "https://github.com/embray"
}
```

<div id="comment:34" align="right">comment:34</div>

Yes, that's it. Internally, Cygwin's `mmap` uses the larger "allocation granularity" (64k) as the "page size" for mmap'd regions, since each `VirtualAlloc` has to be aligned to multiple of 64k anyways, so there's no point in making a mmap that is less than a multiple of 64k. So the behavior I was originally getting was actually correct, but when I used a 4k `PARI_STACK_ALIGN` it was putting the stack top below the end of a larger 64k range of memory, so that "fixed" the problem, sort of by chance, as you surmised. Similarly on Linux I guess it just happened that you had readable memory at that location unless you forcibly do a `MAP_FIXED` mmap there with `PROT_NONE` or something.



---

archive/issue_comments_422761.json:
```json
{
    "body": "Upstream: **Fixed upstream, but not in a stable release.**",
    "created_at": "2019-02-22T12:58:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422761",
    "user": "https://github.com/jdemeyer"
}
```

Upstream: **Fixed upstream, but not in a stable release.**



---

archive/issue_comments_422762.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nThis is actually already fixed in PARI master. I'll create a branch.",
    "created_at": "2019-02-22T12:58:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422762",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">comment:35</div>

This is actually already fixed in PARI master. I'll create a branch.



---

archive/issue_comments_422763.json:
```json
{
    "body": "Changed branch from **[u/embray/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-27335)** to **[u/jdemeyer/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket-27335)**",
    "created_at": "2019-02-22T13:00:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422763",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/embray/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-27335)** to **[u/jdemeyer/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket-27335)**



---

archive/issue_comments_422764.json:
```json
{
    "body": "Changed commit from **[`7b8044b`](https://github.com/sagemath/sagetrac-mirror/commit/7b8044b45f63cf8fccda4bc6f72d437fa6c24b61)** to **[`6e680ff`](https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b)**",
    "created_at": "2019-02-22T13:03:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422764",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[`7b8044b`](https://github.com/sagemath/sagetrac-mirror/commit/7b8044b45f63cf8fccda4bc6f72d437fa6c24b61)** to **[`6e680ff`](https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b)**



---

archive/issue_comments_422765.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@embray](#comment:34):\n> Yes, that's it. Internally, Cygwin's `mmap` uses the larger \"allocation granularity\" (64k) as the \"page size\" for mmap'd regions, since each `VirtualAlloc` has to be aligned to multiple of 64k anyways, so there's no point in making a mmap that is less than a multiple of 64k. So the behavior I was originally getting was actually correct, but when I used a 4k `PARI_STACK_ALIGN` it was putting the stack top below the end of a larger 64k range of memory, so that \"fixed\" the problem, sort of by chance, as you surmised.\n\nSo it seems to me that the \"allocation granularity\" is the right measure to use after all.\n\n> Similarly on Linux I guess it just happened that you had readable memory at that location\n\nIndeed.\n\n> unless you forcibly do a `MAP_FIXED` mmap there with `PROT_NONE` or something. \n\nWell, doing an `mmap` of `/dev/zero` with `PROT_NONE` was sufficient (this used to be in the ticket description before you accidentally reverted it)\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b\"><code>6e680ff</code></a></td><td><code>Fix https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117</code></td></tr></table>\n",
    "created_at": "2019-02-22T13:03:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422765",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@embray](#comment:34):
> Yes, that's it. Internally, Cygwin's `mmap` uses the larger "allocation granularity" (64k) as the "page size" for mmap'd regions, since each `VirtualAlloc` has to be aligned to multiple of 64k anyways, so there's no point in making a mmap that is less than a multiple of 64k. So the behavior I was originally getting was actually correct, but when I used a 4k `PARI_STACK_ALIGN` it was putting the stack top below the end of a larger 64k range of memory, so that "fixed" the problem, sort of by chance, as you surmised.

So it seems to me that the "allocation granularity" is the right measure to use after all.

> Similarly on Linux I guess it just happened that you had readable memory at that location

Indeed.

> unless you forcibly do a `MAP_FIXED` mmap there with `PROT_NONE` or something. 

Well, doing an `mmap` of `/dev/zero` with `PROT_NONE` was sufficient (this used to be in the ticket description before you accidentally reverted it)

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b"><code>6e680ff</code></a></td><td><code>Fix https://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=2117</code></td></tr></table>




---

archive/issue_comments_422766.json:
```json
{
    "body": "Changed author from **Erik Bray** to **Jeroen Demeyer**",
    "created_at": "2019-02-22T13:03:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422766",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Erik Bray** to **Jeroen Demeyer**



---

archive/issue_comments_422767.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@jdemeyer](#comment:37):\n> So it seems to me that the \"allocation granularity\" is the right measure to use after all.\n\nYes, apparently so.  Last time I was bitten by this it was because I wanted to make memory usage calculations given a page count, and in that case using it for the page size was actually wrong, but not in this case.\n\nIn this case it gave me behavior I *wanted* (accessing that memory address did not cause an access violation) but what I wanted was also wrong in the first place.\n\n> Well, doing an `mmap` of `/dev/zero` with `PROT_NONE` was sufficient (this used to be in the ticket description before you accidentally reverted it)\n\nOops, sorry.",
    "created_at": "2019-02-22T13:08:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422767",
    "user": "https://github.com/embray"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@jdemeyer](#comment:37):
> So it seems to me that the "allocation granularity" is the right measure to use after all.

Yes, apparently so.  Last time I was bitten by this it was because I wanted to make memory usage calculations given a page count, and in that case using it for the page size was actually wrong, but not in this case.

In this case it gave me behavior I *wanted* (accessing that memory address did not cause an access violation) but what I wanted was also wrong in the first place.

> Well, doing an `mmap` of `/dev/zero` with `PROT_NONE` was sufficient (this used to be in the ticket description before you accidentally reverted it)

Oops, sorry.



---

archive/issue_events_375562.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-26T12:36:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375562"
}
```



---

archive/issue_events_375563.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-02-26T12:36:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375563"
}
```



---

archive/issue_comments_422768.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2019-02-26T12:36:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422768",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_comments_422769.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket-27335)** to **[`6e680ff`](https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b)**",
    "created_at": "2019-02-28T17:54:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27335#issuecomment-422769",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/ticket-27335](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket-27335)** to **[`6e680ff`](https://github.com/sagemath/sagetrac-mirror/commit/6e680ffe87d8a9bd86e9af00839badd85b19b90b)**



---

archive/issue_events_375564.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-28T17:54:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375564"
}
```



---

archive/issue_events_375565.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "bbea55c96e1f05302b3c7f593cf64492497047c5",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-02-28T17:54:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27335",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27335#event-375565"
}
```
