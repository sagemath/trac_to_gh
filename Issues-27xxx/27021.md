# Issue 27021: Clean up import structure of coercion_model

archive/issues_026784.json:
```json
{
    "body": "Currently, there is a base class `CoercionModel` defined in `element.pyx` and the real coercion model is a derived class `CoercionModel_cache_maps` in `coerce.pyx`. This is explained by a comment in `element.pyx`:\n\n```\n# We define this base class here to avoid circular cimports.\n```\n\nHowever, we can get rid of this circular import by forcing `element` to be imported first.\n\nThen we can move the coercion model to `coerce.pyx`. This has the following advantages:\n\n1. simpler code as the superfluous base class can be deleted.\n\n2. making more sense as everything regarding the coercion model will be in `coerce.pyx`\n\n3. better performance for Cython code that `cimport`s the coercion model as it now has access to al `cdef` methods and attributes, not only those from the old `CoercionModel` base class.\n\nBranch/Commit: b61bd8116ce290e6ad3b728460a6bce5d79ff39d\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27021\n\n",
    "closed_at": "2019-01-24T18:17:46Z",
    "created_at": "2019-01-04T15:27:32Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Clean up import structure of coercion_model",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27021",
    "user": "https://github.com/jdemeyer"
}
```
Currently, there is a base class `CoercionModel` defined in `element.pyx` and the real coercion model is a derived class `CoercionModel_cache_maps` in `coerce.pyx`. This is explained by a comment in `element.pyx`:

```
# We define this base class here to avoid circular cimports.
```

However, we can get rid of this circular import by forcing `element` to be imported first.

Then we can move the coercion model to `coerce.pyx`. This has the following advantages:

1. simpler code as the superfluous base class can be deleted.

2. making more sense as everything regarding the coercion model will be in `coerce.pyx`

3. better performance for Cython code that `cimport`s the coercion model as it now has access to al `cdef` methods and attributes, not only those from the old `CoercionModel` base class.

Branch/Commit: b61bd8116ce290e6ad3b728460a6bce5d79ff39d

Reviewer: Travis Scrimshaw

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27021





---

archive/issue_comments_401067.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+Currently, there is a base class `CoercionModel` defined in `element.pyx` and the real coercion model is a derived class `CoercionModel_cache_maps` in `coerce.pyx`. This is explained by a comment in `element.pyx`:\n \n+```\n+# We define this base class here to avoid circular cimports.\n+```\n+\n+However, we can get rid of this circular import by forcing `element` to be imported first.\n+\n+Then we can move the coercion model to `coerce.pyx`. This has the advantage of being simpler (no longer needing a silly base class), making more sense (everything regarding the coercion model will be in `coerce.pyx`) and possibly also being better for performance (things that `cimport` the coercion model now have access to al `cdef` methods and attributes, not only those from the `CoercionModel` base class).\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-01-07T14:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401067",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,12 @@
+Currently, there is a base class `CoercionModel` defined in `element.pyx` and the real coercion model is a derived class `CoercionModel_cache_maps` in `coerce.pyx`. This is explained by a comment in `element.pyx`:
 
+```
+# We define this base class here to avoid circular cimports.
+```
+
+However, we can get rid of this circular import by forcing `element` to be imported first.
+
+Then we can move the coercion model to `coerce.pyx`. This has the advantage of being simpler (no longer needing a silly base class), making more sense (everything regarding the coercion model will be in `coerce.pyx`) and possibly also being better for performance (things that `cimport` the coercion model now have access to al `cdef` methods and attributes, not only those from the `CoercionModel` base class).
 
 Comment: 1
 
``````




---

archive/issue_comments_401068.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+Currently, there is a base class `CoercionModel` defined in `element.pyx` and the real coercion model is a derived class `CoercionModel_cache_maps` in `coerce.pyx`. This is explained by a comment in `element.pyx`:\n \n+```\n+# We define this base class here to avoid circular cimports.\n+```\n+\n+However, we can get rid of this circular import by forcing `element` to be imported first.\n+\n+Then we can move the coercion model to `coerce.pyx`. This has the following advantages:\n+\n+1. simpler code as the superfluous base class can be deleted.\n+\n+2. making more sense as everything regarding the coercion model will be in `coerce.pyx`\n+\n+3. better performance for Cython code that `cimport`s the coercion model as it now has access to al `cdef` methods and attributes, not only those from the old `CoercionModel` base class.\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-01-07T14:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401068",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+Currently, there is a base class `CoercionModel` defined in `element.pyx` and the real coercion model is a derived class `CoercionModel_cache_maps` in `coerce.pyx`. This is explained by a comment in `element.pyx`:
 
+```
+# We define this base class here to avoid circular cimports.
+```
+
+However, we can get rid of this circular import by forcing `element` to be imported first.
+
+Then we can move the coercion model to `coerce.pyx`. This has the following advantages:
+
+1. simpler code as the superfluous base class can be deleted.
+
+2. making more sense as everything regarding the coercion model will be in `coerce.pyx`
+
+3. better performance for Cython code that `cimport`s the coercion model as it now has access to al `cdef` methods and attributes, not only those from the old `CoercionModel` base class.
 
 Comment: 1
 
``````




---

archive/issue_comments_401069.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2019-01-07T15:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401069",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_401070.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-07T15:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401070",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401071.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-07T18:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401071",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401072.json:
```json
{
    "body": "<a id='comment:5'></a>LGTM.",
    "created_at": "2019-01-07T18:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401072",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>LGTM.



---

archive/issue_comments_401073.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-01-07T18:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401073",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_401074.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2019-01-07T18:26:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401074",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_401075.json:
```json
{
    "body": "<a id='comment:7'></a>There is an issue with docbuilding.",
    "created_at": "2019-01-07T19:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401075",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>There is an issue with docbuilding.



---

archive/issue_comments_401076.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-07T19:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401076",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_401077.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-08T06:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401077",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_401078.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-08T09:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401078",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_401079.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-08T11:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401079",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_401080.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-08T17:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401080",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401081.json:
```json
{
    "body": "<a id='comment:11'></a>Patchbots are green.",
    "created_at": "2019-01-08T17:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401081",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Patchbots are green.



---

archive/issue_comments_401082.json:
```json
{
    "body": "<a id='comment:12'></a>arando is not exactly green...",
    "created_at": "2019-01-08T20:42:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401082",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>arando is not exactly green...



---

archive/issue_comments_401083.json:
```json
{
    "body": "<a id='comment:13'></a>When I was looking at it, it looked like it was morally green with some sort of misbuild with giac. However, looking at all of the failures, there are some doctests that indicate an import error from this ticket.",
    "created_at": "2019-01-08T22:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401083",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>When I was looking at it, it looked like it was morally green with some sort of misbuild with giac. However, looking at all of the failures, there are some doctests that indicate an import error from this ticket.



---

archive/issue_comments_401084.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-01-08T22:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401084",
    "user": "https://github.com/tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_401085.json:
```json
{
    "body": "<a id='comment:14'></a>I suspect (but still need to confirm) that this is just a matter of rebuilding `giacpy_sage`. The API of `element.pxd` changed, so any package cimporting that needs to be recompiled.",
    "created_at": "2019-01-09T08:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401085",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>I suspect (but still need to confirm) that this is just a matter of rebuilding `giacpy_sage`. The API of `element.pxd` changed, so any package cimporting that needs to be recompiled.



---

archive/issue_comments_401086.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-09T08:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401086",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_401087.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-09T09:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401087",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_401088.json:
```json
{
    "body": "<a id='comment:16'></a>A rebuild of `giacpy_sage` fixes it indeed.",
    "created_at": "2019-01-09T09:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401088",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>A rebuild of `giacpy_sage` fixes it indeed.



---

archive/issue_comments_401089.json:
```json
{
    "body": "<a id='comment:17'></a>This again shows why patchbots should install optional packages...",
    "created_at": "2019-01-09T09:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401089",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>This again shows why patchbots should install optional packages...



---

archive/issue_comments_401090.json:
```json
{
    "body": "<a id='comment:18'></a>A real green bot. Thanks.",
    "created_at": "2019-01-09T16:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401090",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>A real green bot. Thanks.



---

archive/issue_comments_401091.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-09T16:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401091",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401092.json:
```json
{
    "body": "<a id='comment:19'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401092",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_events_067068.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:16:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27021#event-67068"
}
```



---

archive/issue_comments_401093.json:
```json
{
    "body": "<a id='comment:20'></a>\n```\n[sagelib-8.6] Error compiling Cython file:\n[sagelib-8.6] ------------------------------------------------------------\n[sagelib-8.6] ...\n[sagelib-8.6] from sage.structure.parent import Parent\n[sagelib-8.6] from sage.rings.all import ZZ, QQ, RDF\n[sagelib-8.6] \n[sagelib-8.6] from sage.groups.perm_gps.permgroup_element cimport PermutationGroupElement\n[sagelib-8.6] from sage.combinat.permutation import Permutation\n[sagelib-8.6] from sage.structure.element cimport coercion_model as cm\n[sagelib-8.6] ^\n[sagelib-8.6] ------------------------------------------------------------\n[sagelib-8.6] \n[sagelib-8.6] sage/libs/gap/element.pyx:34:0: 'sage/structure/element/coercion_model.pxd' not found\n```",
    "created_at": "2019-01-19T19:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401093",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>
```
[sagelib-8.6] Error compiling Cython file:
[sagelib-8.6] ------------------------------------------------------------
[sagelib-8.6] ...
[sagelib-8.6] from sage.structure.parent import Parent
[sagelib-8.6] from sage.rings.all import ZZ, QQ, RDF
[sagelib-8.6] 
[sagelib-8.6] from sage.groups.perm_gps.permgroup_element cimport PermutationGroupElement
[sagelib-8.6] from sage.combinat.permutation import Permutation
[sagelib-8.6] from sage.structure.element cimport coercion_model as cm
[sagelib-8.6] ^
[sagelib-8.6] ------------------------------------------------------------
[sagelib-8.6] 
[sagelib-8.6] sage/libs/gap/element.pyx:34:0: 'sage/structure/element/coercion_model.pxd' not found
```



---

archive/issue_comments_401094.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-01-19T19:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401094",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_401095.json:
```json
{
    "body": "<a id='comment:21'></a>`@`vbraun: Volker, there was a conflict with #21020, that we fixed by letting #21020 depend on the present ticket. So now you can merge either #27021 only, or both #27021 and the new version of #21020",
    "created_at": "2019-01-19T19:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401095",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>`@`vbraun: Volker, there was a conflict with #21020, that we fixed by letting #21020 depend on the present ticket. So now you can merge either #27021 only, or both #27021 and the new version of #21020



---

archive/issue_comments_401096.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-01-20T13:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401096",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_401097.json:
```json
{
    "body": "<a id='comment:22'></a>If you want this to be merged, it should be set back to positive review.",
    "created_at": "2019-01-20T13:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401097",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>If you want this to be merged, it should be set back to positive review.



---

archive/issue_events_067069.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-24T18:17:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27021#event-67069"
}
```



---

archive/issue_comments_401098.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-24T18:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27021#issuecomment-401098",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
