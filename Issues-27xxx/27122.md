# Issue 27122: Compile with -march=native

archive/issues_026885.json:
```json
{
    "body": "We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n\nIn `gcc/spkg_configure.ac` we check, whether the argument `-march=native` is accepted.\n\nIn `build/make/Makefile.in` we assemble the flags.\n\nWe add `-march=native` to the compiler flags, if not building fat binaries and the compiler and the package accepts it.\n\nDuring the build of sage there are now the following flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by\n- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)\n- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)\n- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)\n- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)\n- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)\n\nLikewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.\n\nWe try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.\n\nInidividual packages can still be compiled with specified flags or in debug mode using\n\n```\nmake CFLAGS=-O2 some-package\n```\nor\n\n```\nmake SAGE_DEBUG=\"yes\" some-package\n```\n\nCC:  @sophiasage @vbraun @embray @kiwifb\n\nKeywords: Intrinsics, SIMD\n\nReviewer: Matthias Koeppe\n\nAuthor: Jonathan Kliem\n\nBranch: 7bc1f285f9256ebe8f5749848bfd3b97bc173853\n\nDependencies: #30375\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27122\n\n",
    "closed_at": "2020-12-27T23:25:41Z",
    "created_at": "2019-01-25T11:36:49Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Compile with -march=native",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27122",
    "user": "https://github.com/kliem"
}
```
We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.

In `gcc/spkg_configure.ac` we check, whether the argument `-march=native` is accepted.

In `build/make/Makefile.in` we assemble the flags.

We add `-march=native` to the compiler flags, if not building fat binaries and the compiler and the package accepts it.

During the build of sage there are now the following flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by
- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)
- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)
- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)
- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)
- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)

Likewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.

We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.

Inidividual packages can still be compiled with specified flags or in debug mode using

```
make CFLAGS=-O2 some-package
```
or

```
make SAGE_DEBUG="yes" some-package
```

CC:  @sophiasage @vbraun @embray @kiwifb

Keywords: Intrinsics, SIMD

Reviewer: Matthias Koeppe

Author: Jonathan Kliem

Branch: 7bc1f285f9256ebe8f5749848bfd3b97bc173853

Dependencies: #30375

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27122





---

archive/issue_comments_521603.json:
```json
{
    "body": "<a id='comment:1'></a>The topic has nothing to do with polyhedra, many parts of Sage could benefit from it.",
    "created_at": "2019-01-25T11:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521603",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>The topic has nothing to do with polyhedra, many parts of Sage could benefit from it.



---

archive/issue_comments_521604.json:
```json
{
    "body": "Changing keywords from \"Intrinsics, SIMD, Polyhedra, FindPoly\" to \"Intrinsics, SIMD\".",
    "created_at": "2019-01-25T11:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521604",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "Intrinsics, SIMD, Polyhedra, FindPoly" to "Intrinsics, SIMD".



---

archive/issue_comments_521605.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,20 +1,8 @@\n-In #26887 we are constructing a class that makes fast computations of combinatorial data of Polyhedra.\n+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n-Can we add the extra compile argument `-march=native` in `build/cythonized/setup.py`?\n+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.\n \n-```\n-if os.environ.get(\"SAGE_FAT_BINARY\") != \"yes\":\n-    extra_compile_args.append('-march=native')\n-```\n-\n-This would speed up those calculations depending on the architecture:\n-\n-- `f_vector` of `polytopes.permutahedron(8)` takes 1.6 seconds with intrinsics and 4.8 seconds without.\n-- `f_vector` of a 20-dimensional counterexample of the Hirsch-conjecture takes about 3 minutes with intrinsics and 9 minutes without (the polytope contains 353,731,266 faces).\n-\n-As we are setting up a database `FindPoly`, which shall contain a lot of polytopes, we would like calculations to be done as fast as somehow possible. The project does not depend on this happening, but still it would be nice.\n-\n-Keywords: Intrinsics, SIMD, Polyhedra, FindPoly\n+There is also the question at what level to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-01-25T11:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521605",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,20 +1,8 @@
-In #26887 we are constructing a class that makes fast computations of combinatorial data of Polyhedra.
+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
-Can we add the extra compile argument `-march=native` in `build/cythonized/setup.py`?
+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.
 
-```
-if os.environ.get("SAGE_FAT_BINARY") != "yes":
-    extra_compile_args.append('-march=native')
-```
-
-This would speed up those calculations depending on the architecture:
-
-- `f_vector` of `polytopes.permutahedron(8)` takes 1.6 seconds with intrinsics and 4.8 seconds without.
-- `f_vector` of a 20-dimensional counterexample of the Hirsch-conjecture takes about 3 minutes with intrinsics and 9 minutes without (the polytope contains 353,731,266 faces).
-
-As we are setting up a database `FindPoly`, which shall contain a lot of polytopes, we would like calculations to be done as fast as somehow possible. The project does not depend on this happening, but still it would be nice.
-
-Keywords: Intrinsics, SIMD, Polyhedra, FindPoly
+There is also the question at what level to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).
 
 Comment: 1
 
``````




---

archive/issue_comments_521606.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.\n+\n+There is also the question of where to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-01-25T11:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521606",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,8 @@
+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.
+
+There is also the question of where to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).
 
 Comment: 1
 
``````




---

archive/issue_comments_521607.json:
```json
{
    "body": "<a id='comment:3'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521607",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_067365.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67365"
}
```



---

archive/issue_events_067366.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:55:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67366"
}
```



---

archive/issue_comments_521608.json:
```json
{
    "body": "<a id='comment:4'></a>As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521608",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_521609.json:
```json
{
    "body": "Changing branch from \"\" to \"public/27122\"",
    "created_at": "2019-10-23T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521609",
    "user": "https://github.com/kliem"
}
```

Changing branch from "" to "public/27122"



---

archive/issue_comments_521610.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2019-10-23T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521610",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_521611.json:
```json
{
    "body": "Changing commit from \"\" to \"cdc86563cfe52a78e9e50b1ce374750434e1dc1e\"",
    "created_at": "2019-10-23T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521611",
    "user": "https://github.com/kliem"
}
```

Changing commit from "" to "cdc86563cfe52a78e9e50b1ce374750434e1dc1e"



---

archive/issue_comments_521612.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-23T10:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521612",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_521613.json:
```json
{
    "body": "<a id='comment:7'></a>I added a very naive approach of doing it. Wondering if this is remotely ok or going in the right direction.",
    "created_at": "2019-10-23T10:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521613",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>I added a very naive approach of doing it. Wondering if this is remotely ok or going in the right direction.



---

archive/issue_comments_521614.json:
```json
{
    "body": "<a id='comment:8'></a>looks OK - not sure whether converting version to `float()` is normal practice, but that's minor.\n\nI'm also not sure whether this will pass the argument to Cython, or it needs\n\n`# distutils: extra_compile_args = -march=native`\n\nin `*.pxd` files.",
    "created_at": "2019-10-23T11:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521614",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>looks OK - not sure whether converting version to `float()` is normal practice, but that's minor.

I'm also not sure whether this will pass the argument to Cython, or it needs

`# distutils: extra_compile_args = -march=native`

in `*.pxd` files.



---

archive/issue_comments_521615.json:
```json
{
    "body": "<a id='comment:9'></a>I believe it works, but I'm not entirely sure.\n\nThis seems to state that `sage/stats/distributions/discrete_gaussian_integer.pyx` was compiled with `-march=native`.\n\nI have not set it with `CFLAGS`, in that case it would have appeared twice on the list.\n\n```\n[sagelib-9.0.beta2] [469/499] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I./sage/cpython -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/cypari2 -I./sage/libs/ntl -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/\ncysignals -I/srv/public/kliem/sage/local/include -I/srv/public/kliem/sage/src -I/srv/public/kliem/sage/src/sage/ext -I/srv/public/kliem/sage/local/include/python2.7 -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/numpy/core/include -Ibuild/cythonized -I/srv/pu\nblic/kliem/sage/local/include/python2.7 -c build/cythonized/sage/stats/distributions/discrete_gaussian_integer.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/stats/distributions/discrete_gaussian_integer.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -march\n=native -D_XOPEN_SOURCE=600 -std=c99                                                                                                                                                                                                                                           \n[sagelib-9.0.beta2] build/cythonized/sage/stats/hmm/hmm.c: In function \u2018__pyx_pw_4sage_5stats_3hmm_3hmm_25DiscreteHiddenMarkovModel_17_forward\u2019:          \n```",
    "created_at": "2019-10-23T19:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521615",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>I believe it works, but I'm not entirely sure.

This seems to state that `sage/stats/distributions/discrete_gaussian_integer.pyx` was compiled with `-march=native`.

I have not set it with `CFLAGS`, in that case it would have appeared twice on the list.

```
[sagelib-9.0.beta2] [469/499] gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I./sage/cpython -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/cypari2 -I./sage/libs/ntl -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/
cysignals -I/srv/public/kliem/sage/local/include -I/srv/public/kliem/sage/src -I/srv/public/kliem/sage/src/sage/ext -I/srv/public/kliem/sage/local/include/python2.7 -I/srv/public/kliem/sage/local/lib/python2.7/site-packages/numpy/core/include -Ibuild/cythonized -I/srv/pu
blic/kliem/sage/local/include/python2.7 -c build/cythonized/sage/stats/distributions/discrete_gaussian_integer.c -o build/temp.linux-x86_64-2.7/build/cythonized/sage/stats/distributions/discrete_gaussian_integer.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -march
=native -D_XOPEN_SOURCE=600 -std=c99                                                                                                                                                                                                                                           
[sagelib-9.0.beta2] build/cythonized/sage/stats/hmm/hmm.c: In function ‘__pyx_pw_4sage_5stats_3hmm_3hmm_25DiscreteHiddenMarkovModel_17_forward’:          
```



---

archive/issue_comments_521616.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,55 @@\n+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.\n+\n+There is also the question of where to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).\n+\n+** Please help testing this ticket:**\n+\n+- Pull the latest develop (for help, see [http://doc.sagemath.org/html/en/developer/manual_git.html](http://doc.sagemath.org/html/en/developer/manual_git.html))\n+- Test the current sage, e.g. with\n+\n+```\n+sage -t --long --all -p #\n+```\n+  where # denotes the number of threads you want to use.\n+- Note which tests failed and the cpu time.\n+- Checkout a new branch and pull this ticket, e.g.\n+\n+```\n+git checkout -b test_march_native\n+git pull trac public/27122\n+```\n+- Make sage.\n+- Repeat the doctests:\n+\n+```\n+sage -t --long --all -p #\n+```\n+\n+The ticket works if:\n+- sage builds\n+- no new tests fail\n+- the overall test time is somewhat similar\n+\n+Please report success or any failure (with log of the failure) as a comment to this ticket along with\n+- operating system,\n+- kernel,\n+- architecture,\n+- cpu model,\n+- which of the following flags are set `sse4_1 avx avx2 popcnt`.\n+One way to obtain those information is to run the following commands:\n+- Linux:\n+  - `hostnamectl` (for the first three items)\n+  - `lscpu | grep -i \"Model name\"` \n+  - `lscpu | grep -o sse4_1; lscpu | grep -o \"avx \"; lscpu | grep -o avx2; lscpu | grep -o popcnt`\n+- OS X:\n+  - `sysctl -n machdep.cpu.brand_string`\n+  - `sw_vers`\n+  - `uname -a`\n+  - `sysctl -a | grep -o SSE4.1; sysctl -a | grep -o \"AVX \"; sysctl -a | grep -o AVX2; sysctl -a | grep -o POPCNT`\n+\n+Thank you. If you went through those steps, you can also quickly check #27103.\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-10-25T08:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521616",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,55 @@
+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.
+
+There is also the question of where to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).
+
+** Please help testing this ticket:**
+
+- Pull the latest develop (for help, see [http://doc.sagemath.org/html/en/developer/manual_git.html](http://doc.sagemath.org/html/en/developer/manual_git.html))
+- Test the current sage, e.g. with
+
+```
+sage -t --long --all -p #
+```
+  where # denotes the number of threads you want to use.
+- Note which tests failed and the cpu time.
+- Checkout a new branch and pull this ticket, e.g.
+
+```
+git checkout -b test_march_native
+git pull trac public/27122
+```
+- Make sage.
+- Repeat the doctests:
+
+```
+sage -t --long --all -p #
+```
+
+The ticket works if:
+- sage builds
+- no new tests fail
+- the overall test time is somewhat similar
+
+Please report success or any failure (with log of the failure) as a comment to this ticket along with
+- operating system,
+- kernel,
+- architecture,
+- cpu model,
+- which of the following flags are set `sse4_1 avx avx2 popcnt`.
+One way to obtain those information is to run the following commands:
+- Linux:
+  - `hostnamectl` (for the first three items)
+  - `lscpu | grep -i "Model name"` 
+  - `lscpu | grep -o sse4_1; lscpu | grep -o "avx "; lscpu | grep -o avx2; lscpu | grep -o popcnt`
+- OS X:
+  - `sysctl -n machdep.cpu.brand_string`
+  - `sw_vers`
+  - `uname -a`
+  - `sysctl -a | grep -o SSE4.1; sysctl -a | grep -o "AVX "; sysctl -a | grep -o AVX2; sysctl -a | grep -o POPCNT`
+
+Thank you. If you went through those steps, you can also quickly check #27103.
 
 Comment: 1
 
``````




---

archive/issue_comments_521617.json:
```json
{
    "body": "<a id='comment:10'></a>It works for me. All tests passed. No significant time difference.\n\n- Operating System: Debian GNU/Linux 10 (buster)\n- Kernel: Linux 4.19.0-6-amd64\n- Architecture: x86-64\n- CPU Model name: Intel(R) Core(TM) i7-7700 CPU `@` 3.60GHz",
    "created_at": "2019-10-25T08:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521617",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>It works for me. All tests passed. No significant time difference.

- Operating System: Debian GNU/Linux 10 (buster)
- Kernel: Linux 4.19.0-6-amd64
- Architecture: x86-64
- CPU Model name: Intel(R) Core(TM) i7-7700 CPU `@` 3.60GHz



---

archive/issue_comments_521618.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,52 @@\n+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.\n+\n+There is also the question of where to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).\n+\n+** Please help testing this ticket:**\n+\n+- Pull the latest develop (for help, see [http://doc.sagemath.org/html/en/developer/manual_git.html](http://doc.sagemath.org/html/en/developer/manual_git.html))\n+- Test the current sage, e.g. with\n+\n+```\n+sage -t --long --all -p #\n+```\n+  where # denotes the number of threads you want to use.\n+- Note which tests failed and the cpu time.\n+- Checkout a new branch and pull this ticket, e.g.\n+\n+```\n+git checkout -b test_march_native\n+git pull trac public/27122\n+```\n+- Make sage.\n+- Repeat the doctests:\n+\n+```\n+sage -t --long --all -p #\n+```\n+\n+The ticket works if:\n+- sage builds\n+- no new tests fail\n+- the overall test time is somewhat similar\n+\n+Please report success or any failure (with log of the failure) as a comment to this ticket along with\n+- operating system,\n+- kernel,\n+- architecture,\n+- cpu model.\n+One way to obtain those information is to run the following commands:\n+- Linux:\n+  - `hostnamectl` (for the first three items)\n+  - `lscpu | grep -i \"Model name\"` \n+- OS X:\n+  - `sysctl -n machdep.cpu.brand_string`\n+  - `sw_vers`\n+  - `uname -a`\n+\n+Thank you. If you went through those steps, you can also quickly check #27103.\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-10-25T08:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521618",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,52 @@
+We should compile (parts of) Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
+The main problem is how to determine whether the toolchain will accept it. Not all compilers accept that option and some compilers use old assemblers that do not understand all those new instructions.
+
+There is also the question of where to do this. I'm inclined to do it for Python, such that it affects all Python packages (including the Sage library).
+
+** Please help testing this ticket:**
+
+- Pull the latest develop (for help, see [http://doc.sagemath.org/html/en/developer/manual_git.html](http://doc.sagemath.org/html/en/developer/manual_git.html))
+- Test the current sage, e.g. with
+
+```
+sage -t --long --all -p #
+```
+  where # denotes the number of threads you want to use.
+- Note which tests failed and the cpu time.
+- Checkout a new branch and pull this ticket, e.g.
+
+```
+git checkout -b test_march_native
+git pull trac public/27122
+```
+- Make sage.
+- Repeat the doctests:
+
+```
+sage -t --long --all -p #
+```
+
+The ticket works if:
+- sage builds
+- no new tests fail
+- the overall test time is somewhat similar
+
+Please report success or any failure (with log of the failure) as a comment to this ticket along with
+- operating system,
+- kernel,
+- architecture,
+- cpu model.
+One way to obtain those information is to run the following commands:
+- Linux:
+  - `hostnamectl` (for the first three items)
+  - `lscpu | grep -i "Model name"` 
+- OS X:
+  - `sysctl -n machdep.cpu.brand_string`
+  - `sw_vers`
+  - `uname -a`
+
+Thank you. If you went through those steps, you can also quickly check #27103.
 
 Comment: 1
 
``````




---

archive/issue_comments_521619.json:
```json
{
    "body": "<a id='comment:13'></a>Works on\n\n- Operating System: Ubuntu 18.04.3 LTS\n- Kernel: Linux 4.15.0-65-generic\n- Architecture: x86-64\n- Model name:          Intel(R) Core(TM) i5-7200U CPU `@` 2.50GHz",
    "created_at": "2019-10-26T10:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521619",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>Works on

- Operating System: Ubuntu 18.04.3 LTS
- Kernel: Linux 4.15.0-65-generic
- Architecture: x86-64
- Model name:          Intel(R) Core(TM) i5-7200U CPU `@` 2.50GHz



---

archive/issue_comments_521620.json:
```json
{
    "body": "<a id='comment:14'></a>Success on my notebook running a Python 3-based 9.0.beta2 on top of Debian testing :\n\n- Operating System: Debian GNU/Linux bullseye/sid\n- Kernel: Linux 5.2.0-3-amd64\n- Architecture: x86-64\n- Nom de mod\u00e8le : Intel(R) Core(TM) i7-8550U CPU `@` 1.80GHz\n\nHTH,",
    "created_at": "2019-10-26T15:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521620",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:14'></a>Success on my notebook running a Python 3-based 9.0.beta2 on top of Debian testing :

- Operating System: Debian GNU/Linux bullseye/sid
- Kernel: Linux 5.2.0-3-amd64
- Architecture: x86-64
- Nom de modèle : Intel(R) Core(TM) i7-8550U CPU `@` 1.80GHz

HTH,



---

archive/issue_comments_521621.json:
```json
{
    "body": "<a id='comment:15'></a>works on Intel(R) Core(TM) i5-2500 CPU `@` 3.30GHz (in 32-bit mode), Ubunty 14.04 LTS",
    "created_at": "2019-10-27T08:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521621",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>works on Intel(R) Core(TM) i5-2500 CPU `@` 3.30GHz (in 32-bit mode), Ubunty 14.04 LTS



---

archive/issue_comments_521622.json:
```json
{
    "body": "<a id='comment:16'></a>I don't think we should be reinventing the thirty-year-old standard CFLAGS here. It looks like setup.py will already use CFLAGS if it's set. I'm not arguing against sane defaults, just saying that appending `-march=native` on **top** of my CFLAGS is a bit rude if I've set them to what I want.\n\nInstead, why don't we try to set a decent default for CFLAGS if the user does not already have it set? Typically this amounts to something like\n\n```\nCFLAGS ?= -march=native -O2\n```\n\nin a makefile somewhere. For people who don't care, CFLAGS will get set to something nice, and setup.py will use that value. For the people who have set CFLAGS to something special, nothing goes wrong.",
    "created_at": "2019-10-28T13:50:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521622",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:16'></a>I don't think we should be reinventing the thirty-year-old standard CFLAGS here. It looks like setup.py will already use CFLAGS if it's set. I'm not arguing against sane defaults, just saying that appending `-march=native` on **top** of my CFLAGS is a bit rude if I've set them to what I want.

Instead, why don't we try to set a decent default for CFLAGS if the user does not already have it set? Typically this amounts to something like

```
CFLAGS ?= -march=native -O2
```

in a makefile somewhere. For people who don't care, CFLAGS will get set to something nice, and setup.py will use that value. For the people who have set CFLAGS to something special, nothing goes wrong.



---

archive/issue_comments_521623.json:
```json
{
    "body": "Changing commit from \"cdc86563cfe52a78e9e50b1ce374750434e1dc1e\" to \"9aabee1ecf8507cf68a6122ca3febfa0416af528\"",
    "created_at": "2019-10-28T14:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521623",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cdc86563cfe52a78e9e50b1ce374750434e1dc1e" to "9aabee1ecf8507cf68a6122ca3febfa0416af528"



---

archive/issue_comments_521624.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-28T14:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521624",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521625.json:
```json
{
    "body": "<a id='comment:18'></a>Ok, this should respect CFLAGS now.\n\nI need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.",
    "created_at": "2019-10-28T14:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521625",
    "user": "https://github.com/kliem"
}
```

<a id='comment:18'></a>Ok, this should respect CFLAGS now.

I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.



---

archive/issue_comments_521626.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 gh-kliem]:\n> Ok, this should respect CFLAGS now.\n> \n> I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.\n\n\nI'd bet that our ./configure script is capable of doing that in a more reliable way, since it's something that C programs need to do often and python programs basically never. For example, I think we already check for a suitable version of gcc to see if we need to build our own. And we include an autoconf macro (m4/ax_c_check_flag.m4) that will try to compile a file using `-march=native`, and then report back if it worked or not.\n\nIdeally, CFLAGS set in the environment will work everywhere, subject to upstream/spkg cooperation. But they definitely work in setup.py, so if we're able to detect these features at a higher level and then (by default) set CFLAGS/CXXFLAGS to include them, more code would be able to benefit from it. The setup.py script would still pick them up from the environment, but anything else that respects the environment variables would benefit, too.\n\n(I don't know off the top of my head that setup.py doesn't affect spkgs, but I would guess not.)",
    "created_at": "2019-10-28T15:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521626",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:19'></a>Replying to [comment:18 gh-kliem]:
> Ok, this should respect CFLAGS now.
> 
> I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.


I'd bet that our ./configure script is capable of doing that in a more reliable way, since it's something that C programs need to do often and python programs basically never. For example, I think we already check for a suitable version of gcc to see if we need to build our own. And we include an autoconf macro (m4/ax_c_check_flag.m4) that will try to compile a file using `-march=native`, and then report back if it worked or not.

Ideally, CFLAGS set in the environment will work everywhere, subject to upstream/spkg cooperation. But they definitely work in setup.py, so if we're able to detect these features at a higher level and then (by default) set CFLAGS/CXXFLAGS to include them, more code would be able to benefit from it. The setup.py script would still pick them up from the environment, but anything else that respects the environment variables would benefit, too.

(I don't know off the top of my head that setup.py doesn't affect spkgs, but I would guess not.)



---

archive/issue_comments_521627.json:
```json
{
    "body": "<a id='comment:20'></a>Thanks for the comment by the way. It makes sense to me.\n\nI'm just very busy at the moment and didn't have time to see how that could be handled by the configure script.\n\nReplying to [comment:19 mjo]:\n> Replying to [comment:18 gh-kliem]:\n> > Ok, this should respect CFLAGS now.\n> > \n> > I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.\n\n> \n> I'd bet that our ./configure script is capable of doing that in a more reliable way, since it's something that C programs need to do often and python programs basically never. For example, I think we already check for a suitable version of gcc to see if we need to build our own. And we include an autoconf macro (m4/ax_c_check_flag.m4) that will try to compile a file using `-march=native`, and then report back if it worked or not.\n> \n> Ideally, CFLAGS set in the environment will work everywhere, subject to upstream/spkg cooperation. But they definitely work in setup.py, so if we're able to detect these features at a higher level and then (by default) set CFLAGS/CXXFLAGS to include them, more code would be able to benefit from it. The setup.py script would still pick them up from the environment, but anything else that respects the environment variables would benefit, too.\n> \n> (I don't know off the top of my head that setup.py doesn't affect spkgs, but I would guess not.)",
    "created_at": "2019-11-11T19:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521627",
    "user": "https://github.com/kliem"
}
```

<a id='comment:20'></a>Thanks for the comment by the way. It makes sense to me.

I'm just very busy at the moment and didn't have time to see how that could be handled by the configure script.

Replying to [comment:19 mjo]:
> Replying to [comment:18 gh-kliem]:
> > Ok, this should respect CFLAGS now.
> > 
> > I need to check yet, that the compiler can handle `march=native`. This is why I did it in the setup file.

> 
> I'd bet that our ./configure script is capable of doing that in a more reliable way, since it's something that C programs need to do often and python programs basically never. For example, I think we already check for a suitable version of gcc to see if we need to build our own. And we include an autoconf macro (m4/ax_c_check_flag.m4) that will try to compile a file using `-march=native`, and then report back if it worked or not.
> 
> Ideally, CFLAGS set in the environment will work everywhere, subject to upstream/spkg cooperation. But they definitely work in setup.py, so if we're able to detect these features at a higher level and then (by default) set CFLAGS/CXXFLAGS to include them, more code would be able to benefit from it. The setup.py script would still pick them up from the environment, but anything else that respects the environment variables would benefit, too.
> 
> (I don't know off the top of my head that setup.py doesn't affect spkgs, but I would guess not.)



---

archive/issue_comments_521628.json:
```json
{
    "body": "<a id='comment:21'></a>This does the trick, but might be a bit blunt:\n\n```\ndiff --git a/build/make/Makefile.in b/build/make/Makefile.in\nindex eea7ceb7dc..a5966b8011 100644\n--- a/build/make/Makefile.in\n+++ b/build/make/Makefile.in\n@@ -17,6 +17,13 @@\n # Always use bash for make rules\n SHELL = @SHELL@\n\n+# Use safe-but-efficient optimization flags, if the user does not\n+# provide his own.\n+CFLAGS ?= -O2 -march=native\n+CXXFLAGS ?= -O2 -march=native\n+export CFLAGS\n+export CXXFLAGS\n+\n ifndef SAGE_SPKG_INST\n ifndef DEBUG_RULES\n $(error This Makefile needs to be invoked by build/make/install)\n```\n\nIn any case, it would make sense at that point to go through every spkg-install and strip out any \"-O2\" and \"-march=native\" additions.",
    "created_at": "2020-01-01T19:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521628",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:21'></a>This does the trick, but might be a bit blunt:

```
diff --git a/build/make/Makefile.in b/build/make/Makefile.in
index eea7ceb7dc..a5966b8011 100644
--- a/build/make/Makefile.in
+++ b/build/make/Makefile.in
@@ -17,6 +17,13 @@
 # Always use bash for make rules
 SHELL = @SHELL@

+# Use safe-but-efficient optimization flags, if the user does not
+# provide his own.
+CFLAGS ?= -O2 -march=native
+CXXFLAGS ?= -O2 -march=native
+export CFLAGS
+export CXXFLAGS
+
 ifndef SAGE_SPKG_INST
 ifndef DEBUG_RULES
 $(error This Makefile needs to be invoked by build/make/install)
```

In any case, it would make sense at that point to go through every spkg-install and strip out any "-O2" and "-march=native" additions.



---

archive/issue_comments_521629.json:
```json
{
    "body": "Changing commit from \"9aabee1ecf8507cf68a6122ca3febfa0416af528\" to \"60bddf468a3c0b0e70ec285ebf450ca45eabf8f3\"",
    "created_at": "2020-01-06T08:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521629",
    "user": "https://github.com/kliem"
}
```

Changing commit from "9aabee1ecf8507cf68a6122ca3febfa0416af528" to "60bddf468a3c0b0e70ec285ebf450ca45eabf8f3"



---

archive/issue_comments_521630.json:
```json
{
    "body": "Changing branch from \"public/27122\" to \"public/27122-new\"",
    "created_at": "2020-01-06T08:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521630",
    "user": "https://github.com/kliem"
}
```

Changing branch from "public/27122" to "public/27122-new"



---

archive/issue_comments_521631.json:
```json
{
    "body": "<a id='comment:22'></a>New commits:",
    "created_at": "2020-01-06T08:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521631",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>New commits:



---

archive/issue_comments_521632.json:
```json
{
    "body": "<a id='comment:23'></a>Thanks. I basically did it like this.\n\nI also added `-O0`, `-O2` and `-g` according to `SAGE_DEBUG`. This helps clean up a lot of code (basically every package sets those flags manually).\n\nFinally, I used `src/bin/testcflags.sh` to remove unsupported flags.\n\nThe package `ecm` still adds `-march=native` on top of `CFLAGS` unless a similar flag is present.\n\nSome packages prefer `-O3` over `-O2`, so I left the flag `-O3` as it is.\n\nWith this branch all tests passed on my end (ran distclean and installed all packages I touched).\n\nReplying to [comment:21 mjo]:\n> This does the trick, but might be a bit blunt:\n> \n> \n> ```\n> diff --git a/build/make/Makefile.in b/build/make/Makefile.in\n> index eea7ceb7dc..a5966b8011 100644\n> --- a/build/make/Makefile.in\n> +++ b/build/make/Makefile.in\n> @@ -17,6 +17,13 @@\n>  # Always use bash for make rules\n>  SHELL = @SHELL@\n> \n> +# Use safe-but-efficient optimization flags, if the user does not\n> +# provide his own.\n> +CFLAGS ?= -O2 -march=native\n> +CXXFLAGS ?= -O2 -march=native\n> +export CFLAGS\n> +export CXXFLAGS\n> +\n>  ifndef SAGE_SPKG_INST\n>  ifndef DEBUG_RULES\n>  $(error This Makefile needs to be invoked by build/make/install)\n> ```\n> \n> In any case, it would make sense at that point to go through every spkg-install and strip out any \"-O2\" and \"-march=native\" additions.",
    "created_at": "2020-01-06T08:44:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521632",
    "user": "https://github.com/kliem"
}
```

<a id='comment:23'></a>Thanks. I basically did it like this.

I also added `-O0`, `-O2` and `-g` according to `SAGE_DEBUG`. This helps clean up a lot of code (basically every package sets those flags manually).

Finally, I used `src/bin/testcflags.sh` to remove unsupported flags.

The package `ecm` still adds `-march=native` on top of `CFLAGS` unless a similar flag is present.

Some packages prefer `-O3` over `-O2`, so I left the flag `-O3` as it is.

With this branch all tests passed on my end (ran distclean and installed all packages I touched).

Replying to [comment:21 mjo]:
> This does the trick, but might be a bit blunt:
> 
> 
> ```
> diff --git a/build/make/Makefile.in b/build/make/Makefile.in
> index eea7ceb7dc..a5966b8011 100644
> --- a/build/make/Makefile.in
> +++ b/build/make/Makefile.in
> @@ -17,6 +17,13 @@
>  # Always use bash for make rules
>  SHELL = @SHELL@
> 
> +# Use safe-but-efficient optimization flags, if the user does not
> +# provide his own.
> +CFLAGS ?= -O2 -march=native
> +CXXFLAGS ?= -O2 -march=native
> +export CFLAGS
> +export CXXFLAGS
> +
>  ifndef SAGE_SPKG_INST
>  ifndef DEBUG_RULES
>  $(error This Makefile needs to be invoked by build/make/install)
> ```
> 
> In any case, it would make sense at that point to go through every spkg-install and strip out any "-O2" and "-march=native" additions.



---

archive/issue_comments_521633.json:
```json
{
    "body": "<a id='comment:24'></a>Is the new code acceptable?",
    "created_at": "2020-01-15T10:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521633",
    "user": "https://github.com/kliem"
}
```

<a id='comment:24'></a>Is the new code acceptable?



---

archive/issue_comments_521634.json:
```json
{
    "body": "<a id='comment:25'></a>LGTM at first glance. Good job figuring out what to do with SAGE_DEBUG and SAGE_FAT_BINARY, I missed those entirely.\n\nI've never tried passing `-march=native` to gfortran, but it looks like it should work. I've added it to my local config for future builds.\n\nThe use of testcflags.sh only attempts to compile a C program with those flags, but then appends them to the compiler flags for C++ and fortran as well. That's not 100% correct, but I think we're already making the assumption that every compiler is from the same version of the same gcc suite? (Anyone?) So long as it works, I'd be happy with a comment about that. In the future, we could always change it to use the `AX_CHECK_COMPILE_FLAG` repeatedly, but that's overkill until we can actually swap out compilers.",
    "created_at": "2020-01-18T01:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521634",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:25'></a>LGTM at first glance. Good job figuring out what to do with SAGE_DEBUG and SAGE_FAT_BINARY, I missed those entirely.

I've never tried passing `-march=native` to gfortran, but it looks like it should work. I've added it to my local config for future builds.

The use of testcflags.sh only attempts to compile a C program with those flags, but then appends them to the compiler flags for C++ and fortran as well. That's not 100% correct, but I think we're already making the assumption that every compiler is from the same version of the same gcc suite? (Anyone?) So long as it works, I'd be happy with a comment about that. In the future, we could always change it to use the `AX_CHECK_COMPILE_FLAG` repeatedly, but that's overkill until we can actually swap out compilers.



---

archive/issue_comments_521635.json:
```json
{
    "body": "Changing commit from \"60bddf468a3c0b0e70ec285ebf450ca45eabf8f3\" to \"e4205465daa4267c12a3ff49d23471b277bc16d5\"",
    "created_at": "2020-01-27T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521635",
    "user": "https://github.com/kliem"
}
```

Changing commit from "60bddf468a3c0b0e70ec285ebf450ca45eabf8f3" to "e4205465daa4267c12a3ff49d23471b277bc16d5"



---

archive/issue_comments_521636.json:
```json
{
    "body": "Changing branch from \"public/27122-new\" to \"public/27122-reb\"",
    "created_at": "2020-01-27T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521636",
    "user": "https://github.com/kliem"
}
```

Changing branch from "public/27122-new" to "public/27122-reb"



---

archive/issue_comments_521637.json:
```json
{
    "body": "<a id='comment:26'></a>Ok, I added a comment about that assumption.\n\nIs this at a point where people can/should test it again?\n\n---\nNew commits:",
    "created_at": "2020-01-27T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521637",
    "user": "https://github.com/kliem"
}
```

<a id='comment:26'></a>Ok, I added a comment about that assumption.

Is this at a point where people can/should test it again?

---
New commits:



---

archive/issue_comments_521638.json:
```json
{
    "body": "Changing author from \"\" to \"Jonathan Kliem\"",
    "created_at": "2020-01-27T10:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521638",
    "user": "https://github.com/kliem"
}
```

Changing author from "" to "Jonathan Kliem"



---

archive/issue_comments_521639.json:
```json
{
    "body": "<a id='comment:28'></a>Yeah, now it just needs testing on a few different platforms. I've been using `-march=native` in my exported CFLAGS for years without problems, and your implementation looks OK to me, but I'm on a boring amd64/linux system and these days I'm doing my best to *not* build any spkgs.\n\nWhile testing, you should be sure that the spkg really gets used (otherwise, the CFLAGS are irrelevant). The `./configure` script nowadays will do its best to use packages from the system instead of an spkg. You can disable that using e.g. `--without-system-foo`, but there are a lot of flags you have to pass. Something like\n\n```\n$ ./configure --help | grep -oP '\\-\\-with-system[^ =]+' | sort | uniq | sed 's/with/without/'\n--without-system-arb\n--without-system-atlas\n--without-system-bzip2\n...\n```\n\ncan be used to get the full list for your branch.",
    "created_at": "2020-01-27T15:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521639",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:28'></a>Yeah, now it just needs testing on a few different platforms. I've been using `-march=native` in my exported CFLAGS for years without problems, and your implementation looks OK to me, but I'm on a boring amd64/linux system and these days I'm doing my best to *not* build any spkgs.

While testing, you should be sure that the spkg really gets used (otherwise, the CFLAGS are irrelevant). The `./configure` script nowadays will do its best to use packages from the system instead of an spkg. You can disable that using e.g. `--without-system-foo`, but there are a lot of flags you have to pass. Something like

```
$ ./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/'
--without-system-arb
--without-system-atlas
--without-system-bzip2
...
```

can be used to get the full list for your branch.



---

archive/issue_comments_521640.json:
```json
{
    "body": "<a id='comment:29'></a>Ok. Took a while, but it seems to work now. The test `sage -t --long src/sage/interfaces/psage.py` only worked on retry, but I guess this is fine.\n\nWhat I did was basically the following:\n\n```\n$ make distclean\n$ ./configure $(./configure --help | grep -oP '\\-\\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | past -sd \" \")\n$ make build; ./sage -i openssl; ./sage -f python3; ./sage -i pyopenssl; make build\n$ ./sage -i $(./sage --optional | awk -F\\. '{print $1}' | grep -v warnings | grep -v package |  grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd \" \")\n$ sage -i sage_numerical_backends_coin\n$ make\n$ sage -t --long --all\n```\n(install gcc)\n\n```\n$ make distclean\n$ ./configure $(./configure --help | grep -oP '\\-\\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd \" \")\n$ make build; ./sage -i openssl; ./sage -f python3; ./sage -i pyopenssl; make build\n$ ./sage -i $(./sage --optional | awk -F\\. '{print $1}' | grep -v warnings | grep -v package | grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd \" \")\n$ sage -i sage_numerical_backends_coin; make; sage -t --long --all\n```\n(use system gcc)\n\nI'm often having trouble with openssl and I don't exactly understand the problem (but the workaround seems to work), so I guess you can ignore that part.\n\nI would suggest the following for others to test it:\n\n- Pull ticket.\n- Unset `CFLAGS` etc.\n- `make distclean`\n- configure to compile as you would usually do, plus add the following:\n\n```\n$ ./configure --help | grep -oP '\\-\\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd \" \"\n```\n  so e.g. one would configure to compile with clang as follows:\n\n```\n$ CC=clang CXX=clang++ FC=flang ./configure $(./configure --help | grep -oP '\\-\\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd \" \")\n```\n- make sage\n- install optional packages\n\n```\n$ ./sage -i $(./sage --optional | awk -F\\. '{print $1}' | grep -v warnings | grep -v package |  grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd \" \") sage_numerical_backends_coin\n```\n- test everything with `sage -t --all --long`\n\nReport any (unusual) trouble you are having.",
    "created_at": "2020-01-29T10:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521640",
    "user": "https://github.com/kliem"
}
```

<a id='comment:29'></a>Ok. Took a while, but it seems to work now. The test `sage -t --long src/sage/interfaces/psage.py` only worked on retry, but I guess this is fine.

What I did was basically the following:

```
$ make distclean
$ ./configure $(./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | past -sd " ")
$ make build; ./sage -i openssl; ./sage -f python3; ./sage -i pyopenssl; make build
$ ./sage -i $(./sage --optional | awk -F\. '{print $1}' | grep -v warnings | grep -v package |  grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd " ")
$ sage -i sage_numerical_backends_coin
$ make
$ sage -t --long --all
```
(install gcc)

```
$ make distclean
$ ./configure $(./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd " ")
$ make build; ./sage -i openssl; ./sage -f python3; ./sage -i pyopenssl; make build
$ ./sage -i $(./sage --optional | awk -F\. '{print $1}' | grep -v warnings | grep -v package | grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd " ")
$ sage -i sage_numerical_backends_coin; make; sage -t --long --all
```
(use system gcc)

I'm often having trouble with openssl and I don't exactly understand the problem (but the workaround seems to work), so I guess you can ignore that part.

I would suggest the following for others to test it:

- Pull ticket.
- Unset `CFLAGS` etc.
- `make distclean`
- configure to compile as you would usually do, plus add the following:

```
$ ./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd " "
```
  so e.g. one would configure to compile with clang as follows:

```
$ CC=clang CXX=clang++ FC=flang ./configure $(./configure --help | grep -oP '\-\-with-system[^ =]+' | sort | uniq | sed 's/with/without/' | grep -v gfortran | grep -v gcc | past -sd " ")
```
- make sage
- install optional packages

```
$ ./sage -i $(./sage --optional | awk -F\. '{print $1}' | grep -v warnings | grep -v package |  grep -v gfort | grep -v buckygen |grep -v database | grep -v polymake | grep -v jupymake | paste -sd " ") sage_numerical_backends_coin
```
- test everything with `sage -t --all --long`

Report any (unusual) trouble you are having.



---

archive/issue_comments_521641.json:
```json
{
    "body": "<a id='comment:30'></a>To test build changes like this systematically, I recommend to use #29053 / #29087.",
    "created_at": "2020-02-02T17:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521641",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>To test build changes like this systematically, I recommend to use #29053 / #29087.



---

archive/issue_comments_521642.json:
```json
{
    "body": "<a id='comment:31'></a>[https://github.com/kliem/sage-test-27122/runs/422709282](https://github.com/kliem/sage-test-27122/runs/422709282)\n\nI pulled the newest develop and #29087 to run those tests.\n\nIt's really hard to see the difference to your run: [https://github.com/mkoeppe/sage/runs/422167181](https://github.com/mkoeppe/sage/runs/422167181). I'm reducing my attention here to those tests that suceeded for you:\n\n- Problems with gsl for\n  - ubuntu-xenial, minimal, ubuntu-latest\n  - ubuntu-xenial, standard, ubuntu-latest\n\n- Problems with gsl and libatomic_ops for\n  - ubuntu-bionic, standard, ubuntu-latest\n  - ubuntu-eoan, standard, ubuntu-latest\n  - fedora-26, standard, ubuntu-latest\n  - fedora-28, standard, ubuntu-latest\n\n- Never ran the following:\n  - ubuntu-bionic-i386, standard:\n\nFrom this I gather that maybe one shouldn't use `-march=native` for those two packages. Does this make any sense?\n\nReplying to [comment:30 mkoeppe]:\n> To test build changes like this systematically, I recommend to use #29053 / #29087.",
    "created_at": "2020-02-03T15:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521642",
    "user": "https://github.com/kliem"
}
```

<a id='comment:31'></a>[https://github.com/kliem/sage-test-27122/runs/422709282](https://github.com/kliem/sage-test-27122/runs/422709282)

I pulled the newest develop and #29087 to run those tests.

It's really hard to see the difference to your run: [https://github.com/mkoeppe/sage/runs/422167181](https://github.com/mkoeppe/sage/runs/422167181). I'm reducing my attention here to those tests that suceeded for you:

- Problems with gsl for
  - ubuntu-xenial, minimal, ubuntu-latest
  - ubuntu-xenial, standard, ubuntu-latest

- Problems with gsl and libatomic_ops for
  - ubuntu-bionic, standard, ubuntu-latest
  - ubuntu-eoan, standard, ubuntu-latest
  - fedora-26, standard, ubuntu-latest
  - fedora-28, standard, ubuntu-latest

- Never ran the following:
  - ubuntu-bionic-i386, standard:

From this I gather that maybe one shouldn't use `-march=native` for those two packages. Does this make any sense?

Replying to [comment:30 mkoeppe]:
> To test build changes like this systematically, I recommend to use #29053 / #29087.



---

archive/issue_comments_521643.json:
```json
{
    "body": "<a id='comment:32'></a>New commits:",
    "created_at": "2020-03-30T07:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521643",
    "user": "https://github.com/kliem"
}
```

<a id='comment:32'></a>New commits:



---

archive/issue_comments_521644.json:
```json
{
    "body": "Changing branch from \"public/27122-reb\" to \"public/27122-reb2\"",
    "created_at": "2020-03-30T07:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521644",
    "user": "https://github.com/kliem"
}
```

Changing branch from "public/27122-reb" to "public/27122-reb2"



---

archive/issue_comments_521645.json:
```json
{
    "body": "Changing commit from \"e4205465daa4267c12a3ff49d23471b277bc16d5\" to \"301bd2c279991115c5702b1837118339360e8e86\"",
    "created_at": "2020-03-30T07:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521645",
    "user": "https://github.com/kliem"
}
```

Changing commit from "e4205465daa4267c12a3ff49d23471b277bc16d5" to "301bd2c279991115c5702b1837118339360e8e86"



---

archive/issue_comments_521646.json:
```json
{
    "body": "<a id='comment:33'></a>Can someone please help me with the following issue.\n\n- conda-forge and homebrew-macos\n\n```\n  `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`\n```\n  The following line seems to be a problem:\n\n```\n+opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))\n```\n\nOtherwise things are looking good, I would say.\n\nThings have improved \"by themselves\" (of course not):\n\n[https://github.com/kliem/sage-test-27122/actions/runs/66307817](https://github.com/kliem/sage-test-27122/actions/runs/66307817)\n\nNow the current ticket (with #29087 merged) runs as smooth as the current beta [https://github.com/mkoeppe/sage/actions/runs/65613035](https://github.com/mkoeppe/sage/actions/runs/65613035). However many tests got cancelled due to exceeding 6 hours.\n\n- ubuntu-trusty, minimal:\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/matrix/matrix2.pyx  # Timed out\n\n```\nsage: all(L.change_ring(SR).is_cross_positive_on(K)\n    for L in K.cross_positive_operators_gens())  # long time ## line 15240 ##\n```\n\n  Got cancelled at `sage -t src/sage/numerical/linear_tensor.py` (6 hours)\n- ubuntu-trusty, standard\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  \n  Got cancelled at `sage -t src/sage/modular/local_comp/liftings.py`\n- ubuntu-trusty, standard-python2\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/doctest/test.py [https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ](https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ)\n\n  Got cancelled at `sage -t src/sage/schemes/affine/affine_subscheme.py`\n\n- ubuntu-xenial, minimal -- ubuntu-bionic, minimal -- debian-jessie, minimal -- debian-buster, minimal -- fedora-26, minimal -- fedora-26, standard -- centos-8, standard -- archlinux-latest, minimal\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed\n\n- ubuntu-xenial, standard -- ubuntu-xenial, standard-python2\n  - sage -t src/sage/graphs/digraph_generators.py  # 5 doctests failed\n  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed\n  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed\n\n- ubuntu-bionic, standard -- ubuntu-bionic, standard-python2 -- ubuntu-focal, standard -- ubuntu-focal, standard-python2 -- linuxmint-19.3, standard, linuxmint-19.3, standard-python2\n  - sage -t src/sage/interfaces/r.py  # 1 doctest failed\n  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed\n  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed\n  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (only python3)\n  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed\n- ubuntu-eoan, minimal\n  Got cancelled at `sage -t src/sage/manifolds/differentiable/differentiable_submanifold.py`\n- ubuntu-eoan, standard\n\n```\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/u/underscore/libjs-underscore_1.8.3~dfsg-1_all.deb  Could not connect to azure.archive.ubuntu.com:80 (52.177.174.250), connection timed out\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/s/sphinx/libjs-sphinxdoc_1.6.7-1ubuntu1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-pluggy/python3-pluggy_0.6.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-py/python3-py_1.5.2-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/p/python-setuptools/python3-setuptools_39.0.1-2_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-virtualenv/python3-virtualenv_15.1.0+ds-1.1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-virtualenv/virtualenv_15.1.0+ds-1.1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/t/tox/tox_2.5.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/t/tox/python-tox_2.5.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:\nE: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing?\n```\n- ubuntu-eoan, standard-python2\n  - sage -t src/sage/interfaces/r.py  # 1 doctest failed\n  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed\n  - sage -t src/sage/libs/eclib/interface.py  # 1 doctest failed\n  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed\n  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed\n- ubuntu-focal, minimal\n\n  cancelled at `sage -t src/sage/geometry/hyperplane_arrangement/check_freeness.py`\n\n- debian-jessie, standard\n  - sage -t src/sage/doctest/test.py  # Timed out\n\n```\n sage: if system() == \"Linux\":\n    P = subprocess.Popen([\"sage\", \"-t\", \"--warn-long\", \"0\", \"--memlimit=2000\", \"memlimit.rst\"], stdout=subprocess.PIPE, **kwds)\n    out, err = P.communicate()\n    ok = (\"MemoryError: failed to allocate\" in bytes_to_str(out)) ## line 521 ##\n```\n    probably related to [https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ](https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ)\n- sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n- sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed\n- sage -t src/sage/tests/cmdline.py  # 3 doctests failed\n\n- debian-jessie, standard-python2\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py\n    Timed out\n  - sage -t src/sage/doctest/test.py  # 1 doctest failed\n  cancelled at `sage -t src/sage/rings/rational.pxd`\n\n- debian-buster, standard -- debian-buster, standard-python2\n  - sage -t src/sage/interfaces/r.py  # 1 doctest failed\n  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed\n  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed\n  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (only python3)\n  - sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py  # 2 doctests failed\n  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed\n\n- debian-bullseye, minimal\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  cancelled at `sage -t src/sage/modular/modform/weight1.py`\n\n- debian-bullseye, standard -- debian-bullseye, standard-python2 -- debian-sid, standard\n  - sage -t src/sage/interfaces/r.py  # 1 doctest failed\n  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed\n  - sage -t src/sage/lfunctions/dokchitser.py  # 2 doctests failed\n  - sage -t src/sage/lfunctions/pari.py  # 1 doctest failed\n  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed\n  - sage -t src/sage/interfaces/maxima.py  # Timed out (only debian-sid, standard-python2)\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed\n  - sage -t src/sage/rings/number_field/number_field_ideal.py  # 2 doctests failed\n  - sage -t src/sage/rings/number_field/number_field.py  # 8 doctests failed\n  - sage -t src/sage/rings/number_field/unit_group.py  # 1 doctest failed\n  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (python3 only)\n  - sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed\n  - sage -t src/sage/rings/number_field/number_field_element.pyx  # Timed out\n  - sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # 3 doctests failed\n  - sage -t src/sage/schemes/elliptic_curves/height.py  # 6 doctests failed\n  - sage -t src/sage/schemes/plane_conics/con_number_field.py  # 1 doctest failed\n  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed\n\n- debian-sid, minimal\n\n  cancelled at `sage -t src/sage/misc/bindable_class.py`\n- linuxmint-19.3, minimal\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed\n  cancelled at `sage -t src/sage/rings/polynomial/polynomial_number_field.pyx`\n\n- fedora-26, standard-python2\n\n- fedora-28, minimal\n\n  cancelled at `sage -t src/sage/plot/disk.py`\n- centos-7, minimal\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  cancelled at `sage -t src/sage/sat/solvers/satsolver.pxd`\n- centos-8, standard\n  \n  cancelled during `[pplpy-0.8.4] installing. Log file: /sage/logs/pkgs/pplpy-0.8.4.log`\n- centos-8, standard-python2\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n- centos-8, minimal\n \n  cancelled at `sage -t src/sage/manifolds/differentiable/characteristic_class.py`\n- centos-8, standard-python2\n\n  cancelled during traceback of `sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out`\n\n- archlinux-latest, standard -- archlinux-latest, standard-python2\n  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed\n  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\n  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed\n  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (python3 only)\n\n- slackware (build failure, see #29373)",
    "created_at": "2020-03-31T15:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521646",
    "user": "https://github.com/kliem"
}
```

<a id='comment:33'></a>Can someone please help me with the following issue.

- conda-forge and homebrew-macos

```
  `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`
```
  The following line seems to be a problem:

```
+opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))
```

Otherwise things are looking good, I would say.

Things have improved "by themselves" (of course not):

[https://github.com/kliem/sage-test-27122/actions/runs/66307817](https://github.com/kliem/sage-test-27122/actions/runs/66307817)

Now the current ticket (with #29087 merged) runs as smooth as the current beta [https://github.com/mkoeppe/sage/actions/runs/65613035](https://github.com/mkoeppe/sage/actions/runs/65613035). However many tests got cancelled due to exceeding 6 hours.

- ubuntu-trusty, minimal:
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/matrix/matrix2.pyx  # Timed out

```
sage: all(L.change_ring(SR).is_cross_positive_on(K)
    for L in K.cross_positive_operators_gens())  # long time ## line 15240 ##
```

  Got cancelled at `sage -t src/sage/numerical/linear_tensor.py` (6 hours)
- ubuntu-trusty, standard
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  
  Got cancelled at `sage -t src/sage/modular/local_comp/liftings.py`
- ubuntu-trusty, standard-python2
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/doctest/test.py [https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ](https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ)

  Got cancelled at `sage -t src/sage/schemes/affine/affine_subscheme.py`

- ubuntu-xenial, minimal -- ubuntu-bionic, minimal -- debian-jessie, minimal -- debian-buster, minimal -- fedora-26, minimal -- fedora-26, standard -- centos-8, standard -- archlinux-latest, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed

- ubuntu-xenial, standard -- ubuntu-xenial, standard-python2
  - sage -t src/sage/graphs/digraph_generators.py  # 5 doctests failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- ubuntu-bionic, standard -- ubuntu-bionic, standard-python2 -- ubuntu-focal, standard -- ubuntu-focal, standard-python2 -- linuxmint-19.3, standard, linuxmint-19.3, standard-python2
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (only python3)
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed
- ubuntu-eoan, minimal
  Got cancelled at `sage -t src/sage/manifolds/differentiable/differentiable_submanifold.py`
- ubuntu-eoan, standard

```
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/u/underscore/libjs-underscore_1.8.3~dfsg-1_all.deb  Could not connect to azure.archive.ubuntu.com:80 (52.177.174.250), connection timed out
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/s/sphinx/libjs-sphinxdoc_1.6.7-1ubuntu1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-pluggy/python3-pluggy_0.6.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-py/python3-py_1.5.2-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/p/python-setuptools/python3-setuptools_39.0.1-2_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-virtualenv/python3-virtualenv_15.1.0+ds-1.1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/p/python-virtualenv/virtualenv_15.1.0+ds-1.1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/t/tox/tox_2.5.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/universe/t/tox/python-tox_2.5.0-1_all.deb  Unable to connect to azure.archive.ubuntu.com:http:
E: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing?
```
- ubuntu-eoan, standard-python2
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/libs/eclib/interface.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed
- ubuntu-focal, minimal

  cancelled at `sage -t src/sage/geometry/hyperplane_arrangement/check_freeness.py`

- debian-jessie, standard
  - sage -t src/sage/doctest/test.py  # Timed out

```
 sage: if system() == "Linux":
    P = subprocess.Popen(["sage", "-t", "--warn-long", "0", "--memlimit=2000", "memlimit.rst"], stdout=subprocess.PIPE, **kwds)
    out, err = P.communicate()
    ok = ("MemoryError: failed to allocate" in bytes_to_str(out)) ## line 521 ##
```
    probably related to [https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ](https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/IEX-j4PDAwAJ)
- sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
- sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
- sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- debian-jessie, standard-python2
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py
    Timed out
  - sage -t src/sage/doctest/test.py  # 1 doctest failed
  cancelled at `sage -t src/sage/rings/rational.pxd`

- debian-buster, standard -- debian-buster, standard-python2
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (only python3)
  - sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py  # 2 doctests failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- debian-bullseye, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  cancelled at `sage -t src/sage/modular/modform/weight1.py`

- debian-bullseye, standard -- debian-bullseye, standard-python2 -- debian-sid, standard
  - sage -t src/sage/interfaces/r.py  # 1 doctest failed
  - sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed
  - sage -t src/sage/lfunctions/dokchitser.py  # 2 doctests failed
  - sage -t src/sage/lfunctions/pari.py  # 1 doctest failed
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/interfaces/maxima.py  # Timed out (only debian-sid, standard-python2)
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/number_field/number_field_ideal.py  # 2 doctests failed
  - sage -t src/sage/rings/number_field/number_field.py  # 8 doctests failed
  - sage -t src/sage/rings/number_field/unit_group.py  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (python3 only)
  - sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed
  - sage -t src/sage/rings/number_field/number_field_element.pyx  # Timed out
  - sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # 3 doctests failed
  - sage -t src/sage/schemes/elliptic_curves/height.py  # 6 doctests failed
  - sage -t src/sage/schemes/plane_conics/con_number_field.py  # 1 doctest failed
  - sage -t src/sage/tests/cmdline.py  # 3 doctests failed

- debian-sid, minimal

  cancelled at `sage -t src/sage/misc/bindable_class.py`
- linuxmint-19.3, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
  cancelled at `sage -t src/sage/rings/polynomial/polynomial_number_field.pyx`

- fedora-26, standard-python2

- fedora-28, minimal

  cancelled at `sage -t src/sage/plot/disk.py`
- centos-7, minimal
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  cancelled at `sage -t src/sage/sat/solvers/satsolver.pxd`
- centos-8, standard
  
  cancelled during `[pplpy-0.8.4] installing. Log file: /sage/logs/pkgs/pplpy-0.8.4.log`
- centos-8, standard-python2
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
- centos-8, minimal
 
  cancelled at `sage -t src/sage/manifolds/differentiable/characteristic_class.py`
- centos-8, standard-python2

  cancelled during traceback of `sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out`

- archlinux-latest, standard -- archlinux-latest, standard-python2
  - sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed
  - sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
  - sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
  - sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed (python3 only)

- slackware (build failure, see #29373)



---

archive/issue_comments_521647.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 gh-kliem]:\n> Can someone please help me with the following issue.\n> \n> - conda-forge and homebrew-macos\n> \n> ```\n>   `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`\n> ```\n>   The following line seems to be a problem:\n> \n> ```\n> +opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))\n> ```",
    "created_at": "2020-03-31T15:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521647",
    "user": "https://github.com/kliem"
}
```

<a id='comment:34'></a>Replying to [comment:33 gh-kliem]:
> Can someone please help me with the following issue.
> 
> - conda-forge and homebrew-macos
> 
> ```
>   `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`
> ```
>   The following line seems to be a problem:
> 
> ```
> +opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))
> ```



---

archive/issue_comments_521648.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-03-31T15:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521648",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_521649.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:34 gh-kliem]:\n> Replying to [comment:33 gh-kliem]:\n> > Can someone please help me with the following issue.\n> > \n> > - conda-forge and homebrew-macos\n> > \n> > ```\n> >   `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`\n> > ```\n> >   The following line seems to be a problem:\n> > \n> > ```\n> > +opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))\n> > ```\n\n\nWhere do you see this line?",
    "created_at": "2020-03-31T15:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521649",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Replying to [comment:34 gh-kliem]:
> Replying to [comment:33 gh-kliem]:
> > Can someone please help me with the following issue.
> > 
> > - conda-forge and homebrew-macos
> > 
> > ```
> >   `/bin/sh: ../../src/bin/./testcflags.sh: No such file or directory`
> > ```
> >   The following line seems to be a problem:
> > 
> > ```
> > +opt := $(shell export CC=$(CC) && ../../src/bin/./testcflags.sh $(opt))
> > ```


Where do you see this line?



---

archive/issue_comments_521650.json:
```json
{
    "body": "<a id='comment:36'></a>Oh, I see, you added this on the ticket. See #29381.",
    "created_at": "2020-03-31T15:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521650",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Oh, I see, you added this on the ticket. See #29381.



---

archive/issue_comments_521651.json:
```json
{
    "body": "<a id='comment:37'></a>Lots of the doctest failures that you reported can also be seen on 9.1.beta9 on these platforms. \nHelp with fixing them is very welcome.\nSee https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/5vDLmipuAwAJ",
    "created_at": "2020-03-31T15:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521651",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Lots of the doctest failures that you reported can also be seen on 9.1.beta9 on these platforms. 
Help with fixing them is very welcome.
See https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/5vDLmipuAwAJ



---

archive/issue_comments_521652.json:
```json
{
    "body": "Changing commit from \"301bd2c279991115c5702b1837118339360e8e86\" to \"2d1d7980c413afc1e5c6625c16b3bac99daa7463\"",
    "created_at": "2020-03-31T16:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521652",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "301bd2c279991115c5702b1837118339360e8e86" to "2d1d7980c413afc1e5c6625c16b3bac99daa7463"



---

archive/issue_comments_521653.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-31T16:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521654.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:36 mkoeppe]:\n> Oh, I see, you added this on the ticket. See #29381.\n\n\nThanks.\n\nWell, turns out I haven't tested anything new. Enabling `march=native` just failed everywhere and I retested the newest beta.",
    "created_at": "2020-03-31T16:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521654",
    "user": "https://github.com/kliem"
}
```

<a id='comment:39'></a>Replying to [comment:36 mkoeppe]:
> Oh, I see, you added this on the ticket. See #29381.


Thanks.

Well, turns out I haven't tested anything new. Enabling `march=native` just failed everywhere and I retested the newest beta.



---

archive/issue_comments_521655.json:
```json
{
    "body": "<a id='comment:40'></a>Seems to work now:\n\n[https://github.com/kliem/sage-test-27122/actions/runs/67557444](https://github.com/kliem/sage-test-27122/actions/runs/67557444)\n\nSome strange fail in (debian-bullseye, standard):\n\n```\ncp: cannot create directory '/sage/local/./lib/python3.7/site-packages/Cython/__pycache__': File exists\n```\nLooks somewhat like a racing condition to me. Given that it bullseye suceeds on minimal and standard-python2, I would say it's fine.\n\nOtherwise its the usual suspects (note that macos got cancelled due to timout):\n\n- sage -t src/sage/doctest/test.py  # 1 doctest failed\n- sage -t src/sage/graphs/digraph_generators.py  # 5 doctests failed\n\n  e.g. ubuntu-xenial, standard, might be related to #28958\n\n  seems to use system nauty: `configure: will use system package and not install SPKG nauty`\n- sage -t src/sage/interfaces/r.py  # 1 doctest failed #29471\n- sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed #29442\n- sage -t src/sage/lfunctions/dokchitser.py  # 2 doctests failed #29472\n- sage -t src/sage/lfunctions/pari.py  # 1 doctest failed #29472\n- sage -t src/sage/libs/eclib/interface.py  # 2 doctests failed #28943\n- sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed #29493\n- sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out #29440\n- sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed #29493\n- sage -t src/sage/rings/number_field/unit_group.py  # 1 doctest failed #29472\n- sage -t src/sage/rings/number_field/number_field_element.pyx  # Timed out #29472\n- sage -t src/sage/rings/number_field/number_field_ideal.py  # 2 doctests failed #29445 and #29472\n- sage -t src/sage/rings/number_field/number_field.py  # 8 doctests failed #29472\n- sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed #29272\n- sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed #29472\n- sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # 3 doctests failed #29472 (fixes 2 of them)\n- sage -t src/sage/schemes/elliptic_curves/height.py  # 6 doctests failed\n- sage -t src/sage/schemes/plane_conics/con_number_field.py  # 1 doctest failed\n- sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py  # 2 doctests failed #29494\n- sage -t src/sage/tests/cmdline.py  # 3 doctests failed #29092",
    "created_at": "2020-04-01T08:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521655",
    "user": "https://github.com/kliem"
}
```

<a id='comment:40'></a>Seems to work now:

[https://github.com/kliem/sage-test-27122/actions/runs/67557444](https://github.com/kliem/sage-test-27122/actions/runs/67557444)

Some strange fail in (debian-bullseye, standard):

```
cp: cannot create directory '/sage/local/./lib/python3.7/site-packages/Cython/__pycache__': File exists
```
Looks somewhat like a racing condition to me. Given that it bullseye suceeds on minimal and standard-python2, I would say it's fine.

Otherwise its the usual suspects (note that macos got cancelled due to timout):

- sage -t src/sage/doctest/test.py  # 1 doctest failed
- sage -t src/sage/graphs/digraph_generators.py  # 5 doctests failed

  e.g. ubuntu-xenial, standard, might be related to #28958

  seems to use system nauty: `configure: will use system package and not install SPKG nauty`
- sage -t src/sage/interfaces/r.py  # 1 doctest failed #29471
- sage -t src/sage/interfaces/tachyon.py  # 1 doctest failed #29442
- sage -t src/sage/lfunctions/dokchitser.py  # 2 doctests failed #29472
- sage -t src/sage/lfunctions/pari.py  # 1 doctest failed #29472
- sage -t src/sage/libs/eclib/interface.py  # 2 doctests failed #28943
- sage -t src/sage/libs/glpk/error.pyx  # 1 doctest failed #29493
- sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out #29440
- sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed #29493
- sage -t src/sage/rings/number_field/unit_group.py  # 1 doctest failed #29472
- sage -t src/sage/rings/number_field/number_field_element.pyx  # Timed out #29472
- sage -t src/sage/rings/number_field/number_field_ideal.py  # 2 doctests failed #29445 and #29472
- sage -t src/sage/rings/number_field/number_field.py  # 8 doctests failed #29472
- sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed #29272
- sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed #29472
- sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # 3 doctests failed #29472 (fixes 2 of them)
- sage -t src/sage/schemes/elliptic_curves/height.py  # 6 doctests failed
- sage -t src/sage/schemes/plane_conics/con_number_field.py  # 1 doctest failed
- sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py  # 2 doctests failed #29494
- sage -t src/sage/tests/cmdline.py  # 3 doctests failed #29092



---

archive/issue_comments_521656.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-04-01T08:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521656",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_521657.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,12 @@\n+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n+We use the `build/bin/testcflags.sh` script to check whether the toolchain will accept it. We do so in the makefile.\n+\n+Along the way we clean up sage's debug options. According to the documentation on building sage from source [https://doc.sagemath.org/html/en/installation/source.html](https://doc.sagemath.org/html/en/installation/source.html) reasonable default flags would be\n+- `-O2 -g` if `SAGE_DEBUG` is not set\n+- `-O2` if `SAGE_DEBUG=no` and\n+- `-O0 -g` if `SAGE_DEBUG=yes`.\n+At the moment, some packages do it that way, some don't (e.g. eclib always sets `-g` no matter what you do). There is also a lot of duplication, because every single package installer checks for `SAGE_DEBUG`.\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-04-03T13:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521657",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,12 @@
+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
+We use the `build/bin/testcflags.sh` script to check whether the toolchain will accept it. We do so in the makefile.
+
+Along the way we clean up sage's debug options. According to the documentation on building sage from source [https://doc.sagemath.org/html/en/installation/source.html](https://doc.sagemath.org/html/en/installation/source.html) reasonable default flags would be
+- `-O2 -g` if `SAGE_DEBUG` is not set
+- `-O2` if `SAGE_DEBUG=no` and
+- `-O0 -g` if `SAGE_DEBUG=yes`.
+At the moment, some packages do it that way, some don't (e.g. eclib always sets `-g` no matter what you do). There is also a lot of duplication, because every single package installer checks for `SAGE_DEBUG`.
 
 Comment: 1
 
``````




---

archive/issue_events_067367.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-04-24T08:05:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67367"
}
```



---

archive/issue_comments_521658.json:
```json
{
    "body": "<a id='comment:42'></a>Is this ticket anywhere near a positive review?\n\nIt would be nice to migrate my own implementation for bitsets for `CombinatorialPolyhedron` to the one in `data_structures/bitsets.pxi`. That would prevent a lot of code duplication for #29191. But I would only do this, if I can modify `data_structures/bitsets.pxi` such that it uses intrinsics.\n\nBut, enabling intrinsics without `-march=native` as default would mean that a lot of code is never really tested as many cases are very dependent on the specific architecture (see #27103).",
    "created_at": "2020-04-24T08:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521658",
    "user": "https://github.com/kliem"
}
```

<a id='comment:42'></a>Is this ticket anywhere near a positive review?

It would be nice to migrate my own implementation for bitsets for `CombinatorialPolyhedron` to the one in `data_structures/bitsets.pxi`. That would prevent a lot of code duplication for #29191. But I would only do this, if I can modify `data_structures/bitsets.pxi` such that it uses intrinsics.

But, enabling intrinsics without `-march=native` as default would mean that a lot of code is never really tested as many cases are very dependent on the specific architecture (see #27103).



---

archive/issue_comments_521659.json:
```json
{
    "body": "<a id='comment:43'></a>One problem with `-march=native` as default is that building binary packages with it is a bit hard (unless it is combined with settings for a low grade CPU).\n\nPerhaps, keeping it a non-default is more meaningful?",
    "created_at": "2020-04-24T11:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521659",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'></a>One problem with `-march=native` as default is that building binary packages with it is a bit hard (unless it is combined with settings for a low grade CPU).

Perhaps, keeping it a non-default is more meaningful?



---

archive/issue_comments_521660.json:
```json
{
    "body": "<a id='comment:44'></a>Isn't that what `SAGE_FAT_BINARY` is for?\n\nI just noticed that need to rebase.",
    "created_at": "2020-04-24T11:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521660",
    "user": "https://github.com/kliem"
}
```

<a id='comment:44'></a>Isn't that what `SAGE_FAT_BINARY` is for?

I just noticed that need to rebase.



---

archive/issue_comments_521661.json:
```json
{
    "body": "<a id='comment:45'></a>New commits:",
    "created_at": "2020-04-24T13:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521661",
    "user": "https://github.com/kliem"
}
```

<a id='comment:45'></a>New commits:



---

archive/issue_comments_521662.json:
```json
{
    "body": "Changing branch from \"public/27122-reb2\" to \"public/27122-reb3\"",
    "created_at": "2020-04-24T13:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521662",
    "user": "https://github.com/kliem"
}
```

Changing branch from "public/27122-reb2" to "public/27122-reb3"



---

archive/issue_comments_521663.json:
```json
{
    "body": "Changing commit from \"2d1d7980c413afc1e5c6625c16b3bac99daa7463\" to \"bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0\"",
    "created_at": "2020-04-24T13:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521663",
    "user": "https://github.com/kliem"
}
```

Changing commit from "2d1d7980c413afc1e5c6625c16b3bac99daa7463" to "bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0"



---

archive/issue_comments_521664.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-04-24T13:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521664",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_521665.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-24T13:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521665",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_521666.json:
```json
{
    "body": "<a id='comment:46'></a>Looks good to me and should be merged early in the 9.2 series",
    "created_at": "2020-04-24T13:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521666",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>Looks good to me and should be merged early in the 9.2 series



---

archive/issue_comments_521667.json:
```json
{
    "body": "<a id='comment:47'></a>Thanks.",
    "created_at": "2020-04-24T13:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521667",
    "user": "https://github.com/kliem"
}
```

<a id='comment:47'></a>Thanks.



---

archive/issue_comments_521668.json:
```json
{
    "body": "<a id='comment:48'></a>Looks like `@`vbraun is already merging it for 9.1.\n\nIn a test run for `ubuntu-trusty-minimal` (https://github.com/mkoeppe/sage/runs/617198833) I see a new error building gfortran:\n\n```\n/sage/local/var/tmp/sage/build/gfortran-9.2.0/gcc-build/./gcc/xgcc -B/sage/local/var/tmp/sage/build/gfortran-9.2.0/gcc-build/./gcc/ -B/sage/local/x86_64-pc-linux-gnu/bin/ -B/sage/local/x86_64-pc-linux-gnu/lib/ -isystem /sage/local/x86_64-pc-linux-gnu/include -isystem /sage/local/x86_64-pc-linux-gnu/sys-include    -O2 -g -march=native -O2  -O2 -g -march=native -DIN_GCC    -W -Wall -Wno-narrowing -Wwrite-strings -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -fpic -mlong-double-80 -DUSE_ELF_SYMVER  -g -DIN_LIBGCC2 -fbuilding-libgcc -fno-stack-protector   -fpic -mlong-double-80 -DUSE_ELF_SYMVER  -I. -I. -I../.././gcc -I../../../src/libgcc -I../../../src/libgcc/. -I../../../src/libgcc/../gcc -I../../../src/libgcc/../include -I../../../src/libgcc/config/libbid -DENABLE_DECIMAL_BID_FORMAT -DHAVE_CC_TLS  -DUSE_TLS -o _ffssi2_s.o -MT _ffssi2_s.o -MD -MP -MF _ffssi2_s.dep -DSHARED -DL_ffssi2 -c ../../../src/libgcc/libgcc2.c\n/tmp/ccjkcyn0.s: Assembler messages:\n/tmp/ccjkcyn0.s:3937: Error: no such instruction: `vmovdqu8 (%rcx),%xmm0'\n/tmp/ccjkcyn0.s:3939: Error: no such instruction: `vmovdqu8 -16(%rcx,%r8),%xmm1'\n/tmp/ccjkcyn0.s:6032: Error: operand size mismatch for `vmovdqa64'\n/tmp/ccjkcyn0.s:6033: Error: operand size mismatch for `vmovdqa64'\n/tmp/ccjkcyn0.s:6034: Error: operand size mismatch for `vmovdqa64'\n/tmp/ccjkcyn0.s:6035: Error: operand size mismatch for `vmovdqa64'\n/tmp/ccjkcyn0.s:6036: Error: operand size mismatch for `vmovdqa64'\n/tmp/ccjkcyn0.s:6037: Error: operand size mismatch for `vmovdqa64'\n```\n\nAlso #29575 (debian-jessie: fflas_ffpack again) is from that run.\n\nSo this may need some more work",
    "created_at": "2020-04-25T15:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521668",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'></a>Looks like `@`vbraun is already merging it for 9.1.

In a test run for `ubuntu-trusty-minimal` (https://github.com/mkoeppe/sage/runs/617198833) I see a new error building gfortran:

```
/sage/local/var/tmp/sage/build/gfortran-9.2.0/gcc-build/./gcc/xgcc -B/sage/local/var/tmp/sage/build/gfortran-9.2.0/gcc-build/./gcc/ -B/sage/local/x86_64-pc-linux-gnu/bin/ -B/sage/local/x86_64-pc-linux-gnu/lib/ -isystem /sage/local/x86_64-pc-linux-gnu/include -isystem /sage/local/x86_64-pc-linux-gnu/sys-include    -O2 -g -march=native -O2  -O2 -g -march=native -DIN_GCC    -W -Wall -Wno-narrowing -Wwrite-strings -Wcast-qual -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition  -isystem ./include   -fpic -mlong-double-80 -DUSE_ELF_SYMVER  -g -DIN_LIBGCC2 -fbuilding-libgcc -fno-stack-protector   -fpic -mlong-double-80 -DUSE_ELF_SYMVER  -I. -I. -I../.././gcc -I../../../src/libgcc -I../../../src/libgcc/. -I../../../src/libgcc/../gcc -I../../../src/libgcc/../include -I../../../src/libgcc/config/libbid -DENABLE_DECIMAL_BID_FORMAT -DHAVE_CC_TLS  -DUSE_TLS -o _ffssi2_s.o -MT _ffssi2_s.o -MD -MP -MF _ffssi2_s.dep -DSHARED -DL_ffssi2 -c ../../../src/libgcc/libgcc2.c
/tmp/ccjkcyn0.s: Assembler messages:
/tmp/ccjkcyn0.s:3937: Error: no such instruction: `vmovdqu8 (%rcx),%xmm0'
/tmp/ccjkcyn0.s:3939: Error: no such instruction: `vmovdqu8 -16(%rcx,%r8),%xmm1'
/tmp/ccjkcyn0.s:6032: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6033: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6034: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6035: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6036: Error: operand size mismatch for `vmovdqa64'
/tmp/ccjkcyn0.s:6037: Error: operand size mismatch for `vmovdqa64'
```

Also #29575 (debian-jessie: fflas_ffpack again) is from that run.

So this may need some more work



---

archive/issue_comments_521669.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-04-25T15:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521669",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_521670.json:
```json
{
    "body": "<a id='comment:50'></a>Also segfaults building dochtml with `ubuntu-bionic-standard` (https://github.com/mkoeppe/sage/runs/617198861)",
    "created_at": "2020-04-25T15:47:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521670",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>Also segfaults building dochtml with `ubuntu-bionic-standard` (https://github.com/mkoeppe/sage/runs/617198861)



---

archive/issue_comments_521671.json:
```json
{
    "body": "<a id='comment:52'></a>Also segfault on `linuxmint-19.3-minimal` (https://github.com/mkoeppe/sage/runs/617198994)\n\nDefinitely not ready for 9.1.",
    "created_at": "2020-04-25T15:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521671",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'></a>Also segfault on `linuxmint-19.3-minimal` (https://github.com/mkoeppe/sage/runs/617198994)

Definitely not ready for 9.1.



---

archive/issue_comments_521672.json:
```json
{
    "body": "<a id='comment:53'></a>Also breaks gfortran build on `cygwin-minimal` (https://github.com/mkoeppe/sage/runs/617198553)",
    "created_at": "2020-04-25T15:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521672",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:53'></a>Also breaks gfortran build on `cygwin-minimal` (https://github.com/mkoeppe/sage/runs/617198553)



---

archive/issue_events_067368.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-25T21:35:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67368"
}
```



---

archive/issue_comments_521673.json:
```json
{
    "body": "Changing branch from \"public/27122-reb3\" to \"bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0\"",
    "created_at": "2020-04-25T21:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521673",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/27122-reb3" to "bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0"



---

archive/issue_comments_521674.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-25T21:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521674",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_521675.json:
```json
{
    "body": "Changing commit from \"bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0\" to \"\"",
    "created_at": "2020-04-25T21:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521675",
    "user": "https://github.com/vbraun"
}
```

Changing commit from "bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0" to ""



---

archive/issue_comments_521676.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2020-04-25T21:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521676",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_067369.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-25T21:36:03Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67369"
}
```



---

archive/issue_comments_521677.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2020-04-25T21:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521677",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_521678.json:
```json
{
    "body": "Changing commit from \"\" to \"bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0\"",
    "created_at": "2020-04-25T21:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521678",
    "user": "https://github.com/kliem"
}
```

Changing commit from "" to "bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0"



---

archive/issue_comments_521679.json:
```json
{
    "body": "Changing branch from \"bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0\" to \"public/27122-reb3\"",
    "created_at": "2020-04-25T21:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521679",
    "user": "https://github.com/kliem"
}
```

Changing branch from "bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0" to "public/27122-reb3"



---

archive/issue_comments_521680.json:
```json
{
    "body": "<a id='comment:56'></a>New commits:",
    "created_at": "2020-04-25T21:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521680",
    "user": "https://github.com/kliem"
}
```

<a id='comment:56'></a>New commits:



---

archive/issue_comments_521681.json:
```json
{
    "body": "<a id='comment:57'></a>What I'm getting from the failures above is the following:\n\nDon't use `-march=native` as a default for gfortran and and python.\n\nRequire gcc at least 5.1 in addition to the checks here (this was my first approach, I don't find the bug anymore that caused me to think we need at least version 5.1, but certainly 4.9.2 isn't working for us).",
    "created_at": "2020-04-25T22:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521681",
    "user": "https://github.com/kliem"
}
```

<a id='comment:57'></a>What I'm getting from the failures above is the following:

Don't use `-march=native` as a default for gfortran and and python.

Require gcc at least 5.1 in addition to the checks here (this was my first approach, I don't find the bug anymore that caused me to think we need at least version 5.1, but certainly 4.9.2 isn't working for us).



---

archive/issue_comments_521682.json:
```json
{
    "body": "<a id='comment:58'></a>This change is broken (empty then clause)\n\n```\ndiff --git a/build/pkgs/pari/spkg-check.in b/build/pkgs/pari/spkg-check.in\nindex ae3aecb..a353b0e 100644\n--- a/build/pkgs/pari/spkg-check.in\n+++ b/build/pkgs/pari/spkg-check.in\n@@ -3,10 +3,8 @@\n ###########################################\n \n if [ \"x$SAGE_DEBUG\" = xyes ] ; then\n-    CFLAGS=\"$CFLAGS -O0 -g\" # Disable optimisation, add debug symbols. Good\n-                            # for debugging or working around compiler bugs.\n else\n-    CFLAGS=\"-O3 -g $CFLAGS\" # Default optimisation, with debug symbols.\n+    CFLAGS=\"-O3 $CFLAGS\" # Default optimisation, with debug symbols.\n                             # Prepend to not override user's setting.\n fi\n \n```\nReported by vbraun at #29589",
    "created_at": "2020-04-26T18:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521682",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>This change is broken (empty then clause)

```
diff --git a/build/pkgs/pari/spkg-check.in b/build/pkgs/pari/spkg-check.in
index ae3aecb..a353b0e 100644
--- a/build/pkgs/pari/spkg-check.in
+++ b/build/pkgs/pari/spkg-check.in
@@ -3,10 +3,8 @@
 ###########################################
 
 if [ "x$SAGE_DEBUG" = xyes ] ; then
-    CFLAGS="$CFLAGS -O0 -g" # Disable optimisation, add debug symbols. Good
-                            # for debugging or working around compiler bugs.
 else
-    CFLAGS="-O3 -g $CFLAGS" # Default optimisation, with debug symbols.
+    CFLAGS="-O3 $CFLAGS" # Default optimisation, with debug symbols.
                             # Prepend to not override user's setting.
 fi
 
```
Reported by vbraun at #29589



---

archive/issue_comments_521683.json:
```json
{
    "body": "<a id='comment:59'></a>Replying to [comment:52 mkoeppe]:\n> Also segfault on `linuxmint-19.3-minimal` (https://github.com/mkoeppe/sage/runs/617198994)\n> \n> Definitely not ready for 9.1.\n\n\nThis appears to be #28800. I'm currently using the original settings for\n- pari (to fix this segemtation fault),\n- fflas_ffpack,\n- gfortran.\n\nI'll push something, once I have more luck.",
    "created_at": "2020-04-27T09:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521683",
    "user": "https://github.com/kliem"
}
```

<a id='comment:59'></a>Replying to [comment:52 mkoeppe]:
> Also segfault on `linuxmint-19.3-minimal` (https://github.com/mkoeppe/sage/runs/617198994)
> 
> Definitely not ready for 9.1.


This appears to be #28800. I'm currently using the original settings for
- pari (to fix this segemtation fault),
- fflas_ffpack,
- gfortran.

I'll push something, once I have more luck.



---

archive/issue_comments_521684.json:
```json
{
    "body": "Changing commit from \"bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0\" to \"a04ca1e95e6af5f55e59be2832710eab5cd52c6b\"",
    "created_at": "2020-04-27T15:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521684",
    "user": "https://github.com/kliem"
}
```

Changing commit from "bc6f7c1cf87e806b9f5ea1478bff0a2fc4cf23e0" to "a04ca1e95e6af5f55e59be2832710eab5cd52c6b"



---

archive/issue_comments_521685.json:
```json
{
    "body": "Changing branch from \"public/27122-reb3\" to \"public/27122-reb4\"",
    "created_at": "2020-04-27T15:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521685",
    "user": "https://github.com/kliem"
}
```

Changing branch from "public/27122-reb3" to "public/27122-reb4"



---

archive/issue_comments_521686.json:
```json
{
    "body": "<a id='comment:60'></a>New commits:",
    "created_at": "2020-04-27T15:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521686",
    "user": "https://github.com/kliem"
}
```

<a id='comment:60'></a>New commits:



---

archive/issue_comments_521687.json:
```json
{
    "body": "<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-27T15:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521687",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521688.json:
```json
{
    "body": "Changing commit from \"a04ca1e95e6af5f55e59be2832710eab5cd52c6b\" to \"072e7e05ab233095c95bdbfb54b5bd984cc378d6\"",
    "created_at": "2020-04-27T15:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521688",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a04ca1e95e6af5f55e59be2832710eab5cd52c6b" to "072e7e05ab233095c95bdbfb54b5bd984cc378d6"



---

archive/issue_comments_521689.json:
```json
{
    "body": "<a id='comment:62'></a>It seems that my approaches for disabling `-march=native` for certain packages don't work.\n\nFor ubuntu-trusty it tried to compile `gfortran` with `-march=native`, but I tried to disable that.\n\nhttps://github.com/kliem/sage-test-27122/runs/622914460?check_suite_focus=true\n\nFor linuxmint-19, python 2 I'm still getting the segmentation fault when building the documentation. So I'm suspecting that `pari` was build with `-march=native` against my wishes.\n\nhttps://github.com/kliem/sage-test-27122/runs/622915243?check_suite_focus=true\n\nI can keep on trying, but maybe someone that understands those scripts better than me finds a mistake. I would appreciate that.",
    "created_at": "2020-04-28T06:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521689",
    "user": "https://github.com/kliem"
}
```

<a id='comment:62'></a>It seems that my approaches for disabling `-march=native` for certain packages don't work.

For ubuntu-trusty it tried to compile `gfortran` with `-march=native`, but I tried to disable that.

https://github.com/kliem/sage-test-27122/runs/622914460?check_suite_focus=true

For linuxmint-19, python 2 I'm still getting the segmentation fault when building the documentation. So I'm suspecting that `pari` was build with `-march=native` against my wishes.

https://github.com/kliem/sage-test-27122/runs/622915243?check_suite_focus=true

I can keep on trying, but maybe someone that understands those scripts better than me finds a mistake. I would appreciate that.



---

archive/issue_comments_521690.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-04-28T06:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521690",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_521691.json:
```json
{
    "body": "Changing commit from \"072e7e05ab233095c95bdbfb54b5bd984cc378d6\" to \"31db2e54c451c44b18234cfe839d5c6799e0922a\"",
    "created_at": "2020-04-29T08:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521691",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "072e7e05ab233095c95bdbfb54b5bd984cc378d6" to "31db2e54c451c44b18234cfe839d5c6799e0922a"



---

archive/issue_comments_521692.json:
```json
{
    "body": "<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-29T08:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521692",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521693.json:
```json
{
    "body": "<a id='comment:64'></a>Turns out my makefile syntax was completely wrong. But I think I got it figured out now and it should correctly determine the gcc version (and check correctly `SAGE_DEBUG` and `SAGE_FAT_BINARY`).\n\n`@`embray: As you wrote a workaround that fixes segmentation faults when building the documentation in #28356, maybe you have an educated guess, which package might be causing the following problem. Currently I disable `-march=native` for the following:\n- pari\n- cypari\n- pari_jupyter\n- fflas_ffpack\n- gfortran\n- gcc (I'm not sure if `gcc/build_gcc` will do that, it seemed to help the gfortran issue however)\n- linbox\n\n```\n[combinat ] building [inventory]: targets for 368 source files that are out of date\n[combinat ] updating environment: 368 added, 0 changed, 0 removed\nError building the documentation.\nTraceback (most recent call last):\n  File \"/sage/local/lib/python3.7/runpy.py\", line 193, in _run_module_as_main\n    \"__main__\", mod_spec)\n  File \"/sage/local/lib/python3.7/runpy.py\", line 85, in _run_code\n    exec(code, run_globals)\n  File \"/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 1720, in main\n    builder()\n  File \"/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 327, in _wrapper\n    getattr(get_builder(document), 'inventory')(*args, **kwds)\n  File \"/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 552, in _wrapper\n    self._build_everything_except_bibliography(lang, format, *args, **kwds)\n  File \"/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 538, in _build_everything_except_bibliography\n    build_many(build_ref_doc, non_references)\n  File \"/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 280, in build_many\n    _build_many(target, args, processes=NUM_THREADS)\n  File \"/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/utils.py\", line 283, in build_many\n    raise worker_exc.original_exception\nException: ('Non-exception during docbuild: Segmentation fault', SignalError('Segmentation fault'))\n```\n\n`@`all: Is there a way to obtain a meaningful backtrace? Antonio Rojas stated that he downgraded sage to obtain that. But that is not really an option here. \nhttps://groups.google.com/d/msg/sage-packaging/VU4h8IWGFLA/rU-8NCPjBgAJ",
    "created_at": "2020-04-29T08:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521693",
    "user": "https://github.com/kliem"
}
```

<a id='comment:64'></a>Turns out my makefile syntax was completely wrong. But I think I got it figured out now and it should correctly determine the gcc version (and check correctly `SAGE_DEBUG` and `SAGE_FAT_BINARY`).

`@`embray: As you wrote a workaround that fixes segmentation faults when building the documentation in #28356, maybe you have an educated guess, which package might be causing the following problem. Currently I disable `-march=native` for the following:
- pari
- cypari
- pari_jupyter
- fflas_ffpack
- gfortran
- gcc (I'm not sure if `gcc/build_gcc` will do that, it seemed to help the gfortran issue however)
- linbox

```
[combinat ] building [inventory]: targets for 368 source files that are out of date
[combinat ] updating environment: 368 added, 0 changed, 0 removed
Error building the documentation.
Traceback (most recent call last):
  File "/sage/local/lib/python3.7/runpy.py", line 193, in _run_module_as_main
    "__main__", mod_spec)
  File "/sage/local/lib/python3.7/runpy.py", line 85, in _run_code
    exec(code, run_globals)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 1720, in main
    builder()
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 327, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 552, in _wrapper
    self._build_everything_except_bibliography(lang, format, *args, **kwds)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 538, in _build_everything_except_bibliography
    build_many(build_ref_doc, non_references)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 280, in build_many
    _build_many(target, args, processes=NUM_THREADS)
  File "/sage/local/lib/python3.7/site-packages/sage_setup/docbuild/utils.py", line 283, in build_many
    raise worker_exc.original_exception
Exception: ('Non-exception during docbuild: Segmentation fault', SignalError('Segmentation fault'))
```

`@`all: Is there a way to obtain a meaningful backtrace? Antonio Rojas stated that he downgraded sage to obtain that. But that is not really an option here. 
https://groups.google.com/d/msg/sage-packaging/VU4h8IWGFLA/rU-8NCPjBgAJ



---

archive/issue_comments_521694.json:
```json
{
    "body": "<a id='comment:65'></a>I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY",
    "created_at": "2020-05-13T22:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521694",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:65'></a>I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY



---

archive/issue_comments_521695.json:
```json
{
    "body": "<a id='comment:66'></a>likewise for SAGE_DEBUG",
    "created_at": "2020-05-13T22:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521695",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:66'></a>likewise for SAGE_DEBUG



---

archive/issue_comments_521696.json:
```json
{
    "body": "<a id='comment:67'></a>Yes, I also realized that.\n\nWhen I was looking for which flags the packages where using, I always looked into the configure file, because that's the place where it belongs to :-) It took me a while to realize that I'm doing it wrong then.",
    "created_at": "2020-05-14T07:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521696",
    "user": "https://github.com/kliem"
}
```

<a id='comment:67'></a>Yes, I also realized that.

When I was looking for which flags the packages where using, I always looked into the configure file, because that's the place where it belongs to :-) It took me a while to realize that I'm doing it wrong then.



---

archive/issue_comments_521697.json:
```json
{
    "body": "<a id='comment:68'></a>Sorry, haven't read through all the discussion, so apologies if this already came up. The gcc manpage recommends `-Og -g` to \"Optimize debugging experience\" over `-O0` and the resulting code runs much faster.",
    "created_at": "2020-05-27T14:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521697",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:68'></a>Sorry, haven't read through all the discussion, so apologies if this already came up. The gcc manpage recommends `-Og -g` to "Optimize debugging experience" over `-O0` and the resulting code runs much faster.



---

archive/issue_comments_521698.json:
```json
{
    "body": "<a id='comment:69'></a>New try. Do it in `configure.ac` now, this is where it belongs I think. I will most likely have all the old problems again.\n\n---\nNew commits:",
    "created_at": "2020-06-15T13:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521698",
    "user": "https://github.com/kliem"
}
```

<a id='comment:69'></a>New try. Do it in `configure.ac` now, this is where it belongs I think. I will most likely have all the old problems again.

---
New commits:



---

archive/issue_comments_521699.json:
```json
{
    "body": "Changing commit from \"31db2e54c451c44b18234cfe839d5c6799e0922a\" to \"f63aa174447b9b214fae82eb26727ddbea25f5b5\"",
    "created_at": "2020-06-15T13:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521699",
    "user": "https://github.com/kliem"
}
```

Changing commit from "31db2e54c451c44b18234cfe839d5c6799e0922a" to "f63aa174447b9b214fae82eb26727ddbea25f5b5"



---

archive/issue_comments_521700.json:
```json
{
    "body": "Changing branch from \"public/27122-reb4\" to \"u/gh-kliem/march_native_in_configure\"",
    "created_at": "2020-06-15T13:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521700",
    "user": "https://github.com/kliem"
}
```

Changing branch from "public/27122-reb4" to "u/gh-kliem/march_native_in_configure"



---

archive/issue_comments_521701.json:
```json
{
    "body": "<a id='comment:70'></a>Replying to [comment:65 mkoeppe]:\n> I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY\n\n\nWhat kind of options should I add for this?\n\nSomething like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.",
    "created_at": "2020-06-15T13:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521701",
    "user": "https://github.com/kliem"
}
```

<a id='comment:70'></a>Replying to [comment:65 mkoeppe]:
> I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY


What kind of options should I add for this?

Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.



---

archive/issue_comments_521702.json:
```json
{
    "body": "<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-15T13:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521702",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521703.json:
```json
{
    "body": "Changing commit from \"f63aa174447b9b214fae82eb26727ddbea25f5b5\" to \"6e407f7b89dc1017a036edd466e81bc37d0ae91c\"",
    "created_at": "2020-06-15T13:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521703",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f63aa174447b9b214fae82eb26727ddbea25f5b5" to "6e407f7b89dc1017a036edd466e81bc37d0ae91c"



---

archive/issue_comments_521704.json:
```json
{
    "body": "<a id='comment:72'></a>we configure compilers mostly in `build/pkgs/{gcc,gfortran}/spkg-configure.m4` - could you perhaps move (most of) your changes to `configure.ac` there?",
    "created_at": "2020-06-15T13:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521704",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:72'></a>we configure compilers mostly in `build/pkgs/{gcc,gfortran}/spkg-configure.m4` - could you perhaps move (most of) your changes to `configure.ac` there?



---

archive/issue_comments_521705.json:
```json
{
    "body": "<a id='comment:73'></a>I don't think this is where it belongs. I'm setting flags for building any package.\n\nThis is usually done in `configure.ac` and is so already. If you don't set `CFLAGS` then `AC_PROG_CC()` will set `CFLAGS` to `-g -02` (or different order).",
    "created_at": "2020-06-15T13:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521705",
    "user": "https://github.com/kliem"
}
```

<a id='comment:73'></a>I don't think this is where it belongs. I'm setting flags for building any package.

This is usually done in `configure.ac` and is so already. If you don't set `CFLAGS` then `AC_PROG_CC()` will set `CFLAGS` to `-g -02` (or different order).



---

archive/issue_comments_521706.json:
```json
{
    "body": "<a id='comment:74'></a>Replying to [comment:73 gh-kliem]:\n> I don't think this is where it belongs. I'm setting flags for building any package.\n\n\nsure, you are setting compilers' flags, and this is done in the files I pointed to.\nE.g. in `build/pkgs/gcc/spkg-configure.m4` we have\n\n```\n    # Modify CXX to include an option that enables C++11 support if necessary\n    AX_CXX_COMPILE_STDCXX_11([], optional)\n```\nwhich adds if needed something to `CXXFLAGS`, etc.\n\n\n> \n> This is usually done in `configure.ac` and is so already. If you don't set `CFLAGS` then `AC_PROG_CC()` will set `CFLAGS` to `-g -02` (or different order).\n\n\nAC_PROG_CC only is called early in `configure.ac` to ensure general sanity.\nAs you might know, `build/pkgs/*/spkg-configure.m4` are collected by `./boostrap` and used to\ngenerate `./configure` from them and `configure.ac`. We have moved a lot of compiler-specific stuff into  `build/pkgs/*/spkg-configure.m4` when the latter were instroduced, and for a good reason.",
    "created_at": "2020-06-15T14:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521706",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:74'></a>Replying to [comment:73 gh-kliem]:
> I don't think this is where it belongs. I'm setting flags for building any package.


sure, you are setting compilers' flags, and this is done in the files I pointed to.
E.g. in `build/pkgs/gcc/spkg-configure.m4` we have

```
    # Modify CXX to include an option that enables C++11 support if necessary
    AX_CXX_COMPILE_STDCXX_11([], optional)
```
which adds if needed something to `CXXFLAGS`, etc.


> 
> This is usually done in `configure.ac` and is so already. If you don't set `CFLAGS` then `AC_PROG_CC()` will set `CFLAGS` to `-g -02` (or different order).


AC_PROG_CC only is called early in `configure.ac` to ensure general sanity.
As you might know, `build/pkgs/*/spkg-configure.m4` are collected by `./boostrap` and used to
generate `./configure` from them and `configure.ac`. We have moved a lot of compiler-specific stuff into  `build/pkgs/*/spkg-configure.m4` when the latter were instroduced, and for a good reason.



---

archive/issue_comments_521707.json:
```json
{
    "body": "<a id='comment:75'></a>Replying to [comment:70 gh-kliem]:\n> Replying to [comment:65 mkoeppe]:\n> > I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY\n\n> \n> What kind of options should I add for this?\n> \n> Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.\n\n\nWhat I meant by this was for the top-level configure to have an option `--enable-fat-binary` (or perhaps a better name for that) so that this is not controlled by an environment variable.",
    "created_at": "2020-06-15T14:20:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521707",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:75'></a>Replying to [comment:70 gh-kliem]:
> Replying to [comment:65 mkoeppe]:
> > I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY

> 
> What kind of options should I add for this?
> 
> Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.


What I meant by this was for the top-level configure to have an option `--enable-fat-binary` (or perhaps a better name for that) so that this is not controlled by an environment variable.



---

archive/issue_comments_521708.json:
```json
{
    "body": "Changing commit from \"6e407f7b89dc1017a036edd466e81bc37d0ae91c\" to \"6ba54119a79ce724cccdc3d48c0661d1d7320af8\"",
    "created_at": "2020-06-15T15:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521708",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6e407f7b89dc1017a036edd466e81bc37d0ae91c" to "6ba54119a79ce724cccdc3d48c0661d1d7320af8"



---

archive/issue_comments_521709.json:
```json
{
    "body": "<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-15T15:06:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521709",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521710.json:
```json
{
    "body": "<a id='comment:77'></a>Replying to [comment:75 mkoeppe]:\n> Replying to [comment:70 gh-kliem]:\n> > Replying to [comment:65 mkoeppe]:\n> > > I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY\n\n> > \n> > What kind of options should I add for this?\n> > \n> > Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.\n\n> \n> What I meant by this was for the top-level configure to have an option `--enable-fat-binary` (or perhaps a better name for that) so that this is not controlled by an environment variable.\n\n\nYes this should make things easier.",
    "created_at": "2020-06-15T15:07:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521710",
    "user": "https://github.com/kliem"
}
```

<a id='comment:77'></a>Replying to [comment:75 mkoeppe]:
> Replying to [comment:70 gh-kliem]:
> > Replying to [comment:65 mkoeppe]:
> > > I think determining flags should really be done in `configure`. Also let's add configure options for enabling SAGE_FAT_BINARY

> > 
> > What kind of options should I add for this?
> > 
> > Something like `--disable-sse --disable-sse2 --disable-sse3 --disable-ssse3 --disable-sse41 --disable-sse42 --disable-fma --disable-fma4 --disable-avx --disable-avx2`? However, I'm not sure that this will be used anywhere.

> 
> What I meant by this was for the top-level configure to have an option `--enable-fat-binary` (or perhaps a better name for that) so that this is not controlled by an environment variable.


Yes this should make things easier.



---

archive/issue_comments_521711.json:
```json
{
    "body": "<a id='comment:78'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-16T05:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521711",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:78'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521712.json:
```json
{
    "body": "Changing commit from \"6ba54119a79ce724cccdc3d48c0661d1d7320af8\" to \"a6b93f261b30adfdb37d8867dbb05e0713e32d8d\"",
    "created_at": "2020-06-16T05:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521712",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6ba54119a79ce724cccdc3d48c0661d1d7320af8" to "a6b93f261b30adfdb37d8867dbb05e0713e32d8d"



---

archive/issue_comments_521713.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-06-17T21:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521713",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_521714.json:
```json
{
    "body": "<a id='comment:79'></a>It seems that with the new approach things have improved. Or maybe some work has been done somewhere else.\n\n- tox.ini:\n\n  looks the same to me (new failure to push docker image for debian-jessie):\n\n  beta1: https://github.com/sagemath/sage/actions/runs/134966983\n\n  #27122: https://github.com/kliem/sage/actions/runs/136808684\n\n- optional:\n\n  no new failure (although tests aren't all the way done yet)\n\n  beta1: https://github.com/sagemath/sage/actions/runs/134966981\n\n  #27122: https://github.com/kliem/sage/actions/runs/136808682 \n\n- `gcc_spkg`:\n\n  some tests take half an hour longer, but I don't know if that has any say\n\n  beta1: https://github.com/sagemath/sage/actions/runs/134966986\n\n  #27122: https://github.com/kliem/sage/actions/runs/136808677\n\n- cygwin-standard:\n\n  looks the same to me:\n\n  beta1: https://github.com/sagemath/sage/actions/runs/134966985\n\n  #27122: https://github.com/kliem/sage/actions/runs/136808676\n\n- cygwin-minimal:\n\n  looks the same to me:\n\n  beta1: https://github.com/sagemath/sage/actions/runs/134966984\n\n  https://github.com/kliem/sage/actions/runs/136808673",
    "created_at": "2020-06-17T21:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521714",
    "user": "https://github.com/kliem"
}
```

<a id='comment:79'></a>It seems that with the new approach things have improved. Or maybe some work has been done somewhere else.

- tox.ini:

  looks the same to me (new failure to push docker image for debian-jessie):

  beta1: https://github.com/sagemath/sage/actions/runs/134966983

  #27122: https://github.com/kliem/sage/actions/runs/136808684

- optional:

  no new failure (although tests aren't all the way done yet)

  beta1: https://github.com/sagemath/sage/actions/runs/134966981

  #27122: https://github.com/kliem/sage/actions/runs/136808682 

- `gcc_spkg`:

  some tests take half an hour longer, but I don't know if that has any say

  beta1: https://github.com/sagemath/sage/actions/runs/134966986

  #27122: https://github.com/kliem/sage/actions/runs/136808677

- cygwin-standard:

  looks the same to me:

  beta1: https://github.com/sagemath/sage/actions/runs/134966985

  #27122: https://github.com/kliem/sage/actions/runs/136808676

- cygwin-minimal:

  looks the same to me:

  beta1: https://github.com/sagemath/sage/actions/runs/134966984

  https://github.com/kliem/sage/actions/runs/136808673



---

archive/issue_comments_521715.json:
```json
{
    "body": "<a id='comment:80'></a>Never mind. The environment variables `CFLAGS` never made it from `configure.ac` to anywhere else.\n\nI'm trying to figure out, who to do this. Any help welcome.",
    "created_at": "2020-06-17T22:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521715",
    "user": "https://github.com/kliem"
}
```

<a id='comment:80'></a>Never mind. The environment variables `CFLAGS` never made it from `configure.ac` to anywhere else.

I'm trying to figure out, who to do this. Any help welcome.



---

archive/issue_comments_521716.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-06-17T22:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521716",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_521717.json:
```json
{
    "body": "<a id='comment:81'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-17T22:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521717",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:81'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521718.json:
```json
{
    "body": "Changing commit from \"a6b93f261b30adfdb37d8867dbb05e0713e32d8d\" to \"c225c7ed5260b64dce8748c9aa92502874f2cd39\"",
    "created_at": "2020-06-17T22:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521718",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a6b93f261b30adfdb37d8867dbb05e0713e32d8d" to "c225c7ed5260b64dce8748c9aa92502874f2cd39"



---

archive/issue_comments_521719.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2020-06-17T22:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521719",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_521720.json:
```json
{
    "body": "<a id='comment:82'></a>I think I found the correct place.\n\nNow it's probably going to fail on certain machines again.",
    "created_at": "2020-06-17T22:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521720",
    "user": "https://github.com/kliem"
}
```

<a id='comment:82'></a>I think I found the correct place.

Now it's probably going to fail on certain machines again.



---

archive/issue_comments_521721.json:
```json
{
    "body": "<a id='comment:83'></a>once again, settings of gcc flags are not to be done in `configure.ac` - as I explained, we already have all of them we currently set, set in `build/pkgs/{gcc,gfortran}/spkg-configure.m4`\n\nPlease move them accordingly, or if you have problem doing that, I can help, but doing compiler settings in two different places is verboden.",
    "created_at": "2020-06-18T13:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521721",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:83'></a>once again, settings of gcc flags are not to be done in `configure.ac` - as I explained, we already have all of them we currently set, set in `build/pkgs/{gcc,gfortran}/spkg-configure.m4`

Please move them accordingly, or if you have problem doing that, I can help, but doing compiler settings in two different places is verboden.



---

archive/issue_comments_521722.json:
```json
{
    "body": "<a id='comment:84'></a>Well, `configure.ac` runs `AC_PROG_CC()`, which sets `CFLAGS` to `-g -O2` if not set, so we must grep the user `CFLAGS` in `configure.ac` (it was already pointed out above that user input `CFLAGS` should not be overridden unless necessary).\n\nIf I get this right, `configure.ac` just barely checks if there is anything that can be used to at least build gcc. In `gcc` we futher analyse what the user has and figure out, whether this suffices.\n\nI agree that it makes sense to figure out the flags there as we are doing all those case distinctions already (what compiler are you etc, can you compile a basic file etc.). I'll take care of it soon, but not today (as for testing it shouldn't really make a difference, there are many open problems with this).",
    "created_at": "2020-06-18T18:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521722",
    "user": "https://github.com/kliem"
}
```

<a id='comment:84'></a>Well, `configure.ac` runs `AC_PROG_CC()`, which sets `CFLAGS` to `-g -O2` if not set, so we must grep the user `CFLAGS` in `configure.ac` (it was already pointed out above that user input `CFLAGS` should not be overridden unless necessary).

If I get this right, `configure.ac` just barely checks if there is anything that can be used to at least build gcc. In `gcc` we futher analyse what the user has and figure out, whether this suffices.

I agree that it makes sense to figure out the flags there as we are doing all those case distinctions already (what compiler are you etc, can you compile a basic file etc.). I'll take care of it soon, but not today (as for testing it shouldn't really make a difference, there are many open problems with this).



---

archive/issue_comments_521723.json:
```json
{
    "body": "<a id='comment:85'></a>I think `AC_PROG_CC` etc can be moved to gcc/gfortran's `spkg-configure.m4`",
    "created_at": "2020-06-18T23:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521723",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:85'></a>I think `AC_PROG_CC` etc can be moved to gcc/gfortran's `spkg-configure.m4`



---

archive/issue_comments_521724.json:
```json
{
    "body": "<a id='comment:86'></a>Replying to [comment:85 dimpase]:\n> I think `AC_PROG_CC` etc can be moved to gcc/gfortran's `spkg-configure.m4`\n\n\nI did a very quick check, applying\n\n```diff\n--- a/configure.ac\n+++ b/configure.ac\n@@ -308,6 +308,7 @@ AX_PROG_PERL_VERSION([5.8.0],[],[\n # Check C/C++/Fortran compilers\n ###############################################################################\n \n+SAGE_SPKG_COLLECT()\n SAGE_CHECK_CONDA_COMPILERS\n \n AC_PROG_CC()\n@@ -412,7 +413,6 @@ AS_IF([test \"x$enable_download_from_upstream_url\" = \"xyes\"], [\n ])\n AC_SUBST([SAGE_SPKG_OPTIONS])\n \n-SAGE_SPKG_COLLECT()\n \n # We need sage-env-config to exist before running this.\n # TODO: fix this in Trac #21524\n```\nand everything still seemed to be working. This means that we can move all these `AC_PROG_*()`\n(perhaps using `AC_REQUIRE()`) to respective `build/pkgs/*/*.m4` files.\n\nIf you could try this during the refactoring you're planning to do, it'd be great.",
    "created_at": "2020-06-19T10:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521724",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:86'></a>Replying to [comment:85 dimpase]:
> I think `AC_PROG_CC` etc can be moved to gcc/gfortran's `spkg-configure.m4`


I did a very quick check, applying

```diff
--- a/configure.ac
+++ b/configure.ac
@@ -308,6 +308,7 @@ AX_PROG_PERL_VERSION([5.8.0],[],[
 # Check C/C++/Fortran compilers
 ###############################################################################
 
+SAGE_SPKG_COLLECT()
 SAGE_CHECK_CONDA_COMPILERS
 
 AC_PROG_CC()
@@ -412,7 +413,6 @@ AS_IF([test "x$enable_download_from_upstream_url" = "xyes"], [
 ])
 AC_SUBST([SAGE_SPKG_OPTIONS])
 
-SAGE_SPKG_COLLECT()
 
 # We need sage-env-config to exist before running this.
 # TODO: fix this in Trac #21524
```
and everything still seemed to be working. This means that we can move all these `AC_PROG_*()`
(perhaps using `AC_REQUIRE()`) to respective `build/pkgs/*/*.m4` files.

If you could try this during the refactoring you're planning to do, it'd be great.



---

archive/issue_comments_521725.json:
```json
{
    "body": "Changing commit from \"c225c7ed5260b64dce8748c9aa92502874f2cd39\" to \"4596c4bcb5e9132c4e627edd8081ed139b22e613\"",
    "created_at": "2020-06-20T05:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521725",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c225c7ed5260b64dce8748c9aa92502874f2cd39" to "4596c4bcb5e9132c4e627edd8081ed139b22e613"



---

archive/issue_comments_521726.json:
```json
{
    "body": "<a id='comment:87'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-20T05:36:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521726",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:87'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521727.json:
```json
{
    "body": "<a id='comment:88'></a>And back to the old problems again.\n\nhttps://github.com/kliem/sage/actions/runs/140694723\n\nThere are sementation faults when building the documentation e.g. in ubuntu bionic.\n\nHowever, I disabled `march=native` for pari and all packages depending on `pari` and that still didn't seem to fix the issue (according to the logs this seemed to work).\n\nSomething isn't thread safe from above probably as in #28800. I have no clue, about that and I'm left with disabling `march=native` for random packages and hoping that I have luck.\n\nOr does anyone know how to get a meaningful log of the documentation build?",
    "created_at": "2020-06-20T05:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521727",
    "user": "https://github.com/kliem"
}
```

<a id='comment:88'></a>And back to the old problems again.

https://github.com/kliem/sage/actions/runs/140694723

There are sementation faults when building the documentation e.g. in ubuntu bionic.

However, I disabled `march=native` for pari and all packages depending on `pari` and that still didn't seem to fix the issue (according to the logs this seemed to work).

Something isn't thread safe from above probably as in #28800. I have no clue, about that and I'm left with disabling `march=native` for random packages and hoping that I have luck.

Or does anyone know how to get a meaningful log of the documentation build?



---

archive/issue_comments_521728.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2020-06-20T05:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521728",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_521729.json:
```json
{
    "body": "<a id='comment:89'></a>One thing one could do, is to not build the documentation and hope that the problem shows up during the doctests.",
    "created_at": "2020-06-20T05:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521729",
    "user": "https://github.com/kliem"
}
```

<a id='comment:89'></a>One thing one could do, is to not build the documentation and hope that the problem shows up during the doctests.



---

archive/issue_comments_521730.json:
```json
{
    "body": "<a id='comment:90'></a>permutahedron. Looks like stuff linked to cddlib, it says so in the code. I don't remember cddlib to be so sensitive to optimisation. Heck, I use `-march=native` in my sage-on-gentoo builds and I am fine.\nBut `pari` is definitely sensitive to optimisation. When I was working on enabling clang, I also tried the Intel compiler. `pari` needed to be compiled at `-O0` with it. Any optimisation with icc would break it. That was the only package that I remember with that issue.",
    "created_at": "2020-06-20T05:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521730",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:90'></a>permutahedron. Looks like stuff linked to cddlib, it says so in the code. I don't remember cddlib to be so sensitive to optimisation. Heck, I use `-march=native` in my sage-on-gentoo builds and I am fine.
But `pari` is definitely sensitive to optimisation. When I was working on enabling clang, I also tried the Intel compiler. `pari` needed to be compiled at `-O0` with it. Any optimisation with icc would break it. That was the only package that I remember with that issue.



---

archive/issue_comments_521731.json:
```json
{
    "body": "<a id='comment:91'></a>Thanks. I'm going through the packages now. It might have been `lcalc` after all though. Turns out it also uses `CFLAGS`, but we never minded that in `spkg-install`. And as it uses the pari headers, it might recompile something and then lead to the problem.",
    "created_at": "2020-06-20T12:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521731",
    "user": "https://github.com/kliem"
}
```

<a id='comment:91'></a>Thanks. I'm going through the packages now. It might have been `lcalc` after all though. Turns out it also uses `CFLAGS`, but we never minded that in `spkg-install`. And as it uses the pari headers, it might recompile something and then lead to the problem.



---

archive/issue_comments_521732.json:
```json
{
    "body": "<a id='comment:92'></a>And it wasn't `cddlib`, at least not by itself.",
    "created_at": "2020-06-20T12:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521732",
    "user": "https://github.com/kliem"
}
```

<a id='comment:92'></a>And it wasn't `cddlib`, at least not by itself.



---

archive/issue_comments_521733.json:
```json
{
    "body": "Changing work_issues from \"\" to \"move to gcc/spkg-configure; fix documentation build\"",
    "created_at": "2020-06-20T12:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521733",
    "user": "https://github.com/kliem"
}
```

Changing work_issues from "" to "move to gcc/spkg-configure; fix documentation build"



---

archive/issue_comments_521734.json:
```json
{
    "body": "<a id='comment:94'></a>I think I found the problem. After disabling gap, it worked.\n\nhttps://github.com/kliem/sage/actions/runs/141805272",
    "created_at": "2020-06-21T06:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521734",
    "user": "https://github.com/kliem"
}
```

<a id='comment:94'></a>I think I found the problem. After disabling gap, it worked.

https://github.com/kliem/sage/actions/runs/141805272



---

archive/issue_comments_521735.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-06-21T06:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521735",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_521736.json:
```json
{
    "body": "<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-23T06:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521736",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_521737.json:
```json
{
    "body": "Changing commit from \"4596c4bcb5e9132c4e627edd8081ed139b22e613\" to \"4c52d4d43794f807875739deb27a51d46836764c\"",
    "created_at": "2020-06-23T06:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521737",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4596c4bcb5e9132c4e627edd8081ed139b22e613" to "4c52d4d43794f807875739deb27a51d46836764c"



---

archive/issue_comments_521738.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,27 @@\n+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n+Most of the work is done in the `gcc/spkg_configure.ac` and `gfortran/spkg_configure.ac`.\n+\n+We also gather and clean up other compiler flags. In short we\n+- add `--enable-fat-binary` to `configure` (as an alternative to setting `SAGE_FAT_BINARY`)\n+- add `--enable_debug={no|symbols|yes}` as alternative to setting `SAGE_DEBUG`\n+\n+- compile with `-Og -g` if `SAGE_DEBUG=yes`\n+- compile with `-O2` if `SAGE_DEBUG=no` (some packages with `O3` instead)\n+- compile with `-O2 -g` otherwise (some packages with `O3` instead)\n+\n+We add `-march=native` to the later two, if not building fat binaries and the compiler and the package accepts it.\n+\n+During the build of sage there are now flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by\n+- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)\n+- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)\n+- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)\n+- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)\n+- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)\n+\n+Likewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.\n+\n+We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-06-23T07:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521738",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,27 @@
+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
+Most of the work is done in the `gcc/spkg_configure.ac` and `gfortran/spkg_configure.ac`.
+
+We also gather and clean up other compiler flags. In short we
+- add `--enable-fat-binary` to `configure` (as an alternative to setting `SAGE_FAT_BINARY`)
+- add `--enable_debug={no|symbols|yes}` as alternative to setting `SAGE_DEBUG`
+
+- compile with `-Og -g` if `SAGE_DEBUG=yes`
+- compile with `-O2` if `SAGE_DEBUG=no` (some packages with `O3` instead)
+- compile with `-O2 -g` otherwise (some packages with `O3` instead)
+
+We add `-march=native` to the later two, if not building fat binaries and the compiler and the package accepts it.
+
+During the build of sage there are now flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by
+- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)
+- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)
+- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)
+- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)
+- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)
+
+Likewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.
+
+We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.
 
 Comment: 1
 
``````




---

archive/issue_comments_521739.json:
```json
{
    "body": "Changing work_issues from \"move to gcc/spkg-configure; fix documentation build\" to \"move to gcc/spkg-configure; enable-debug; documententation for developers\"",
    "created_at": "2020-06-23T07:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521739",
    "user": "https://github.com/kliem"
}
```

Changing work_issues from "move to gcc/spkg-configure; fix documentation build" to "move to gcc/spkg-configure; enable-debug; documententation for developers"



---

archive/issue_comments_521740.json:
```json
{
    "body": "<a id='comment:96'></a>I meant to change from \"needs info\" to \"needs work\" earlier.",
    "created_at": "2020-06-23T07:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521740",
    "user": "https://github.com/kliem"
}
```

<a id='comment:96'></a>I meant to change from "needs info" to "needs work" earlier.



---

archive/issue_comments_521741.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-06-23T07:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521741",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_521742.json:
```json
{
    "body": "<a id='comment:97'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-23T12:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521742",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:97'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521743.json:
```json
{
    "body": "Changing commit from \"4c52d4d43794f807875739deb27a51d46836764c\" to \"d12ed68a2a7a6fb9161cb11f066ca94c4b6c228e\"",
    "created_at": "2020-06-23T12:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521743",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4c52d4d43794f807875739deb27a51d46836764c" to "d12ed68a2a7a6fb9161cb11f066ca94c4b6c228e"



---

archive/issue_comments_521744.json:
```json
{
    "body": "Changing work_issues from \"move to gcc/spkg-configure; enable-debug; documententation for developers\" to \"\"",
    "created_at": "2020-06-23T12:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521744",
    "user": "https://github.com/kliem"
}
```

Changing work_issues from "move to gcc/spkg-configure; enable-debug; documententation for developers" to ""



---

archive/issue_comments_521745.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-06-23T12:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521745",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_521746.json:
```json
{
    "body": "<a id='comment:98'></a>Tests are running here:\n\n- tox.ini: https://github.com/kliem/sage/actions/runs/144837797\n- tox.ini with gcc-spkg: https://github.com/kliem/sage/actions/runs/144837787\n- optional: https://github.com/kliem/sage/actions/runs/144837791\n- cygwin minimal: https://github.com/kliem/sage/actions/runs/144837775\n- cygwin standard: https://github.com/kliem/sage/actions/runs/144837781\n\nIn comparison to 9.2beta1:\n\n- tox.ini: https://github.com/sagemath/sage/actions/runs/134966983\n- tox.ini with gcc-spkg: https://github.com/sagemath/sage/actions/runs/134966986\n- optional: https://github.com/sagemath/sage/actions/runs/134966981\n- cygwin minimal: https://github.com/sagemath/sage/actions/runs/134966984\n- cygwin standard: https://github.com/sagemath/sage/actions/runs/134966985",
    "created_at": "2020-06-23T12:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521746",
    "user": "https://github.com/kliem"
}
```

<a id='comment:98'></a>Tests are running here:

- tox.ini: https://github.com/kliem/sage/actions/runs/144837797
- tox.ini with gcc-spkg: https://github.com/kliem/sage/actions/runs/144837787
- optional: https://github.com/kliem/sage/actions/runs/144837791
- cygwin minimal: https://github.com/kliem/sage/actions/runs/144837775
- cygwin standard: https://github.com/kliem/sage/actions/runs/144837781

In comparison to 9.2beta1:

- tox.ini: https://github.com/sagemath/sage/actions/runs/134966983
- tox.ini with gcc-spkg: https://github.com/sagemath/sage/actions/runs/134966986
- optional: https://github.com/sagemath/sage/actions/runs/134966981
- cygwin minimal: https://github.com/sagemath/sage/actions/runs/134966984
- cygwin standard: https://github.com/sagemath/sage/actions/runs/134966985



---

archive/issue_comments_521747.json:
```json
{
    "body": "<a id='comment:99'></a>Somehow it seems the second last commit `74b82b6506cd71d87f616389fe2fa142dd16f4cf` has messed up the `scipy` build. Or something else is going on. I'm getting:\n\n```\n [sagelib-9.2.beta1] installing. Log file: /sage/logs/pkgs/sagelib-9.2.beta1.log\n  [sagelib-9.2.beta1] successfully installed.\n  [scipy-1.2.3] error installing, exit status 1. End of log file:\n  [scipy-1.2.3]       Running setup.py install for scipy: finished with status 'error'\n  [scipy-1.2.3]   Cleaning up...\n  [scipy-1.2.3]     Removing source in /tmp/pip-req-build-18apw96c\n  [scipy-1.2.3]   Removed build tracker '/tmp/pip-req-tracker-x3hgraz6'\n  [scipy-1.2.3]   Command \"/sage/local/bin/python3 -u -c \"import setuptools, tokenize;__file__='/tmp/pip-req-build-18apw96c/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\\r\\n', '\\n');f.close();exec(compile(code, __file__, 'exec'))\" --no-user-cfg install --record /tmp/pip-record-v0usfnl4/install-record.txt --single-version-externally-managed --root /sage/local/var/tmp/sage/build/scipy-1.2.3/inst --compile --install-headers /sage/local/include/site/python3.7/scipy\" failed with error code 1 in /tmp/pip-req-build-18apw96c/\n  [scipy-1.2.3]   Exception information:\n  [scipy-1.2.3]   Traceback (most recent call last):\n  [scipy-1.2.3]     File \"/sage/local/lib/python3.7/site-packages/pip/_internal/cli/base_command.py\", line 143, in main\n  [scipy-1.2.3]       status = self.run(options, args)\n  [scipy-1.2.3]     File \"/sage/local/lib/python3.7/site-packages/pip/_internal/commands/install.py\", line 366, in run\n  [scipy-1.2.3]       use_user_site=options.use_user_site,\n  [scipy-1.2.3]     File \"/sage/local/lib/python3.7/site-packages/pip/_internal/req/__init__.py\", line 49, in install_given_reqs\n  [scipy-1.2.3]       **kwargs\n  [scipy-1.2.3]     File \"/sage/local/lib/python3.7/site-packages/pip/_internal/req/req_install.py\", line 791, in install\n  [scipy-1.2.3]       spinner=spinner,\n  [scipy-1.2.3]     File \"/sage/local/lib/python3.7/site-packages/pip/_internal/utils/misc.py\", line 705, in call_subprocess\n  [scipy-1.2.3]       % (command_desc, proc.returncode, cwd))\n  [scipy-1.2.3]   pip._internal.exceptions.InstallationError: Command \"/sage/local/bin/python3 -u -c \"import setuptools, tokenize;__file__='/tmp/pip-req-build-18apw96c/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\\r\\n', '\\n');f.close();exec(compile(code, __file__, 'exec'))\" --no-user-cfg install --record /tmp/pip-record-v0usfnl4/install-record.txt --single-version-externally-managed --root /sage/local/var/tmp/sage/build/scipy-1.2.3/inst --compile --install-headers /sage/local/include/site/python3.7/scipy\" failed with error code 1 in /tmp/pip-req-build-18apw96c/\n  [scipy-1.2.3]   Error: installing with pip3 failed\n```\n\non many platforms. Seems like I messed up when moving stuff around from `configure.ac` to `{gcc,gfortran}/spkg-configure.ac`.",
    "created_at": "2020-06-23T21:43:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521747",
    "user": "https://github.com/kliem"
}
```

<a id='comment:99'></a>Somehow it seems the second last commit `74b82b6506cd71d87f616389fe2fa142dd16f4cf` has messed up the `scipy` build. Or something else is going on. I'm getting:

```
 [sagelib-9.2.beta1] installing. Log file: /sage/logs/pkgs/sagelib-9.2.beta1.log
  [sagelib-9.2.beta1] successfully installed.
  [scipy-1.2.3] error installing, exit status 1. End of log file:
  [scipy-1.2.3]       Running setup.py install for scipy: finished with status 'error'
  [scipy-1.2.3]   Cleaning up...
  [scipy-1.2.3]     Removing source in /tmp/pip-req-build-18apw96c
  [scipy-1.2.3]   Removed build tracker '/tmp/pip-req-tracker-x3hgraz6'
  [scipy-1.2.3]   Command "/sage/local/bin/python3 -u -c "import setuptools, tokenize;__file__='/tmp/pip-req-build-18apw96c/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /tmp/pip-record-v0usfnl4/install-record.txt --single-version-externally-managed --root /sage/local/var/tmp/sage/build/scipy-1.2.3/inst --compile --install-headers /sage/local/include/site/python3.7/scipy" failed with error code 1 in /tmp/pip-req-build-18apw96c/
  [scipy-1.2.3]   Exception information:
  [scipy-1.2.3]   Traceback (most recent call last):
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/cli/base_command.py", line 143, in main
  [scipy-1.2.3]       status = self.run(options, args)
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/commands/install.py", line 366, in run
  [scipy-1.2.3]       use_user_site=options.use_user_site,
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/req/__init__.py", line 49, in install_given_reqs
  [scipy-1.2.3]       **kwargs
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/req/req_install.py", line 791, in install
  [scipy-1.2.3]       spinner=spinner,
  [scipy-1.2.3]     File "/sage/local/lib/python3.7/site-packages/pip/_internal/utils/misc.py", line 705, in call_subprocess
  [scipy-1.2.3]       % (command_desc, proc.returncode, cwd))
  [scipy-1.2.3]   pip._internal.exceptions.InstallationError: Command "/sage/local/bin/python3 -u -c "import setuptools, tokenize;__file__='/tmp/pip-req-build-18apw96c/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /tmp/pip-record-v0usfnl4/install-record.txt --single-version-externally-managed --root /sage/local/var/tmp/sage/build/scipy-1.2.3/inst --compile --install-headers /sage/local/include/site/python3.7/scipy" failed with error code 1 in /tmp/pip-req-build-18apw96c/
  [scipy-1.2.3]   Error: installing with pip3 failed
```

on many platforms. Seems like I messed up when moving stuff around from `configure.ac` to `{gcc,gfortran}/spkg-configure.ac`.



---

archive/issue_comments_521748.json:
```json
{
    "body": "Changing commit from \"d12ed68a2a7a6fb9161cb11f066ca94c4b6c228e\" to \"16a6989274d87c44815f05dab041c5ea825db759\"",
    "created_at": "2020-06-24T22:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d12ed68a2a7a6fb9161cb11f066ca94c4b6c228e" to "16a6989274d87c44815f05dab041c5ea825db759"



---

archive/issue_comments_521749.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-24T22:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521749",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521750.json:
```json
{
    "body": "<a id='comment:1'></a>I undid part of the reordering (or most of it).\n\nIt looks much better now (some tests still running):\n\n- tox.ini: https://github.com/kliem/sage/actions/runs/145781781\n- gcc-spkg: https://github.com/kliem/sage/actions/runs/145781778\n- optional: https://github.com/kliem/sage/actions/runs/145781780\n- cygwin minimal: https://github.com/kliem/sage/actions/runs/145781783\n- cygwin standard: https://github.com/kliem/sage/actions/runs/145781785",
    "created_at": "2020-06-24T22:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521750",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>I undid part of the reordering (or most of it).

It looks much better now (some tests still running):

- tox.ini: https://github.com/kliem/sage/actions/runs/145781781
- gcc-spkg: https://github.com/kliem/sage/actions/runs/145781778
- optional: https://github.com/kliem/sage/actions/runs/145781780
- cygwin minimal: https://github.com/kliem/sage/actions/runs/145781783
- cygwin standard: https://github.com/kliem/sage/actions/runs/145781785



---

archive/issue_comments_521751.json:
```json
{
    "body": "<a id='comment:2'></a>OK, this still looks acceptable, w.r.t. what is done in configure.ac, and try further refactoring on another ticket.",
    "created_at": "2020-06-25T06:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521751",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>OK, this still looks acceptable, w.r.t. what is done in configure.ac, and try further refactoring on another ticket.



---

archive/issue_comments_521752.json:
```json
{
    "body": "<a id='comment:3'></a>I took a brief look at the source changes, and it looks clean to me. \nI haven't looked at the tests.",
    "created_at": "2020-06-25T07:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521752",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>I took a brief look at the source changes, and it looks clean to me. 
I haven't looked at the tests.



---

archive/issue_comments_521753.json:
```json
{
    "body": "<a id='comment:4'></a>Here is a overview, over the test results (all in comparison to the 9.2.beta1 tests and only mentioning differences):\n\n- tox.ini:\n  - ubuntu-trusty-standard\n    `sage -t src/sage/interfaces/maxima.py  # Timed out` after\n\n```\nsage: maxima._batch('10003;') ## line 864 ##\n'kill(sage121)$batchload(\"/root/.sage/temp/9b341214822c/14051/interface/tmp14054-1371013559\");1+952962022;\\r\\n\\r\\n(%o771) \"/root/.sage/temp/9b341214822c/14051/interface/tmp14054-1371013559\"\\r\\n(%o772) '\nsage: maxima._batch('10003;',batchload=False) ## line 866 ##\n```\n- debian-stretch-standard: didn't finish in 6 hours\n- linuxmint-19.3-minimal: didn't finish in 6 hours\n- fedora-26, standard: `sage -t src/sage/symbolic/expression.pyx  # 1 doctest failed`\n- fedora-27, minimal: failed to build `mpir`\n- fedora-28, standard: `sage -t src/sage/interfaces/maxima.py  # Timed out`\n- fedora-31, minimal: `sage -t src/sage/symbolic/integration/integral.py  # 1 doctest failed`7\n- fedora-32, standard didn't finish in time and `sage -t src/sage/interfaces/maxima.py  # Timed out`\n- local-macos (homebrew-macos-python3_xcode, minimal): new failures\n\n```\nsage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out\nsage -t src/sage/manifolds/differentiable/metric.py  # Timed out\nsage -t src/sage/parallel/map_reduce.py  # 1 doctest failed\nsage -t src/sage/plot/plot3d/platonic.py  # Timed out\nsage -t src/sage/plot/plot3d/shapes.pyx  # Timed out\n```\n- local-macos (homebrew-macos-python3_xcode, standard): new failures\n\n```\nsage -t src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst  # Timed out\nsage -t src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst  # Timed out\nsage -t src/sage/geometry/polyhedron/base.py  # Timed out\nsage -t src/sage/manifolds/differentiable/affine_connection.py  # Timed out\nsage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out\nsage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out\nsage -t src/sage/manifolds/differentiable/metric.py  # Timed out\nsage -t src/sage/manifolds/differentiable/multivectorfield.py  # Timed out\nsage -t src/sage/manifolds/differentiable/pseudo_riemannian_submanifold.py  # Timed out\nsage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed\nsage -t src/sage/parallel/map_reduce.py  # 1 doctest failed\nsage -t src/sage/plot/plot3d/platonic.py  # Timed out\nsage -t src/sage/plot/plot3d/shapes.pyx  # Timed out\nsage -t src/sage/rings/function_field/function_field.py  # Timed out\nsage -t src/sage/schemes/elliptic_curves/isogeny_class.py  # Timed out\n```\n- local-macos (homebrew-macos-python3_xcode-nokegonly, minimal)\n\n```\nsage -t src/sage/plot/plot3d/shapes.pyx  # Timed out\nsage -t src/sage/rings/function_field/function_field.py  # Timed out\n```\n- local-macos (homebrew-macos-python3_xcode-nokegonly, standard)\n\n```\nsage -t src/sage/plot/plot3d/shapes.pyx  # Timed out\nsage -t src/sage/rings/function_field/function_field.py  # Timed out\n```\n- local-macos (homebrew-macos-python3_pythonorg, minimal)\n\n```\nsage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out\nsage -t src/sage/manifolds/differentiable/metric.py  # Timed out\nsage -t src/sage/plot/plot3d/shapes.pyx  # Timed out\nsage -t src/sage/rings/function_field/function_field.py  # Timed out\n```\n-  local-macos (homebrew-macos-python3_pythonorg, standard)\n\n```\nsage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out\nsage -t src/sage/manifolds/differentiable/metric.py  # Timed out\nsage -t src/sage/parallel/map_reduce.py  # 1 doctest failed\nsage -t src/sage/plot/plot3d/platonic.py  # Timed out\nsage -t src/sage/plot/plot3d/shapes.pyx  # Timed out\nsage -t src/sage/schemes/elliptic_curves/isogeny_class.py  # Timed out\nsage -t src/sage/symbolic/relation.py  # Timed out\n```\n- local-macos (conda-forge-macos): many failures, looks like the new ones are the same as other mac\n\nI'll leave it at that for now.\n\nAll those new mac failures don't look good.",
    "created_at": "2020-06-25T10:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521753",
    "user": "https://github.com/kliem"
}
```

<a id='comment:4'></a>Here is a overview, over the test results (all in comparison to the 9.2.beta1 tests and only mentioning differences):

- tox.ini:
  - ubuntu-trusty-standard
    `sage -t src/sage/interfaces/maxima.py  # Timed out` after

```
sage: maxima._batch('10003;') ## line 864 ##
'kill(sage121)$batchload("/root/.sage/temp/9b341214822c/14051/interface/tmp14054-1371013559");1+952962022;\r\n\r\n(%o771) "/root/.sage/temp/9b341214822c/14051/interface/tmp14054-1371013559"\r\n(%o772) '
sage: maxima._batch('10003;',batchload=False) ## line 866 ##
```
- debian-stretch-standard: didn't finish in 6 hours
- linuxmint-19.3-minimal: didn't finish in 6 hours
- fedora-26, standard: `sage -t src/sage/symbolic/expression.pyx  # 1 doctest failed`
- fedora-27, minimal: failed to build `mpir`
- fedora-28, standard: `sage -t src/sage/interfaces/maxima.py  # Timed out`
- fedora-31, minimal: `sage -t src/sage/symbolic/integration/integral.py  # 1 doctest failed`7
- fedora-32, standard didn't finish in time and `sage -t src/sage/interfaces/maxima.py  # Timed out`
- local-macos (homebrew-macos-python3_xcode, minimal): new failures

```
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot3d/platonic.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
```
- local-macos (homebrew-macos-python3_xcode, standard): new failures

```
sage -t src/doc/en/thematic_tutorials/vector_calculus/vector_calc_advanced.rst  # Timed out
sage -t src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst  # Timed out
sage -t src/sage/geometry/polyhedron/base.py  # Timed out
sage -t src/sage/manifolds/differentiable/affine_connection.py  # Timed out
sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/manifolds/differentiable/multivectorfield.py  # Timed out
sage -t src/sage/manifolds/differentiable/pseudo_riemannian_submanifold.py  # Timed out
sage -t src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot3d/platonic.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
sage -t src/sage/schemes/elliptic_curves/isogeny_class.py  # Timed out
```
- local-macos (homebrew-macos-python3_xcode-nokegonly, minimal)

```
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
```
- local-macos (homebrew-macos-python3_xcode-nokegonly, standard)

```
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
```
- local-macos (homebrew-macos-python3_pythonorg, minimal)

```
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
```
-  local-macos (homebrew-macos-python3_pythonorg, standard)

```
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot3d/platonic.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/schemes/elliptic_curves/isogeny_class.py  # Timed out
sage -t src/sage/symbolic/relation.py  # Timed out
```
- local-macos (conda-forge-macos): many failures, looks like the new ones are the same as other mac

I'll leave it at that for now.

All those new mac failures don't look good.



---

archive/issue_comments_521754.json:
```json
{
    "body": "<a id='comment:105'></a>Replying to [comment:90 fbissey]:\n> permutahedron. Looks like stuff linked to cddlib, it says so in the code. I don't remember cddlib to be so sensitive to optimisation. Heck, I use `-march=native` in my sage-on-gentoo builds and I am fine.\n> But `pari` is definitely sensitive to optimisation. When I was working on enabling clang, I also tried the Intel compiler. `pari` needed to be compiled at `-O0` with it. Any optimisation with icc would break it. That was the only package that I remember with that issue.\n\n\nIt really looks like `pari` shouldn't be optimzed. At least not when using `clang`.\nhttps://github.com/kliem/sage/runs/787575732?check_suite_focus=true\n\nThis old run, didn't have the new doctest failures.\n\nSo try disabling `-march=native` for `pari` and maxima`?",
    "created_at": "2020-06-25T10:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521754",
    "user": "https://github.com/kliem"
}
```

<a id='comment:105'></a>Replying to [comment:90 fbissey]:
> permutahedron. Looks like stuff linked to cddlib, it says so in the code. I don't remember cddlib to be so sensitive to optimisation. Heck, I use `-march=native` in my sage-on-gentoo builds and I am fine.
> But `pari` is definitely sensitive to optimisation. When I was working on enabling clang, I also tried the Intel compiler. `pari` needed to be compiled at `-O0` with it. Any optimisation with icc would break it. That was the only package that I remember with that issue.


It really looks like `pari` shouldn't be optimzed. At least not when using `clang`.
https://github.com/kliem/sage/runs/787575732?check_suite_focus=true

This old run, didn't have the new doctest failures.

So try disabling `-march=native` for `pari` and maxima`?



---

archive/issue_comments_521755.json:
```json
{
    "body": "Changing commit from \"16a6989274d87c44815f05dab041c5ea825db759\" to \"863862679f6a9cba3476b515dbbfe22ed31a6571\"",
    "created_at": "2020-06-25T10:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521755",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "16a6989274d87c44815f05dab041c5ea825db759" to "863862679f6a9cba3476b515dbbfe22ed31a6571"



---

archive/issue_comments_521756.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-25T10:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521756",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521757.json:
```json
{
    "body": "<a id='comment:7'></a>`maxima` doesn't compile with `-march=native`, so I guess this has nothing to do with it.\nHopefully the new run without `pari` will resolve the other problems:\n- tox.ini https://github.com/kliem/sage/actions/runs/147321660\n- tox.ini gcc-spkg: https://github.com/kliem/sage/actions/runs/147321678\n- targets optional: https://github.com/kliem/sage/actions/runs/147321655\n- cygwin minimal: https://github.com/kliem/sage/actions/runs/147321676\n- cygwin standard: https://github.com/kliem/sage/actions/runs/147321676",
    "created_at": "2020-06-25T16:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521757",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>`maxima` doesn't compile with `-march=native`, so I guess this has nothing to do with it.
Hopefully the new run without `pari` will resolve the other problems:
- tox.ini https://github.com/kliem/sage/actions/runs/147321660
- tox.ini gcc-spkg: https://github.com/kliem/sage/actions/runs/147321678
- targets optional: https://github.com/kliem/sage/actions/runs/147321655
- cygwin minimal: https://github.com/kliem/sage/actions/runs/147321676
- cygwin standard: https://github.com/kliem/sage/actions/runs/147321676



---

archive/issue_comments_521758.json:
```json
{
    "body": "<a id='comment:108'></a>Replying to [comment:107 gh-kliem]:\n> `maxima` doesn't compile with `-march=native`, so I guess this has nothing to do with it.\n\n\nAs far as I understand, Maxima build process does not involve anything but a Lisp compiler, ECL in the case of Sage. And ECL compiles directly into object files, as far as I know.\n\nSo this is probably a red herring.",
    "created_at": "2020-06-25T17:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521758",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:108'></a>Replying to [comment:107 gh-kliem]:
> `maxima` doesn't compile with `-march=native`, so I guess this has nothing to do with it.


As far as I understand, Maxima build process does not involve anything but a Lisp compiler, ECL in the case of Sage. And ECL compiles directly into object files, as far as I know.

So this is probably a red herring.



---

archive/issue_comments_521759.json:
```json
{
    "body": "<a id='comment:9'></a>The last commits don't make a difference as far as I can tell. But the new mac failures seem to be real random. They are also present here (which is a completely different ticket):\n- local-macos (homebrew-macos-python3_pythonorg, minimal) https://github.com/mkoeppe/sage/runs/785733405?check_suite_focus=true\n\nI personally guess the new errors on mac are either random or caused by something else (some package updated maybe). That would also explain why on homebrew-macos-python3_xcode there are so many new failures for standard, but not for minimal. (As this ticket here is supposed to influence minimal much more than standard.)\n\nSomething is going on either way, as even on 9.2.beta1 we have many time outs in `plot` and `manifolds`. So if I get an extra error in `sage -t src/sage/plot/plot3d/shapes.pyx`, I don't even know if this is really bad or just random.\n\nBasically, I see the following options now:\n\n- revert the last two commits or not (independent of the other options):\n\n  I don't see an advantage in disabling `-march=native` for `pari`, but maybe that is really something we should do.\n- decide that the macos failures are either random or acceptable\n- disable `-march=native` for clang (but it is not said that things would improve for mac then)\n- someone has an educated guess about what I could do about the mac failures\n\nIt is possible however that some of the new mac failures are caused by the fact that the default `CFLAGS` is now `-g -O2` instead of just empty.\n\nFor an updated comparison, I started a mac only test on the current develop again:\nhttps://github.com/kliem/sage/actions/runs/148471033",
    "created_at": "2020-06-26T09:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521759",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>The last commits don't make a difference as far as I can tell. But the new mac failures seem to be real random. They are also present here (which is a completely different ticket):
- local-macos (homebrew-macos-python3_pythonorg, minimal) https://github.com/mkoeppe/sage/runs/785733405?check_suite_focus=true

I personally guess the new errors on mac are either random or caused by something else (some package updated maybe). That would also explain why on homebrew-macos-python3_xcode there are so many new failures for standard, but not for minimal. (As this ticket here is supposed to influence minimal much more than standard.)

Something is going on either way, as even on 9.2.beta1 we have many time outs in `plot` and `manifolds`. So if I get an extra error in `sage -t src/sage/plot/plot3d/shapes.pyx`, I don't even know if this is really bad or just random.

Basically, I see the following options now:

- revert the last two commits or not (independent of the other options):

  I don't see an advantage in disabling `-march=native` for `pari`, but maybe that is really something we should do.
- decide that the macos failures are either random or acceptable
- disable `-march=native` for clang (but it is not said that things would improve for mac then)
- someone has an educated guess about what I could do about the mac failures

It is possible however that some of the new mac failures are caused by the fact that the default `CFLAGS` is now `-g -O2` instead of just empty.

For an updated comparison, I started a mac only test on the current develop again:
https://github.com/kliem/sage/actions/runs/148471033



---

archive/issue_comments_521760.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-26T20:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521760",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521761.json:
```json
{
    "body": "Changing commit from \"863862679f6a9cba3476b515dbbfe22ed31a6571\" to \"28ac47550eebe0ad6cd3094b432bed29085838ff\"",
    "created_at": "2020-06-26T20:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "863862679f6a9cba3476b515dbbfe22ed31a6571" to "28ac47550eebe0ad6cd3094b432bed29085838ff"



---

archive/issue_comments_521762.json:
```json
{
    "body": "<a id='comment:1'></a>I can confirm that the mac os errors also happen on a clean build from 9.2.beta1, so I think it has nothing to do with that ticket and is just somewhat random behaviour:\n\nlocal-macos (homebrew-macos-python3_pythonorg, minimal)\nhttps://github.com/kliem/sage/runs/810515848?check_suite_focus=true\n\nhad the following failures:\n\n```\nsage -t src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # Timed out\nsage -t src/sage/interfaces/gap.py  # 1 doctest failed\nsage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out\nsage -t src/sage/manifolds/differentiable/metric.py  # Timed out\nsage -t src/sage/manifolds/differentiable/tensorfield.py  # Timed out\nsage -t src/sage/parallel/map_reduce.py  # 1 doctest failed\nsage -t src/sage/plot/plot.py  # Timed out\nsage -t src/sage/plot/plot3d/base.pyx  # Timed out\nsage -t src/sage/plot/plot3d/implicit_plot3d.py  # Timed out\nsage -t src/sage/plot/plot3d/parametric_plot3d.py  # Timed out\nsage -t src/sage/plot/plot3d/plot3d.py  # Timed out\nsage -t src/sage/plot/plot3d/shapes.pyx  # Timed out\nsage -t src/sage/plot/plot3d/shapes2.py  # Timed out\nsage -t src/sage/rings/function_field/function_field.py  # Timed out\nsage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out\n```\n\nI would propose leaving the ticket as it is. Testwise I think it looks fine.",
    "created_at": "2020-06-26T20:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521762",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>I can confirm that the mac os errors also happen on a clean build from 9.2.beta1, so I think it has nothing to do with that ticket and is just somewhat random behaviour:

local-macos (homebrew-macos-python3_pythonorg, minimal)
https://github.com/kliem/sage/runs/810515848?check_suite_focus=true

had the following failures:

```
sage -t src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # Timed out
sage -t src/sage/interfaces/gap.py  # 1 doctest failed
sage -t src/sage/manifolds/differentiable/euclidean.py  # Timed out
sage -t src/sage/manifolds/differentiable/metric.py  # Timed out
sage -t src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t src/sage/parallel/map_reduce.py  # 1 doctest failed
sage -t src/sage/plot/plot.py  # Timed out
sage -t src/sage/plot/plot3d/base.pyx  # Timed out
sage -t src/sage/plot/plot3d/implicit_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/plot/plot3d/shapes2.py  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
```

I would propose leaving the ticket as it is. Testwise I think it looks fine.



---

archive/issue_comments_521763.json:
```json
{
    "body": "<a id='comment:2'></a>Could you comment on whether this implements autotools semantics of \"precious variables\" (see #29507) for CFLAGS, FCFLAGS etc.?",
    "created_at": "2020-06-26T21:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521763",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>Could you comment on whether this implements autotools semantics of "precious variables" (see #29507) for CFLAGS, FCFLAGS etc.?



---

archive/issue_comments_521764.json:
```json
{
    "body": "<a id='comment:3'></a>This definitely doesn't implement autotools semantics of \"precious variables\", but I think it is an improvement towards that.\n\nUntil now, every build of sage would pick up `CFLAGS`, `CXXFLAGS`, `FCFLAGS` and `F77FLAGS` again from the environment. This is strange especially now that we have seperated `make` from `configure`.\n\nWith this ticket the flags will be picked up on `configure` (if set) and will overwritten for `make` according to their set up (this is what `sage-build-env-config.in` does). They are also mostly respected now. Until now, if you set `CFLAGS` to `-O0`, every package `spkg-install.in` would just overwrite that (or add `-g -O2`, which in practice overwrites it I think). Now many (but not all) packages will just respect that.\n\nI think it needs very little change to implement autotools semantics of \"precious variables\" `CFLAGS` etc. from here, but I'm not sure exactly how to do this.",
    "created_at": "2020-06-27T09:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521764",
    "user": "https://github.com/kliem"
}
```

<a id='comment:3'></a>This definitely doesn't implement autotools semantics of "precious variables", but I think it is an improvement towards that.

Until now, every build of sage would pick up `CFLAGS`, `CXXFLAGS`, `FCFLAGS` and `F77FLAGS` again from the environment. This is strange especially now that we have seperated `make` from `configure`.

With this ticket the flags will be picked up on `configure` (if set) and will overwritten for `make` according to their set up (this is what `sage-build-env-config.in` does). They are also mostly respected now. Until now, if you set `CFLAGS` to `-O0`, every package `spkg-install.in` would just overwrite that (or add `-g -O2`, which in practice overwrites it I think). Now many (but not all) packages will just respect that.

I think it needs very little change to implement autotools semantics of "precious variables" `CFLAGS` etc. from here, but I'm not sure exactly how to do this.



---

archive/issue_comments_521765.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-27T09:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521765",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521766.json:
```json
{
    "body": "Changing commit from \"28ac47550eebe0ad6cd3094b432bed29085838ff\" to \"234338ea6283549195c4b22fc84cb621fcb75c48\"",
    "created_at": "2020-06-27T09:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521766",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "28ac47550eebe0ad6cd3094b432bed29085838ff" to "234338ea6283549195c4b22fc84cb621fcb75c48"



---

archive/issue_comments_521767.json:
```json
{
    "body": "<a id='comment:5'></a>Regarding the last commit, we should really pick up `SAGE_DEBUG` from configuration time and not from build time. It will influence the build of some packages.",
    "created_at": "2020-06-27T09:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521767",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>Regarding the last commit, we should really pick up `SAGE_DEBUG` from configuration time and not from build time. It will influence the build of some packages.



---

archive/issue_comments_521768.json:
```json
{
    "body": "<a id='comment:6'></a>Can users still use the `SAGE_DEBUG` environment variable at all to configure anythin, or is it overridden by the enable value?",
    "created_at": "2020-07-04T19:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521768",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Can users still use the `SAGE_DEBUG` environment variable at all to configure anythin, or is it overridden by the enable value?



---

archive/issue_comments_521769.json:
```json
{
    "body": "<a id='comment:7'></a>\n```diff\n+AC_ARG_ENABLE([debug],\n+              [AS_HELP_STRING([--enable-debug={no|symbols|yes}],\n+                              [controls debugging support: \"no\" debugging; debugging \"symbols\" (default); build debug version (\"yes\")])],\n+              [AC_SUBST(SAGE_DEBUG, $enableval)],\n+              [])\n+\n```\nYes you can still set `SAGE_DEBUG`. However, if you configure with the option `--enable-debug=...`, it will override this variable.\n\nNote also that this must now be done at configuration time.\n\nI just checked. The following all work:\n\n```\n./configure --enable-debug=yes\n```\n\n```\n./configure SAGE_DEBUG=yes\n```\n\n```\nexport SAGE_DEBUG=yes; ./configure\n```",
    "created_at": "2020-07-05T06:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521769",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>
```diff
+AC_ARG_ENABLE([debug],
+              [AS_HELP_STRING([--enable-debug={no|symbols|yes}],
+                              [controls debugging support: "no" debugging; debugging "symbols" (default); build debug version ("yes")])],
+              [AC_SUBST(SAGE_DEBUG, $enableval)],
+              [])
+
```
Yes you can still set `SAGE_DEBUG`. However, if you configure with the option `--enable-debug=...`, it will override this variable.

Note also that this must now be done at configuration time.

I just checked. The following all work:

```
./configure --enable-debug=yes
```

```
./configure SAGE_DEBUG=yes
```

```
export SAGE_DEBUG=yes; ./configure
```



---

archive/issue_comments_521770.json:
```json
{
    "body": "<a id='comment:8'></a>I think it would be good if at least `make SAGE_DEBUG=yes some-package` would still be supported.",
    "created_at": "2020-07-06T18:39:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521770",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>I think it would be good if at least `make SAGE_DEBUG=yes some-package` would still be supported.



---

archive/issue_comments_521771.json:
```json
{
    "body": "<a id='comment:119'></a>Replying to [comment:118 mkoeppe]:\n> I think it would be good if at least `make SAGE_DEBUG=yes some-package` would still be supported.\n\n\nThe problem is that what `SAGE_DEBUG` mostly does is to set `CFLAGS` accordingly. If we configure this stuff in `configure` then it feels like doing everything twice. Unless we ignore `SAGE_DEBUG` mostly in `configure` and wait for this until `sage-build-env-config.in`. There we could do\n\n```\nexport SAGE_DEBUG?=\"@SAGE_DEBUG@\"\n```\nand then build together all the flags according to `SAGE_DEBUG`.",
    "created_at": "2020-07-06T18:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521771",
    "user": "https://github.com/kliem"
}
```

<a id='comment:119'></a>Replying to [comment:118 mkoeppe]:
> I think it would be good if at least `make SAGE_DEBUG=yes some-package` would still be supported.


The problem is that what `SAGE_DEBUG` mostly does is to set `CFLAGS` accordingly. If we configure this stuff in `configure` then it feels like doing everything twice. Unless we ignore `SAGE_DEBUG` mostly in `configure` and wait for this until `sage-build-env-config.in`. There we could do

```
export SAGE_DEBUG?="@SAGE_DEBUG@"
```
and then build together all the flags according to `SAGE_DEBUG`.



---

archive/issue_comments_521772.json:
```json
{
    "body": "<a id='comment:0'></a>This sounds like a good solution.\n\nI think it's important to support per-package SAGE_DEBUG, just like we support per-package SAGE_CHECK.",
    "created_at": "2020-07-06T19:45:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521772",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:0'></a>This sounds like a good solution.

I think it's important to support per-package SAGE_DEBUG, just like we support per-package SAGE_CHECK.



---

archive/issue_comments_521773.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-07-07T08:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521773",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_521774.json:
```json
{
    "body": "Changing commit from \"234338ea6283549195c4b22fc84cb621fcb75c48\" to \"e9fb1a37af6ac08c29dff5a9cb062eccf60f761a\"",
    "created_at": "2020-07-07T08:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521774",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "234338ea6283549195c4b22fc84cb621fcb75c48" to "e9fb1a37af6ac08c29dff5a9cb062eccf60f761a"



---

archive/issue_comments_521775.json:
```json
{
    "body": "<a id='comment:2'></a>Ok. I went back into `build/make/Makefile.in`. I think it works now.\n\nIf you run `make build SAGE_DEBUG=yes` without configuration, it will still assemble according to `SAGE_DEBUG`. You can even choose different flags with `make CFLAGS=-O2 some-package`. That will also work.\n\nHowever `export SAGE_DEBUG=yes; make build` will not work, unless for some reason this will induce configuration.",
    "created_at": "2020-07-07T09:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521775",
    "user": "https://github.com/kliem"
}
```

<a id='comment:2'></a>Ok. I went back into `build/make/Makefile.in`. I think it works now.

If you run `make build SAGE_DEBUG=yes` without configuration, it will still assemble according to `SAGE_DEBUG`. You can even choose different flags with `make CFLAGS=-O2 some-package`. That will also work.

However `export SAGE_DEBUG=yes; make build` will not work, unless for some reason this will induce configuration.



---

archive/issue_comments_521776.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,40 @@\n+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n+In `gcc/spkg_configure.ac` we check, whether the argument `-march=native` is accepted.\n+\n+In `build/make/Makefile.in` we assemble the flags.\n+\n+We also gather and clean up other compiler flags. In short we\n+- add `--enable-fat-binary` to `configure` (as an alternative to setting `SAGE_FAT_BINARY`)\n+- add `--enable_debug={no|symbols|yes}` as alternative to setting `SAGE_DEBUG`\n+\n+- compile with `-Og -g` if `SAGE_DEBUG=yes`\n+- compile with `-O2` if `SAGE_DEBUG=no` (some packages with `O3` instead)\n+- compile with `-O2 -g` otherwise (some packages with `O3` instead)\n+\n+We add `-march=native` to the later two, if not building fat binaries and the compiler and the package accepts it.\n+\n+During the build of sage there are now flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by\n+- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)\n+- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)\n+- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)\n+- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)\n+- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)\n+\n+Likewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.\n+\n+We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.\n+\n+Inidividual packages can still be compiled with specified flags or in debug mode using\n+\n+```\n+make CFLAGS=-O2 some-package\n+```\n+or\n+\n+```\n+make SAGE_DEBUG=\"yes\" some-package\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-07-07T09:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521776",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,40 @@
+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
+In `gcc/spkg_configure.ac` we check, whether the argument `-march=native` is accepted.
+
+In `build/make/Makefile.in` we assemble the flags.
+
+We also gather and clean up other compiler flags. In short we
+- add `--enable-fat-binary` to `configure` (as an alternative to setting `SAGE_FAT_BINARY`)
+- add `--enable_debug={no|symbols|yes}` as alternative to setting `SAGE_DEBUG`
+
+- compile with `-Og -g` if `SAGE_DEBUG=yes`
+- compile with `-O2` if `SAGE_DEBUG=no` (some packages with `O3` instead)
+- compile with `-O2 -g` otherwise (some packages with `O3` instead)
+
+We add `-march=native` to the later two, if not building fat binaries and the compiler and the package accepts it.
+
+During the build of sage there are now flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by
+- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)
+- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)
+- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)
+- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)
+- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)
+
+Likewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.
+
+We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.
+
+Inidividual packages can still be compiled with specified flags or in debug mode using
+
+```
+make CFLAGS=-O2 some-package
+```
+or
+
+```
+make SAGE_DEBUG="yes" some-package
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_521777.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-13T05:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521777",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521778.json:
```json
{
    "body": "Changing commit from \"e9fb1a37af6ac08c29dff5a9cb062eccf60f761a\" to \"df59361cd348455c9280779bc256f5903328ff75\"",
    "created_at": "2020-08-13T05:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521778",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e9fb1a37af6ac08c29dff5a9cb062eccf60f761a" to "df59361cd348455c9280779bc256f5903328ff75"



---

archive/issue_comments_521779.json:
```json
{
    "body": "<a id='comment:5'></a>I would be glad if we could bring this in, in an early 9.3 beta.\n\nOne could also think of splitting this ticket into two. One that reorders the all the flags and one where we enable march=native.",
    "created_at": "2020-08-16T05:40:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521779",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>I would be glad if we could bring this in, in an early 9.3 beta.

One could also think of splitting this ticket into two. One that reorders the all the flags and one where we enable march=native.



---

archive/issue_events_067370.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-08-16T05:40:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67370"
}
```



---

archive/issue_events_067371.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-08-16T05:40:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67371"
}
```



---

archive/issue_comments_521780.json:
```json
{
    "body": "<a id='comment:6'></a>Yes, I agree with both points.",
    "created_at": "2020-08-16T06:29:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521780",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Yes, I agree with both points.



---

archive/issue_comments_521781.json:
```json
{
    "body": "Changing commit from \"df59361cd348455c9280779bc256f5903328ff75\" to \"5da42f16bf3d470bbc6e42beaa3e7485650a3f36\"",
    "created_at": "2020-08-16T07:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521781",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "df59361cd348455c9280779bc256f5903328ff75" to "5da42f16bf3d470bbc6e42beaa3e7485650a3f36"



---

archive/issue_comments_521782.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-16T07:24:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521782",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521783.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,32 @@\n+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.\n \n+In `gcc/spkg_configure.ac` we check, whether the argument `-march=native` is accepted.\n+\n+In `build/make/Makefile.in` we assemble the flags.\n+\n+We add `-march=native` to the compiler flags, if not building fat binaries and the compiler and the package accepts it.\n+\n+During the build of sage there are now the following flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by\n+- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)\n+- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)\n+- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)\n+- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)\n+- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)\n+\n+Likewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.\n+\n+We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.\n+\n+Inidividual packages can still be compiled with specified flags or in debug mode using\n+\n+```\n+make CFLAGS=-O2 some-package\n+```\n+or\n+\n+```\n+make SAGE_DEBUG=\"yes\" some-package\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-08-16T07:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521783",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,32 @@
+We should compile Sage with the extra compile argument `-march=native` for extra performance, at least if `SAGE_FAT_BINARY` is not set.
 
+In `gcc/spkg_configure.ac` we check, whether the argument `-march=native` is accepted.
+
+In `build/make/Makefile.in` we assemble the flags.
+
+We add `-march=native` to the compiler flags, if not building fat binaries and the compiler and the package accepts it.
+
+During the build of sage there are now the following flags that can be exported in `spkg_install.in` with one line, instead of checking `SAGE_DEBUG` etc. for each individual package, e.g. by
+- `export CFLAGS=$CFLAGS` (redundant, use flags as above with `-march=native` if possible)
+- `export CFLAGS=$CFLAGS_NON_NATIVE` (flags as above without `-march=native`)
+- `export CFLAGS=$CFLAGS_O3` (`O3` instead of `O2`, but only if not in debug mode, add `-march=native` if possible)
+- `export CFLAGS=$CFLAGS_O3_NON_NATIVE` (`O3` instead of `O2`, no `-march=native`)
+- `export CFLAGS=$ORIGINAL_CFLAGS` (use `$CFLAGS` as set before `configure`)
+
+Likewise we do with `CXXFLAGS`, `FCFLAGS`, `F77FLAGS`.
+
+We try to respect the users choice and do not overwrite the flags if already set by the user, but only add compile flags if absolutely necessary for packages to work.
+
+Inidividual packages can still be compiled with specified flags or in debug mode using
+
+```
+make CFLAGS=-O2 some-package
+```
+or
+
+```
+make SAGE_DEBUG="yes" some-package
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_521784.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#30375\"",
    "created_at": "2020-08-16T07:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521784",
    "user": "https://github.com/kliem"
}
```

Changing dependencies from "" to "#30375"



---

archive/issue_comments_521785.json:
```json
{
    "body": "<a id='comment:129'></a>Replying to [comment:126 mkoeppe]:\n> Yes, I agree with both points.\n\n\nOk. The controversial part of adding `-march=native` is now down to a rather small commit.",
    "created_at": "2020-08-16T07:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521785",
    "user": "https://github.com/kliem"
}
```

<a id='comment:129'></a>Replying to [comment:126 mkoeppe]:
> Yes, I agree with both points.


Ok. The controversial part of adding `-march=native` is now down to a rather small commit.



---

archive/issue_comments_521786.json:
```json
{
    "body": "Changing work_issues from \"\" to \"Merge latest branch of dependencies\"",
    "created_at": "2020-12-01T17:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521786",
    "user": "https://github.com/mkoeppe"
}
```

Changing work_issues from "" to "Merge latest branch of dependencies"



---

archive/issue_comments_521787.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-01T17:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521787",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_521788.json:
```json
{
    "body": "Changing branch from \"u/gh-kliem/march_native_in_configure\" to \"u/gh-kliem/march_native_on_30375\"",
    "created_at": "2020-12-03T10:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521788",
    "user": "https://github.com/kliem"
}
```

Changing branch from "u/gh-kliem/march_native_in_configure" to "u/gh-kliem/march_native_on_30375"



---

archive/issue_comments_521789.json:
```json
{
    "body": "<a id='comment:1'></a>Last 10 new commits:",
    "created_at": "2020-12-03T10:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521789",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>Last 10 new commits:



---

archive/issue_comments_521790.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-03T10:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521790",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_521791.json:
```json
{
    "body": "Changing commit from \"5da42f16bf3d470bbc6e42beaa3e7485650a3f36\" to \"4e6273441de2114a7a9ea36a69a3137976a1bfa2\"",
    "created_at": "2020-12-03T10:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521791",
    "user": "https://github.com/kliem"
}
```

Changing commit from "5da42f16bf3d470bbc6e42beaa3e7485650a3f36" to "4e6273441de2114a7a9ea36a69a3137976a1bfa2"



---

archive/issue_comments_521792.json:
```json
{
    "body": "Changing commit from \"4e6273441de2114a7a9ea36a69a3137976a1bfa2\" to \"a1ffd9b1c5ee9689ad628ebbe48847a495e1c0d1\"",
    "created_at": "2020-12-03T17:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521792",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4e6273441de2114a7a9ea36a69a3137976a1bfa2" to "a1ffd9b1c5ee9689ad628ebbe48847a495e1c0d1"



---

archive/issue_comments_521793.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-03T17:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521793",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521794.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-12-15T06:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521794",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_521795.json:
```json
{
    "body": "Changing commit from \"a1ffd9b1c5ee9689ad628ebbe48847a495e1c0d1\" to \"ea601ea6742ddcfab610aeb7cc53fec375d77c7a\"",
    "created_at": "2020-12-15T06:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a1ffd9b1c5ee9689ad628ebbe48847a495e1c0d1" to "ea601ea6742ddcfab610aeb7cc53fec375d77c7a"



---

archive/issue_comments_521796.json:
```json
{
    "body": "Changing work_issues from \"Merge latest branch of dependencies\" to \"\"",
    "created_at": "2020-12-21T04:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521796",
    "user": "https://github.com/mkoeppe"
}
```

Changing work_issues from "Merge latest branch of dependencies" to ""



---

archive/issue_comments_521797.json:
```json
{
    "body": "Changing reviewer from \"Matthias Koeppe\" to \"Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861\"",
    "created_at": "2020-12-21T04:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521797",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "Matthias Koeppe" to "Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861"



---

archive/issue_comments_521798.json:
```json
{
    "body": "<a id='comment:5'></a>Instead of `SAGE_MARCH`, perhaps something like `CFLAGS_MARCH`...?!\nAnd I would suggest to not use the prefix `CONFIGURED_` here -- because I think this is not a case as for CFLAGS where we want to respect user variable settings?",
    "created_at": "2020-12-21T18:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521798",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Instead of `SAGE_MARCH`, perhaps something like `CFLAGS_MARCH`...?!
And I would suggest to not use the prefix `CONFIGURED_` here -- because I think this is not a case as for CFLAGS where we want to respect user variable settings?



---

archive/issue_comments_521799.json:
```json
{
    "body": "Changing commit from \"ea601ea6742ddcfab610aeb7cc53fec375d77c7a\" to \"73ecf70a1ecfa0be713378bcc3c674804a908e57\"",
    "created_at": "2020-12-21T18:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521799",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ea601ea6742ddcfab610aeb7cc53fec375d77c7a" to "73ecf70a1ecfa0be713378bcc3c674804a908e57"



---

archive/issue_comments_521800.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-21T18:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521801.json:
```json
{
    "body": "<a id='comment:137'></a>Replying to [comment:135 mkoeppe]:\n> Instead of `SAGE_MARCH`, perhaps something like `CFLAGS_MARCH`...?!\n> And I would suggest to not use the prefix `CONFIGURED_` here -- because I think this is not a case as for CFLAGS where we want to respect user variable settings?\n\n\nSure.",
    "created_at": "2020-12-21T18:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521801",
    "user": "https://github.com/kliem"
}
```

<a id='comment:137'></a>Replying to [comment:135 mkoeppe]:
> Instead of `SAGE_MARCH`, perhaps something like `CFLAGS_MARCH`...?!
> And I would suggest to not use the prefix `CONFIGURED_` here -- because I think this is not a case as for CFLAGS where we want to respect user variable settings?


Sure.



---

archive/issue_comments_521802.json:
```json
{
    "body": "<a id='comment:8'></a>And I thought you had found a better solution for that `free-form` business in #30375?",
    "created_at": "2020-12-21T18:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521802",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>And I thought you had found a better solution for that `free-form` business in #30375?



---

archive/issue_comments_521803.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-21T20:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521803",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_521804.json:
```json
{
    "body": "Changing commit from \"73ecf70a1ecfa0be713378bcc3c674804a908e57\" to \"7bc1f285f9256ebe8f5749848bfd3b97bc173853\"",
    "created_at": "2020-12-21T20:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521804",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "73ecf70a1ecfa0be713378bcc3c674804a908e57" to "7bc1f285f9256ebe8f5749848bfd3b97bc173853"



---

archive/issue_comments_521805.json:
```json
{
    "body": "<a id='comment:140'></a>Replying to [comment:138 mkoeppe]:\n> And I thought you had found a better solution for that `free-form` business in #30375?\n\n\nRight, I forgot to change that.",
    "created_at": "2020-12-21T20:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521805",
    "user": "https://github.com/kliem"
}
```

<a id='comment:140'></a>Replying to [comment:138 mkoeppe]:
> And I thought you had found a better solution for that `free-form` business in #30375?


Right, I forgot to change that.



---

archive/issue_comments_521806.json:
```json
{
    "body": "<a id='comment:1'></a>Looks good to me. If you have capacity on GH Actions, could you run it one more time? (Ideally with #31064 for the latest version of the cygwin workflow)",
    "created_at": "2020-12-21T23:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521806",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>Looks good to me. If you have capacity on GH Actions, could you run it one more time? (Ideally with #31064 for the latest version of the cygwin workflow)



---

archive/issue_comments_521807.json:
```json
{
    "body": "Changing reviewer from \"Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861\" to \"Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861, https://github.com/kliem/sage/pull/30/checks\"",
    "created_at": "2020-12-22T07:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521807",
    "user": "https://github.com/kliem"
}
```

Changing reviewer from "Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861" to "Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861, https://github.com/kliem/sage/pull/30/checks"



---

archive/issue_comments_521808.json:
```json
{
    "body": "<a id='comment:143'></a>Replying to [comment:141 mkoeppe]:\n> Looks good to me. If you have capacity on GH Actions, could you run it one more time? (Ideally with #31064 for the latest version of the cygwin workflow)\n\n\nCapacities are fine. Actually, I'm not using it most of the time, so if you ping me, I can run something.",
    "created_at": "2020-12-22T07:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521808",
    "user": "https://github.com/kliem"
}
```

<a id='comment:143'></a>Replying to [comment:141 mkoeppe]:
> Looks good to me. If you have capacity on GH Actions, could you run it one more time? (Ideally with #31064 for the latest version of the cygwin workflow)


Capacities are fine. Actually, I'm not using it most of the time, so if you ping me, I can run something.



---

archive/issue_comments_521809.json:
```json
{
    "body": "Changing reviewer from \"Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861, https://github.com/kliem/sage/pull/30/checks\" to \"Matthias Koeppe\"",
    "created_at": "2020-12-25T19:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521809",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/434965861, https://github.com/kliem/sage/pull/30/checks" to "Matthias Koeppe"



---

archive/issue_comments_521810.json:
```json
{
    "body": "<a id='comment:4'></a>Looking good. Thanks for your patience with this long review process.",
    "created_at": "2020-12-25T19:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521810",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>Looking good. Thanks for your patience with this long review process.



---

archive/issue_comments_521811.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-25T19:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521811",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_521812.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-27T23:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521812",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_521813.json:
```json
{
    "body": "Changing branch from \"u/gh-kliem/march_native_on_30375\" to \"7bc1f285f9256ebe8f5749848bfd3b97bc173853\"",
    "created_at": "2020-12-27T23:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521813",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/gh-kliem/march_native_on_30375" to "7bc1f285f9256ebe8f5749848bfd3b97bc173853"



---

archive/issue_events_067372.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-27T23:25:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27122#event-67372"
}
```



---

archive/issue_comments_521814.json:
```json
{
    "body": "<a id='comment:146'></a>Replying to [comment:144 mkoeppe]:\n> Looking good. Thanks for your patience with this long review process.\n> \n\n\nThank you. And thank you in particular for creating the github workflow for testing.",
    "created_at": "2020-12-28T06:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521814",
    "user": "https://github.com/kliem"
}
```

<a id='comment:146'></a>Replying to [comment:144 mkoeppe]:
> Looking good. Thanks for your patience with this long review process.
> 


Thank you. And thank you in particular for creating the github workflow for testing.



---

archive/issue_comments_521815.json:
```json
{
    "body": "Changing commit from \"7bc1f285f9256ebe8f5749848bfd3b97bc173853\" to \"\"",
    "created_at": "2020-12-28T06:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27122#issuecomment-521815",
    "user": "https://github.com/kliem"
}
```

Changing commit from "7bc1f285f9256ebe8f5749848bfd3b97bc173853" to ""
