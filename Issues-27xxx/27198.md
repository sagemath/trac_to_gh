# Issue 27198: Fix overflow problems for extremely large meataxe matrices

archive/issues_026961.json:
```json
{
    "assignees": [],
    "body": "As observed at #27152, extremely large MeatAxe matrices seem to be problematic.\n\n```\nsage: %time M = matrix(GF(243), 2^16, 2^16)\nCPU times: user 7min 23s, sys: 1.06 s, total: 7min 24s\nWall time: 7min 25s\nsage: pickle = dumps(M)\n<segfault>\n```\n\nDepends on #27152\n\nBranch/Commit: **[u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices) @ [`f559516`](https://github.com/sagemath/sagetrac-mirror/commit/f5595165184e58ed7cc55863e767281690a35331)**\n\nAuthor: **Simon King**\n\nComponent: **packages: optional**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27198_\n\n",
    "created_at": "2019-02-01T13:09:23Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix overflow problems for extremely large meataxe matrices",
    "type": "issue",
    "updated_at": "2022-08-06T19:55:19Z",
    "url": "https://github.com/sagemath/sage/issues/27198",
    "user": "https://github.com/simon-king-jena"
}
```
As observed at #27152, extremely large MeatAxe matrices seem to be problematic.

```
sage: %time M = matrix(GF(243), 2^16, 2^16)
CPU times: user 7min 23s, sys: 1.06 s, total: 7min 24s
Wall time: 7min 25s
sage: pickle = dumps(M)
<segfault>
```

Depends on #27152

Branch/Commit: **[u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices) @ [`f559516`](https://github.com/sagemath/sagetrac-mirror/commit/f5595165184e58ed7cc55863e767281690a35331)**

Author: **Simon King**

Component: **packages: optional**

_Issue created by migration from https://trac.sagemath.org/ticket/27198_





---

archive/issue_events_375527.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-01T13:09:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375527"
}
```



---

archive/issue_events_375528.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-01T13:09:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "c: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375528"
}
```



---

archive/issue_events_375529.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-01T13:09:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375529"
}
```



---

archive/issue_events_375530.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-01T13:09:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375530"
}
```



---

archive/issue_comments_419789.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nNote that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.",
    "created_at": "2019-02-01T20:05:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419789",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:1" align="right">comment:1</div>

Note that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.



---

archive/issue_comments_419790.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nReplying to [@jdemeyer](#comment:1):\n> Note that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.\n\nRight. I've never actually worked with matrices that big, and it could very well be that there is some kind of overflow in SharedMeatAxe. But first, I'd like to see what is the smallest example exposing the wrong item access resp. the segfault, so that it doesn't take so long time (7 minutes) for each test run.",
    "created_at": "2019-02-01T20:14:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419790",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

Replying to [@jdemeyer](#comment:1):
> Note that the problems could be either in the Sage wrapper or it could also be upstream in (shared)meataxe.

Right. I've never actually worked with matrices that big, and it could very well be that there is some kind of overflow in SharedMeatAxe. But first, I'd like to see what is the smallest example exposing the wrong item access resp. the segfault, so that it doesn't take so long time (7 minutes) for each test run.



---

archive/issue_comments_419791.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nOuch, I am so stupid. I worked with a field of size `243=3^5` and was assigning the value `123`, which is divisible by 3 and thus zero. So, the item assignment probably is a non-issue.",
    "created_at": "2019-02-01T20:22:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419791",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

Ouch, I am so stupid. I worked with a field of size `243=3^5` and was assigning the value `123`, which is divisible by 3 and thus zero. So, the item assignment probably is a non-issue.



---

archive/issue_comments_419792.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,18 +1,9 @@\n-As observed at #27152, extremely large MeatAxe matrices seem to be problematic in several regards.\n+As observed at #27152, extremely large MeatAxe matrices seem to be problematic.\n \n ```\n sage: %time M = matrix(GF(243), 2^16, 2^16)\n CPU times: user 7min 23s, sys: 1.06 s, total: 7min 24s\n Wall time: 7min 25s\n-sage: M[0,0]\n-0\n-sage: M[2^16-1,0]\n-0\n-sage: M[2^16-1,2^16-1]\n-0\n-sage: M[2^16-1,2^16-1] = 123\n-sage: M[2^16-1,2^16-1]  # wrong\n-0\n sage: pickle = dumps(M)\n <segfault>\n ```\n``````\n",
    "created_at": "2019-02-01T20:34:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419792",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,18 +1,9 @@
-As observed at #27152, extremely large MeatAxe matrices seem to be problematic in several regards.
+As observed at #27152, extremely large MeatAxe matrices seem to be problematic.
 
 ```
 sage: %time M = matrix(GF(243), 2^16, 2^16)
 CPU times: user 7min 23s, sys: 1.06 s, total: 7min 24s
 Wall time: 7min 25s
-sage: M[0,0]
-0
-sage: M[2^16-1,0]
-0
-sage: M[2^16-1,2^16-1]
-0
-sage: M[2^16-1,2^16-1] = 123
-sage: M[2^16-1,2^16-1]  # wrong
-0
 sage: pickle = dumps(M)
 <segfault>
 ```
``````




---

archive/issue_comments_419793.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nPS: I find it unlikely that the problem is upstrem. Both `__reduce__` and `mtx_unpickle` hardly call a meataxe library function. It's basically memcopy and pointer advancement. With one exception, though: The global variables `FfCurrentRowSize` and `FfCurrentRowSizeIo` are set by calling a library function. So, that could potentially go wrong upstream.\n\nWe'll see.",
    "created_at": "2019-02-01T20:39:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419793",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

PS: I find it unlikely that the problem is upstrem. Both `__reduce__` and `mtx_unpickle` hardly call a meataxe library function. It's basically memcopy and pointer advancement. With one exception, though: The global variables `FfCurrentRowSize` and `FfCurrentRowSizeIo` are set by calling a library function. So, that could potentially go wrong upstream.

We'll see.



---

archive/issue_comments_419794.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nInterestingly, allocating an empty matrix of only 1/4 of the size takes about the same time. Could that indicate a problem? Pickling of that smaller matrix fails, because Sage cannot allocate enough memory. But it doesn't crash:\n\n```\nsage: %time M = matrix(GF(243), 2^16-1, 2^16-1)\nCPU times: user 7min 33s, sys: 809 ms, total: 7min 34s\nWall time: 7min 34s\nsage: d = dumps(M)\n---------------------------------------------------------------------------\nMemoryError                               Traceback (most recent call last)\n<ipython-input-2-aaf8f192cb1c> in <module>()\n----> 1 d = dumps(M)\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4160)()\n    281         picklejar(obj)\n    282     try:\n--> 283         return obj.dumps(compress)\n    284     except (AttributeError, RuntimeError, TypeError):\n    285         return _base_dumps(obj, compress=compress)\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3638)()\n    462         \"\"\"\n    463 \n--> 464         return _base_dumps(self, compress=compress)\n    465 \n    466     #############################################################################\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:3894)()\n    254     \"\"\"\n    255 \n--> 256     gherkin = SagePickler.dumps(obj)\n    257 \n    258     if compress:\n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6609)()\n    833         buf = io.BytesIO()\n    834         pickler = cls(buf, **kwargs)\n--> 835         pickler.dump(obj)\n    836         return buf.getvalue()\n    837 \n\n/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__reduce__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:6122)()\n    531             FfSetNoc(self.Data.Noc)\n    532             pickle_size = FfCurrentRowSizeIo*self.Data.Nor\n--> 533             d = <char*>check_malloc(pickle_size)\n    534             p = self.Data.Data\n    535             x = d\n\nmemory.pxd in cysignals.memory.check_malloc (build/cythonized/sage/matrix/matrix_gfpn_dense.c:17384)()\n\nMemoryError: failed to allocate 18446744073709420545 bytes\n```\nI find the number of bytes-to-be-allocated interesting. It should allocate `pickle_size` bytes, and `pickle_size=FfCurrentRowSizeIo*self.Data.Nor`. We have `self.Data.Nor = 2^16-1`, and `FfCurrentRowSizeIo` should be the number of bytes needed to store one row. Since the field is relatively large, one item will be stored in a single byte, and thus I'd expect `FfCurrentRowSizeIo=2^16-1`.\n\nHence, the number of bytes to be allocated should be `4294836225 = (2<sup>16-1)</sup>2`, and that's far less than what the `__reduce__` method is trying to allocate.",
    "created_at": "2019-02-01T20:51:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419794",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

Interestingly, allocating an empty matrix of only 1/4 of the size takes about the same time. Could that indicate a problem? Pickling of that smaller matrix fails, because Sage cannot allocate enough memory. But it doesn't crash:

```
sage: %time M = matrix(GF(243), 2^16-1, 2^16-1)
CPU times: user 7min 33s, sys: 809 ms, total: 7min 34s
Wall time: 7min 34s
sage: d = dumps(M)
---------------------------------------------------------------------------
MemoryError                               Traceback (most recent call last)
<ipython-input-2-aaf8f192cb1c> in <module>()
----> 1 d = dumps(M)

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.dumps (build/cythonized/sage/misc/persist.c:4160)()
    281         picklejar(obj)
    282     try:
--> 283         return obj.dumps(compress)
    284     except (AttributeError, RuntimeError, TypeError):
    285         return _base_dumps(obj, compress=compress)

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject.dumps (build/cythonized/sage/structure/sage_object.c:3638)()
    462         """
    463 
--> 464         return _base_dumps(self, compress=compress)
    465 
    466     #############################################################################

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist._base_dumps (build/cythonized/sage/misc/persist.c:3894)()
    254     """
    255 
--> 256     gherkin = SagePickler.dumps(obj)
    257 
    258     if compress:

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/misc/persist.pyx in sage.misc.persist.SagePickler.dumps (build/cythonized/sage/misc/persist.c:6609)()
    833         buf = io.BytesIO()
    834         pickler = cls(buf, **kwargs)
--> 835         pickler.dump(obj)
    836         return buf.getvalue()
    837 

/home/king/Sage/git/py3/local/lib/python3.6/site-packages/sage/matrix/matrix_gfpn_dense.pyx in sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.__reduce__ (build/cythonized/sage/matrix/matrix_gfpn_dense.c:6122)()
    531             FfSetNoc(self.Data.Noc)
    532             pickle_size = FfCurrentRowSizeIo*self.Data.Nor
--> 533             d = <char*>check_malloc(pickle_size)
    534             p = self.Data.Data
    535             x = d

memory.pxd in cysignals.memory.check_malloc (build/cythonized/sage/matrix/matrix_gfpn_dense.c:17384)()

MemoryError: failed to allocate 18446744073709420545 bytes
```
I find the number of bytes-to-be-allocated interesting. It should allocate `pickle_size` bytes, and `pickle_size=FfCurrentRowSizeIo*self.Data.Nor`. We have `self.Data.Nor = 2^16-1`, and `FfCurrentRowSizeIo` should be the number of bytes needed to store one row. Since the field is relatively large, one item will be stored in a single byte, and thus I'd expect `FfCurrentRowSizeIo=2^16-1`.

Hence, the number of bytes to be allocated should be `4294836225 = (2<sup>16-1)</sup>2`, and that's far less than what the `__reduce__` method is trying to allocate.



---

archive/issue_comments_419795.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@simon-king-jena](#comment:6):\n> \n> ```\n> MemoryError: failed to allocate 18446744073709420545 bytes\n> ```\n> I find the number of bytes-to-be-allocated interesting.\n\nYes. As I mentioned already in #27152, there is an overflow in the line \n\n```\npickle_size = FfCurrentRowSizeIo*self.Data.Nor\n```",
    "created_at": "2019-02-01T20:57:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419795",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@simon-king-jena](#comment:6):
> 
> ```
> MemoryError: failed to allocate 18446744073709420545 bytes
> ```
> I find the number of bytes-to-be-allocated interesting.

Yes. As I mentioned already in #27152, there is an overflow in the line 

```
pickle_size = FfCurrentRowSizeIo*self.Data.Nor
```



---

archive/issue_comments_419796.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@jdemeyer](#comment:7):\n> Yes. As I mentioned already in #27152, there is an overflow in the line \n> \n> ```\n> pickle_size = FfCurrentRowSizeIo*self.Data.Nor\n> ```\n\nRight, I thought I had fixed it by using `Py_ssize_t`, but just realise that that was in a different place.",
    "created_at": "2019-02-01T21:35:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419796",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@jdemeyer](#comment:7):
> Yes. As I mentioned already in #27152, there is an overflow in the line 
> 
> ```
> pickle_size = FfCurrentRowSizeIo*self.Data.Nor
> ```

Right, I thought I had fixed it by using `Py_ssize_t`, but just realise that that was in a different place.



---

archive/issue_comments_419797.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI don't understand what type I should use for pickle_size.\n\nWhen using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.",
    "created_at": "2019-02-01T21:51:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419797",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

I don't understand what type I should use for pickle_size.

When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.



---

archive/issue_comments_419798.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@simon-king-jena](#comment:9):\n> When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.\n\nThe problem is not the assignment, the problem is the multiplication. You need to do something like\n\n```\npickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor\n```\n(one of the two casts should be sufficient)",
    "created_at": "2019-02-01T21:57:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419798",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@simon-king-jena](#comment:9):
> When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.

The problem is not the assignment, the problem is the multiplication. You need to do something like

```
pickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor
```
(one of the two casts should be sufficient)



---

archive/issue_comments_419799.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jdemeyer](#comment:10):\n> Replying to [@simon-king-jena](#comment:9):\n> > When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.\n\n> \n> The problem is not the assignment, the problem is the multiplication. You need to do something like\n> \n> ```\n> pickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor\n> ```\n> (one of the two casts should be sufficient)\n\nI see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`? That's what I am testing right now, but when you find that problematic, I could change it before posting a commit.",
    "created_at": "2019-02-01T21:59:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419799",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jdemeyer](#comment:10):
> Replying to [@simon-king-jena](#comment:9):
> > When using `Py_ssize_t`, I still get `failed to allocate 18446744073709420545 bytes`.

> 
> The problem is not the assignment, the problem is the multiplication. You need to do something like
> 
> ```
> pickle_size = <Py_ssize_t>FfCurrentRowSizeIo * <Py_ssize_t>self.Data.Nor
> ```
> (one of the two casts should be sufficient)

I see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`? That's what I am testing right now, but when you find that problematic, I could change it before posting a commit.



---

archive/issue_comments_419800.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@simon-king-jena](#comment:11):\n> I see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?\n\nIt works, but the size of data is so that my computer basically freezes.\n\nAnother question: The pickling does\n\n```\n            d = <char*>check_malloc(pickle_size)\n            p = self.Data.Data\n            x = d\n            for i in range(self.Data.Nor):\n                memcpy(x, p, FfCurrentRowSizeIo)\n                sig_check()\n                x += FfCurrentRowSizeIo\n                FfStepPtr(&p)\n```\nwhich is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).\n\nThen, it does\n\n```\n            pickle_str = PyBytes_FromStringAndSize(d, pickle_size)\n            sig_free(d)\n```\n\nIf I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.\n\nWouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?",
    "created_at": "2019-02-01T22:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419800",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@simon-king-jena](#comment:11):
> I see. Actually I figured something like that. Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?

It works, but the size of data is so that my computer basically freezes.

Another question: The pickling does

```
            d = <char*>check_malloc(pickle_size)
            p = self.Data.Data
            x = d
            for i in range(self.Data.Nor):
                memcpy(x, p, FfCurrentRowSizeIo)
                sig_check()
                x += FfCurrentRowSizeIo
                FfStepPtr(&p)
```
which is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).

Then, it does

```
            pickle_str = PyBytes_FromStringAndSize(d, pickle_size)
            sig_free(d)
```

If I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.

Wouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?



---

archive/issue_comments_419801.json:
```json
{
    "body": "Branch: **[u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices)**",
    "created_at": "2019-02-01T22:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419801",
    "user": "https://github.com/simon-king-jena"
}
```

Branch: **[u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/fix_overflow_problems_for_extremely_large_meataxe_matrices)**



---

archive/issue_comments_419802.json:
```json
{
    "body": "Commit: **[`211f733`](https://github.com/sagemath/sagetrac-mirror/commit/211f7333f4fdbd12f8d668be793338bd18d296e7)**",
    "created_at": "2019-02-02T20:31:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419802",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`211f733`](https://github.com/sagemath/sagetrac-mirror/commit/211f7333f4fdbd12f8d668be793338bd18d296e7)**



---

archive/issue_comments_419803.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/211f7333f4fdbd12f8d668be793338bd18d296e7\"><code>211f733</code></a></td><td><code>Avoid unnecessary copies in pickling meataxe matrices</code></td></tr></table>\n",
    "created_at": "2019-02-02T20:31:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419803",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/211f7333f4fdbd12f8d668be793338bd18d296e7"><code>211f733</code></a></td><td><code>Avoid unnecessary copies in pickling meataxe matrices</code></td></tr></table>




---

archive/issue_comments_419804.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThe segfault / overflow seems to be gone.",
    "created_at": "2019-02-02T21:10:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419804",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

The segfault / overflow seems to be gone.



---

archive/issue_comments_419805.json:
```json
{
    "body": "Author: **Simon King**",
    "created_at": "2019-02-02T21:10:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419805",
    "user": "https://github.com/simon-king-jena"
}
```

Author: **Simon King**



---

archive/issue_events_375531.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2019-02-02T21:10:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375531"
}
```



---

archive/issue_comments_419806.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@simon-king-jena](#comment:12):\n> Another question: The pickling does\n> \n> ```\n>             d = <char*>check_malloc(pickle_size)\n>             p = self.Data.Data\n>             x = d\n>             for i in range(self.Data.Nor):\n>                 memcpy(x, p, FfCurrentRowSizeIo)\n>                 sig_check()\n>                 x += FfCurrentRowSizeIo\n>                 FfStepPtr(&p)\n> ```\n> which is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).\n> \n> Then, it does\n> \n> ```\n>             pickle_str = PyBytes_FromStringAndSize(d, pickle_size)\n>             sig_free(d)\n> ```\n> \n> If I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.\n> \n> Wouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?\n\n```\ncdef bytes pickle_bytes = PyBytes_FromStringAndSize(NULL, pickle_size)\ncdef char* x = PyBytes_AS_STRING(pickle_bytes)\n```\nand then write into `x` as before and return `pickle_bytes` (which is a better name than `pickle_str`)",
    "created_at": "2019-02-04T09:10:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419806",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@simon-king-jena](#comment:12):
> Another question: The pickling does
> 
> ```
>             d = <char*>check_malloc(pickle_size)
>             p = self.Data.Data
>             x = d
>             for i in range(self.Data.Nor):
>                 memcpy(x, p, FfCurrentRowSizeIo)
>                 sig_check()
>                 x += FfCurrentRowSizeIo
>                 FfStepPtr(&p)
> ```
> which is basically copied from an upstream function that directly writes to a file (that's why pickling doesn't use that upstream function).
> 
> Then, it does
> 
> ```
>             pickle_str = PyBytes_FromStringAndSize(d, pickle_size)
>             sig_free(d)
> ```
> 
> If I understand correctly, `PyBytes_FromStringAndSize` *copies* `d`.
> 
> Wouldn't it be better to use the above loop to directly write into a Python `bytes` using cpython functions, rather than creating a `char*` temporarily? But how?

```
cdef bytes pickle_bytes = PyBytes_FromStringAndSize(NULL, pickle_size)
cdef char* x = PyBytes_AS_STRING(pickle_bytes)
```
and then write into `x` as before and return `pickle_bytes` (which is a better name than `pickle_str`)



---

archive/issue_comments_419807.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@simon-king-jena](#comment:11):\n> Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?\n\nTechnically, yes that would work. But I think it's worse in terms of understanding what the code does: what is the meaning (to a human) of `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo`?\n\nIt's fine for me if you use a different variable name:\n\n```\ncdef Py_ssize_t row_size = FfCurrentRowSizeIo\ncdef Py_ssize_t pickle_size = row_size * self.Data.Nor\n```",
    "created_at": "2019-02-04T09:14:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419807",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@simon-king-jena](#comment:11):
> Would it be ok to first assign `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo` and then later do `pickle_size *= self.Data.Nor`?

Technically, yes that would work. But I think it's worse in terms of understanding what the code does: what is the meaning (to a human) of `cdef Py_ssize_t pickle_size = FfCurrentRowSizeIo`?

It's fine for me if you use a different variable name:

```
cdef Py_ssize_t row_size = FfCurrentRowSizeIo
cdef Py_ssize_t pickle_size = row_size * self.Data.Nor
```



---

archive/issue_comments_419808.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nYou have\n\n```\npickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)\n```\ntwice. Why that?",
    "created_at": "2019-02-04T09:14:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419808",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

You have

```
pickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)
```
twice. Why that?



---

archive/issue_comments_419809.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jdemeyer](#comment:18):\n> You have\n> \n> ```\n> pickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)\n> ```\n> twice. Why that?\n\nOops. Thanks for catching it.",
    "created_at": "2019-02-04T09:17:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419809",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jdemeyer](#comment:18):
> You have
> 
> ```
> pickle_str = PyBytes_FromStringAndSize(NULL, pickle_size)
> ```
> twice. Why that?

Oops. Thanks for catching it.



---

archive/issue_comments_419810.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nIsn't this an unused variable?\n\n```\nnor = self.Data.Nor\n```\n\nFor `pickled_rowsize`, I would also use `Py_ssize_t`.",
    "created_at": "2019-02-04T09:19:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419810",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Isn't this an unused variable?

```
nor = self.Data.Nor
```

For `pickled_rowsize`, I would also use `Py_ssize_t`.



---

archive/issue_comments_419811.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/14398d2a6bd9d5cb7e7929a97c977cafce0b5923\"><code>14398d2</code></a></td><td><code>Code cleanup and fixing another potential overflow</code></td></tr></table>\n",
    "created_at": "2019-02-04T11:47:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419811",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/14398d2a6bd9d5cb7e7929a97c977cafce0b5923"><code>14398d2</code></a></td><td><code>Code cleanup and fixing another potential overflow</code></td></tr></table>




---

archive/issue_comments_419812.json:
```json
{
    "body": "Changed commit from **[`211f733`](https://github.com/sagemath/sagetrac-mirror/commit/211f7333f4fdbd12f8d668be793338bd18d296e7)** to **[`14398d2`](https://github.com/sagemath/sagetrac-mirror/commit/14398d2a6bd9d5cb7e7929a97c977cafce0b5923)**",
    "created_at": "2019-02-04T11:47:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419812",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`211f733`](https://github.com/sagemath/sagetrac-mirror/commit/211f7333f4fdbd12f8d668be793338bd18d296e7)** to **[`14398d2`](https://github.com/sagemath/sagetrac-mirror/commit/14398d2a6bd9d5cb7e7929a97c977cafce0b5923)**



---

archive/issue_comments_419813.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThe last commit addresses your comments. Also I deal with another potential overflow, namely\n\n```diff\n-            if <size_t>pickled_rowsize == FfCurrentRowSize:\n-                memcpy(OUT.Data.Data, x, OUT.Data.RowSize*OUT.Data.Nor)\n+            if pickled_rowsize == <Py_ssize_t>FfCurrentRowSize:\n+                memcpy(OUT.Data.Data, x, <Py_ssize_t>OUT.Data.RowSize*<Py_ssize_t>OUT.Data.Nor)\n```",
    "created_at": "2019-02-04T11:48:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419813",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

The last commit addresses your comments. Also I deal with another potential overflow, namely

```diff
-            if <size_t>pickled_rowsize == FfCurrentRowSize:
-                memcpy(OUT.Data.Data, x, OUT.Data.RowSize*OUT.Data.Nor)
+            if pickled_rowsize == <Py_ssize_t>FfCurrentRowSize:
+                memcpy(OUT.Data.Data, x, <Py_ssize_t>OUT.Data.RowSize*<Py_ssize_t>OUT.Data.Nor)
```



---

archive/issue_comments_419814.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nTicket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419814",
    "user": "https://github.com/embray"
}
```

<div id="comment:23" align="right">comment:23</div>

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_375532.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375532"
}
```



---

archive/issue_events_375533.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375533"
}
```



---

archive/issue_events_375534.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375534"
}
```



---

archive/issue_events_375535.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:37:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375535"
}
```



---

archive/issue_comments_419815.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nMoving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419815",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_events_375536.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375536"
}
```



---

archive/issue_events_375537.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375537"
}
```



---

archive/issue_comments_419816.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nTicket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419816",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">comment:25</div>

Ticket retargeted after milestone closed



---

archive/issue_comments_419817.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nred branch",
    "created_at": "2020-01-02T19:52:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419817",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:26" align="right">comment:26</div>

red branch



---

archive/issue_events_375538.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-01-02T19:52:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375538"
}
```



---

archive/issue_events_375539.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-01-02T19:52:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375539"
}
```



---

archive/issue_comments_419818.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nSigh. I totally forgot about that ticket. Really unfortunate that the review wasn't finished.",
    "created_at": "2020-01-02T21:27:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419818",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:27" align="right">comment:27</div>

Sigh. I totally forgot about that ticket. Really unfortunate that the review wasn't finished.



---

archive/issue_comments_419819.json:
```json
{
    "body": "<div id=\"comment:28\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4c21d8b38929af26ff6de2ad5340708ae3cd5325\"><code>4c21d8b</code></a></td><td><code>meataxe/matrix_gfpn_dense: Fix most comparisons of signed and unsigned types</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/28326d2b39fdb8d71598300a1cb20b7827d25e4b\"><code>28326d2</code></a></td><td><code>Make the type of FfCurrentRowSizeIo comply with upstream's choice</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a5ba71c40aec9b668b99c6a77d7c5b1b38ede579\"><code>a5ba71c</code></a></td><td><code>Use Py_ssize_t to avoid overflow</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eb1cc331a8432720f31fc40189e23e932ab2234b\"><code>eb1cc33</code></a></td><td><code>Avoid unnecessary copies in pickling meataxe matrices</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f5595165184e58ed7cc55863e767281690a35331\"><code>f559516</code></a></td><td><code>Code cleanup and fixing another potential overflow</code></td></tr></table>\n",
    "created_at": "2020-01-10T20:51:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419819",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:28"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4c21d8b38929af26ff6de2ad5340708ae3cd5325"><code>4c21d8b</code></a></td><td><code>meataxe/matrix_gfpn_dense: Fix most comparisons of signed and unsigned types</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/28326d2b39fdb8d71598300a1cb20b7827d25e4b"><code>28326d2</code></a></td><td><code>Make the type of FfCurrentRowSizeIo comply with upstream's choice</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a5ba71c40aec9b668b99c6a77d7c5b1b38ede579"><code>a5ba71c</code></a></td><td><code>Use Py_ssize_t to avoid overflow</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eb1cc331a8432720f31fc40189e23e932ab2234b"><code>eb1cc33</code></a></td><td><code>Avoid unnecessary copies in pickling meataxe matrices</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f5595165184e58ed7cc55863e767281690a35331"><code>f559516</code></a></td><td><code>Code cleanup and fixing another potential overflow</code></td></tr></table>




---

archive/issue_comments_419820.json:
```json
{
    "body": "Changed commit from **[`14398d2`](https://github.com/sagemath/sagetrac-mirror/commit/14398d2a6bd9d5cb7e7929a97c977cafce0b5923)** to **[`f559516`](https://github.com/sagemath/sagetrac-mirror/commit/f5595165184e58ed7cc55863e767281690a35331)**",
    "created_at": "2020-01-10T20:51:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419820",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`14398d2`](https://github.com/sagemath/sagetrac-mirror/commit/14398d2a6bd9d5cb7e7929a97c977cafce0b5923)** to **[`f559516`](https://github.com/sagemath/sagetrac-mirror/commit/f5595165184e58ed7cc55863e767281690a35331)**



---

archive/issue_events_375540.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2020-01-10T20:52:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375540"
}
```



---

archive/issue_events_375541.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2020-01-10T20:52:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375541"
}
```



---

archive/issue_comments_419821.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI hope I succeeded in rebasing the branch. Hopefully this time it doesn't start to bit rot.",
    "created_at": "2020-01-10T20:52:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419821",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:29" align="right">comment:29</div>

I hope I succeeded in rebasing the branch. Hopefully this time it doesn't start to bit rot.



---

archive/issue_comments_419822.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nThe `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.\n\nAlso, why all the changes `size_t` -> `int`?",
    "created_at": "2020-01-14T16:45:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419822",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:30" align="right">comment:30</div>

The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.

Also, why all the changes `size_t` -> `int`?



---

archive/issue_comments_419823.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@tscrim](#comment:30):\n> The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.\n\nOK. I don't recall why this change was made (actually I don't recall THAT such change was made).\n\n> Also, why all the changes `size_t` -> `int`?\n\nI think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.",
    "created_at": "2020-01-14T16:49:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419823",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@tscrim](#comment:30):
> The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.

OK. I don't recall why this change was made (actually I don't recall THAT such change was made).

> Also, why all the changes `size_t` -> `int`?

I think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.



---

archive/issue_comments_419824.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@simon-king-jena](#comment:31):\n> Replying to [@tscrim](#comment:30):\n> > The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.\n\n> \n> OK. I don't recall why this change was made (actually I don't recall THAT such change was made).\n\nMy guess from the looks of it comes from a mistake during a merge.\n\n> > Also, why all the changes `size_t` -> `int`?\n\n> \n> I think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.\n\nOkay. I just couldn't see anything in the comments about this, so I was curious. This change is good with me.",
    "created_at": "2020-01-14T17:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419824",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@simon-king-jena](#comment:31):
> Replying to [@tscrim](#comment:30):
> > The `_richcmp_` -> `_cmp_` change is backwards, so I think that needs to be reverted.

> 
> OK. I don't recall why this change was made (actually I don't recall THAT such change was made).

My guess from the looks of it comes from a mistake during a merge.

> > Also, why all the changes `size_t` -> `int`?

> 
> I think it was an attempt to fix some compiler warnings concerning comparison of signed and unsigned types. Or it was because the original MeatAxe had int where it ought to be size_t, and I didn't change the types in my fork (yet), and I wanted to be consistent in the Sage wrapper. I don't recall which of the two reasons it was.

Okay. I just couldn't see anything in the comments about this, so I was curious. This change is good with me.



---

archive/issue_events_375542.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375542"
}
```



---

archive/issue_events_375543.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375543"
}
```



---

archive/issue_comments_419825.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nMoving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419825",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:33" align="right">comment:33</div>

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_375544.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-05-30T06:55:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375544"
}
```



---

archive/issue_events_375545.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-05-30T06:55:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375545"
}
```



---

archive/issue_comments_419826.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nthe wrong change from richcmp to cmp is still there",
    "created_at": "2020-05-30T06:55:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419826",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:34" align="right">comment:34</div>

the wrong change from richcmp to cmp is still there



---

archive/issue_events_375546.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375546"
}
```



---

archive/issue_events_375547.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375547"
}
```



---

archive/issue_comments_419827.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419827",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">comment:36</div>

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_375548.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375548"
}
```



---

archive/issue_events_375549.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375549"
}
```



---

archive/issue_events_375550.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375550"
}
```



---

archive/issue_events_375551.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375551"
}
```



---

archive/issue_comments_419828.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27198#issuecomment-419828",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:37" align="right">comment:37</div>

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_375552.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375552"
}
```



---

archive/issue_events_375553.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375553"
}
```



---

archive/issue_events_375554.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375554"
}
```



---

archive/issue_events_375555.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375555"
}
```



---

archive/issue_events_375556.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-06T19:55:19Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375556"
}
```



---

archive/issue_events_375557.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-06T19:55:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27198",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27198#event-375557"
}
```
