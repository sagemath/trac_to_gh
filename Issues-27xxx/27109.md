# Issue 27109: libffi tries to install to ${prefix}/lib64 on some Linuxes

archive/issues_026872.json:
```json
{
    "assignees": [],
    "body": "The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.\n\nThis is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.\n\nCC:  @strogdon @fchapoton @jdemeyer\n\nBranch/Commit: **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**\n\nReviewer: **Jeroen Demeyer**\n\nAuthor: **Erik Bray**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/27109_\n\n",
    "closed_at": "2019-01-27T10:54:48Z",
    "created_at": "2019-01-24T13:19:36Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "libffi tries to install to ${prefix}/lib64 on some Linuxes",
    "type": "issue",
    "updated_at": "2019-01-27T10:54:48Z",
    "url": "https://github.com/sagemath/sage/issues/27109",
    "user": "https://github.com/embray"
}
```
The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.

This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.

CC:  @strogdon @fchapoton @jdemeyer

Branch/Commit: **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**

Reviewer: **Jeroen Demeyer**

Author: **Erik Bray**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/27109_





---

archive/issue_events_372564.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372564"
}
```



---

archive/issue_events_372565.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "000080",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372565"
}
```



---

archive/issue_events_372566.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372566"
}
```



---

archive/issue_events_372567.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372567"
}
```



---

archive/issue_comments_418247.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nJust in case you have anything to add.",
    "created_at": "2019-01-24T13:20:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418247",
    "user": "https://github.com/embray"
}
```

<div id="comment:1" align="right">comment:1</div>

Just in case you have anything to add.



---

archive/issue_comments_418248.json:
```json
{
    "body": "Replying to [ticket:27109 embray]:\n> I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.\n\nNo, it's because there hasn't been a release of libffi since 2014! There is a \"libffi 3.3 Release Candidate 0\" though: https://github.com/libffi/libffi/releases",
    "created_at": "2019-01-24T13:43:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418248",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:27109 embray]:
> I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.

No, it's because there hasn't been a release of libffi since 2014! There is a "libffi 3.3 Release Candidate 0" though: https://github.com/libffi/libffi/releases



---

archive/issue_comments_418249.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?",
    "created_at": "2019-01-24T14:22:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418249",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?



---

archive/issue_comments_418250.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2019-01-24T14:32:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418250",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_418251.json:
```json
{
    "body": "Branch: **[u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)**",
    "created_at": "2019-01-24T14:49:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418251",
    "user": "https://github.com/jdemeyer"
}
```

Branch: **[u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)**



---

archive/issue_comments_418252.json:
```json
{
    "body": "Commit: **[56eea27](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)**",
    "created_at": "2019-01-24T14:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418252",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[56eea27](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)**



---

archive/issue_comments_418253.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143\">56eea27</a></td><td><code>Add patch to set toolexeclibdir=libdir</code></td></tr></table>\n",
    "created_at": "2019-01-24T14:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418253",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143">56eea27</a></td><td><code>Add patch to set toolexeclibdir=libdir</code></td></tr></table>




---

archive/issue_events_372568.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-24T14:52:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372568"
}
```



---

archive/issue_comments_418254.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nA very simple (but admittedly ugly) fix.",
    "created_at": "2019-01-24T14:52:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418254",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

A very simple (but admittedly ugly) fix.



---

archive/issue_comments_418255.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@jdemeyer](#comment:7):\n> A very simple (but admittedly ugly) fix.\n\nIs there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?",
    "created_at": "2019-01-24T16:21:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418255",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@jdemeyer](#comment:7):
> A very simple (but admittedly ugly) fix.

Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?



---

archive/issue_comments_418256.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@jdemeyer](#comment:3):\n> I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?\n\nI was just going to add the patch from upstream (and update `spkg-install` to configure with `--disable-multi-os-directory`.  I was going to do it earlier but I had something else come up.",
    "created_at": "2019-01-24T17:12:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418256",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@jdemeyer](#comment:3):
> I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?

I was just going to add the patch from upstream (and update `spkg-install` to configure with `--disable-multi-os-directory`.  I was going to do it earlier but I had something else come up.



---

archive/issue_comments_418257.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@strogdon](#comment:8):\n> Replying to [@jdemeyer](#comment:7):\n> > A very simple (but admittedly ugly) fix.\n\n> Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?\n\nAs I mentioned in the description you need *libffi-devel* or whatever the equivalent is on Gentoo.  Fr\u00e9d\u00e9ric reported that this worked.\n\nPerhaps we could also add that to the list of build dependencies in the installation instructions.  It's not strictly necessary of course, but if the goal is to get people to build fewer dependencies in Sage then we might as well inform them of what system packages they can use (perhaps as an optional addendum).",
    "created_at": "2019-01-24T17:16:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418257",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@strogdon](#comment:8):
> Replying to [@jdemeyer](#comment:7):
> > A very simple (but admittedly ugly) fix.

> Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?

As I mentioned in the description you need *libffi-devel* or whatever the equivalent is on Gentoo.  Frédéric reported that this worked.

Perhaps we could also add that to the list of build dependencies in the installation instructions.  It's not strictly necessary of course, but if the goal is to get people to build fewer dependencies in Sage then we might as well inform them of what system packages they can use (perhaps as an optional addendum).



---

archive/issue_comments_418258.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI believe the `configure` step is not correct. In `config.log` on Gentoo\n\n```\nconfigure:9080: g++ -o conftest -g -O2  -I/usr/include -I/usr/include  -Wl,-O1 -Wl,--as-needed -L/usr/lib -L/usr/lib conftest.cpp -lffi  -lz -lm  >&5\nconfigure:9080: $? = 0\nconfigure:9097: result: -lffi\nconfigure:9110: checking ffi.h usability\nconfigure:9110: g++ -c -g -O2  -I/usr/include -I/usr/include  conftest.cpp >&5\nconftest.cpp:58:10: fatal error: ffi.h: No such file or directory\n #include <ffi.h>\n          ^~~~~~~\ncompilation terminated.\n```\nSo the headers cannot be found even though they are installed, but in sort of an `odd` location.",
    "created_at": "2019-01-24T17:18:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418258",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:11" align="right">comment:11</div>

I believe the `configure` step is not correct. In `config.log` on Gentoo

```
configure:9080: g++ -o conftest -g -O2  -I/usr/include -I/usr/include  -Wl,-O1 -Wl,--as-needed -L/usr/lib -L/usr/lib conftest.cpp -lffi  -lz -lm  >&5
configure:9080: $? = 0
configure:9097: result: -lffi
configure:9110: checking ffi.h usability
configure:9110: g++ -c -g -O2  -I/usr/include -I/usr/include  conftest.cpp >&5
conftest.cpp:58:10: fatal error: ffi.h: No such file or directory
 #include <ffi.h>
          ^~~~~~~
compilation terminated.
```
So the headers cannot be found even though they are installed, but in sort of an `odd` location.



---

archive/issue_comments_418259.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nOn Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.",
    "created_at": "2019-01-24T17:24:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418259",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:12" align="right">comment:12</div>

On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.



---

archive/issue_comments_418260.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)** to **[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)**",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418260",
    "user": "https://github.com/embray"
}
```

Changed branch from **[u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)** to **[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)**



---

archive/issue_comments_418261.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nJust using the patch from upstream seems towork (with the necessary changes applied to `configure` as well).\n\nI'm not sure if we really need to bump the package-version.txt either since the package will have never installed successfully in the first place for anyone affected by this.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce\">bfa7c90</a></td><td><code>Trac #27109: Include upstream patch to libffi for --disable-multi-os-directory</code></td></tr></table>\n",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418261",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

Just using the patch from upstream seems towork (with the necessary changes applied to `configure` as well).

I'm not sure if we really need to bump the package-version.txt either since the package will have never installed successfully in the first place for anyone affected by this.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce">bfa7c90</a></td><td><code>Trac #27109: Include upstream patch to libffi for --disable-multi-os-directory</code></td></tr></table>




---

archive/issue_comments_418262.json:
```json
{
    "body": "Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Erik Bray**",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418262",
    "user": "https://github.com/embray"
}
```

Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Erik Bray**



---

archive/issue_comments_418263.json:
```json
{
    "body": "Changed commit from **[56eea27](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)** to **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418263",
    "user": "https://github.com/embray"
}
```

Changed commit from **[56eea27](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)** to **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**



---

archive/issue_comments_418264.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@strogdon](#comment:12):\n> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\nSo even after running `./configure` I see\n\n```\nconfigure: === checking whether to install the libffi SPKG ===\nchecking for library containing ffi_call... -lffi\nchecking ffi.h usability... no\nchecking ffi.h presence... no\nchecking for ffi.h... no\nchecking ffi/ffi.h usability... no\nchecking ffi/ffi.h presence... no\nchecking for ffi/ffi.h... no\n```\nSince the headers are in a `non-standard` location they are not found. This `non-standard` location is where the `libffi` package installs the headers by default.",
    "created_at": "2019-01-24T17:40:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418264",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@strogdon](#comment:12):
> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

So even after running `./configure` I see

```
configure: === checking whether to install the libffi SPKG ===
checking for library containing ffi_call... -lffi
checking ffi.h usability... no
checking ffi.h presence... no
checking for ffi.h... no
checking ffi/ffi.h usability... no
checking ffi/ffi.h presence... no
checking for ffi/ffi.h... no
```
Since the headers are in a `non-standard` location they are not found. This `non-standard` location is where the `libffi` package installs the headers by default.



---

archive/issue_comments_418265.json:
```json
{
    "body": "Changed commit from **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)** to **[4d9ccb4](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)**",
    "created_at": "2019-01-24T17:58:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418265",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)** to **[4d9ccb4](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)**



---

archive/issue_comments_418266.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1\">4d9ccb4</a></td><td><code>Trac #27109: Use pkg-config if possible to detect libffi</code></td></tr></table>\n",
    "created_at": "2019-01-24T17:58:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418266",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1">4d9ccb4</a></td><td><code>Trac #27109: Use pkg-config if possible to detect libffi</code></td></tr></table>




---

archive/issue_comments_418267.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@strogdon](#comment:12):\n> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\nI just pushed an update that might help with that.",
    "created_at": "2019-01-24T17:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418267",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@strogdon](#comment:12):
> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

I just pushed an update that might help with that.



---

archive/issue_comments_418268.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nFWIW Python (which is AFAIK the main package for which we install libffi as a dependency (and even then we're not using it yet since Python<3.7 has a vendored copy)) also uses pkg-config, where available, to get the libffi CFLAGS, so this gel nicely with Python in this respect.",
    "created_at": "2019-01-24T18:09:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418268",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

FWIW Python (which is AFAIK the main package for which we install libffi as a dependency (and even then we're not using it yet since Python<3.7 has a vendored copy)) also uses pkg-config, where available, to get the libffi CFLAGS, so this gel nicely with Python in this respect.



---

archive/issue_comments_418269.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@embray](#comment:16):\n> Replying to [@strogdon](#comment:12):\n> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\n> \n> I just pushed an update that might help with that.\n\nOK, let me give that a try. Curiously, on Gentoo even though install of the `libffi` libraries failed, the headers were installed (under local/lib/libffi-3.2.1/include) as well as `local/lib/pkgconfig/libffi.pc`?",
    "created_at": "2019-01-24T18:11:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418269",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@embray](#comment:16):
> Replying to [@strogdon](#comment:12):
> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

> 
> I just pushed an update that might help with that.

OK, let me give that a try. Curiously, on Gentoo even though install of the `libffi` libraries failed, the headers were installed (under local/lib/libffi-3.2.1/include) as well as `local/lib/pkgconfig/libffi.pc`?



---

archive/issue_comments_418270.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@embray](#comment:16):\n> Replying to [@strogdon](#comment:12):\n> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\n> \n> I just pushed an update that might help with that.\n\nThis appears to do the trick here. Now from `config.log`\n\n```\npkg_cv_LIBFFI_CFLAGS=-I/usr/lib64/libffi-3.2.1/include\npkg_cv_LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'\n```\nand\n\n```\nLIBFFI_CFLAGS='-I/usr/lib64/libffi-3.2.1/include'\nLIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'\n```",
    "created_at": "2019-01-24T18:39:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418270",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@embray](#comment:16):
> Replying to [@strogdon](#comment:12):
> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

> 
> I just pushed an update that might help with that.

This appears to do the trick here. Now from `config.log`

```
pkg_cv_LIBFFI_CFLAGS=-I/usr/lib64/libffi-3.2.1/include
pkg_cv_LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'
```
and

```
LIBFFI_CFLAGS='-I/usr/lib64/libffi-3.2.1/include'
LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'
```



---

archive/issue_comments_418271.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI'm seeing current build failures related to libffi on \"OpenSuse Leap 15.0\":\n\n```\n[libffi-3.2.1] Copying package files from temporary location /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst to /waste/jenkins/local\n[libffi-3.2.1] cp: cannot overwrite non-directory '/waste/jenkins/local/./lib64' with directory '/waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64'\n```\nHere the \"/waste/jenkins/local/./lib64\" is a symbolic link to \"lib\", so I do not really understand the error message:\n\n```\njenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64\ntotal 116\n-rw-r--r-- 1 jenkins jenkins 60312 Jan 25 03:23 libffi.a\n-rwxr-xr-x 1 jenkins jenkins   956 Jan 25 03:23 libffi.la\nlrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so -> libffi.so.6.0.4\nlrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so.6 -> libffi.so.6.0.4\n-rwxr-xr-x 1 jenkins jenkins 46568 Jan 25 03:23 libffi.so.6.0.4\njenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/./lib64\nlrwxrwxrwx 1 jenkins jenkins 3 Jan 24 22:48 /waste/jenkins/local/./lib64 -> lib\n```",
    "created_at": "2019-01-25T09:34:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418271",
    "user": "https://github.com/cnassau"
}
```

<div id="comment:20" align="right">comment:20</div>

I'm seeing current build failures related to libffi on "OpenSuse Leap 15.0":

```
[libffi-3.2.1] Copying package files from temporary location /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst to /waste/jenkins/local
[libffi-3.2.1] cp: cannot overwrite non-directory '/waste/jenkins/local/./lib64' with directory '/waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64'
```
Here the "/waste/jenkins/local/./lib64" is a symbolic link to "lib", so I do not really understand the error message:

```
jenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64
total 116
-rw-r--r-- 1 jenkins jenkins 60312 Jan 25 03:23 libffi.a
-rwxr-xr-x 1 jenkins jenkins   956 Jan 25 03:23 libffi.la
lrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so -> libffi.so.6.0.4
lrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so.6 -> libffi.so.6.0.4
-rwxr-xr-x 1 jenkins jenkins 46568 Jan 25 03:23 libffi.so.6.0.4
jenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/./lib64
lrwxrwxrwx 1 jenkins jenkins 3 Jan 24 22:48 /waste/jenkins/local/./lib64 -> lib
```



---

archive/issue_comments_418272.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI don't like how this ticket is turning from \"fix this one specific libffi install issue blocking installation of Sage\" to \"let's fix everything related to ffi in Sage\".\n\nCan we please focus on the first issue only and keep the rest for other tickets?",
    "created_at": "2019-01-25T09:40:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418272",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

I don't like how this ticket is turning from "fix this one specific libffi install issue blocking installation of Sage" to "let's fix everything related to ffi in Sage".

Can we please focus on the first issue only and keep the rest for other tickets?



---

archive/issue_comments_418273.json:
```json
{
    "body": "Changed branch from **[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)** to **[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)**",
    "created_at": "2019-01-25T09:42:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418273",
    "user": "https://github.com/jdemeyer"
}
```

Changed branch from **[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)** to **[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)**



---

archive/issue_comments_418274.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI split this ticket in two, see #27114 for further fixes.",
    "created_at": "2019-01-25T09:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418274",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

I split this ticket in two, see #27114 for further fixes.



---

archive/issue_comments_418275.json:
```json
{
    "body": "Changed commit from **[4d9ccb4](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)** to **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**",
    "created_at": "2019-01-25T09:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418275",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[4d9ccb4](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)** to **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**



---

archive/issue_comments_418276.json:
```json
{
    "body": "Changed author from **Jeroen Demeyer, Erik Bray** to **Erik Bray**",
    "created_at": "2019-01-25T09:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418276",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Jeroen Demeyer, Erik Bray** to **Erik Bray**



---

archive/issue_comments_418277.json:
```json
{
    "body": "Reviewer: **Jeroen Demeyer**",
    "created_at": "2019-01-25T09:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418277",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Jeroen Demeyer**



---

archive/issue_events_372569.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-25T09:45:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372569"
}
```



---

archive/issue_events_372570.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-25T09:45:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372570"
}
```



---

archive/issue_comments_418278.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,3 @@\n The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.\n \n-This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a) (quite some time ago in fact) so we just need to include that patch.\n-\n-I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.\n-\n-In the meantime it may also work to install your distro's libffi-devel package and re-run Sage's `./configure`.\n+This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.\n``````\n",
    "created_at": "2019-01-25T09:47:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418278",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,3 @@
 The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.
 
-This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a) (quite some time ago in fact) so we just need to include that patch.
-
-I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.
-
-In the meantime it may also work to install your distro's libffi-devel package and re-run Sage's `./configure`.
+This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.
``````




---

archive/issue_comments_418279.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI think splitting it seems a bit pointless to me, but since you did it already then that's fine.",
    "created_at": "2019-01-25T10:51:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418279",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">comment:27</div>

I think splitting it seems a bit pointless to me, but since you did it already then that's fine.



---

archive/issue_comments_418280.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI was hoping for this ticket to be merged in 8.7.beta1, but unfortunately that hasn't happened.",
    "created_at": "2019-01-27T10:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418280",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

I was hoping for this ticket to be merged in 8.7.beta1, but unfortunately that hasn't happened.



---

archive/issue_comments_418281.json:
```json
{
    "body": "Changed branch from **[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)** to **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**",
    "created_at": "2019-01-27T10:54:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-418281",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)** to **[bfa7c90](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)**



---

archive/issue_events_372571.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-27T10:54:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372571"
}
```



---

archive/issue_events_372572.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d0a072e104838bda3bf8cde56e50b8d02bb45fcb",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-01-27T10:54:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-372572"
}
```
