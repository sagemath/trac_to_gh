# Issue 27109: libffi tries to install to ${prefix}/lib64 on some Linuxes

archive/issues_026872.json:
```json
{
    "assignees": [],
    "body": "The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.\n\nThis is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.\n\n**CC:**  @strogdon @fchapoton @jdemeyer\n\n**Branch/Commit:** [bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Erik Bray\n\nIssue created by migration from https://trac.sagemath.org/ticket/27109\n\n",
    "closed_at": "2019-01-27T10:54:48Z",
    "created_at": "2019-01-24T13:19:36Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "libffi tries to install to ${prefix}/lib64 on some Linuxes",
    "type": "issue",
    "updated_at": "2019-01-27T10:54:48Z",
    "url": "https://github.com/sagemath/sage/issues/27109",
    "user": "https://github.com/embray"
}
```
The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.

This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.

**CC:**  @strogdon @fchapoton @jdemeyer

**Branch/Commit:** [bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)

**Reviewer:** Jeroen Demeyer

**Author:** Erik Bray

Issue created by migration from https://trac.sagemath.org/ticket/27109





---

archive/issue_events_325516.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325516"
}
```



---

archive/issue_events_325517.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
    "label_color": "08517b",
    "label_name": "component: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325517"
}
```



---

archive/issue_events_325518.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/blocker",
    "label_color": "ff0000",
    "label_name": "blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325518"
}
```



---

archive/issue_events_325519.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-24T13:19:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325519"
}
```



---

archive/issue_comments_420869.json:
```json
{
    "body": "<a id='comment:1'>**Comment 1:**</a>\nJust in case you have anything to add.",
    "created_at": "2019-01-24T13:20:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420869",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'>**Comment 1:**</a>
Just in case you have anything to add.



---

archive/issue_comments_420870.json:
```json
{
    "body": "Replying to [ticket:27109 embray]:\n> I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.\n\nNo, it's because there hasn't been a release of libffi since 2014! There is a \"libffi 3.3 Release Candidate 0\" though: https://github.com/libffi/libffi/releases",
    "created_at": "2019-01-24T13:43:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420870",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:27109 embray]:
> I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.

No, it's because there hasn't been a release of libffi since 2014! There is a "libffi 3.3 Release Candidate 0" though: https://github.com/libffi/libffi/releases



---

archive/issue_comments_420871.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\nI'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?",
    "created_at": "2019-01-24T14:22:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420871",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'>**Comment 3:**</a>
I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?



---

archive/issue_comments_420872.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2019-01-24T14:32:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420872",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_420873.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)",
    "created_at": "2019-01-24T14:49:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420873",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)



---

archive/issue_comments_420874.json:
```json
{
    "body": "**Commit:** [56eea27dfd0876cbc45dd50af62734a283355143](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)",
    "created_at": "2019-01-24T14:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420874",
    "user": "https://github.com/sagetrac-git"
}
```

**Commit:** [56eea27dfd0876cbc45dd50af62734a283355143](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)



---

archive/issue_comments_420875.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143\">56eea27</a></td><td><code>Add patch to set toolexeclibdir=libdir</code></td></tr></table>\n",
    "created_at": "2019-01-24T14:51:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420875",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:6'>**Comment 6:**</a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143">56eea27</a></td><td><code>Add patch to set toolexeclibdir=libdir</code></td></tr></table>




---

archive/issue_events_325520.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-24T14:52:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325520"
}
```



---

archive/issue_comments_420876.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\nA very simple (but admittedly ugly) fix.",
    "created_at": "2019-01-24T14:52:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420876",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>**Comment 7:**</a>
A very simple (but admittedly ugly) fix.



---

archive/issue_comments_420877.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nReplying to [@jdemeyer](#comment%3A7):\n> A very simple (but admittedly ugly) fix.\n\nIs there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?",
    "created_at": "2019-01-24T16:21:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420877",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:8'>**Comment 8:**</a>
Replying to [@jdemeyer](#comment%3A7):
> A very simple (but admittedly ugly) fix.

Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?



---

archive/issue_comments_420878.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nReplying to [@jdemeyer](#comment%3A3):\n> I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?\n\nI was just going to add the patch from upstream (and update `spkg-install` to configure with `--disable-multi-os-directory`.  I was going to do it earlier but I had something else come up.",
    "created_at": "2019-01-24T17:12:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420878",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'>**Comment 9:**</a>
Replying to [@jdemeyer](#comment%3A3):
> I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?

I was just going to add the patch from upstream (and update `spkg-install` to configure with `--disable-multi-os-directory`.  I was going to do it earlier but I had something else come up.



---

archive/issue_comments_420879.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nReplying to [@strogdon](#comment%3A8):\n> Replying to [@jdemeyer](#comment%3A7):\n> > A very simple (but admittedly ugly) fix.\n\n> Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?\n\nAs I mentioned in the description you need *libffi-devel* or whatever the equivalent is on Gentoo.  Fr\u00e9d\u00e9ric reported that this worked.\n\nPerhaps we could also add that to the list of build dependencies in the installation instructions.  It's not strictly necessary of course, but if the goal is to get people to build fewer dependencies in Sage then we might as well inform them of what system packages they can use (perhaps as an optional addendum).",
    "created_at": "2019-01-24T17:16:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420879",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'>**Comment 10:**</a>
Replying to [@strogdon](#comment%3A8):
> Replying to [@jdemeyer](#comment%3A7):
> > A very simple (but admittedly ugly) fix.

> Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?

As I mentioned in the description you need *libffi-devel* or whatever the equivalent is on Gentoo.  Frédéric reported that this worked.

Perhaps we could also add that to the list of build dependencies in the installation instructions.  It's not strictly necessary of course, but if the goal is to get people to build fewer dependencies in Sage then we might as well inform them of what system packages they can use (perhaps as an optional addendum).



---

archive/issue_comments_420880.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nI believe the `configure` step is not correct. In `config.log` on Gentoo\n\n```\nconfigure:9080: g++ -o conftest -g -O2  -I/usr/include -I/usr/include  -Wl,-O1 -Wl,--as-needed -L/usr/lib -L/usr/lib conftest.cpp -lffi  -lz -lm  >&5\nconfigure:9080: $? = 0\nconfigure:9097: result: -lffi\nconfigure:9110: checking ffi.h usability\nconfigure:9110: g++ -c -g -O2  -I/usr/include -I/usr/include  conftest.cpp >&5\nconftest.cpp:58:10: fatal error: ffi.h: No such file or directory\n #include <ffi.h>\n          ^~~~~~~\ncompilation terminated.\n```\nSo the headers cannot be found even though they are installed, but in sort of an `odd` location.",
    "created_at": "2019-01-24T17:18:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420880",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:11'>**Comment 11:**</a>
I believe the `configure` step is not correct. In `config.log` on Gentoo

```
configure:9080: g++ -o conftest -g -O2  -I/usr/include -I/usr/include  -Wl,-O1 -Wl,--as-needed -L/usr/lib -L/usr/lib conftest.cpp -lffi  -lz -lm  >&5
configure:9080: $? = 0
configure:9097: result: -lffi
configure:9110: checking ffi.h usability
configure:9110: g++ -c -g -O2  -I/usr/include -I/usr/include  conftest.cpp >&5
conftest.cpp:58:10: fatal error: ffi.h: No such file or directory
 #include <ffi.h>
          ^~~~~~~
compilation terminated.
```
So the headers cannot be found even though they are installed, but in sort of an `odd` location.



---

archive/issue_comments_420881.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\nOn Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.",
    "created_at": "2019-01-24T17:24:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420881",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:12'>**Comment 12:**</a>
On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.



---

archive/issue_comments_420882.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)\" to \"[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)\".",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420882",
    "user": "https://github.com/embray"
}
```

**Changing branch** from "[u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/libffi_tries_to_install_to___prefix__lib64_on_some_linuxes)" to "[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)".



---

archive/issue_comments_420883.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nJust using the patch from upstream seems towork (with the necessary changes applied to `configure` as well).\n\nI'm not sure if we really need to bump the package-version.txt either since the package will have never installed successfully in the first place for anyone affected by this.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce\">bfa7c90</a></td><td><code>Trac #27109: Include upstream patch to libffi for --disable-multi-os-directory</code></td></tr></table>\n",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420883",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'>**Comment 13:**</a>
Just using the patch from upstream seems towork (with the necessary changes applied to `configure` as well).

I'm not sure if we really need to bump the package-version.txt either since the package will have never installed successfully in the first place for anyone affected by this.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce">bfa7c90</a></td><td><code>Trac #27109: Include upstream patch to libffi for --disable-multi-os-directory</code></td></tr></table>




---

archive/issue_comments_420884.json:
```json
{
    "body": "**Changing author** from \"Jeroen Demeyer\" to \"Jeroen Demeyer, Erik Bray\".",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420884",
    "user": "https://github.com/embray"
}
```

**Changing author** from "Jeroen Demeyer" to "Jeroen Demeyer, Erik Bray".



---

archive/issue_comments_420885.json:
```json
{
    "body": "**Changing commit** from \"[56eea27dfd0876cbc45dd50af62734a283355143](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)\" to \"[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)\".",
    "created_at": "2019-01-24T17:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420885",
    "user": "https://github.com/embray"
}
```

**Changing commit** from "[56eea27dfd0876cbc45dd50af62734a283355143](https://github.com/sagemath/sagetrac-mirror/commit/56eea27dfd0876cbc45dd50af62734a283355143)" to "[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)".



---

archive/issue_comments_420886.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nReplying to [@strogdon](#comment%3A12):\n> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\nSo even after running `./configure` I see\n\n```\nconfigure: === checking whether to install the libffi SPKG ===\nchecking for library containing ffi_call... -lffi\nchecking ffi.h usability... no\nchecking ffi.h presence... no\nchecking for ffi.h... no\nchecking ffi/ffi.h usability... no\nchecking ffi/ffi.h presence... no\nchecking for ffi/ffi.h... no\n```\nSince the headers are in a `non-standard` location they are not found. This `non-standard` location is where the `libffi` package installs the headers by default.",
    "created_at": "2019-01-24T17:40:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420886",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:14'>**Comment 14:**</a>
Replying to [@strogdon](#comment%3A12):
> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

So even after running `./configure` I see

```
configure: === checking whether to install the libffi SPKG ===
checking for library containing ffi_call... -lffi
checking ffi.h usability... no
checking ffi.h presence... no
checking for ffi.h... no
checking ffi/ffi.h usability... no
checking ffi/ffi.h presence... no
checking for ffi/ffi.h... no
```
Since the headers are in a `non-standard` location they are not found. This `non-standard` location is where the `libffi` package installs the headers by default.



---

archive/issue_comments_420887.json:
```json
{
    "body": "**Changing commit** from \"[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)\" to \"[4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)\".",
    "created_at": "2019-01-24T17:58:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420887",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)" to "[4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)".



---

archive/issue_comments_420888.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1\">4d9ccb4</a></td><td><code>Trac #27109: Use pkg-config if possible to detect libffi</code></td></tr></table>\n",
    "created_at": "2019-01-24T17:58:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420888",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:15'>**Comment 15:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1">4d9ccb4</a></td><td><code>Trac #27109: Use pkg-config if possible to detect libffi</code></td></tr></table>




---

archive/issue_comments_420889.json:
```json
{
    "body": "<a id='comment:16'>**Comment 16:**</a>\nReplying to [@strogdon](#comment%3A12):\n> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\nI just pushed an update that might help with that.",
    "created_at": "2019-01-24T17:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420889",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'>**Comment 16:**</a>
Replying to [@strogdon](#comment%3A12):
> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

I just pushed an update that might help with that.



---

archive/issue_comments_420890.json:
```json
{
    "body": "<a id='comment:17'>**Comment 17:**</a>\nFWIW Python (which is AFAIK the main package for which we install libffi as a dependency (and even then we're not using it yet since Python<3.7 has a vendored copy)) also uses pkg-config, where available, to get the libffi CFLAGS, so this gel nicely with Python in this respect.",
    "created_at": "2019-01-24T18:09:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420890",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'>**Comment 17:**</a>
FWIW Python (which is AFAIK the main package for which we install libffi as a dependency (and even then we're not using it yet since Python<3.7 has a vendored copy)) also uses pkg-config, where available, to get the libffi CFLAGS, so this gel nicely with Python in this respect.



---

archive/issue_comments_420891.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nReplying to [@embray](#comment%3A16):\n> Replying to [@strogdon](#comment%3A12):\n> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\n> \n> I just pushed an update that might help with that.\n\nOK, let me give that a try. Curiously, on Gentoo even though install of the `libffi` libraries failed, the headers were installed (under local/lib/libffi-3.2.1/include) as well as `local/lib/pkgconfig/libffi.pc`?",
    "created_at": "2019-01-24T18:11:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420891",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:18'>**Comment 18:**</a>
Replying to [@embray](#comment%3A16):
> Replying to [@strogdon](#comment%3A12):
> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

> 
> I just pushed an update that might help with that.

OK, let me give that a try. Curiously, on Gentoo even though install of the `libffi` libraries failed, the headers were installed (under local/lib/libffi-3.2.1/include) as well as `local/lib/pkgconfig/libffi.pc`?



---

archive/issue_comments_420892.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nReplying to [@embray](#comment%3A16):\n> Replying to [@strogdon](#comment%3A12):\n> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.\n\n> \n> I just pushed an update that might help with that.\n\nThis appears to do the trick here. Now from `config.log`\n\n```\npkg_cv_LIBFFI_CFLAGS=-I/usr/lib64/libffi-3.2.1/include\npkg_cv_LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'\n```\nand\n\n```\nLIBFFI_CFLAGS='-I/usr/lib64/libffi-3.2.1/include'\nLIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'\n```",
    "created_at": "2019-01-24T18:39:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420892",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:19'>**Comment 19:**</a>
Replying to [@embray](#comment%3A16):
> Replying to [@strogdon](#comment%3A12):
> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

> 
> I just pushed an update that might help with that.

This appears to do the trick here. Now from `config.log`

```
pkg_cv_LIBFFI_CFLAGS=-I/usr/lib64/libffi-3.2.1/include
pkg_cv_LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'
```
and

```
LIBFFI_CFLAGS='-I/usr/lib64/libffi-3.2.1/include'
LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'
```



---

archive/issue_comments_420893.json:
```json
{
    "body": "<a id='comment:20'>**Comment 20:**</a>\nI'm seeing current build failures related to libffi on \"OpenSuse Leap 15.0\":\n\n```\n[libffi-3.2.1] Copying package files from temporary location /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst to /waste/jenkins/local\n[libffi-3.2.1] cp: cannot overwrite non-directory '/waste/jenkins/local/./lib64' with directory '/waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64'\n```\nHere the \"/waste/jenkins/local/./lib64\" is a symbolic link to \"lib\", so I do not really understand the error message:\n\n```\njenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64\ntotal 116\n-rw-r--r-- 1 jenkins jenkins 60312 Jan 25 03:23 libffi.a\n-rwxr-xr-x 1 jenkins jenkins   956 Jan 25 03:23 libffi.la\nlrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so -> libffi.so.6.0.4\nlrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so.6 -> libffi.so.6.0.4\n-rwxr-xr-x 1 jenkins jenkins 46568 Jan 25 03:23 libffi.so.6.0.4\njenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/./lib64\nlrwxrwxrwx 1 jenkins jenkins 3 Jan 24 22:48 /waste/jenkins/local/./lib64 -> lib\n```",
    "created_at": "2019-01-25T09:34:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420893",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:20'>**Comment 20:**</a>
I'm seeing current build failures related to libffi on "OpenSuse Leap 15.0":

```
[libffi-3.2.1] Copying package files from temporary location /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst to /waste/jenkins/local
[libffi-3.2.1] cp: cannot overwrite non-directory '/waste/jenkins/local/./lib64' with directory '/waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64'
```
Here the "/waste/jenkins/local/./lib64" is a symbolic link to "lib", so I do not really understand the error message:

```
jenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64
total 116
-rw-r--r-- 1 jenkins jenkins 60312 Jan 25 03:23 libffi.a
-rwxr-xr-x 1 jenkins jenkins   956 Jan 25 03:23 libffi.la
lrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so -> libffi.so.6.0.4
lrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so.6 -> libffi.so.6.0.4
-rwxr-xr-x 1 jenkins jenkins 46568 Jan 25 03:23 libffi.so.6.0.4
jenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/./lib64
lrwxrwxrwx 1 jenkins jenkins 3 Jan 24 22:48 /waste/jenkins/local/./lib64 -> lib
```



---

archive/issue_comments_420894.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nI don't like how this ticket is turning from \"fix this one specific libffi install issue blocking installation of Sage\" to \"let's fix everything related to ffi in Sage\".\n\nCan we please focus on the first issue only and keep the rest for other tickets?",
    "created_at": "2019-01-25T09:40:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420894",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'>**Comment 21:**</a>
I don't like how this ticket is turning from "fix this one specific libffi install issue blocking installation of Sage" to "let's fix everything related to ffi in Sage".

Can we please focus on the first issue only and keep the rest for other tickets?



---

archive/issue_comments_420895.json:
```json
{
    "body": "**Changing branch** from \"[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)\" to \"[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)\".",
    "created_at": "2019-01-25T09:42:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420895",
    "user": "https://github.com/jdemeyer"
}
```

**Changing branch** from "[u/embray/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/build/ticket-27109)" to "[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)".



---

archive/issue_comments_420896.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\nI split this ticket in two, see #27114 for further fixes.",
    "created_at": "2019-01-25T09:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420896",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'>**Comment 23:**</a>
I split this ticket in two, see #27114 for further fixes.



---

archive/issue_comments_420897.json:
```json
{
    "body": "**Changing commit** from \"[4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)\" to \"[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)\".",
    "created_at": "2019-01-25T09:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420897",
    "user": "https://github.com/jdemeyer"
}
```

**Changing commit** from "[4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1](https://github.com/sagemath/sagetrac-mirror/commit/4d9ccb4a31892374bc8eb1b16a7f9b9a2d7cc1d1)" to "[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)".



---

archive/issue_comments_420898.json:
```json
{
    "body": "**Changing author** from \"Jeroen Demeyer, Erik Bray\" to \"Erik Bray\".",
    "created_at": "2019-01-25T09:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420898",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Jeroen Demeyer, Erik Bray" to "Erik Bray".



---

archive/issue_comments_420899.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2019-01-25T09:44:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420899",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_events_325521.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-25T09:45:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325521"
}
```



---

archive/issue_events_325522.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-25T09:45:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325522"
}
```



---

archive/issue_comments_420900.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,7 +1,3 @@\n The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.\n \n-This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a) (quite some time ago in fact) so we just need to include that patch.\n-\n-I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.\n-\n-In the meantime it may also work to install your distro's libffi-devel package and re-run Sage's `./configure`.\n+This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.\n``````\n",
    "created_at": "2019-01-25T09:47:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420900",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,7 +1,3 @@
 The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.
 
-This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a) (quite some time ago in fact) so we just need to include that patch.
-
-I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.
-
-In the meantime it may also work to install your distro's libffi-devel package and re-run Sage's `./configure`.
+This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a), so we just need to include that patch.
``````




---

archive/issue_comments_420901.json:
```json
{
    "body": "<a id='comment:27'>**Comment 27:**</a>\nI think splitting it seems a bit pointless to me, but since you did it already then that's fine.",
    "created_at": "2019-01-25T10:51:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420901",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'>**Comment 27:**</a>
I think splitting it seems a bit pointless to me, but since you did it already then that's fine.



---

archive/issue_comments_420902.json:
```json
{
    "body": "<a id='comment:28'>**Comment 28:**</a>\nI was hoping for this ticket to be merged in 8.7.beta1, but unfortunately that hasn't happened.",
    "created_at": "2019-01-27T10:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420902",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'>**Comment 28:**</a>
I was hoping for this ticket to be merged in 8.7.beta1, but unfortunately that hasn't happened.



---

archive/issue_comments_420903.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)\" to \"[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)\".",
    "created_at": "2019-01-27T10:54:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27109#issuecomment-420903",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/build/ticket-27109](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/build/ticket-27109)" to "[bfa7c90b4ff5387ee8a895a59d412e9f1c725fce](https://github.com/sagemath/sagetrac-mirror/commit/bfa7c90b4ff5387ee8a895a59d412e9f1c725fce)".



---

archive/issue_events_325523.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-27T10:54:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325523"
}
```



---

archive/issue_events_325524.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "d0a072e104838bda3bf8cde56e50b8d02bb45fcb",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-01-27T10:54:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27109",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27109#event-325524"
}
```
