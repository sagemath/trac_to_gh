# Issue 27508: Force tail reduction in polynomial quotient ring

archive/issues_027271.json:
```json
{
    "body": "I'd like to \"remove squares\" in some polynomials living in a polynomial ring over `QQ`, in 2 variables: `x`,`y`. I tried to implement this by modding out by the ideal `(x^2 - x, y^2 - y)`. Depending on the ordering, the result of `.mod()` does not always output the polynomial I am looking for. \n\nWithout specifying an ordering, everything seems fine:\n\n```python\nsage: R1.<x,y> = PolynomialRing(QQ, 2)\nsage: I1 = R1.ideal([\"x^2 - x\", \"y^2 - y\"])\nsage: R1(\"x^2 + y\").mod(I1)\nx + y\nsage: R1(\"x + y^2\").mod(I1)\nx + y\n```\n\nHowever, when specifying the order `lex` the reduction of `x + y^2` is not as expected:\n\n```python\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\nsage: I2 = R2.ideal([\"x^2 - x\", \"y^2 - y\"])\nsage: R2(\"x^2 + y\").mod(I2)\nx + y\nsage: R2(\"x + y^2\").mod(I2)\nx + y^2\n```\n\nThis issue was reported in [sage-support](https://groups.google.com/forum/#!topic/sage-support/80Scc9pTkPM) where it was pointed out that it is likely a bug in Singular, or in the Singular interface to Sage.\n\nIn particular, using the order `lex` works when `implementation=\"generic\"` is also specified:\n\n```python\nsage: R3.<x,y> = PolynomialRing(QQ, 2, order=\"lex\", implementation=\"generic\")\nsage: I3 = R3.ideal([\"x^2 - x\", \"y^2 - y\"])\nsage: R3(\"x^2 + y\").mod(I3)\nx + y\nsage: R3(\"x + y^2\").mod(I3)\nx + y\n```\n\nFor reference, I am using Sage version 8.6 on macOS Mojave 10.14.3.\n\nPS. see also https://groups.google.com/d/msg/sage-devel/K49-V3BbWbg/pxuoehPvAAAJ\n\n**Assignee:** @dimpase\n\n**CC:**  @simon-king-jena @malb @mwageringel\n\n**Keywords:** multivariate polynomial, quotient ring, singular\n\n**Branch:** [21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)\n\n**Reviewer:** Markus Wageringel\n\n**Author:** Dima Pasechnik\n\nIssue created by migration from https://trac.sagemath.org/ticket/27508\n\n",
    "closed_at": "2020-04-23T22:33:11Z",
    "created_at": "2019-03-18T16:15:18Z",
    "labels": [
        "component: commutative algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.1",
    "title": "Force tail reduction in polynomial quotient ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/27508",
    "user": "https://github.com/rachelplayer"
}
```
I'd like to "remove squares" in some polynomials living in a polynomial ring over `QQ`, in 2 variables: `x`,`y`. I tried to implement this by modding out by the ideal `(x^2 - x, y^2 - y)`. Depending on the ordering, the result of `.mod()` does not always output the polynomial I am looking for. 

Without specifying an ordering, everything seems fine:

```python
sage: R1.<x,y> = PolynomialRing(QQ, 2)
sage: I1 = R1.ideal(["x^2 - x", "y^2 - y"])
sage: R1("x^2 + y").mod(I1)
x + y
sage: R1("x + y^2").mod(I1)
x + y
```

However, when specifying the order `lex` the reduction of `x + y^2` is not as expected:

```python
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
sage: I2 = R2.ideal(["x^2 - x", "y^2 - y"])
sage: R2("x^2 + y").mod(I2)
x + y
sage: R2("x + y^2").mod(I2)
x + y^2
```

This issue was reported in [sage-support](https://groups.google.com/forum/#!topic/sage-support/80Scc9pTkPM) where it was pointed out that it is likely a bug in Singular, or in the Singular interface to Sage.

In particular, using the order `lex` works when `implementation="generic"` is also specified:

```python
sage: R3.<x,y> = PolynomialRing(QQ, 2, order="lex", implementation="generic")
sage: I3 = R3.ideal(["x^2 - x", "y^2 - y"])
sage: R3("x^2 + y").mod(I3)
x + y
sage: R3("x + y^2").mod(I3)
x + y
```

For reference, I am using Sage version 8.6 on macOS Mojave 10.14.3.

PS. see also https://groups.google.com/d/msg/sage-devel/K49-V3BbWbg/pxuoehPvAAAJ

**Assignee:** @dimpase

**CC:**  @simon-king-jena @malb @mwageringel

**Keywords:** multivariate polynomial, quotient ring, singular

**Branch:** [21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)

**Reviewer:** Markus Wageringel

**Author:** Dima Pasechnik

Issue created by migration from https://trac.sagemath.org/ticket/27508





---

archive/issue_comments_428708.json:
```json
{
    "body": "<a id='comment:1'></a>\nThanks, one would put \"author\" in only if intended to provide a patch soon.",
    "created_at": "2019-03-18T16:19:17Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428708",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
Thanks, one would put "author" in only if intended to provide a patch soon.



---

archive/issue_comments_428709.json:
```json
{
    "body": "**Changing author** from \"Rachel Player\" to \"\".",
    "created_at": "2019-03-18T16:19:56Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428709",
    "user": "https://github.com/rachelplayer"
}
```

**Changing author** from "Rachel Player" to "".



---

archive/issue_comments_428710.json:
```json
{
    "body": "<a id='comment:3'></a>\nThanks, in that case I have removed my name from \"author\".",
    "created_at": "2019-03-18T16:20:23Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428710",
    "user": "https://github.com/rachelplayer"
}
```

<a id='comment:3'></a>
Thanks, in that case I have removed my name from "author".



---

archive/issue_comments_428711.json:
```json
{
    "body": "<a id='comment:4'></a>\nSingular understand option `\"lp\"` for the lexicographic order.\nSee https://www.singular.uni-kl.de/Manual/4-0-3/sing_31.htm#SEC43\n\nAnd if I define `R2.<x,y> = PolynomialRing(QQ, 2, order=\"lp\")`\nthen it all works as expect. So the bug is in translating the Sage's option `\"lex\"` into Singular's one, should be easy to fix.",
    "created_at": "2019-03-18T16:36:06Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428711",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
Singular understand option `"lp"` for the lexicographic order.
See https://www.singular.uni-kl.de/Manual/4-0-3/sing_31.htm#SEC43

And if I define `R2.<x,y> = PolynomialRing(QQ, 2, order="lp")`
then it all works as expect. So the bug is in translating the Sage's option `"lex"` into Singular's one, should be easy to fix.



---

archive/issue_comments_428712.json:
```json
{
    "body": "<a id='comment:5'></a>\nThe following appears to fix this, although I don't really now why...\n\n```diff\n--- a/src/sage/libs/singular/ring.pyx\n+++ b/src/sage/libs/singular/ring.pyx\n@@ -50,7 +50,7 @@ from collections import defaultdict\n order_dict = {\n     \"dp\": ringorder_dp,\n     \"Dp\": ringorder_Dp,\n-    \"lp\": ringorder_lp,\n+    \"lex\": ringorder_lp,\n     \"rp\": ringorder_rp,\n     \"ds\": ringorder_ds,\n     \"Ds\": ringorder_Ds,\n```\n`\"lp\"` order still works, no idea why.",
    "created_at": "2019-03-18T16:51:39Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428712",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
The following appears to fix this, although I don't really now why...

```diff
--- a/src/sage/libs/singular/ring.pyx
+++ b/src/sage/libs/singular/ring.pyx
@@ -50,7 +50,7 @@ from collections import defaultdict
 order_dict = {
     "dp": ringorder_dp,
     "Dp": ringorder_Dp,
-    "lp": ringorder_lp,
+    "lex": ringorder_lp,
     "rp": ringorder_rp,
     "ds": ringorder_ds,
     "Ds": ringorder_Ds,
```
`"lp"` order still works, no idea why.



---

archive/issue_events_242930.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-19T16:35:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242930"
}
```



---

archive/issue_comments_428713.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe file \"src/sage/rings/polynomial/term_order.py\" might be related.",
    "created_at": "2019-03-20T00:26:45Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428713",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:7'></a>
The file "src/sage/rings/polynomial/term_order.py" might be related.



---

archive/issue_comments_428714.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis bug is already in Sage 8.1, that's as far back as I went.\nPerhaps it was always there, I don't know.\n\nBroken lex order should be a blocker, I think...",
    "created_at": "2019-03-21T00:35:13Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428714",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
This bug is already in Sage 8.1, that's as far back as I went.
Perhaps it was always there, I don't know.

Broken lex order should be a blocker, I think...



---

archive/issue_events_242931.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-21T00:35:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242931"
}
```



---

archive/issue_events_242932.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-21T00:35:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242932"
}
```



---

archive/issue_comments_428715.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [dimpase](#comment%3A8):\n> This bug is already in Sage 8.1, that's as far back as I went.\n\n\nIf a bug is that old and nobody noticed before, then surely it's not serious enough to warrant blocker status? But I'll let the release manager judge that.",
    "created_at": "2019-03-21T01:18:29Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428715",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [dimpase](#comment%3A8):
> This bug is already in Sage 8.1, that's as far back as I went.


If a bug is that old and nobody noticed before, then surely it's not serious enough to warrant blocker status? But I'll let the release manager judge that.



---

archive/issue_comments_428716.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [dimpase](#comment%3A5):\n> `\"lp\"` order still works, no idea why.\n\n\nWhat do you mean with \"still works\"? At the places where `order_dict` is used, a default value of `ringorder_dp` is used, so if `lp` is not a key in the dict anymore, I would expect that you end up with `dp` instead.",
    "created_at": "2019-03-21T05:19:08Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428716",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:10'></a>
Replying to [dimpase](#comment%3A5):
> `"lp"` order still works, no idea why.


What do you mean with "still works"? At the places where `order_dict` is used, a default value of `ringorder_dp` is used, so if `lp` is not a key in the dict anymore, I would expect that you end up with `dp` instead.



---

archive/issue_comments_428717.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [nbruin](#comment%3A10):\n> Replying to [dimpase](#comment%3A5):\n> > `\"lp\"` order still works, no idea why.\n\n> \n> What do you mean with \"still works\"? At the places where `order_dict` is used, a default value of `ringorder_dp` is used, so if `lp` is not a key in the dict anymore, I would expect that you end up with `dp` instead.\n\n\nNo, an unknown value of `order` leads to error:\n\n```\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"baz\")\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-5-4b6111e40869> in <module>()\n----> 1 R2 = PolynomialRing(QQ, Integer(2), order=\"baz\", names=('x', 'y',)); (x, y,) = R2._first_ngens(2)\n\n/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, *args, **kwds)\n    646 \n    647     if multivariate or len(names) != 1:\n--> 648         return _multi_variate(base_ring, names, **kwds)\n    649     else:\n    650         return _single_variate(base_ring, names, **kwds)\n\n/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _multi_variate(base_ring, names, sparse, order, implementation)\n    761     from sage.rings.polynomial.term_order import TermOrder\n    762     n = len(names)\n--> 763     order = TermOrder(order, n)\n    764 \n    765     # \"implementation\" must be last\n\n/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/rings/polynomial/term_order.pyc in __init__(self, name, n, force)\n    729                     else: # simple order\n    730                         if name not in print_name_mapping.keys() and name not in singular_name_mapping.values():\n--> 731                             raise ValueError(\"unknown term order {!r}\".format(name))\n    732                         self._length = n\n    733                         self._name = name\n\nValueError: unknown term order 'baz'\n```",
    "created_at": "2019-03-21T07:26:33Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428717",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
Replying to [nbruin](#comment%3A10):
> Replying to [dimpase](#comment%3A5):
> > `"lp"` order still works, no idea why.

> 
> What do you mean with "still works"? At the places where `order_dict` is used, a default value of `ringorder_dp` is used, so if `lp` is not a key in the dict anymore, I would expect that you end up with `dp` instead.


No, an unknown value of `order` leads to error:

```
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="baz")
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-5-4b6111e40869> in <module>()
----> 1 R2 = PolynomialRing(QQ, Integer(2), order="baz", names=('x', 'y',)); (x, y,) = R2._first_ngens(2)

/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, *args, **kwds)
    646 
    647     if multivariate or len(names) != 1:
--> 648         return _multi_variate(base_ring, names, **kwds)
    649     else:
    650         return _single_variate(base_ring, names, **kwds)

/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _multi_variate(base_ring, names, sparse, order, implementation)
    761     from sage.rings.polynomial.term_order import TermOrder
    762     n = len(names)
--> 763     order = TermOrder(order, n)
    764 
    765     # "implementation" must be last

/mnt/opt/Sage/sage-dev/local/lib/python2.7/site-packages/sage/rings/polynomial/term_order.pyc in __init__(self, name, n, force)
    729                     else: # simple order
    730                         if name not in print_name_mapping.keys() and name not in singular_name_mapping.values():
--> 731                             raise ValueError("unknown term order {!r}".format(name))
    732                         self._length = n
    733                         self._name = name

ValueError: unknown term order 'baz'
```



---

archive/issue_comments_428718.json:
```json
{
    "body": "<a id='comment:12'></a>\nI suspect it is easy to fix, as it's some sort of translation issue between orders of Sage and orders of Singular, and people who wrote it are reading this ticket, I gather.\n\nPlease, please, do something, it is **very serious**, a broken Groebner basis for lex order is  really a blocker.",
    "created_at": "2019-03-21T07:33:15Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428718",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>
I suspect it is easy to fix, as it's some sort of translation issue between orders of Sage and orders of Singular, and people who wrote it are reading this ticket, I gather.

Please, please, do something, it is **very serious**, a broken Groebner basis for lex order is  really a blocker.



---

archive/issue_comments_428719.json:
```json
{
    "body": "<a id='comment:13'></a>\nIf the bug is already in Sage 8.1, Sage 8.2, Sage 8.3, Sage 8.4, Sage 8.5 and Sage 8.6, would it really make such a big difference to have the same bug also in Sage 8.7?\n\nBut it doesn't matter what I think, the release manager will decide.",
    "created_at": "2019-03-21T09:45:05Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428719",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
If the bug is already in Sage 8.1, Sage 8.2, Sage 8.3, Sage 8.4, Sage 8.5 and Sage 8.6, would it really make such a big difference to have the same bug also in Sage 8.7?

But it doesn't matter what I think, the release manager will decide.



---

archive/issue_comments_428720.json:
```json
{
    "body": "<a id='comment:14'></a>\nI also checked now that it is already in 7.4. This is a bug of the type \"2+2=5\", if you ask me, it's a shame to release anything with this kind of thing knowingly broken without either a fix or a fat warning somewhere...",
    "created_at": "2019-03-21T09:47:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428720",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>
I also checked now that it is already in 7.4. This is a bug of the type "2+2=5", if you ask me, it's a shame to release anything with this kind of thing knowingly broken without either a fix or a fat warning somewhere...



---

archive/issue_comments_428721.json:
```json
{
    "body": "<a id='comment:15'></a>\nI chased this issue a little more. It seems that there is no problem in the translation. Perhaps it is a deeper issue. \n\nUltimately the normal form computation occurs in the code starting from line 283 in `src/sage/libs/singular/groebner_strategy.pyx` \n\nSomeone else who knows libSingular well, not me, is invited to look into it.",
    "created_at": "2019-03-21T09:48:54Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428721",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:15'></a>
I chased this issue a little more. It seems that there is no problem in the translation. Perhaps it is a deeper issue. 

Ultimately the normal form computation occurs in the code starting from line 283 in `src/sage/libs/singular/groebner_strategy.pyx` 

Someone else who knows libSingular well, not me, is invited to look into it.



---

archive/issue_comments_428722.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [klee](#comment%3A15):\n> I chased this issue a little more. It seems that there is no problem in the translation. Perhaps it is a deeper issue. \n\n\nThis does not explain why **after** the change in [comment:5](#comment%3A5)\none can do\n\n```\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\nsage: I2 = R2.ideal([\"x^2 - x\", \"y^2 - y\"])\nsage: R2(\"x + y^2\").mod(I2)\nx + y\nsage: R2._singular_()\npolynomial ring, over a field, global ordering\n// coefficients: QQ\n// number of vars : 2\n//        block   1 : ordering lp\n//                  : names    x y\n//        block   2 : ordering C\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lp\")\nsage: I2 = R2.ideal([\"x^2 - x\", \"y^2 - y\"])\nsage: R2(\"x + y^2\").mod(I2)\nx + y\nsage: R2._singular_()\npolynomial ring, over a field, global ordering\n// coefficients: QQ\n// number of vars : 2\n//        block   1 : ordering lp\n//                  : names    x y\n//        block   2 : ordering C\n```\n\neven though if `order_dict` is a (mathematical) function then `\"lp\"` should not have worked. (And indeed replacing `lp` by `baz` gives an error at once.\n\nSo you see above the order is `lp`, a.k.a. lex, all good. Well, without the [comment:5](#comment%3A5) change:\n\n```\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\nsage: R2._singular_() # all good, no?\npolynomial ring, over a field, global ordering\n// coefficients: QQ\n// number of vars : 2\n//        block   1 : ordering lp\n//                  : names    x y\n//        block   2 : ordering C\nsage: I2 = R2.ideal([\"x^2 - x\", \"y^2 - y\"])\nsage: R2(\"x + y^2\").mod(I2) # OOPS!!!!\nx + y^2\n```\n\n\n\n\n\n> \n> Ultimately the normal form computation occurs in the code starting from line 283 in `src/sage/libs/singular/groebner_strategy.pyx` \n> \n\nat this point the order is already set. From the conversation about it appears that nobody knows the real purpose `order_dict`.\n\n\n> Someone else who knows libSingular well, not me, is invited to look into it.\n",
    "created_at": "2019-03-21T10:43:32Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428722",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>
Replying to [klee](#comment%3A15):
> I chased this issue a little more. It seems that there is no problem in the translation. Perhaps it is a deeper issue. 


This does not explain why **after** the change in [comment:5](#comment%3A5)
one can do

```
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
sage: I2 = R2.ideal(["x^2 - x", "y^2 - y"])
sage: R2("x + y^2").mod(I2)
x + y
sage: R2._singular_()
polynomial ring, over a field, global ordering
// coefficients: QQ
// number of vars : 2
//        block   1 : ordering lp
//                  : names    x y
//        block   2 : ordering C
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lp")
sage: I2 = R2.ideal(["x^2 - x", "y^2 - y"])
sage: R2("x + y^2").mod(I2)
x + y
sage: R2._singular_()
polynomial ring, over a field, global ordering
// coefficients: QQ
// number of vars : 2
//        block   1 : ordering lp
//                  : names    x y
//        block   2 : ordering C
```

even though if `order_dict` is a (mathematical) function then `"lp"` should not have worked. (And indeed replacing `lp` by `baz` gives an error at once.

So you see above the order is `lp`, a.k.a. lex, all good. Well, without the [comment:5](#comment%3A5) change:

```
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
sage: R2._singular_() # all good, no?
polynomial ring, over a field, global ordering
// coefficients: QQ
// number of vars : 2
//        block   1 : ordering lp
//                  : names    x y
//        block   2 : ordering C
sage: I2 = R2.ideal(["x^2 - x", "y^2 - y"])
sage: R2("x + y^2").mod(I2) # OOPS!!!!
x + y^2
```





> 
> Ultimately the normal form computation occurs in the code starting from line 283 in `src/sage/libs/singular/groebner_strategy.pyx` 
> 

at this point the order is already set. From the conversation about it appears that nobody knows the real purpose `order_dict`.


> Someone else who knows libSingular well, not me, is invited to look into it.




---

archive/issue_comments_428723.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [nbruin](#comment%3A10):\n> Replying to [dimpase](#comment%3A5):\n> > `\"lp\"` order still works, no idea why.\n\n> \n> What do you mean with \"still works\"? At the places where `order_dict` is used, a default value of `ringorder_dp` is used, so if `lp` is not a key in the dict anymore, I would expect that you end up with `dp` instead.\n\n\nplease also see [comment:16](#comment%3A16) about this - no, at no point here the \"internal\" Singular's order becomes `dp`.",
    "created_at": "2019-03-21T10:57:29Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428723",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
Replying to [nbruin](#comment%3A10):
> Replying to [dimpase](#comment%3A5):
> > `"lp"` order still works, no idea why.

> 
> What do you mean with "still works"? At the places where `order_dict` is used, a default value of `ringorder_dp` is used, so if `lp` is not a key in the dict anymore, I would expect that you end up with `dp` instead.


please also see [comment:16](#comment%3A16) about this - no, at no point here the "internal" Singular's order becomes `dp`.



---

archive/issue_comments_428724.json:
```json
{
    "body": "<a id='comment:18'></a>\nMore about the bug: it appears that only the 1st term is reduced:\n\n```\nsage: R2.<y,z,t,x> = PolynomialRing(QQ, 4, order=\"lex\")\n....: I2 = R2.ideal([x^2 + x, y^2 +2*y, z^2 - z, t^2 - t])\n....: p = x^2 + y^2+z^2+t^2; p.mod(I2)\n....: \n-2*y + z^2 + t^2 + x^2\nsage: I2.reduce(p)\n-2*y + z^2 + t^2 + x^2\n```\n(similarly with 3 variables...)\n\nNow, reading code tells me that `p.mod(I2)` does `I2.reduce(p)`\nwhich in turn tries the strat thing, which \"works\":\n\n```\n        try:\n            strat = self._groebner_strategy()\n            return strat.normal_form(f)\n        except (TypeError, NotImplementedError, ValueError):\n            pass\n```\nand gets the wrong answer. If it didn't work then it'd try to reduce using an explicit Groebner basis for `I2`, something that gives a correct answer:\n\n```\nsage: p.reduce(I2.groebner_basis())\n-2*y + z + t - x\n```\n\nSo indeed it's that `strat` thing. Note that if I specify `order=\"lp\"` then calling `_groebner_strategy()` fails, and the result is (correctly) computed reducing with the Groebner basis.",
    "created_at": "2019-03-22T10:21:07Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428724",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>
More about the bug: it appears that only the 1st term is reduced:

```
sage: R2.<y,z,t,x> = PolynomialRing(QQ, 4, order="lex")
....: I2 = R2.ideal([x^2 + x, y^2 +2*y, z^2 - z, t^2 - t])
....: p = x^2 + y^2+z^2+t^2; p.mod(I2)
....: 
-2*y + z^2 + t^2 + x^2
sage: I2.reduce(p)
-2*y + z^2 + t^2 + x^2
```
(similarly with 3 variables...)

Now, reading code tells me that `p.mod(I2)` does `I2.reduce(p)`
which in turn tries the strat thing, which "works":

```
        try:
            strat = self._groebner_strategy()
            return strat.normal_form(f)
        except (TypeError, NotImplementedError, ValueError):
            pass
```
and gets the wrong answer. If it didn't work then it'd try to reduce using an explicit Groebner basis for `I2`, something that gives a correct answer:

```
sage: p.reduce(I2.groebner_basis())
-2*y + z + t - x
```

So indeed it's that `strat` thing. Note that if I specify `order="lp"` then calling `_groebner_strategy()` fails, and the result is (correctly) computed reducing with the Groebner basis.



---

archive/issue_comments_428725.json:
```json
{
    "body": "<a id='comment:19'></a>\nWe don't really promise anywhere to do tail reduction I think; Singular does the right thing by default but also not necessarily:\n\n```\n> ring r=0,(x,y),lp;\n// ** redefining r (ring r=0,(x,y),lp;)\n> ideal i=x2-x,y2-y;\n> ideal gb=groebner(i);\n> reduce(x+y2, gb, 0);     // Tail reduction (default)\nx+y\n> reduce(x+y2, gb, 1);     // No tail reduction\nx+y2\n```\nWhile we *should* do tail reduction there is nothing mathematically wrong, so imho no blocker.",
    "created_at": "2019-03-23T17:27:39Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428725",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
We don't really promise anywhere to do tail reduction I think; Singular does the right thing by default but also not necessarily:

```
> ring r=0,(x,y),lp;
// ** redefining r (ring r=0,(x,y),lp;)
> ideal i=x2-x,y2-y;
> ideal gb=groebner(i);
> reduce(x+y2, gb, 0);     // Tail reduction (default)
x+y
> reduce(x+y2, gb, 1);     // No tail reduction
x+y2
```
While we *should* do tail reduction there is nothing mathematically wrong, so imho no blocker.



---

archive/issue_events_242933.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-23T17:28:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242933"
}
```



---

archive/issue_comments_428726.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [vbraun](#comment%3A19):\n> We don't really promise anywhere to do tail reduction I think; \n\n\nyes we do:\n\n```\nage: I2.reduce?\nSignature:      I2.reduce(f)\nDocstring:     \n   Reduce an element modulo the reduced Groebner basis for this ideal.\n   This returns 0 if and only if the element is in this ideal. In any\n   case, this reduction is unique up to monomial orders.\n```\nand here we see different reductions depending upon the chosen implementation for the ring, nothing one can call \"unique up to monomial orders\".\n(the default implementation gives one result, the generic one gives another result).\n\nPerhaps Sage should allow for not doing the tail reduction, but it must not be the default in any case (it's not the default in Singular, the optional 3rd argument in `reduce` is by default 0 in Singular)",
    "created_at": "2019-03-24T01:09:27Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428726",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>
Replying to [vbraun](#comment%3A19):
> We don't really promise anywhere to do tail reduction I think; 


yes we do:

```
age: I2.reduce?
Signature:      I2.reduce(f)
Docstring:     
   Reduce an element modulo the reduced Groebner basis for this ideal.
   This returns 0 if and only if the element is in this ideal. In any
   case, this reduction is unique up to monomial orders.
```
and here we see different reductions depending upon the chosen implementation for the ring, nothing one can call "unique up to monomial orders".
(the default implementation gives one result, the generic one gives another result).

Perhaps Sage should allow for not doing the tail reduction, but it must not be the default in any case (it's not the default in Singular, the optional 3rd argument in `reduce` is by default 0 in Singular)



---

archive/issue_events_242934.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-24T01:09:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242934"
}
```



---

archive/issue_comments_428727.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [dimpase](#comment%3A17):\n> please also see [comment:16](#comment%3A16) about this - no, at no point here the \"internal\" Singular's order becomes `dp`.\n\n\nI looked at [comment:16](#comment%3A16) and I don't see a conclusive argument there that checks that the internal libsingular ring does *not* have `dp` as its ordering. In [singular_ring_new](https://github.com/sagemath/sage/blob/9db4320e485ed0aeae56d2c9dfc91fabe14659b1/src/sage/libs/singular/ring.pyx#L180) we see that the singular termorder string is looked up from the `term_order.singular_str()` attribute. That's what's used as key into the `order_dict` dictionary, with [order_dict.get(s, ringorder_dp)](https://github.com/sagemath/sage/blob/9db4320e485ed0aeae56d2c9dfc91fabe14659b1/src/sage/libs/singular/ring.pyx#L189), so if a key is not found then you end up with `dp` as ordering. We have:\n\n```\nsage: R1.<x,y> = PolynomialRing(QQ, 2)\nsage: R1.term_order().singular_str()\n'dp'\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\nsage: R2.term_order().singular_str()\n'lp'\nsage: R3.<x,y> = PolynomialRing(QQ, 2, order=\"lp\")\nsage: R3.term_order().singular_str()\n'lp'\n```\nso changing \"lp\" as a key in `order_dict` to \"lex\" would result in all three of these resulting into a libsingular ring with `dp` as ordering; where we are not observing failure of tail reduction on the examples we're trying.\n\nIt's a little strange that `lp` is also accepted as ordering, since that is not a value that Sage really knows how to work with otherwise. That explicitly coded, however: [if name not in print_name_mapping.keys() and name not in singular_name_mapping.values()](https://github.com/sagemath/sage/blob/9db4320e485ed0aeae56d2c9dfc91fabe14659b1/src/sage/rings/polynomial/term_order.py#L730) (that's why \"baz\" is not accepted as a term order and \"lp\" is)\n\nSo the way I read the code is that the currently proposed modification maps both degrevlex and lex (and also \"lp\") to `ringorder_dp` in libsingular.\n\nWe should probably be using examples where \"lex\" and \"degrevlex\" give different normal forms (and hopefully also different tailreduction results). I'm pretty sure the real problem is *not* in `order_dict`.",
    "created_at": "2019-03-24T20:52:09Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428727",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:23'></a>
Replying to [dimpase](#comment%3A17):
> please also see [comment:16](#comment%3A16) about this - no, at no point here the "internal" Singular's order becomes `dp`.


I looked at [comment:16](#comment%3A16) and I don't see a conclusive argument there that checks that the internal libsingular ring does *not* have `dp` as its ordering. In [singular_ring_new](https://github.com/sagemath/sage/blob/9db4320e485ed0aeae56d2c9dfc91fabe14659b1/src/sage/libs/singular/ring.pyx#L180) we see that the singular termorder string is looked up from the `term_order.singular_str()` attribute. That's what's used as key into the `order_dict` dictionary, with [order_dict.get(s, ringorder_dp)](https://github.com/sagemath/sage/blob/9db4320e485ed0aeae56d2c9dfc91fabe14659b1/src/sage/libs/singular/ring.pyx#L189), so if a key is not found then you end up with `dp` as ordering. We have:

```
sage: R1.<x,y> = PolynomialRing(QQ, 2)
sage: R1.term_order().singular_str()
'dp'
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
sage: R2.term_order().singular_str()
'lp'
sage: R3.<x,y> = PolynomialRing(QQ, 2, order="lp")
sage: R3.term_order().singular_str()
'lp'
```
so changing "lp" as a key in `order_dict` to "lex" would result in all three of these resulting into a libsingular ring with `dp` as ordering; where we are not observing failure of tail reduction on the examples we're trying.

It's a little strange that `lp` is also accepted as ordering, since that is not a value that Sage really knows how to work with otherwise. That explicitly coded, however: [if name not in print_name_mapping.keys() and name not in singular_name_mapping.values()](https://github.com/sagemath/sage/blob/9db4320e485ed0aeae56d2c9dfc91fabe14659b1/src/sage/rings/polynomial/term_order.py#L730) (that's why "baz" is not accepted as a term order and "lp" is)

So the way I read the code is that the currently proposed modification maps both degrevlex and lex (and also "lp") to `ringorder_dp` in libsingular.

We should probably be using examples where "lex" and "degrevlex" give different normal forms (and hopefully also different tailreduction results). I'm pretty sure the real problem is *not* in `order_dict`.



---

archive/issue_comments_428728.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [nbruin](#comment%3A23):\n\n[...]\n> We should probably be using examples where \"lex\" and \"degrevlex\" give different normal forms (and hopefully also different tailreduction results). I'm pretty sure the real problem is *not* in `order_dict`.\n\n\nIt seems that Volker might be right about the real problem: the tail is not rewritten fully simply because due to Singular's options in place when Singular's `redtailBba` function is called in `normal_form()`.\nIt's undocumented code in Singular, and Sage's interface to it dates back to 2009. Perhaps `malb` can comment on it...",
    "created_at": "2019-03-24T21:08:24Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428728",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>
Replying to [nbruin](#comment%3A23):

[...]
> We should probably be using examples where "lex" and "degrevlex" give different normal forms (and hopefully also different tailreduction results). I'm pretty sure the real problem is *not* in `order_dict`.


It seems that Volker might be right about the real problem: the tail is not rewritten fully simply because due to Singular's options in place when Singular's `redtailBba` function is called in `normal_form()`.
It's undocumented code in Singular, and Sage's interface to it dates back to 2009. Perhaps `malb` can comment on it...



---

archive/issue_comments_428729.json:
```json
{
    "body": "<a id='comment:25'></a>\nAnd by the way there is this: #12529",
    "created_at": "2019-03-24T21:09:38Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428729",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
And by the way there is this: #12529



---

archive/issue_comments_428730.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [dimpase](#comment%3A16):\n> This does not explain why **after** the change in [comment:5](#comment%3A5)\n> one can do\n> \n> ```\n> sage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\n> sage: I2 = R2.ideal([\"x^2 - x\", \"y^2 - y\"])\n> sage: R2(\"x + y^2\").mod(I2)\n> x + y\n> sage: R2._singular_()\n> [...]\n> ```\n\n\nBeware, the `._singular_()` code has to do with the Singular *interface*. Whatever it does is quite independent of `libsingular`. If you want to know what `libsingular` is doing, you have to query *it*. The design of `libsingular` doesn't make it particularly easy to dig up stuff about it interactively.",
    "created_at": "2019-03-25T04:23:35Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428730",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:26'></a>
Replying to [dimpase](#comment%3A16):
> This does not explain why **after** the change in [comment:5](#comment%3A5)
> one can do
> 
> ```
> sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
> sage: I2 = R2.ideal(["x^2 - x", "y^2 - y"])
> sage: R2("x + y^2").mod(I2)
> x + y
> sage: R2._singular_()
> [...]
> ```


Beware, the `._singular_()` code has to do with the Singular *interface*. Whatever it does is quite independent of `libsingular`. If you want to know what `libsingular` is doing, you have to query *it*. The design of `libsingular` doesn't make it particularly easy to dig up stuff about it interactively.



---

archive/issue_comments_428731.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [nbruin](#comment%3A26):\n> Replying to [dimpase](#comment%3A16):\n> > This does not explain why **after** the change in [comment:5](#comment%3A5)\n> > one can do\n> > \n> > ```\n> > sage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\n> > sage: I2 = R2.ideal([\"x^2 - x\", \"y^2 - y\"])\n> > sage: R2(\"x + y^2\").mod(I2)\n> > x + y\n> > sage: R2._singular_()\n> > [...]\n> > ```\n\n> \n> Beware, the `._singular_()` code has to do with the Singular *interface*. Whatever it does is quite independent of `libsingular`. If you want to know what `libsingular` is doing, you have to query *it*. The design of `libsingular` doesn't make it particularly easy to dig up stuff about it interactively.\n\n\nYes, I became aware of this. At some point on this ticket I started testing things after removing `SAGE_LOCAL/bin/Singular` :-)",
    "created_at": "2019-03-25T07:07:09Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428731",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
Replying to [nbruin](#comment%3A26):
> Replying to [dimpase](#comment%3A16):
> > This does not explain why **after** the change in [comment:5](#comment%3A5)
> > one can do
> > 
> > ```
> > sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
> > sage: I2 = R2.ideal(["x^2 - x", "y^2 - y"])
> > sage: R2("x + y^2").mod(I2)
> > x + y
> > sage: R2._singular_()
> > [...]
> > ```

> 
> Beware, the `._singular_()` code has to do with the Singular *interface*. Whatever it does is quite independent of `libsingular`. If you want to know what `libsingular` is doing, you have to query *it*. The design of `libsingular` doesn't make it particularly easy to dig up stuff about it interactively.


Yes, I became aware of this. At some point on this ticket I started testing things after removing `SAGE_LOCAL/bin/Singular` :-)



---

archive/issue_comments_428732.json:
```json
{
    "body": "<a id='comment:28'></a>\nIt's not obvious which of several prototypes of `redtailBba` is being called from `normal_form()`. So this is the question for the original authors: how does one change the default---which is, apparently, assuming that this is indeed not a bug, that the tail reduction is not carried out?",
    "created_at": "2019-03-25T09:37:25Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428732",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>
It's not obvious which of several prototypes of `redtailBba` is being called from `normal_form()`. So this is the question for the original authors: how does one change the default---which is, apparently, assuming that this is indeed not a bug, that the tail reduction is not carried out?



---

archive/issue_comments_428733.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [dimpase](#comment%3A5):\n> The following appears to fix this, although I don't really now why...\n> \n> ```diff\n> --- a/src/sage/libs/singular/ring.pyx\n> +++ b/src/sage/libs/singular/ring.pyx\n> @@ -50,7 +50,7 @@ from collections import defaultdict\n>  order_dict = {\n>      \"dp\": ringorder_dp,\n>      \"Dp\": ringorder_Dp,\n> -    \"lp\": ringorder_lp,\n> +    \"lex\": ringorder_lp,\n>      \"rp\": ringorder_rp,\n>      \"ds\": ringorder_ds,\n>      \"Ds\": ringorder_Ds,\n> ```\n> `\"lp\"` order still works, no idea why.\n\n\nDoesn't that simply revert back to \"dp\"? `_order[idx] = order_dict.get(s, ringorder_dp)`",
    "created_at": "2019-03-25T10:33:17Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428733",
    "user": "https://github.com/malb"
}
```

<a id='comment:29'></a>
Replying to [dimpase](#comment%3A5):
> The following appears to fix this, although I don't really now why...
> 
> ```diff
> --- a/src/sage/libs/singular/ring.pyx
> +++ b/src/sage/libs/singular/ring.pyx
> @@ -50,7 +50,7 @@ from collections import defaultdict
>  order_dict = {
>      "dp": ringorder_dp,
>      "Dp": ringorder_Dp,
> -    "lp": ringorder_lp,
> +    "lex": ringorder_lp,
>      "rp": ringorder_rp,
>      "ds": ringorder_ds,
>      "Ds": ringorder_Ds,
> ```
> `"lp"` order still works, no idea why.


Doesn't that simply revert back to "dp"? `_order[idx] = order_dict.get(s, ringorder_dp)`



---

archive/issue_comments_428734.json:
```json
{
    "body": "<a id='comment:30'></a>\nI'm guessing this is a question for the Singular team, they might not like tail reductions for lex?",
    "created_at": "2019-03-25T10:34:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428734",
    "user": "https://github.com/malb"
}
```

<a id='comment:30'></a>
I'm guessing this is a question for the Singular team, they might not like tail reductions for lex?



---

archive/issue_comments_428735.json:
```json
{
    "body": "<a id='comment:31'></a>\nMoving all blocker/critical issues from 8.7 to 8.8.",
    "created_at": "2019-03-25T10:41:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428735",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>
Moving all blocker/critical issues from 8.7 to 8.8.



---

archive/issue_events_242935.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:41:19Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242935"
}
```



---

archive/issue_events_242936.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:41:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242936"
}
```



---

archive/issue_comments_428736.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [malb](#comment%3A29):\n> Replying to [dimpase](#comment%3A5):\n> > The following appears to fix this, although I don't really now why...\n> > \n> > ```diff\n> > --- a/src/sage/libs/singular/ring.pyx\n> > +++ b/src/sage/libs/singular/ring.pyx\n> > @@ -50,7 +50,7 @@ from collections import defaultdict\n> >  order_dict = {\n> >      \"dp\": ringorder_dp,\n> >      \"Dp\": ringorder_Dp,\n> > -    \"lp\": ringorder_lp,\n> > +    \"lex\": ringorder_lp,\n> >      \"rp\": ringorder_rp,\n> >      \"ds\": ringorder_ds,\n> >      \"Ds\": ringorder_Ds,\n> > ```\n> > `\"lp\"` order still works, no idea why.\n\n> \n> Doesn't that simply revert back to \"dp\"? `_order[idx] = order_dict.get(s, ringorder_dp)`\n\n\nno, sorry, this actually just breaks the creation of the strategy thing completely, and resorts to reducing using an explicitly computed Groebner basis, \nas I sort of said later in [comment:18](#comment%3A18).",
    "created_at": "2019-03-25T10:54:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428736",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>
Replying to [malb](#comment%3A29):
> Replying to [dimpase](#comment%3A5):
> > The following appears to fix this, although I don't really now why...
> > 
> > ```diff
> > --- a/src/sage/libs/singular/ring.pyx
> > +++ b/src/sage/libs/singular/ring.pyx
> > @@ -50,7 +50,7 @@ from collections import defaultdict
> >  order_dict = {
> >      "dp": ringorder_dp,
> >      "Dp": ringorder_Dp,
> > -    "lp": ringorder_lp,
> > +    "lex": ringorder_lp,
> >      "rp": ringorder_rp,
> >      "ds": ringorder_ds,
> >      "Ds": ringorder_Ds,
> > ```
> > `"lp"` order still works, no idea why.

> 
> Doesn't that simply revert back to "dp"? `_order[idx] = order_dict.get(s, ringorder_dp)`


no, sorry, this actually just breaks the creation of the strategy thing completely, and resorts to reducing using an explicitly computed Groebner basis, 
as I sort of said later in [comment:18](#comment%3A18).



---

archive/issue_comments_428737.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [malb](#comment%3A30):\n> I'm guessing this is a question for the Singular team, they might not like tail reductions for lex?\n\n\nWhich version of `redtailBba()` do you call?\nIn `kutil.h` one  sees \n\n```\nKINLINE poly redtailBba (poly p,int end_pos,kStrategy strat,\n       BOOLEAN normalize=FALSE);\npoly redtailBba (LObject *L, int end_pos,kStrategy strat,\n               BOOLEAN withT = FALSE,BOOLEAN normalize=FALSE);\npoly redtailBba (TObject *T, int end_pos,kStrategy strat);\n```\nso that `normalize=FALSE` (and mysteriously named `withT = FALSE`) suggests \nyou might be calling with these defaults.\n\nThe call is `_p = redtailBba(_p, max_ind, self._strat)`\nwith `cdef poly *_p`, so it might be it picks up the 2nd prototype, with these defaults...",
    "created_at": "2019-03-25T11:15:32Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428737",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>
Replying to [malb](#comment%3A30):
> I'm guessing this is a question for the Singular team, they might not like tail reductions for lex?


Which version of `redtailBba()` do you call?
In `kutil.h` one  sees 

```
KINLINE poly redtailBba (poly p,int end_pos,kStrategy strat,
       BOOLEAN normalize=FALSE);
poly redtailBba (LObject *L, int end_pos,kStrategy strat,
               BOOLEAN withT = FALSE,BOOLEAN normalize=FALSE);
poly redtailBba (TObject *T, int end_pos,kStrategy strat);
```
so that `normalize=FALSE` (and mysteriously named `withT = FALSE`) suggests 
you might be calling with these defaults.

The call is `_p = redtailBba(_p, max_ind, self._strat)`
with `cdef poly *_p`, so it might be it picks up the 2nd prototype, with these defaults...



---

archive/issue_comments_428738.json:
```json
{
    "body": "<a id='comment:34'></a>\nIndeed, that's the one. However, this doesn't seem to make a difference:\n\n```diff\ndiff --git a/src/sage/libs/singular/decl.pxd b/src/sage/libs/singular/decl.pxd\nindex 7f09aafd9e..4fd0fad5e6 100644\n--- a/src/sage/libs/singular/decl.pxd\n+++ b/src/sage/libs/singular/decl.pxd\n@@ -890,7 +890,7 @@ cdef extern from \"singular/Singular/libsingular.h\":\n     # head reduction\n     poly *redNF(poly *p, int index, int nonorm, skStrategy *strat)\n     # tail reduction\n-    poly *redtailBba(poly *p, int index, skStrategy *strat)\n+    poly *redtailBba(poly *p, int index, skStrategy *strat, bint normalize)\n \n     cdef int CMD_1\n     cdef int CMD_2\ndiff --git a/src/sage/libs/singular/groebner_strategy.pyx b/src/sage/libs/singular/groebner_strategy.pyx\nindex 8488fa8a38..14145bf206 100644\n--- a/src/sage/libs/singular/groebner_strategy.pyx\n+++ b/src/sage/libs/singular/groebner_strategy.pyx\n@@ -288,7 +288,7 @@ cdef class GroebnerStrategy(SageObject):\n         cdef int max_ind = 0\n         cdef poly *_p = redNF(p_Copy(p._poly, self._parent._ring), max_ind, 0, self._strat)\n         if likely(_p!=NULL):\n-            _p = redtailBba(_p, max_ind, self._strat)\n+            _p = redtailBba(_p, max_ind, self._strat, True)\n         return new_MP(self._parent, _p)\n \n cdef class NCGroebnerStrategy(SageObject):\n@@ -517,10 +517,10 @@ cdef class NCGroebnerStrategy(SageObject):\n         if unlikely(self._parent._ring != currRing):\n             rChangeCurrRing(self._parent._ring)\n \n-        cdef int max_ind\n+        cdef int max_ind = 0\n         cdef poly *_p = redNF(p_Copy(p._poly, self._parent._ring), max_ind, 0, self._strat)\n         if likely(_p!=NULL):\n-            _p = redtailBba(_p, max_ind, self._strat)\n+            _p = redtailBba(_p, max_ind, self._strat, True)\n         return new_NCP(self._parent, _p)\n \n def unpickle_NCGroebnerStrategy0(I):\n\n```\n\nAnd I still get:\n\n```python\nsage: R.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\n....: I = R.ideal([x^2 - x, y^2 - y])\n....: f = x + y^2\n....: f.mod(I)\n....: \nx + y^2\n```",
    "created_at": "2019-03-25T11:41:30Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428738",
    "user": "https://github.com/malb"
}
```

<a id='comment:34'></a>
Indeed, that's the one. However, this doesn't seem to make a difference:

```diff
diff --git a/src/sage/libs/singular/decl.pxd b/src/sage/libs/singular/decl.pxd
index 7f09aafd9e..4fd0fad5e6 100644
--- a/src/sage/libs/singular/decl.pxd
+++ b/src/sage/libs/singular/decl.pxd
@@ -890,7 +890,7 @@ cdef extern from "singular/Singular/libsingular.h":
     # head reduction
     poly *redNF(poly *p, int index, int nonorm, skStrategy *strat)
     # tail reduction
-    poly *redtailBba(poly *p, int index, skStrategy *strat)
+    poly *redtailBba(poly *p, int index, skStrategy *strat, bint normalize)
 
     cdef int CMD_1
     cdef int CMD_2
diff --git a/src/sage/libs/singular/groebner_strategy.pyx b/src/sage/libs/singular/groebner_strategy.pyx
index 8488fa8a38..14145bf206 100644
--- a/src/sage/libs/singular/groebner_strategy.pyx
+++ b/src/sage/libs/singular/groebner_strategy.pyx
@@ -288,7 +288,7 @@ cdef class GroebnerStrategy(SageObject):
         cdef int max_ind = 0
         cdef poly *_p = redNF(p_Copy(p._poly, self._parent._ring), max_ind, 0, self._strat)
         if likely(_p!=NULL):
-            _p = redtailBba(_p, max_ind, self._strat)
+            _p = redtailBba(_p, max_ind, self._strat, True)
         return new_MP(self._parent, _p)
 
 cdef class NCGroebnerStrategy(SageObject):
@@ -517,10 +517,10 @@ cdef class NCGroebnerStrategy(SageObject):
         if unlikely(self._parent._ring != currRing):
             rChangeCurrRing(self._parent._ring)
 
-        cdef int max_ind
+        cdef int max_ind = 0
         cdef poly *_p = redNF(p_Copy(p._poly, self._parent._ring), max_ind, 0, self._strat)
         if likely(_p!=NULL):
-            _p = redtailBba(_p, max_ind, self._strat)
+            _p = redtailBba(_p, max_ind, self._strat, True)
         return new_NCP(self._parent, _p)
 
 def unpickle_NCGroebnerStrategy0(I):

```

And I still get:

```python
sage: R.<x,y> = PolynomialRing(QQ, 2, order="lex")
....: I = R.ideal([x^2 - x, y^2 - y])
....: f = x + y^2
....: f.mod(I)
....: 
x + y^2
```



---

archive/issue_comments_428739.json:
```json
{
    "body": "<a id='comment:35'></a>\nNote that the class [skStrategy](https://www.singular.uni-kl.de/dox/html/classskStrategy.html#a2c0ad11fb2c598c0a5c5e1ce9a546f8f) has a `noTailReduction` member.\nCould it be that it's `True` by default?",
    "created_at": "2019-03-25T12:49:56Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428739",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>
Note that the class [skStrategy](https://www.singular.uni-kl.de/dox/html/classskStrategy.html#a2c0ad11fb2c598c0a5c5e1ce9a546f8f) has a `noTailReduction` member.
Could it be that it's `True` by default?



---

archive/issue_comments_428740.json:
```json
{
    "body": "**Assignee:** @dimpase",
    "created_at": "2019-03-25T13:00:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428740",
    "user": "https://github.com/dimpase"
}
```

**Assignee:** @dimpase



---

archive/issue_comments_428741.json:
```json
{
    "body": "**Author:** Dima Pasechnik",
    "created_at": "2019-03-25T13:00:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428741",
    "user": "https://github.com/dimpase"
}
```

**Author:** Dima Pasechnik



---

archive/issue_comments_428742.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [dimpase](#comment%3A35):\n> Note that the class [skStrategy](https://www.singular.uni-kl.de/dox/html/classskStrategy.html#a2c0ad11fb2c598c0a5c5e1ce9a546f8f) has a `noTailReduction` member.\n> Could it be that it's `True` by default?\n\nYES!\n\n```diff\n--- a/src/sage/libs/singular/decl.pxd\n+++ b/src/sage/libs/singular/decl.pxd\n@@ -317,6 +317,7 @@ cdef extern from \"singular/Singular/libsingular.h\":\n         void (*initEcartPair)(LObject * h, poly *f, poly *g, int ecartF, int ecartG)\n         int (*posInLOld)(LObject * Ls, int Ll, LObject* Lo, skStrategy *strat)\n         LObject P\n+        bint noTailReduction\n         ideal *Shdl\n         ideal *D\n         ideal *M\n\ndiff --git a/src/sage/libs/singular/groebner_strategy.pyx b/src/sage/libs/singular/groebner_strategy.pyx\nindex 8488fa8a38..f7a55c3a82 100644\n--- a/src/sage/libs/singular/groebner_strategy.pyx\n+++ b/src/sage/libs/singular/groebner_strategy.pyx\n@@ -127,6 +127,7 @@ cdef class GroebnerStrategy(SageObject):\n         self._strat.sl = -1\n         #- init local data struct\n         initS(i, NULL, self._strat)\n+        self._strat.noTailReduction = False\n \n```\n\nrestores the sanity... \n\n\nI'll make a patch.",
    "created_at": "2019-03-25T13:00:19Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428742",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>
Replying to [dimpase](#comment%3A35):
> Note that the class [skStrategy](https://www.singular.uni-kl.de/dox/html/classskStrategy.html#a2c0ad11fb2c598c0a5c5e1ce9a546f8f) has a `noTailReduction` member.
> Could it be that it's `True` by default?

YES!

```diff
--- a/src/sage/libs/singular/decl.pxd
+++ b/src/sage/libs/singular/decl.pxd
@@ -317,6 +317,7 @@ cdef extern from "singular/Singular/libsingular.h":
         void (*initEcartPair)(LObject * h, poly *f, poly *g, int ecartF, int ecartG)
         int (*posInLOld)(LObject * Ls, int Ll, LObject* Lo, skStrategy *strat)
         LObject P
+        bint noTailReduction
         ideal *Shdl
         ideal *D
         ideal *M

diff --git a/src/sage/libs/singular/groebner_strategy.pyx b/src/sage/libs/singular/groebner_strategy.pyx
index 8488fa8a38..f7a55c3a82 100644
--- a/src/sage/libs/singular/groebner_strategy.pyx
+++ b/src/sage/libs/singular/groebner_strategy.pyx
@@ -127,6 +127,7 @@ cdef class GroebnerStrategy(SageObject):
         self._strat.sl = -1
         #- init local data struct
         initS(i, NULL, self._strat)
+        self._strat.noTailReduction = False
 
```

restores the sanity... 


I'll make a patch.



---

archive/issue_comments_428743.json:
```json
{
    "body": "<a id='comment:37'></a>\nNice find! It's strange that \n\n```python\nsage: from sage.libs.singular.option import LibSingularOptions\nsage: LibSingularOptions()[\"redTail\"]\nTrue\n```\n\ndoesn't seem to affect it, but perhaps that only affects GB computations not manual normal forms.",
    "created_at": "2019-03-25T13:24:37Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428743",
    "user": "https://github.com/malb"
}
```

<a id='comment:37'></a>
Nice find! It's strange that 

```python
sage: from sage.libs.singular.option import LibSingularOptions
sage: LibSingularOptions()["redTail"]
True
```

doesn't seem to affect it, but perhaps that only affects GB computations not manual normal forms.



---

archive/issue_comments_428744.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [malb](#comment%3A37):\n> Nice find! It's strange that \n> \n> ```python\n> sage: from sage.libs.singular.option import LibSingularOptions\n> sage: LibSingularOptions()[\"redTail\"]\n> True\n> ```\n> \n> doesn't seem to affect it, but perhaps that only affects GB computations not manual normal forms.\n\n\nWhat I don't understand is why `self._strat.noTailReduction = False` is needed explicitly,\nisn't the `False` value the default result of the initialisation of the class?\n\nOr is it implementation-dependent?",
    "created_at": "2019-03-25T14:51:14Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428744",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'></a>
Replying to [malb](#comment%3A37):
> Nice find! It's strange that 
> 
> ```python
> sage: from sage.libs.singular.option import LibSingularOptions
> sage: LibSingularOptions()["redTail"]
> True
> ```
> 
> doesn't seem to affect it, but perhaps that only affects GB computations not manual normal forms.


What I don't understand is why `self._strat.noTailReduction = False` is needed explicitly,
isn't the `False` value the default result of the initialisation of the class?

Or is it implementation-dependent?



---

archive/issue_comments_428745.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [malb](#comment%3A37):\n> Nice find! It's strange that \n> \n> ```python\n> sage: from sage.libs.singular.option import LibSingularOptions\n> sage: LibSingularOptions()[\"redTail\"]\n> True\n> ```\n> \n> doesn't seem to affect it, but perhaps that only affects GB computations not manual normal forms.\n\n\nAlready creating a ring with `lex` term ordering option flips this option:\n\n```\nsage: from sage.libs.singular.option import LibSingularOptions\nsage: LibSingularOptions()[\"redTail\"]\nTrue\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\nsage: LibSingularOptions()[\"redTail\"]\nFalse\n```\n\nin fact, I saw the following comment in `kernel/GBEngine/kutil.cc`:\n\n```\n/* alway use tailreduction, except:\n  * - in local rings, - in lex order case, -in ring over extensions */\n```\n\nThus, `lex` is special...",
    "created_at": "2019-03-25T17:53:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428745",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:39'></a>
Replying to [malb](#comment%3A37):
> Nice find! It's strange that 
> 
> ```python
> sage: from sage.libs.singular.option import LibSingularOptions
> sage: LibSingularOptions()["redTail"]
> True
> ```
> 
> doesn't seem to affect it, but perhaps that only affects GB computations not manual normal forms.


Already creating a ring with `lex` term ordering option flips this option:

```
sage: from sage.libs.singular.option import LibSingularOptions
sage: LibSingularOptions()["redTail"]
True
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
sage: LibSingularOptions()["redTail"]
False
```

in fact, I saw the following comment in `kernel/GBEngine/kutil.cc`:

```
/* alway use tailreduction, except:
  * - in local rings, - in lex order case, -in ring over extensions */
```

Thus, `lex` is special...



---

archive/issue_comments_428746.json:
```json
{
    "body": "<a id='comment:40'></a>\nI opened https://github.com/Singular/Sources/issues/920 to ask upstream for confirmation that we understand everything well here.",
    "created_at": "2019-03-25T19:48:10Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428746",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:40'></a>
I opened https://github.com/Singular/Sources/issues/920 to ask upstream for confirmation that we understand everything well here.



---

archive/issue_comments_428747.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [dimpase](#comment%3A40):\n> I opened https://github.com/Singular/Sources/issues/920 to ask upstream for confirmation that we understand everything well here.\n\n\nIt doesn't look like github issues are a regular discussion forum for Singular issues, so you might want to send it elsewhere.\n\nI can imagine that particularly for lex, tail reduction might be more expensive (e.g., there's generally an infinite number of monomials smaller than the leading one, so it's harder to bound the process). So there might be something to say for amending the documentation of `reduce` to allow for non-tailreduced outcomes and allowing for an option to set whether tailreduction is required or not.",
    "created_at": "2019-03-25T21:32:26Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428747",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:41'></a>
Replying to [dimpase](#comment%3A40):
> I opened https://github.com/Singular/Sources/issues/920 to ask upstream for confirmation that we understand everything well here.


It doesn't look like github issues are a regular discussion forum for Singular issues, so you might want to send it elsewhere.

I can imagine that particularly for lex, tail reduction might be more expensive (e.g., there's generally an infinite number of monomials smaller than the leading one, so it's harder to bound the process). So there might be something to say for amending the documentation of `reduce` to allow for non-tailreduced outcomes and allowing for an option to set whether tailreduction is required or not.



---

archive/issue_comments_428748.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [nbruin](#comment%3A41):\n> Replying to [dimpase](#comment%3A40):\n> > I opened https://github.com/Singular/Sources/issues/920 to ask upstream for confirmation that we understand everything well here.\n\n> \n> It doesn't look like github issues are a regular discussion forum for Singular issues, so you might want to send it elsewhere.\n\n\nin my experience, it's a place where one of the authors of sage/libs/singular/groebner_strategy looks very often, and replies quickly.\n\n> \n> I can imagine that particularly for lex, tail reduction might be more expensive (e.g., there's generally an infinite number of monomials smaller than the leading one, so it's harder to bound the process). So there might be something to say for amending the documentation of `reduce` to allow for non-tailreduced outcomes and allowing for an option to set whether tailreduction is required or not.\n\n\nyes, with `lex` Groebner bases are pretty bad, that's no surprise that one does not want full reduction (and there is no harm in postponing it, except one wants it, of course, too).\n\nI'm just surprised that `libSingular` appears to change an option without asking.",
    "created_at": "2019-03-25T23:48:40Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428748",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'></a>
Replying to [nbruin](#comment%3A41):
> Replying to [dimpase](#comment%3A40):
> > I opened https://github.com/Singular/Sources/issues/920 to ask upstream for confirmation that we understand everything well here.

> 
> It doesn't look like github issues are a regular discussion forum for Singular issues, so you might want to send it elsewhere.


in my experience, it's a place where one of the authors of sage/libs/singular/groebner_strategy looks very often, and replies quickly.

> 
> I can imagine that particularly for lex, tail reduction might be more expensive (e.g., there's generally an infinite number of monomials smaller than the leading one, so it's harder to bound the process). So there might be something to say for amending the documentation of `reduce` to allow for non-tailreduced outcomes and allowing for an option to set whether tailreduction is required or not.


yes, with `lex` Groebner bases are pretty bad, that's no surprise that one does not want full reduction (and there is no harm in postponing it, except one wants it, of course, too).

I'm just surprised that `libSingular` appears to change an option without asking.



---

archive/issue_comments_428749.json:
```json
{
    "body": "<a id='comment:43'></a>\non https://github.com/Singular/Sources/issues/920 we get an advice to call `kNF()` rather than `redNF()` and `redtailBba()`, and indeed `kNF()` will call `redNF()` and `redtailBba()` for you, and do some other \"admin\" stuff with options.\n\nThe question is, why was this not done in the 1st place?",
    "created_at": "2019-03-29T10:48:10Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428749",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'></a>
on https://github.com/Singular/Sources/issues/920 we get an advice to call `kNF()` rather than `redNF()` and `redtailBba()`, and indeed `kNF()` will call `redNF()` and `redtailBba()` for you, and do some other "admin" stuff with options.

The question is, why was this not done in the 1st place?



---

archive/issue_comments_428750.json:
```json
{
    "body": "<a id='comment:44'></a>\ngit blame ascribes this to the original check-in of the file groebner_strategy.pyx (by Martin Albrecht), so we've never done differently. Given that we have pretty authoritative advice now, I think it would be reasonable to just ascribe it to incomplete information at the time, and make the change now. If there was a good reason, we'll discover it ...",
    "created_at": "2019-03-29T15:38:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428750",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:44'></a>
git blame ascribes this to the original check-in of the file groebner_strategy.pyx (by Martin Albrecht), so we've never done differently. Given that we have pretty authoritative advice now, I think it would be reasonable to just ascribe it to incomplete information at the time, and make the change now. If there was a good reason, we'll discover it ...



---

archive/issue_comments_428751.json:
```json
{
    "body": "<a id='comment:45'></a>\nthe advice is from 3rd author of `groebner_strategy.pyx`, so that's a bit worrying :-)",
    "created_at": "2019-03-29T16:29:29Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428751",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:45'></a>
the advice is from 3rd author of `groebner_strategy.pyx`, so that's a bit worrying :-)



---

archive/issue_comments_428752.json:
```json
{
    "body": "<a id='comment:46'></a>\nTo add to the worry: I have no recollection why I did what I did.",
    "created_at": "2019-03-29T17:27:58Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428752",
    "user": "https://github.com/malb"
}
```

<a id='comment:46'></a>
To add to the worry: I have no recollection why I did what I did.



---

archive/issue_events_242937.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-06-11T10:42:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242937"
}
```



---

archive/issue_comments_428753.json:
```json
{
    "body": "**Changing author** from \"Dima Pasechnik\" to \"\".",
    "created_at": "2019-06-11T10:42:44Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428753",
    "user": "https://github.com/dimpase"
}
```

**Changing author** from "Dima Pasechnik" to "".



---

archive/issue_comments_428754.json:
```json
{
    "body": "<a id='comment:48'></a>\nAs the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:55:02Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428754",
    "user": "https://github.com/embray"
}
```

<a id='comment:48'></a>
As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_events_242938.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:55:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242938"
}
```



---

archive/issue_comments_428755.json:
```json
{
    "body": "**Branch:** [u/dimpase/singular/singu_nf](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/singular/singu_nf)",
    "created_at": "2020-04-18T03:23:04Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428755",
    "user": "https://github.com/dimpase"
}
```

**Branch:** [u/dimpase/singular/singu_nf](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/singular/singu_nf)



---

archive/issue_comments_428756.json:
```json
{
    "body": "<a id='comment:50'></a>\nby popular demand, a minimal patch.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670\">21e4f9a</a></td><td><code>a minimal fix to ensure that 'lex' order always reduces</code></td></tr></table>\n",
    "created_at": "2020-04-18T03:23:04Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428756",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:50'></a>
by popular demand, a minimal patch.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670">21e4f9a</a></td><td><code>a minimal fix to ensure that 'lex' order always reduces</code></td></tr></table>




---

archive/issue_events_242939.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-04-18T03:23:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242939"
}
```



---

archive/issue_comments_428757.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -36,3 +36,5 @@\n ```\n \n For reference, I am using Sage version 8.6 on macOS Mojave 10.14.3.\n+\n+PS. see also https://groups.google.com/d/msg/sage-devel/K49-V3BbWbg/pxuoehPvAAAJ\n``````\n",
    "created_at": "2020-04-18T03:23:04Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428757",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -36,3 +36,5 @@
 ```
 
 For reference, I am using Sage version 8.6 on macOS Mojave 10.14.3.
+
+PS. see also https://groups.google.com/d/msg/sage-devel/K49-V3BbWbg/pxuoehPvAAAJ
``````




---

archive/issue_comments_428758.json:
```json
{
    "body": "**Commit:** [21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)",
    "created_at": "2020-04-18T03:23:04Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428758",
    "user": "https://github.com/dimpase"
}
```

**Commit:** [21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)



---

archive/issue_comments_428759.json:
```json
{
    "body": "**Author:** Dima Pasechnik",
    "created_at": "2020-04-18T03:23:04Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428759",
    "user": "https://github.com/dimpase"
}
```

**Author:** Dima Pasechnik



---

archive/issue_events_242940.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-04-18T03:27:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242940"
}
```



---

archive/issue_comments_428760.json:
```json
{
    "body": "<a id='comment:52'></a>\nHere is another example that seems to be solved by this. This does not involve a `lex` ordering I think, but only happens over non-prime fields.\n\n```\nsage: R.<x,y> = GF(101^2)['X,Y'].quotient('X*Y - 1')\nsage: R('X^3 - X^2*Y')\nx^3 - x^2*y\n```\n\nHowever, I could not find any documentation whatsoever on this `noTailReduction` flag. I think we should avoid using low-level functionality like this which we do not understand, as this is hard to maintain. Upstream suggested to call `kNF()` instead, so we should at least try that, unless we know more about why this was not done in the first place. In fact, looking at the code in `multi_polynomial_libsingular.pyx`:\n\n```\nsage: R2.<x,y> = PolynomialRing(QQ, 2, order=\"lex\")\nsage: I2 = R2.ideal([\"x^2 - x\", \"y^2 - y\"])\nsage: R2(\"x + y^2\").reduce(I2)          # calls _groebner_strategy().normal_form()\nx + y^2\nsage: R2(\"x + y^2\").reduce(I2.gens())   # calls kNF()\nx + y\n```",
    "created_at": "2020-04-19T21:06:20Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428760",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:52'></a>
Here is another example that seems to be solved by this. This does not involve a `lex` ordering I think, but only happens over non-prime fields.

```
sage: R.<x,y> = GF(101^2)['X,Y'].quotient('X*Y - 1')
sage: R('X^3 - X^2*Y')
x^3 - x^2*y
```

However, I could not find any documentation whatsoever on this `noTailReduction` flag. I think we should avoid using low-level functionality like this which we do not understand, as this is hard to maintain. Upstream suggested to call `kNF()` instead, so we should at least try that, unless we know more about why this was not done in the first place. In fact, looking at the code in `multi_polynomial_libsingular.pyx`:

```
sage: R2.<x,y> = PolynomialRing(QQ, 2, order="lex")
sage: I2 = R2.ideal(["x^2 - x", "y^2 - y"])
sage: R2("x + y^2").reduce(I2)          # calls _groebner_strategy().normal_form()
x + y^2
sage: R2("x + y^2").reduce(I2.gens())   # calls kNF()
x + y
```



---

archive/issue_comments_428761.json:
```json
{
    "body": "<a id='comment:53'></a>\nFrankly, the whole libsingular interface is hard to maintain, as it relies on undocumented functionality.\n\nI went and read source to figure out what that flag does.",
    "created_at": "2020-04-20T00:03:40Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428761",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:53'></a>
Frankly, the whole libsingular interface is hard to maintain, as it relies on undocumented functionality.

I went and read source to figure out what that flag does.



---

archive/issue_comments_428762.json:
```json
{
    "body": "<a id='comment:54'></a>\nI think making use of kNF is a bit too major a rewrite of the libsingular interface for me to attempt  it.",
    "created_at": "2020-04-20T00:08:40Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428762",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:54'></a>
I think making use of kNF is a bit too major a rewrite of the libsingular interface for me to attempt  it.



---

archive/issue_comments_428763.json:
```json
{
    "body": "<a id='comment:55'></a>\nOk, fair enough. The whole `groebner_strategy` module directly uses Singular internals, so this patch is certainly in the spirit of that module. The module is only used for normal form computations, so it seems unlikely this change has unexpected effects that are worse than what we currently have.\n\nTherefore, I am setting this to positive. The issue this ticket solves is a huge pain, as equality testing in some quotient rings is completely broken, which defeats the point of using quotient rings in the first place. Thanks for finding a solution.",
    "created_at": "2020-04-20T18:32:48Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428763",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:55'></a>
Ok, fair enough. The whole `groebner_strategy` module directly uses Singular internals, so this patch is certainly in the spirit of that module. The module is only used for normal form computations, so it seems unlikely this change has unexpected effects that are worse than what we currently have.

Therefore, I am setting this to positive. The issue this ticket solves is a huge pain, as equality testing in some quotient rings is completely broken, which defeats the point of using quotient rings in the first place. Thanks for finding a solution.



---

archive/issue_events_242941.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-04-20T18:32:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242941"
}
```



---

archive/issue_events_242942.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-04-20T18:32:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242942"
}
```



---

archive/issue_comments_428764.json:
```json
{
    "body": "**Reviewer:** Markus Wageringel",
    "created_at": "2020-04-20T18:32:48Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428764",
    "user": "https://github.com/mwageringel"
}
```

**Reviewer:** Markus Wageringel



---

archive/issue_comments_428765.json:
```json
{
    "body": "**Changing branch** from \"[u/dimpase/singular/singu_nf](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/singular/singu_nf)\" to \"[21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)\".",
    "created_at": "2020-04-23T22:33:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428765",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/dimpase/singular/singu_nf](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/singular/singu_nf)" to "[21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)".



---

archive/issue_events_242943.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-23T22:33:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242943"
}
```



---

archive/issue_events_242944.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a6b03dda335376498bbcbb9ee68828199369c922",
    "created_at": "2020-04-23T22:33:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27508#event-242944"
}
```



---

archive/issue_comments_428766.json:
```json
{
    "body": "**Changing commit** from \"[21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)\" to \"\".",
    "created_at": "2020-10-09T00:52:15Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428766",
    "user": "https://github.com/slel"
}
```

**Changing commit** from "[21e4f9a36e9c86c8db260d5ee77b648f5803a670](https://github.com/sagemath/sagetrac-mirror/commit/21e4f9a36e9c86c8db260d5ee77b648f5803a670)" to "".



---

archive/issue_comments_428767.json:
```json
{
    "body": "<a id='comment:57'></a>\nReplying to [dimpase](#comment%3A25):\n> And by the way there is this: #12529\n\n\nDoctest added there (needs review).",
    "created_at": "2020-10-09T00:52:15Z",
    "issue": "https://github.com/sagemath/sage/issues/27508",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27508#issuecomment-428767",
    "user": "https://github.com/slel"
}
```

<a id='comment:57'></a>
Replying to [dimpase](#comment%3A25):
> And by the way there is this: #12529


Doctest added there (needs review).
