# Issue 27865: Refactor GraphicsArray, fixing various issues

archive/issues_027628.json:
```json
{
    "body": "This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #27866.\n\n`GraphicsArray` is now endowed with a `matplotlib()` function (inheritated from  `MultiGraphics`). This fixes the issues reported in #10466, #10657, #11160 and #12591 (see :comment:3 and comment:5 below for a summary). \nMoreover, this simplifies `sphinx_plot()` (defined in `src/doc/common/conf.py`), avoiding code duplication. \n\nBeside introducing `matplotlib()` at the graphics array level, two bugs had to be corrected in `Graphics.matplotlib()`:\n\n- `_set_scale` was called on the whole figure, while it should be called on the current subplot\n- `tick_params` was called on `figure.get_axes()[0]`, i.e. the first subplot of the figure, while it should be called on the current subplot.\n\nThe documentation of `Graphics.matplotlib()` is also improved in this ticket. \n\nAnother bug has been corrected in `Graphics.save()`: contrary to what was claimed in the documentation `g.save(\"filename\")` with `\"filename\"` having no extension did not save in a `sobj` file but yielded to an error. \n\nAnother modification is the introduction of the helper function `_parse_figsize()` in `src/sage/plot/graphics.py` to avoid code duplication: it is used in `Graphics.matplotlib()`, `MultiGraphics.matplotlib()` and `sphinx_plot()`.\n\nSince the file `src/sage/plot/graphics.py` was already quite long (3736 lines!), the class `GraphicsArray` was moved to the new file `src/sage/plot/multigraphics.py`, which contains the definition of the base class `MultiGraphics`. This makes things more consistent:\n- `src/sage/plot/graphics.py`: only `Graphics` objects\n- `src/sage/plot/multigraphics.py`: only `MultiGraphics` objects\n\nBesides the bugs reported in the tickets #10466, #10657, #11160 and #12591, this ticket fixes two other bugs:\n\n- if any plot in the array had a log scale, the latter was erroneously applied to the first plot of the array\n\n- the computation of `nrows` and `ncols` in the function `graphics_array()` (defined in `src/sage/plot/plot.py`) yielded unnecessary large numbers in certain cases. For instance we have in Sage 8.7:\n\n```\nsage: graphics_array([plot(sin)]*4, ncols=4)\nGraphics Array of size 2 x 4\n```\n  with the second raw that is entirely blank. With the code in this ticket the output is \n\n```\nGraphics Array of size 1 x 4\n```\n  This fix explains the change of doctest outputs in `src/sage/categories/finite_posets.py` and `src/sage/repl/rich_output/pretty_print.py`\n\nA preview (including the functionalities introduced in #27866) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).\n\nCC:  @kcrisman @fchapoton @dkrenn @jdemeyer @embray\n\nKeywords: graphics_array, matplotlib\n\nBranch/Commit: 36c0f178353017ac12573ff038c40ed55a24ba2d\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27865\n\n",
    "closed_at": "2019-06-27T20:13:31Z",
    "created_at": "2019-05-24T12:12:57Z",
    "labels": [
        "component: graphics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Refactor GraphicsArray, fixing various issues",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27865",
    "user": "https://github.com/egourgoulhon"
}
```
This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #27866.

`GraphicsArray` is now endowed with a `matplotlib()` function (inheritated from  `MultiGraphics`). This fixes the issues reported in #10466, #10657, #11160 and #12591 (see :comment:3 and comment:5 below for a summary). 
Moreover, this simplifies `sphinx_plot()` (defined in `src/doc/common/conf.py`), avoiding code duplication. 

Beside introducing `matplotlib()` at the graphics array level, two bugs had to be corrected in `Graphics.matplotlib()`:

- `_set_scale` was called on the whole figure, while it should be called on the current subplot
- `tick_params` was called on `figure.get_axes()[0]`, i.e. the first subplot of the figure, while it should be called on the current subplot.

The documentation of `Graphics.matplotlib()` is also improved in this ticket. 

Another bug has been corrected in `Graphics.save()`: contrary to what was claimed in the documentation `g.save("filename")` with `"filename"` having no extension did not save in a `sobj` file but yielded to an error. 

Another modification is the introduction of the helper function `_parse_figsize()` in `src/sage/plot/graphics.py` to avoid code duplication: it is used in `Graphics.matplotlib()`, `MultiGraphics.matplotlib()` and `sphinx_plot()`.

Since the file `src/sage/plot/graphics.py` was already quite long (3736 lines!), the class `GraphicsArray` was moved to the new file `src/sage/plot/multigraphics.py`, which contains the definition of the base class `MultiGraphics`. This makes things more consistent:
- `src/sage/plot/graphics.py`: only `Graphics` objects
- `src/sage/plot/multigraphics.py`: only `MultiGraphics` objects

Besides the bugs reported in the tickets #10466, #10657, #11160 and #12591, this ticket fixes two other bugs:

- if any plot in the array had a log scale, the latter was erroneously applied to the first plot of the array

- the computation of `nrows` and `ncols` in the function `graphics_array()` (defined in `src/sage/plot/plot.py`) yielded unnecessary large numbers in certain cases. For instance we have in Sage 8.7:

```
sage: graphics_array([plot(sin)]*4, ncols=4)
Graphics Array of size 2 x 4
```
  with the second raw that is entirely blank. With the code in this ticket the output is 

```
Graphics Array of size 1 x 4
```
  This fix explains the change of doctest outputs in `src/sage/categories/finite_posets.py` and `src/sage/repl/rich_output/pretty_print.py`

A preview (including the functionalities introduced in #27866) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).

CC:  @kcrisman @fchapoton @dkrenn @jdemeyer @embray

Keywords: graphics_array, matplotlib

Branch/Commit: 36c0f178353017ac12573ff038c40ed55a24ba2d

Reviewer: Frédéric Chapoton

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27865





---

archive/issue_comments_538947.json:
```json
{
    "body": "Changing commit from \"\" to \"3a5ef55af4d104c840107f46abbcba90fa401a18\"",
    "created_at": "2019-05-24T12:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538947",
    "user": "https://github.com/egourgoulhon"
}
```

Changing commit from "" to "3a5ef55af4d104c840107f46abbcba90fa401a18"



---

archive/issue_comments_538948.json:
```json
{
    "body": "<a id='comment:1'></a>Last 10 new commits:",
    "created_at": "2019-05-24T12:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538948",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:1'></a>Last 10 new commits:



---

archive/issue_comments_538949.json:
```json
{
    "body": "Changing branch from \"\" to \"public/graphics/multi_graphics\"",
    "created_at": "2019-05-24T12:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538949",
    "user": "https://github.com/egourgoulhon"
}
```

Changing branch from "" to "public/graphics/multi_graphics"



---

archive/issue_comments_538950.json:
```json
{
    "body": "Changing author from \"\" to \"Eric Gourgoulhon\"",
    "created_at": "2019-05-24T12:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538950",
    "user": "https://github.com/egourgoulhon"
}
```

Changing author from "" to "Eric Gourgoulhon"



---

archive/issue_comments_538951.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #...\n+This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #27866.\n \n `GraphicsArray` is now endowed with a `matplotlib()` function (inheritated from  `MultiGraphics`). This fixes the issues reported in #10466, #10657, #11160 and #12591. \n Moreover, this simplifies `sphinx_plot()` (defined in `src/doc/common/conf.py`), avoiding code duplication. \n@@ -35,7 +35,7 @@\n ```\n   This fix explains the change of doctest outputs in `src/sage/categories/finite_posets.py` and `src/sage/repl/rich_output/pretty_print.py`\n \n-A preview (including the functionalities introduced in #...) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).\n+A preview (including the functionalities introduced in #27866) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-05-24T12:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538951",
    "user": "https://github.com/egourgoulhon"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #...
+This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #27866.
 
 `GraphicsArray` is now endowed with a `matplotlib()` function (inheritated from  `MultiGraphics`). This fixes the issues reported in #10466, #10657, #11160 and #12591. 
 Moreover, this simplifies `sphinx_plot()` (defined in `src/doc/common/conf.py`), avoiding code duplication. 
@@ -35,7 +35,7 @@
 ```
   This fix explains the change of doctest outputs in `src/sage/categories/finite_posets.py` and `src/sage/repl/rich_output/pretty_print.py`
 
-A preview (including the functionalities introduced in #...) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).
+A preview (including the functionalities introduced in #27866) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).
 
 Comment: 1
 
``````




---

archive/issue_comments_538952.json:
```json
{
    "body": "Attachment [graphics_array_bug.png](tarball://root/attachments/some-uuid/ticket27865/graphics_array_bug.png) by @egourgoulhon created at 2019-05-24 12:19:13",
    "created_at": "2019-05-24T12:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538952",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [graphics_array_bug.png](tarball://root/attachments/some-uuid/ticket27865/graphics_array_bug.png) by @egourgoulhon created at 2019-05-24 12:19:13



---

archive/issue_comments_538953.json:
```json
{
    "body": "Attachment [graphics_array_ok.png](tarball://root/attachments/some-uuid/ticket27865/graphics_array_ok.png) by @egourgoulhon created at 2019-05-24 12:19:46",
    "created_at": "2019-05-24T12:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538953",
    "user": "https://github.com/egourgoulhon"
}
```

Attachment [graphics_array_ok.png](tarball://root/attachments/some-uuid/ticket27865/graphics_array_ok.png) by @egourgoulhon created at 2019-05-24 12:19:46



---

archive/issue_comments_538954.json:
```json
{
    "body": "<a id='comment:3'></a>Here is an example summarizing some the `GraphicsArray` issues. In Sage 8.7, the following code:\n\n```\nsage: g1 = plot(sin(x^2), (x, 0, 6), \n....:           axes_labels=[r'$\\theta$', r'$\\sin(\\theta^2)$'], fontsize=14)\nsage: g2 = circle((0,0), 1, fill=True, color='red', alpha=0.4, axes=False) \\\n....:      + text(\"This is a disk\", (0.9, 1.1), color='red', alpha=0.4, \n....:             fontsize=12)\nsage: g3 = plot(x^3, (x, 1, 100), axes_labels=[r'$x$', r'$y$'], \n....:           legend_label=r'$y = x^3$', scale='semilogy', frame=True, \n....:           gridlines='minor') \\\n....:      + text(\"This is a semilogy plot\", (80, 1e5), color='red', alpha=0.4, \n....:             fontsize=12)\nsage: graphics_array([g1, g2, g3])\n```\nresults in this figure:\n\n![](graphics_array_bug.png)\n\nWe see that \n- the `semilogy` scale asked for `g3` is actually applied to `g1`\n- the fontsize asked for `g1` is not taken into account (this is #10657)\n- the option `axes=False` asked for `g2` is not taken into account (#10466 and #10657)\n- the legend of `g3` is doubled (#12591) \n- the color of the text in `g3` is not the same as in `g2`, while they both defined as `color='red', alpha=0.4` (#12591)\n\nWith the code introduced in this ticket, the output becomes\n\n![](graphics_array_ok.png)\n\nWe see that all the above issues are gone.",
    "created_at": "2019-05-24T12:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538954",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:3'></a>Here is an example summarizing some the `GraphicsArray` issues. In Sage 8.7, the following code:

```
sage: g1 = plot(sin(x^2), (x, 0, 6), 
....:           axes_labels=[r'$\theta$', r'$\sin(\theta^2)$'], fontsize=14)
sage: g2 = circle((0,0), 1, fill=True, color='red', alpha=0.4, axes=False) \
....:      + text("This is a disk", (0.9, 1.1), color='red', alpha=0.4, 
....:             fontsize=12)
sage: g3 = plot(x^3, (x, 1, 100), axes_labels=[r'$x$', r'$y$'], 
....:           legend_label=r'$y = x^3$', scale='semilogy', frame=True, 
....:           gridlines='minor') \
....:      + text("This is a semilogy plot", (80, 1e5), color='red', alpha=0.4, 
....:             fontsize=12)
sage: graphics_array([g1, g2, g3])
```
results in this figure:

![](graphics_array_bug.png)

We see that 
- the `semilogy` scale asked for `g3` is actually applied to `g1`
- the fontsize asked for `g1` is not taken into account (this is #10657)
- the option `axes=False` asked for `g2` is not taken into account (#10466 and #10657)
- the legend of `g3` is doubled (#12591) 
- the color of the text in `g3` is not the same as in `g2`, while they both defined as `color='red', alpha=0.4` (#12591)

With the code introduced in this ticket, the output becomes

![](graphics_array_ok.png)

We see that all the above issues are gone.



---

archive/issue_comments_538955.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-24T12:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538955",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_538956.json:
```json
{
    "body": "<a id='comment:5'></a>Another bug fixed by this ticket regards the options passed to the method `GraphicsArray.show()`. This bug shows up in the\n[2D plotting section](http://doc.sagemath.org/html/en/reference/plotting/sage/plot/plot.html) of the reference manual. In the example starting with *\"The basic options for filling a plot\"*, the figure resulting from\n\n```\nsage: p1 = plot(sin(x), -pi, pi, fill='axis')\nsage: p2 = plot(sin(x), -pi, pi, fill='min', fillalpha=1)\nsage: p3 = plot(sin(x), -pi, pi, fill='max')\nsage: p4 = plot(sin(x), -pi, pi, fill=(1-x)/3, fillcolor='blue', fillalpha=.2)\nsage: graphics_array([[p1, p2], [p3, p4]]).show(frame=True, axes=False)\n```\nhas obviously some axes and no frame...\n\nCompare with the figure produced by the code in this ticket [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/plot.html).",
    "created_at": "2019-05-24T12:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538956",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:5'></a>Another bug fixed by this ticket regards the options passed to the method `GraphicsArray.show()`. This bug shows up in the
[2D plotting section](http://doc.sagemath.org/html/en/reference/plotting/sage/plot/plot.html) of the reference manual. In the example starting with *"The basic options for filling a plot"*, the figure resulting from

```
sage: p1 = plot(sin(x), -pi, pi, fill='axis')
sage: p2 = plot(sin(x), -pi, pi, fill='min', fillalpha=1)
sage: p3 = plot(sin(x), -pi, pi, fill='max')
sage: p4 = plot(sin(x), -pi, pi, fill=(1-x)/3, fillcolor='blue', fillalpha=.2)
sage: graphics_array([[p1, p2], [p3, p4]]).show(frame=True, axes=False)
```
has obviously some axes and no frame...

Compare with the figure produced by the code in this ticket [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/plot.html).



---

archive/issue_comments_538957.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,41 @@\n+This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #27866.\n \n+`GraphicsArray` is now endowed with a `matplotlib()` function (inheritated from  `MultiGraphics`). This fixes the issues reported in #10466, #10657, #11160 and #12591 (see :comment:3 and comment:5 below for a summary). \n+Moreover, this simplifies `sphinx_plot()` (defined in `src/doc/common/conf.py`), avoiding code duplication. \n+\n+Beside introducing `matplotlib()` at the graphics array level, two bugs had to be corrected in `Graphics.matplotlib()`:\n+\n+- `_set_scale` was called on the whole figure, while it should be called on the current subplot\n+- `tick_params` was called on `figure.get_axes()[0]`, i.e. the first subplot of the figure, while it should be called on the current subplot.\n+\n+The documentation of `Graphics.matplotlib()` is also improved in this ticket. \n+\n+Another bug has been corrected in `Graphics.save()`: contrary to what was claimed in the documentation `g.save(\"filename\")` with `\"filename\"` having no extension did not save in a `sobj` file but yielded to an error. \n+\n+Another modification is the introduction of the helper function `_parse_figsize()` in `src/sage/plot/graphics.py` to avoid code duplication: it is used in `Graphics.matplotlib()`, `MultiGraphics.matplotlib()` and `sphinx_plot()`.\n+\n+Since the file `src/sage/plot/graphics.py` was already quite long (3736 lines!), the class `GraphicsArray` was moved to the new file `src/sage/plot/multigraphics.py`, which contains the definition of the base class `MultiGraphics`. This makes things more consistent:\n+- `src/sage/plot/graphics.py`: only `Graphics` objects\n+- `src/sage/plot/multigraphics.py`: only `MultiGraphics` objects\n+\n+Besides the bugs reported in the tickets #10466, #10657, #11160 and #12591, this ticket fixes two other bugs:\n+\n+- if any plot in the array had a log scale, the latter was erroneously applied to the first plot of the array\n+\n+- the computation of `nrows` and `ncols` in the function `graphics_array()` (defined in `src/sage/plot/plot.py`) yielded unnecessary large numbers in certain cases. For instance we have in Sage 8.7:\n+\n+```\n+sage: graphics_array([plot(sin)]*4, ncols=4)\n+Graphics Array of size 2 x 4\n+```\n+  with the second raw that is entirely blank. With the code in this ticket the output is \n+\n+```\n+Graphics Array of size 1 x 4\n+```\n+  This fix explains the change of doctest outputs in `src/sage/categories/finite_posets.py` and `src/sage/repl/rich_output/pretty_print.py`\n+\n+A preview (including the functionalities introduced in #27866) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).\n \n Comment: 1\n \n``````\n",
    "created_at": "2019-05-24T13:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538957",
    "user": "https://github.com/egourgoulhon"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,41 @@
+This ticket makes `GraphicsArray` derive from a new class, `MultiGraphics`, which is more generic (arbitrary positions of graphics objects on a canvas) and paves the way towards graphics insets in #27866.
 
+`GraphicsArray` is now endowed with a `matplotlib()` function (inheritated from  `MultiGraphics`). This fixes the issues reported in #10466, #10657, #11160 and #12591 (see :comment:3 and comment:5 below for a summary). 
+Moreover, this simplifies `sphinx_plot()` (defined in `src/doc/common/conf.py`), avoiding code duplication. 
+
+Beside introducing `matplotlib()` at the graphics array level, two bugs had to be corrected in `Graphics.matplotlib()`:
+
+- `_set_scale` was called on the whole figure, while it should be called on the current subplot
+- `tick_params` was called on `figure.get_axes()[0]`, i.e. the first subplot of the figure, while it should be called on the current subplot.
+
+The documentation of `Graphics.matplotlib()` is also improved in this ticket. 
+
+Another bug has been corrected in `Graphics.save()`: contrary to what was claimed in the documentation `g.save("filename")` with `"filename"` having no extension did not save in a `sobj` file but yielded to an error. 
+
+Another modification is the introduction of the helper function `_parse_figsize()` in `src/sage/plot/graphics.py` to avoid code duplication: it is used in `Graphics.matplotlib()`, `MultiGraphics.matplotlib()` and `sphinx_plot()`.
+
+Since the file `src/sage/plot/graphics.py` was already quite long (3736 lines!), the class `GraphicsArray` was moved to the new file `src/sage/plot/multigraphics.py`, which contains the definition of the base class `MultiGraphics`. This makes things more consistent:
+- `src/sage/plot/graphics.py`: only `Graphics` objects
+- `src/sage/plot/multigraphics.py`: only `MultiGraphics` objects
+
+Besides the bugs reported in the tickets #10466, #10657, #11160 and #12591, this ticket fixes two other bugs:
+
+- if any plot in the array had a log scale, the latter was erroneously applied to the first plot of the array
+
+- the computation of `nrows` and `ncols` in the function `graphics_array()` (defined in `src/sage/plot/plot.py`) yielded unnecessary large numbers in certain cases. For instance we have in Sage 8.7:
+
+```
+sage: graphics_array([plot(sin)]*4, ncols=4)
+Graphics Array of size 2 x 4
+```
+  with the second raw that is entirely blank. With the code in this ticket the output is 
+
+```
+Graphics Array of size 1 x 4
+```
+  This fix explains the change of doctest outputs in `src/sage/categories/finite_posets.py` and `src/sage/repl/rich_output/pretty_print.py`
+
+A preview (including the functionalities introduced in #27866) is available [here](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html).
 
 Comment: 1
 
``````




---

archive/issue_comments_538958.json:
```json
{
    "body": "<a id='comment:7'></a>THIS IS AMAZING!\n\n---\nI (as usual the past few years, I am sorry) will not be able to provide code review.  But I think this is a great improvement.  The multigraphics examples at the end of [the example page](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html) are particularly impressive, and bring us a long ways toward having a \"mathematical\" way to interface with the stuff matplotlib provides - I could imagine it being particularly helpful with SageTeX.  Thank you.\n\nAs my only suggestion, I would just urge you to be sure all previously \"wrong\" behavior shows up in the tests section, and that any errors be tested as well.  As an example, you mention\n> For instance, G[0, 1] will throw an error.\n\nso might as well put in \n\n```\nsage: G[0,1]\nIndexError ...\n```\nor whatever is appropriate.  We've definitely caught subtle things over the years with those kinds of tests.",
    "created_at": "2019-05-24T13:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538958",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:7'></a>THIS IS AMAZING!

---
I (as usual the past few years, I am sorry) will not be able to provide code review.  But I think this is a great improvement.  The multigraphics examples at the end of [the example page](https://sagemanifolds.obspm.fr/preview/graphics_inset/reference/plotting/sage/plot/multigraphics.html) are particularly impressive, and bring us a long ways toward having a "mathematical" way to interface with the stuff matplotlib provides - I could imagine it being particularly helpful with SageTeX.  Thank you.

As my only suggestion, I would just urge you to be sure all previously "wrong" behavior shows up in the tests section, and that any errors be tested as well.  As an example, you mention
> For instance, G[0, 1] will throw an error.

so might as well put in 

```
sage: G[0,1]
IndexError ...
```
or whatever is appropriate.  We've definitely caught subtle things over the years with those kinds of tests.



---

archive/issue_comments_538959.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 kcrisman]:\n> As my only suggestion, I would just urge you to be sure all previously \"wrong\" behavior shows up in the tests section, and that any errors be tested as well.  As an example, you mention\n> > For instance, G[0, 1] will throw an error.\n\n> so might as well put in \n> {{{\n> sage: G[0,1]\n> IndexError ...\n> }}}\n> or whatever is appropriate.  We've definitely caught subtle things over the years with those kinds of tests.\n\n\nOK, no problem, I'll introduce these tests. \nAnd thanks for your comments.",
    "created_at": "2019-05-24T14:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538959",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>Replying to [comment:7 kcrisman]:
> As my only suggestion, I would just urge you to be sure all previously "wrong" behavior shows up in the tests section, and that any errors be tested as well.  As an example, you mention
> > For instance, G[0, 1] will throw an error.

> so might as well put in 
> {{{
> sage: G[0,1]
> IndexError ...
> }}}
> or whatever is appropriate.  We've definitely caught subtle things over the years with those kinds of tests.


OK, no problem, I'll introduce these tests. 
And thanks for your comments.



---

archive/issue_comments_538960.json:
```json
{
    "body": "<a id='comment:10'></a>During the preparation of this ticket, two questions arose:\n- the method `Graphics.matplotlib()` has the optional argument `filename=None`, which is not used in the function body; can we get rid of it?\n- the method `Graphics.save_image()` merely falls back to `Graphics.save()`; can we remove it (after some deprecation period of course) ?",
    "created_at": "2019-05-25T06:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538960",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:10'></a>During the preparation of this ticket, two questions arose:
- the method `Graphics.matplotlib()` has the optional argument `filename=None`, which is not used in the function body; can we get rid of it?
- the method `Graphics.save_image()` merely falls back to `Graphics.save()`; can we remove it (after some deprecation period of course) ?



---

archive/issue_comments_538961.json:
```json
{
    "body": "<a id='comment:11'></a>some failing doctests, see patchbot reports",
    "created_at": "2019-06-05T18:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538961",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:11'></a>some failing doctests, see patchbot reports



---

archive/issue_comments_538962.json:
```json
{
    "body": "Changing commit from \"3a5ef55af4d104c840107f46abbcba90fa401a18\" to \"af2bf46ee0fc9cc5d24a696d55f4a1af1cc45f52\"",
    "created_at": "2019-06-06T22:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3a5ef55af4d104c840107f46abbcba90fa401a18" to "af2bf46ee0fc9cc5d24a696d55f4a1af1cc45f52"



---

archive/issue_comments_538963.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-06T22:20:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538963",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_538964.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:11 chapoton]:\n> some failing doctests, see patchbot reports\n\nFrom all the errors reported bu the patchbots, it seems that only one pertains to this ticket:\n\n```\nFile \"src/sage/plot/multigraphics.py\", line 427, in \nsage.plot.multigraphics.MultiGraphics._latex_\nFailed example:\n    A._latex_()[:40]\nException raised:\n...\n      File \"/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/lib/python2.7/site-packages/matplotlib/backends/backend_pgf.py\", line 315, in __init__\n        \"or error in preamble:\\n%s\" % stdout)\n    LatexError: LaTeX returned an error, probably missing font or error in preamble:\n...\n    ! Package fontspec Error: The font \"Bitstream Vera Serif\" cannot be found.\n```\nThis doctest is passed on my computer (Ubuntu 18.04). It fails on macOS patchbots. The reason seems to be this Matplotlib issue:\nhttps://github.com/matplotlib/matplotlib/issues/10307\n\nActually, this doctest was borrowed from the previous method `GraphicsArray._latex_()`, since now the method `_latex_()` is defined at the level of the base class `MultiGraphics`. Its failure had not been revealed previously by the macOS patchbots because the doctest was marked with `# not tested`. When I transferred the method `_latex_()` from `GraphicsArray` to `MultiGraphics`, I suppressed the marker `# not tested` because the doctest passed on my computer and I though there was then no reason for such a marker.\n\nI have restored the `# not tested` marker in the above commit, along with a comment about the Matplotlib issue on macOS.\n\nThe patchbots also complain about 4 pyflakes issues. However, these reports are spurious for 2 of them:\n- \n\n```\nsrc/doc/common/conf.py:4: 'sage.misc.sagedoc.extlinks' imported but unused\n```\n  => if one suppresses this import, then the documentation fails to build (stating that `:trac:` is unknown)\n- \n\n```\nsrc/sage/plot/plot.py:585: 'sage.plot.line.line2d' imported but unused\n```\n  => this line is preceded by the following comment: \n\n```\n# import of line2d below is only for redirection of imports\n```\n  so I guess one should keep it.\n\nThe other 2 pyflakes errors are \n\n```\nsrc/sage/repl/rich_output/pretty_print.py:34: 'types' imported but unused\nsrc/sage/repl/rich_output/pretty_print.py:35: 'collections' imported but unused\n```\nThese imports have not been introduced by the currrent ticket and I am not sure whether one could removed them without any subtle side effect... \n\nBesides, the above commit implements the `G[0, 1]` error example suggested by Karl-Dieter in comment:7.",
    "created_at": "2019-06-06T22:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538964",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:13'></a>Replying to [comment:11 chapoton]:
> some failing doctests, see patchbot reports

From all the errors reported bu the patchbots, it seems that only one pertains to this ticket:

```
File "src/sage/plot/multigraphics.py", line 427, in 
sage.plot.multigraphics.MultiGraphics._latex_
Failed example:
    A._latex_()[:40]
Exception raised:
...
      File "/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/lib/python2.7/site-packages/matplotlib/backends/backend_pgf.py", line 315, in __init__
        "or error in preamble:\n%s" % stdout)
    LatexError: LaTeX returned an error, probably missing font or error in preamble:
...
    ! Package fontspec Error: The font "Bitstream Vera Serif" cannot be found.
```
This doctest is passed on my computer (Ubuntu 18.04). It fails on macOS patchbots. The reason seems to be this Matplotlib issue:
https://github.com/matplotlib/matplotlib/issues/10307

Actually, this doctest was borrowed from the previous method `GraphicsArray._latex_()`, since now the method `_latex_()` is defined at the level of the base class `MultiGraphics`. Its failure had not been revealed previously by the macOS patchbots because the doctest was marked with `# not tested`. When I transferred the method `_latex_()` from `GraphicsArray` to `MultiGraphics`, I suppressed the marker `# not tested` because the doctest passed on my computer and I though there was then no reason for such a marker.

I have restored the `# not tested` marker in the above commit, along with a comment about the Matplotlib issue on macOS.

The patchbots also complain about 4 pyflakes issues. However, these reports are spurious for 2 of them:
- 

```
src/doc/common/conf.py:4: 'sage.misc.sagedoc.extlinks' imported but unused
```
  => if one suppresses this import, then the documentation fails to build (stating that `:trac:` is unknown)
- 

```
src/sage/plot/plot.py:585: 'sage.plot.line.line2d' imported but unused
```
  => this line is preceded by the following comment: 

```
# import of line2d below is only for redirection of imports
```
  so I guess one should keep it.

The other 2 pyflakes errors are 

```
src/sage/repl/rich_output/pretty_print.py:34: 'types' imported but unused
src/sage/repl/rich_output/pretty_print.py:35: 'collections' imported but unused
```
These imports have not been introduced by the currrent ticket and I am not sure whether one could removed them without any subtle side effect... 

Besides, the above commit implements the `G[0, 1]` error example suggested by Karl-Dieter in comment:7.



---

archive/issue_comments_538965.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-07T08:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538965",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_538966.json:
```json
{
    "body": "Changing commit from \"af2bf46ee0fc9cc5d24a696d55f4a1af1cc45f52\" to \"36c0f178353017ac12573ff038c40ed55a24ba2d\"",
    "created_at": "2019-06-07T08:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538966",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "af2bf46ee0fc9cc5d24a696d55f4a1af1cc45f52" to "36c0f178353017ac12573ff038c40ed55a24ba2d"



---

archive/issue_comments_538967.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 egourgoulhon]:\n> Besides, the above commit implements the `G[0, 1]` error example suggested by Karl-Dieter in comment:7.\n\n\nI've prepared the `G[0, 1]` example with py3 Sage and it turns out that the error message is different in py2. This triggered a new doctest error for the py2 patchbot. The above commit (comment:14) fixes this.",
    "created_at": "2019-06-07T08:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538967",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:15'></a>Replying to [comment:13 egourgoulhon]:
> Besides, the above commit implements the `G[0, 1]` error example suggested by Karl-Dieter in comment:7.


I've prepared the `G[0, 1]` example with py3 Sage and it turns out that the error message is different in py2. This triggered a new doctest error for the py2 patchbot. The above commit (comment:14) fixes this.



---

archive/issue_comments_538968.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:7 kcrisman]:\n> \n> As my only suggestion, I would just urge you to be sure all previously \"wrong\" behavior shows up in the tests section\n\n\nActually, the previous wrong behaviors were \"silent\" errors, which showed up only in the figures, as illustrated in comment:3. Their fixes therefore cannot be checked in doctests. I've however chosen the doctests in the EXAMPLES section of `sage.plot.plot.graphics_array` and `sage.plot.multigraphics.GraphicsArray` to include most of (if not all) the issues exhibited in comment:3 and comment:5. But at the end, the fix can only be judged by a human eye.",
    "created_at": "2019-06-14T13:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538968",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:16'></a>Replying to [comment:7 kcrisman]:
> 
> As my only suggestion, I would just urge you to be sure all previously "wrong" behavior shows up in the tests section


Actually, the previous wrong behaviors were "silent" errors, which showed up only in the figures, as illustrated in comment:3. Their fixes therefore cannot be checked in doctests. I've however chosen the doctests in the EXAMPLES section of `sage.plot.plot.graphics_array` and `sage.plot.multigraphics.GraphicsArray` to include most of (if not all) the issues exhibited in comment:3 and comment:5. But at the end, the fix can only be judged by a human eye.



---

archive/issue_comments_538969.json:
```json
{
    "body": "<a id='comment:17'></a>It seems there is no longer any failing doctest reported by the patchbots (except for spurious ones, i.e. failures that appear on the ticket 0 as well: https://patchbot.sagemath.org/ticket/0/)...",
    "created_at": "2019-06-14T13:50:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538969",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:17'></a>It seems there is no longer any failing doctest reported by the patchbots (except for spurious ones, i.e. failures that appear on the ticket 0 as well: https://patchbot.sagemath.org/ticket/0/)...



---

archive/issue_comments_538970.json:
```json
{
    "body": "<a id='comment:18'></a>> > As my only suggestion, I would just urge you to be sure all previously \"wrong\" behavior shows up in the tests section\n\n> \n> Actually, the previous wrong behaviors were \"silent\" errors, which showed up only in the figures, as illustrated in comment:3. Their fixes therefore cannot be checked in doctests. I've however chosen the doctests in the EXAMPLES section of `sage.plot.plot.graphics_array` and `sage.plot.multigraphics.GraphicsArray` to include most of (if not all) the issues exhibited in comment:3 and comment:5. But at the end, the fix can only be judged by a human eye. \n\n\nOh, that was all I meant.  Yes, at one point we considered trying to automate doctesting the images themselves (!) but especially now that a lot of images are created for the documentation, regressions should be easier to identify, and we would like to have those available.  Thanks!",
    "created_at": "2019-06-14T14:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538970",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:18'></a>> > As my only suggestion, I would just urge you to be sure all previously "wrong" behavior shows up in the tests section

> 
> Actually, the previous wrong behaviors were "silent" errors, which showed up only in the figures, as illustrated in comment:3. Their fixes therefore cannot be checked in doctests. I've however chosen the doctests in the EXAMPLES section of `sage.plot.plot.graphics_array` and `sage.plot.multigraphics.GraphicsArray` to include most of (if not all) the issues exhibited in comment:3 and comment:5. But at the end, the fix can only be judged by a human eye. 


Oh, that was all I meant.  Yes, at one point we considered trying to automate doctesting the images themselves (!) but especially now that a lot of images are created for the documentation, regressions should be easier to identify, and we would like to have those available.  Thanks!



---

archive/issue_comments_538971.json:
```json
{
    "body": "<a id='comment:19'></a>I am giving a positive review. This is a very nice progress, that fixes a whole lot of long-standing bugs. Fixed tickets will have to be closed later, with appropriate doctests if necessary.",
    "created_at": "2019-06-19T14:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538971",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:19'></a>I am giving a positive review. This is a very nice progress, that fixes a whole lot of long-standing bugs. Fixed tickets will have to be closed later, with appropriate doctests if necessary.



---

archive/issue_comments_538972.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-19T14:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538972",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_538973.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2019-06-19T14:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538973",
    "user": "https://github.com/fchapoton"
}
```

Changing reviewer from "" to "Frédéric Chapoton"



---

archive/issue_comments_538974.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 chapoton]:\n> I am giving a positive review. This is a very nice progress, that fixes a whole lot of long-standing bugs. Fixed tickets will have to be closed later, with appropriate doctests if necessary.\n\n\n\nThanks for the review!",
    "created_at": "2019-06-19T16:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538974",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:20'></a>Replying to [comment:19 chapoton]:
> I am giving a positive review. This is a very nice progress, that fixes a whole lot of long-standing bugs. Fixed tickets will have to be closed later, with appropriate doctests if necessary.



Thanks for the review!



---

archive/issue_comments_538975.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-27T20:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538975",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_538976.json:
```json
{
    "body": "Changing branch from \"public/graphics/multi_graphics\" to \"36c0f178353017ac12573ff038c40ed55a24ba2d\"",
    "created_at": "2019-06-27T20:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538976",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/graphics/multi_graphics" to "36c0f178353017ac12573ff038c40ed55a24ba2d"



---

archive/issue_events_069074.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-27T20:13:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27865#event-69074"
}
```



---

archive/issue_events_069075.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:34:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27865#event-69075"
}
```



---

archive/issue_comments_538977.json:
```json
{
    "body": "<a id='comment:22'></a>Not in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were *actually* included, especially when closing tickets.",
    "created_at": "2019-07-03T11:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27865#issuecomment-538977",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>Not in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were *actually* included, especially when closing tickets.
