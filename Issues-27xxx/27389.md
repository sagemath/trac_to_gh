# Issue 27389: Fix src/build/cythonized/build/cythonized directory

archive/issues_027152.json:
```json
{
    "body": "Inside `$SAGE_ROOT`, I see a file like\n\n```\nsrc/build/cythonized/build/cythonized/sage/libs/eclib/wrap.cpp\n```\nThe duplication of `build/cythonized` is not how it's supposed to be.\n\nThere is also an issue with dependency checking: when `src/sage/libs/eclib/wrap.cpp` is edited and Sage is rebuilt, the new contents of that file are not taken into account.\n\nThis started with #27040, which accidentally removed the top-level source directory `SAGE_SRC` from the include directories. This way, the include was only found in the build directory, confusing Cython.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27389\n\n",
    "closed_at": "2019-03-07T19:27:00Z",
    "created_at": "2019-03-01T08:58:07Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Fix src/build/cythonized/build/cythonized directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27389",
    "user": "https://github.com/jdemeyer"
}
```
Inside `$SAGE_ROOT`, I see a file like

```
src/build/cythonized/build/cythonized/sage/libs/eclib/wrap.cpp
```
The duplication of `build/cythonized` is not how it's supposed to be.

There is also an issue with dependency checking: when `src/sage/libs/eclib/wrap.cpp` is edited and Sage is rebuilt, the new contents of that file are not taken into account.

This started with #27040, which accidentally removed the top-level source directory `SAGE_SRC` from the include directories. This way, the include was only found in the build directory, confusing Cython.

Issue created by migration from https://trac.sagemath.org/ticket/27389





---

archive/issue_comments_382067.json:
```json
{
    "body": "This seems to be recent: I don't see it in Sage 8.6.",
    "created_at": "2019-03-01T19:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382067",
    "user": "https://github.com/jhpalmieri"
}
```

This seems to be recent: I don't see it in Sage 8.6.



---

archive/issue_comments_382068.json:
```json
{
    "body": "Is it a problem to have `src/build/cythonized/setup.py`, a copy of `src/setup.py`? That's been there for some time, I think.",
    "created_at": "2019-03-01T21:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382068",
    "user": "https://github.com/jhpalmieri"
}
```

Is it a problem to have `src/build/cythonized/setup.py`, a copy of `src/setup.py`? That's been there for some time, I think.



---

archive/issue_comments_382069.json:
```json
{
    "body": "It looks to me like the `build/cythonized/build/cythonized` problem first arises in 8.7.beta2.",
    "created_at": "2019-03-01T21:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382069",
    "user": "https://github.com/jhpalmieri"
}
```

It looks to me like the `build/cythonized/build/cythonized` problem first arises in 8.7.beta2.



---

archive/issue_comments_382070.json:
```json
{
    "body": "Could the problem be #27041?",
    "created_at": "2019-03-02T01:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382070",
    "user": "https://github.com/jhpalmieri"
}
```

Could the problem be #27041?



---

archive/issue_comments_382071.json:
```json
{
    "body": "No, it's #27040, and in particular, the directories are created when `cythonize` is run in `sage_build_cython.run`. The dependencies for the elements in `module_list` are wrong: before #27040, I see (among other things):\n\n```\n/path/to/SAGE_ROOT/local/include/python2.7/pythread.h\n/path/to/SAGE_ROOT/src/sage/cpython/cython_metaclass.h\n/path/to/SAGE_ROOT/src/sage/libs/ntl/ntlwrap.h\n/path/to/SAGE_ROOT/src/sage/libs/ntl/ntlwrap_impl.h\n/path/to/SAGE_ROOT/src/setup.py\n```\nwhile after #27040, I see\n\n```\n/path/to/SAGE_ROOT/local/include/python2.7/pythread.h\nbuild/cythonized/sage/cpython/cython_metaclass.h\nbuild/cythonized/sage/libs/ntl/ntlwrap.h\nbuild/cythonized/sage/libs/ntl/ntlwrap_impl.h\nbuild/cythonized/setup.py\n```\n(I put a print statement in the `Cython.Build.Dependencies.cythonize` function: after `module_list, module_metadata = create_extension_list(...`, I added\n\n```\n    for m in module_list:\n        for dep in m.depends:\n            print(dep)\n```\n)\nDoes that clarify anything?",
    "created_at": "2019-03-02T07:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382071",
    "user": "https://github.com/jhpalmieri"
}
```

No, it's #27040, and in particular, the directories are created when `cythonize` is run in `sage_build_cython.run`. The dependencies for the elements in `module_list` are wrong: before #27040, I see (among other things):

```
/path/to/SAGE_ROOT/local/include/python2.7/pythread.h
/path/to/SAGE_ROOT/src/sage/cpython/cython_metaclass.h
/path/to/SAGE_ROOT/src/sage/libs/ntl/ntlwrap.h
/path/to/SAGE_ROOT/src/sage/libs/ntl/ntlwrap_impl.h
/path/to/SAGE_ROOT/src/setup.py
```
while after #27040, I see

```
/path/to/SAGE_ROOT/local/include/python2.7/pythread.h
build/cythonized/sage/cpython/cython_metaclass.h
build/cythonized/sage/libs/ntl/ntlwrap.h
build/cythonized/sage/libs/ntl/ntlwrap_impl.h
build/cythonized/setup.py
```
(I put a print statement in the `Cython.Build.Dependencies.cythonize` function: after `module_list, module_metadata = create_extension_list(...`, I added

```
    for m in module_list:
        for dep in m.depends:
            print(dep)
```
)
Does that clarify anything?



---

archive/issue_comments_382072.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2019-03-02T07:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382072",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_382073.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-03-04T10:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382073",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_382074.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-04T10:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382074",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_382075.json:
```json
{
    "body": "Just to be clear, this is only an oddity when building in source, right?  Does it actually *break* anything?  You mentioned in the ticket something about it breaking dependency checking when modifying some files.  Did this fix it?",
    "created_at": "2019-03-04T16:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382075",
    "user": "https://github.com/embray"
}
```

Just to be clear, this is only an oddity when building in source, right?  Does it actually *break* anything?  You mentioned in the ticket something about it breaking dependency checking when modifying some files.  Did this fix it?



---

archive/issue_comments_382076.json:
```json
{
    "body": "Replying to [comment:13 embray]:\n> Just to be clear, this is only an oddity when building in source, right?\n\n\nWhat do you mean with \"building in source\"?\n\n> Does it actually *break* anything?  You mentioned in the ticket something about it breaking dependency checking when modifying some files.  Did this fix it?\n\n\nYes, this is needed to fix dependency checking because the build directory `build/cythonize` is also in the list of include directories (see line 421 of `src/setup.py`). Certain auto-generated files end up in `build/cythonize`, so that's needed. Normal C/C++ source files like `sage/cpython/cython_metaclass.h` appear in the source directory `$SAGE_SRC`. They are also copied by Cython to `build/cythonized`. But the dependency should be on the file in `$SAGE_SRC` which means that this directory is needed in the list of include directories and it should come before `build/cythonized` in that list.",
    "created_at": "2019-03-04T16:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382076",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 embray]:
> Just to be clear, this is only an oddity when building in source, right?


What do you mean with "building in source"?

> Does it actually *break* anything?  You mentioned in the ticket something about it breaking dependency checking when modifying some files.  Did this fix it?


Yes, this is needed to fix dependency checking because the build directory `build/cythonize` is also in the list of include directories (see line 421 of `src/setup.py`). Certain auto-generated files end up in `build/cythonize`, so that's needed. Normal C/C++ source files like `sage/cpython/cython_metaclass.h` appear in the source directory `$SAGE_SRC`. They are also copied by Cython to `build/cythonized`. But the dependency should be on the file in `$SAGE_SRC` which means that this directory is needed in the list of include directories and it should come before `build/cythonized` in that list.



---

archive/issue_comments_382077.json:
```json
{
    "body": "With this branch in place, will existing `build/cythonized/build/cythonized` directories cause any problems? Is there any reason to clean them up?",
    "created_at": "2019-03-04T21:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382077",
    "user": "https://github.com/jhpalmieri"
}
```

With this branch in place, will existing `build/cythonized/build/cythonized` directories cause any problems? Is there any reason to clean them up?



---

archive/issue_comments_382078.json:
```json
{
    "body": "Replying to [comment:15 jhpalmieri]:\n> With this branch in place, will existing `build/cythonized/build/cythonized` directories cause any problems?\n\n\nI don't think so.",
    "created_at": "2019-03-04T22:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382078",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:15 jhpalmieri]:
> With this branch in place, will existing `build/cythonized/build/cythonized` directories cause any problems?


I don't think so.



---

archive/issue_comments_382079.json:
```json
{
    "body": "First: with this branch, the `build/cythonized/build/` directory is not created.\n\nSecond: without this branch (and is this what Erik was asking?), if I use `./configure --prefix=/path/to/somewhere/else`, then `build/cythonized/build` is still created in `SAGE_ROOT/src`.",
    "created_at": "2019-03-05T00:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382079",
    "user": "https://github.com/jhpalmieri"
}
```

First: with this branch, the `build/cythonized/build/` directory is not created.

Second: without this branch (and is this what Erik was asking?), if I use `./configure --prefix=/path/to/somewhere/else`, then `build/cythonized/build` is still created in `SAGE_ROOT/src`.



---

archive/issue_comments_382080.json:
```json
{
    "body": "I'm ready to give this a positive review. I'll wait a day to see if there are any objections.",
    "created_at": "2019-03-05T00:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382080",
    "user": "https://github.com/jhpalmieri"
}
```

I'm ready to give this a positive review. I'll wait a day to see if there are any objections.



---

archive/issue_comments_382081.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-06T19:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382081",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_068021.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-07T19:27:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27389#event-68021"
}
```



---

archive/issue_comments_382082.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-07T19:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27389",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27389#issuecomment-382082",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
