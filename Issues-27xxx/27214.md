# Issue 27214: libgap memory allocation on Cygwin

archive/issues_026977.json:
```json
{
    "body": "As discussed in #27213, when we initialize libgap, we pass it the `-s` flag which according to the docs is 'set the initially mapped virtual memory', to a size determined by `sage.interfaces.gap.get_gap_memory_pool_size()`, which on my system happens to be ~3GB.\n\nThis is fine, in general, as it's an amount that's available to my system.  Nonetheless, in most usage (especially e.g. in the test suite) most of this will not be used.\n\nI have to look into exactly how this memory gets allocated, but however it's being allocated it is unfortunately \"committed\" memory, meaning that although those pages are allocated lazily, they are guaranteed by the system to be made available for that process, so regardless whether those pages are actually in RAM, space is still reserved for them.  So perhaps it uses sbrk to expand the process's heap.  When the process is forked, Cygwin's `fork()` has to copy the parent process's heap into the child.  This has the unfortunate effect of accessing those pages, causing them to become allocated in physical memory (even, apparently, if they're clean / unused).\n\nThis is essentially the same issue we faced with PARI in #22633, but applied to GAP.  In fact, GAP's code sets the default value of the `-s` flag to 0 on Cygwin, presumably for reasons related to this.  This might be possible to avoid, as was done in PARI, by instead allocating this memory with `mmap` and `MAP_NORESERVE`.\n\n**Upstream PR:** https://github.com/gap-system/gap/pull/3335\n\nAssignee: @embray\n\nBranch/Commit: 4b359de75fe85f481d889d0c0ace4086cb130088\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nDependencies: #27070, #27490\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27214\n\n",
    "closed_at": "2019-03-19T21:26:11Z",
    "created_at": "2019-02-04T12:25:33Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "libgap memory allocation on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27214",
    "user": "https://github.com/embray"
}
```
As discussed in #27213, when we initialize libgap, we pass it the `-s` flag which according to the docs is 'set the initially mapped virtual memory', to a size determined by `sage.interfaces.gap.get_gap_memory_pool_size()`, which on my system happens to be ~3GB.

This is fine, in general, as it's an amount that's available to my system.  Nonetheless, in most usage (especially e.g. in the test suite) most of this will not be used.

I have to look into exactly how this memory gets allocated, but however it's being allocated it is unfortunately "committed" memory, meaning that although those pages are allocated lazily, they are guaranteed by the system to be made available for that process, so regardless whether those pages are actually in RAM, space is still reserved for them.  So perhaps it uses sbrk to expand the process's heap.  When the process is forked, Cygwin's `fork()` has to copy the parent process's heap into the child.  This has the unfortunate effect of accessing those pages, causing them to become allocated in physical memory (even, apparently, if they're clean / unused).

This is essentially the same issue we faced with PARI in #22633, but applied to GAP.  In fact, GAP's code sets the default value of the `-s` flag to 0 on Cygwin, presumably for reasons related to this.  This might be possible to avoid, as was done in PARI, by instead allocating this memory with `mmap` and `MAP_NORESERVE`.

**Upstream PR:** https://github.com/gap-system/gap/pull/3335

Assignee: @embray

Branch/Commit: 4b359de75fe85f481d889d0c0ace4086cb130088

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Jeroen Demeyer

Author: Erik Bray

Dependencies: #27070, #27490

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27214





---

archive/issue_comments_517346.json:
```json
{
    "body": "<a id='comment:1'></a>\nI think this is even sort of [implicitly acknowledged](https://github.com/gap-system/gap/blob/49633e8f06583a102cd0c506febe1cb128fa97f6/src/system.c#L1075) in the GAP source code where it sets the default `SyAllocPool = 0` if some macro `SYS_IS_CYGWIN32` is defined (from the commit history it's hard to tell exactly why that was added, or if any consideration has been given whether the same issue affects 64-bit Cygwin).\n\nI found that as a short term workaround passing `-s 0` when initializing libgap on Cygwin is good enough.  In that case it will allocate memory as-needed, which may have some performance impact when allocating lots of GAP objects, but for most usage I don't know that it will be noticeable (I'm not sure how best to test this--write a test that allocates lots of GAP objects?)",
    "created_at": "2019-02-05T11:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517346",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
I think this is even sort of [implicitly acknowledged](https://github.com/gap-system/gap/blob/49633e8f06583a102cd0c506febe1cb128fa97f6/src/system.c#L1075) in the GAP source code where it sets the default `SyAllocPool = 0` if some macro `SYS_IS_CYGWIN32` is defined (from the commit history it's hard to tell exactly why that was added, or if any consideration has been given whether the same issue affects 64-bit Cygwin).

I found that as a short term workaround passing `-s 0` when initializing libgap on Cygwin is good enough.  In that case it will allocate memory as-needed, which may have some performance impact when allocating lots of GAP objects, but for most usage I don't know that it will be noticeable (I'm not sure how best to test this--write a test that allocates lots of GAP objects?)



---

archive/issue_comments_517347.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [embray](#comment%3A1):\n> I found that as a short term workaround passing `-s 0` when initializing libgap on Cygwin is good enough.\n\n\nThat makes me wonder... if it's good enough for Cygwin, would it be good enough to do that on all systems unconditionally?",
    "created_at": "2019-02-05T12:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517347",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Replying to [embray](#comment%3A1):
> I found that as a short term workaround passing `-s 0` when initializing libgap on Cygwin is good enough.


That makes me wonder... if it's good enough for Cygwin, would it be good enough to do that on all systems unconditionally?



---

archive/issue_comments_517348.json:
```json
{
    "body": "<a id='comment:3'></a>\nI don't know.  The default on 64-bit systems is `SyAllocPool = 4096L*1024*1024;   /* Note this is in bytes! */` or 4GB.  Our routine for determining `get_gap_memory_pool_size()` actually gives less than this on my system (which has 32GB).  I don't really fully understand what the impact is of this in general, though I assumed there were good reasons for how we do it currently.\n\nIt's also a question of what is meant by \"good enough\".  Like I wrote, this likely does have impact when allocating a number of large GAP objects; or at least it ensures that there is enough memory reserved for GAP.  But I don't really have a good way at hand to measure that.  Might have to dig through the history to see what motivated this in the first place.\n\nFor my purposes \"good enough\" is \"it works, and most users will never tell the difference either way\".",
    "created_at": "2019-02-05T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517348",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
I don't know.  The default on 64-bit systems is `SyAllocPool = 4096L*1024*1024;   /* Note this is in bytes! */` or 4GB.  Our routine for determining `get_gap_memory_pool_size()` actually gives less than this on my system (which has 32GB).  I don't really fully understand what the impact is of this in general, though I assumed there were good reasons for how we do it currently.

It's also a question of what is meant by "good enough".  Like I wrote, this likely does have impact when allocating a number of large GAP objects; or at least it ensures that there is enough memory reserved for GAP.  But I don't really have a good way at hand to measure that.  Might have to dig through the history to see what motivated this in the first place.

For my purposes "good enough" is "it works, and most users will never tell the difference either way".



---

archive/issue_comments_517349.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe current use of `-s` in the libgap interface was actually introduced by #13588, apparently in order to *reduce* it, and not out of any performance consideration.",
    "created_at": "2019-02-05T13:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517349",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
The current use of `-s` in the libgap interface was actually introduced by #13588, apparently in order to *reduce* it, and not out of any performance consideration.



---

archive/issue_comments_517350.json:
```json
{
    "body": "<a id='comment:5'></a>\nOkay, I think I misunderstood exactly what `-s` does and how it impacts memory allocation in GAP (it doesn't help that a lot of documentation about this is out of date / inaccurate).\n\nIn fact it only uses the manual `sbrk()` calls in the specific case of `-s 0`.  Otherwise, for `-s > 0` (note: the internal variable that corresponds with `-s` is called `SyAllocPool`) it bypasses the manual `sbrk()` manipulations (thankfully) and instead allocates its own reserved pool for GAP objects, either using `mmap` (but only, for some reason or other, if `madvise` is available) or just one big `calloc()` call.\n\nCygwin does have `madvise` so I guess GAP is using `mmap` here.  I think the trick to prevent this behavior is to pass `MMAP_NORESERVE` when making a big `mmap` on Cygwin, as this has the effect of *preventing* the `MEM_COMMIT` flag from being passed to the underlying [VirtualAlloc](https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc) call.  This has an effect similar to overcommitting memory on Linux.",
    "created_at": "2019-02-05T14:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517350",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Okay, I think I misunderstood exactly what `-s` does and how it impacts memory allocation in GAP (it doesn't help that a lot of documentation about this is out of date / inaccurate).

In fact it only uses the manual `sbrk()` calls in the specific case of `-s 0`.  Otherwise, for `-s > 0` (note: the internal variable that corresponds with `-s` is called `SyAllocPool`) it bypasses the manual `sbrk()` manipulations (thankfully) and instead allocates its own reserved pool for GAP objects, either using `mmap` (but only, for some reason or other, if `madvise` is available) or just one big `calloc()` call.

Cygwin does have `madvise` so I guess GAP is using `mmap` here.  I think the trick to prevent this behavior is to pass `MMAP_NORESERVE` when making a big `mmap` on Cygwin, as this has the effect of *preventing* the `MEM_COMMIT` flag from being passed to the underlying [VirtualAlloc](https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc) call.  This has an effect similar to overcommitting memory on Linux.



---

archive/issue_comments_517351.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jdemeyer](#comment%3A2):\n> Replying to [embray](#comment%3A1):\n> > I found that as a short term workaround passing `-s 0` when initializing libgap on Cygwin is good enough.\n\n> \n> That makes me wonder... if it's good enough for Cygwin, would it be good enough to do that on all systems unconditionally?\n\n\nSo to answer your question, no that would not be a good idea on any systems, really.",
    "created_at": "2019-02-05T14:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517351",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Replying to [jdemeyer](#comment%3A2):
> Replying to [embray](#comment%3A1):
> > I found that as a short term workaround passing `-s 0` when initializing libgap on Cygwin is good enough.

> 
> That makes me wonder... if it's good enough for Cygwin, would it be good enough to do that on all systems unconditionally?


So to answer your question, no that would not be a good idea on any systems, really.



---

archive/issue_comments_517352.json:
```json
{
    "body": "<a id='comment:7'></a>\nThis issue is actually pretty bad I think.  It doesn't immediately break anything, but it can become a real drag when doing anything that involves forking a lot of new processes, and in particular it can be bad when running the doctests in parallel.",
    "created_at": "2019-02-22T13:50:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517352",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
This issue is actually pretty bad I think.  It doesn't immediately break anything, but it can become a real drag when doing anything that involves forking a lot of new processes, and in particular it can be bad when running the doctests in parallel.



---

archive/issue_events_084514.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27214#event-84514"
}
```



---

archive/issue_comments_517353.json:
```json
{
    "body": "<a id='comment:8'></a>\nWhat I do wonder is what changed that I'm only starting to notice this now.  Before upgrading to GAP 4.10, we were still passing the same flags to Volker's libGAP, and I'm pretty sure it would have had the same behavior w.r.t. memory allocation.\n\nMaybe just since we've merged some other changes to make more use of the libGAP interface the problem has become more pronounced.  I'd have to install an older version of Sage to compare.",
    "created_at": "2019-02-22T13:54:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517353",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
What I do wonder is what changed that I'm only starting to notice this now.  Before upgrading to GAP 4.10, we were still passing the same flags to Volker's libGAP, and I'm pretty sure it would have had the same behavior w.r.t. memory allocation.

Maybe just since we've merged some other changes to make more use of the libGAP interface the problem has become more pronounced.  I'd have to install an older version of Sage to compare.



---

archive/issue_comments_517354.json:
```json
{
    "body": "<a id='comment:9'></a>\nI'm actually moving this up to blocker: I cannot, even with all other existing fixes applied, get the tests for `sage.interfaces.gap` to pass.  Somewhere early on in that module's tests it invokes libgap.  Then later, when it forks to start GAP subprocesses all of them are huge in memory usage.  Something about the nature of the tests in this module are such that it forks enough subprocesses, all with the weight of this GAP memory allocation, that it eats up all 32GB of my system's memory and eventually crashes.\n\nI'm still a little unclear as to why this has gotten so bad only with the recent GAP updates, but at least there are a couple possible workarounds, which I'll try shortly...",
    "created_at": "2019-02-26T12:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517354",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I'm actually moving this up to blocker: I cannot, even with all other existing fixes applied, get the tests for `sage.interfaces.gap` to pass.  Somewhere early on in that module's tests it invokes libgap.  Then later, when it forks to start GAP subprocesses all of them are huge in memory usage.  Something about the nature of the tests in this module are such that it forks enough subprocesses, all with the weight of this GAP memory allocation, that it eats up all 32GB of my system's memory and eventually crashes.

I'm still a little unclear as to why this has gotten so bad only with the recent GAP updates, but at least there are a couple possible workarounds, which I'll try shortly...



---

archive/issue_events_084515.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27214#event-84515"
}
```



---

archive/issue_comments_517355.json:
```json
{
    "body": "<a id='comment:10'></a>\nI tried applying a patch for GAP (just on Cygwin) to use MAP_NORESERVE when mmap-ing the GAP pool.  When I run GAP directly, or even when I run the GAP API tests (in the GAP sources, that is) it appears to work fine, at least superficially.\n\nHowever, when I use the libgap interface in Sage with this patch, it immediately segfaults:\n\n```\n$ ./sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 8.7.beta4, Release Date: 2019-02-15               \u2502\n\u2502 Using Python 2.7.15. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: libgap(1)\n------------------------------------------------------------------------\nAn error occurred during signal handling.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\nSegmentation fault (core dumped)\n```\n\nwhich is completely bizarre and I can't explain it.  I will dig in a bit to see what is happening here...",
    "created_at": "2019-02-26T14:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517355",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
I tried applying a patch for GAP (just on Cygwin) to use MAP_NORESERVE when mmap-ing the GAP pool.  When I run GAP directly, or even when I run the GAP API tests (in the GAP sources, that is) it appears to work fine, at least superficially.

However, when I use the libgap interface in Sage with this patch, it immediately segfaults:

```
$ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.7.beta4, Release Date: 2019-02-15               │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: libgap(1)
------------------------------------------------------------------------
An error occurred during signal handling.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault (core dumped)
```

which is completely bizarre and I can't explain it.  I will dig in a bit to see what is happening here...



---

archive/issue_comments_517356.json:
```json
{
    "body": "<a id='comment:11'></a>\nI see: When you create an mmap with MAP_NORESERVE on Cygwin, if you try to access the allocated region it creates without committing it results in an access violation--you can't read or write to that memory until it's been explicitly committed with an additional `VirtualAlloc` call.\n\nNormally Cygwin handles this transparently: when its vectored exception handler catches a `STATUS_ACCESS_VIOLATION` it first checks if the access violation was on a memory address inside an mmap created with `MAP_NORESERVE`.  If so, it the commits the page containing the address in question, and if that is successful the exception handler returns a special value (understood by the kernel `ExceptionContinueExecution`) which basically means the error has been handled, and it should retry the operation (in this case the memory access) that resulted in the exception.\n\nThis works fine normally, which is why I don't see any problem when running GAP directly.  However, here's the tricky part: The reason this results in a SIGSEGV in Sage is because of Cysignals.  Specifically, the custom \"vectored continue handler\" I added in [cysignals#83](https://github.com/sagemath/cysignals/pull/83) in order to better handle exceptions that occur on a sigaltstack.  The reason I used a \"vector continue handler\" here is that, according to [this invaluable analysis](https://reverseengineering.stackexchange.com/questions/14992/what-are-the-vectored-continue-handlers), a vectored continue handler can be run even when the kernel detects a failed SEH validation, which is what happens when you're suddenly running on a stack that Windows thinks is off in the weeds, as is the case with sigaltstack.\n\nThe problem is that vectored continue handlers *also* run after a normal exception occurs and the SEH handler returns `ExceptionContinueExecution`.  This is what happens immediately after Cygwin's exception handler handles those explicit memory commits.  So rather than returning from this particular exception normally, we wind up in Cysignals' `win32_altstack_handler` even though we should no longer be handling an exception, much less on an alt-stack.\n\nOne aspect of this that is not totally clear to me is why this doesn't happen normally: That is, why is this behavior normally avoided in cysignals' signal handling?  If I had to wager a guess, it's simply that when cysignals does a longjmp from within the signal handler, we never return to the original exception handler in Cygwin and the vectored continue handler isn't run. Whereas, in this one obscure case, we wind up in the `win32_altstack_handler` before Cygwin even has a chance to send the process the SIGSEGV signal.\n\nI need to see if there's way to modify `win32_altstack_handler` in order to detect this situation and avoid doing the wrong thing. For example, it should check whether or not we're actually running on the signal stack.",
    "created_at": "2019-02-26T17:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517356",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
I see: When you create an mmap with MAP_NORESERVE on Cygwin, if you try to access the allocated region it creates without committing it results in an access violation--you can't read or write to that memory until it's been explicitly committed with an additional `VirtualAlloc` call.

Normally Cygwin handles this transparently: when its vectored exception handler catches a `STATUS_ACCESS_VIOLATION` it first checks if the access violation was on a memory address inside an mmap created with `MAP_NORESERVE`.  If so, it the commits the page containing the address in question, and if that is successful the exception handler returns a special value (understood by the kernel `ExceptionContinueExecution`) which basically means the error has been handled, and it should retry the operation (in this case the memory access) that resulted in the exception.

This works fine normally, which is why I don't see any problem when running GAP directly.  However, here's the tricky part: The reason this results in a SIGSEGV in Sage is because of Cysignals.  Specifically, the custom "vectored continue handler" I added in [cysignals#83](https://github.com/sagemath/cysignals/pull/83) in order to better handle exceptions that occur on a sigaltstack.  The reason I used a "vector continue handler" here is that, according to [this invaluable analysis](https://reverseengineering.stackexchange.com/questions/14992/what-are-the-vectored-continue-handlers), a vectored continue handler can be run even when the kernel detects a failed SEH validation, which is what happens when you're suddenly running on a stack that Windows thinks is off in the weeds, as is the case with sigaltstack.

The problem is that vectored continue handlers *also* run after a normal exception occurs and the SEH handler returns `ExceptionContinueExecution`.  This is what happens immediately after Cygwin's exception handler handles those explicit memory commits.  So rather than returning from this particular exception normally, we wind up in Cysignals' `win32_altstack_handler` even though we should no longer be handling an exception, much less on an alt-stack.

One aspect of this that is not totally clear to me is why this doesn't happen normally: That is, why is this behavior normally avoided in cysignals' signal handling?  If I had to wager a guess, it's simply that when cysignals does a longjmp from within the signal handler, we never return to the original exception handler in Cygwin and the vectored continue handler isn't run. Whereas, in this one obscure case, we wind up in the `win32_altstack_handler` before Cygwin even has a chance to send the process the SIGSEGV signal.

I need to see if there's way to modify `win32_altstack_handler` in order to detect this situation and avoid doing the wrong thing. For example, it should check whether or not we're actually running on the signal stack.



---

archive/issue_comments_517357.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2019-02-26T17:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517357",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_517358.json:
```json
{
    "body": "<a id='comment:13'></a>\nOne quite easy workaround: Just bail early out of `win32_altstack_handler` completely if `cysigs.inside_signal_handler`.  There's no reason to do anything in that function if we're not handling a signal in the first place.\n\nThis could still result in the undesired behavior if we happen to access some uninitialized memory in a `MAP_NORESERVE` mmap from within a signal handler.  This seems generally unlikely to me, but perhaps a more reliable solution should be found for that case as well.  But as a starting point this solves the basic problem completely.",
    "created_at": "2019-02-26T17:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517358",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
One quite easy workaround: Just bail early out of `win32_altstack_handler` completely if `cysigs.inside_signal_handler`.  There's no reason to do anything in that function if we're not handling a signal in the first place.

This could still result in the undesired behavior if we happen to access some uninitialized memory in a `MAP_NORESERVE` mmap from within a signal handler.  This seems generally unlikely to me, but perhaps a more reliable solution should be found for that case as well.  But as a starting point this solves the basic problem completely.



---

archive/issue_comments_517359.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#27384\"",
    "created_at": "2019-02-28T10:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517359",
    "user": "https://github.com/embray"
}
```

Changing dependencies from "" to "#27384"



---

archive/issue_comments_517360.json:
```json
{
    "body": "Changing commit from \"\" to \"f16f8102103b9eef812e5c8eb9089f9fb9238352\"",
    "created_at": "2019-02-28T11:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517360",
    "user": "https://github.com/embray"
}
```

Changing commit from "" to "f16f8102103b9eef812e5c8eb9089f9fb9238352"



---

archive/issue_comments_517361.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-28T11:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517361",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_517362.json:
```json
{
    "body": "Changing author from \"\" to \"Erik Bray\"",
    "created_at": "2019-02-28T11:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517362",
    "user": "https://github.com/embray"
}
```

Changing author from "" to "Erik Bray"



---

archive/issue_comments_517363.json:
```json
{
    "body": "Changing branch from \"\" to \"u/embray/cygwin/patch-gap-mmap-noreserve-pool\"",
    "created_at": "2019-02-28T11:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517363",
    "user": "https://github.com/embray"
}
```

Changing branch from "" to "u/embray/cygwin/patch-gap-mmap-noreserve-pool"



---

archive/issue_comments_517364.json:
```json
{
    "body": "<a id='comment:15'></a>\nThis adds a patch to GAP, which works fine on plain GAP but for use in Sage also requires #27384.  By design the patch only affects GAP on Cygwin.  In principle the same change could be made on other systems that support `mmap()` with the `MAP_NORESERVE` flag, though it's not clear whether or not that's strictly desirable. \n\nIt just means we can allocate a virtual address range for GAP's objects to live in up to any arbitrary size supported by the system, without regard to whether there is enough physical memory to use that entire address space (either at the time of allocation or sometime in the future) so it's still possible to run out of memory and get memory errors.\n\nThe reason this is needed on Cygwin is, as explained above, due to strange notions in Windows as to how copy-on-write pages are supposed to work, particularly in the context of making a `MAP_PRIVATE` mmap available to a child process after forking, which means that unfortunately such mmaps must be *copied* into the child process.  Thus if a huge mmap needs to be made for GAP's memory pool, and then we fork the process, that entire mmap (even if much of it has not been written to yet) needs to copied in physical RAM.  The only way to prevent this and keep the footprint of large mmaps small is to use the non-POSIX `MAP_NORESERVE` flag.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                          |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|\n|[f95dcff](https://github.com/sagemath/sagetrac-mirror/commit/f95dcff22000f525b3a114d89dd10b2e134589fa)|`Trac #27384: Patch cysignals with fix for Cygwin's sigaltstack exception`|\n|[f16f810](https://github.com/sagemath/sagetrac-mirror/commit/f16f8102103b9eef812e5c8eb9089f9fb9238352)|`Trac #27214: Patch GAP to allocate its memory pool using MAP_NORESERVE`|",
    "created_at": "2019-02-28T11:26:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517364",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
This adds a patch to GAP, which works fine on plain GAP but for use in Sage also requires #27384.  By design the patch only affects GAP on Cygwin.  In principle the same change could be made on other systems that support `mmap()` with the `MAP_NORESERVE` flag, though it's not clear whether or not that's strictly desirable. 

It just means we can allocate a virtual address range for GAP's objects to live in up to any arbitrary size supported by the system, without regard to whether there is enough physical memory to use that entire address space (either at the time of allocation or sometime in the future) so it's still possible to run out of memory and get memory errors.

The reason this is needed on Cygwin is, as explained above, due to strange notions in Windows as to how copy-on-write pages are supposed to work, particularly in the context of making a `MAP_PRIVATE` mmap available to a child process after forking, which means that unfortunately such mmaps must be *copied* into the child process.  Thus if a huge mmap needs to be made for GAP's memory pool, and then we fork the process, that entire mmap (even if much of it has not been written to yet) needs to copied in physical RAM.  The only way to prevent this and keep the footprint of large mmaps small is to use the non-POSIX `MAP_NORESERVE` flag.

---
New commits:
|                                                                                                                                          |                                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|
|[f95dcff](https://github.com/sagemath/sagetrac-mirror/commit/f95dcff22000f525b3a114d89dd10b2e134589fa)|`Trac #27384: Patch cysignals with fix for Cygwin's sigaltstack exception`|
|[f16f810](https://github.com/sagemath/sagetrac-mirror/commit/f16f8102103b9eef812e5c8eb9089f9fb9238352)|`Trac #27214: Patch GAP to allocate its memory pool using MAP_NORESERVE`|



---

archive/issue_comments_517365.json:
```json
{
    "body": "Changing upstream from \"N/A\" to \"Not yet reported upstream; Will do shortly.\"",
    "created_at": "2019-02-28T11:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517365",
    "user": "https://github.com/embray"
}
```

Changing upstream from "N/A" to "Not yet reported upstream; Will do shortly."



---

archive/issue_comments_517366.json:
```json
{
    "body": "Changing dependencies from \"#27384\" to \"#27070\"",
    "created_at": "2019-03-11T11:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517366",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "#27384" to "#27070"



---

archive/issue_comments_517367.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-11T11:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517367",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_517368.json:
```json
{
    "body": "<a id='comment:17'></a>\n1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?\n\n2. #27214 needs to be removed from this branch.",
    "created_at": "2019-03-11T11:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517368",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?

2. #27214 needs to be removed from this branch.



---

archive/issue_comments_517369.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [jdemeyer](#comment%3A17):\n> 1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?\n\n\nIt might be useful, but I would rather discuss that with upstream before imposing it that broadly.  It may be useful on Linux by allowing to overcommit memory, but it isn't strictly needed to solve any specific problem I'm aware of.\n\n> 2. #27214 needs to be removed from this branch.\n\n\nI assume you meant #27384.",
    "created_at": "2019-03-11T12:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517369",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
Replying to [jdemeyer](#comment%3A17):
> 1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?


It might be useful, but I would rather discuss that with upstream before imposing it that broadly.  It may be useful on Linux by allowing to overcommit memory, but it isn't strictly needed to solve any specific problem I'm aware of.

> 2. #27214 needs to be removed from this branch.


I assume you meant #27384.



---

archive/issue_comments_517370.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,3 +5,5 @@\n I have to look into exactly how this memory gets allocated, but however it's being allocated it is unfortunately \"committed\" memory, meaning that although those pages are allocated lazily, they are guaranteed by the system to be made available for that process, so regardless whether those pages are actually in RAM, space is still reserved for them.  So perhaps it uses sbrk to expand the process's heap.  When the process is forked, Cygwin's `fork()` has to copy the parent process's heap into the child.  This has the unfortunate effect of accessing those pages, causing them to become allocated in physical memory (even, apparently, if they're clean / unused).\n \n This is essentially the same issue we faced with PARI in #22633, but applied to GAP.  In fact, GAP's code sets the default value of the `-s` flag to 0 on Cygwin, presumably for reasons related to this.  This might be possible to avoid, as was done in PARI, by instead allocating this memory with `mmap` and `MAP_NORESERVE`.\n+\n+**Upstream PR:** https://github.com/gap-system/gap/pull/3335\n``````\n",
    "created_at": "2019-03-11T12:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517370",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,3 +5,5 @@
 I have to look into exactly how this memory gets allocated, but however it's being allocated it is unfortunately "committed" memory, meaning that although those pages are allocated lazily, they are guaranteed by the system to be made available for that process, so regardless whether those pages are actually in RAM, space is still reserved for them.  So perhaps it uses sbrk to expand the process's heap.  When the process is forked, Cygwin's `fork()` has to copy the parent process's heap into the child.  This has the unfortunate effect of accessing those pages, causing them to become allocated in physical memory (even, apparently, if they're clean / unused).
 
 This is essentially the same issue we faced with PARI in #22633, but applied to GAP.  In fact, GAP's code sets the default value of the `-s` flag to 0 on Cygwin, presumably for reasons related to this.  This might be possible to avoid, as was done in PARI, by instead allocating this memory with `mmap` and `MAP_NORESERVE`.
+
+**Upstream PR:** https://github.com/gap-system/gap/pull/3335
``````




---

archive/issue_comments_517371.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [embray](#comment%3A18):\n> Replying to [jdemeyer](#comment%3A17):\n> > 1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?\n  \n> \n> It might be useful, but I would rather discuss that with upstream before imposing it that broadly.  It may be useful on Linux by allowing to overcommit memory, but it isn't strictly needed to solve any specific problem I'm aware of.\n\n\nSure, maybe it doesn't solve any problem on Linux. But it's a good idea in general to avoid OS-specific fixes. Unless there is a good reason to apply this *only* on Cygwin, we should just apply it in general.",
    "created_at": "2019-03-11T12:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517371",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
Replying to [embray](#comment%3A18):
> Replying to [jdemeyer](#comment%3A17):
> > 1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?
  
> 
> It might be useful, but I would rather discuss that with upstream before imposing it that broadly.  It may be useful on Linux by allowing to overcommit memory, but it isn't strictly needed to solve any specific problem I'm aware of.


Sure, maybe it doesn't solve any problem on Linux. But it's a good idea in general to avoid OS-specific fixes. Unless there is a good reason to apply this *only* on Cygwin, we should just apply it in general.



---

archive/issue_comments_517372.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [jdemeyer](#comment%3A20):\n> Replying to [embray](#comment%3A18):\n> > Replying to [jdemeyer](#comment%3A17):\n> > > 1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?\n  \n> > \n> > It might be useful, but I would rather discuss that with upstream before imposing it that broadly.  It may be useful on Linux by allowing to overcommit memory, but it isn't strictly needed to solve any specific problem I'm aware of.\n\n> \n> Sure, maybe it doesn't solve any problem on Linux. But it's a good idea in general to avoid OS-specific fixes. Unless there is a good reason to apply this *only* on Cygwin, we should just apply it in general.\n\n\nI would agree if it weren't with something like GAP, where I'd rather have cooperation from upstream before making changes that could have impact other OS's (namely Linux in this case, I think) when it's not strictly necessary to.  In other words, I think if a patch is being made to support one platform, we should keep it restricted to that one platform to minimize the effects on other platforms, which may result in bug reports that are sent to the project's developer, or something like that.\n\nThat's just as a general principle.  I agree that in this case it should be low-impact on other platforms as well.  But it's still a change that's better avoided for now if possible.\n\nAlso, I want to keep this ticket open a bit longer since I'm now experiencing another segfault, that curiously is only appearing (so far) during documentation building, and which seems like it might be related to this.",
    "created_at": "2019-03-11T15:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517372",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>
Replying to [jdemeyer](#comment%3A20):
> Replying to [embray](#comment%3A18):
> > Replying to [jdemeyer](#comment%3A17):
> > > 1. Wouldn't it make sense to use `MAP_NORESERVE` unconditionally (on all systems)?
  
> > 
> > It might be useful, but I would rather discuss that with upstream before imposing it that broadly.  It may be useful on Linux by allowing to overcommit memory, but it isn't strictly needed to solve any specific problem I'm aware of.

> 
> Sure, maybe it doesn't solve any problem on Linux. But it's a good idea in general to avoid OS-specific fixes. Unless there is a good reason to apply this *only* on Cygwin, we should just apply it in general.


I would agree if it weren't with something like GAP, where I'd rather have cooperation from upstream before making changes that could have impact other OS's (namely Linux in this case, I think) when it's not strictly necessary to.  In other words, I think if a patch is being made to support one platform, we should keep it restricted to that one platform to minimize the effects on other platforms, which may result in bug reports that are sent to the project's developer, or something like that.

That's just as a general principle.  I agree that in this case it should be low-impact on other platforms as well.  But it's still a change that's better avoided for now if possible.

Also, I want to keep this ticket open a bit longer since I'm now experiencing another segfault, that curiously is only appearing (so far) during documentation building, and which seems like it might be related to this.



---

archive/issue_comments_517373.json:
```json
{
    "body": "Changing upstream from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. Developers acknowledge bug.\"",
    "created_at": "2019-03-11T15:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517373",
    "user": "https://github.com/embray"
}
```

Changing upstream from "Not yet reported upstream; Will do shortly." to "Reported upstream. Developers acknowledge bug."



---

archive/issue_comments_517374.json:
```json
{
    "body": "<a id='comment:22'></a>\nLet's see what the GAP folks say.",
    "created_at": "2019-03-11T15:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517374",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
Let's see what the GAP folks say.



---

archive/issue_comments_517375.json:
```json
{
    "body": "<a id='comment:23'></a>\nThere is definitely a bizarre problem when initializing libgap from a process started by Python's `multiprocessing` module.  For example:\n\n```python\n>>> import multiprocessing\n>>> def foo():\n...     from sage.all import libgap\n...     print(libgap(1))\n>>> p = multiprocessing.Pool(1, maxtasksperchild=1)\n>>> p.apply(foo)\n1  # eventually\n>>> p.apply(foo)  # again\n... hangs ...\n```\n\nThe hang in multiprocessing is due to [this issue](https://bugs.python.org/issue9205) which we already know.  The question is why is the child process dying unexpectedly.  I added some additional debugging to the multiprocessing module and found that it's segfaulting (only the second time, not the first time, and it's a *new* process the second time due to `maxtasksperchild=1`).  The segfault seems to originate from `InitBags` but that's all I can say for now, because even gdb is going haywire on this, which leads me to suspect a bug in Cygwin.\n\nAs a matter of fact, there was a [bug in Cygwin](https://cygwin.com/ml/cygwin/2019-01/msg00303.html) fixed very recently (like just a couple weeks ago) that might be relevant to this, but I haven't confirmed.  That is what I am going to check next.\n\nI think the issue may be especially screwy because `multiprocessing.Pool` forks worker processes from within a thread, which technically is fine in principle, but is obviously thorny territory in practice, especially in conjunction with proper exception and signal handling.  The bug that was fixed in Cygwin was in particular to do with exception handling on threads so I do believe it could be related.  One of the tracebacks I managed to get from the segfault in  `InitBags()` even showed:\n\n```\n#76 0x00000003bc41f842 in t_bootstrap ()\n   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll\n#77 0x0000000180141a1b in pthread::thread_init_wrapper (arg=0x6021cdb30)\n    at /usr/src/debug/cygwin-2.9.0-3/winsup/cygwin/thread.cc:2015\n#78 0x00000001800bed31 in pthread_wrapper (arg=<optimized out>)\n    at /usr/src/debug/cygwin-2.9.0-3/winsup/cygwin/miscfuncs.cc:459\n#79 0x0000000000000000 in ?? ()\nBacktrace stopped: previous frame inner to this frame (corrupt stack?)\n```\n\nwhich is fishy.\n\nI believe a workaround might be to go ahead and initialize libgap before forking any subprocesses.  Alternatively, just running the docbuild without multiprocessing, at least on Cygwin, is an okay workaround so long as it works.",
    "created_at": "2019-03-11T17:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517375",
    "user": "https://github.com/embray"
}
```

<a id='comment:23'></a>
There is definitely a bizarre problem when initializing libgap from a process started by Python's `multiprocessing` module.  For example:

```python
>>> import multiprocessing
>>> def foo():
...     from sage.all import libgap
...     print(libgap(1))
>>> p = multiprocessing.Pool(1, maxtasksperchild=1)
>>> p.apply(foo)
1  # eventually
>>> p.apply(foo)  # again
... hangs ...
```

The hang in multiprocessing is due to [this issue](https://bugs.python.org/issue9205) which we already know.  The question is why is the child process dying unexpectedly.  I added some additional debugging to the multiprocessing module and found that it's segfaulting (only the second time, not the first time, and it's a *new* process the second time due to `maxtasksperchild=1`).  The segfault seems to originate from `InitBags` but that's all I can say for now, because even gdb is going haywire on this, which leads me to suspect a bug in Cygwin.

As a matter of fact, there was a [bug in Cygwin](https://cygwin.com/ml/cygwin/2019-01/msg00303.html) fixed very recently (like just a couple weeks ago) that might be relevant to this, but I haven't confirmed.  That is what I am going to check next.

I think the issue may be especially screwy because `multiprocessing.Pool` forks worker processes from within a thread, which technically is fine in principle, but is obviously thorny territory in practice, especially in conjunction with proper exception and signal handling.  The bug that was fixed in Cygwin was in particular to do with exception handling on threads so I do believe it could be related.  One of the tracebacks I managed to get from the segfault in  `InitBags()` even showed:

```
#76 0x00000003bc41f842 in t_bootstrap ()
   from /home/embray/src/sagemath/sage/local/bin/libpython2.7.dll
#77 0x0000000180141a1b in pthread::thread_init_wrapper (arg=0x6021cdb30)
    at /usr/src/debug/cygwin-2.9.0-3/winsup/cygwin/thread.cc:2015
#78 0x00000001800bed31 in pthread_wrapper (arg=<optimized out>)
    at /usr/src/debug/cygwin-2.9.0-3/winsup/cygwin/miscfuncs.cc:459
#79 0x0000000000000000 in ?? ()
Backtrace stopped: previous frame inner to this frame (corrupt stack?)
```

which is fishy.

I believe a workaround might be to go ahead and initialize libgap before forking any subprocesses.  Alternatively, just running the docbuild without multiprocessing, at least on Cygwin, is an okay workaround so long as it works.



---

archive/issue_comments_517376.json:
```json
{
    "body": "<a id='comment:24'></a>\nThey would also prefer to keep it Cygwin-specific for now: https://github.com/gap-system/gap/pull/3335#issuecomment-472033940\n\nI don't necessarily agree, but it's not worth fighting either.",
    "created_at": "2019-03-12T15:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517376",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>
They would also prefer to keep it Cygwin-specific for now: https://github.com/gap-system/gap/pull/3335#issuecomment-472033940

I don't necessarily agree, but it's not worth fighting either.



---

archive/issue_comments_517377.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. Developers acknowledge bug.\" to \"Fixed upstream, but not in a stable release.\"",
    "created_at": "2019-03-12T15:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517377",
    "user": "https://github.com/embray"
}
```

Changing upstream from "Reported upstream. Developers acknowledge bug." to "Fixed upstream, but not in a stable release."



---

archive/issue_comments_517378.json:
```json
{
    "body": "<a id='comment:25'></a>\nAfter looking into this a bit more and obtaining some more stack traces, plus taking a look again at the `multiprocessing.pool` sources I see what's going on here:\n\nIn my example code in[comment:23](#comment%3A23) the strange thing was that on the first `p.apply(foo)` it works, and then on the second one it segfaults.  The reason for that is simply that `Pool.__init__` directly calls `Pool._repopulate_pool()`, the method which forks off worker processes.\n\nThus, the N processes created at the time of `Pool.__init__` are all forked directly from the main thread and function normally (in particular with the fix from #27384 in effect).\n\nHowever, `Pool` then starts up a *thread*, as I mentioned previously, which is responsible for checking for completed worker processes and starting up new ones as needed.  This is when things go awry.  Cygwin supports forking from a thread just fine--perhaps too well in fact, because it successfully duplicates the thread and resumes execution on it in the new process, and this means it's susceptible to the bug I previously mentioned, where Cygwin exception handling wasn't working properly on threads, and in particular meaning that the first time accessing a mmap created with `MAP_NORESERVE` results immediately in an unhandled `STATUS_ACCESS_VIOLATION`, which Cysignals' `win32_altstack_handler` takes and exits the process with `exit(-SIGSEGV)` as though an unhandled SIGSEGV occurred.\n\nI'm correct, then Cygwin 3.0.0 should fix that.  I'm trying that next.\n\nIn the meantime a workaround is still needed.  I would propose re-introducing the option to build the docs in serial, without using `multiprocessing` at all.  This could be hidden normally much like the doctest runner's `--serial` flag, and on Cygwin use that at least for Cygwin<3.0.0.\n\nAnother option we've talked about before is replacing `multiprocessing.Pool` with something else which doesn't require threads, such as a generalization of `sage.doctest.forker`.  I would still like to do that.  But I think in the short-term a simpler hack is needed.  After all, *most* other problems with using multiprocessing here have been otherwise dealt with, it's just this last stupid issue with Cygwin+gap+mmap+fork :(",
    "created_at": "2019-03-12T17:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517378",
    "user": "https://github.com/embray"
}
```

<a id='comment:25'></a>
After looking into this a bit more and obtaining some more stack traces, plus taking a look again at the `multiprocessing.pool` sources I see what's going on here:

In my example code in[comment:23](#comment%3A23) the strange thing was that on the first `p.apply(foo)` it works, and then on the second one it segfaults.  The reason for that is simply that `Pool.__init__` directly calls `Pool._repopulate_pool()`, the method which forks off worker processes.

Thus, the N processes created at the time of `Pool.__init__` are all forked directly from the main thread and function normally (in particular with the fix from #27384 in effect).

However, `Pool` then starts up a *thread*, as I mentioned previously, which is responsible for checking for completed worker processes and starting up new ones as needed.  This is when things go awry.  Cygwin supports forking from a thread just fine--perhaps too well in fact, because it successfully duplicates the thread and resumes execution on it in the new process, and this means it's susceptible to the bug I previously mentioned, where Cygwin exception handling wasn't working properly on threads, and in particular meaning that the first time accessing a mmap created with `MAP_NORESERVE` results immediately in an unhandled `STATUS_ACCESS_VIOLATION`, which Cysignals' `win32_altstack_handler` takes and exits the process with `exit(-SIGSEGV)` as though an unhandled SIGSEGV occurred.

I'm correct, then Cygwin 3.0.0 should fix that.  I'm trying that next.

In the meantime a workaround is still needed.  I would propose re-introducing the option to build the docs in serial, without using `multiprocessing` at all.  This could be hidden normally much like the doctest runner's `--serial` flag, and on Cygwin use that at least for Cygwin<3.0.0.

Another option we've talked about before is replacing `multiprocessing.Pool` with something else which doesn't require threads, such as a generalization of `sage.doctest.forker`.  I would still like to do that.  But I think in the short-term a simpler hack is needed.  After all, *most* other problems with using multiprocessing here have been otherwise dealt with, it's just this last stupid issue with Cygwin+gap+mmap+fork :(



---

archive/issue_comments_517379.json:
```json
{
    "body": "<a id='comment:26'></a>\nYep, Cygwin 3.0 fixes it.  So that's good news at least.  I'll make sure Cygwin>=3.0 is used for new builds of Sage and for the buildbot (probably >=3.0.4 since 3.0.0 had some unrelated problems with fork()).  It will still be good to have a workaround though.",
    "created_at": "2019-03-12T17:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517379",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>
Yep, Cygwin 3.0 fixes it.  So that's good news at least.  I'll make sure Cygwin>=3.0 is used for new builds of Sage and for the buildbot (probably >=3.0.4 since 3.0.0 had some unrelated problems with fork()).  It will still be good to have a workaround though.



---

archive/issue_comments_517380.json:
```json
{
    "body": "<a id='comment:27'></a>\nOkay, I'm going to rebase this to work with #27070, and I'm adding a little patch I'm experimenting with currently to work around the docbuild issue on older Cygwins that have this bug.",
    "created_at": "2019-03-14T13:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517380",
    "user": "https://github.com/embray"
}
```

<a id='comment:27'></a>
Okay, I'm going to rebase this to work with #27070, and I'm adding a little patch I'm experimenting with currently to work around the docbuild issue on older Cygwins that have this bug.



---

archive/issue_comments_517381.json:
```json
{
    "body": "Changing dependencies from \"#27070\" to \"#27070, #27490\"",
    "created_at": "2019-03-15T10:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517381",
    "user": "https://github.com/embray"
}
```

Changing dependencies from "#27070" to "#27070, #27490"



---

archive/issue_comments_517382.json:
```json
{
    "body": "<a id='comment:29'></a>\nI think I mentioned the `MAP_NORESERVE` once to gap developers and they were sympathetic; IMHO it should definitely be upstreamed.\n\nRealistically, this ticket is not going to make it for Sage 8.7 though.",
    "created_at": "2019-03-15T12:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517382",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>
I think I mentioned the `MAP_NORESERVE` once to gap developers and they were sympathetic; IMHO it should definitely be upstreamed.

Realistically, this ticket is not going to make it for Sage 8.7 though.



---

archive/issue_comments_517383.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-15T15:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517383",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_517384.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [vbraun](#comment%3A29):\n> I think I mentioned the `MAP_NORESERVE` once to gap developers and they were sympathetic; IMHO it should definitely be upstreamed.\n> \n> Realistically, this ticket is not going to make it for Sage 8.7 though. \n\n\nWhat does \"realistically\" mean in this case? On what basis?  I gave you plenty of advance notice that it's needed.",
    "created_at": "2019-03-15T15:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517384",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>
Replying to [vbraun](#comment%3A29):
> I think I mentioned the `MAP_NORESERVE` once to gap developers and they were sympathetic; IMHO it should definitely be upstreamed.
> 
> Realistically, this ticket is not going to make it for Sage 8.7 though. 


What does "realistically" mean in this case? On what basis?  I gave you plenty of advance notice that it's needed.



---

archive/issue_comments_517385.json:
```json
{
    "body": "<a id='comment:32'></a>\nDid you forget to update the branch to #27070?",
    "created_at": "2019-03-15T15:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517385",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>
Did you forget to update the branch to #27070?



---

archive/issue_comments_517386.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-15T15:48:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517386",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_517387.json:
```json
{
    "body": "Changing commit from \"f16f8102103b9eef812e5c8eb9089f9fb9238352\" to \"4b359de75fe85f481d889d0c0ace4086cb130088\"",
    "created_at": "2019-03-15T15:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517387",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f16f8102103b9eef812e5c8eb9089f9fb9238352" to "4b359de75fe85f481d889d0c0ace4086cb130088"



---

archive/issue_comments_517388.json:
```json
{
    "body": "<a id='comment:33'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                             |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|\n|[14b1551](https://github.com/sagemath/sagetrac-mirror/commit/14b155156b09c7df85d3ed5bd6728a3847064d31)|`Upgrade to Cysignals 1.10.2`|\n|[a2ac9c7](https://github.com/sagemath/sagetrac-mirror/commit/a2ac9c78eb99858027bc12c60dc392e7ce3118a7)|`cysignals should be a normal dependency`|\n|[4b359de](https://github.com/sagemath/sagetrac-mirror/commit/4b359de75fe85f481d889d0c0ace4086cb130088)|`Trac #27214: Patch GAP to allocate its memory pool using MAP_NORESERVE`|",
    "created_at": "2019-03-15T15:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517388",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                             |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|
|[14b1551](https://github.com/sagemath/sagetrac-mirror/commit/14b155156b09c7df85d3ed5bd6728a3847064d31)|`Upgrade to Cysignals 1.10.2`|
|[a2ac9c7](https://github.com/sagemath/sagetrac-mirror/commit/a2ac9c78eb99858027bc12c60dc392e7ce3118a7)|`cysignals should be a normal dependency`|
|[4b359de](https://github.com/sagemath/sagetrac-mirror/commit/4b359de75fe85f481d889d0c0ace4086cb130088)|`Trac #27214: Patch GAP to allocate its memory pool using MAP_NORESERVE`|



---

archive/issue_comments_517389.json:
```json
{
    "body": "<a id='comment:34'></a>\nI thought I did, but apparently not? I must have pushed to a different remote.",
    "created_at": "2019-03-15T15:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517389",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>
I thought I did, but apparently not? I must have pushed to a different remote.



---

archive/issue_comments_517390.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-15T15:51:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517390",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_517391.json:
```json
{
    "body": "<a id='comment:35'></a>\nPlease add a reference to the upstream PR in the `.patch` file. Once you did that, you can set this to positive review.",
    "created_at": "2019-03-15T15:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517391",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>
Please add a reference to the upstream PR in the `.patch` file. Once you did that, you can set this to positive review.



---

archive/issue_comments_517392.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2019-03-15T16:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517392",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_517393.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-15T17:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517393",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_517394.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-19T21:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517394",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_517395.json:
```json
{
    "body": "Changing branch from \"u/embray/cygwin/patch-gap-mmap-noreserve-pool\" to \"4b359de75fe85f481d889d0c0ace4086cb130088\"",
    "created_at": "2019-03-19T21:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27214#issuecomment-517395",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/cygwin/patch-gap-mmap-noreserve-pool" to "4b359de75fe85f481d889d0c0ace4086cb130088"



---

archive/issue_events_084516.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-19T21:26:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27214",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27214#event-84516"
}
```
