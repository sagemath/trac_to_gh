# Issue 27605: Add Python trashcan patches

archive/issues_027368.json:
```json
{
    "body": "It turns out that there is a crazy corner case left due to #27267: if a big nested deallocation occurs which was triggered by the deallocation of an instance of a Python class, the trashcan is not cleaned up: the deallocation ends but not every object is actually deallocated. Allocating a cypari2 `Gen` right after this causes cypari2 to be in an inconsistent state, since it assumes that all `Gen`s on the PARI stack have actually been deleted.\n\nThis needs several patches:\n- https://github.com/python/cpython/pull/12730 (3.7) and https://github.com/python/cpython/pull/12699 (2.7), both backports of https://github.com/python/cpython/pull/11841\n- https://github.com/python/cpython/pull/12725 (2.7 only)\n\nCC:  @NathanDunfield\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Vincent Delecroix\n\nAuthor: Jeroen Demeyer\n\nBranch: d51e20211d0b5d615f39d49b2d7ab8590424fc69\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27605\n\n",
    "closed_at": "2019-05-24T18:29:56Z",
    "created_at": "2019-04-05T13:47:35Z",
    "labels": [
        "component: packages: standard",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Add Python trashcan patches",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27605",
    "user": "https://github.com/jdemeyer"
}
```
It turns out that there is a crazy corner case left due to #27267: if a big nested deallocation occurs which was triggered by the deallocation of an instance of a Python class, the trashcan is not cleaned up: the deallocation ends but not every object is actually deallocated. Allocating a cypari2 `Gen` right after this causes cypari2 to be in an inconsistent state, since it assumes that all `Gen`s on the PARI stack have actually been deleted.

This needs several patches:
- https://github.com/python/cpython/pull/12730 (3.7) and https://github.com/python/cpython/pull/12699 (2.7), both backports of https://github.com/python/cpython/pull/11841
- https://github.com/python/cpython/pull/12725 (2.7 only)

CC:  @NathanDunfield

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Vincent Delecroix

Author: Jeroen Demeyer

Branch: d51e20211d0b5d615f39d49b2d7ab8590424fc69

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27605





---

archive/issue_comments_410864.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n It turns out that there is a crazy corner case left due to #27267: if a big nested deallocation occurs which was triggered by the deallocation of an instance of a Python class, the trashcan is not cleaned up: the deallocation ends but not every object is actually deallocated. Allocating a cypari2 `Gen` right after this causes cypari2 to be in an inconsistent state, since it assumes that all `Gen`s on the PARI stack have actually been deleted.\n \n-This is fixed by my upstream trashcan patch https://github.com/python/cpython/pull/11841 and its 2.7 backport https://github.com/python/cpython/pull/12699 (the latter is what's in this branch).\n+This needs several patches:\n+- https://github.com/python/cpython/pull/11841 (3.7) and https://github.com/python/cpython/pull/12699 (backport to 2.7)\n+- https://github.com/python/cpython/pull/12725 (2.7 only)\n \n Upstream: Reported upstream. Developers acknowledge bug.\n \n``````\n",
    "created_at": "2019-04-08T14:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410864",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
 It turns out that there is a crazy corner case left due to #27267: if a big nested deallocation occurs which was triggered by the deallocation of an instance of a Python class, the trashcan is not cleaned up: the deallocation ends but not every object is actually deallocated. Allocating a cypari2 `Gen` right after this causes cypari2 to be in an inconsistent state, since it assumes that all `Gen`s on the PARI stack have actually been deleted.
 
-This is fixed by my upstream trashcan patch https://github.com/python/cpython/pull/11841 and its 2.7 backport https://github.com/python/cpython/pull/12699 (the latter is what's in this branch).
+This needs several patches:
+- https://github.com/python/cpython/pull/11841 (3.7) and https://github.com/python/cpython/pull/12699 (backport to 2.7)
+- https://github.com/python/cpython/pull/12725 (2.7 only)
 
 Upstream: Reported upstream. Developers acknowledge bug.
 
``````




---

archive/issue_comments_410865.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2019-04-08T14:27:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410865",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_410866.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-04-08T14:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410866",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_410867.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,8 @@\n+It turns out that there is a crazy corner case left due to #27267: if a big nested deallocation occurs which was triggered by the deallocation of an instance of a Python class, the trashcan is not cleaned up: the deallocation ends but not every object is actually deallocated. Allocating a cypari2 `Gen` right after this causes cypari2 to be in an inconsistent state, since it assumes that all `Gen`s on the PARI stack have actually been deleted.\n \n+This needs several patches:\n+- https://github.com/python/cpython/pull/12730 (3.7) and https://github.com/python/cpython/pull/12699 (2.7), both backports of https://github.com/python/cpython/pull/11841\n+- https://github.com/python/cpython/pull/12725 (2.7 only)\n \n Upstream: Reported upstream. Developers acknowledge bug.\n \n``````\n",
    "created_at": "2019-04-08T14:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410867",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,8 @@
+It turns out that there is a crazy corner case left due to #27267: if a big nested deallocation occurs which was triggered by the deallocation of an instance of a Python class, the trashcan is not cleaned up: the deallocation ends but not every object is actually deallocated. Allocating a cypari2 `Gen` right after this causes cypari2 to be in an inconsistent state, since it assumes that all `Gen`s on the PARI stack have actually been deleted.
 
+This needs several patches:
+- https://github.com/python/cpython/pull/12730 (3.7) and https://github.com/python/cpython/pull/12699 (2.7), both backports of https://github.com/python/cpython/pull/11841
+- https://github.com/python/cpython/pull/12725 (2.7 only)
 
 Upstream: Reported upstream. Developers acknowledge bug.
 
``````




---

archive/issue_comments_410868.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-08T14:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410868",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_410869.json:
```json
{
    "body": "<a id='comment:7'></a>Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.",
    "created_at": "2019-04-19T08:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410869",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.



---

archive/issue_comments_410870.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 vdelecroix]:\n> Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.\n\n\nWe might as well wait for Godot...",
    "created_at": "2019-04-19T08:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410870",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>Replying to [comment:7 vdelecroix]:
> Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.


We might as well wait for Godot...



---

archive/issue_comments_410871.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 jdemeyer]:\n> Replying to [comment:7 vdelecroix]:\n> > Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.\n\n> \n> We might as well wait for Godot...\n\n\nDon't be so pessimistic. The crash with cypari2 used to be really bad. It seems that they at least acknowledge the bug. Patching python2 with a non-accepted upstream patch is a very delicate situation...",
    "created_at": "2019-04-19T08:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410871",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.

> 
> We might as well wait for Godot...


Don't be so pessimistic. The crash with cypari2 used to be really bad. It seems that they at least acknowledge the bug. Patching python2 with a non-accepted upstream patch is a very delicate situation...



---

archive/issue_comments_410872.json:
```json
{
    "body": "<a id='comment:10'></a>I tested this patch with Python 3 rather than Python 2.  When I do `sage -python -m snappy.test`, I no longer get the `cypari2` crashes that were observed before, but I do still see a couple messages:\n\n```\nRuntimeWarning: cypari2 leaked 384 bytes on the PARI stack\nRuntimeWarning: cypari2 leaked 192 bytes on the PARI stack\n```\nAre these harmless?  I had assumed they were connected with the underlying issue here, but perhaps not.  I will also do this test with Python 2 and report back.",
    "created_at": "2019-04-19T15:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410872",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:10'></a>I tested this patch with Python 3 rather than Python 2.  When I do `sage -python -m snappy.test`, I no longer get the `cypari2` crashes that were observed before, but I do still see a couple messages:

```
RuntimeWarning: cypari2 leaked 384 bytes on the PARI stack
RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
```
Are these harmless?  I had assumed they were connected with the underlying issue here, but perhaps not.  I will also do this test with Python 2 and report back.



---

archive/issue_comments_410873.json:
```json
{
    "body": "<a id='comment:11'></a>Those warnings are worrying but maybe they are unrelated to the trashcan.",
    "created_at": "2019-04-19T16:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410873",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>Those warnings are worrying but maybe they are unrelated to the trashcan.



---

archive/issue_comments_410874.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 jdemeyer]:\n> Those warnings are worrying but maybe they are unrelated to the trashcan.\n\n\nThe warnings also manifest under Python 2.  I checked to see which doctests trigger them, and found that the problem can easily be reproduced by:\n\n```\nsage: import snappy\nsage: M = snappy.Manifold('m004')\nsage: M.high_precision()\n/sage/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2878: RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack\n  exec(code_obj, self.user_global_ns, self.user_ns)\n```\nTurning warnings into exceptions to try to identify the source, I get the following message followed by a hard SIGSEGV crash:\n\n```\nsage: import snappy, warnings\nsage: warnings.simplefilter('error')\nsage: snappy.Manifold('m004').high_precision()\n---------------------------------------------------------------------------\nRuntimeWarning                            Traceback (most recent call last)\nRuntimeWarning: cypari2 leaked 192 bytes on the PARI stack\nException RuntimeWarning: RuntimeWarning(u'cypari2 leaked 192 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored\nERROR: removing wrong instance of Gen\n---------------------------------------------------------------------------\nRuntimeWarning                            Traceback (most recent call last)\nRuntimeWarning: cypari2 leaked 192 bytes on the PARI stack\nException RuntimeWarning: RuntimeWarning(u'cypari2 leaked 192 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored\nExpected: 0.499999999999999 + 0.866025403784439*I\nActual:   0.499999999999999 + 0.866025403784439*I\n---------------------------------------------------------------------------\nRuntimeWarning                            Traceback (most recent call last)\nRuntimeWarning: cypari2 leaked 264 bytes on the PARI stack\nException RuntimeWarning: RuntimeWarning(u'cypari2 leaked 264 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored\nERROR: removing wrong instance of Gen\n------------------------------------------------------------------------\n[...log clipped...]\n```",
    "created_at": "2019-04-19T18:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410874",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:12'></a>Replying to [comment:11 jdemeyer]:
> Those warnings are worrying but maybe they are unrelated to the trashcan.


The warnings also manifest under Python 2.  I checked to see which doctests trigger them, and found that the problem can easily be reproduced by:

```
sage: import snappy
sage: M = snappy.Manifold('m004')
sage: M.high_precision()
/sage/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2878: RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
  exec(code_obj, self.user_global_ns, self.user_ns)
```
Turning warnings into exceptions to try to identify the source, I get the following message followed by a hard SIGSEGV crash:

```
sage: import snappy, warnings
sage: warnings.simplefilter('error')
sage: snappy.Manifold('m004').high_precision()
---------------------------------------------------------------------------
RuntimeWarning                            Traceback (most recent call last)
RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
Exception RuntimeWarning: RuntimeWarning(u'cypari2 leaked 192 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored
ERROR: removing wrong instance of Gen
---------------------------------------------------------------------------
RuntimeWarning                            Traceback (most recent call last)
RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
Exception RuntimeWarning: RuntimeWarning(u'cypari2 leaked 192 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored
Expected: 0.499999999999999 + 0.866025403784439*I
Actual:   0.499999999999999 + 0.866025403784439*I
---------------------------------------------------------------------------
RuntimeWarning                            Traceback (most recent call last)
RuntimeWarning: cypari2 leaked 264 bytes on the PARI stack
Exception RuntimeWarning: RuntimeWarning(u'cypari2 leaked 264 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored
ERROR: removing wrong instance of Gen
------------------------------------------------------------------------
[...log clipped...]
```



---

archive/issue_comments_410875.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 dunfield]:\n> Turning warnings into exceptions to try to identify the source\n\n\nUnfortunately, these warnings happen during deallocation (think of `__del__` in Python), so exceptions are not supported there. That's also the reason why `ERROR: removing wrong instance of Gen` is printed rather than raising an exception.",
    "created_at": "2019-04-19T20:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410875",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [comment:12 dunfield]:
> Turning warnings into exceptions to try to identify the source


Unfortunately, these warnings happen during deallocation (think of `__del__` in Python), so exceptions are not supported there. That's also the reason why `ERROR: removing wrong instance of Gen` is printed rather than raising an exception.



---

archive/issue_comments_410876.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:9 vdelecroix]:\n> Patching python2 with a non-accepted upstream patch is a very delicate situation...\n\n\nThis is a pure bug-fix. Adding this patch doesn't make it any harder to support Sage without this patch, so I don't think that it's delicate.",
    "created_at": "2019-04-20T07:30:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410876",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Replying to [comment:9 vdelecroix]:
> Patching python2 with a non-accepted upstream patch is a very delicate situation...


This is a pure bug-fix. Adding this patch doesn't make it any harder to support Sage without this patch, so I don't think that it's delicate.



---

archive/issue_comments_410877.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:9 vdelecroix]:\n> It seems that they at least acknowledge the bug.\n\n\nIndeed. And in fact four(!) Python core developers approve the patch. Still, because of one guy's bikeshedding, it's not getting merged.",
    "created_at": "2019-04-20T07:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410877",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Replying to [comment:9 vdelecroix]:
> It seems that they at least acknowledge the bug.


Indeed. And in fact four(!) Python core developers approve the patch. Still, because of one guy's bikeshedding, it's not getting merged.



---

archive/issue_comments_410878.json:
```json
{
    "body": "<a id='comment:16'></a>Patch has been accepted in CPython master, but unlikely to be backported to earlier versions.",
    "created_at": "2019-05-15T14:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410878",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>Patch has been accepted in CPython master, but unlikely to be backported to earlier versions.



---

archive/issue_comments_410879.json:
```json
{
    "body": "<a id='comment:17'></a>All right then... It is a pity that this will be not backported though! What should be done for cypari2? Mention the bug explicitely in the README?",
    "created_at": "2019-05-19T13:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410879",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>All right then... It is a pity that this will be not backported though! What should be done for cypari2? Mention the bug explicitely in the README?



---

archive/issue_comments_410880.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-19T13:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410880",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_410881.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 vdelecroix]:\n> All right then... It is a pity that this will be not backported though! What should be done for cypari2? Mention the bug explicitely in the README?\n\n\nWill merging ticket this cause problems for the folks who package Sage for the various Linux distros?  Presumably Debian et al are not going to be willing to apply these patches to their master versions of Python 2.7 and 3.7.  I guess if all of Sage's doctests pass without the patches then it's OK.  (It still surprises me that snappy's doctests, which number only a few 1000 and doesn't use cypari2 that heavily trigger this problem but Sage's massive test suite does not.)",
    "created_at": "2019-05-19T14:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410881",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:18'></a>Replying to [comment:17 vdelecroix]:
> All right then... It is a pity that this will be not backported though! What should be done for cypari2? Mention the bug explicitely in the README?


Will merging ticket this cause problems for the folks who package Sage for the various Linux distros?  Presumably Debian et al are not going to be willing to apply these patches to their master versions of Python 2.7 and 3.7.  I guess if all of Sage's doctests pass without the patches then it's OK.  (It still surprises me that snappy's doctests, which number only a few 1000 and doesn't use cypari2 that heavily trigger this problem but Sage's massive test suite does not.)



---

archive/issue_comments_410882.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 dunfield]:\n> Will merging ticket this cause problems for the folks who package Sage for the various Linux distros?\n\n\nNo, they will likely just package Python without these patches. This means that the snappy+cypari2 bug will still occur.\n\n> I guess if all of Sage's doctests pass without the patches then it's OK.\n\n\nIt indeed seems not to affect Sage doctests.\n\n> It still surprises me that snappy's doctests, which number only a few 1000 and doesn't use cypari2 that heavily\n\n\nI have no explanation for that. Maybe it's just coincidence.",
    "created_at": "2019-05-19T16:40:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410882",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>Replying to [comment:18 dunfield]:
> Will merging ticket this cause problems for the folks who package Sage for the various Linux distros?


No, they will likely just package Python without these patches. This means that the snappy+cypari2 bug will still occur.

> I guess if all of Sage's doctests pass without the patches then it's OK.


It indeed seems not to affect Sage doctests.

> It still surprises me that snappy's doctests, which number only a few 1000 and doesn't use cypari2 that heavily


I have no explanation for that. Maybe it's just coincidence.



---

archive/issue_events_068557.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-05-24T18:29:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27605#event-68557"
}
```



---

archive/issue_comments_410883.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-24T18:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410883",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_410884.json:
```json
{
    "body": "<a id='comment:21'></a>Sadly, some parts of this issue have not been completely dealt with.  Here is a simple example\n(with Sage 8.8 on Ubuntu 18.04):\n\n```\nsage: z = complex(pari('1+1*I'))\n/XXX/sage-8.8/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2878:\nRuntimeWarning: cypari2 leaked 48 bytes on the PARI stack\n  exec(code_obj, self.user_global_ns, self.user_ns)\n```\n\nI think the core issue here is that the stack management code in cypari2/stack.pyx is\nfundamentally unsafe.\n\nHere is the situation, as I understand it.\n\n* Cypari2 allows a PARI GEN which is wrapped by a Gen object to reside either on the PARI stack\n  or on the heap, but the stack is preferred.\n\n* The PARI stack is also used by PARI, for example to store intermediate values produced when\n  evaluating PARI expressions.  This means that there will be non-wrapped GENS on the PARI stack.  \n  Typically one should expect a block of non-wrapped GENS between each pair of adjacent wrapped\n  GENS as well as some non-wrapped GENS that were pushed after the last wrapped GEN.\n\n* When a Gen object is deallocated, and if it was the last Gen to have had its GEN X pushed onto\n  the PARI stack, then reset_avma is called to set PARI's avma stack pointer to the address of\n  the penultimate wrapped GEN Y.  Any non-wrapped GEN pushed after Y will be lost.  This is\n  dangerous, because those lost GENS could be clobbered the next time that PARI pushes a GEN.\n  That, of course, is the reason for the warning.  Note, though, that the warning is only\n  triggered if there are non-wrapped GENS which were pushed after X.  Losing the GENs between\n  X and Y is just as dangerous but does not trigger a warning.\n\nI don't see any way to make this scheme safe.  I don't see any reliable way to control when PARI\nwill push GENS on its stack since, for example, Sage allows execution of arbitrary GP code.\nAnd I don't see any reliable way to control when Sage Gens will be deallocated.  Presumably the\nidea of storing wrapped GENS on the PARI stack was intended to be an optimization.  I think\nit would be better to forego this optimization in favor of safety.  However, if the optimization\ndoes provide significant performance increases then I would suggest that it be made optional.\nA Gen object could store its GEN on the heap by default, but allow as an option that the GEN be\nstored on the PARI stack.  That way people who were willing to risk crashes in order to increase\nspeed would be able to do so while the rest of us could safely store our GENs on the heap.",
    "created_at": "2019-07-28T14:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410884",
    "user": "https://github.com/culler"
}
```

<a id='comment:21'></a>Sadly, some parts of this issue have not been completely dealt with.  Here is a simple example
(with Sage 8.8 on Ubuntu 18.04):

```
sage: z = complex(pari('1+1*I'))
/XXX/sage-8.8/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2878:
RuntimeWarning: cypari2 leaked 48 bytes on the PARI stack
  exec(code_obj, self.user_global_ns, self.user_ns)
```

I think the core issue here is that the stack management code in cypari2/stack.pyx is
fundamentally unsafe.

Here is the situation, as I understand it.

* Cypari2 allows a PARI GEN which is wrapped by a Gen object to reside either on the PARI stack
  or on the heap, but the stack is preferred.

* The PARI stack is also used by PARI, for example to store intermediate values produced when
  evaluating PARI expressions.  This means that there will be non-wrapped GENS on the PARI stack.  
  Typically one should expect a block of non-wrapped GENS between each pair of adjacent wrapped
  GENS as well as some non-wrapped GENS that were pushed after the last wrapped GEN.

* When a Gen object is deallocated, and if it was the last Gen to have had its GEN X pushed onto
  the PARI stack, then reset_avma is called to set PARI's avma stack pointer to the address of
  the penultimate wrapped GEN Y.  Any non-wrapped GEN pushed after Y will be lost.  This is
  dangerous, because those lost GENS could be clobbered the next time that PARI pushes a GEN.
  That, of course, is the reason for the warning.  Note, though, that the warning is only
  triggered if there are non-wrapped GENS which were pushed after X.  Losing the GENs between
  X and Y is just as dangerous but does not trigger a warning.

I don't see any way to make this scheme safe.  I don't see any reliable way to control when PARI
will push GENS on its stack since, for example, Sage allows execution of arbitrary GP code.
And I don't see any reliable way to control when Sage Gens will be deallocated.  Presumably the
idea of storing wrapped GENS on the PARI stack was intended to be an optimization.  I think
it would be better to forego this optimization in favor of safety.  However, if the optimization
does provide significant performance increases then I would suggest that it be made optional.
A Gen object could store its GEN on the heap by default, but allow as an option that the GEN be
stored on the PARI stack.  That way people who were willing to risk crashes in order to increase
speed would be able to do so while the rest of us could safely store our GENs on the heap.



---

archive/issue_comments_410885.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 culler]:\n> Sadly, some parts of this issue have not been completely dealt with.  Here is a simple example\n> (with Sage 8.8 on Ubuntu 18.04):\n\n>\n> [...]\n\n\nThanks Marc for the report. I opened an [issue on github](https://github.com/sagemath/cypari2/issues/81) where cypari2 is developed.",
    "created_at": "2019-07-28T18:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27605",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27605#issuecomment-410885",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>Replying to [comment:21 culler]:
> Sadly, some parts of this issue have not been completely dealt with.  Here is a simple example
> (with Sage 8.8 on Ubuntu 18.04):

>
> [...]


Thanks Marc for the report. I opened an [issue on github](https://github.com/sagemath/cypari2/issues/81) where cypari2 is developed.
