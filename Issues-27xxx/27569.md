# Issue 27569: Unicode issue with modular polynomials database

archive/issues_027332.json:
```json
{
    "body": "\n```\nsage: MP = AtkinModularPolynomialDatabase()\nsage: MP[3]\n---------------------------------------------------------------------------\nUnicodeDecodeError                        Traceback (most recent call last)\n<ipython-input-29-920f2702531e> in <module>()\n----> 1 MP[Integer(3)]\n\n/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in __getitem__(self, level)\n    156                 raise TypeError(\"Argument level (= %s) must be prime.\"%N)\n    157         modpol = self._dbpath(level)\n--> 158         coeff_list = _dbz_to_integer_list(modpol)\n    159         if self.model == \"Cls\":\n    160             P = PolynomialRing(IntegerRing(),2,\"j\")\n\n/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_integer_list(name)\n     65     \"\"\"\n     66     from sage.rings.integer import Integer\n---> 67     data = _dbz_to_string(name)\n     68     return [[Integer(v) for v in row.strip().split(\" \")]\n     69             for row in data.split(\"\\n\")[:-1]]\n\n/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_string(name)\n     41         raise LookupError(\"filename {} does not exist\".format(filename))\n     42 \n---> 43     data = bz2.decompress(f.read())\n     44 \n     45     return data\n\n/home/kedlaya/sage/local/lib/python3.6/codecs.py in decode(self, input, final)\n    319         # decode input (taking the buffer into account)\n    320         data = self.buffer + input\n--> 321         (result, consumed) = self._buffer_decode(data, self.errors, final)\n    322         # keep undecoded input until the next call\n    323         self.buffer = data[consumed:]\n\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0x90 in position 13: invalid start byte\n```\n\nBranch/Commit: [8c80a1df70f58570fad92e7e96b091eea3be74d1](https://github.com/sagemath/sagetrac-mirror/commit/8c80a1df70f58570fad92e7e96b091eea3be74d1)\n\nReviewer: Kiran Kedlaya\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27569\n\n",
    "closed_at": "2019-04-05T20:51:39Z",
    "created_at": "2019-03-30T01:28:55Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Unicode issue with modular polynomials database",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27569",
    "user": "https://github.com/kedlaya"
}
```

```
sage: MP = AtkinModularPolynomialDatabase()
sage: MP[3]
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-29-920f2702531e> in <module>()
----> 1 MP[Integer(3)]

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in __getitem__(self, level)
    156                 raise TypeError("Argument level (= %s) must be prime."%N)
    157         modpol = self._dbpath(level)
--> 158         coeff_list = _dbz_to_integer_list(modpol)
    159         if self.model == "Cls":
    160             P = PolynomialRing(IntegerRing(),2,"j")

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_integer_list(name)
     65     """
     66     from sage.rings.integer import Integer
---> 67     data = _dbz_to_string(name)
     68     return [[Integer(v) for v in row.strip().split(" ")]
     69             for row in data.split("\n")[:-1]]

/home/kedlaya/sage/local/lib/python3.6/site-packages/sage/databases/db_modular_polynomials.py in _dbz_to_string(name)
     41         raise LookupError("filename {} does not exist".format(filename))
     42 
---> 43     data = bz2.decompress(f.read())
     44 
     45     return data

/home/kedlaya/sage/local/lib/python3.6/codecs.py in decode(self, input, final)
    319         # decode input (taking the buffer into account)
    320         data = self.buffer + input
--> 321         (result, consumed) = self._buffer_decode(data, self.errors, final)
    322         # keep undecoded input until the next call
    323         self.buffer = data[consumed:]

UnicodeDecodeError: 'utf-8' codec can't decode byte 0x90 in position 13: invalid start byte
```

Branch/Commit: [8c80a1df70f58570fad92e7e96b091eea3be74d1](https://github.com/sagemath/sagetrac-mirror/commit/8c80a1df70f58570fad92e7e96b091eea3be74d1)

Reviewer: Kiran Kedlaya

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27569





---

archive/issue_comments_533635.json:
```json
{
    "body": "<a id='comment:2'></a>\nGuessing this is a Py3 issue?",
    "created_at": "2019-03-30T01:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533635",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:2'></a>
Guessing this is a Py3 issue?



---

archive/issue_comments_533636.json:
```json
{
    "body": "<a id='comment:3'></a>\nhere is a tentative of fix, plus some pep8 cleanup in the modified file\n\n---\nNew commits:\n|                                                                                                                                          |                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[f935155](https://github.com/sagemath/sagetrac-mirror/commit/f93515572d45a92125d5969109f7ac03901c1215)|`trac 27569, python3 fix for modular database`|",
    "created_at": "2019-03-30T11:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533636",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>
here is a tentative of fix, plus some pep8 cleanup in the modified file

---
New commits:
|                                                                                                                                          |                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[f935155](https://github.com/sagemath/sagetrac-mirror/commit/f93515572d45a92125d5969109f7ac03901c1215)|`trac 27569, python3 fix for modular database`|



---

archive/issue_comments_533637.json:
```json
{
    "body": "Changing author from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2019-03-30T11:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533637",
    "user": "https://github.com/fchapoton"
}
```

Changing author from "" to "Frédéric Chapoton"



---

archive/issue_comments_533638.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-30T11:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533638",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_533639.json:
```json
{
    "body": "Changing branch from \"\" to \"u/chapoton/27569\"",
    "created_at": "2019-03-30T11:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533639",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "u/chapoton/27569"



---

archive/issue_comments_533640.json:
```json
{
    "body": "Changing commit from \"\" to \"f93515572d45a92125d5969109f7ac03901c1215\"",
    "created_at": "2019-03-30T11:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533640",
    "user": "https://github.com/fchapoton"
}
```

Changing commit from "" to "f93515572d45a92125d5969109f7ac03901c1215"



---

archive/issue_comments_533641.json:
```json
{
    "body": "Changing commit from \"f93515572d45a92125d5969109f7ac03901c1215\" to \"6b745dc65188a2be89e6fbfe9ee614afa3ced7a2\"",
    "created_at": "2019-03-30T12:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533641",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f93515572d45a92125d5969109f7ac03901c1215" to "6b745dc65188a2be89e6fbfe9ee614afa3ced7a2"



---

archive/issue_comments_533642.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[6b745dc](https://github.com/sagemath/sagetrac-mirror/commit/6b745dc65188a2be89e6fbfe9ee614afa3ced7a2)|`trac 27569 fixing the doctests`|",
    "created_at": "2019-03-30T12:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[6b745dc](https://github.com/sagemath/sagetrac-mirror/commit/6b745dc65188a2be89e6fbfe9ee614afa3ced7a2)|`trac 27569 fixing the doctests`|



---

archive/issue_comments_533643.json:
```json
{
    "body": "Changing commit from \"6b745dc65188a2be89e6fbfe9ee614afa3ced7a2\" to \"8c80a1df70f58570fad92e7e96b091eea3be74d1\"",
    "created_at": "2019-03-30T15:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533643",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6b745dc65188a2be89e6fbfe9ee614afa3ced7a2" to "8c80a1df70f58570fad92e7e96b091eea3be74d1"



---

archive/issue_comments_533644.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|\n|[8c80a1d](https://github.com/sagemath/sagetrac-mirror/commit/8c80a1df70f58570fad92e7e96b091eea3be74d1)|`trac 27569 fixing another doctest`|",
    "created_at": "2019-03-30T15:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533644",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|
|[8c80a1d](https://github.com/sagemath/sagetrac-mirror/commit/8c80a1df70f58570fad92e7e96b091eea3be74d1)|`trac 27569 fixing another doctest`|



---

archive/issue_comments_533645.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis does fix the issue on my end. But what is going on with the patchbot failures?",
    "created_at": "2019-03-31T14:13:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533645",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:6'></a>
This does fix the issue on my end. But what is going on with the patchbot failures?



---

archive/issue_comments_533646.json:
```json
{
    "body": "<a id='comment:7'></a>\npatchbot looks green enough to me",
    "created_at": "2019-04-04T13:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533646",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
patchbot looks green enough to me



---

archive/issue_comments_533647.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-04T13:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533647",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_533648.json:
```json
{
    "body": "<a id='comment:8'></a>\nOK then!",
    "created_at": "2019-04-04T13:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533648",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:8'></a>
OK then!



---

archive/issue_comments_533649.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Kiran Kedlaya\"",
    "created_at": "2019-04-04T13:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533649",
    "user": "https://github.com/kedlaya"
}
```

Changing reviewer from "" to "Kiran Kedlaya"



---

archive/issue_comments_533650.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-05T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533650",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_077646.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-05T20:51:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27569#event-77646"
}
```



---

archive/issue_comments_533651.json:
```json
{
    "body": "Changing branch from \"u/chapoton/27569\" to \"8c80a1df70f58570fad92e7e96b091eea3be74d1\"",
    "created_at": "2019-04-05T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27569",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27569#issuecomment-533651",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/chapoton/27569" to "8c80a1df70f58570fad92e7e96b091eea3be74d1"
