# Issue 27941: R installation fails on macOS with libcurl from Anaconda

archive/issues_027704.json:
```json
{
    "assignees": [],
    "body": "As reported in https://groups.google.com/d/msg/sage-devel/MMjoi2iDqo8/s55Uj2hHAwAJ\n(and earlier, in 2017, in https://groups.google.com/d/msg/sage-devel/aOK-ZtyH_Z8/Br4IycQnAgAJ).\n\nReproduced on macOS 10.14, Anaconda 3:\nconfig.log from R build:\n\n```\nconfigure:42569: checking for curl-config\nconfigure:42587: found /anaconda3/bin/curl-config\nconfigure:42599: result: /anaconda3/bin/curl-config\nconfigure:42625: checking curl/curl.h usability\nconfigure:42625: clang -c  -g -O2  -fPIC -I/anaconda3/include -I/usr/local/Cellar/pcre2/10.32/include   conftest.c >&5\nconfigure:42625: $? = 0\nconfigure:42625: result: yes\nconfigure:42625: checking curl/curl.h presence\nconfigure:42625: clang -E -I/anaconda3/include -I/usr/local/Cellar/pcre2/10.32/include   conftest.c\nconfigure:42625: $? = 0\nconfigure:42625: result: yes\nconfigure:42625: checking for curl/curl.h\nconfigure:42625: result: yes\nconfigure:42639: checking if libcurl is version 7 and >= 7.22.0\nconfigure:42668: clang -o conftest  -g -O2  -fPIC -I/anaconda3/include -I/usr/local/Cellar/pcre2/10.32/include   -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-anaconda/local\n/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-anaconda/local/lib  conftest.c -L/anaconda3/lib -lcurl -lssh2 -lssh2 -lssl -lcrypto -lssl -lcrypto -lgssapi_krb5 \n-lresolv -lz -L/usr/local/Cellar/pcre2/10.32/lib -lpcre2-8 -lpcre -llzma -lbz2 -lz -licucore -ldl -lm  -liconv >&5\nconfigure:42668: $? = 0\nconfigure:42668: ./conftest\ndyld: Library not loaded: @rpath/libcurl.4.dylib\n  Referenced from: /Users/mkoeppe/s/sage/sage-rebasing/worktree-anaconda/local/var/tmp/sage/build/r-3.6.0/src/./conftest\n  Reason: image not found\n./configure: line 2254: 38949 Abort trap: 6           ./conftest$ac_exeext\nconfigure:42668: $? = 134\nconfigure: program exited with status 134\n```\n\n**CC:**  @dimpase @embray @slel @jhpalmieri @vbraun @isuruf\n\n**Keywords:** conda\n\n**Branch:** [1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)\n\n**Reviewer:** John Palmieri\n\n**Author:** Matthias Koeppe\n\nIssue created by migration from https://trac.sagemath.org/ticket/27941\n\n",
    "closed_at": "2019-06-27T20:13:13Z",
    "created_at": "2019-06-06T20:48:13Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "R installation fails on macOS with libcurl from Anaconda",
    "type": "issue",
    "updated_at": "2020-01-13T18:15:00Z",
    "url": "https://github.com/sagemath/sage/issues/27941",
    "user": "https://github.com/mkoeppe"
}
```
As reported in https://groups.google.com/d/msg/sage-devel/MMjoi2iDqo8/s55Uj2hHAwAJ
(and earlier, in 2017, in https://groups.google.com/d/msg/sage-devel/aOK-ZtyH_Z8/Br4IycQnAgAJ).

Reproduced on macOS 10.14, Anaconda 3:
config.log from R build:

```
configure:42569: checking for curl-config
configure:42587: found /anaconda3/bin/curl-config
configure:42599: result: /anaconda3/bin/curl-config
configure:42625: checking curl/curl.h usability
configure:42625: clang -c  -g -O2  -fPIC -I/anaconda3/include -I/usr/local/Cellar/pcre2/10.32/include   conftest.c >&5
configure:42625: $? = 0
configure:42625: result: yes
configure:42625: checking curl/curl.h presence
configure:42625: clang -E -I/anaconda3/include -I/usr/local/Cellar/pcre2/10.32/include   conftest.c
configure:42625: $? = 0
configure:42625: result: yes
configure:42625: checking for curl/curl.h
configure:42625: result: yes
configure:42639: checking if libcurl is version 7 and >= 7.22.0
configure:42668: clang -o conftest  -g -O2  -fPIC -I/anaconda3/include -I/usr/local/Cellar/pcre2/10.32/include   -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-anaconda/local
/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-anaconda/local/lib  conftest.c -L/anaconda3/lib -lcurl -lssh2 -lssh2 -lssl -lcrypto -lssl -lcrypto -lgssapi_krb5 
-lresolv -lz -L/usr/local/Cellar/pcre2/10.32/lib -lpcre2-8 -lpcre -llzma -lbz2 -lz -licucore -ldl -lm  -liconv >&5
configure:42668: $? = 0
configure:42668: ./conftest
dyld: Library not loaded: @rpath/libcurl.4.dylib
  Referenced from: /Users/mkoeppe/s/sage/sage-rebasing/worktree-anaconda/local/var/tmp/sage/build/r-3.6.0/src/./conftest
  Reason: image not found
./configure: line 2254: 38949 Abort trap: 6           ./conftest$ac_exeext
configure:42668: $? = 134
configure: program exited with status 134
```

**CC:**  @dimpase @embray @slel @jhpalmieri @vbraun @isuruf

**Keywords:** conda

**Branch:** [1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)

**Reviewer:** John Palmieri

**Author:** Matthias Koeppe

Issue created by migration from https://trac.sagemath.org/ticket/27941





---

archive/issue_events_335132.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2019-06-06T20:48:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335132"
}
```



---

archive/issue_events_335133.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2019-06-06T20:48:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20standard",
    "label_color": "08517b",
    "label_name": "component: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335133"
}
```



---

archive/issue_events_335134.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2019-06-06T20:48:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335134"
}
```



---

archive/issue_comments_437007.json:
```json
{
    "body": "<a id='comment:1'>**Comment 1:**</a>\nAll Anaconda libraries on macOS are run-path dependent:\n\n```\n$ otool -L /anaconda3/lib/libc*.*.dylib \n/anaconda3/lib/libcrypto.1.1.dylib:\n\t@rpath/libcrypto.1.1.dylib (compatibility version 1.1.0, current version 1.1.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1213.0.0)\n/anaconda3/lib/libcurl.4.dylib:\n\t@rpath/libcurl.4.dylib (compatibility version 10.0.0, current version 10.0.0)\n\t@rpath/libssh2.1.dylib (compatibility version 1.0.0, current version 1.0.1)\n\t@rpath/libssl.1.1.dylib (compatibility version 1.1.0, current version 1.1.0)\n\t@rpath/libcrypto.1.1.dylib (compatibility version 1.1.0, current version 1.1.0)\n\t@rpath/libgssapi_krb5.2.2.dylib (compatibility version 2.0.0, current version 2.2.0)\n\t@rpath/libz.1.dylib (compatibility version 1.0.0, current version 1.2.11)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1213.0.0)\n```",
    "created_at": "2019-06-06T20:59:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437007",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'>**Comment 1:**</a>
All Anaconda libraries on macOS are run-path dependent:

```
$ otool -L /anaconda3/lib/libc*.*.dylib 
/anaconda3/lib/libcrypto.1.1.dylib:
	@rpath/libcrypto.1.1.dylib (compatibility version 1.1.0, current version 1.1.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1213.0.0)
/anaconda3/lib/libcurl.4.dylib:
	@rpath/libcurl.4.dylib (compatibility version 10.0.0, current version 10.0.0)
	@rpath/libssh2.1.dylib (compatibility version 1.0.0, current version 1.0.1)
	@rpath/libssl.1.1.dylib (compatibility version 1.1.0, current version 1.1.0)
	@rpath/libcrypto.1.1.dylib (compatibility version 1.1.0, current version 1.1.0)
	@rpath/libgssapi_krb5.2.2.dylib (compatibility version 2.0.0, current version 2.2.0)
	@rpath/libz.1.dylib (compatibility version 1.0.0, current version 1.2.11)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1213.0.0)
```



---

archive/issue_comments_437008.json:
```json
{
    "body": "<a id='comment:2'>**Comment 2:**</a>\nPerhaps `build/pkgs/curl/spkg-configure.m4` (introduced in #24081) should check whether libcurl is actually usable?",
    "created_at": "2019-06-06T21:16:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437008",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'>**Comment 2:**</a>
Perhaps `build/pkgs/curl/spkg-configure.m4` (introduced in #24081) should check whether libcurl is actually usable?



---

archive/issue_comments_437009.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\nPerhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.",
    "created_at": "2019-06-07T18:24:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437009",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'>**Comment 3:**</a>
Perhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.



---

archive/issue_comments_437010.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\nWhy do we see `-I/usr/local/Cellar/pcre2/10.32/include` ? Is it an attempt to mix Anaconda with Homebrew? That's sure to induce a severe hangover IMHO :-)",
    "created_at": "2019-06-07T18:32:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437010",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'>**Comment 4:**</a>
Why do we see `-I/usr/local/Cellar/pcre2/10.32/include` ? Is it an attempt to mix Anaconda with Homebrew? That's sure to induce a severe hangover IMHO :-)



---

archive/issue_comments_437011.json:
```json
{
    "body": "<a id='comment:5'>**Comment 5:**</a>\nI seem to recall mentioning on the mailing list (and a million other rants about OSX ;) that a frequent source of problems is mixing anaconda with homebrew with god knows what else.\n\nNot even sure if that's *really* the problem here but it would be good to try to isolate these different packaging systems from each other to be sure.",
    "created_at": "2019-06-07T18:36:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437011",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'>**Comment 5:**</a>
I seem to recall mentioning on the mailing list (and a million other rants about OSX ;) that a frequent source of problems is mixing anaconda with homebrew with god knows what else.

Not even sure if that's *really* the problem here but it would be good to try to isolate these different packaging systems from each other to be sure.



---

archive/issue_comments_437012.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\nReplying to [@dimpase](#comment%3A4):\n> Why do we see `-I/usr/local/Cellar/pcre2/10.32/include` ? Is it an attempt to mix Anaconda with Homebrew? That's sure to induce a severe hangover IMHO :-)\n\nLike every mac, it has bits and pieces from every pseudodistribution.",
    "created_at": "2019-06-07T18:41:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437012",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'>**Comment 6:**</a>
Replying to [@dimpase](#comment%3A4):
> Why do we see `-I/usr/local/Cellar/pcre2/10.32/include` ? Is it an attempt to mix Anaconda with Homebrew? That's sure to induce a severe hangover IMHO :-)

Like every mac, it has bits and pieces from every pseudodistribution.



---

archive/issue_comments_437013.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\nI have pointed out a specific technical problem with rpath. The other mess is unrelated.",
    "created_at": "2019-06-07T18:43:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437013",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'>**Comment 7:**</a>
I have pointed out a specific technical problem with rpath. The other mess is unrelated.



---

archive/issue_comments_437014.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nReplying to [@mkoeppe](#comment%3A7):\n> I have pointed out a specific technical problem with rpath. \n\nWhich is, by the way, a frequent problem known to the net.\nSee for example: http://cmake.3232098.n2.nabble.com/Issues-trying-to-use-the-Anaconda-compiler-tools-with-CMake-td7598056.html",
    "created_at": "2019-06-07T18:44:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437014",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'>**Comment 8:**</a>
Replying to [@mkoeppe](#comment%3A7):
> I have pointed out a specific technical problem with rpath. 

Which is, by the way, a frequent problem known to the net.
See for example: http://cmake.3232098.n2.nabble.com/Issues-trying-to-use-the-Anaconda-compiler-tools-with-CMake-td7598056.html



---

archive/issue_comments_437015.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nIsn't Anaconda coming with its own compiler, so that's iffy that everything gets to working correctly together?\n\nBesides, I don't even know what that `@rpath` is meant to be.",
    "created_at": "2019-06-07T18:53:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437015",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'>**Comment 9:**</a>
Isn't Anaconda coming with its own compiler, so that's iffy that everything gets to working correctly together?

Besides, I don't even know what that `@rpath` is meant to be.



---

archive/issue_comments_437016.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nReplying to [@dimpase](#comment%3A9):\n> Isn't Anaconda coming with its own compiler, so that's iffy that everything gets to working correctly together?\n\nThe one that I installed didn't come with its own compiler; but the \"conda build\" magic is said to take care of the rpath stuff. Haven't tried.\n \n> Besides, I don't even know what that `@rpath` is meant to be. \n\nhttps://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/RunpathDependentLibraries.html",
    "created_at": "2019-06-07T18:59:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437016",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'>**Comment 10:**</a>
Replying to [@dimpase](#comment%3A9):
> Isn't Anaconda coming with its own compiler, so that's iffy that everything gets to working correctly together?

The one that I installed didn't come with its own compiler; but the "conda build" magic is said to take care of the rpath stuff. Haven't tried.
 
> Besides, I don't even know what that `@rpath` is meant to be. 

https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/RunpathDependentLibraries.html



---

archive/issue_comments_437017.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nReplying to [@embray](#comment%3A3):\n> Perhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.\n\nYes, let's do that.",
    "created_at": "2019-06-07T18:59:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437017",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'>**Comment 11:**</a>
Replying to [@embray](#comment%3A3):
> Perhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.

Yes, let's do that.



---

archive/issue_comments_437018.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\nReplying to [@embray](#comment%3A3):\n> Perhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.\n\nThe hope ([#24081 comment:33](https://github.com/sagemath/sage/issues/24081#comment:33)) was that `curl-config` would be good enough, but it now makes sense to see if `AC_CHECK_LIB` helps.",
    "created_at": "2019-06-07T20:36:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437018",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'>**Comment 12:**</a>
Replying to [@embray](#comment%3A3):
> Perhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.

The hope ([#24081 comment:33](https://github.com/sagemath/sage/issues/24081#comment:33)) was that `curl-config` would be good enough, but it now makes sense to see if `AC_CHECK_LIB` helps.



---

archive/issue_comments_437019.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nthe problem with using `foo-config`, `pkg-config --modversion foo`, etc in `spkg-configure.m4` files is that this won't work out of the box as soon as the library `foo` is not installed in a place known to the compliler/linker.\n\nthe conservative way would be indeed to resort to `AC_CHECK_LIB` etc, whereas the way to unvendor more would be to actually use the info one can extract from `foo-config` etc to supply the needed extra flags to the build process.\n\nWith `PKG_CHECK_MODULES([FOO], [libfoo]...)` it is in fact easy, as it automatically populates the custom-named variables with compiler and linker flags, `FOO_CFLAGS` and `FOO_LIBS`.\nSo they can be written into sage-env-config and used by the dependencies of `foo`.\n \nPerhaps we could experiment with this approach with Homebrew-provided libraries that get installed into `Cellar`. \n\nAnyhow, for curl one ought to use their ready autoconf macro, rather than reinvent the\nwheel: [LIBCURL_CHECK_CONFIG](https://github.com/curl/curl/blob/master/docs/libcurl/libcurl.m4)",
    "created_at": "2019-06-07T21:28:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437019",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'>**Comment 13:**</a>
the problem with using `foo-config`, `pkg-config --modversion foo`, etc in `spkg-configure.m4` files is that this won't work out of the box as soon as the library `foo` is not installed in a place known to the compliler/linker.

the conservative way would be indeed to resort to `AC_CHECK_LIB` etc, whereas the way to unvendor more would be to actually use the info one can extract from `foo-config` etc to supply the needed extra flags to the build process.

With `PKG_CHECK_MODULES([FOO], [libfoo]...)` it is in fact easy, as it automatically populates the custom-named variables with compiler and linker flags, `FOO_CFLAGS` and `FOO_LIBS`.
So they can be written into sage-env-config and used by the dependencies of `foo`.
 
Perhaps we could experiment with this approach with Homebrew-provided libraries that get installed into `Cellar`. 

Anyhow, for curl one ought to use their ready autoconf macro, rather than reinvent the
wheel: [LIBCURL_CHECK_CONFIG](https://github.com/curl/curl/blob/master/docs/libcurl/libcurl.m4)



---

archive/issue_comments_437020.json:
```json
{
    "body": "<a id='comment:14'>**Comment 14:**</a>\nReplying to [@dimpase](#comment%3A13):\n> With `PKG_CHECK_MODULES([FOO], [libfoo]...)` it is in fact easy, as it automatically populates the custom-named variables with compiler and linker flags, `FOO_CFLAGS` and `FOO_LIBS`.\n\nAnaconda does provide pkg-config files, but unfortunately they do not include the rpath information either. Example, `/anaconda3/lib/pkgconfig/libcurl.pc`:\n\n```\nprefix=/anaconda3\nexec_prefix=${prefix}\nlibdir=${exec_prefix}/lib\nincludedir=${prefix}/include\nsupported_protocols=\"DICT FILE FTP FTPS GOPHER HTTP HTTPS IMAP IMAPS POP3 POP3S RTSP SCP SFTP SMB SMBS SMTP SMTPS TELNET TFTP\"\nsupported_features=\"SSL IPv6 UnixSockets libz AsynchDNS GSS-API SPNEGO Kerberos NTLM NTLM_WB TLS-SRP HTTPS-proxy\"\n\nName: libcurl\nURL: https://curl.haxx.se/\nDescription: Library to transfer files with ftp, http, etc.\nVersion: 7.64.0\nLibs: -L${libdir} -lcurl\nLibs.private: -lssh2 -lssh2 -lssl -lcrypto -lssl -lcrypto -lgssapi_krb5 -lresolv -lz\nCflags: -I${includedir} \n```",
    "created_at": "2019-06-08T02:17:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437020",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'>**Comment 14:**</a>
Replying to [@dimpase](#comment%3A13):
> With `PKG_CHECK_MODULES([FOO], [libfoo]...)` it is in fact easy, as it automatically populates the custom-named variables with compiler and linker flags, `FOO_CFLAGS` and `FOO_LIBS`.

Anaconda does provide pkg-config files, but unfortunately they do not include the rpath information either. Example, `/anaconda3/lib/pkgconfig/libcurl.pc`:

```
prefix=/anaconda3
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include
supported_protocols="DICT FILE FTP FTPS GOPHER HTTP HTTPS IMAP IMAPS POP3 POP3S RTSP SCP SFTP SMB SMBS SMTP SMTPS TELNET TFTP"
supported_features="SSL IPv6 UnixSockets libz AsynchDNS GSS-API SPNEGO Kerberos NTLM NTLM_WB TLS-SRP HTTPS-proxy"

Name: libcurl
URL: https://curl.haxx.se/
Description: Library to transfer files with ftp, http, etc.
Version: 7.64.0
Libs: -L${libdir} -lcurl
Libs.private: -lssh2 -lssh2 -lssl -lcrypto -lssl -lcrypto -lgssapi_krb5 -lresolv -lz
Cflags: -I${includedir} 
```



---

archive/issue_comments_437021.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\nReplying to [@jhpalmieri](#comment%3A12):\n> Replying to [@embray](#comment%3A3):\n> > Perhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.\n\n> \n> The hope ([#24081 comment:33](https://github.com/sagemath/sage/issues/24081#comment:33)) was that `curl-config` would be good enough, but it now makes sense to see if `AC_CHECK_LIB` helps.\n\nUnfortunately the problem with rpaths can only be detected by linking and *runnning* a test program. AC_CHECK_LIB only links it, which will still succeed. Same with Dima's suggestion to use the macro from libcurl.m4 - it detects a \"usable\" libcurl, but if you link a program against it, it will still fail at runtime.",
    "created_at": "2019-06-08T02:43:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437021",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'>**Comment 15:**</a>
Replying to [@jhpalmieri](#comment%3A12):
> Replying to [@embray](#comment%3A3):
> > Perhaps so--it assumes that if `curl-config` works then so should the library.  But maybe not?  It should probably do an `AC_CHECK_LIB` too just to be safe.

> 
> The hope ([#24081 comment:33](https://github.com/sagemath/sage/issues/24081#comment:33)) was that `curl-config` would be good enough, but it now makes sense to see if `AC_CHECK_LIB` helps.

Unfortunately the problem with rpaths can only be detected by linking and *runnning* a test program. AC_CHECK_LIB only links it, which will still succeed. Same with Dima's suggestion to use the macro from libcurl.m4 - it detects a "usable" libcurl, but if you link a program against it, it will still fail at runtime.



---

archive/issue_comments_437022.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda)",
    "created_at": "2019-06-08T02:46:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437022",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda)



---

archive/issue_comments_437023.json:
```json
{
    "body": "**Commit:** [1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)",
    "created_at": "2019-06-08T03:12:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437023",
    "user": "https://github.com/sagetrac-git"
}
```

**Commit:** [1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)



---

archive/issue_comments_437024.json:
```json
{
    "body": "<a id='comment:17'>**Comment 17:**</a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58\">1af7d3c</a></td><td><code>Check whether libcurl links to executables</code></td></tr></table>\n",
    "created_at": "2019-06-08T03:12:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437024",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>**Comment 17:**</a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58">1af7d3c</a></td><td><code>Check whether libcurl links to executables</code></td></tr></table>




---

archive/issue_comments_437025.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2019-06-08T04:06:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437025",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_437026.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nWith this patch it detects that libcurl from Anaconda actually doesn't work and then proceeds to build correctly. Runs and passes all tests.",
    "created_at": "2019-06-08T04:06:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437026",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'>**Comment 18:**</a>
With this patch it detects that libcurl from Anaconda actually doesn't work and then proceeds to build correctly. Runs and passes all tests.



---

archive/issue_events_335135.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2019-06-08T04:06:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335135"
}
```



---

archive/issue_comments_437027.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nI'd like to understand how Anaconda actually is meant to be used. How on Earth an application using its libraries is meant to discover the info about `@rpath` ? Is one meant to use their special building tools?\n\nIn this sense Homebrew looks a much saner solution.",
    "created_at": "2019-06-08T06:40:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437027",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'>**Comment 19:**</a>
I'd like to understand how Anaconda actually is meant to be used. How on Earth an application using its libraries is meant to discover the info about `@rpath` ? Is one meant to use their special building tools?

In this sense Homebrew looks a much saner solution.



---

archive/issue_comments_437028.json:
```json
{
    "body": "<a id='comment:20'>**Comment 20:**</a>\nReplying to [@dimpase](#comment%3A19):\n> I'd like to understand how Anaconda actually is meant to be used. How on Earth an application using its libraries is meant to discover the info about `@rpath` ? Is one meant to use their special building tools?\n\nThe default installation only puts `$CONDA_PREFIX/bin` into PATH and makes no further changes to build variables such as CFLAGS. I think it's only an oversight that binaries such as `curl-config` become available that leak information about build-time directories.\nBuilding software seems to be intended to be done with their package-oriented build tools.",
    "created_at": "2019-06-08T06:51:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437028",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'>**Comment 20:**</a>
Replying to [@dimpase](#comment%3A19):
> I'd like to understand how Anaconda actually is meant to be used. How on Earth an application using its libraries is meant to discover the info about `@rpath` ? Is one meant to use their special building tools?

The default installation only puts `$CONDA_PREFIX/bin` into PATH and makes no further changes to build variables such as CFLAGS. I think it's only an oversight that binaries such as `curl-config` become available that leak information about build-time directories.
Building software seems to be intended to be done with their package-oriented build tools.



---

archive/issue_comments_437029.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nPerhaps Volker knows better - I recall a discussion where he proposed that Sage should be possible to build using (ana)conda. Now it looks harder than with more traditional OSX package systems such as Homebrew...",
    "created_at": "2019-06-08T07:49:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437029",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'>**Comment 21:**</a>
Perhaps Volker knows better - I recall a discussion where he proposed that Sage should be possible to build using (ana)conda. Now it looks harder than with more traditional OSX package systems such as Homebrew...



---

archive/issue_comments_437030.json:
```json
{
    "body": "<a id='comment:22'>**Comment 22:**</a>\n`@`rpath is an Apple magic rpath prefix to search a special list of paths, see e.g. https://wincent.com/wiki/%40executable_path%2C_%40load_path_and_%40rpath\n\nSince its an Apple proprietary thing I'm not sure if a lot of thought was give to it on the conda or curl side, its possibly just something that xcode coughs up.\n\nIt seems that specifying `-rpath /path/to/conda/lib` when linking to it would suffice, but then we'd need to know first whether we want to link to conda or not. As always, Apple is geared towards shipping binaries to users and not to compile stuff yourself.",
    "created_at": "2019-06-08T15:14:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437030",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'>**Comment 22:**</a>
`@`rpath is an Apple magic rpath prefix to search a special list of paths, see e.g. https://wincent.com/wiki/%40executable_path%2C_%40load_path_and_%40rpath

Since its an Apple proprietary thing I'm not sure if a lot of thought was give to it on the conda or curl side, its possibly just something that xcode coughs up.

It seems that specifying `-rpath /path/to/conda/lib` when linking to it would suffice, but then we'd need to know first whether we want to link to conda or not. As always, Apple is geared towards shipping binaries to users and not to compile stuff yourself.



---

archive/issue_comments_437031.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\nNeed review.",
    "created_at": "2019-06-19T19:24:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437031",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'>**Comment 23:**</a>
Need review.



---

archive/issue_comments_437032.json:
```json
{
    "body": "<a id='comment:25'>**Comment 25:**</a>\nThis seems to work, in the sense that if I have anaconda installed with their stupid modification to my `.profile`, changing my PATH, then Sage thinks that curl is broken and so builds its own. \n\nMaybe a better solution would be to use `curl-config --prefix` to actually locate the anaconda curl libraries and then use those if present. That's not happening with this branch, right? It would come closer to the goal of using whatever libraries are already installed. (Or alternatively, if anaconda is going to screw around with my PATH, they should also set some other environment variables telling programs where to find their headers and libraries.)",
    "created_at": "2019-06-21T02:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437032",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'>**Comment 25:**</a>
This seems to work, in the sense that if I have anaconda installed with their stupid modification to my `.profile`, changing my PATH, then Sage thinks that curl is broken and so builds its own. 

Maybe a better solution would be to use `curl-config --prefix` to actually locate the anaconda curl libraries and then use those if present. That's not happening with this branch, right? It would come closer to the goal of using whatever libraries are already installed. (Or alternatively, if anaconda is going to screw around with my PATH, they should also set some other environment variables telling programs where to find their headers and libraries.)



---

archive/issue_comments_437033.json:
```json
{
    "body": "<a id='comment:26'>**Comment 26:**</a>\nReplying to [@jhpalmieri](#comment%3A25):\n> Maybe a better solution would be to use `curl-config --prefix` to actually locate the anaconda curl libraries and then use those if present. That's not happening with this branch, right? It would come closer to the goal of using whatever libraries are already installed. (Or alternatively, if anaconda is going to screw around with my PATH, they should also set some other environment variables telling programs where to find their headers and libraries.)\n\nYes, that's out of the scope of this ticket; it would go to #27699. It would likely not be curl-specific but rather set LDFLAGS to include an rpath directive.",
    "created_at": "2019-06-21T03:00:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437033",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'>**Comment 26:**</a>
Replying to [@jhpalmieri](#comment%3A25):
> Maybe a better solution would be to use `curl-config --prefix` to actually locate the anaconda curl libraries and then use those if present. That's not happening with this branch, right? It would come closer to the goal of using whatever libraries are already installed. (Or alternatively, if anaconda is going to screw around with my PATH, they should also set some other environment variables telling programs where to find their headers and libraries.)

Yes, that's out of the scope of this ticket; it would go to #27699. It would likely not be curl-specific but rather set LDFLAGS to include an rpath directive.



---

archive/issue_events_335136.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2019-06-21T03:12:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335136"
}
```



---

archive/issue_events_335137.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2019-06-21T03:12:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335137"
}
```



---

archive/issue_comments_437034.json:
```json
{
    "body": "**Reviewer:** John Palmieri",
    "created_at": "2019-06-21T03:12:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437034",
    "user": "https://github.com/jhpalmieri"
}
```

**Reviewer:** John Palmieri



---

archive/issue_comments_437035.json:
```json
{
    "body": "<a id='comment:27'>**Comment 27:**</a>\nI'm willing to give this a positive review, but I'm not sure I see the point. At least with my setup, once I allow anaconda to modify the path, other things besides R break. For example, tachyon:\n\n```\ngcc -Os -ffast-math -DBsd  -DUSEPNG    -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2-anaconda3/local/include  -c ../src/pngfile.c -o ../compile/macosx/libtachyon/pngfile.o\n../src/pngfile.c:33:10: fatal error: 'png.h' file not found\n#include \"png.h\" /* the libpng library headers */\n         ^~~~~~~\n1 error generated.\nmake[6]: *** [../compile/macosx/libtachyon/pngfile.o] Error 1\n```\nSo this looks like one small fix to a much larger problem.",
    "created_at": "2019-06-21T03:12:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437035",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'>**Comment 27:**</a>
I'm willing to give this a positive review, but I'm not sure I see the point. At least with my setup, once I allow anaconda to modify the path, other things besides R break. For example, tachyon:

```
gcc -Os -ffast-math -DBsd  -DUSEPNG    -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2-anaconda3/local/include  -c ../src/pngfile.c -o ../compile/macosx/libtachyon/pngfile.o
../src/pngfile.c:33:10: fatal error: 'png.h' file not found
#include "png.h" /* the libpng library headers */
         ^~~~~~~
1 error generated.
make[6]: *** [../compile/macosx/libtachyon/pngfile.o] Error 1
```
So this looks like one small fix to a much larger problem.



---

archive/issue_comments_437036.json:
```json
{
    "body": "<a id='comment:28'>**Comment 28:**</a>\nmaybe different versions of conda have different behaviour here, but on an installation I have, once you run \"conda deactivate\", the only addition to PATH contains `conda` and nothing else.\n\n```\n(base)~$ conda deactivate\n$ echo $PATH\n/home/dimpase/miniconda2/condabin:/usr/local/bin:/usr/bin:...\n$ ls /home/dimpase/miniconda2/condabin/\nconda\n```\n\nWhile building Sage on \"active\" conda is not working, merely having a non-active installation should not break stuff. IMHO.\n\nwhereas\n\n```\n$ conda activate\n(base)~$ echo $PATH\n/home/dimpase/miniconda2/bin:/home/dimpase/miniconda2/condabin:/usr/local/bin:...\n(base)~$ which curl-config \n/home/dimpase/miniconda2/bin/curl-config\n```\nprepends more things to `PATH`.",
    "created_at": "2019-06-21T07:27:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437036",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'>**Comment 28:**</a>
maybe different versions of conda have different behaviour here, but on an installation I have, once you run "conda deactivate", the only addition to PATH contains `conda` and nothing else.

```
(base)~$ conda deactivate
$ echo $PATH
/home/dimpase/miniconda2/condabin:/usr/local/bin:/usr/bin:...
$ ls /home/dimpase/miniconda2/condabin/
conda
```

While building Sage on "active" conda is not working, merely having a non-active installation should not break stuff. IMHO.

whereas

```
$ conda activate
(base)~$ echo $PATH
/home/dimpase/miniconda2/bin:/home/dimpase/miniconda2/condabin:/usr/local/bin:...
(base)~$ which curl-config 
/home/dimpase/miniconda2/bin/curl-config
```
prepends more things to `PATH`.



---

archive/issue_comments_437037.json:
```json
{
    "body": "<a id='comment:29'>**Comment 29:**</a>\nReplying to [@jhpalmieri](#comment%3A27):\n> I'm willing to give this a positive review, but I'm not sure I see the point. At least with my setup, once I allow anaconda to modify the path, other things besides R break. For example, tachyon:\n> \n> ```\n> gcc -Os -ffast-math -DBsd  -DUSEPNG    -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2-anaconda3/local/include  -c ../src/pngfile.c -o ../compile/macosx/libtachyon/pngfile.o\n> ../src/pngfile.c:33:10: fatal error: 'png.h' file not found\n> #include \"png.h\" /* the libpng library headers */\n>          ^~~~~~~\n> 1 error generated.\n> make[6]: *** [../compile/macosx/libtachyon/pngfile.o] Error 1\n> ```\n> So this looks like one small fix to a much larger problem.\n\nInteresting. On my system, Tachyon compiled without problem.",
    "created_at": "2019-06-21T17:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437037",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'>**Comment 29:**</a>
Replying to [@jhpalmieri](#comment%3A27):
> I'm willing to give this a positive review, but I'm not sure I see the point. At least with my setup, once I allow anaconda to modify the path, other things besides R break. For example, tachyon:
> 
> ```
> gcc -Os -ffast-math -DBsd  -DUSEPNG    -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-8.8.rc2-anaconda3/local/include  -c ../src/pngfile.c -o ../compile/macosx/libtachyon/pngfile.o
> ../src/pngfile.c:33:10: fatal error: 'png.h' file not found
> #include "png.h" /* the libpng library headers */
>          ^~~~~~~
> 1 error generated.
> make[6]: *** [../compile/macosx/libtachyon/pngfile.o] Error 1
> ```
> So this looks like one small fix to a much larger problem.

Interesting. On my system, Tachyon compiled without problem.



---

archive/issue_comments_437038.json:
```json
{
    "body": "<a id='comment:30'>**Comment 30:**</a>\nReplying to [@dimpase](#comment%3A28):\n> maybe different versions of conda have different behaviour here, but on an installation I have, once you run \"conda deactivate\", the only addition to PATH contains `conda` and nothing else.\n\nThis ticket is about fixing things when conda is \"activated\". It is activated after a default installation of Anaconda 3. I haven't tried with miniconda.",
    "created_at": "2019-06-21T17:16:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437038",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'>**Comment 30:**</a>
Replying to [@dimpase](#comment%3A28):
> maybe different versions of conda have different behaviour here, but on an installation I have, once you run "conda deactivate", the only addition to PATH contains `conda` and nothing else.

This ticket is about fixing things when conda is "activated". It is activated after a default installation of Anaconda 3. I haven't tried with miniconda.



---

archive/issue_comments_437039.json:
```json
{
    "body": "<a id='comment:31'>**Comment 31:**</a>\nI have an old (I think) conda installation; it only added one directory to my PATH folder. Today when I ran `conda init bash`, it made more significant changes, and that may have other effects.\n\nWith the old version, I was seeing all sorts of strange things. I had built my own version of `gmp`, for example, but without C++ support. Sage built fine, and givaro in particular had no problems. When I allowed that one conda directory to be in the path, then the givaro build failed, saying that `gmp` did not have C++ support and should be built instead with `--enable-cxx`. The strange thing was that the version of `gmp` in conda had C++ support, and so did the version in SAGE_ROOT/local, but something about how conda was working led to the complaining that the file `gmpxx.h` was missing from `/usr/local/include`.\n\nAfter I did `conda init bash` today, which makes a more serious change in my environment, the Sage build failed during brial, saying that `gd` wasn't found. `gd` is not listed as a dependency for brial, and I've never seen this come up before. I did `make gd` and then `make`, and brial built fine after that. In general, conda is making my computer act very strangely.",
    "created_at": "2019-06-21T17:26:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437039",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:31'>**Comment 31:**</a>
I have an old (I think) conda installation; it only added one directory to my PATH folder. Today when I ran `conda init bash`, it made more significant changes, and that may have other effects.

With the old version, I was seeing all sorts of strange things. I had built my own version of `gmp`, for example, but without C++ support. Sage built fine, and givaro in particular had no problems. When I allowed that one conda directory to be in the path, then the givaro build failed, saying that `gmp` did not have C++ support and should be built instead with `--enable-cxx`. The strange thing was that the version of `gmp` in conda had C++ support, and so did the version in SAGE_ROOT/local, but something about how conda was working led to the complaining that the file `gmpxx.h` was missing from `/usr/local/include`.

After I did `conda init bash` today, which makes a more serious change in my environment, the Sage build failed during brial, saying that `gd` wasn't found. `gd` is not listed as a dependency for brial, and I've never seen this come up before. I did `make gd` and then `make`, and brial built fine after that. In general, conda is making my computer act very strangely.



---

archive/issue_comments_437040.json:
```json
{
    "body": "<a id='comment:32'>**Comment 32:**</a>\nwell, I don't think we need to support an old conda.",
    "created_at": "2019-06-21T17:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437040",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'>**Comment 32:**</a>
well, I don't think we need to support an old conda.



---

archive/issue_comments_437041.json:
```json
{
    "body": "<a id='comment:33'>**Comment 33:**</a>\nWe don't need to support an old conda, but it would be nice for all of Sage's configure stuff to work well in a conda environment as well.  It's not *necessary* for building Sage in Conda, but it will help.  In the last week working with Isuru we've found a number of issues with Sage's new and improved/improving configure script as it relates to Conda.  It's a useful test case as it does expose minor bugs in building in contexts where the usual assumptions (like `prefix=/usr` or `prefix=/usr/local`) do not apply.",
    "created_at": "2019-06-21T18:00:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437041",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'>**Comment 33:**</a>
We don't need to support an old conda, but it would be nice for all of Sage's configure stuff to work well in a conda environment as well.  It's not *necessary* for building Sage in Conda, but it will help.  In the last week working with Isuru we've found a number of issues with Sage's new and improved/improving configure script as it relates to Conda.  It's a useful test case as it does expose minor bugs in building in contexts where the usual assumptions (like `prefix=/usr` or `prefix=/usr/local`) do not apply.



---

archive/issue_comments_437042.json:
```json
{
    "body": "<a id='comment:34'>**Comment 34:**</a>\nReplying to [@jhpalmieri](#comment%3A31):\n> After I did `conda init bash` today, which makes a more serious change in my environment, the Sage build failed during brial, saying that `gd` wasn't found. `gd` is not listed as a dependency for brial, and I've never seen this come up before. I did `make gd` and then `make`, and brial built fine after that. \n\nBRiaL only seems to look for gd if it can't use m4ri with libpng - see https://github.com/BRiAl/BRiAl/blob/master/configure.ac#L81\nSo this also comes from the same libpng breakage that you mentioned above.",
    "created_at": "2019-06-21T18:07:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437042",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'>**Comment 34:**</a>
Replying to [@jhpalmieri](#comment%3A31):
> After I did `conda init bash` today, which makes a more serious change in my environment, the Sage build failed during brial, saying that `gd` wasn't found. `gd` is not listed as a dependency for brial, and I've never seen this come up before. I did `make gd` and then `make`, and brial built fine after that. 

BRiaL only seems to look for gd if it can't use m4ri with libpng - see https://github.com/BRiAl/BRiAl/blob/master/configure.ac#L81
So this also comes from the same libpng breakage that you mentioned above.



---

archive/issue_comments_437043.json:
```json
{
    "body": "<a id='comment:35'>**Comment 35:**</a>\nWow.  That's so random...",
    "created_at": "2019-06-21T18:08:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437043",
    "user": "https://github.com/embray"
}
```

<a id='comment:35'>**Comment 35:**</a>
Wow.  That's so random...



---

archive/issue_comments_437044.json:
```json
{
    "body": "<a id='comment:36'>**Comment 36:**</a>\n`conda init ...` is an experimental feature. I don't really know what it does. Cf.\n`conda -h`. \n\nAnyhow, in the acticated conda environment the right thing would be to make it possible to use any conda-installed library/executable, and this ticket seems to be just a small step in this direction. (E.g. I doubt that GMP from conda will work).\n\nDoes anaconda have `conda deactivate` command?",
    "created_at": "2019-06-22T11:12:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437044",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'>**Comment 36:**</a>
`conda init ...` is an experimental feature. I don't really know what it does. Cf.
`conda -h`. 

Anyhow, in the acticated conda environment the right thing would be to make it possible to use any conda-installed library/executable, and this ticket seems to be just a small step in this direction. (E.g. I doubt that GMP from conda will work).

Does anaconda have `conda deactivate` command?



---

archive/issue_comments_437045.json:
```json
{
    "body": "<a id='comment:37'>**Comment 37:**</a>\nAt this point I have updated my anaconda installation. `conda init bash` appends this to my `.bash_profile`:\n\n```\n# >>> conda initialize >>>\n# !! Contents within this block are managed by 'conda init' !!\n__conda_setup=\"$('/Users/palmieri/anaconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)\"\nif [ $? -eq 0 ]; then\n    eval \"$__conda_setup\"\nelse\n    if [ -f \"/Users/palmieri/anaconda3/etc/profile.d/conda.sh\" ]; then\n        . \"/Users/palmieri/anaconda3/etc/profile.d/conda.sh\"\n    else\n        export PATH=\"/Users/palmieri/anaconda3/bin:$PATH\"\n    fi\nfi\nunset __conda_setup\n# <<< conda initialize <<<\n```\nThen `conda activate`/`conda deactivate` just modify PATH.",
    "created_at": "2019-06-22T15:33:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437045",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:37'>**Comment 37:**</a>
At this point I have updated my anaconda installation. `conda init bash` appends this to my `.bash_profile`:

```
# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/Users/palmieri/anaconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/Users/palmieri/anaconda3/etc/profile.d/conda.sh" ]; then
        . "/Users/palmieri/anaconda3/etc/profile.d/conda.sh"
    else
        export PATH="/Users/palmieri/anaconda3/bin:$PATH"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<
```
Then `conda activate`/`conda deactivate` just modify PATH.



---

archive/issue_comments_437046.json:
```json
{
    "body": "<a id='comment:38'>**Comment 38:**</a>\nI still don't understand why one would  need to run `conda init ...`.\n\nThanks for confirming that  `conda deactivate` also works for anaconda. We ought to menion `conda deactivate` in the installation manual.",
    "created_at": "2019-06-22T17:40:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437046",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'>**Comment 38:**</a>
I still don't understand why one would  need to run `conda init ...`.

Thanks for confirming that  `conda deactivate` also works for anaconda. We ought to menion `conda deactivate` in the installation manual.



---

archive/issue_comments_437047.json:
```json
{
    "body": "<a id='comment:39'>**Comment 39:**</a>\nReplying to [@dimpase](#comment%3A38):\n> I still don't understand why one would  need to run `conda init ...`.\n\nOn OS X at least, when you install anaconda, it asks whether you want it to modify your shell scripts. If you say no, then whenever you want, you can run `conda init ...` to do that modification.",
    "created_at": "2019-06-22T18:24:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437047",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:39'>**Comment 39:**</a>
Replying to [@dimpase](#comment%3A38):
> I still don't understand why one would  need to run `conda init ...`.

On OS X at least, when you install anaconda, it asks whether you want it to modify your shell scripts. If you say no, then whenever you want, you can run `conda init ...` to do that modification.



---

archive/issue_comments_437048.json:
```json
{
    "body": "<a id='comment:40'>**Comment 40:**</a>\nbut why would you need this? \n\ncan you use conda activate/deactivate instead?",
    "created_at": "2019-06-22T18:31:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437048",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:40'>**Comment 40:**</a>
but why would you need this? 

can you use conda activate/deactivate instead?



---

archive/issue_comments_437049.json:
```json
{
    "body": "<a id='comment:41'>**Comment 41:**</a>\nWith no modifications to my PATH:\n\n```\n$ ./anaconda3/condabin/conda activate\n\nCommandNotFoundError: Your shell has not been properly configured to use 'conda activate'.\nTo initialize your shell, run\n\n    $ conda init <SHELL_NAME>\n\n...\n```\nThe modifications to `.bash_profile` also set some other variables:\n\n```\nCONDA_EXE=\"/Users/palmieri/anaconda3/bin/conda\"\nCONDA_PYTHON_EXE=\"/Users/palmieri/anaconda3/bin/python\"\nCONDA_SHLVL=\"0\"\n```\nand it defines a `conda` command that is required to use with `conda activate`.",
    "created_at": "2019-06-22T19:43:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437049",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:41'>**Comment 41:**</a>
With no modifications to my PATH:

```
$ ./anaconda3/condabin/conda activate

CommandNotFoundError: Your shell has not been properly configured to use 'conda activate'.
To initialize your shell, run

    $ conda init <SHELL_NAME>

...
```
The modifications to `.bash_profile` also set some other variables:

```
CONDA_EXE="/Users/palmieri/anaconda3/bin/conda"
CONDA_PYTHON_EXE="/Users/palmieri/anaconda3/bin/python"
CONDA_SHLVL="0"
```
and it defines a `conda` command that is required to use with `conda activate`.



---

archive/issue_comments_437050.json:
```json
{
    "body": "<a id='comment:42'>**Comment 42:**</a>\nOK, so it looks as if Anaconda needs a modified set of instructions, thanks.\nHopefully the \u201cinner parts\u201d are the same as of (mini)conda...",
    "created_at": "2019-06-22T22:16:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437050",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'>**Comment 42:**</a>
OK, so it looks as if Anaconda needs a modified set of instructions, thanks.
Hopefully the “inner parts” are the same as of (mini)conda...



---

archive/issue_comments_437051.json:
```json
{
    "body": "<a id='comment:43'>**Comment 43:**</a>\n`conda init` is mentioned in step 7 [here](https://docs.anaconda.com/anaconda/install/mac-os/). I see a similar instruction on the Linux installation page.",
    "created_at": "2019-06-22T22:19:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437051",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'>**Comment 43:**</a>
`conda init` is mentioned in step 7 [here](https://docs.anaconda.com/anaconda/install/mac-os/). I see a similar instruction on the Linux installation page.



---

archive/issue_comments_437052.json:
```json
{
    "body": "<a id='comment:44'>**Comment 44:**</a>\nboth miniconda and anaconda use a package manager called Conda. Otherwise it seems they are not quite identical at the user interface level.",
    "created_at": "2019-06-22T23:32:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437052",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:44'>**Comment 44:**</a>
both miniconda and anaconda use a package manager called Conda. Otherwise it seems they are not quite identical at the user interface level.



---

archive/issue_events_335138.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-27T20:13:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335138"
}
```



---

archive/issue_events_335139.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "0e8fb5d32af5c11572415f86e2455a791e45c0f0",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-06-27T20:13:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335139"
}
```



---

archive/issue_comments_437053.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda)\" to \"[1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)\".",
    "created_at": "2019-06-27T20:13:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437053",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/r_installation_fails_on_macos_with_libcurl_from_anaconda)" to "[1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)".



---

archive/issue_events_335140.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:34:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "milestone_number": null,
    "milestone_title": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335140"
}
```



---

archive/issue_events_335141.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-07-03T11:34:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "milestone_number": null,
    "milestone_title": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27941#event-335141"
}
```



---

archive/issue_comments_437054.json:
```json
{
    "body": "<a id='comment:46'>**Comment 46:**</a>\nNot in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were *actually* included, especially when closing tickets.",
    "created_at": "2019-07-03T11:34:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437054",
    "user": "https://github.com/embray"
}
```

<a id='comment:46'>**Comment 46:**</a>
Not in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were *actually* included, especially when closing tickets.



---

archive/issue_comments_437055.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"conda\".",
    "created_at": "2020-01-13T18:15:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437055",
    "user": "https://github.com/mkoeppe"
}
```

**Changing keywords** from "" to "conda".



---

archive/issue_comments_437056.json:
```json
{
    "body": "**Changing commit** from \"[1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)\" to \"\".",
    "created_at": "2020-01-13T18:15:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/27941",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27941#issuecomment-437056",
    "user": "https://github.com/mkoeppe"
}
```

**Changing commit** from "[1af7d3cbc540e2e59959ba2ddf62c710a92b2d58](https://github.com/sagemath/sagetrac-mirror/commit/1af7d3cbc540e2e59959ba2ddf62c710a92b2d58)" to "".
