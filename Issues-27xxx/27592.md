# Issue 27592: Some cleanup of Graphics3d._rich_repr_threejs

archive/issues_027355.json:
```json
{
    "body": "Here's a bit of improvement, I think, to the `Graphics3d._rich_repr_threejs` method implementation.\n\nIn particular, it does away with most of the manual string formatting of JavaScript in favor of just using the `json` module to do this.  It also uses jinja2 for rendering the `threejs_template.html` template.  This may prove more flexible in the future.\n\nI did a bit of performance testing on this, and compared to the overhead of actually generating 3D models and the like, the performance difference between this approach and the old code is negligible--they are about the same.  However, I think this approach results in cleaner code.\n\nThis is just a preliminary to some more specific changes toward #22408 (making ThreeJS the default 3D graphics viewer).\n\n**Assignee:** @embray\n\n**CC:**  @jcamp0x2a\n\n**Keywords:** threejs\n\n**Branch:** [u/embray/plot3d/threejs-jinja2](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/plot3d/threejs-jinja2)\n\n**Commit:** [0a8402f54e5f711082a2d62021f4be4a0a755455](https://github.com/sagemath/sagetrac-mirror/commit/0a8402f54e5f711082a2d62021f4be4a0a755455)\n\n**Author:** Erik Bray\n\n**Status:** needs_work\n\n**Dependencies:** #27568\n\nIssue created by migration from https://trac.sagemath.org/ticket/27592\n\n",
    "created_at": "2019-04-02T11:44:51Z",
    "labels": [
        "component: graphics",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Some cleanup of Graphics3d._rich_repr_threejs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27592",
    "user": "https://github.com/embray"
}
```
Here's a bit of improvement, I think, to the `Graphics3d._rich_repr_threejs` method implementation.

In particular, it does away with most of the manual string formatting of JavaScript in favor of just using the `json` module to do this.  It also uses jinja2 for rendering the `threejs_template.html` template.  This may prove more flexible in the future.

I did a bit of performance testing on this, and compared to the overhead of actually generating 3D models and the like, the performance difference between this approach and the old code is negligible--they are about the same.  However, I think this approach results in cleaner code.

This is just a preliminary to some more specific changes toward #22408 (making ThreeJS the default 3D graphics viewer).

**Assignee:** @embray

**CC:**  @jcamp0x2a

**Keywords:** threejs

**Branch:** [u/embray/plot3d/threejs-jinja2](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/plot3d/threejs-jinja2)

**Commit:** [0a8402f54e5f711082a2d62021f4be4a0a755455](https://github.com/sagemath/sagetrac-mirror/commit/0a8402f54e5f711082a2d62021f4be4a0a755455)

**Author:** Erik Bray

**Status:** needs_work

**Dependencies:** #27568

Issue created by migration from https://trac.sagemath.org/ticket/27592





---

archive/issue_comments_509383.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2019-04-02T11:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509383",
    "user": "https://github.com/embray"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_509384.json:
```json
{
    "body": "**Description changed:**\n``````diff\n\n``````\n",
    "created_at": "2019-04-02T11:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509384",
    "user": "https://github.com/embray"
}
```

**Description changed:**
``````diff

``````




---

archive/issue_comments_509385.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2019-04-02T11:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509385",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_509386.json:
```json
{
    "body": "<a id='comment:3'></a>\nOops, need to rebase this on a different branch.",
    "created_at": "2019-04-02T11:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509386",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
Oops, need to rebase this on a different branch.



---

archive/issue_comments_509387.json:
```json
{
    "body": "**Changing commit** from \"[7f544c82ef4367db0c86eda068d6fdd77968ae42](https://github.com/sagemath/sagetrac-mirror/commit/7f544c82ef4367db0c86eda068d6fdd77968ae42)\" to \"[d80024e067955057c6c9c97a0deed50b54ab330c](https://github.com/sagemath/sagetrac-mirror/commit/d80024e067955057c6c9c97a0deed50b54ab330c)\".",
    "created_at": "2019-04-02T11:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509387",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7f544c82ef4367db0c86eda068d6fdd77968ae42](https://github.com/sagemath/sagetrac-mirror/commit/7f544c82ef4367db0c86eda068d6fdd77968ae42)" to "[d80024e067955057c6c9c97a0deed50b54ab330c](https://github.com/sagemath/sagetrac-mirror/commit/d80024e067955057c6c9c97a0deed50b54ab330c)".



---

archive/issue_comments_509388.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4f7015697b95c55d72d7521365ff37f36b7bb51f\">4f70156</a></td><td><code>Slight reorganizing of imports</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/adc844bdd620af64aee29cbd4555a7543bd39599\">adc844b</a></td><td><code>A bit more cleanup of Graphics3D._rich_repr_threejs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d80024e067955057c6c9c97a0deed50b54ab330c\">d80024e</a></td><td><code>Change the threejs_template.html to a Jinja template and use jinja2 to render it.</code></td></tr></table>\n",
    "created_at": "2019-04-02T11:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509388",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4f7015697b95c55d72d7521365ff37f36b7bb51f">4f70156</a></td><td><code>Slight reorganizing of imports</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/adc844bdd620af64aee29cbd4555a7543bd39599">adc844b</a></td><td><code>A bit more cleanup of Graphics3D._rich_repr_threejs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d80024e067955057c6c9c97a0deed50b54ab330c">d80024e</a></td><td><code>Change the threejs_template.html to a Jinja template and use jinja2 to render it.</code></td></tr></table>




---

archive/issue_comments_509389.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2019-04-02T11:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509389",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_509390.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi Erik, happy to see that you are working on threejs!\n\nHave you noticed the (very) recent improvements:\n- #27575: Three.js: Fix CDN Fallback\n- #27568: Three.js: Consolidate Surface Code\n- #27561: Fix Minor Three.js Template Error\n- #27560: Update Three.js Online CDN\n- #26718: Upgrade to three.js r100\nDoes the current ticket have some articulation with those?",
    "created_at": "2019-04-02T12:42:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509390",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:6'></a>
Hi Erik, happy to see that you are working on threejs!

Have you noticed the (very) recent improvements:
- #27575: Three.js: Fix CDN Fallback
- #27568: Three.js: Consolidate Surface Code
- #27561: Fix Minor Three.js Template Error
- #27560: Update Three.js Online CDN
- #26718: Upgrade to three.js r100
Does the current ticket have some articulation with those?



---

archive/issue_comments_509391.json:
```json
{
    "body": "<a id='comment:7'></a>\nThank you for pointing these out (I was aware of #27560 but not the others).  I think this will have some minor conflict with #27568, but nothing substantial.  I'll rebase this on top of it and make sure it can be incorporated.",
    "created_at": "2019-04-02T13:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509391",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Thank you for pointing these out (I was aware of #27560 but not the others).  I think this will have some minor conflict with #27568, but nothing substantial.  I'll rebase this on top of it and make sure it can be incorporated.



---

archive/issue_comments_509392.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2019-04-02T13:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509392",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_509393.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"threejs\".",
    "created_at": "2019-04-02T13:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509393",
    "user": "https://github.com/embray"
}
```

**Changing keywords** from "" to "threejs".



---

archive/issue_comments_509394.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b609839733854ca034085ded1c5f89e6cb108449\">b609839</a></td><td><code>Consolidate surface code</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/824001b8033477e81d0044173e4e290fe1718dbe\">824001b</a></td><td><code>Slight reorganizing of imports</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eeedcc16a2fc5a07810469baee28ef94ccd86b29\">eeedcc1</a></td><td><code>A bit more cleanup of Graphics3D._rich_repr_threejs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0a8402f54e5f711082a2d62021f4be4a0a755455\">0a8402f</a></td><td><code>Change the threejs_template.html to a Jinja template and use jinja2 to render it.</code></td></tr></table>\n",
    "created_at": "2019-04-03T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509394",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b609839733854ca034085ded1c5f89e6cb108449">b609839</a></td><td><code>Consolidate surface code</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/824001b8033477e81d0044173e4e290fe1718dbe">824001b</a></td><td><code>Slight reorganizing of imports</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eeedcc16a2fc5a07810469baee28ef94ccd86b29">eeedcc1</a></td><td><code>A bit more cleanup of Graphics3D._rich_repr_threejs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0a8402f54e5f711082a2d62021f4be4a0a755455">0a8402f</a></td><td><code>Change the threejs_template.html to a Jinja template and use jinja2 to render it.</code></td></tr></table>




---

archive/issue_comments_509395.json:
```json
{
    "body": "**Changing commit** from \"[d80024e067955057c6c9c97a0deed50b54ab330c](https://github.com/sagemath/sagetrac-mirror/commit/d80024e067955057c6c9c97a0deed50b54ab330c)\" to \"[0a8402f54e5f711082a2d62021f4be4a0a755455](https://github.com/sagemath/sagetrac-mirror/commit/0a8402f54e5f711082a2d62021f4be4a0a755455)\".",
    "created_at": "2019-04-03T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509395",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[d80024e067955057c6c9c97a0deed50b54ab330c](https://github.com/sagemath/sagetrac-mirror/commit/d80024e067955057c6c9c97a0deed50b54ab330c)" to "[0a8402f54e5f711082a2d62021f4be4a0a755455](https://github.com/sagemath/sagetrac-mirror/commit/0a8402f54e5f711082a2d62021f4be4a0a755455)".



---

archive/issue_comments_509396.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2019-04-03T10:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509396",
    "user": "https://github.com/embray"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_509397.json:
```json
{
    "body": "<a id='comment:10'></a>\nRebased to incorporate the changes from #27568.  I don't think this should conflict with any of the other ongoing ThreeJS tickets.",
    "created_at": "2019-04-03T10:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509397",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Rebased to incorporate the changes from #27568.  I don't think this should conflict with any of the other ongoing ThreeJS tickets.



---

archive/issue_comments_509398.json:
```json
{
    "body": "**Dependencies:** #27568",
    "created_at": "2019-04-03T10:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509398",
    "user": "https://github.com/embray"
}
```

**Dependencies:** #27568



---

archive/issue_comments_509399.json:
```json
{
    "body": "<a id='comment:11'></a>\nWith this ticket branch pulled in Sage 8.8.beta0, the notebook\nhttps://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.3/SM_AdS.ipynb\nfails in cell [15], which regards 3D plot of lines. The error is \n\n```\nTypeError: Object of type 'Integer' is not JSON serializable\n```\nand arises from line 456 of `src/sage/plot/plot3d/base.pyx`:\n\n```\n    SAGE_LINES=json.dumps(lines),\n```\nThe full traceback is copied below.\n\nThe same notebook works well with Sage 8.8.beta0 (python3-built). \n\n```\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-15-61e6b42cec16> in <module>()\n      8                     label_axes=False)  # phi = pi => X < 0 part\n      9 show(graph_hyp, aspect_ratio=Integer(1), viewer=viewer3D, online=True,\n---> 10      axes_labels=['V','X','U'])\n\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/pretty_print.py in show(*args, **kwds)\n    256         args[0].show()\n    257         return\n--> 258     pretty_print(*args, **kwds)\n\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/pretty_print.py in pretty_print(*args, **kwds)\n    227             pass\n    228         elif len(args) == 1:\n--> 229             dm.display_immediately(*args, **kwds)\n    230         else:\n    231             SequencePrettyPrinter(*args, **kwds).pretty_print()\n\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in display_immediately(self, obj, **rich_repr_kwds)\n    833             1/2\n    834         \"\"\"\n--> 835         plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)\n    836         self._backend.display_immediately(plain_text, rich_output)\n    837 \n\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in _rich_output_formatter(self, obj, rich_repr_kwds)\n    623         has_rich_repr = isinstance(obj, SageObject) and hasattr(obj, '_rich_repr_')\n    624         if has_rich_repr:\n--> 625             rich_output = self._call_rich_repr(obj, rich_repr_kwds)\n    626         if isinstance(rich_output, OutputPlainText):\n    627             plain_text = rich_output\n\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in _call_rich_repr(self, obj, rich_repr_kwds)\n    581         if rich_repr_kwds:\n    582             # do not ignore errors from invalid options\n--> 583             return obj._rich_repr_(self, **rich_repr_kwds)\n    584         try:\n    585             return obj._rich_repr_(self)\n\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_ (build/cythonized/sage/plot/plot3d/base.c:5661)()\n    171             return self._rich_repr_wavefront(**opts)\n    172         elif viewer == 'threejs':\n--> 173             return self._rich_repr_threejs(**opts)\n    174         else:\n    175             assert False   # unreachable\n\n/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs (build/cythonized/sage/plot/plot3d/base.c:9931)()\n    450                 SAGE_TEXTS=json.dumps(texts),\n    451                 SAGE_POINTS=json.dumps(points),\n--> 452                 SAGE_LINES=json.dumps(lines),\n    453                 SAGE_SURFACES=surfaces\n    454         )\n\n/home/eric/sage/py3/local/lib/python3.6/json/__init__.py in dumps(obj, skipkeys, ensure_ascii, check_circular, allow_nan, cls, indent, separators, default, sort_keys, **kw)\n    229         cls is None and indent is None and separators is None and\n    230         default is None and not sort_keys and not kw):\n--> 231         return _default_encoder.encode(obj)\n    232     if cls is None:\n    233         cls = JSONEncoder\n\n/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in encode(self, o)\n    197         # exceptions aren't as detailed.  The list call should be roughly\n    198         # equivalent to the PySequence_Fast that ''.join() would do.\n--> 199         chunks = self.iterencode(o, _one_shot=True)\n    200         if not isinstance(chunks, (list, tuple)):\n    201             chunks = list(chunks)\n\n/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in iterencode(self, o, _one_shot)\n    255                 self.key_separator, self.item_separator, self.sort_keys,\n    256                 self.skipkeys, _one_shot)\n--> 257         return _iterencode(o, 0)\n    258 \n    259 def _make_iterencode(markers, _default, _encoder, _indent, _floatstr,\n\n/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in default(self, o)\n    178         \"\"\"\n    179         raise TypeError(\"Object of type '%s' is not JSON serializable\" %\n--> 180                         o.__class__.__name__)\n    181 \n    182     def encode(self, o):\n\nTypeError: Object of type 'Integer' is not JSON serializable\n```",
    "created_at": "2019-04-04T13:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509399",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:11'></a>
With this ticket branch pulled in Sage 8.8.beta0, the notebook
https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.3/SM_AdS.ipynb
fails in cell [15], which regards 3D plot of lines. The error is 

```
TypeError: Object of type 'Integer' is not JSON serializable
```
and arises from line 456 of `src/sage/plot/plot3d/base.pyx`:

```
    SAGE_LINES=json.dumps(lines),
```
The full traceback is copied below.

The same notebook works well with Sage 8.8.beta0 (python3-built). 

```
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-15-61e6b42cec16> in <module>()
      8                     label_axes=False)  # phi = pi => X < 0 part
      9 show(graph_hyp, aspect_ratio=Integer(1), viewer=viewer3D, online=True,
---> 10      axes_labels=['V','X','U'])

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/pretty_print.py in show(*args, **kwds)
    256         args[0].show()
    257         return
--> 258     pretty_print(*args, **kwds)

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/pretty_print.py in pretty_print(*args, **kwds)
    227             pass
    228         elif len(args) == 1:
--> 229             dm.display_immediately(*args, **kwds)
    230         else:
    231             SequencePrettyPrinter(*args, **kwds).pretty_print()

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in display_immediately(self, obj, **rich_repr_kwds)
    833             1/2
    834         """
--> 835         plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
    836         self._backend.display_immediately(plain_text, rich_output)
    837 

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in _rich_output_formatter(self, obj, rich_repr_kwds)
    623         has_rich_repr = isinstance(obj, SageObject) and hasattr(obj, '_rich_repr_')
    624         if has_rich_repr:
--> 625             rich_output = self._call_rich_repr(obj, rich_repr_kwds)
    626         if isinstance(rich_output, OutputPlainText):
    627             plain_text = rich_output

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/repl/rich_output/display_manager.py in _call_rich_repr(self, obj, rich_repr_kwds)
    581         if rich_repr_kwds:
    582             # do not ignore errors from invalid options
--> 583             return obj._rich_repr_(self, **rich_repr_kwds)
    584         try:
    585             return obj._rich_repr_(self)

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_ (build/cythonized/sage/plot/plot3d/base.c:5661)()
    171             return self._rich_repr_wavefront(**opts)
    172         elif viewer == 'threejs':
--> 173             return self._rich_repr_threejs(**opts)
    174         else:
    175             assert False   # unreachable

/home/eric/sage/py3/local/lib/python3.6/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_threejs (build/cythonized/sage/plot/plot3d/base.c:9931)()
    450                 SAGE_TEXTS=json.dumps(texts),
    451                 SAGE_POINTS=json.dumps(points),
--> 452                 SAGE_LINES=json.dumps(lines),
    453                 SAGE_SURFACES=surfaces
    454         )

/home/eric/sage/py3/local/lib/python3.6/json/__init__.py in dumps(obj, skipkeys, ensure_ascii, check_circular, allow_nan, cls, indent, separators, default, sort_keys, **kw)
    229         cls is None and indent is None and separators is None and
    230         default is None and not sort_keys and not kw):
--> 231         return _default_encoder.encode(obj)
    232     if cls is None:
    233         cls = JSONEncoder

/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in encode(self, o)
    197         # exceptions aren't as detailed.  The list call should be roughly
    198         # equivalent to the PySequence_Fast that ''.join() would do.
--> 199         chunks = self.iterencode(o, _one_shot=True)
    200         if not isinstance(chunks, (list, tuple)):
    201             chunks = list(chunks)

/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in iterencode(self, o, _one_shot)
    255                 self.key_separator, self.item_separator, self.sort_keys,
    256                 self.skipkeys, _one_shot)
--> 257         return _iterencode(o, 0)
    258 
    259 def _make_iterencode(markers, _default, _encoder, _indent, _floatstr,

/home/eric/sage/py3/local/lib/python3.6/json/encoder.py in default(self, o)
    178         """
    179         raise TypeError("Object of type '%s' is not JSON serializable" %
--> 180                         o.__class__.__name__)
    181 
    182     def encode(self, o):

TypeError: Object of type 'Integer' is not JSON serializable
```



---

archive/issue_comments_509400.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2019-04-04T13:03:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509400",
    "user": "https://github.com/egourgoulhon"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_509401.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [egourgoulhon](#comment%3A11):\n> With this ticket branch pulled in Sage 8.8.beta0, the notebook\n> https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.3/SM_AdS.ipynb\n> fails in cell [15], which regards 3D plot of lines. \n\n\nA minimal example yielding to a similar error is\n\n```\nE = EuclideanSpace(3)\nshow(E.cartesian_coordinates().plot(), viewer='threejs')\n```\nOne gets \n\n```\nTypeError: Object of type 'RealDoubleElement' is not JSON serializable\n```\nfrom line 450 of `src/sage/plot/plot3d/base.pyx`:\n\n```\n    SAGE_TEXTS=json.dumps(texts),\n```",
    "created_at": "2019-04-04T13:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509401",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:12'></a>
Replying to [egourgoulhon](#comment%3A11):
> With this ticket branch pulled in Sage 8.8.beta0, the notebook
> https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.3/SM_AdS.ipynb
> fails in cell [15], which regards 3D plot of lines. 


A minimal example yielding to a similar error is

```
E = EuclideanSpace(3)
show(E.cartesian_coordinates().plot(), viewer='threejs')
```
One gets 

```
TypeError: Object of type 'RealDoubleElement' is not JSON serializable
```
from line 450 of `src/sage/plot/plot3d/base.pyx`:

```
    SAGE_TEXTS=json.dumps(texts),
```



---

archive/issue_comments_509402.json:
```json
{
    "body": "<a id='comment:13'></a>\nOkay, I see.  What we're lacking is JSON serialization for some basic Sage types.\n\nWhile it would be overkill to add that just for this ticket, it would be a useful thing to have in its own right.  I'll at least get something started for that...",
    "created_at": "2019-04-04T13:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509402",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
Okay, I see.  What we're lacking is JSON serialization for some basic Sage types.

While it would be overkill to add that just for this ticket, it would be a useful thing to have in its own right.  I'll at least get something started for that...



---

archive/issue_comments_509403.json:
```json
{
    "body": "<a id='comment:14'></a>\nTickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509403",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_events_077373.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77373"
}
```



---

archive/issue_comments_509404.json:
```json
{
    "body": "**Assignee:** @embray",
    "created_at": "2019-08-12T12:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509404",
    "user": "https://github.com/embray"
}
```

**Assignee:** @embray



---

archive/issue_comments_509405.json:
```json
{
    "body": "<a id='comment:15'></a>\nStill need to see about adding basic support for JSON serializations of Sage Objects.",
    "created_at": "2019-08-12T12:08:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509405",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
Still need to see about adding basic support for JSON serializations of Sage Objects.



---

archive/issue_events_077374.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77374"
}
```



---

archive/issue_events_077375.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77375"
}
```



---

archive/issue_comments_509406.json:
```json
{
    "body": "<a id='comment:16'></a>\nTicket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509406",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>
Ticket retargeted after milestone closed



---

archive/issue_events_077376.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77376"
}
```



---

archive/issue_events_077377.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-04-14T19:41:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77377"
}
```



---

archive/issue_comments_509407.json:
```json
{
    "body": "<a id='comment:17'></a>\nBatch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509407",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_509408.json:
```json
{
    "body": "<a id='comment:19'></a>\nThe manual JSON construction of points, lines, texts, and surfaces was cleaned up independently as part of #29227.\n\nThe clean up of the `bounds`, `lights`, and `ambient` JSONs as well as the imports clean up from this branch would be nice to have, though.\n\nI do also really like the idea of using Jinja instead of string replacements from this ticket. Could even replace my somewhat hacky conditional inclusion of the new animation.html/css/js files with commands in the template. Something like:\n\n```\n{% if animate %}\n<style>{% include 'animation.css' %}</style>\n<script>{% include 'animation.js' %}</script>\n{% include 'animation.html' %}\n{% endif %}\n```",
    "created_at": "2020-08-27T06:37:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509408",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:19'></a>
The manual JSON construction of points, lines, texts, and surfaces was cleaned up independently as part of #29227.

The clean up of the `bounds`, `lights`, and `ambient` JSONs as well as the imports clean up from this branch would be nice to have, though.

I do also really like the idea of using Jinja instead of string replacements from this ticket. Could even replace my somewhat hacky conditional inclusion of the new animation.html/css/js files with commands in the template. Something like:

```
{% if animate %}
<style>{% include 'animation.css' %}</style>
<script>{% include 'animation.js' %}</script>
{% include 'animation.html' %}
{% endif %}
```



---

archive/issue_comments_509409.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [gh-jcamp0x2a](#comment%3A19):\n> The manual JSON construction of points, lines, texts, and surfaces was cleaned up independently as part of #29227.\n> \n> The clean up of the `bounds`, `lights`, and `ambient` JSONs as well as the imports clean up from this branch would be nice to have, though.\n> \n> I do also really like the idea of using Jinja instead of string replacements from this ticket. Could even replace my somewhat hacky conditional inclusion of the new animation.html/css/js files with commands in the template. Something like:\n> \n> ```\n> {% if animate %}\n> <style>{% include 'animation.css' %}</style>\n> <script>{% include 'animation.js' %}</script>\n> {% include 'animation.html' %}\n> {% endif %}\n> ```\n\n\nThanks for pointing it out.  That manual JSON construction was a real bummer, and I like your `threejs_repr` approach.\n\nI completely forgot about this ticket (almost 2 years old as you can see) but maybe I can rebase it on top of your work and incorporate Jinja into it.",
    "created_at": "2020-08-31T13:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509409",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
Replying to [gh-jcamp0x2a](#comment%3A19):
> The manual JSON construction of points, lines, texts, and surfaces was cleaned up independently as part of #29227.
> 
> The clean up of the `bounds`, `lights`, and `ambient` JSONs as well as the imports clean up from this branch would be nice to have, though.
> 
> I do also really like the idea of using Jinja instead of string replacements from this ticket. Could even replace my somewhat hacky conditional inclusion of the new animation.html/css/js files with commands in the template. Something like:
> 
> ```
> {% if animate %}
> <style>{% include 'animation.css' %}</style>
> <script>{% include 'animation.js' %}</script>
> {% include 'animation.html' %}
> {% endif %}
> ```


Thanks for pointing it out.  That manual JSON construction was a real bummer, and I like your `threejs_repr` approach.

I completely forgot about this ticket (almost 2 years old as you can see) but maybe I can rebase it on top of your work and incorporate Jinja into it.



---

archive/issue_comments_509410.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [embray](#comment%3A20):\n> I completely forgot about this ticket (almost 2 years old as you can see) but maybe I can rebase it on top of your work and incorporate Jinja into it.\n\n\nThat would be awesome :)\n\nI see the JSON serialization was a hangup in the past for this ticket? I remember encountering issues with it, too. Rather than try to implement JSON serialization for a bunch of Sage types, which I agree would be ideal, I opted to do explicit conversion to int/float in the various `threejs_repr` methods since almost all of those types already supported that conversion. So I think (hope) everything is safe to send to jinja as-is.",
    "created_at": "2020-09-03T16:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509410",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:21'></a>
Replying to [embray](#comment%3A20):
> I completely forgot about this ticket (almost 2 years old as you can see) but maybe I can rebase it on top of your work and incorporate Jinja into it.


That would be awesome :)

I see the JSON serialization was a hangup in the past for this ticket? I remember encountering issues with it, too. Rather than try to implement JSON serialization for a bunch of Sage types, which I agree would be ideal, I opted to do explicit conversion to int/float in the various `threejs_repr` methods since almost all of those types already supported that conversion. So I think (hope) everything is safe to send to jinja as-is.



---

archive/issue_events_077378.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77378"
}
```



---

archive/issue_events_077379.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77379"
}
```



---

archive/issue_comments_509411.json:
```json
{
    "body": "<a id='comment:23'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509411",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_077380.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77380"
}
```



---

archive/issue_events_077381.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77381"
}
```



---

archive/issue_events_077382.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77382"
}
```



---

archive/issue_events_077383.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77383"
}
```



---

archive/issue_comments_509412.json:
```json
{
    "body": "<a id='comment:24'></a>\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27592#issuecomment-509412",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_077384.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77384"
}
```



---

archive/issue_events_077385.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77385"
}
```



---

archive/issue_events_077386.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77386"
}
```



---

archive/issue_events_077387.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-07T00:07:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77387"
}
```



---

archive/issue_events_077388.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77388"
}
```



---

archive/issue_events_077389.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27592",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27592#event-77389"
}
```
