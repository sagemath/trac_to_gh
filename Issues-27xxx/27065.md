# Issue 27065: py3: handle the explain_pickle problem

archive/issues_026828.json:
```json
{
    "body": "CC:  @embray @jdemeyer @kiwifb @tscrim @vinklein\n\nThe file explain_pickle has currently 70 failing doctests with python3. It seems to be very difficult to fix them all.\n\nProposal:\n\n* either (1) remove this file completely\n* or (2) tag all doctests with `#py2`\n\nThis ticket implements option (2): tag all doctests with `#py2`.\n\nFurther work on `explain_pickle` is tracked at #27350.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27065\n\n",
    "closed_at": "2019-02-26T23:36:52Z",
    "created_at": "2019-01-15T19:04:33Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "py3: handle the explain_pickle problem",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27065",
    "user": "https://github.com/fchapoton"
}
```
CC:  @embray @jdemeyer @kiwifb @tscrim @vinklein

The file explain_pickle has currently 70 failing doctests with python3. It seems to be very difficult to fix them all.

Proposal:

* either (1) remove this file completely
* or (2) tag all doctests with `#py2`

This ticket implements option (2): tag all doctests with `#py2`.

Further work on `explain_pickle` is tracked at #27350.

Issue created by migration from https://trac.sagemath.org/ticket/27065





---

archive/issue_comments_376994.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-01-15T19:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-376994",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_376995.json:
```json
{
    "body": "I brought this up on the mailing list some months ago, and consensus of most people who participated in the discussion was to remove this module from Sage, but publish it as a stand-alone package: https://groups.google.com/d/msg/sage-devel/94kP0_Xbx04/x7St89zwCgAJ\n\nI can work on that.  My feeling about it is to make two completely separate Python 2 and Python 3 versions.  Maintenance-wise I don't see that being much of a burden since this module won't likely be maintained much anyways, and after 2020 the Python 2 version can be removed entirely.",
    "created_at": "2019-01-16T10:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-376995",
    "user": "https://github.com/embray"
}
```

I brought this up on the mailing list some months ago, and consensus of most people who participated in the discussion was to remove this module from Sage, but publish it as a stand-alone package: https://groups.google.com/d/msg/sage-devel/94kP0_Xbx04/x7St89zwCgAJ

I can work on that.  My feeling about it is to make two completely separate Python 2 and Python 3 versions.  Maintenance-wise I don't see that being much of a burden since this module won't likely be maintained much anyways, and after 2020 the Python 2 version can be removed entirely.



---

archive/issue_comments_376996.json:
```json
{
    "body": "Good. Should we deprecate or can we just remove (given our python3 objective) ?",
    "created_at": "2019-01-16T12:25:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-376996",
    "user": "https://github.com/fchapoton"
}
```

Good. Should we deprecate or can we just remove (given our python3 objective) ?



---

archive/issue_comments_376997.json:
```json
{
    "body": "Here is branch that removes `explain_pickle` from sage.\n\n---\nNew commits:",
    "created_at": "2019-01-16T12:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-376997",
    "user": "https://github.com/fchapoton"
}
```

Here is branch that removes `explain_pickle` from sage.

---
New commits:



---

archive/issue_events_067232.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-16T13:29:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27065#event-67232"
}
```



---

archive/issue_comments_376998.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-16T16:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-376998",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_376999.json:
```json
{
    "body": "What to do with the few doctests using `unpickle_newobj` and `unpickle_build` ? Just remove them ?",
    "created_at": "2019-01-16T16:20:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-376999",
    "user": "https://github.com/fchapoton"
}
```

What to do with the few doctests using `unpickle_newobj` and `unpickle_build` ? Just remove them ?



---

archive/issue_comments_377000.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2019-01-16T17:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377000",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_377001.json:
```json
{
    "body": "I had assumed keep `sage.misc.explain_pickle` but just have it do `from explain_pickle import *` and also raise a deprecation warning if imported.\n\nThis will have to wait, of course, until I make `explain_pickle`, and we can add it either as a standard package, or an optional package (in which case `sage.misc.explain_pickle` should catch `ImportError` and provide some explanation).",
    "created_at": "2019-01-16T17:41:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377001",
    "user": "https://github.com/embray"
}
```

I had assumed keep `sage.misc.explain_pickle` but just have it do `from explain_pickle import *` and also raise a deprecation warning if imported.

This will have to wait, of course, until I make `explain_pickle`, and we can add it either as a standard package, or an optional package (in which case `sage.misc.explain_pickle` should catch `ImportError` and provide some explanation).



---

archive/issue_comments_377002.json:
```json
{
    "body": "I would recommend making it straight to standard, but this will need a (quick) sage-devel vote.",
    "created_at": "2019-01-16T17:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377002",
    "user": "https://github.com/tscrim"
}
```

I would recommend making it straight to standard, but this will need a (quick) sage-devel vote.



---

archive/issue_comments_377003.json:
```json
{
    "body": "I'm fine with either way, but point is there should still be some sort of regression for the old module (even if probably very few people use it outside of development--but clearly some do!)",
    "created_at": "2019-01-18T09:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377003",
    "user": "https://github.com/embray"
}
```

I'm fine with either way, but point is there should still be some sort of regression for the old module (even if probably very few people use it outside of development--but clearly some do!)



---

archive/issue_comments_377004.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-21T10:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_377005.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-21T10:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377005",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_377006.json:
```json
{
    "body": "Now ready. All failing doctests have been marked as depending on the non-existing pip package \"explain_pickle\".",
    "created_at": "2019-01-21T10:37:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377006",
    "user": "https://github.com/fchapoton"
}
```

Now ready. All failing doctests have been marked as depending on the non-existing pip package "explain_pickle".



---

archive/issue_comments_377007.json:
```json
{
    "body": "Please just let me take care of it.  I promise I will soon (although I don't consider it high priority even for the Python 3 port, but I know you want to get those failures down--though this would be a good use case for known-failures :)\n\nI fear you did some work here that was ultimately unnecessary.  In particular, I believe the `unpickle_newobj` utility doesn't even belong in explain_pickle in the first place; it should be moved elsewhere.\n\nSecond of all, I had still planned to keep the `sage.misc.explain_pickle` module as a wrapper--possibly with parts of it deprecated, but also possibly not; it depends on exactly how the third-party `explain_pickle` module ends up being structured.  For example, there's lots of use currently of Sage-specific stuff like `SageInputExpression` and `SageInputBuilder` that doesn't necessarily make sense to use (at least directly) in a more generic implementation.  But it will definitely have an API that will allow using them, but that might involve extensions that would still belong somewhere in sage, such as in the existing explain_pickle module.\n\nSo it's not just a simple matter of removing that module and declaring tests that happened to use it as optional, and there's not much point in doing work on this until I have that third-party module ready to work with.",
    "created_at": "2019-01-21T11:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377007",
    "user": "https://github.com/embray"
}
```

Please just let me take care of it.  I promise I will soon (although I don't consider it high priority even for the Python 3 port, but I know you want to get those failures down--though this would be a good use case for known-failures :)

I fear you did some work here that was ultimately unnecessary.  In particular, I believe the `unpickle_newobj` utility doesn't even belong in explain_pickle in the first place; it should be moved elsewhere.

Second of all, I had still planned to keep the `sage.misc.explain_pickle` module as a wrapper--possibly with parts of it deprecated, but also possibly not; it depends on exactly how the third-party `explain_pickle` module ends up being structured.  For example, there's lots of use currently of Sage-specific stuff like `SageInputExpression` and `SageInputBuilder` that doesn't necessarily make sense to use (at least directly) in a more generic implementation.  But it will definitely have an API that will allow using them, but that might involve extensions that would still belong somewhere in sage, such as in the existing explain_pickle module.

So it's not just a simple matter of removing that module and declaring tests that happened to use it as optional, and there's not much point in doing work on this until I have that third-party module ready to work with.



---

archive/issue_comments_377008.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-21T11:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377008",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_377009.json:
```json
{
    "body": "In fact, now that I've done a bit more research into how this works, I'm almost certain that `sage.misc.explain_pickle` won't go away at all.  However, most of its current contents will be gone, and replaced with a few Sage-specific wrappers and some tests for cases that are of particular interest for Sage (e.g. testing that `register_unpickle_override` is handled properly when explaining pickles that load globals).",
    "created_at": "2019-01-21T13:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377009",
    "user": "https://github.com/embray"
}
```

In fact, now that I've done a bit more research into how this works, I'm almost certain that `sage.misc.explain_pickle` won't go away at all.  However, most of its current contents will be gone, and replaced with a few Sage-specific wrappers and some tests for cases that are of particular interest for Sage (e.g. testing that `register_unpickle_override` is handled properly when explaining pickles that load globals).



---

archive/issue_comments_377010.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2019-01-21T16:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377010",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_377011.json:
```json
{
    "body": "I've spent some time better understanding exactly how explain_pickle works, and believe I have a strategy now for implementing the \"generic\" version, and possibly deprecating parts of the existing code.",
    "created_at": "2019-01-21T16:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377011",
    "user": "https://github.com/embray"
}
```

I've spent some time better understanding exactly how explain_pickle works, and believe I have a strategy now for implementing the "generic" version, and possibly deprecating parts of the existing code.



---

archive/issue_comments_377012.json:
```json
{
    "body": "Making progress on this, though I still need to do a lot of testing, and the integration back into Sage isn't even started yet.",
    "created_at": "2019-01-25T13:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377012",
    "user": "https://github.com/embray"
}
```

Making progress on this, though I still need to do a lot of testing, and the integration back into Sage isn't even started yet.



---

archive/issue_comments_377013.json:
```json
{
    "body": "Erik, any news on this front ? I am tempted to just put `# py2` everywhere in this file..",
    "created_at": "2019-02-18T19:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377013",
    "user": "https://github.com/fchapoton"
}
```

Erik, any news on this front ? I am tempted to just put `# py2` everywhere in this file..



---

archive/issue_comments_377014.json:
```json
{
    "body": "I have had other priorities come up since I last worked on this (see e.g. https://trac.sagemath.org/query?priority=blocker&status=needs_info&status=needs_review&status=needs_work&status=new&status=positive_review&milestone=sage-8.7&col=id&col=summary&col=priority&col=status&col=type&col=milestone&col=component&order=priority)\n\nIf I have updates I won't just sit silently on them.",
    "created_at": "2019-02-19T15:32:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377014",
    "user": "https://github.com/embray"
}
```

I have had other priorities come up since I last worked on this (see e.g. https://trac.sagemath.org/query?priority=blocker&status=needs_info&status=needs_review&status=needs_work&status=new&status=positive_review&milestone=sage-8.7&col=id&col=summary&col=priority&col=status&col=type&col=milestone&col=component&order=priority)

If I have updates I won't just sit silently on them.



---

archive/issue_comments_377015.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-22T19:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377015",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_377016.json:
```json
{
    "body": "Thanks, Erik. I understand very well the existence of \"other priorities\".\n\nI am proposing now a simple branch, where I just tag `#py2` the failing doctests. This will allow to put this aside, and it will no longer stand in the middle of the way to python3-full-tests-pass.\n\n---\nNew commits:",
    "created_at": "2019-02-22T19:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377016",
    "user": "https://github.com/fchapoton"
}
```

Thanks, Erik. I understand very well the existence of "other priorities".

I am proposing now a simple branch, where I just tag `#py2` the failing doctests. This will allow to put this aside, and it will no longer stand in the middle of the way to python3-full-tests-pass.

---
New commits:



---

archive/issue_comments_377017.json:
```json
{
    "body": "green bot, please review",
    "created_at": "2019-02-23T07:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377017",
    "user": "https://github.com/fchapoton"
}
```

green bot, please review



---

archive/issue_comments_377018.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-25T08:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377018",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_377019.json:
```json
{
    "body": "I agree, this is better than nothing.",
    "created_at": "2019-02-25T08:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377019",
    "user": "https://github.com/jdemeyer"
}
```

I agree, this is better than nothing.



---

archive/issue_comments_377020.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-02-25T12:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377020",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_377021.json:
```json
{
    "body": "I don't really see the urgency of this.  It's really easy to ignore these failures as they're completely localized to this module, which can easily be skipped entirely.\n\nFeel free to set back to positive_review if you disagree, but please open a new ticket for the continued work and assign me or else I will probably forget to work on it at all (I want to though; last I worked on it it was about 80% complete--it was just surprisingly hard to get some things working on Python 3).",
    "created_at": "2019-02-25T12:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377021",
    "user": "https://github.com/embray"
}
```

I don't really see the urgency of this.  It's really easy to ignore these failures as they're completely localized to this module, which can easily be skipped entirely.

Feel free to set back to positive_review if you disagree, but please open a new ticket for the continued work and assign me or else I will probably forget to work on it at all (I want to though; last I worked on it it was about 80% complete--it was just surprisingly hard to get some things working on Python 3).



---

archive/issue_comments_377022.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-02-25T12:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377022",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_377023.json:
```json
{
    "body": "I have created #27350 for the task you want to do.\n\nI am now setting back the present trivial ticket to positive.",
    "created_at": "2019-02-25T12:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377023",
    "user": "https://github.com/fchapoton"
}
```

I have created #27350 for the task you want to do.

I am now setting back the present trivial ticket to positive.



---

archive/issue_comments_377024.json:
```json
{
    "body": "Remove assignee @embray.",
    "created_at": "2019-02-25T12:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377024",
    "user": "https://github.com/embray"
}
```

Remove assignee @embray.



---

archive/issue_comments_377025.json:
```json
{
    "body": "Okay, thank you.  This is fine with me if it will make you happy.  However, though it's not a big deal, in the future I would prefer that on tickets where the \"owner\" field is set to me where I am in the process of working on a solution, that the ticket not be essentially hijacked, and instead that a new ticket be created for your temporary workaround.",
    "created_at": "2019-02-25T13:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377025",
    "user": "https://github.com/embray"
}
```

Okay, thank you.  This is fine with me if it will make you happy.  However, though it's not a big deal, in the future I would prefer that on tickets where the "owner" field is set to me where I am in the process of working on a solution, that the ticket not be essentially hijacked, and instead that a new ticket be created for your temporary workaround.



---

archive/issue_comments_377026.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-26T23:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27065#issuecomment-377026",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_067233.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-26T23:36:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27065",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27065#event-67233"
}
```
