# Issue 27490: Simplistic multiprocessing.Pool replacement for parallel docbuild on older Cygwin

archive/issues_027253.json:
```json
{
    "body": "For Cygwin versions less than 3.0.0 (and only Cygwin) this replaces the use of `multiprocessing.Pool` in the `sage_setup.docbuild.build_many` function, with a na\u00efve but \"good enough\" (it works in general) parallel process pool that does not rely on starting processes from threads.\n\nThis is needed for #27214, because the specific combination of using `MAP_NORESERVE` `mmap`s and forking processes from a thread can result in a bug in Cygwin (fixed in 3.0.0) which causes unhandled segfaults to occur in any code that is run during the docbuild which uses libgap.\n\nSo this is really only needed so that the docs can continue to be built on systems (including my primary development environment, as well as the buildbot) that do not yet have Cygwin >= 3.0.0 once #27214 is applied.\n\nCC:  @jdemeyer\n\nBranch: [fe0e3ea1a8d85d41047f9308db48912f1bdcffcd](https://github.com/sagemath/sagetrac-mirror/commit/fe0e3ea1a8d85d41047f9308db48912f1bdcffcd)\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/27490\n\n",
    "closed_at": "2019-03-19T21:26:13Z",
    "created_at": "2019-03-15T10:49:36Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Simplistic multiprocessing.Pool replacement for parallel docbuild on older Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27490",
    "user": "https://github.com/embray"
}
```
For Cygwin versions less than 3.0.0 (and only Cygwin) this replaces the use of `multiprocessing.Pool` in the `sage_setup.docbuild.build_many` function, with a naÃ¯ve but "good enough" (it works in general) parallel process pool that does not rely on starting processes from threads.

This is needed for #27214, because the specific combination of using `MAP_NORESERVE` `mmap`s and forking processes from a thread can result in a bug in Cygwin (fixed in 3.0.0) which causes unhandled segfaults to occur in any code that is run during the docbuild which uses libgap.

So this is really only needed so that the docs can continue to be built on systems (including my primary development environment, as well as the buildbot) that do not yet have Cygwin >= 3.0.0 once #27214 is applied.

CC:  @jdemeyer

Branch: [fe0e3ea1a8d85d41047f9308db48912f1bdcffcd](https://github.com/sagemath/sagetrac-mirror/commit/fe0e3ea1a8d85d41047f9308db48912f1bdcffcd)

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/27490





---

archive/issue_comments_531784.json:
```json
{
    "body": "Changing branch from \"\" to \"u/embray/ticket-27490\"",
    "created_at": "2019-03-15T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531784",
    "user": "https://github.com/embray"
}
```

Changing branch from "" to "u/embray/ticket-27490"



---

archive/issue_comments_531785.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-15T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531785",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_531786.json:
```json
{
    "body": "Changing author from \"\" to \"Erik Bray\"",
    "created_at": "2019-03-15T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531786",
    "user": "https://github.com/embray"
}
```

Changing author from "" to "Erik Bray"



---

archive/issue_comments_531787.json:
```json
{
    "body": "Changing commit from \"\" to \"f9aabb755ce4cb89a6dd926bd26a08611cfaf389\"",
    "created_at": "2019-03-15T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531787",
    "user": "https://github.com/embray"
}
```

Changing commit from "" to "f9aabb755ce4cb89a6dd926bd26a08611cfaf389"



---

archive/issue_comments_531788.json:
```json
{
    "body": "<a id='comment:1'></a>\nJeroen, you will likely have thoughts about this.  Keep in mind, it's not meant to be at all robust--just a quick workaround so I don't have to spend too much more time on it.  But if you have any thoughts on straightforward improvements to this I'm all for it.\n\nObviously a better workaround, if it were possible, would be to use the much talked-about idea for generalizing the parallel processing loop from the Sage doctester. But since we don't have that yet this will do for now.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|\n|[f9aabb7](https://github.com/sagemath/sagetrac-mirror/commit/f9aabb755ce4cb89a6dd926bd26a08611cfaf389)|`Trac #27490: Simplistic multiprocessing.Pool replacement for parallel docbuild on older Cygwin`|",
    "created_at": "2019-03-15T11:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531788",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>
Jeroen, you will likely have thoughts about this.  Keep in mind, it's not meant to be at all robust--just a quick workaround so I don't have to spend too much more time on it.  But if you have any thoughts on straightforward improvements to this I'm all for it.

Obviously a better workaround, if it were possible, would be to use the much talked-about idea for generalizing the parallel processing loop from the Sage doctester. But since we don't have that yet this will do for now.

---
New commits:
|                                                                                                                                          |                                                                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|
|[f9aabb7](https://github.com/sagemath/sagetrac-mirror/commit/f9aabb755ce4cb89a6dd926bd26a08611cfaf389)|`Trac #27490: Simplistic multiprocessing.Pool replacement for parallel docbuild on older Cygwin`|



---

archive/issue_comments_531789.json:
```json
{
    "body": "<a id='comment:2'></a>\nI'm just wondering why you even bother with parallel docbuilding in the first place. The obvious solution is just using a single process.",
    "created_at": "2019-03-15T13:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531789",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
I'm just wondering why you even bother with parallel docbuilding in the first place. The obvious solution is just using a single process.



---

archive/issue_comments_531790.json:
```json
{
    "body": "<a id='comment:3'></a>\nAlso, in general I don't like code of the form\n\n```\nif A_is_not_broken:\n    A()\nelse:\n    B()\n```\nIf `B` works well enough to replace `A`, then why don't we just use `B` unconditionally?\n\nThis is especially relevant when `A` involves `multiprocessing.Pool` which has other issues (that's why I didn't use it in the doctester).\n\nSo I would like to know if there is a good reason to not use your \"simplistic multiprocessing.Pool replacement\" on all systems.",
    "created_at": "2019-03-15T13:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531790",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Also, in general I don't like code of the form

```
if A_is_not_broken:
    A()
else:
    B()
```
If `B` works well enough to replace `A`, then why don't we just use `B` unconditionally?

This is especially relevant when `A` involves `multiprocessing.Pool` which has other issues (that's why I didn't use it in the doctester).

So I would like to know if there is a good reason to not use your "simplistic multiprocessing.Pool replacement" on all systems.



---

archive/issue_comments_531791.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-15T13:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531791",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_531792.json:
```json
{
    "body": "<a id='comment:4'></a>\nSome comments on the code:\n\n1. This should use `os.wait()` instead of `time.sleep(5)`. Unless I'm missing something, this should be robust.\n\n2. A few comments would be helpful.\n\n3. `not any(filter(None, workers))` is not an easy condition to understand. I would write it as `all(w is None for w in workers)`.\n\n4. I don't think that there is a need to gracefully shutdown the workers in the `finally` block. A hard kill `os.kill(w.pid, signal.SIGKILL)` may be better because it guarantees to kill the process (cysignals catches `SIGTERM` which does `sys.exit()` but that might not actually kill the process in a sufficiently messed up state). For extra safety, maybe call `is_alive()` before killing the process.\n\nIn general, I like it. It's simple but the use case is sufficiently simple that we don't need anything more complicated. And it says a lot about `multiprocess.Pool` that this might actually work better than `multiprocessing.Pool`.",
    "created_at": "2019-03-15T13:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531792",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Some comments on the code:

1. This should use `os.wait()` instead of `time.sleep(5)`. Unless I'm missing something, this should be robust.

2. A few comments would be helpful.

3. `not any(filter(None, workers))` is not an easy condition to understand. I would write it as `all(w is None for w in workers)`.

4. I don't think that there is a need to gracefully shutdown the workers in the `finally` block. A hard kill `os.kill(w.pid, signal.SIGKILL)` may be better because it guarantees to kill the process (cysignals catches `SIGTERM` which does `sys.exit()` but that might not actually kill the process in a sufficiently messed up state). For extra safety, maybe call `is_alive()` before killing the process.

In general, I like it. It's simple but the use case is sufficiently simple that we don't need anything more complicated. And it says a lot about `multiprocess.Pool` that this might actually work better than `multiprocessing.Pool`.



---

archive/issue_comments_531793.json:
```json
{
    "body": "<a id='comment:5'></a>\nThanks for having a look.\n\nReplying to [jdemeyer](#comment%3A4):\n> Some comments on the code:\n> \n> 1. This should use `os.wait()` instead of `time.sleep(5)`. Unless I'm missing something, this should be robust.\n\n\nYes, that should be much better.\n\n> 2. A few comments would be helpful.\n\n\n+1\n\n> 3. `not any(filter(None, workers))` is not an easy condition to understand. I would write it as `all(w is None for w in workers)`.\n\n\nI thought it was pretty straightforward, but I guess the `not any` is a little confusing.\n\n> 4. I don't think that there is a need to gracefully shutdown the workers in the `finally` block. A hard kill `os.kill(w.pid, signal.SIGKILL)` may be better because it guarantees to kill the process (cysignals catches `SIGTERM` which does `sys.exit()` but that might not actually kill the process in a sufficiently messed up state). For extra safety, maybe call `is_alive()` before killing the process.\n\n\nI think there is: Or at least to try to SIGTERM first. Reason being this block can be reached if one process exits in error, while other processes are still working perfectly fine.  You want to gracefully shut them down and ensure that their atexit handlers run, clean up temp files, etc.\n\n> In general, I like it. It's simple but the use case is sufficiently simple that we don't need anything more complicated. And it says a lot about `multiprocess.Pool` that this might actually work better than `multiprocessing.Pool`.\n\n\nI don't know that it says a lot. I don't think it actually works \"better\" on the whole, just in this one case. Keep in mind also that `multiprocessing.Pool` implements a lot of generic functionality (e.g. multiple simultaneous `map_async` jobs) that simply aren't needed for this simpler use case.\n\nOne downside to this approach is that there is no data returned from the child processes to the parent. So for example an exception raised in a worker cannot be re-raised from the parent.  Instead I just raise a generic `RuntimeError` if the process exited with an error code.  I simulated this case in testing and you can still see the worker's exception and traceback printed to stderr, so that was good-enough for my purposes.",
    "created_at": "2019-03-15T14:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531793",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>
Thanks for having a look.

Replying to [jdemeyer](#comment%3A4):
> Some comments on the code:
> 
> 1. This should use `os.wait()` instead of `time.sleep(5)`. Unless I'm missing something, this should be robust.


Yes, that should be much better.

> 2. A few comments would be helpful.


+1

> 3. `not any(filter(None, workers))` is not an easy condition to understand. I would write it as `all(w is None for w in workers)`.


I thought it was pretty straightforward, but I guess the `not any` is a little confusing.

> 4. I don't think that there is a need to gracefully shutdown the workers in the `finally` block. A hard kill `os.kill(w.pid, signal.SIGKILL)` may be better because it guarantees to kill the process (cysignals catches `SIGTERM` which does `sys.exit()` but that might not actually kill the process in a sufficiently messed up state). For extra safety, maybe call `is_alive()` before killing the process.


I think there is: Or at least to try to SIGTERM first. Reason being this block can be reached if one process exits in error, while other processes are still working perfectly fine.  You want to gracefully shut them down and ensure that their atexit handlers run, clean up temp files, etc.

> In general, I like it. It's simple but the use case is sufficiently simple that we don't need anything more complicated. And it says a lot about `multiprocess.Pool` that this might actually work better than `multiprocessing.Pool`.


I don't know that it says a lot. I don't think it actually works "better" on the whole, just in this one case. Keep in mind also that `multiprocessing.Pool` implements a lot of generic functionality (e.g. multiple simultaneous `map_async` jobs) that simply aren't needed for this simpler use case.

One downside to this approach is that there is no data returned from the child processes to the parent. So for example an exception raised in a worker cannot be re-raised from the parent.  Instead I just raise a generic `RuntimeError` if the process exited with an error code.  I simulated this case in testing and you can still see the worker's exception and traceback printed to stderr, so that was good-enough for my purposes.



---

archive/issue_comments_531794.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [jdemeyer](#comment%3A3):\n> Also, in general I don't like code of the form\n> \n> ```\n> if A_is_not_broken:\n>     A()\n> else:\n>     B()\n> ```\n> If `B` works well enough to replace `A`, then why don't we just use `B` unconditionally?\n> \n> This is especially relevant when `A` involves `multiprocessing.Pool` which has other issues (that's why I didn't use it in the doctester).\n> \n> So I would like to know if there is a good reason to not use your \"simplistic multiprocessing.Pool replacement\" on all systems.\n\n\nPartly for the reason I mentioned at the end of my previous comment, and partly just because I need this *now* and although I'm convinced it's robust-enough for my use it's still not well-tested.\n\nHow about for now we special-case this, and then for the next release make it a priority to finally get at least an initial version of the doctest forker code released and replace it with that?",
    "created_at": "2019-03-15T14:56:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531794",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
Replying to [jdemeyer](#comment%3A3):
> Also, in general I don't like code of the form
> 
> ```
> if A_is_not_broken:
>     A()
> else:
>     B()
> ```
> If `B` works well enough to replace `A`, then why don't we just use `B` unconditionally?
> 
> This is especially relevant when `A` involves `multiprocessing.Pool` which has other issues (that's why I didn't use it in the doctester).
> 
> So I would like to know if there is a good reason to not use your "simplistic multiprocessing.Pool replacement" on all systems.


Partly for the reason I mentioned at the end of my previous comment, and partly just because I need this *now* and although I'm convinced it's robust-enough for my use it's still not well-tested.

How about for now we special-case this, and then for the next release make it a priority to finally get at least an initial version of the doctest forker code released and replace it with that?



---

archive/issue_comments_531795.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jdemeyer](#comment%3A2):\n> I'm just wondering why you even bother with parallel docbuilding in the first place. The obvious solution is just using a single process.\n\n\nAt first I did just replace this with just plain `map(target, args)` but I wasn't satisfied: It was slow (obviously) and made memory usage even worse than it already is, over time.  It still seems better, if not kind of brushing other problems under the rug, to build each sub-doc in its own process that can easily be cleaned up when it's done.\n\nThe parallel version only took about 20 minutes to get working.",
    "created_at": "2019-03-15T15:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531795",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
Replying to [jdemeyer](#comment%3A2):
> I'm just wondering why you even bother with parallel docbuilding in the first place. The obvious solution is just using a single process.


At first I did just replace this with just plain `map(target, args)` but I wasn't satisfied: It was slow (obviously) and made memory usage even worse than it already is, over time.  It still seems better, if not kind of brushing other problems under the rug, to build each sub-doc in its own process that can easily be cleaned up when it's done.

The parallel version only took about 20 minutes to get working.



---

archive/issue_comments_531796.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|\n|[219e9c4](https://github.com/sagemath/sagetrac-mirror/commit/219e9c41e43036bed5d2a3f54d4684ee33aef06a)|`A little bit of import cleanup`|\n|[88771df](https://github.com/sagemath/sagetrac-mirror/commit/88771dfbe0d6b90cf5574065d312d1e0a7f005af)|`Trac #27490: Address some review comments and other cleanup:`|",
    "created_at": "2019-03-15T15:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531796",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------|
|[219e9c4](https://github.com/sagemath/sagetrac-mirror/commit/219e9c41e43036bed5d2a3f54d4684ee33aef06a)|`A little bit of import cleanup`|
|[88771df](https://github.com/sagemath/sagetrac-mirror/commit/88771dfbe0d6b90cf5574065d312d1e0a7f005af)|`Trac #27490: Address some review comments and other cleanup:`|



---

archive/issue_comments_531797.json:
```json
{
    "body": "Changing commit from \"f9aabb755ce4cb89a6dd926bd26a08611cfaf389\" to \"88771dfbe0d6b90cf5574065d312d1e0a7f005af\"",
    "created_at": "2019-03-15T15:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531797",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f9aabb755ce4cb89a6dd926bd26a08611cfaf389" to "88771dfbe0d6b90cf5574065d312d1e0a7f005af"



---

archive/issue_comments_531798.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-15T15:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531798",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_531799.json:
```json
{
    "body": "<a id='comment:9'></a>\nI addressed most of your comments, but I still have the big `if/else`.  Since that `sage_setup.docbuild.__init__` module is already quite large, perhaps I could move that code to a utility module at least.\n\nI'd still be open to just using it on all platforms, but I'm wary, given that this isn't battle-tested.",
    "created_at": "2019-03-15T15:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531799",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I addressed most of your comments, but I still have the big `if/else`.  Since that `sage_setup.docbuild.__init__` module is already quite large, perhaps I could move that code to a utility module at least.

I'd still be open to just using it on all platforms, but I'm wary, given that this isn't battle-tested.



---

archive/issue_comments_531800.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [embray](#comment%3A9):\n> I'd still be open to just using it on all platforms, but I'm wary, given that this isn't battle-tested.\n\n\nI see your point.",
    "created_at": "2019-03-15T15:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531800",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
Replying to [embray](#comment%3A9):
> I'd still be open to just using it on all platforms, but I'm wary, given that this isn't battle-tested.


I see your point.



---

archive/issue_comments_531801.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-15T16:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531801",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_531802.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2019-03-15T16:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531802",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_531803.json:
```json
{
    "body": "<a id='comment:11'></a>\nI'm willing to give this the benefit of the doubt. You'll probably be the only user of this code anyway.\n\nI'm sure that there is room for improvement (I still don't like the `finally` block for example), but we can defer that to the point that we decide to use this code for all systems.",
    "created_at": "2019-03-15T16:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531803",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
I'm willing to give this the benefit of the doubt. You'll probably be the only user of this code anyway.

I'm sure that there is room for improvement (I still don't like the `finally` block for example), but we can defer that to the point that we decide to use this code for all systems.



---

archive/issue_comments_531804.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-03-15T16:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531804",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_531805.json:
```json
{
    "body": "<a id='comment:12'></a>\nThanks.  However, I need to double back now since my last change broke something.  It's not starting new processes up after previous ones finish.",
    "created_at": "2019-03-15T16:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531805",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
Thanks.  However, I need to double back now since my last change broke something.  It's not starting new processes up after previous ones finish.



---

archive/issue_comments_531806.json:
```json
{
    "body": "<a id='comment:13'></a>\nThis sort-of makes sense: It turns out of you `os.wait()` a process run by `multiprocessing.Process()` it breaks, because it wants to `os.waitpid()` on itself so it can get its return code.  So wait()-ing that process manually means it never finds out that it itself finished (and it doesn't check for the correct error code that would indicate as much) so it always just returns `None` for its exitcode.  This is a bit buggy but understandable.",
    "created_at": "2019-03-15T16:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531806",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>
This sort-of makes sense: It turns out of you `os.wait()` a process run by `multiprocessing.Process()` it breaks, because it wants to `os.waitpid()` on itself so it can get its return code.  So wait()-ing that process manually means it never finds out that it itself finished (and it doesn't check for the correct error code that would indicate as much) so it always just returns `None` for its exitcode.  This is a bit buggy but understandable.



---

archive/issue_comments_531807.json:
```json
{
    "body": "<a id='comment:14'></a>\nI see. In the doctester, we solve this by checking for the `SIGCHLD` signal instead of `os.wait()`. Now I know why.",
    "created_at": "2019-03-15T17:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531807",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
I see. In the doctester, we solve this by checking for the `SIGCHLD` signal instead of `os.wait()`. Now I know why.



---

archive/issue_comments_531808.json:
```json
{
    "body": "<a id='comment:15'></a>\nI thought of doing that as a solution, but then you start involving signal handling and basically reimplementing parts of the doctester.  I have another solution that's a bit ugly but simpler.\n\nIt would be nice if there were a sort of `multiprocessing.wait()` that could wait for any one `multiprocessing.Process` to finish (or maybe one out of a specific list thereof).  Since multiprocessing already tracks its child processes this could be done.  Maybe I'll propose it...",
    "created_at": "2019-03-15T17:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531808",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
I thought of doing that as a solution, but then you start involving signal handling and basically reimplementing parts of the doctester.  I have another solution that's a bit ugly but simpler.

It would be nice if there were a sort of `multiprocessing.wait()` that could wait for any one `multiprocessing.Process` to finish (or maybe one out of a specific list thereof).  Since multiprocessing already tracks its child processes this could be done.  Maybe I'll propose it...



---

archive/issue_comments_531809.json:
```json
{
    "body": "<a id='comment:16'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|\n|[1e5b1f5](https://github.com/sagemath/sagetrac-mirror/commit/1e5b1f56b37e1fb9abdc75c5e3540fc137c5024c)|`Trac #27490: Further fixes in use of os.wait()`|",
    "created_at": "2019-03-15T17:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531809",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------|
|[1e5b1f5](https://github.com/sagemath/sagetrac-mirror/commit/1e5b1f56b37e1fb9abdc75c5e3540fc137c5024c)|`Trac #27490: Further fixes in use of os.wait()`|



---

archive/issue_comments_531810.json:
```json
{
    "body": "Changing commit from \"88771dfbe0d6b90cf5574065d312d1e0a7f005af\" to \"1e5b1f56b37e1fb9abdc75c5e3540fc137c5024c\"",
    "created_at": "2019-03-15T17:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531810",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "88771dfbe0d6b90cf5574065d312d1e0a7f005af" to "1e5b1f56b37e1fb9abdc75c5e3540fc137c5024c"



---

archive/issue_comments_531811.json:
```json
{
    "body": "<a id='comment:17'></a>\nOne can see how quickly more complex this *can* become.",
    "created_at": "2019-03-15T17:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531811",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>
One can see how quickly more complex this *can* become.



---

archive/issue_comments_531812.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-15T17:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531812",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_531813.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-15T17:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531813",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_531814.json:
```json
{
    "body": "<a id='comment:18'></a>\nSetting back to positive review since Jeroen was okay with (or at least resigned to) the current approach.  I've tested the updated code several times with different numbers of processes and am satisfied with it for now.",
    "created_at": "2019-03-15T17:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531814",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
Setting back to positive review since Jeroen was okay with (or at least resigned to) the current approach.  I've tested the updated code several times with different numbers of processes and am satisfied with it for now.



---

archive/issue_comments_531815.json:
```json
{
    "body": "<a id='comment:19'></a>\nCan we move that abomination at least into a separate file",
    "created_at": "2019-03-15T18:00:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531815",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
Can we move that abomination at least into a separate file



---

archive/issue_comments_531816.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-03-16T14:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531816",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_531817.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2019-03-18T11:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531817",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_531818.json:
```json
{
    "body": "<a id='comment:21'></a>\nWhich \"abomination\"?  I'm not necessarily going to do anything at your behest if you put it in such negative terms.",
    "created_at": "2019-03-18T11:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531818",
    "user": "https://github.com/embray"
}
```

<a id='comment:21'></a>
Which "abomination"?  I'm not necessarily going to do anything at your behest if you put it in such negative terms.



---

archive/issue_comments_531819.json:
```json
{
    "body": "<a id='comment:22'></a>\n(Which is not not say I necessarily think this is pretty as-is but it's still not even clear exactly what you're asking to move).",
    "created_at": "2019-03-18T11:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531819",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
(Which is not not say I necessarily think this is pretty as-is but it's still not even clear exactly what you're asking to move).



---

archive/issue_comments_531820.json:
```json
{
    "body": "<a id='comment:23'></a>\nIm asking you to move the parallel implementation of multiprocessing into a separate file, ideally with a small doctstring explaining what is going on here.",
    "created_at": "2019-03-18T16:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531820",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>
Im asking you to move the parallel implementation of multiprocessing into a separate file, ideally with a small doctstring explaining what is going on here.



---

archive/issue_comments_531821.json:
```json
{
    "body": "<a id='comment:24'></a>\nBut both versions? Just the one I added?",
    "created_at": "2019-03-19T08:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531821",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>
But both versions? Just the one I added?



---

archive/issue_comments_531822.json:
```json
{
    "body": "<a id='comment:25'></a>\nAt least for now just the one you added in the else branch. Thanks.",
    "created_at": "2019-03-19T09:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531822",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:25'></a>
At least for now just the one you added in the else branch. Thanks.



---

archive/issue_comments_531823.json:
```json
{
    "body": "<a id='comment:26'></a>\nOkay, I'll do that.",
    "created_at": "2019-03-19T10:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531823",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>
Okay, I'll do that.



---

archive/issue_comments_531824.json:
```json
{
    "body": "<a id='comment:27'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|\n|[78f8938](https://github.com/sagemath/sagetrac-mirror/commit/78f89387636bbbe9b2b315e6ed801f3b4908b249)|`Trac #27490: Moved the alternate build_many implementation into a`|",
    "created_at": "2019-03-19T11:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531824",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
|[78f8938](https://github.com/sagemath/sagetrac-mirror/commit/78f89387636bbbe9b2b315e6ed801f3b4908b249)|`Trac #27490: Moved the alternate build_many implementation into a`|



---

archive/issue_comments_531825.json:
```json
{
    "body": "Changing commit from \"1e5b1f56b37e1fb9abdc75c5e3540fc137c5024c\" to \"78f89387636bbbe9b2b315e6ed801f3b4908b249\"",
    "created_at": "2019-03-19T11:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531825",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1e5b1f56b37e1fb9abdc75c5e3540fc137c5024c" to "78f89387636bbbe9b2b315e6ed801f3b4908b249"



---

archive/issue_comments_531826.json:
```json
{
    "body": "<a id='comment:28'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------|\n|[3a35e4d](https://github.com/sagemath/sagetrac-mirror/commit/3a35e4d05c1ee547d25a30c51c57cdfdf5a9aa7a)|`fixup`|",
    "created_at": "2019-03-19T11:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |       |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------|
|[3a35e4d](https://github.com/sagemath/sagetrac-mirror/commit/3a35e4d05c1ee547d25a30c51c57cdfdf5a9aa7a)|`fixup`|



---

archive/issue_comments_531827.json:
```json
{
    "body": "Changing commit from \"78f89387636bbbe9b2b315e6ed801f3b4908b249\" to \"3a35e4d05c1ee547d25a30c51c57cdfdf5a9aa7a\"",
    "created_at": "2019-03-19T11:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531827",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "78f89387636bbbe9b2b315e6ed801f3b4908b249" to "3a35e4d05c1ee547d25a30c51c57cdfdf5a9aa7a"



---

archive/issue_comments_531828.json:
```json
{
    "body": "Changing commit from \"3a35e4d05c1ee547d25a30c51c57cdfdf5a9aa7a\" to \"fe0e3ea1a8d85d41047f9308db48912f1bdcffcd\"",
    "created_at": "2019-03-19T11:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531828",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3a35e4d05c1ee547d25a30c51c57cdfdf5a9aa7a" to "fe0e3ea1a8d85d41047f9308db48912f1bdcffcd"



---

archive/issue_comments_531829.json:
```json
{
    "body": "<a id='comment:29'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|\n|[fe0e3ea](https://github.com/sagemath/sagetrac-mirror/commit/fe0e3ea1a8d85d41047f9308db48912f1bdcffcd)|`Trac #27490: Moved the alternate build_many implementation into a`|",
    "created_at": "2019-03-19T11:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531829",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
|[fe0e3ea](https://github.com/sagemath/sagetrac-mirror/commit/fe0e3ea1a8d85d41047f9308db48912f1bdcffcd)|`Trac #27490: Moved the alternate build_many implementation into a`|



---

archive/issue_comments_531830.json:
```json
{
    "body": "<a id='comment:30'></a>\n(Just removed an unused import.)",
    "created_at": "2019-03-19T11:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531830",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>
(Just removed an unused import.)



---

archive/issue_comments_531831.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-03-19T11:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531831",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_531832.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-19T14:27:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531832",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_531833.json:
```json
{
    "body": "Changing branch from \"u/embray/ticket-27490\" to \"fe0e3ea1a8d85d41047f9308db48912f1bdcffcd\"",
    "created_at": "2019-03-19T21:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531833",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/ticket-27490" to "fe0e3ea1a8d85d41047f9308db48912f1bdcffcd"



---

archive/issue_events_077402.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-19T21:26:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27490#event-77402"
}
```



---

archive/issue_comments_531834.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-19T21:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531834",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_531835.json:
```json
{
    "body": "<a id='comment:33'></a>\nFollowup at #27514",
    "created_at": "2019-03-19T21:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531835",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:33'></a>
Followup at #27514



---

archive/issue_comments_531836.json:
```json
{
    "body": "Changing commit from \"fe0e3ea1a8d85d41047f9308db48912f1bdcffcd\" to \"\"",
    "created_at": "2019-03-19T21:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27490#issuecomment-531836",
    "user": "https://github.com/vbraun"
}
```

Changing commit from "fe0e3ea1a8d85d41047f9308db48912f1bdcffcd" to ""
