# Issue 27373: some dummy packages must be only re-installable via ./configure --with-...

archive/issues_027136.json:
```json
{
    "body": "`$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. \n\nTo deal with this, we introduce a kind of dummy packages, freezable,\nwhich differ from dummy so that they (once frozen) cannot be re-installed via\n`sage -i`, but only via re-running `./configire --with-...` first.\n\nSpecifically, for gmp and mpir, which are the only freezable packages so far, `./configure --with-mp=system` freezes, them, and\n`./sage -i gmp` or `./sage -i mpir` errors out.\nTo unfreeze, one needs to do first `./configure --with-mp=gmp` (or `=mpir`).\n\nThe branch implements this. If an attempt is made to run `./configure --with-mp=gmp`, (or any other \"frozen\" package) while Sage is configured with external gmp, one gets the error message\n\n```\n***********************************************\n before running ./sage -i/f gmp please run\n   ./configure <dollar sign>(./config.status --config) --with-mp=gmp\n***********************************************\n```\n\nDepends on #27212\n\n**Assignee:** @embray\n\n**CC:**  @embray\n\n**Reviewer:** Dima Pasechnik\n\nIssue created by migration from https://trac.sagemath.org/ticket/27373\n\n",
    "closed_at": "2020-10-11T16:54:31Z",
    "created_at": "2019-02-27T09:49:19Z",
    "labels": [
        "component: build",
        "duplicate"
    ],
    "title": "some dummy packages must be only re-installable via ./configure --with-...",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/27373",
    "user": "https://github.com/dimpase"
}
```
`$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. 

To deal with this, we introduce a kind of dummy packages, freezable,
which differ from dummy so that they (once frozen) cannot be re-installed via
`sage -i`, but only via re-running `./configire --with-...` first.

Specifically, for gmp and mpir, which are the only freezable packages so far, `./configure --with-mp=system` freezes, them, and
`./sage -i gmp` or `./sage -i mpir` errors out.
To unfreeze, one needs to do first `./configure --with-mp=gmp` (or `=mpir`).

The branch implements this. If an attempt is made to run `./configure --with-mp=gmp`, (or any other "frozen" package) while Sage is configured with external gmp, one gets the error message

```
***********************************************
 before running ./sage -i/f gmp please run
   ./configure <dollar sign>(./config.status --config) --with-mp=gmp
***********************************************
```

Depends on #27212

**Assignee:** @embray

**CC:**  @embray

**Reviewer:** Dima Pasechnik

Issue created by migration from https://trac.sagemath.org/ticket/27373





---

archive/issue_comments_426117.json:
```json
{
    "body": "<a id='comment:1'></a>\nWe can also merely document that `./sage -i blah` must be run after `./configure --with-blah=install`, perhaps also insert some warning print somewhere...",
    "created_at": "2019-02-27T10:18:33Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426117",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>
We can also merely document that `./sage -i blah` must be run after `./configure --with-blah=install`, perhaps also insert some warning print somewhere...



---

archive/issue_comments_426118.json:
```json
{
    "body": "<a id='comment:2'></a>\nI looked a bit into how `./sage -i blah` may trigger a run of `./configure --with-blah=install` - this is not hard, assuming `--with-blah` is a parameter known to configure. E.g. it can grep for it in the output of `./configure -h`, and \nrun, if found.\n\nThis will require having each package `blah` for which such a configure run is needed to implement the corresponding `--with-blah=`, (or, perhaps, something like\n`--install-blah`, to make it even clearer)\n\n---\n\nAn alternative might be to do this via special Makefile targets, something I am much less keen on.",
    "created_at": "2019-02-28T14:16:31Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426118",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
I looked a bit into how `./sage -i blah` may trigger a run of `./configure --with-blah=install` - this is not hard, assuming `--with-blah` is a parameter known to configure. E.g. it can grep for it in the output of `./configure -h`, and 
run, if found.

This will require having each package `blah` for which such a configure run is needed to implement the corresponding `--with-blah=`, (or, perhaps, something like
`--install-blah`, to make it even clearer)

---

An alternative might be to do this via special Makefile targets, something I am much less keen on.



---

archive/issue_comments_426119.json:
```json
{
    "body": "<a id='comment:3'></a>\nOn further reflection, it won't fly yet, as it would need to remember the exact parameters used to call `./configure`...\n\nAn easier hack would be to set a flag in the call of `sage -i blah` which would be tested by the spkg-install of `blah` and if it's on, rewrite the corresponding part of\n`src/bin/sage-env-config`. A relatively ugly hack, but looks relatively easy to implement.",
    "created_at": "2019-02-28T17:05:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426119",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
On further reflection, it won't fly yet, as it would need to remember the exact parameters used to call `./configure`...

An easier hack would be to set a flag in the call of `sage -i blah` which would be tested by the spkg-install of `blah` and if it's on, rewrite the corresponding part of
`src/bin/sage-env-config`. A relatively ugly hack, but looks relatively easy to implement.



---

archive/issue_comments_426120.json:
```json
{
    "body": "<a id='comment:4'></a>\nScratch all the above - it's simply the matter of having spkg-install to change ~~`src/bin/sage-env-config`~~ `$SAGE_LOCAL/bin/sage-env-config`.\n\nDoes this look right?\n\nI suppose this fix should be added to #27212, not here...",
    "created_at": "2019-03-01T07:02:32Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426120",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>
Scratch all the above - it's simply the matter of having spkg-install to change ~~`src/bin/sage-env-config`~~ `$SAGE_LOCAL/bin/sage-env-config`.

Does this look right?

I suppose this fix should be added to #27212, not here...



---

archive/issue_comments_426121.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,5 +2,7 @@\n \n Possible fix:\n \n- `sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.\n+`blah/spkg-install` should overwrite the corresponding lines of `src/bin/sage-env-config`. \n \n+~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~\n+\n``````\n",
    "created_at": "2019-03-01T07:02:32Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426121",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,5 +2,7 @@
 
 Possible fix:
 
- `sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.
+`blah/spkg-install` should overwrite the corresponding lines of `src/bin/sage-env-config`. 
 
+~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~
+
``````




---

archive/issue_comments_426122.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,8 +1,8 @@\n-`src/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. \n+`$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. \n \n Possible fix:\n \n-`blah/spkg-install` should overwrite the corresponding lines of `src/bin/sage-env-config`. \n+`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`. \n \n ~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~\n \n``````\n",
    "created_at": "2019-03-01T08:21:27Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426122",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,8 +1,8 @@
-`src/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. 
+`$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. 
 
 Possible fix:
 
-`blah/spkg-install` should overwrite the corresponding lines of `src/bin/sage-env-config`. 
+`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`. 
 
 ~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~
 
``````




---

archive/issue_comments_426123.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [dimpase](#comment%3A4):\n> Scratch all the above - it's simply the matter of having spkg-install to change `src/bin/sage-env-config`.\n> \n> Does this look right?\n> \n> I suppose this fix should be added to #27212, not here...\n\n\nIf you change `src/bin/sage-env-config`, you'll have to re-install it. The one used at runtime is `SAGE_LOCAL/bin/sage-env-config`. The real way to do that is to have individual packages install the environment variable they need and then `sage-env` to read them. Like Erik suggested before. Such variables not being handled by the package themselves just lead to madness just as you are experiencing now.",
    "created_at": "2019-03-01T08:42:30Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426123",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:6'></a>
Replying to [dimpase](#comment%3A4):
> Scratch all the above - it's simply the matter of having spkg-install to change `src/bin/sage-env-config`.
> 
> Does this look right?
> 
> I suppose this fix should be added to #27212, not here...


If you change `src/bin/sage-env-config`, you'll have to re-install it. The one used at runtime is `SAGE_LOCAL/bin/sage-env-config`. The real way to do that is to have individual packages install the environment variable they need and then `sage-env` to read them. Like Erik suggested before. Such variables not being handled by the package themselves just lead to madness just as you are experiencing now.



---

archive/issue_comments_426124.json:
```json
{
    "body": "<a id='comment:7'></a>\nright, I realised it must be `$SAGE_LOCAL/bin/sage-env-config` an hour ago, as you can see from the ticket description. \n\nI don't get the second part of the comment - using a system package instead of Sage-supplied one might affect the environment, and the package responsible for this must take care of this, so that its \"dependees\" know about it. I don't see how `sage-env` is involved (besides that it uses  `sage-env-config`).",
    "created_at": "2019-03-01T09:05:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426124",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
right, I realised it must be `$SAGE_LOCAL/bin/sage-env-config` an hour ago, as you can see from the ticket description. 

I don't get the second part of the comment - using a system package instead of Sage-supplied one might affect the environment, and the package responsible for this must take care of this, so that its "dependees" know about it. I don't see how `sage-env` is involved (besides that it uses  `sage-env-config`).



---

archive/issue_comments_426125.json:
```json
{
    "body": "**Assignee:** @dimpase",
    "created_at": "2019-03-01T11:44:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426125",
    "user": "https://github.com/dimpase"
}
```

**Assignee:** @dimpase



---

archive/issue_comments_426126.json:
```json
{
    "body": "**Author:** Dima Pasechnik",
    "created_at": "2019-03-01T11:44:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426126",
    "user": "https://github.com/dimpase"
}
```

**Author:** Dima Pasechnik



---

archive/issue_comments_426127.json:
```json
{
    "body": "**Commit:** [84736587b00c0e6fdcc26fe094a25dff85a74989](https://github.com/sagemath/sagetrac-mirror/commit/84736587b00c0e6fdcc26fe094a25dff85a74989)",
    "created_at": "2019-03-01T11:52:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426127",
    "user": "https://github.com/dimpase"
}
```

**Commit:** [84736587b00c0e6fdcc26fe094a25dff85a74989](https://github.com/sagemath/sagetrac-mirror/commit/84736587b00c0e6fdcc26fe094a25dff85a74989)



---

archive/issue_events_241762.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-01T11:52:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241762"
}
```



---

archive/issue_comments_426128.json:
```json
{
    "body": "**Branch:** [u/dimpase/packages/gmp-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/gmp-config)",
    "created_at": "2019-03-01T11:52:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426128",
    "user": "https://github.com/dimpase"
}
```

**Branch:** [u/dimpase/packages/gmp-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/gmp-config)



---

archive/issue_comments_426129.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis should do it; I wrote a short sdh_- function to use on #27212 branch and in the other places (and call it).\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c4e42e6e7d76431a8d62a6e2133ce31b3ef43df0\">c4e42e6</a></td><td><code>spkg-configure for GMP</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b0700885b53fe3f0b862ca3000df069ceb7e2340\">b070088</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3b6eebda8df1ae7fbc86f81c0fcf123989504447\">3b6eebd</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b80bf726f85843031b461348944c78a39dae453e\">b80bf72</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ca3f5676d759bc658708f7f0986ceec569f3d51\">0ca3f56</a></td><td><code>fix typo</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06798ca585f1187bd8511a1ca530581028aab99e\">06798ca</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b592d77c204865c293ef473abb7a70ecbaf9e17b\">b592d77</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5057680b1ff2829d1ed0558ef4042472c03c63ae\">5057680</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/101537b93c3343a3e7a8554d8e82d8da36be5691\">101537b</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/84736587b00c0e6fdcc26fe094a25dff85a74989\">8473658</a></td><td><code>sdh_update_var_env_config, call it to update SAGE_GMP_*</code></td></tr></table>\n",
    "created_at": "2019-03-01T11:52:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426129",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
This should do it; I wrote a short sdh_- function to use on #27212 branch and in the other places (and call it).

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c4e42e6e7d76431a8d62a6e2133ce31b3ef43df0">c4e42e6</a></td><td><code>spkg-configure for GMP</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b0700885b53fe3f0b862ca3000df069ceb7e2340">b070088</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3b6eebda8df1ae7fbc86f81c0fcf123989504447">3b6eebd</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b80bf726f85843031b461348944c78a39dae453e">b80bf72</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ca3f5676d759bc658708f7f0986ceec569f3d51">0ca3f56</a></td><td><code>fix typo</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06798ca585f1187bd8511a1ca530581028aab99e">06798ca</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b592d77c204865c293ef473abb7a70ecbaf9e17b">b592d77</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5057680b1ff2829d1ed0558ef4042472c03c63ae">5057680</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/101537b93c3343a3e7a8554d8e82d8da36be5691">101537b</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/84736587b00c0e6fdcc26fe094a25dff85a74989">8473658</a></td><td><code>sdh_update_var_env_config, call it to update SAGE_GMP_*</code></td></tr></table>




---

archive/issue_comments_426130.json:
```json
{
    "body": "<a id='comment:10'></a>\nPlease review the last commit, the rest are from #27212.",
    "created_at": "2019-03-01T11:53:17Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426130",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
Please review the last commit, the rest are from #27212.



---

archive/issue_comments_426131.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis is of course far from ideal, as it makes the actual state of the configuration different from the one obtained after running `./configure`. \n\nI don't know how to reconcile them---it still seems that a better way would be to always call `./configure`, but does it remember the way it was called in the 1st place?",
    "created_at": "2019-03-01T12:07:49Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426131",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
This is of course far from ideal, as it makes the actual state of the configuration different from the one obtained after running `./configure`. 

I don't know how to reconcile them---it still seems that a better way would be to always call `./configure`, but does it remember the way it was called in the 1st place?



---

archive/issue_comments_426132.json:
```json
{
    "body": "<a id='comment:12'></a>\nI can see that there's a problem here, but I don't think the ticket description describes what the problem is very well, but I need to think about it more.\n\nI think ultimately what we want here is if you're changing your package selections it should be necessary to re-run `./configure`.  There's no simple way around that and that's really the only correct solution.\n\nAnother part of the problem is that `./sage -i` never really worked the way you're trying to make it work.  It was mostly only ever for installing optional packages that were not installed by default (but were still *selected* for possible installation in the Makefile generated by configure).",
    "created_at": "2019-03-05T15:08:26Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426132",
    "user": "https://github.com/embray"
}
```

<a id='comment:12'></a>
I can see that there's a problem here, but I don't think the ticket description describes what the problem is very well, but I need to think about it more.

I think ultimately what we want here is if you're changing your package selections it should be necessary to re-run `./configure`.  There's no simple way around that and that's really the only correct solution.

Another part of the problem is that `./sage -i` never really worked the way you're trying to make it work.  It was mostly only ever for installing optional packages that were not installed by default (but were still *selected* for possible installation in the Makefile generated by configure).



---

archive/issue_comments_426133.json:
```json
{
    "body": "<a id='comment:13'></a>\nHow about disabling 'sage -i' for dummy packages?",
    "created_at": "2019-03-05T15:27:38Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426133",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>
How about disabling 'sage -i' for dummy packages?



---

archive/issue_comments_426134.json:
```json
{
    "body": "<a id='comment:14'></a>\nFor lack of a better answer, at the moment, I'd be fine with that.  Just print an error message like \"So and so has been selected to be used from your system; re-run `./configure` with <such and such flags> to use the Sage SPKG instead\".\n\nThe only problem is that for most packages we don't have the appropriate \"<such and such flags>\".  That's been on my to-do list for this since the beginning.  It would be easy to add though, I think.  Have the `SAGE_SPKG_CONFIGURE` macro also generate some `--with-<package>`.  If `--with-<package>=sage` then it would just set `sage_spkg_install_<package>=yes` and skip any system checks for that package.",
    "created_at": "2019-03-05T15:40:26Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426134",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>
For lack of a better answer, at the moment, I'd be fine with that.  Just print an error message like "So and so has been selected to be used from your system; re-run `./configure` with <such and such flags> to use the Sage SPKG instead".

The only problem is that for most packages we don't have the appropriate "<such and such flags>".  That's been on my to-do list for this since the beginning.  It would be easy to add though, I think.  Have the `SAGE_SPKG_CONFIGURE` macro also generate some `--with-<package>`.  If `--with-<package>=sage` then it would just set `sage_spkg_install_<package>=yes` and skip any system checks for that package.



---

archive/issue_comments_426135.json:
```json
{
    "body": "<a id='comment:15'></a>\nThe only try part to that is there are still some special cases like `--with-mp=` which could obviously conflict with that, so additional care might be needed to handle such a conflict, alas.",
    "created_at": "2019-03-05T15:42:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426135",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
The only try part to that is there are still some special cases like `--with-mp=` which could obviously conflict with that, so additional care might be needed to handle such a conflict, alas.



---

archive/issue_comments_426136.json:
```json
{
    "body": "<a id='comment:16'></a>\nIt looks it might be most natural to disallow this undesired building via `./sage -i` by not having Makefile rules to \"really\" build the affected dummy packages - instead the corresponding rules would print an error suggested in comment 14.\n\nThis would also still allow dummy packages which are OK to build via `./sage -i` to retain this possibility.\n\nIf I'm to do such a fix I'd much appreciate some pointers to where to look and what to change...",
    "created_at": "2019-03-08T10:15:41Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426136",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>
It looks it might be most natural to disallow this undesired building via `./sage -i` by not having Makefile rules to "really" build the affected dummy packages - instead the corresponding rules would print an error suggested in comment 14.

This would also still allow dummy packages which are OK to build via `./sage -i` to retain this possibility.

If I'm to do such a fix I'd much appreciate some pointers to where to look and what to change...



---

archive/issue_comments_426137.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe current plan is to setup something like `sage_spkg_freeze_foo` for each package `foo` that is dummy and not `sage -i`-installable, and change `m4/sage_spkg_collect.m4`\nto earmark these packages (e.g. add them to a separate list `SAGE_FROZEN_PACKAGES`, \nand not to `SAGE_DUMMY_PACKAGES`)\n\nNow, for packages in  `SAGE_FROZEN_PACKAGES` one has to generate the correct make targets. I suppose this is to be done in `build/make/Makefile.in`?\n\nDoes this make sense, or do I miss something? What I don't understand at the moment is how e.g. `SAGE_DUMMY_PACKAGES` become `DUMMY_PACKAGES`...",
    "created_at": "2019-03-08T18:18:20Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426137",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
The current plan is to setup something like `sage_spkg_freeze_foo` for each package `foo` that is dummy and not `sage -i`-installable, and change `m4/sage_spkg_collect.m4`
to earmark these packages (e.g. add them to a separate list `SAGE_FROZEN_PACKAGES`, 
and not to `SAGE_DUMMY_PACKAGES`)

Now, for packages in  `SAGE_FROZEN_PACKAGES` one has to generate the correct make targets. I suppose this is to be done in `build/make/Makefile.in`?

Does this make sense, or do I miss something? What I don't understand at the moment is how e.g. `SAGE_DUMMY_PACKAGES` become `DUMMY_PACKAGES`...



---

archive/issue_comments_426138.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0309d8cdaf0af02d5a909000bc91e66aca74c898\">0309d8c</a></td><td><code>spkg-configure for GMP</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8435b90575fcc848003ca4af37f9aa6fda06b97f\">8435b90</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/39072063fb1bf1628e29b9e42e83f1a06d2f7e7b\">3907206</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dcb676d5eb7653ed23376cd287d4dddedf65288e\">dcb676d</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/23209dc3a147301d12775b72ec09f595020c8732\">23209dc</a></td><td><code>fix typo</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4621d18a4c29169f0f2ba015a157910fc52c43c9\">4621d18</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/503655a4e208678f1f27361a4b50df47414dc2ea\">503655a</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/837b38aacd3bb12536584977e096a5b69c1adab8\">837b38a</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/154fed00755a0f4ce399010e79778cc819fd0574\">154fed0</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f218515b64f81b3b7f964a6c46bbe88622797be6\">f218515</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr></table>\n",
    "created_at": "2019-03-08T23:55:52Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426138",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0309d8cdaf0af02d5a909000bc91e66aca74c898">0309d8c</a></td><td><code>spkg-configure for GMP</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8435b90575fcc848003ca4af37f9aa6fda06b97f">8435b90</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/39072063fb1bf1628e29b9e42e83f1a06d2f7e7b">3907206</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dcb676d5eb7653ed23376cd287d4dddedf65288e">dcb676d</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/23209dc3a147301d12775b72ec09f595020c8732">23209dc</a></td><td><code>fix typo</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4621d18a4c29169f0f2ba015a157910fc52c43c9">4621d18</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/503655a4e208678f1f27361a4b50df47414dc2ea">503655a</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/837b38aacd3bb12536584977e096a5b69c1adab8">837b38a</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/154fed00755a0f4ce399010e79778cc819fd0574">154fed0</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f218515b64f81b3b7f964a6c46bbe88622797be6">f218515</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr></table>




---

archive/issue_comments_426139.json:
```json
{
    "body": "**Changing commit** from \"[84736587b00c0e6fdcc26fe094a25dff85a74989](https://github.com/sagemath/sagetrac-mirror/commit/84736587b00c0e6fdcc26fe094a25dff85a74989)\" to \"[f218515b64f81b3b7f964a6c46bbe88622797be6](https://github.com/sagemath/sagetrac-mirror/commit/f218515b64f81b3b7f964a6c46bbe88622797be6)\".",
    "created_at": "2019-03-08T23:55:52Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426139",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[84736587b00c0e6fdcc26fe094a25dff85a74989](https://github.com/sagemath/sagetrac-mirror/commit/84736587b00c0e6fdcc26fe094a25dff85a74989)" to "[f218515b64f81b3b7f964a6c46bbe88622797be6](https://github.com/sagemath/sagetrac-mirror/commit/f218515b64f81b3b7f964a6c46bbe88622797be6)".



---

archive/issue_comments_426140.json:
```json
{
    "body": "<a id='comment:19'></a>\nerror reporting of these failing `sage -i` needs a bit of work still...",
    "created_at": "2019-03-09T00:04:08Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426140",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
error reporting of these failing `sage -i` needs a bit of work still...



---

archive/issue_comments_426141.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,8 +1,20 @@\n `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. \n \n-Possible fix:\n+To deal with this, we introduce a kind of dummy packages, frozen,\n+which differ from dummy so that they cannot be re-installed via\n+`sage -i`, but only via re-running `./configire --with-...` first.\n \n-`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`. \n+Specifically, for gmp and mpir, which are the only freezable packages so far, `./configure --with-mp=system` freezes, them, and\n+`./sage -i gmp` or `./sage -i mpir` errors out.\n+To unfreeze, one needs to do first `./configure --with-mp=gmp` (or `=mpir`).\n+\n+The branch implements this.\n+\n+\n+\n+~~Possible fix:~~\n+\n+~~`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`.~~ \n \n ~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~\n \n``````\n",
    "created_at": "2019-03-09T00:04:08Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426141",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,8 +1,20 @@
 `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. 
 
-Possible fix:
+To deal with this, we introduce a kind of dummy packages, frozen,
+which differ from dummy so that they cannot be re-installed via
+`sage -i`, but only via re-running `./configire --with-...` first.
 
-`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`. 
+Specifically, for gmp and mpir, which are the only freezable packages so far, `./configure --with-mp=system` freezes, them, and
+`./sage -i gmp` or `./sage -i mpir` errors out.
+To unfreeze, one needs to do first `./configure --with-mp=gmp` (or `=mpir`).
+
+The branch implements this.
+
+
+
+~~Possible fix:~~
+
+~~`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`.~~ 
 
 ~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~
 
``````




---

archive/issue_events_241763.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-09T00:07:43Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "rename": {
        "from": "re-installing dummy packages must update sage-env-config",
        "to": "some dummy packages must be only re-installable via ./configure --with-..."
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241763"
}
```



---

archive/issue_comments_426142.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. \n \n-To deal with this, we introduce a kind of dummy packages, frozen,\n-which differ from dummy so that they cannot be re-installed via\n+To deal with this, we introduce a kind of dummy packages, freezable,\n+which differ from dummy so that they (once frozen) cannot be re-installed via\n `sage -i`, but only via re-running `./configire --with-...` first.\n \n Specifically, for gmp and mpir, which are the only freezable packages so far, `./configure --with-mp=system` freezes, them, and\n``````\n",
    "created_at": "2019-03-09T00:07:43Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426142",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir` (or any other dummy package that sets anything in the build environment). Currently this does not happen. This is a bug introduced in #27212 that leads to `sage -i mpir` breaking stuff. 
 
-To deal with this, we introduce a kind of dummy packages, frozen,
-which differ from dummy so that they cannot be re-installed via
+To deal with this, we introduce a kind of dummy packages, freezable,
+which differ from dummy so that they (once frozen) cannot be re-installed via
 `sage -i`, but only via re-running `./configire --with-...` first.
 
 Specifically, for gmp and mpir, which are the only freezable packages so far, `./configure --with-mp=system` freezes, them, and
``````




---

archive/issue_events_241764.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-09T07:28:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241764"
}
```



---

archive/issue_events_241765.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-09T07:28:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241765"
}
```



---

archive/issue_comments_426143.json:
```json
{
    "body": "<a id='comment:21'></a>\nThis totally broke building (`make`, or any `sage -i`), for some reason...",
    "created_at": "2019-03-09T07:28:31Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426143",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>
This totally broke building (`make`, or any `sage -i`), for some reason...



---

archive/issue_comments_426144.json:
```json
{
    "body": "<a id='comment:22'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7\">38120cc</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr></table>\n",
    "created_at": "2019-03-09T10:13:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426144",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7">38120cc</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr></table>




---

archive/issue_comments_426145.json:
```json
{
    "body": "**Changing commit** from \"[f218515b64f81b3b7f964a6c46bbe88622797be6](https://github.com/sagemath/sagetrac-mirror/commit/f218515b64f81b3b7f964a6c46bbe88622797be6)\" to \"[38120ccdce0dd88519ede9a50cede1bbf6cce8a7](https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7)\".",
    "created_at": "2019-03-09T10:13:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426145",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f218515b64f81b3b7f964a6c46bbe88622797be6](https://github.com/sagemath/sagetrac-mirror/commit/f218515b64f81b3b7f964a6c46bbe88622797be6)" to "[38120ccdce0dd88519ede9a50cede1bbf6cce8a7](https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7)".



---

archive/issue_comments_426146.json:
```json
{
    "body": "<a id='comment:23'></a>\nErik, could you please look at the new (\"frozen\") targets I'm trying to add to `build/make/Makefile.in` (see the latest commits on this branch, the loop that populates them is commented out and marked by TODO). I cannot make them work for a reason I don't understand.\n\nThe idea is that FROZEN_PACKAGES, a list that has at most mpir and gmp on, has its NORMAL_PACKAGES targets replaced by `$(error...)`, to provide an intelligent error reporting at `sage -i` attempts on them.\n\nBut it does not work (if uncommented), they always get invoked, at normal `make` runs too, and the build does not go forward. \n\nI don't see what is wrong there (not the least, perhaps, as I still don't quite understand the dummy targets hack, IMHO it deserves more comments in that Makefile.in...)",
    "created_at": "2019-03-09T10:21:05Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426146",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
Erik, could you please look at the new ("frozen") targets I'm trying to add to `build/make/Makefile.in` (see the latest commits on this branch, the loop that populates them is commented out and marked by TODO). I cannot make them work for a reason I don't understand.

The idea is that FROZEN_PACKAGES, a list that has at most mpir and gmp on, has its NORMAL_PACKAGES targets replaced by `$(error...)`, to provide an intelligent error reporting at `sage -i` attempts on them.

But it does not work (if uncommented), they always get invoked, at normal `make` runs too, and the build does not go forward. 

I don't see what is wrong there (not the least, perhaps, as I still don't quite understand the dummy targets hack, IMHO it deserves more comments in that Makefile.in...)



---

archive/issue_comments_426147.json:
```json
{
    "body": "**Changing assignee** from @dimpase to @embray.",
    "created_at": "2019-03-09T10:21:05Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426147",
    "user": "https://github.com/dimpase"
}
```

**Changing assignee** from @dimpase to @embray.



---

archive/issue_events_241766.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-09T10:21:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241766"
}
```



---

archive/issue_events_241767.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-09T10:21:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241767"
}
```



---

archive/issue_comments_426148.json:
```json
{
    "body": "<a id='comment:25'></a>\nIt would be also OK with me to leave this \"meaningful error message\" thing for another ticket, if one cannot fix that makefile quickly...",
    "created_at": "2019-03-09T21:39:57Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426148",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
It would be also OK with me to leave this "meaningful error message" thing for another ticket, if one cannot fix that makefile quickly...



---

archive/issue_comments_426149.json:
```json
{
    "body": "Replying to [ticket:27373 dimpase]:\n> `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir`\n\n\nCan you explain why?",
    "created_at": "2019-03-11T12:07:16Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426149",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:27373 dimpase]:
> `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir`


Can you explain why?



---

archive/issue_comments_426150.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [jdemeyer](#comment%3A26):\n> Replying to [ticket:27373 dimpase]:\n> > `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir`\n\n> \n> Can you explain why?\n\nthis is modulo #27212: if gmp/mpir came from the system then various packages need to know where to find include files and the shared libraries for it.",
    "created_at": "2019-03-11T12:24:50Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426150",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>
Replying to [jdemeyer](#comment%3A26):
> Replying to [ticket:27373 dimpase]:
> > `$SAGE_LOCAL/bin/sage-env-config` must get updated after, say, `sage -i mpir`

> 
> Can you explain why?

this is modulo #27212: if gmp/mpir came from the system then various packages need to know where to find include files and the shared libraries for it.



---

archive/issue_events_241768.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-11T12:34:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241768"
}
```



---

archive/issue_events_241769.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-11T12:34:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241769"
}
```



---

archive/issue_comments_426151.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [dimpase](#comment%3A27):\n> if gmp/mpir came from the system then various packages need to know where to find include files and the shared libraries for it.\n\n\nSure, but the decision of whether or not the package is taken from the system should be made by `./configure`. Doing `sage -i mpir` shouldn't change that. So I still don't understand which problem this ticket is trying to solve.",
    "created_at": "2019-03-11T12:34:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426151",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>
Replying to [dimpase](#comment%3A27):
> if gmp/mpir came from the system then various packages need to know where to find include files and the shared libraries for it.


Sure, but the decision of whether or not the package is taken from the system should be made by `./configure`. Doing `sage -i mpir` shouldn't change that. So I still don't understand which problem this ticket is trying to solve.



---

archive/issue_comments_426152.json:
```json
{
    "body": "<a id='comment:29'></a>\nThe problem is that `sage -i mpir` will break the build if gmp/mpir came from the system. I thought that before #27212 it was working.",
    "created_at": "2019-03-11T13:53:06Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426152",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>
The problem is that `sage -i mpir` will break the build if gmp/mpir came from the system. I thought that before #27212 it was working.



---

archive/issue_comments_426153.json:
```json
{
    "body": "<a id='comment:30'></a>\nWithout this ticket #27212 results in sage -i mpir being installed from sources no matter what.",
    "created_at": "2019-03-11T13:54:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426153",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>
Without this ticket #27212 results in sage -i mpir being installed from sources no matter what.



---

archive/issue_comments_426154.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [dimpase](#comment%3A29):\n> The problem is that `sage -i mpir` will break the build if gmp/mpir came from the system.\n\n\nBut why? I see nothing in `sage-env-config` that would depend on the installation of mpir.",
    "created_at": "2019-03-11T14:05:32Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426154",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:31'></a>
Replying to [dimpase](#comment%3A29):
> The problem is that `sage -i mpir` will break the build if gmp/mpir came from the system.


But why? I see nothing in `sage-env-config` that would depend on the installation of mpir.



---

archive/issue_comments_426155.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [dimpase](#comment%3A30):\n> sage -i mpir being installed from sources no matter what.\n\n\nBut that's a feature. It's the same for other optionally-from-the-system packages.\n\nThe command `sage -i mpir` means \"build the Sage package `mpir`\". I think it's good to have an override for system packages: if I really want the Sage `mpir` package, I would be able to install it with `sage -i mpir`.",
    "created_at": "2019-03-11T14:08:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426155",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:32'></a>
Replying to [dimpase](#comment%3A30):
> sage -i mpir being installed from sources no matter what.


But that's a feature. It's the same for other optionally-from-the-system packages.

The command `sage -i mpir` means "build the Sage package `mpir`". I think it's good to have an override for system packages: if I really want the Sage `mpir` package, I would be able to install it with `sage -i mpir`.



---

archive/issue_comments_426156.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [jdemeyer](#comment%3A31):\n> Replying to [dimpase](#comment%3A29):\n> > The problem is that `sage -i mpir` will break the build if gmp/mpir came from the system.\n\n> \n> But why? I see nothing in `sage-env-config` that would depend on the installation of mpir.\n\n\nThere isn't anything currently but there would be after #27212.  That's what Dima is concerned about.\n\nThe issue is that if you're using MPIR (or any package, really, but let's keep using it as an example), and then you want to do `sage -i mpir` and install the Sage SPKG (which may even be a different version), then it may be necessary to re-configure any other installed packages that depend on mpir; likely rebuild them as well.\n\nThis is a change in the configuration to the system, hence my point earlier that it's thus necessary to re-run Sage's top-level `./configure` script.  Unfortunately what we're missing at the moment (but would be easy to add, and I will do it if Dima hasn't already) is an easy way to tell Sage's `./configure` explicitly that we want to use the SPKG for a given dependency.",
    "created_at": "2019-03-11T14:28:02Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426156",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>
Replying to [jdemeyer](#comment%3A31):
> Replying to [dimpase](#comment%3A29):
> > The problem is that `sage -i mpir` will break the build if gmp/mpir came from the system.

> 
> But why? I see nothing in `sage-env-config` that would depend on the installation of mpir.


There isn't anything currently but there would be after #27212.  That's what Dima is concerned about.

The issue is that if you're using MPIR (or any package, really, but let's keep using it as an example), and then you want to do `sage -i mpir` and install the Sage SPKG (which may even be a different version), then it may be necessary to re-configure any other installed packages that depend on mpir; likely rebuild them as well.

This is a change in the configuration to the system, hence my point earlier that it's thus necessary to re-run Sage's top-level `./configure` script.  Unfortunately what we're missing at the moment (but would be easy to add, and I will do it if Dima hasn't already) is an easy way to tell Sage's `./configure` explicitly that we want to use the SPKG for a given dependency.



---

archive/issue_comments_426157.json:
```json
{
    "body": "<a id='comment:34'></a>\nFor example if you run `sage -i mpir` then it should run\n\n```\n./configure $(./config.status --config) --with-mpir=spkg\n```\n\nwhere `./config.status --config` just prints the flags of the last `./configure` run.\n\nOr something like that.  What we currently lack is the `--with-mpir=spkg` part, or some equivalent that means \"don't check for a system mpir, just build and install the mpir SPKG\".\n\nNo further mucking around with makefiles or anything is required--`./configure` would re-build `build/make/Makefile` with all the correct selections.",
    "created_at": "2019-03-11T14:33:46Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426157",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>
For example if you run `sage -i mpir` then it should run

```
./configure $(./config.status --config) --with-mpir=spkg
```

where `./config.status --config` just prints the flags of the last `./configure` run.

Or something like that.  What we currently lack is the `--with-mpir=spkg` part, or some equivalent that means "don't check for a system mpir, just build and install the mpir SPKG".

No further mucking around with makefiles or anything is required--`./configure` would re-build `build/make/Makefile` with all the correct selections.



---

archive/issue_comments_426158.json:
```json
{
    "body": "<a id='comment:35'></a>\nThanks a lot for those clarifications. I couldn't understand much from the ticket description.\n\nSo it boils down to basically two issues:\n\n1. We need a way to force running `./configure` after installing a particular package. We could re-use the file `\"$SAGE_LOCAL/lib/sage-force-relocate.txt\"` (possibly with a different name) as a trigger for that.\n\n2. We need to ensure that `./configure` treats already-installed packages as not coming from the system. I don't think that we need a `--with-spkg` flag though. `./configure` should auto-detect that `mpir` is already installed.",
    "created_at": "2019-03-11T14:40:13Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426158",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>
Thanks a lot for those clarifications. I couldn't understand much from the ticket description.

So it boils down to basically two issues:

1. We need a way to force running `./configure` after installing a particular package. We could re-use the file `"$SAGE_LOCAL/lib/sage-force-relocate.txt"` (possibly with a different name) as a trigger for that.

2. We need to ensure that `./configure` treats already-installed packages as not coming from the system. I don't think that we need a `--with-spkg` flag though. `./configure` should auto-detect that `mpir` is already installed.



---

archive/issue_comments_426159.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [jdemeyer](#comment%3A35):\n> Thanks a lot for those clarifications. I couldn't understand much from the ticket description.\n> \n> So it boils down to basically two issues:\n> \n> 1. We need a way to force running `./configure` after installing a particular package. We could re-use the file `\"$SAGE_LOCAL/lib/sage-force-relocate.txt\"` (possibly with a different name) as a trigger for that.\n> \n> 2. We need to ensure that `./configure` treats already-installed packages as not coming from the system. I don't think that we need a `--with-spkg` flag though. `./configure` should auto-detect that `mpir` is already installed.\n\n\nI think you might still have things backwards: What I'm proposing is that configure should be re-run *before* installing the SPKG.  That makes it clear, from the Makefile on down, that our build is configured to use the mpir SPKG.  Thus after its installation we should also re-run `make build` to re-build any of its dependencies.\n\nOtherwise you end up in this confusing state where mpir is in the list of \"DUMMY PACKAGES\" and thus not really managed by Sage's makefile, and yet is actually installed by Sage.",
    "created_at": "2019-03-11T14:50:04Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426159",
    "user": "https://github.com/embray"
}
```

<a id='comment:36'></a>
Replying to [jdemeyer](#comment%3A35):
> Thanks a lot for those clarifications. I couldn't understand much from the ticket description.
> 
> So it boils down to basically two issues:
> 
> 1. We need a way to force running `./configure` after installing a particular package. We could re-use the file `"$SAGE_LOCAL/lib/sage-force-relocate.txt"` (possibly with a different name) as a trigger for that.
> 
> 2. We need to ensure that `./configure` treats already-installed packages as not coming from the system. I don't think that we need a `--with-spkg` flag though. `./configure` should auto-detect that `mpir` is already installed.


I think you might still have things backwards: What I'm proposing is that configure should be re-run *before* installing the SPKG.  That makes it clear, from the Makefile on down, that our build is configured to use the mpir SPKG.  Thus after its installation we should also re-run `make build` to re-build any of its dependencies.

Otherwise you end up in this confusing state where mpir is in the list of "DUMMY PACKAGES" and thus not really managed by Sage's makefile, and yet is actually installed by Sage.



---

archive/issue_comments_426160.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [embray](#comment%3A36):\n> I think you might still have things backwards: What I'm proposing is that configure should be re-run *before* installing the SPKG.  That makes it clear, from the Makefile on down, that our build is configured to use the mpir SPKG.\n\n\nI don't really see how the contents of the Sage-the-distribution `Makefile`s should influence the build of mpir. Whether or not mpir is a dummy package shouldn't influence what `sage -i mpir` does: it just runs the build script of mpir.\n\n> Otherwise you end up in this confusing state where mpir is in the list of \"DUMMY PACKAGES\" and thus not really managed by Sage's makefile, and yet is actually installed by Sage.\n\n\nOf course. But I would suggest to run `./configure` *after* building MPIR instead of before. I think that's easier to implement. We actually used to do this for GCC (to implement `SAGE_BUILD_TOOLCHAIN` but that got broken).",
    "created_at": "2019-03-11T15:02:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426160",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>
Replying to [embray](#comment%3A36):
> I think you might still have things backwards: What I'm proposing is that configure should be re-run *before* installing the SPKG.  That makes it clear, from the Makefile on down, that our build is configured to use the mpir SPKG.


I don't really see how the contents of the Sage-the-distribution `Makefile`s should influence the build of mpir. Whether or not mpir is a dummy package shouldn't influence what `sage -i mpir` does: it just runs the build script of mpir.

> Otherwise you end up in this confusing state where mpir is in the list of "DUMMY PACKAGES" and thus not really managed by Sage's makefile, and yet is actually installed by Sage.


Of course. But I would suggest to run `./configure` *after* building MPIR instead of before. I think that's easier to implement. We actually used to do this for GCC (to implement `SAGE_BUILD_TOOLCHAIN` but that got broken).



---

archive/issue_comments_426161.json:
```json
{
    "body": "<a id='comment:38'></a>\nOkay, I think I agree with you--without having actually tried it at least--that you could do things in either order.  To me it makes more sense to re-configure first but if you think it would be easy to do afterwards, and successfully detect that we've installed the Sage SPKG, I'm okay with that too.",
    "created_at": "2019-03-11T15:19:39Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426161",
    "user": "https://github.com/embray"
}
```

<a id='comment:38'></a>
Okay, I think I agree with you--without having actually tried it at least--that you could do things in either order.  To me it makes more sense to re-configure first but if you think it would be easy to do afterwards, and successfully detect that we've installed the Sage SPKG, I'm okay with that too.



---

archive/issue_comments_426162.json:
```json
{
    "body": "**Changing commit** from \"[38120ccdce0dd88519ede9a50cede1bbf6cce8a7](https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7)\" to \"[9f02d15aab404c0c5473c6c3f24da0210375a345](https://github.com/sagemath/sagetrac-mirror/commit/9f02d15aab404c0c5473c6c3f24da0210375a345)\".",
    "created_at": "2019-03-11T16:02:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426162",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[38120ccdce0dd88519ede9a50cede1bbf6cce8a7](https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7)" to "[9f02d15aab404c0c5473c6c3f24da0210375a345](https://github.com/sagemath/sagetrac-mirror/commit/9f02d15aab404c0c5473c6c3f24da0210375a345)".



---

archive/issue_comments_426163.json:
```json
{
    "body": "<a id='comment:39'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b0700885b53fe3f0b862ca3000df069ceb7e2340\">b070088</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3b6eebda8df1ae7fbc86f81c0fcf123989504447\">3b6eebd</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b80bf726f85843031b461348944c78a39dae453e\">b80bf72</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ca3f5676d759bc658708f7f0986ceec569f3d51\">0ca3f56</a></td><td><code>fix typo</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06798ca585f1187bd8511a1ca530581028aab99e\">06798ca</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b592d77c204865c293ef473abb7a70ecbaf9e17b\">b592d77</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5057680b1ff2829d1ed0558ef4042472c03c63ae\">5057680</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/101537b93c3343a3e7a8554d8e82d8da36be5691\">101537b</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/862ca6af87ac256bf726b0bd7ef7439e2d9b0080\">862ca6a</a></td><td><code>Merge remote-tracking branch 'trac/develop' into HEAD</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9f02d15aab404c0c5473c6c3f24da0210375a345\">9f02d15</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr></table>\n",
    "created_at": "2019-03-11T16:02:11Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426163",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b0700885b53fe3f0b862ca3000df069ceb7e2340">b070088</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3b6eebda8df1ae7fbc86f81c0fcf123989504447">3b6eebd</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b80bf726f85843031b461348944c78a39dae453e">b80bf72</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ca3f5676d759bc658708f7f0986ceec569f3d51">0ca3f56</a></td><td><code>fix typo</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06798ca585f1187bd8511a1ca530581028aab99e">06798ca</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b592d77c204865c293ef473abb7a70ecbaf9e17b">b592d77</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5057680b1ff2829d1ed0558ef4042472c03c63ae">5057680</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/101537b93c3343a3e7a8554d8e82d8da36be5691">101537b</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/862ca6af87ac256bf726b0bd7ef7439e2d9b0080">862ca6a</a></td><td><code>Merge remote-tracking branch 'trac/develop' into HEAD</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9f02d15aab404c0c5473c6c3f24da0210375a345">9f02d15</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr></table>




---

archive/issue_comments_426164.json:
```json
{
    "body": "<a id='comment:40'></a>\nRebased. I believe that the way of [comment:34](#comment%3A34) (with ./configure run before or after the build - to me it's more natural before) is implementable via rules in build/make/Makefile.in, but I'd rather have Erik on it.\n\n(Or I can do it, but then I first need more info on the inner working of that .dummy targets...)",
    "created_at": "2019-03-11T16:10:35Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426164",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:40'></a>
Rebased. I believe that the way of [comment:34](#comment%3A34) (with ./configure run before or after the build - to me it's more natural before) is implementable via rules in build/make/Makefile.in, but I'd rather have Erik on it.

(Or I can do it, but then I first need more info on the inner working of that .dummy targets...)



---

archive/issue_comments_426165.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [jdemeyer](#comment%3A37):\n> Replying to [embray](#comment%3A36):\n> > I think you might still have things backwards: What I'm proposing is that configure should be re-run *before* installing the SPKG.  That makes it clear, from the Makefile on down, that our build is configured to use the mpir SPKG.\n\n> \n> I don't really see how the contents of the Sage-the-distribution `Makefile`s should influence the build of mpir. Whether or not mpir is a dummy package shouldn't influence what `sage -i mpir` does: it just runs the build script of mpir.\n> \n> > Otherwise you end up in this confusing state where mpir is in the list of \"DUMMY PACKAGES\" and thus not really managed by Sage's makefile, and yet is actually installed by Sage.\n\n> \n> Of course. But I would suggest to run `./configure` *after* building MPIR instead of before. \n\n\nI don't understand - unless after running ./configure you do make once again.\nBut then what's the point of running ./configure after make, if you can run in before make, and run make just once? \n\n> I think that's easier to implement. We actually used to do this for GCC (to implement `SAGE_BUILD_TOOLCHAIN` but that got broken).\n",
    "created_at": "2019-03-11T18:10:13Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426165",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>
Replying to [jdemeyer](#comment%3A37):
> Replying to [embray](#comment%3A36):
> > I think you might still have things backwards: What I'm proposing is that configure should be re-run *before* installing the SPKG.  That makes it clear, from the Makefile on down, that our build is configured to use the mpir SPKG.

> 
> I don't really see how the contents of the Sage-the-distribution `Makefile`s should influence the build of mpir. Whether or not mpir is a dummy package shouldn't influence what `sage -i mpir` does: it just runs the build script of mpir.
> 
> > Otherwise you end up in this confusing state where mpir is in the list of "DUMMY PACKAGES" and thus not really managed by Sage's makefile, and yet is actually installed by Sage.

> 
> Of course. But I would suggest to run `./configure` *after* building MPIR instead of before. 


I don't understand - unless after running ./configure you do make once again.
But then what's the point of running ./configure after make, if you can run in before make, and run make just once? 

> I think that's easier to implement. We actually used to do this for GCC (to implement `SAGE_BUILD_TOOLCHAIN` but that got broken).




---

archive/issue_comments_426166.json:
```json
{
    "body": "<a id='comment:42'></a>\nIt might help to look at exactly what `sage -i` does (from `src/bin/sage`):\n\n```\n    for PKG in $PACKAGES; do\n        echo\n        # First check that $PKG is actually a Makefile target\n        # See https://trac.sagemath.org/ticket/25078\n        if ! echo \"$ALL_TARGETS\" | grep \"^${PKG}$\" >/dev/null; then\n            echo >&2 \"Error: package '$PKG' not found\"\n            echo >&2 \"Note: if it is an old-style package, use -p instead of -i to install it\"\n            exit 1\n        fi\n        $MAKE SAGE_SPKG=\"sage-spkg $INSTALL_OPTIONS\" \"$PKG\"\n    done\n```\n\nThere are some bits here that obscure things, but ultimately the meat of the command that it's running to install the package is\n\n```\nmake <pkgname>\n```\n\nor to use a real example\n\n```\nmake mpir\n```\n\nIn this case the Makefile target that's *just* the package name itself is a \"phony target\": It does not correspond to a file that is expected to exist (e.g. same as `all` or `clean`).  The thing about phony targets is that when you run them their rules are just followed no matter what (there's no output file to check whether it's already up-to-date).\n\nHowever, phony targets can still have prerequisites, and when running a phony target it will still follow the usual rules of ensuring that all the prerequisites exist and are up-to-date.\n\nIn `build/make/Makefile` the recipes for <pkgname> phony targets are simple and boil down to (in the case of mpir):\n\n```\nmpir: local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0\n```\n\ni.e. the \"stamp file\" that is normally created when an SPKG is installed, indicating that that SPKG is installed and up-to-date.\n\nHowever, if the mpir SPKG was *not* installed (or same for any other package that was not installed by default, such as git), then this file does not exist.  That's because the \"stamp file\" for mpir as far as the rest of the Makefile is concerned is `local/var/lib/sage/installed/.dummy`--just an empty file that is created once (if it doesn't exist) and is otherwise always \"up-to-date\".\n\nMeanwhile, the make recipe for building the real stamp file at `local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0` boils down to (when you strip away some of the noise like `sage-logger`)\n\n```\nsage-spkg mpir\n```\n\nwhich *actually* installs the Sage SPKG, and which also create the \"stamp file\" at `local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0` indicating that now the actual mpir SPKG is installed.\n\nThis is why, as Jeroen pointed out, it's not strictly necessary to re-run `./configure` *first*, because even if mpir is a \"dummy package\" in the Makefile, running `make mpir` will forcibly install the SPKG anyways.\n\nWe still would need to re-run `./configure` afterwards and ensure that when `build/make/Makefile` is re-generated it no longer includes mpir in its list of `DUMMY_PACKAGES`.  If it does, then that's a bug that we need to correct.\n\nIt might be easier to understand the whole thing if `DUMMY_PACKAGES` were called something else like `DEPENDENCIES_THAT_ARE_NOT_NEEDED_OR_ARE_OTHERWISE_SATISFIED_BY_THE_SYSTEM`.",
    "created_at": "2019-03-12T16:43:29Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426166",
    "user": "https://github.com/embray"
}
```

<a id='comment:42'></a>
It might help to look at exactly what `sage -i` does (from `src/bin/sage`):

```
    for PKG in $PACKAGES; do
        echo
        # First check that $PKG is actually a Makefile target
        # See https://trac.sagemath.org/ticket/25078
        if ! echo "$ALL_TARGETS" | grep "^${PKG}$" >/dev/null; then
            echo >&2 "Error: package '$PKG' not found"
            echo >&2 "Note: if it is an old-style package, use -p instead of -i to install it"
            exit 1
        fi
        $MAKE SAGE_SPKG="sage-spkg $INSTALL_OPTIONS" "$PKG"
    done
```

There are some bits here that obscure things, but ultimately the meat of the command that it's running to install the package is

```
make <pkgname>
```

or to use a real example

```
make mpir
```

In this case the Makefile target that's *just* the package name itself is a "phony target": It does not correspond to a file that is expected to exist (e.g. same as `all` or `clean`).  The thing about phony targets is that when you run them their rules are just followed no matter what (there's no output file to check whether it's already up-to-date).

However, phony targets can still have prerequisites, and when running a phony target it will still follow the usual rules of ensuring that all the prerequisites exist and are up-to-date.

In `build/make/Makefile` the recipes for <pkgname> phony targets are simple and boil down to (in the case of mpir):

```
mpir: local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0
```

i.e. the "stamp file" that is normally created when an SPKG is installed, indicating that that SPKG is installed and up-to-date.

However, if the mpir SPKG was *not* installed (or same for any other package that was not installed by default, such as git), then this file does not exist.  That's because the "stamp file" for mpir as far as the rest of the Makefile is concerned is `local/var/lib/sage/installed/.dummy`--just an empty file that is created once (if it doesn't exist) and is otherwise always "up-to-date".

Meanwhile, the make recipe for building the real stamp file at `local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0` boils down to (when you strip away some of the noise like `sage-logger`)

```
sage-spkg mpir
```

which *actually* installs the Sage SPKG, and which also create the "stamp file" at `local/var/lib/sage/installed/mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0` indicating that now the actual mpir SPKG is installed.

This is why, as Jeroen pointed out, it's not strictly necessary to re-run `./configure` *first*, because even if mpir is a "dummy package" in the Makefile, running `make mpir` will forcibly install the SPKG anyways.

We still would need to re-run `./configure` afterwards and ensure that when `build/make/Makefile` is re-generated it no longer includes mpir in its list of `DUMMY_PACKAGES`.  If it does, then that's a bug that we need to correct.

It might be easier to understand the whole thing if `DUMMY_PACKAGES` were called something else like `DEPENDENCIES_THAT_ARE_NOT_NEEDED_OR_ARE_OTHERWISE_SATISFIED_BY_THE_SYSTEM`.



---

archive/issue_comments_426167.json:
```json
{
    "body": "<a id='comment:43'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8435b90575fcc848003ca4af37f9aa6fda06b97f\">8435b90</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/39072063fb1bf1628e29b9e42e83f1a06d2f7e7b\">3907206</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dcb676d5eb7653ed23376cd287d4dddedf65288e\">dcb676d</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/23209dc3a147301d12775b72ec09f595020c8732\">23209dc</a></td><td><code>fix typo</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4621d18a4c29169f0f2ba015a157910fc52c43c9\">4621d18</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/503655a4e208678f1f27361a4b50df47414dc2ea\">503655a</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/837b38aacd3bb12536584977e096a5b69c1adab8\">837b38a</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/154fed00755a0f4ce399010e79778cc819fd0574\">154fed0</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7\">38120cc</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f86e16d723cf7c20e721aa458ce1e0b7bc1ced64\">f86e16d</a></td><td><code>don't mix NORMAL and BUILT, and $(info...) with @echo</code></td></tr></table>\n",
    "created_at": "2019-03-13T00:59:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426167",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8435b90575fcc848003ca4af37f9aa6fda06b97f">8435b90</a></td><td><code>Move all the --with-mp logic into the spkg-configure.m4 for MPIR so that it</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/39072063fb1bf1628e29b9e42e83f1a06d2f7e7b">3907206</a></td><td><code>Replace various --with-gmp=$SAGE_LOCAL flags in spkg-installs with a</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dcb676d5eb7653ed23376cd287d4dddedf65288e">dcb676d</a></td><td><code>Reworked this a bit more</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/23209dc3a147301d12775b72ec09f595020c8732">23209dc</a></td><td><code>fix typo</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4621d18a4c29169f0f2ba015a157910fc52c43c9">4621d18</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/503655a4e208678f1f27361a4b50df47414dc2ea">503655a</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/837b38aacd3bb12536584977e096a5b69c1adab8">837b38a</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/154fed00755a0f4ce399010e79778cc819fd0574">154fed0</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38120ccdce0dd88519ede9a50cede1bbf6cce8a7">38120cc</a></td><td><code>set up frozen packages - only reinstallable via ./configure</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f86e16d723cf7c20e721aa458ce1e0b7bc1ced64">f86e16d</a></td><td><code>don't mix NORMAL and BUILT, and $(info...) with @echo</code></td></tr></table>




---

archive/issue_comments_426168.json:
```json
{
    "body": "**Changing commit** from \"[9f02d15aab404c0c5473c6c3f24da0210375a345](https://github.com/sagemath/sagetrac-mirror/commit/9f02d15aab404c0c5473c6c3f24da0210375a345)\" to \"[f86e16d723cf7c20e721aa458ce1e0b7bc1ced64](https://github.com/sagemath/sagetrac-mirror/commit/f86e16d723cf7c20e721aa458ce1e0b7bc1ced64)\".",
    "created_at": "2019-03-13T00:59:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426168",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9f02d15aab404c0c5473c6c3f24da0210375a345](https://github.com/sagemath/sagetrac-mirror/commit/9f02d15aab404c0c5473c6c3f24da0210375a345)" to "[f86e16d723cf7c20e721aa458ce1e0b7bc1ced64](https://github.com/sagemath/sagetrac-mirror/commit/f86e16d723cf7c20e721aa458ce1e0b7bc1ced64)".



---

archive/issue_comments_426169.json:
```json
{
    "body": "<a id='comment:44'></a>\nThanks, I've got it working. Now an attempt to do `./sage -i gmp` if gmp/mpir was configured to come from the system ends with\n\n```\n***********************************************\n gmp must be installed by re-running \n./configure \n--with-X=gmp first, where X=mp for gmp gmp or mpir, and X=gmp otherwise.\n***********************************************\n```\n\nOne minor nitpick I still need to fix (how?) is to correctly do\n\n```\n@echo ./configure '$(./config.status --config)'\n```\nto show the whole string...",
    "created_at": "2019-03-13T01:05:44Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426169",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:44'></a>
Thanks, I've got it working. Now an attempt to do `./sage -i gmp` if gmp/mpir was configured to come from the system ends with

```
***********************************************
 gmp must be installed by re-running 
./configure 
--with-X=gmp first, where X=mp for gmp gmp or mpir, and X=gmp otherwise.
***********************************************
```

One minor nitpick I still need to fix (how?) is to correctly do

```
@echo ./configure '$(./config.status --config)'
```
to show the whole string...



---

archive/issue_comments_426170.json:
```json
{
    "body": "<a id='comment:45'></a>\n**Branch pushed to git repo; I updated commit sha1.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ca3f5676d759bc658708f7f0986ceec569f3d51\">0ca3f56</a></td><td><code>fix typo</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06798ca585f1187bd8511a1ca530581028aab99e\">06798ca</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b592d77c204865c293ef473abb7a70ecbaf9e17b\">b592d77</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5057680b1ff2829d1ed0558ef4042472c03c63ae\">5057680</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/101537b93c3343a3e7a8554d8e82d8da36be5691\">101537b</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/862ca6af87ac256bf726b0bd7ef7439e2d9b0080\">862ca6a</a></td><td><code>Merge remote-tracking branch 'trac/develop' into HEAD</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7e2b10087c2e81539644d12c0a70cd1a95ea7866\">7e2b100</a></td><td><code>Remove broken SAGE_BUILD_TOOLCHAIN support</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/03dc987c6d475279b0008fa8f5ba37a0045bb75e\">03dc987</a></td><td><code>Merged trac #27215 in</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b472f0f33a46e54bef70b272318923f21d503c84\">b472f0f</a></td><td><code>Merge public/packages/gmp_m4, bump to Sage 8.6.beta7</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/df478e1741c82431c8c5407119194d9012fe5786\">df478e1</a></td><td><code>error message with special-casing MP_LIBRARY</code></td></tr></table>\n",
    "created_at": "2019-03-13T10:17:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426170",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>
**Branch pushed to git repo; I updated commit sha1.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ca3f5676d759bc658708f7f0986ceec569f3d51">0ca3f56</a></td><td><code>fix typo</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06798ca585f1187bd8511a1ca530581028aab99e">06798ca</a></td><td><code>added a bit more explanation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b592d77c204865c293ef473abb7a70ecbaf9e17b">b592d77</a></td><td><code>correct logic for SAGE_GMP_PREFIX etc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5057680b1ff2829d1ed0558ef4042472c03c63ae">5057680</a></td><td><code>add the AX_ABSOLUTE_HEADER macro</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/101537b93c3343a3e7a8554d8e82d8da36be5691">101537b</a></td><td><code>iml in particular is very picky about being given an absolute path to the</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/862ca6af87ac256bf726b0bd7ef7439e2d9b0080">862ca6a</a></td><td><code>Merge remote-tracking branch 'trac/develop' into HEAD</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7e2b10087c2e81539644d12c0a70cd1a95ea7866">7e2b100</a></td><td><code>Remove broken SAGE_BUILD_TOOLCHAIN support</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/03dc987c6d475279b0008fa8f5ba37a0045bb75e">03dc987</a></td><td><code>Merged trac #27215 in</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b472f0f33a46e54bef70b272318923f21d503c84">b472f0f</a></td><td><code>Merge public/packages/gmp_m4, bump to Sage 8.6.beta7</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/df478e1741c82431c8c5407119194d9012fe5786">df478e1</a></td><td><code>error message with special-casing MP_LIBRARY</code></td></tr></table>




---

archive/issue_comments_426171.json:
```json
{
    "body": "**Changing commit** from \"[f86e16d723cf7c20e721aa458ce1e0b7bc1ced64](https://github.com/sagemath/sagetrac-mirror/commit/f86e16d723cf7c20e721aa458ce1e0b7bc1ced64)\" to \"[df478e1741c82431c8c5407119194d9012fe5786](https://github.com/sagemath/sagetrac-mirror/commit/df478e1741c82431c8c5407119194d9012fe5786)\".",
    "created_at": "2019-03-13T10:17:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426171",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[f86e16d723cf7c20e721aa458ce1e0b7bc1ced64](https://github.com/sagemath/sagetrac-mirror/commit/f86e16d723cf7c20e721aa458ce1e0b7bc1ced64)" to "[df478e1741c82431c8c5407119194d9012fe5786](https://github.com/sagemath/sagetrac-mirror/commit/df478e1741c82431c8c5407119194d9012fe5786)".



---

archive/issue_events_241770.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-13T10:27:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241770"
}
```



---

archive/issue_events_241771.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-03-13T10:27:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241771"
}
```



---

archive/issue_comments_426172.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -8,13 +8,11 @@\n `./sage -i gmp` or `./sage -i mpir` errors out.\n To unfreeze, one needs to do first `./configure --with-mp=gmp` (or `=mpir`).\n \n-The branch implements this.\n+The branch implements this. If an attempt is made to run `./configure --with-mp=gmp`, (or any other \"frozen\" package) while Sage is configured with external gmp, one gets the error message\n \n-\n-\n-~~Possible fix:~~\n-\n-~~`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`.~~ \n-\n-~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~\n-\n+```\n+***********************************************\n+ before running ./sage -i/f gmp please run\n+   ./configure <dollar sign>(./config.status --config) --with-mp=gmp\n+***********************************************\n+```\n``````\n",
    "created_at": "2019-03-13T10:27:14Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426172",
    "user": "https://github.com/dimpase"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -8,13 +8,11 @@
 `./sage -i gmp` or `./sage -i mpir` errors out.
 To unfreeze, one needs to do first `./configure --with-mp=gmp` (or `=mpir`).
 
-The branch implements this.
+The branch implements this. If an attempt is made to run `./configure --with-mp=gmp`, (or any other "frozen" package) while Sage is configured with external gmp, one gets the error message
 
-
-
-~~Possible fix:~~
-
-~~`blah/spkg-install` should overwrite the corresponding lines of `$SAGE_LOCAL/bin/sage-env-config`.~~ 
-
-~~`sage -i blah` should run ./configure which (somehow) must ignore whatever one has in `blah/spkg-configure.m4`. E.g. `./configure` must get `--with-blah=` parameter which is by default `system`, but may be changed to `install` or `sage` or something like this.~~
-
+```
+***********************************************
+ before running ./sage -i/f gmp please run
+   ./configure <dollar sign>(./config.status --config) --with-mp=gmp
+***********************************************
+```
``````




---

archive/issue_comments_426173.json:
```json
{
    "body": "**Dependencies:** #27212",
    "created_at": "2019-03-13T10:27:14Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426173",
    "user": "https://github.com/dimpase"
}
```

**Dependencies:** #27212



---

archive/issue_comments_426174.json:
```json
{
    "body": "<a id='comment:46'></a>\nOK, I think I am happy with this branch. Please review. I think it's a reasonable compromise to have a clear error here instead of implementing lots of `--with-...=`\nthings just to cover for a very unlikely case (I hope no-one uses `sage -i` in scripts...).\n\n---\n(one little thing is that I don't know how to print `$` instead of `<dollar sign>` in the error message, please advise if you think this is important enough)",
    "created_at": "2019-03-13T10:27:14Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426174",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:46'></a>
OK, I think I am happy with this branch. Please review. I think it's a reasonable compromise to have a clear error here instead of implementing lots of `--with-...=`
things just to cover for a very unlikely case (I hope no-one uses `sage -i` in scripts...).

---
(one little thing is that I don't know how to print `$` instead of `<dollar sign>` in the error message, please advise if you think this is important enough)



---

archive/issue_events_241772.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-13T10:29:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241772"
}
```



---

archive/issue_events_241773.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-03-13T10:29:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241773"
}
```



---

archive/issue_comments_426175.json:
```json
{
    "body": "<a id='comment:47'></a>\nDima, could you please explain again (preferably in the ticket description) what you're trying to accomplish here, in other words: which problem does this solve? I don't see any good reason why `./sage -i mpir` should be disallowed.",
    "created_at": "2019-03-13T10:29:58Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426175",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>
Dima, could you please explain again (preferably in the ticket description) what you're trying to accomplish here, in other words: which problem does this solve? I don't see any good reason why `./sage -i mpir` should be disallowed.



---

archive/issue_comments_426176.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [jdemeyer](#comment%3A47):\n> Dima, could you please explain again (preferably in the ticket description) what you're trying to accomplish here? I don't see any good reason why `./sage -i mpir` should be disallowed.\n\n\nI think I have explained this once already. The reason for this ticket is that the branch of #27212 introduces a breakage into `./sage -i mpir/gmp`, ASSUMING Sage is configured to use an external `$MP_LIBRARY`. So I am fixing this here.\nAnd it's not really \"disallowed\", it's \"do this and this, then `./sage -i mpir/gmp`\".\n\nIf Sage is configured with its own gmp/mpir then `./sage -i gmp/mpir` will continue to work as before, also with this branch.",
    "created_at": "2019-03-13T10:42:21Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426176",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:48'></a>
Replying to [jdemeyer](#comment%3A47):
> Dima, could you please explain again (preferably in the ticket description) what you're trying to accomplish here? I don't see any good reason why `./sage -i mpir` should be disallowed.


I think I have explained this once already. The reason for this ticket is that the branch of #27212 introduces a breakage into `./sage -i mpir/gmp`, ASSUMING Sage is configured to use an external `$MP_LIBRARY`. So I am fixing this here.
And it's not really "disallowed", it's "do this and this, then `./sage -i mpir/gmp`".

If Sage is configured with its own gmp/mpir then `./sage -i gmp/mpir` will continue to work as before, also with this branch.



---

archive/issue_comments_426177.json:
```json
{
    "body": "<a id='comment:49'></a>\nOK, but I don't like your solution because:\n\n1. It does break `sage -i mpir`\n\n2. It's more complicated than just rerunning `./configure`. In particular, it forces adding a `--with-package` flag for every package for which you want to implement this trick (for GMP/MPIR we already had a `--with-mp` flag but I assume that you want to generalize #27212 to other packages).",
    "created_at": "2019-03-13T10:58:53Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426177",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:49'></a>
OK, but I don't like your solution because:

1. It does break `sage -i mpir`

2. It's more complicated than just rerunning `./configure`. In particular, it forces adding a `--with-package` flag for every package for which you want to implement this trick (for GMP/MPIR we already had a `--with-mp` flag but I assume that you want to generalize #27212 to other packages).



---

archive/issue_comments_426178.json:
```json
{
    "body": "<a id='comment:50'></a>\nWhy did you merge the branch of #27212 in this ticket? Was that intentional?",
    "created_at": "2019-03-13T11:00:02Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426178",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>
Why did you merge the branch of #27212 in this ticket? Was that intentional?



---

archive/issue_comments_426179.json:
```json
{
    "body": "<a id='comment:51'></a>\nActually, you probably don't need to reconfigure at all. In `sage-env-config`, you could just check whether Sage's GMP/MPIR is installed:\n\n```\nif [ -r \"$SAGE_LOCAL/include/gmp.h\" ]; then\n    # Use Sage GMP/MPIR\nelse\n    # Use system GMP/MPIR\nfi\n```",
    "created_at": "2019-03-13T11:07:24Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426179",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>
Actually, you probably don't need to reconfigure at all. In `sage-env-config`, you could just check whether Sage's GMP/MPIR is installed:

```
if [ -r "$SAGE_LOCAL/include/gmp.h" ]; then
    # Use Sage GMP/MPIR
else
    # Use system GMP/MPIR
fi
```



---

archive/issue_comments_426180.json:
```json
{
    "body": "<a id='comment:52'></a>\nReplying to [jdemeyer](#comment%3A50):\n> Why did you merge the branch of #27212 in this ticket? Was that intentional?\n\n\nOf course, there is no point in this ticket without #27212.",
    "created_at": "2019-03-13T11:13:08Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426180",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:52'></a>
Replying to [jdemeyer](#comment%3A50):
> Why did you merge the branch of #27212 in this ticket? Was that intentional?


Of course, there is no point in this ticket without #27212.



---

archive/issue_comments_426181.json:
```json
{
    "body": "<a id='comment:53'></a>\nReplying to [jdemeyer](#comment%3A49):\n> OK, but I don't like your solution because:\n> \n> 1. It does break `sage -i mpir`\n  \n>\nyour proposal, running ./configure after `sage -i mpir`, does not really fly, as `sage -i mpir` triggers a rebuild of its dependencies without proper changes in the environment,\nso the dependencies will get rebuild against the external \"mpir/gmp\".\n\nRunning ./configure before `sage -i mpir`, as Erik proposed, is safer, but needs more of these `--with-foo=` than we currently have.  \n\n> \n> 2. It's more complicated than just rerunning `./configure`. In particular, it forces adding a `--with-package` flag for every package for which you want to implement this trick (for GMP/MPIR we already had a `--with-mp` flag but I assume that you want to generalize #27212 to other packages).\n\n\nYes, but there are not too many packages that modify (or will need to modify) `sage-env-config`.\n\nThese are packages (say, gmp) that for historical or other reasons spawned a cottage industry of custom-installated headers and libraries, so that packages that use then do `--with-gmp=`, or/and `--with-gmp-headers=`...\n\nA list may be compiled by looking at the output of `grep \\\\-with\\\\- $SAGE_ROOT/build/pkgs/*/spkg-install`. I get \nblas/lapack/openblas, cdd(lib), flint, glpk, gmp, mpfr, mpir, isl, ntl, pari, polylib, readline, zlib.\n\nHowever this can be further pruned, as e.g. --with-zlib=$SAGE_LOCAL is harmless, in the sense that if extrenal zlib is used, this option does not break anything.\nIn this sense, despite already allowing several external libraries replacements for the Sage-vendored ones (see #27330, we already can have external bzip2, libffi, lzma, zlib, gf2x, no problems it seems) gmp/mpir are the 1st that really need this special treatment.",
    "created_at": "2019-03-13T11:53:05Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426181",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:53'></a>
Replying to [jdemeyer](#comment%3A49):
> OK, but I don't like your solution because:
> 
> 1. It does break `sage -i mpir`
  
>
your proposal, running ./configure after `sage -i mpir`, does not really fly, as `sage -i mpir` triggers a rebuild of its dependencies without proper changes in the environment,
so the dependencies will get rebuild against the external "mpir/gmp".

Running ./configure before `sage -i mpir`, as Erik proposed, is safer, but needs more of these `--with-foo=` than we currently have.  

> 
> 2. It's more complicated than just rerunning `./configure`. In particular, it forces adding a `--with-package` flag for every package for which you want to implement this trick (for GMP/MPIR we already had a `--with-mp` flag but I assume that you want to generalize #27212 to other packages).


Yes, but there are not too many packages that modify (or will need to modify) `sage-env-config`.

These are packages (say, gmp) that for historical or other reasons spawned a cottage industry of custom-installated headers and libraries, so that packages that use then do `--with-gmp=`, or/and `--with-gmp-headers=`...

A list may be compiled by looking at the output of `grep \\-with\\- $SAGE_ROOT/build/pkgs/*/spkg-install`. I get 
blas/lapack/openblas, cdd(lib), flint, glpk, gmp, mpfr, mpir, isl, ntl, pari, polylib, readline, zlib.

However this can be further pruned, as e.g. --with-zlib=$SAGE_LOCAL is harmless, in the sense that if extrenal zlib is used, this option does not break anything.
In this sense, despite already allowing several external libraries replacements for the Sage-vendored ones (see #27330, we already can have external bzip2, libffi, lzma, zlib, gf2x, no problems it seems) gmp/mpir are the 1st that really need this special treatment.



---

archive/issue_comments_426182.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [jdemeyer](#comment%3A51):\n> Actually, you probably don't need to reconfigure at all. In `sage-env-config`, you could just check whether Sage's GMP/MPIR is installed:\n> \n> ```\n> if [ -r \"$SAGE_LOCAL/include/gmp.h\" ]; then\n>     # Use Sage GMP/MPIR\n> else\n>     # Use system GMP/MPIR\n> fi\n> ```\n\nIf you look at the branch of #27212, at the end of `sage-env-config.in` you will see\n\n```\n# This is usually blank if the system GMP is used, or $SAGE_LOCAL otherwise\nexport SAGE_GMP_PREFIX=\"@SAGE_GMP_PREFIX@\"\nexport SAGE_GMP_INCLUDE=\"@SAGE_GMP_INCLUDE@\"\nif [ -n \"$SAGE_GMP_PREFIX\" ]; then\n    # Many packages that depend on GMP accept a --with-gmp=<prefix> flag to\n    # their ./configure scripts.  When using the system's GMP this is not\n    # generally necessary, but when using the GMP package installed in\n    # SAGE_LOCAL it is useful to pass it.  We define this variable to\n    # pass to these packages' ./configure scripts.  When using the system\n    # GMP its value is just blank (for many of these packages passing\n    # --with-gmp without an argument is actually a bug)\n    export SAGE_CONFIGURE_GMP=\"--with-gmp=$SAGE_GMP_PREFIX\"\nfi\n```\nIn general, these two variables SAGE_GMP_PREFIX, SAGE_GMP_INCLUDE, can be non-empty. Indeed, their values can be overridden by your check. OK, I have to think about it.",
    "created_at": "2019-03-13T12:10:05Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426182",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:54'></a>
Replying to [jdemeyer](#comment%3A51):
> Actually, you probably don't need to reconfigure at all. In `sage-env-config`, you could just check whether Sage's GMP/MPIR is installed:
> 
> ```
> if [ -r "$SAGE_LOCAL/include/gmp.h" ]; then
>     # Use Sage GMP/MPIR
> else
>     # Use system GMP/MPIR
> fi
> ```

If you look at the branch of #27212, at the end of `sage-env-config.in` you will see

```
# This is usually blank if the system GMP is used, or $SAGE_LOCAL otherwise
export SAGE_GMP_PREFIX="@SAGE_GMP_PREFIX@"
export SAGE_GMP_INCLUDE="@SAGE_GMP_INCLUDE@"
if [ -n "$SAGE_GMP_PREFIX" ]; then
    # Many packages that depend on GMP accept a --with-gmp=<prefix> flag to
    # their ./configure scripts.  When using the system's GMP this is not
    # generally necessary, but when using the GMP package installed in
    # SAGE_LOCAL it is useful to pass it.  We define this variable to
    # pass to these packages' ./configure scripts.  When using the system
    # GMP its value is just blank (for many of these packages passing
    # --with-gmp without an argument is actually a bug)
    export SAGE_CONFIGURE_GMP="--with-gmp=$SAGE_GMP_PREFIX"
fi
```
In general, these two variables SAGE_GMP_PREFIX, SAGE_GMP_INCLUDE, can be non-empty. Indeed, their values can be overridden by your check. OK, I have to think about it.



---

archive/issue_comments_426183.json:
```json
{
    "body": "<a id='comment:55'></a>\nReplying to [dimpase](#comment%3A53):\n> `sage -i mpir` triggers a rebuild of its dependencies without proper changes in the environment,\n> so the dependencies will get rebuild against the external \"mpir/gmp\".\n\n\nI'm confused what you mean here: are you talking about dependencies of mpir or packages depending on mpir? `sage -i mpir` installs dependencies of mpir (which is only yasm) but for the dependencies, it doesn't matter how mpir is configured.",
    "created_at": "2019-03-13T14:50:01Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426183",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>
Replying to [dimpase](#comment%3A53):
> `sage -i mpir` triggers a rebuild of its dependencies without proper changes in the environment,
> so the dependencies will get rebuild against the external "mpir/gmp".


I'm confused what you mean here: are you talking about dependencies of mpir or packages depending on mpir? `sage -i mpir` installs dependencies of mpir (which is only yasm) but for the dependencies, it doesn't matter how mpir is configured.



---

archive/issue_comments_426184.json:
```json
{
    "body": "<a id='comment:56'></a>\nIn more detail, probably `sage-env-config` could be modified as follows:\n\n```\nif [ -r \"$SAGE_LOCAL/include/gmp.h\" ]; then\n    # Use Sage GMP/MPIR\n    export SAGE_GMP_PREFIX=\"$SAGE_LOCAL\"\n    export SAGE_GMP_INCLUDE=\"$SAGE_LOCAL\"\nelse\n    # Use system GMP/MPIR\n    export SAGE_GMP_PREFIX=\"@SAGE_GMP_PREFIX@\"\n    export SAGE_GMP_INCLUDE=\"@SAGE_GMP_INCLUDE@\"\nfi\nif [ -n \"$SAGE_GMP_PREFIX\" ]; then\n    # Many packages that depend on GMP accept a --with-gmp=<prefix> flag to\n    # their ./configure scripts.  When using the system's GMP this is not\n    # generally necessary, but when using the GMP package installed in\n    # SAGE_LOCAL it is useful to pass it.  We define this variable to\n    # pass to these packages' ./configure scripts.  When using the system\n    # GMP its value is just blank (for many of these packages passing\n    # --with-gmp without an argument is actually a bug)\n    export SAGE_CONFIGURE_GMP=\"--with-gmp=$SAGE_GMP_PREFIX\"\nfi\n```",
    "created_at": "2019-03-13T14:53:43Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426184",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:56'></a>
In more detail, probably `sage-env-config` could be modified as follows:

```
if [ -r "$SAGE_LOCAL/include/gmp.h" ]; then
    # Use Sage GMP/MPIR
    export SAGE_GMP_PREFIX="$SAGE_LOCAL"
    export SAGE_GMP_INCLUDE="$SAGE_LOCAL"
else
    # Use system GMP/MPIR
    export SAGE_GMP_PREFIX="@SAGE_GMP_PREFIX@"
    export SAGE_GMP_INCLUDE="@SAGE_GMP_INCLUDE@"
fi
if [ -n "$SAGE_GMP_PREFIX" ]; then
    # Many packages that depend on GMP accept a --with-gmp=<prefix> flag to
    # their ./configure scripts.  When using the system's GMP this is not
    # generally necessary, but when using the GMP package installed in
    # SAGE_LOCAL it is useful to pass it.  We define this variable to
    # pass to these packages' ./configure scripts.  When using the system
    # GMP its value is just blank (for many of these packages passing
    # --with-gmp without an argument is actually a bug)
    export SAGE_CONFIGURE_GMP="--with-gmp=$SAGE_GMP_PREFIX"
fi
```



---

archive/issue_comments_426185.json:
```json
{
    "body": "<a id='comment:57'></a>\nI'm testing adding this hack to `sage-env-config.in` on the branch of #27212:\n\n```diff\ndiff --git a/src/bin/sage-env-config.in b/src/bin/sage-env-config.in\nindex aa41ba2241..5be5f9b022 100644\n--- a/src/bin/sage-env-config.in\n+++ b/src/bin/sage-env-config.in\n@@ -36,9 +36,16 @@ if [ \"$SAGE_PYTHON_VERSION\" = 3 ]; then\n     export SAGE_PYTHON3=yes\n fi\n \n-# This is usually blank if the system GMP is used, or $SAGE_LOCAL otherwise\n-export SAGE_GMP_PREFIX=\"@SAGE_GMP_PREFIX@\"\n-export SAGE_GMP_INCLUDE=\"@SAGE_GMP_INCLUDE@\"\n+# This is usually blank if the system GMP is used, or $SAGE_LOCAL otherwise.\n+# Note that here we override the settings obtained by ./configure run,\n+# to allow ./sage -i gmp/mpir to be used, see a discussion on #27373.\n+if [ -r \"$SAGE_LOCAL/include/gmp.h\" ]; then\n+    export SAGE_GMP_PREFIX=\"$SAGE_LOCAL\"\n+    export SAGE_GMP_INCLUDE=\"$SAGE_LOCAL/include\"\n+else # This is usually blank if the system GMP is used\n+    export SAGE_GMP_PREFIX=\"@SAGE_GMP_PREFIX@\"\n+    export SAGE_GMP_INCLUDE=\"@SAGE_GMP_INCLUDE@\"\n+fi\n if [ -n \"$SAGE_GMP_PREFIX\" ]; then\n     # Many packages that depend on GMP accept a --with-gmp=<prefix> flag to\n     # their ./configure scripts.  When using the system's GMP this is not\n```\n\nWhile I expect this to work, this means living with an inconsistency between the configuration as given by `./config.status --config` and the real one, which takes precedence once this patch above is applied.\nA run of ./configure, either with the proper parameters, or allowing it look into `$SAGE_LOCAL`, is needed to fix this inconsistency.\n\nI am uneasy about letting `./configure` look into `$SAGE_LOCAL`, as there could be stale or broken packages there in need of a rebuild, which can trick `./configure`.\n\nAlthough the latter seems attractive going forward, as it would allow pointing not only at `$SAGE_LOCAL`, but at other non-standard locations with goodies ready to be used, too (useful for . This will require adjusting a number of `spkg-configure.m4` files.",
    "created_at": "2019-03-13T14:59:39Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426185",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:57'></a>
I'm testing adding this hack to `sage-env-config.in` on the branch of #27212:

```diff
diff --git a/src/bin/sage-env-config.in b/src/bin/sage-env-config.in
index aa41ba2241..5be5f9b022 100644
--- a/src/bin/sage-env-config.in
+++ b/src/bin/sage-env-config.in
@@ -36,9 +36,16 @@ if [ "$SAGE_PYTHON_VERSION" = 3 ]; then
     export SAGE_PYTHON3=yes
 fi
 
-# This is usually blank if the system GMP is used, or $SAGE_LOCAL otherwise
-export SAGE_GMP_PREFIX="@SAGE_GMP_PREFIX@"
-export SAGE_GMP_INCLUDE="@SAGE_GMP_INCLUDE@"
+# This is usually blank if the system GMP is used, or $SAGE_LOCAL otherwise.
+# Note that here we override the settings obtained by ./configure run,
+# to allow ./sage -i gmp/mpir to be used, see a discussion on #27373.
+if [ -r "$SAGE_LOCAL/include/gmp.h" ]; then
+    export SAGE_GMP_PREFIX="$SAGE_LOCAL"
+    export SAGE_GMP_INCLUDE="$SAGE_LOCAL/include"
+else # This is usually blank if the system GMP is used
+    export SAGE_GMP_PREFIX="@SAGE_GMP_PREFIX@"
+    export SAGE_GMP_INCLUDE="@SAGE_GMP_INCLUDE@"
+fi
 if [ -n "$SAGE_GMP_PREFIX" ]; then
     # Many packages that depend on GMP accept a --with-gmp=<prefix> flag to
     # their ./configure scripts.  When using the system's GMP this is not
```

While I expect this to work, this means living with an inconsistency between the configuration as given by `./config.status --config` and the real one, which takes precedence once this patch above is applied.
A run of ./configure, either with the proper parameters, or allowing it look into `$SAGE_LOCAL`, is needed to fix this inconsistency.

I am uneasy about letting `./configure` look into `$SAGE_LOCAL`, as there could be stale or broken packages there in need of a rebuild, which can trick `./configure`.

Although the latter seems attractive going forward, as it would allow pointing not only at `$SAGE_LOCAL`, but at other non-standard locations with goodies ready to be used, too (useful for . This will require adjusting a number of `spkg-configure.m4` files.



---

archive/issue_comments_426186.json:
```json
{
    "body": "<a id='comment:58'></a>\nWe were writing comments at the same time...",
    "created_at": "2019-03-13T15:01:06Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426186",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:58'></a>
We were writing comments at the same time...



---

archive/issue_comments_426187.json:
```json
{
    "body": "<a id='comment:59'></a>\nReplying to [jdemeyer](#comment%3A56):\n> In more detail, probably `sage-env-config` could be modified as follows:\n\n\nThat isn't necessary or helpful, and only makes things even more confusing.  I agree with you that I'm -1 on this patch as-is, but for different reasons.  My feeling is that rather than error out and tell the user what to do we just do the right thing for them; no big deal.\n\nHowever, what Dima is trying to say is that we already worked out a good scheme for configuring other packages that depend on GMP/MPIR and this uses some variables that are written to `sage-env-config` at configure-time, so it *is* necessary to re-run `configure` either before or after installing a gmp/mpir SPKG.  I just think we should do that automatically.\n\nI also think that the discussion in this ticket is suffering from too many cooks in the kitchen who aren't understanding the fuller picture.  It might help if you understood what's going on in #27212, and if Dima understood everything I wrote in [comment:42](#comment%3A42).",
    "created_at": "2019-03-13T15:31:03Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426187",
    "user": "https://github.com/embray"
}
```

<a id='comment:59'></a>
Replying to [jdemeyer](#comment%3A56):
> In more detail, probably `sage-env-config` could be modified as follows:


That isn't necessary or helpful, and only makes things even more confusing.  I agree with you that I'm -1 on this patch as-is, but for different reasons.  My feeling is that rather than error out and tell the user what to do we just do the right thing for them; no big deal.

However, what Dima is trying to say is that we already worked out a good scheme for configuring other packages that depend on GMP/MPIR and this uses some variables that are written to `sage-env-config` at configure-time, so it *is* necessary to re-run `configure` either before or after installing a gmp/mpir SPKG.  I just think we should do that automatically.

I also think that the discussion in this ticket is suffering from too many cooks in the kitchen who aren't understanding the fuller picture.  It might help if you understood what's going on in #27212, and if Dima understood everything I wrote in [comment:42](#comment%3A42).



---

archive/issue_comments_426188.json:
```json
{
    "body": "<a id='comment:60'></a>\nWould it make sense to close this ticket and discuss everything at #27212? Especially given that these tickets are so tied together, to the point that both tickets contain changes from both tickets.",
    "created_at": "2019-03-13T15:35:31Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426188",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:60'></a>
Would it make sense to close this ticket and discuss everything at #27212? Especially given that these tickets are so tied together, to the point that both tickets contain changes from both tickets.



---

archive/issue_comments_426189.json:
```json
{
    "body": "<a id='comment:61'></a>\nReplying to [embray](#comment%3A59):\n> Replying to [jdemeyer](#comment%3A56):\n> > In more detail, probably `sage-env-config` could be modified as follows:\n\n> \n> That isn't necessary or helpful, and only makes things even more confusing.  I agree with you that I'm -1 on this patch as-is, but for different reasons. \n\n\nTo expand on this more, I don't think any of the `SAGE_FROZEN_PACKAGES` stuff is necessary in the slightest. In fact I don't think solving this problem requires any modifications to the makefile.  All that's necessary is to have `sage -i` re-run configure when appropriate.  This could be handled either by the implementation of `sage -i` itself, or in `spkg-install` (I think the latter might be more appropriate, because it already contains all the machinery to check whether or not we're installing some SPKG for the first time).",
    "created_at": "2019-03-13T15:35:46Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426189",
    "user": "https://github.com/embray"
}
```

<a id='comment:61'></a>
Replying to [embray](#comment%3A59):
> Replying to [jdemeyer](#comment%3A56):
> > In more detail, probably `sage-env-config` could be modified as follows:

> 
> That isn't necessary or helpful, and only makes things even more confusing.  I agree with you that I'm -1 on this patch as-is, but for different reasons. 


To expand on this more, I don't think any of the `SAGE_FROZEN_PACKAGES` stuff is necessary in the slightest. In fact I don't think solving this problem requires any modifications to the makefile.  All that's necessary is to have `sage -i` re-run configure when appropriate.  This could be handled either by the implementation of `sage -i` itself, or in `spkg-install` (I think the latter might be more appropriate, because it already contains all the machinery to check whether or not we're installing some SPKG for the first time).



---

archive/issue_comments_426190.json:
```json
{
    "body": "<a id='comment:62'></a>\nReplying to [jdemeyer](#comment%3A60):\n> Would it make sense to close this ticket and discuss everything at #27212? Especially given that these tickets are so tied together, to the point that both tickets contain changes from both tickets.\n\n\nI wouldn't necessarily close this ticket as the problem it's addressing is a real problem to be solved, even if I don't agree with the proposed solution.  If you have specific comments on #27212 obviously I would make them there.  Though that ticket has already been in pretty good shape for a while now I think, and just needs some final review.  Certainly your thoughts would be appreciated.",
    "created_at": "2019-03-13T15:37:57Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426190",
    "user": "https://github.com/embray"
}
```

<a id='comment:62'></a>
Replying to [jdemeyer](#comment%3A60):
> Would it make sense to close this ticket and discuss everything at #27212? Especially given that these tickets are so tied together, to the point that both tickets contain changes from both tickets.


I wouldn't necessarily close this ticket as the problem it's addressing is a real problem to be solved, even if I don't agree with the proposed solution.  If you have specific comments on #27212 obviously I would make them there.  Though that ticket has already been in pretty good shape for a while now I think, and just needs some final review.  Certainly your thoughts would be appreciated.



---

archive/issue_comments_426191.json:
```json
{
    "body": "<a id='comment:63'></a>\nThe issue of this ticket is not limited to #27212, other tickets in the pipeline suffer from it too. \n\nI am fine with an autoconf-based solution to this one, as opposed to the one on the branch. We can e.g. include in spkg-configure.m4 checks that make targets mentioned in comment 42 are already there, if a new flag to be set up is on. Should I try this?",
    "created_at": "2019-03-13T15:52:31Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426191",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:63'></a>
The issue of this ticket is not limited to #27212, other tickets in the pipeline suffer from it too. 

I am fine with an autoconf-based solution to this one, as opposed to the one on the branch. We can e.g. include in spkg-configure.m4 checks that make targets mentioned in comment 42 are already there, if a new flag to be set up is on. Should I try this?



---

archive/issue_comments_426192.json:
```json
{
    "body": "<a id='comment:64'></a>\nOK, so this is what I'd like to do\n\n* set up a new ./configure parameter `--installed-packages=` that can be empty, or point to `$SAGE_LOCAL`, or to another Sage build tree (maybe outside of $SAGE_ROOT tree). \n* this parameter is checked by `SAGE_SPKG_CONFIGURE`, which needs to be modified. If it's empty, skip to the current behaviour.\n* otherwise, assume the parameter equals DIR. Check that DIR/local/var/lib/sage/installed/SPKG_NAME-SPKG_VERSION exists, if not, skip to the current behaviour.\n* otherwise, ignore all the `--with-SPKG_NAME=` and similar (such as `--with-mp=`) parameters, and use SPKG_NAME from DIR.\n* individual `spkg-configure.m4` typically won't need to do anything new here (but perhaps not always).\n\nThe call to `./sage -i/f SPKG_NAME` will first install `SPKG_NAME` as it currently does, and then call `./configure $(./config.status --config) --installed-packages=$SAGE_LOCAL`.\n\nThe whole thing would have the same effect as `./configure $(./config.status --config) --with-SPKG_NAME=install` (assuming `--with-SPKG_NAME=install` is implemented - it need not be the case) followed by `sage -i/f SPKG_NAME`.\n\nWhat worries me here a bit are the timestamps that will be backwards, as normally `make` is run after `./configure`, not before?\n\n---\n\nWhat's the opinion of the other kitchen chefs on this grand design?",
    "created_at": "2019-03-13T17:23:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426192",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:64'></a>
OK, so this is what I'd like to do

* set up a new ./configure parameter `--installed-packages=` that can be empty, or point to `$SAGE_LOCAL`, or to another Sage build tree (maybe outside of $SAGE_ROOT tree). 
* this parameter is checked by `SAGE_SPKG_CONFIGURE`, which needs to be modified. If it's empty, skip to the current behaviour.
* otherwise, assume the parameter equals DIR. Check that DIR/local/var/lib/sage/installed/SPKG_NAME-SPKG_VERSION exists, if not, skip to the current behaviour.
* otherwise, ignore all the `--with-SPKG_NAME=` and similar (such as `--with-mp=`) parameters, and use SPKG_NAME from DIR.
* individual `spkg-configure.m4` typically won't need to do anything new here (but perhaps not always).

The call to `./sage -i/f SPKG_NAME` will first install `SPKG_NAME` as it currently does, and then call `./configure $(./config.status --config) --installed-packages=$SAGE_LOCAL`.

The whole thing would have the same effect as `./configure $(./config.status --config) --with-SPKG_NAME=install` (assuming `--with-SPKG_NAME=install` is implemented - it need not be the case) followed by `sage -i/f SPKG_NAME`.

What worries me here a bit are the timestamps that will be backwards, as normally `make` is run after `./configure`, not before?

---

What's the opinion of the other kitchen chefs on this grand design?



---

archive/issue_comments_426193.json:
```json
{
    "body": "<a id='comment:65'></a>\nI guess it will take some time to digest properly. Nevertheless, first impressions:\n* I don't like `--installed-packages=` either in name or purpose. From its name I would expect to pass a list of packages rather than a directory. That naming can be fixed. \n* Once you get to the fact that it is a directory, I notice you don't mention the possibility to point it to `/usr` or `/usr/local`. You imply a separate prefix where you install a bunch of packages. That's part of the second limitation, you pass only one directory.\n* That points to the fact that it is not quite the way autotools work, you can pass hints, various detection macro allow you to pass installation prefix - for individual packages. However if you have a system set with something like `lmod` your paths and default flags are supposed to be set properly so that you can detect anything you have loaded in your environment without any hints. That's the way I expect `configure` to work, if it is in my environment, wherever it is, it will be properly detected and set (unless you have done something very wrong and I have a few horror stories to tell about those).\n\nI am not so worried about time stamps and such. The current system already has `make` run `configure` in the first place.",
    "created_at": "2019-03-13T19:49:08Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426193",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:65'></a>
I guess it will take some time to digest properly. Nevertheless, first impressions:
* I don't like `--installed-packages=` either in name or purpose. From its name I would expect to pass a list of packages rather than a directory. That naming can be fixed. 
* Once you get to the fact that it is a directory, I notice you don't mention the possibility to point it to `/usr` or `/usr/local`. You imply a separate prefix where you install a bunch of packages. That's part of the second limitation, you pass only one directory.
* That points to the fact that it is not quite the way autotools work, you can pass hints, various detection macro allow you to pass installation prefix - for individual packages. However if you have a system set with something like `lmod` your paths and default flags are supposed to be set properly so that you can detect anything you have loaded in your environment without any hints. That's the way I expect `configure` to work, if it is in my environment, wherever it is, it will be properly detected and set (unless you have done something very wrong and I have a few horror stories to tell about those).

I am not so worried about time stamps and such. The current system already has `make` run `configure` in the first place.



---

archive/issue_comments_426194.json:
```json
{
    "body": "<a id='comment:66'></a>\nReplying to [fbissey](#comment%3A65):\n> I guess it will take some time to digest properly.\n\n\nTLDR; one needs to reconcile the results of manual running `./sage -i` with the results of `./configure`. At the same time, it would provide a handy way to use Sage packages build out of the tree in a \"trusted\" location, without going through macros checking them (such macros might not work for non-standard locations).\n \n\n> Nevertheless, first impressions:\n> * I don't like `--installed-packages=` either in name or purpose. From its name I would expect to pass a list of packages rather than a directory. That naming can be fixed. \n\n\nsure, how about `--installed-packages_prefix=`?\n\n> * Once you get to the fact that it is a directory, I notice you don't mention the possibility to point it to `/usr` or `/usr/local`. You imply a separate prefix where you install a bunch of packages. That's part of the second limitation, you pass only one directory.\n\n\nThe standard directories are already taken care of by the spkg-configure.m4 macros, but yes, having more then one \"trusted\" $SAGE_LOCAL might be useful.",
    "created_at": "2019-03-13T21:45:37Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426194",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:66'></a>
Replying to [fbissey](#comment%3A65):
> I guess it will take some time to digest properly.


TLDR; one needs to reconcile the results of manual running `./sage -i` with the results of `./configure`. At the same time, it would provide a handy way to use Sage packages build out of the tree in a "trusted" location, without going through macros checking them (such macros might not work for non-standard locations).
 

> Nevertheless, first impressions:
> * I don't like `--installed-packages=` either in name or purpose. From its name I would expect to pass a list of packages rather than a directory. That naming can be fixed. 


sure, how about `--installed-packages_prefix=`?

> * Once you get to the fact that it is a directory, I notice you don't mention the possibility to point it to `/usr` or `/usr/local`. You imply a separate prefix where you install a bunch of packages. That's part of the second limitation, you pass only one directory.


The standard directories are already taken care of by the spkg-configure.m4 macros, but yes, having more then one "trusted" $SAGE_LOCAL might be useful.



---

archive/issue_comments_426195.json:
```json
{
    "body": "<a id='comment:67'></a>\nThis all sounds way overcomplicated to me in order to solve, what, as I've explained, is not a complicated issue.  Now you're throwing into the mix the idea of having multiple arbitrary package installation prefixes.  While I'm not opposed to that necessarily in principle, it's a huge can of worms at not all needed in order to solve this problem.\n\nI haven't really had time to work on this the last couple weeks as I've had higher priorities, but perhaps I can take a crack at solving this issue soon.  I'm certain it doesn't need to get that complicated or difficult.",
    "created_at": "2019-03-18T11:37:48Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426195",
    "user": "https://github.com/embray"
}
```

<a id='comment:67'></a>
This all sounds way overcomplicated to me in order to solve, what, as I've explained, is not a complicated issue.  Now you're throwing into the mix the idea of having multiple arbitrary package installation prefixes.  While I'm not opposed to that necessarily in principle, it's a huge can of worms at not all needed in order to solve this problem.

I haven't really had time to work on this the last couple weeks as I've had higher priorities, but perhaps I can take a crack at solving this issue soon.  I'm certain it doesn't need to get that complicated or difficult.



---

archive/issue_comments_426196.json:
```json
{
    "body": "<a id='comment:68'></a>\nI'd be very glad you you could fix this, especially as this most probably will need changes in your m4 macros.",
    "created_at": "2019-03-18T11:41:22Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426196",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:68'></a>
I'd be very glad you you could fix this, especially as this most probably will need changes in your m4 macros.



---

archive/issue_comments_426197.json:
```json
{
    "body": "<a id='comment:69'></a>\nMoving all my in-progress tickets to 8.8 milestone.",
    "created_at": "2019-03-25T10:43:18Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426197",
    "user": "https://github.com/embray"
}
```

<a id='comment:69'></a>
Moving all my in-progress tickets to 8.8 milestone.



---

archive/issue_events_241774.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:43:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241774"
}
```



---

archive/issue_events_241775.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:43:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241775"
}
```



---

archive/issue_comments_426198.json:
```json
{
    "body": "<a id='comment:70'></a>\nInstead of printing the error (\"what to do\", basically) and bailing out, as the current branch does here, one can exec that \"what to do\". (This amounts to a bit more work than launching `./configure` from make, but should be doable I guess).\n\nAnyhow, I really would like this to move forward, either this or some other way, for currently this ticket basically stalls #27330.",
    "created_at": "2019-04-05T09:23:00Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426198",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:70'></a>
Instead of printing the error ("what to do", basically) and bailing out, as the current branch does here, one can exec that "what to do". (This amounts to a bit more work than launching `./configure` from make, but should be doable I guess).

Anyhow, I really would like this to move forward, either this or some other way, for currently this ticket basically stalls #27330.



---

archive/issue_comments_426199.json:
```json
{
    "body": "<a id='comment:71'></a>\nI plan to work on fixing this next now that #27567 is done (which I may still not even need but I wanted to have it first just in case).\n\nThat said, I may be forgetting something again, but I don't really see how this is a blocker to progressing on #27330.  Yes, it is a bug.  But it's a bug that already exists, and will continue to exist whether or not additional packages get added to configure.\n\nI think it's also not all that severe since it only happens if you do `sage -i <some-standard-spkg>` which is not all that common of a thing to do, and maybe only of particular interest to Sage developers, or users who are having problems using one of their systems' versions of some package.\n\nSo yes it should be fixed ASAP, but I don't personally feel held up by it either.",
    "created_at": "2019-04-05T15:07:51Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426199",
    "user": "https://github.com/embray"
}
```

<a id='comment:71'></a>
I plan to work on fixing this next now that #27567 is done (which I may still not even need but I wanted to have it first just in case).

That said, I may be forgetting something again, but I don't really see how this is a blocker to progressing on #27330.  Yes, it is a bug.  But it's a bug that already exists, and will continue to exist whether or not additional packages get added to configure.

I think it's also not all that severe since it only happens if you do `sage -i <some-standard-spkg>` which is not all that common of a thing to do, and maybe only of particular interest to Sage developers, or users who are having problems using one of their systems' versions of some package.

So yes it should be fixed ASAP, but I don't personally feel held up by it either.



---

archive/issue_comments_426200.json:
```json
{
    "body": "<a id='comment:72'></a>\nwell, it's error-prone to have a bunch of unmerged tickets, it makes reviewing harder, etc. \n\nI am totally with you on it not being severe, and I think a solution provided by the current branch is good enough, but Jeroen has another opinion.\nAnd it's a bug introduced in #27212, so does not really \"exists\" in Sage yet.",
    "created_at": "2019-04-05T15:19:29Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426200",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:72'></a>
well, it's error-prone to have a bunch of unmerged tickets, it makes reviewing harder, etc. 

I am totally with you on it not being severe, and I think a solution provided by the current branch is good enough, but Jeroen has another opinion.
And it's a bug introduced in #27212, so does not really "exists" in Sage yet.



---

archive/issue_comments_426201.json:
```json
{
    "body": "<a id='comment:73'></a>\nThere is a different but related bug with `sage -i` that is independent of any of the `spkg-configure` stuff.\n\nThere is a list in `build/make/Makefile` (that is generated at configure-time) called `OPTIONAL_INSTALLED_PACKAGES`.  This lists packages of type=optional that happen to be installed at the time `configure` is run (which it checks, slightly sloppily, by checking of `local/var/lib/sage/installed/<pkgname>-*` exists; I don't have a better way in mind at the moment).  In a default install built from this ticket it has:\n\n```\n# All optional installed packages (triggers the auto-update)\nOPTIONAL_INSTALLED_PACKAGES = \\\n    python2 \\\n```\n\n(I'm not fond of the fact that python2 is considered an \"optional\" package but that's a different issue.)\n\n\nThis list is used primarily in the `all-sage` target, which ensures that all packges are up-to-date when running `make`--this is usually run as part of the default make target:\n\n```\nall-sage: \\\n                sagelib \\\n                $(STANDARD_PACKAGE_INSTS) \\\n                $(OPTIONAL_INSTALLED_PACKAGE_INSTS) \\\n                $(EXTCODE) \\\n                $(SCRIPTS)\n```\n\nThis ensures that if some package is updated, all of its dependent packages are also updated, including *optional* packages that are not normally part of the `sagelib` dependencies.\n\nHowever, when running `sage -i` on some optional package (for example, I ran `sage -i fricas`) this list is *not* immediately updated.  I can run `make build` all day after `sage -i` and it still won't update.  This is because, of course, `./configure` needs to be re-run.  And after `configure` it should make sense to re-run `make build` as well, since some packages' dependencies might have been updated.",
    "created_at": "2019-04-10T15:26:09Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426201",
    "user": "https://github.com/embray"
}
```

<a id='comment:73'></a>
There is a different but related bug with `sage -i` that is independent of any of the `spkg-configure` stuff.

There is a list in `build/make/Makefile` (that is generated at configure-time) called `OPTIONAL_INSTALLED_PACKAGES`.  This lists packages of type=optional that happen to be installed at the time `configure` is run (which it checks, slightly sloppily, by checking of `local/var/lib/sage/installed/<pkgname>-*` exists; I don't have a better way in mind at the moment).  In a default install built from this ticket it has:

```
# All optional installed packages (triggers the auto-update)
OPTIONAL_INSTALLED_PACKAGES = \
    python2 \
```

(I'm not fond of the fact that python2 is considered an "optional" package but that's a different issue.)


This list is used primarily in the `all-sage` target, which ensures that all packges are up-to-date when running `make`--this is usually run as part of the default make target:

```
all-sage: \
                sagelib \
                $(STANDARD_PACKAGE_INSTS) \
                $(OPTIONAL_INSTALLED_PACKAGE_INSTS) \
                $(EXTCODE) \
                $(SCRIPTS)
```

This ensures that if some package is updated, all of its dependent packages are also updated, including *optional* packages that are not normally part of the `sagelib` dependencies.

However, when running `sage -i` on some optional package (for example, I ran `sage -i fricas`) this list is *not* immediately updated.  I can run `make build` all day after `sage -i` and it still won't update.  This is because, of course, `./configure` needs to be re-run.  And after `configure` it should make sense to re-run `make build` as well, since some packages' dependencies might have been updated.



---

archive/issue_comments_426202.json:
```json
{
    "body": "<a id='comment:74'></a>\nThe other problem is that re-running `configure` after installing, say, `mpir`, doesn't move it from `DUMMY_PACKAGES` to `BUILT_PACKAGES`.\n\nThis should be done in `configure` by checking of the `spkg` is installed (again, if nothing else, by looking for some `local/var/lib/sage/installed/mpir-*`) and forcing `sage_spkg_install_mpir=yes`, skipping all other checks.",
    "created_at": "2019-04-10T16:06:47Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426202",
    "user": "https://github.com/embray"
}
```

<a id='comment:74'></a>
The other problem is that re-running `configure` after installing, say, `mpir`, doesn't move it from `DUMMY_PACKAGES` to `BUILT_PACKAGES`.

This should be done in `configure` by checking of the `spkg` is installed (again, if nothing else, by looking for some `local/var/lib/sage/installed/mpir-*`) and forcing `sage_spkg_install_mpir=yes`, skipping all other checks.



---

archive/issue_comments_426203.json:
```json
{
    "body": "<a id='comment:75'></a>\nI think I've got something almost working.  It's got another prerequisite ticket but I'll post it tomorrow.",
    "created_at": "2019-04-10T17:19:10Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426203",
    "user": "https://github.com/embray"
}
```

<a id='comment:75'></a>
I think I've got something almost working.  It's got another prerequisite ticket but I'll post it tomorrow.



---

archive/issue_comments_426204.json:
```json
{
    "body": "<a id='comment:76'></a>\nSee #27641 for the next bit of prerequisite work needed to fix this.  I will shortly be adding another ticket with an actual attempt at a fix.",
    "created_at": "2019-04-11T10:40:55Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426204",
    "user": "https://github.com/embray"
}
```

<a id='comment:76'></a>
See #27641 for the next bit of prerequisite work needed to fix this.  I will shortly be adding another ticket with an actual attempt at a fix.



---

archive/issue_comments_426205.json:
```json
{
    "body": "<a id='comment:77'></a>\nTickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426205",
    "user": "https://github.com/embray"
}
```

<a id='comment:77'></a>
Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_events_241776.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241776"
}
```



---

archive/issue_events_241777.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241777"
}
```



---

archive/issue_events_241778.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-09-07T20:38:19Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241778"
}
```



---

archive/issue_events_241779.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-09-07T20:38:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241779"
}
```



---

archive/issue_events_241780.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-09-07T20:38:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241780"
}
```



---

archive/issue_comments_426206.json:
```json
{
    "body": "<a id='comment:79'></a>\nWhy the change of status?  Is this fixed / a non-issue now?",
    "created_at": "2019-09-11T09:38:36Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426206",
    "user": "https://github.com/embray"
}
```

<a id='comment:79'></a>
Why the change of status?  Is this fixed / a non-issue now?



---

archive/issue_comments_426207.json:
```json
{
    "body": "<a id='comment:80'></a>\nProbably this should become a task, I don't now.\nSo far I haven't heard any reports that this is a real issue...",
    "created_at": "2019-09-11T10:19:59Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426207",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:80'></a>
Probably this should become a task, I don't now.
So far I haven't heard any reports that this is a real issue...



---

archive/issue_comments_426208.json:
```json
{
    "body": "<a id='comment:81'></a>\nI think it my still be an issue but I should investigate.  I have heard some stray reports of people building sage with `--with-python=3` and then having everything get messed up as soon as they install an optional package or something.",
    "created_at": "2019-09-18T11:24:25Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426208",
    "user": "https://github.com/embray"
}
```

<a id='comment:81'></a>
I think it my still be an issue but I should investigate.  I have heard some stray reports of people building sage with `--with-python=3` and then having everything get messed up as soon as they install an optional package or something.



---

archive/issue_events_241781.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-09-18T11:24:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241781"
}
```



---

archive/issue_events_241782.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-09-18T11:24:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241782"
}
```



---

archive/issue_events_241783.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-09-18T11:24:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "bug",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241783"
}
```



---

archive/issue_events_241784.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-09-18T11:24:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241784"
}
```



---

archive/issue_comments_426209.json:
```json
{
    "body": "<a id='comment:82'></a>\nI think this will just be a special case of #29113 (Reimplement `sage -i SPKG` as `configure --enable-SPKG && make build`).",
    "created_at": "2020-02-07T21:50:46Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426209",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:82'></a>
I think this will just be a special case of #29113 (Reimplement `sage -i SPKG` as `configure --enable-SPKG && make build`).



---

archive/issue_comments_426210.json:
```json
{
    "body": "<a id='comment:83'></a>\nfurther work on this to continue on #29113",
    "created_at": "2020-02-08T09:23:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426210",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:83'></a>
further work on this to continue on #29113



---

archive/issue_events_241785.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-02-08T09:23:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241785"
}
```



---

archive/issue_comments_426211.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2020-02-08T09:23:12Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426211",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_events_241786.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-02-08T09:23:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "needs info",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241786"
}
```



---

archive/issue_events_241787.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-02-08T09:23:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241787"
}
```



---

archive/issue_events_241788.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-10-11T16:54:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "duplicate",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241788"
}
```



---

archive/issue_events_241789.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-10-11T16:54:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241789"
}
```



---

archive/issue_events_241790.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-10-11T16:54:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/27373#event-241790"
}
```



---

archive/issue_comments_426212.json:
```json
{
    "body": "**Changing commit** from \"[df478e1741c82431c8c5407119194d9012fe5786](https://github.com/sagemath/sagetrac-mirror/commit/df478e1741c82431c8c5407119194d9012fe5786)\" to \"\".",
    "created_at": "2020-10-11T16:55:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426212",
    "user": "https://github.com/slel"
}
```

**Changing commit** from "[df478e1741c82431c8c5407119194d9012fe5786](https://github.com/sagemath/sagetrac-mirror/commit/df478e1741c82431c8c5407119194d9012fe5786)" to "".



---

archive/issue_comments_426213.json:
```json
{
    "body": "**Changing author** from \"Dima Pasechnik\" to \"\".",
    "created_at": "2020-10-11T16:55:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426213",
    "user": "https://github.com/slel"
}
```

**Changing author** from "Dima Pasechnik" to "".



---

archive/issue_comments_426214.json:
```json
{
    "body": "**Changing branch** from \"[u/dimpase/packages/gmp-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/gmp-config)\" to \"\".",
    "created_at": "2020-10-11T16:55:28Z",
    "issue": "https://github.com/sagemath/sage/issues/27373",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/27373#issuecomment-426214",
    "user": "https://github.com/slel"
}
```

**Changing branch** from "[u/dimpase/packages/gmp-config](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/gmp-config)" to "".
