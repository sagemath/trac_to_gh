# Issue 30280: MemoryError in doctesting combinat/designs/gen_quadrangles_with_spread.pyx

Issue created by migration from https://trac.sagemath.org/ticket/30517

Original creator: strogdon

Original creation time: 2020-09-06 15:38:00

CC:  dimpase @ivo-maffei

Keywords: generalised_quadrangle

There are numerous `MemoryError` instances in doctesting `gen_quadrangles_with_spread.pyx` with a final failure

```
----------------------------------------------------------------------
sage -t --long --warn-long 127.5 --random-seed=0 src/sage/combinat/designs/gen_quadrangles_with_spread.pyx  # Bad exit: 1
----------------------------------------------------------------------
Total time for all tests: 108.3 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```



---

Attachment


---

Comment by strogdon created at 2020-09-06 15:40:50

log of failed doctest


---

Comment by strogdon created at 2020-09-06 17:18:22

I ran every command in `gen_quadrangles_with_spread.pyx` from the sage prompt without a problem. I'm wondering if there is some weird interaction with the doctesting framework - like memory not being cleared?


---

Comment by strogdon created at 2020-09-07 06:19:47

The above [test.log](https://trac.sagemath.org/attachment/ticket/30517/gen_quadrangles_with_spread.pyx_test.log) was with `9.2.beta11` which uses `python3.7`. `9.2.beta12` uses `python3.8` and the failure is more catastrophic. I will attach the full doctest with stack and cython backtraces. The doctest consumes about 2 GB of RAM before quitting. I have about 8 GB of total RAM. I do not have debugging symbols compiled in libraries. Doing that would require a significant effort.


---

Comment by strogdon created at 2020-09-07 06:26:18

full doctest using 9.2.beta12 with stack and cython backtraces


---

Attachment


---

Comment by fbissey created at 2020-09-07 20:46:12

Was this with gcc 9 or 10?


---

Comment by strogdon created at 2020-09-07 20:47:18

With these changes

```diff
diff --git a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
index 753d935e86..a8c1be9f09 100644
--- a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
+++ b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
@@ -198,10 +198,6 @@ def dual_GQ_ovoid(GQ, O):
         sage: t[0].is_generalized_quadrangle(parameters=True)
         (9, 3)
         sage: t = dual_GQ_ovoid(*t)
-        sage: t[0].is_generalized_quadrangle(parameters=True)
-        (3, 9)
-        sage: all([x in t[0] for x in t[1]])
-        True
 
 
     TESTS::
@@ -271,8 +267,6 @@ def generalised_quadrangle_hermitian_with_ovoid(const int q):
               is_GQ_with_spread, dual_GQ_ovoid
         sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)
         sage: t = dual_GQ_ovoid(*t)
-        sage: is_GQ_with_spread(*t, s=3, t=9)
-        True
```


I get no `MemoryError` and the doctest passes.


---

Comment by strogdon created at 2020-09-07 20:48:52

Replying to [comment:6 fbissey]:
> Was this with gcc 9 or 10?
This was with gcc 9. But I get the same result with gcc 10.


---

Comment by fbissey created at 2020-09-07 20:55:01

Replying to [comment:7 strogdon]:
> With these changes
> {{{
> #!diff
> diff --git a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> index 753d935e86..a8c1be9f09 100644
> --- a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> +++ b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> `@``@` -198,10 +198,6 `@``@` def dual_GQ_ovoid(GQ, O):
>          sage: t[0].is_generalized_quadrangle(parameters=True)
>          (9, 3)
>          sage: t = dual_GQ_ovoid(*t)
> -        sage: t[0].is_generalized_quadrangle(parameters=True)
> -        (3, 9)
> -        sage: all([x in t[0] for x in t[1]])
> -        True
>  
>  
>      TESTS::
> `@``@` -271,8 +267,6 `@``@` def generalised_quadrangle_hermitian_with_ovoid(const int q):
>                is_GQ_with_spread, dual_GQ_ovoid
>          sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)
>          sage: t = dual_GQ_ovoid(*t)
> -        sage: is_GQ_with_spread(*t, s=3, t=9)
> -        True
> }}}
> 
> I get no `MemoryError` and the doctest passes.

In the first part of the diff, you are removing two tests. I am assuming that means that they would fail individually without the other one being present. Is it the case?

The fact that you could run all the command individually without problem means the environment has to be "primed". There is probably a memory leak somewhere that leads to that particular outcome. Finding the leak may not be obvious.


---

Comment by strogdon created at 2020-09-07 21:03:04

Replying to [comment:9 fbissey]:
> Replying to [comment:7 strogdon]:
> > With these changes
> > {{{
> > #!diff
> > diff --git a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> > index 753d935e86..a8c1be9f09 100644
> > --- a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> > +++ b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> > `@``@` -198,10 +198,6 `@``@` def dual_GQ_ovoid(GQ, O):
> >          sage: t[0].is_generalized_quadrangle(parameters=True)
> >          (9, 3)
> >          sage: t = dual_GQ_ovoid(*t)
> > -        sage: t[0].is_generalized_quadrangle(parameters=True)
> > -        (3, 9)
> > -        sage: all([x in t[0] for x in t[1]])
> > -        True
> >  
> >  
> >      TESTS::
> > `@``@` -271,8 +267,6 `@``@` def generalised_quadrangle_hermitian_with_ovoid(const int q):
> >                is_GQ_with_spread, dual_GQ_ovoid
> >          sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)
> >          sage: t = dual_GQ_ovoid(*t)
> > -        sage: is_GQ_with_spread(*t, s=3, t=9)
> > -        True
> > }}}
> > 
> > I get no `MemoryError` and the doctest passes.
> 
> In the first part of the diff, you are removing two tests. I am assuming that means that they would fail individually without the other one being present. Is it the case?
> 
> The fact that you could run all the command individually without problem means the environment has to be "primed". There is probably a memory leak somewhere that leads to that particular outcome. Finding the leak may not be obvious.

I don't know if removing just the first test in the first part of the diff would be sufficient to fix things. I can try just removing the first test. It appeared to me that perhaps `t = dual_GQ_ovoid(*t)` was tainted so I removed the second test also. This may be incorrect.

But I do think you are correct in that there is a possible memory leak.


---

Comment by dimpase created at 2020-09-07 21:09:58

I've cc'd the author, Ivo.


---

Comment by strogdon created at 2020-09-07 21:10:31

This also works

```diff
diff --git a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
index 753d935e86..23ec4b3a84 100644
--- a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
+++ b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
@@ -198,8 +198,6 @@ def dual_GQ_ovoid(GQ, O):
         sage: t[0].is_generalized_quadrangle(parameters=True)
         (9, 3)
         sage: t = dual_GQ_ovoid(*t)
-        sage: t[0].is_generalized_quadrangle(parameters=True)
-        (3, 9)
         sage: all([x in t[0] for x in t[1]])
         True
 
@@ -271,8 +269,6 @@ def generalised_quadrangle_hermitian_with_ovoid(const int q):
               is_GQ_with_spread, dual_GQ_ovoid
         sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)
         sage: t = dual_GQ_ovoid(*t)
-        sage: is_GQ_with_spread(*t, s=3, t=9)
-        True
         sage: t = dual_GQ_ovoid(*(
         ....: designs.generalised_quadrangle_hermitian_with_ovoid(2)))
```



---

Comment by strogdon created at 2020-09-07 21:11:53

I didn't mean to remove the Cc


---

Comment by @Ivo-Maffei created at 2020-09-08 09:36:09

`is_GQ_with_spread` internally calls `is_generalized_quadrangle`, so the issue lies in the first removed doctest.
In #30223 we had a similar issue with `is_generalized_quadrangle` which was called on an incidence structure not manipulated with `dual_GQ_ovoid`, so I'm keen to assume that `dual_GQ_ovoid` is not the cause of the issue.

I can't reproduce the `MemoryError` on my machine so I created a test-function whose doctests should pretty much cover all operations done in `is_generalised_quadrangle`. Could you please run the doctests and let me know all lines (if any) that fail?
----
New commits:


---

Comment by dimpase created at 2020-09-08 14:14:30

we should improve `is_generalized_quadrangle`.


there is no need to construct the incidence graph. In the regular+uniform  case, i.e. if (s,t) are defined, just check that the collinearity graph (aka block graph) is s.r.g. with the correct parameters.

Otherwise,
if neither s nor t are defined, it is not a GQ, for either t or s must be 1. To finish, if s is not 1, take the dual, so now s=1, and the collinearity graph must be complete bipartite.


---

Comment by @Ivo-Maffei created at 2020-09-08 15:38:23

Replying to [comment:15 dimpase]:
> there is no need to construct the incidence graph. In the regular+uniform  case, i.e. if (s,t) are defined, just check that the collinearity graph (aka block graph) is s.r.g. with the correct parameters.
I understand that the collinearity graph of a GQ is a srg, but I'm uncertain about the converse.
In particular, there are many difference incidence structures that have the same collinearity graph.
If we allow duplicate blocks, then an incidence structure which is a regular GQ with a duplicated block is no more a GQ, but its collinearity graph is the same. Perhaps this is just an edge-case and not allowing duplicate blocks would fix the converse, but I'm not sure.

> Otherwise,
> if neither s nor t are defined, it is not a GQ
I don't see why this would be the case, but I trust you.
Also you say that if s is not defined, then t must be 1 and vice versa?

> now s=1, and the collinearity graph must be complete bipartite.
Consider the incidence structure with blocks `[[1, 2], [2, 3]]`.
Then s = 1 and t is not defined.
Its collinearity graph has edges `[(1, 2), (2, 3)]` which is complete bipartite K_{2, 1}, but the incidence structure is not a GQ.
I think that more generally complete bipartite K_{n, 1} are not GQ, is this right?


---

Attachment

These are the failures I get with the added tests in `test()`


---

Comment by dimpase created at 2020-09-08 17:32:52

Replying to [comment:16 gh-Ivo-Maffei]:
> Replying to [comment:15 dimpase]:
> > there is no need to construct the incidence graph. In the regular+uniform  case, i.e. if (s,t) are defined, just check that the collinearity graph (aka block graph) is s.r.g. with the correct parameters.
> I understand that the collinearity graph of a GQ is a srg, but I'm uncertain about the converse.
> In particular, there are many difference incidence structures that have the same collinearity graph.
> If we allow duplicate blocks, then an incidence structure which is a regular GQ with a duplicated block is no more a GQ, but its collinearity graph is the same. Perhaps this is just an edge-case and not allowing duplicate blocks would fix the converse, but I'm not sure.
> 
> > Otherwise,
> > if neither s nor t are defined, it is not a GQ
> I don't see why this would be the case, but I trust you.
> Also you say that if s is not defined, then t must be 1 and vice versa?
> 
> > now s=1, and the collinearity graph must be complete bipartite.
> Consider the incidence structure with blocks `[[1, 2], [2, 3]]`.
> Then s = 1 and t is not defined.
> Its collinearity graph has edges `[(1, 2), (2, 3)]` which is complete bipartite K_{2, 1}, but the incidence structure is not a GQ.
> I think that more generally complete bipartite K_{n, 1} are not GQ, is this right?

right, these are so called degenerate generalised polygons (a number of lines all intersecting in one point). Usually, but not excluded from the definition. Let's exclude this case.

We should also exclude the case of repeated lines.


Note that it is immediate (there cannot be any triangls, but for any point p and line L not on L there is a point collinear on L collinear to p) from the definition of a generalised quadrangle that two non-intersecting lines have the same size. 
Dually, for any 2 non-collinear points the number of lines on each of then must be the same.  

It follows that there are either lines of two different sizes, and you have a "grid" (just 2 lines on each point, so t=1), or all lines are of the same size.


---

Comment by dimpase created at 2020-09-08 17:38:00

Doesn't

```
Using --optional=build,dochtml,memlimit,sage
```

mean that tests limit memory in some way?


---

Attachment

Tests in https://trac.sagemath.org/attachment/ticket/30517/quadrangles_with_spread.pyx_newtest.log may be contaminated by prior failures. Attached are results of just the tests in `test()`


---

Comment by strogdon created at 2020-09-08 18:16:18

Replying to [comment:18 dimpase]:
> Doesn't
> {{{
> Using --optional=build,dochtml,memlimit,sage
> }}}
> mean that tests limit memory in some way?
This

```
Testing files:

  -t [options] <files|dir> -- test examples in .py, .pyx, .sage
                              or .tex files.  Options:
     --long           -- include lines with the phrase 'long time'
     --verbose        -- print debugging output during the test
     --all            -- test all files
     --optional       -- also test all examples labeled "# optional"
```

seems to imply relative to doctesting that files so marked will also be tested. Not sure what the `Using --optional=...` implies, nor do I know how to change it.


---

Comment by dimpase created at 2020-09-08 19:03:48

It seems from reading `src/bin/sage-runtests` that the default, if there is `memlimit` in
`--optional`, is 3300 MB "per test"


---

Comment by strogdon created at 2020-09-08 19:28:02

Replying to [comment:20 dimpase]:
> It seems from reading `src/bin/sage-runtests` that the default, if there is `memlimit` in
> `--optional`, is 3300 MB "per test"
Well, isn't that interesting. Doing

```
./sage -t --long --verbose --warn-long 127.5 --random-seed=0 --memlimit=0 src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
```

gives no failing tests. When I use `memlimit=0` then `memlimit` does not appear

```
Using --optional=build,dochtml,sage
```

What do you have in your `Using` line and how are the `--optional` items set? Is this really the issue?


---

Comment by dimpase created at 2020-09-08 20:27:13

Replying to [comment:21 strogdon]:

> {{{
> Using --optional=build,dochtml,sage
> }}}
> What do you have in your `Using` line and how are the `--optional` items set? Is this really the issue?

that was just a copy/paste from the log you attached here. By default `memlimit` is there.

It could be just few memory-hungry tests run in parallel, and not a memory leak.


---

Comment by vbraun created at 2021-01-31 15:12:40

This almost always runs out of memory on the kucalc buildbot:

```
sage: from sage.combinat.designs.gen_quadrangles_with_spread import is_GQ_with_spread, dual_GQ_ovoid ## line 270 ##
sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3) ## line 272 ##
sage: t = dual_GQ_ovoid(*t) ## line 273 ##
sage: is_GQ_with_spread(*t, s=3, t=9) ## line 274 ##

**********************************************************************
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/combinat/designs/gen_quadrangles_with_spread.pyx  # Bad exit: 1
----------------------------------------------------------------------
```

For example, running the last `is_GQ_with_spread` command eats about 170Mb per invocation that is never released.


---

Comment by vbraun created at 2021-01-31 15:20:08

Replying to [comment:7 strogdon]:
> With these changes
> {{{
> #!diff
> diff --git a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> index 753d935e86..a8c1be9f09 100644
> --- a/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> +++ b/src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
> `@``@` -198,10 +198,6 `@``@` def dual_GQ_ovoid(GQ, O):
>          sage: t[0].is_generalized_quadrangle(parameters=True)
>          (9, 3)
>          sage: t = dual_GQ_ovoid(*t)
> -        sage: t[0].is_generalized_quadrangle(parameters=True)
> -        (3, 9)
> -        sage: all([x in t[0] for x in t[1]])
> -        True
>  
>  
>      TESTS::
> `@``@` -271,8 +267,6 `@``@` def generalised_quadrangle_hermitian_with_ovoid(const int q):
>                is_GQ_with_spread, dual_GQ_ovoid
>          sage: t = designs.generalised_quadrangle_hermitian_with_ovoid(3)
>          sage: t = dual_GQ_ovoid(*t)
> -        sage: is_GQ_with_spread(*t, s=3, t=9)
> -        True
> }}}
> 
> I get no `MemoryError` and the doctest passes.

If you want to tag those up as `# known bug` I'll be happy to review


---

Comment by git created at 2021-01-31 16:25:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-01-31 16:25:46

I have added a commit on top of the public branch, just adding the 3 suggested known bug tags


---

Comment by strogdon created at 2021-01-31 16:39:14

Replying to [comment:27 chapoton]:
> I have added a commit on top of the public branch, just adding the 3 suggested known bug tags 
Is the `def test()` function needed?


---

Comment by chapoton created at 2021-01-31 16:57:14

I have not idea. Feel free to remove it and squash the branch if you think this is better.


---

Comment by @Ivo-Maffei created at 2021-01-31 19:37:24

Replying to [comment:28 strogdon]:
> Is the `def test()` function needed?
`def test()` is a function I added it in [comment:14 here] to help debug the issue. I guess it can go now that vbraun found the problem.


---

Comment by dimpase created at 2021-01-31 20:38:32

Replying to [comment:30 gh-Ivo-Maffei]:
> Replying to [comment:28 strogdon]:
> > Is the `def test()` function needed?
> `def test()` is a function I added it in [comment:14 here] to help debug the issue. I guess it can go now that vbraun found the problem.

well, not that Volker found the problem, he found a test to disable to avoid this doctesting issue.


---

Comment by git created at 2021-01-31 20:46:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-01-31 20:47:09

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-01-31 20:47:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-01-31 20:50:53

Followup for the underlying issue at #31313


---

Comment by git created at 2021-02-03 06:29:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-02-03 06:29:48

Changing status from positive_review to needs_review.


---

Comment by @DaveWitteMorris created at 2021-02-03 06:33:45

The memory leak was fixed at #31313, so I removed the "known bug" tags. I think it is cleaner to do that here, instead of on #31313. Revert my PR if I am wrong.


---

Comment by chapoton created at 2021-02-03 09:09:24

never ever change something on a positive reviewed ticket unless you have very good reasons


---

Comment by chapoton created at 2021-02-03 16:30:39

as you can see here, the former branch had already been used by our release manager 

https://github.com/vbraun/sage/commits/develop

so _please_ revert and put back the exact same branch that was here when it was set to positive


---

Comment by @DaveWitteMorris created at 2021-02-03 18:33:55

I'm very sorry I goofed things up. I thought it was only closed tickets that should not be messed with.

I also thought it would be easy to revert my commit, so I'm also sorry that I don't know how to "put back the exact same branch that was here". My attempt was rejected:

```
STDERR: error: failed to push some refs to 'git@trac.sagemath.org:sage.git'
STDERR: hint: Updates were rejected because a pushed branch tip is behind its remote
```

I know very little about git, so, since this didn't work, all I would know how to do is push a reversion commit to undo my erroneous change, but I don't think you want me to do that, because it would add yet another commit to the history.  (Maybe a "forced push" would work, but I am not confident enough to try something like that, because my understanding is that it has the potential to mess things up permanently.)


---

Comment by chapoton created at 2021-02-03 19:49:00

no problem, errare humanum est. I hope that I have not have sound rude..

I will handle the restoration


---

Comment by chapoton created at 2021-02-03 19:54:18

`@`vbraun

the new correct branch name is "public/quadrangles_restored"


---

Comment by chapoton created at 2021-02-03 19:54:57

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-02-03 19:54:57

and I am setting back to positive


---

Comment by @DaveWitteMorris created at 2021-02-03 20:19:25

Thanks for fixing this! I'm sorry to have made extra work for you.


---

Comment by vbraun created at 2021-02-07 19:40:23

Resolution: fixed
