# Issue 12181: wrong comparison between RealIntervalField and RealField

archive/issues_012181.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @robertwb @williamstein\n\nconsider the following:\n\n```\nsage: RealIntervalField(53)(-1) > RR(1)\nFalse\nsage: RealIntervalField(54)(-1) > RR(1)\nTrue\n```\n\nThe second answer is clearly wrong.\n\nThe problem seems to be the following: the `_richcmp` function\nfrom `structure/element.pyx` is called. With precision 54, the\ncall to `coercion_model.canonical_coercion` fails, then we have\n`r=1`, the two tests around line 853 fail, and the returned value is `_rich_to_bool(op, r)` which does not depend on `left` and `right`!\n\nPaul\n\nIssue created by migration from https://trac.sagemath.org/ticket/12353\n\n",
    "created_at": "2012-01-25T08:21:49Z",
    "labels": [
        "component: basic arithmetic",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "wrong comparison between RealIntervalField and RealField",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12181",
    "user": "https://github.com/zimmermann6"
}
```
Assignee: @aghitza

CC:  @robertwb @williamstein

consider the following:

```
sage: RealIntervalField(53)(-1) > RR(1)
False
sage: RealIntervalField(54)(-1) > RR(1)
True
```

The second answer is clearly wrong.

The problem seems to be the following: the `_richcmp` function
from `structure/element.pyx` is called. With precision 54, the
call to `coercion_model.canonical_coercion` fails, then we have
`r=1`, the two tests around line 853 fail, and the returned value is `_rich_to_bool(op, r)` which does not depend on `left` and `right`!

Paul

Issue created by migration from https://trac.sagemath.org/ticket/12353





---

archive/issue_comments_141648.json:
```json
{
    "body": "still wrong with Sage 5.0.beta1 on a 64-bit Core 2 under Ubuntu 10.10 (gcc 4.4.5):\n\n```\ntarte% ./sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: RealIntervalField(53)(-1) > RR(1)\nFalse\nsage: RealIntervalField(54)(-1) > RR(1)\nTrue\n```\n\nPaul",
    "created_at": "2012-01-26T06:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141648",
    "user": "https://github.com/zimmermann6"
}
```

still wrong with Sage 5.0.beta1 on a 64-bit Core 2 under Ubuntu 10.10 (gcc 4.4.5):

```
tarte% ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: RealIntervalField(53)(-1) > RR(1)
False
sage: RealIntervalField(54)(-1) > RR(1)
True
```

Paul



---

archive/issue_comments_141649.json:
```json
{
    "body": "Robert, this seems related to the coercion model. Please could you help?\n\nPaul",
    "created_at": "2012-01-30T10:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141649",
    "user": "https://github.com/zimmermann6"
}
```

Robert, this seems related to the coercion model. Please could you help?

Paul



---

archive/issue_comments_141650.json:
```json
{
    "body": "I'm currently building Sage 4.8 on `sage.math` (where the bug doesn't happen\nwith 4.7.2) to compare with my workstation where the bug happens, and isolate the\nproblem.\n\nPaul",
    "created_at": "2012-01-30T10:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141650",
    "user": "https://github.com/zimmermann6"
}
```

I'm currently building Sage 4.8 on `sage.math` (where the bug doesn't happen
with 4.7.2) to compare with my workstation where the bug happens, and isolate the
problem.

Paul



---

archive/issue_comments_141651.json:
```json
{
    "body": "after some investigation, the function `_richcmp` in `structure/element.pyx`\ncomputes `r = cmp(type(left), type(right))`, which gives `r=-1` on sage.math,\nand `r=1` on my workstation (both with Sage 4.8).\n\nNote that the *types* only are compared, thus by swapping the values I can produce a\nbug on sage.math too:\n\n```\nsage: RealIntervalField(54)(1) > RR(-1)\nFalse\n```\n\n\nSomething is badly wrong by comparing the types, not the values. Here we need help from someone more fluent in the Sage internals.\n\nPaul",
    "created_at": "2012-01-30T15:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141651",
    "user": "https://github.com/zimmermann6"
}
```

after some investigation, the function `_richcmp` in `structure/element.pyx`
computes `r = cmp(type(left), type(right))`, which gives `r=-1` on sage.math,
and `r=1` on my workstation (both with Sage 4.8).

Note that the *types* only are compared, thus by swapping the values I can produce a
bug on sage.math too:

```
sage: RealIntervalField(54)(1) > RR(-1)
False
```


Something is badly wrong by comparing the types, not the values. Here we need help from someone more fluent in the Sage internals.

Paul



---

archive/issue_comments_141652.json:
```json
{
    "body": "Are we talking about this piece of code (line 840)\n\n```\n            except (TypeError, NotImplementedError):\n                r = cmp(type(left), type(right))\n                if r == 0:\n                    r = -1\n```\n\nAs far as I know comparing type when you cannot compare the values is standard python behavior and is implemented in other places such as sets/set.py\n\n```\n    def __cmp__(self, right):\n        r\"\"\"\n        Compare self and right.\n\n        If right is not a Set compare types.  If right is also a Set,\n        returns comparison on the underlying objects.\n\n        .. note::\n\n           If `X < Y` is true this does *not* necessarily mean\n           that `X` is a subset of `Y`.  Also, any two sets can be\n           compared still, but the result need not be meaningful\n           if they are not equal. \n\n        EXAMPLES:\n            sage: Set(ZZ) == Set(QQ)\n            False\n            sage: Set(ZZ) < Set(QQ)\n            True\n            sage: Primes() == Set(QQ)\n            False\n\n        The following is random, illustrating that comparison of\n        sets is not the subset relation, when they are not equal::\n        \n            sage: Primes() < Set(QQ)             # random\n            True or False\n        \"\"\"\n        if not isinstance(right, Set_object):\n            return cmp(type(self), type(right))\n        return cmp(self.__object, right.__object)\n```\n\nThe comparison of type can be machine dependent as far as I remember which explain the inconsistencies. I guess it would be nice to try to get\n* a better answer\n* a better comparison",
    "created_at": "2012-01-30T21:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141652",
    "user": "https://github.com/kiwifb"
}
```

Are we talking about this piece of code (line 840)

```
            except (TypeError, NotImplementedError):
                r = cmp(type(left), type(right))
                if r == 0:
                    r = -1
```

As far as I know comparing type when you cannot compare the values is standard python behavior and is implemented in other places such as sets/set.py

```
    def __cmp__(self, right):
        r"""
        Compare self and right.

        If right is not a Set compare types.  If right is also a Set,
        returns comparison on the underlying objects.

        .. note::

           If `X < Y` is true this does *not* necessarily mean
           that `X` is a subset of `Y`.  Also, any two sets can be
           compared still, but the result need not be meaningful
           if they are not equal. 

        EXAMPLES:
            sage: Set(ZZ) == Set(QQ)
            False
            sage: Set(ZZ) < Set(QQ)
            True
            sage: Primes() == Set(QQ)
            False

        The following is random, illustrating that comparison of
        sets is not the subset relation, when they are not equal::
        
            sage: Primes() < Set(QQ)             # random
            True or False
        """
        if not isinstance(right, Set_object):
            return cmp(type(self), type(right))
        return cmp(self.__object, right.__object)
```

The comparison of type can be machine dependent as far as I remember which explain the inconsistencies. I guess it would be nice to try to get
* a better answer
* a better comparison



---

archive/issue_comments_141653.json:
```json
{
    "body": "Francois,\n\n> Are we talking about this piece of code (line 840) [...]\n\nyes exactly. But in this case the comparison of numerical values (the point interval\n[-1.0, -1.0] and the real 1.0) is well defined, thus I do not understand why the code returns\na comparison of *types* which is machine dependent. And moreover I don't understand how the\ndoctests could work before (see comment 50 in #12171).\n\nPaul",
    "created_at": "2012-01-30T21:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141653",
    "user": "https://github.com/zimmermann6"
}
```

Francois,

> Are we talking about this piece of code (line 840) [...]

yes exactly. But in this case the comparison of numerical values (the point interval
[-1.0, -1.0] and the real 1.0) is well defined, thus I do not understand why the code returns
a comparison of *types* which is machine dependent. And moreover I don't understand how the
doctests could work before (see comment 50 in #12171).

Paul



---

archive/issue_comments_141654.json:
```json
{
    "body": "After thinking about it, I agree it should work. So something is wrong with the coercion (line 2774 onward) so we should try to debug what's happening there.",
    "created_at": "2012-01-30T22:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141654",
    "user": "https://github.com/kiwifb"
}
```

After thinking about it, I agree it should work. So something is wrong with the coercion (line 2774 onward) so we should try to debug what's happening there.



---

archive/issue_comments_141655.json:
```json
{
    "body": "Why is this a blocker?",
    "created_at": "2012-02-02T21:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141655",
    "user": "https://github.com/jdemeyer"
}
```

Why is this a blocker?



---

archive/issue_comments_141656.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Why is this a blocker?\n\nbecause this is a wrong result in basic arithmetic, which can yield wrong results\nin any part of Sage.\n\nWilliam, Robert, are you out there to help fixing this?\n\nPaul",
    "created_at": "2012-02-03T07:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141656",
    "user": "https://github.com/zimmermann6"
}
```

Replying to [comment:8 jdemeyer]:
> Why is this a blocker?

because this is a wrong result in basic arithmetic, which can yield wrong results
in any part of Sage.

William, Robert, are you out there to help fixing this?

Paul



---

archive/issue_comments_141657.json:
```json
{
    "body": "I will take a look in the next few hours.",
    "created_at": "2012-02-03T21:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141657",
    "user": "https://github.com/roed314"
}
```

I will take a look in the next few hours.



---

archive/issue_comments_141658.json:
```json
{
    "body": "Alright.  I know what's going on and am working on a fix.  I'll try to post a patch tonight.",
    "created_at": "2012-02-04T00:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141658",
    "user": "https://github.com/roed314"
}
```

Alright.  I know what's going on and am working on a fix.  I'll try to post a patch tonight.



---

archive/issue_comments_141659.json:
```json
{
    "body": "I didn't get to it tonight but will do so in the next couple days. Here's a brief description of the fix.\n\nWe need to update the construction functors returned by RIF.construction() and RR.construction() to be able to merge construction functors of different types. So there's a total ordering on the types of real fields, and the pushout of two real fields has type the \"minimum\" of their types, and precision the minimum of their precisions.",
    "created_at": "2012-02-04T08:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141659",
    "user": "https://github.com/roed314"
}
```

I didn't get to it tonight but will do so in the next couple days. Here's a brief description of the fix.

We need to update the construction functors returned by RIF.construction() and RR.construction() to be able to merge construction functors of different types. So there's a total ordering on the types of real fields, and the pushout of two real fields has type the "minimum" of their types, and precision the minimum of their precisions.



---

archive/issue_comments_141660.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-07T03:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141660",
    "user": "https://github.com/roed314"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_141661.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-07T10:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141661",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141662.json:
```json
{
    "body": "David, thanks for your patch, I will review it. A first comment: RQDF is deprecated, thus it should not be considered in the patch. Please can you update this?\n\nPaul",
    "created_at": "2012-02-07T10:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141662",
    "user": "https://github.com/zimmermann6"
}
```

David, thanks for your patch, I will review it. A first comment: RQDF is deprecated, thus it should not be considered in the patch. Please can you update this?

Paul



---

archive/issue_comments_141663.json:
```json
{
    "body": "There is a new ticket #12458 about obsolete RQDF stuff.\n\nPaul",
    "created_at": "2012-02-07T10:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141663",
    "user": "https://github.com/zimmermann6"
}
```

There is a new ticket #12458 about obsolete RQDF stuff.

Paul



---

archive/issue_comments_141664.json:
```json
{
    "body": "oops there was a typo in the description.\n\nPaul",
    "created_at": "2012-02-07T10:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141664",
    "user": "https://github.com/zimmermann6"
}
```

oops there was a typo in the description.

Paul



---

archive/issue_comments_141665.json:
```json
{
    "body": "How about the following?  I made it clear that it was deprecated and removed it from pushout, but left it as an option in `create_RealField` where it returns `RealField(212)`?  Let me know if you prefer a different solution.",
    "created_at": "2012-02-07T10:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141665",
    "user": "https://github.com/roed314"
}
```

How about the following?  I made it clear that it was deprecated and removed it from pushout, but left it as an option in `create_RealField` where it returns `RealField(212)`?  Let me know if you prefer a different solution.



---

archive/issue_comments_141666.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-07T10:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141666",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141667.json:
```json
{
    "body": "David,\n\nsince RQDF is since long time obsolete in Sage, I would prefer we don't add new references to it (see #12458).\n\nPaul",
    "created_at": "2012-02-07T10:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141667",
    "user": "https://github.com/zimmermann6"
}
```

David,

since RQDF is since long time obsolete in Sage, I would prefer we don't add new references to it (see #12458).

Paul



---

archive/issue_comments_141668.json:
```json
{
    "body": "Changed.",
    "created_at": "2012-02-07T10:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141668",
    "user": "https://github.com/roed314"
}
```

Changed.



---

archive/issue_comments_141669.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-07T11:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141669",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141670.json:
```json
{
    "body": "a typo while reading the patch: approrpiate should be appropriate.\n\nPaul",
    "created_at": "2012-02-07T11:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141670",
    "user": "https://github.com/zimmermann6"
}
```

a typo while reading the patch: approrpiate should be appropriate.

Paul



---

archive/issue_comments_141671.json:
```json
{
    "body": "also, in `We check that #12353 has been resolved`, the 3rd and 4th tests are\nidentical (my fault). The 3rd one should be at precision 53:\n\n```\nsage: RealIntervalField(53)(1) > RR(-1) \nTrue\n```\n\nPaul",
    "created_at": "2012-02-07T11:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141671",
    "user": "https://github.com/zimmermann6"
}
```

also, in `We check that #12353 has been resolved`, the 3rd and 4th tests are
identical (my fault). The 3rd one should be at precision 53:

```
sage: RealIntervalField(53)(1) > RR(-1) 
True
```

Paul



---

archive/issue_comments_141672.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-07T11:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141672",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141673.json:
```json
{
    "body": "Fixed",
    "created_at": "2012-02-07T11:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141673",
    "user": "https://github.com/roed314"
}
```

Fixed



---

archive/issue_comments_141674.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-07T12:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141674",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141675.json:
```json
{
    "body": "I give a positive review since all doctests still work, and the problem is fixed.\nHowever I'm not fluent enough in the construction functors to really review the new\ncode. If Robert or William can do this, please go ahead. In the meantime, since this\nfixes an major defect, I set to positive review.\n\nPaul",
    "created_at": "2012-02-07T12:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141675",
    "user": "https://github.com/zimmermann6"
}
```

I give a positive review since all doctests still work, and the problem is fixed.
However I'm not fluent enough in the construction functors to really review the new
code. If Robert or William can do this, please go ahead. In the meantime, since this
fixes an major defect, I set to positive review.

Paul



---

archive/issue_comments_141676.json:
```json
{
    "body": "Attachment [12353.patch](tarball://root/attachments/some-uuid/ticket12353/12353.patch) by @jdemeyer created at 2012-02-09 09:24:40\n\nFolded both patches into one.",
    "created_at": "2012-02-09T09:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141676",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12353.patch](tarball://root/attachments/some-uuid/ticket12353/12353.patch) by @jdemeyer created at 2012-02-09 09:24:40

Folded both patches into one.



---

archive/issue_comments_141677.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-02-14T14:22:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12181#issuecomment-141677",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
