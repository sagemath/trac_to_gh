# Issue 12181: wrong comparison between RealIntervalField and RealField

Issue created by migration from https://trac.sagemath.org/ticket/12353

Original creator: zimmerma

Original creation time: 2012-01-25 08:21:49

Assignee: AlexGhitza

CC:  robertwb was

consider the following:

```
sage: RealIntervalField(53)(-1) > RR(1)
False
sage: RealIntervalField(54)(-1) > RR(1)
True
```

The second answer is clearly wrong.

The problem seems to be the following: the `_richcmp` function
from `structure/element.pyx` is called. With precision 54, the
call to `coercion_model.canonical_coercion` fails, then we have
`r=1`, the two tests around line 853 fail, and the returned value is `_rich_to_bool(op, r)` which does not depend on `left` and `right`!

Paul


---

Comment by zimmerma created at 2012-01-26 06:59:05

still wrong with Sage 5.0.beta1 on a 64-bit Core 2 under Ubuntu 10.10 (gcc 4.4.5):

```
tarte% ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: RealIntervalField(53)(-1) > RR(1)
False
sage: RealIntervalField(54)(-1) > RR(1)
True
```

Paul


---

Comment by zimmerma created at 2012-01-30 10:19:29

Robert, this seems related to the coercion model. Please could you help?

Paul


---

Comment by zimmerma created at 2012-01-30 10:25:58

I'm currently building Sage 4.8 on `sage.math` (where the bug doesn't happen
with 4.7.2) to compare with my workstation where the bug happens, and isolate the
problem.

Paul


---

Comment by zimmerma created at 2012-01-30 15:48:44

after some investigation, the function `_richcmp` in `structure/element.pyx`
computes `r = cmp(type(left), type(right))`, which gives `r=-1` on sage.math,
and `r=1` on my workstation (both with Sage 4.8).

Note that the *types* only are compared, thus by swapping the values I can produce a
bug on sage.math too:

```
sage: RealIntervalField(54)(1) > RR(-1)
False
```


Something is badly wrong by comparing the types, not the values. Here we need help from someone more fluent in the Sage internals.

Paul


---

Comment by fbissey created at 2012-01-30 21:47:12

Are we talking about this piece of code (line 840)

```
            except (TypeError, NotImplementedError):
                r = cmp(type(left), type(right))
                if r == 0:
                    r = -1
```

As far as I know comparing type when you cannot compare the values is standard python behavior and is implemented in other places such as sets/set.py

```
    def __cmp__(self, right):
        r"""
        Compare self and right.

        If right is not a Set compare types.  If right is also a Set,
        returns comparison on the underlying objects.

        .. note::

           If `X < Y` is true this does *not* necessarily mean
           that `X` is a subset of `Y`.  Also, any two sets can be
           compared still, but the result need not be meaningful
           if they are not equal. 

        EXAMPLES:
            sage: Set(ZZ) == Set(QQ)
            False
            sage: Set(ZZ) < Set(QQ)
            True
            sage: Primes() == Set(QQ)
            False

        The following is random, illustrating that comparison of
        sets is not the subset relation, when they are not equal::
        
            sage: Primes() < Set(QQ)             # random
            True or False
        """
        if not isinstance(right, Set_object):
            return cmp(type(self), type(right))
        return cmp(self.__object, right.__object)
```

The comparison of type can be machine dependent as far as I remember which explain the inconsistencies. I guess it would be nice to try to get
 * a better answer
 * a better comparison


---

Comment by zimmerma created at 2012-01-30 21:58:04

Francois,

> Are we talking about this piece of code (line 840) [...]

yes exactly. But in this case the comparison of numerical values (the point interval
[-1.0, -1.0] and the real 1.0) is well defined, thus I do not understand why the code returns
a comparison of *types* which is machine dependent. And moreover I don't understand how the
doctests could work before (see comment 50 in #12171).

Paul


---

Comment by fbissey created at 2012-01-30 22:09:11

After thinking about it, I agree it should work. So something is wrong with the coercion (line 2774 onward) so we should try to debug what's happening there.


---

Comment by jdemeyer created at 2012-02-02 21:59:48

Changing priority from blocker to major.


---

Comment by jdemeyer created at 2012-02-02 21:59:48

Why is this a blocker?


---

Comment by zimmerma created at 2012-02-03 07:16:16

Replying to [comment:8 jdemeyer]:
> Why is this a blocker?

because this is a wrong result in basic arithmetic, which can yield wrong results
in any part of Sage.

William, Robert, are you out there to help fixing this?

Paul


---

Comment by roed created at 2012-02-03 21:37:37

I will take a look in the next few hours.


---

Comment by roed created at 2012-02-04 00:47:26

Alright.  I know what's going on and am working on a fix.  I'll try to post a patch tonight.


---

Comment by roed created at 2012-02-04 08:09:55

I didn't get to it tonight but will do so in the next couple days. Here's a brief description of the fix.

We need to update the construction functors returned by RIF.construction() and RR.construction() to be able to merge construction functors of different types. So there's a total ordering on the types of real fields, and the pushout of two real fields has type the "minimum" of their types, and precision the minimum of their precisions.


---

Comment by roed created at 2012-02-07 03:29:19

Changing status from new to needs_review.


---

Comment by zimmerma created at 2012-02-07 10:03:42

Changing status from needs_review to needs_work.


---

Comment by zimmerma created at 2012-02-07 10:03:42

David, thanks for your patch, I will review it. A first comment: RQDF is deprecated, thus it should not be considered in the patch. Please can you update this?

Paul


---

Comment by zimmerma created at 2012-02-07 10:16:52

There is a new ticket #12458 about obsolete RQDF stuff.

Paul


---

Comment by zimmerma created at 2012-02-07 10:19:43

oops there was a typo in the description.

Paul


---

Comment by roed created at 2012-02-07 10:23:36

How about the following?  I made it clear that it was deprecated and removed it from pushout, but left it as an option in `create_RealField` where it returns `RealField(212)`?  Let me know if you prefer a different solution.


---

Comment by roed created at 2012-02-07 10:23:36

Changing status from needs_work to needs_review.


---

Comment by zimmerma created at 2012-02-07 10:28:45

David,

since RQDF is since long time obsolete in Sage, I would prefer we don't add new references to it (see #12458).

Paul


---

Comment by roed created at 2012-02-07 10:50:25

Changed.


---

Comment by zimmerma created at 2012-02-07 11:00:16

Changing status from needs_review to needs_work.


---

Comment by zimmerma created at 2012-02-07 11:00:16

a typo while reading the patch: approrpiate should be appropriate.

Paul


---

Comment by zimmerma created at 2012-02-07 11:04:03

also, in `We check that #12353 has been resolved`, the 3rd and 4th tests are
identical (my fault). The 3rd one should be at precision 53:

```
sage: RealIntervalField(53)(1) > RR(-1) 
True
```

Paul


---

Comment by roed created at 2012-02-07 11:06:42

Changing status from needs_work to needs_review.


---

Comment by roed created at 2012-02-07 11:06:42

Fixed


---

Comment by zimmerma created at 2012-02-07 12:28:02

Changing status from needs_review to positive_review.


---

Comment by zimmerma created at 2012-02-07 12:28:02

I give a positive review since all doctests still work, and the problem is fixed.
However I'm not fluent enough in the construction functors to really review the new
code. If Robert or William can do this, please go ahead. In the meantime, since this
fixes an major defect, I set to positive review.

Paul


---

Attachment

Folded both patches into one.


---

Comment by jdemeyer created at 2012-02-14 14:22:14

Resolution: fixed
