# Issue 11754: "make build" should run Sage once

Issue created by migration from https://trac.sagemath.org/ticket/11926

Original creator: jdemeyer

Original creation time: 2011-10-15 14:16:06

Assignee: GeorgSWeber

CC:  pcpa

Keywords: Makefile build

In a multi-user environment, the user compiling Sage must run it at least once to generate the `sage-current-location` file, generate `.pyc` files, update package-config files.

The proposed fix is: in the top-level Makefile, if `local/lib/sage-current-location.txt` does not exist, do a dummy run of Sage.


---

Comment by jdemeyer created at 2011-10-15 14:36:56

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-10-15 17:00:53

I think I suggested this sort of thing once, and it was criticized.  I don't remember the critiques.  Anyway, I like the idea.  In case some system administrator is building Sage and doesn't want a .sage directory created for them, should we set DOTSAGE to something temporary first?

By the way, running Sage as part of the build process should also take care of some of the issues at #5155 (not all of them, unfortunately).


---

Comment by jdemeyer created at 2011-10-15 17:47:04

Replying to [comment:3 jhpalmieri]:
> I think I suggested this sort of thing once, and it was criticized.  I don't remember the critiques.  Anyway, I like the idea.

> In case some system administrator is building Sage and doesn't want a .sage directory created for them, should we set DOTSAGE to something temporary first?
Good idea.  Make a temporary DOTSAGE, run Sage, remove the temporary DOTSAGE

> By the way, running Sage as part of the build process should also take care of some of the issues at #5155 (not all of them, unfortunately).
Thanks for the pointer.  Also #11887 is related.


---

Comment by jdemeyer created at 2011-10-15 17:47:04

Changing status from needs_review to needs_work.


---

Comment by leif created at 2011-10-15 18:32:35

I don't like the idea of running `sage` after `make build` since it certainly doesn't belong to that target, but if at all, it shouldn't be run from `spkg/install` but the `Makefile`, preferably in the _default rule_, not `build`.  Or run `sage-location` from there if `make` did anything, but we should in principle run it from elsewhere.

Someone who is going to install Sage system-wide should run `make ptestlong` or similiar anyway (which also runs `sage`), just like one runs `make check` before running `make install`.

Also note that `sage` (or `sage-location`) should be run (at least) *after* it has been moved to its final installation location, which is likely to happen _after_ having built Sage.


---

Comment by jdemeyer created at 2011-10-15 19:04:09

Replying to [comment:5 leif]:
> I don't like the idea of running `sage` after `make build` since it certainly doesn't belong to that target
I think it does.  Currently, after `make build` (or simply `make`), Sage *does not work* for a different user.  I think `make build` should result in a proper Sage installation, which means that it should work for *every user*.

> it shouldn't be run from `spkg/install` but the `Makefile`
Why?  I like `spkg/install` better because it allows us to run Sage only if something was actually installed.  You don't want to run Sage everytime somebody does `make foo` for various values of "foo".  Also, IIRC, we run `spkg/install` on upgrading but not a top-level `make all` or `make build`.

> Or run `sage-location` from there if `make` did anything, but we should in principle run it from elsewhere.
Running `sage-location` is certainly not sufficient to generate all files needed to run Sage.

> Someone who is going to install Sage system-wide should run `make ptestlong`
Let the sysadmin decide whether they want to run `make ptestlong` or not, I want to give him the option of NOT doing it.

> Also note that `sage` (or `sage-location`) should be run (at least) *after* it has been moved to its final installation location, which is likely to happen _after_ having built Sage.
I would think most people run Sage from the location where they installed it, or equivalently, install Sage in the location they want to run it from.  In any case, this does not invalidate the reasons for this ticket.


---

Comment by jdemeyer created at 2011-10-15 22:17:40

Updated version of the patch using a temporary `DOT_SAGE` directory.  I have not really tested it well.


---

Comment by jdemeyer created at 2011-10-15 22:17:40

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-10-16 15:51:01

Tested with a complete build from scratch that this does indeed what it should do.  A simple `make build` allows *any user* to run Sage.


---

Comment by jhpalmieri created at 2011-10-16 19:42:28

I don't see anything in the new patch about `DOT_SAGE`.


---

Comment by jdemeyer created at 2011-10-17 06:40:11

Replying to [comment:9 jhpalmieri]:
> I don't see anything in the new patch about `DOT_SAGE`.

So true!  I seems I forget a `hg qrefresh`.


---

Comment by jdemeyer created at 2011-10-17 06:51:41

Replying to [comment:3 jhpalmieri]:
> In case some system administrator is building Sage and doesn't want a .sage directory created for them, should we set DOTSAGE to something temporary first?

Related question which comes up: should we also use a temporary DOT_SAGE directory for `make doc`?  In #10163, I found out that `make doc` does run Sage (and does create a DOT_SAGE directory).


---

Comment by jhpalmieri created at 2011-10-17 17:11:05

I'm somewhat tempted to add a new command-line option to Sage:

```diff
diff --git a/sage-sage b/sage-sage
--- a/sage-sage
+++ b/sage-sage
@@ -247,6 +247,27 @@ if [ $# -gt 0 ]; then
   fi
 fi
 
+# The following function creates a temporary file and stores its name
+# in $FILE.  (It would be nice to replace this with 'mktemp', but that
+# command has different syntax on OS X compared to linux or Solaris.)
+sagetempfile() {
+    FILE=`mktemp -d 2>/dev/null`
+    if [ $? -ne 0 ]; then
+        # presumably because the "-d" option to mktemp expects an argument,
+        # e.g., on OS X.
+        FILE=`mktemp -d -t dotsage`
+    fi
+}
+
+if [ "$1" = '--norc' -o "$1" = '--nodotsage' ]; then
+    OLD_DOT_SAGE=$DOT_SAGE
+    sagetempfile
+    DOT_SAGE=$FILE && export DOT_SAGE
+    shift
+    sage "$@"
+    rm -rf "$DOT_SAGE"
+    DOT_SAGE=$OLD_DOT_SAGE && export DOT_SAGE
+fi
 
 LOGFILE="$SAGE_ROOT/sage.log"
 LOGOPT=""

```

We should probably check exit codes for various things here, and of course this would need to be documented.  If we had this, then in `Makefile`, we could replace "sage --docbuild ..." with "sage --norc --docbuild ...".  We could possibly do the same with "make test", etc.


---

Comment by jdemeyer created at 2011-10-17 18:31:05

Replying to [comment:13 jhpalmieri]:
> I'm somewhat tempted to add a new command-line option to Sage:
Let's discuss this in a different ticket: #11932.

I think I am going to revert the `DOT_SAGE` handling here and leave that for #11932, because currently it's very hard to avoid having a `$HOME/.sage` directory created when installing Sage.


---

Comment by jdemeyer created at 2011-10-17 18:31:05

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-10-17 18:42:53

Changing status from needs_work to needs_review.


---

Comment by leif created at 2011-10-17 20:57:55

s/succesfully/successfully/

Still, running `sage` (especially the full bunch of shell scripts) there is quite dangerous, as almost everything can happen.  Worse, there's no _"DO NOT INTERRUPT THIS"_*, and error messages aren't even logged.

Better write some `install` target (and / or a `sage-first_time` script), and update the Sage Installation Guide, especially with respect to files that are created upon first start-up, hardcoded path etc. etc.

IMHO we should in general do certain things _upon installing Sage_ (some actually _during_ the build), rather than checking them and doing them _for the first time_ when someone tries to start Sage.


----
* This message is btw. printed too late, as `install_moved()` already does some stuff before the script (eventually!) gets to this.




P.S.: No serious sysadmin builds in, say, `/usr/local/`, or leaves an "installation" in `/tmp/`.


---

Comment by leif created at 2011-10-17 20:59:45

s/does not run/failed to start up/.


---

Comment by leif created at 2011-10-17 21:02:36

Also, upon upgrading the message is useless (at least in the first place), as a second attempt to upgrade / build Sage is made.


---

Comment by jhpalmieri created at 2011-10-17 21:41:35

Instead of running Sage, you could run `sage-location` and `sage-python -c 'from sage.all import *'`, along with printing messages like "Generating necessary pyc files; do not interrupt".  This should generate the pyc files and the other files in local/lib, right? This avoids the shell script sage-sage, but is there any real advantage to doing this instead of just running `sage`?


---

Comment by leif created at 2011-10-17 22:29:19

Replying to [comment:19 jhpalmieri]:
> Instead of running Sage, you could run `sage-location` and `sage-python -c 'from sage.all import *'`, along with printing messages like "Generating necessary pyc files; do not interrupt".  This should generate the pyc files and the other files in local/lib, right? This avoids the shell script sage-sage, but is there any real advantage to doing this instead of just running `sage`?

Not much I think.  But we should really separate the things that have to (or should better) be done before running Sage the first time.  Compiling Python files does IMHO not belong to this, and executing `from sage.all import *` can again do almost everything (or lead to arbitrary constellations if the build is broken), and is hardly guaranteed to at all exit by itself.

Creating a (fully working) "read-only" installation (from the perspective of an arbitrary user) is certainly not something that belongs to a regular *build*; you'd do such if you intend to _install_ Sage system-wide for example of course, hence there should be some (separate) target for this.  Such target _could_ be the default target (`all`), although I think it shouldn't, at least not unless there's a (well-documented) way to specify the destination in advance, during some manually run `configure` for example.


---

Comment by jhpalmieri created at 2011-10-18 05:39:03

On one hand, there is something attractive about building and installing Sage by running (perhaps) "configure", then "make", then "make install".  However, this would require some work, and also a potential change of behavior for most Sage developers.  This sounds like a possibility, but a long-term one.  I don't see it happening any time soon, anyway.  Jeroen's suggestion here, on the other hand, is a quick solution for a problem with Sage now.  I suggest we merge this now (once the typos are fixed, along with any other simple fixes), and consider a longer term solution separately.

I wouldn't object if this were implemented by adding a new target in the Makefile, but I think it should be run by default to address the issues Jeroen has raised here.  I also wouldn't object if it were implemented as in the current patch, perhaps with a followup ticket to make it a separate target for make.


---

Comment by leif created at 2011-10-18 07:11:28

Replying to [comment:21 jhpalmieri]:
> Jeroen's suggestion here, on the other hand, is a quick solution for a problem with Sage now.

I don't see any problem, except that the current behaviour of Sage regarding on-the-fly creation or modification of files in the "static" installation tree is suboptimal and -- IMHO worse -- AFAIK not documented, at least not very well.

And the "problem" is all but new.

Sysadmins -- at least those that have installed Sage before (others will quickly notice) -- are likely to be aware of that; most other users don't care at all, so this is rather a non-issue.

Adding running `sage` at the end of every (perhaps partial re-) build is not the right way to solve this; in contrast, it is likely to obscure errors that don't show up during the build but when you try to start Sage, in addition with the potential to make the build hang (without any output).

So the minimal things to do are -- if you really want to run Sage _there_:

 * Print a message that we're attempting to run `sage`.
 * Disable keyboard interrupts during important operations (`sage-location`, maybe elsewhere, too), and issue a warning that this process must not be interrupted, at least for a few minutes.
 * Perhaps set a reasonably long timeout for running `sage`.
 * Log the output instead of redirecting it to `/dev/null`, such that we can print at least a reference to the error log in case of failures.




> I suggest we merge this now (once the typos are fixed, along with any other simple fixes), and consider a longer term solution separately.

There are various possible long-term solutions; the primary goal should be to _document_ potential issues, i.e., at least prominently state that Sage should be run at least once at its final location for use in a multi-user environment, or more precisely, for a system-wide installation.




> I wouldn't object if this were implemented by adding a new target in the Makefile, but I think it should be run by default to address the issues Jeroen has raised here.

An `echo` statement at the end of the build, perhaps in the `Makefile`, would IMHO fully suffice for the moment; no need to hurry or for "quick [and dirty] fixes" (which btw. often cause more trouble than they solve).

Have there been any "error" reports regarding this?  Changing the permissions of _all_ files in a couple of spkgs wasn't necessary either.

Note that "ordinary" users won't be able to install / upgrade spkgs anyway, so the `pkg-config` and `.la` files for example aren't an issue in a system-wide installation, nor will such users be able to move Sage, unless they copy the whole installation (in which case they're likely to gain ownership, or at least can change the owner, such that they'll have write permission on the copied installation).


---

Comment by jdemeyer created at 2011-10-18 10:19:21

Replying to [comment:16 leif]:
> Still, running `sage` (especially the full bunch of shell scripts) there is quite dangerous, as almost everything can happen.
What's your point really?  Whoever built Sage will have to run it sooner or later, otherwise it's quite pointless building Sage.  So the danger is there anyway.


---

Comment by jdemeyer created at 2011-10-18 10:32:31

Replying to [comment:18 leif]:
> Also, upon upgrading the message is useless (at least in the first place), as a second attempt to upgrade / build Sage is made.
What do you mean by "a second attempt to upgrade / build Sage is made"?


---

Comment by jdemeyer created at 2011-10-18 10:40:12

Replying to [comment:16 leif]:
> Better write some `install` target (and / or a `sage-first_time` script), and update the Sage Installation Guide, especially with respect to files that are created upon first start-up, hardcoded path etc. etc.
> 
> IMHO we should in general do certain things _upon installing Sage_ (some actually _during_ the build), rather than checking them and doing them _for the first time_ when someone tries to start Sage.
In principle you are of course right but Sage is quite different from other software.  It currently has no `make install` rule, and it is not at all clear to me what `make install` should do anyway.  Also, Sage is special in that the source code is really in the installation.  Normally, you would have a source tree and a build tree, but with Sage this is one.  Sage developers are used to this, so people might even complain if you try to change this.  So for this ticket, let's not overhaul the whole Sage build process, let's stick to the simple solution.

> * This message is btw. printed too late, as `install_moved()` already does some stuff before the script (eventually!) gets to this.
See #5155.

Leif: would you agree with the following: add a `make install` rule in Sage which simply runs Sage (and hence indirectly `sage-location`)?  And then not run Sage from `spkg/install`.


---

Comment by leif created at 2011-10-18 17:37:29

Replying to [comment:23 jdemeyer]:
> Replying to [comment:16 leif]:
> > Still, running `sage` (especially the full bunch of shell scripts) there is quite dangerous, as almost everything can happen.
> Whoever built Sage will have to run it sooner or later, otherwise it's quite pointless building Sage.  So the danger is there anyway.

:D I didn't know that.  I only build Sage, but have never run it.

Seriously, the difference is whether a user _intentionally_ runs `sage` (for the first time after a build / upgrade / extraction of a binary distribution), and _sees_ what's happening.  Your new patch omits the redirection to `/dev/null`, but I think it would be better to log the output to something like `$SAGE_ROOT/first_sage_startup-`date +"%Y-%m-%d-%H:%M"`.log`, which we _could_ delete afterwards if apparently nothing went wrong, otherwise point the user to this file, e.g. for bug reports (also to sage-release btw.).

We have enough "error reports" where people claim something didn't work but couldn't provide error logs.




I'd also prefer running Sage from the `Makefile`; rather than changing the `build` target, we could modify the _default target_ to run `sage` once after a successful build (or after building the documentation, but that's likely to fail in "weird" ways if `sage` itself doesn't work properly), perhaps just if no (recent) "first run" logfile exists.

There we should IMHO separate what's currently implicitly performed by `sage-location`, for example by adding an option to `sage-sage` for running just that.  For upgrades, running `sage-location` _afterwards_ is not strictly necessary; although some parts should be run by `sage-spkg` anyway, such that they also get run upon e.g. `sage -i ...`.  If `SAGE_UPGRADING=yes`, we could add a message to `spkg/install` (or `sage-sage`, or `sage-update`) recommending to try to run `sage` _right now_ (provided the build succeeded).  `make upgrade` (and `make rebuild`) are overdue anyway; if/when we drop the creation of `pipestatus`, we could also change `sage-update` to just _download_ new files and then run `make rebuild`, i.e., make it use the top-level `Makefile` as well (which is now under revision control and hence subject to upgrades, too).


---

Comment by leif created at 2011-10-18 17:52:17

Replying to [comment:24 jdemeyer]:
> Replying to [comment:18 leif]:
> > Also, upon upgrading the message is useless (at least in the first place), as a second attempt to upgrade / build Sage is made.
> What do you mean by "a second attempt to upgrade / build Sage is made"?


```sh
if [ "$1" = '-upgrade' -o "$1" = "--upgrade" ]; then
    # People often move the Sage install right before doing the upgrade, so it's
    # important to fix any path hardcoding issues first, or certain library
    # links will fail.
    "$SAGE_ROOT/local/bin/"sage-location

    # Do it twice since when installing sage-scripts and a running
    # script changes, it gets confused and exits with an error.
    # Running again (with the script replaced) then fixes the problem.
    # Run from a temporary copy of sage-sage
    shift
    sage-upgrade "$@"
    if [ $? = 2 ]; then   # this exit codes means the user elected not to do the upgrade at all.
        exit $?
    fi
    echo "Double checking that all packages have been installed."
    sage-upgrade "$@"
    exit $?
fi
```



---

Comment by jdemeyer created at 2011-10-18 19:54:56

Updated version, needs review (even though I have not yet tested building from scratch).


---

Comment by jdemeyer created at 2011-10-18 19:55:06

Changing keywords from "Makefile build" to "Makefile build sage-starts".


---

Comment by jdemeyer created at 2011-10-22 21:23:20

Any reviewers for this quite simple patch?


---

Comment by jhpalmieri created at 2011-10-22 23:33:55

I haven't tested it out, but it looks good at first glance.  If you're going to make changes to the error messages printed by sage-spkg, it would be good to mention `$SAGE_ROOT/spkg/logs/$PKG_NAME.log`.  If people build in parallel (and I hope they do), `$SAGE_ROOT/install.log` can be a real mess, and so may not be the best way to extract information.  What do you think about my attached patch?


---

Attachment

scripts repo; apply on top of other scripts patch


---

Comment by jhpalmieri created at 2011-10-23 02:47:17

I think that in sage-starts, if Sage fails to start, you should delete `SAGE_ROOT/local/bin/sage-flags.txt`: this is created by sage-location, which gets run by sage, which gets run by sage-starts.  That is, the file sage-flags.txt might be created successfully, then 

```
spkg/pipestatus "./sage -c \"print 'Yes, Sage starts.'\" 2>&1" "tee -a start.log"
```

fails, and then if you run "make" again, it won't test whether Sage starts because of the presence of sage-flags.txt.

Either that, or there needs to be a different test in the Makefile to decide whether to run sage-starts.


---

Comment by jdemeyer created at 2011-10-23 08:04:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-10-23 08:04:57

Replying to [comment:34 jhpalmieri]:
> Either that, or there needs to be a different test in the Makefile to decide whether to run sage-starts.

How about having a _third_ file besides the existing `sage-flags.txt` and `sage-current-location.txt`?  Say, a file `sage-started.txt` whose existence means Sage was run at least once successfully.

I think we could also use the non-existence of this file as a trigger in `sage-location` to force some actions.  For example, on upgrading, even if the Sage tree was not moved, it might make sense to call `update_library_files()` and `update_pkgconfig_files()`.

I would write the file `sage-started.txt` in `sage-location` and potentially delete it in `sage-starts` (that's what you proposed for `sage-flags.txt` instead).


---

Comment by jhpalmieri created at 2011-10-23 20:38:33

You could instead test whether the file starts.log ends with "Yes, Sage starts."  You could test this in sage-starts rather than in the Makefile.


---

Comment by jdemeyer created at 2011-10-24 07:46:57

Replying to [comment:36 jhpalmieri]:
> You could instead test whether the file starts.log ends with "Yes, Sage starts."

Sorry, but I disagree.  I think neither the existence nor contents of any logfiles should influence the runtime at all.  Users should be able to do whatever they want with logfiles without it making any difference.


---

Comment by jdemeyer created at 2011-10-29 19:40:18

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-10-29 19:42:52

New patches up for review.  It uses a new file _local/lib/sage-started.txt_ to check whether to run `sage-starts`.  I also added a reviewer patch for your changed error message.


---

Attachment


---

Comment by leif created at 2011-10-30 06:23:32

For the record:

```
Installation in a Multiuser Environment
---------------------------------------

This section addresses the question of how a system administrator
can install a single copy of Sage in a multi-user computer
network.

System-wide install
~~~~~~~~~~~~~~~~~~~

#. After you build Sage, you may optionally copy or move the entire
   build tree to ``/usr/local``.

#. There are some initial files that have to be created the first time
   Sage is run. Try starting up Sage once as root (or, to be
   more thorough, try ``make test`` as root to run all the standard test
   code). You can stop the tests by pressing ``ctrl-z`` followed by
   typing ``kill %1`` (assuming you had no other jobs in the
   background of that shell).

...
```


(I.e., RTFM.)


---

Comment by leif created at 2011-10-30 07:11:03

The patch to `spkg/install` will conflict with #11959, so should be removed from the patch.  (The changes are irrelevant anyway.)


---

Comment by leif created at 2011-10-30 07:24:32

I don't think it's a good idea to write the "sage started" file from `sage-location`, as running `sage-location` doesn't imply that Sage will or will get run.

Btw., `.pyc` wasn't a typo; while the `.pyc` files don't get "regenerated" by `sage-location`, they get _deleted_, such that they'll indeed get regenerated the next time Sage is run.

(The `.pc` files don't get regenerated either; if at all, they get updated when necessary.)


---

Comment by leif created at 2011-10-30 07:38:36

The patch to `sage-spkg` is also unrelated (and of just cosmetic nature) and will just cause unnecessary merge conflicts.


---

Comment by leif created at 2011-10-30 07:46:40

Replying to [comment:50 leif]:
> The patch to `sage-spkg` is also unrelated (and of just cosmetic nature) and will just cause unnecessary merge conflicts.

s/the patch/the three patches/ !?!

These should better be split off and moved to (and later rebased on) #11021.


---

Comment by jdemeyer created at 2011-10-30 11:18:00

Replying to [comment:47 leif]:
> (I.e., RTFM.)
I think we should Edit The Fucking Manual then.


---

Comment by jdemeyer created at 2011-10-30 11:32:53

Replying to [comment:48 leif]:
> The patch to `spkg/install` will conflict with #11959, so should be removed from the patch.

Done.


---

Comment by jdemeyer created at 2011-10-30 13:27:22

Replying to [comment:50 leif]:
> The patch to `sage-spkg` is also unrelated (and of just cosmetic nature) and will just cause unnecessary merge conflicts.

I agree it is unrelated and of cosmetic nature but it improves the error messages which is quite important I think.  And #11021 is a ticket which has no activity since 3 months so I don't think moving it there is such a good solution.


---

Comment by jdemeyer created at 2011-10-30 14:21:00

Apply to SCRIPTS repository


---

Attachment


---

Comment by jdemeyer created at 2011-10-30 14:21:28

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-10-30 14:24:33

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-10-30 14:24:33

Replying to [comment:49 leif]:
> I don't think it's a good idea to write the "sage started" file from `sage-location`, as running `sage-location` doesn't imply that Sage will or will get run.

Okay, moved this to `sage/all.py`, surely a better place.  Needs review.


---

Comment by jhpalmieri created at 2011-10-30 18:35:09

If someone runs 'make build' instead of 'make' or 'make start', is there a good way to let them know that they should probably run Sage once to initialize various files, or should we just hope that they've read enough of README.txt or the installation guide?


---

Comment by jdemeyer created at 2011-10-31 08:43:20

Replying to [comment:58 jhpalmieri]:
> If someone runs 'make build' instead of 'make' or 'make start', is there a good way to let them know that they should probably run Sage once to initialize various files, or should we just hope that they've read enough of README.txt or the installation guide?

Well, we could print a message after `make build` is finished, but this will also be printed when doing a simple `make` and might confuse users.  So I would rather _not_ print anything and assume that users who know about `make build` also know what they are doing.


---

Comment by jhpalmieri created at 2011-10-31 22:10:51

I think this looks good.  There are a few small cosmetic changes; if you want to make them, no need for re-review.

 - In [attachment:11926_sage.patch], line 859, I would change "such that" to "so that".

 - After having rewritten the error message in [attachment:trac_11926-error-msg.patch] myself, I now think it would look better to add blank lines above and below line 56, the name of the log file.  (That's line 59 in [attachment:11926-error-msg-review.patch]).  The same might go for line 65 (in the review patch), the commands to try to debug the error, but it's not as important there.


---

Comment by jhpalmieri created at 2011-10-31 22:10:51

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-10-31 22:47:00

Apply to the SAGE_ROOT repository


---

Attachment


---

Attachment

Replying to [comment:60 jhpalmieri]:
> In [attachment:11926_sage.patch], line 859, I would change "such that" to "so that".
Done

> After having rewritten the error message in [attachment:trac_11926-error-msg.patch] myself, I now think it would look better to add blank lines above and below line 56, the name of the log file.  (That's line 59 in [attachment:11926-error-msg-review.patch]).  The same might go for line 65 (in the review patch), the commands to try to debug the error, but it's not as important there.

Well, I think the indentation already makes them stand out.  Looking at the new error message in the description of this ticket, I quite like it.


---

Comment by jdemeyer created at 2011-11-02 08:32:25

Resolution: fixed


---

Comment by leif created at 2011-11-02 15:42:58

Replying to [comment:59 jdemeyer]:
> Replying to [comment:58 jhpalmieri]:
> > If someone runs 'make build' instead of 'make' or 'make start', is there a good way to let them know that they should probably run Sage once to initialize various files, or should we just hope that they've read enough of README.txt or the installation guide?
> 
> Well, we could print a message after `make build` is finished, but this will also be printed when doing a simple `make` and might confuse users.  So I would rather _not_ print anything and assume that users who know about `make build` also know what they are doing.


```make
ifeq ($(MAKECMDGOALS),build)
        RUN_SAGE_REMINDER = echo "Make sure to run Sage once before ..."
endif

...

build: ...
        ...
        $(RUN_SAGE_REMINDER)
```


----

IMHO this ticket still needs work.

First of all, `doc` should also depend on `start`[sic], to avoid attempting to run both at the same time.

Second, the output of `sage-starts` still isn't logged, which is important for error reports at least.


---

Comment by jdemeyer created at 2011-11-02 15:50:46

Replying to [comment:63 leif]:
> First of all, `doc` should also depend on `start`[sic], to avoid attempting to run both at the same time.
Nothing wrong with running `doc` and `start`[sic] at the same time.

> Second, the output of `sage-starts` still isn't logged
That's not true.  It is logged in `$SAGE_ROOT/start.log`, see the new `local/bin/sage-starts`.  If `sage-starts` fails, you get an error message pointing to this logfile.


---

Comment by leif created at 2011-11-02 16:06:44

Replying to [comment:63 leif]:
> Second, the output of `sage-starts` still isn't logged, which is important for error reports at least.

Ok, I see it is in `$SAGE_ROOT/start.log`.  Not immediately clear from the `Makefile`, and having it in `install.log` as well wouldn't be bad either.

From `start.log` alone (which is always appended to), it isn't clear what happened inbetween (i.e., the relevant parts of `install.log`), and conversely, from `install.log` one doesn't necessarily see whether running Sage succeeded.  Having the date and time (UTC) there (in `start.log`, but in general in `install.log`, too) wouldn't be bad either.


---

Comment by leif created at 2011-11-02 16:14:25

Replying to [comment:64 jdemeyer]:
> Replying to [comment:63 leif]:
> > First of all, `doc` should also depend on `start`[sic], to avoid attempting to run both at the same time.
> Nothing wrong with running `doc` and `start`[sic] at the same time.

Seriously?  If both get run at the same time, the [screen] output is likely to get messed up (the message of `sage-starts` almost certainly not being the last).  But more important, it doesn't make sense to try to build the documentation if Sage doesn't start up (since it will fail at some later point), and are you 100% sure that there aren't any further race conditions between these two?


---

Comment by leif created at 2011-11-02 16:26:14

In the patch to `sage-spkg` (which is unrelated to this ticket anyway), `error_msg()` prints `"sage: An error occurred while testing $PKG_NAME.` regardless of `$1`.


---

Comment by leif created at 2011-11-02 16:31:08

Replying to [comment:67 leif]:
> In the patch to `sage-spkg` (which is unrelated to this ticket anyway), `error_msg()` prints `"sage: An error occurred while testing $PKG_NAME.` regardless of `$1`.

I see.  Fixed in yet another reviewer patch...  Sorry for the noise, although the patch is still unrelated to the ticket's topic.  (More precisely, I already made similar changes at / for #11021, where it IMHO belongs.)


---

Comment by leif created at 2011-11-02 16:43:33

W.r.t. the Installation Guide:

One shouldn't edit `/usr/local/sage-*/sage` (*after* copying it; one can of course), but `/usr/local/bin/sage`, i.e., one should either edit the copy, or the original and copy it _afterwards_.

No need to remove the recommendation to run `make test` or whatever (`make ptestlong` would IMHO be more appropriate).


---

Comment by leif created at 2011-11-02 16:48:37

Replying to [comment:69 leif]:
> W.r.t. the Installation Guide:
> 
> One shouldn't edit `/usr/local/sage-*/sage` (*after* copying it; one can of course), but `/usr/local/bin/sage`, i.e., one should either edit the copy, or the original and copy it _afterwards_.

P.S.: One should preferably edit the copy, since the original is under revision control, so changes to that can e.g. again cause "errors" during upgrading.


---

Comment by jdemeyer created at 2011-11-02 19:46:53

Replying to [comment:68 leif]:
> I see.  Fixed in yet another reviewer patch...  Sorry for the noise, although the patch is still unrelated to the ticket's topic.  (More precisely, I already made similar changes at / for #11021, where it IMHO belongs.)

I don't see why it belongs more to #11021 than here, but in any case, that's not a very relevant discussion.  I was unaware of #11021 when I made the changes and I'm not sure whether that ticket is ready to be merged.


---

Comment by jdemeyer created at 2011-11-02 19:55:17

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-11-02 19:55:17

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-11-02 19:55:23

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-11-02 19:56:16

Added an extra patch with the documentation changes proposed by leif, needs_review.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Attachment

Can somebody please review the last patch here?


---

Comment by jhpalmieri created at 2011-11-03 21:41:01

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2011-11-03 21:41:01

Looks okay to me.


---

Comment by leif created at 2011-11-03 23:55:30

Replying to [comment:79 jhpalmieri]:
> Looks okay to me.

Yes.

But still `doc` should depend on `start`, such that one immediately gets _a single, meaningful_ error message, not intermixed by repeated random tracebacks from Sphinx (after each of which the script btw. still unconditionally prints _"Build succeeded.  The built documents can be found in..."_).

And it would be far better to have the output of `sage-starts` also appended to `install.log`, for the reasons given earlier.




W.r.t. #11021:

Despite its current title, it involves a "major" rewrite of `sage-spkg`, i.e., makes changes all over the code, half of which were -- though already positively reviewed -- removed from another ticket for IMHO no reason (since at that point, they did apply and didn't break any other tickets).

So that ticket certainly drags (which mainly is my fault; I've returned to it many times, but then again had to work on too many other tickets), but it doesn't make things easier if other tickets do redundant changes to `sage-spkg`, thereby just causing tedious rebasing.

One can by the way search for other tickets before working on e.g. scripts or spkgs.  And there's btw. also a meta-ticket for changes to the `Makefile`, #11622.


---

Comment by jdemeyer created at 2011-11-04 09:18:27

Replying to [comment:80 leif]:
> But still `doc` should depend on `start`, such that one immediately gets _a single, meaningful_ error message
I don't find it logical that `doc` would depend on `start`.  I still think the best solution would be to have `make build` run `sage-starts`.  So here, we have to agree to disagree.

> So that ticket certainly drags (which mainly is my fault; I've returned to it many times, but then again had to work on too many other tickets), but it doesn't make things easier if other tickets do redundant changes to `sage-spkg`, thereby just causing tedious rebasing.
If we are not allowed to make patches just because some other ticket makes changes to the same code, then we might as well stop Sage development.  Especially if the ticket gets "dragged" as you say.


---

Comment by jdemeyer created at 2011-11-04 09:31:16

Replying to [comment:80 leif]:
> And it would be far better to have the output of `sage-starts` also appended to `install.log`, for the reasons given earlier.
I don't have strong feelings about this issue.  If you want to make this change on a different ticket, go ahead, I will have a look.


---

Comment by jdemeyer created at 2011-11-04 09:31:16

Resolution: fixed


---

Comment by leif created at 2011-11-04 09:37:32

Replying to [comment:81 jdemeyer]:
> Replying to [comment:80 leif]:
> > But still `doc` should depend on `start`, such that one immediately gets _a single, meaningful_ error message
> I don't find it logical that `doc` would depend on `start`.  I still think the best solution would be to have `make build` run `sage-starts`.  So here, we have to agree to disagree.

The builder imports `sage.all`, hence `doc` requires that Sage can start.

Perhaps `sage --docbuild` should check once that it is functional (with `try: import sage.all ...`).





> If we are not allowed to make patches just because some other ticket makes changes to the same code, then we might as well stop Sage development.  Especially if the ticket gets "dragged" as you say.

I was talking about _unnecessary_, unrelated changes.  Any developer should at least be aware of other tickets touching the same code.

It's also bad practice to bundle unrelated changes to different files into a single patch, just because they're in the same repo.


---

Comment by jhpalmieri created at 2011-11-04 21:07:17

See #11991 for what I hope is a quick a follow-up: sage-starts should record the time and version number.


---

Comment by fbissey created at 2011-11-24 22:46:40

I hate to be late to the party. I was bogged down into work. I appreciate the point of view that most people won't build the stuff system wide. Me and Paulo from Mandriva do. I and probably him will object to that sage-started.txt file being stored in $SAGE_LOCAL/lib/. To us it belongs to DOTSAGE. I know it complicates the testing that Jeroen wants to do. But this goes a long way to making a system wide installation troublesome. 

I may have missed it but where is the documentation for someone who wants to make a system wide install? Just this ticket?


---

Comment by jhpalmieri created at 2011-11-25 04:29:53

I think that sage_started.txt should be viewed as a file like sage-current-location.txt: a file which is produced during the build/test process, which ordinary users don't need write-access to.  This ticket is related to some of the issues at #5155, and should indeed fix some of them.  But maybe I don't understand your complaint; can you explain it more?


---

Comment by jdemeyer created at 2011-11-25 09:13:14

Replying to [comment:85 fbissey]:
> I hate to be late to the party. I was bogged down into work. I appreciate the point of view that most people won't build the stuff system wide. Me and Paulo from Mandriva do. I and probably him will object to that sage-started.txt file being stored in $SAGE_LOCAL/lib/. To us it belongs to DOTSAGE. I know it complicates the testing that Jeroen wants to do. But this goes a long way to making a system wide installation troublesome.
Why do you think this makes a system-wide install harder?  In fact, this ticket was exactly supposed to make it _easier_ to do a system-wide install.

> I may have missed it but where is the documentation for someone who wants to make a system wide install? Just this ticket?
See [http://sagemath.org/doc/installation/source.html#installation-in-a-multiuser-environment](http://sagemath.org/doc/installation/source.html#installation-in-a-multiuser-environment).  Of course this ticket (and probably others to be merged in sage-4.8) will change this documentation, but the essence should remain the same.


---

Comment by fbissey created at 2011-11-25 11:28:44

OK. I just completed my first ebuild of a sage-4.8 alpha this afternoon. The first I noticed about this is when I ran the doctests as a normal user. I do that straight away as this is the only validation test I have. A truckload of doctests just failed complaining that they couldn't find "sage-started.txt". Actually so many failed that I am almost wondering if there is something wrong with the ones that didn't.

I spent 3 weeks fixing bad fortran code and bad makefiles so I may have had a bit of a temper there but it just made my life difficult.

I am not sure how it helps with #5155 since it adds stuff that actually wants access to SAGE_ROOT.

I'll admit that I skimmed a bit on reading this thread so I won't attribute bad intent but using DOT_SAGE has been raised and apparently shot down as "system wide install" is not a normal install. You don't have to support the kind of stuff I do but it felt like making it more difficult knowingly.


---

Comment by jdemeyer created at 2011-11-25 11:35:31

How did you build sage?  i.e. which shell commands did you execute, starting from the Sage source tarball, to get the totally-non-working Sage?


---

Comment by jdemeyer created at 2011-11-25 11:40:48

Also: precisely which alpha version of Sage did you use?  There have been various changes to the build process in the 4.8 series.


---

Comment by jhpalmieri created at 2011-11-25 18:16:10

I tried the following:

 - build Sage ('make'), version 4.8.alpha2
 - move the Sage installation and run 'sage' once, as per the multi-user installation instructions
 - chmod a-w -R sage-x.y.z (so I don't have write access anymore)
 - sage -tp 18 devel/sage

Almost all tests passed; the only failures were the ones reported at #5515.

```
The following tests failed:

	sage -t --long devel/sage/sage/modular/hecke/submodule.py # 1 doctests failed
	sage -t --long devel/sage/sage/modular/abvar/abvar.py # 1 doctests failed
	sage -t --long devel/sage/sage/lfunctions/sympow.py # 13 doctests failed
	sage -t --long devel/sage/sage/interfaces/qepcad.py # 3 doctests failed
	sage -t --long devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py # 17 doctests failed
```

So I think the approach on this ticket should work with a multi-user installation, but as I said earlier, I may be misunderstanding the problem.


---

Comment by fbissey created at 2011-11-25 18:34:37

Sorry not to reply immediately Jeroen but that last message was the last thing I did before getting some sleep.

Which helped clear my mind a little and take on board some comments properly. I, and am pretty sure that Mandriva does too, bypass the normal sage build system in our packages. You may have noticed the word ebuild (gentoo). So I didn't notice that you basically generated a file that was essential to start sage at the very end of the building process and outside of any spkg (that's a very crucial bit if you are packaging sage). I guess now that I have noticed and realized it is supposed to be there I could just add it and adjust the location.

My real mistake was to think it was created each time sage was launched - never mind that there is no process to remove it.
