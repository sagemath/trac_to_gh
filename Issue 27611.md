# Issue 27611: Deprecate to_sage() and structure_sheaf() in Macaulay2 interface

Issue created by migration from https://trac.sagemath.org/ticket/27848

Original creator: @mwageringel

Original creation time: 2019-05-18 12:12:21

Keywords: macaulay2, deprecation

For consistency with other interfaces, the method `to_sage()` for converting `Macaulay2Element`s to Sage should be deprecated and replaced by `sage()`. More precisely, the method `_sage_()` inherited from a super class should be implemented.

Similarly, the Sage method `structure_sheaf()` should be deprecated in favor of the Macaulay2 function `sheaf()` which provides the same functionality. Since `structure_sheaf()` is implemented for any `Macaulay2Element`, even for elements that do not support it, it unnecessarily pollutes the tab completion menu. In contrast, `sheaf()` only appears in the completion menu if an element supports it.



---

Comment by @mwageringel created at 2019-05-18 14:52:46

I have implemented the deprecations and also fixed all the failing doctests involving Macaulay2, which I tested using Macaulay2 1.11 and 1.13 on OS X.

Since the Macaulay2 description of matrices changed in 1.13, I also added code to ensure these matrices have the correct string representation within Sage (see the commit message for details).

To run the tests on all files that have optional Macaulay2 doctests, you can use:

```
sage -t --long --optional=sage,macaulay2 $(grep -i "optional.*macaulay2" -r src/sage -l | paste -sd " " -)
```

----
New commits:


---

Comment by @mwageringel created at 2019-05-18 14:52:46

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-06-20 09:59:02

With python3-sage, and M2 (version 1.14) installed and working, and this ticket's branch, I get

```
sage -t --long src/sage/matrix/matrix1.pyx  # 2 doctests failed
sage -t --long src/sage/interfaces/macaulay2.py  # 2 doctests failed
```

Some of these failures may be there without the branch here.


---

Comment by chapoton created at 2019-06-20 10:00:35

The matrix failure should be an easy fix: please replace

```
entries = map(list, self)
```

by 

```
entries = [list(c) for c in self]
```

in the macaulay method in the file matrix1.pyx.


---

Comment by chapoton created at 2019-06-20 10:02:45

The other failure is a "bytes versus string" problem.

EDIT:

This shoud be fixed by replacing

```
return s
```

by
`return bytes_to_str(s)`
in the
`_sage_src_` method of the M2 interface.


---

Comment by chapoton created at 2019-06-20 11:07:10

I have made my suggested changes. If you agree with them, you can set this ticket to positive review.
----
New commits:


---

Comment by @mwageringel created at 2019-06-20 17:04:02

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2019-06-20 17:04:02

Ok, thank you.


---

Comment by vbraun created at 2019-06-27 20:13:33

Resolution: fixed


---

Comment by embray created at 2019-07-03 11:34:48

Not in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were _actually_ included, especially when closing tickets.
