# Issue 33944: Clean pkgs/sagemath-standard/scripts-* when venvs are switched

archive/issues_033944.json:
```json
{
    "body": "CC:  culler jhpalmieri\n\nAs reported in https://groups.google.com/g/sage-release/c/FezzF5Q7Wt4/m/TJG8jQyAAQAJ, scripts with old shebang lines may leak into new venvs.\n\nIn the reported case, this happened in a build `--without-system-python3` on updating from Python 3.10.3 to 3.10.5, but this could also happen when `--with-sage-venv=/SOME/GIVEN/PATH` is used.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34181\n\n",
    "created_at": "2022-07-14T14:51:16Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Clean pkgs/sagemath-standard/scripts-* when venvs are switched",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33944",
    "user": "mkoeppe"
}
```
CC:  culler jhpalmieri

As reported in https://groups.google.com/g/sage-release/c/FezzF5Q7Wt4/m/TJG8jQyAAQAJ, scripts with old shebang lines may leak into new venvs.

In the reported case, this happened in a build `--without-system-python3` on updating from Python 3.10.3 to 3.10.5, but this could also happen when `--with-sage-venv=/SOME/GIVEN/PATH` is used.


Issue created by migration from https://trac.sagemath.org/ticket/34181





---

archive/issue_comments_482033.json:
```json
{
    "body": "An easy way to fix it is to just delete the cache `pkgs/sagemath-standard/build/scripts*` at the beginning of `build/pkgs/sagelib/spkg-install`. Regenerating the scripts probably does not have a noticeable performance penalty",
    "created_at": "2022-07-14T15:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482033",
    "user": "mkoeppe"
}
```

An easy way to fix it is to just delete the cache `pkgs/sagemath-standard/build/scripts*` at the beginning of `build/pkgs/sagelib/spkg-install`. Regenerating the scripts probably does not have a noticeable performance penalty



---

archive/issue_comments_482034.json:
```json
{
    "body": "I think this is the same as https://github.com/pypa/setuptools/issues/847",
    "created_at": "2022-07-14T15:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482034",
    "user": "mkoeppe"
}
```

I think this is the same as https://github.com/pypa/setuptools/issues/847



---

archive/issue_comments_482035.json:
```json
{
    "body": "Marc, I think this fixes the issue\n----\nNew commits:",
    "created_at": "2022-07-14T15:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482035",
    "user": "mkoeppe"
}
```

Marc, I think this fixes the issue
----
New commits:



---

archive/issue_comments_482036.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-14T15:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482036",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_482037.json:
```json
{
    "body": "By the way, in your case the issue was provoked because `configure --without-system-python3 --with-sage-venv` chooses a venv directory that's keyed to the full version number (`.../venv-python3.10.5`), whereas the setuptools build cache is keyed only to major and minor version (`scripts-3.10`).",
    "created_at": "2022-07-14T16:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482037",
    "user": "mkoeppe"
}
```

By the way, in your case the issue was provoked because `configure --without-system-python3 --with-sage-venv` chooses a venv directory that's keyed to the full version number (`.../venv-python3.10.5`), whereas the setuptools build cache is keyed only to major and minor version (`scripts-3.10`).



---

archive/issue_comments_482038.json:
```json
{
    "body": "Thanks!\n\nI am not explicitly using the --with-sage-venv option but it is evidently on by default.\n\nIt will not be so easy to recreate my previous directory state.  I will try to test somehow, though.",
    "created_at": "2022-07-14T16:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482038",
    "user": "culler"
}
```

Thanks!

I am not explicitly using the --with-sage-venv option but it is evidently on by default.

It will not be so easy to recreate my previous directory state.  I will try to test somehow, though.



---

archive/issue_comments_482039.json:
```json
{
    "body": "I just did `./configure --enable-editable && make`, and there is no directory `$SAGE_SRC/build/scripts-*`: `build` only contains `lib.macosx-12-x86_64-cpython-39`. Is that a problem?",
    "created_at": "2022-07-25T04:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482039",
    "user": "jhpalmieri"
}
```

I just did `./configure --enable-editable && make`, and there is no directory `$SAGE_SRC/build/scripts-*`: `build` only contains `lib.macosx-12-x86_64-cpython-39`. Is that a problem?



---

archive/issue_comments_482040.json:
```json
{
    "body": "Not a problem, the `rm -rf` will not give an error",
    "created_at": "2022-07-25T05:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482040",
    "user": "mkoeppe"
}
```

Not a problem, the `rm -rf` will not give an error



---

archive/issue_comments_482041.json:
```json
{
    "body": "I understand that, but the command won't remove any files. It seems like this is hard to reproduce, but if some of the old scripts are causing problems, this won't have any effect in the editable case. If that's the case, the following would give a clearer picture of what's happening:\n\n```diff\ndiff --git a/build/pkgs/sagelib/spkg-install b/build/pkgs/sagelib/spkg-install\nindex c21c506f17..3178741aa2 100755\n--- a/build/pkgs/sagelib/spkg-install\n+++ b/build/pkgs/sagelib/spkg-install\n@@ -3,6 +3,8 @@ if [ \"$SAGE_EDITABLE\" = yes ]; then\n     cd \"$SAGE_SRC\"\n else\n     cd src\n+    # Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.\n+    rm -rf build/scripts-*\n fi\n ## All sagelib-building is done by setup.py.\n ## This is so that sagelib can be installed by standard Python procedures,\n@@ -37,9 +39,6 @@ export SAGE_SHARE=/doesnotexist\n # spec, which includes setting a symlink to the installed documentation.\n # export SAGE_DOC=/doesnotexist\n \n-# Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.\n-rm -rf build/scripts-*\n-\n SITEPACKAGESDIR=$(python3 -c 'import sysconfig; print(sysconfig.get_paths()[\"purelib\"])')\n if [ \"$SAGE_EDITABLE\" = yes ]; then\n     # In an incremental build, we may need to uninstall old versions installed by distutils\n```\n\nMaybe even add a comment in the \"if\" part about it not being a problem with editable builds, if that is indeed the case.",
    "created_at": "2022-07-25T05:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482041",
    "user": "jhpalmieri"
}
```

I understand that, but the command won't remove any files. It seems like this is hard to reproduce, but if some of the old scripts are causing problems, this won't have any effect in the editable case. If that's the case, the following would give a clearer picture of what's happening:

```diff
diff --git a/build/pkgs/sagelib/spkg-install b/build/pkgs/sagelib/spkg-install
index c21c506f17..3178741aa2 100755
--- a/build/pkgs/sagelib/spkg-install
+++ b/build/pkgs/sagelib/spkg-install
@@ -3,6 +3,8 @@ if [ "$SAGE_EDITABLE" = yes ]; then
     cd "$SAGE_SRC"
 else
     cd src
+    # Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.
+    rm -rf build/scripts-*
 fi
 ## All sagelib-building is done by setup.py.
 ## This is so that sagelib can be installed by standard Python procedures,
@@ -37,9 +39,6 @@ export SAGE_SHARE=/doesnotexist
 # spec, which includes setting a symlink to the installed documentation.
 # export SAGE_DOC=/doesnotexist
 
-# Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.
-rm -rf build/scripts-*
-
 SITEPACKAGESDIR=$(python3 -c 'import sysconfig; print(sysconfig.get_paths()["purelib"])')
 if [ "$SAGE_EDITABLE" = yes ]; then
     # In an incremental build, we may need to uninstall old versions installed by distutils
```

Maybe even add a comment in the "if" part about it not being a problem with editable builds, if that is indeed the case.



---

archive/issue_comments_482042.json:
```json
{
    "body": "OK if you want to push this change to the ticket",
    "created_at": "2022-07-25T05:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482042",
    "user": "mkoeppe"
}
```

OK if you want to push this change to the ticket



---

archive/issue_comments_482043.json:
```json
{
    "body": "Okay, done.\n----\nNew commits:",
    "created_at": "2022-07-25T05:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482043",
    "user": "jhpalmieri"
}
```

Okay, done.
----
New commits:



---

archive/issue_comments_482044.json:
```json
{
    "body": "LGTM",
    "created_at": "2022-07-25T21:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482044",
    "user": "mkoeppe"
}
```

LGTM



---

archive/issue_comments_482045.json:
```json
{
    "body": "`@`culler: what do you think? I'm happy with it.",
    "created_at": "2022-07-25T22:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482045",
    "user": "jhpalmieri"
}
```

`@`culler: what do you think? I'm happy with it.



---

archive/issue_comments_482046.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-29T17:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482046",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_482047.json:
```json
{
    "body": "Let's move ahead with this.",
    "created_at": "2022-07-29T17:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482047",
    "user": "jhpalmieri"
}
```

Let's move ahead with this.



---

archive/issue_comments_482048.json:
```json
{
    "body": "Thanks!",
    "created_at": "2022-07-29T17:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482048",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_482049.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-04T22:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33944#issuecomment-482049",
    "user": "vbraun"
}
```

Resolution: fixed
