# Issue 33944: Clean pkgs/sagemath-standard/scripts-* when venvs are switched

Issue created by migration from https://trac.sagemath.org/ticket/34181

Original creator: mkoeppe

Original creation time: 2022-07-14 14:51:16

CC:  culler jhpalmieri

As reported in https://groups.google.com/g/sage-release/c/FezzF5Q7Wt4/m/TJG8jQyAAQAJ, scripts with old shebang lines may leak into new venvs.

In the reported case, this happened in a build `--without-system-python3` on updating from Python 3.10.3 to 3.10.5, but this could also happen when `--with-sage-venv=/SOME/GIVEN/PATH` is used.



---

Comment by mkoeppe created at 2022-07-14 15:00:24

An easy way to fix it is to just delete the cache `pkgs/sagemath-standard/build/scripts*` at the beginning of `build/pkgs/sagelib/spkg-install`. Regenerating the scripts probably does not have a noticeable performance penalty


---

Comment by mkoeppe created at 2022-07-14 15:09:21

I think this is the same as https://github.com/pypa/setuptools/issues/847


---

Comment by mkoeppe created at 2022-07-14 15:55:55

Marc, I think this fixes the issue
----
New commits:


---

Comment by mkoeppe created at 2022-07-14 15:55:55

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-07-14 16:06:47

By the way, in your case the issue was provoked because `configure --without-system-python3 --with-sage-venv` chooses a venv directory that's keyed to the full version number (`.../venv-python3.10.5`), whereas the setuptools build cache is keyed only to major and minor version (`scripts-3.10`).


---

Comment by culler created at 2022-07-14 16:26:08

Thanks!

I am not explicitly using the --with-sage-venv option but it is evidently on by default.

It will not be so easy to recreate my previous directory state.  I will try to test somehow, though.


---

Comment by jhpalmieri created at 2022-07-25 04:59:26

I just did `./configure --enable-editable && make`, and there is no directory `$SAGE_SRC/build/scripts-*`: `build` only contains `lib.macosx-12-x86_64-cpython-39`. Is that a problem?


---

Comment by mkoeppe created at 2022-07-25 05:01:04

Not a problem, the `rm -rf` will not give an error


---

Comment by jhpalmieri created at 2022-07-25 05:07:04

I understand that, but the command won't remove any files. It seems like this is hard to reproduce, but if some of the old scripts are causing problems, this won't have any effect in the editable case. If that's the case, the following would give a clearer picture of what's happening:

```diff
diff --git a/build/pkgs/sagelib/spkg-install b/build/pkgs/sagelib/spkg-install
index c21c506f17..3178741aa2 100755
--- a/build/pkgs/sagelib/spkg-install
+++ b/build/pkgs/sagelib/spkg-install
@@ -3,6 +3,8 @@ if [ "$SAGE_EDITABLE" = yes ]; then
     cd "$SAGE_SRC"
 else
     cd src
+    # Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.
+    rm -rf build/scripts-*
 fi
 ## All sagelib-building is done by setup.py.
 ## This is so that sagelib can be installed by standard Python procedures,
@@ -37,9 +39,6 @@ export SAGE_SHARE=/doesnotexist
 # spec, which includes setting a symlink to the installed documentation.
 # export SAGE_DOC=/doesnotexist
 
-# Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.
-rm -rf build/scripts-*
-
 SITEPACKAGESDIR=$(python3 -c 'import sysconfig; print(sysconfig.get_paths()["purelib"])')
 if [ "$SAGE_EDITABLE" = yes ]; then
     # In an incremental build, we may need to uninstall old versions installed by distutils
```

Maybe even add a comment in the "if" part about it not being a problem with editable builds, if that is indeed the case.


---

Comment by mkoeppe created at 2022-07-25 05:16:30

OK if you want to push this change to the ticket


---

Comment by jhpalmieri created at 2022-07-25 05:29:48

Okay, done.
----
New commits:


---

Comment by mkoeppe created at 2022-07-25 21:33:47

LGTM


---

Comment by jhpalmieri created at 2022-07-25 22:13:22

`@`culler: what do you think? I'm happy with it.


---

Comment by jhpalmieri created at 2022-07-29 17:21:15

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-07-29 17:21:15

Let's move ahead with this.


---

Comment by mkoeppe created at 2022-07-29 17:26:16

Thanks!


---

Comment by vbraun created at 2022-08-04 22:46:59

Resolution: fixed
