# Issue 16807: fix pexpect interfaces with a system-wide sage install

Issue created by migration from https://trac.sagemath.org/ticket/17044

Original creator: was

Original creation time: 2014-09-25 23:34:38

CC:  novoselt

If you install Sage system-wide (e.g., in /usr/local) for all users on your system, most of the pexpect interfaces will be completely massively broken.  The bug is big, but the fix is pretty trivial:


```
diff --git a/src/sage/interfaces/expect.py b/src/sage/interfaces/expect.py
index 4e47d54..ef8a4e1 100644
--- a/src/sage/interfaces/expect.py
+++ b/src/sage/interfaces/expect.py
@@ -127,7 +127,7 @@ class Expect(Interface):
     """
     def __init__(self, name, prompt, command=None, server=None, server_tmpdir=None,
                  ulimit = None, maxread=100000,
-                 script_subdirectory="", restart_on_ctrlc=False,
+                 script_subdirectory=None, restart_on_ctrlc=False,
                  verbose_start=False, init_code=[], max_startup_time=None,
                  logfile = None, eval_using_file_cutoff=0,
                  do_cleaner=True, remote_cleaner=False, path=None,
```


The problem is that elsewhere in the code there is an 

```
if script_subdirectory is None
```

rather than a

```
if script_subdirectory
```



---

Comment by chapoton created at 2014-09-26 07:38:52

Done
----
New commits:


---

Comment by chapoton created at 2014-09-26 07:38:52

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-09-26 07:52:27

I would like to understand the problem better. So William, could you please
1) say which version of Sage this refers to
2) describe the actual input and error you are getting
3) if any doctests fail in your setup (without this patch)

I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. So the problem is probably more subtle than you think.


---

Comment by was created at 2014-09-26 15:52:31

Replying to [comment:2 jdemeyer]:
> I would like to understand the problem better. So William, could you please
> 1) say which version of Sage this refers to

At least any Sage-6.x.

> 2) describe the actual input and error you are getting

Install Sage system-wide, then try to do anything with *some* of the pexpect-based interfaces as a normal user who doesn't own the sage install, especially ones that use optional software.  E.g., 

 sage: scilab('2+3')

> 3) if any doctests fail in your setup (without this patch)

Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  

> 
> I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. 

This problem has popped on the mailing lists, and basically got ignored, probably because for the most part our Sage developers usually own their own Sage installs.   However, with SageMathCloud, which has now 7000 *active users* per week all using a system-wide Sage install, this problem comes up more.  I had dome some horrible hacks to try to get around it, e.g., pointing SAGE_ROOT/local/share at something world writeable, but even this fails miserable if *two* regular users use the same interface -- one creates the user directory as their own, and the other then can't write to it. 

I think much of this boils down to a stupid coding mistake (surely made by me) involving `=""` versus `=None`.

> So the problem is probably more subtle than you think.

It probably is.  I wouldn't be surprised at all if this small patch is not the whole story, and there are similar bugs still lurking, since any classes that derive from the base Expect class (in expect.py) could cause their own related trouble...


---

Comment by jdemeyer created at 2014-09-26 16:22:50

Replying to [comment:3 was]:
> > 3) if any doctests fail in your setup (without this patch)
> 
> Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  
I meant: do any doctests fail when running doctests as the user who _doesn't_ own the Sage install? That should work (see #5155), although I don't know if this is still tested on a regular basis (I did it as part of my release management scripts, I have no idea if Volker does it).


---

Comment by jdemeyer created at 2014-09-26 18:15:19

Patch doesn't solve the issue.


---

Comment by jdemeyer created at 2014-09-26 18:15:19

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-26 18:20:44

My proposal to fix this ticket would be to get rid completely of the "script_subdirectory" argument, it's a broken design.


---

Comment by jdemeyer created at 2014-09-26 18:26:10

OK, perhaps not get rid of "script_directory" completely, but only use it for scripts which are known to be shipped with Sage, e.g. some PARI/GP scripts.


---

Comment by git created at 2014-09-26 19:33:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-09-26 19:50:16

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-09-26 19:50:16

This fixes the bug, but I still have to run doctests.


---

Comment by jdemeyer created at 2014-09-27 09:53:34

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-09-27 09:53:34

Doctests pass.


---

Comment by jdemeyer created at 2014-09-27 09:53:40

Changing status from positive_review to needs_review.


---

Comment by chapoton created at 2014-09-30 15:15:26

Hello,

I am not sure at all to be competent to review this ticket. As far as I can tell, this looks good.

I allowed myself to remove a few unused imports (except one which is in fact used in an indirect way) and one unused variable.

Jeroen, you can set this to positive review if you want.


---

Comment by git created at 2014-09-30 15:16:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-09-30 15:20:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-02 16:21:49

Resolution: fixed
