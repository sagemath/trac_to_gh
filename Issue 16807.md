# Issue 16807: fix pexpect interfaces with a system-wide sage install

archive/issues_016807.json:
```json
{
    "body": "CC:  @novoselt\n\nIf you install Sage system-wide (e.g., in /usr/local) for all users on your system, most of the pexpect interfaces will be completely massively broken.  The bug is big, but the fix is pretty trivial:\n\n\n```\ndiff --git a/src/sage/interfaces/expect.py b/src/sage/interfaces/expect.py\nindex 4e47d54..ef8a4e1 100644\n--- a/src/sage/interfaces/expect.py\n+++ b/src/sage/interfaces/expect.py\n@@ -127,7 +127,7 @@ class Expect(Interface):\n     \"\"\"\n     def __init__(self, name, prompt, command=None, server=None, server_tmpdir=None,\n                  ulimit = None, maxread=100000,\n-                 script_subdirectory=\"\", restart_on_ctrlc=False,\n+                 script_subdirectory=None, restart_on_ctrlc=False,\n                  verbose_start=False, init_code=[], max_startup_time=None,\n                  logfile = None, eval_using_file_cutoff=0,\n                  do_cleaner=True, remote_cleaner=False, path=None,\n```\n\n\nThe problem is that elsewhere in the code there is an \n\n```\nif script_subdirectory is None\n```\n\nrather than a\n\n```\nif script_subdirectory\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17044\n\n",
    "created_at": "2014-09-25T23:34:38Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "fix pexpect interfaces with a system-wide sage install",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16807",
    "user": "https://github.com/williamstein"
}
```
CC:  @novoselt

If you install Sage system-wide (e.g., in /usr/local) for all users on your system, most of the pexpect interfaces will be completely massively broken.  The bug is big, but the fix is pretty trivial:


```
diff --git a/src/sage/interfaces/expect.py b/src/sage/interfaces/expect.py
index 4e47d54..ef8a4e1 100644
--- a/src/sage/interfaces/expect.py
+++ b/src/sage/interfaces/expect.py
@@ -127,7 +127,7 @@ class Expect(Interface):
     """
     def __init__(self, name, prompt, command=None, server=None, server_tmpdir=None,
                  ulimit = None, maxread=100000,
-                 script_subdirectory="", restart_on_ctrlc=False,
+                 script_subdirectory=None, restart_on_ctrlc=False,
                  verbose_start=False, init_code=[], max_startup_time=None,
                  logfile = None, eval_using_file_cutoff=0,
                  do_cleaner=True, remote_cleaner=False, path=None,
```


The problem is that elsewhere in the code there is an 

```
if script_subdirectory is None
```

rather than a

```
if script_subdirectory
```


Issue created by migration from https://trac.sagemath.org/ticket/17044





---

archive/issue_comments_222231.json:
```json
{
    "body": "Done\n----\nNew commits:",
    "created_at": "2014-09-26T07:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222231",
    "user": "https://github.com/fchapoton"
}
```

Done
----
New commits:



---

archive/issue_comments_222232.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-26T07:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222232",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_222233.json:
```json
{
    "body": "I would like to understand the problem better. So William, could you please\n1) say which version of Sage this refers to\n2) describe the actual input and error you are getting\n3) if any doctests fail in your setup (without this patch)\n\nI am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. So the problem is probably more subtle than you think.",
    "created_at": "2014-09-26T07:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222233",
    "user": "https://github.com/jdemeyer"
}
```

I would like to understand the problem better. So William, could you please
1) say which version of Sage this refers to
2) describe the actual input and error you are getting
3) if any doctests fail in your setup (without this patch)

I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. So the problem is probably more subtle than you think.



---

archive/issue_comments_222234.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> I would like to understand the problem better. So William, could you please\n> 1) say which version of Sage this refers to\n\nAt least any Sage-6.x.\n\n> 2) describe the actual input and error you are getting\n\nInstall Sage system-wide, then try to do anything with *some* of the pexpect-based interfaces as a normal user who doesn't own the sage install, especially ones that use optional software.  E.g., \n\n sage: scilab('2+3')\n\n> 3) if any doctests fail in your setup (without this patch)\n\nNope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  \n\n> \n> I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. \n\nThis problem has popped on the mailing lists, and basically got ignored, probably because for the most part our Sage developers usually own their own Sage installs.   However, with SageMathCloud, which has now 7000 *active users* per week all using a system-wide Sage install, this problem comes up more.  I had dome some horrible hacks to try to get around it, e.g., pointing SAGE_ROOT/local/share at something world writeable, but even this fails miserable if *two* regular users use the same interface -- one creates the user directory as their own, and the other then can't write to it. \n\nI think much of this boils down to a stupid coding mistake (surely made by me) involving `=\"\"` versus `=None`.\n\n> So the problem is probably more subtle than you think.\n\nIt probably is.  I wouldn't be surprised at all if this small patch is not the whole story, and there are similar bugs still lurking, since any classes that derive from the base Expect class (in expect.py) could cause their own related trouble...",
    "created_at": "2014-09-26T15:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222234",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:2 jdemeyer]:
> I would like to understand the problem better. So William, could you please
> 1) say which version of Sage this refers to

At least any Sage-6.x.

> 2) describe the actual input and error you are getting

Install Sage system-wide, then try to do anything with *some* of the pexpect-based interfaces as a normal user who doesn't own the sage install, especially ones that use optional software.  E.g., 

 sage: scilab('2+3')

> 3) if any doctests fail in your setup (without this patch)

Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  

> 
> I am asking because you're certainly not the first person ever to install Sage system-wide but it is the first time I see this problem reported. 

This problem has popped on the mailing lists, and basically got ignored, probably because for the most part our Sage developers usually own their own Sage installs.   However, with SageMathCloud, which has now 7000 *active users* per week all using a system-wide Sage install, this problem comes up more.  I had dome some horrible hacks to try to get around it, e.g., pointing SAGE_ROOT/local/share at something world writeable, but even this fails miserable if *two* regular users use the same interface -- one creates the user directory as their own, and the other then can't write to it. 

I think much of this boils down to a stupid coding mistake (surely made by me) involving `=""` versus `=None`.

> So the problem is probably more subtle than you think.

It probably is.  I wouldn't be surprised at all if this small patch is not the whole story, and there are similar bugs still lurking, since any classes that derive from the base Expect class (in expect.py) could cause their own related trouble...



---

archive/issue_comments_222235.json:
```json
{
    "body": "Replying to [comment:3 was]:\n> > 3) if any doctests fail in your setup (without this patch)\n> \n> Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  \nI meant: do any doctests fail when running doctests as the user who *doesn't* own the Sage install? That should work (see #5155), although I don't know if this is still tested on a regular basis (I did it as part of my release management scripts, I have no idea if Volker does it).",
    "created_at": "2014-09-26T16:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222235",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 was]:
> > 3) if any doctests fail in your setup (without this patch)
> 
> Nope.  We don't do doctesting that tests permissions, since doctesting is always run as the user that owns the Sage install.  
I meant: do any doctests fail when running doctests as the user who *doesn't* own the Sage install? That should work (see #5155), although I don't know if this is still tested on a regular basis (I did it as part of my release management scripts, I have no idea if Volker does it).



---

archive/issue_comments_222236.json:
```json
{
    "body": "Patch doesn't solve the issue.",
    "created_at": "2014-09-26T18:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222236",
    "user": "https://github.com/jdemeyer"
}
```

Patch doesn't solve the issue.



---

archive/issue_comments_222237.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-26T18:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222237",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_222238.json:
```json
{
    "body": "My proposal to fix this ticket would be to get rid completely of the \"script_subdirectory\" argument, it's a broken design.",
    "created_at": "2014-09-26T18:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222238",
    "user": "https://github.com/jdemeyer"
}
```

My proposal to fix this ticket would be to get rid completely of the "script_subdirectory" argument, it's a broken design.



---

archive/issue_comments_222239.json:
```json
{
    "body": "OK, perhaps not get rid of \"script_directory\" completely, but only use it for scripts which are known to be shipped with Sage, e.g. some PARI/GP scripts.",
    "created_at": "2014-09-26T18:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222239",
    "user": "https://github.com/jdemeyer"
}
```

OK, perhaps not get rid of "script_directory" completely, but only use it for scripts which are known to be shipped with Sage, e.g. some PARI/GP scripts.



---

archive/issue_comments_222240.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-09-26T19:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222240",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_222241.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-26T19:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222241",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_222242.json:
```json
{
    "body": "This fixes the bug, but I still have to run doctests.",
    "created_at": "2014-09-26T19:50:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222242",
    "user": "https://github.com/jdemeyer"
}
```

This fixes the bug, but I still have to run doctests.



---

archive/issue_comments_222243.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-27T09:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222243",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_222244.json:
```json
{
    "body": "Doctests pass.",
    "created_at": "2014-09-27T09:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222244",
    "user": "https://github.com/jdemeyer"
}
```

Doctests pass.



---

archive/issue_comments_222245.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-09-27T09:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222245",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_222246.json:
```json
{
    "body": "Hello,\n\nI am not sure at all to be competent to review this ticket. As far as I can tell, this looks good.\n\nI allowed myself to remove a few unused imports (except one which is in fact used in an indirect way) and one unused variable.\n\nJeroen, you can set this to positive review if you want.",
    "created_at": "2014-09-30T15:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222246",
    "user": "https://github.com/fchapoton"
}
```

Hello,

I am not sure at all to be competent to review this ticket. As far as I can tell, this looks good.

I allowed myself to remove a few unused imports (except one which is in fact used in an indirect way) and one unused variable.

Jeroen, you can set this to positive review if you want.



---

archive/issue_comments_222247.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-30T15:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222247",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_222248.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-30T15:20:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222248",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_049592.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-10-02T16:21:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16807#event-49592"
}
```



---

archive/issue_comments_222249.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-10-02T16:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16807",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16807#issuecomment-222249",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
