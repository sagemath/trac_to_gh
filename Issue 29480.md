# Issue 29480: Cubic Hecke Algebras

Issue created by migration from https://trac.sagemath.org/ticket/29717

Original creator: soehms

Original creation time: 2020-05-20 10:25:27

CC:  tscrim

Keywords: cubic Hecke algebra braid group

Cubic Hecke Algebras are factors of the group algebra of the Artin braid groups, such that the images `s_i` of the braid generators satisfy a cubic equation:


```
    s_i^3 = u s_i^2 - v s_i + w
```


Here `u, v, w` are elements in an arbitrary integral domain and `i` is a positive integer less than `n`, the number of the braid group's strands. By the analogue to the
[Iwahori Hecke algebras](https://en.wikipedia.org/wiki/Iwahori%E2%80%93Hecke_algebra) ([Sage class](http://doc.sagemath.org/html/en/reference/algebras/sage/algebras/iwahori_hecke_algebra.html?highlight=iwahori%20hecke#module-sage.algebras.iwahori_hecke_algebra)) in which the braid generators satisfy a quadratic relation these algebras have been called _cubic Hecke algebras_. The relations inherited from the braid group are:


```
    s_i s_{i+1} s_i = s_{i+1} s_i s_{i+1} \mbox{ where } 1\leq i < n-1 \mbox{ and }
    s_i s_j = s_j s_i \mbox{ where } 1 \leq i < j - 1 < n - 1.
```


If the ring elements `u, v, w`  are taken to be `u = v = 0, w = 1` the cubic Hecke algebra specializes to the group algebra of the [cubic braid group](http://doc.sagemath.org/html/en/reference/groups/sage/groups/cubic_braid.html?highlight=cubic%20braid#module-sage.groups.cubic_braid),
which is the factor group of the Artin braid group setting the generators order to be three.

More information on these algebras can be found in ["A  MAXIMAL  CUBIC  QUOTIENT  OF  THE  BRAID  ALGEBRA"](http://www.lamfa.u-picardie.fr/marin/arts/GQ.pdf) and the references given there.

This ticket implements a class to work with them. It uses [data files](http://www.lamfa.u-picardie.fr/marin/representationH4-en.html) supplied by Iwan Marin for a basis of the cubic Hecke algebras up to 4 strands and corresponding regular representation matrices. The implementation is experimental with respect to the following two aspects:

1. In a technical sense, since this class will cache results in the file system, for example: images of braids to accelerate the calculation of images of longer braid words or products of basis elements.
2. In a mathematical sense, since the cubic Hecke algebra on more than 4 strands is not equipped with an appropriate basis (not even an algorithm to produce a flat basis according to Iwan Marin's work on the five strand cubic Hecke algebra).
   At the moment, the "basis" for the algebras on more than 4 strands grows randomly (starting from the one from the data files) according to the users action, without any guarantee that this would lead to a generating set behaving good under specializations.

In general, it would be desirable to replace the dependence on the data files by algorithms implemented in this class. This would make sense as soon as such algorithms have been found which cover the case of five strands, as well.


The code is spread over two existing directories: `src/sage/algebras/hecke_algebras/, src/sage/databases` and two new sub directories in the former one: `base_rings_of_definition` and `matrix_representations`. Both of the new directories contain just one module. Their purpose is to describe the special properties of matrix representations and base rings concerning the cubic Hecke algebra. Thus, in the latter case the corresponding module contains special classes for the most general base ring of the algebra (called the _ring of definition_) and a corresponding ring for the coefficients of the split irreducible matrix representations.

From the point of view of the algebra the ring of definition must not necessarily contain the roots of the defining cubic equation. Thus, it is defined by `\Z[u, v, w, w^(-1)]` where the indeterminates are taken from the coefficients of the underlying cubic equation `x**3 - u*x**2 + v*x - w`. But, concerning the split irreducible representations the roots (in Ivan Marin's papers often denoted `a, b, c`) are needed, and in addition a third root of unity (for the nine-dimensional representations of the cubic Hecke algebra on 4 strands). Accordingly, this ring is realized as a Laurent polynomial ring in `a, b, c` over `\Z` adjoined with a third root of unity. It can be considered as an extension of the ring of definition, more precisely as the [link ticket splitting algebra] of the cubic equation.

These both classes of base rings posses a method `create_specialization` which allows the user to consider cubic Hecke algebras over other base rings. Thus, the user may choose his own coefficients or roots of the cubic equation as long, as they define a valid ring homomorphism from the corresponding generic base ring.

The module for the matrix representations contains enum classes to specify the type of the representation (left regular, right regular, split irreducible) and to specify a certain irreducible. Furthermore, it implements parent and element classes for a faithful representation (at least in the case of less than 5 strands) in block diagonal structure with irreducibles blocks (in the case of that representation type).

Everything that has to do with the access to the data files and the file cache is implemented in `src/sage/databases/cubic_hecke_db.py`. The data files are stored in `local/share/cubic_hecke_marin/` and the file cache in `$HOME/.sage/db/cubic_hecke/`. The former ones are created via the sage-package `cubic_hecke_marin` (from the attached tarball) at build time and the later one at runtime.


---

Comment by soehms created at 2020-05-20 10:26:51

tarball for data files


---

Attachment


---

Comment by git created at 2020-05-21 09:42:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-05-21 09:45:12

Lets see if the patchbots can do that!


---

Comment by soehms created at 2020-05-21 09:45:12

Changing status from new to needs_review.


---

Comment by git created at 2020-05-24 06:47:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-03 08:35:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-16 13:37:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-06-16 13:39:06

I just merged in the fixes of #29716.


---

Comment by git created at 2020-07-03 07:42:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-31 20:07:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2020-11-01 09:52:36

I will change the database integration in a similar way as I did in #30352.


---

Comment by soehms created at 2020-11-01 09:52:36

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-29 06:13:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-03-29 06:14:42

After a long break I do some major changes, now:

1.  As announced in the previous comment I change the integration of the database. It now consists of a static part covering the cubic Hecke algebras on at most 3 strand (according to the demonstration cases of the KnotInfo database) and an [optional extension](https://pypi.org/project/database-cubic-hecke) serving for the larger algebras. It can be installed via `pip`. The branch of this ticket represents the stand alone part so that the patchbots will check that everything is o.K. if the optional package is not present. In order to test the integration of the optional package I will open another ticket which will be tested via [GitHub](GitHub) actions.

2. I add another functionality to obtain Markov traces on the cubic Hecke algebras (method `formal_markov_trace`). 

3. I change the construction of the base ring of definition using localization of multivariate polynomial ring over the integers after this is available now.

4. A lot of improvements concerning style and documentation.


---

Comment by soehms created at 2022-03-29 06:18:04

I accidentally merged in #33581 and #33584 but that should not matter!


---

Comment by git created at 2022-03-29 06:38:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-03-29 15:43:02

> I will open another ticket which will be tested via [GitHub](GitHub) actions.

This is #33590.


---

Comment by soehms created at 2022-03-29 17:43:43

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-03-30 01:01:20

Shouldn't the database ticket be a dependency of this one?

I don't think we need the subfolders `base_rings_of_definitions` and `matrix_representations` since they effectively only contain one file.

There is one failure reported by the patchbot that needs to be fixed:

```
sage -t --long --random-seed=191203056443036684306219620613401301840 src/sage/doctest/sources.py
**********************************************************************
File "src/sage/doctest/sources.py", line 782, in sage.doctest.sources.FileDocTestSource._test_enough_doctests
Failed example:
    for path, dirs, files in itertools.chain(os.walk('sage'), os.walk('doc')): # long time
        path = os.path.relpath(path)
        dirs.sort(); files.sort()
        for F in files:
            _, ext = os.path.splitext(F)
            if ext in ('.py', '.pyx', '.pxd', '.pxi', '.sage', '.spyx', '.rst'):
                filename = os.path.join(path, F)
                FDS = FileDocTestSource(filename, DocTestDefaults(long=True, optional=True, force_lib=True))
                FDS._test_enough_doctests(verbose=False)
Expected:
    There are 3 unexpected tests being run in sage/doctest/parsing.py
    There are 1 unexpected tests being run in sage/doctest/reporting.py
Got:
    There are 2 tests in sage/databases/cubic_hecke_db.py that are not being run
    There are 3 unexpected tests being run in sage/doctest/parsing.py
    There are 1 unexpected tests being run in sage/doctest/reporting.py
**********************************************************************
```


Some `Returns` -> `Return` in docstrings.

For `TestSuite`, you can implement `some_elements()` with the more interesting elements too.

Perhaps instead of `CubicHeckeRingOfDefinition`, maybe `CubicHeckeUniversalRing`? The term "ring of definition" is a bit strange to me, and a bit too generic of a name.

For `extension_ring()`, I think the extension ring should be the one setting the coercions rather than that method. It feels strange that the method is doing something that the class should "know" how to do.

There are some `$` in the docstrings to become ```.

Saying `optional default:` is redundant. I would remove `optional`.


```diff
-    TESTS:
+    TESTS::
 
         sage: CHA3 = algebras.CubicHecke(3)
         sage: TestSuite(CHA3).run()
```


Instead of setting `self._names = names`, I think it is better to pass it up to the `CombinatorialFreeModule.__init__`.

I will probably have more comments as I go further through the code, but this (still) is a very nice piece of code that I am looking forward to getting merged into Sage.


---

Comment by git created at 2022-04-01 06:41:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-04-01 06:56:14

Replying to [comment:22 tscrim]:
> Shouldn't the database ticket be a dependency of this one?
> 

No, the other way around. I intend to have this branch tested by patchbots (without the database installed).

> I don't think we need the subfolders `base_rings_of_definitions` and `matrix_representations` since they effectively only contain one file.
> 

So what place do you suggest for these files? I didn't want to have them inside `hecke_algebras` since they describe no Hecke algebras for themselves.
Furthermore, these directories could be used in future, for example if we implement a wrapper around CHEVIE's cyclotomic Hecke algebras. Many of these have specific demands for their generic base rings and all come along with matrix representations.

> There is one failure reported by the patchbot that needs to be fixed ...
> 

Fixed.

> Some `Returns` -> `Return` in docstrings.
> 

Fixed.

> For `TestSuite`, you can implement `some_elements()` with the more interesting elements too.
> 

At the moment the test for associativity already takes long time with one (interesting) element (for the algebra on four strands up to half an hour, if the filecache is empty). I fear that will increase a lot if there are more elements.

> Perhaps instead of `CubicHeckeRingOfDefinition`, maybe `CubicHeckeUniversalRing`? The term "ring of definition" is a bit strange to me, and a bit too generic of a name.
> 

I asked Ivan Marin for a suggestion for that name (my suggestion was the same as yours). Here his argumentation (dating from July 2019) that convinced me:

>  Other terminology which are compatible with algebraic geometry and which I sometimes use are "ring of definition", "defining rings". I prefer these terms to "universal base rings", because in that case the problem is : universal among what ? Every possible specialization ? Kind of chicken and egg problem...

But you are right, this is not commonly used and to be honest: at the moment I don't see his _chicken and egg problem_ any more.


> For `extension_ring()`, I think the extension ring should be the one setting the coercions rather than that method. It feels strange that the method is doing something that the class should "know" how to do.
> 

I don't understand your point here. Should the method `extension_ring` return a coercion map rather than a ring? Or do you mean that it is redundant?

> There are some `$` in the docstrings to become ```.
> 

Fixed.

> Saying `optional default:` is redundant. I would remove `optional`.
> 

Fixed.

> {{{#!diff
> -    TESTS:
> +    TESTS::
>  
>          sage: CHA3 = algebras.CubicHecke(3)
>          sage: TestSuite(CHA3).run()
> }}}
> 

Fixed.

> Instead of setting `self._names = names`, I think it is better to pass it up to the `CombinatorialFreeModule.__init__`.
> 

Fixed.

> I will probably have more comments as I go further through the code, but this (still) is a very nice piece of code that I am looking forward to getting merged into Sage.

Many thanks!


---

Comment by tscrim created at 2022-04-01 09:05:35

Replying to [comment:24 soehms]:
> Replying to [comment:22 tscrim]:
> > Shouldn't the database ticket be a dependency of this one?
> No, the other way around. I intend to have this branch tested by patchbots (without the database installed).

The patchbots test things without installing optional packages (unless their owners have installed them, but generally that is not the case).  I would think logically you want to have this tested with the package, which can be merged without this (albeit with limited use within Sage by default). Well, it's not anything important as they will likely be merged at the same time.

> > I don't think we need the subfolders `base_rings_of_definitions` and `matrix_representations` since they effectively only contain one file.
> > 
> 
> So what place do you suggest for these files? I didn't want to have them inside `hecke_algebras` since they describe no Hecke algebras for themselves.

I would place them in there because they are used to create the Hecke algebras in question. I don't see what difference it makes for it being a subfolder as it just adds more complexity to the file hierarchy.

> Furthermore, these directories could be used in future, for example if we implement a wrapper around CHEVIE's cyclotomic Hecke algebras. Many of these have specific demands for their generic base rings and all come along with matrix representations.

If it makes sense to do this because the files in that directory become sufficiently complicated, then we can do it then. However, where we are now, it makes things more cumbersome, not less.

> > Perhaps instead of `CubicHeckeRingOfDefinition`, maybe `CubicHeckeUniversalRing`? The term "ring of definition" is a bit strange to me, and a bit too generic of a name.
> > 
> 
> I asked Ivan Marin for a suggestion for that name (my suggestion was the same as yours). Here his argumentation (dating from July 2019) that convinced me:
> 
> >  Other terminology which are compatible with algebraic geometry and which I sometimes use are "ring of definition", "defining rings". I prefer these terms to "universal base rings", because in that case the problem is : universal among what ? Every possible specialization ? Kind of chicken and egg problem...
> 
> But you are right, this is not commonly used and to be honest: at the moment I don't see his _chicken and egg problem_ any more.

Something like this perhaps:

Q1: Universal wrt to what?\\
A1: A Hecke algebra with a universal base ring\\
Q2: What is its universal base ring?\\
A2: See Q1.

Personally I think we get a more explicit chicken-and-egg-problem with "ring of definition." I also would not know how to make sense of this ring from the name. Well, it isn't anything that needs to be changed.

> > For `extension_ring()`, I think the extension ring should be the one setting the coercions rather than that method. It feels strange that the method is doing something that the class should "know" how to do.
> > 
> 
> I don't understand your point here. Should the method `extension_ring` return a coercion map rather than a ring? Or do you mean that it is redundant?

No, it is about who is saying there is a coercion from `B -> E`. Is it in `B.e()` or in `E`? The standard way is `E._coerce_map_from_()`, which can also be done from a particular morphism. Additionally, since `E` should be a `UniqueRepresentation`, there should not be any caching in `e()` (which can and usually does) create memory leaks. `E` should allow itself to be removed from memory when there is no way to obtain it from the current references. Basically it is about moving the line:

```
ExtensionRing.register_conversion(embedding_into_extension_ring)
```

and the other related code necessary to do this.

> > I will probably have more comments as I go further through the code, but this (still) is a very nice piece of code that I am looking forward to getting merged into Sage.
> 
> Many thanks!

Sorry for the limited reply. I am finishing up my day. I should be able to get through more of this next week.


---

Comment by git created at 2022-04-03 20:48:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-04-03 20:54:28

Replying to [comment:25 tscrim]:
> Replying to [comment:24 soehms]:
> > Replying to [comment:22 tscrim]:
> > > Shouldn't the database ticket be a dependency of this one?
> > No, the other way around. I intend to have this branch tested by patchbots (without the database installed).
> 
> The patchbots test things without installing optional packages (unless their owners have installed them, but generally that is not the case).  I would think logically you want to have this tested with the package, which can be merged without this (albeit with limited use within Sage by default). Well, it's not anything important as they will likely be merged at the same time.
> 

You are right, I expected that the patchbots will not run on #33590 since it has modified files under `build/pkgs`. I expected a purple cube instead of the patchbot badged. But astonishingly the patchbot run on that branch after I set _needs review_ as well. So there is no need for that ticket any more. I merge it into this and will close it as duplicate.


> > > I don't think we need the subfolders `base_rings_of_definitions` and `matrix_representations` since they effectively only contain one file.
> > > 
> > 
> > So what place do you suggest for these files? I didn't want to have them inside `hecke_algebras` since they describe no Hecke algebras for themselves.
> 
> I would place them in there because they are used to create the Hecke algebras in question. I don't see what difference it makes for it being a subfolder as it just adds more complexity to the file hierarchy.
> 
> > Furthermore, these directories could be used in future, for example if we implement a wrapper around CHEVIE's cyclotomic Hecke algebras. Many of these have specific demands for their generic base rings and all come along with matrix representations.
> 
> If it makes sense to do this because the files in that directory become sufficiently complicated, then we can do it then. However, where we are now, it makes things more cumbersome, not less.
> 

Convinced! I will do that on a next step.


> > > Perhaps instead of `CubicHeckeRingOfDefinition`, maybe `CubicHeckeUniversalRing`? The term "ring of definition" is a bit strange to me, and a bit too generic of a name.
> > > 
> > 
> > I asked Ivan Marin for a suggestion for that name (my suggestion was the same as yours). Here his argumentation (dating from July 2019) that convinced me:
> > 
> > >  Other terminology which are compatible with algebraic geometry and which I sometimes use are "ring of definition", "defining rings". I prefer these terms to "universal base rings", because in that case the problem is : universal among what ? Every possible specialization ? Kind of chicken and egg problem...
> > 
> > But you are right, this is not commonly used and to be honest: at the moment I don't see his _chicken and egg problem_ any more.
> 
> Something like this perhaps:
> 
> Q1: Universal wrt to what?\\
> A1: A Hecke algebra with a universal base ring\\
> Q2: What is its universal base ring?\\
> A2: See Q1.
> 

Yes, that's the point!

> Personally I think we get a more explicit chicken-and-egg-problem with "ring of definition." I also would not know how to make sense of this ring from the name. Well, it isn't anything that needs to be changed.
> 

I add an according explanation to the docstring.

> > > For `extension_ring()`, I think the extension ring should be the one setting the coercions rather than that method. It feels strange that the method is doing something that the class should "know" how to do.
> > > 
> > 
> > I don't understand your point here. Should the method `extension_ring` return a coercion map rather than a ring? Or do you mean that it is redundant?
> 
> No, it is about who is saying there is a coercion from `B -> E`. Is it in `B.e()` or in `E`? The standard way is `E._coerce_map_from_()`, which can also be done from a particular morphism. Additionally, since `E` should be a `UniqueRepresentation`, there should not be any caching in `e()` (which can and usually does) create memory leaks. `E` should allow itself to be removed from memory when there is no way to obtain it from the current references. Basically it is about moving the line:
> {{{
> ExtensionRing.register_conversion(embedding_into_extension_ring)
> }}}
> and the other related code necessary to do this.
> 

I misunderstood that because I was looking at the wrong `extension_ring` method (that of `CubicHeckeAlgebra`). I have fixed this, now.


---

Comment by git created at 2022-04-04 06:48:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-04-05 06:21:19

The current patchbot failures seem to be caused by a leftover file cache. I will see how I can ensure these to be cleared.

The [first workflow run](https://github.com/soehms/sage/actions/runs/2088022012) including all optional tests (`database_cubic_hecke` + `gap3`) are fine (the build failures on some platforms seem to be unrelated). For example [gentoo python 3.10](https://github.com/soehms/sage/suites/5917098133/artifacts/202912636):


```
Using --optional=database_cubic_hecke,gap3,sage
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_cubic_hecke,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Sorting sources by runtime so that slower doctests are run first....
Doctesting 9 files using 3 threads.
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/__init__.py
    [0 tests, 0.00 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/all.py
    [0 tests, 0.00 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/base_rings_of_definition/__init__.py
    [0 tests, 0.00 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/ariki_koike_algebra.py
    [263 tests, 16.69 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/matrix_representations/__init__.py
    [0 tests, 0.00 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/base_rings_of_definition/cubic_hecke_base_ring.py
    [225 tests, 13.29 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/matrix_representations/cubic_hecke_matrix_rep.py
    [131 tests, 7.40 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 databases/cubic_hecke_db.py
    [171 tests, 8.86 s]
sage -t --long --random-seed=104303597285919165653703494900311160938 algebras/hecke_algebras/cubic_hecke_algebra.py
    [373 tests, 218.98 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 229.3 seconds
    cpu time: 237.0 seconds
    cumulative wall time: 265.2 seconds
Features detected for doctesting: 
Pytest is not installed, skip checking tests that rely on it.
```



---

Comment by mkoeppe created at 2022-04-05 21:44:33

The new package in `build/pkgs/database_cubic_hecke` and the additions in `sage.features` look OK. I would only suggest to shorten the title in SPKG.rst a bit.
I can't comment on the other parts of the ticket.


---

Comment by git created at 2022-04-06 06:24:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-04-06 06:32:13

The former commit removes the last dependency on the Sage library from the file-cache (it now consists of nothing else than dictionaries, lists, tuples, integers and strings).

The expected behavior for the patchbot which did the two jobs for this ticket would be to raise the new exception. All other patchbots should be green.
Is there a way to clean `SAGE_DOT` files on that special patchbot?

The [GitHub jobs](https://github.com/soehms/sage/actions/runs/2094438982) running on the commit with the dropped directories look good. But note, that not all jobs did test for gap3 ([linux-mint-18](https://github.com/soehms/sage/suites/5933695249/artifacts/203950529) did [fedora-36](https://github.com/soehms/sage/suites/5933695249/artifacts/203950526) did not).


---

Comment by soehms created at 2022-04-06 06:33:17

Replying to [comment:31 mkoeppe]:
> The new package in `build/pkgs/database_cubic_hecke` and the additions in `sage.features` look OK. I would only suggest to shorten the title in SPKG.rst a bit.

This is done, now. Thanks for having a look at it!


---

Comment by git created at 2022-05-02 17:30:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-05-02 17:39:00

Although there shouldn't be any space left for further file-cache incompatibilities, I make another according change. I think it's better to move an incompatible file automatically away and raise a warning instead of an exception. 

At least this should result in a self-healing of the patchbot having a corrupted file-cache ([tmonteil-lxc1-standard-nodistro](https://patchbot.sagemath.org/log/29717/Linux/1_SMP_Debian_5.10.106-1_(2022-03-17)/x86_64/5.10.0-13-amd64/tmonteil-lxc1-standard-nodistro/2022-04-21%2001:30:34),  the other one [pc72-math](https://patchbot.sagemath.org/log/29717/Linux/102-Ubuntu_SMP_Fri_Nov_5_16:31:28_UTC_2021/x86_64/5.4.0-91-generic/pc72-math/2022-04-06%2015:52:45) seems to be clean again). If this patchbots will run on an upcoming test the expected behavior is that there should be exactly one failure due to the warning. All following tests should be green.

The GitHub tests on the current commit are running [here](https://github.com/soehms/sage/actions/runs/2259407836)!


---

Comment by git created at 2022-08-12 15:59:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-08-12 16:05:00

The previous commit takes acount of #7989 and #33852.


---

Comment by git created at 2022-08-13 12:43:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-08-16 09:17:37

I have gone through the doc and code. I have made a bunch of reviewer changes and a few code simplifications. I only have the following question now:

Can the result of `formal_markov_trace` ever be `0`? If so, what should the parent of the result be?

Beyond that, I think everything is okay and ready for a positive review. (Unfortunately this is not so likely to make it into 9.7. `:/` Sorry for being really slow on the review.)
----
New commits:


---

Comment by git created at 2022-08-16 09:17:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by soehms created at 2022-08-17 16:04:53

Replying to [comment:40 tscrim]:
> I have gone through the doc and code. I have made a bunch of reviewer changes and a few code simplifications. 

Thanks a lot, Travis! It's much improved, now!

> Can the result of `formal_markov_trace` ever be `0`? 

Yes (at least for elements which are not braid images):


```sage
sage: CHA3 = algebras.CubicHecke(3)
sage: CHA3.inject_variables()
Defining c0, c1
sage: d = c0 * ~c1 * c0 * ~c1 - ~c0 * c1 * ~c0 * c1; d
v/w*c0*c1^-1*c0 + (-u)*c0^-1*c1*c0^-1 + ((-v)/w)*c1*c0^-1*c1 + u/w*c0*c1*c0^-1*c1 + u*v/w*c1*c0^-1 + ((-u^2)/w)*c0*c1*c0^-1
sage: fmt = d.formal_markov_trace(); fmt
0
sage: fmt.parent()
Free module generated by {U1, U2, U3, K4} over Multivariate Polynomial Ring in u, v, w, s over Integer Ring localized at (s, w, v, u)
```


> If so, what should the parent of the result be?

I think it's o.k. as it is, right?


> 
> (Unfortunately this is not so likely to make it into 9.7. `:/` Sorry for being really slow on the review.)

No problem! Good thinks take time. Also, compared to the size of the branch and the amount of other reviews you do, I don't think that you are slow.


Reading your changes I found some more typos which I fix in the previous commit. Furthermore, since we now have the Links Gould polynomial I add a check of the formal Markov trace against it.
----
New commits:


---

Comment by tscrim created at 2022-08-17 23:51:54

Replying to [comment:43 soehms]:
> Replying to [comment:40 tscrim]:
> > Can the result of `formal_markov_trace` ever be `0`? 
> 
> Yes (at least for elements which are not braid images):
> 
> {{{#!sage
> sage: CHA3 = algebras.CubicHecke(3)
> sage: CHA3.inject_variables()
> Defining c0, c1
> sage: d = c0 * ~c1 * c0 * ~c1 - ~c0 * c1 * ~c0 * c1; d
> v/w*c0*c1^-1*c0 + (-u)*c0<sup>-1*c1*c0</sup>-1 + ((-v)/w)*c1*c0^-1*c1 + u/w*c0*c1*c0^-1*c1 + u*v/w*c1*c0^-1 + ((-u<sup>2)/w)*c0*c1*c0</sup>-1
> sage: fmt = d.formal_markov_trace(); fmt
> 0
> sage: fmt.parent()
> Free module generated by {U1, U2, U3, K4} over Multivariate Polynomial Ring in u, v, w, s over Integer Ring localized at (s, w, v, u)
> }}}

I should refine my question a bit. Could `vs` ever be empty?

> > If so, what should the parent of the result be?
> 
> I think it's o.k. as it is, right?

If the above happens, then it will return an `int`. Actually, I guess this could be fixed by simply doing `M.sum()` instead of `sum()`.

> Reading your changes I found some more typos which I fix in the previous commit. Furthermore, since we now have the Links Gould polynomial I add a check of the formal Markov trace against it.

Thank you. Although thinking a bit more, is there a reason why we want the `formal_markov_trace()` to be a vector space element? Mainly, I am wondering if it makes sense to have `U1`, `U2`, `U3`, and `K4` be generators of a multivariate polynomial ring.


---

Comment by soehms created at 2022-08-18 15:58:59

Replying to [comment:44 tscrim]:
> Replying to [comment:43 soehms]:
> > Replying to [comment:40 tscrim]:
> ...
> I should refine my question a bit. Could `vs` ever be empty?

I would say: no (since the default of `sparse` in `to_vector` is `False`).

> .. Actually, I guess this could be fixed by simply doing `M.sum()` instead of `sum()`.


Anyway, this change can not be wrong. But benchmarks show a remarkable difference:


with `sum()`:


```sage
sage: CHA4 = algebras.CubicHecke(4)
sage: t = CHA4(KnotInfo.K9_42.braid())
sage: %time t.formal_markov_trace()
CPU times: user 103 ms, sys: 0 ns, total: 103 ms
Wall time: 102 ms
((-u*v^2*s^4-u*v^3*s^2+v*w*s^4+v^2*w*s^2+u*v*w^2)/(w^3*s))*B[U1] + ((u^2*v^2*s^2-u*v*w*s^2)/w^3)*B[U2] + ((-v^2*s^2+u*w*s^2-u*v*w+w^2)/(w^2*s))*B[K4] + ((u*v^2-v*w)/w^2)*B[K4U] + ((v^2-u*w)/w^2)*B[K6]
```


with `M.sum()`:


```sage
sage: CHA4 = algebras.CubicHecke(4)
sage: t = CHA4(KnotInfo.K9_42.braid())
sage: %time t.formal_markov_trace()
CPU times: user 4.25 s, sys: 0 ns, total: 4.25 s
Wall time: 4.24 s
((-u*v^2*s^4-u*v^3*s^2+v*w*s^4+v^2*w*s^2+u*v*w^2)/(w^3*s))*B[U1] + ((u^2*v^2*s^2-u*v*w*s^2)/w^3)*B[U2] + ((-v^2*s^2+u*w*s^2-u*v*w+w^2)/(w^2*s))*B[K4] + ((u*v^2-v*w)/w^2)*B[K4U] + ((v^2-u*w)/w^2)*B[K6]
```



> Although thinking a bit more, is there a reason why we want the `formal_markov_trace()` to be a vector space element? Mainly, I am wondering if it makes sense to have `U1`, `U2`, `U3`, and `K4` be generators of a multivariate polynomial ring.

Actually, my first version was like that. But I think the module version is closer to the mathematical structure. The polynomial version could be misleading since no higher powers of the generators `U1`, `U2`, `U3`, and `K4` are possible. If you agree I would add a boolean keyword `as_polynomial` to have the vector converted to such a polynomial for convenience. But I would prefer the default being `False`.


---

Comment by tscrim created at 2022-08-19 01:26:58

Replying to [comment:45 soehms]:
> Replying to [comment:44 tscrim]:
> > Replying to [comment:43 soehms]:
> > > Replying to [comment:40 tscrim]:
> > I should refine my question a bit. Could `vs` ever be empty?
> 
> I would say: no (since the default of `sparse` in `to_vector` is `False`).

Okay, then we don't have to worry too much about this.

Actually, that gives me an idea for another micro-optimization that I have done.

> > .. Actually, I guess this could be fixed by simply doing `M.sum()` instead of `sum()`.
> 
> Anyway, this change can not be wrong. But benchmarks show a remarkable difference:
> 
> 
> with `sum()`:
> 
> {{{#!sage
> sage: CHA4 = algebras.CubicHecke(4)
> sage: t = CHA4(KnotInfo.K9_42.braid())
> sage: %time t.formal_markov_trace()
> CPU times: user 103 ms, sys: 0 ns, total: 103 ms
> Wall time: 102 ms
> ((-u*v<sup>2*s</sup>4-u*v<sup>3*s</sup>2+v*w*s<sup>4+v</sup>2*w*s<sup>2+u*v*w</sup>2)/(w^3*s))*B[U1] + ((u<sup>2*v</sup>2*s<sup>2-u*v*w*s</sup>2)/w^3)*B[U2] + ((-v<sup>2*s</sup>2+u*w*s<sup>2-u*v*w+w</sup>2)/(w^2*s))*B[K4] + ((u*v<sup>2-v*w)/w</sup>2)*B[K4U] + ((v<sup>2-u*w)/w</sup>2)*B[K6]
> }}}
> 
> with `M.sum()`:
> 
> {{{#!sage
> sage: CHA4 = algebras.CubicHecke(4)
> sage: t = CHA4(KnotInfo.K9_42.braid())
> sage: %time t.formal_markov_trace()
> CPU times: user 4.25 s, sys: 0 ns, total: 4.25 s
> Wall time: 4.24 s
> ((-u*v<sup>2*s</sup>4-u*v<sup>3*s</sup>2+v*w*s<sup>4+v</sup>2*w*s<sup>2+u*v*w</sup>2)/(w^3*s))*B[U1] + ((u<sup>2*v</sup>2*s<sup>2-u*v*w*s</sup>2)/w^3)*B[U2] + ((-v<sup>2*s</sup>2+u*w*s<sup>2-u*v*w+w</sup>2)/(w^2*s))*B[K4] + ((u*v<sup>2-v*w)/w</sup>2)*B[K4U] + ((v<sup>2-u*w)/w</sup>2)*B[K6]
> }}}

Something has been cached the result for the top computation from the bottom. I first ran the `sum` and then the `M.sum`. Both times I got

```
CPU times: user 1.16 s, sys: 0 ns, total: 1.16 s
Wall time: 1.16 s
```

but the first time took noticeably longer; by my estimate around 5s.

I have changed the line altogether in my recent push.

> > Although thinking a bit more, is there a reason why we want the `formal_markov_trace()` to be a vector space element? Mainly, I am wondering if it makes sense to have `U1`, `U2`, `U3`, and `K4` be generators of a multivariate polynomial ring.
> 
> Actually, my first version was like that. But I think the module version is closer to the mathematical structure. The polynomial version could be misleading since no higher powers of the generators `U1`, `U2`, `U3`, and `K4` are possible. If you agree I would add a boolean keyword `as_polynomial` to have the vector converted to such a polynomial for convenience. But I would prefer the default being `False`.

No, there is no need to make it more complicated like that. It is more if you would expect the user to specialize the aforementioned parameters. Being a CFM element means that is not "easy" to do (it isn't hard, but it takes a little more thought than just `p.subs()`).

I realized I forgot to go over `cubic_braid.py`. I also was able to significantly speed up the infinite dimensional construction (at least for 6 strands).
----
New commits:


---

Comment by git created at 2022-08-19 05:47:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-08-19 07:22:28

Replying to [comment:46 tscrim]:
> Replying to [comment:45 soehms]:
> > Replying to [comment:44 tscrim]:
> ....
> 
> Something has been cached the result for the top computation from the bottom. I first ran the `sum` and then the `M.sum`. Both times I got
> {{{
> CPU times: user 1.16 s, sys: 0 ns, total: 1.16 s
> Wall time: 1.16 s
> }}}
> but the first time took noticeably longer; by my estimate around 5s.
> 

You are right, that is loading the coefficients for the 4-strand Markov trace from the database.

> I have changed the line altogether in my recent push.

Great! With your current changes I now get:


```
sage: CHA4 = algebras.CubicHecke(4)
sage: %time CHA4.one().formal_markov_trace()
CPU times: user 5.81 s, sys: 0 ns, total: 5.81 s
Wall time: 5.88 s
B[U4]
sage: t = CHA4(KnotInfo.K9_42.braid())
sage: %time t.formal_markov_trace()
CPU times: user 15.6 ms, sys: 0 ns, total: 15.6 ms
Wall time: 25.5 ms
((-u*v^2*s^4-u*v^3*s^2+v*w*s^4+v^2*w*s^2+u*v*w^2)/(w^3*s))*B[U1] + ((u^2*v^2*s^2-u*v*w*s^2)/w^3)*B[U2] + ((-v^2*s^2+u*w*s^2-u*v*w+w^2)/(w^2*s))*B[K4] + ((u*v^2-v*w)/w^2)*B[K4U] + ((v^2-u*w)/w^2)*B[K6]
```




> 
>> .. If you agree I would add a boolean keyword `as_polynomial` to have the vector converted to such a polynomial for convenience. But I would prefer the default being `False`.
> 
> No, there is no need to make it more complicated like that. It is more if you would expect the user to specialize the aforementioned parameters. Being a CFM element means that is not "easy" to do (it isn't hard, but it takes a little more thought than just `p.subs()`).
> 

That's correct. I'll think about a way to make it more convenient for the user (after my vacation, which will be in the next two weeks), for example, supporting the definition of a map. But I think that might be a follow-up ticket.


> I realized I forgot to go over `cubic_braid.py`. I also was able to significantly speed up the infinite dimensional construction (at least for 6 strands).

Great! Very good improvement. Thanks a lot again!


---

Comment by soehms created at 2022-08-19 07:28:47

Replying to [comment:47 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[f113e5c](https://git.sagemath.org/sage.git/commit/?id=f113e5c1dfe1cbef8e9f74905edbe79e29b63796)||`Doing the rest of my commit of cubic_braid.py.`||

Thanks!


---

Comment by soehms created at 2022-08-19 07:37:04

Sorry that was the woring branch!


---

Comment by soehms created at 2022-08-19 07:48:33

Correct merge Error


---

Comment by soehms created at 2022-08-19 07:54:40

Sorry much trouble for just one missing letter!

But I think the branch still wrong. I have to do it later on!


---

Comment by soehms created at 2022-08-19 09:40:43

New commits:


---

Comment by soehms created at 2022-08-19 09:43:55

Replying to [comment:53 soehms]:
> Sorry much trouble for just one missing letter!
> 
> But I think the branch still wrong. I have to do it later on!

It should be o.K. again!


---

Comment by tscrim created at 2022-08-22 03:12:01

Thanks. Then positive review.


---

Comment by tscrim created at 2022-08-22 03:12:01

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2022-08-24 11:53:58

Replying to [comment:56 tscrim]:
> Thanks. Then positive review.

Thanks a lot, as well!


---

Comment by vbraun created at 2022-08-29 11:24:18

Resolution: fixed
