# Issue 18030: libgap for PermutationGroup

archive/issues_018030.json:
```json
{
    "body": "CC:  @nthiery @tscrim\n\nAs remarked in [this question on ask.sagemath.org](http://ask.sagemath.org/question/26590/add-generator-to-a-group-combine-generators-of-two-groups/) a lot of time is spent with pexpect when playing with permutation groups.\n\nIn this ticket:\n- we interface libgap permutation group so that the following works\n\n```\nsage: p1=libgap.eval(\"(1,2,3)\")\nsage: p2=libgap.eval(\"(3,4,5)\")\nsage: p1.sage()\n(1,2,3)\nsage: G=libgap.Group([p1,p2])\nsage: G.sage()\nTraceback (most recent call last):\n...\nNotImplementedError: cannot construct equivalent Sage object\n```\n\n- we check that interesting GAP functions such as `ClosureGroup`, `AllBlocks`, are available from libgap\n- we use them in `PermutationGroup` inplace of the current gap version\n\nIssue created by migration from https://trac.sagemath.org/ticket/18267\n\n",
    "created_at": "2015-04-21T13:30:18Z",
    "labels": [
        "interfaces",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "libgap for PermutationGroup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18030",
    "user": "@videlec"
}
```
CC:  @nthiery @tscrim

As remarked in [this question on ask.sagemath.org](http://ask.sagemath.org/question/26590/add-generator-to-a-group-combine-generators-of-two-groups/) a lot of time is spent with pexpect when playing with permutation groups.

In this ticket:
- we interface libgap permutation group so that the following works

```
sage: p1=libgap.eval("(1,2,3)")
sage: p2=libgap.eval("(3,4,5)")
sage: p1.sage()
(1,2,3)
sage: G=libgap.Group([p1,p2])
sage: G.sage()
Traceback (most recent call last):
...
NotImplementedError: cannot construct equivalent Sage object
```

- we check that interesting GAP functions such as `ClosureGroup`, `AllBlocks`, are available from libgap
- we use them in `PermutationGroup` inplace of the current gap version

Issue created by migration from https://trac.sagemath.org/ticket/18267





---

archive/issue_comments_242655.json:
```json
{
    "body": "The overhead of using pexpect for GAP is *especially* serious on Cygwin.  I believe it to be one of the worst performance hits there, due to the I/O overhead.\n\nIt's so slow in fact that I wonder if there isn't a bug/defect in Cygwin related to this.  It's normal that there is some additional overhead involved for I/O on Cygwin, but this is especially bad.",
    "created_at": "2019-04-12T16:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242655",
    "user": "@embray"
}
```

The overhead of using pexpect for GAP is *especially* serious on Cygwin.  I believe it to be one of the worst performance hits there, due to the I/O overhead.

It's so slow in fact that I wonder if there isn't a bug/defect in Cygwin related to this.  It's normal that there is some additional overhead involved for I/O on Cygwin, but this is especially bad.



---

archive/issue_comments_242656.json:
```json
{
    "body": "I have a prototype for this in progress that is shaping up pretty well so far.  I will likely need help with this part:\n\n> we check that interesting GAP functions such as `ClosureGroup`, `AllBlocks`, are available from libgap\n\nas I don't know all the math well enough to write interesting tests for this.  But I can get most of the skunkworks done and then anyone else who's interested can add on to it.",
    "created_at": "2019-04-12T16:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242656",
    "user": "@embray"
}
```

I have a prototype for this in progress that is shaping up pretty well so far.  I will likely need help with this part:

> we check that interesting GAP functions such as `ClosureGroup`, `AllBlocks`, are available from libgap

as I don't know all the math well enough to write interesting tests for this.  But I can get most of the skunkworks done and then anyone else who's interested can add on to it.



---

archive/issue_comments_242657.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2019-04-12T16:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242657",
    "user": "@embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_242658.json:
```json
{
    "body": "The I/O overhead on Cygwin adds up to something on the order of 20x in this test (specially, the `_test_cellular` test).  I tracked this down to being entirely coming from the pexpect communication.  On Linux:\n\n\n```\nsage -t --long src/sage/combinat/symmetric_group_algebra.py\n    [422 tests, 30.17 s]\n```\n\n\nOn Cygwin (different machine, but with reasonably good specs):\n\n\n```\nsage -t --long src/sage/combinat/symmetric_group_algebra.py\n    [422 tests, 613.16 s]\n```\n\n\nMore than 10 minutes on this one test!  It's by far one of the slowest tests on Cygwin.  With my prototype of getting pexpect out of permutation groups I knocked this result down to (again on Cygwin):\n\n\n```\nsage -t --long src/sage/combinat/symmetric_group_algebra.py\n    [422 tests, 25.49 s]\n```\n",
    "created_at": "2019-04-12T16:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242658",
    "user": "@embray"
}
```

The I/O overhead on Cygwin adds up to something on the order of 20x in this test (specially, the `_test_cellular` test).  I tracked this down to being entirely coming from the pexpect communication.  On Linux:


```
sage -t --long src/sage/combinat/symmetric_group_algebra.py
    [422 tests, 30.17 s]
```


On Cygwin (different machine, but with reasonably good specs):


```
sage -t --long src/sage/combinat/symmetric_group_algebra.py
    [422 tests, 613.16 s]
```


More than 10 minutes on this one test!  It's by far one of the slowest tests on Cygwin.  With my prototype of getting pexpect out of permutation groups I knocked this result down to (again on Cygwin):


```
sage -t --long src/sage/combinat/symmetric_group_algebra.py
    [422 tests, 25.49 s]
```




---

archive/issue_comments_242659.json:
```json
{
    "body": "Unfortunately `src/sage/groups/perm_gps/permgroup_named.py` still remains by far one of the slowest tests on Cygwin despite my fixes.  Unclear as of yet why; maybe several tests using other code that still uses pexpect, or something else...",
    "created_at": "2019-04-12T16:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242659",
    "user": "@embray"
}
```

Unfortunately `src/sage/groups/perm_gps/permgroup_named.py` still remains by far one of the slowest tests on Cygwin despite my fixes.  Unclear as of yet why; maybe several tests using other code that still uses pexpect, or something else...



---

archive/issue_comments_242660.json:
```json
{
    "body": "Well I found one more pexpect use in permgroup_named; fixing that one knocked it down from ~5 minutes to\n\n\n```\nsage -t --long src/sage/groups/perm_gps/permgroup_named.py\n    [509 tests, 47.12 s]\n```\n\n\nWhich is still about 5 times slower for some reason than that test is on Linux, but progress!\n\nSome of the tests also intentionally use the pexpect interface directly, so nothing to do about that for now.",
    "created_at": "2019-04-12T16:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242660",
    "user": "@embray"
}
```

Well I found one more pexpect use in permgroup_named; fixing that one knocked it down from ~5 minutes to


```
sage -t --long src/sage/groups/perm_gps/permgroup_named.py
    [509 tests, 47.12 s]
```


Which is still about 5 times slower for some reason than that test is on Linux, but progress!

Some of the tests also intentionally use the pexpect interface directly, so nothing to do about that for now.



---

archive/issue_comments_242661.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-25T13:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242661",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_242662.json:
```json
{
    "body": "Here is my current prototype for getting pexpect out of permutation groups, and having them use libgap exclusively.  For the large part it is quite effective at this.  This fixes (among many other examples):\n\n\n```\nsage: G = SymmetricGroup(3)\nsage: %prun G.one()\nsage: G.one()\n()\nsage: gap._expect is None\n```\n\n\nwhere previously this was invoking a GAP process through pexpect.\n----\nLast 10 new commits:",
    "created_at": "2019-06-25T13:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242662",
    "user": "@embray"
}
```

Here is my current prototype for getting pexpect out of permutation groups, and having them use libgap exclusively.  For the large part it is quite effective at this.  This fixes (among many other examples):


```
sage: G = SymmetricGroup(3)
sage: %prun G.one()
sage: G.one()
()
sage: gap._expect is None
```


where previously this was invoking a GAP process through pexpect.
----
Last 10 new commits:



---

archive/issue_comments_242663.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-25T13:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242663",
    "user": "@embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_242664.json:
```json
{
    "body": "Unfortunately there is still a handful of failing tests with this.",
    "created_at": "2019-06-25T13:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242664",
    "user": "@embray"
}
```

Unfortunately there is still a handful of failing tests with this.



---

archive/issue_comments_242665.json:
```json
{
    "body": "I think most of the problems are coming from my hacky attempt to make some `GapElement` objects pickle-able in [fcfde85](https://git.sagemath.org/sage.git/commit/?h=75d6b764cac83c2930dff648605de98adbc506db&id=fcfde857e27b703dfed96787f639126d76f31c30) which can make some surprising results, and is maybe not quite right yet.  It should probably be handled in a separate ticket.",
    "created_at": "2019-06-25T14:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242665",
    "user": "@embray"
}
```

I think most of the problems are coming from my hacky attempt to make some `GapElement` objects pickle-able in [fcfde85](https://git.sagemath.org/sage.git/commit/?h=75d6b764cac83c2930dff648605de98adbc506db&id=fcfde857e27b703dfed96787f639126d76f31c30) which can make some surprising results, and is maybe not quite right yet.  It should probably be handled in a separate ticket.



---

archive/issue_comments_242666.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2019-06-25T15:29:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242666",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_242667.json:
```json
{
    "body": "Fixed the problems *that I knew about*, though there are likely still others.  Although this is set to \"needs_work\" it would probably be interesting-enough to start playing around with if anyone wants to review.",
    "created_at": "2019-06-25T15:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242667",
    "user": "@embray"
}
```

Fixed the problems *that I knew about*, though there are likely still others.  Although this is set to "needs_work" it would probably be interesting-enough to start playing around with if anyone wants to review.



---

archive/issue_comments_242668.json:
```json
{
    "body": "With the current version of this branch almost everything works except for a few trivial doctest failures due to new pseudo-random results in some tests.\n\nHowever, I am also getting a bizarre memory error when running the tests for `sage.combinat.tableau` that's similar to what I reported in #27681 (but later couldn't reproduce).",
    "created_at": "2019-06-25T15:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242668",
    "user": "@embray"
}
```

With the current version of this branch almost everything works except for a few trivial doctest failures due to new pseudo-random results in some tests.

However, I am also getting a bizarre memory error when running the tests for `sage.combinat.tableau` that's similar to what I reported in #27681 (but later couldn't reproduce).



---

archive/issue_comments_242669.json:
```json
{
    "body": "+1 for doing this.",
    "created_at": "2019-06-26T10:10:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242669",
    "user": "@tscrim"
}
```

+1 for doing this.



---

archive/issue_comments_242670.json:
```json
{
    "body": "If anyone would like to help test this that would be great for moving forward on this work.  In particular, it would be helpful to know if anyone can reproduce the test failure in `sage.combinat.tableau`, since from my end that is the only major blocker to completing this work.",
    "created_at": "2019-07-01T13:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242670",
    "user": "@embray"
}
```

If anyone would like to help test this that would be great for moving forward on this work.  In particular, it would be helpful to know if anyone can reproduce the test failure in `sage.combinat.tableau`, since from my end that is the only major blocker to completing this work.



---

archive/issue_comments_242671.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-04T15:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242671",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242672.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-04T15:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242672",
    "user": "@embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_242673.json:
```json
{
    "body": "All tests now pass for me on this ticket (have not tried optional packages).\n\nThe one bug I mentioned in comment:14 is now tracked at #28106 and is not directly caused by the changes I made here; rather it only exhibited due to the fact that using libgap in more places meant slightly more virtual memory was being allocated in some tests than previously, but this is expected.\n\nSo if you run into the bug with `MemoryError`s in `sage.combinat.tableau` you can pass the test runner `--memlimit=4000` or something like that.",
    "created_at": "2019-07-04T15:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242673",
    "user": "@embray"
}
```

All tests now pass for me on this ticket (have not tried optional packages).

The one bug I mentioned in comment:14 is now tracked at #28106 and is not directly caused by the changes I made here; rather it only exhibited due to the fact that using libgap in more places meant slightly more virtual memory was being allocated in some tests than previously, but this is expected.

So if you run into the bug with `MemoryError`s in `sage.combinat.tableau` you can pass the test runner `--memlimit=4000` or something like that.



---

archive/issue_comments_242674.json:
```json
{
    "body": "I have tested a bit with python3. All doctests pass in tableau-related files and in the modified files.",
    "created_at": "2019-07-07T09:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242674",
    "user": "@fchapoton"
}
```

I have tested a bit with python3. All doctests pass in tableau-related files and in the modified files.



---

archive/issue_comments_242675.json:
```json
{
    "body": "Tests pass with [surface_dynamics](https://gitlab.com/videlec/surface_dynamics) that uses `PermutationGroup`. In the same library, I also replaced many calls to `gap` by `libgap` and everything went smoothly.\n\nThanks for working on this!",
    "created_at": "2019-07-07T20:22:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242675",
    "user": "@videlec"
}
```

Tests pass with [surface_dynamics](https://gitlab.com/videlec/surface_dynamics) that uses `PermutationGroup`. In the same library, I also replaced many calls to `gap` by `libgap` and everything went smoothly.

Thanks for working on this!



---

archive/issue_comments_242676.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-08T13:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242676",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_242677.json:
```json
{
    "body": "Everything also LGTM.",
    "created_at": "2019-07-08T13:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242677",
    "user": "@tscrim"
}
```

Everything also LGTM.



---

archive/issue_comments_242678.json:
```json
{
    "body": "Changing keywords from \"\" to \"fpsac2019\".",
    "created_at": "2019-07-08T13:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242678",
    "user": "@tscrim"
}
```

Changing keywords from "" to "fpsac2019".



---

archive/issue_comments_242679.json:
```json
{
    "body": "Any reason this is sage-pending?",
    "created_at": "2019-08-05T16:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242679",
    "user": "@embray"
}
```

Any reason this is sage-pending?



---

archive/issue_comments_242680.json:
```json
{
    "body": "dependency needing work",
    "created_at": "2019-08-05T18:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242680",
    "user": "@fchapoton"
}
```

dependency needing work



---

archive/issue_comments_242681.json:
```json
{
    "body": "I think I'll just remove the dependency.  It's not actually a dependency for this ticket, especially since my solution proposed there still doesn't seem to work.  The relation between that issue and this ticket is much more indirect than I previously thought.",
    "created_at": "2019-08-06T12:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242681",
    "user": "@embray"
}
```

I think I'll just remove the dependency.  It's not actually a dependency for this ticket, especially since my solution proposed there still doesn't seem to work.  The relation between that issue and this ticket is much more indirect than I previously thought.



---

archive/issue_comments_242682.json:
```json
{
    "body": "This breaks the gap interfaces when building with SAGE_DEBUG=yes:\n\n```\n**********************************************************************\nFile \"src/sage/interfaces/gap.py\", line 732, in sage.interfaces.gap.Gap_generic._eval_line\nFailed example:\n    a = gap(3)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.gap.Gap_generic._eval_line[8]>\", line 1, in <module>\n        a = gap(Integer(3))\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 295, in __call__\n        result = self._coerce_from_special_method(x)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 323, in _coerce_from_special_method\n        return (x.__getattribute__(s))(self)\n      File \"sage/structure/sage_object.pyx\", line 693, in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:5929)\n        return self._interface_(G)\n      File \"sage/structure/sage_object.pyx\", line 669, in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5475)\n        X = I(s)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 288, in __call__\n        return cls(self, x, name=name)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1438, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 491, in _create\n        self.set(name, value)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1411, in set\n        self._eval_line(cmd, allow_use_file=True)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 746, in _eval_line\n        expect_eof= (self._quit_string() in line))\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 609, in _execute_line\n        x = E.expect_list(self._compiled_full_pattern)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/spawnbase.py\", line 369, in expect_list\n        return exp.expect_loop(timeout)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/expect.py\", line 111, in expect_loop\n        incoming = spawn.read_nonblocking(spawn.maxread, timeout)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 469, in read_nonblocking\n        self.isalive()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 704, in isalive\n        alive = ptyproc.isalive()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py\", line 35, in __exit__\n        self.gen.throw(type, value, traceback)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 25, in _wrap_ptyprocess_err\n        raise ExceptionPexpect(*e.args)\n    ExceptionPexpect: isalive() encountered condition where \"terminated\" is 0, but there was no child process. Did someone else call waitpid() on our process?\n**********************************************************************\n[...]\n    [227 tests, 92 failures, 42.83 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/interfaces/gap.py  # 92 doctests failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2019-08-10T08:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242682",
    "user": "@vbraun"
}
```

This breaks the gap interfaces when building with SAGE_DEBUG=yes:

```
**********************************************************************
File "src/sage/interfaces/gap.py", line 732, in sage.interfaces.gap.Gap_generic._eval_line
Failed example:
    a = gap(3)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.gap.Gap_generic._eval_line[8]>", line 1, in <module>
        a = gap(Integer(3))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 295, in __call__
        result = self._coerce_from_special_method(x)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 323, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage/structure/sage_object.pyx", line 693, in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:5929)
        return self._interface_(G)
      File "sage/structure/sage_object.pyx", line 669, in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5475)
        X = I(s)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 288, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1438, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 491, in _create
        self.set(name, value)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1411, in set
        self._eval_line(cmd, allow_use_file=True)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 746, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 609, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/spawnbase.py", line 369, in expect_list
        return exp.expect_loop(timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/expect.py", line 111, in expect_loop
        incoming = spawn.read_nonblocking(spawn.maxread, timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 469, in read_nonblocking
        self.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 704, in isalive
        alive = ptyproc.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py", line 35, in __exit__
        self.gen.throw(type, value, traceback)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 25, in _wrap_ptyprocess_err
        raise ExceptionPexpect(*e.args)
    ExceptionPexpect: isalive() encountered condition where "terminated" is 0, but there was no child process. Did someone else call waitpid() on our process?
**********************************************************************
[...]
    [227 tests, 92 failures, 42.83 s]
----------------------------------------------------------------------
sage -t --long src/sage/interfaces/gap.py  # 92 doctests failed
----------------------------------------------------------------------
```




---

archive/issue_comments_242683.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-08-10T08:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242683",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_242684.json:
```json
{
    "body": "I'm not really sure what makes you think that has anything to do with this ticket. That looks like the gap interpreter itself is crashing unexpectedly when running a debug build. But this ticket doesn't change anything about gap itself or the pexpect interface.",
    "created_at": "2019-08-12T09:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242684",
    "user": "@embray"
}
```

I'm not really sure what makes you think that has anything to do with this ticket. That looks like the gap interpreter itself is crashing unexpectedly when running a debug build. But this ticket doesn't change anything about gap itself or the pexpect interface.



---

archive/issue_comments_242685.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2019-08-12T09:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242685",
    "user": "@embray"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_242686.json:
```json
{
    "body": "I only ran the tests with and without this ticket, I haven't looked at the code. If it is as you say then presumably its some sort of resource exhaustion while running the tests.",
    "created_at": "2019-08-12T12:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242686",
    "user": "@vbraun"
}
```

I only ran the tests with and without this ticket, I haven't looked at the code. If it is as you say then presumably its some sort of resource exhaustion while running the tests.



---

archive/issue_comments_242687.json:
```json
{
    "body": "I'll still check if I can reproduce.  It could be something like #28106",
    "created_at": "2019-08-14T11:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242687",
    "user": "@embray"
}
```

I'll still check if I can reproduce.  It could be something like #28106



---

archive/issue_comments_242688.json:
```json
{
    "body": "I can reproduce it, even with `--memlimit=0`.  Truly baffling, but I guess there must be something...",
    "created_at": "2019-08-14T12:39:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242688",
    "user": "@embray"
}
```

I can reproduce it, even with `--memlimit=0`.  Truly baffling, but I guess there must be something...



---

archive/issue_comments_242689.json:
```json
{
    "body": "Somehow it seems this has caused a regression of something that was supposed to be fixed by #10296.  The problems start here:\n\n\n```\n        The following tests against a bug fixed at :trac:`10296`::\n\n            sage: gap(3)\n            3\n            sage: gap.eval('quit;')\n            ''\n            sage: a = gap(3)\n            ** Gap crashed or quit executing '\\$sage...:=3;;' **\n            Restarting Gap and trying again\n            sage: a\n            3\n```\n\n\nInstead of gap crashing normally and restarting, we get this error instead:\n\n\n```\nException raised:\n    Traceback (most recent call last):\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.interfaces.gap.Gap_generic._eval_line[8]>\", line 1, in <module>\n        a = gap(Integer(3))\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 295, in __call__\n        result = self._coerce_from_special_method(x)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 323, in _coerce_from_special_method\n        return (x.__getattribute__(s))(self)\n      File \"sage/structure/sage_object.pyx\", line 693, in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:5929)\n        return self._interface_(G)\n      File \"sage/structure/sage_object.pyx\", line 669, in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5475)\n        X = I(s)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 288, in __call__\n        return cls(self, x, name=name)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1438, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 491, in _create\n        self.set(name, value)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1411, in set\n        self._eval_line(cmd, allow_use_file=True)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 746, in _eval_line\n        expect_eof= (self._quit_string() in line))\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 609, in _execute_line\n        x = E.expect_list(self._compiled_full_pattern)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/spawnbase.py\", line 369, in expect_list\n        return exp.expect_loop(timeout)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/expect.py\", line 111, in expect_loop\n        incoming = spawn.read_nonblocking(spawn.maxread, timeout)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 469, in read_nonblocking\n        self.isalive()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 704, in isalive\n        alive = ptyproc.isalive()\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py\", line 35, in __exit__\n        self.gen.throw(type, value, traceback)\n      File \"/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py\", line 25, in _wrap_ptyprocess_err\n        raise ExceptionPexpect(*e.args)\n    ExceptionPexpect: isalive() encountered condition where \"terminated\" is 0, but there was no child process. Did someone else call waitpid() on our process?\n```\n\n\nafter which point the gap interface never recovers.  It's only happening in the tests though.  I can't reproduce interactively.  Running the tests with `--serial` makes no difference.",
    "created_at": "2019-08-14T12:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242689",
    "user": "@embray"
}
```

Somehow it seems this has caused a regression of something that was supposed to be fixed by #10296.  The problems start here:


```
        The following tests against a bug fixed at :trac:`10296`::

            sage: gap(3)
            3
            sage: gap.eval('quit;')
            ''
            sage: a = gap(3)
            ** Gap crashed or quit executing '\$sage...:=3;;' **
            Restarting Gap and trying again
            sage: a
            3
```


Instead of gap crashing normally and restarting, we get this error instead:


```
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.gap.Gap_generic._eval_line[8]>", line 1, in <module>
        a = gap(Integer(3))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 295, in __call__
        result = self._coerce_from_special_method(x)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 323, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage/structure/sage_object.pyx", line 693, in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:5929)
        return self._interface_(G)
      File "sage/structure/sage_object.pyx", line 669, in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5475)
        X = I(s)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 288, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1438, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 491, in _create
        self.set(name, value)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1411, in set
        self._eval_line(cmd, allow_use_file=True)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 746, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 609, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/spawnbase.py", line 369, in expect_list
        return exp.expect_loop(timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/expect.py", line 111, in expect_loop
        incoming = spawn.read_nonblocking(spawn.maxread, timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 469, in read_nonblocking
        self.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 704, in isalive
        alive = ptyproc.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py", line 35, in __exit__
        self.gen.throw(type, value, traceback)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 25, in _wrap_ptyprocess_err
        raise ExceptionPexpect(*e.args)
    ExceptionPexpect: isalive() encountered condition where "terminated" is 0, but there was no child process. Did someone else call waitpid() on our process?
```


after which point the gap interface never recovers.  It's only happening in the tests though.  I can't reproduce interactively.  Running the tests with `--serial` makes no difference.



---

archive/issue_comments_242690.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2019-08-14T13:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242690",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_242691.json:
```json
{
    "body": "Rebased on current develop, and the latest commit fixes the immediate problem in the test suite.\n\nI believe there is still an underlying problem with libgap/gap interaction which is not yet addressed though (and is probably not new as of this ticket, but just more likely to occur with libgap being used more extensively).",
    "created_at": "2019-08-14T13:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242691",
    "user": "@embray"
}
```

Rebased on current develop, and the latest commit fixes the immediate problem in the test suite.

I believe there is still an underlying problem with libgap/gap interaction which is not yet addressed though (and is probably not new as of this ticket, but just more likely to occur with libgap being used more extensively).



---

archive/issue_comments_242692.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-08-14T13:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242692",
    "user": "@embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_242693.json:
```json
{
    "body": "This might be related to https://github.com/gap-system/gap/issues/3380 , with libgap `wait()`-ing on random child processes inappropriatly.",
    "created_at": "2019-08-14T13:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242693",
    "user": "@embray"
}
```

This might be related to https://github.com/gap-system/gap/issues/3380 , with libgap `wait()`-ing on random child processes inappropriatly.



---

archive/issue_comments_242694.json:
```json
{
    "body": "It seems that, at least theoretically, we already do disable GAP's default `SIGCHLD` handler.",
    "created_at": "2019-08-14T13:41:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242694",
    "user": "@embray"
}
```

It seems that, at least theoretically, we already do disable GAP's default `SIGCHLD` handler.



---

archive/issue_comments_242695.json:
```json
{
    "body": "Bizarrely, even after backing out that last test update, and rebuilding, I can't reproduce the issue anymore either.  I think it might have actually had something to do with sage-cleaner.\n\nPlease send this to the buildbots again.  I really don't think the issue is caused by this ticket, but is something more ephemeral that it happens to provoke somehow.",
    "created_at": "2019-08-14T14:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242695",
    "user": "@embray"
}
```

Bizarrely, even after backing out that last test update, and rebuilding, I can't reproduce the issue anymore either.  I think it might have actually had something to do with sage-cleaner.

Please send this to the buildbots again.  I really don't think the issue is caused by this ticket, but is something more ephemeral that it happens to provoke somehow.



---

archive/issue_comments_242696.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-14T14:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242696",
    "user": "@embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_242697.json:
```json
{
    "body": "Yes, this has got to have something to do with `sage-cleaner`.  If I just start a `sage-cleaner` process on its own, then run `./sage -t src/sage/interfaces/gap.py` I can reproduce the issue reliably.",
    "created_at": "2019-08-14T14:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242697",
    "user": "@embray"
}
```

Yes, this has got to have something to do with `sage-cleaner`.  If I just start a `sage-cleaner` process on its own, then run `./sage -t src/sage/interfaces/gap.py` I can reproduce the issue reliably.



---

archive/issue_comments_242698.json:
```json
{
    "body": "Soft dependency on #28354: Although I don't think the issues are particularly related, if those pexpect exceptions about `isalive()` keep happening, merging #28354 first should alleviate them.",
    "created_at": "2019-08-14T16:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242698",
    "user": "@embray"
}
```

Soft dependency on #28354: Although I don't think the issues are particularly related, if those pexpect exceptions about `isalive()` keep happening, merging #28354 first should alleviate them.



---

archive/issue_comments_242699.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-18T18:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18030",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18030#issuecomment-242699",
    "user": "@vbraun"
}
```

Resolution: fixed
