# Issue 18030: libgap for PermutationGroup

Issue created by migration from https://trac.sagemath.org/ticket/18267

Original creator: vdelecroix

Original creation time: 2015-04-21 13:30:18

CC:  nthiery tscrim

As remarked in [this question on ask.sagemath.org](http://ask.sagemath.org/question/26590/add-generator-to-a-group-combine-generators-of-two-groups/) a lot of time is spent with pexpect when playing with permutation groups.

In this ticket:
 - we interface libgap permutation group so that the following works

```
sage: p1=libgap.eval("(1,2,3)")
sage: p2=libgap.eval("(3,4,5)")
sage: p1.sage()
(1,2,3)
sage: G=libgap.Group([p1,p2])
sage: G.sage()
Traceback (most recent call last):
...
NotImplementedError: cannot construct equivalent Sage object
```

 - we check that interesting GAP functions such as `ClosureGroup`, `AllBlocks`, are available from libgap
 - we use them in `PermutationGroup` inplace of the current gap version


---

Comment by embray created at 2019-04-12 16:10:54

The overhead of using pexpect for GAP is _especially_ serious on Cygwin.  I believe it to be one of the worst performance hits there, due to the I/O overhead.

It's so slow in fact that I wonder if there isn't a bug/defect in Cygwin related to this.  It's normal that there is some additional overhead involved for I/O on Cygwin, but this is especially bad.


---

Comment by embray created at 2019-04-12 16:13:53

I have a prototype for this in progress that is shaping up pretty well so far.  I will likely need help with this part:

> we check that interesting GAP functions such as `ClosureGroup`, `AllBlocks`, are available from libgap

as I don't know all the math well enough to write interesting tests for this.  But I can get most of the skunkworks done and then anyone else who's interested can add on to it.


---

Comment by embray created at 2019-04-12 16:13:53

Set assignee to embray.


---

Comment by embray created at 2019-04-12 16:17:37

The I/O overhead on Cygwin adds up to something on the order of 20x in this test (specially, the `_test_cellular` test).  I tracked this down to being entirely coming from the pexpect communication.  On Linux:


```
sage -t --long src/sage/combinat/symmetric_group_algebra.py
    [422 tests, 30.17 s]
```


On Cygwin (different machine, but with reasonably good specs):


```
sage -t --long src/sage/combinat/symmetric_group_algebra.py
    [422 tests, 613.16 s]
```


More than 10 minutes on this one test!  It's by far one of the slowest tests on Cygwin.  With my prototype of getting pexpect out of permutation groups I knocked this result down to (again on Cygwin):


```
sage -t --long src/sage/combinat/symmetric_group_algebra.py
    [422 tests, 25.49 s]
```



---

Comment by embray created at 2019-04-12 16:26:08

Unfortunately `src/sage/groups/perm_gps/permgroup_named.py` still remains by far one of the slowest tests on Cygwin despite my fixes.  Unclear as of yet why; maybe several tests using other code that still uses pexpect, or something else...


---

Comment by embray created at 2019-04-12 16:50:38

Well I found one more pexpect use in permgroup_named; fixing that one knocked it down from ~5 minutes to


```
sage -t --long src/sage/groups/perm_gps/permgroup_named.py
    [509 tests, 47.12 s]
```


Which is still about 5 times slower for some reason than that test is on Linux, but progress!

Some of the tests also intentionally use the pexpect interface directly, so nothing to do about that for now.


---

Comment by embray created at 2019-06-25 13:58:14

Changing status from new to needs_review.


---

Comment by embray created at 2019-06-25 13:58:14

Here is my current prototype for getting pexpect out of permutation groups, and having them use libgap exclusively.  For the large part it is quite effective at this.  This fixes (among many other examples):


```
sage: G = SymmetricGroup(3)
sage: %prun G.one()
sage: G.one()
()
sage: gap._expect is None
```


where previously this was invoking a GAP process through pexpect.
----
Last 10 new commits:


---

Comment by embray created at 2019-06-25 13:58:41

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-06-25 13:58:41

Unfortunately there is still a handful of failing tests with this.


---

Comment by embray created at 2019-06-25 14:06:14

I think most of the problems are coming from my hacky attempt to make some `GapElement` objects pickle-able in [fcfde85](https://git.sagemath.org/sage.git/commit/?h=75d6b764cac83c2930dff648605de98adbc506db&id=fcfde857e27b703dfed96787f639126d76f31c30) which can make some surprising results, and is maybe not quite right yet.  It should probably be handled in a separate ticket.


---

Comment by git created at 2019-06-25 15:29:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2019-06-25 15:43:28

Fixed the problems _that I knew about_, though there are likely still others.  Although this is set to "needs_work" it would probably be interesting-enough to start playing around with if anyone wants to review.


---

Comment by embray created at 2019-06-25 15:59:17

With the current version of this branch almost everything works except for a few trivial doctest failures due to new pseudo-random results in some tests.

However, I am also getting a bizarre memory error when running the tests for `sage.combinat.tableau` that's similar to what I reported in #27681 (but later couldn't reproduce).


---

Comment by tscrim created at 2019-06-26 10:10:44

+1 for doing this.


---

Comment by embray created at 2019-07-01 13:22:55

If anyone would like to help test this that would be great for moving forward on this work.  In particular, it would be helpful to know if anyone can reproduce the test failure in `sage.combinat.tableau`, since from my end that is the only major blocker to completing this work.


---

Comment by git created at 2019-07-04 15:27:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-07-04 15:30:42

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-07-04 15:30:42

All tests now pass for me on this ticket (have not tried optional packages).

The one bug I mentioned in comment:14 is now tracked at #28106 and is not directly caused by the changes I made here; rather it only exhibited due to the fact that using libgap in more places meant slightly more virtual memory was being allocated in some tests than previously, but this is expected.

So if you run into the bug with `MemoryError`s in `sage.combinat.tableau` you can pass the test runner `--memlimit=4000` or something like that.


---

Comment by chapoton created at 2019-07-07 09:52:45

I have tested a bit with python3. All doctests pass in tableau-related files and in the modified files.


---

Comment by vdelecroix created at 2019-07-07 20:22:18

Tests pass with [surface_dynamics](https://gitlab.com/videlec/surface_dynamics) that uses `PermutationGroup`. In the same library, I also replaced many calls to `gap` by `libgap` and everything went smoothly.

Thanks for working on this!


---

Comment by tscrim created at 2019-07-08 13:00:46

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-07-08 13:00:46

Everything also LGTM.


---

Comment by tscrim created at 2019-07-08 13:01:37

Changing keywords from "" to "fpsac2019".


---

Comment by embray created at 2019-08-05 16:49:26

Any reason this is sage-pending?


---

Comment by chapoton created at 2019-08-05 18:45:55

dependency needing work


---

Comment by embray created at 2019-08-06 12:57:28

I think I'll just remove the dependency.  It's not actually a dependency for this ticket, especially since my solution proposed there still doesn't seem to work.  The relation between that issue and this ticket is much more indirect than I previously thought.


---

Comment by vbraun created at 2019-08-10 08:31:25

This breaks the gap interfaces when building with SAGE_DEBUG=yes:

```
**********************************************************************
File "src/sage/interfaces/gap.py", line 732, in sage.interfaces.gap.Gap_generic._eval_line
Failed example:
    a = gap(3)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.gap.Gap_generic._eval_line[8]>", line 1, in <module>
        a = gap(Integer(3))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 295, in __call__
        result = self._coerce_from_special_method(x)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 323, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage/structure/sage_object.pyx", line 693, in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:5929)
        return self._interface_(G)
      File "sage/structure/sage_object.pyx", line 669, in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5475)
        X = I(s)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 288, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1438, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 491, in _create
        self.set(name, value)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1411, in set
        self._eval_line(cmd, allow_use_file=True)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 746, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 609, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/spawnbase.py", line 369, in expect_list
        return exp.expect_loop(timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/expect.py", line 111, in expect_loop
        incoming = spawn.read_nonblocking(spawn.maxread, timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 469, in read_nonblocking
        self.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 704, in isalive
        alive = ptyproc.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py", line 35, in __exit__
        self.gen.throw(type, value, traceback)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 25, in _wrap_ptyprocess_err
        raise ExceptionPexpect(*e.args)
    ExceptionPexpect: isalive() encountered condition where "terminated" is 0, but there was no child process. Did someone else call waitpid() on our process?
**********************************************************************
[...]
    [227 tests, 92 failures, 42.83 s]
----------------------------------------------------------------------
sage -t --long src/sage/interfaces/gap.py  # 92 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2019-08-10 08:31:25

Changing status from positive_review to needs_work.


---

Comment by embray created at 2019-08-12 09:06:49

I'm not really sure what makes you think that has anything to do with this ticket. That looks like the gap interpreter itself is crashing unexpectedly when running a debug build. But this ticket doesn't change anything about gap itself or the pexpect interface.


---

Comment by embray created at 2019-08-12 09:06:49

Changing status from needs_work to needs_info.


---

Comment by vbraun created at 2019-08-12 12:43:55

I only ran the tests with and without this ticket, I haven't looked at the code. If it is as you say then presumably its some sort of resource exhaustion while running the tests.


---

Comment by embray created at 2019-08-14 11:25:28

I'll still check if I can reproduce.  It could be something like #28106


---

Comment by embray created at 2019-08-14 12:39:56

I can reproduce it, even with `--memlimit=0`.  Truly baffling, but I guess there must be something...


---

Comment by embray created at 2019-08-14 12:47:32

Somehow it seems this has caused a regression of something that was supposed to be fixed by #10296.  The problems start here:


```
        The following tests against a bug fixed at :trac:`10296`::

            sage: gap(3)
            3
            sage: gap.eval('quit;')
            ''
            sage: a = gap(3)
            ** Gap crashed or quit executing '\$sage...:=3;;' **
            Restarting Gap and trying again
            sage: a
            3
```


Instead of gap crashing normally and restarting, we get this error instead:


```
Exception raised:
    Traceback (most recent call last):
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.gap.Gap_generic._eval_line[8]>", line 1, in <module>
        a = gap(Integer(3))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 295, in __call__
        result = self._coerce_from_special_method(x)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 323, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage/structure/sage_object.pyx", line 693, in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:5929)
        return self._interface_(G)
      File "sage/structure/sage_object.pyx", line 669, in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5475)
        X = I(s)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 288, in __call__
        return cls(self, x, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1438, in __init__
        self._name = parent._create(value, name=name)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 491, in _create
        self.set(name, value)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1411, in set
        self._eval_line(cmd, allow_use_file=True)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 746, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 609, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/spawnbase.py", line 369, in expect_list
        return exp.expect_loop(timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/expect.py", line 111, in expect_loop
        incoming = spawn.read_nonblocking(spawn.maxread, timeout)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 469, in read_nonblocking
        self.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 704, in isalive
        alive = ptyproc.isalive()
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/contextlib.py", line 35, in __exit__
        self.gen.throw(type, value, traceback)
      File "/home/buildbot-sage/slave/sage_git/build/local/lib/python2.7/site-packages/pexpect/pty_spawn.py", line 25, in _wrap_ptyprocess_err
        raise ExceptionPexpect(*e.args)
    ExceptionPexpect: isalive() encountered condition where "terminated" is 0, but there was no child process. Did someone else call waitpid() on our process?
```


after which point the gap interface never recovers.  It's only happening in the tests though.  I can't reproduce interactively.  Running the tests with `--serial` makes no difference.


---

Comment by git created at 2019-08-14 13:09:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2019-08-14 13:11:15

Rebased on current develop, and the latest commit fixes the immediate problem in the test suite.

I believe there is still an underlying problem with libgap/gap interaction which is not yet addressed though (and is probably not new as of this ticket, but just more likely to occur with libgap being used more extensively).


---

Comment by embray created at 2019-08-14 13:11:15

Changing status from needs_info to needs_review.


---

Comment by embray created at 2019-08-14 13:24:59

This might be related to https://github.com/gap-system/gap/issues/3380 , with libgap `wait()`-ing on random child processes inappropriatly.


---

Comment by embray created at 2019-08-14 13:41:30

It seems that, at least theoretically, we already do disable GAP's default `SIGCHLD` handler.


---

Comment by embray created at 2019-08-14 14:14:39

Bizarrely, even after backing out that last test update, and rebuilding, I can't reproduce the issue anymore either.  I think it might have actually had something to do with sage-cleaner.

Please send this to the buildbots again.  I really don't think the issue is caused by this ticket, but is something more ephemeral that it happens to provoke somehow.


---

Comment by embray created at 2019-08-14 14:14:39

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-08-14 14:20:49

Yes, this has got to have something to do with `sage-cleaner`.  If I just start a `sage-cleaner` process on its own, then run `./sage -t src/sage/interfaces/gap.py` I can reproduce the issue reliably.


---

Comment by embray created at 2019-08-14 16:23:06

Soft dependency on #28354: Although I don't think the issues are particularly related, if those pexpect exceptions about `isalive()` keep happening, merging #28354 first should alleviate them.


---

Comment by vbraun created at 2019-08-18 18:46:43

Resolution: fixed
