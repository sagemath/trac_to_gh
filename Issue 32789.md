# Issue 32789: make BinaryQF.solve_integer() work for square discriminants

archive/issues_032789.json:
```json
{
    "body": "CC:  @collares @slel @davewittemorris\n\nAs reported in comment:8:ticket:32782, PARI's `qfbsolve()` does not work with quadratic forms whose discriminant is a square integer.\n\nThis currently triggers failures in random testing, but it is not a regression: `BinaryQF.solve_integer()` used to reject *all* positive discriminants prior to #32782.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33026\n\n",
    "created_at": "2021-12-15T07:43:06Z",
    "labels": [
        "quadratic forms",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "make BinaryQF.solve_integer() work for square discriminants",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32789",
    "user": "@yyyyx4"
}
```
CC:  @collares @slel @davewittemorris

As reported in comment:8:ticket:32782, PARI's `qfbsolve()` does not work with quadratic forms whose discriminant is a square integer.

This currently triggers failures in random testing, but it is not a regression: `BinaryQF.solve_integer()` used to reject *all* positive discriminants prior to #32782.

Issue created by migration from https://trac.sagemath.org/ticket/33026





---

archive/issue_comments_467570.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-15T08:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467570",
    "user": "@yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_467571.json:
```json
{
    "body": "Also fixed: The doctest was checking whether `Q(*xy) == 0` rather than `Q(*xy) == n`.",
    "created_at": "2021-12-15T08:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467571",
    "user": "@yyyyx4"
}
```

Also fixed: The doctest was checking whether `Q(*xy) == 0` rather than `Q(*xy) == n`.



---

archive/issue_comments_467572.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-21T11:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467572",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_467573.json:
```json
{
    "body": "Rebased onto #33057.",
    "created_at": "2021-12-21T11:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467573",
    "user": "@yyyyx4"
}
```

Rebased onto #33057.



---

archive/issue_comments_467574.json:
```json
{
    "body": "Instead of\n\n```\n+                try:\n+                    y = ZZ((n//x - Q._a*x) / Q._b)\n+                except TypeError:\n+                    continue\n+                return tuple(row[0]*x + row[1]*y for row in M.rows())\n```\n\nyou would better do\n\n```\ny_num = n // x - Q._a * x\nif Q._b.divides(y_num):\n    y = y_num // Q._b\n    return tuple(row[0]*x + row[1]*y for row in M.rows())\n```\n",
    "created_at": "2021-12-29T10:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467574",
    "user": "@videlec"
}
```

Instead of

```
+                try:
+                    y = ZZ((n//x - Q._a*x) / Q._b)
+                except TypeError:
+                    continue
+                return tuple(row[0]*x + row[1]*y for row in M.rows())
```

you would better do

```
y_num = n // x - Q._a * x
if Q._b.divides(y_num):
    y = y_num // Q._b
    return tuple(row[0]*x + row[1]*y for row in M.rows())
```




---

archive/issue_comments_467575.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-29T16:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467575",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467576.json:
```json
{
    "body": "Thanks, done.",
    "created_at": "2021-12-29T16:58:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467576",
    "user": "@yyyyx4"
}
```

Thanks, done.



---

archive/issue_comments_467577.json:
```json
{
    "body": "It is better to avoid the use multiple statements on the same line as\n\n```\nU.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)\n```\n\nSee [PEP8](https://www.python.org/dev/peps/pep-0008/). (I don't understand why this is not checked by the patchbot.)\n\nSince you have a special treatment for `n=0`, it would be reasonable to have a dedicated doctest.\nMaybe, you could change\n\n```\nsage: n = randrange(-10^3, 10^3)\nsage: Q = BinaryQF([n, randrange(-10^3, 10^3), 0][::(-1)**randrange(2)])\nsage: U = random_matrix(ZZ, 2, 2, 'unimodular')\nsage: U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)\nsage: Q = Q.matrix_action_right(U)\nsage: Q.discriminant().is_square()\nTrue\nsage: xy = Q.solve_integer(n)\nsage: Q(*xy) == n\nTrue\n```\n\nto\n\n```\nsage: Q = BinaryQF([n, randrange(-10^3, 10^3), 0][::(-1)**randrange(2)])\nsage: U = random_matrix(ZZ, 2, 2, 'unimodular')\nsage: U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)\nsage: Q = Q.matrix_action_right(U)\nsage: Q.discriminant().is_square()\nTrue\nsage: xy = Q.solve_integer(0)\nsage: Q(*xy) == 0\nTrue\nsage: n = randrange(-10^3, 10^3)\nsage: xy = Q.solve_integer(n)\nsage: Q(*xy) == n\nTrue\n```\n\n\nAnd I think this will be all my comments for this ticket.",
    "created_at": "2021-12-30T10:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467577",
    "user": "@videlec"
}
```

It is better to avoid the use multiple statements on the same line as

```
U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)
```

See [PEP8](https://www.python.org/dev/peps/pep-0008/). (I don't understand why this is not checked by the patchbot.)

Since you have a special treatment for `n=0`, it would be reasonable to have a dedicated doctest.
Maybe, you could change

```
sage: n = randrange(-10^3, 10^3)
sage: Q = BinaryQF([n, randrange(-10^3, 10^3), 0][::(-1)**randrange(2)])
sage: U = random_matrix(ZZ, 2, 2, 'unimodular')
sage: U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)
sage: Q = Q.matrix_action_right(U)
sage: Q.discriminant().is_square()
True
sage: xy = Q.solve_integer(n)
sage: Q(*xy) == n
True
```

to

```
sage: Q = BinaryQF([n, randrange(-10^3, 10^3), 0][::(-1)**randrange(2)])
sage: U = random_matrix(ZZ, 2, 2, 'unimodular')
sage: U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)
sage: Q = Q.matrix_action_right(U)
sage: Q.discriminant().is_square()
True
sage: xy = Q.solve_integer(0)
sage: Q(*xy) == 0
True
sage: n = randrange(-10^3, 10^3)
sage: xy = Q.solve_integer(n)
sage: Q(*xy) == n
True
```


And I think this will be all my comments for this ticket.



---

archive/issue_comments_467578.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-30T12:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467578",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467579.json:
```json
{
    "body": "Thank you! Done.",
    "created_at": "2021-12-30T12:18:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467579",
    "user": "@yyyyx4"
}
```

Thank you! Done.



---

archive/issue_comments_467580.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-30T12:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467580",
    "user": "@videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_467581.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-12T22:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32789#issuecomment-467581",
    "user": "@vbraun"
}
```

Resolution: fixed
