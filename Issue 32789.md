# Issue 32789: make BinaryQF.solve_integer() work for square discriminants

Issue created by migration from https://trac.sagemath.org/ticket/33026

Original creator: lorenz

Original creation time: 2021-12-15 07:43:06

CC:  @collares slelievre @davewittemorris

As reported in comment:8:ticket:32782, PARI's `qfbsolve()` does not work with quadratic forms whose discriminant is a square integer.

This currently triggers failures in random testing, but it is not a regression: `BinaryQF.solve_integer()` used to reject _all_ positive discriminants prior to #32782.


---

Comment by lorenz created at 2021-12-15 08:07:11

Changing status from new to needs_review.


---

Comment by lorenz created at 2021-12-15 08:07:11

Also fixed: The doctest was checking whether `Q(*xy) == 0` rather than `Q(*xy) == n`.


---

Comment by git created at 2021-12-21 11:31:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by lorenz created at 2021-12-21 11:32:39

Rebased onto #33057.


---

Comment by vdelecroix created at 2021-12-29 10:14:10

Instead of

```
+                try:
+                    y = ZZ((n//x - Q._a*x) / Q._b)
+                except TypeError:
+                    continue
+                return tuple(row[0]*x + row[1]*y for row in M.rows())
```

you would better do

```
y_num = n // x - Q._a * x
if Q._b.divides(y_num):
    y = y_num // Q._b
    return tuple(row[0]*x + row[1]*y for row in M.rows())
```



---

Comment by git created at 2021-12-29 16:58:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-12-29 16:58:36

Thanks, done.


---

Comment by vdelecroix created at 2021-12-30 10:54:38

It is better to avoid the use multiple statements on the same line as

```
U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)
```

See [PEP8](https://www.python.org/dev/peps/pep-0008/). (I don't understand why this is not checked by the patchbot.)

Since you have a special treatment for `n=0`, it would be reasonable to have a dedicated doctest.
Maybe, you could change

```
sage: n = randrange(-10^3, 10^3)
sage: Q = BinaryQF([n, randrange(-10^3, 10^3), 0][::(-1)**randrange(2)])
sage: U = random_matrix(ZZ, 2, 2, 'unimodular')
sage: U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)
sage: Q = Q.matrix_action_right(U)
sage: Q.discriminant().is_square()
True
sage: xy = Q.solve_integer(n)
sage: Q(*xy) == n
True
```

to

```
sage: Q = BinaryQF([n, randrange(-10^3, 10^3), 0][::(-1)**randrange(2)])
sage: U = random_matrix(ZZ, 2, 2, 'unimodular')
sage: U.rescale_row(0, choice((+1,-1))); assert U.det() in (+1,-1)
sage: Q = Q.matrix_action_right(U)
sage: Q.discriminant().is_square()
True
sage: xy = Q.solve_integer(0)
sage: Q(*xy) == 0
True
sage: n = randrange(-10^3, 10^3)
sage: xy = Q.solve_integer(n)
sage: Q(*xy) == n
True
```


And I think this will be all my comments for this ticket.


---

Comment by git created at 2021-12-30 12:18:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-12-30 12:18:44

Thank you! Done.


---

Comment by vdelecroix created at 2021-12-30 12:20:06

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-12 22:05:21

Resolution: fixed
