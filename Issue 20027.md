# Issue 20027: Hasse-Weil Zeta function of a superelliptic curve over finite fields.

Issue created by migration from Trac.

Original creator: edgarcosta

Original creation time: 2016-03-23 17:58:29

CC:  alexjbest

Keywords: days71

We plan to add code to compute the Hasse-Weil Zeta function of a superelliptic curve over finite fields using p-adic methods.


---

Comment by roed created at 2017-07-17 17:37:05

Changing keywords from "days71" to "days71, sd87".


---

Comment by edgarcosta created at 2017-08-22 21:16:05

Changing keywords from "days71, sd87" to "days71, sd87, days88".


---

Comment by edgarcosta created at 2018-06-01 20:41:24

New commits:


---

Comment by edgarcosta created at 2018-06-01 20:41:24

Changing status from new to needs_info.


---

Comment by git created at 2018-06-01 20:46:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2018-06-01 20:50:46

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by alexjbest created at 2018-11-26 14:54:17

Last 10 new commits:


---

Comment by edgarcosta created at 2018-12-12 22:45:25

Last 10 new commits:


---

Comment by alexjbest created at 2018-12-13 02:02:48

This is looking pretty good now to me, so I intend to mark this as positive review once #25366 is reviewed.


---

Comment by edgarcosta created at 2019-06-03 20:25:21

Vishal Arul spotted some bugs.

```
sage: %time CyclicCover(11, PolynomialRing(GF(1129), 'x')([-1] + [0]*(5-1) + [1])).frobenius_polynomial()
CPU times: user 16.1 s, sys: 124 ms, total: 16.3 s
Wall time: 16.5 s
x^40 + 7337188909826596*x^30 + 3818873571673594702967652840943135*x^20 + 24687045654725446027864774006541463602997309796*x^10 + 11320844849639649951608809973589776933203136765026963553258401
```

So the discrepancy is in the `t^20` coefficient -- Minzlaff's code says it is

```
20187877911930897108199045855206 = 6 * 1129^10
```

while the current code says it is

```
3818873571673594702967652840943135 = 6 * 1129^10 + 1129^11.
```

the difference is exactly 1129^11. So it does look like some kind of precision error...

My bet is that error is either in working precision or the code to lift characteristic polynomial to ZZ


Another bug, that seems to be related with precision when using the slow method

```
sage: CyclicCover(3, PolynomialRing(GF(1009), 'x')([-1] + [0]*(5-1) + [1])).frobenius_polynomial()
x^8 + 266*x^6 - 1474149*x^4 + 270809546*x^2 + 1036488922561
sage: CyclicCover(3, PolynomialRing(GF(1009**2), 'x')([-1] + [0]*(5-1) + [1])).frobenius_polynomial()
x^8 + 1045817316825941*x^7 + 546866930086505850133464526551*x^6 + 190640968494636702312197540239024924597536618*x^5 + 49843906537040069873392691186784704861320520036908736885312*x^4 + 194087947845988228526704383964086734259184677590058*x^3 + 566821515149604163130057985174959967417111*x^2 + 1103577471286158480607964750564981*x + 1074309286591662654798721
```


It looks like the frobenius polynomial for GF(1009) is correct, but it is not correct for `GF(1009**2)`. Comparing with Minzlaff's code, the right frobenius polynomial for `GF(1009**2)` should be 

```
x^8 + 532*x^7 - 2877542*x^6 - 242628176*x^5 + 4390163797795*x^4 - 247015136050256*x^3 - 2982540407204025062*x^2 + 561382189105547134612*x + 1074309286591662654798721
```



---

Comment by edgarcosta created at 2019-06-03 20:25:44

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-10-11 15:20:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-11 17:12:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-11 20:59:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2019-10-11 20:59:48

The bugs mentioned before have been fixed


---

Comment by chapoton created at 2019-10-12 07:34:11

* Use "Return" and not "Returns" in the first line of documentations ; same for "Computes", etc

* Do not end the lines by `\` when using `....:`, they are not needed

* the `\` is also not needed to wrap lines inside the text of an Error, just write something like


```
raise BeautifulError("all the carrots "
                     "belong to the rabbits")
```


* Use `https://www.gnu.org/licenses/` in the headers (with https instead of http)

* Capital F to Frobenius in the documentation

* Is the change to `src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx` needed ?

* The file `src/sage/schemes/cyclic_covers/__init__.py` should rather be empty

* src/sage/schemes/cyclic_covers/charpoly_frobenius.py:8: 'sage.matrix.constructor.matrix' imported but unused

* When testing that something mod 2 is not zero, you can write `if k % 2:`

ok, enough for the moment


---

Comment by chapoton created at 2019-10-12 07:43:12

and many more tests should be tagged as #long

the longest one takes too long and should remain `# not tested, very long`


---

Comment by alexjbest created at 2019-10-12 12:16:35

Replying to [comment:20 chapoton]:
> * Use "Return" and not "Returns" in the first line of documentations ; same for "Computes", etc
> 
> * Do not end the lines by `\` when using `....:`, they are not needed
> 
> * the `\` is also not needed to wrap lines inside the text of an Error, just write something like
> 
> {{{
> raise BeautifulError("all the carrots "
>                      "belong to the rabbits")
> }}}
> 
> * Use `https://www.gnu.org/licenses/` in the headers (with https instead of http)
> 
> * Capital F to Frobenius in the documentation
> 
> * Is the change to `src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx` needed ?
> 
> * The file `src/sage/schemes/cyclic_covers/__init__.py` should rather be empty
> 
> * src/sage/schemes/cyclic_covers/charpoly_frobenius.py:8: 'sage.matrix.constructor.matrix' imported but unused
> 
> * When testing that something mod 2 is not zero, you can write `if k % 2:`
> 
> ok, enough for the moment

Most of these are fine and I am happy to do, but I wonder if you know an automatic tool to fix these things, if not perhaps we should make one, it would save time fixing annoying single character changes.
As for ` k %2 ` I don't know why I would do that, to save keystrokes? It makes it less readable IMO and doesn't seem to have benefit.

As for the change to `src/sage/schemes/hyperelliptic_curves/hypellfrob.pyx` I'm not sure how that appeared there, maybe a merge issue, if they don't break anything I'll remove them I suppose.


---

Comment by git created at 2019-10-12 14:06:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-12 14:29:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-12 14:34:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-12 14:41:21

Humm. not sure what you are doing, But I did not suggest anything about white space.

And you can write the Errors on two lines (not 4), exactly as I suggested before.


---

Comment by chapoton created at 2019-10-12 14:43:20

Usually, one does not put spaces around powers, so `x**n` is fine.

If you want to know how you are supposed to write code exactly, you should use pycodestyle to check for pep8 correctness. This is not strongly required.


---

Comment by git created at 2019-10-12 17:03:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-12 19:04:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alexjbest created at 2019-10-12 19:08:17

I think we got all your suggestions now, thanks!

I'm still not sure which tests are too long now, `sage -t` already includes warn long and shows nothing on my laptop, is there a good way to determine this?


---

Comment by chapoton created at 2019-10-12 19:27:27

Not so amused by your commit titles, sorry to say. Your code has to meet Sage's standards, that's just the way it goes. I am really trying to help.

More fixes:

* Typo "instegral"

* Is there some reference article, either as preprint or published ? If yes, should be added.

* One spurious empty line here

```
+        r"""
+
+        Return if this curve is singular or not.
```


* INPUT: and OUTPUT: must be followed by empty lines

* Typo in the sentence `Return the polynomial of defining the cyclic cover.` : remove "of"

* Remain some traces of copy-paste:

```
Return this HyperellipticCurve over a new base ring R.
```

and

```
String representation of hyperelliptic curves.
```


* you should probably use the existing "is_squarefree" method of polynomials and not re-invent it in "check_squarefree":

```
sage: g=(x-1)^2
sage: g.is_squarefree()
False
sage: x = polygen(QQ)
sage: g=(x-1)^2
sage: g.is_squarefree()
False
sage: x = polygen(Qp(5))
sage: g = x^2 + 5
sage: g.is_squarefree()
True
sage: x = polygen(GF(2))
sage: g = x^2 + x + 1
sage: g.is_squarefree()
True
```



---

Comment by git created at 2019-10-12 19:45:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-10-12 19:52:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alexjbest created at 2019-10-12 19:56:18

> Not so amused by your commit titles, sorry to say. Your code has to meet Sage's standards, that's just the way it goes. I am really trying to help.
Sorry that's more me being lazy than making a point! I appreciate the comments.
----


---

Comment by git created at 2019-10-12 20:01:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2019-10-12 20:12:31

Thanks for your comments.
I think I have addressed most of your comments, with the exception: 
> * When testing that something mod 2 is not zero, you can write `if k % 2:`
which I disagree with

ok. That would be slightly faster.

> * Is there some reference article, either as preprint or published ? If yes, should be added. 

as the answer is yes, and I need to figure out how to add the reference properly.

The reference itself should be added in the master reference file:

src/doc/en/reference/references/index.rst

and called in your files somewhere using the usual syntax `[Who2019]_ `

* long tests
How do we determine what is long?

using

```
./sage -bt --long --warn-long src/sage/schemes/cyclic_covers/
```


Well, your machine may be too quick. Mine is slow. I will launch this command and report.

I also have an honest question, do you know the reason for not using the 3rd person in the documentation, e.g., return instead of returns? I know it is pep8 stuff, but I am confused about how should I be reading docstrings for this to make sense grammatically, as I always read them as the function F does something...

This is not pep8 stuff, but sage's own decision. The first line of the documentation is supposed to be in imperative mode (like when giving an order) as explained here:

http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings


---

Comment by chapoton created at 2019-10-13 07:46:22

Here are some timings

```
 sage.schemes.cyclic_covers.cycliccover_finite_field.CyclicCover_finite_field.frobenius_polynomial
Warning, slow doctest:
    CyclicCover(11, PolynomialRing(GF(1129), 'x')([-1] + [0]*(5-1) + [1])).frobenius_polynomial() # long time
Test ran for 27.69 s
**********************************************************************
File "src/sage/schemes/cyclic_covers/cycliccover_finite_field.py", line 1122, in sage.schemes.cyclic_covers.cycliccover_finite_field.CyclicCover_finite_field.frobenius_polynomial
Warning, slow doctest:
    CyclicCover(3, PolynomialRing(GF(1009^2), 'x')([-1] + [0]*(5-1) + [1])).frobenius_polynomial() # long time
Test ran for 135.69 s
**********************************************************************
File "src/sage/schemes/cyclic_covers/cycliccover_finite_field.py", line 1131, in sage.schemes.cyclic_covers.cycliccover_finite_field.CyclicCover_finite_field.frobenius_polynomial
Warning, slow doctest:
    C.frobenius_polynomial()
Test ran for 26.42 s
```

I sugggest that at least the worst one become `# not tested`


---

Comment by chapoton created at 2019-10-13 19:13:46

There is a line

```
....:)
```

that is missing a white space after `:`


---

Comment by git created at 2019-10-14 12:34:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-15 07:21:00

* The following

```
+            min_val = min(
+                [min([self._Qq(elt).valuation() for elt in row]) for row in F.rows()]
+            )
```

could be done in one loop

```
min_val = min(self._Qq(elt).valuation() for row in F.rows() for elt in row)
```


* In this

```
+        Compute p-adic Frobenius matrix to precision p^N. If N not
+        supplied, a default value is selected, which is the minimum needed
+        to recover the charpoly unambiguously.
```

the first sentence should be followed by an empty line.

* In all.py, do not use assert

* In this sentence

```
+    - ``charpoly_prec`` -- a vector ai, such that, `frob_matrix.change_ring(ZZ).charpoly()[i]`
+        will be correct mod `p^ai`, this can be easily deduced from the hodge numbers and
+        knowing the q-adic precision of `frob_matrix`
```

Hodge take a capital H, and the final frob_matrix should be between double backticks
* You could replace

```
import sage.schemes.curves.affine_curve as plane_curve
```

by

```
from sage.schemes.curves.affine_curve import AffinePlaneCurve
```

and then use that directly

* In src/sage/schemes/cyclic_covers/charpoly_frobenius.py, there are many divisions by 2. I would suggest to add `from __future__ import division` in order to make sure that the python3  behaviour will remain the same.

* this sentence does not make sense

```
+    - ``f`` - univariate polynomial
+      is not given, then it defaults to 0.
```


* do not use range(0, something) but range(something)

* still an empty line to be removed here:

```
+    def _horizontal_matrix_reduction(self, s):
+        r"""
+
```


* this should not be indented

```
+        OUTPUT:
+
+            A tuple of tuples ``( (D0, D1), (M0, M1) )``
+            where MV_t  = M0 + t * M1 and DV_t = D0 + t * D1
+
```


ok, enough for today


---

Comment by git created at 2019-10-17 00:32:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alexjbest created at 2019-10-17 00:35:32

Changing component from padics to algebraic geometry.


---

Comment by git created at 2019-10-17 00:54:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-18 09:45:02

You should call the added reference somewhere using `[ABCMT2019]_`, say in charpoly_frobenius


---

Comment by chapoton created at 2019-10-18 11:19:36

This is wrong

```
import sage.schemes.curves.affine_curve import AffinePlaneCurve
```

The first "import" should be "from" instead.


---

Comment by git created at 2019-10-21 10:53:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-21 17:59:17


```
+REFERENCES::
```

should end with a single colon, and be followed by an empty line.

Once done, I will give a positive review, if you set to "needs_review". It is better to make further changes in later tickets.


---

Comment by git created at 2019-10-21 18:30:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2019-10-21 18:31:41

Thank you!


---

Comment by edgarcosta created at 2019-10-21 18:31:41

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-10-21 19:39:52

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-10-21 19:39:52

my pleasure


---

Comment by vbraun created at 2019-10-23 22:58:10

Resolution: fixed
