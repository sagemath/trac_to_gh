# Issue 11734: PolyBoRi should obey some standard environment variables

Issue created by migration from Trac.

Original creator: AlexanderDreyer

Original creation time: 2011-10-07 20:24:00

Assignee: AlexGhitza

CC:  leif

It was discovered in #11575 that PolyBoRi's build system  does not export all relevant environment variables to the build environment.

The PolyBoRi spkg already treats the following:
`CC CXX SAGESOFLAGS PYTHONHOME SAGE_LOCAL`

Yet, the following standard environment variables are not utilized in PolyBoRi's build process:
`CFLAGS CXXFLAGS CPPFLAGS LDFLAGS ABI CPP`

The following environment variables should be exported to PolyBoRi's build environment:
`LD_LIBRARY_PATH LIBRARY_PATH LD_RUN_PATH DYLD_RUN_PATH`


---

Comment by AlexanderDreyer created at 2011-10-07 20:24:14

Changing assignee from AlexGhitza to AlexanderDreyer.


---

Comment by AlexanderDreyer created at 2011-10-07 22:09:20

There are two kind of environment variables. 
First, there are `PATH`, `LD_LIBRARY_PATH`, `CPATH` (used by gcc} and similar ones. Those just have to be imported to the build environment, for instance by the following patch to PolyBoRi's `SConstruct` file:


```diff -u

`@``@` -377,17 +377,12 `@``@`                                                                                                           
                                                                                                                                
 tools +=  ["disttar", "doxygen"]                                                                                               
                                                                                                                                
-# Get paths an related things from current environment                                                                         
-# note: we cannot avoid those due to non-standard system setups                                                                
-getenv = dict()                                                                                                                
-for key in ['PATH', 'HOME', 'LD_LIBRARY_PATH'] :                                                                               
-    try:                                                                                                                       
-        getenv[key] = os.environ[key]                                                                                          
-    except KeyError:                                                                                                           
-        pass                                                                                                                   
+# Get paths and related things from current environment os.environ                                                             
+# note: We cannot avoid those due to non-standard system setups,                                                               
+#       also we do not know which variables are used in general                                                                
                                                                                                                                
-                                                                                                                               
-env = Environment(ENV = getenv, options = opts, tools = tools, toolpath = '.')                                                 
+env = Environment(ENV = os.environ, options = opts, tools = tools,                                                             
+                  toolpath = '.')                                                                                              
                                                                                                                                
 env['RPATH'] = env.Literal('\\$$ORIGIN/') 
```


On the other hand, there are variables like `CFLAGS`, `LDFLAGS`... Those are not used by the compiler directly, but by `make`-based build systems. So we have to tell `scons` what we intended with them. For instance, we have to add a line like the following to the configuration file `custom.py` in the spkg:


```python
CXXFLAGS=os.environ['CXXFLAGS']
```



---

Comment by leif created at 2011-10-08 02:51:58

It turned out that the build (and partially "Configure", by not finding the GD and M4RI libraries) was broken for me just because *`LIBRARY_PATH`* was missing in the environment set up by (or for) `SConstruct`.

So using

```python
env = Environment(ENV = os.environ, options = opts, tools = tools,                                                             
                  toolpath = '.')
```

(in `SConstruct`) would work for me, as well as just adding `LIBRARY_PATH` to the "exported" environment variables.

Another option is to add all the directories from `LIBRARY_PATH` to `LIBPATH` (in `custom.py`):

```python
if os.environ.has_key("LIBRARY_PATH"): 
    LIBPATH += os.environ["LIBRARY_PATH"].split(os.pathsep)
```


(Cf. [comment:ticket:11575:131 this comment] at #11575.)




It's in general of course not bad to export (and/or make use of) other standard environment variables, like `CFLAGS` etc., too, as mentioned in the ticket's description.


---

Comment by AlexanderDreyer created at 2011-10-08 19:11:13

Replying to [comment:3 leif]:
> It's in general of course not bad to export (and/or make use of) other standard environment variables, like `CFLAGS` etc., too, as mentioned in the ticket's description.
Yeah, this will be default now in 0.8.1. We change here one crucial paradigm (better explicit than implict variable import). But since one cannot know all set ups, this is the best was to do.

I'll prepare new spkgs soon.


---

Comment by AlexanderDreyer created at 2011-10-08 19:11:13

Changing status from new to needs_info.


---

Comment by leif created at 2011-10-08 20:54:43

`SPKG.txt` should have a _Special Update/Build Instructions_ section (e.g. mentioning that some upstream parts should get deleted, cf. #9472).

Also, `spkg/standard/deps` have been fixed long ago to make PolyBoRi also depend on GD; cf. #9712. (I.e., the FIXME note in `SPKG.txt` should also be removed.)


---

Comment by AlexanderDreyer created at 2011-10-08 21:36:34

Here the updates spkg for the 0.7 series.
http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.7.1.p7.spkg
PolyBoRi 0.8 will follow soon.


---

Comment by AlexanderDreyer created at 2011-10-08 22:17:37

Changing status from needs_info to needs_review.


---

Comment by AlexanderDreyer created at 2011-10-08 22:17:37

Delivering a fix for polybori 0.7.1 this ticket should depend on #11756. I'll open another ticket for 0.8.


---

Comment by AlexanderDreyer created at 2011-10-09 21:24:57

Since I had to backport another patch from 0.8 (prepend local paths), I rebundled another spkg (at the same place above).


---

Comment by AlexanderDreyer created at 2011-10-09 21:58:41

Note the corresponding ticket for 0.8 is #11909.


---

Comment by AlexanderDreyer created at 2011-10-10 21:05:53

The new spkg builds, installs and passes all tests on SuSE 11 amd64 and OS X 10.5 ppc.


---

Comment by leif created at 2011-10-10 22:54:01

Replying to [comment:12 AlexanderDreyer]:
> The new spkg builds, installs and passes all tests on *SuSE 11* [...]

In that case, you could also give the new readline 6.2 spkg at #11882 a try... :P

(We couldn't yet test it on OpenSUSE, i.e. nobody had access to an OpenSUSE system; I'm pretty sure the work-around is meanwhile obsolete such that we should remove or disable it.  I've only tested it on SLES 11.1 where the work-around -- more or less incidentally -- isn't applied.)


---

Comment by AlexanderDreyer created at 2011-10-11 09:24:21

Replying to [comment:13 leif]:
> In that case, you could also give the new readline 6.2 spkg at #11882 a try... :P
If works fine!

> (We couldn't yet test it on OpenSUSE, i.e. nobody had access to an OpenSUSE system; I'm pretty sure the work-around is meanwhile obsolete such that we should remove or disable it.  I've only tested it on SLES 11.1 where the work-around -- more or less incidentally -- isn't applied.)
OpenSuSE 11.1 and SLES 11 are binary compatible. But it makes a difference whether SP1 was applied to one of them. (I would recomment to apply the service pack anyway.)


---

Comment by AlexanderDreyer created at 2011-10-11 09:24:21

Remove assignee AlexanderDreyer.


---

Comment by AlexanderDreyer created at 2011-10-11 09:31:23

Set assignee to AlexanderDreyer.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jdemeyer created at 2012-04-02 10:14:37

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2012-04-02 10:14:37

How does this relate to #12750 and #12655?


---

Comment by AlexanderDreyer created at 2012-04-02 14:51:40

Replying to [comment:17 jdemeyer]:
> How does this relate to #12750 and #12655?
The fix was merge upstream into the 0.8.1 branch, so #12655 includes it. #12750 only partially (`CXXFLAGS` etc.).


---

Comment by AlexanderDreyer created at 2012-04-02 14:54:04

I'd suggest that I provide a new polybori.0.8.0.p3.spkg with the environment patch in #11909, but not for #12655 (0.8.1).


---

Comment by jdemeyer created at 2012-04-02 15:01:42

Replying to [comment:19 AlexanderDreyer]:
> I'd suggest that I provide a new polybori.0.8.0.p3.spkg with the environment patch in #11909, but not for #12655 (0.8.1).
If #12655 already includes the patch, I don't see the need to do this.

Why not close this ticket as duplicate of #12655?


---

Comment by AlexanderDreyer created at 2012-04-02 18:17:12

Replying to [comment:20 jdemeyer]:
> Why not close this ticket as duplicate of #12655?
I'm fine with that. (In fact, I'd prefer resolving as duplicate, since that issue is really obsolete now.)


---

Comment by jdemeyer created at 2012-04-02 21:08:38

Resolution: duplicate


---

Comment by leif created at 2012-04-02 22:38:55

Well, this ticket isn't really a duplicate of #12655, it's just (more or less incidentally) superseded by #12655, since upstream also fixed this in the later release.

So until we've upgraded PolyBoRi to 0.8.1 (for other reasons as well), this is still an open issue, although not with PolyBoRi 0.7.1, but 0.8.0, our current spkg.  *#11909* addresses this... :-)
