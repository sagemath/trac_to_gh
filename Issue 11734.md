# Issue 11734: PolyBoRi should obey some standard environment variables

archive/issues_011734.json:
```json
{
    "body": "Assignee: AlexGhitza\n\nCC:  leif\n\nIt was discovered in #11575 that PolyBoRi's build system  does not export all relevant environment variables to the build environment.\n\nThe PolyBoRi spkg already treats the following:\n`CC CXX SAGESOFLAGS PYTHONHOME SAGE_LOCAL`\n\nYet, the following standard environment variables are not utilized in PolyBoRi's build process:\n`CFLAGS CXXFLAGS CPPFLAGS LDFLAGS ABI CPP`\n\nThe following environment variables should be exported to PolyBoRi's build environment:\n`LD_LIBRARY_PATH LIBRARY_PATH LD_RUN_PATH DYLD_RUN_PATH`\n\nIssue created by migration from https://trac.sagemath.org/ticket/11906\n\n",
    "created_at": "2011-10-07T20:24:00Z",
    "labels": [
        "algebra",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "PolyBoRi should obey some standard environment variables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11734",
    "user": "AlexanderDreyer"
}
```
Assignee: AlexGhitza

CC:  leif

It was discovered in #11575 that PolyBoRi's build system  does not export all relevant environment variables to the build environment.

The PolyBoRi spkg already treats the following:
`CC CXX SAGESOFLAGS PYTHONHOME SAGE_LOCAL`

Yet, the following standard environment variables are not utilized in PolyBoRi's build process:
`CFLAGS CXXFLAGS CPPFLAGS LDFLAGS ABI CPP`

The following environment variables should be exported to PolyBoRi's build environment:
`LD_LIBRARY_PATH LIBRARY_PATH LD_RUN_PATH DYLD_RUN_PATH`

Issue created by migration from https://trac.sagemath.org/ticket/11906





---

archive/issue_comments_133396.json:
```json
{
    "body": "Changing assignee from AlexGhitza to AlexanderDreyer.",
    "created_at": "2011-10-07T20:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133396",
    "user": "AlexanderDreyer"
}
```

Changing assignee from AlexGhitza to AlexanderDreyer.



---

archive/issue_comments_133397.json:
```json
{
    "body": "There are two kind of environment variables. \nFirst, there are `PATH`, `LD_LIBRARY_PATH`, `CPATH` (used by gcc} and similar ones. Those just have to be imported to the build environment, for instance by the following patch to PolyBoRi's `SConstruct` file:\n\n\n```diff -u\n\n@@ -377,17 +377,12 @@                                                                                                           \n                                                                                                                                \n tools +=  [\"disttar\", \"doxygen\"]                                                                                               \n                                                                                                                                \n-# Get paths an related things from current environment                                                                         \n-# note: we cannot avoid those due to non-standard system setups                                                                \n-getenv = dict()                                                                                                                \n-for key in ['PATH', 'HOME', 'LD_LIBRARY_PATH'] :                                                                               \n-    try:                                                                                                                       \n-        getenv[key] = os.environ[key]                                                                                          \n-    except KeyError:                                                                                                           \n-        pass                                                                                                                   \n+# Get paths and related things from current environment os.environ                                                             \n+# note: We cannot avoid those due to non-standard system setups,                                                               \n+#       also we do not know which variables are used in general                                                                \n                                                                                                                                \n-                                                                                                                               \n-env = Environment(ENV = getenv, options = opts, tools = tools, toolpath = '.')                                                 \n+env = Environment(ENV = os.environ, options = opts, tools = tools,                                                             \n+                  toolpath = '.')                                                                                              \n                                                                                                                                \n env['RPATH'] = env.Literal('\\\\$$ORIGIN/') \n```\n\n\nOn the other hand, there are variables like `CFLAGS`, `LDFLAGS`... Those are not used by the compiler directly, but by `make`-based build systems. So we have to tell `scons` what we intended with them. For instance, we have to add a line like the following to the configuration file `custom.py` in the spkg:\n\n\n```python\nCXXFLAGS=os.environ['CXXFLAGS']\n```\n",
    "created_at": "2011-10-07T22:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133397",
    "user": "AlexanderDreyer"
}
```

There are two kind of environment variables. 
First, there are `PATH`, `LD_LIBRARY_PATH`, `CPATH` (used by gcc} and similar ones. Those just have to be imported to the build environment, for instance by the following patch to PolyBoRi's `SConstruct` file:


```diff -u

@@ -377,17 +377,12 @@                                                                                                           
                                                                                                                                
 tools +=  ["disttar", "doxygen"]                                                                                               
                                                                                                                                
-# Get paths an related things from current environment                                                                         
-# note: we cannot avoid those due to non-standard system setups                                                                
-getenv = dict()                                                                                                                
-for key in ['PATH', 'HOME', 'LD_LIBRARY_PATH'] :                                                                               
-    try:                                                                                                                       
-        getenv[key] = os.environ[key]                                                                                          
-    except KeyError:                                                                                                           
-        pass                                                                                                                   
+# Get paths and related things from current environment os.environ                                                             
+# note: We cannot avoid those due to non-standard system setups,                                                               
+#       also we do not know which variables are used in general                                                                
                                                                                                                                
-                                                                                                                               
-env = Environment(ENV = getenv, options = opts, tools = tools, toolpath = '.')                                                 
+env = Environment(ENV = os.environ, options = opts, tools = tools,                                                             
+                  toolpath = '.')                                                                                              
                                                                                                                                
 env['RPATH'] = env.Literal('\\$$ORIGIN/') 
```


On the other hand, there are variables like `CFLAGS`, `LDFLAGS`... Those are not used by the compiler directly, but by `make`-based build systems. So we have to tell `scons` what we intended with them. For instance, we have to add a line like the following to the configuration file `custom.py` in the spkg:


```python
CXXFLAGS=os.environ['CXXFLAGS']
```




---

archive/issue_comments_133398.json:
```json
{
    "body": "It turned out that the build (and partially \"Configure\", by not finding the GD and M4RI libraries) was broken for me just because **`LIBRARY_PATH`** was missing in the environment set up by (or for) `SConstruct`.\n\nSo using\n\n```python\nenv = Environment(ENV = os.environ, options = opts, tools = tools,                                                             \n                  toolpath = '.')\n```\n\n(in `SConstruct`) would work for me, as well as just adding `LIBRARY_PATH` to the \"exported\" environment variables.\n\nAnother option is to add all the directories from `LIBRARY_PATH` to `LIBPATH` (in `custom.py`):\n\n```python\nif os.environ.has_key(\"LIBRARY_PATH\"): \n    LIBPATH += os.environ[\"LIBRARY_PATH\"].split(os.pathsep)\n```\n\n\n(Cf. [comment:ticket:11575:131 this comment] at #11575.)\n\n\n\n\nIt's in general of course not bad to export (and/or make use of) other standard environment variables, like `CFLAGS` etc., too, as mentioned in the ticket's description.",
    "created_at": "2011-10-08T02:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133398",
    "user": "leif"
}
```

It turned out that the build (and partially "Configure", by not finding the GD and M4RI libraries) was broken for me just because **`LIBRARY_PATH`** was missing in the environment set up by (or for) `SConstruct`.

So using

```python
env = Environment(ENV = os.environ, options = opts, tools = tools,                                                             
                  toolpath = '.')
```

(in `SConstruct`) would work for me, as well as just adding `LIBRARY_PATH` to the "exported" environment variables.

Another option is to add all the directories from `LIBRARY_PATH` to `LIBPATH` (in `custom.py`):

```python
if os.environ.has_key("LIBRARY_PATH"): 
    LIBPATH += os.environ["LIBRARY_PATH"].split(os.pathsep)
```


(Cf. [comment:ticket:11575:131 this comment] at #11575.)




It's in general of course not bad to export (and/or make use of) other standard environment variables, like `CFLAGS` etc., too, as mentioned in the ticket's description.



---

archive/issue_comments_133399.json:
```json
{
    "body": "Replying to [comment:3 leif]:\n> It's in general of course not bad to export (and/or make use of) other standard environment variables, like `CFLAGS` etc., too, as mentioned in the ticket's description.\nYeah, this will be default now in 0.8.1. We change here one crucial paradigm (better explicit than implict variable import). But since one cannot know all set ups, this is the best was to do.\n\nI'll prepare new spkgs soon.",
    "created_at": "2011-10-08T19:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133399",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:3 leif]:
> It's in general of course not bad to export (and/or make use of) other standard environment variables, like `CFLAGS` etc., too, as mentioned in the ticket's description.
Yeah, this will be default now in 0.8.1. We change here one crucial paradigm (better explicit than implict variable import). But since one cannot know all set ups, this is the best was to do.

I'll prepare new spkgs soon.



---

archive/issue_comments_133400.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2011-10-08T19:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133400",
    "user": "AlexanderDreyer"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_133401.json:
```json
{
    "body": "`SPKG.txt` should have a *Special Update/Build Instructions* section (e.g. mentioning that some upstream parts should get deleted, cf. #9472).\n\nAlso, `spkg/standard/deps` have been fixed long ago to make PolyBoRi also depend on GD; cf. #9712. (I.e., the FIXME note in `SPKG.txt` should also be removed.)",
    "created_at": "2011-10-08T20:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133401",
    "user": "leif"
}
```

`SPKG.txt` should have a *Special Update/Build Instructions* section (e.g. mentioning that some upstream parts should get deleted, cf. #9472).

Also, `spkg/standard/deps` have been fixed long ago to make PolyBoRi also depend on GD; cf. #9712. (I.e., the FIXME note in `SPKG.txt` should also be removed.)



---

archive/issue_comments_133402.json:
```json
{
    "body": "Here the updates spkg for the 0.7 series.\nhttp://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.7.1.p7.spkg\nPolyBoRi 0.8 will follow soon.",
    "created_at": "2011-10-08T21:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133402",
    "user": "AlexanderDreyer"
}
```

Here the updates spkg for the 0.7 series.
http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.7.1.p7.spkg
PolyBoRi 0.8 will follow soon.



---

archive/issue_comments_133403.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2011-10-08T22:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133403",
    "user": "AlexanderDreyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_133404.json:
```json
{
    "body": "Delivering a fix for polybori 0.7.1 this ticket should depend on #11756. I'll open another ticket for 0.8.",
    "created_at": "2011-10-08T22:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133404",
    "user": "AlexanderDreyer"
}
```

Delivering a fix for polybori 0.7.1 this ticket should depend on #11756. I'll open another ticket for 0.8.



---

archive/issue_comments_133405.json:
```json
{
    "body": "Since I had to backport another patch from 0.8 (prepend local paths), I rebundled another spkg (at the same place above).",
    "created_at": "2011-10-09T21:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133405",
    "user": "AlexanderDreyer"
}
```

Since I had to backport another patch from 0.8 (prepend local paths), I rebundled another spkg (at the same place above).



---

archive/issue_comments_133406.json:
```json
{
    "body": "Note the corresponding ticket for 0.8 is #11909.",
    "created_at": "2011-10-09T21:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133406",
    "user": "AlexanderDreyer"
}
```

Note the corresponding ticket for 0.8 is #11909.



---

archive/issue_comments_133407.json:
```json
{
    "body": "The new spkg builds, installs and passes all tests on SuSE 11 amd64 and OS X 10.5 ppc.",
    "created_at": "2011-10-10T21:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133407",
    "user": "AlexanderDreyer"
}
```

The new spkg builds, installs and passes all tests on SuSE 11 amd64 and OS X 10.5 ppc.



---

archive/issue_comments_133408.json:
```json
{
    "body": "Replying to [comment:12 AlexanderDreyer]:\n> The new spkg builds, installs and passes all tests on **SuSE 11** [...]\n\nIn that case, you could also give the new readline 6.2 spkg at #11882 a try... :P\n\n(We couldn't yet test it on OpenSUSE, i.e. nobody had access to an OpenSUSE system; I'm pretty sure the work-around is meanwhile obsolete such that we should remove or disable it.  I've only tested it on SLES 11.1 where the work-around -- more or less incidentally -- isn't applied.)",
    "created_at": "2011-10-10T22:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133408",
    "user": "leif"
}
```

Replying to [comment:12 AlexanderDreyer]:
> The new spkg builds, installs and passes all tests on **SuSE 11** [...]

In that case, you could also give the new readline 6.2 spkg at #11882 a try... :P

(We couldn't yet test it on OpenSUSE, i.e. nobody had access to an OpenSUSE system; I'm pretty sure the work-around is meanwhile obsolete such that we should remove or disable it.  I've only tested it on SLES 11.1 where the work-around -- more or less incidentally -- isn't applied.)



---

archive/issue_comments_133409.json:
```json
{
    "body": "Replying to [comment:13 leif]:\n> In that case, you could also give the new readline 6.2 spkg at #11882 a try... :P\nIf works fine!\n\n> (We couldn't yet test it on OpenSUSE, i.e. nobody had access to an OpenSUSE system; I'm pretty sure the work-around is meanwhile obsolete such that we should remove or disable it.  I've only tested it on SLES 11.1 where the work-around -- more or less incidentally -- isn't applied.)\nOpenSuSE 11.1 and SLES 11 are binary compatible. But it makes a difference whether SP1 was applied to one of them. (I would recomment to apply the service pack anyway.)",
    "created_at": "2011-10-11T09:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133409",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:13 leif]:
> In that case, you could also give the new readline 6.2 spkg at #11882 a try... :P
If works fine!

> (We couldn't yet test it on OpenSUSE, i.e. nobody had access to an OpenSUSE system; I'm pretty sure the work-around is meanwhile obsolete such that we should remove or disable it.  I've only tested it on SLES 11.1 where the work-around -- more or less incidentally -- isn't applied.)
OpenSuSE 11.1 and SLES 11 are binary compatible. But it makes a difference whether SP1 was applied to one of them. (I would recomment to apply the service pack anyway.)



---

archive/issue_comments_133410.json:
```json
{
    "body": "Remove assignee AlexanderDreyer.",
    "created_at": "2011-10-11T09:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133410",
    "user": "AlexanderDreyer"
}
```

Remove assignee AlexanderDreyer.



---

archive/issue_comments_133411.json:
```json
{
    "body": "Set assignee to AlexanderDreyer.",
    "created_at": "2011-10-11T09:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133411",
    "user": "AlexanderDreyer"
}
```

Set assignee to AlexanderDreyer.



---

archive/issue_comments_133412.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133412",
    "user": "jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_133413.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2012-04-02T10:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133413",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_133414.json:
```json
{
    "body": "How does this relate to #12750 and #12655?",
    "created_at": "2012-04-02T10:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133414",
    "user": "jdemeyer"
}
```

How does this relate to #12750 and #12655?



---

archive/issue_comments_133415.json:
```json
{
    "body": "Replying to [comment:17 jdemeyer]:\n> How does this relate to #12750 and #12655?\nThe fix was merge upstream into the 0.8.1 branch, so #12655 includes it. #12750 only partially (`CXXFLAGS` etc.).",
    "created_at": "2012-04-02T14:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133415",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:17 jdemeyer]:
> How does this relate to #12750 and #12655?
The fix was merge upstream into the 0.8.1 branch, so #12655 includes it. #12750 only partially (`CXXFLAGS` etc.).



---

archive/issue_comments_133416.json:
```json
{
    "body": "I'd suggest that I provide a new polybori.0.8.0.p3.spkg with the environment patch in #11909, but not for #12655 (0.8.1).",
    "created_at": "2012-04-02T14:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133416",
    "user": "AlexanderDreyer"
}
```

I'd suggest that I provide a new polybori.0.8.0.p3.spkg with the environment patch in #11909, but not for #12655 (0.8.1).



---

archive/issue_comments_133417.json:
```json
{
    "body": "Replying to [comment:19 AlexanderDreyer]:\n> I'd suggest that I provide a new polybori.0.8.0.p3.spkg with the environment patch in #11909, but not for #12655 (0.8.1).\nIf #12655 already includes the patch, I don't see the need to do this.\n\nWhy not close this ticket as duplicate of #12655?",
    "created_at": "2012-04-02T15:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133417",
    "user": "jdemeyer"
}
```

Replying to [comment:19 AlexanderDreyer]:
> I'd suggest that I provide a new polybori.0.8.0.p3.spkg with the environment patch in #11909, but not for #12655 (0.8.1).
If #12655 already includes the patch, I don't see the need to do this.

Why not close this ticket as duplicate of #12655?



---

archive/issue_comments_133418.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n> Why not close this ticket as duplicate of #12655?\nI'm fine with that. (In fact, I'd prefer resolving as duplicate, since that issue is really obsolete now.)",
    "created_at": "2012-04-02T18:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133418",
    "user": "AlexanderDreyer"
}
```

Replying to [comment:20 jdemeyer]:
> Why not close this ticket as duplicate of #12655?
I'm fine with that. (In fact, I'd prefer resolving as duplicate, since that issue is really obsolete now.)



---

archive/issue_comments_133419.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2012-04-02T21:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133419",
    "user": "jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_comments_133420.json:
```json
{
    "body": "Well, this ticket isn't really a duplicate of #12655, it's just (more or less incidentally) superseded by #12655, since upstream also fixed this in the later release.\n\nSo until we've upgraded PolyBoRi to 0.8.1 (for other reasons as well), this is still an open issue, although not with PolyBoRi 0.7.1, but 0.8.0, our current spkg.  **#11909** addresses this... :-)",
    "created_at": "2012-04-02T22:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11734",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11734#issuecomment-133420",
    "user": "leif"
}
```

Well, this ticket isn't really a duplicate of #12655, it's just (more or less incidentally) superseded by #12655, since upstream also fixed this in the later release.

So until we've upgraded PolyBoRi to 0.8.1 (for other reasons as well), this is still an open issue, although not with PolyBoRi 0.7.1, but 0.8.0, our current spkg.  **#11909** addresses this... :-)
