# Issue 30440: Add VS Code config for inplace venv

Issue created by migration from https://trac.sagemath.org/ticket/30677

Original creator: @tobiasdiez

Original creation time: 2020-09-28 09:09:43

CC:  mkoeppe

Add VS code config to use the local virtual environment `src/.venv` that is added in #30371.


---

Comment by @tobiasdiez created at 2020-09-28 09:09:51

Changing status from new to needs_review.


---

Comment by git created at 2020-10-03 22:10:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by dimpase created at 2020-12-12 08:16:03

rebase is needed


---

Comment by mkoeppe created at 2021-02-11 22:58:56

This ticket could also be retargeted to #31377, using `local/` as the venv instead of `src/.venv`.


---

Comment by @tobiasdiez created at 2021-02-18 18:38:09

Replying to [comment:8 mkoeppe]:
> This ticket could also be retargeted to #31377, using `local/` as the venv instead of `src/.venv`.

The nice thing about pipenv is that one can specify python packages for development, and so install e.g. pytest and linters in the virtual environment. VS code picks these up, and complains if they are not installed otherwise. Does sage's build setup has a similar flag to install dev packages?


---

Comment by mkoeppe created at 2021-02-18 18:41:40

In the current model, the linters are installed by tox into the tox environment.


---

Comment by dimpase created at 2021-03-10 13:57:00

needs a rebase


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-08-28 01:32:38

This should be redone without dep on #30371


---

Comment by mkoeppe created at 2021-08-28 01:32:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-10-03 03:41:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-10-03 04:11:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-04 09:39:55

If you plan to change from the pipenv to the sage venv, please also make sure that all dev-packages are included in the latter enviroment: https://github.com/sagemath/sagetrac-mirror/blob/fec55234a00e46d023ad583f8c6284b970141ab0/src/Pipfile#L6-L15
These are needed to use all features of VS code properly (linting, jupyter notebook support, etc). While working on the pipenv enviroment I've added those packages, but didn't double-check if they are included in the sage distribution (since they are meant only for developers, and not for actual distribution). 

Also for clarification: the sage venv can be configured to have an editable install, right?


---

Comment by mkoeppe created at 2021-10-04 19:43:43

Replying to [comment:19 gh-tobiasdiez]:
> for clarification: the sage venv can be configured to have an editable install, right?

Yes, this has been shipped in Sage 9.3, see https://wiki.sagemath.org/ReleaseTours/sage-9.3#Editable_.28.22in-place.22.2C_.22develop.22.29_installs_of_the_Sage_library


---

Comment by @tobiasdiez created at 2021-10-21 19:19:04

Matthias do you still have something you want to change here?

By the way, I think `.venv` is the most common convention for python venvs. At leasts that's what pipenv and poetry are using by default, and https://docs.python.org/3/library/venv.html is listing as "a common name". So maybe as a follow-up to #32442 rename the symbolic link accordingly (or even make it the default to install the python environment in `.venv`)?


---

Comment by @tobiasdiez created at 2021-10-21 19:19:04

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-10-21 19:23:14

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-10-21 19:34:21

Replying to [comment:21 gh-tobiasdiez]:
> I think `.venv` is the most common convention for python venvs. At leasts that's what pipenv and poetry are using by default, and https://docs.python.org/3/library/venv.html is listing as "a common name". So maybe as a follow-up to #32442 rename the symbolic link accordingly (or even make it the default to install the python environment in `.venv`)?

Well, a `.venv` according to this common convention would lie in `SAGE_ROOT/src/` or perhaps in `SAGE_ROOT/pkgs/sagemath-standard/`, i.e., at the root of a Python distribution tree -- not in `SAGE_ROOT`, so it's not just a matter of renaming.

Also, I don't think we want tools such as `pipenv` to actually manipulate the venv built by the Sage distribution because it is managed by our build system.


---

Comment by mkoeppe created at 2021-10-21 19:40:47

To expand on this, I think it's better to reserve the common name `.venv` for user-created venvs (of which there can be many); and to use `SAGE_ROOT/venv` for "the" venv (= the one configured and built by the distribution).

Then we can document as "best practices" to work with a user-created venv for example as the target for pip-installing additional packages. This will be more robust than the current status quo, in which the venv is built by our special tooling, and users kind of can install additional stuff if they are careful.


---

Comment by @tobiasdiez created at 2021-10-22 08:19:13

Replying to [comment:24 mkoeppe]:
> To expand on this, I think it's better to reserve the common name `.venv` for user-created venvs (of which there can be many); and to use `SAGE_ROOT/venv` for "the" venv (= the one configured and built by the distribution).

In this case, it is no good idea to use `venv` as the base for VS code since extensions (pycodestyle, pytest etc) will install additional packages using pip if needed.

 
> Then we can document as "best practices" to work with a user-created venv for example as the target for pip-installing additional packages. This will be more robust than the current status quo, in which the venv is built by our special tooling, and users kind of can install additional stuff if they are careful.

To be honest, this sounds relatively complicated and confusing (as a 'normal' dev I don't really see the difference between ".venv" and "venv"). Why not treat sage-the-distribution as just one of many ways to create a venv? For example, one could also add a `enable-pipenv` flag to make in which case pipenv is used to create the venv instead. It would be strange if this then would create `venv` and `.venv`.


---

Comment by mkoeppe created at 2021-10-22 19:48:50

Replying to [comment:25 gh-tobiasdiez]:
> Why not treat sage-the-distribution as just one of many ways to create a venv? 

Well, sage-the-distribution builds a set of wheels using "the" venv, which are stored in the venv's `var/lib/sage/wheels` directory. This distinguishes "the" venv from other venvs. I want to document the process for users to create user venvs by installing these wheels.


---

Comment by mkoeppe created at 2021-10-22 19:58:59

Replying to [comment:25 gh-tobiasdiez]:
> Replying to [comment:24 mkoeppe]:
> > To expand on this, I think it's better to reserve the common name `.venv` for user-created venvs (of which there can be many); and to use `SAGE_ROOT/venv` for "the" venv (= the one configured and built by the distribution).
> 
> In this case, it is no good idea to use `venv` as the base for VS code since extensions (pycodestyle, pytest etc) will install additional packages using pip if needed.

This is a good point but as of the status quo, "the" venv is the only venv around.


---

Comment by mkoeppe created at 2021-10-25 03:36:56

What is the work issue "config test discovery"?


---

Comment by git created at 2021-10-26 15:41:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-10-26 15:42:12

Replying to [comment:28 mkoeppe]:
> What is the work issue "config test discovery"?

Adding config for VS code testing feature: https://code.visualstudio.com/docs/python/testing.
I've added this now.


---

Comment by @tobiasdiez created at 2021-10-26 15:42:27

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2021-11-18 12:25:27

It would be nice if this could be reviewed (and merged) relatively soon.


---

Comment by dimpase created at 2021-11-18 15:43:30

Does it mean to work together with a particular VSCode plugin?


---

Comment by git created at 2021-11-18 16:28:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-11-18 16:32:41

Replying to [comment:33 dimpase]:
> Does it mean to work together with a particular VSCode plugin?

With the "standard" python extension https://marketplace.visualstudio.com/items?itemName=ms-python.python, which I've now also added as "recommendation" (vscode will ask once when a workspace is opened for the first time to install these recommended extensions).


---

Comment by git created at 2021-11-18 16:33:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2021-11-19 14:46:52

I got it installed, and what should I try? I don't use vscode for developent, so it's pretty unclear.

Incidentally, I saw that vscode has support for jupyter notebooks now, but the kernels it knows are the Python only ones. Should it know - be able to discover somehow - Sage's jupyter kernel, too?


---

Comment by @tobiasdiez created at 2021-11-19 16:26:27

It should "just work". This ticket is not doing much, only adding basic configs so that vs code is automatically discovering the right things. In particular:
- Find the virtual environment in `venv`
- Use pytest for test discovery (https://code.visualstudio.com/docs/python/testing)
- Hide build artifacts in the file explorer

Coding you still have to do yourself though ;) (or install https://copilot.github.com/)

But you are right, adding documentation for how to use vs code might be a good follow-up. The same for the jupyter support - I had a quick look and it seems to work in principle but still have to figure out the details.


---

Comment by dimpase created at 2021-11-19 16:48:13

Replying to [comment:38 gh-tobiasdiez]:
> It should "just work". This ticket is not doing much, only adding basic configs so that vs code is automatically discovering the right things. In particular:
> - Find the virtual environment in `venv`
> - Use pytest for test discovery (https://code.visualstudio.com/docs/python/testing)
> - Hide build artifacts in the file explorer

I know it's hard to explain in text - but I have trouble understanding how to do the
1st 2 items. (we can have a video call via google meet or so, so that I can see the screen and
the cursor...)

By `It should "just work"` - do you mean the jupyter thing?
Well, I can browse (and view, nicely) Sage's jupyter notebooks in vscode, but not run, as I don't see a way to select the right kernel, and it's now shown in the menu.


> 
> Coding you still have to do yourself though ;) (or install https://copilot.github.com/)
> 
I sometimes use vscode as an IDE to write markdown or LaTeX (or Lean :-)), but never for other things, so far.


---

Comment by @tobiasdiez created at 2021-11-19 17:26:01

For the virtual env, you should have something like `Pytohn 3.8.10 ('venv': venv)` in the lower left corner 
![](https://code.visualstudio.com/assets/docs/python/environments/selected-interpreter-status-bar.png)

With this ticket, this is now the default and can be changed as described in https://code.visualstudio.com/docs/python/environments#_select-and-activate-an-environment.


For testing, vscode should now look for pytests instead of the "Configure Python tests" window that you get normally after activating the test icon (with the red border)

![](https://code.visualstudio.com/assets/docs/python/testing/test-explorer-no-tests.png)

For jupyter, it may work if you have jupter installed in the sage venv and then select it as the kernel as described here https://code.visualstudio.com/docs/datascience/jupyter-notebooks#_create-or-open-a-jupyter-notebook.
There are also config options to do this by default, but I've not yet looked into this.
For basic things, this is working for me, but I'm not sure about e.g. sage syntax etc.


---

Comment by dimpase created at 2021-11-21 12:35:51

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-11-21 12:35:51

OK, I'm getting somewhere with Jupyter.

This time I started with opening the SAGE_ROOT "folder", clicked on "trust the author", and only after that, opened a Sage Jupyter notebook.

Now, the Sage kernel shows up in the kernel list, and if I choose it, then after a while (~10 sec or more, I thought it just hangs, at first) it loads and everything works.
Opening it next time is a bit faster. (I'm on a slow net now, and maybe it's phoning back?!).

Anyhow, these details (about opening folger and blessing it) should be added to wiki, or docs, something like this.

Otherwise, good!


---

Comment by dimpase created at 2021-11-21 12:37:45

It should be adverticed in the release wiki, we probably will then get a lot of feedback.


---

Comment by @tobiasdiez created at 2021-11-21 18:21:08

Thanks for the review.

I agree that it would be helpful to have a how to get started with vscode, especially for beginners. But I couldn't any similar docs for other Ides either. What are the conventions, and is it okay to "advertise" vscode by adding it to the docs?


---

Comment by mkoeppe created at 2021-11-21 20:15:15

This would be a very valuable contribution. We have a meta-ticket #30500 for these kinds of things, but so far nobody has done the work.


---

Comment by dimpase created at 2021-11-21 23:17:34

Replying to [comment:44 gh-tobiasdiez]:
> Thanks for the review.
> 
> I agree that it would be helpful to have a how to get started with vscode, especially for beginners. But I couldn't any similar docs for other Ides either. What are the conventions, and is it okay to "advertise" vscode by adding it to the docs? 

as vscode is getting dominant, hiding from the public that we have these binding in Sage is kind of silly.

we do have binding for jupyter(lab), and something for emacs too, so it's not setting up a precedent.


---

Comment by vbraun created at 2022-01-01 00:23:14

Resolution: fixed
