# Issue 10814: Floyd-Warshall algorithm in Cython

archive/issues_010814.json:
```json
{
    "body": "Assignee: jason, ncohen, rlm\n\nCC:  jason rlm mvngu\n\nThis patch implements a Cython version of the Floyd-Warshall algorithm currently available in Sage. Both stay implemented, as the Cython version only deals with unweighted graphs, and prefers to add integer values than Python objects anyway.\n\nThe performance improvement is obvious for the ``all_pairs_shortest_path`` method which used by default the Python implementation\n\n```\nsage: g = graphs.PetersenGraph()\nsage: %timeit g.shortest_path_all_pairs()\n625 loops, best of 3: 555 \u00b5s per loop\nsage: %timeit g.shortest_path_all_pairs(by_weight=True)\n125 loops, best of 3: 6.44 ms per loop\nsage: g = graphs.Grid2dGraph(5,5)\nsage: %timeit g.shortest_path_all_pairs()\n125 loops, best of 3: 3.77 ms per loop\nsage: %timeit g.shortest_path_all_pairs(by_weight=True)\n5 loops, best of 3: 133 ms per loop\nsage: g = graphs.Grid2dGraph(15,15)\nsage: %timeit g.shortest_path_all_pairs()\n5 loops, best of 3: 753 ms per loop\nsage: %timeit g.shortest_path_all_pairs(by_weight=True)\n(still running)\n```\n\nThe new implementation is now the default.\n\nMeanwhile, the method ``distance_all_pairs`` which already used Cython code is not always improved \n\n```\nsage: g = graphs.PetersenGraph()\nsage: %timeit g.distance_all_pairs()\n625 loops, best of 3: 660 \u00b5s per loop\nsage: %timeit g.distance_all_pairs(algorithm=\"Floyd-Warshall\")\n625 loops, best of 3: 263 \u00b5s per loop\n\nsage: g = graphs.Grid2dGraph(20,20)\nsage: %timeit g.distance_all_pairs()\n5 loops, best of 3: 951 ms per loop\nsage: %timeit g.distance_all_pairs(algorithm=\"Floyd-Warshall\")\n5 loops, best of 3: 3.08 s per loop\n```\n\n\nHence the default behaviour of this method does not change, the two algorithms being made available.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10885\n\n",
    "created_at": "2011-03-07T15:01:41Z",
    "labels": [
        "graph theory",
        "major",
        "enhancement"
    ],
    "title": "Floyd-Warshall algorithm in Cython",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10814",
    "user": "ncohen"
}
```
Assignee: jason, ncohen, rlm

CC:  jason rlm mvngu

This patch implements a Cython version of the Floyd-Warshall algorithm currently available in Sage. Both stay implemented, as the Cython version only deals with unweighted graphs, and prefers to add integer values than Python objects anyway.

The performance improvement is obvious for the ``all_pairs_shortest_path`` method which used by default the Python implementation

```
sage: g = graphs.PetersenGraph()
sage: %timeit g.shortest_path_all_pairs()
625 loops, best of 3: 555 µs per loop
sage: %timeit g.shortest_path_all_pairs(by_weight=True)
125 loops, best of 3: 6.44 ms per loop
sage: g = graphs.Grid2dGraph(5,5)
sage: %timeit g.shortest_path_all_pairs()
125 loops, best of 3: 3.77 ms per loop
sage: %timeit g.shortest_path_all_pairs(by_weight=True)
5 loops, best of 3: 133 ms per loop
sage: g = graphs.Grid2dGraph(15,15)
sage: %timeit g.shortest_path_all_pairs()
5 loops, best of 3: 753 ms per loop
sage: %timeit g.shortest_path_all_pairs(by_weight=True)
(still running)
```

The new implementation is now the default.

Meanwhile, the method ``distance_all_pairs`` which already used Cython code is not always improved 

```
sage: g = graphs.PetersenGraph()
sage: %timeit g.distance_all_pairs()
625 loops, best of 3: 660 µs per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
625 loops, best of 3: 263 µs per loop

sage: g = graphs.Grid2dGraph(20,20)
sage: %timeit g.distance_all_pairs()
5 loops, best of 3: 951 ms per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
5 loops, best of 3: 3.08 s per loop
```


Hence the default behaviour of this method does not change, the two algorithms being made available.

Issue created by migration from https://trac.sagemath.org/ticket/10885





---

archive/issue_comments_114489.json:
```json
{
    "body": "Attachment [trac_10885.patch](tarball://root/attachments/some-uuid/ticket10885/trac_10885.patch) by jason created at 2011-03-07 16:34:57",
    "created_at": "2011-03-07T16:34:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114489",
    "user": "jason"
}
```

Attachment [trac_10885.patch](tarball://root/attachments/some-uuid/ticket10885/trac_10885.patch) by jason created at 2011-03-07 16:34:57



---

archive/issue_comments_114490.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-03-07T18:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114490",
    "user": "ncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_114491.json:
```json
{
    "body": "Passes all long tests ! `:-)`\n\nNathann",
    "created_at": "2011-03-07T18:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114491",
    "user": "ncohen"
}
```

Passes all long tests ! `:-)`

Nathann



---

archive/issue_comments_114492.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-03-09T00:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114492",
    "user": "ylchapuy"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_114493.json:
```json
{
    "body": "You can easily improve a lot the efficiency by:\n* cdefing list gverts = g.verts()\n* using g instead of gg._backend._cg\n* cdefing two dicts variables for gg._backend.vertex_ints and gg._backend.vertex_labels as well\n* in the main triple loop, cdefing two vars dv = dist[v_int] and dw = dist[w_int] as outside as possible\n\nAlso anything dealing with prec should only be done it paths=True. This can save half the memory when not needed.",
    "created_at": "2011-03-09T00:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114493",
    "user": "ylchapuy"
}
```

You can easily improve a lot the efficiency by:
* cdefing list gverts = g.verts()
* using g instead of gg._backend._cg
* cdefing two dicts variables for gg._backend.vertex_ints and gg._backend.vertex_labels as well
* in the main triple loop, cdefing two vars dv = dist[v_int] and dw = dist[w_int] as outside as possible

Also anything dealing with prec should only be done it paths=True. This can save half the memory when not needed.



---

archive/issue_comments_114494.json:
```json
{
    "body": "Attachment [trac10885-efficiency_improvment.patch](tarball://root/attachments/some-uuid/ticket10885/trac10885-efficiency_improvment.patch) by ylchapuy created at 2011-03-10 18:20:43\n\napply after trac_10885.patch",
    "created_at": "2011-03-10T18:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114494",
    "user": "ylchapuy"
}
```

Attachment [trac10885-efficiency_improvment.patch](tarball://root/attachments/some-uuid/ticket10885/trac10885-efficiency_improvment.patch) by ylchapuy created at 2011-03-10 18:20:43

apply after trac_10885.patch



---

archive/issue_comments_114495.json:
```json
{
    "body": "apply both trac_10885.patch and trac10885-efficiency_improvment.patch",
    "created_at": "2011-03-10T18:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114495",
    "user": "ylchapuy"
}
```

apply both trac_10885.patch and trac10885-efficiency_improvment.patch



---

archive/issue_comments_114496.json:
```json
{
    "body": "I left a small bug in my last patch.\nApply in order trac_10885.patch trac10885-efficiency_improvment.patch and trac10855-efficiency_improvment_bug_correction.patch",
    "created_at": "2011-03-10T22:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114496",
    "user": "ylchapuy"
}
```

I left a small bug in my last patch.
Apply in order trac_10885.patch trac10885-efficiency_improvment.patch and trac10855-efficiency_improvment_bug_correction.patch



---

archive/issue_comments_114497.json:
```json
{
    "body": "Greaaaaat !! Thank you for your help ! I still have many tricks to learn `:-)`\n\nPasses all tests, does its job even faster... Niiiiice ! \n\nNathann",
    "created_at": "2011-03-11T04:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114497",
    "user": "ncohen"
}
```

Greaaaaat !! Thank you for your help ! I still have many tricks to learn `:-)`

Passes all tests, does its job even faster... Niiiiice ! 

Nathann



---

archive/issue_comments_114498.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2011-03-11T04:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114498",
    "user": "ncohen"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_114499.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-03-11T07:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114499",
    "user": "ylchapuy"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_114500.json:
```json
{
    "body": "Sorry to bother you, but formally I didn't gave you a positive review.\n\nE.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?\n\nYou might also add one doctest for the ValueError and one for paths=False and distances=True.",
    "created_at": "2011-03-11T07:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114500",
    "user": "ylchapuy"
}
```

Sorry to bother you, but formally I didn't gave you a positive review.

E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?

You might also add one doctest for the ValueError and one for paths=False and distances=True.



---

archive/issue_comments_114501.json:
```json
{
    "body": "Replying to [comment:8 ylchapuy]:\n> Sorry to bother you, but formally I didn't gave you a positive review.\n\nOh. Right. My mistake.\n\n> E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?\n\nWell, what would it return ? There is already a shortest_path_all pairs and distance_all_pairs in the Graph method, and Floyd-Warshall is not always the fastest available.\n\n> You might also add one doctest for the ValueError and one for paths=False and distances=True.\n\nDone !\n\nNathann",
    "created_at": "2011-03-11T13:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114501",
    "user": "ncohen"
}
```

Replying to [comment:8 ylchapuy]:
> Sorry to bother you, but formally I didn't gave you a positive review.

Oh. Right. My mistake.

> E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?

Well, what would it return ? There is already a shortest_path_all pairs and distance_all_pairs in the Graph method, and Floyd-Warshall is not always the fastest available.

> You might also add one doctest for the ValueError and one for paths=False and distances=True.

Done !

Nathann



---

archive/issue_comments_114502.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-11T13:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114502",
    "user": "ncohen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114503.json:
```json
{
    "body": "Attachment [trac_10885-documentation.patch](tarball://root/attachments/some-uuid/ticket10885/trac_10885-documentation.patch) by ncohen created at 2011-03-11 13:38:40",
    "created_at": "2011-03-11T13:38:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114503",
    "user": "ncohen"
}
```

Attachment [trac_10885-documentation.patch](tarball://root/attachments/some-uuid/ticket10885/trac_10885-documentation.patch) by ncohen created at 2011-03-11 13:38:40



---

archive/issue_comments_114504.json:
```json
{
    "body": "Replying to [comment:9 ncohen]:\n> Replying to [comment:8 ylchapuy]:\n> > E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?\n> \n> Well, what would it return ? There is already a shortest_path_all pairs and distance_all_pairs in the Graph method, and Floyd-Warshall is not always the fastest available.\n\nI'm not sure I follow the argument: it does return something, and it's even documented... Maybe call it '_floyd_warshall' if you don't want the user to access it.\n\nI might be wrong but it seems to me Sage convention is to prefer methods instead of functions. Jason, Robert, Minh, any preference on this matter?\n\n> > You might also add one doctest for the ValueError and one for paths=False and distances=True.\n> \n> Done !\n\nGreat, and it even removed a bug ;)\n\n> Nathann",
    "created_at": "2011-03-11T18:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114504",
    "user": "ylchapuy"
}
```

Replying to [comment:9 ncohen]:
> Replying to [comment:8 ylchapuy]:
> > E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?
> 
> Well, what would it return ? There is already a shortest_path_all pairs and distance_all_pairs in the Graph method, and Floyd-Warshall is not always the fastest available.

I'm not sure I follow the argument: it does return something, and it's even documented... Maybe call it '_floyd_warshall' if you don't want the user to access it.

I might be wrong but it seems to me Sage convention is to prefer methods instead of functions. Jason, Robert, Minh, any preference on this matter?

> > You might also add one doctest for the ValueError and one for paths=False and distances=True.
> 
> Done !

Great, and it even removed a bug ;)

> Nathann



---

archive/issue_comments_114505.json:
```json
{
    "body": "> I'm not sure I follow the argument: it does return something, and it's even documented... Maybe call it '_floyd_warshall' if you don't want the user to access it.\n\nWell, it can be renamed to _floyd_warshall if you want, but really anybody who would begin to list what is included inside this module will not really care about this _. There are several functions there already, which they are used by methods of the generic_graph file (a python file actually, though there also is a .pyx one).\n\nOh, and yes it's documented, like always. A patch to get the graph/ to 100% coverage was just finished, and I'm not going to spoil that by forgetting my methods `:-p`\n\nNathann",
    "created_at": "2011-03-12T12:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114505",
    "user": "ncohen"
}
```

> I'm not sure I follow the argument: it does return something, and it's even documented... Maybe call it '_floyd_warshall' if you don't want the user to access it.

Well, it can be renamed to _floyd_warshall if you want, but really anybody who would begin to list what is included inside this module will not really care about this _. There are several functions there already, which they are used by methods of the generic_graph file (a python file actually, though there also is a .pyx one).

Oh, and yes it's documented, like always. A patch to get the graph/ to 100% coverage was just finished, and I'm not going to spoil that by forgetting my methods `:-p`

Nathann



---

archive/issue_comments_114506.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-03-14T13:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114506",
    "user": "ylchapuy"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114507.json:
```json
{
    "body": "Ok, I have no strong feelings about this.\nI'll give this a positive review then.",
    "created_at": "2011-03-14T13:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114507",
    "user": "ylchapuy"
}
```

Ok, I have no strong feelings about this.
I'll give this a positive review then.



---

archive/issue_comments_114508.json:
```json
{
    "body": "Thank you for your help in optimizing the code :-)\n\nNathann",
    "created_at": "2011-03-14T13:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114508",
    "user": "ncohen"
}
```

Thank you for your help in optimizing the code :-)

Nathann



---

archive/issue_comments_114509.json:
```json
{
    "body": "In the commit message of [attachment:trac10855-efficiency_improvment_bug_correction.patch], the ticket number should be fixed.",
    "created_at": "2011-03-26T21:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114509",
    "user": "jdemeyer"
}
```

In the commit message of [attachment:trac10855-efficiency_improvment_bug_correction.patch], the ticket number should be fixed.



---

archive/issue_comments_114510.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-03-26T21:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114510",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_114511.json:
```json
{
    "body": "Could you update it Yann ? I can not overwrite your patch `^^;`\n\nNathann",
    "created_at": "2011-03-31T11:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114511",
    "user": "ncohen"
}
```

Could you update it Yann ? I can not overwrite your patch `^^;`

Nathann



---

archive/issue_comments_114512.json:
```json
{
    "body": "Attachment [trac10855-efficiency_improvment_bug_correction.patch](tarball://root/attachments/some-uuid/ticket10885/trac10855-efficiency_improvment_bug_correction.patch) by ylchapuy created at 2011-03-31 21:53:36\n\nthe name of the file is still wrong, but the commit message is now ok...",
    "created_at": "2011-03-31T21:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114512",
    "user": "ylchapuy"
}
```

Attachment [trac10855-efficiency_improvment_bug_correction.patch](tarball://root/attachments/some-uuid/ticket10885/trac10855-efficiency_improvment_bug_correction.patch) by ylchapuy created at 2011-03-31 21:53:36

the name of the file is still wrong, but the commit message is now ok...



---

archive/issue_comments_114513.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-03-31T21:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114513",
    "user": "ylchapuy"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_114514.json:
```json
{
    "body": "Thaaaaaaanks ! `:-)`",
    "created_at": "2011-04-01T06:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114514",
    "user": "ncohen"
}
```

Thaaaaaaanks ! `:-)`



---

archive/issue_comments_114515.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-04-01T06:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114515",
    "user": "ncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_114516.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-05T12:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10814",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10814#issuecomment-114516",
    "user": "jdemeyer"
}
```

Resolution: fixed
