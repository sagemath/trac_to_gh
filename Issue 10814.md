# Issue 10814: Floyd-Warshall algorithm in Cython

Issue created by migration from Trac.

Original creator: ncohen

Original creation time: 2011-03-07 15:01:41

Assignee: jason, ncohen, rlm

CC:  jason rlm mvngu

This patch implements a Cython version of the Floyd-Warshall algorithm currently available in Sage. Both stay implemented, as the Cython version only deals with unweighted graphs, and prefers to add integer values than Python objects anyway.

The performance improvement is obvious for the ``all_pairs_shortest_path`` method which used by default the Python implementation

```
sage: g = graphs.PetersenGraph()
sage: %timeit g.shortest_path_all_pairs()
625 loops, best of 3: 555 µs per loop
sage: %timeit g.shortest_path_all_pairs(by_weight=True)
125 loops, best of 3: 6.44 ms per loop
sage: g = graphs.Grid2dGraph(5,5)
sage: %timeit g.shortest_path_all_pairs()
125 loops, best of 3: 3.77 ms per loop
sage: %timeit g.shortest_path_all_pairs(by_weight=True)
5 loops, best of 3: 133 ms per loop
sage: g = graphs.Grid2dGraph(15,15)
sage: %timeit g.shortest_path_all_pairs()
5 loops, best of 3: 753 ms per loop
sage: %timeit g.shortest_path_all_pairs(by_weight=True)
(still running)
```

The new implementation is now the default.

Meanwhile, the method ``distance_all_pairs`` which already used Cython code is not always improved 

```
sage: g = graphs.PetersenGraph()
sage: %timeit g.distance_all_pairs()
625 loops, best of 3: 660 µs per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
625 loops, best of 3: 263 µs per loop

sage: g = graphs.Grid2dGraph(20,20)
sage: %timeit g.distance_all_pairs()
5 loops, best of 3: 951 ms per loop
sage: %timeit g.distance_all_pairs(algorithm="Floyd-Warshall")
5 loops, best of 3: 3.08 s per loop
```


Hence the default behaviour of this method does not change, the two algorithms being made available.


---

Attachment


---

Comment by ncohen created at 2011-03-07 18:45:51

Changing status from new to needs_review.


---

Comment by ncohen created at 2011-03-07 18:45:51

Passes all long tests ! `:-)`

Nathann


---

Comment by ylchapuy created at 2011-03-09 00:47:38

Changing status from needs_review to needs_work.


---

Comment by ylchapuy created at 2011-03-09 00:47:38

You can easily improve a lot the efficiency by:
  * cdefing list gverts = g.verts()
  * using g instead of gg._backend._cg
  * cdefing two dicts variables for gg._backend.vertex_ints and gg._backend.vertex_labels as well
  * in the main triple loop, cdefing two vars dv = dist[v_int] and dw = dist[w_int] as outside as possible

Also anything dealing with prec should only be done it paths=True. This can save half the memory when not needed.


---

Attachment

apply after trac_10885.patch


---

Comment by ylchapuy created at 2011-03-10 18:21:22

apply both trac_10885.patch and trac10885-efficiency_improvment.patch


---

Comment by ylchapuy created at 2011-03-10 22:12:38

I left a small bug in my last patch.
Apply in order trac_10885.patch trac10885-efficiency_improvment.patch and trac10855-efficiency_improvment_bug_correction.patch


---

Comment by ncohen created at 2011-03-11 04:51:06

Greaaaaat !! Thank you for your help ! I still have many tricks to learn `:-)`

Passes all tests, does its job even faster... Niiiiice ! 

Nathann


---

Comment by ncohen created at 2011-03-11 04:51:06

Changing status from needs_work to positive_review.


---

Comment by ylchapuy created at 2011-03-11 07:20:03

Changing status from positive_review to needs_work.


---

Comment by ylchapuy created at 2011-03-11 07:20:03

Sorry to bother you, but formally I didn't gave you a positive review.

E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?

You might also add one doctest for the ValueError and one for paths=False and distances=True.


---

Comment by ncohen created at 2011-03-11 13:35:40

Replying to [comment:8 ylchapuy]:
> Sorry to bother you, but formally I didn't gave you a positive review.

Oh. Right. My mistake.

> E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?

Well, what would it return ? There is already a shortest_path_all pairs and distance_all_pairs in the Graph method, and Floyd-Warshall is not always the fastest available.

> You might also add one doctest for the ValueError and one for paths=False and distances=True.

Done !

Nathann


---

Comment by ncohen created at 2011-03-11 13:35:40

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by ylchapuy created at 2011-03-11 18:22:13

Replying to [comment:9 ncohen]:
> Replying to [comment:8 ylchapuy]:
> > E.g is there any reason 'floyd_warshall' is a function rather than a method like 'breadth_first_search' ?
> 
> Well, what would it return ? There is already a shortest_path_all pairs and distance_all_pairs in the Graph method, and Floyd-Warshall is not always the fastest available.

I'm not sure I follow the argument: it does return something, and it's even documented... Maybe call it '_floyd_warshall' if you don't want the user to access it.

I might be wrong but it seems to me Sage convention is to prefer methods instead of functions. Jason, Robert, Minh, any preference on this matter?

> > You might also add one doctest for the ValueError and one for paths=False and distances=True.
> 
> Done !

Great, and it even removed a bug ;)

> Nathann


---

Comment by ncohen created at 2011-03-12 12:26:17

> I'm not sure I follow the argument: it does return something, and it's even documented... Maybe call it '_floyd_warshall' if you don't want the user to access it.

Well, it can be renamed to _floyd_warshall if you want, but really anybody who would begin to list what is included inside this module will not really care about this _. There are several functions there already, which they are used by methods of the generic_graph file (a python file actually, though there also is a .pyx one).

Oh, and yes it's documented, like always. A patch to get the graph/ to 100% coverage was just finished, and I'm not going to spoil that by forgetting my methods `:-p`

Nathann


---

Comment by ylchapuy created at 2011-03-14 13:07:38

Changing status from needs_review to positive_review.


---

Comment by ylchapuy created at 2011-03-14 13:07:38

Ok, I have no strong feelings about this.
I'll give this a positive review then.


---

Comment by ncohen created at 2011-03-14 13:27:13

Thank you for your help in optimizing the code :-)

Nathann


---

Comment by jdemeyer created at 2011-03-26 21:28:54

In the commit message of [attachment:trac10855-efficiency_improvment_bug_correction.patch], the ticket number should be fixed.


---

Comment by jdemeyer created at 2011-03-26 21:28:54

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2011-03-31 11:16:52

Could you update it Yann ? I can not overwrite your patch `^^;`

Nathann


---

Attachment

the name of the file is still wrong, but the commit message is now ok...


---

Comment by ylchapuy created at 2011-03-31 21:53:36

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2011-04-01 06:54:17

Thaaaaaaanks ! `:-)`


---

Comment by ncohen created at 2011-04-01 06:54:17

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-04-05 12:00:50

Resolution: fixed
