# Issue 13260: add sage.env and fix a inappropriate references to SAGE_ROOT

archive/issues_013260.json:
```json
{
    "body": "Assignee: @jasongrout\n\nCC:  @jdemeyer @kiwifb @burcin\n\nThere are many places within the Sage library that make explicit references to `SAGE_ROOT`, when `SAGE_LOCAL`, `SAGE_DATA`, etc. are more appropriate. These references assume a particular directory structure which unnecessarily break various components when using a different directory structure (i.e. transitioning to git or sage-on-gentoo). This ticket aims to correct most of these references.\n\nThis ticket also adds `sage.env` as a place to keep global used Sage variables (these currently live in `sage.misc.misc`). Currently this file does little more than separate out these variables, but the intent is to provide a dedicated place in python for determining the environment for the Sage library (this will eventually need to be independent of `sage-env` if we are ever to truly transition to argparse).\n\nIssue created by migration from https://trac.sagemath.org/ticket/13432\n\n",
    "created_at": "2012-09-06T08:57:40Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "add sage.env and fix a inappropriate references to SAGE_ROOT",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13260",
    "user": "https://github.com/ohanar"
}
```
Assignee: @jasongrout

CC:  @jdemeyer @kiwifb @burcin

There are many places within the Sage library that make explicit references to `SAGE_ROOT`, when `SAGE_LOCAL`, `SAGE_DATA`, etc. are more appropriate. These references assume a particular directory structure which unnecessarily break various components when using a different directory structure (i.e. transitioning to git or sage-on-gentoo). This ticket aims to correct most of these references.

This ticket also adds `sage.env` as a place to keep global used Sage variables (these currently live in `sage.misc.misc`). Currently this file does little more than separate out these variables, but the intent is to provide a dedicated place in python for determining the environment for the Sage library (this will eventually need to be independent of `sage-env` if we are ever to truly transition to argparse).

Issue created by migration from https://trac.sagemath.org/ticket/13432





---

archive/issue_comments_162281.json:
```json
{
    "body": "+1 to the idea.",
    "created_at": "2012-09-06T09:15:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162281",
    "user": "https://github.com/jdemeyer"
}
```

+1 to the idea.



---

archive/issue_comments_162282.json:
```json
{
    "body": "I am very supportive as well as some people would know. The main challenge is to avoid duplication with sage-env. How is the sage \"executable\" supposed to know about SAGE_ROOT/SAGE_LOCAL from the new env.py?",
    "created_at": "2012-09-06T09:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162282",
    "user": "https://github.com/kiwifb"
}
```

I am very supportive as well as some people would know. The main challenge is to avoid duplication with sage-env. How is the sage "executable" supposed to know about SAGE_ROOT/SAGE_LOCAL from the new env.py?



---

archive/issue_comments_162283.json:
```json
{
    "body": "Replying to [comment:3 fbissey]:\n> I am very supportive as well as some people would know. The main challenge is to avoid duplication with sage-env.\n\nI don't think there is duplication if `sage/env.py` simply reads the environment variables set by `sage-env`.  I see it as a library interface to the `sage-env` script.",
    "created_at": "2012-09-06T09:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162283",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 fbissey]:
> I am very supportive as well as some people would know. The main challenge is to avoid duplication with sage-env.

I don't think there is duplication if `sage/env.py` simply reads the environment variables set by `sage-env`.  I see it as a library interface to the `sage-env` script.



---

archive/issue_comments_162284.json:
```json
{
    "body": "Eventually I would like `sage.env` to be independent of `sage-env`, so that our executable can be pure python (using argparse), but that is probably in distant future :).",
    "created_at": "2012-09-06T09:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162284",
    "user": "https://github.com/ohanar"
}
```

Eventually I would like `sage.env` to be independent of `sage-env`, so that our executable can be pure python (using argparse), but that is probably in distant future :).



---

archive/issue_comments_162285.json:
```json
{
    "body": "OK I read it a bit more carefully and I see it is sourced from the environment. I guess sage in its current state can work like that without problem.\n\nAnd yes from my sage-on-gentoo point of view where sage is part of the system I would need it to be independent. There are issues in s-o-g when you import thing like sympy in python because it will pull sage if installed. If the variables are not in the environment things break in sageinspect. \n\nWe used to define SAGE variable in the global environment but that had its issue and the lmnd people (should copy burcin on this) didn't like it. At the moment I have pushed things in misc/misc.py to make things work in most cases.",
    "created_at": "2012-09-06T09:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162285",
    "user": "https://github.com/kiwifb"
}
```

OK I read it a bit more carefully and I see it is sourced from the environment. I guess sage in its current state can work like that without problem.

And yes from my sage-on-gentoo point of view where sage is part of the system I would need it to be independent. There are issues in s-o-g when you import thing like sympy in python because it will pull sage if installed. If the variables are not in the environment things break in sageinspect. 

We used to define SAGE variable in the global environment but that had its issue and the lmnd people (should copy burcin on this) didn't like it. At the moment I have pushed things in misc/misc.py to make things work in most cases.



---

archive/issue_comments_162286.json:
```json
{
    "body": "Replying to [comment:5 ohanar]:\n> Eventually I would like `sage.env` to be independent of `sage-env`, so that our executable can be pure python (using argparse), but that is probably in distant future :).\nI'm not sure whether I like that, but since it's in the distant future, I don't have to worry about it.",
    "created_at": "2012-09-06T09:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162286",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 ohanar]:
> Eventually I would like `sage.env` to be independent of `sage-env`, so that our executable can be pure python (using argparse), but that is probably in distant future :).
I'm not sure whether I like that, but since it's in the distant future, I don't have to worry about it.



---

archive/issue_comments_162287.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-03-05T06:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162287",
    "user": "https://github.com/ohanar"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_162288.json:
```json
{
    "body": "Ok, this has been fixed up and should be ready to go now.",
    "created_at": "2013-03-05T06:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162288",
    "user": "https://github.com/ohanar"
}
```

Ok, this has been fixed up and should be ready to go now.



---

archive/issue_comments_162289.json:
```json
{
    "body": "That looks so much like the mega patch that I apply to sage-on-gentoo. OK my equivalent of env.py is not nearly as sophisticated and I don't have some of these new variables. But otherwise that's scary and this will simplify my life a great deal.\n\nI am going through comparing with my own stuff.",
    "created_at": "2013-03-05T08:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162289",
    "user": "https://github.com/kiwifb"
}
```

That looks so much like the mega patch that I apply to sage-on-gentoo. OK my equivalent of env.py is not nearly as sophisticated and I don't have some of these new variables. But otherwise that's scary and this will simplify my life a great deal.

I am going through comparing with my own stuff.



---

archive/issue_comments_162290.json:
```json
{
    "body": "OK so far the main differences with my own stuff is that I have gone on a hunt on a wider ranger of variables. SAGE_ROOT is the lead bad guy but I also went for most instances of os.environ['SAGE_LOCAL'] and others that made sense to me. This ticket is just for SAGE_ROOT and that's already a big chunk.",
    "created_at": "2013-03-05T08:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162290",
    "user": "https://github.com/kiwifb"
}
```

OK so far the main differences with my own stuff is that I have gone on a hunt on a wider ranger of variables. SAGE_ROOT is the lead bad guy but I also went for most instances of os.environ['SAGE_LOCAL'] and others that made sense to me. This ticket is just for SAGE_ROOT and that's already a big chunk.



---

archive/issue_comments_162291.json:
```json
{
    "body": "`SAGE_ROOT` is the main bad guy for my purposes (which is the transition to git). I haven't completely fixed every single usage of it in the library, because some bits required a good amount of logic to rework, so if your patch has fixes for the bits that I omitted that would be appreciated.\n\nI think that a follow up ticket for the `SAGE_LOCAL` instances would be a good idea. You should check my usage's of `SAGE_SRC` and see if your patch gets away something more or less equivalent to my `SAGE_LIB` in any of those places.",
    "created_at": "2013-03-05T08:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162291",
    "user": "https://github.com/ohanar"
}
```

`SAGE_ROOT` is the main bad guy for my purposes (which is the transition to git). I haven't completely fixed every single usage of it in the library, because some bits required a good amount of logic to rework, so if your patch has fixes for the bits that I omitted that would be appreciated.

I think that a follow up ticket for the `SAGE_LOCAL` instances would be a good idea. You should check my usage's of `SAGE_SRC` and see if your patch gets away something more or less equivalent to my `SAGE_LIB` in any of those places.



---

archive/issue_comments_162292.json:
```json
{
    "body": "In one of my first attempt I ended up with an unbuildable sage :( but getting all the variables in an independent file is the big cure for that. I understand the problem with the logic. I still have one doctest failure in lazy_import_cache in sage-on-gentoo and I am not sure why.\n\nI didn't create any new variables like SAGE_SRC and SAGE_LIB, that was a lot of work as it is.\n\nI believe the other instances of SAGE_ROOT in sage/misc/cython.py can go.\n\n```\n@@ -335,10 +336,10 @@\n     Before :trac:`12975`, it would have beeen needed to write ``#clang c++``,\n     but upper case ``C++`` has resulted in an error::\n\n-        sage: from sage.all import SAGE_ROOT\n+        sage: from sage.env import SAGE_LOCAL\n         sage: code = [\n         ... \"#clang C++\",\n-        ... \"#cinclude %s/local/include/singular %s/local/include/factory\"%(SAGE_ROOT,SAGE_ROOT),\n+        ... \"#cinclude %s/include/singular %s/include/singular\"%(SAGE_LOCAL,SAGE_LOCAL),\n         ... \"#clib m readline singular givaro ntl gmpxx gmp\",\n         ... \"from sage.rings.polynomial.multi_polynomial_libsingular cimport MPolynomial_libsin$\n         ... \"from sage.libs.singular.polynomial cimport singular_polynomial_pow\",\n@@ -449,12 +450,7 @@\n import distutils.sysconfig, os, sys\n from distutils.core import setup, Extension\n\n-if not os.environ.has_key('SAGE_ROOT'):\n-    print \"    ERROR: The environment variable SAGE_ROOT must be defined.\"\n-    sys.exit(1)\n-else:\n-    SAGE_ROOT  = os.environ['SAGE_ROOT']\n-    SAGE_LOCAL = SAGE_ROOT + '/local/'\n+from sage.env import SAGE_ROOT, SAGE_LOCAL\n\n extra_link_args =  ['-L' + SAGE_LOCAL + '/lib']\n extra_compile_args = %s\n```\n\nI edited it so it is closer to your style.",
    "created_at": "2013-03-05T08:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162292",
    "user": "https://github.com/kiwifb"
}
```

In one of my first attempt I ended up with an unbuildable sage :( but getting all the variables in an independent file is the big cure for that. I understand the problem with the logic. I still have one doctest failure in lazy_import_cache in sage-on-gentoo and I am not sure why.

I didn't create any new variables like SAGE_SRC and SAGE_LIB, that was a lot of work as it is.

I believe the other instances of SAGE_ROOT in sage/misc/cython.py can go.

```
@@ -335,10 +336,10 @@
     Before :trac:`12975`, it would have beeen needed to write ``#clang c++``,
     but upper case ``C++`` has resulted in an error::

-        sage: from sage.all import SAGE_ROOT
+        sage: from sage.env import SAGE_LOCAL
         sage: code = [
         ... "#clang C++",
-        ... "#cinclude %s/local/include/singular %s/local/include/factory"%(SAGE_ROOT,SAGE_ROOT),
+        ... "#cinclude %s/include/singular %s/include/singular"%(SAGE_LOCAL,SAGE_LOCAL),
         ... "#clib m readline singular givaro ntl gmpxx gmp",
         ... "from sage.rings.polynomial.multi_polynomial_libsingular cimport MPolynomial_libsin$
         ... "from sage.libs.singular.polynomial cimport singular_polynomial_pow",
@@ -449,12 +450,7 @@
 import distutils.sysconfig, os, sys
 from distutils.core import setup, Extension

-if not os.environ.has_key('SAGE_ROOT'):
-    print "    ERROR: The environment variable SAGE_ROOT must be defined."
-    sys.exit(1)
-else:
-    SAGE_ROOT  = os.environ['SAGE_ROOT']
-    SAGE_LOCAL = SAGE_ROOT + '/local/'
+from sage.env import SAGE_ROOT, SAGE_LOCAL

 extra_link_args =  ['-L' + SAGE_LOCAL + '/lib']
 extra_compile_args = %s
```

I edited it so it is closer to your style.



---

archive/issue_comments_162293.json:
```json
{
    "body": "sage/sandpiles/sandpile.py you have \n\n```\nSAGE_ROOT = os.environ['SAGE_ROOT'] \npath_to_zsolve = SAGE_ROOT+'/local/bin/' \n```\n\nbecoming \n\n```\npath_to_zsolve = os.path.join(SAGE_LOCAL,'bin','zsolve')\n```\n\nIs it correcting a bug as well?",
    "created_at": "2013-03-05T08:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162293",
    "user": "https://github.com/kiwifb"
}
```

sage/sandpiles/sandpile.py you have 

```
SAGE_ROOT = os.environ['SAGE_ROOT'] 
path_to_zsolve = SAGE_ROOT+'/local/bin/' 
```

becoming 

```
path_to_zsolve = os.path.join(SAGE_LOCAL,'bin','zsolve')
```

Is it correcting a bug as well?



---

archive/issue_comments_162294.json:
```json
{
    "body": "Replying to [comment:17 fbissey]:\n> sage/sandpiles/sandpile.py you have \n> {{{\n> SAGE_ROOT = os.environ['SAGE_ROOT'] \n> path_to_zsolve = SAGE_ROOT+'/local/bin/' \n> }}}\n> becoming \n> {{{\n> path_to_zsolve = os.path.join(SAGE_LOCAL,'bin','zsolve')\n> }}}\n> Is it correcting a bug as well?\n\nNo, if you look a little further down, I change a `path_to_zsolve+'zsolve'` to just `path_to_zsolve` -- this is a little cleaner, and it removes the string arithmetic that should be `os.path.join`'s.",
    "created_at": "2013-03-05T08:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162294",
    "user": "https://github.com/ohanar"
}
```

Replying to [comment:17 fbissey]:
> sage/sandpiles/sandpile.py you have 
> {{{
> SAGE_ROOT = os.environ['SAGE_ROOT'] 
> path_to_zsolve = SAGE_ROOT+'/local/bin/' 
> }}}
> becoming 
> {{{
> path_to_zsolve = os.path.join(SAGE_LOCAL,'bin','zsolve')
> }}}
> Is it correcting a bug as well?

No, if you look a little further down, I change a `path_to_zsolve+'zsolve'` to just `path_to_zsolve` -- this is a little cleaner, and it removes the string arithmetic that should be `os.path.join`'s.



---

archive/issue_comments_162295.json:
```json
{
    "body": "Replying to [comment:18 ohanar]:\n> Replying to [comment:17 fbissey]:\n> > sage/sandpiles/sandpile.py you have \n> > {{{\n> > SAGE_ROOT = os.environ['SAGE_ROOT'] \n> > path_to_zsolve = SAGE_ROOT+'/local/bin/' \n> > }}}\n> > becoming \n> > {{{\n> > path_to_zsolve = os.path.join(SAGE_LOCAL,'bin','zsolve')\n> > }}}\n> > Is it correcting a bug as well?\n> \n> No, if you look a little further down, I change a `path_to_zsolve+'zsolve'` to just `path_to_zsolve` -- this is a little cleaner, and it removes the string arithmetic that should be `os.path.join`'s.\n\n\nI missed that line.\n\nIs the replacement of SAGE_INC in setup.py (well spotted the one where it is still SAGE_LOCAL/include) by CPATH really necessary? That's the only place CPATH is used and you don't use it in module_list.py anyway.\n\nApart from this I am positive that it should go in while it is easy to apply. We may do some more work on this later.",
    "created_at": "2013-03-05T09:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162295",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:18 ohanar]:
> Replying to [comment:17 fbissey]:
> > sage/sandpiles/sandpile.py you have 
> > {{{
> > SAGE_ROOT = os.environ['SAGE_ROOT'] 
> > path_to_zsolve = SAGE_ROOT+'/local/bin/' 
> > }}}
> > becoming 
> > {{{
> > path_to_zsolve = os.path.join(SAGE_LOCAL,'bin','zsolve')
> > }}}
> > Is it correcting a bug as well?
> 
> No, if you look a little further down, I change a `path_to_zsolve+'zsolve'` to just `path_to_zsolve` -- this is a little cleaner, and it removes the string arithmetic that should be `os.path.join`'s.


I missed that line.

Is the replacement of SAGE_INC in setup.py (well spotted the one where it is still SAGE_LOCAL/include) by CPATH really necessary? That's the only place CPATH is used and you don't use it in module_list.py anyway.

Apart from this I am positive that it should go in while it is easy to apply. We may do some more work on this later.



---

archive/issue_comments_162296.json:
```json
{
    "body": "Don't use `CPATH` the way you are using it. Invent a new variable `SAGE_INCLUDE` or whatever.\n\n`CPATH` is a colon-separated list of directories searched by GCC for include files.",
    "created_at": "2013-03-05T09:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162296",
    "user": "https://github.com/jdemeyer"
}
```

Don't use `CPATH` the way you are using it. Invent a new variable `SAGE_INCLUDE` or whatever.

`CPATH` is a colon-separated list of directories searched by GCC for include files.



---

archive/issue_comments_162297.json:
```json
{
    "body": "I think CPATH (and its idea) should be dropped from sage.env altogether and setup.py only be touched to normalize its use of SAGE_INC.",
    "created_at": "2013-03-05T09:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162297",
    "user": "https://github.com/kiwifb"
}
```

I think CPATH (and its idea) should be dropped from sage.env altogether and setup.py only be touched to normalize its use of SAGE_INC.



---

archive/issue_comments_162298.json:
```json
{
    "body": "Replying to [comment:21 fbissey]:\n> I think CPATH (and its idea) should be dropped from sage.env altogether.\nYes exactly.",
    "created_at": "2013-03-05T09:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162298",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:21 fbissey]:
> I think CPATH (and its idea) should be dropped from sage.env altogether.
Yes exactly.



---

archive/issue_comments_162299.json:
```json
{
    "body": "Ok, updated the patch. Added the fix for `cython.py` suggested and reverted `CPATH` to `SAGE_INC` and it is no longer defined in `env.py`. I also modified `module_list.py` to use the new module as well.",
    "created_at": "2013-03-05T10:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162299",
    "user": "https://github.com/ohanar"
}
```

Ok, updated the patch. Added the fix for `cython.py` suggested and reverted `CPATH` to `SAGE_INC` and it is no longer defined in `env.py`. I also modified `module_list.py` to use the new module as well.



---

archive/issue_comments_162300.json:
```json
{
    "body": "Thank you for the new patch. I will still whine a bit about setup.py. In the definition of \"include_dirs\" on line 54 (after patch) you didn't put SAGE_INC itself. I think the list should be\n\n```\ninclude_dirs = [SAGE_INC,\n                os.path.join(SAGE_INC, 'csage'), \n \t              os.path.join(SAGE_SRC, 'sage', 'ext')]\n```\n\nI don't think we can count on CPATH being defined and providing SAGE_INC in all cases so I think it needs to be included here.",
    "created_at": "2013-03-06T09:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162300",
    "user": "https://github.com/kiwifb"
}
```

Thank you for the new patch. I will still whine a bit about setup.py. In the definition of "include_dirs" on line 54 (after patch) you didn't put SAGE_INC itself. I think the list should be

```
include_dirs = [SAGE_INC,
                os.path.join(SAGE_INC, 'csage'), 
 	              os.path.join(SAGE_SRC, 'sage', 'ext')]
```

I don't think we can count on CPATH being defined and providing SAGE_INC in all cases so I think it needs to be included here.



---

archive/issue_comments_162301.json:
```json
{
    "body": "Replying to [comment:25 fbissey]:\n> I don't think we can count on CPATH being defined and providing SAGE_INC in all cases so I think it needs to be included here.\n\nI thought the point of #13348 was so that we didn't have to add `SAGE_LOCAL/include` to spkgs anymore. Truthfully, I would also like to replace `os.path.join(SAGE_INC, 'csage')` with `os.path.join(SAGE_SRC, 'c_lib', 'include')`, since in some distant future, I would like the sage python library, c library, extcode, and scripts to be a single \"sage\" package (but obviously this conflicts with both the setup of sage and sage-on-gentoo presently).",
    "created_at": "2013-03-06T21:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162301",
    "user": "https://github.com/ohanar"
}
```

Replying to [comment:25 fbissey]:
> I don't think we can count on CPATH being defined and providing SAGE_INC in all cases so I think it needs to be included here.

I thought the point of #13348 was so that we didn't have to add `SAGE_LOCAL/include` to spkgs anymore. Truthfully, I would also like to replace `os.path.join(SAGE_INC, 'csage')` with `os.path.join(SAGE_SRC, 'c_lib', 'include')`, since in some distant future, I would like the sage python library, c library, extcode, and scripts to be a single "sage" package (but obviously this conflicts with both the setup of sage and sage-on-gentoo presently).



---

archive/issue_comments_162302.json:
```json
{
    "body": "And truthfully I would like the c_lib to be handled differently, not completely sure how but differently. I was concerned that not putting SAGE_INC would break some upgrades. But upgrade from very old versions of sage is not recommended or guaranteed to work in any case. CPATH has been included in sage 5.4 that should be old enough.\n\nPositive review then.",
    "created_at": "2013-03-06T21:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162302",
    "user": "https://github.com/kiwifb"
}
```

And truthfully I would like the c_lib to be handled differently, not completely sure how but differently. I was concerned that not putting SAGE_INC would break some upgrades. But upgrade from very old versions of sage is not recommended or guaranteed to work in any case. CPATH has been included in sage 5.4 that should be old enough.

Positive review then.



---

archive/issue_comments_162303.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-03-06T21:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162303",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_162304.json:
```json
{
    "body": "apply to root repository",
    "created_at": "2013-03-06T23:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162304",
    "user": "https://github.com/ohanar"
}
```

apply to root repository



---

archive/issue_comments_162305.json:
```json
{
    "body": "Attachment [trac13432_root.patch](tarball://root/attachments/some-uuid/ticket13432/trac13432_root.patch) by @ohanar created at 2013-03-06 23:07:41\n\nReplying to [comment:27 fbissey]:\n> I was concerned that not putting SAGE_INC would break some upgrades.\n\nGood point, I think Jeroen tries to make sure that all versions back to 4.8 can still upgrade. This should still work even for those versions since the sage library implicitly depends on SAGE_ROOT_REPO, but just to be sure, I've added a tiny patch to the root repository to make this dependency explicit.",
    "created_at": "2013-03-06T23:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162305",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac13432_root.patch](tarball://root/attachments/some-uuid/ticket13432/trac13432_root.patch) by @ohanar created at 2013-03-06 23:07:41

Replying to [comment:27 fbissey]:
> I was concerned that not putting SAGE_INC would break some upgrades.

Good point, I think Jeroen tries to make sure that all versions back to 4.8 can still upgrade. This should still work even for those versions since the sage library implicitly depends on SAGE_ROOT_REPO, but just to be sure, I've added a tiny patch to the root repository to make this dependency explicit.



---

archive/issue_comments_162306.json:
```json
{
    "body": "I test upgrades starting from sage-4.5 (older versions don't work because they lack the `pipestatus` script).",
    "created_at": "2013-03-07T07:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162306",
    "user": "https://github.com/jdemeyer"
}
```

I test upgrades starting from sage-4.5 (older versions don't work because they lack the `pipestatus` script).



---

archive/issue_comments_162307.json:
```json
{
    "body": "In `sage/interfaces/expect.py`, this usage of `DOT_SAGE` needs to be fixed:\n\n```\n        #If the 'SAGE_PEXPECT_LOG' environment variable is set and\n        #the current logfile is None, then set the logfile to be one\n        #in .sage/pexpect_logs/\n        if self.__logfile is None and 'SAGE_PEXPECT_LOG' in os.environ:\n            from sage.misc.all import DOT_SAGE\n            logs = '%s/pexpect_logs'%DOT_SAGE\n            sage_makedirs(logs)\n\n            filename = '%s/%s-%s-%s-%s.log'%(logs, self.name(), os.getpid(), id(self), self._session_number)\n            self.__logfile = open(filename, 'w')\n```\n",
    "created_at": "2013-03-07T10:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162307",
    "user": "https://github.com/jdemeyer"
}
```

In `sage/interfaces/expect.py`, this usage of `DOT_SAGE` needs to be fixed:

```
        #If the 'SAGE_PEXPECT_LOG' environment variable is set and
        #the current logfile is None, then set the logfile to be one
        #in .sage/pexpect_logs/
        if self.__logfile is None and 'SAGE_PEXPECT_LOG' in os.environ:
            from sage.misc.all import DOT_SAGE
            logs = '%s/pexpect_logs'%DOT_SAGE
            sage_makedirs(logs)

            filename = '%s/%s-%s-%s-%s.log'%(logs, self.name(), os.getpid(), id(self), self._session_number)
            self.__logfile = open(filename, 'w')
```




---

archive/issue_comments_162308.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-03-07T10:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162308",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_162309.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> In `sage/interfaces/expect.py`, this usage of `DOT_SAGE` needs to be fixed:\n> {{{\n>         #If the 'SAGE_PEXPECT_LOG' environment variable is set and\n>         #the current logfile is None, then set the logfile to be one\n>         #in .sage/pexpect_logs/\n>         if self.__logfile is None and 'SAGE_PEXPECT_LOG' in os.environ:\n>             from sage.misc.all import DOT_SAGE\n>             logs = '%s/pexpect_logs'%DOT_SAGE\n>             sage_makedirs(logs)\n> \n>             filename = '%s/%s-%s-%s-%s.log'%(logs, self.name(), os.getpid(), id(self), self._session_number)\n>             self.__logfile = open(filename, 'w')\n> }}}\n\nThat shouldn't be necessary to build or run sage and is covered by backward compatibility in sage/misc/misc.py but OK will fix it.",
    "created_at": "2013-03-07T19:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162309",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:30 jdemeyer]:
> In `sage/interfaces/expect.py`, this usage of `DOT_SAGE` needs to be fixed:
> {{{
>         #If the 'SAGE_PEXPECT_LOG' environment variable is set and
>         #the current logfile is None, then set the logfile to be one
>         #in .sage/pexpect_logs/
>         if self.__logfile is None and 'SAGE_PEXPECT_LOG' in os.environ:
>             from sage.misc.all import DOT_SAGE
>             logs = '%s/pexpect_logs'%DOT_SAGE
>             sage_makedirs(logs)
> 
>             filename = '%s/%s-%s-%s-%s.log'%(logs, self.name(), os.getpid(), id(self), self._session_number)
>             self.__logfile = open(filename, 'w')
> }}}

That shouldn't be necessary to build or run sage and is covered by backward compatibility in sage/misc/misc.py but OK will fix it.



---

archive/issue_comments_162310.json:
```json
{
    "body": "Actually why this particular file even after the big patch there are several instances of sage variables imported from misc/misc.py. Do you want them all switched to env.py?",
    "created_at": "2013-03-07T20:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162310",
    "user": "https://github.com/kiwifb"
}
```

Actually why this particular file even after the big patch there are several instances of sage variables imported from misc/misc.py. Do you want them all switched to env.py?



---

archive/issue_comments_162311.json:
```json
{
    "body": "Replying to [comment:31 fbissey]:\n> That shouldn't be necessary to build or run sage and is covered by backward compatibility in sage/misc/misc.py\nNo, it's not covered since this one imports from sage.misc.**all**. And yes, it leads to failures (in an unrelated doctest in #12415).",
    "created_at": "2013-03-07T22:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162311",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:31 fbissey]:
> That shouldn't be necessary to build or run sage and is covered by backward compatibility in sage/misc/misc.py
No, it's not covered since this one imports from sage.misc.**all**. And yes, it leads to failures (in an unrelated doctest in #12415).



---

archive/issue_comments_162312.json:
```json
{
    "body": "Ha. I missed that. In my version of this for sage-on-gentoo I made sage.misc.all backward compatible, ohanar didn't. I will check what other places rely on misc.all.",
    "created_at": "2013-03-07T22:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162312",
    "user": "https://github.com/kiwifb"
}
```

Ha. I missed that. In my version of this for sage-on-gentoo I made sage.misc.all backward compatible, ohanar didn't. I will check what other places rely on misc.all.



---

archive/issue_comments_162313.json:
```json
{
    "body": "Attachment [trac_13432-fix_expect.patch](tarball://root/attachments/some-uuid/ticket13432/trac_13432-fix_expect.patch) by @kiwifb created at 2013-03-07 22:26:13\n\nFix DOT_SAGE in expect.py",
    "created_at": "2013-03-07T22:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162313",
    "user": "https://github.com/kiwifb"
}
```

Attachment [trac_13432-fix_expect.patch](tarball://root/attachments/some-uuid/ticket13432/trac_13432-fix_expect.patch) by @kiwifb created at 2013-03-07 22:26:13

Fix DOT_SAGE in expect.py



---

archive/issue_comments_162314.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-07T22:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162314",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_162315.json:
```json
{
    "body": "That was the last spot. I added a trivial patch to take care of it.",
    "created_at": "2013-03-07T22:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162315",
    "user": "https://github.com/kiwifb"
}
```

That was the last spot. I added a trivial patch to take care of it.



---

archive/issue_comments_162316.json:
```json
{
    "body": "Changing keywords from \"\" to \"build warnings\".",
    "created_at": "2013-03-08T22:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162316",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "build warnings".



---

archive/issue_comments_162317.json:
```json
{
    "body": "When building Sage, there are lots of warnings of the form\n\n```\n  warnings.warn(msg+' I will assume it is a system C/C++ header.')\nsetup.py:637: UserWarning: could not find dependency linbox/algorithms/echelon-form.h included in sage/libs/linbox/echelonform.pxd. I will assume it is a system C/C++ header.\n```\n\nThis is a problem, those headers are **not** system headers, which might break dependency checking.",
    "created_at": "2013-03-08T22:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162317",
    "user": "https://github.com/jdemeyer"
}
```

When building Sage, there are lots of warnings of the form

```
  warnings.warn(msg+' I will assume it is a system C/C++ header.')
setup.py:637: UserWarning: could not find dependency linbox/algorithms/echelon-form.h included in sage/libs/linbox/echelonform.pxd. I will assume it is a system C/C++ header.
```

This is a problem, those headers are **not** system headers, which might break dependency checking.



---

archive/issue_comments_162318.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-08T22:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162318",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_162319.json:
```json
{
    "body": "#13031 would resolve this issue.",
    "created_at": "2013-03-08T23:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162319",
    "user": "https://github.com/ohanar"
}
```

#13031 would resolve this issue.



---

archive/issue_comments_162320.json:
```json
{
    "body": "While that ticket may really fix the problem, now I wish I hadn't said yes to your removal of SAGE_INC on the basis of CPATH. It obviously doesn't work here.\n\nAdmittely that probably means there is a bug somewhere as you would expect it to work.",
    "created_at": "2013-03-09T08:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162320",
    "user": "https://github.com/kiwifb"
}
```

While that ticket may really fix the problem, now I wish I hadn't said yes to your removal of SAGE_INC on the basis of CPATH. It obviously doesn't work here.

Admittely that probably means there is a bug somewhere as you would expect it to work.



---

archive/issue_comments_162321.json:
```json
{
    "body": "Attachment [trac13432.patch](tarball://root/attachments/some-uuid/ticket13432/trac13432.patch) by @ohanar created at 2013-03-10 01:39:53\n\napply to sage library",
    "created_at": "2013-03-10T01:39:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162321",
    "user": "https://github.com/ohanar"
}
```

Attachment [trac13432.patch](tarball://root/attachments/some-uuid/ticket13432/trac13432.patch) by @ohanar created at 2013-03-10 01:39:53

apply to sage library



---

archive/issue_comments_162322.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-10T03:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162322",
    "user": "https://github.com/ohanar"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_162323.json:
```json
{
    "body": "Ok, threw `SAGE_INC` back in, so those errors don't come up anymore.",
    "created_at": "2013-03-10T03:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162323",
    "user": "https://github.com/ohanar"
}
```

Ok, threw `SAGE_INC` back in, so those errors don't come up anymore.



---

archive/issue_comments_162324.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-03-10T03:16:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162324",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_162325.json:
```json
{
    "body": "Thanks. I don't think that's essential to your git migration. More a question of minimal\"beauty\". We can always remove it with #13031 if it really negates the need for it.",
    "created_at": "2013-03-10T03:16:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162325",
    "user": "https://github.com/kiwifb"
}
```

Thanks. I don't think that's essential to your git migration. More a question of minimal"beauty". We can always remove it with #13031 if it really negates the need for it.



---

archive/issue_comments_162326.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-03-13T11:05:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162326",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_013164.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-13T11:05:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13260#event-13164"
}
```



---

archive/issue_comments_162327.json:
```json
{
    "body": "If you want people to use these variables \"correctly\", you'd better document them somewhere. I hope you're working on a follow-up ticket for this...",
    "created_at": "2013-03-20T01:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162327",
    "user": "https://github.com/jhpalmieri"
}
```

If you want people to use these variables "correctly", you'd better document them somewhere. I hope you're working on a follow-up ticket for this...



---

archive/issue_comments_162328.json:
```json
{
    "body": "I made a ticket for documenting development environment variables at #14262 -- I probably won't get around to it for another week/week and a half, as I'm mainly prepping for Sage Days 47 (and then might not get a chance to work on it at the Sage Days).",
    "created_at": "2013-03-20T01:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162328",
    "user": "https://github.com/ohanar"
}
```

I made a ticket for documenting development environment variables at #14262 -- I probably won't get around to it for another week/week and a half, as I'm mainly prepping for Sage Days 47 (and then might not get a chance to work on it at the Sage Days).



---

archive/issue_comments_162329.json:
```json
{
    "body": "Related: #15005.",
    "created_at": "2013-09-23T14:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162329",
    "user": "https://github.com/mezzarobba"
}
```

Related: #15005.



---

archive/issue_comments_162330.json:
```json
{
    "body": "Sorry to revive an old ticket, but the people involved here might be able to answer the best: what is the rationale behind the variable substitution used in `sage/env.py`? That is, what is the advantage to doing the string substitution `\"$SAGE_LOCAL\" --> SAGE_ENV['SAGE_LOCAL']`, rather than just using the (already defined) variable `SAGE_LOCAL`? Using an example from the file, why use\n\n```\n_add_variable_or_fallback('SAGE_ETC',        opj('$SAGE_LOCAL', 'etc'))\n```\n\ninstead of\n\n```\n_add_variable_or_fallback('SAGE_ETC',        opj(SAGE_LOCAL, 'etc'))\n```\n\n\nI am asking because there is a bug in the variable substitution (which I attempted to address in #23758): the variable substitution is done by iterating over `SAGE_ENV.items()`, which I think has no well-defined order, yet the order in which the substitution is done can matter, for example if you have variables `SAGE_LOCAL` and `SAGE_LOCAL_OTHER`, \"$SAGE_LOCAL_OTHER\" matches both as a string. In #23762, the possibility has been raised of removing the variable substitution altogether, so I want to know what we would be losing if we do this.",
    "created_at": "2017-08-31T22:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13260",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13260#issuecomment-162330",
    "user": "https://github.com/jhpalmieri"
}
```

Sorry to revive an old ticket, but the people involved here might be able to answer the best: what is the rationale behind the variable substitution used in `sage/env.py`? That is, what is the advantage to doing the string substitution `"$SAGE_LOCAL" --> SAGE_ENV['SAGE_LOCAL']`, rather than just using the (already defined) variable `SAGE_LOCAL`? Using an example from the file, why use

```
_add_variable_or_fallback('SAGE_ETC',        opj('$SAGE_LOCAL', 'etc'))
```

instead of

```
_add_variable_or_fallback('SAGE_ETC',        opj(SAGE_LOCAL, 'etc'))
```


I am asking because there is a bug in the variable substitution (which I attempted to address in #23758): the variable substitution is done by iterating over `SAGE_ENV.items()`, which I think has no well-defined order, yet the order in which the substitution is done can matter, for example if you have variables `SAGE_LOCAL` and `SAGE_LOCAL_OTHER`, "$SAGE_LOCAL_OTHER" matches both as a string. In #23762, the possibility has been raised of removing the variable substitution altogether, so I want to know what we would be losing if we do this.
