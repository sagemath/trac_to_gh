# Issue 11532: Resolve symbolic links in $HOME/.sage

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2011-08-18 19:20:40

CC:  leif

Similarly to `SAGE_ROOT`, it might be good to resolve symbolic links in `$HOME/.sage` when assigning `DOT_SAGE`.  This can be useful for example when `$HOME/.sage` is a symbolic link to a non-existent directory (the directory would be created later in `sage-sage`).


---

Comment by jdemeyer created at 2011-08-18 19:25:58

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-08-18 19:30:39

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-08-23 13:15:33

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-11-17 23:07:30

Note also #11924: currently if `DOTSAGE` doesn't end with a slash, then there are unintended consequences.  (#11924 should be an easy review.)


---

Comment by jhpalmieri created at 2011-12-19 21:42:22

I wonder if we should put the `resolvelinks` script in a separate file in the root repo, and then call it from the top-level sage script (as in #5852) or from sage-env (for this ticket).  As such, this seems related to #11073.


---

Comment by jdemeyer created at 2011-12-19 21:52:55

Replying to [comment:11 jhpalmieri]:
> I wonder if we should put the `resolvelinks` script in a separate file in the root repo, and then call it from the top-level sage script (as in #5852) or from sage-env (for this ticket).

We _cannot_ put it in a seperate file because `$SAGE_ROOT/sage` would need to know `SAGE_ROOT` in order to find this new separate file.  So, in any case, `$SAGE_ROOT/sage` needs the `resolvelinks` script.  So, we would have to source `$SAGE_ROOT/sage` from `sage-env` which doesn't sound like a very good idea (it _could_ be done though).


---

Comment by jhpalmieri created at 2011-12-20 00:59:58

Well, what's the purpose of canonicalizing SAGE_ROOT in the `sage` script?  It seems useful to have canonical names for paths, and it's important for some doctests (etc.), but do we actually need to do this for the script to function properly right at the start?  If not, we could detect a preliminary value for `SAGE_ROOT` first, find the `resolvelinks` script, run it if it exists (e.g., check after seeing if `sage-sage` exists and before exporting `SAGE_ROOT`), and then find and export the permanent value for `SAGE_ROOT`.


---

Comment by jdemeyer created at 2011-12-21 10:36:52

Replying to [comment:13 jhpalmieri]:
> Well, what's the purpose of canonicalizing SAGE_ROOT in the `sage` script?

It's precisely for the reason I said: we need to be able to determine a usable value of `$SAGE_ROOT` before we can do _anything_ with Sage.

It's true that it doesn't matter that it's canonical, but we still need to dereference symbolic links in `$0` (the script filename) to find `$SAGE_ROOT`.  Since #5852, we support an installation where somebody makes a symbolic link from `/usr/local/bin/sage` to `/usr/local/sage/sage-4.8/sage` or whatever.

I agree the code duplication is not so nice, but I still think the patch can be reviewed as-is.


---

Comment by jhpalmieri created at 2011-12-21 17:20:12

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-12-22 12:53:32

Amazing, this causes

```
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha4-remove-base/devel/sage-main/sage/schemes/elliptic_curves/ell_rational_field.py", line 526:
    sage: E.conductor(algorithm="gp")
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha4-remove-base/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha4-remove-base/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha4-remove-base/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_12[5]>", line 1, in <module>
        E.conductor(algorithm="gp")###line 526:
    sage: E.conductor(algorithm="gp")
      File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha4-remove-base/local/lib/python/site-packages/sage/schemes/elliptic_curves/ell_rational_field.py", line 552, in conductor
        self.__conductor_gp = Integer(gp.eval('ellglobalred(ellinit(%s,0))[1]'%list(self.a_invariants())))
      File "integer.pyx", line 681, in sage.rings.integer.Integer.__init__ (sage/rings/integer.c:6786)
    TypeError: unable to convert x (=read("/mnt/usb1/scratch/jdemeyer/merger/sage-4.8.alpha4-remove-base/home/.sage/temp/sage.math.washington.edu/9425//interface//tmp11939") ) to an integer
**********************************************************************
```



---

Comment by jdemeyer created at 2011-12-22 12:53:32

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-12-22 13:29:05

I keep positive review here, the latter problem is now #12221.


---

Comment by jdemeyer created at 2011-12-22 13:29:05

Changing status from needs_work to positive_review.


---

Attachment

Patch to the SCRIPTS repository (local/bin)


---

Comment by jdemeyer created at 2011-12-24 01:48:34

I changed the patch slightly to add the slash after $DOT_SAGE.  I don't see how this could cause #12221, but it seems safer to keep the slash, just like it was before.  Needs review please.


---

Comment by jdemeyer created at 2011-12-24 01:48:34

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-12-24 01:48:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-12-26 11:37:12

John, can you please review this new revised patch?


---

Comment by jhpalmieri created at 2011-12-27 19:48:35

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2011-12-27 19:48:35

The only real change is to append the slash, right?  It works for me in my testing.


---

Comment by jdemeyer created at 2011-12-29 07:03:06

Resolution: fixed
