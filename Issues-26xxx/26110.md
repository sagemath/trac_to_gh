# Issue 26110: Tests marked "optional - dochtml" are not run by default

archive/issues_025873.json:
```json
{
    "body": "According to #25345, tests marked `optional - dochtml` are supposed to be run by default, but they are not, at least not for me. When I run doctests, I see\n\n```\nUsing --optional=coxeter3,mpir,python2,sage\n```\nNote that `dochtml` is missing. As an experiment, I added\n\n```\n    sage: 1 + 1 == 3 # optional -- dochtml\n    True\n```\nto a file, and when I ran `sage -t ...` on that file, tests passed. (Tests failed if I included the `--optional=dochtml` flag.)\n\nMarked as a blocker because as things stand, we are skipping tests that we should not be skipping, and that we were not skipping before #25345.\n\nCC:  @jdemeyer\n\nBranch/Commit: 6a5090389bde02be3498fb05e9b18834de8eac52\n\nReviewer: John Palmieri\n\nAuthor: Jeroen Demeyer\n\nDependencies: #26184\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26110\n\n",
    "closed_at": "2018-09-06T07:11:48Z",
    "created_at": "2018-08-22T20:04:47Z",
    "labels": [
        "component: doctest framework",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Tests marked \"optional - dochtml\" are not run by default",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26110",
    "user": "https://github.com/jhpalmieri"
}
```
According to #25345, tests marked `optional - dochtml` are supposed to be run by default, but they are not, at least not for me. When I run doctests, I see

```
Using --optional=coxeter3,mpir,python2,sage
```
Note that `dochtml` is missing. As an experiment, I added

```
    sage: 1 + 1 == 3 # optional -- dochtml
    True
```
to a file, and when I ran `sage -t ...` on that file, tests passed. (Tests failed if I included the `--optional=dochtml` flag.)

Marked as a blocker because as things stand, we are skipping tests that we should not be skipping, and that we were not skipping before #25345.

CC:  @jdemeyer

Branch/Commit: 6a5090389bde02be3498fb05e9b18834de8eac52

Reviewer: John Palmieri

Author: Jeroen Demeyer

Dependencies: #26184

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26110





---

archive/issue_comments_501779.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/run-dochtml-tests-by-default\"",
    "created_at": "2018-08-22T20:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501779",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/run-dochtml-tests-by-default"



---

archive/issue_comments_501780.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-22T20:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501780",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_501781.json:
```json
{
    "body": "Changing author from \"\" to \"John Palmieri\"",
    "created_at": "2018-08-22T20:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501781",
    "user": "https://github.com/jhpalmieri"
}
```

Changing author from "" to "John Palmieri"



---

archive/issue_comments_501782.json:
```json
{
    "body": "Changing commit from \"\" to \"8cff1a67231a1ac604d9daa5637793b0fd406f17\"",
    "created_at": "2018-08-22T20:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501782",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "8cff1a67231a1ac604d9daa5637793b0fd406f17"



---

archive/issue_comments_501783.json:
```json
{
    "body": "<a id='comment:2'></a>I think this will take care of it, but someone who knows the doctesting framework should review this (and #25345) carefully.\n\n---\nNew commits:",
    "created_at": "2018-08-22T20:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501783",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>I think this will take care of it, but someone who knows the doctesting framework should review this (and #25345) carefully.

---
New commits:



---

archive/issue_comments_501784.json:
```json
{
    "body": "<a id='comment:3'></a>I think this was added just recently, and the intent was explicitly to *not* require these tests by default.\n\nI argued at the time that maybe it should be enabled by default, but only if `SAGE_DOC` can be found.",
    "created_at": "2018-08-22T20:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501784",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>I think this was added just recently, and the intent was explicitly to *not* require these tests by default.

I argued at the time that maybe it should be enabled by default, but only if `SAGE_DOC` can be found.



---

archive/issue_comments_501785.json:
```json
{
    "body": "<a id='comment:4'></a>Recent, yes: merged in 8.4.beta1. But the intention was to keep testing by default:\n\n- From the description at #25345: \"This patch makes the doctests that depend on the htmldocs optional, but enables those doctests by default.\" \n- From [comment 23 there](https://trac.sagemath.org/ticket/25345#comment:23): \"This change does not disable documentation in any way. It is still enabled by default and tested by default.\"\n\nThere would have been serious objections by me and by Jeroen (see [his comment 24](https://trac.sagemath.org/ticket/25345#comment:24)) to that ticket if it changed the default testing behavior.",
    "created_at": "2018-08-22T21:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501785",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>Recent, yes: merged in 8.4.beta1. But the intention was to keep testing by default:

- From the description at #25345: "This patch makes the doctests that depend on the htmldocs optional, but enables those doctests by default." 
- From [comment 23 there](https://trac.sagemath.org/ticket/25345#comment:23): "This change does not disable documentation in any way. It is still enabled by default and tested by default."

There would have been serious objections by me and by Jeroen (see [his comment 24](https://trac.sagemath.org/ticket/25345#comment:24)) to that ticket if it changed the default testing behavior.



---

archive/issue_comments_501786.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-22T22:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501786",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_501787.json:
```json
{
    "body": "Changing commit from \"8cff1a67231a1ac604d9daa5637793b0fd406f17\" to \"78b3df8b94cd36d2e907bb00b3d467c9bc2bd1d5\"",
    "created_at": "2018-08-22T22:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501787",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8cff1a67231a1ac604d9daa5637793b0fd406f17" to "78b3df8b94cd36d2e907bb00b3d467c9bc2bd1d5"



---

archive/issue_comments_501788.json:
```json
{
    "body": "<a id='comment:7'></a>I'm sorry but I don't like this solution. The duplication between `sage-runtests` script and the doctest framework is bad: it violates \"Don't Repeat Yourself (DRY)\" leading to errors such as this ticket.",
    "created_at": "2018-08-23T09:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501788",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>I'm sorry but I don't like this solution. The duplication between `sage-runtests` script and the doctest framework is bad: it violates "Don't Repeat Yourself (DRY)" leading to errors such as this ticket.



---

archive/issue_comments_501789.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/run-dochtml-tests-by-default\" to \"u/jdemeyer/run-dochtml-tests-by-default\"",
    "created_at": "2018-08-23T09:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501789",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "u/jhpalmieri/run-dochtml-tests-by-default" to "u/jdemeyer/run-dochtml-tests-by-default"



---

archive/issue_comments_501790.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-23T09:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501790",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_501791.json:
```json
{
    "body": "Changing commit from \"78b3df8b94cd36d2e907bb00b3d467c9bc2bd1d5\" to \"d6d4f0643130d054edd8265bd724207a3b1cce61\"",
    "created_at": "2018-08-23T09:27:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501791",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "78b3df8b94cd36d2e907bb00b3d467c9bc2bd1d5" to "d6d4f0643130d054edd8265bd724207a3b1cce61"



---

archive/issue_comments_501792.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2018-08-23T09:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501792",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_501793.json:
```json
{
    "body": "<a id='comment:11'></a>\n```diff\ndiff --git a/Makefile b/Makefile\nindex d81d450..1f83cbb 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -111,43 +111,46 @@ micro_release: bdist-clean sagelib-clean\n TESTALL = ./sage -t --all\n PTESTALL = ./sage -t -p --all\n \n+# Flags for ./sage -t --all:\n+OPTIONAL_AND_EXTERNAL = --optional=sage,dochtml,optional,external\n+\n```\n\nWhy is this called something so specific as \"OPTIONAL_AND_EXTERNAL\" and not just \"TESTALL_FLAGS\" or something?",
    "created_at": "2018-08-23T12:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501793",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>
```diff
diff --git a/Makefile b/Makefile
index d81d450..1f83cbb 100644
--- a/Makefile
+++ b/Makefile
@@ -111,43 +111,46 @@ micro_release: bdist-clean sagelib-clean
 TESTALL = ./sage -t --all
 PTESTALL = ./sage -t -p --all
 
+# Flags for ./sage -t --all:
+OPTIONAL_AND_EXTERNAL = --optional=sage,dochtml,optional,external
+
```

Why is this called something so specific as "OPTIONAL_AND_EXTERNAL" and not just "TESTALL_FLAGS" or something?



---

archive/issue_comments_501794.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/run-dochtml-tests-by-default\" to \"u/jhpalmieri/run-dochtml-tests-by-default\"",
    "created_at": "2018-08-23T15:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501794",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "u/jdemeyer/run-dochtml-tests-by-default" to "u/jhpalmieri/run-dochtml-tests-by-default"



---

archive/issue_comments_501795.json:
```json
{
    "body": "<a id='comment:13'></a>I changed \"OPTIONAL_AND_EXTERNAL\" to \"TESTALL_FLAGS\". I also added a little documentation (which I should have done in my initial version).\n\n---\nNew commits:",
    "created_at": "2018-08-23T15:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501795",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>I changed "OPTIONAL_AND_EXTERNAL" to "TESTALL_FLAGS". I also added a little documentation (which I should have done in my initial version).

---
New commits:



---

archive/issue_comments_501796.json:
```json
{
    "body": "Changing commit from \"d6d4f0643130d054edd8265bd724207a3b1cce61\" to \"6a5090389bde02be3498fb05e9b18834de8eac52\"",
    "created_at": "2018-08-23T15:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501796",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "d6d4f0643130d054edd8265bd724207a3b1cce61" to "6a5090389bde02be3498fb05e9b18834de8eac52"



---

archive/issue_comments_501797.json:
```json
{
    "body": "<a id='comment:14'></a>Yes disabling doctest framework testing by default was definitely *not* my intention. Sorry that it turned out that way (hard to test the testing).\n\nThat said I agree with Jeroen. You wrote a comment\n\n> # NOTE that these are NOT the defaults used by the sage-runtests\n> # script (which is what gets invoked when running `sage -t`).\n> # These are only basic defaults when invoking the doctest runner\n> # from Python, which is not the typical use case.\n\n\nIs there any reason it should work that way? Refactoring that could be done separately from this ticket though if it would take too much time. Fixing the default doctests has higher priority than refactoring.",
    "created_at": "2018-08-23T21:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501797",
    "user": "https://github.com/timokau"
}
```

<a id='comment:14'></a>Yes disabling doctest framework testing by default was definitely *not* my intention. Sorry that it turned out that way (hard to test the testing).

That said I agree with Jeroen. You wrote a comment

> # NOTE that these are NOT the defaults used by the sage-runtests
> # script (which is what gets invoked when running `sage -t`).
> # These are only basic defaults when invoking the doctest runner
> # from Python, which is not the typical use case.


Is there any reason it should work that way? Refactoring that could be done separately from this ticket though if it would take too much time. Fixing the default doctests has higher priority than refactoring.



---

archive/issue_comments_501798.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [jdemeyer](https://trac.sagemath.org/ticket/25345?replyto=35#comment:35) in #25345:\n> Replying to [ticket:25345 gh-timokau]:\n> > I also make sure that the optional `py2` tag is only added if `sage` is in the optionals list.\n\n> \n> This change doesn't really make sense to me. I think it's a feature that `# py2` tests are always run on Python 2, regardless of the `--optional` option. So I'm reverting this part in #26110.\n\n\nThe reason I did that change is because the `py2` tests were not able to be run without the `sage` tests being run too. They need the context (variables being set etc.). The `py2` tag was very much used as if it was intended to be used in an \"and\" combination with sage, not \"or\".\n\nIf that is not the case and we're reverting that, we need to mark the context of `py2` tests as `py2`, too.",
    "created_at": "2018-08-23T21:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501798",
    "user": "https://github.com/timokau"
}
```

<a id='comment:15'></a>Replying to [jdemeyer](https://trac.sagemath.org/ticket/25345?replyto=35#comment:35) in #25345:
> Replying to [ticket:25345 gh-timokau]:
> > I also make sure that the optional `py2` tag is only added if `sage` is in the optionals list.

> 
> This change doesn't really make sense to me. I think it's a feature that `# py2` tests are always run on Python 2, regardless of the `--optional` option. So I'm reverting this part in #26110.


The reason I did that change is because the `py2` tests were not able to be run without the `sage` tests being run too. They need the context (variables being set etc.). The `py2` tag was very much used as if it was intended to be used in an "and" combination with sage, not "or".

If that is not the case and we're reverting that, we need to mark the context of `py2` tests as `py2`, too.



---

archive/issue_comments_501799.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 gh-timokau]:\n> Yes disabling doctest framework testing by default was definitely *not* my intention. Sorry that it turned out that way (hard to test the testing).\n> \n> That said I agree with Jeroen. You wrote a comment\n> \n> > # NOTE that these are NOT the defaults used by the sage-runtests\n> > # script (which is what gets invoked when running `sage -t`).\n> > # These are only basic defaults when invoking the doctest runner\n> > # from Python, which is not the typical use case.\n\n> \n> Is there any reason it should work that way? Refactoring that could be done separately from this ticket though if it would take too much time. Fixing the default doctests has higher priority than refactoring.\n\n\nJeroen wrote the comment, but my reply would be: it is easy to figure out that `sage-runtests` runs the tests, and once you know that, it is pretty easy to find out what flags it uses. If you put the flags in `doctest/control.py`, they are much harder to find.",
    "created_at": "2018-08-23T22:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501799",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>Replying to [comment:14 gh-timokau]:
> Yes disabling doctest framework testing by default was definitely *not* my intention. Sorry that it turned out that way (hard to test the testing).
> 
> That said I agree with Jeroen. You wrote a comment
> 
> > # NOTE that these are NOT the defaults used by the sage-runtests
> > # script (which is what gets invoked when running `sage -t`).
> > # These are only basic defaults when invoking the doctest runner
> > # from Python, which is not the typical use case.

> 
> Is there any reason it should work that way? Refactoring that could be done separately from this ticket though if it would take too much time. Fixing the default doctests has higher priority than refactoring.


Jeroen wrote the comment, but my reply would be: it is easy to figure out that `sage-runtests` runs the tests, and once you know that, it is pretty easy to find out what flags it uses. If you put the flags in `doctest/control.py`, they are much harder to find.



---

archive/issue_comments_501800.json:
```json
{
    "body": "<a id='comment:17'></a>It still seems confusing to me to split the doctest options over two files with a little redundancy. But at least with the comment nobody should make the same mistake I did, so maybe that's good enough.",
    "created_at": "2018-08-23T22:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501800",
    "user": "https://github.com/timokau"
}
```

<a id='comment:17'></a>It still seems confusing to me to split the doctest options over two files with a little redundancy. But at least with the comment nobody should make the same mistake I did, so maybe that's good enough.



---

archive/issue_comments_501801.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:15 gh-timokau]:\n> Replying to [jdemeyer](https://trac.sagemath.org/ticket/25345?replyto=35#comment:35) in #25345:\n> > Replying to [ticket:25345 gh-timokau]:\n> > > I also make sure that the optional `py2` tag is only added if `sage` is in the optionals list.\n\n> > \n> > This change doesn't really make sense to me. I think it's a feature that `# py2` tests are always run on Python 2, regardless of the `--optional` option. So I'm reverting this part in #26110.\n\n> \n> The reason I did that change is because the `py2` tests were not able to be run without the `sage` tests being run too. They need the context (variables being set etc.). The `py2` tag was very much used as if it was intended to be used in an \"and\" combination with sage, not \"or\".\n> \n> If that is not the case and we're reverting that, we need to mark the context of `py2` tests as `py2`, too.\n\n\nThere are no guidelines in the Sage documentation about this, as far as I know, and there are certainly doctests in the Sage library in which the \"context\" is not marked at all, and only the line actually using the optional part is marked as optional. (This is done in `sage/misc/latex.py`, for example, and also in a few files in `sage/homology`.) You may very well want to illustrate some basic computations, and then, if an optional package happens to be present, also do something fancier, but the basic parts should always be doctested. It would be redundant and awkward to have\n\n```\nsage: basic computation 1\nsage: basic computation 2\nsage: basic computation 3\n\nsage: basic computation 1 # optional - fancy\nsage: basic computation 2 # optional - fancy\nsage: basic computation 3 # optional - fancy\nsage: fancy computation   # optional - fancy\n```",
    "created_at": "2018-08-23T22:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501801",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>Replying to [comment:15 gh-timokau]:
> Replying to [jdemeyer](https://trac.sagemath.org/ticket/25345?replyto=35#comment:35) in #25345:
> > Replying to [ticket:25345 gh-timokau]:
> > > I also make sure that the optional `py2` tag is only added if `sage` is in the optionals list.

> > 
> > This change doesn't really make sense to me. I think it's a feature that `# py2` tests are always run on Python 2, regardless of the `--optional` option. So I'm reverting this part in #26110.

> 
> The reason I did that change is because the `py2` tests were not able to be run without the `sage` tests being run too. They need the context (variables being set etc.). The `py2` tag was very much used as if it was intended to be used in an "and" combination with sage, not "or".
> 
> If that is not the case and we're reverting that, we need to mark the context of `py2` tests as `py2`, too.


There are no guidelines in the Sage documentation about this, as far as I know, and there are certainly doctests in the Sage library in which the "context" is not marked at all, and only the line actually using the optional part is marked as optional. (This is done in `sage/misc/latex.py`, for example, and also in a few files in `sage/homology`.) You may very well want to illustrate some basic computations, and then, if an optional package happens to be present, also do something fancier, but the basic parts should always be doctested. It would be redundant and awkward to have

```
sage: basic computation 1
sage: basic computation 2
sage: basic computation 3

sage: basic computation 1 # optional - fancy
sage: basic computation 2 # optional - fancy
sage: basic computation 3 # optional - fancy
sage: fancy computation   # optional - fancy
```



---

archive/issue_comments_501802.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 jhpalmieri]:\n> There are no guidelines in the Sage documentation about this, as far as I know, and there are certainly doctests in the Sage library in which the \"context\" is not marked at all, and only the line actually using the optional part is marked as optional. (This is done in `sage/misc/latex.py`, for example, and also in a few files in `sage/homology`.) You may very well want to illustrate some basic computations, and then, if an optional package happens to be present, also do something fancier, but the basic parts should always be doctested. It would be redundant and awkward to have\n\n\nYes this was my understanding too, which is why I only added `py2` conditional on the \"basic parts\" (optional - sage) being tested too. A better solution would be to be able to express \"run this when sage AND py2 is present\" vs \"run this when sage OR py2 is present\", but that would be a significant change in the doctesting framework.",
    "created_at": "2018-08-24T10:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501802",
    "user": "https://github.com/timokau"
}
```

<a id='comment:19'></a>Replying to [comment:18 jhpalmieri]:
> There are no guidelines in the Sage documentation about this, as far as I know, and there are certainly doctests in the Sage library in which the "context" is not marked at all, and only the line actually using the optional part is marked as optional. (This is done in `sage/misc/latex.py`, for example, and also in a few files in `sage/homology`.) You may very well want to illustrate some basic computations, and then, if an optional package happens to be present, also do something fancier, but the basic parts should always be doctested. It would be redundant and awkward to have


Yes this was my understanding too, which is why I only added `py2` conditional on the "basic parts" (optional - sage) being tested too. A better solution would be to be able to express "run this when sage AND py2 is present" vs "run this when sage OR py2 is present", but that would be a significant change in the doctesting framework.



---

archive/issue_comments_501803.json:
```json
{
    "body": "<a id='comment:20'></a>John: do you agree with my patch from [comment:9]?",
    "created_at": "2018-08-29T08:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501803",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>John: do you agree with my patch from [comment:9]?



---

archive/issue_comments_501804.json:
```json
{
    "body": "Changing reviewer from \"Jeroen Demeyer\" to \"John Palmieri\"",
    "created_at": "2018-08-29T17:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501804",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "Jeroen Demeyer" to "John Palmieri"



---

archive/issue_comments_501805.json:
```json
{
    "body": "<a id='comment:21'></a>Yes, I agree with it, plus my added documentation. Positive review from me.",
    "created_at": "2018-08-29T17:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501805",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>Yes, I agree with it, plus my added documentation. Positive review from me.



---

archive/issue_comments_501806.json:
```json
{
    "body": "Changing author from \"John Palmieri\" to \"Jeroen Demeyer\"",
    "created_at": "2018-08-29T17:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501806",
    "user": "https://github.com/jhpalmieri"
}
```

Changing author from "John Palmieri" to "Jeroen Demeyer"



---

archive/issue_comments_501807.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-29T17:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501807",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_501808.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-08-29T17:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501808",
    "user": "https://github.com/timokau"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_501809.json:
```json
{
    "body": "<a id='comment:22'></a>As I said before, adding `py2` unconditionally makes it impossible to run the `dochtml` doctests in isolation. I think that should be fixed either by reverting that change, modifying the doctest framework to make \"OR\" possible or giving the `py2` tests their necessary context.",
    "created_at": "2018-08-29T17:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501809",
    "user": "https://github.com/timokau"
}
```

<a id='comment:22'></a>As I said before, adding `py2` unconditionally makes it impossible to run the `dochtml` doctests in isolation. I think that should be fixed either by reverting that change, modifying the doctest framework to make "OR" possible or giving the `py2` tests their necessary context.



---

archive/issue_comments_501810.json:
```json
{
    "body": "<a id='comment:23'></a>I don't understand: where have you talked about `py2` tests and `dochtml` tests? Or did you mean `py2` and `sage`? Anyway, can you give an example illustrating the issue?",
    "created_at": "2018-08-29T18:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501810",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'></a>I don't understand: where have you talked about `py2` tests and `dochtml` tests? Or did you mean `py2` and `sage`? Anyway, can you give an example illustrating the issue?



---

archive/issue_comments_501811.json:
```json
{
    "body": "<a id='comment:24'></a>This is what I was talking about [comment:15 here] and [comment:19 here]. The point of the orignal ticket that introduced this bug was to be able to build and test sage and its docs seperately. When `py2` is always added by default, the docs cannot be tested individually like this:\n\n```\nsage -t --optional=dochtml --all\n```\n\nBecause the `py2` tests will be run without their context. That is why I originally made the change to only add `py2` when `sage` is also added (since the `py2` tests assume that all unmarked doctests are also run), which Jeroen reverted here.",
    "created_at": "2018-08-29T18:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501811",
    "user": "https://github.com/timokau"
}
```

<a id='comment:24'></a>This is what I was talking about [comment:15 here] and [comment:19 here]. The point of the orignal ticket that introduced this bug was to be able to build and test sage and its docs seperately. When `py2` is always added by default, the docs cannot be tested individually like this:

```
sage -t --optional=dochtml --all
```

Because the `py2` tests will be run without their context. That is why I originally made the change to only add `py2` when `sage` is also added (since the `py2` tests assume that all unmarked doctests are also run), which Jeroen reverted here.



---

archive/issue_comments_501812.json:
```json
{
    "body": "<a id='comment:25'></a>> The point of the orignal ticket that introduced this bug was to be able to build and test sage and its docs seperately.\n\n\nThe stated point of the original ticket was to be able to test the Sage library and skip over tests which depended on the docs; this is not the same as being able to test the docs independently, and if that was one of the goals of #25345, it was not clear to me. Given the situation with other optional tags in Sage, you shouldn't expect `sage -t --optional=dochtml --all` to pass. Running `sage -t --optional=latex --all` results in some failed tests, for example. Same with `--optional=chomp`.\n\nAs I said before, there are no guidelines that optional tests marked \"TAG\" must pass when run with only `--optional=TAG`. Therefore we shouldn't start imposing that restriction without an explicit agreement that the policy is being changed. Right now, the de facto policy is: optional tests marked \"TAG\" should pass when run with `--optional=sage,TAG` (but they don't need to pass with `--optional=TAG`).",
    "created_at": "2018-08-29T19:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501812",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>> The point of the orignal ticket that introduced this bug was to be able to build and test sage and its docs seperately.


The stated point of the original ticket was to be able to test the Sage library and skip over tests which depended on the docs; this is not the same as being able to test the docs independently, and if that was one of the goals of #25345, it was not clear to me. Given the situation with other optional tags in Sage, you shouldn't expect `sage -t --optional=dochtml --all` to pass. Running `sage -t --optional=latex --all` results in some failed tests, for example. Same with `--optional=chomp`.

As I said before, there are no guidelines that optional tests marked "TAG" must pass when run with only `--optional=TAG`. Therefore we shouldn't start imposing that restriction without an explicit agreement that the policy is being changed. Right now, the de facto policy is: optional tests marked "TAG" should pass when run with `--optional=sage,TAG` (but they don't need to pass with `--optional=TAG`).



---

archive/issue_comments_501813.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 jhpalmieri]:\n> > The point of the orignal ticket that introduced this bug was to be able to build and test sage and its docs seperately.\n\n> \n> The stated point of the original ticket was to be able to test the Sage library and skip over tests which depended on the docs; this is not the same as being able to test the docs independently, and if that was one of the goals of #25345, it was not clear to me.\n\n\nYou're right, I probably failed to say that explicitly. My reasoning is that I want to build the docs seperately from the rest of sage but I would still like to run those tests. That was possible before.\n\n> Given the situation with other optional tags in Sage, you shouldn't expect `sage -t --optional=dochtml --all` to pass. Running `sage -t --optional=latex --all` results in some failed tests, for example. Same with `--optional=chomp`.\n\n\nBut it did pass since the `dochtml` doctests are few and pretty isolated.\n\n> As I said before, there are no guidelines that optional tests marked \"TAG\" must pass when run with only `--optional=TAG`. Therefore we shouldn't start imposing that restriction without an explicit agreement that the policy is being changed. Right now, the de facto policy is: optional tests marked \"TAG\" should pass when run with `--optional=sage,TAG` (but they don't need to pass with `--optional=TAG`).\n\n\nI agree that a general discussion is out of scope (although I think that is a problem and should be solved some day). But this is of a much more limited scope and easy to solve. There are also no downsides to only adding `py2` when `sage` is added since it won't work otherwise anyways.",
    "created_at": "2018-08-29T19:35:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501813",
    "user": "https://github.com/timokau"
}
```

<a id='comment:26'></a>Replying to [comment:25 jhpalmieri]:
> > The point of the orignal ticket that introduced this bug was to be able to build and test sage and its docs seperately.

> 
> The stated point of the original ticket was to be able to test the Sage library and skip over tests which depended on the docs; this is not the same as being able to test the docs independently, and if that was one of the goals of #25345, it was not clear to me.


You're right, I probably failed to say that explicitly. My reasoning is that I want to build the docs seperately from the rest of sage but I would still like to run those tests. That was possible before.

> Given the situation with other optional tags in Sage, you shouldn't expect `sage -t --optional=dochtml --all` to pass. Running `sage -t --optional=latex --all` results in some failed tests, for example. Same with `--optional=chomp`.


But it did pass since the `dochtml` doctests are few and pretty isolated.

> As I said before, there are no guidelines that optional tests marked "TAG" must pass when run with only `--optional=TAG`. Therefore we shouldn't start imposing that restriction without an explicit agreement that the policy is being changed. Right now, the de facto policy is: optional tests marked "TAG" should pass when run with `--optional=sage,TAG` (but they don't need to pass with `--optional=TAG`).


I agree that a general discussion is out of scope (although I think that is a problem and should be solved some day). But this is of a much more limited scope and easy to solve. There are also no downsides to only adding `py2` when `sage` is added since it won't work otherwise anyways.



---

archive/issue_comments_501814.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:22 gh-timokau]:\n> I think that should be fixed either by reverting that change, modifying the doctest framework to make \"OR\" possible or giving the `py2` tests their necessary context.\n\n\nThat issue is really unrelated to this ticket, so let's not confound two issues.\n\nI still think that the handling of `py2` in this ticket is better than before: it treats `py2` like all other optional tags, making things more consistent (agreed, consistently \"wrong\" but consistence is good).\n\nI'm fine with having a wider discussion about the meaning of `--optional=sage` but that shouldn't hold up this ticket.",
    "created_at": "2018-08-29T20:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501814",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>Replying to [comment:22 gh-timokau]:
> I think that should be fixed either by reverting that change, modifying the doctest framework to make "OR" possible or giving the `py2` tests their necessary context.


That issue is really unrelated to this ticket, so let's not confound two issues.

I still think that the handling of `py2` in this ticket is better than before: it treats `py2` like all other optional tags, making things more consistent (agreed, consistently "wrong" but consistence is good).

I'm fine with having a wider discussion about the meaning of `--optional=sage` but that shouldn't hold up this ticket.



---

archive/issue_comments_501815.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-08-29T20:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501815",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_501816.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-08-29T20:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501816",
    "user": "https://github.com/timokau"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_501817.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 jdemeyer]:\n> Replying to [comment:22 gh-timokau]:\n> > I think that should be fixed either by reverting that change, modifying the doctest framework to make \"OR\" possible or giving the `py2` tests their necessary context.\n\n> \n> That issue is really unrelated to this ticket, so let's not confound two issues.\n\n\nIt worked before this ticket and doesn't work after. So I think it is related.\n\n> I still think that the handling of `py2` in this ticket is better than before: it treats `py2` like all other optional tags, making things more consistent (agreed, consistently \"wrong\" but consistence is good).\n\n\nNo, `py2` is differnt from other optional tags because it is added automatically. Before it was added automatically only when it made sense. With this change it is added in any case. I don't think that is an improvement.\nI'll set this back to needs_work once more because I really think it does. The issue is relevant to this ticket, easy to fix and with no disadvantage. If you want to set it to positive_review again, I'll have to accept that and just not run the dochtml tests at all for now.",
    "created_at": "2018-08-29T20:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501817",
    "user": "https://github.com/timokau"
}
```

<a id='comment:28'></a>Replying to [comment:27 jdemeyer]:
> Replying to [comment:22 gh-timokau]:
> > I think that should be fixed either by reverting that change, modifying the doctest framework to make "OR" possible or giving the `py2` tests their necessary context.

> 
> That issue is really unrelated to this ticket, so let's not confound two issues.


It worked before this ticket and doesn't work after. So I think it is related.

> I still think that the handling of `py2` in this ticket is better than before: it treats `py2` like all other optional tags, making things more consistent (agreed, consistently "wrong" but consistence is good).


No, `py2` is differnt from other optional tags because it is added automatically. Before it was added automatically only when it made sense. With this change it is added in any case. I don't think that is an improvement.
I'll set this back to needs_work once more because I really think it does. The issue is relevant to this ticket, easy to fix and with no disadvantage. If you want to set it to positive_review again, I'll have to accept that and just not run the dochtml tests at all for now.



---

archive/issue_comments_501818.json:
```json
{
    "body": "<a id='comment:29'></a>I've created #26159 as a sort of \"wishlist\" ticket for a general solution. I won't try to implement that myself though.",
    "created_at": "2018-08-29T20:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501818",
    "user": "https://github.com/timokau"
}
```

<a id='comment:29'></a>I've created #26159 as a sort of "wishlist" ticket for a general solution. I won't try to implement that myself though.



---

archive/issue_comments_501819.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:28 gh-timokau]:\n> Before it was added automatically only when it made sense.\n\n\nThis is where I do not agree. `py2` and `sage` are semantically completely unrelated. The only reason why you think that they are related is to work around a bug in the doctester. I say: don't work around that bug but fix that bug. I see that you just opened #26159 for that. Once you fix that, you will realize that `py2` and `sage` have nothing to do with eachother.\n\nThe only part where I do agree is that I shouldn't be changing anything to `py2` on this ticket. But you also shouldn't have changed it on #25345 either. So let's just revert this to how it was in Sage 8.3 and discuss it in #26159. I honestly think that it's the most sensible thing to do.",
    "created_at": "2018-08-29T20:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501819",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>Replying to [comment:28 gh-timokau]:
> Before it was added automatically only when it made sense.


This is where I do not agree. `py2` and `sage` are semantically completely unrelated. The only reason why you think that they are related is to work around a bug in the doctester. I say: don't work around that bug but fix that bug. I see that you just opened #26159 for that. Once you fix that, you will realize that `py2` and `sage` have nothing to do with eachother.

The only part where I do agree is that I shouldn't be changing anything to `py2` on this ticket. But you also shouldn't have changed it on #25345 either. So let's just revert this to how it was in Sage 8.3 and discuss it in #26159. I honestly think that it's the most sensible thing to do.



---

archive/issue_comments_501820.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-08-29T20:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501820",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_501821.json:
```json
{
    "body": "<a id='comment:31'></a>I\"m not sure what the bug in the doctester is, but since #26159 is described as a wishlist, I think it is less focused then just being aimed at a single issue involving `py2`. So I think a more focused ticket should be opened. I would do it, but I'm not sure what the issue is. Is it that we want `sage -t --optional=tag1,tag2,...` to skip `py2` tests unless `sage` is one of the tags? I can see some sense in that: we have in the Sage library tests like this:\n\n```\nsage: setup\nsage: setup\nsage: test something # py2\nANSWER\nsage: test something # py3\nDIFFERENT ANSWER\n```\nand I don't want to have to mark the first two lines with `# py2, py3`. With `--optional=dochtml`, only the third line will get executed, resulting in a failed test. Is that the point?\n\nIt's still not obvious to me that it's a bug, and I think it belongs on a separate ticket, but I certainly don't mind if it gets fixed.",
    "created_at": "2018-08-29T21:17:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501821",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:31'></a>I"m not sure what the bug in the doctester is, but since #26159 is described as a wishlist, I think it is less focused then just being aimed at a single issue involving `py2`. So I think a more focused ticket should be opened. I would do it, but I'm not sure what the issue is. Is it that we want `sage -t --optional=tag1,tag2,...` to skip `py2` tests unless `sage` is one of the tags? I can see some sense in that: we have in the Sage library tests like this:

```
sage: setup
sage: setup
sage: test something # py2
ANSWER
sage: test something # py3
DIFFERENT ANSWER
```
and I don't want to have to mark the first two lines with `# py2, py3`. With `--optional=dochtml`, only the third line will get executed, resulting in a failed test. Is that the point?

It's still not obvious to me that it's a bug, and I think it belongs on a separate ticket, but I certainly don't mind if it gets fixed.



---

archive/issue_comments_501822.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:30 jdemeyer]:\n> Replying to [comment:28 gh-timokau]:\n> > Before it was added automatically only when it made sense.\n\n> \n> This is where I do not agree. `py2` and `sage` are semantically completely unrelated.\n\n\nMaybe not semantically but in practice they are. I don't see why we should hinder a practical usecase for that. Currently all `py2` tests assume that `sage` tests are run so it doesn't make any sense to add `py2` when `sage` is not tested.\nIt does not have any advantage whatsoever to add `py2` when `sage` is not added while it does have an advantage not to add it.\n\n> The only reason why you think that they are related is to work around a bug in the doctester. I say: don't work around that bug but fix that bug. I see that you just opened #26159 for that. Once you fix that, you will realize that `py2` and `sage` have nothing to do with eachother.\n\n\nI don't think we should introduce a regression that can be easily fixed and does not have any disadvantages on typical workflow just because the solution is not good enough yet. A better solution can still come in the future but I expect that to take significant changes in the doctesting framework.\n\n> The only part where I do agree is that I shouldn't be changing anything to `py2` on this ticket. But you also shouldn't have changed it on #25345 either.\n\n\nI changed in in #25345 to make the use case of testing sage and dochtml seperately possible. I just never explicitly said that I intended to also run the dochtml tests. But I still think that was in-scope for that ticket.\n\n> So let's just revert this to how it was in Sage 8.3 and discuss it in #26159. I honestly think that it's the most sensible thing to do.\n\n\nI disagree but apparently your mind is made up.",
    "created_at": "2018-08-29T21:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501822",
    "user": "https://github.com/timokau"
}
```

<a id='comment:32'></a>Replying to [comment:30 jdemeyer]:
> Replying to [comment:28 gh-timokau]:
> > Before it was added automatically only when it made sense.

> 
> This is where I do not agree. `py2` and `sage` are semantically completely unrelated.


Maybe not semantically but in practice they are. I don't see why we should hinder a practical usecase for that. Currently all `py2` tests assume that `sage` tests are run so it doesn't make any sense to add `py2` when `sage` is not tested.
It does not have any advantage whatsoever to add `py2` when `sage` is not added while it does have an advantage not to add it.

> The only reason why you think that they are related is to work around a bug in the doctester. I say: don't work around that bug but fix that bug. I see that you just opened #26159 for that. Once you fix that, you will realize that `py2` and `sage` have nothing to do with eachother.


I don't think we should introduce a regression that can be easily fixed and does not have any disadvantages on typical workflow just because the solution is not good enough yet. A better solution can still come in the future but I expect that to take significant changes in the doctesting framework.

> The only part where I do agree is that I shouldn't be changing anything to `py2` on this ticket. But you also shouldn't have changed it on #25345 either.


I changed in in #25345 to make the use case of testing sage and dochtml seperately possible. I just never explicitly said that I intended to also run the dochtml tests. But I still think that was in-scope for that ticket.

> So let's just revert this to how it was in Sage 8.3 and discuss it in #26159. I honestly think that it's the most sensible thing to do.


I disagree but apparently your mind is made up.



---

archive/issue_comments_501823.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:31 jhpalmieri]:\n> I\"m not sure what the bug in the doctester is\n\n\nIt may be a bit much to call it a bug but I think Jeroen is talking about the inadequacy that currently makes it necessary to always include `sage` in the optionals list.\n\n> but since #26159 is described as a wishlist, I think it is less focused then just being aimed at a single issue involving `py2`. So I think a more focused ticket should be opened.\n\n\nThe current behaviour is the one I want and introduced in #25345 (kind of out of scope because I did not mention that use case there). The change is revertet in this ticket:\n\n```\n-                if \"sage\" in options.optional:\n-                    options.optional |= auto_optional_tags\n+                options.optional |= auto_optional_tags\n```\n\nSo there would be little use in reverting it here and then re-introducing it in another ticket. I think it shouldn't be reverted in the first place.\n\n> I would do it, but I'm not sure what the issue is. Is it that we want `sage -t --optional=tag1,tag2,...` to skip `py2` tests unless `sage` is one of the tags?\n\n\nWe currently add some `--optional` tags by default. When we detect python2 we add the `py2` tag. In #25345 I changed that so that py2 is only added when `sage` is also tested. Here that change is reverted.\n\nThe use case is that I first build sage without doctest, testing `sage -t --optional=sage`. Then I have a different package which depends on sage, build the docs and is tested by `sage -t --optional=dochtml`. Before #25345 (and after this is merged) that will not work because it will also automatically try to run all the `py2` tests wihtout context.",
    "created_at": "2018-08-29T21:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501823",
    "user": "https://github.com/timokau"
}
```

<a id='comment:33'></a>Replying to [comment:31 jhpalmieri]:
> I"m not sure what the bug in the doctester is


It may be a bit much to call it a bug but I think Jeroen is talking about the inadequacy that currently makes it necessary to always include `sage` in the optionals list.

> but since #26159 is described as a wishlist, I think it is less focused then just being aimed at a single issue involving `py2`. So I think a more focused ticket should be opened.


The current behaviour is the one I want and introduced in #25345 (kind of out of scope because I did not mention that use case there). The change is revertet in this ticket:

```
-                if "sage" in options.optional:
-                    options.optional |= auto_optional_tags
+                options.optional |= auto_optional_tags
```

So there would be little use in reverting it here and then re-introducing it in another ticket. I think it shouldn't be reverted in the first place.

> I would do it, but I'm not sure what the issue is. Is it that we want `sage -t --optional=tag1,tag2,...` to skip `py2` tests unless `sage` is one of the tags?


We currently add some `--optional` tags by default. When we detect python2 we add the `py2` tag. In #25345 I changed that so that py2 is only added when `sage` is also tested. Here that change is reverted.

The use case is that I first build sage without doctest, testing `sage -t --optional=sage`. Then I have a different package which depends on sage, build the docs and is tested by `sage -t --optional=dochtml`. Before #25345 (and after this is merged) that will not work because it will also automatically try to run all the `py2` tests wihtout context.



---

archive/issue_comments_501824.json:
```json
{
    "body": "<a id='comment:34'></a>So among the issues is your particular use case, which happened to work after #25345, but is not guaranteed to work in the future because someone might add `dochtml` flags without marking their context. This is not very compelling to me.\n\nA separate issue is the particular handling of the `py2` and `py3` tags. That could go on another ticket.",
    "created_at": "2018-08-29T21:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501824",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:34'></a>So among the issues is your particular use case, which happened to work after #25345, but is not guaranteed to work in the future because someone might add `dochtml` flags without marking their context. This is not very compelling to me.

A separate issue is the particular handling of the `py2` and `py3` tags. That could go on another ticket.



---

archive/issue_comments_501825.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:34 jhpalmieri]:\n> So among the issues is your particular use case, which happened to work after #25345, but is not guaranteed to work in the future because someone might add `dochtml` flags without marking their context. This is not very compelling to me.\n\n\nIn theory yes, that might happen. In practice there currently only are 16 lines marked as `optional - dochtml` and all of them are isolated enough to work. I think it is pretty unlikely that more will be added any time soon (since not many tests actually require the docs to be build) and even more unlikely that those will need context.\n\nSo it is a question of definitely breaking it now vs. it hypothetically maybe one day stop working.\n\n> A separate issue is the particular handling of the `py2` and `py3` tags. That could go on another ticket.\n\n\nDo you mean that they are always added by default? They do need to be handled somewhat special because they need to determine the python version at runtime.",
    "created_at": "2018-08-29T21:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501825",
    "user": "https://github.com/timokau"
}
```

<a id='comment:35'></a>Replying to [comment:34 jhpalmieri]:
> So among the issues is your particular use case, which happened to work after #25345, but is not guaranteed to work in the future because someone might add `dochtml` flags without marking their context. This is not very compelling to me.


In theory yes, that might happen. In practice there currently only are 16 lines marked as `optional - dochtml` and all of them are isolated enough to work. I think it is pretty unlikely that more will be added any time soon (since not many tests actually require the docs to be build) and even more unlikely that those will need context.

So it is a question of definitely breaking it now vs. it hypothetically maybe one day stop working.

> A separate issue is the particular handling of the `py2` and `py3` tags. That could go on another ticket.


Do you mean that they are always added by default? They do need to be handled somewhat special because they need to determine the python version at runtime.



---

archive/issue_comments_501826.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 gh-timokau]:\n> Do you mean that they are always added by default? They do need to be handled somewhat special because they need to determine the python version at runtime.\n\n\nI mean whether they should be treated differently (only added when `sage` is also tested) or treated like the optional tags.",
    "created_at": "2018-08-29T23:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501826",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:36'></a>Replying to [comment:35 gh-timokau]:
> Do you mean that they are always added by default? They do need to be handled somewhat special because they need to determine the python version at runtime.


I mean whether they should be treated differently (only added when `sage` is also tested) or treated like the optional tags.



---

archive/issue_comments_501827.json:
```json
{
    "body": "<a id='comment:37'></a>Can we please move the discussion about `py2` to a different ticket? I'm totally open for discussions, but not on this ticket.",
    "created_at": "2018-08-30T05:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501827",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Can we please move the discussion about `py2` to a different ticket? I'm totally open for discussions, but not on this ticket.



---

archive/issue_comments_501828.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:36 jhpalmieri]:\n> Replying to [comment:35 gh-timokau]:\n> > Do you mean that they are always added by default? They do need to be handled somewhat special because they need to determine the python version at runtime.\n\n> \n> I mean whether they should be treated differently (only added when `sage` is also tested) or treated like the optional tags.\n\n\nRight. At least moving option (1) into another ticket doesn't make much sense to me though because that is the status quo that is changed by this ticket.",
    "created_at": "2018-08-30T13:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501828",
    "user": "https://github.com/timokau"
}
```

<a id='comment:38'></a>Replying to [comment:36 jhpalmieri]:
> Replying to [comment:35 gh-timokau]:
> > Do you mean that they are always added by default? They do need to be handled somewhat special because they need to determine the python version at runtime.

> 
> I mean whether they should be treated differently (only added when `sage` is also tested) or treated like the optional tags.


Right. At least moving option (1) into another ticket doesn't make much sense to me though because that is the status quo that is changed by this ticket.



---

archive/issue_comments_501829.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-08-30T17:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501829",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_501830.json:
```json
{
    "body": "<a id='comment:39'></a>\n```\nDoctesting 1 file.\nsage -t --long src/sage/misc/sagedoc.py\n**********************************************************************\nFile \"src/sage/misc/sagedoc.py\", line 1179, in sage.misc.sagedoc.?\nFailed example:\n    len(L) < N  # optional - dochtml, long time\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/misc/sagedoc.py\", line 1183, in sage.misc.sagedoc.?\nFailed example:\n    all(tree_re.search(l) for l in L) # optional - dochtml, long time\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   2 of  35 in sage.misc.sagedoc.?\n    [115 tests, 2 failures, 49.04 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/misc/sagedoc.py  # 2 doctests failed\n----------------------------------------------------------------------\n```",
    "created_at": "2018-08-30T17:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501830",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:39'></a>
```
Doctesting 1 file.
sage -t --long src/sage/misc/sagedoc.py
**********************************************************************
File "src/sage/misc/sagedoc.py", line 1179, in sage.misc.sagedoc.?
Failed example:
    len(L) < N  # optional - dochtml, long time
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/misc/sagedoc.py", line 1183, in sage.misc.sagedoc.?
Failed example:
    all(tree_re.search(l) for l in L) # optional - dochtml, long time
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   2 of  35 in sage.misc.sagedoc.?
    [115 tests, 2 failures, 49.04 s]
----------------------------------------------------------------------
sage -t --long src/sage/misc/sagedoc.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

archive/issue_comments_501831.json:
```json
{
    "body": "<a id='comment:40'></a>You must have merged #26017 to get this failure.",
    "created_at": "2018-08-30T17:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501831",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:40'></a>You must have merged #26017 to get this failure.



---

archive/issue_comments_501832.json:
```json
{
    "body": "<a id='comment:41'></a>When I merge #26017 with this ticket, I don't get any failures with `make ptestlong`. Volker, can you clarify?",
    "created_at": "2018-08-30T20:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501832",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:41'></a>When I merge #26017 with this ticket, I don't get any failures with `make ptestlong`. Volker, can you clarify?



---

archive/issue_comments_501833.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-08-31T07:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501833",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_501834.json:
```json
{
    "body": "<a id='comment:42'></a>I agree: the doctests which are failing are doctests added by #26017",
    "created_at": "2018-08-31T07:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501834",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:42'></a>I agree: the doctests which are failing are doctests added by #26017



---

archive/issue_comments_501835.json:
```json
{
    "body": "<a id='comment:43'></a>Guys, you were supposed to wait for the next beta and not throw a wrench in the release management process by setting a ticket that does not work back to positive review.",
    "created_at": "2018-09-02T08:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501835",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:43'></a>Guys, you were supposed to wait for the next beta and not throw a wrench in the release management process by setting a ticket that does not work back to positive review.



---

archive/issue_comments_501836.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-09-02T08:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501836",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_501837.json:
```json
{
    "body": "<a id='comment:44'></a>Volker, could you please say something like \"doctest failure in upcoming beta\" rather than just post a failure with no explanation? Sometimes there are failures purely caused by the ticket that the authors and reviewers missed, and those probably deserve no explanation, but otherwise it could help if we know the context for the failures.",
    "created_at": "2018-09-02T17:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501837",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:44'></a>Volker, could you please say something like "doctest failure in upcoming beta" rather than just post a failure with no explanation? Sometimes there are failures purely caused by the ticket that the authors and reviewers missed, and those probably deserve no explanation, but otherwise it could help if we know the context for the failures.



---

archive/issue_comments_501838.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:43 vbraun]:\n> Guys, you were supposed to wait for the next beta and not throw a wrench in the release management process by setting a ticket that does not work back to positive review.\n\n\nAt the time of setting it to positive review, it passed all doctests. We mentioned that the failures were really because of #26017 but you ignored that. Now that #26017 is merged, this ticket indeed breaks.\n\nIn other words: I don't think that we (on this ticket) did anything wrong.",
    "created_at": "2018-09-03T07:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501838",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>Replying to [comment:43 vbraun]:
> Guys, you were supposed to wait for the next beta and not throw a wrench in the release management process by setting a ticket that does not work back to positive review.


At the time of setting it to positive review, it passed all doctests. We mentioned that the failures were really because of #26017 but you ignored that. Now that #26017 is merged, this ticket indeed breaks.

In other words: I don't think that we (on this ticket) did anything wrong.



---

archive/issue_comments_501839.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-09-03T10:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501839",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_501840.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#26184\"",
    "created_at": "2018-09-03T10:09:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501840",
    "user": "https://github.com/jdemeyer"
}
```

Changing dependencies from "" to "#26184"



---

archive/issue_events_065139.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-06T07:11:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26110#event-65139"
}
```



---

archive/issue_comments_501841.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/run-dochtml-tests-by-default\" to \"6a5090389bde02be3498fb05e9b18834de8eac52\"",
    "created_at": "2018-09-06T07:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501841",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/run-dochtml-tests-by-default" to "6a5090389bde02be3498fb05e9b18834de8eac52"



---

archive/issue_comments_501842.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-06T07:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26110",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26110#issuecomment-501842",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
