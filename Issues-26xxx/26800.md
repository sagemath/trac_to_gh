# Issue 26800: neighbors of a nonexistent vertex

archive/issues_026800.json:
```json
{
    "body": "CC:  @bgrenet\n\nKeywords: neighbor neighbor_iterator LookupError\n\nThe neighbor_iterator method does not give a correct error message when given a vertex that does not belong to the graph.\n\\\\\n\n```\nsage: g = Graph()\nsage: list(g.neighbor_iterator(123))\nLookupError: vertex (-1) is not a vertex of the graph\n```\n\nThe issue is that '-1' is not the name of the vertex that we tried to\ndelete.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27037\n\n",
    "closed_at": "2019-01-28T19:20:12Z",
    "created_at": "2019-01-10T11:00:02Z",
    "labels": [
        "component: graph theory",
        "trivial",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "neighbors of a nonexistent vertex",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26800",
    "user": "https://github.com/jfraymond"
}
```
CC:  @bgrenet

Keywords: neighbor neighbor_iterator LookupError

The neighbor_iterator method does not give a correct error message when given a vertex that does not belong to the graph.
\\

```
sage: g = Graph()
sage: list(g.neighbor_iterator(123))
LookupError: vertex (-1) is not a vertex of the graph
```

The issue is that '-1' is not the name of the vertex that we tried to
delete.

Issue created by migration from https://trac.sagemath.org/ticket/27037





---

archive/issue_comments_376559.json:
```json
{
    "body": "It is fixed.\nI could not use check_vertex (because it does not exist for the object we have at this point), so I used a condition on has_vertex.\n\nNow we have\n\n```\nsage: g.neighbors(-41)\nLookupError                               Traceback (most recent call last)\n...\nLookupError: vertex (-41) is not a vertex of the graph\n```\n(same for neighbor_iterator, and also for digraphs)\n\n---\nNew commits:",
    "created_at": "2019-01-11T16:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376559",
    "user": "https://github.com/jfraymond"
}
```

It is fixed.
I could not use check_vertex (because it does not exist for the object we have at this point), so I used a condition on has_vertex.

Now we have

```
sage: g.neighbors(-41)
LookupError                               Traceback (most recent call last)
...
LookupError: vertex (-41) is not a vertex of the graph
```
(same for neighbor_iterator, and also for digraphs)

---
New commits:



---

archive/issue_comments_376560.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-11T16:58:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376560",
    "user": "https://github.com/jfraymond"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_376561.json:
```json
{
    "body": "Thank you for this patch. \nI agree with your proposal. We can unfortunately not avoid calling twice `get_vertex` (`has_vertex` calls `get_vertex`).\n\nCould you create `TESTS::` blocks for the doctests you have added?",
    "created_at": "2019-01-12T13:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376561",
    "user": "https://github.com/dcoudert"
}
```

Thank you for this patch. 
I agree with your proposal. We can unfortunately not avoid calling twice `get_vertex` (`has_vertex` calls `get_vertex`).

Could you create `TESTS::` blocks for the doctests you have added?



---

archive/issue_comments_376562.json:
```json
{
    "body": "We need to run some timings on this change. I am generally -1 on changes that are essentially cosmetic that result in a speed drop, more so in backend functions. My guess is the `-1` comes from the exception being propagated up via Cython, but I have not looked into it. This might not have a real change in timings, but I think it is worthwhile to check.",
    "created_at": "2019-01-13T17:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376562",
    "user": "https://github.com/tscrim"
}
```

We need to run some timings on this change. I am generally -1 on changes that are essentially cosmetic that result in a speed drop, more so in backend functions. My guess is the `-1` comes from the exception being propagated up via Cython, but I have not looked into it. This might not have a real change in timings, but I think it is worthwhile to check.



---

archive/issue_comments_376563.json:
```json
{
    "body": "Thanks for your answers.\n\n`@`dcoudert: Ah, I did not see that `has_vertex` calls `get_vertex`. It is possible to avoid calling twice `get_vertex` by doing the same check as in `has_vertex`:\n\n```python\ndef iterator_in_nbrs(self, v):\n    cdef int v_int = self.get_vertex(v)\n    if not (v_int != -1 and bitset_in((<CGraph>self._cg).active_vertices, v_int)):\n        # condition copied directly from has_vertex\n        raise LookupError(\"vertex ({0}) is not a vertex of the graph\".format(v))\n\n    # rest of the function as before\n```\nIs it OK to use this conditional rather that calling `has_vertex`? (On the one hand we avoid a call to `get_vertex` but on the other hand if `has_vertex` changes in the future, nobody will think of updating the conditional here.)\\\\\nYes, I will create `TESTS::` blocks.\n\n`@`tscrim: I compared the timings for the following code, with two cases depending whether the vertex exists in the graph.\n\n```python\ndef t1(h):\n    for i in range(50):\n        try:\n            l = h.neighbors(i)\n        except LookupError:\n            pass\n```\n\nI get the following results.\\\\\n'Old' version (before this patch):\n\n```\nsage: g = Graph()\nsage: %timeit t1(g)\n10000 loops, best of 3: 107 \u00b5s per loop\nsage: g.add_vertices(range(50))\nsage: %timeit t1(g)\n10000 loops, best of 3: 49.5 \u00b5s per loop\n```\n\nThis patch:\n\n```\nsage: g = Graph()\nsage: %timeit t1(g)\n10000 loops, best of 3: 95.3 \u00b5s per loop\nsage: g.add_vertices(range(50))\nsage: %timeit t1(g)\n10000 loops, best of 3: 52.3 \u00b5s per loop\n```\n\nThe version with only one call to `get_vertex` mentioned earlier in this message:\n\n```\nsage: g = Graph()\nsage: %timeit t1(g)\n10000 loops, best of 3: 92.1 \u00b5s per loop\nsage: g.add_vertices(range(50))\nsage: %timeit t1(g)\n10000 loops, best of 3: 48.5 \u00b5s per loop\n```",
    "created_at": "2019-01-14T11:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376563",
    "user": "https://github.com/jfraymond"
}
```

Thanks for your answers.

`@`dcoudert: Ah, I did not see that `has_vertex` calls `get_vertex`. It is possible to avoid calling twice `get_vertex` by doing the same check as in `has_vertex`:

```python
def iterator_in_nbrs(self, v):
    cdef int v_int = self.get_vertex(v)
    if not (v_int != -1 and bitset_in((<CGraph>self._cg).active_vertices, v_int)):
        # condition copied directly from has_vertex
        raise LookupError("vertex ({0}) is not a vertex of the graph".format(v))

    # rest of the function as before
```
Is it OK to use this conditional rather that calling `has_vertex`? (On the one hand we avoid a call to `get_vertex` but on the other hand if `has_vertex` changes in the future, nobody will think of updating the conditional here.)\\
Yes, I will create `TESTS::` blocks.

`@`tscrim: I compared the timings for the following code, with two cases depending whether the vertex exists in the graph.

```python
def t1(h):
    for i in range(50):
        try:
            l = h.neighbors(i)
        except LookupError:
            pass
```

I get the following results.\\
'Old' version (before this patch):

```
sage: g = Graph()
sage: %timeit t1(g)
10000 loops, best of 3: 107 µs per loop
sage: g.add_vertices(range(50))
sage: %timeit t1(g)
10000 loops, best of 3: 49.5 µs per loop
```

This patch:

```
sage: g = Graph()
sage: %timeit t1(g)
10000 loops, best of 3: 95.3 µs per loop
sage: g.add_vertices(range(50))
sage: %timeit t1(g)
10000 loops, best of 3: 52.3 µs per loop
```

The version with only one call to `get_vertex` mentioned earlier in this message:

```
sage: g = Graph()
sage: %timeit t1(g)
10000 loops, best of 3: 92.1 µs per loop
sage: g.add_vertices(range(50))
sage: %timeit t1(g)
10000 loops, best of 3: 48.5 µs per loop
```



---

archive/issue_comments_376564.json:
```json
{
    "body": "From your timings, we get ~7-8% slowdown with this ticket on a more practical test. I think generally people will be looking up neighbors of vertices in the graph. So I think the first part of that test is not as important as the second.\n\nI think what you should do is check you mentioned above. One other option is to make the actual check an `cdef inline` function to avoid some code duplication. However, I suspect it is sufficient to simply check `v_int != -1`.",
    "created_at": "2019-01-14T20:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376564",
    "user": "https://github.com/tscrim"
}
```

From your timings, we get ~7-8% slowdown with this ticket on a more practical test. I think generally people will be looking up neighbors of vertices in the graph. So I think the first part of that test is not as important as the second.

I think what you should do is check you mentioned above. One other option is to make the actual check an `cdef inline` function to avoid some code duplication. However, I suspect it is sufficient to simply check `v_int != -1`.



---

archive/issue_comments_376565.json:
```json
{
    "body": "It is not sufficient to check `v_int != -1`. Indeed, `get_vertex()` can return a value different from `-1` even if the requested vertex is not in the graph. See e.g., #22374#comment:12\n\nAn option could be to add a method that, given the internal value associated to a vertex (i.e., the value returned by `get_vertex()`), check if it corresponds to an active vertex of the graph.\n\nAnother option could be to expand method `get_vertex()` with a parameter like `check_active` (default to `False`) that would raise an error if the vertex is not active.\n\nThe first option should avoid to slowdown the code.",
    "created_at": "2019-01-15T12:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376565",
    "user": "https://github.com/dcoudert"
}
```

It is not sufficient to check `v_int != -1`. Indeed, `get_vertex()` can return a value different from `-1` even if the requested vertex is not in the graph. See e.g., #22374#comment:12

An option could be to add a method that, given the internal value associated to a vertex (i.e., the value returned by `get_vertex()`), check if it corresponds to an active vertex of the graph.

Another option could be to expand method `get_vertex()` with a parameter like `check_active` (default to `False`) that would raise an error if the vertex is not active.

The first option should avoid to slowdown the code.



---

archive/issue_events_067138.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:15:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26800#event-67138"
}
```



---

archive/issue_comments_376566.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376566",
    "user": "https://github.com/embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_376567.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-22T16:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376567",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_376568.json:
```json
{
    "body": "I used the check as in `has_vertex`, i.e. `v_int != -1 and bitset_in((<CGraph>self._cg).active_vertices, v_int)`.\nThis does not make the code slower, according to the timings above.",
    "created_at": "2019-01-22T16:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376568",
    "user": "https://github.com/jfraymond"
}
```

I used the check as in `has_vertex`, i.e. `v_int != -1 and bitset_in((<CGraph>self._cg).active_vertices, v_int)`.
This does not make the code slower, according to the timings above.



---

archive/issue_comments_376569.json:
```json
{
    "body": "I am happy with it. David?",
    "created_at": "2019-01-23T00:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376569",
    "user": "https://github.com/tscrim"
}
```

I am happy with it. David?



---

archive/issue_comments_376570.json:
```json
{
    "body": "I agree with these changes. I don't see yet a smarter way to do it.",
    "created_at": "2019-01-23T08:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376570",
    "user": "https://github.com/dcoudert"
}
```

I agree with these changes. I don't see yet a smarter way to do it.



---

archive/issue_comments_376571.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-23T08:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376571",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_376572.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-28T19:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26800#issuecomment-376572",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_067139.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-28T19:20:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26800",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26800#event-67139"
}
```
