# Issue 26118: sage -tp times out on a 160 core machine

archive/issues_025881.json:
```json
{
    "body": "Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.\n\nIt turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.\n\nOne workaround `export OPENBLAS_NUM_THREADS=1`.\n\nOr we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.\n\nThe FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq\n\n---\n\nHere are some benchmarks:\n\n```\nsage: m=load('/tmp/matrix') # a 500x500 RDF matrix\nsage: %timeit m.eigenvalues()\n1 loop, best of 3: 1.78 s per loop # currently\n1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1\n```\n\nNote that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)\n\nI also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.\n\n**CC:**  @slel @roed314\n\n**Branch:** [dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)\n\n**Reviewer:** Volker Braun\n\n**Author:** Julian R\u00fcth\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26118\n\n",
    "closed_at": "2018-08-25T11:01:27Z",
    "created_at": "2018-08-24T02:32:11Z",
    "labels": [
        "component: doctest framework",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "sage -tp times out on a 160 core machine",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26118",
    "user": "https://github.com/saraedum"
}
```
Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.

It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.

One workaround `export OPENBLAS_NUM_THREADS=1`.

Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.

The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq

---

Here are some benchmarks:

```
sage: m=load('/tmp/matrix') # a 500x500 RDF matrix
sage: %timeit m.eigenvalues()
1 loop, best of 3: 1.78 s per loop # currently
1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1
```

Note that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)

I also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.

**CC:**  @slel @roed314

**Branch:** [dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)

**Reviewer:** Volker Braun

**Author:** Julian Rüth

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/26118





---

archive/issue_comments_503803.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,6 +3,7 @@\n It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.\n \n This ugly workaround fixes it:\n+\n ```\n --- a/src/sage/doctest/forker.py\n +++ b/src/sage/doctest/forker.py\n``````\n",
    "created_at": "2018-08-24T02:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503803",
    "user": "https://github.com/saraedum"
}
```


**Description changed:**
``````diff
--- 
+++ 
@@ -3,6 +3,7 @@
 It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.
 
 This ugly workaround fixes it:
+
 ```
 --- a/src/sage/doctest/forker.py
 +++ b/src/sage/doctest/forker.py
``````




---

archive/issue_comments_503804.json:
```json
{
    "body": "<a id='comment:2'></a>\nroed: As you are often working on k8s. Does this also happen there?",
    "created_at": "2018-08-24T02:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503804",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:2'></a>
roed: As you are often working on k8s. Does this also happen there?



---

archive/issue_comments_503805.json:
```json
{
    "body": "<a id='comment:3'></a>\nWith an initial workaround, that set the CPU affinity before forking:\n\nBtw., with that workaround often the following part of the \"A tour of Sage\" in all languages hangs:\n\n```\nTrying (line 99):    m = random_matrix(RDF,500)\nExpecting nothing\nok [0.09 s]\nTrying (line 108):    e = m.eigenvalues()  # ungef\u00e4hr 2 Sekunden\nExpecting nothing\n```\n\nSo maybe this has something to do with some BLAS?",
    "created_at": "2018-08-24T02:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503805",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:3'></a>
With an initial workaround, that set the CPU affinity before forking:

Btw., with that workaround often the following part of the "A tour of Sage" in all languages hangs:

```
Trying (line 99):    m = random_matrix(RDF,500)
Expecting nothing
ok [0.09 s]
Trying (line 108):    e = m.eigenvalues()  # ungefähr 2 Sekunden
Expecting nothing
```

So maybe this has something to do with some BLAS?



---

archive/issue_comments_503806.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe hangs do not happen anymore with `OPENBLAS_NUM_THREADS=1` and `sage -tp --all` finishes in 2:29 minutes (which is the time it takes to run the tests in `sage.manifolds.differentiable.tensorfield`).",
    "created_at": "2018-08-24T03:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503806",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:4'></a>
The hangs do not happen anymore with `OPENBLAS_NUM_THREADS=1` and `sage -tp --all` finishes in 2:29 minutes (which is the time it takes to run the tests in `sage.manifolds.differentiable.tensorfield`).



---

archive/issue_comments_503807.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.\n \n-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.\n+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. \n \n This ugly workaround fixes it:\n \n@@ -19,3 +19,5 @@\n          try:\n              # Block SIGCHLD and SIGINT except during the pselect() call\n ```\n+\n+A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.\n``````\n",
    "created_at": "2018-08-24T03:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503807",
    "user": "https://github.com/saraedum"
}
```


**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.
 
-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.
+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. 
 
 This ugly workaround fixes it:
 
@@ -19,3 +19,5 @@
          try:
              # Block SIGCHLD and SIGINT except during the pselect() call
 ```
+
+A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.
``````




---

archive/issue_comments_503808.json:
```json
{
    "body": "<a id='comment:5'></a>\nWhat I want to know is, where is this 160 core machine and can I use it to build sage?",
    "created_at": "2018-08-24T12:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503808",
    "user": "https://github.com/embray"
}
```


<a id='comment:5'></a>
What I want to know is, where is this 160 core machine and can I use it to build sage?



---

archive/issue_comments_503809.json:
```json
{
    "body": "<a id='comment:6'></a>\nI haven't seen this on k8s, though I haven't been using it much recently.",
    "created_at": "2018-08-24T12:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503809",
    "user": "https://github.com/roed314"
}
```


<a id='comment:6'></a>
I haven't seen this on k8s, though I haven't been using it much recently.



---

archive/issue_comments_503810.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [embray](#comment%3A5):\n> What I want to know is, where is this 160 core machine and can I use it to build sage?\n\nI spawned it with the google cloud credits from slelievre. I think they still work for today if you want to play with it.",
    "created_at": "2018-08-24T13:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503810",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:7'></a>
Replying to [embray](#comment%3A5):
> What I want to know is, where is this 160 core machine and can I use it to build sage?

I spawned it with the google cloud credits from slelievre. I think they still work for today if you want to play with it.



---

archive/issue_comments_503811.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [roed](#comment%3A6):\n> I haven't seen this on k8s, though I haven't been using it much recently.\n\nThis seems to be a new issue caused by #24669.",
    "created_at": "2018-08-24T14:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503811",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:8'></a>
Replying to [roed](#comment%3A6):
> I haven't seen this on k8s, though I haven't been using it much recently.

This seems to be a new issue caused by #24669.



---

archive/issue_comments_503812.json:
```json
{
    "body": "<a id='comment:9'></a>\nSee #21323 for some background on `OPENBLAS_NUM_THREADS`.",
    "created_at": "2018-08-24T14:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503812",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:9'></a>
See #21323 for some background on `OPENBLAS_NUM_THREADS`.



---

archive/issue_comments_503813.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,23 +1,9 @@\n Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.\n \n-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. \n+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.\n \n-This ugly workaround fixes it:\n+One workaround `export OPENBLAS_NUM_THREADS=1`.\n \n-```\n---- a/src/sage/doctest/forker.py\n-+++ b/src/sage/doctest/forker.py\n-@@ -1696,6 +1696,9 @@ class DocTestDispatcher(SageObject):\n-         # Logger\n-         log = self.controller.log\n- \n-+        import os\n-+        os.system(\"taskset -p 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffff\n-ffffffffffffffffffffffff %d 2>/dev/null >/dev/null\" % os.getpid())\n-+\n-         from cysignals.pselect import PSelecter\n-         try:\n-             # Block SIGCHLD and SIGINT except during the pselect() call\n-```\n+Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.\n \n-A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.\n+The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq\n``````\n",
    "created_at": "2018-08-24T14:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503813",
    "user": "https://github.com/saraedum"
}
```


**Description changed:**
``````diff
--- 
+++ 
@@ -1,23 +1,9 @@
 Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.
 
-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. 
+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.
 
-This ugly workaround fixes it:
+One workaround `export OPENBLAS_NUM_THREADS=1`.
 
-```
---- a/src/sage/doctest/forker.py
-+++ b/src/sage/doctest/forker.py
-@@ -1696,6 +1696,9 @@ class DocTestDispatcher(SageObject):
-         # Logger
-         log = self.controller.log
- 
-+        import os
-+        os.system("taskset -p 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffff
-ffffffffffffffffffffffff %d 2>/dev/null >/dev/null" % os.getpid())
-+
-         from cysignals.pselect import PSelecter
-         try:
-             # Block SIGCHLD and SIGINT except during the pselect() call
-```
+Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.
 
-A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.
+The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq
``````




---

archive/issue_comments_503814.json:
```json
{
    "body": "<a id='comment:11'></a>\nSetting `export OPENBLAS_MAIN_FREE=1` causes hangs in the \"a tour of Sage\", same as in comment 3.",
    "created_at": "2018-08-24T14:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503814",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:11'></a>
Setting `export OPENBLAS_MAIN_FREE=1` causes hangs in the "a tour of Sage", same as in comment 3.



---

archive/issue_comments_503815.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -7,3 +7,18 @@\n Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.\n \n The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq\n+\n+---\n+\n+Here are some benchmarks:\n+\n+```\n+sage: m=load('/tmp/matrix') # a 500x500 RDF matrix\n+sage: %timeit m.eigenvalues()\n+1 loop, best of 3: 1.78 s per loop # currently\n+1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1\n+```\n+\n+Note that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)\n+\n+I also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.\n``````\n",
    "created_at": "2018-08-24T15:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503815",
    "user": "https://github.com/saraedum"
}
```


**Description changed:**
``````diff
--- 
+++ 
@@ -7,3 +7,18 @@
 Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.
 
 The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq
+
+---
+
+Here are some benchmarks:
+
+```
+sage: m=load('/tmp/matrix') # a 500x500 RDF matrix
+sage: %timeit m.eigenvalues()
+1 loop, best of 3: 1.78 s per loop # currently
+1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1
+```
+
+Note that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)
+
+I also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.
``````




---

archive/issue_comments_503816.json:
```json
{
    "body": "**Author:** Julian R\u00fcth",
    "created_at": "2018-08-24T15:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503816",
    "user": "https://github.com/saraedum"
}
```


**Author:** Julian Rüth



---

archive/issue_comments_503817.json:
```json
{
    "body": "**Branch:** [u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)",
    "created_at": "2018-08-24T15:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503817",
    "user": "https://github.com/saraedum"
}
```


**Branch:** [u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)



---

archive/issue_comments_503818.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-08-24T15:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503818",
    "user": "https://github.com/saraedum"
}
```


**Changing status** from new to needs_review.



---

archive/issue_comments_503819.json:
```json
{
    "body": "<a id='comment:14'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a\">dd20582</a></td><td><code>Set OPENBLAS_NUM_THREADS=1</code></td></tr></table>\n",
    "created_at": "2018-08-24T15:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503819",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:14'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a">dd20582</a></td><td><code>Set OPENBLAS_NUM_THREADS=1</code></td></tr></table>




---

archive/issue_comments_503820.json:
```json
{
    "body": "**Commit:** [dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)",
    "created_at": "2018-08-24T15:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503820",
    "user": "https://github.com/saraedum"
}
```


**Commit:** [dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)



---

archive/issue_comments_503821.json:
```json
{
    "body": "<a id='comment:15'></a>\n`SAGE_NUM_THREADS=160 sage -tp --long --all` btw crashes with segfaults in `gentourng`; that's probably unrelated.\n\n`SAGE_NUM_THREADS=1 SAGE_NUM_THREADS_PARALLEL=160 sage -tp --long --all` works however, and finishes after 4 minutes (which is the time that sage.schemes.elliptic_curves.ell_number_field takes\u2026)\n\nNote that the latter setting would not work without the changes introduced in this ticket (all 160 workers are scheduled on the same core.)",
    "created_at": "2018-08-24T15:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503821",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:15'></a>
`SAGE_NUM_THREADS=160 sage -tp --long --all` btw crashes with segfaults in `gentourng`; that's probably unrelated.

`SAGE_NUM_THREADS=1 SAGE_NUM_THREADS_PARALLEL=160 sage -tp --long --all` works however, and finishes after 4 minutes (which is the time that sage.schemes.elliptic_curves.ell_number_field takes…)

Note that the latter setting would not work without the changes introduced in this ticket (all 160 workers are scheduled on the same core.)



---

archive/issue_comments_503822.json:
```json
{
    "body": "<a id='comment:16'></a>\nIf we decide to set `OPENBLAS_NUM_THREADS=1`, would it be possible to set it within python instead of in `sage-env`? That way it would also work when using `from sage import ...`.",
    "created_at": "2018-08-24T15:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503822",
    "user": "https://github.com/timokau"
}
```


<a id='comment:16'></a>
If we decide to set `OPENBLAS_NUM_THREADS=1`, would it be possible to set it within python instead of in `sage-env`? That way it would also work when using `from sage import ...`.



---

archive/issue_comments_503823.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2018-08-24T16:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503823",
    "user": "https://github.com/embray"
}
```


**Changing status** from needs_review to needs_work.



---

archive/issue_comments_503824.json:
```json
{
    "body": "<a id='comment:17'></a>\nLet us not set this is for all cases; in normal usage it is not a problem, only in the doctests.  And only, it seems, in extreme cases.  I would prefer to find out exactly what the limits are here and limit functionality only near those limits (and to maybe investigate what exactly is going on at those limits and maybe fix the underlying issue).",
    "created_at": "2018-08-24T16:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503824",
    "user": "https://github.com/embray"
}
```


<a id='comment:17'></a>
Let us not set this is for all cases; in normal usage it is not a problem, only in the doctests.  And only, it seems, in extreme cases.  I would prefer to find out exactly what the limits are here and limit functionality only near those limits (and to maybe investigate what exactly is going on at those limits and maybe fix the underlying issue).



---

archive/issue_comments_503825.json:
```json
{
    "body": "<a id='comment:18'></a>\nWhat makes you think this is only a doctest problem?",
    "created_at": "2018-08-24T16:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503825",
    "user": "https://github.com/timokau"
}
```


<a id='comment:18'></a>
What makes you think this is only a doctest problem?



---

archive/issue_comments_503826.json:
```json
{
    "body": "<a id='comment:19'></a>\nYes, please look at my benchmarks above. This is a performance and a stability problem in normal usage.",
    "created_at": "2018-08-24T18:22:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503826",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:19'></a>
Yes, please look at my benchmarks above. This is a performance and a stability problem in normal usage.



---

archive/issue_comments_503827.json:
```json
{
    "body": "**Changing status** from needs_work to positive_review.",
    "created_at": "2018-08-24T22:49:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503827",
    "user": "https://github.com/vbraun"
}
```


**Changing status** from needs_work to positive_review.



---

archive/issue_comments_503828.json:
```json
{
    "body": "<a id='comment:20'></a>\nI've also noted the wrong cpu affinity on the buildbot, it is a major nuisance.",
    "created_at": "2018-08-24T22:49:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503828",
    "user": "https://github.com/vbraun"
}
```


<a id='comment:20'></a>
I've also noted the wrong cpu affinity on the buildbot, it is a major nuisance.



---

archive/issue_comments_503829.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2018-08-24T22:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503829",
    "user": "https://github.com/vbraun"
}
```


**Reviewer:** Volker Braun



---

archive/issue_comments_503830.json:
```json
{
    "body": "**Changing branch** from \"[u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)\" to \"[dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)\".",
    "created_at": "2018-08-25T11:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503830",
    "user": "https://github.com/vbraun"
}
```


**Changing branch** from "[u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)" to "[dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)".



---

archive/issue_events_074028.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-25T11:01:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26118#event-74028"
}
```




---

archive/issue_comments_503831.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2018-08-25T11:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503831",
    "user": "https://github.com/vbraun"
}
```


**Resolution:** fixed



---

archive/issue_comments_503832.json:
```json
{
    "body": "**Changing commit** from \"[dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)\" to \"\".",
    "created_at": "2018-08-29T13:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503832",
    "user": "https://github.com/embray"
}
```


**Changing commit** from "[dd20582d28372ffc38d16444b3f81d5c2885289a](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)" to "".



---

archive/issue_comments_503833.json:
```json
{
    "body": "<a id='comment:23'></a>\nI don't see why you would want to set this for all use cases.  It seems, rather, libraries that use their own multithreading and would conflict with openblas's should explicitly set `openblas_set_num_threads` as in #21323#comment:7\n\nThis just looks like a brute-force workaround for a specific case.",
    "created_at": "2018-08-29T13:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503833",
    "user": "https://github.com/embray"
}
```


<a id='comment:23'></a>
I don't see why you would want to set this for all use cases.  It seems, rather, libraries that use their own multithreading and would conflict with openblas's should explicitly set `openblas_set_num_threads` as in #21323#comment:7

This just looks like a brute-force workaround for a specific case.



---

archive/issue_comments_503834.json:
```json
{
    "body": "<a id='comment:24'></a>\nI there some reliable way to reproduce this problem?  I'm having trouble even doing that, though I'm sure it's possible.",
    "created_at": "2018-08-29T13:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503834",
    "user": "https://github.com/embray"
}
```


<a id='comment:24'></a>
I there some reliable way to reproduce this problem?  I'm having trouble even doing that, though I'm sure it's possible.



---

archive/issue_comments_503835.json:
```json
{
    "body": "<a id='comment:25'></a>\nIt was quite reproducible. But afair the cpu affinity is only set in the course of running the tests, not immediately. Wait until make ptestlong is mostly done and then check the taskset output.",
    "created_at": "2018-08-29T22:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503835",
    "user": "https://github.com/vbraun"
}
```


<a id='comment:25'></a>
It was quite reproducible. But afair the cpu affinity is only set in the course of running the tests, not immediately. Wait until make ptestlong is mostly done and then check the taskset output.



---

archive/issue_comments_503836.json:
```json
{
    "body": "<a id='comment:26'></a>\nI'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in \"normal usage\".  Is there a way to reproduce this problem without having to run `make ptestlong`?\n\nIn any case it sounds like a bug that should be fixed in openblas, not hackishly worked around.  The reason I'm confused is that in the doctests we fork for every test, so I don't see why there would be a problem with thread CPU affinity since from test to test it's not even going to be reusing the same threads.\n\nPerhaps I need to study more carefully what exactly this option is doing in openblas.",
    "created_at": "2018-09-03T10:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503836",
    "user": "https://github.com/embray"
}
```


<a id='comment:26'></a>
I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in "normal usage".  Is there a way to reproduce this problem without having to run `make ptestlong`?

In any case it sounds like a bug that should be fixed in openblas, not hackishly worked around.  The reason I'm confused is that in the doctests we fork for every test, so I don't see why there would be a problem with thread CPU affinity since from test to test it's not even going to be reusing the same threads.

Perhaps I need to study more carefully what exactly this option is doing in openblas.



---

archive/issue_comments_503837.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [embray](#comment%3A26):\n> I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in \"normal usage\".  Is there a way to reproduce this problem without having to run `make ptestlong`?\n\n\nYes, see ticket description.",
    "created_at": "2018-09-03T10:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503837",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:27'></a>
Replying to [embray](#comment%3A26):
> I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in "normal usage".  Is there a way to reproduce this problem without having to run `make ptestlong`?


Yes, see ticket description.



---

archive/issue_comments_503838.json:
```json
{
    "body": "<a id='comment:28'></a>\nI see; it's nothing to do with thread CPU affinity at all, but process CPU affinity.  The mention of `OPENBLAS_NUM_THREADS=1` had me thinking this was something about threads.  That makes more sense.\n\nWhat's weird is that `gotoblas_affinity_init()` still sets up a new CPU affinity mask and installs it with `sched_setaffinity()`--does some stuff I don't understand--and *then* if `OPENBLAS_MAIN_FREE=1` and only if, calls `sched_setaffinity()` again to set it back to the original mask.",
    "created_at": "2018-09-03T10:33:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503838",
    "user": "https://github.com/embray"
}
```


<a id='comment:28'></a>
I see; it's nothing to do with thread CPU affinity at all, but process CPU affinity.  The mention of `OPENBLAS_NUM_THREADS=1` had me thinking this was something about threads.  That makes more sense.

What's weird is that `gotoblas_affinity_init()` still sets up a new CPU affinity mask and installs it with `sched_setaffinity()`--does some stuff I don't understand--and *then* if `OPENBLAS_MAIN_FREE=1` and only if, calls `sched_setaffinity()` again to set it back to the original mask.



---

archive/issue_comments_503839.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [saraedum](#comment%3A27):\n> Replying to [embray](#comment%3A26):\n> > I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in \"normal usage\".  Is there a way to reproduce this problem without having to run `make ptestlong`?\n\n> \n> Yes, see ticket description.\n\n\nI tried that, but there was only one time I was able to get a kind of slow result, and I think I deleted that matrix.  Now, no matter how many times I try to create a random matrix, I seem to be getting ones whose eigenvalues are solved very quickly and I barely see any problem.  Perhaps I need some specific matrix that exhibits the problem.\n\nAnyways, now that I've looked at the openblas code I have no problem with this workaround.  I want to understand the code in openblas a bit better, but I agree that for the purposes of Sage we don't have any reason for openblas to mess with CPU affinity.  Perhaps we should even build Sage's openblas with `NO_AFFINITY=1` (but keep the environment variable set for non-Sage builds of openblas).",
    "created_at": "2018-09-03T10:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503839",
    "user": "https://github.com/embray"
}
```


<a id='comment:29'></a>
Replying to [saraedum](#comment%3A27):
> Replying to [embray](#comment%3A26):
> > I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in "normal usage".  Is there a way to reproduce this problem without having to run `make ptestlong`?

> 
> Yes, see ticket description.


I tried that, but there was only one time I was able to get a kind of slow result, and I think I deleted that matrix.  Now, no matter how many times I try to create a random matrix, I seem to be getting ones whose eigenvalues are solved very quickly and I barely see any problem.  Perhaps I need some specific matrix that exhibits the problem.

Anyways, now that I've looked at the openblas code I have no problem with this workaround.  I want to understand the code in openblas a bit better, but I agree that for the purposes of Sage we don't have any reason for openblas to mess with CPU affinity.  Perhaps we should even build Sage's openblas with `NO_AFFINITY=1` (but keep the environment variable set for non-Sage builds of openblas).



---

archive/issue_comments_503840.json:
```json
{
    "body": "<a id='comment:30'></a>\nI'm surprised `OPENBLAS_NUM_THREADS=1` didn't work for you:\n\n```c\n#ifdef USE_OPENMP\n  numprocs = 0;\n#else\n  numprocs = readenv_atoi(\"OPENBLAS_NUM_THREADS\");\n  if (numprocs == 0) numprocs = readenv_atoi(\"GOTO_NUM_THREADS\");\n#endif\n\n  if (numprocs == 0) numprocs = readenv_atoi(\"OMP_NUM_THREADS\");\n\n  numnodes = 1;\n\n  if (numprocs == 1) {\n    disable_mapping = 1;\n    return;\n  }\n```",
    "created_at": "2018-09-03T10:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503840",
    "user": "https://github.com/embray"
}
```


<a id='comment:30'></a>
I'm surprised `OPENBLAS_NUM_THREADS=1` didn't work for you:

```c
#ifdef USE_OPENMP
  numprocs = 0;
#else
  numprocs = readenv_atoi("OPENBLAS_NUM_THREADS");
  if (numprocs == 0) numprocs = readenv_atoi("GOTO_NUM_THREADS");
#endif

  if (numprocs == 0) numprocs = readenv_atoi("OMP_NUM_THREADS");

  numnodes = 1;

  if (numprocs == 1) {
    disable_mapping = 1;
    return;
  }
```



---

archive/issue_comments_503841.json:
```json
{
    "body": "<a id='comment:31'></a>\nSorry, I don't understand what you mean with \"didn't work for you\".",
    "created_at": "2018-09-03T10:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503841",
    "user": "https://github.com/saraedum"
}
```


<a id='comment:31'></a>
Sorry, I don't understand what you mean with "didn't work for you".



---

archive/issue_comments_503842.json:
```json
{
    "body": "<a id='comment:32'></a>\nNevermind, apparently it did: #26118#comment:4\nI misread something else.",
    "created_at": "2018-09-03T11:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26118#issuecomment-503842",
    "user": "https://github.com/embray"
}
```


<a id='comment:32'></a>
Nevermind, apparently it did: #26118#comment:4
I misread something else.
