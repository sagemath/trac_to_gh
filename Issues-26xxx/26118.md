# Issue 26118: sage -tp times out on a 160 core machine

archive/issues_025881.json:
```json
{
    "assignees": [],
    "body": "Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.\n\nIt turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.\n\nOne workaround `export OPENBLAS_NUM_THREADS=1`.\n\nOr we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.\n\nThe FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq\n\n---\n\nHere are some benchmarks:\n\n```\nsage: m=load('/tmp/matrix') # a 500x500 RDF matrix\nsage: %timeit m.eigenvalues()\n1 loop, best of 3: 1.78 s per loop # currently\n1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1\n```\n\nNote that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)\n\nI also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.\n\nCC:  @slel @roed314\n\nBranch: **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)**\n\nReviewer: **Volker Braun**\n\nAuthor: **Julian R\u00fcth**\n\nComponent: **doctest framework**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26118_\n\n",
    "closed_at": "2018-08-25T11:01:27Z",
    "created_at": "2018-08-24T02:32:11Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage -tp times out on a 160 core machine",
    "type": "issue",
    "updated_at": "2018-09-03T11:03:24Z",
    "url": "https://github.com/sagemath/sage/issues/26118",
    "user": "https://github.com/saraedum"
}
```
Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.

It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.

One workaround `export OPENBLAS_NUM_THREADS=1`.

Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.

The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq

---

Here are some benchmarks:

```
sage: m=load('/tmp/matrix') # a 500x500 RDF matrix
sage: %timeit m.eigenvalues()
1 loop, best of 3: 1.78 s per loop # currently
1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1
```

Note that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)

I also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.

CC:  @slel @roed314

Branch: **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)**

Reviewer: **Volker Braun**

Author: **Julian Rüth**

Component: **doctest framework**

_Issue created by migration from https://trac.sagemath.org/ticket/26118_





---

archive/issue_events_357510.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-08-24T02:32:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357510"
}
```



---

archive/issue_events_357511.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-08-24T02:32:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20doctest%20framework",
    "label_color": "0000b0",
    "label_name": "c: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357511"
}
```



---

archive/issue_events_357512.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-08-24T02:32:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20minor%20/%204",
    "label_color": "ffe799",
    "label_name": "p: minor / 4",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357512"
}
```



---

archive/issue_events_357513.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-08-24T02:32:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357513"
}
```



---

archive/issue_comments_402370.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,11 +3,12 @@\n It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.\n \n This ugly workaround fixes it:\n+\n ```\n --- a/src/sage/doctest/forker.py\n +++ b/src/sage/doctest/forker.py\n @@ -1696,6 +1696,9 @@ class DocTestDispatcher(SageObject):\n-         \\# Logger\n+         # Logger\n          log = self.controller.log\n  \n +        import os\n@@ -16,5 +17,5 @@\n +\n          from cysignals.pselect import PSelecter\n          try:\n-             \\# Block SIGCHLD and SIGINT except during the pselect() call\n+             # Block SIGCHLD and SIGINT except during the pselect() call\n ```\n``````\n",
    "created_at": "2018-08-24T02:32:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402370",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,11 +3,12 @@
 It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.
 
 This ugly workaround fixes it:
+
 ```
 --- a/src/sage/doctest/forker.py
 +++ b/src/sage/doctest/forker.py
 @@ -1696,6 +1696,9 @@ class DocTestDispatcher(SageObject):
-         \# Logger
+         # Logger
          log = self.controller.log
  
 +        import os
@@ -16,5 +17,5 @@
 +
          from cysignals.pselect import PSelecter
          try:
-             \# Block SIGCHLD and SIGINT except during the pselect() call
+             # Block SIGCHLD and SIGINT except during the pselect() call
 ```
``````




---

archive/issue_comments_402371.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nroed: As you are often working on k8s. Does this also happen there?",
    "created_at": "2018-08-24T02:32:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402371",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:2" align="right">comment:2</div>

roed: As you are often working on k8s. Does this also happen there?



---

archive/issue_comments_402372.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nWith an initial workaround, that set the CPU affinity before forking:\n\nBtw., with that workaround often the following part of the \"A tour of Sage\" in all languages hangs:\n\n```\nTrying (line 99):    m = random_matrix(RDF,500)\nExpecting nothing\nok [0.09 s]\nTrying (line 108):    e = m.eigenvalues()  # ungef\u00e4hr 2 Sekunden\nExpecting nothing\n```\n\nSo maybe this has something to do with some BLAS?",
    "created_at": "2018-08-24T02:48:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402372",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:3" align="right">comment:3</div>

With an initial workaround, that set the CPU affinity before forking:

Btw., with that workaround often the following part of the "A tour of Sage" in all languages hangs:

```
Trying (line 99):    m = random_matrix(RDF,500)
Expecting nothing
ok [0.09 s]
Trying (line 108):    e = m.eigenvalues()  # ungefähr 2 Sekunden
Expecting nothing
```

So maybe this has something to do with some BLAS?



---

archive/issue_comments_402373.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThe hangs do not happen anymore with `OPENBLAS_NUM_THREADS=1` and `sage -tp --all` finishes in 2:29 minutes (which is the time it takes to run the tests in `sage.manifolds.differentiable.tensorfield`).",
    "created_at": "2018-08-24T03:01:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402373",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:4" align="right">comment:4</div>

The hangs do not happen anymore with `OPENBLAS_NUM_THREADS=1` and `sage -tp --all` finishes in 2:29 minutes (which is the time it takes to run the tests in `sage.manifolds.differentiable.tensorfield`).



---

archive/issue_comments_402374.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.\n \n-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.\n+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. \n \n This ugly workaround fixes it:\n \n@@ -19,3 +19,5 @@\n          try:\n              # Block SIGCHLD and SIGINT except during the pselect() call\n ```\n+\n+A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.\n``````\n",
    "created_at": "2018-08-24T03:01:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402374",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.
 
-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. I've read some reports online that numpy sets that affinity.
+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. 
 
 This ugly workaround fixes it:
 
@@ -19,3 +19,5 @@
          try:
              # Block SIGCHLD and SIGINT except during the pselect() call
 ```
+
+A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.
``````




---

archive/issue_comments_402375.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWhat I want to know is, where is this 160 core machine and can I use it to build sage?",
    "created_at": "2018-08-24T12:57:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402375",
    "user": "https://github.com/embray"
}
```

<div id="comment:5" align="right">comment:5</div>

What I want to know is, where is this 160 core machine and can I use it to build sage?



---

archive/issue_comments_402376.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI haven't seen this on k8s, though I haven't been using it much recently.",
    "created_at": "2018-08-24T12:59:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402376",
    "user": "https://github.com/roed314"
}
```

<div id="comment:6" align="right">comment:6</div>

I haven't seen this on k8s, though I haven't been using it much recently.



---

archive/issue_comments_402377.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@embray](#comment%3A5):\n> What I want to know is, where is this 160 core machine and can I use it to build sage?\n\nI spawned it with the google cloud credits from slelievre. I think they still work for today if you want to play with it.",
    "created_at": "2018-08-24T13:02:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402377",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@embray](#comment%3A5):
> What I want to know is, where is this 160 core machine and can I use it to build sage?

I spawned it with the google cloud credits from slelievre. I think they still work for today if you want to play with it.



---

archive/issue_comments_402378.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@roed314](#comment%3A6):\n> I haven't seen this on k8s, though I haven't been using it much recently.\n\nThis seems to be a new issue caused by #24669.",
    "created_at": "2018-08-24T14:32:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402378",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@roed314](#comment%3A6):
> I haven't seen this on k8s, though I haven't been using it much recently.

This seems to be a new issue caused by #24669.



---

archive/issue_comments_402379.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nSee #21323 for some background on `OPENBLAS_NUM_THREADS`.",
    "created_at": "2018-08-24T14:42:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402379",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:9" align="right">comment:9</div>

See #21323 for some background on `OPENBLAS_NUM_THREADS`.



---

archive/issue_comments_402380.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,23 +1,9 @@\n Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.\n \n-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. \n+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.\n \n-This ugly workaround fixes it:\n+One workaround `export OPENBLAS_NUM_THREADS=1`.\n \n-```\n---- a/src/sage/doctest/forker.py\n-+++ b/src/sage/doctest/forker.py\n-@@ -1696,6 +1696,9 @@ class DocTestDispatcher(SageObject):\n-         # Logger\n-         log = self.controller.log\n- \n-+        import os\n-+        os.system(\"taskset -p 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffff\n-ffffffffffffffffffffffff %d 2>/dev/null >/dev/null\" % os.getpid())\n-+\n-         from cysignals.pselect import PSelecter\n-         try:\n-             # Block SIGCHLD and SIGINT except during the pselect() call\n-```\n+Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.\n \n-A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.\n+The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq\n``````\n",
    "created_at": "2018-08-24T14:50:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402380",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,23 +1,9 @@
 Strangely `SAGE_NUM_THREADS=160 sage -tp --long --all` produces lots of timeouts on a 160 core machine.
 
-It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity. 
+It turns out that only a few cores are actually used (three or four most of the time) which seems to be related to the set CPU affinity.
 
-This ugly workaround fixes it:
+One workaround `export OPENBLAS_NUM_THREADS=1`.
 
-```
---- a/src/sage/doctest/forker.py
-+++ b/src/sage/doctest/forker.py
-@@ -1696,6 +1696,9 @@ class DocTestDispatcher(SageObject):
-         # Logger
-         log = self.controller.log
- 
-+        import os
-+        os.system("taskset -p 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffff
-ffffffffffffffffffffffff %d 2>/dev/null >/dev/null" % os.getpid())
-+
-         from cysignals.pselect import PSelecter
-         try:
-             # Block SIGCHLD and SIGINT except during the pselect() call
-```
+Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.
 
-A better workaround, turned out to be setting `OPENBLAS_NUM_THREADS=1`.
+The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq
``````




---

archive/issue_comments_402381.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nSetting `export OPENBLAS_MAIN_FREE=1` causes hangs in the \"a tour of Sage\", same as in comment 3.",
    "created_at": "2018-08-24T14:53:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402381",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:11" align="right">comment:11</div>

Setting `export OPENBLAS_MAIN_FREE=1` causes hangs in the "a tour of Sage", same as in comment 3.



---

archive/issue_comments_402382.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,3 +7,18 @@\n Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.\n \n The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq\n+\n+---\n+\n+Here are some benchmarks:\n+\n+```\n+sage: m=load('/tmp/matrix') # a 500x500 RDF matrix\n+sage: %timeit m.eigenvalues()\n+1 loop, best of 3: 1.78 s per loop # currently\n+1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1\n+```\n+\n+Note that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)\n+\n+I also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.\n``````\n",
    "created_at": "2018-08-24T15:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402382",
    "user": "https://github.com/saraedum"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,3 +7,18 @@
 Or we could `export OPENBLAS_MAIN_FREE=1` to disable OPENBLAS' threading affinity.
 
 The FAQ explains what these options do: https://github.com/xianyi/OpenBLAS/wiki/faq
+
+---
+
+Here are some benchmarks:
+
+```
+sage: m=load('/tmp/matrix') # a 500x500 RDF matrix
+sage: %timeit m.eigenvalues()
+1 loop, best of 3: 1.78 s per loop # currently
+1 loop, best of 3: 911 ms per loop # with OPENBLAS_NUM_THREADS=1
+```
+
+Note that the first one causes 100% load on 130 of the 160 cores and the second one only causes 100% load on a single core. (Yes, it's faster anyway.)
+
+I also tried with all sorts of combinations of SAGE_NUM_THREADS*, OPENBLAS_MAIN_FREE and always got around 1.8s and 100% load on 130 cores. I'v sometimes seen segfaults that were not reproducible but never with OPENBLAS_NUM_THREADS=1.
``````




---

archive/issue_comments_402383.json:
```json
{
    "body": "Author: **Julian R\u00fcth**",
    "created_at": "2018-08-24T15:19:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402383",
    "user": "https://github.com/saraedum"
}
```

Author: **Julian Rüth**



---

archive/issue_comments_402384.json:
```json
{
    "body": "Branch: **[u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)**",
    "created_at": "2018-08-24T15:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402384",
    "user": "https://github.com/saraedum"
}
```

Branch: **[u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)**



---

archive/issue_events_357514.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-08-24T15:21:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357514"
}
```



---

archive/issue_comments_402385.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a\"><code>dd20582</code></a></td><td><code>Set OPENBLAS_NUM_THREADS=1</code></td></tr></table>\n",
    "created_at": "2018-08-24T15:21:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402385",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:14"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a"><code>dd20582</code></a></td><td><code>Set OPENBLAS_NUM_THREADS=1</code></td></tr></table>




---

archive/issue_comments_402386.json:
```json
{
    "body": "Commit: **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)**",
    "created_at": "2018-08-24T15:21:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402386",
    "user": "https://github.com/saraedum"
}
```

Commit: **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)**



---

archive/issue_comments_402387.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\n`SAGE_NUM_THREADS=160 sage -tp --long --all` btw crashes with segfaults in `gentourng`; that's probably unrelated.\n\n`SAGE_NUM_THREADS=1 SAGE_NUM_THREADS_PARALLEL=160 sage -tp --long --all` works however, and finishes after 4 minutes (which is the time that sage.schemes.elliptic_curves.ell_number_field takes\u2026)\n\nNote that the latter setting would not work without the changes introduced in this ticket (all 160 workers are scheduled on the same core.)",
    "created_at": "2018-08-24T15:42:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402387",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:15" align="right">comment:15</div>

`SAGE_NUM_THREADS=160 sage -tp --long --all` btw crashes with segfaults in `gentourng`; that's probably unrelated.

`SAGE_NUM_THREADS=1 SAGE_NUM_THREADS_PARALLEL=160 sage -tp --long --all` works however, and finishes after 4 minutes (which is the time that sage.schemes.elliptic_curves.ell_number_field takes…)

Note that the latter setting would not work without the changes introduced in this ticket (all 160 workers are scheduled on the same core.)



---

archive/issue_comments_402388.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nIf we decide to set `OPENBLAS_NUM_THREADS=1`, would it be possible to set it within python instead of in `sage-env`? That way it would also work when using `from sage import ...`.",
    "created_at": "2018-08-24T15:42:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402388",
    "user": "https://github.com/timokau"
}
```

<div id="comment:16" align="right">comment:16</div>

If we decide to set `OPENBLAS_NUM_THREADS=1`, would it be possible to set it within python instead of in `sage-env`? That way it would also work when using `from sage import ...`.



---

archive/issue_events_357515.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-24T16:41:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357515"
}
```



---

archive/issue_events_357516.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-24T16:41:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357516"
}
```



---

archive/issue_comments_402389.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nLet us not set this is for all cases; in normal usage it is not a problem, only in the doctests.  And only, it seems, in extreme cases.  I would prefer to find out exactly what the limits are here and limit functionality only near those limits (and to maybe investigate what exactly is going on at those limits and maybe fix the underlying issue).",
    "created_at": "2018-08-24T16:41:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402389",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

Let us not set this is for all cases; in normal usage it is not a problem, only in the doctests.  And only, it seems, in extreme cases.  I would prefer to find out exactly what the limits are here and limit functionality only near those limits (and to maybe investigate what exactly is going on at those limits and maybe fix the underlying issue).



---

archive/issue_comments_402390.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nWhat makes you think this is only a doctest problem?",
    "created_at": "2018-08-24T16:43:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402390",
    "user": "https://github.com/timokau"
}
```

<div id="comment:18" align="right">comment:18</div>

What makes you think this is only a doctest problem?



---

archive/issue_comments_402391.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nYes, please look at my benchmarks above. This is a performance and a stability problem in normal usage.",
    "created_at": "2018-08-24T18:22:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402391",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:19" align="right">comment:19</div>

Yes, please look at my benchmarks above. This is a performance and a stability problem in normal usage.



---

archive/issue_events_357517.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-24T22:49:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357517"
}
```



---

archive/issue_events_357518.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-24T22:49:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357518"
}
```



---

archive/issue_comments_402392.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI've also noted the wrong cpu affinity on the buildbot, it is a major nuisance.",
    "created_at": "2018-08-24T22:49:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402392",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:20" align="right">comment:20</div>

I've also noted the wrong cpu affinity on the buildbot, it is a major nuisance.



---

archive/issue_comments_402393.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2018-08-24T22:49:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402393",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun**



---

archive/issue_comments_402394.json:
```json
{
    "body": "Changed branch from **[u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)** to **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)**",
    "created_at": "2018-08-25T11:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402394",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/saraedum/26118](https://github.com/sagemath/sagetrac-mirror/tree/u/saraedum/26118)** to **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)**



---

archive/issue_events_357519.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-25T11:01:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357519"
}
```



---

archive/issue_events_357520.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "e83762e05124bd0f9630462833046e295dc057ab",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-08-25T11:01:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26118#event-357520"
}
```



---

archive/issue_comments_402395.json:
```json
{
    "body": "Changed commit from **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)** to none",
    "created_at": "2018-08-29T13:41:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402395",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`dd20582`](https://github.com/sagemath/sagetrac-mirror/commit/dd20582d28372ffc38d16444b3f81d5c2885289a)** to none



---

archive/issue_comments_402396.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI don't see why you would want to set this for all use cases.  It seems, rather, libraries that use their own multithreading and would conflict with openblas's should explicitly set `openblas_set_num_threads` as in [#21323 comment:7](https://github.com/sagemath/sage/issues/21323#comment:7)\n\nThis just looks like a brute-force workaround for a specific case.",
    "created_at": "2018-08-29T13:41:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402396",
    "user": "https://github.com/embray"
}
```

<div id="comment:23" align="right">comment:23</div>

I don't see why you would want to set this for all use cases.  It seems, rather, libraries that use their own multithreading and would conflict with openblas's should explicitly set `openblas_set_num_threads` as in [#21323 comment:7](https://github.com/sagemath/sage/issues/21323#comment:7)

This just looks like a brute-force workaround for a specific case.



---

archive/issue_comments_402397.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI there some reliable way to reproduce this problem?  I'm having trouble even doing that, though I'm sure it's possible.",
    "created_at": "2018-08-29T13:52:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402397",
    "user": "https://github.com/embray"
}
```

<div id="comment:24" align="right">comment:24</div>

I there some reliable way to reproduce this problem?  I'm having trouble even doing that, though I'm sure it's possible.



---

archive/issue_comments_402398.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nIt was quite reproducible. But afair the cpu affinity is only set in the course of running the tests, not immediately. Wait until make ptestlong is mostly done and then check the taskset output.",
    "created_at": "2018-08-29T22:36:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402398",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:25" align="right">comment:25</div>

It was quite reproducible. But afair the cpu affinity is only set in the course of running the tests, not immediately. Wait until make ptestlong is mostly done and then check the taskset output.



---

archive/issue_comments_402399.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nI'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in \"normal usage\".  Is there a way to reproduce this problem without having to run `make ptestlong`?\n\nIn any case it sounds like a bug that should be fixed in openblas, not hackishly worked around.  The reason I'm confused is that in the doctests we fork for every test, so I don't see why there would be a problem with thread CPU affinity since from test to test it's not even going to be reusing the same threads.\n\nPerhaps I need to study more carefully what exactly this option is doing in openblas.",
    "created_at": "2018-09-03T10:21:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402399",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">comment:26</div>

I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in "normal usage".  Is there a way to reproduce this problem without having to run `make ptestlong`?

In any case it sounds like a bug that should be fixed in openblas, not hackishly worked around.  The reason I'm confused is that in the doctests we fork for every test, so I don't see why there would be a problem with thread CPU affinity since from test to test it's not even going to be reusing the same threads.

Perhaps I need to study more carefully what exactly this option is doing in openblas.



---

archive/issue_comments_402400.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@embray](#comment%3A26):\n> I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in \"normal usage\".  Is there a way to reproduce this problem without having to run `make ptestlong`?\n\nYes, see ticket description.",
    "created_at": "2018-09-03T10:25:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402400",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@embray](#comment%3A26):
> I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in "normal usage".  Is there a way to reproduce this problem without having to run `make ptestlong`?

Yes, see ticket description.



---

archive/issue_comments_402401.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI see; it's nothing to do with thread CPU affinity at all, but process CPU affinity.  The mention of `OPENBLAS_NUM_THREADS=1` had me thinking this was something about threads.  That makes more sense.\n\nWhat's weird is that `gotoblas_affinity_init()` still sets up a new CPU affinity mask and installs it with `sched_setaffinity()`--does some stuff I don't understand--and *then* if `OPENBLAS_MAIN_FREE=1` and only if, calls `sched_setaffinity()` again to set it back to the original mask.",
    "created_at": "2018-09-03T10:33:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402401",
    "user": "https://github.com/embray"
}
```

<div id="comment:28" align="right">comment:28</div>

I see; it's nothing to do with thread CPU affinity at all, but process CPU affinity.  The mention of `OPENBLAS_NUM_THREADS=1` had me thinking this was something about threads.  That makes more sense.

What's weird is that `gotoblas_affinity_init()` still sets up a new CPU affinity mask and installs it with `sched_setaffinity()`--does some stuff I don't understand--and *then* if `OPENBLAS_MAIN_FREE=1` and only if, calls `sched_setaffinity()` again to set it back to the original mask.



---

archive/issue_comments_402402.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@saraedum](#comment%3A27):\n> Replying to [@embray](#comment%3A26):\n> > I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in \"normal usage\".  Is there a way to reproduce this problem without having to run `make ptestlong`?\n\n> \n> Yes, see ticket description.\n\nI tried that, but there was only one time I was able to get a kind of slow result, and I think I deleted that matrix.  Now, no matter how many times I try to create a random matrix, I seem to be getting ones whose eigenvalues are solved very quickly and I barely see any problem.  Perhaps I need some specific matrix that exhibits the problem.\n\nAnyways, now that I've looked at the openblas code I have no problem with this workaround.  I want to understand the code in openblas a bit better, but I agree that for the purposes of Sage we don't have any reason for openblas to mess with CPU affinity.  Perhaps we should even build Sage's openblas with `NO_AFFINITY=1` (but keep the environment variable set for non-Sage builds of openblas).",
    "created_at": "2018-09-03T10:41:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402402",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@saraedum](#comment%3A27):
> Replying to [@embray](#comment%3A26):
> > I'm not sure what I'm looking for here.  Julian suggested that it's a problem that occurs in "normal usage".  Is there a way to reproduce this problem without having to run `make ptestlong`?

> 
> Yes, see ticket description.

I tried that, but there was only one time I was able to get a kind of slow result, and I think I deleted that matrix.  Now, no matter how many times I try to create a random matrix, I seem to be getting ones whose eigenvalues are solved very quickly and I barely see any problem.  Perhaps I need some specific matrix that exhibits the problem.

Anyways, now that I've looked at the openblas code I have no problem with this workaround.  I want to understand the code in openblas a bit better, but I agree that for the purposes of Sage we don't have any reason for openblas to mess with CPU affinity.  Perhaps we should even build Sage's openblas with `NO_AFFINITY=1` (but keep the environment variable set for non-Sage builds of openblas).



---

archive/issue_comments_402403.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nI'm surprised `OPENBLAS_NUM_THREADS=1` didn't work for you:\n\n```c\n#ifdef USE_OPENMP\n  numprocs = 0;\n#else\n  numprocs = readenv_atoi(\"OPENBLAS_NUM_THREADS\");\n  if (numprocs == 0) numprocs = readenv_atoi(\"GOTO_NUM_THREADS\");\n#endif\n\n  if (numprocs == 0) numprocs = readenv_atoi(\"OMP_NUM_THREADS\");\n\n  numnodes = 1;\n\n  if (numprocs == 1) {\n    disable_mapping = 1;\n    return;\n  }\n```",
    "created_at": "2018-09-03T10:51:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402403",
    "user": "https://github.com/embray"
}
```

<div id="comment:30" align="right">comment:30</div>

I'm surprised `OPENBLAS_NUM_THREADS=1` didn't work for you:

```c
#ifdef USE_OPENMP
  numprocs = 0;
#else
  numprocs = readenv_atoi("OPENBLAS_NUM_THREADS");
  if (numprocs == 0) numprocs = readenv_atoi("GOTO_NUM_THREADS");
#endif

  if (numprocs == 0) numprocs = readenv_atoi("OMP_NUM_THREADS");

  numnodes = 1;

  if (numprocs == 1) {
    disable_mapping = 1;
    return;
  }
```



---

archive/issue_comments_402404.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nSorry, I don't understand what you mean with \"didn't work for you\".",
    "created_at": "2018-09-03T10:55:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402404",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:31" align="right">comment:31</div>

Sorry, I don't understand what you mean with "didn't work for you".



---

archive/issue_comments_402405.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nNevermind, apparently it did: [#26118 comment:4](https://github.com/sagemath/sage/issues/26118#comment:4)\nI misread something else.",
    "created_at": "2018-09-03T11:03:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26118#issuecomment-402405",
    "user": "https://github.com/embray"
}
```

<div id="comment:32" align="right">comment:32</div>

Nevermind, apparently it did: [#26118 comment:4](https://github.com/sagemath/sage/issues/26118#comment:4)
I misread something else.
