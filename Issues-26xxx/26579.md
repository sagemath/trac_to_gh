# Issue 26579: Fix ecl.pyx doctests with threaded ecl

archive/issues_026342.json:
```json
{
    "assignees": [],
    "body": "Make ecl.pyx tests pass when ecl is built with threads support. Fixes one test suite failure on Arch.\n\nCC:  @kiwifb @timokau @saraedum\n\nKeywords: **packaging**\n\nBranch: **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)**\n\nReviewer: **Fran\u00e7ois Bissey**\n\nAuthor: **Antonio Rojas**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26579_\n\n",
    "closed_at": "2018-11-04T10:38:48Z",
    "created_at": "2018-10-28T10:32:04Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20distribution",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix ecl.pyx doctests with threaded ecl",
    "type": "issue",
    "updated_at": "2018-11-04T10:38:48Z",
    "url": "https://github.com/sagemath/sage/issues/26579",
    "user": "https://github.com/antonio-rojas"
}
```
Make ecl.pyx tests pass when ecl is built with threads support. Fixes one test suite failure on Arch.

CC:  @kiwifb @timokau @saraedum

Keywords: **packaging**

Branch: **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)**

Reviewer: **François Bissey**

Author: **Antonio Rojas**

_Issue created by migration from https://trac.sagemath.org/ticket/26579_





---

archive/issue_events_347762.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2018-10-28T10:32:04Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347762"
}
```



---

archive/issue_events_347763.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2018-10-28T10:32:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347763"
}
```



---

archive/issue_comments_412440.json:
```json
{
    "body": "Branch: **[u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl)**",
    "created_at": "2018-10-28T10:32:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412440",
    "user": "https://github.com/antonio-rojas"
}
```

Branch: **[u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl)**



---

archive/issue_comments_412441.json:
```json
{
    "body": "Commit: **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)**",
    "created_at": "2018-10-28T10:36:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412441",
    "user": "https://github.com/antonio-rojas"
}
```

Commit: **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)**



---

archive/issue_comments_412442.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4\">1f4794c</a></td><td><code>Fix doctest with thread-enabled ecl</code></td></tr></table>\n",
    "created_at": "2018-10-28T10:36:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412442",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:2" align="right">Comment 2</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4">1f4794c</a></td><td><code>Fix doctest with thread-enabled ecl</code></td></tr></table>




---

archive/issue_comments_412443.json:
```json
{
    "body": "Author: **Antonio Rojas**",
    "created_at": "2018-10-28T10:36:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412443",
    "user": "https://github.com/antonio-rojas"
}
```

Author: **Antonio Rojas**



---

archive/issue_comments_412444.json:
```json
{
    "body": "Changed keywords from none to **packaging**",
    "created_at": "2018-10-28T10:36:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412444",
    "user": "https://github.com/antonio-rojas"
}
```

Changed keywords from none to **packaging**



---

archive/issue_events_347764.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2018-10-28T10:36:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347764"
}
```



---

archive/issue_events_347765.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2018-10-28T10:36:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347765"
}
```



---

archive/issue_comments_412445.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+Make ecl.pyx tests pass when ecl is built with threads support. Fixes one test suite failure on Arch.\n``````\n",
    "created_at": "2018-10-28T10:36:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412445",
    "user": "https://github.com/antonio-rojas"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+Make ecl.pyx tests pass when ecl is built with threads support. Fixes one test suite failure on Arch.
``````




---

archive/issue_events_347766.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2018-10-28T10:36:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20distribution",
    "label_color": "000080",
    "label_name": "component: distribution",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347766"
}
```



---

archive/issue_comments_412446.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2018-10-28T20:05:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412446",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **François Bissey**



---

archive/issue_events_347767.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-10-28T20:05:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347767"
}
```



---

archive/issue_events_347768.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-10-28T20:05:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347768"
}
```



---

archive/issue_comments_412447.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nFeels like something I have seen before. Anyway the fix in question is extremely minor and  is at the level of a typo correction.",
    "created_at": "2018-10-28T20:05:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412447",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:3" align="right">Comment 3</div>

Feels like something I have seen before. Anyway the fix in question is extremely minor and  is at the level of a typo correction.



---

archive/issue_comments_412448.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nAt least a while ago, running ecllib in sage with thread support was rather fundamentally not possible: when threads are enabled, ecl will have a separate thread for signal handling (and garbage collection). Furthermore, it will use some very strange signals for syncing processes around garbage collection.\n\nSage will swap signal handlers when entering/exiting ecllib. That's fundamentally incompatible with a multi-threaded approach.\n\nI think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).",
    "created_at": "2018-10-28T20:42:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412448",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">Comment 4</div>

At least a while ago, running ecllib in sage with thread support was rather fundamentally not possible: when threads are enabled, ecl will have a separate thread for signal handling (and garbage collection). Furthermore, it will use some very strange signals for syncing processes around garbage collection.

Sage will swap signal handlers when entering/exiting ecllib. That's fundamentally incompatible with a multi-threaded approach.

I think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).



---

archive/issue_events_347769.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2018-10-28T20:42:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347769"
}
```



---

archive/issue_events_347770.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2018-10-28T20:42:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347770"
}
```



---

archive/issue_comments_412449.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nReplying to [@nbruin](#comment%3A4):\n> I think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).\n\nI don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.\n\nIf there are concerns about possible issues with threaded ecl (of which I'm not aware after having packaged Sage for 4 years) they should be addressed elsewhere by adding appropriate tests for the actual issues. Again, I don't understand why they should prevent merging this.",
    "created_at": "2018-10-29T20:41:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412449",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:5" align="right">Comment 5</div>

Replying to [@nbruin](#comment%3A4):
> I think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).

I don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.

If there are concerns about possible issues with threaded ecl (of which I'm not aware after having packaged Sage for 4 years) they should be addressed elsewhere by adding appropriate tests for the actual issues. Again, I don't understand why they should prevent merging this.



---

archive/issue_comments_412450.json:
```json
{
    "body": "Changed branch from **[u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl)** to **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)**",
    "created_at": "2018-10-29T22:46:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412450",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl](https://github.com/sagemath/sagetrac-mirror/tree/u/arojas/fix_ecl_pyx_doctests_with_threaded_ecl)** to **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)**



---

archive/issue_events_347771.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-10-29T22:46:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347771"
}
```



---

archive/issue_events_347772.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "5eacadc0b1b50580d33adeed846e802155f08ce5",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-10-29T22:46:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347772"
}
```



---

archive/issue_comments_412451.json:
```json
{
    "body": "Changed commit from **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)** to none",
    "created_at": "2018-10-29T22:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412451",
    "user": "https://github.com/vbraun"
}
```

Changed commit from **[1f4794c](https://github.com/sagemath/sagetrac-mirror/commit/1f4794c68c0bbe1b9c33a074e006bbb88119d7a4)** to none



---

archive/issue_comments_412452.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nIts not easy to write tests for signal / multithread interop, things just tend to randomly crash on some systems but not on others. How much of the Sage testsuite passes reliably on Arch?",
    "created_at": "2018-10-29T22:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412452",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">Comment 7</div>

Its not easy to write tests for signal / multithread interop, things just tend to randomly crash on some systems but not on others. How much of the Sage testsuite passes reliably on Arch?



---

archive/issue_comments_412453.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nI agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.",
    "created_at": "2018-10-29T23:09:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412453",
    "user": "https://github.com/timokau"
}
```

<div id="comment:8" align="right">Comment 8</div>

I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.



---

archive/issue_comments_412454.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@timokau](#comment%3A8):\n> I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.\n\nExcept that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.\n\nAnyway, not going to waste more of my time pushing for this. I'll just keep ignoring the test as I've always done.",
    "created_at": "2018-10-30T06:48:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412454",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@timokau](#comment%3A8):
> I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.

Except that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.

Anyway, not going to waste more of my time pushing for this. I'll just keep ignoring the test as I've always done.



---

archive/issue_comments_412455.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nReplying to [@antonio-rojas](#comment%3A5):\n\n> I don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.\n\nSee #11752 for an actual bug report that led to the disabling of threads. It's 7 years old, so things might have changed, but it was a very concrete issue that crashed sage.\n\nThe incompatibility I observed before was so bad that sage should refuse to load ecllib when it has threading enabled. If the situation has improved, it's great. Otherwise, Arch should modify its sage dependencies and link to a libecl-nothreading.so or something. It's unfortunate, but as far as I know, sage will *not* work properly with a threaded libecl.\n\nIt would be great if sage could work with a libecl configured with default options (which means threading  nowadays -- when sage adopted libecl it didn't have threading), especially because it would mean better integration with distributions like Arch. I'm just sharing my earlier experience that this was (at least at some point) not the case. I expect that the test suite won't exercise ecl enough to reliably trigger the behaviours that would crash sage/ecl-with-threading.\n\n**EDIT:** In fact, the ticket in question deals exactly with the scenario you are facing: running sage in a way that is more integrated in a larger distribution (Mandriva there). It looked like it turned out to be possible at the time to run a generically compiled ECL, but to turn off the threading with a boot-time option (it looks like the option got renamed and that the test is exactly checking that the option is set appropriately).",
    "created_at": "2018-10-30T06:54:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412455",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:10" align="right">Comment 10</div>

Replying to [@antonio-rojas](#comment%3A5):

> I don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.

See #11752 for an actual bug report that led to the disabling of threads. It's 7 years old, so things might have changed, but it was a very concrete issue that crashed sage.

The incompatibility I observed before was so bad that sage should refuse to load ecllib when it has threading enabled. If the situation has improved, it's great. Otherwise, Arch should modify its sage dependencies and link to a libecl-nothreading.so or something. It's unfortunate, but as far as I know, sage will *not* work properly with a threaded libecl.

It would be great if sage could work with a libecl configured with default options (which means threading  nowadays -- when sage adopted libecl it didn't have threading), especially because it would mean better integration with distributions like Arch. I'm just sharing my earlier experience that this was (at least at some point) not the case. I expect that the test suite won't exercise ecl enough to reliably trigger the behaviours that would crash sage/ecl-with-threading.

**EDIT:** In fact, the ticket in question deals exactly with the scenario you are facing: running sage in a way that is more integrated in a larger distribution (Mandriva there). It looked like it turned out to be possible at the time to run a generically compiled ECL, but to turn off the threading with a boot-time option (it looks like the option got renamed and that the test is exactly checking that the option is set appropriately).



---

archive/issue_comments_412456.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nReplying to [@antonio-rojas](#comment%3A9):\n> Replying to [@timokau](#comment%3A8):\n> > I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.\n\n> \n> Except that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.\n\nWell the first thing I would try is to build ecl with the same options and see if that fixes anything. If there are no actual issues with threading however that is of course different. Would be nice if someone with more experience with the ecl interface could re-evaluate.",
    "created_at": "2018-10-30T09:52:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412456",
    "user": "https://github.com/timokau"
}
```

<div id="comment:11" align="right">Comment 11</div>

Replying to [@antonio-rojas](#comment%3A9):
> Replying to [@timokau](#comment%3A8):
> > I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.

> 
> Except that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.

Well the first thing I would try is to build ecl with the same options and see if that fixes anything. If there are no actual issues with threading however that is of course different. Would be nice if someone with more experience with the ecl interface could re-evaluate.



---

archive/issue_comments_412457.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nGood news! I looked up the particular configuration option:\n\nhttps://common-lisp.net/project/ecl/static/manual/re97.html#table.boot_options\n\nand it's only the *signal number* that would be used for thread communication in ECL, should multiple threads exist. I don't think we ever should have multiple threads in ECL within sage, because the signal handling would get completely screwed up. However, this option doesn't particularly seem to influence whether we do. I think it might be a bit of a red flag if this option does have a special value (because it might indicate an ECL build that has thread support), but that in itself is not necessarily indicative of problems. Also, with the work on #11752 it seems that just having thread support in ECL built doesn't necessarily trigger problems. So it might be OK to not test this option.\n\nOn the other hand, \"ECL_OPT_SIGNAL_HANDLING_THREAD\" really should be checked to be 0. If it isn't we can really expect trouble.",
    "created_at": "2018-10-30T22:09:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412457",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:12" align="right">Comment 12</div>

Good news! I looked up the particular configuration option:

https://common-lisp.net/project/ecl/static/manual/re97.html#table.boot_options

and it's only the *signal number* that would be used for thread communication in ECL, should multiple threads exist. I don't think we ever should have multiple threads in ECL within sage, because the signal handling would get completely screwed up. However, this option doesn't particularly seem to influence whether we do. I think it might be a bit of a red flag if this option does have a special value (because it might indicate an ECL build that has thread support), but that in itself is not necessarily indicative of problems. Also, with the work on #11752 it seems that just having thread support in ECL built doesn't necessarily trigger problems. So it might be OK to not test this option.

On the other hand, "ECL_OPT_SIGNAL_HANDLING_THREAD" really should be checked to be 0. If it isn't we can really expect trouble.



---

archive/issue_events_347773.json:
```json
{
    "actor": "https://github.com/antonio-rojas",
    "created_at": "2018-10-31T06:53:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347773"
}
```



---

archive/issue_comments_412458.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nGreat, so can this be set back to positive_review?",
    "created_at": "2018-10-31T06:53:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412458",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:13" align="right">Comment 13</div>

Great, so can this be set back to positive_review?



---

archive/issue_comments_412459.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nReplying to [@antonio-rojas](#comment%3A13):\n> Great, so can this be set back to positive_review?\n\nWhile you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.",
    "created_at": "2018-10-31T06:59:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412459",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:14" align="right">Comment 14</div>

Replying to [@antonio-rojas](#comment%3A13):
> Great, so can this be set back to positive_review?

While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.



---

archive/issue_events_347774.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-10-31T06:59:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347774"
}
```



---

archive/issue_events_347775.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-10-31T06:59:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347775"
}
```



---

archive/issue_comments_412460.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nReplying to [@kiwifb](#comment%3A14):\n> Replying to [@antonio-rojas](#comment%3A13):\n> > Great, so can this be set back to positive_review?\n\n> \n> While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.\n\nThis is not merged in beta2, please reopen.",
    "created_at": "2018-11-01T22:25:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412460",
    "user": "https://github.com/antonio-rojas"
}
```

<div id="comment:15" align="right">Comment 15</div>

Replying to [@kiwifb](#comment%3A14):
> Replying to [@antonio-rojas](#comment%3A13):
> > Great, so can this be set back to positive_review?

> 
> While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.

This is not merged in beta2, please reopen.



---

archive/issue_comments_412461.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nReplying to [@antonio-rojas](#comment%3A15):\n> Replying to [@kiwifb](#comment%3A14):\n> > Replying to [@antonio-rojas](#comment%3A13):\n> > > Great, so can this be set back to positive_review?\n\n> > \n> > While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.\n\n> \n> This is not merged in beta2.\n\nOK I didn't see it being pulled off again :(  putting it back to positive review then.",
    "created_at": "2018-11-01T22:27:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26579#issuecomment-412461",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:16" align="right">Comment 16</div>

Replying to [@antonio-rojas](#comment%3A15):
> Replying to [@kiwifb](#comment%3A14):
> > Replying to [@antonio-rojas](#comment%3A13):
> > > Great, so can this be set back to positive_review?

> > 
> > While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.

> 
> This is not merged in beta2.

OK I didn't see it being pulled off again :(  putting it back to positive review then.



---

archive/issue_events_347776.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-01T22:27:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347776"
}
```



---

archive/issue_events_347777.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-01T22:27:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347777"
}
```



---

archive/issue_events_347778.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-01T22:27:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347778"
}
```



---

archive/issue_events_347779.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-04T10:38:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347779"
}
```



---

archive/issue_events_347780.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-04T10:38:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26579",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26579#event-347780"
}
```
