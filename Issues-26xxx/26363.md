# Issue 26363: Polyhedron_normaliz.save

archive/issues_026126.json:
```json
{
    "body": "CC:  @jplab winfried @tscrim @kliem\n\n```\nsage: P = polytopes.dodecahedron(backend='normaliz')\nsage: P\nA 3-dimensional polyhedron in (Number Field in sqrt5 with defining polynomial x^2 - 5)^3 defined as the convex hull of 20 vertices\nsage: P.save('dodecahedron.sobj')\nTypeError: can't pickle PyCapsule objects\n```\n\nWe fix this by removing the cone with `__getstate__` on pickling.\n\nOn unpickling we use `__setstate__` and `_cone_from_Vrepresentation_and_Hrepresentation` from #28639 to restore the cone.\n\nSpecial care has to be taken in the following cases:\n- no inequalities (the cone can only be initialized from Vrep),\n- the empty polyhedron (cone is `None` in this case).\n\nAs the lines are recomputed, there is no guarantee that they appear in the same order in the normaliz cone. However, normaliz sorts the given lines anyway:\n\n```\nsage: P = Polyhedron(lines=[[1,0], [0,1]], backend='normaliz').lines()\n(A line in the direction (1, 0), A line in the direction (0, 1))\nsage: P = Polyhedron(lines=[[0,1], [1,0]], backend='normaliz').lines()\n(A line in the direction (1, 0), A line in the direction (0, 1))\nsage: P = Polyhedron(lines=[[1,1], [1,0]], backend='normaliz').lines()\n(A line in the direction (1, 0), A line in the direction (0, 1))\n```\n\nAlso, even if `_normaliz_cone` has the lines somewhat shuffled, this shouldn't be noticable as computations are invariant on which line we choose.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26363\n\n",
    "closed_at": "2020-01-31T23:49:53Z",
    "created_at": "2018-09-29T21:59:54Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Polyhedron_normaliz.save",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26363",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jplab winfried @tscrim @kliem

```
sage: P = polytopes.dodecahedron(backend='normaliz')
sage: P
A 3-dimensional polyhedron in (Number Field in sqrt5 with defining polynomial x^2 - 5)^3 defined as the convex hull of 20 vertices
sage: P.save('dodecahedron.sobj')
TypeError: can't pickle PyCapsule objects
```

We fix this by removing the cone with `__getstate__` on pickling.

On unpickling we use `__setstate__` and `_cone_from_Vrepresentation_and_Hrepresentation` from #28639 to restore the cone.

Special care has to be taken in the following cases:
- no inequalities (the cone can only be initialized from Vrep),
- the empty polyhedron (cone is `None` in this case).

As the lines are recomputed, there is no guarantee that they appear in the same order in the normaliz cone. However, normaliz sorts the given lines anyway:

```
sage: P = Polyhedron(lines=[[1,0], [0,1]], backend='normaliz').lines()
(A line in the direction (1, 0), A line in the direction (0, 1))
sage: P = Polyhedron(lines=[[0,1], [1,0]], backend='normaliz').lines()
(A line in the direction (1, 0), A line in the direction (0, 1))
sage: P = Polyhedron(lines=[[1,1], [1,0]], backend='normaliz').lines()
(A line in the direction (1, 0), A line in the direction (0, 1))
```

Also, even if `_normaliz_cone` has the lines somewhat shuffled, this shouldn't be noticable as computations are invariant on which line we choose.

Issue created by migration from https://trac.sagemath.org/ticket/26363





---

archive/issue_comments_367980.json:
```json
{
    "body": "One could define in `Polyhedron_normaliz`:\n\n```\ndef __getstate__(self):\n     state = super(Polyhedron_normaliz, self).__getstate__()\n     # Remove the unpicklable entries.\n     del state[1]['_normaliz_cone']\n     return state\n```\n\nThis constructs an object just as\n\n```\nsage: P = P.base_extend(P.base_ring(),backend='field')\nsage: P.base_extend(P.base_ring(),backend='normaliz')\n```\n(but saving computed results)\n\nHowever, one would need a method to recover `_normaliz_cone` (this method is needed anyway, to make the second thing work).",
    "created_at": "2019-07-05T19:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367980",
    "user": "https://github.com/kliem"
}
```

One could define in `Polyhedron_normaliz`:

```
def __getstate__(self):
     state = super(Polyhedron_normaliz, self).__getstate__()
     # Remove the unpicklable entries.
     del state[1]['_normaliz_cone']
     return state
```

This constructs an object just as

```
sage: P = P.base_extend(P.base_ring(),backend='field')
sage: P.base_extend(P.base_ring(),backend='normaliz')
```
(but saving computed results)

However, one would need a method to recover `_normaliz_cone` (this method is needed anyway, to make the second thing work).



---

archive/issue_comments_367981.json:
```json
{
    "body": "I think I know what to do about it.\n\n1. As mentioned one can just remove the cone on pickling. Then the loaded object is just as good as changing backend back and forth (and changing backend to normaliz should also work and still give us a cone or a way to retrive the cone).\n\n2. Next step would be do allow initialization of a cone from `Vrepresentation` and `Hrepresentation`. This works by homogenization of the input and explicitly giving a dehomogenization (this is the only way that Normaliz accepts precomputed data).\n\n   Note: I'm not proposing to allow to give both representations to normaliz by the user, but when changing fields or loading a stored object I think we should trust them to be correct.\n\n3. Once this is done, one can set up normaliz cone to be a lazy attribute.",
    "created_at": "2019-10-19T13:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367981",
    "user": "https://github.com/kliem"
}
```

I think I know what to do about it.

1. As mentioned one can just remove the cone on pickling. Then the loaded object is just as good as changing backend back and forth (and changing backend to normaliz should also work and still give us a cone or a way to retrive the cone).

2. Next step would be do allow initialization of a cone from `Vrepresentation` and `Hrepresentation`. This works by homogenization of the input and explicitly giving a dehomogenization (this is the only way that Normaliz accepts precomputed data).

   Note: I'm not proposing to allow to give both representations to normaliz by the user, but when changing fields or loading a stored object I think we should trust them to be correct.

3. Once this is done, one can set up normaliz cone to be a lazy attribute.



---

archive/issue_comments_367982.json:
```json
{
    "body": "In #28639 I will implement a method that generates the cone from both Vrep and Hrep (recomputing the lines, but thats ok I guess). I have tested this with a few polyhedra, but I have no idea, which examples can be tricky.",
    "created_at": "2019-10-19T20:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367982",
    "user": "https://github.com/kliem"
}
```

In #28639 I will implement a method that generates the cone from both Vrep and Hrep (recomputing the lines, but thats ok I guess). I have tested this with a few polyhedra, but I have no idea, which examples can be tricky.



---

archive/issue_events_065581.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2019-10-21T09:37:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26363#event-65581"
}
```



---

archive/issue_comments_367983.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-12-02T09:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367983",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_367984.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-02T09:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367984",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367985.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-12-02T10:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367985",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_367986.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-02T10:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367986",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367987.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-02T10:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367987",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367988.json:
```json
{
    "body": "I plan to extend Normaliz as suggested. The essential point is that Normaliz can skip a convex hull computation, but nevertheless can produce the facet/ectreme ray incidence vectors and keep them for further operations, like the modification of the original cone.\n\nI am not sure whether one can give up the requirement to input the precomputed data in homogenized form with an added dehomogenization if they come from an inhomogeneous computation.",
    "created_at": "2019-12-02T21:48:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367988",
    "user": "https://trac.sagemath.org/admin/accounts/users/Winfried"
}
```

I plan to extend Normaliz as suggested. The essential point is that Normaliz can skip a convex hull computation, but nevertheless can produce the facet/ectreme ray incidence vectors and keep them for further operations, like the modification of the original cone.

I am not sure whether one can give up the requirement to input the precomputed data in homogenized form with an added dehomogenization if they come from an inhomogeneous computation.



---

archive/issue_events_065582.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26363#event-65582"
}
```



---

archive/issue_events_065583.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26363#event-65583"
}
```



---

archive/issue_comments_367989.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367989",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_367990.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-01-27T14:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367990",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_367991.json:
```json
{
    "body": "If there are any extensions to Normaliz that can be utilized in the future (as per comment:11), we can do further changes then. This is a nice improvement. LGTM.",
    "created_at": "2020-01-29T06:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367991",
    "user": "https://github.com/tscrim"
}
```

If there are any extensions to Normaliz that can be utilized in the future (as per comment:11), we can do further changes then. This is a nice improvement. LGTM.



---

archive/issue_comments_367992.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-29T06:03:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367992",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_065584.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-31T23:49:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26363#event-65584"
}
```



---

archive/issue_comments_367993.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-31T23:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367993",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_367994.json:
```json
{
    "body": "Meanwhile I have implemented the use of precomputed data. Version 3.8.4 will very soon be published. Normaliz accepts \n\n```\nType::extreme_rays\n```\nand \n\n```\nType::support_hyperplanes\n```\nas precomputed data. \n\nHowevber, these do not always define the cone (or polyhedron) in which we want to compute since nontrivial coordinate transformations may come into play. These are restored via \n\n```\nType::generated_lattice\n```\n(also in the algebraic case) and \n\n```\nType::maximal_subspace\n```\n\nIt is also important that these precomputed data are considered homogeneous input types so that the polyhedron must be defined via Type::dehomogenization or Type::grading.\n\nSee Sections 6.21 and D.8.16 in Normaliz.pdf (as of today).",
    "created_at": "2020-02-02T10:15:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26363#issuecomment-367994",
    "user": "https://trac.sagemath.org/admin/accounts/users/Winfried"
}
```

Meanwhile I have implemented the use of precomputed data. Version 3.8.4 will very soon be published. Normaliz accepts 

```
Type::extreme_rays
```
and 

```
Type::support_hyperplanes
```
as precomputed data. 

Howevber, these do not always define the cone (or polyhedron) in which we want to compute since nontrivial coordinate transformations may come into play. These are restored via 

```
Type::generated_lattice
```
(also in the algebraic case) and 

```
Type::maximal_subspace
```

It is also important that these precomputed data are considered homogeneous input types so that the polyhedron must be defined via Type::dehomogenization or Type::grading.

See Sections 6.21 and D.8.16 in Normaliz.pdf (as of today).
