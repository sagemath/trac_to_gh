# Issue 26930: add GAP io and crypting pkgs

archive/issues_026693.json:
```json
{
    "body": "These GAP packages extend GAP kernel functionality. \nOn the libgap side, this requires tinkering with the loader, see\non #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).\n\nHere is a branch that implements this.\n\nWe also need to fix GAP's gac/libtool mini-toolchain, used by some GAP pkgs. This involves patching of gac, and installing libtool, done in #27218.\n\nCC:  @embray @kiwifb @timokau @jhpalmieri @AndrewAtLarge\n\nBranch/Commit: c84753f36265886e31cbf9d7c31745d176a907c8\n\nReviewer: Erik Bray\n\nAuthor: Dima Pasechnik, Erik Bray\n\nDependencies: #27218, #27230, #27380\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26930\n\n",
    "closed_at": "2019-03-03T22:38:24Z",
    "created_at": "2018-12-21T11:33:03Z",
    "labels": [
        "component: packages: optional",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "add GAP io and crypting pkgs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26930",
    "user": "https://github.com/dimpase"
}
```
These GAP packages extend GAP kernel functionality. 
On the libgap side, this requires tinkering with the loader, see
on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).

Here is a branch that implements this.

We also need to fix GAP's gac/libtool mini-toolchain, used by some GAP pkgs. This involves patching of gac, and installing libtool, done in #27218.

CC:  @embray @kiwifb @timokau @jhpalmieri @AndrewAtLarge

Branch/Commit: c84753f36265886e31cbf9d7c31745d176a907c8

Reviewer: Erik Bray

Author: Dima Pasechnik, Erik Bray

Dependencies: #27218, #27230, #27380

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26930





---

archive/issue_comments_399589.json:
```json
{
    "body": "<a id='comment:1'></a>on OSX the dlopen call does not work. However, it does if given full path to the dll, i.e.\n\n```diff\n--- a/src/sage/libs/gap/util.pyx\n+++ b/src/sage/libs/gap/util.pyx\n@@ -263,7 +263,8 @@ cdef initialize():\n     # Note: we could use RTLD_NOLOAD and avoid the subsequent dlclose() but\n     # this isn't portable\n     cdef void* handle\n-    handle = dlopen(\"libgap.so\", RTLD_NOW | RTLD_GLOBAL)\n+    # handle = dlopen(\"libgap.so\", RTLD_NOW | RTLD_GLOBAL)\n+    handle = dlopen(\"/Users/dima/sagetrac-mirror/local/lib/python2.7/site-packages/sage/libs/gap/libgap.so\", RTLD_NOW | RTLD_GLOBAL)\n     if handle == NULL:\n         raise RuntimeError(\n                 \"Could not dlopen() libgap.so even though it should already \"\n```\nname resolution procedures are different on OSX. Actually, I don't know what's happening  on Linux so that libgap.so is found.\nPerhaps, it's already loaded on Linux, but not on OSX?",
    "created_at": "2018-12-21T13:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399589",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:1'></a>on OSX the dlopen call does not work. However, it does if given full path to the dll, i.e.

```diff
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
@@ -263,7 +263,8 @@ cdef initialize():
     # Note: we could use RTLD_NOLOAD and avoid the subsequent dlclose() but
     # this isn't portable
     cdef void* handle
-    handle = dlopen("libgap.so", RTLD_NOW | RTLD_GLOBAL)
+    # handle = dlopen("libgap.so", RTLD_NOW | RTLD_GLOBAL)
+    handle = dlopen("/Users/dima/sagetrac-mirror/local/lib/python2.7/site-packages/sage/libs/gap/libgap.so", RTLD_NOW | RTLD_GLOBAL)
     if handle == NULL:
         raise RuntimeError(
                 "Could not dlopen() libgap.so even though it should already "
```
name resolution procedures are different on OSX. Actually, I don't know what's happening  on Linux so that libgap.so is found.
Perhaps, it's already loaded on Linux, but not on OSX?



---

archive/issue_comments_399590.json:
```json
{
    "body": "<a id='comment:2'></a>That's not really the intended \"libgap.so\".  I meant the one from GAP itself, in `$SAGE_LOCAL/lib/libgap.so`.  The re-dlopening the Python module might do it as well.\n\nThe other option, as I mentioned, would be to use Python's built-in `sys.setdlopenflags(...)`, but that has to be called before importing any modules (e.g. `sage.lib.gap.libgap`) that are linked with libgap.  It would probably be good afterwards to set it back to its default which is `RTLD_LAZY`.\n\nBut yes, it's probably more portable either way to give a full path to the relevant shared object.",
    "created_at": "2018-12-21T13:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399590",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>That's not really the intended "libgap.so".  I meant the one from GAP itself, in `$SAGE_LOCAL/lib/libgap.so`.  The re-dlopening the Python module might do it as well.

The other option, as I mentioned, would be to use Python's built-in `sys.setdlopenflags(...)`, but that has to be called before importing any modules (e.g. `sage.lib.gap.libgap`) that are linked with libgap.  It would probably be good afterwards to set it back to its default which is `RTLD_LAZY`.

But yes, it's probably more portable either way to give a full path to the relevant shared object.



---

archive/issue_comments_399591.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 embray]:\n> That's not really the intended \"libgap.so\".  I meant the one from GAP itself, in `$SAGE_LOCAL/lib/libgap.so`.  \n\noh, right --- except it's `.dylib`, not `.so`. (I searched for `libgap.so`, absent-mindedly, found unique match, tried it :-))\n\nAnd indeed simply replacing `libgap.so` with `libgap.dylib` in the dlopen call suffices,\nno need for the full path.\n\nSo this is easy to fix - except that in C I would have gone for a macro with the right extension, how is one supposed to do this in Cython?",
    "created_at": "2018-12-21T14:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399591",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>Replying to [comment:2 embray]:
> That's not really the intended "libgap.so".  I meant the one from GAP itself, in `$SAGE_LOCAL/lib/libgap.so`.  

oh, right --- except it's `.dylib`, not `.so`. (I searched for `libgap.so`, absent-mindedly, found unique match, tried it :-))

And indeed simply replacing `libgap.so` with `libgap.dylib` in the dlopen call suffices,
no need for the full path.

So this is easy to fix - except that in C I would have gone for a macro with the right extension, how is one supposed to do this in Cython?



---

archive/issue_comments_399592.json:
```json
{
    "body": "<a id='comment:4'></a>Your plan isn't clear from the ticket description. Is your plan to add IO to the `gap_packages` optional package? By the way: Could you remind me of the current status? I.e., is `database_gap` now part of `gap_packages`, or is it still independent? Is it supposed to be standard soon?",
    "created_at": "2018-12-26T16:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399592",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>Your plan isn't clear from the ticket description. Is your plan to add IO to the `gap_packages` optional package? By the way: Could you remind me of the current status? I.e., is `database_gap` now part of `gap_packages`, or is it still independent? Is it supposed to be standard soon?



---

archive/issue_comments_399593.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 SimonKing]:\n> Your plan isn't clear from the ticket description. Is your plan to add IO to the `gap_packages` optional package? By the way: Could you remind me of the current status? I.e., is `database_gap` now part of `gap_packages`, or is it still independent? Is it supposed to be standard soon?\n\n\n`database_gap` spkg is there no more, it's part of `gap` spkg; in fact, already \non #22626.\nOn #26856 Erik prefers to keep `gap_packages` optional, at least for the upcoming (quick) release 8.6, to make Debian deadline of 12 Jan.\n\nWe have not included IO there, as it'd be an extra over the current `gap_packages`, and something that needs more testing. Then we can extend `gap_packages` (and merge everything into `gap`, as we are already using the same tarball for `gap` and `gap_packages` anyway).",
    "created_at": "2018-12-26T16:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399593",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>Replying to [comment:4 SimonKing]:
> Your plan isn't clear from the ticket description. Is your plan to add IO to the `gap_packages` optional package? By the way: Could you remind me of the current status? I.e., is `database_gap` now part of `gap_packages`, or is it still independent? Is it supposed to be standard soon?


`database_gap` spkg is there no more, it's part of `gap` spkg; in fact, already 
on #22626.
On #26856 Erik prefers to keep `gap_packages` optional, at least for the upcoming (quick) release 8.6, to make Debian deadline of 12 Jan.

We have not included IO there, as it'd be an extra over the current `gap_packages`, and something that needs more testing. Then we can extend `gap_packages` (and merge everything into `gap`, as we are already using the same tarball for `gap` and `gap_packages` anyway).



---

archive/issue_comments_399594.json:
```json
{
    "body": "<a id='comment:6'></a>And now a question on the IO package: From its documentation, I see that it allows to pickle any GAP object into a file object. But that's cumbersome for serialisation in Sage.\n\nIn Sage, we want a `__reduce__` method (or a different serialisation protocol) to return a data tuple that is eventually dumped to a string by standard Python tools. But it seems wrong to me if we have a complicated object (say, a cohomology ring) with several attributes, one of them being defined in libgap, and to write only this attribute directly to a file.\n\nSo, how do you envision libgap serialisation?",
    "created_at": "2018-12-26T16:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399594",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>And now a question on the IO package: From its documentation, I see that it allows to pickle any GAP object into a file object. But that's cumbersome for serialisation in Sage.

In Sage, we want a `__reduce__` method (or a different serialisation protocol) to return a data tuple that is eventually dumped to a string by standard Python tools. But it seems wrong to me if we have a complicated object (say, a cohomology ring) with several attributes, one of them being defined in libgap, and to write only this attribute directly to a file.

So, how do you envision libgap serialisation?



---

archive/issue_comments_399595.json:
```json
{
    "body": "<a id='comment:7'></a>Would you rather prefer IO dumping to a string? (i.e. into memory, right?)\nI'm not sure, but perhaps this is doable via their streams; it sounds like a reasonable feature to add to IO, if it's not there yet.\n\nAs Python serialisation was never my concern, I have little idea about it.",
    "created_at": "2018-12-26T16:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399595",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>Would you rather prefer IO dumping to a string? (i.e. into memory, right?)
I'm not sure, but perhaps this is doable via their streams; it sounds like a reasonable feature to add to IO, if it's not there yet.

As Python serialisation was never my concern, I have little idea about it.



---

archive/issue_comments_399596.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 dimpase]:\n> As Python serialisation was never my concern, I have little idea about it.\n\n\nThis is a SageMath ticket. So, Python serialisation has to come into play sooner or later.\n\nHaving IO installed and working is a nice first step. But eventually,\n\n```\nsage: G = libgap.DihedralGroup(8)\nsage: loads(dumps(G))\n```\nshould work. And also something like the following should work:\n\n```python\nclass Foo(Ring):\n    def __init__(self, G):\n        assert G in Groups()\n        self.G = G\n        ...\n    def __reduce__(self):\n        return Foo, self.G\n```\nand then\n\n```\nsage: loads(dumps(Foo(libgap.DihedralGroup(8))))\n```\n\nBut that would be for two follow-up tickets. One for pickling, the other for making libgap aware of Sage's categories (thus, translating `G in Groups()` into `bool(G.IsGroup())`).",
    "created_at": "2018-12-26T16:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399596",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>Replying to [comment:7 dimpase]:
> As Python serialisation was never my concern, I have little idea about it.


This is a SageMath ticket. So, Python serialisation has to come into play sooner or later.

Having IO installed and working is a nice first step. But eventually,

```
sage: G = libgap.DihedralGroup(8)
sage: loads(dumps(G))
```
should work. And also something like the following should work:

```python
class Foo(Ring):
    def __init__(self, G):
        assert G in Groups()
        self.G = G
        ...
    def __reduce__(self):
        return Foo, self.G
```
and then

```
sage: loads(dumps(Foo(libgap.DihedralGroup(8))))
```

But that would be for two follow-up tickets. One for pickling, the other for making libgap aware of Sage's categories (thus, translating `G in Groups()` into `bool(G.IsGroup())`).



---

archive/issue_comments_399597.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2018-12-27T16:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_399598.json:
```json
{
    "body": "<a id='comment:10'></a>rebased over the branch on #26856, added OSX (and perhaps even Cygwin?) support.",
    "created_at": "2018-12-27T16:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399598",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>rebased over the branch on #26856, added OSX (and perhaps even Cygwin?) support.



---

archive/issue_comments_399599.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2018-12-29T18:31:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399599",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_399600.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-09T11:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399600",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399601.json:
```json
{
    "body": "<a id='comment:14'></a>merged 8.6.rc0 in.",
    "created_at": "2019-01-09T11:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399601",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>merged 8.6.rc0 in.



---

archive/issue_comments_399602.json:
```json
{
    "body": "<a id='comment:15'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399602",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_events_066698.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:15:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26930#event-66698"
}
```



---

archive/issue_comments_399603.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-22T13:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399603",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399604.json:
```json
{
    "body": "<a id='comment:17'></a>Minor comment: if you are changing the `spkg-install` script of a package, you should also bump the patchlevel to force a rebuild.",
    "created_at": "2019-01-22T13:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399604",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Minor comment: if you are changing the `spkg-install` script of a package, you should also bump the patchlevel to force a rebuild.



---

archive/issue_comments_399605.json:
```json
{
    "body": "<a id='comment:18'></a>Since `dlopen` takes a `const char*`, it's safer to use byte literals here:\n\n```python\n    for suffix in [b\"so\", b\"dylib\", b\"dll\"]:\n        handle = dlopen(b\"libgap.\" + suffix, RTLD_NOW | RTLD_GLOBAL)\n```",
    "created_at": "2019-01-22T13:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399605",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Since `dlopen` takes a `const char*`, it's safer to use byte literals here:

```python
    for suffix in [b"so", b"dylib", b"dll"]:
        handle = dlopen(b"libgap." + suffix, RTLD_NOW | RTLD_GLOBAL)
```



---

archive/issue_comments_399606.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-22T13:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399606",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399607.json:
```json
{
    "body": "<a id='comment:21'></a>Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:\n\n```sh\ncp -f \"$SAGE_LOCAL/include/gap/config.h\" \"$GAP_ROOT/src/\"\n```",
    "created_at": "2019-01-22T13:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399607",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:

```sh
cp -f "$SAGE_LOCAL/include/gap/config.h" "$GAP_ROOT/src/"
```



---

archive/issue_comments_399608.json:
```json
{
    "body": "<a id='comment:22'></a>Finally a minor Cython style issue: I prefer `handle is NULL` as a more Pythonic spelling of `handle == NULL`.",
    "created_at": "2019-01-22T13:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399608",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>Finally a minor Cython style issue: I prefer `handle is NULL` as a more Pythonic spelling of `handle == NULL`.



---

archive/issue_comments_399609.json:
```json
{
    "body": "<a id='comment:23'></a>By the way, the commit history is a mess. Maybe it would be better to squash and rebase on top of 8.6.",
    "created_at": "2019-01-22T14:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399609",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>By the way, the commit history is a mess. Maybe it would be better to squash and rebase on top of 8.6.



---

archive/issue_comments_399610.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:21 jdemeyer]:\n> Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:\n> \n> ```\n> #!sh\n> cp -f \"$SAGE_LOCAL/include/gap/config.h\" \"$GAP_ROOT/src/\"\n> ```\n\n\nIf I remember correctly this is where `io.c` expect some of its \"include\". I am planning to patch in sage-on-gentoo rather than doing something like that.\n\nNow going through the ticket and this bit in particular:\n\n```\n+    cdef void* handle\n+    for suffix in [\"so\", \"dylib\", \"dll\"]:\n+        handle = dlopen(\"libgap.\"+suffix, RTLD_NOW | RTLD_GLOBAL)\n+        if handle != NULL:\n+            break\n```\n\nwhere the point has been made that we don't need the full path. Now that starts to get unrelated but we do the same thing for libsingular in `libs/singular.pyx` and we go to great length to get the full path even defining it in `env.py`. If I read this correctly it is now way more complicated than it should be.",
    "created_at": "2019-01-22T18:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399610",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:24'></a>Replying to [comment:21 jdemeyer]:
> Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:
> 
> ```
> #!sh
> cp -f "$SAGE_LOCAL/include/gap/config.h" "$GAP_ROOT/src/"
> ```


If I remember correctly this is where `io.c` expect some of its "include". I am planning to patch in sage-on-gentoo rather than doing something like that.

Now going through the ticket and this bit in particular:

```
+    cdef void* handle
+    for suffix in ["so", "dylib", "dll"]:
+        handle = dlopen("libgap."+suffix, RTLD_NOW | RTLD_GLOBAL)
+        if handle != NULL:
+            break
```

where the point has been made that we don't need the full path. Now that starts to get unrelated but we do the same thing for libsingular in `libs/singular.pyx` and we go to great length to get the full path even defining it in `env.py`. If I read this correctly it is now way more complicated than it should be.



---

archive/issue_comments_399611.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 fbissey]:\n> Replying to [comment:21 jdemeyer]:\n> > Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:\n> > \n> > ```\n> > #!sh\n> > cp -f \"$SAGE_LOCAL/include/gap/config.h\" \"$GAP_ROOT/src/\"\n> > ```\n\n> \n> If I remember correctly this is where `io.c` expect some of its \"include\". I am planning to patch in sage-on-gentoo rather than doing something like that.\n\n\nThat's right. Perhaps the proper way would be to use `sdh_install` rather than `cp`, but on the other hand it's not clear to me whether `$GAP_ROOT/src/` is a location supported by this machinery.\n\nErik, could you look into this?\n\n(Of course, GAP having its include files in the same directory as C sources is a problem, due to their lack of proper install mechanism...)",
    "created_at": "2019-01-23T00:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399611",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>Replying to [comment:24 fbissey]:
> Replying to [comment:21 jdemeyer]:
> > Copying a file into `$SAGE_LOCAL` like this is very fishy. At least it needs to be better explained why it's needed:
> > 
> > ```
> > #!sh
> > cp -f "$SAGE_LOCAL/include/gap/config.h" "$GAP_ROOT/src/"
> > ```

> 
> If I remember correctly this is where `io.c` expect some of its "include". I am planning to patch in sage-on-gentoo rather than doing something like that.


That's right. Perhaps the proper way would be to use `sdh_install` rather than `cp`, but on the other hand it's not clear to me whether `$GAP_ROOT/src/` is a location supported by this machinery.

Erik, could you look into this?

(Of course, GAP having its include files in the same directory as C sources is a problem, due to their lack of proper install mechanism...)



---

archive/issue_comments_399612.json:
```json
{
    "body": "<a id='comment:26'></a>This is all I had to do compile `io` against an installed gap (with `config.h` installed in `include/gap` like in vanilla sage)\n\n```diff\ndiff --git a/pkg/io-4.5.4/src/io.c b/pkg/io-4.5.4/src/io.c\nindex 5aa4a082..07e6e312 100644\n--- a/pkg/io-4.5.4/src/io.c\n+++ b/pkg/io-4.5.4/src/io.c\n@@ -11,8 +11,8 @@\n /* Try to use as much of the GNU C library as possible: */\n #define _GNU_SOURCE\n \n-#include \"src/compiled.h\"          /* GAP headers                */\n-#include \"src/iostream.h\"          /* Signal Handling            */\n+#include \"gap/compiled.h\"          /* GAP headers                */\n+#include \"gap/iostream.h\"          /* Signal Handling            */\n \n #undef PACKAGE\n #undef PACKAGE_BUGREPORT\n```",
    "created_at": "2019-01-23T00:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399612",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:26'></a>This is all I had to do compile `io` against an installed gap (with `config.h` installed in `include/gap` like in vanilla sage)

```diff
diff --git a/pkg/io-4.5.4/src/io.c b/pkg/io-4.5.4/src/io.c
index 5aa4a082..07e6e312 100644
--- a/pkg/io-4.5.4/src/io.c
+++ b/pkg/io-4.5.4/src/io.c
@@ -11,8 +11,8 @@
 /* Try to use as much of the GNU C library as possible: */
 #define _GNU_SOURCE
 
-#include "src/compiled.h"          /* GAP headers                */
-#include "src/iostream.h"          /* Signal Handling            */
+#include "gap/compiled.h"          /* GAP headers                */
+#include "gap/iostream.h"          /* Signal Handling            */
 
 #undef PACKAGE
 #undef PACKAGE_BUGREPORT
```



---

archive/issue_comments_399613.json:
```json
{
    "body": "<a id='comment:27'></a>rebased branch, using byte literals now, also internet-related tests fixed at one place\n\n---\nNew commits:",
    "created_at": "2019-01-23T00:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399613",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>rebased branch, using byte literals now, also internet-related tests fixed at one place

---
New commits:



---

archive/issue_comments_399614.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-23T00:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399614",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399615.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-23T06:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399615",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399616.json:
```json
{
    "body": "<a id='comment:28'></a>[comment:17] and [comment:21] have not been addressed yet (neither has [comment:22] but that's just a style issue)",
    "created_at": "2019-01-23T06:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399616",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:28'></a>[comment:17] and [comment:21] have not been addressed yet (neither has [comment:22] but that's just a style issue)



---

archive/issue_comments_399617.json:
```json
{
    "body": "<a id='comment:29'></a>Thanks for doing the rebase, but `rebased the messy branch from #26930` is not really a good commit message. Better would be something like `Trac #26930: add GAP io package`.",
    "created_at": "2019-01-23T08:34:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399617",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Thanks for doing the rebase, but `rebased the messy branch from #26930` is not really a good commit message. Better would be something like `Trac #26930: add GAP io package`.



---

archive/issue_comments_399618.json:
```json
{
    "body": "<a id='comment:30'></a>I would like to handle the path for libgap.so (and its related variants) better, and had planned to do so soon before I saw all the recent work on this ticket.\n\nI think the path to libgap should be set in `sage.env` and should be possible to override by environment variable, analogous to the handling of `SINGULAR_SO` (it could even repurpose the same code more-or-less).",
    "created_at": "2019-01-23T10:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399618",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>I would like to handle the path for libgap.so (and its related variants) better, and had planned to do so soon before I saw all the recent work on this ticket.

I think the path to libgap should be set in `sage.env` and should be possible to override by environment variable, analogous to the handling of `SINGULAR_SO` (it could even repurpose the same code more-or-less).



---

archive/issue_comments_399619.json:
```json
{
    "body": "<a id='comment:31'></a>This change\n\n```diff\n\ndiff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install\nindex 1a3e8c5..607d2c7 100644\n--- a/build/pkgs/gap_packages/spkg-install\n+++ b/build/pkgs/gap_packages/spkg-install\n@@ -48,15 +48,15 @@ install_compiled_pkg()\n     # Clean up any build artificts before installing the rest of the package\n     # Also remove configure/Makefiles\n     # Note: None, if any of the packages really have a proper install target\n-    make clean  # Works for some packages but not all\n-    rm -rf bin/\n-    rm -rf configure configure.* config.* autogen.sh *.m4 Makefile* m4/\n \n     # Create the bin/ symlink\n     ln -s \"$SAGE_LOCAL/lib/gap/pkg/$pkg/bin\" bin\n \n     # Install the rest of the package files\n     sdh_install * \"$PKG_DIR/$pkg\"\n+    make clean  # Works for some packages but not all\n+    rm -rf bin/\n+    rm -rf configure configure.* config.* autogen.sh *.m4 Makefile* m4/\n }\n \n # Build and install compiled packages:\n```\n\nis not good.  You seem to have brought it over from some old branch for #26856, where I also had to remove it: #26856#comment:110",
    "created_at": "2019-01-23T10:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399619",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>This change

```diff

diff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install
index 1a3e8c5..607d2c7 100644
--- a/build/pkgs/gap_packages/spkg-install
+++ b/build/pkgs/gap_packages/spkg-install
@@ -48,15 +48,15 @@ install_compiled_pkg()
     # Clean up any build artificts before installing the rest of the package
     # Also remove configure/Makefiles
     # Note: None, if any of the packages really have a proper install target
-    make clean  # Works for some packages but not all
-    rm -rf bin/
-    rm -rf configure configure.* config.* autogen.sh *.m4 Makefile* m4/
 
     # Create the bin/ symlink
     ln -s "$SAGE_LOCAL/lib/gap/pkg/$pkg/bin" bin
 
     # Install the rest of the package files
     sdh_install * "$PKG_DIR/$pkg"
+    make clean  # Works for some packages but not all
+    rm -rf bin/
+    rm -rf configure configure.* config.* autogen.sh *.m4 Makefile* m4/
 }
 
 # Build and install compiled packages:
```

is not good.  You seem to have brought it over from some old branch for #26856, where I also had to remove it: #26856#comment:110



---

archive/issue_comments_399620.json:
```json
{
    "body": "<a id='comment:32'></a>\n```diff\ndiff --git a/src/doc/en/constructions/groups.rst b/src/doc/en/constructions/groups.rst\nindex 30d8da4..0cc7b92 100644\n--- a/src/doc/en/constructions/groups.rst\n+++ b/src/doc/en/constructions/groups.rst\n@@ -184,7 +184,7 @@ Here's another way, working more directly with GAP::\n     [ Group( [ f1, f2 ] ), Group( [ f2 ] ), Group( <identity> of ... ) ]\n     sage: print(gap.eval(\"G := SymmetricGroup( 4 )\"))\n     Sym( [ 1 .. 4 ] )\n-    sage: print(gap.eval(\"normal := NormalSubgroups( G );\"))\n+    sage: print(gap.eval(\"normal := NormalSubgroups( G );\")) # random\n     [ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,3)(2,4) ]),\n       Group(()) ]\n```\n\nI'm confused why it's still giving you random results here.  #26874 should have fixed this.  I want to look into it.  It's not too important of course, but it still troubles me that there's some non-determinism in the tests when AFAIK there shouldn't be.",
    "created_at": "2019-01-23T10:48:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399620",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>
```diff
diff --git a/src/doc/en/constructions/groups.rst b/src/doc/en/constructions/groups.rst
index 30d8da4..0cc7b92 100644
--- a/src/doc/en/constructions/groups.rst
+++ b/src/doc/en/constructions/groups.rst
@@ -184,7 +184,7 @@ Here's another way, working more directly with GAP::
     [ Group( [ f1, f2 ] ), Group( [ f2 ] ), Group( <identity> of ... ) ]
     sage: print(gap.eval("G := SymmetricGroup( 4 )"))
     Sym( [ 1 .. 4 ] )
-    sage: print(gap.eval("normal := NormalSubgroups( G );"))
+    sage: print(gap.eval("normal := NormalSubgroups( G );")) # random
     [ Sym( [ 1 .. 4 ] ), Alt( [ 1 .. 4 ] ), Group([ (1,4)(2,3), (1,3)(2,4) ]),
       Group(()) ]
```

I'm confused why it's still giving you random results here.  #26874 should have fixed this.  I want to look into it.  It's not too important of course, but it still troubles me that there's some non-determinism in the tests when AFAIK there shouldn't be.



---

archive/issue_comments_399621.json:
```json
{
    "body": "<a id='comment:33'></a>I don't know why you removed this:\n\n```diff\ndiff --git a/src/sage/graphs/strongly_regular_db.pyx b/src/sage/graphs/strongly_regular_db.pyx\nindex 55a1428..90af15a 100644\n--- a/src/sage/graphs/strongly_regular_db.pyx\n+++ b/src/sage/graphs/strongly_regular_db.pyx\n@@ -2450,10 +2450,8 @@ def SRG_416_100_36_20():\n         (416, 100, 36, 20)\n     \"\"\"\n     from sage.libs.gap.libgap import libgap\n-    libgap.eval(\"SetInfoLevel(InfoWarning,0)\") # silence #I warnings from GAP (without IO pkg)\n     libgap.LoadPackage(\"AtlasRep\")\n     g=libgap.AtlasGroup(\"G2(4)\",libgap.NrMovedPoints,416)\n-    libgap.eval(\"SetInfoLevel(InfoWarning,1)\") # restore #I warnings\n     h = Graph()\n     h.add_edges(g.Orbit([1,5],libgap.OnSets))\n     h.relabel()\n```\n\nIt's still not a standard package, so these warnings will still happen if the IO package is not installed.  This isn't just a problem for sage-the-distribution.  E.g. on Debian it's perfectly possible (at least for now) to install the sagemath package without installing the gap-io package.",
    "created_at": "2019-01-23T10:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399621",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>I don't know why you removed this:

```diff
diff --git a/src/sage/graphs/strongly_regular_db.pyx b/src/sage/graphs/strongly_regular_db.pyx
index 55a1428..90af15a 100644
--- a/src/sage/graphs/strongly_regular_db.pyx
+++ b/src/sage/graphs/strongly_regular_db.pyx
@@ -2450,10 +2450,8 @@ def SRG_416_100_36_20():
         (416, 100, 36, 20)
     """
     from sage.libs.gap.libgap import libgap
-    libgap.eval("SetInfoLevel(InfoWarning,0)") # silence #I warnings from GAP (without IO pkg)
     libgap.LoadPackage("AtlasRep")
     g=libgap.AtlasGroup("G2(4)",libgap.NrMovedPoints,416)
-    libgap.eval("SetInfoLevel(InfoWarning,1)") # restore #I warnings
     h = Graph()
     h.add_edges(g.Orbit([1,5],libgap.OnSets))
     h.relabel()
```

It's still not a standard package, so these warnings will still happen if the IO package is not installed.  This isn't just a problem for sage-the-distribution.  E.g. on Debian it's perfectly possible (at least for now) to install the sagemath package without installing the gap-io package.



---

archive/issue_comments_399622.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 embray]:\n> I don't know why you removed this:\n> \n> \n> ```\n> #!diff\n> diff --git a/src/sage/graphs/strongly_regular_db.pyx b/src/sage/graphs/strongly_regular_db.pyx\n> index 55a1428..90af15a 100644\n> --- a/src/sage/graphs/strongly_regular_db.pyx\n> +++ b/src/sage/graphs/strongly_regular_db.pyx\n> @@ -2450,10 +2450,8 @@ def SRG_416_100_36_20():\n>          (416, 100, 36, 20)\n>      \"\"\"\n>      from sage.libs.gap.libgap import libgap\n> -    libgap.eval(\"SetInfoLevel(InfoWarning,0)\") # silence #I warnings from GAP (without IO pkg)\n>      libgap.LoadPackage(\"AtlasRep\")\n>      g=libgap.AtlasGroup(\"G2(4)\",libgap.NrMovedPoints,416)\n> -    libgap.eval(\"SetInfoLevel(InfoWarning,1)\") # restore #I warnings\n>      h = Graph()\n>      h.add_edges(g.Orbit([1,5],libgap.OnSets))\n>      h.relabel()\n> ```\n> \n> It's still not a standard package, so these warnings will still happen if the IO package is not installed.  This isn't just a problem for sage-the-distribution.  E.g. on Debian it's perfectly possible (at least for now) to install the sagemath package without installing the gap-io package.\n\n\noh, I might have been confused by shaffling packages around. This chane makes sense if atlasrep is in gap-packages, but this is not the case any more.",
    "created_at": "2019-01-23T11:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399622",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>Replying to [comment:33 embray]:
> I don't know why you removed this:
> 
> 
> ```
> #!diff
> diff --git a/src/sage/graphs/strongly_regular_db.pyx b/src/sage/graphs/strongly_regular_db.pyx
> index 55a1428..90af15a 100644
> --- a/src/sage/graphs/strongly_regular_db.pyx
> +++ b/src/sage/graphs/strongly_regular_db.pyx
> @@ -2450,10 +2450,8 @@ def SRG_416_100_36_20():
>          (416, 100, 36, 20)
>      """
>      from sage.libs.gap.libgap import libgap
> -    libgap.eval("SetInfoLevel(InfoWarning,0)") # silence #I warnings from GAP (without IO pkg)
>      libgap.LoadPackage("AtlasRep")
>      g=libgap.AtlasGroup("G2(4)",libgap.NrMovedPoints,416)
> -    libgap.eval("SetInfoLevel(InfoWarning,1)") # restore #I warnings
>      h = Graph()
>      h.add_edges(g.Orbit([1,5],libgap.OnSets))
>      h.relabel()
> ```
> 
> It's still not a standard package, so these warnings will still happen if the IO package is not installed.  This isn't just a problem for sage-the-distribution.  E.g. on Debian it's perfectly possible (at least for now) to install the sagemath package without installing the gap-io package.


oh, I might have been confused by shaffling packages around. This chane makes sense if atlasrep is in gap-packages, but this is not the case any more.



---

archive/issue_comments_399623.json:
```json
{
    "body": "<a id='comment:35'></a>Replying to [comment:31 embray]:\n> This change\n> is not good.  You seem to have brought it over from some old branch for #26856, where I also had to remove it: #26856#comment:110\n\n\nduh... I looked at that diff, wondering whether there is some whitespace-only difference there, for it looked totally the same :-(",
    "created_at": "2019-01-23T22:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399623",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:35'></a>Replying to [comment:31 embray]:
> This change
> is not good.  You seem to have brought it over from some old branch for #26856, where I also had to remove it: #26856#comment:110


duh... I looked at that diff, wondering whether there is some whitespace-only difference there, for it looked totally the same :-(



---

archive/issue_comments_399624.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-23T22:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399624",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399625.json:
```json
{
    "body": "<a id='comment:37'></a>What should we do with comment 21? Just patch the GAP/io package source?",
    "created_at": "2019-01-23T22:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399625",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>What should we do with comment 21? Just patch the GAP/io package source?



---

archive/issue_comments_399626.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-23T22:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399626",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399627.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-01-23T22:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399627",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399628.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,6 +2,8 @@\n on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).\n \n Here is a branch that implements this.\n+\n+io package needs a small patch to use proper include directory\n \n Work_Issues: test it in libgap, also on OSX\n \n``````\n",
    "created_at": "2019-01-23T23:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399628",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,6 +2,8 @@
 on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).
 
 Here is a branch that implements this.
+
+io package needs a small patch to use proper include directory
 
 Work_Issues: test it in libgap, also on OSX
 
``````




---

archive/issue_comments_399629.json:
```json
{
    "body": "<a id='comment:41'></a>piing...",
    "created_at": "2019-01-28T11:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399629",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>piing...



---

archive/issue_comments_399630.json:
```json
{
    "body": "<a id='comment:42'></a>Hi!\n\nI'm currently trying to compile a bunch of GAP packages in Sage environment, and apparently, I need to add this:\n\n$ CFLAGS=\"-I../.. -I../../gen\" ./configure --with-gaproot=../..\n\nIs it the only way?",
    "created_at": "2019-02-04T17:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399630",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:42'></a>Hi!

I'm currently trying to compile a bunch of GAP packages in Sage environment, and apparently, I need to add this:

$ CFLAGS="-I../.. -I../../gen" ./configure --with-gaproot=../..

Is it the only way?



---

archive/issue_comments_399631.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-04T17:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399631",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399632.json:
```json
{
    "body": "<a id='comment:43'></a>I just looked into this with Odile, who was trying to compile the IO package.  I don't think patching the sources is the way.  It's strange that the configure script, even given a path to the gaproot, doesn't add this.  I will look into what is *intended* for this and see if there's a reason what we're doing with just passing `--with-gaproot` to configure doesn't work.\n\nEither it's a bug on our end, or a bug in the package's configure.  Odile was able to work around it by adding `CFLAGS=-I../../ -I../../gen` and that seemed to work (where `../../` here was the relative path to the gaproot).  If we have to do that we can, but it still smells like a hack.\n\nI also want to address #26930#comment:30",
    "created_at": "2019-02-04T17:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399632",
    "user": "https://github.com/embray"
}
```

<a id='comment:43'></a>I just looked into this with Odile, who was trying to compile the IO package.  I don't think patching the sources is the way.  It's strange that the configure script, even given a path to the gaproot, doesn't add this.  I will look into what is *intended* for this and see if there's a reason what we're doing with just passing `--with-gaproot` to configure doesn't work.

Either it's a bug on our end, or a bug in the package's configure.  Odile was able to work around it by adding `CFLAGS=-I../../ -I../../gen` and that seemed to work (where `../../` here was the relative path to the gaproot).  If we have to do that we can, but it still smells like a hack.

I also want to address #26930#comment:30



---

archive/issue_comments_399633.json:
```json
{
    "body": "<a id='comment:44'></a>I don't see why we should not patch package's source.\n\nIt's written with GAP's sources and headers alike living in GAPROOT/src/, and\nnaturally you can either create some foo/src to use in `-I`, or else, indeed, replace `src/` with `gap/`.\n\nI would like to see the log of the failure (without these extra CFLAGS)",
    "created_at": "2019-02-04T18:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399633",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:44'></a>I don't see why we should not patch package's source.

It's written with GAP's sources and headers alike living in GAPROOT/src/, and
naturally you can either create some foo/src to use in `-I`, or else, indeed, replace `src/` with `gap/`.

I would like to see the log of the failure (without these extra CFLAGS)



---

archive/issue_comments_399634.json:
```json
{
    "body": "<a id='comment:45'></a>*after a bare ./configure --with-gaproot=../..* :\n\n\n```\n(sage-sh) odile@ancolie:json-2.0.0$ make\n  CXX      src/json.lo\nsrc/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type\n #include \"src/compiled.h\"          /* GAP headers                */\n          ^~~~~~~~~~~~~~~~\ncompilation terminated.\nmake: *** [Makefile:501: src/json.lo] Error 1\n\n```",
    "created_at": "2019-02-04T18:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399634",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:45'></a>*after a bare ./configure --with-gaproot=../..* :


```
(sage-sh) odile@ancolie:json-2.0.0$ make
  CXX      src/json.lo
src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type
 #include "src/compiled.h"          /* GAP headers                */
          ^~~~~~~~~~~~~~~~
compilation terminated.
make: *** [Makefile:501: src/json.lo] Error 1

```



---

archive/issue_comments_399635.json:
```json
{
    "body": "<a id='comment:46'></a>Don't do things like this at `sage -sh` prompt, it's not meant for this.\n\nJust do the usual `./sage -f gap_packages` (with the branch pulled in, naturally).",
    "created_at": "2019-02-04T18:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399635",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:46'></a>Don't do things like this at `sage -sh` prompt, it's not meant for this.

Just do the usual `./sage -f gap_packages` (with the branch pulled in, naturally).



---

archive/issue_comments_399636.json:
```json
{
    "body": "<a id='comment:47'></a>and if you want more GAP packages installed, modify `gap_packages/spkg-install` accordingly.",
    "created_at": "2019-02-04T18:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399636",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:47'></a>and if you want more GAP packages installed, modify `gap_packages/spkg-install` accordingly.



---

archive/issue_comments_399637.json:
```json
{
    "body": "<a id='comment:48'></a>Could you point me to a documentation page for this?\n\n(I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)\n\nNote: I'm a complete newbie to GAP, not to mention GAP-in-Sage ..",
    "created_at": "2019-02-04T18:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399637",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:48'></a>Could you point me to a documentation page for this?

(I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)

Note: I'm a complete newbie to GAP, not to mention GAP-in-Sage ..



---

archive/issue_comments_399638.json:
```json
{
    "body": "<a id='comment:49'></a>Thanks anyway, I'll try that.",
    "created_at": "2019-02-04T18:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399638",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:49'></a>Thanks anyway, I'll try that.



---

archive/issue_comments_399639.json:
```json
{
    "body": "<a id='comment:50'></a>Here is my gap_packages-4.10.0.log[http://fluidinfo.fr/gap/gap_packages-4.10.0.log](http://fluidinfo.fr/gap/gap_packages-4.10.0.log)\n\nNote: I have a crypting-0.9 source directory, in my ./local/share/gap/pkg : for some reason it was not in the build directory as the other packages, I just copied it there and here is my second log[http://fluidinfo.fr/gap/gap_packages-4.10.0.log.1](http://fluidinfo.fr/gap/gap_packages-4.10.0.log.1)",
    "created_at": "2019-02-04T18:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399639",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:50'></a>Here is my gap_packages-4.10.0.log[http://fluidinfo.fr/gap/gap_packages-4.10.0.log](http://fluidinfo.fr/gap/gap_packages-4.10.0.log)

Note: I have a crypting-0.9 source directory, in my ./local/share/gap/pkg : for some reason it was not in the build directory as the other packages, I just copied it there and here is my second log[http://fluidinfo.fr/gap/gap_packages-4.10.0.log.1](http://fluidinfo.fr/gap/gap_packages-4.10.0.log.1)



---

archive/issue_comments_399640.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:48 zerline]:\n> Could you point me to a documentation page for this?\n> \n> (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)\n> \n\nThis link is totally obsolete - edited last time in 2013.\nI've just edited that page to make this clear. Sorry...",
    "created_at": "2019-02-04T18:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399640",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:51'></a>Replying to [comment:48 zerline]:
> Could you point me to a documentation page for this?
> 
> (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)
> 

This link is totally obsolete - edited last time in 2013.
I've just edited that page to make this clear. Sorry...



---

archive/issue_comments_399641.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:45 zerline]:\n> *after a bare ./configure --with-gaproot=../..* :\n> \n> \n> \n> ```\n> (sage-sh) odile@ancolie:json-2.0.0$ make\n>   CXX      src/json.lo\n> src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type\n>  #include \"src/compiled.h\"          /* GAP headers                */\n>           ^~~~~~~~~~~~~~~~\n> compilation terminated.\n> make: *** [Makefile:501: src/json.lo] Error 1\n> \n> ```\n\n\nThat's exactly one of the things I patch see #26930?replyto=45#comment:26",
    "created_at": "2019-02-04T18:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399641",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:52'></a>Replying to [comment:45 zerline]:
> *after a bare ./configure --with-gaproot=../..* :
> 
> 
> 
> ```
> (sage-sh) odile@ancolie:json-2.0.0$ make
>   CXX      src/json.lo
> src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type
>  #include "src/compiled.h"          /* GAP headers                */
>           ^~~~~~~~~~~~~~~~
> compilation terminated.
> make: *** [Makefile:501: src/json.lo] Error 1
> 
> ```


That's exactly one of the things I patch see #26930?replyto=45#comment:26



---

archive/issue_comments_399642.json:
```json
{
    "body": "<a id='comment:53'></a>Let us separate a review for this ticket and adding yet more GAP packages.\nI just opened #27218 for this purpose.",
    "created_at": "2019-02-04T18:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399642",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:53'></a>Let us separate a review for this ticket and adding yet more GAP packages.
I just opened #27218 for this purpose.



---

archive/issue_comments_399643.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-04T18:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399643",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399644.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:51 dimpase]:\n> Replying to [comment:48 zerline]:\n> > Could you point me to a documentation page for this?\n> > \n> > (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)\n> > \n\n> This link is totally obsolete - edited last time in 2013.\n> I've just edited that page to make this clear. Sorry...\n\n\nYet this method works .. especially if you want to also test GAP by itself: from the GAP console, apparently *these* packages (those compiled with the method above) are loaded.",
    "created_at": "2019-02-04T21:18:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399644",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:54'></a>Replying to [comment:51 dimpase]:
> Replying to [comment:48 zerline]:
> > Could you point me to a documentation page for this?
> > 
> > (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)
> > 

> This link is totally obsolete - edited last time in 2013.
> I've just edited that page to make this clear. Sorry...


Yet this method works .. especially if you want to also test GAP by itself: from the GAP console, apparently *these* packages (those compiled with the method above) are loaded.



---

archive/issue_comments_399645.json:
```json
{
    "body": "<a id='comment:55'></a>Replying to [comment:52 fbissey]:\n> Replying to [comment:45 zerline]:\n> > *after a bare ./configure --with-gaproot=../..* :\n> > \n> > \n> > \n> > ```\n> > (sage-sh) odile@ancolie:json-2.0.0$ make\n> >   CXX      src/json.lo\n> > src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type\n> >  #include \"src/compiled.h\"          /* GAP headers                */\n> >           ^~~~~~~~~~~~~~~~\n> > compilation terminated.\n> > make: *** [Makefile:501: src/json.lo] Error 1\n> > \n> > ```\n\n> \n> That's exactly one of the things I patch see #26930?replyto=45#comment:26 \n\n\nthank you",
    "created_at": "2019-02-04T21:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399645",
    "user": "https://trac.sagemath.org/admin/accounts/users/zerline"
}
```

<a id='comment:55'></a>Replying to [comment:52 fbissey]:
> Replying to [comment:45 zerline]:
> > *after a bare ./configure --with-gaproot=../..* :
> > 
> > 
> > 
> > ```
> > (sage-sh) odile@ancolie:json-2.0.0$ make
> >   CXX      src/json.lo
> > src/json.cc:5:10: fatal error: src/compiled.h: Aucun fichier ou dossier de ce type
> >  #include "src/compiled.h"          /* GAP headers                */
> >           ^~~~~~~~~~~~~~~~
> > compilation terminated.
> > make: *** [Makefile:501: src/json.lo] Error 1
> > 
> > ```

> 
> That's exactly one of the things I patch see #26930?replyto=45#comment:26 


thank you



---

archive/issue_comments_399646.json:
```json
{
    "body": "<a id='comment:56'></a>Replying to [comment:54 zerline]:\n> Replying to [comment:51 dimpase]:\n> > Replying to [comment:48 zerline]:\n> > > Could you point me to a documentation page for this?\n> > > \n> > > (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)\n> > > \n\n> > This link is totally obsolete - edited last time in 2013.\n> > I've just edited that page to make this clear. Sorry...\n\n> \n> Yet this method works .. especially if you want to also test GAP by itself: from the GAP console, apparently *these* packages (those compiled with the method above) are loaded.\n\n\nthere is no guarantee that one does not break GAP's installation in Sage this way - and it happened in the past often that people tried installing this way GAP packages with kernel modules (such as IO) and ended up with broken Sage installations.",
    "created_at": "2019-02-04T21:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399646",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:56'></a>Replying to [comment:54 zerline]:
> Replying to [comment:51 dimpase]:
> > Replying to [comment:48 zerline]:
> > > Could you point me to a documentation page for this?
> > > 
> > > (I just used https://wiki.sagemath.org/InstallingGapPackages, which recommends compiling within the Sage shell)
> > > 

> > This link is totally obsolete - edited last time in 2013.
> > I've just edited that page to make this clear. Sorry...

> 
> Yet this method works .. especially if you want to also test GAP by itself: from the GAP console, apparently *these* packages (those compiled with the method above) are loaded.


there is no guarantee that one does not break GAP's installation in Sage this way - and it happened in the past often that people tried installing this way GAP packages with kernel modules (such as IO) and ended up with broken Sage installations.



---

archive/issue_comments_399647.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-05T13:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399647",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399648.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2019-02-05T13:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399648",
    "user": "https://github.com/dimpase"
}
```

Changing priority from major to critical.



---

archive/issue_comments_399649.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,11 @@\n+On the libgap side, this requires tinkering with the loader, see\n+on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).\n \n+Here is a branch that implements this.\n+\n+GAP package sources use old location for GAP headers, so we need to set up a symbolic link to accommodate this. \n+\n+We also need to fix GAP's gac/libtool mini-toolchain, used by some GAP pkgs. This involves patching of gac, and installing libtool, see #27218 for details.\n \n Work_Issues: test it in libgap, also on OSX\n \n``````\n",
    "created_at": "2019-02-05T13:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399649",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,11 @@
+On the libgap side, this requires tinkering with the loader, see
+on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).
 
+Here is a branch that implements this.
+
+GAP package sources use old location for GAP headers, so we need to set up a symbolic link to accommodate this. 
+
+We also need to fix GAP's gac/libtool mini-toolchain, used by some GAP pkgs. This involves patching of gac, and installing libtool, see #27218 for details.
 
 Work_Issues: test it in libgap, also on OSX
 
``````




---

archive/issue_comments_399650.json:
```json
{
    "body": "<a id='comment:59'></a>Replying to [comment:44 dimpase]:\n> I don't see why we should not patch package's source.\n\n\nIt isn't necessary normally when building the package, so why should it have to be patched?  ISTM the problem is just how GAP is being \"installed\" in Sage, which as we know is tricky since it doesn't have a proper installation system.  \n\nI think the stuff Odile pointed out last night about `sysinfo.gap` clearly needs to be addressed (and in a separate ticket; this one is already trying to do too much).\n\nFor example, mine contains (this is just partial):\n\n```\n$ cat sysinfo.gap\n# This files has been generated by the GAP build system,\n# do not edit manually!\nGAParch=x86_64-unknown-cygwin-default64\nGAP_ABI=64\nGAP_HPCGAP=no\nGAP_ADDGUARDS2=\n\nGAP_BIN_DIR=\"/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src\"\nGAP_LIB_DIR=\"/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src\"\n\nGAP_CC=\"gcc\"\nGAP_CFLAGS=\" -O2 -g  \"\nGAP_CPPFLAGS=\" -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src/gen -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src/src -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src -DHAVE_CONFIG_H -I/home/embray/src/sagemath/sage/local/include      \"\nGAP_LDFLAGS=\" -L/home/embray/src/sagemath/sage/local/lib      -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib   -Wl,--stack,16777216\"\nGAP_LIBS=\" -lgmp -lz -lreadline    \"\n```\n\nIn other words, it puts in a lot of paths, which seem to be important for building many packages, but that reference the SPKG build directory and not the actual final GAP_ROOT location (under `$SAGE_LOCAL/share/gap`).\n\nSo I think this probably needs to be fixed up when \"installing\" GAP, at a minimum.",
    "created_at": "2019-02-05T15:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399650",
    "user": "https://github.com/embray"
}
```

<a id='comment:59'></a>Replying to [comment:44 dimpase]:
> I don't see why we should not patch package's source.


It isn't necessary normally when building the package, so why should it have to be patched?  ISTM the problem is just how GAP is being "installed" in Sage, which as we know is tricky since it doesn't have a proper installation system.  

I think the stuff Odile pointed out last night about `sysinfo.gap` clearly needs to be addressed (and in a separate ticket; this one is already trying to do too much).

For example, mine contains (this is just partial):

```
$ cat sysinfo.gap
# This files has been generated by the GAP build system,
# do not edit manually!
GAParch=x86_64-unknown-cygwin-default64
GAP_ABI=64
GAP_HPCGAP=no
GAP_ADDGUARDS2=

GAP_BIN_DIR="/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src"
GAP_LIB_DIR="/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src"

GAP_CC="gcc"
GAP_CFLAGS=" -O2 -g  "
GAP_CPPFLAGS=" -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src/gen -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src/src -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/gap-4.10.0/src -DHAVE_CONFIG_H -I/home/embray/src/sagemath/sage/local/include      "
GAP_LDFLAGS=" -L/home/embray/src/sagemath/sage/local/lib      -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib   -Wl,--stack,16777216"
GAP_LIBS=" -lgmp -lz -lreadline    "
```

In other words, it puts in a lot of paths, which seem to be important for building many packages, but that reference the SPKG build directory and not the actual final GAP_ROOT location (under `$SAGE_LOCAL/share/gap`).

So I think this probably needs to be fixed up when "installing" GAP, at a minimum.



---

archive/issue_comments_399651.json:
```json
{
    "body": "<a id='comment:60'></a>On the other hand, the problem of using src/ prefix for includes in quite a few GAP packages seems to be a bit too big to patch.",
    "created_at": "2019-02-05T15:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399651",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:60'></a>On the other hand, the problem of using src/ prefix for includes in quite a few GAP packages seems to be a bit too big to patch.



---

archive/issue_comments_399652.json:
```json
{
    "body": "<a id='comment:61'></a>This should be a dependent of #27218, not the other way around.   I think #27218 will help here.  I don't mind including crypting in this ticket as well since it is small and we know that it's been asked for.  Plus it helps to have an additional test case.",
    "created_at": "2019-02-05T16:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399652",
    "user": "https://github.com/embray"
}
```

<a id='comment:61'></a>This should be a dependent of #27218, not the other way around.   I think #27218 will help here.  I don't mind including crypting in this ticket as well since it is small and we know that it's been asked for.  Plus it helps to have an additional test case.



---

archive/issue_comments_399653.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n+These GAP packages extend GAP kernel functionality. \n+On the libgap side, this requires tinkering with the loader, see\n+on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).\n \n+Here is a branch that implements this.\n+\n+We also need to fix GAP's gac/libtool mini-toolchain, used by some GAP pkgs. This involves patching of gac, and installing libtool, done in #27218.\n \n Work_Issues: test it in libgap, also on OSX\n \n``````\n",
    "created_at": "2019-02-06T15:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399653",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,10 @@
+These GAP packages extend GAP kernel functionality. 
+On the libgap side, this requires tinkering with the loader, see
+on #22626 Erik [proposed a patch](https://trac.sagemath.org/ticket/22626#comment:424).
 
+Here is a branch that implements this.
+
+We also need to fix GAP's gac/libtool mini-toolchain, used by some GAP pkgs. This involves patching of gac, and installing libtool, done in #27218.
 
 Work_Issues: test it in libgap, also on OSX
 
``````




---

archive/issue_comments_399654.json:
```json
{
    "body": "<a id='comment:63'></a>I added yet one more ticket for working on a way to get the libgap.so: #27230\n\nThe idea, as in comment:30, was to use the same code for both `SINGULAR_SO` and a new `LIBGAP_SO` variable which serves a similar purpose.\n\nIf that code ends up being contentious we can fall back on a simpler method, though I think either way it makes sense to reuse the code used for `SINGULAR_SO` as well, rather than just looping over some extension names.",
    "created_at": "2019-02-06T16:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399654",
    "user": "https://github.com/embray"
}
```

<a id='comment:63'></a>I added yet one more ticket for working on a way to get the libgap.so: #27230

The idea, as in comment:30, was to use the same code for both `SINGULAR_SO` and a new `LIBGAP_SO` variable which serves a similar purpose.

If that code ends up being contentious we can fall back on a simpler method, though I think either way it makes sense to reuse the code used for `SINGULAR_SO` as well, rather than just looping over some extension names.



---

archive/issue_comments_399655.json:
```json
{
    "body": "<a id='comment:64'></a>New commits:",
    "created_at": "2019-02-06T16:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399655",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:64'></a>New commits:



---

archive/issue_comments_399656.json:
```json
{
    "body": "<a id='comment:65'></a>If you want, please also try merging #27230 into this and adding a `LIBGAP_SO` to `sage.env` like I suggested in that ticket, and then use that instead of the loop you have currently around `dlopen`.  That's a good observation that for Python 3 it will have to pass bytes to `dlopen()`, so you can use `str_to_bytes(LIBGAP_SO)` for that.",
    "created_at": "2019-02-06T16:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399656",
    "user": "https://github.com/embray"
}
```

<a id='comment:65'></a>If you want, please also try merging #27230 into this and adding a `LIBGAP_SO` to `sage.env` like I suggested in that ticket, and then use that instead of the loop you have currently around `dlopen`.  That's a good observation that for Python 3 it will have to pass bytes to `dlopen()`, so you can use `str_to_bytes(LIBGAP_SO)` for that.



---

archive/issue_comments_399657.json:
```json
{
    "body": "<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-06T20:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399658.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-06T20:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399658",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399659.json:
```json
{
    "body": "<a id='comment:67'></a>once #27230 done it will be ready for review",
    "created_at": "2019-02-06T20:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399659",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:67'></a>once #27230 done it will be ready for review



---

archive/issue_comments_399660.json:
```json
{
    "body": "<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-07T01:41:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399661.json:
```json
{
    "body": "<a id='comment:69'></a>so this is now really ready for review.",
    "created_at": "2019-02-07T01:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399661",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:69'></a>so this is now really ready for review.



---

archive/issue_comments_399662.json:
```json
{
    "body": "<a id='comment:70'></a>Is this supposed to work on distro with an unchanged gap or is the io package now required?",
    "created_at": "2019-02-07T11:55:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399662",
    "user": "https://github.com/timokau"
}
```

<a id='comment:70'></a>Is this supposed to work on distro with an unchanged gap or is the io package now required?



---

archive/issue_comments_399663.json:
```json
{
    "body": "<a id='comment:71'></a>Replying to [comment:70 gh-timokau]:\n> Is this supposed to work on distro with an unchanged gap or is the io package now required?\n\n\nno, io package is still optional. As you see, this ticket does two things:\n\n* fixes Sage's libgap interface to allow kernel modules\n\n* adds two packages (both needing the 1st thing) to its optional spkg gap_packages",
    "created_at": "2019-02-07T12:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399663",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:71'></a>Replying to [comment:70 gh-timokau]:
> Is this supposed to work on distro with an unchanged gap or is the io package now required?


no, io package is still optional. As you see, this ticket does two things:

* fixes Sage's libgap interface to allow kernel modules

* adds two packages (both needing the 1st thing) to its optional spkg gap_packages



---

archive/issue_comments_399664.json:
```json
{
    "body": "<a id='comment:72'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-08T20:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399664",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:72'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399665.json:
```json
{
    "body": "<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-26T11:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399665",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399666.json:
```json
{
    "body": "<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-27T21:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399666",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399667.json:
```json
{
    "body": "<a id='comment:76'></a>#27380 (extra `/` removed (sic!)) has apparently fixed the problem I had with this branch on OSX, upon running tests on my ancient MacBook it should be ready to go.",
    "created_at": "2019-02-27T22:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399667",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:76'></a>#27380 (extra `/` removed (sic!)) has apparently fixed the problem I had with this branch on OSX, upon running tests on my ancient MacBook it should be ready to go.



---

archive/issue_comments_399668.json:
```json
{
    "body": "<a id='comment:77'></a>Tests pass on OSX and Linux. Please review.",
    "created_at": "2019-02-28T07:01:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399668",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:77'></a>Tests pass on OSX and Linux. Please review.



---

archive/issue_comments_399669.json:
```json
{
    "body": "<a id='comment:78'></a>OSX-specific reviews are needed for this ticket and #27380",
    "created_at": "2019-02-28T07:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399669",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:78'></a>OSX-specific reviews are needed for this ticket and #27380



---

archive/issue_comments_399670.json:
```json
{
    "body": "<a id='comment:79'></a>Is there a reason this first \"installs\" crypting by copy in\n\n```diff\ndiff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install\nindex 1a3e8c5..07ce727 100644\n--- a/build/pkgs/gap_packages/spkg-install\n+++ b/build/pkgs/gap_packages/spkg-install\n@@ -15,6 +15,7 @@ sdh_install \\\n     AutoDoc-* \\\n     corelg \\\n     crime-* \\\n+    crypting-* \\\n     cryst \\\n     crystcat \\\n     design \\\n```\n\nbut then installs it again (including compilation) further down in\n\n```diff\n@@ -63,7 +64,7 @@ install_compiled_pkg()\n #\n # These packages have an old ./configure that take the GAP_ROOT as a positional\n # argument\n-for pkg in cohomolo-* grape-* guava-*\n+for pkg in cohomolo-* crypting-* grape-* guava-*\n do\n     echo \"Building GAP package $pkg\"\n     cd \"$PKG_SRC_DIR/$pkg\"\n```",
    "created_at": "2019-02-28T10:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399670",
    "user": "https://github.com/embray"
}
```

<a id='comment:79'></a>Is there a reason this first "installs" crypting by copy in

```diff
diff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install
index 1a3e8c5..07ce727 100644
--- a/build/pkgs/gap_packages/spkg-install
+++ b/build/pkgs/gap_packages/spkg-install
@@ -15,6 +15,7 @@ sdh_install \
     AutoDoc-* \
     corelg \
     crime-* \
+    crypting-* \
     cryst \
     crystcat \
     design \
```

but then installs it again (including compilation) further down in

```diff
@@ -63,7 +64,7 @@ install_compiled_pkg()
 #
 # These packages have an old ./configure that take the GAP_ROOT as a positional
 # argument
-for pkg in cohomolo-* grape-* guava-*
+for pkg in cohomolo-* crypting-* grape-* guava-*
 do
     echo "Building GAP package $pkg"
     cd "$PKG_SRC_DIR/$pkg"
```



---

archive/issue_comments_399671.json:
```json
{
    "body": "<a id='comment:80'></a>looks like a harmless typo...",
    "created_at": "2019-02-28T10:26:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399671",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:80'></a>looks like a harmless typo...



---

archive/issue_comments_399672.json:
```json
{
    "body": "<a id='comment:81'></a>Any comment on comment:32 ?  This test really shouldn't be giving unpredictable results.",
    "created_at": "2019-02-28T10:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399672",
    "user": "https://github.com/embray"
}
```

<a id='comment:81'></a>Any comment on comment:32 ?  This test really shouldn't be giving unpredictable results.



---

archive/issue_comments_399673.json:
```json
{
    "body": "<a id='comment:82'></a>Replying to [comment:80 dimpase]:\n> looks like a harmless typo...\n\n\nI wouldn't necessarily call it \"harmless\" but if it's a typo that's okay; I just wondered if there was a real reason or not.",
    "created_at": "2019-02-28T10:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399673",
    "user": "https://github.com/embray"
}
```

<a id='comment:82'></a>Replying to [comment:80 dimpase]:
> looks like a harmless typo...


I wouldn't necessarily call it "harmless" but if it's a typo that's okay; I just wondered if there was a real reason or not.



---

archive/issue_comments_399674.json:
```json
{
    "body": "<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-28T16:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399674",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399675.json:
```json
{
    "body": "<a id='comment:84'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-28T17:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399675",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:84'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399676.json:
```json
{
    "body": "<a id='comment:85'></a>Fixed both things.",
    "created_at": "2019-02-28T17:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399676",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:85'></a>Fixed both things.



---

archive/issue_comments_399677.json:
```json
{
    "body": "<a id='comment:86'></a>Seems to work on OS X. At least there is more stuff (`io`, `crypting`) in `local/share/gap/pkg` with this branch than without it. I'm not sure what the breakage was from #27380: `gap_packages` installed for me on top of a clean install of 8.7.beta5 without these branches.\n\nWhat else would you like me to check?",
    "created_at": "2019-02-28T18:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399677",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:86'></a>Seems to work on OS X. At least there is more stuff (`io`, `crypting`) in `local/share/gap/pkg` with this branch than without it. I'm not sure what the breakage was from #27380: `gap_packages` installed for me on top of a clean install of 8.7.beta5 without these branches.

What else would you like me to check?



---

archive/issue_comments_399678.json:
```json
{
    "body": "<a id='comment:87'></a>Replying to [comment:86 jhpalmieri]:\n> Seems to work on OS X. At least there is more stuff (`io`, `crypting`) in `local/share/gap/pkg` with this branch than without it. I'm not sure what the breakage was from #27380: `gap_packages` installed for me on top of a clean install of 8.7.beta5 without these branches.\n> \n\nbut some GAP packages were not fully functional, as their binaries (only few GAP packages have these) were installed in wrong directories...\n\n> What else would you like me to check?\n\n\ncould you run tests, just to have another data point? (I tested on OSX 10.13, I don't have 10.14, my OSX box is too old for it).",
    "created_at": "2019-02-28T18:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399678",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:87'></a>Replying to [comment:86 jhpalmieri]:
> Seems to work on OS X. At least there is more stuff (`io`, `crypting`) in `local/share/gap/pkg` with this branch than without it. I'm not sure what the breakage was from #27380: `gap_packages` installed for me on top of a clean install of 8.7.beta5 without these branches.
> 

but some GAP packages were not fully functional, as their binaries (only few GAP packages have these) were installed in wrong directories...

> What else would you like me to check?


could you run tests, just to have another data point? (I tested on OSX 10.13, I don't have 10.14, my OSX box is too old for it).



---

archive/issue_comments_399679.json:
```json
{
    "body": "<a id='comment:88'></a>All tests pass for me. I didn't run full tests with `gap_packages` but without this branch, but I ran limited tests and saw one failure in `sage/groups`. So this looks good to me.",
    "created_at": "2019-02-28T20:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399679",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:88'></a>All tests pass for me. I didn't run full tests with `gap_packages` but without this branch, but I ran limited tests and saw one failure in `sage/groups`. So this looks good to me.



---

archive/issue_comments_399680.json:
```json
{
    "body": "<a id='comment:89'></a>I don't have a great internet connection at the moment but I can test on macosx 10.14.2 by Monday, if not earlier. This said, since this is a package can some one please tell me what needs to be tested. Is `sage -i io && sage -i macosx && make ptestlong` enough?",
    "created_at": "2019-03-01T13:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399680",
    "user": "https://github.com/AndrewAtLarge"
}
```

<a id='comment:89'></a>I don't have a great internet connection at the moment but I can test on macosx 10.14.2 by Monday, if not earlier. This said, since this is a package can some one please tell me what needs to be tested. Is `sage -i io && sage -i macosx && make ptestlong` enough?



---

archive/issue_comments_399681.json:
```json
{
    "body": "<a id='comment:90'></a>Replying to [comment:89 andrew.mathas]:\n> I don't have a great internet connection at the moment but I can test on macosx 10.14.2 by Monday, if not earlier. This said, since this is a package can some one please tell me what needs to be tested. Is `sage -i io && sage -i macosx && make ptestlong` enough? \n\n\nYou just need to pull the branch, the GAP tarball is the same. So can be done over GSM :-)\n\nAfter merging the branch, you'll need to do \n\n```\n./sage -f gap_packages && make ptestlong\n```\nAnd if there are errors in tests, please posts them (from `logs/ptestlong.log` file).\nThanks!",
    "created_at": "2019-03-01T13:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399681",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:90'></a>Replying to [comment:89 andrew.mathas]:
> I don't have a great internet connection at the moment but I can test on macosx 10.14.2 by Monday, if not earlier. This said, since this is a package can some one please tell me what needs to be tested. Is `sage -i io && sage -i macosx && make ptestlong` enough? 


You just need to pull the branch, the GAP tarball is the same. So can be done over GSM :-)

After merging the branch, you'll need to do 

```
./sage -f gap_packages && make ptestlong
```
And if there are errors in tests, please posts them (from `logs/ptestlong.log` file).
Thanks!



---

archive/issue_comments_399682.json:
```json
{
    "body": "<a id='comment:91'></a>On Cygwin I'm getting a few cases of this failure in `src/sage/coding/linear_code.py`:\n\n```\nsage -t --long src/sage/coding/linear_code.py\n**********************************************************************\nFile \"src/sage/coding/linear_code.py\", line 3134, in sage.coding.linear_code.AbstractLinearCode.weight_distribution\nFailed example:\n    C.weight_distribution(algorithm=\"leon\")   # optional - gap_packages (Guava package)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.coding.linear_code.AbstractLinearCode.weight_distribution[8]>\", line 1, in <module>\n        C.weight_distribution(algorithm=\"leon\")   # optional - gap_packages (Guava package)\n      File \"sage/misc/cachefunc.pyx\", line 1950, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10265)\n        w = self._instance_call(*args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1826, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9750)\n        return self.f(self._instance, *args, **kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/coding/linear_code.py\", line 3184, in weight_distribution\n        lines = subprocess.check_output([os.path.join(guava_bin_dir, 'wtdist'), input])\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/subprocess.py\", line 223, in check_output\n        raise CalledProcessError(retcode, cmd, output=output)\n    CalledProcessError: Command '['/home/embray/src/sagemath/sage/local/share/gap/pkg/guava-3.14/bin/x86_64-unknown-cygwin-default64/wtdist', '/home/embray/.sage/temp/NAVI-Brick/6764/tmp_7ZlhoX::code']' returned non-zero exit status -11\n```\n\nThe \"exit status -11\" indicates that the `wtdist` program, whatever that is, from the guava package is segfaulting.  Which is odd because I don't remember having any problem with that before, and it's not clear why it would start with this ticket (unless maybe it's doing something with the IO module that it didn't do when it was unavailable).\n\nI'm going to try backing out the changes from this ticket and rebuilding `gap_packages` again just to rule out the possibility that the problem is somehow related to this ticket.",
    "created_at": "2019-03-01T15:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399682",
    "user": "https://github.com/embray"
}
```

<a id='comment:91'></a>On Cygwin I'm getting a few cases of this failure in `src/sage/coding/linear_code.py`:

```
sage -t --long src/sage/coding/linear_code.py
**********************************************************************
File "src/sage/coding/linear_code.py", line 3134, in sage.coding.linear_code.AbstractLinearCode.weight_distribution
Failed example:
    C.weight_distribution(algorithm="leon")   # optional - gap_packages (Guava package)
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.coding.linear_code.AbstractLinearCode.weight_distribution[8]>", line 1, in <module>
        C.weight_distribution(algorithm="leon")   # optional - gap_packages (Guava package)
      File "sage/misc/cachefunc.pyx", line 1950, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10265)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1826, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:9750)
        return self.f(self._instance, *args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/coding/linear_code.py", line 3184, in weight_distribution
        lines = subprocess.check_output([os.path.join(guava_bin_dir, 'wtdist'), input])
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/subprocess.py", line 223, in check_output
        raise CalledProcessError(retcode, cmd, output=output)
    CalledProcessError: Command '['/home/embray/src/sagemath/sage/local/share/gap/pkg/guava-3.14/bin/x86_64-unknown-cygwin-default64/wtdist', '/home/embray/.sage/temp/NAVI-Brick/6764/tmp_7ZlhoX::code']' returned non-zero exit status -11
```

The "exit status -11" indicates that the `wtdist` program, whatever that is, from the guava package is segfaulting.  Which is odd because I don't remember having any problem with that before, and it's not clear why it would start with this ticket (unless maybe it's doing something with the IO module that it didn't do when it was unavailable).

I'm going to try backing out the changes from this ticket and rebuilding `gap_packages` again just to rule out the possibility that the problem is somehow related to this ticket.



---

archive/issue_comments_399683.json:
```json
{
    "body": "<a id='comment:92'></a>we didn't build this part of guava before, that's why...",
    "created_at": "2019-03-01T17:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399683",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:92'></a>we didn't build this part of guava before, that's why...



---

archive/issue_comments_399684.json:
```json
{
    "body": "<a id='comment:93'></a>I don't see anything explicitly in this ticket that would cause it to start being built though, so I'm a little confused.  Is it because we didn't have #27218?  Does it just, silently not build or something?",
    "created_at": "2019-03-01T17:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399684",
    "user": "https://github.com/embray"
}
```

<a id='comment:93'></a>I don't see anything explicitly in this ticket that would cause it to start being built though, so I'm a little confused.  Is it because we didn't have #27218?  Does it just, silently not build or something?



---

archive/issue_comments_399685.json:
```json
{
    "body": "<a id='comment:94'></a>AFAICT the code that uses it doesn't check if the `wtdist` program exists or not or anything like that, so it should have just failed before with a command not found or something if it wasn't being built...",
    "created_at": "2019-03-01T17:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399685",
    "user": "https://github.com/embray"
}
```

<a id='comment:94'></a>AFAICT the code that uses it doesn't check if the `wtdist` program exists or not or anything like that, so it should have just failed before with a command not found or something if it wasn't being built...



---

archive/issue_comments_399686.json:
```json
{
    "body": "<a id='comment:95'></a>Well I was able to reproduce that issue with `gap_packages` prior to this ticket so I guess it's unrelated.  I'll make a new ticket for it. I'm not overly concerned about it in this case since gap_packages is not installed by default anyways.\n\nAs a side note, I realized in testing this that it this ticket should also bump the patch version on the SPKG version.\n\nWe should also clean up the commit history.  I can go ahead and do that...",
    "created_at": "2019-03-01T18:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399686",
    "user": "https://github.com/embray"
}
```

<a id='comment:95'></a>Well I was able to reproduce that issue with `gap_packages` prior to this ticket so I guess it's unrelated.  I'll make a new ticket for it. I'm not overly concerned about it in this case since gap_packages is not installed by default anyways.

As a side note, I realized in testing this that it this ticket should also bump the patch version on the SPKG version.

We should also clean up the commit history.  I can go ahead and do that...



---

archive/issue_comments_399687.json:
```json
{
    "body": "<a id='comment:96'></a>oops, sorry, I meant it was not installed before GAP 4.10.\nI gather it could be something trivial like whether or not there is `.exe` suffix...\n\nYes, please, bump up the version and rebase. The follow-up to this is #27295.",
    "created_at": "2019-03-01T18:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399687",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:96'></a>oops, sorry, I meant it was not installed before GAP 4.10.
I gather it could be something trivial like whether or not there is `.exe` suffix...

Yes, please, bump up the version and rebase. The follow-up to this is #27295.



---

archive/issue_comments_399688.json:
```json
{
    "body": "<a id='comment:97'></a>Okay, I'm fine with this now, especially since you tested on OSX.\n\n---\nNew commits:",
    "created_at": "2019-03-01T18:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399688",
    "user": "https://github.com/embray"
}
```

<a id='comment:97'></a>Okay, I'm fine with this now, especially since you tested on OSX.

---
New commits:



---

archive/issue_comments_399689.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-01T18:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399689",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399690.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-03-01T18:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399690",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_399691.json:
```json
{
    "body": "<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2019-03-01T18:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399691",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:98'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_399692.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-01T18:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399692",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399693.json:
```json
{
    "body": "<a id='comment:99'></a>Just reworded one of the commit messages.",
    "created_at": "2019-03-01T18:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399693",
    "user": "https://github.com/embray"
}
```

<a id='comment:99'></a>Just reworded one of the commit messages.



---

archive/issue_events_066699.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-03-03T22:38:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26930#event-66699"
}
```



---

archive/issue_comments_399694.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-03T22:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26930",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26930#issuecomment-399694",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
