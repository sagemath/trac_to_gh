# Issue 26546: matrix_gfpn_dense: refactor field_to_int()

archive/issues_026309.json:
```json
{
    "body": "```\nsage: from sage.matrix.matrix_gfpn_dense import PrimeFieldConverter_class\nsage: C = PrimeFieldConverter_class(GF(5))\nsage: C.field_to_int(\"foo\")\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\nValueError: invalid literal for int() with base 10: 'foo'\nException ValueError: \"invalid literal for int() with base 10: 'foo'\" in 'sage.matrix.matrix_gfpn_dense.PrimeFieldConverter_class.field_to_int' ignored\n0\n```\n\nMaybe all calls to `field_to_int` are done safely such that doesn't occur in practice. But still, it seems safer to have proper exception handling here.\n\nI also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.\n\nCC:  simonking\n\nBranch/Commit: 3156293eb39ab4f5c8278e583d19fe0a6724ad4d\n\nReviewer: Simon King\n\nAuthor: Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26546\n\n",
    "closed_at": "2018-12-07T12:10:43Z",
    "created_at": "2018-10-24T09:45:15Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "matrix_gfpn_dense: refactor field_to_int()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26546",
    "user": "https://github.com/jdemeyer"
}
```
```
sage: from sage.matrix.matrix_gfpn_dense import PrimeFieldConverter_class
sage: C = PrimeFieldConverter_class(GF(5))
sage: C.field_to_int("foo")
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
ValueError: invalid literal for int() with base 10: 'foo'
Exception ValueError: "invalid literal for int() with base 10: 'foo'" in 'sage.matrix.matrix_gfpn_dense.PrimeFieldConverter_class.field_to_int' ignored
0
```

Maybe all calls to `field_to_int` are done safely such that doesn't occur in practice. But still, it seems safer to have proper exception handling here.

I also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.

CC:  simonking

Branch/Commit: 3156293eb39ab4f5c8278e583d19fe0a6724ad4d

Reviewer: Simon King

Author: Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26546





---

archive/issue_comments_370193.json:
```json
{
    "body": "Simon, what you do think about this:\n\n> I also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.",
    "created_at": "2018-10-24T10:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370193",
    "user": "https://github.com/jdemeyer"
}
```

Simon, what you do think about this:

> I also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.



---

archive/issue_comments_370194.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 jdemeyer]:\n> Simon, what you do think about this:\n> \n> > I also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.\n\n\nThat seems to make sense.\n\nIf I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.",
    "created_at": "2018-10-24T10:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370194",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>Replying to [comment:3 jdemeyer]:
> Simon, what you do think about this:
> 
> > I also noted that `field_to_int` and `int_to_field` are only ever used together with `FfToInt` and `FfFromInt`. So it makes a lot of sense to move those calls to `FieldConverter_class`.


That seems to make sense.

If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.



---

archive/issue_comments_370195.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 SimonKing]:\n> If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.\n\n\nMy plan was to change this to take a `FEL` as argument and return a `FEL` and then use `except? 255`. If you agree, I'll make that change.",
    "created_at": "2018-10-24T10:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370195",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [comment:4 SimonKing]:
> If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.


My plan was to change this to take a `FEL` as argument and return a `FEL` and then use `except? 255`. If you agree, I'll make that change.



---

archive/issue_comments_370196.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jdemeyer]:\n> Replying to [comment:4 SimonKing]:\n> > If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.\n\n> \n> My plan was to change this to take a `FEL` as argument and return a `FEL` and then use `except? 255`. If you agree, I'll make that change.\n\n\nAre you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.\n\nIn any case, if you have a function returning FEL, you can do `except 255` without `?`, as the size of a field is at most 251.",
    "created_at": "2018-10-24T10:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370196",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>Replying to [comment:5 jdemeyer]:
> Replying to [comment:4 SimonKing]:
> > If I see that correctly, `field_to_int` actually returns non-negative integers. Therefore, it would be easiest to impose `except -1` in the function declaration.

> 
> My plan was to change this to take a `FEL` as argument and return a `FEL` and then use `except? 255`. If you agree, I'll make that change.


Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.

In any case, if you have a function returning FEL, you can do `except 255` without `?`, as the size of a field is at most 251.



---

archive/issue_comments_370197.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 SimonKing]:\n> Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.\n\n\nYes, that's exactly what I meant: replace `int` by `FEL`.",
    "created_at": "2018-10-24T11:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370197",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:6 SimonKing]:
> Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.


Yes, that's exactly what I meant: replace `int` by `FEL`.



---

archive/issue_comments_370198.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 jdemeyer]:\n> Replying to [comment:6 SimonKing]:\n> > Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.\n\n> \n> Yes, that's exactly what I meant: replace `int` by `FEL`.\n\n\nOK, as long as you do not want to change the input of `field_to_int` or the output of `int_to_field`, because that would clearly be a Sage object (element of `GF(25,'x')`, for example).\n\nThen, it should probably be called `field_to_fel` and `fel_to_field`. How could these be doc tested, as FEL is a C type?",
    "created_at": "2018-10-24T11:58:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370198",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 SimonKing]:
> > Are you sure that's how the function is used? It is supposed to be a conversion between good old Sage field elements (python objects!) and FEL.

> 
> Yes, that's exactly what I meant: replace `int` by `FEL`.


OK, as long as you do not want to change the input of `field_to_int` or the output of `int_to_field`, because that would clearly be a Sage object (element of `GF(25,'x')`, for example).

Then, it should probably be called `field_to_fel` and `fel_to_field`. How could these be doc tested, as FEL is a C type?



---

archive/issue_comments_370199.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 SimonKing]:\n> How could these be doc tested, as FEL is a C type?\n\n\nWell, `int` is also a C type and you're already testing that...",
    "created_at": "2018-10-24T12:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370199",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [comment:8 SimonKing]:
> How could these be doc tested, as FEL is a C type?


Well, `int` is also a C type and you're already testing that...



---

archive/issue_comments_370200.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:\n> Replying to [comment:8 SimonKing]:\n> > How could these be doc tested, as FEL is a C type?\n\n> \n> Well, `int` is also a C type and you're already testing that...\n\n\nSure. Actually I thought it already is a problem if one renames a C type to some equivalent type. But if that's not a problem, then FEL certainly is the way to go.",
    "created_at": "2018-10-24T12:14:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370200",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 SimonKing]:
> > How could these be doc tested, as FEL is a C type?

> 
> Well, `int` is also a C type and you're already testing that...


Sure. Actually I thought it already is a problem if one renames a C type to some equivalent type. But if that's not a problem, then FEL certainly is the way to go.



---

archive/issue_comments_370201.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-10-26T08:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370201",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_370202.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-26T08:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370202",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370203.json:
```json
{
    "body": "<a id='comment:15'></a>What does \"cdef readonly\" mean?",
    "created_at": "2018-10-26T10:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370203",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>What does "cdef readonly" mean?



---

archive/issue_comments_370204.json:
```json
{
    "body": "<a id='comment:16'></a>This comment\n\n```\n.. WARNING::\n\n        Before calling the ``fel_to_field`` or ``field_to_fel`` methods,\n        one should call the ``FfSetField`` function.\n```\n(appearing at least twice) looks potentially confusing. The user might ask, HOW to call ``FfSetField``. Since it's a C library function, the user cannot call it, unless she writes Cython code.",
    "created_at": "2018-10-26T10:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370204",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>This comment

```
.. WARNING::

        Before calling the ``fel_to_field`` or ``field_to_fel`` methods,
        one should call the ``FfSetField`` function.
```
(appearing at least twice) looks potentially confusing. The user might ask, HOW to call ``FfSetField``. Since it's a C library function, the user cannot call it, unless she writes Cython code.



---

archive/issue_comments_370205.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 SimonKing]:\n> What does \"cdef readonly\" mean?\n\n\nAccessible from Python, but read-only (contrary to `cdef public` which is read-write)",
    "created_at": "2018-10-26T11:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370205",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>Replying to [comment:15 SimonKing]:
> What does "cdef readonly" mean?


Accessible from Python, but read-only (contrary to `cdef public` which is read-write)



---

archive/issue_comments_370206.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 SimonKing]:\n> Since it's a C library function, the user cannot call it, unless she writes Cython code.\n\n\nThe whole thing is only really useful for Cython anyway... but I see your point.",
    "created_at": "2018-10-26T11:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370206",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>Replying to [comment:16 SimonKing]:
> Since it's a C library function, the user cannot call it, unless she writes Cython code.


The whole thing is only really useful for Cython anyway... but I see your point.



---

archive/issue_comments_370207.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-29T18:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370207",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370208.json:
```json
{
    "body": "<a id='comment:20'></a>The changes look good to me and the tests at least in sage/matrix pass. Later I will run a complete test, and if that works it will be positive review.",
    "created_at": "2018-11-02T12:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370208",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:20'></a>The changes look good to me and the tests at least in sage/matrix pass. Later I will run a complete test, and if that works it will be positive review.



---

archive/issue_comments_370209.json:
```json
{
    "body": "<a id='comment:21'></a>Tests pass, so, here is the previously announced positive review.",
    "created_at": "2018-11-02T23:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370209",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'></a>Tests pass, so, here is the previously announced positive review.



---

archive/issue_comments_370210.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-02T23:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370210",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370211.json:
```json
{
    "body": "<a id='comment:22'></a>See patchbot\n\n```\nsage -t --long src/sage/matrix/matrix_gfpn_dense.pyx  # 2 doctests failed\n```",
    "created_at": "2018-11-06T21:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370211",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>See patchbot

```
sage -t --long src/sage/matrix/matrix_gfpn_dense.pyx  # 2 doctests failed
```



---

archive/issue_comments_370212.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-11-06T21:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370212",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_370213.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 vbraun]:\n> See patchbot\n> \n> ```\n> sage -t --long src/sage/matrix/matrix_gfpn_dense.pyx  # 2 doctests failed\n> ```\n\n\nRight, that test lacks `# optional: meataxe`. So, that test will fail if and only if meataxe is not installed (that's why that error didn't occur for me).",
    "created_at": "2018-11-06T21:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370213",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>Replying to [comment:22 vbraun]:
> See patchbot
> 
> ```
> sage -t --long src/sage/matrix/matrix_gfpn_dense.pyx  # 2 doctests failed
> ```


Right, that test lacks `# optional: meataxe`. So, that test will fail if and only if meataxe is not installed (that's why that error didn't occur for me).



---

archive/issue_comments_370214.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-12-04T08:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370214",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_370215.json:
```json
{
    "body": "<a id='comment:25'></a>I just noticed that the forgotten \"# optional\" still hasn't been added.\n\nFixed, tests pass now with and without optional meataxe. I suppose I can return to giving a positive review, as the new commit can be considered a \"reviewer patch\".\n\n---\nNew commits:",
    "created_at": "2018-12-04T08:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370215",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'></a>I just noticed that the forgotten "# optional" still hasn't been added.

Fixed, tests pass now with and without optional meataxe. I suppose I can return to giving a positive review, as the new commit can be considered a "reviewer patch".

---
New commits:



---

archive/issue_comments_370216.json:
```json
{
    "body": "<a id='comment:26'></a>If it passes tests, sure.",
    "created_at": "2018-12-04T10:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370216",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>If it passes tests, sure.



---

archive/issue_comments_370217.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-07T12:10:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26546#issuecomment-370217",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_065944.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-07T12:10:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26546",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26546#event-65944"
}
```
