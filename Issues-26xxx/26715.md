# Issue 26715: build/pkgs/gfortran/spkg-configure.m4 works incorrectly if CC and CXX are already there

archive/issues_026478.json:
```json
{
    "assignees": [],
    "body": "As a result of refactoring configure.ac in #24919,\nabsence of (g)fortran now forces installation of full gcc, instead of just gfortran part of it.\n\nThis is particularly crucial on OSX, where we don't normally build full gcc any more, but only build gfortran.\n\nTo reproduce, move gfortran out of your PATH, and re-run ./configure. You'll see that now `gcc` and `gfortran` are scheduled for installation...\n\n\n\nCC:  @embray @jhpalmieri @vbraun @kiwifb\n\nBranch: **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)**\n\nReviewer: **Erik Bray**\n\nAuthor: **Fran\u00e7ois Bissey**\n\nComponent: **build: configure**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26715_\n\n",
    "closed_at": "2018-11-21T19:54:53Z",
    "created_at": "2018-11-18T10:54:03Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build%3A%20configure",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20build%3A%20configure"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "build/pkgs/gfortran/spkg-configure.m4 works incorrectly if CC and CXX are already there",
    "type": "issue",
    "updated_at": "2019-02-12T09:19:23Z",
    "url": "https://github.com/sagemath/sage/issues/26715",
    "user": "https://github.com/dimpase"
}
```
As a result of refactoring configure.ac in #24919,
absence of (g)fortran now forces installation of full gcc, instead of just gfortran part of it.

This is particularly crucial on OSX, where we don't normally build full gcc any more, but only build gfortran.

To reproduce, move gfortran out of your PATH, and re-run ./configure. You'll see that now `gcc` and `gfortran` are scheduled for installation...



CC:  @embray @jhpalmieri @vbraun @kiwifb

Branch: **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)**

Reviewer: **Erik Bray**

Author: **Fran√ßois Bissey**

Component: **build: configure**

_Issue created by migration from https://trac.sagemath.org/ticket/26715_





---

archive/issue_events_364374.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-11-18T10:54:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364374"
}
```



---

archive/issue_events_364375.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-11-18T10:54:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build%3A%20configure",
    "label_color": "0000b0",
    "label_name": "c: build: configure",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364375"
}
```



---

archive/issue_events_364376.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-11-18T10:54:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364376"
}
```



---

archive/issue_events_364377.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2018-11-18T10:54:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364377"
}
```



---

archive/issue_comments_411392.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n-As a result of refactoring configure.ac in #24919, it appears that\n+As a result of refactoring configure.ac in #24919,\n absence of (g)fortran now forces installation of full gcc, instead of just gfortran part of it.\n \n This is particularly crucial on OSX, where we don't normally build full gcc any more, but only build gfortran.\n \n+To reproduce, move gfortran out of your PATH, and re-run ./configure. You'll see that now `gcc` and `gfortran` are scheduled for installation...\n \n+\n``````\n",
    "created_at": "2018-11-18T19:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411392",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
-As a result of refactoring configure.ac in #24919, it appears that
+As a result of refactoring configure.ac in #24919,
 absence of (g)fortran now forces installation of full gcc, instead of just gfortran part of it.
 
 This is particularly crucial on OSX, where we don't normally build full gcc any more, but only build gfortran.
 
+To reproduce, move gfortran out of your PATH, and re-run ./configure. You'll see that now `gcc` and `gfortran` are scheduled for installation...
 
+
``````




---

archive/issue_comments_411393.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nIt appears that all what's needed is\n\n```diff\n--- a/build/pkgs/gfortran/spkg-configure.m4\n+++ b/build/pkgs/gfortran/spkg-configure.m4\n@@ -14,7 +14,6 @@ SAGE_SPKG_CONFIGURE([gfortran], [\n         # compiler.\n         if test -z \"$FC\"; then\n             sage_spkg_install_gfortran=yes\n-            SAGE_MUST_INSTALL_GCC([a Fortran compiler is missing])\n         fi\n \n         # see http://www.gnu.org/software/hello/manual/autoconf/Fortran-Compiler.html\n```\n\nwith this change, and no gfortran in `PATH`, everything looks as it should after running `./configure`.\n\nCould someone with access to OSX please try this? (Don't forget to run ./bootstrap before\n./configure, i.e. you do need autotools for such a check...).",
    "created_at": "2018-11-18T19:38:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411393",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:2" align="right">comment:2</div>

It appears that all what's needed is

```diff
--- a/build/pkgs/gfortran/spkg-configure.m4
+++ b/build/pkgs/gfortran/spkg-configure.m4
@@ -14,7 +14,6 @@ SAGE_SPKG_CONFIGURE([gfortran], [
         # compiler.
         if test -z "$FC"; then
             sage_spkg_install_gfortran=yes
-            SAGE_MUST_INSTALL_GCC([a Fortran compiler is missing])
         fi
 
         # see http://www.gnu.org/software/hello/manual/autoconf/Fortran-Compiler.html
```

with this change, and no gfortran in `PATH`, everything looks as it should after running `./configure`.

Could someone with access to OSX please try this? (Don't forget to run ./bootstrap before
./configure, i.e. you do need autotools for such a check...).



---

archive/issue_comments_411394.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThis is all a bit tricky. What control logic is there when you don't have gfortran (so that the above check will say `sage_spkg_install_gfortran=yes`) but gcc must be installed as well?",
    "created_at": "2018-11-18T21:17:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411394",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:3" align="right">comment:3</div>

This is all a bit tricky. What control logic is there when you don't have gfortran (so that the above check will say `sage_spkg_install_gfortran=yes`) but gcc must be installed as well?



---

archive/issue_comments_411395.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@kiwifb](#comment%3A3):\n> This is all a bit tricky. What control logic is there when you don't have gfortran (so that the above check will say `sage_spkg_install_gfortran=yes`) but gcc must be installed as well?\n\nThere is `build/pkgs/gcc/spkg-configure.m4` which should take care of this.",
    "created_at": "2018-11-18T21:22:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411395",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@kiwifb](#comment%3A3):
> This is all a bit tricky. What control logic is there when you don't have gfortran (so that the above check will say `sage_spkg_install_gfortran=yes`) but gcc must be installed as well?

There is `build/pkgs/gcc/spkg-configure.m4` which should take care of this.



---

archive/issue_comments_411396.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@dimpase](#comment%3A4):\n> Replying to [@kiwifb](#comment%3A3):\n> > This is all a bit tricky. What control logic is there when you don't have gfortran (so that the above check will say `sage_spkg_install_gfortran=yes`) but gcc must be installed as well?\n\n> \n> There is `build/pkgs/gcc/spkg-configure.m4` which should take care of this.\n\nIt doesn't but the the section of code you point too in the diff can only be reached if `sage_spkg_install_gcc` is no. Otherwise the variable I was worried about is set to no.\n\nThe only real issue to be careful here is that the gcc bit needs to be run before the gfortran bit. If we go by lexical order everything is fine in this particular case. But that may be something to remember if there is ever another package with an \"optional split\" or a where checking a dependency first is important.",
    "created_at": "2018-11-18T21:30:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411396",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@dimpase](#comment%3A4):
> Replying to [@kiwifb](#comment%3A3):
> > This is all a bit tricky. What control logic is there when you don't have gfortran (so that the above check will say `sage_spkg_install_gfortran=yes`) but gcc must be installed as well?

> 
> There is `build/pkgs/gcc/spkg-configure.m4` which should take care of this.

It doesn't but the the section of code you point too in the diff can only be reached if `sage_spkg_install_gcc` is no. Otherwise the variable I was worried about is set to no.

The only real issue to be careful here is that the gcc bit needs to be run before the gfortran bit. If we go by lexical order everything is fine in this particular case. But that may be something to remember if there is ever another package with an "optional split" or a where checking a dependency first is important.



---

archive/issue_comments_411397.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nIt seems to be the case for \"package Bar provides functionality Foo\" kind of stuff that one can dive in :-P\n\nShould this Sage component be called YAPS (Yet Another Packaging System)? And by virtue of name it must be implemented in yaml...",
    "created_at": "2018-11-18T23:04:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411397",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:6" align="right">comment:6</div>

It seems to be the case for "package Bar provides functionality Foo" kind of stuff that one can dive in :-P

Should this Sage component be called YAPS (Yet Another Packaging System)? And by virtue of name it must be implemented in yaml...



---

archive/issue_comments_411398.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nAmusing. But more seriously your diff certainly point to an issue that needs to be fixed and is logically what we are after. However the line probably should be replaced with a notice. It was probably the intent in the first place. When do you intend to submit a branch for review?",
    "created_at": "2018-11-18T23:51:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411398",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:7" align="right">comment:7</div>

Amusing. But more seriously your diff certainly point to an issue that needs to be fixed and is logically what we are after. However the line probably should be replaced with a notice. It was probably the intent in the first place. When do you intend to submit a branch for review?



---

archive/issue_comments_411399.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@kiwifb](#comment%3A7):\n> Amusing. But more seriously your diff certainly point to an issue that needs to be fixed and is logically what we are after. However the line probably should be replaced with a notice. It was probably the intent in the first place. When do you intend to submit a branch for review?\n\nI think having some kind of notice was the intent, though written exactly as I did was probably a mistake on my part.  Looking at the diff from #24919, this is the original code I removed from `configure.ac`:\n\n```diff\n-# Check that the Fortran compiler accepts free-format source code\n-# (as opposed to the older fixed-format style from Fortran 77).\n-# This helps verify the compiler works too, so if some idiot\n-# sets FC to /usr/bin/ls, we will at least know it's\n-# not a working Fortran compiler.\n-AC_LANG(Fortran)\n-if test -z \"$FC\"; then\n-    need_to_install_gfortran=yes\n-else\n```\n\nand this is the equivalent code that was moved to `build/pkgs/gfortran/spkg-configure.m4`:\n\n```diff\n+        # Check that the Fortran compiler accepts free-format source code (as\n+        # opposed to the older fixed-format style from Fortran 77).\n+        # This helps verify the compiler works too, so if some idiot sets FC to\n+        # /usr/bin/ls, we will at least know it's not a working Fortran\n+        # compiler.\n+        if test -z \"$FC\"; then\n+            sage_spkg_install_gfortran=yes\n+            SAGE_MUST_INSTALL_GCC([a Fortran compiler is missing])\n+        fi\n```\n\nThe use of the `SAGE_MUST_INSTALL_GCC` macro here is a mistake.  It *might* be a remnant from before we created a separate \"gfortran\" package (that actually happened after I first introduced #24919, and while I tried to incorporate that change it looks like this might have been left in).\n\nAs Dima suggested it can just be removed and/or replaced with an `AC_MSG_NOTICE`.",
    "created_at": "2018-11-19T08:14:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411399",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@kiwifb](#comment%3A7):
> Amusing. But more seriously your diff certainly point to an issue that needs to be fixed and is logically what we are after. However the line probably should be replaced with a notice. It was probably the intent in the first place. When do you intend to submit a branch for review?

I think having some kind of notice was the intent, though written exactly as I did was probably a mistake on my part.  Looking at the diff from #24919, this is the original code I removed from `configure.ac`:

```diff
-# Check that the Fortran compiler accepts free-format source code
-# (as opposed to the older fixed-format style from Fortran 77).
-# This helps verify the compiler works too, so if some idiot
-# sets FC to /usr/bin/ls, we will at least know it's
-# not a working Fortran compiler.
-AC_LANG(Fortran)
-if test -z "$FC"; then
-    need_to_install_gfortran=yes
-else
```

and this is the equivalent code that was moved to `build/pkgs/gfortran/spkg-configure.m4`:

```diff
+        # Check that the Fortran compiler accepts free-format source code (as
+        # opposed to the older fixed-format style from Fortran 77).
+        # This helps verify the compiler works too, so if some idiot sets FC to
+        # /usr/bin/ls, we will at least know it's not a working Fortran
+        # compiler.
+        if test -z "$FC"; then
+            sage_spkg_install_gfortran=yes
+            SAGE_MUST_INSTALL_GCC([a Fortran compiler is missing])
+        fi
```

The use of the `SAGE_MUST_INSTALL_GCC` macro here is a mistake.  It *might* be a remnant from before we created a separate "gfortran" package (that actually happened after I first introduced #24919, and while I tried to incorporate that change it looks like this might have been left in).

As Dima suggested it can just be removed and/or replaced with an `AC_MSG_NOTICE`.



---

archive/issue_comments_411400.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nActually, I think there needs to be a bit more logic restructuring too.  That `fi` should be an `else`.  There's no point in checking `AC_FC_FREEFORM` if `$FC` is empty, as in the original code.",
    "created_at": "2018-11-19T08:16:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411400",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

Actually, I think there needs to be a bit more logic restructuring too.  That `fi` should be an `else`.  There's no point in checking `AC_FC_FREEFORM` if `$FC` is empty, as in the original code.



---

archive/issue_comments_411401.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nI'd say we're wedded to gfortran too much. As far as I know, [flang](https://github.com/flang-compiler/flang) is in a good state, and a good candidate to replace gfortran (well, yes, it's not that fast yet, but, OK...).\n\nThis ticket would be a good occasion to fix this, and check for presence of a meaningful Fortran compiler, not specifically gfortran.",
    "created_at": "2018-11-19T09:49:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411401",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:11" align="right">comment:11</div>

I'd say we're wedded to gfortran too much. As far as I know, [flang](https://github.com/flang-compiler/flang) is in a good state, and a good candidate to replace gfortran (well, yes, it's not that fast yet, but, OK...).

This ticket would be a good occasion to fix this, and check for presence of a meaningful Fortran compiler, not specifically gfortran.



---

archive/issue_comments_411402.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThis really isn't specifically about gfortran.  It is, in fact, just checking that a fortran compiler exists, and if not is installing gfortran.  Let's not overcomplicate things here:  We've identified a simple fix.  I'll attach a patch if no one else does.",
    "created_at": "2018-11-19T17:50:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411402",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

This really isn't specifically about gfortran.  It is, in fact, just checking that a fortran compiler exists, and if not is installing gfortran.  Let's not overcomplicate things here:  We've identified a simple fix.  I'll attach a patch if no one else does.



---

archive/issue_comments_411403.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@embray](#comment%3A12):\n> This really isn't specifically about gfortran.  It is, in fact, just checking that a fortran compiler exists, and if not is installing gfortran.  Let's not overcomplicate things here:  We've identified a simple fix.  I'll attach a patch if no one else does.\n\nPlease do.",
    "created_at": "2018-11-19T17:51:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411403",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@embray](#comment%3A12):
> This really isn't specifically about gfortran.  It is, in fact, just checking that a fortran compiler exists, and if not is installing gfortran.  Let's not overcomplicate things here:  We've identified a simple fix.  I'll attach a patch if no one else does.

Please do.



---

archive/issue_comments_411404.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@dimpase](#comment%3A11):\n> I'd say we're wedded to gfortran too much. As far as I know, [flang](https://github.com/flang-compiler/flang) is in a good state, and a good candidate to replace gfortran (well, yes, it's not that fast yet, but, OK...).\n\nIf flang is pretty good, then can you open another ticket to add it as an optional package? It would be nice to have a quicker way to build Sage on OS X for users who don't want to install their own gfortran.",
    "created_at": "2018-11-19T20:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411404",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@dimpase](#comment%3A11):
> I'd say we're wedded to gfortran too much. As far as I know, [flang](https://github.com/flang-compiler/flang) is in a good state, and a good candidate to replace gfortran (well, yes, it's not that fast yet, but, OK...).

If flang is pretty good, then can you open another ticket to add it as an optional package? It would be nice to have a quicker way to build Sage on OS X for users who don't want to install their own gfortran.



---

archive/issue_comments_411405.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nflang does not run on OSX yet. It does run on Linux and FreeBSD, though.",
    "created_at": "2018-11-19T21:10:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411405",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:15" align="right">comment:15</div>

flang does not run on OSX yet. It does run on Linux and FreeBSD, though.



---

archive/issue_comments_411406.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\n`flang` is not the only option by far. When I started the work on `clang` I effectively widened the pool of C/C++ compiler usable - not limited to clang. In fact I compiled sage with the Intel C/C++ compiler (and gfortran) with minimal difficulties. But it's not widely advertised and certainly we cannot say it is supported. So widening fortran compiler is good and may be support a different one. \n\nBut building `flang`, OS X or not, is still a hardship. I am afraid Intel fortran will do horrible and unhelpful optimisation but should be tried and then there is the community PGI compiler. Those are closed sources but somewhat easily available across some platforms (may be not freeBSD).",
    "created_at": "2018-11-19T21:14:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411406",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:16" align="right">comment:16</div>

`flang` is not the only option by far. When I started the work on `clang` I effectively widened the pool of C/C++ compiler usable - not limited to clang. In fact I compiled sage with the Intel C/C++ compiler (and gfortran) with minimal difficulties. But it's not widely advertised and certainly we cannot say it is supported. So widening fortran compiler is good and may be support a different one. 

But building `flang`, OS X or not, is still a hardship. I am afraid Intel fortran will do horrible and unhelpful optimisation but should be tried and then there is the community PGI compiler. Those are closed sources but somewhat easily available across some platforms (may be not freeBSD).



---

archive/issue_comments_411407.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nimho Sage should not be in business of building compilers.",
    "created_at": "2018-11-19T21:39:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411407",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

imho Sage should not be in business of building compilers.



---

archive/issue_comments_411408.json:
```json
{
    "body": "Branch: **[u/fbissey/fortran](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/fortran)**",
    "created_at": "2018-11-19T21:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411408",
    "user": "https://github.com/kiwifb"
}
```

Branch: **[u/fbissey/fortran](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/fortran)**



---

archive/issue_comments_411409.json:
```json
{
    "body": "Commit: **[`a666ff9`](https://github.com/sagemath/sagetrac-mirror/commit/a666ff9ca7eaff96d8546b633391ab955b38e486)**",
    "created_at": "2018-11-19T21:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411409",
    "user": "https://github.com/kiwifb"
}
```

Commit: **[`a666ff9`](https://github.com/sagemath/sagetrac-mirror/commit/a666ff9ca7eaff96d8546b633391ab955b38e486)**



---

archive/issue_comments_411410.json:
```json
{
    "body": "Author: **Fran\u00e7ois Bissey**",
    "created_at": "2018-11-19T21:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411410",
    "user": "https://github.com/kiwifb"
}
```

Author: **Fran√ßois Bissey**



---

archive/issue_events_364378.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-19T21:51:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364378"
}
```



---

archive/issue_comments_411411.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nOK does this branch satisfy everyone.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a666ff9ca7eaff96d8546b633391ab955b38e486\"><code>a666ff9</code></a></td><td><code>Do not build gcc if only a fortran compiler is missing. More care about check logic. Don't restrict to gfortran.</code></td></tr></table>\n",
    "created_at": "2018-11-19T21:51:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411411",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:18" align="right">comment:18</div>

OK does this branch satisfy everyone.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a666ff9ca7eaff96d8546b633391ab955b38e486"><code>a666ff9</code></a></td><td><code>Do not build gcc if only a fortran compiler is missing. More care about check logic. Don't restrict to gfortran.</code></td></tr></table>




---

archive/issue_comments_411412.json:
```json
{
    "body": "Changed commit from **[`a666ff9`](https://github.com/sagemath/sagetrac-mirror/commit/a666ff9ca7eaff96d8546b633391ab955b38e486)** to **[`c35c6ec`](https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4)**",
    "created_at": "2018-11-19T21:53:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411412",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a666ff9`](https://github.com/sagemath/sagetrac-mirror/commit/a666ff9ca7eaff96d8546b633391ab955b38e486)** to **[`c35c6ec`](https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4)**



---

archive/issue_comments_411413.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4\"><code>c35c6ec</code></a></td><td><code>Correct spacing</code></td></tr></table>\n",
    "created_at": "2018-11-19T21:53:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411413",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4"><code>c35c6ec</code></a></td><td><code>Correct spacing</code></td></tr></table>




---

archive/issue_events_364379.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-19T22:09:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364379"
}
```



---

archive/issue_events_364380.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-19T22:09:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364380"
}
```



---

archive/issue_comments_411414.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nStuff is broken, trying to figure out why.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4\"><code>c35c6ec</code></a></td><td><code>Correct spacing</code></td></tr></table>\n",
    "created_at": "2018-11-19T22:09:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411414",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:20" align="right">comment:20</div>

Stuff is broken, trying to figure out why.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4"><code>c35c6ec</code></a></td><td><code>Correct spacing</code></td></tr></table>




---

archive/issue_comments_411415.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOK that was weird. After running `bootstrap` even after nicely reworking the syntax in the best possible ways and even in M4sh, I still had an empty `else...fi` section where I expected `AC_FC_FREEFORM` to be expanded.\n\nIt seems like that macro doesn't really like to live in a conditional. In fact it looks like it goes next to AC_PROG_FC all by itself. AC_PROG_FC (and also CC and CXX) is currently called in `configure.ac`, `gcc/spkg-configure.m4` and of course `gfortran/spkg-configure.m4`. \n\nI also learned a few things about `AC_REQUIRE` in the process.",
    "created_at": "2018-11-19T23:49:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411415",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:21" align="right">comment:21</div>

OK that was weird. After running `bootstrap` even after nicely reworking the syntax in the best possible ways and even in M4sh, I still had an empty `else...fi` section where I expected `AC_FC_FREEFORM` to be expanded.

It seems like that macro doesn't really like to live in a conditional. In fact it looks like it goes next to AC_PROG_FC all by itself. AC_PROG_FC (and also CC and CXX) is currently called in `configure.ac`, `gcc/spkg-configure.m4` and of course `gfortran/spkg-configure.m4`. 

I also learned a few things about `AC_REQUIRE` in the process.



---

archive/issue_comments_411416.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI also did some testing with `FC=/bin/ls` because it was helpfully suggested in comments\n\n```\nchecking whether we are using the GNU Fortran compiler... no\nchecking whether /bin/ls accepts -g... no\nchecking for Fortran flag needed to accept free-form source... unknown\nconfigure: Your Fortran compiler does not accept free-format source code\nconfigure: which means the compiler is either seriously broken, or\nconfigure: is too old to build Sage.\nconfigure: === checking whether to install the gfortran SPKG ===\n```\nThis is also nicely triggered if there is no `FC` found so it is enough.",
    "created_at": "2018-11-20T00:09:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411416",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:22" align="right">comment:22</div>

I also did some testing with `FC=/bin/ls` because it was helpfully suggested in comments

```
checking whether we are using the GNU Fortran compiler... no
checking whether /bin/ls accepts -g... no
checking for Fortran flag needed to accept free-form source... unknown
configure: Your Fortran compiler does not accept free-format source code
configure: which means the compiler is either seriously broken, or
configure: is too old to build Sage.
configure: === checking whether to install the gfortran SPKG ===
```
This is also nicely triggered if there is no `FC` found so it is enough.



---

archive/issue_comments_411417.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2449240ab8629475607ad2184372dd3d53a62364\"><code>2449240</code></a></td><td><code>Do not check for a fortran compiler in the C/C++ detection macro. Leave it to the fortran macro.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd\"><code>3185e91</code></a></td><td><code>Extreme streamlining of fortran package macro.</code></td></tr></table>\n",
    "created_at": "2018-11-20T00:13:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411417",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2449240ab8629475607ad2184372dd3d53a62364"><code>2449240</code></a></td><td><code>Do not check for a fortran compiler in the C/C++ detection macro. Leave it to the fortran macro.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd"><code>3185e91</code></a></td><td><code>Extreme streamlining of fortran package macro.</code></td></tr></table>




---

archive/issue_comments_411418.json:
```json
{
    "body": "Changed commit from **[`c35c6ec`](https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4)** to **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)**",
    "created_at": "2018-11-20T00:13:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411418",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c35c6ec`](https://github.com/sagemath/sagetrac-mirror/commit/c35c6ec1cc26a843a4cfe79a807e5f324afe8dd4)** to **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)**



---

archive/issue_events_364381.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-20T00:15:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364381"
}
```



---

archive/issue_events_364382.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2018-11-20T00:15:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364382"
}
```



---

archive/issue_comments_411419.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI left the issue of multiple calls to `AC_PROG_*` for later overall. Just touched gcc for cosmetics really.",
    "created_at": "2018-11-20T00:15:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411419",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:24" align="right">comment:24</div>

I left the issue of multiple calls to `AC_PROG_*` for later overall. Just touched gcc for cosmetics really.



---

archive/issue_comments_411420.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nFor the record I just built and successfully doctested sage with this ticket and the PGI fortran compiler. A couple of issues with doing that though. More about it in the morning before I move to Intel compilers.",
    "created_at": "2018-11-20T11:13:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411420",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:25" align="right">comment:25</div>

For the record I just built and successfully doctested sage with this ticket and the PGI fortran compiler. A couple of issues with doing that though. More about it in the morning before I move to Intel compilers.



---

archive/issue_comments_411421.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nBuilds for me on OS X Mojave with my gfortran compiler temporarily removed. The Sage `gfortran` package took more than twice as long to build as any other Sage package, which I think is typical, but also reinforces my hope that we can suggest other fortran compilers for use with Sage.",
    "created_at": "2018-11-20T17:44:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411421",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:26" align="right">comment:26</div>

Builds for me on OS X Mojave with my gfortran compiler temporarily removed. The Sage `gfortran` package took more than twice as long to build as any other Sage package, which I think is typical, but also reinforces my hope that we can suggest other fortran compilers for use with Sage.



---

archive/issue_events_364383.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-11-20T18:18:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364383"
}
```



---

archive/issue_events_364384.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-11-20T18:18:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364384"
}
```



---

archive/issue_comments_411422.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nThe `AC_FC_FREEFORM` macro always got expanded in a strange place for me too, and I could never figure out exactly why!  I didn't realize it was already called automatically by `AC_PROG_FC`, so thank you for figuring that out.  This looks good to me.",
    "created_at": "2018-11-20T18:18:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411422",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">comment:27</div>

The `AC_FC_FREEFORM` macro always got expanded in a strange place for me too, and I could never figure out exactly why!  I didn't realize it was already called automatically by `AC_PROG_FC`, so thank you for figuring that out.  This looks good to me.



---

archive/issue_comments_411423.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2018-11-20T18:18:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411423",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_comments_411424.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@jhpalmieri](#comment%3A26):\n> Builds for me on OS X Mojave with my gfortran compiler temporarily removed. The Sage `gfortran` package took more than twice as long to build as any other Sage package, which I think is typical, but also reinforces my hope that we can suggest other fortran compilers for use with Sage.\n\nThat's because this involves compiling most, if not all, of gcc and only installing the gfortran bits.",
    "created_at": "2018-11-20T18:18:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411424",
    "user": "https://github.com/embray"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@jhpalmieri](#comment%3A26):
> Builds for me on OS X Mojave with my gfortran compiler temporarily removed. The Sage `gfortran` package took more than twice as long to build as any other Sage package, which I think is typical, but also reinforces my hope that we can suggest other fortran compilers for use with Sage.

That's because this involves compiling most, if not all, of gcc and only installing the gfortran bits.



---

archive/issue_comments_411425.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@embray](#comment%3A28):\n> Replying to [@jhpalmieri](#comment%3A26):\n> > Builds for me on OS X Mojave with my gfortran compiler temporarily removed. The Sage `gfortran` package took more than twice as long to build as any other Sage package, which I think is typical, but also reinforces my hope that we can suggest other fortran compilers for use with Sage.\n\n> \n> That's because this involves compiling most, if not all, of gcc and only installing the gfortran bits.\n\nI understand that, I just wish we could build a fortran compiler more quickly. (That's why I install `/usr/local/bin/gfortran` on every OS X machine I use for Sage.)",
    "created_at": "2018-11-20T18:25:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411425",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@embray](#comment%3A28):
> Replying to [@jhpalmieri](#comment%3A26):
> > Builds for me on OS X Mojave with my gfortran compiler temporarily removed. The Sage `gfortran` package took more than twice as long to build as any other Sage package, which I think is typical, but also reinforces my hope that we can suggest other fortran compilers for use with Sage.

> 
> That's because this involves compiling most, if not all, of gcc and only installing the gfortran bits.

I understand that, I just wish we could build a fortran compiler more quickly. (That's why I install `/usr/local/bin/gfortran` on every OS X machine I use for Sage.)



---

archive/issue_comments_411426.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nTotally happy if someone wants to look into that.  Too bad flang is (according to Fran\u00e7ois) still difficult to install on macOS, which would defeat some of the purpose :(",
    "created_at": "2018-11-20T18:34:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411426",
    "user": "https://github.com/embray"
}
```

<div id="comment:30" align="right">comment:30</div>

Totally happy if someone wants to look into that.  Too bad flang is (according to Fran√ßois) still difficult to install on macOS, which would defeat some of the purpose :(



---

archive/issue_comments_411427.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@embray](#comment%3A30):\n> Totally happy if someone wants to look into that.  Too bad flang is (according to Fran\u00e7ois) still difficult to install on macOS, which would defeat some of the purpose :(\n\nIt's a pain on all OS full stop. I think you have to have a private patched build of llvm, you cannot reuse clang bits if you have them. I won't recommend PGI fortran (needs hand holding) but ifc may be fine, I can try other suggestions if I have access to them.",
    "created_at": "2018-11-20T18:50:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411427",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@embray](#comment%3A30):
> Totally happy if someone wants to look into that.  Too bad flang is (according to Fran√ßois) still difficult to install on macOS, which would defeat some of the purpose :(

It's a pain on all OS full stop. I think you have to have a private patched build of llvm, you cannot reuse clang bits if you have them. I won't recommend PGI fortran (needs hand holding) but ifc may be fine, I can try other suggestions if I have access to them.



---

archive/issue_comments_411428.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nOK wrap up for people interested in using something like pgfortran, you can get it from https://www.pgroup.com/ .\nBefore anyone ask, you cannot currently use pgcc/pgc++ to compile sage because they don't pretend to be gcc unlike clang and Intel. sage still wants a compiler that at least pretend to be gcc.\n\nSet your environment\n\n```\nexport PATH=\"/path_to_compiler_prefix/bin:$PATH\"\nexport LDFLAGS=\"-Wl,-rpath=/path_to_compiler_prefix/lib\"\nexport FPICFLAGS=\"-fPIC\"\n./configure FC=pgfortran\n```\n`FPICFLAGS` is specific to R.\n\n* I will send a couple of PR to openblas. openblas's `f_check` script does a pretty good job of finding all the linking flags needed for your compiler. But in the case of PGI, specifically, ruins the results completely - literally  WTF? I will attach a patch for now.\n\n* R needs hand holding. Its configure script has section that are hand crafted instead of using autotools standard macros. The only reason I can think of for doing that is ignorance. This is why you have to define `FPICFLAGS` in advance for it. However, it is not sufficient for configure to work out how to mix fortran and C code. So once the build breaks with an error on R \n\n```\nFC=\"pgfortran -fPIC\" ./sage -i r\n```\nand once done resume the build normally.\n\nDon't define `FC=/path_to_compiler/my_fortran_compiler`. numpy's distutils extension get confused if you do that and scipy's compilation will fail because gnu options are passed to the compiler instead of appropriate ones.",
    "created_at": "2018-11-20T20:24:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411428",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:32" align="right">comment:32</div>

OK wrap up for people interested in using something like pgfortran, you can get it from https://www.pgroup.com/ .
Before anyone ask, you cannot currently use pgcc/pgc++ to compile sage because they don't pretend to be gcc unlike clang and Intel. sage still wants a compiler that at least pretend to be gcc.

Set your environment

```
export PATH="/path_to_compiler_prefix/bin:$PATH"
export LDFLAGS="-Wl,-rpath=/path_to_compiler_prefix/lib"
export FPICFLAGS="-fPIC"
./configure FC=pgfortran
```
`FPICFLAGS` is specific to R.

* I will send a couple of PR to openblas. openblas's `f_check` script does a pretty good job of finding all the linking flags needed for your compiler. But in the case of PGI, specifically, ruins the results completely - literally  WTF? I will attach a patch for now.

* R needs hand holding. Its configure script has section that are hand crafted instead of using autotools standard macros. The only reason I can think of for doing that is ignorance. This is why you have to define `FPICFLAGS` in advance for it. However, it is not sufficient for configure to work out how to mix fortran and C code. So once the build breaks with an error on R 

```
FC="pgfortran -fPIC" ./sage -i r
```
and once done resume the build normally.

Don't define `FC=/path_to_compiler/my_fortran_compiler`. numpy's distutils extension get confused if you do that and scipy's compilation will fail because gnu options are passed to the compiler instead of appropriate ones.



---

archive/issue_comments_411429.json:
```json
{
    "body": "patch to compile openblas properly with pgfortran",
    "created_at": "2018-11-20T20:26:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411429",
    "user": "https://github.com/kiwifb"
}
```

patch to compile openblas properly with pgfortran



---

archive/issue_comments_411430.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nAttachment: **[pgfortran.patch.gz](https://github.com/sagemath/sage/files/ticket26715/pgfortran.patch.gz)**\n\nDoes non-Apple clang pretend to be GCC? How? Just wondering.",
    "created_at": "2018-11-20T20:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411430",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:33" align="right">comment:33</div>

Attachment: **[pgfortran.patch.gz](https://github.com/sagemath/sage/files/ticket26715/pgfortran.patch.gz)**

Does non-Apple clang pretend to be GCC? How? Just wondering.



---

archive/issue_comments_411431.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@dimpase](#comment%3A33):\n> Does non-Apple clang pretend to be GCC? How? Just wondering.\n\nIt does. Compiler identification is by pragma, and clang on OS X or otherwise has the pragmas saying it is gcc-4.2.1. The intel compiler is a bit different, at installation time it will look at your default gcc install and mimic all the needed pragmas to fake it. Both compiler still have their own vendor pragmas. But by default `AC_PROG_CC` will test the gcc pragma to set the variable `IS_GCC` (or something like that) and both clang (any OS) and Intel will set it to `yes`.",
    "created_at": "2018-11-20T20:34:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411431",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@dimpase](#comment%3A33):
> Does non-Apple clang pretend to be GCC? How? Just wondering.

It does. Compiler identification is by pragma, and clang on OS X or otherwise has the pragmas saying it is gcc-4.2.1. The intel compiler is a bit different, at installation time it will look at your default gcc install and mimic all the needed pragmas to fake it. Both compiler still have their own vendor pragmas. But by default `AC_PROG_CC` will test the gcc pragma to set the variable `IS_GCC` (or something like that) and both clang (any OS) and Intel will set it to `yes`.



---

archive/issue_comments_411432.json:
```json
{
    "body": "Changed branch from **[u/fbissey/fortran](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/fortran)** to **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)**",
    "created_at": "2018-11-21T19:54:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411432",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/fbissey/fortran](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/fortran)** to **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)**



---

archive/issue_events_364385.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-21T19:54:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364385"
}
```



---

archive/issue_events_364386.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "10d1b6810c25e8566c5f89edd0cd381fe7247198",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-11-21T19:54:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26715#event-364386"
}
```



---

archive/issue_comments_411433.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nAnd at last for those still interested I did a build with gcc+ifort (intel fortran compiler). Same kind of set up as for PGI. I had to also provide `LD_LIBRARY_PATH` for the compiler's libraries because they don't know how to find each other in the same folder :(\n\nopenblas need the upgrade to 0.3.3 because of this https://github.com/xianyi/OpenBLAS/issues/1548\n\nR is still fiddly and you still need to define `FPICFLAGS` manually. I think most of the difficulties there would disappear by using the intel compiler for C/C++ as well as fortran.\n\nAnyway everything was sorted and built properly sage works and pass its doctests with flying colours on linux.\n\nAdding intel for C/C++ requires adjustment in pari and possibly sqlite from what I remember. But this is an alternative that could really be made to work.",
    "created_at": "2018-11-23T00:56:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411433",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:36" align="right">comment:36</div>

And at last for those still interested I did a build with gcc+ifort (intel fortran compiler). Same kind of set up as for PGI. I had to also provide `LD_LIBRARY_PATH` for the compiler's libraries because they don't know how to find each other in the same folder :(

openblas need the upgrade to 0.3.3 because of this https://github.com/xianyi/OpenBLAS/issues/1548

R is still fiddly and you still need to define `FPICFLAGS` manually. I think most of the difficulties there would disappear by using the intel compiler for C/C++ as well as fortran.

Anyway everything was sorted and built properly sage works and pass its doctests with flying colours on linux.

Adding intel for C/C++ requires adjustment in pari and possibly sqlite from what I remember. But this is an alternative that could really be made to work.



---

archive/issue_comments_411434.json:
```json
{
    "body": "Changed commit from **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)** to none",
    "created_at": "2018-11-23T00:56:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26715#issuecomment-411434",
    "user": "https://github.com/kiwifb"
}
```

Changed commit from **[`3185e91`](https://github.com/sagemath/sagetrac-mirror/commit/3185e91e9da7ce92bb90b69a4ef55dd98432b4dd)** to none
