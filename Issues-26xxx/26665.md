# Issue 26665: python3: 'filter' object is not subscriptable in libs/gap/util.pyx

archive/issues_026428.json:
```json
{
    "body": "Because sage-on-gentoo doesn't use `GAP_DIR` we are exposed to a code path that is not doctested and that fails with python3.\n\n```\n      File \"sage/libs/gap/util.pyx\", line 199, in sage.libs.gap.util.initialize (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4452)\n        s = str_to_bytes(gap_root(), FS_ENCODING, \"surrogateescape\")\n      File \"sage/libs/gap/util.pyx\", line 171, in sage.libs.gap.util.gap_root (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4232)\n        gapdir = filter(lambda dir:dir.strip().startswith('GAP_DIR'), gap_sh)[0]\n    TypeError: 'filter' object is not subscriptable\n```\n\n\nReviewer: Travis Scrimshaw\n\nAuthor: Fran\u00e7ois Bissey\n\nBranch: 842c6dfc15bd04c2e40441fb7b2c23608f210b9f\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26665\n\n",
    "closed_at": "2018-11-12T21:11:33Z",
    "created_at": "2018-11-08T20:02:24Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "python3: 'filter' object is not subscriptable in libs/gap/util.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26665",
    "user": "https://github.com/kiwifb"
}
```
Because sage-on-gentoo doesn't use `GAP_DIR` we are exposed to a code path that is not doctested and that fails with python3.

```
      File "sage/libs/gap/util.pyx", line 199, in sage.libs.gap.util.initialize (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4452)
        s = str_to_bytes(gap_root(), FS_ENCODING, "surrogateescape")
      File "sage/libs/gap/util.pyx", line 171, in sage.libs.gap.util.gap_root (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4232)
        gapdir = filter(lambda dir:dir.strip().startswith('GAP_DIR'), gap_sh)[0]
    TypeError: 'filter' object is not subscriptable
```


Reviewer: Travis Scrimshaw

Author: François Bissey

Branch: 842c6dfc15bd04c2e40441fb7b2c23608f210b9f

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26665





---

archive/issue_comments_514184.json:
```json
{
    "body": "Changing author from \"\" to \"Fran\u00e7ois Bissey\"",
    "created_at": "2018-11-08T20:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514184",
    "user": "https://github.com/kiwifb"
}
```

Changing author from "" to "François Bissey"



---

archive/issue_comments_514185.json:
```json
{
    "body": "Changing branch from \"\" to \"u/fbissey/gap_filter\"",
    "created_at": "2018-11-08T20:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514185",
    "user": "https://github.com/kiwifb"
}
```

Changing branch from "" to "u/fbissey/gap_filter"



---

archive/issue_comments_514186.json:
```json
{
    "body": "<a id='comment:1'></a>\nStill have to write a doctest.\n\n---\nNew commits:\n|                                                                                                                                          |                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[e273d65](https://github.com/sagemath/sagetrac-mirror/commit/e273d65435d4cab288b26ff14dd1d3ccc8469b7b)|`Replace filter for compatibility with python3`|",
    "created_at": "2018-11-08T20:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514186",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:1'></a>
Still have to write a doctest.

---
New commits:
|                                                                                                                                          |                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[e273d65](https://github.com/sagemath/sagetrac-mirror/commit/e273d65435d4cab288b26ff14dd1d3ccc8469b7b)|`Replace filter for compatibility with python3`|



---

archive/issue_comments_514187.json:
```json
{
    "body": "Changing commit from \"\" to \"e273d65435d4cab288b26ff14dd1d3ccc8469b7b\"",
    "created_at": "2018-11-08T20:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514187",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "" to "e273d65435d4cab288b26ff14dd1d3ccc8469b7b"



---

archive/issue_comments_514188.json:
```json
{
    "body": "<a id='comment:2'></a>\nI am not sure how to write that doctest. To test this properly we have to start a new instance of sage with `GAP_ROOT_DIR` set to wrong value and then call `gap_root`. I cannot seem to change the value inside of sage in a way that sticks until the `gap_root` call.",
    "created_at": "2018-11-08T21:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514188",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:2'></a>
I am not sure how to write that doctest. To test this properly we have to start a new instance of sage with `GAP_ROOT_DIR` set to wrong value and then call `gap_root`. I cannot seem to change the value inside of sage in a way that sticks until the `gap_root` call.



---

archive/issue_comments_514189.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[842c6df](https://github.com/sagemath/sagetrac-mirror/commit/842c6dfc15bd04c2e40441fb7b2c23608f210b9f)|`Figured out a way of doctesting gap_root alternate code`|",
    "created_at": "2018-11-08T22:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514189",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[842c6df](https://github.com/sagemath/sagetrac-mirror/commit/842c6dfc15bd04c2e40441fb7b2c23608f210b9f)|`Figured out a way of doctesting gap_root alternate code`|



---

archive/issue_comments_514190.json:
```json
{
    "body": "Changing commit from \"e273d65435d4cab288b26ff14dd1d3ccc8469b7b\" to \"842c6dfc15bd04c2e40441fb7b2c23608f210b9f\"",
    "created_at": "2018-11-08T22:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e273d65435d4cab288b26ff14dd1d3ccc8469b7b" to "842c6dfc15bd04c2e40441fb7b2c23608f210b9f"



---

archive/issue_comments_514191.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-11-08T22:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514191",
    "user": "https://github.com/kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_514192.json:
```json
{
    "body": "<a id='comment:4'></a>\nFigured something out.",
    "created_at": "2018-11-08T22:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514192",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>
Figured something out.



---

archive/issue_comments_514193.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2018-11-09T01:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514193",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_514194.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-09T01:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514194",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_514195.json:
```json
{
    "body": "<a id='comment:5'></a>\nLGTM.",
    "created_at": "2018-11-09T01:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514195",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
LGTM.



---

archive/issue_comments_514196.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'm not wild about the fact that this will just crash with a not-so-useful exception if the file is not found, or the line being searched for in that file is not found.  But that was the case before this ticket as well so it's fine.  I just thought that was worth pointing out.",
    "created_at": "2018-11-09T13:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514196",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>
I'm not wild about the fact that this will just crash with a not-so-useful exception if the file is not found, or the line being searched for in that file is not found.  But that was the case before this ticket as well so it's fine.  I just thought that was worth pointing out.



---

archive/issue_comments_514197.json:
```json
{
    "body": "<a id='comment:7'></a>\nHopefully once the new gap package is sorted all that mess will disappear.",
    "created_at": "2018-11-11T20:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514197",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:7'></a>
Hopefully once the new gap package is sorted all that mess will disappear.



---

archive/issue_comments_514198.json:
```json
{
    "body": "Changing branch from \"u/fbissey/gap_filter\" to \"842c6dfc15bd04c2e40441fb7b2c23608f210b9f\"",
    "created_at": "2018-11-12T21:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514198",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/fbissey/gap_filter" to "842c6dfc15bd04c2e40441fb7b2c23608f210b9f"



---

archive/issue_comments_514199.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-12T21:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514199",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_075078.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-12T21:11:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26665#event-75078"
}
```



---

archive/issue_comments_514200.json:
```json
{
    "body": "<a id='comment:9'></a>\n\n```\nsage: os.system(\"GAP_ROOT_DIR=/not_a_path sage -c \\\"sage.libs.gap.util.gap_root()\\\"\")\nThe gap-4.5.5.spkg (or later) seems to be not installed!\n```\n\nThis breaks for me because I set `GAP_ROOT_DIR` in `sage-env` which is sourced on `sage` startup. As far as I understand that is how `sage-env` and `GAP_ROOT_DIR` are intended to be used, so the doctest should be changed. Also I would expect this test to add significant overhead for little gain, since it has to go through the whole sage startup.",
    "created_at": "2018-11-25T10:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514200",
    "user": "https://github.com/timokau"
}
```

<a id='comment:9'></a>

```
sage: os.system("GAP_ROOT_DIR=/not_a_path sage -c \"sage.libs.gap.util.gap_root()\"")
The gap-4.5.5.spkg (or later) seems to be not installed!
```

This breaks for me because I set `GAP_ROOT_DIR` in `sage-env` which is sourced on `sage` startup. As far as I understand that is how `sage-env` and `GAP_ROOT_DIR` are intended to be used, so the doctest should be changed. Also I would expect this test to add significant overhead for little gain, since it has to go through the whole sage startup.



---

archive/issue_comments_514201.json:
```json
{
    "body": "Changing commit from \"842c6dfc15bd04c2e40441fb7b2c23608f210b9f\" to \"\"",
    "created_at": "2018-11-25T10:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514201",
    "user": "https://github.com/timokau"
}
```

Changing commit from "842c6dfc15bd04c2e40441fb7b2c23608f210b9f" to ""



---

archive/issue_comments_514202.json:
```json
{
    "body": "<a id='comment:10'></a>\nFix in #26758.",
    "created_at": "2018-11-25T13:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26665#issuecomment-514202",
    "user": "https://github.com/timokau"
}
```

<a id='comment:10'></a>
Fix in #26758.
