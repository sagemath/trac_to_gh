# Issue 26013: lots of warnings when uninstalling spkgs

archive/issues_025776.json:
```json
{
    "assignees": [],
    "body": "When upgrading Sage from 8.3.rc2 to 8.4.beta0: `mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0.log`:\n\n```\nUninstalling existing 'mpir'\nWarning: File '/share/info/dir' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpir.info' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpir.info-1' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpir.info-2' not found\nWarning: Directory '/share/info' not found\nWarning: File '/include/gmp.h' not found\nWarning: Directory '/include' not found\nWarning: File '/include/gmpxx.h' not found\nWarning: Directory '/include' not found\nWarning: File '/include/mpir.h' not found\nWarning: Directory '/include' not found\nWarning: File '/include/mpirxx.h' not found\nWarning: Directory '/include' not found\nWarning: File '/lib/libgmp.23.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmp.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmp.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmpxx.8.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmpxx.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libgmpxx.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpir.23.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpir.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpir.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpirxx.8.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpirxx.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpirxx.dylib' not found\nWarning: Directory '/lib' not found\n```\n`mpc-1.1.0.log`:\n\n```\nUninstalling existing 'mpc'\nWarning: File '/share/info/dir' not found\nWarning: Directory '/share/info' not found\nWarning: File '/share/info/mpc.info' not found\nWarning: Directory '/share/info' not found\nWarning: File '/include/mpc.h' not found\nWarning: Directory '/include' not found\nWarning: File '/lib/libmpc.3.dylib' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpc.a' not found\nWarning: Directory '/lib' not found\nWarning: File '/lib/libmpc.dylib' not found\nWarning: Directory '/lib' not found\n```\nand similarly in many other log files. As far as I can tell, files are not being uninstalled before the new versions are built. Is the problem just that the path names should have `SAGE_LOCAL` prepended?\n\nCC:  @jdemeyer @embray\n\nComponent: **build**\n\nAuthor: **John Palmieri**\n\nBranch/Commit: **[`48f7cdc`](https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55)**\n\nReviewer: **Erik Bray**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26013_\n\n",
    "closed_at": "2018-08-11T16:55:20Z",
    "created_at": "2018-08-06T20:08:08Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "lots of warnings when uninstalling spkgs",
    "type": "issue",
    "updated_at": "2018-08-11T16:55:20Z",
    "url": "https://github.com/sagemath/sage/issues/26013",
    "user": "https://github.com/jhpalmieri"
}
```
When upgrading Sage from 8.3.rc2 to 8.4.beta0: `mpir-3.0.0-644faf502c56f97d9accd301965fc57d6ec70868.p0.log`:

```
Uninstalling existing 'mpir'
Warning: File '/share/info/dir' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpir.info' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpir.info-1' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpir.info-2' not found
Warning: Directory '/share/info' not found
Warning: File '/include/gmp.h' not found
Warning: Directory '/include' not found
Warning: File '/include/gmpxx.h' not found
Warning: Directory '/include' not found
Warning: File '/include/mpir.h' not found
Warning: Directory '/include' not found
Warning: File '/include/mpirxx.h' not found
Warning: Directory '/include' not found
Warning: File '/lib/libgmp.23.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmp.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmp.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmpxx.8.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmpxx.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libgmpxx.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpir.23.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpir.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpir.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpirxx.8.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpirxx.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpirxx.dylib' not found
Warning: Directory '/lib' not found
```
`mpc-1.1.0.log`:

```
Uninstalling existing 'mpc'
Warning: File '/share/info/dir' not found
Warning: Directory '/share/info' not found
Warning: File '/share/info/mpc.info' not found
Warning: Directory '/share/info' not found
Warning: File '/include/mpc.h' not found
Warning: Directory '/include' not found
Warning: File '/lib/libmpc.3.dylib' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpc.a' not found
Warning: Directory '/lib' not found
Warning: File '/lib/libmpc.dylib' not found
Warning: Directory '/lib' not found
```
and similarly in many other log files. As far as I can tell, files are not being uninstalled before the new versions are built. Is the problem just that the path names should have `SAGE_LOCAL` prepended?

CC:  @jdemeyer @embray

Component: **build**

Author: **John Palmieri**

Branch/Commit: **[`48f7cdc`](https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55)**

Reviewer: **Erik Bray**

_Issue created by migration from https://trac.sagemath.org/ticket/26013_





---

archive/issue_events_356282.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-08-06T20:08:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356282"
}
```



---

archive/issue_events_356283.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-08-06T20:08:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356283"
}
```



---

archive/issue_events_356284.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-08-06T20:08:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356284"
}
```



---

archive/issue_events_356285.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-08-06T20:08:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356285"
}
```



---

archive/issue_comments_400647.json:
```json
{
    "body": "Replying to [ticket:26013 jhpalmieri]:\n> Is the problem just that the path names should have `SAGE_LOCAL` prepended?\n\nIndeed. However, it works for me.",
    "created_at": "2018-08-07T06:07:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400647",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:26013 jhpalmieri]:
> Is the problem just that the path names should have `SAGE_LOCAL` prepended?

Indeed. However, it works for me.



---

archive/issue_comments_400648.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nIt happens on two different machines. Maybe something is broken. I added some print statements, and they do not clarify things. Here is the change I made:\n\n```diff\ndiff --git a/build/sage_bootstrap/uninstall.py b/build/sage_bootstrap/uninstall.py\nindex 94a1203f0b..ed00ceac46 100644\n--- a/build/sage_bootstrap/uninstall.py\n+++ b/build/sage_bootstrap/uninstall.py\n@@ -187,7 +187,10 @@ def modern_uninstall(spkg_name, sage_local, files, verbose=False):\n     # Remove the files; if a directory is empty after removing a file\n     # from it, remove the directory too.\n     for filename in files:\n+        print(\"  * sage_local = {}\".format(sage_local))\n+        print(\"  * orig filename = {}\".format(filename))\n         filename = pth.join(sage_local, filename)\n+        print(\"  ** new filename = {}\".format(filename))\n         dirname = pth.dirname(filename)\n         if os.path.exists(filename):\n             if verbose:\n```\nHere is typical output:\n\n```\nUninstalling existing 'glpk'\n  * sage_local = /Users/jpalmier/Desktop/Sage_stuff/git/sage/local\n  * orig filename = /bin/glpsol\n  ** new filename = /bin/glpsol\n```\nI don't understand.",
    "created_at": "2018-08-07T16:04:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400648",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:2" align="right">comment:2</div>

It happens on two different machines. Maybe something is broken. I added some print statements, and they do not clarify things. Here is the change I made:

```diff
diff --git a/build/sage_bootstrap/uninstall.py b/build/sage_bootstrap/uninstall.py
index 94a1203f0b..ed00ceac46 100644
--- a/build/sage_bootstrap/uninstall.py
+++ b/build/sage_bootstrap/uninstall.py
@@ -187,7 +187,10 @@ def modern_uninstall(spkg_name, sage_local, files, verbose=False):
     # Remove the files; if a directory is empty after removing a file
     # from it, remove the directory too.
     for filename in files:
+        print("  * sage_local = {}".format(sage_local))
+        print("  * orig filename = {}".format(filename))
         filename = pth.join(sage_local, filename)
+        print("  ** new filename = {}".format(filename))
         dirname = pth.dirname(filename)
         if os.path.exists(filename):
             if verbose:
```
Here is typical output:

```
Uninstalling existing 'glpk'
  * sage_local = /Users/jpalmier/Desktop/Sage_stuff/git/sage/local
  * orig filename = /bin/glpsol
  ** new filename = /bin/glpsol
```
I don't understand.



---

archive/issue_comments_400649.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nOh, I do understand. From the [documentation for os.path.join](https://docs.python.org/2/library/os.path.html#os.path.join):\n\n```\nIf a component is an absolute path, all previous components are thrown away and joining continues from the absolute path component.\n```\nSo we need to strip `os.sep` from the left end of `filename`.",
    "created_at": "2018-08-07T16:24:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400649",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:3" align="right">comment:3</div>

Oh, I do understand. From the [documentation for os.path.join](https://docs.python.org/2/library/os.path.html#os.path.join):

```
If a component is an absolute path, all previous components are thrown away and joining continues from the absolute path component.
```
So we need to strip `os.sep` from the left end of `filename`.



---

archive/issue_comments_400650.json:
```json
{
    "body": "Branch: **[u/jhpalmieri/spkg-uninstall-os-sep](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/spkg-uninstall-os-sep)**",
    "created_at": "2018-08-07T16:26:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400650",
    "user": "https://github.com/jhpalmieri"
}
```

Branch: **[u/jhpalmieri/spkg-uninstall-os-sep](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/spkg-uninstall-os-sep)**



---

archive/issue_comments_400651.json:
```json
{
    "body": "Commit: **[`b31446a`](https://github.com/sagemath/sagetrac-mirror/commit/b31446accb1a28c65d5dcb1a2a1976fa9349d6da)**",
    "created_at": "2018-08-08T03:49:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400651",
    "user": "https://github.com/jhpalmieri"
}
```

Commit: **[`b31446a`](https://github.com/sagemath/sagetrac-mirror/commit/b31446accb1a28c65d5dcb1a2a1976fa9349d6da)**



---

archive/issue_comments_400652.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f1aa8498a280ce0e77443b87c9a5c62f242ceda0\"><code>f1aa849</code></a></td><td><code>trac 26022: \"![ -z ...]\" is not valid, at least on OS X</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b31446accb1a28c65d5dcb1a2a1976fa9349d6da\"><code>b31446a</code></a></td><td><code>trac 26013: use filename.lstrip(os.sep) instead of filename</code></td></tr></table>\n",
    "created_at": "2018-08-08T03:49:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400652",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:5"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f1aa8498a280ce0e77443b87c9a5c62f242ceda0"><code>f1aa849</code></a></td><td><code>trac 26022: "![ -z ...]" is not valid, at least on OS X</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b31446accb1a28c65d5dcb1a2a1976fa9349d6da"><code>b31446a</code></a></td><td><code>trac 26013: use filename.lstrip(os.sep) instead of filename</code></td></tr></table>




---

archive/issue_events_356286.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2018-08-08T03:49:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356286"
}
```



---

archive/issue_comments_400653.json:
```json
{
    "body": "Author: **John Palmieri**",
    "created_at": "2018-08-08T03:49:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400653",
    "user": "https://github.com/jhpalmieri"
}
```

Author: **John Palmieri**



---

archive/issue_comments_400654.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/40e0cfb75ef3a0a18f9ba00ad9a1eabcf5d7fc41\"><code>40e0cfb</code></a></td><td><code>trac 26013: apply lstrip(os.sep) to filename in os.path.join(..., filename)</code></td></tr></table>\n",
    "created_at": "2018-08-08T03:52:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400654",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/40e0cfb75ef3a0a18f9ba00ad9a1eabcf5d7fc41"><code>40e0cfb</code></a></td><td><code>trac 26013: apply lstrip(os.sep) to filename in os.path.join(..., filename)</code></td></tr></table>




---

archive/issue_comments_400655.json:
```json
{
    "body": "Changed commit from **[`b31446a`](https://github.com/sagemath/sagetrac-mirror/commit/b31446accb1a28c65d5dcb1a2a1976fa9349d6da)** to **[`40e0cfb`](https://github.com/sagemath/sagetrac-mirror/commit/40e0cfb75ef3a0a18f9ba00ad9a1eabcf5d7fc41)**",
    "created_at": "2018-08-08T03:52:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400655",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b31446a`](https://github.com/sagemath/sagetrac-mirror/commit/b31446accb1a28c65d5dcb1a2a1976fa9349d6da)** to **[`40e0cfb`](https://github.com/sagemath/sagetrac-mirror/commit/40e0cfb75ef3a0a18f9ba00ad9a1eabcf5d7fc41)**



---

archive/issue_comments_400656.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nSome other OSX users have pointed this issue out before, but I could never figure out why it was happening.  Let me look into this a bit more for a sec because there *shouldn't* be absolute paths in those filenames in the first place.  They should be written as relative paths.  For example I have:\n\n```\n$ cat local/var/lib/sage/installed/mpc-1.1.0\n{\n    \"package_name\": \"mpc\",\n    \"package_version\": \"1.1.0\",\n    \"install_date\": \"Thu Jul 19 08:10:31 UTC 2018\",\n    \"system_uname\": \"Linux sage-docker 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\",\n    \"sage_version\": \"SageMath version 8.3.rc1, Release Date: 2018-07-14\",\n    \"test_result\": \"\",\n    \"files\": [\n        \"include/mpc.h\",\n        \"lib/libmpc.a\",\n        \"lib/libmpc.so\",\n        \"lib/libmpc.so.3\",\n        \"lib/libmpc.so.3.1.0\",\n        \"share/info/dir\",\n        \"share/info/mpc.info\"\n    ]\n}\n```\n\nDo you see absolute paths being written into those files?",
    "created_at": "2018-08-08T11:13:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400656",
    "user": "https://github.com/embray"
}
```

<div id="comment:8" align="right">comment:8</div>

Some other OSX users have pointed this issue out before, but I could never figure out why it was happening.  Let me look into this a bit more for a sec because there *shouldn't* be absolute paths in those filenames in the first place.  They should be written as relative paths.  For example I have:

```
$ cat local/var/lib/sage/installed/mpc-1.1.0
{
    "package_name": "mpc",
    "package_version": "1.1.0",
    "install_date": "Thu Jul 19 08:10:31 UTC 2018",
    "system_uname": "Linux sage-docker 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux",
    "sage_version": "SageMath version 8.3.rc1, Release Date: 2018-07-14",
    "test_result": "",
    "files": [
        "include/mpc.h",
        "lib/libmpc.a",
        "lib/libmpc.so",
        "lib/libmpc.so.3",
        "lib/libmpc.so.3.1.0",
        "share/info/dir",
        "share/info/mpc.info"
    ]
}
```

Do you see absolute paths being written into those files?



---

archive/issue_comments_400657.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nUnfortunately the OSX machine I used to have access to appears to be down, and everyone here is on vacation...",
    "created_at": "2018-08-08T11:19:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400657",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

Unfortunately the OSX machine I used to have access to appears to be down, and everyone here is on vacation...



---

archive/issue_comments_400658.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThe relevant code is in `sage-spkg` (yet more reason this should probably be rewritten in Python as it is growing in complexity, though as Jeroen wrote elsewhere it would be a tedious task...).  A summarized version is as follows:\n\n```\nPREFIX=\"${SAGE_DESTDIR_LOCAL%/}/\"\nold_IFS=\"$IFS\"; IFS=$'\\n'\nfor filename in $(find \"$PREFIX\" -type f -o -type l | sort); do\n    filename=\"${filename#$PREFIX}\"\n    echo \"$filename\"\ndone\n```\n\nin the above, `$PREFIX` should end with a `/`, and `${filename#$PREFIX}` should have the effect of stripping `$PREFIX` (up to and including the final `/`) from the front of `$filename`.  But maybe there's a bug or some other subtlety with that I was unaware of.",
    "created_at": "2018-08-08T11:27:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400658",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">comment:10</div>

The relevant code is in `sage-spkg` (yet more reason this should probably be rewritten in Python as it is growing in complexity, though as Jeroen wrote elsewhere it would be a tedious task...).  A summarized version is as follows:

```
PREFIX="${SAGE_DESTDIR_LOCAL%/}/"
old_IFS="$IFS"; IFS=$'\n'
for filename in $(find "$PREFIX" -type f -o -type l | sort); do
    filename="${filename#$PREFIX}"
    echo "$filename"
done
```

in the above, `$PREFIX` should end with a `/`, and `${filename#$PREFIX}` should have the effect of stripping `$PREFIX` (up to and including the final `/`) from the front of `$filename`.  But maybe there's a bug or some other subtlety with that I was unaware of.



---

archive/issue_comments_400659.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nAnother way maybe it could fail is if your `$SAGE_LOCAL` somehow had a superfluous double-slash at the end of it...?",
    "created_at": "2018-08-08T11:48:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400659",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

Another way maybe it could fail is if your `$SAGE_LOCAL` somehow had a superfluous double-slash at the end of it...?



---

archive/issue_comments_400660.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nIf nothing else, something like this should do the trick.  But I think I will be rewriting a chunk of this code anyways...\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex 125dd15..ded872f 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -889,6 +889,13 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n     old_IFS=\"$IFS\"; IFS=$'\\n'\n     for filename in $(find \"$PREFIX\" -type f -o -type l | sort); do\n         filename=\"${filename#$PREFIX}\"\n+        # Make really sure there are still no leading slashes on the filename\n+        # (which could happen if enough superfluous slashes were added\n+        # elsewhere)\n+        while [[ \"$filename\" == /* ]]; do\n+            filename=\"${filename#/}\"\n+        done\n+\n         if [ $FIRST -eq 1 ]; then\n             FILE_LIST=\"\\\"$filename\\\"\"\n             FIRST=0\n```",
    "created_at": "2018-08-08T12:40:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400660",
    "user": "https://github.com/embray"
}
```

<div id="comment:12" align="right">comment:12</div>

If nothing else, something like this should do the trick.  But I think I will be rewriting a chunk of this code anyways...

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 125dd15..ded872f 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -889,6 +889,13 @@ if [ -d "$SAGE_DESTDIR" ]; then
     old_IFS="$IFS"; IFS=$'\n'
     for filename in $(find "$PREFIX" -type f -o -type l | sort); do
         filename="${filename#$PREFIX}"
+        # Make really sure there are still no leading slashes on the filename
+        # (which could happen if enough superfluous slashes were added
+        # elsewhere)
+        while [[ "$filename" == /* ]]; do
+            filename="${filename#/}"
+        done
+
         if [ $FIRST -eq 1 ]; then
             FILE_LIST="\"$filename\""
             FIRST=0
```



---

archive/issue_comments_400661.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI added `echo \"$filename\"` in `sage-spkg`, and there are indeed leading backslashes. My `$SAGE_LOCAL` has no trailing backslashes (at least when I do `sage -sh` and `echo $SAGE_LOCAL`), and the `$PREFIX` variable in `sage-spkg` has one. As you probably know, `bash` behavior can vary depending on whether it's GNU/linux or BSD. Maybe that's what's going on. Is there an issue with just using `lstrip(os.sep)` as my branch does?",
    "created_at": "2018-08-08T16:11:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400661",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:13" align="right">comment:13</div>

I added `echo "$filename"` in `sage-spkg`, and there are indeed leading backslashes. My `$SAGE_LOCAL` has no trailing backslashes (at least when I do `sage -sh` and `echo $SAGE_LOCAL`), and the `$PREFIX` variable in `sage-spkg` has one. As you probably know, `bash` behavior can vary depending on whether it's GNU/linux or BSD. Maybe that's what's going on. Is there an issue with just using `lstrip(os.sep)` as my branch does?



---

archive/issue_comments_400662.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI'd be curious if you could figure out exactly which part is behaving differently in your bash? What happens with `filename=\"${filename#$PREFIX}`.  Not even necessarily in this script, but just in general? What does something like:\n\n```\nPREFIX=/a/\nfilename=/a/b\nfilename=${filename#$PREFIX}\necho \"$filename\"\n```\n\nIf that returns anything other than just `b` this is a bug in your bash I think.\n\n> Is there an issue with just using `lstrip(os.sep)` as my branch does?\n\nThe point is that shouldn't even be necessary.  It might not be a bad idea anyways just as a sanity check, though I might also issue a warning.  The intent is that these files contain a list of relative paths.  If they don't then the files are malformatted, which means the real problem is in the code producing those files (whether the bug ultimately originates from a buggy bash or not).",
    "created_at": "2018-08-08T16:23:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400662",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

I'd be curious if you could figure out exactly which part is behaving differently in your bash? What happens with `filename="${filename#$PREFIX}`.  Not even necessarily in this script, but just in general? What does something like:

```
PREFIX=/a/
filename=/a/b
filename=${filename#$PREFIX}
echo "$filename"
```

If that returns anything other than just `b` this is a bug in your bash I think.

> Is there an issue with just using `lstrip(os.sep)` as my branch does?

The point is that shouldn't even be necessary.  It might not be a bad idea anyways just as a sanity check, though I might also issue a warning.  The intent is that these files contain a list of relative paths.  If they don't then the files are malformatted, which means the real problem is in the code producing those files (whether the bug ultimately originates from a buggy bash or not).



---

archive/issue_comments_400663.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAlternatively, it's also possible that your `find` is slipping in some superfluous slashes.",
    "created_at": "2018-08-08T16:36:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400663",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

Alternatively, it's also possible that your `find` is slipping in some superfluous slashes.



---

archive/issue_comments_400664.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nThis seems to suggest that it is in fact the `find` at fault: https://apple.stackexchange.com/a/254224/44101",
    "created_at": "2018-08-08T16:39:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400664",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

This seems to suggest that it is in fact the `find` at fault: https://apple.stackexchange.com/a/254224/44101



---

archive/issue_comments_400665.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThis patch should do it:\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex 9b90421eaf..9dffb481df 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -869,9 +869,12 @@ fi\n # case DESTDIR=$SAGE_DESTDIR installation was not used\n echo \"Copying package files from temporary location $SAGE_DESTDIR to $SAGE_LOCAL\"\n if [ -d \"$SAGE_DESTDIR\" ]; then\n-    PREFIX=\"${SAGE_DESTDIR_LOCAL%/}/\"\n+    # Some `find` implementations will put superfluous slashes in the\n+    # output if we give them a directory name with a slash; so make sure\n+    # any trailing slash is removed; https://trac.sagemath.org/ticket/26013\n+    PREFIX=\"${SAGE_DESTDIR_LOCAL%/}\"\n\n-    rm -f \"$PREFIX\"lib/*.la\n+    rm -f \"$PREFIX\"/lib/*.la\n     if [ $? -ne 0 ]; then\n         error_msg \"Error deleting unnecessary libtool archive files\"\n         exit 1\n@@ -882,7 +885,7 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n     FIRST=1\n     old_IFS=\"$IFS\"; IFS=$'\\n'\n     for filename in $(find \"$PREFIX\" -type f -o -type l | sort); do\n-        filename=\"${filename#$PREFIX}\"\n+        filename=\"${filename#$PREFIX/}\"\n         if [ $FIRST -eq 1 ]; then\n             FILE_LIST=\"\\\"$filename\\\"\"\n             FIRST=0\n@@ -893,7 +896,7 @@ if [ -d \"$SAGE_DESTDIR\" ]; then\n         if [ ! -d \"$SAGE_LOCAL/$(dirname \"$filename\")\" ]; then\n             $SAGE_SUDO mkdir -p \"$SAGE_LOCAL/$(dirname \"$filename\")\"\n         fi\n-        $SAGE_SUDO mv \"$PREFIX$filename\" \"${SAGE_LOCAL%/}/$filename\"\n+        $SAGE_SUDO mv \"$PREFIX/$filename\" \"${SAGE_LOCAL%/}/$filename\"\n         if [ $? -ne 0 ]; then\n             error_msg \"Error moving files for $PKG_NAME.\"\n             exit 1\n```\n\nI'm fine with adding this to your existing patch to `uninstall.py` as long a comment is also added pointing back to this ticket (and assuming this patch does in fact work).",
    "created_at": "2018-08-08T16:45:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400665",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

This patch should do it:

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index 9b90421eaf..9dffb481df 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -869,9 +869,12 @@ fi
 # case DESTDIR=$SAGE_DESTDIR installation was not used
 echo "Copying package files from temporary location $SAGE_DESTDIR to $SAGE_LOCAL"
 if [ -d "$SAGE_DESTDIR" ]; then
-    PREFIX="${SAGE_DESTDIR_LOCAL%/}/"
+    # Some `find` implementations will put superfluous slashes in the
+    # output if we give them a directory name with a slash; so make sure
+    # any trailing slash is removed; https://trac.sagemath.org/ticket/26013
+    PREFIX="${SAGE_DESTDIR_LOCAL%/}"

-    rm -f "$PREFIX"lib/*.la
+    rm -f "$PREFIX"/lib/*.la
     if [ $? -ne 0 ]; then
         error_msg "Error deleting unnecessary libtool archive files"
         exit 1
@@ -882,7 +885,7 @@ if [ -d "$SAGE_DESTDIR" ]; then
     FIRST=1
     old_IFS="$IFS"; IFS=$'\n'
     for filename in $(find "$PREFIX" -type f -o -type l | sort); do
-        filename="${filename#$PREFIX}"
+        filename="${filename#$PREFIX/}"
         if [ $FIRST -eq 1 ]; then
             FILE_LIST="\"$filename\""
             FIRST=0
@@ -893,7 +896,7 @@ if [ -d "$SAGE_DESTDIR" ]; then
         if [ ! -d "$SAGE_LOCAL/$(dirname "$filename")" ]; then
             $SAGE_SUDO mkdir -p "$SAGE_LOCAL/$(dirname "$filename")"
         fi
-        $SAGE_SUDO mv "$PREFIX$filename" "${SAGE_LOCAL%/}/$filename"
+        $SAGE_SUDO mv "$PREFIX/$filename" "${SAGE_LOCAL%/}/$filename"
         if [ $? -ne 0 ]; then
             error_msg "Error moving files for $PKG_NAME."
             exit 1
```

I'm fine with adding this to your existing patch to `uninstall.py` as long a comment is also added pointing back to this ticket (and assuming this patch does in fact work).



---

archive/issue_comments_400666.json:
```json
{
    "body": "Changed commit from **[`40e0cfb`](https://github.com/sagemath/sagetrac-mirror/commit/40e0cfb75ef3a0a18f9ba00ad9a1eabcf5d7fc41)** to **[`48f7cdc`](https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55)**",
    "created_at": "2018-08-08T17:55:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400666",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`40e0cfb`](https://github.com/sagemath/sagetrac-mirror/commit/40e0cfb75ef3a0a18f9ba00ad9a1eabcf5d7fc41)** to **[`48f7cdc`](https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55)**



---

archive/issue_comments_400667.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55\"><code>48f7cdc</code></a></td><td><code>trac 26013: make sure that sage-spkg generates relative filenames for</code></td></tr></table>\n",
    "created_at": "2018-08-08T17:55:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400667",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55"><code>48f7cdc</code></a></td><td><code>trac 26013: make sure that sage-spkg generates relative filenames for</code></td></tr></table>




---

archive/issue_comments_400668.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nYour patch works for me. Here is a new branch.",
    "created_at": "2018-08-08T17:55:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400668",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:19" align="right">comment:19</div>

Your patch works for me. Here is a new branch.



---

archive/issue_events_356287.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-09T12:17:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356287"
}
```



---

archive/issue_events_356288.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-08-09T12:17:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356288"
}
```



---

archive/issue_comments_400669.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThanks!",
    "created_at": "2018-08-09T12:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400669",
    "user": "https://github.com/embray"
}
```

<div id="comment:20" align="right">comment:20</div>

Thanks!



---

archive/issue_comments_400670.json:
```json
{
    "body": "Reviewer: **Erik Bray**",
    "created_at": "2018-08-09T12:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400670",
    "user": "https://github.com/embray"
}
```

Reviewer: **Erik Bray**



---

archive/issue_events_356289.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-11T16:55:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356289"
}
```



---

archive/issue_events_356290.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "2bd1923f8a7608f0e5a219d9318f14320d22f409",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-08-11T16:55:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26013#event-356290"
}
```



---

archive/issue_comments_400671.json:
```json
{
    "body": "Changed branch from **[u/jhpalmieri/spkg-uninstall-os-sep](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/spkg-uninstall-os-sep)** to **[`48f7cdc`](https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55)**",
    "created_at": "2018-08-11T16:55:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26013",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26013#issuecomment-400671",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/jhpalmieri/spkg-uninstall-os-sep](https://github.com/sagemath/sagetrac-mirror/tree/u/jhpalmieri/spkg-uninstall-os-sep)** to **[`48f7cdc`](https://github.com/sagemath/sagetrac-mirror/commit/48f7cdc4f7f80041ba843b459696415cac488e55)**
