# Issue 26067: Mitigate speed regression in polynomial division over ℤ

archive/issues_025830.json:
```json
{
    "body": "CC:  @antonio-rojas @timokau\n\nSpeed up `//` for multivariate polynomials over\u00a0\u2124 after the regression discussed at #24735#comment:7. See also #25313.\n\n#24735:\n\n```\nsage: P.<x,y> = ZZ[]\nsage: p = 3*(-x^8*y^2 - x*y^9 + 6*x^8*y + 17*x^2*y^6 - x^3*y^2)\nsage: q = 7*(x^2 + x*y + y^2 + 1)\nsage: %timeit p//q\nThe slowest run took 43.99 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 278 \u00b5s per loop\n```\n\nThis ticket:\n\n```\nsage: P.<x,y> = ZZ[]\nsage: p = 3*(-x^8*y^2 - x*y^9 + 6*x^8*y + 17*x^2*y^6 - x^3*y^2)\nsage: q = 7*(x^2 + x*y + y^2 + 1)\nsage: %timeit p//q\nThe slowest run took 44.73 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 101 \u00b5s per loop\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/26067\n\n",
    "closed_at": "2019-02-22T22:01:42Z",
    "created_at": "2018-08-15T16:09:45Z",
    "labels": [
        "component: commutative algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Mitigate speed regression in polynomial division over \u2124",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26067",
    "user": "https://github.com/mezzarobba"
}
```
CC:  @antonio-rojas @timokau

Speed up `//` for multivariate polynomials over ℤ after the regression discussed at #24735#comment:7. See also #25313.

#24735:

```
sage: P.<x,y> = ZZ[]
sage: p = 3*(-x^8*y^2 - x*y^9 + 6*x^8*y + 17*x^2*y^6 - x^3*y^2)
sage: q = 7*(x^2 + x*y + y^2 + 1)
sage: %timeit p//q
The slowest run took 43.99 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 278 µs per loop
```

This ticket:

```
sage: P.<x,y> = ZZ[]
sage: p = 3*(-x^8*y^2 - x*y^9 + 6*x^8*y + 17*x^2*y^6 - x^3*y^2)
sage: q = 7*(x^2 + x*y + y^2 + 1)
sage: %timeit p//q
The slowest run took 44.73 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 101 µs per loop
```

Issue created by migration from https://trac.sagemath.org/ticket/26067





---

archive/issue_comments_364141.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-15T16:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364141",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_364142.json:
```json
{
    "body": "For fairness, do you have timings before #24735?\n\nAlso, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?",
    "created_at": "2018-08-16T02:02:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364142",
    "user": "https://github.com/tscrim"
}
```

For fairness, do you have timings before #24735?

Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?



---

archive/issue_comments_364143.json:
```json
{
    "body": "According to upstream [0], p_Divide returns 0 when the division is not exact. I have no idea what __floordiv__ should return for polynomials with integers coefficients given that it's not an Euclidean domain, but are you sure that this is what you want?\n\n[0] https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2768",
    "created_at": "2018-08-16T06:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364143",
    "user": "https://github.com/antonio-rojas"
}
```

According to upstream [0], p_Divide returns 0 when the division is not exact. I have no idea what __floordiv__ should return for polynomials with integers coefficients given that it's not an Euclidean domain, but are you sure that this is what you want?

[0] https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2768



---

archive/issue_comments_364144.json:
```json
{
    "body": "Replying to [comment:2 tscrim]:\n> Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?\n\n\nThere's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)",
    "created_at": "2018-08-16T06:07:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364144",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:2 tscrim]:
> Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?


There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)



---

archive/issue_comments_364145.json:
```json
{
    "body": "Replying to [comment:4 arojas]:\n> Replying to [comment:2 tscrim]:\n> > Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?\n\n> \n> There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)\n\n\nThen all of [commit 9ffa9998](https://git.sagemath.org/sage.git/commit/?h=197ac562304611d9f946337332349bff9fa0d05d&id=9ffa9998f5739e010b607070ab1c0e2c41880a1c) is a typo? It is saying there is a `p_MDivide` function unless I am misunderstanding something.",
    "created_at": "2018-08-16T13:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364145",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:4 arojas]:
> Replying to [comment:2 tscrim]:
> > Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?

> 
> There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)


Then all of [commit 9ffa9998](https://git.sagemath.org/sage.git/commit/?h=197ac562304611d9f946337332349bff9fa0d05d&id=9ffa9998f5739e010b607070ab1c0e2c41880a1c) is a typo? It is saying there is a `p_MDivide` function unless I am misunderstanding something.



---

archive/issue_comments_364146.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> Replying to [comment:4 arojas]:\n> > Replying to [comment:2 tscrim]:\n> > > Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?\n\n> > \n> > There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)\n\n> \n> Then all of [commit 9ffa9998](https://git.sagemath.org/sage.git/commit/?h=197ac562304611d9f946337332349bff9fa0d05d&id=9ffa9998f5739e010b607070ab1c0e2c41880a1c) is a typo? It is saying there is a `p_MDivide` function unless I am misunderstanding something.\n\n\nAh, you're right. Looks like they differ in the extra 'ring' parameter. After this patch both versions are used in Sage, so neither should be removed",
    "created_at": "2018-08-16T13:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364146",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:5 tscrim]:
> Replying to [comment:4 arojas]:
> > Replying to [comment:2 tscrim]:
> > > Also, are the functions `p_MDivide` and `pMDivide` different? Should the latter be removed?

> > 
> > There's no p_MDivide, there's only p_Divide and pMDivide (monomial division, formerly called pDivide (without underscore) in previous Singular versions)

> 
> Then all of [commit 9ffa9998](https://git.sagemath.org/sage.git/commit/?h=197ac562304611d9f946337332349bff9fa0d05d&id=9ffa9998f5739e010b607070ab1c0e2c41880a1c) is a typo? It is saying there is a `p_MDivide` function unless I am misunderstanding something.


Ah, you're right. Looks like they differ in the extra 'ring' parameter. After this patch both versions are used in Sage, so neither should be removed



---

archive/issue_comments_364147.json:
```json
{
    "body": "Replying to [comment:3 arojas]:\n> According to upstream [0], p_Divide returns 0 when the division is not exact. I have no idea what __floordiv__ should return for polynomials with integers coefficients given that it's not an Euclidean domain, but are you sure that this is what you want?\n\n\nAs far as I'm concerned it would be okay. But we could maybe also fall back on calling `reduce()` when `p_Divide` returns zero. That would be fast in the case that really makes sense, and slow but consistent with `reduce()` by construction in the general case. What do you think?",
    "created_at": "2019-02-13T11:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364147",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:3 arojas]:
> According to upstream [0], p_Divide returns 0 when the division is not exact. I have no idea what __floordiv__ should return for polynomials with integers coefficients given that it's not an Euclidean domain, but are you sure that this is what you want?


As far as I'm concerned it would be okay. But we could maybe also fall back on calling `reduce()` when `p_Divide` returns zero. That would be fast in the case that really makes sense, and slow but consistent with `reduce()` by construction in the general case. What do you think?



---

archive/issue_comments_364148.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-14T10:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364148",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364149.json:
```json
{
    "body": "Here is a new version that shouldn't break anything. Some timings using a benchmark that Bill Hart posted to sage-devel a while ago:\n\n```\nsage: P.<x,y,z,t> = ZZ[]\n....: f = 1 + x + y + z + t;\n....: p = f^20;\n....: q = p*(p + 1);\n....: %time _ = q//p\n```\n\n8.7.beta3: 5 min 7s\n\n+ this ticket: 41.7 s",
    "created_at": "2019-02-14T10:22:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364149",
    "user": "https://github.com/mezzarobba"
}
```

Here is a new version that shouldn't break anything. Some timings using a benchmark that Bill Hart posted to sage-devel a while ago:

```
sage: P.<x,y,z,t> = ZZ[]
....: f = 1 + x + y + z + t;
....: p = f^20;
....: q = p*(p + 1);
....: %time _ = q//p
```

8.7.beta3: 5 min 7s

+ this ticket: 41.7 s



---

archive/issue_comments_364150.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-14T14:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364150",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_364151.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-14T14:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364151",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_065081.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2019-02-16T19:07:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26067#event-65081"
}
```



---

archive/issue_comments_364152.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-16T19:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364152",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_364153.json:
```json
{
    "body": "LGTM.",
    "created_at": "2019-02-16T19:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364153",
    "user": "https://github.com/tscrim"
}
```

LGTM.



---

archive/issue_comments_364154.json:
```json
{
    "body": "Replying to [comment:12 tscrim]:\n> LGTM.\n\n\nThank you!",
    "created_at": "2019-02-17T07:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364154",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:12 tscrim]:
> LGTM.


Thank you!



---

archive/issue_events_065082.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-22T22:01:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26067#event-65082"
}
```



---

archive/issue_comments_364155.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-22T22:01:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26067#issuecomment-364155",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
