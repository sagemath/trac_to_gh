# Issue 26112: Memory leaks with matrix operations over GF(2)

archive/issues_026112.json:
```json
{
    "body": "Keywords: memory leaks\n\nAs reported on [this ask question](https://ask.sagemath.org/question/43769/memory-leaks-with-matrix-multiplication-over-gf2/):\n\n```\nn = 8\nX = zero_vector(GF(2), n)\nM = zero_matrix(GF(2), n, n)\n\nfor _ in range(10000000):\n    Y = M * X\n```\n\nleads to:\n\n```\nm4ri_mm_malloc: malloc returned NULL\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-1-04da27075a1c> in <module>()\n      4 \n      5 for _ in range(Integer(10000000)):\n----> 6     Y = M * X\n      7 \n\n/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23537)()\n   3666             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n   3667         if BOTH_ARE_ELEMENT(cl):\n-> 3668             return coercion_model.bin_op(left, right, mul)\n   3669 \n   3670         cdef long value\n\n/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9757)()\n   1173             action = self.get_action(xp, yp, op, x, y)\n   1174             if action is not None:\n-> 1175                 return (<Action>action)._call_(x, y)\n   1176 \n   1177         try:\n\n/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/matrix/action.pyx in sage.matrix.action.MatrixVectorAction._call_ (build/cythonized/sage/matrix/action.c:5997)()\n    325             else:\n    326                 v = v.dense_vector()\n--> 327         return A._matrix_times_vector_(v)\n    328 \n    329 \n\n/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.pyx in sage.matrix.matrix_mod2_dense.Matrix_mod2_dense._matrix_times_vector_ (build/cythonized/sage/matrix/matrix_mod2_dense.c:6487)()\n    573             return VS.zero()\n    574         cdef Vector_mod2_dense c = Vector_mod2_dense.__new__(Vector_mod2_dense)\n--> 575         sig_str(\"matrix allocation failed\")\n    576         c._init(self._nrows, VS)\n    577         c._entries = mzd_init(1, self._nrows)\n\nRuntimeError: matrix allocation failed\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26349\n\n",
    "closed_at": "2020-05-02T21:58:30Z",
    "created_at": "2018-09-26T11:48:24Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Memory leaks with matrix operations over GF(2)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26112",
    "user": "https://github.com/antoine06"
}
```
Keywords: memory leaks

As reported on [this ask question](https://ask.sagemath.org/question/43769/memory-leaks-with-matrix-multiplication-over-gf2/):

```
n = 8
X = zero_vector(GF(2), n)
M = zero_matrix(GF(2), n, n)

for _ in range(10000000):
    Y = M * X
```

leads to:

```
m4ri_mm_malloc: malloc returned NULL
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-1-04da27075a1c> in <module>()
      4 
      5 for _ in range(Integer(10000000)):
----> 6     Y = M * X
      7 

/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/structure/element.pyx in sage.structure.element.Matrix.__mul__ (build/cythonized/sage/structure/element.c:23537)()
   3666             return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
   3667         if BOTH_ARE_ELEMENT(cl):
-> 3668             return coercion_model.bin_op(left, right, mul)
   3669 
   3670         cdef long value

/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:9757)()
   1173             action = self.get_action(xp, yp, op, x, y)
   1174             if action is not None:
-> 1175                 return (<Action>action)._call_(x, y)
   1176 
   1177         try:

/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/matrix/action.pyx in sage.matrix.action.MatrixVectorAction._call_ (build/cythonized/sage/matrix/action.c:5997)()
    325             else:
    326                 v = v.dense_vector()
--> 327         return A._matrix_times_vector_(v)
    328 
    329 

/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/matrix/matrix_mod2_dense.pyx in sage.matrix.matrix_mod2_dense.Matrix_mod2_dense._matrix_times_vector_ (build/cythonized/sage/matrix/matrix_mod2_dense.c:6487)()
    573             return VS.zero()
    574         cdef Vector_mod2_dense c = Vector_mod2_dense.__new__(Vector_mod2_dense)
--> 575         sig_str("matrix allocation failed")
    576         c._init(self._nrows, VS)
    577         c._entries = mzd_init(1, self._nrows)

RuntimeError: matrix allocation failed
```


Issue created by migration from https://trac.sagemath.org/ticket/26349





---

archive/issue_comments_367703.json:
```json
{
    "body": "It would seem the memory management on these objects is rather fundamentally broken.\nAlso with lines like `Y= M+M` or `Y=X+X` I am seeing similar leaking behaviour.",
    "created_at": "2018-09-28T13:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367703",
    "user": "https://github.com/nbruin"
}
```

It would seem the memory management on these objects is rather fundamentally broken.
Also with lines like `Y= M+M` or `Y=X+X` I am seeing similar leaking behaviour.



---

archive/issue_comments_367704.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-05-07T17:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367704",
    "user": "https://github.com/black-stones"
}
```

Changing status from new to needs_review.



---

archive/issue_events_065539.json:
```json
{
    "actor": "https://github.com/black-stones",
    "created_at": "2019-05-07T17:21:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65539"
}
```



---

archive/issue_comments_367705.json:
```json
{
    "body": "Tested this on Sage 8.7, macOS Mojave and Ubuntu 19.04, and the problem seems to be fixed.\n\nIf someone else could confirm this on another OS (the person on ask used debian buster) then we can probably close this as wontfix.",
    "created_at": "2019-05-07T17:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367705",
    "user": "https://github.com/black-stones"
}
```

Tested this on Sage 8.7, macOS Mojave and Ubuntu 19.04, and the problem seems to be fixed.

If someone else could confirm this on another OS (the person on ask used debian buster) then we can probably close this as wontfix.



---

archive/issue_comments_367706.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-08T08:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367706",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367707.json:
```json
{
    "body": "Confirmed on Ubuntu 16.04 that I am not seeing a leak.",
    "created_at": "2019-05-08T08:37:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367707",
    "user": "https://github.com/tscrim"
}
```

Confirmed on Ubuntu 16.04 that I am not seeing a leak.



---

archive/issue_events_065540.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2019-05-13T17:51:39Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65540"
}
```



---

archive/issue_events_065541.json:
```json
{
    "actor": "https://github.com/nbruin",
    "created_at": "2019-05-13T17:51:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65541"
}
```



---

archive/issue_comments_367708.json:
```json
{
    "body": "I'm still seeing suspicious behaviour on sage 8.8.beta3 / python3, on Fedora:\n\nIf I set a vmem limit of 10 gigabyte and execute\n\n```\nn = 1000\nX = zero_vector(GF(2), n)\nM = zero_matrix(GF(2), n, n)\n\nfor _ in range(10000000):\n    Y = M + M\n```\nsage still crashes for me (whereas a small number of iterations does run without problem).",
    "created_at": "2019-05-13T17:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367708",
    "user": "https://github.com/nbruin"
}
```

I'm still seeing suspicious behaviour on sage 8.8.beta3 / python3, on Fedora:

If I set a vmem limit of 10 gigabyte and execute

```
n = 1000
X = zero_vector(GF(2), n)
M = zero_matrix(GF(2), n, n)

for _ in range(10000000):
    Y = M + M
```
sage still crashes for me (whereas a small number of iterations does run without problem).



---

archive/issue_comments_367709.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-05-13T17:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367709",
    "user": "https://github.com/nbruin"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_events_065542.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65542"
}
```



---

archive/issue_events_065543.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-06-14T14:50:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65543"
}
```



---

archive/issue_comments_367710.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367710",
    "user": "https://github.com/embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_events_065544.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65544"
}
```



---

archive/issue_events_065545.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-12-30T14:48:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65545"
}
```



---

archive/issue_comments_367711.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367711",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_367712.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-04-25T16:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367712",
    "user": "https://github.com/sn-d"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_367713.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-25T23:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367713",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367714.json:
```json
{
    "body": "LGTM.",
    "created_at": "2020-04-25T23:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367714",
    "user": "https://github.com/tscrim"
}
```

LGTM.



---

archive/issue_events_065546.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-05-02T21:58:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26112#event-65546"
}
```



---

archive/issue_comments_367715.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-05-02T21:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26112#issuecomment-367715",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
