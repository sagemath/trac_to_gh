# Issue 26319: py3: patch six.add_metaclass to preserve wrapped class's __qualname__

archive/issues_026082.json:
```json
{
    "body": "The current version of `six.add_metaclass` does not preserve the original class's `__qualname__` attribute (as it is not normally stored in the class's `__dict__`):\n\n\n```python\n>>> from six import add_metaclass\n>>> class A:\n...     class B:\n...         pass\n...\n>>> A.B\n<class '__main__.A.B'>\n>>> class MyMeta(type): pass\n...\n>>> class A:\n...     @add_metaclass(MyMeta)\n...     class B:\n...         pass\n...\n>>> A.B\n<class '__main__.B'>\n```\n\n**Upstream PR:** https://github.com/benjaminp/six/pull/260\n\nCC:  @fchapoton\n\nUpstream: Completely fixed; Fix reported upstream\n\nAuthor: Erik Bray\n\nBranch: u/embray/python3/ticket-26319\n\nCommit: dff8d2450314d684cf10f0f426d1c6bd46af3f0f\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/26319\n\n",
    "closed_at": "2019-01-10T10:09:30Z",
    "created_at": "2018-09-20T10:42:09Z",
    "labels": [
        "component: python3",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "py3: patch six.add_metaclass to preserve wrapped class's __qualname__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26319",
    "user": "https://github.com/embray"
}
```
The current version of `six.add_metaclass` does not preserve the original class's `__qualname__` attribute (as it is not normally stored in the class's `__dict__`):


```python
>>> from six import add_metaclass
>>> class A:
...     class B:
...         pass
...
>>> A.B
<class '__main__.A.B'>
>>> class MyMeta(type): pass
...
>>> class A:
...     @add_metaclass(MyMeta)
...     class B:
...         pass
...
>>> A.B
<class '__main__.B'>
```

**Upstream PR:** https://github.com/benjaminp/six/pull/260

CC:  @fchapoton

Upstream: Completely fixed; Fix reported upstream

Author: Erik Bray

Branch: u/embray/python3/ticket-26319

Commit: dff8d2450314d684cf10f0f426d1c6bd46af3f0f

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/26319





---

archive/issue_comments_506068.json:
```json
{
    "body": "<a id='comment:1'></a>Here I just monkey-patch `six.add_metaclass` at Sage import time.  This shouldn't be a problem, and allows us to avoid updating every existing import of `six.add_metaclass`.\n\nI'm happy to update the imports instead of monkey-patch, but that carries with it the danger that if someone doesn't know to use `sage.misc.six.add_metaclass` they could repeat this mistake.\n\nAlternatively, we replace *all* imports of `six` with `sage.misc.six` and use only the latter.  That will require a bit of fancy-footwork to make `six.moves` work but it's doable.\n\n---\nNew commits:",
    "created_at": "2018-09-20T10:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506068",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>Here I just monkey-patch `six.add_metaclass` at Sage import time.  This shouldn't be a problem, and allows us to avoid updating every existing import of `six.add_metaclass`.

I'm happy to update the imports instead of monkey-patch, but that carries with it the danger that if someone doesn't know to use `sage.misc.six.add_metaclass` they could repeat this mistake.

Alternatively, we replace *all* imports of `six` with `sage.misc.six` and use only the latter.  That will require a bit of fancy-footwork to make `six.moves` work but it's doable.

---
New commits:



---

archive/issue_comments_506069.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-20T10:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506069",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_506070.json:
```json
{
    "body": "Changing author from \"\" to \"Erik Bray\"",
    "created_at": "2018-09-20T10:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506070",
    "user": "https://github.com/embray"
}
```

Changing author from "" to "Erik Bray"



---

archive/issue_comments_506071.json:
```json
{
    "body": "Changing branch from \"\" to \"u/embray/python3/ticket-26319\"",
    "created_at": "2018-09-20T10:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506071",
    "user": "https://github.com/embray"
}
```

Changing branch from "" to "u/embray/python3/ticket-26319"



---

archive/issue_comments_506072.json:
```json
{
    "body": "Changing commit from \"\" to \"dff8d2450314d684cf10f0f426d1c6bd46af3f0f\"",
    "created_at": "2018-09-20T10:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506072",
    "user": "https://github.com/embray"
}
```

Changing commit from "" to "dff8d2450314d684cf10f0f426d1c6bd46af3f0f"



---

archive/issue_comments_506073.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,6 +20,8 @@\n <class '__main__.B'>\n ```\n \n+**Upstream PR:** https://github.com/benjaminp/six/pull/260\n+\n Upstream: Not yet reported upstream; Will do shortly.\n \n Comment: 1\n``````\n",
    "created_at": "2018-09-20T11:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506073",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,6 +20,8 @@
 <class '__main__.B'>
 ```
 
+**Upstream PR:** https://github.com/benjaminp/six/pull/260
+
 Upstream: Not yet reported upstream; Will do shortly.
 
 Comment: 1
``````




---

archive/issue_comments_506074.json:
```json
{
    "body": "Changing upstream from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. No feedback yet.\"",
    "created_at": "2018-09-20T11:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506074",
    "user": "https://github.com/embray"
}
```

Changing upstream from "Not yet reported upstream; Will do shortly." to "Reported upstream. No feedback yet."



---

archive/issue_comments_506075.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. No feedback yet.\" to \"Reported upstream. Developers acknowledge bug.\"",
    "created_at": "2018-09-21T08:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506075",
    "user": "https://github.com/embray"
}
```

Changing upstream from "Reported upstream. No feedback yet." to "Reported upstream. Developers acknowledge bug."



---

archive/issue_comments_506076.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. Developers acknowledge bug.\" to \"Fixed upstream, but not in a stable release.\"",
    "created_at": "2018-10-04T08:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506076",
    "user": "https://github.com/embray"
}
```

Changing upstream from "Reported upstream. Developers acknowledge bug." to "Fixed upstream, but not in a stable release."



---

archive/issue_events_065479.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26319#event-65479"
}
```



---

archive/issue_comments_506077.json:
```json
{
    "body": "<a id='comment:6'></a>Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506077",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_events_065480.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26319#event-65480"
}
```



---

archive/issue_events_065481.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:10:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26319#event-65481"
}
```



---

archive/issue_comments_506078.json:
```json
{
    "body": "<a id='comment:7'></a>I almost forgot about this ticket, but I believe it will still fix some tests on Python 3.",
    "created_at": "2019-01-09T18:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506078",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>I almost forgot about this ticket, but I believe it will still fix some tests on Python 3.



---

archive/issue_comments_506079.json:
```json
{
    "body": "Changing upstream from \"Fixed upstream, but not in a stable release.\" to \"Completely fixed; Fix reported upstream\"",
    "created_at": "2019-01-10T10:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506079",
    "user": "https://github.com/jdemeyer"
}
```

Changing upstream from "Fixed upstream, but not in a stable release." to "Completely fixed; Fix reported upstream"



---

archive/issue_events_065482.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-10T10:09:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26319#event-65482"
}
```



---

archive/issue_comments_506080.json:
```json
{
    "body": "<a id='comment:8'></a>This is fixed by six 1.12.0, upgrade at #26969.",
    "created_at": "2019-01-10T10:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506080",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>This is fixed by six 1.12.0, upgrade at #26969.



---

archive/issue_comments_506081.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-01-10T10:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506081",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_events_065483.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-10T10:09:30Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26319#event-65483"
}
```



---

archive/issue_events_065484.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-01-10T10:09:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26319#event-65484"
}
```



---

archive/issue_comments_506082.json:
```json
{
    "body": "<a id='comment:9'></a>There still seem to be some test failures on Python 3 related to this, but I can confirm that six 1.12.0 at least contains the basic fix for nested classes with add_metaclass.",
    "created_at": "2019-01-10T14:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506082",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>There still seem to be some test failures on Python 3 related to this, but I can confirm that six 1.12.0 at least contains the basic fix for nested classes with add_metaclass.



---

archive/issue_comments_506083.json:
```json
{
    "body": "<a id='comment:10'></a>Note that `six` also has `with_metaclass`. Presumably that needs to be patched too?",
    "created_at": "2019-01-10T14:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506083",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Note that `six` also has `with_metaclass`. Presumably that needs to be patched too?



---

archive/issue_comments_506084.json:
```json
{
    "body": "<a id='comment:11'></a>I have a PR to fix two other bugs with `with_metaclass` at https://github.com/benjaminp/six/pull/211 but without feedback from upstream.",
    "created_at": "2019-01-10T14:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26319#issuecomment-506084",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>I have a PR to fix two other bugs with `with_metaclass` at https://github.com/benjaminp/six/pull/211 but without feedback from upstream.
