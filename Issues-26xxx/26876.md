# Issue 26876: parallel functions swallow alarm interruptions

archive/issues_026639.json:
```json
{
    "assignees": [],
    "body": "Import alarm, sleep and parallel and construct a function to be run in parallel:\n\n```python\nsage: from signal import alarm\nsage: from time import sleep\nsage: @parallel\n....: def f(a):\n....:     sleep(1)\n....:     return factor(a)\n....: \n```\n\nIf the function `f` is called normally, it behaves well with alarm interruptions:\n\n```python\nsage: try:\n....:     alarm(1)\n....:     map(f, range(10))\n....: except AlarmInterrupt:\n....:     print 'alarm'\n....: else:\n....:     print 'else'\n....:     \n0\nalarm\n```\n\nBut If the function `f` is called in parallel, then it ignores the alarm interruption and just continue its execution:\n\n```python\nsage: try:\n....:     alarm(1)\n....:     L = list(f(range(1,10)))\n....: except AlarmInterrupt:\n....:     print 'alarm'\n....: else:\n....:     print 'else'\n....:     \n0\nelse\n```\n\nOf course, as a result, the computation for input 1 was stopped (thus NO DATA) and the other computations were not stopped:\n\n```python\nsage: L\n[(((1,), {}), 'NO DATA (timed out)'),\n (((2,), {}), 2),\n (((3,), {}), 3),\n (((4,), {}), 2^2),\n (((5,), {}), 5),\n (((6,), {}), 2 * 3),\n (((7,), {}), 7),\n (((8,), {}), 2^3),\n (((9,), {}), 3^2)]\n```\nI consider this as a bug. I believe that the parallel `f` function should not swallow the `alarm` interruptions so that the above example print \"alarm\" and not \"else\".\n\nKeywords: **thursdaysbdx**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26876_\n\n",
    "created_at": "2018-12-11T10:49:36Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "parallel functions swallow alarm interruptions",
    "type": "issue",
    "updated_at": "2022-12-29T01:43:14Z",
    "url": "https://github.com/sagemath/sage/issues/26876",
    "user": "https://github.com/seblabbe"
}
```
Import alarm, sleep and parallel and construct a function to be run in parallel:

```python
sage: from signal import alarm
sage: from time import sleep
sage: @parallel
....: def f(a):
....:     sleep(1)
....:     return factor(a)
....: 
```

If the function `f` is called normally, it behaves well with alarm interruptions:

```python
sage: try:
....:     alarm(1)
....:     map(f, range(10))
....: except AlarmInterrupt:
....:     print 'alarm'
....: else:
....:     print 'else'
....:     
0
alarm
```

But If the function `f` is called in parallel, then it ignores the alarm interruption and just continue its execution:

```python
sage: try:
....:     alarm(1)
....:     L = list(f(range(1,10)))
....: except AlarmInterrupt:
....:     print 'alarm'
....: else:
....:     print 'else'
....:     
0
else
```

Of course, as a result, the computation for input 1 was stopped (thus NO DATA) and the other computations were not stopped:

```python
sage: L
[(((1,), {}), 'NO DATA (timed out)'),
 (((2,), {}), 2),
 (((3,), {}), 3),
 (((4,), {}), 2^2),
 (((5,), {}), 5),
 (((6,), {}), 2 * 3),
 (((7,), {}), 7),
 (((8,), {}), 2^3),
 (((9,), {}), 3^2)]
```
I consider this as a bug. I believe that the parallel `f` function should not swallow the `alarm` interruptions so that the above example print "alarm" and not "else".

Keywords: **thursdaysbdx**

_Issue created by migration from https://trac.sagemath.org/ticket/26876_





---

archive/issue_events_338623.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2018-12-11T10:49:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26876#event-338623"
}
```



---

archive/issue_events_338624.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2018-12-11T10:49:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26876#event-338624"
}
```



---

archive/issue_comments_416649.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nThe problem is that the `@parallel` decorator uses alarms internally to implement the timeout functionality. So basically your alarm is overridden by `@parallel`.",
    "created_at": "2018-12-11T15:37:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416649",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'>Comment 1:</a>
The problem is that the `@parallel` decorator uses alarms internally to implement the timeout functionality. So basically your alarm is overridden by `@parallel`.



---

archive/issue_comments_416650.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\n\n```\nsage: @parallel?\n```\nsays:\n\n```\n      * \"timeout\" -- number of seconds until each subprocess is\n        killed (only supported by 'fork'; zero means not at all)\n```\nWould it be possible when `timeout=zero` that alarm exceptions are not catched since when `timeout=0` no alarm are set?",
    "created_at": "2018-12-13T08:21:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416650",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:2'>Comment 2:</a>

```
sage: @parallel?
```
says:

```
      * "timeout" -- number of seconds until each subprocess is
        killed (only supported by 'fork'; zero means not at all)
```
Would it be possible when `timeout=zero` that alarm exceptions are not catched since when `timeout=0` no alarm are set?



---

archive/issue_comments_416651.json:
```json
{
    "body": "Changed keywords from **** to **thursdaysbdx**",
    "created_at": "2018-12-13T08:22:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416651",
    "user": "https://github.com/seblabbe"
}
```

Changed keywords from **** to **thursdaysbdx**



---

archive/issue_comments_416652.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nI have seen this issue 3 times already on buildservers doctesting `src/sage/parallel/decorate.py`.",
    "created_at": "2019-06-18T19:02:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416652",
    "user": "https://github.com/timokau"
}
```

<a id='comment:4'>Comment 4:</a>
I have seen this issue 3 times already on buildservers doctesting `src/sage/parallel/decorate.py`.



---

archive/issue_comments_416653.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@timokau](#comment%3A4):\n> I have seen this issue 3 times already on buildservers doctesting `src/sage/parallel/decorate.py`.\n\nCan you elaborate?",
    "created_at": "2019-06-19T05:36:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416653",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@timokau](#comment%3A4):
> I have seen this issue 3 times already on buildservers doctesting `src/sage/parallel/decorate.py`.

Can you elaborate?



---

archive/issue_comments_416654.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nOur buildservers have randomly ran into this failure 3 times while building (and testing) sage. Two times was on sage 8.7 (in our unstable channel), once on 8.6 (latest stable). Here's a log for 8.7:\n\nhttp://sprunge.us/mYh7ju",
    "created_at": "2019-06-19T17:38:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416654",
    "user": "https://github.com/timokau"
}
```

<a id='comment:6'>Comment 6:</a>
Our buildservers have randomly ran into this failure 3 times while building (and testing) sage. Two times was on sage 8.7 (in our unstable channel), once on 8.6 (latest stable). Here's a log for 8.7:

http://sprunge.us/mYh7ju



---

archive/issue_comments_416655.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nWhy do you think that those buildserver failures are because of this ticket? It seems to me that you're hitting a different unrelated bug.",
    "created_at": "2019-06-19T18:00:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416655",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
Why do you think that those buildserver failures are because of this ticket? It seems to me that you're hitting a different unrelated bug.



---

archive/issue_comments_416656.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nI just jumped to the conclusion, because the error is so similar. Looking at it in more detail though, you're probably right. May just be the server under load hitting the 10 second timeout (having a timeout in unit tests seems like an antipattern to me anyways).",
    "created_at": "2019-06-20T12:01:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26876#issuecomment-416656",
    "user": "https://github.com/timokau"
}
```

<a id='comment:8'>Comment 8:</a>
I just jumped to the conclusion, because the error is so similar. Looking at it in more detail though, you're probably right. May just be the server under load hitting the 10 second timeout (having a timeout in unit tests seems like an antipattern to me anyways).



---

archive/issue_events_338625.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-12-29T01:43:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26876",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26876#event-338625"
}
```
