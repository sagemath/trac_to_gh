# Issue 26301: Python 3 bug in zipfile

archive/issues_026064.json:
```json
{
    "body": "There's a doctest that invokes this bug in Python 3.6's `zipfile` module:\n\n```\nsage: from sage.plot.plot3d.shapes import Cylinder\nsage: C = Cylinder(3, 1, closed=False)\nsage: C.jmol_repr(C.testing_render_params())\nException ignored in: <bound method ZipFile.__del__ of <zipfile.ZipFile [closed]>>\nTraceback (most recent call last):\n  File \"/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py\", line 1663, in __del__\n    self.close()\n  File \"/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py\", line 1681, in close\n    self._write_end_record()\n  File \"/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py\", line 1783, in _write_end_record\n    centDirSize, centDirOffset, len(self._comment))\nstruct.error: argument out of range\n['pmesh obj_1 \"obj_1.pmesh\"\\ncolor pmesh  [102,102,255]']\n```\n\nThe `Graphics3d.testing_render_params()` opens a `ZipFile` in write mode to `/dev/null`, so the bug seems to have to do with writing a zipfile to `/dev/null` (probably to do with a `tell()` call somewhere).\n\nFor the purposes of testing there's no reason this needs to go to `'/dev/null'`.  It can just as well use a temp file, so we can implement that workaround.  But we should also open an upstream bug report for the `zipfile` problem, if it hasn't already been reported.\n\nUpstream bug report: https://bugs.python.org/issue34904\n\nIssue created by migration from https://trac.sagemath.org/ticket/26301\n\n",
    "closed_at": "2018-10-06T17:12:56Z",
    "created_at": "2018-09-17T15:22:33Z",
    "labels": [
        "component: python3",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Python 3 bug in zipfile",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26301",
    "user": "https://github.com/embray"
}
```
There's a doctest that invokes this bug in Python 3.6's `zipfile` module:

```
sage: from sage.plot.plot3d.shapes import Cylinder
sage: C = Cylinder(3, 1, closed=False)
sage: C.jmol_repr(C.testing_render_params())
Exception ignored in: <bound method ZipFile.__del__ of <zipfile.ZipFile [closed]>>
Traceback (most recent call last):
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py", line 1663, in __del__
    self.close()
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py", line 1681, in close
    self._write_end_record()
  File "/home/embray/src/sagemath/sage-python3/local/lib/python3.6/zipfile.py", line 1783, in _write_end_record
    centDirSize, centDirOffset, len(self._comment))
struct.error: argument out of range
['pmesh obj_1 "obj_1.pmesh"\ncolor pmesh  [102,102,255]']
```

The `Graphics3d.testing_render_params()` opens a `ZipFile` in write mode to `/dev/null`, so the bug seems to have to do with writing a zipfile to `/dev/null` (probably to do with a `tell()` call somewhere).

For the purposes of testing there's no reason this needs to go to `'/dev/null'`.  It can just as well use a temp file, so we can implement that workaround.  But we should also open an upstream bug report for the `zipfile` problem, if it hasn't already been reported.

Upstream bug report: https://bugs.python.org/issue34904

Issue created by migration from https://trac.sagemath.org/ticket/26301





---

archive/issue_comments_367167.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-04T19:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26301#issuecomment-367167",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367168.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-04T19:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26301#issuecomment-367168",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367169.json:
```json
{
    "body": "Sure, looks good to me.  I still need to make sure to make an upstream bug report (but this is pretty minor, and after fixing it in Sage I doubt we'll revisit the issue).",
    "created_at": "2018-10-05T09:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26301#issuecomment-367169",
    "user": "https://github.com/embray"
}
```

Sure, looks good to me.  I still need to make sure to make an upstream bug report (but this is pretty minor, and after fixing it in Sage I doubt we'll revisit the issue).



---

archive/issue_comments_367170.json:
```json
{
    "body": "Interestingly, I can't reproduce the bug on Cygwin, only on Linux.  I was trying to see if it was still broken in master, and at first I thought maybe it was fixed.  But no, it just doesn't happen on Cygwin that I can tell.  Maybe some difference in how /dev/null works; not sure.",
    "created_at": "2018-10-05T10:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26301#issuecomment-367170",
    "user": "https://github.com/embray"
}
```

Interestingly, I can't reproduce the bug on Cygwin, only on Linux.  I was trying to see if it was still broken in master, and at first I thought maybe it was fixed.  But no, it just doesn't happen on Cygwin that I can tell.  Maybe some difference in how /dev/null works; not sure.



---

archive/issue_comments_367171.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-05T10:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26301#issuecomment-367171",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367172.json:
```json
{
    "body": "Ok, upstream bug report submitted.  LGTM.",
    "created_at": "2018-10-05T10:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26301#issuecomment-367172",
    "user": "https://github.com/embray"
}
```

Ok, upstream bug report submitted.  LGTM.



---

archive/issue_events_065450.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-10-06T17:12:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26301#event-65450"
}
```



---

archive/issue_comments_367173.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-06T17:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26301",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26301#issuecomment-367173",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
