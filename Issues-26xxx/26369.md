# Issue 26369: Improve triconnectivity algorithm: some cythonization

archive/issues_026132.json:
```json
{
    "assignees": [],
    "body": "We do some speed up improvements by\n- changing the way edges are stored internally\n- simplifying method `__split_multiple_edges`\n- declare variable types\n- use int arrays\n\n**CC:**  @meghanamreddy saiharsh @tscrim\n\n**Branch/Commit:** [16f290dc72a5950966a535f9ddfd8d0f5083b606](https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** David Coudert\n\nIssue created by migration from https://trac.sagemath.org/ticket/26369\n\n",
    "closed_at": "2018-10-04T21:54:09Z",
    "created_at": "2018-10-01T07:03:50Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20graph%20theory",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Improve triconnectivity algorithm: some cythonization",
    "type": "issue",
    "updated_at": "2018-10-04T21:54:09Z",
    "url": "https://github.com/sagemath/sage/issues/26369",
    "user": "https://github.com/dcoudert"
}
```
We do some speed up improvements by
- changing the way edges are stored internally
- simplifying method `__split_multiple_edges`
- declare variable types
- use int arrays

**CC:**  @meghanamreddy saiharsh @tscrim

**Branch/Commit:** [16f290dc72a5950966a535f9ddfd8d0f5083b606](https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606)

**Reviewer:** Travis Scrimshaw

**Author:** David Coudert

Issue created by migration from https://trac.sagemath.org/ticket/26369





---

archive/issue_comments_409232.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,5 @@\n We do some speed up improvements by\n - changing the way edges are stored internally\n-- simplifying method ``__split_multiple_edges``\n+- simplifying method `__split_multiple_edges`\n - declare variable types\n - use int arrays\n``````\n",
    "created_at": "2018-10-01T07:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409232",
    "user": "https://github.com/dcoudert"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,5 @@
 We do some speed up improvements by
 - changing the way edges are stored internally
-- simplifying method ``__split_multiple_edges``
+- simplifying method `__split_multiple_edges`
 - declare variable types
 - use int arrays
``````




---

archive/issue_comments_409233.json:
```json
{
    "body": "**Commit:** [395a42de8efcd6aaf4353050827d9b6f7e8df713](https://github.com/sagemath/sagetrac-mirror/commit/395a42de8efcd6aaf4353050827d9b6f7e8df713)",
    "created_at": "2018-10-01T07:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409233",
    "user": "https://github.com/dcoudert"
}
```

**Commit:** [395a42de8efcd6aaf4353050827d9b6f7e8df713](https://github.com/sagemath/sagetrac-mirror/commit/395a42de8efcd6aaf4353050827d9b6f7e8df713)



---

archive/issue_comments_409234.json:
```json
{
    "body": "**Branch:** [public/26369_cythonize_triconnectivity](https://github.com/sagemath/sagetrac-mirror/tree/public/26369_cythonize_triconnectivity)",
    "created_at": "2018-10-01T07:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409234",
    "user": "https://github.com/dcoudert"
}
```

**Branch:** [public/26369_cythonize_triconnectivity](https://github.com/sagemath/sagetrac-mirror/tree/public/26369_cythonize_triconnectivity)



---

archive/issue_comments_409235.json:
```json
{
    "body": "<a id='comment:1'></a>\nThis commit changes the way to deal with edges. We now associate each edge a unique identifier (int) and then store that identifier instead of the edge in data structures such as internal dictionaries, the doubly link list, the components, etc.\n\nAfter that we can turn many data structures to arrays. Furthermore, it ensures that `_LinkedListNode` only stores an integer\nvalue and not any types.\n\nOn the way, we drastically simplify method `__split_multiple_edges`. Indeed, we don't need to sort edges, but to arrange edges with same end points into buckets. If a bucket has more than one edge, we have a set of multiple edges.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/395a42de8efcd6aaf4353050827d9b6f7e8df713\">395a42d</a></td><td><code>trac #26369: change internal manipulation of edges</code></td></tr></table>\n",
    "created_at": "2018-10-01T07:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409235",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:1'></a>
This commit changes the way to deal with edges. We now associate each edge a unique identifier (int) and then store that identifier instead of the edge in data structures such as internal dictionaries, the doubly link list, the components, etc.

After that we can turn many data structures to arrays. Furthermore, it ensures that `_LinkedListNode` only stores an integer
value and not any types.

On the way, we drastically simplify method `__split_multiple_edges`. Indeed, we don't need to sort edges, but to arrange edges with same end points into buckets. If a bucket has more than one edge, we have a set of multiple edges.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/395a42de8efcd6aaf4353050827d9b6f7e8df713">395a42d</a></td><td><code>trac #26369: change internal manipulation of edges</code></td></tr></table>




---

archive/issue_comments_409236.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/46ac9547d4684351184190d3c6e1b11aa418b195\">46ac954</a></td><td><code>trac #26369: declare types and use arrays</code></td></tr></table>\n",
    "created_at": "2018-10-01T07:36:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409236",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/46ac9547d4684351184190d3c6e1b11aa418b195">46ac954</a></td><td><code>trac #26369: declare types and use arrays</code></td></tr></table>




---

archive/issue_comments_409237.json:
```json
{
    "body": "**Changing commit** from \"[395a42de8efcd6aaf4353050827d9b6f7e8df713](https://github.com/sagemath/sagetrac-mirror/commit/395a42de8efcd6aaf4353050827d9b6f7e8df713)\" to \"[46ac9547d4684351184190d3c6e1b11aa418b195](https://github.com/sagemath/sagetrac-mirror/commit/46ac9547d4684351184190d3c6e1b11aa418b195)\".",
    "created_at": "2018-10-01T07:36:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409237",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[395a42de8efcd6aaf4353050827d9b6f7e8df713](https://github.com/sagemath/sagetrac-mirror/commit/395a42de8efcd6aaf4353050827d9b6f7e8df713)" to "[46ac9547d4684351184190d3c6e1b11aa418b195](https://github.com/sagemath/sagetrac-mirror/commit/46ac9547d4684351184190d3c6e1b11aa418b195)".



---

archive/issue_comments_409238.json:
```json
{
    "body": "<a id='comment:3'></a>\nIn the second commit, we declare simple types, use int arrays instead of list/dict, etc.",
    "created_at": "2018-10-01T07:38:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409238",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>
In the second commit, we declare simple types, use int arrays instead of list/dict, etc.



---

archive/issue_comments_409239.json:
```json
{
    "body": "**Changing commit** from \"[46ac9547d4684351184190d3c6e1b11aa418b195](https://github.com/sagemath/sagetrac-mirror/commit/46ac9547d4684351184190d3c6e1b11aa418b195)\" to \"[112cc82759cb7068b5ff52c906c67094fea8a2c3](https://github.com/sagemath/sagetrac-mirror/commit/112cc82759cb7068b5ff52c906c67094fea8a2c3)\".",
    "created_at": "2018-10-01T16:31:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409239",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[46ac9547d4684351184190d3c6e1b11aa418b195](https://github.com/sagemath/sagetrac-mirror/commit/46ac9547d4684351184190d3c6e1b11aa418b195)" to "[112cc82759cb7068b5ff52c906c67094fea8a2c3](https://github.com/sagemath/sagetrac-mirror/commit/112cc82759cb7068b5ff52c906c67094fea8a2c3)".



---

archive/issue_comments_409240.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/112cc82759cb7068b5ff52c906c67094fea8a2c3\">112cc82</a></td><td><code>trac #26369: improve manipulation of edges</code></td></tr></table>\n",
    "created_at": "2018-10-01T16:31:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409240",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/112cc82759cb7068b5ff52c906c67094fea8a2c3">112cc82</a></td><td><code>trac #26369: improve manipulation of edges</code></td></tr></table>




---

archive/issue_events_233357.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2018-10-01T16:46:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26369#event-233357"
}
```



---

archive/issue_comments_409241.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis last commit uses the observation that the index in list `int_to_edge` of virtual edges is `>= m` (the first virtual edge has index `m`, the second `m+1`, etc.). \n- The internal label of a virtual edge is now its index.\n- To test if an edge is a virtual edge, it suffices to test if its index is `>= m`.\n- We introduce 2 arrays to store edges extremities. The main motivation is to avoid constantly accessing list `int_to_edge`.\n\nMore cythonization can be done, in particular for the doubly linked list, but I don't know yet what's the best way to do it. May be for another ticket. We already do a lot here.\n\nAlso, I have some doubt in types declarations between `int` and `Py_ssize_t`. When should we use this `Py_ssize_t` ?",
    "created_at": "2018-10-01T16:46:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409241",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:5'></a>
This last commit uses the observation that the index in list `int_to_edge` of virtual edges is `>= m` (the first virtual edge has index `m`, the second `m+1`, etc.). 
- The internal label of a virtual edge is now its index.
- To test if an edge is a virtual edge, it suffices to test if its index is `>= m`.
- We introduce 2 arrays to store edges extremities. The main motivation is to avoid constantly accessing list `int_to_edge`.

More cythonization can be done, in particular for the doubly linked list, but I don't know yet what's the best way to do it. May be for another ticket. We already do a lot here.

Also, I have some doubt in types declarations between `int` and `Py_ssize_t`. When should we use this `Py_ssize_t` ?



---

archive/issue_comments_409242.json:
```json
{
    "body": "<a id='comment:6'></a>\n`Py_ssize_t` is for when you thing you might overflow the usual `int`. In general, you should use `Py_ssize_t` as `int` imposes a more artificial limitation on sizes.",
    "created_at": "2018-10-01T22:31:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409242",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>
`Py_ssize_t` is for when you thing you might overflow the usual `int`. In general, you should use `Py_ssize_t` as `int` imposes a more artificial limitation on sizes.



---

archive/issue_comments_409243.json:
```json
{
    "body": "<a id='comment:7'></a>\nTimings:\n\nYour branch:\n\n```\nsage: G = graphs.JankoKharaghaniGraph(936)\nsage: (G.order(), G.size())\n(936, 175500)\nsage: %time T = G.spqr_tree()\nCPU times: user 4.28 s, sys: 124 ms, total: 4.41 s\nWall time: 4.37 s\n```\nvs 8.4.beta7:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 6.2 s, sys: 92 ms, total: 6.3 s\nWall time: 6.22 s\n```\n\nSo already you have a very good speedup on this example (cut ~1/3 of the run time). Let me take a look over things to see what I can improve as well.",
    "created_at": "2018-10-01T22:35:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409243",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>
Timings:

Your branch:

```
sage: G = graphs.JankoKharaghaniGraph(936)
sage: (G.order(), G.size())
(936, 175500)
sage: %time T = G.spqr_tree()
CPU times: user 4.28 s, sys: 124 ms, total: 4.41 s
Wall time: 4.37 s
```
vs 8.4.beta7:

```
sage: %time T = G.spqr_tree()
CPU times: user 6.2 s, sys: 92 ms, total: 6.3 s
Wall time: 6.22 s
```

So already you have a very good speedup on this example (cut ~1/3 of the run time). Let me take a look over things to see what I can improve as well.



---

archive/issue_comments_409244.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/173d56519be3d6054423d94842e3e5ff96bd8e86\">173d565</a></td><td><code>Cythonizing helper classes in graphs/connectivity.pyx.</code></td></tr></table>\n",
    "created_at": "2018-10-01T23:21:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409244",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/173d56519be3d6054423d94842e3e5ff96bd8e86">173d565</a></td><td><code>Cythonizing helper classes in graphs/connectivity.pyx.</code></td></tr></table>




---

archive/issue_comments_409245.json:
```json
{
    "body": "**Changing commit** from \"[112cc82759cb7068b5ff52c906c67094fea8a2c3](https://github.com/sagemath/sagetrac-mirror/commit/112cc82759cb7068b5ff52c906c67094fea8a2c3)\" to \"[173d56519be3d6054423d94842e3e5ff96bd8e86](https://github.com/sagemath/sagetrac-mirror/commit/173d56519be3d6054423d94842e3e5ff96bd8e86)\".",
    "created_at": "2018-10-01T23:21:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409245",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[112cc82759cb7068b5ff52c906c67094fea8a2c3](https://github.com/sagemath/sagetrac-mirror/commit/112cc82759cb7068b5ff52c906c67094fea8a2c3)" to "[173d56519be3d6054423d94842e3e5ff96bd8e86](https://github.com/sagemath/sagetrac-mirror/commit/173d56519be3d6054423d94842e3e5ff96bd8e86)".



---

archive/issue_comments_409246.json:
```json
{
    "body": "<a id='comment:9'></a>\nWith Cythonizing the helper classes, I get a ~3x speedup versus 8.4.beta7:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 2.63 s, sys: 72 ms, total: 2.7 s\nWall time: 2.66 s\n```\n\nI have not looked at the generated C code to see where inefficiencies are yet (i.e., types that we know that we can declare), but that might get even more speed out. However, the next step would be moving away from the Python types such as `list` and `dict` to C++ STL types `vector` and `map` with explicitly declared types. Actually, you might just consider separating these out into a separate C++  file/library (I believe you can simply replace `Py_ssize_t` with `ssize_t`). This will give you more control over things, but (of course) means you have to manage the memory more yourself.",
    "created_at": "2018-10-01T23:27:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409246",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>
With Cythonizing the helper classes, I get a ~3x speedup versus 8.4.beta7:

```
sage: %time T = G.spqr_tree()
CPU times: user 2.63 s, sys: 72 ms, total: 2.7 s
Wall time: 2.66 s
```

I have not looked at the generated C code to see where inefficiencies are yet (i.e., types that we know that we can declare), but that might get even more speed out. However, the next step would be moving away from the Python types such as `list` and `dict` to C++ STL types `vector` and `map` with explicitly declared types. Actually, you might just consider separating these out into a separate C++  file/library (I believe you can simply replace `Py_ssize_t` with `ssize_t`). This will give you more control over things, but (of course) means you have to manage the memory more yourself.



---

archive/issue_comments_409247.json:
```json
{
    "body": "<a id='comment:10'></a>\nAlthough to do that, I believe you would need to make `_LinkedList(Node)` and `_Component` into C++ classes. Well, I am saying/asking to get rid of as much of the Python as possible. :P",
    "created_at": "2018-10-01T23:44:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409247",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>
Although to do that, I believe you would need to make `_LinkedList(Node)` and `_Component` into C++ classes. Well, I am saying/asking to get rid of as much of the Python as possible. :P



---

archive/issue_comments_409248.json:
```json
{
    "body": "<a id='comment:11'></a>\nActually, pulling it out to a separate library might be a little tricky because of having to work with the `Graph` object. Anyways, these are things that can wait for another ticket. Although one thing that would be really good would be if you could fix the type of `_LinkedListNode` (or maybe as a [fused type](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html)).",
    "created_at": "2018-10-02T00:43:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409248",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>
Actually, pulling it out to a separate library might be a little tricky because of having to work with the `Graph` object. Anyways, these are things that can wait for another ticket. Although one thing that would be really good would be if you could fix the type of `_LinkedListNode` (or maybe as a [fused type](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html)).



---

archive/issue_comments_409249.json:
```json
{
    "body": "<a id='comment:12'></a>\nIt seems like this code converts the graph internally into a specific format, so maybe it could work as a standalone library (or C++) with Sage handling the conversion.\n\nQuestion, does `e_node_dict` always eventually expand out to `G.order()`? If so, then it would be better for it to be a fixed-length array of `_LinkedListNode`'s (once those become `struct`'s, but that seems a little more invasive of a change than I initially was thinking).\n\nIn general, the only bad bit of C code I see are those coming from the `graph_copy` manipulations and the fact that `_LinkedListNode` does not know its `data` type. For the graph manipulations, it might better to directly call the corresponding `_backend` method. At the very least, it avoids a level of python indirection, but you might have to unpack the `int_to_edge` into 3 arrays or an array of a `cdef struct` (I would go with the latter) and then feed each of those off.\n\nI made `_LinkedListNode` know that `data` is a `Py_ssize_t`, which gave me a few extra ticks.\n\nIt might be better for `e_stack` to be a C++ STL `stack` (or `vector`) of `int`'s too.\n\nI didn't see a general `_LinkedList` needing to be a doubly-linked list other than the `remove`. Do you think it would be possible to easily hold onto that `prev` so you don't need to manipulate a doubly-linked list (and only a singly-linked list)?\n\nSpeaking of which, the `_LinkedList` is a little strange in that its getter and setter methods are based on working with the nodes rather than the underlying data.\n\nOkay, I am done with my comments and commits.",
    "created_at": "2018-10-02T02:31:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409249",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>
It seems like this code converts the graph internally into a specific format, so maybe it could work as a standalone library (or C++) with Sage handling the conversion.

Question, does `e_node_dict` always eventually expand out to `G.order()`? If so, then it would be better for it to be a fixed-length array of `_LinkedListNode`'s (once those become `struct`'s, but that seems a little more invasive of a change than I initially was thinking).

In general, the only bad bit of C code I see are those coming from the `graph_copy` manipulations and the fact that `_LinkedListNode` does not know its `data` type. For the graph manipulations, it might better to directly call the corresponding `_backend` method. At the very least, it avoids a level of python indirection, but you might have to unpack the `int_to_edge` into 3 arrays or an array of a `cdef struct` (I would go with the latter) and then feed each of those off.

I made `_LinkedListNode` know that `data` is a `Py_ssize_t`, which gave me a few extra ticks.

It might be better for `e_stack` to be a C++ STL `stack` (or `vector`) of `int`'s too.

I didn't see a general `_LinkedList` needing to be a doubly-linked list other than the `remove`. Do you think it would be possible to easily hold onto that `prev` so you don't need to manipulate a doubly-linked list (and only a singly-linked list)?

Speaking of which, the `_LinkedList` is a little strange in that its getter and setter methods are based on working with the nodes rather than the underlying data.

Okay, I am done with my comments and commits.



---

archive/issue_comments_409250.json:
```json
{
    "body": "<a id='comment:13'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/18aa4b3b1df01060ff9caa081e44831a7b17545e\">18aa4b3</a></td><td><code>Inline a few more things.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c9da30e516ffd414a90894a244d40dfc2ea5ab1\">2c9da30</a></td><td><code>Removing iterator/StopIteration version of adjacency.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/18c5278c1eae4df42390af26c91c60c2e0ec9e4e\">18c5278</a></td><td><code>A few extra standardization things and micro-optimizations.</code></td></tr></table>\n",
    "created_at": "2018-10-02T02:31:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409250",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:13'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/18aa4b3b1df01060ff9caa081e44831a7b17545e">18aa4b3</a></td><td><code>Inline a few more things.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c9da30e516ffd414a90894a244d40dfc2ea5ab1">2c9da30</a></td><td><code>Removing iterator/StopIteration version of adjacency.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/18c5278c1eae4df42390af26c91c60c2e0ec9e4e">18c5278</a></td><td><code>A few extra standardization things and micro-optimizations.</code></td></tr></table>




---

archive/issue_comments_409251.json:
```json
{
    "body": "**Changing commit** from \"[173d56519be3d6054423d94842e3e5ff96bd8e86](https://github.com/sagemath/sagetrac-mirror/commit/173d56519be3d6054423d94842e3e5ff96bd8e86)\" to \"[18c5278c1eae4df42390af26c91c60c2e0ec9e4e](https://github.com/sagemath/sagetrac-mirror/commit/18c5278c1eae4df42390af26c91c60c2e0ec9e4e)\".",
    "created_at": "2018-10-02T02:31:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409251",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[173d56519be3d6054423d94842e3e5ff96bd8e86](https://github.com/sagemath/sagetrac-mirror/commit/173d56519be3d6054423d94842e3e5ff96bd8e86)" to "[18c5278c1eae4df42390af26c91c60c2e0ec9e4e](https://github.com/sagemath/sagetrac-mirror/commit/18c5278c1eae4df42390af26c91c60c2e0ec9e4e)".



---

archive/issue_comments_409252.json:
```json
{
    "body": "**Changing commit** from \"[18c5278c1eae4df42390af26c91c60c2e0ec9e4e](https://github.com/sagemath/sagetrac-mirror/commit/18c5278c1eae4df42390af26c91c60c2e0ec9e4e)\" to \"[4efd92483cdb9ec1e2c741165c7d9f683ec4730f](https://github.com/sagemath/sagetrac-mirror/commit/4efd92483cdb9ec1e2c741165c7d9f683ec4730f)\".",
    "created_at": "2018-10-02T13:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409252",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[18c5278c1eae4df42390af26c91c60c2e0ec9e4e](https://github.com/sagemath/sagetrac-mirror/commit/18c5278c1eae4df42390af26c91c60c2e0ec9e4e)" to "[4efd92483cdb9ec1e2c741165c7d9f683ec4730f](https://github.com/sagemath/sagetrac-mirror/commit/4efd92483cdb9ec1e2c741165c7d9f683ec4730f)".



---

archive/issue_comments_409253.json:
```json
{
    "body": "<a id='comment:14'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4efd92483cdb9ec1e2c741165c7d9f683ec4730f\">4efd924</a></td><td><code>trac #26369: remove graph_copy, int_to_edge, edge_to_int</code></td></tr></table>\n",
    "created_at": "2018-10-02T13:10:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409253",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:14'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4efd92483cdb9ec1e2c741165c7d9f683ec4730f">4efd924</a></td><td><code>trac #26369: remove graph_copy, int_to_edge, edge_to_int</code></td></tr></table>




---

archive/issue_comments_409254.json:
```json
{
    "body": "<a id='comment:15'></a>\nThank you Travis for the great improvements.\n\nI removed `graph_copy`, `int_to_edge`, and `edge_to_int` as we don't need them anymore. In fact, we can use the status of an edge to decide if it is in the graph or not (active if 0,1,2 or inactive if -1).\n\nI will check what can be done for `_LinkedListNode`. Note that I'm reluctant to go to C++ as I know very little of it.",
    "created_at": "2018-10-02T13:17:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409254",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:15'></a>
Thank you Travis for the great improvements.

I removed `graph_copy`, `int_to_edge`, and `edge_to_int` as we don't need them anymore. In fact, we can use the status of an edge to decide if it is in the graph or not (active if 0,1,2 or inactive if -1).

I will check what can be done for `_LinkedListNode`. Note that I'm reluctant to go to C++ as I know very little of it.



---

archive/issue_comments_409255.json:
```json
{
    "body": "**Changing commit** from \"[4efd92483cdb9ec1e2c741165c7d9f683ec4730f](https://github.com/sagemath/sagetrac-mirror/commit/4efd92483cdb9ec1e2c741165c7d9f683ec4730f)\" to \"[16f290dc72a5950966a535f9ddfd8d0f5083b606](https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606)\".",
    "created_at": "2018-10-02T16:18:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409255",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[4efd92483cdb9ec1e2c741165c7d9f683ec4730f](https://github.com/sagemath/sagetrac-mirror/commit/4efd92483cdb9ec1e2c741165c7d9f683ec4730f)" to "[16f290dc72a5950966a535f9ddfd8d0f5083b606](https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606)".



---

archive/issue_comments_409256.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606\">16f290d</a></td><td><code>trac #26369: use struct for the linked list</code></td></tr></table>\n",
    "created_at": "2018-10-02T16:18:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409256",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606">16f290d</a></td><td><code>trac #26369: use struct for the linked list</code></td></tr></table>




---

archive/issue_comments_409257.json:
```json
{
    "body": "<a id='comment:17'></a>\nI changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable.",
    "created_at": "2018-10-02T16:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409257",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:17'></a>
I changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable.



---

archive/issue_comments_409258.json:
```json
{
    "body": "<a id='comment:18'></a>\nTo answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.\n\nI'm curious of the new running time of your favorite example.",
    "created_at": "2018-10-02T16:41:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409258",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:18'></a>
To answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.

I'm curious of the new running time of your favorite example.



---

archive/issue_comments_409259.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@dcoudert](#comment%3A17):\n> I changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable. \n\nI agree, but I feel like this is something we should care a little less about code reability than speed. In fact, this cut the time by another half:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 1.2 s, sys: 36 ms, total: 1.23 s\nWall time: 1.2 s\n```\nUnfortunately Cython does not yet support C++ classes, which would have made the code more readable IMO. Although it just means we had to write more pure C-like code. The 2x speedup though makes it worth it.",
    "created_at": "2018-10-02T22:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409259",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>
Replying to [@dcoudert](#comment%3A17):
> I changed `_LinkedListNode` and `_LinkedList` to struct, and changed the list/dict storing these objects to arrays. This gives additional speedup, but some parts of the code are less readable. 

I agree, but I feel like this is something we should care a little less about code reability than speed. In fact, this cut the time by another half:

```
sage: %time T = G.spqr_tree()
CPU times: user 1.2 s, sys: 36 ms, total: 1.23 s
Wall time: 1.2 s
```
Unfortunately Cython does not yet support C++ classes, which would have made the code more readable IMO. Although it just means we had to write more pure C-like code. The 2x speedup though makes it worth it.



---

archive/issue_events_233358.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-10-02T23:03:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26369#event-233358"
}
```



---

archive/issue_events_233359.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2018-10-02T23:03:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26369#event-233359"
}
```



---

archive/issue_comments_409260.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [@dcoudert](#comment%3A18):\n> To answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.\n\nThe only operation that requires the doubly part is the removal. The rest are constant time (with holding onto the head and tail of every linked list) with a singly-linked list. That is why I asked about holding onto the \"previous\" node of the one being removed if that was easily doable. I don't think so easily, it would probably make the code fairly difficult to read, and probably not gain much speed.\n\nSo I think this will be good for now. At least, I don't see a way to get really any more speed out. Thank you for all your hard work on this!",
    "created_at": "2018-10-02T23:03:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409260",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>
Replying to [@dcoudert](#comment%3A18):
> To answer one of your questions. The doubly linked list is needed as we may replace the data stored in a node, pushed a new node at the beginning of the list, remove any node from a list, and merge 2 list. Using this data structure, these operations are performed in constant time.

The only operation that requires the doubly part is the removal. The rest are constant time (with holding onto the head and tail of every linked list) with a singly-linked list. That is why I asked about holding onto the "previous" node of the one being removed if that was easily doable. I don't think so easily, it would probably make the code fairly difficult to read, and probably not gain much speed.

So I think this will be good for now. At least, I don't see a way to get really any more speed out. Thank you for all your hard work on this!



---

archive/issue_comments_409261.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2018-10-02T23:03:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409261",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_409262.json:
```json
{
    "body": "<a id='comment:21'></a>\nThank you for your great help.",
    "created_at": "2018-10-03T06:18:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409262",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:21'></a>
Thank you for your great help.



---

archive/issue_events_233360.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-10-04T21:54:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26369#event-233360"
}
```



---

archive/issue_events_233361.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "12a9bfb3d446e4c2e71d28a920238dfa7e007645",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-10-04T21:54:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26369#event-233361"
}
```



---

archive/issue_comments_409263.json:
```json
{
    "body": "**Changing branch** from \"[public/26369_cythonize_triconnectivity](https://github.com/sagemath/sagetrac-mirror/tree/public/26369_cythonize_triconnectivity)\" to \"[16f290dc72a5950966a535f9ddfd8d0f5083b606](https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606)\".",
    "created_at": "2018-10-04T21:54:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26369",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26369#issuecomment-409263",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/26369_cythonize_triconnectivity](https://github.com/sagemath/sagetrac-mirror/tree/public/26369_cythonize_triconnectivity)" to "[16f290dc72a5950966a535f9ddfd8d0f5083b606](https://github.com/sagemath/sagetrac-mirror/commit/16f290dc72a5950966a535f9ddfd8d0f5083b606)".
