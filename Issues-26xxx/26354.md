# Issue 26354: Pickling morphisms is broken

archive/issues_026117.json:
```json
{
    "body": "Here is an exemple:\n\n```\nsage: R.<x,y> = QQ[]\nsage: theta = R.hom([y,x])\nsage: hash(theta)\n-1982612945128833994\nsage: hash(loads(dumps(theta)))\nTraceback (most recent call last):\n...\nValueError: mutable sequences are unhashable\n```\n\n**Branch/Commit:** [1ea91f7b6254f8791b4f0b488e32c002af7e99a0](https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** David Roe, Xavier Caruso\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26354\n\n",
    "closed_at": "2018-10-03T21:56:39Z",
    "created_at": "2018-09-27T13:25:48Z",
    "labels": [
        "component: pickling",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Pickling morphisms is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26354",
    "user": "https://github.com/xcaruso"
}
```
Here is an exemple:

```
sage: R.<x,y> = QQ[]
sage: theta = R.hom([y,x])
sage: hash(theta)
-1982612945128833994
sage: hash(loads(dumps(theta)))
Traceback (most recent call last):
...
ValueError: mutable sequences are unhashable
```

**Branch/Commit:** [1ea91f7b6254f8791b4f0b488e32c002af7e99a0](https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0)

**Reviewer:** Travis Scrimshaw

**Author:** David Roe, Xavier Caruso

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/26354





---

archive/issue_comments_508411.json:
```json
{
    "body": "**Branch:** [u/roed/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/pickling_morphisms_is_broken)",
    "created_at": "2018-09-27T21:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508411",
    "user": "https://github.com/roed314"
}
```


**Branch:** [u/roed/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/pickling_morphisms_is_broken)



---

archive/issue_comments_508412.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/94f6985f60c352044b4d99bf8fc15818c17c7281\">94f6985</a></td><td><code>Set immutable in unpickling ring morphisms</code></td></tr></table>\n",
    "created_at": "2018-09-27T21:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508412",
    "user": "https://github.com/roed314"
}
```


<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/94f6985f60c352044b4d99bf8fc15818c17c7281">94f6985</a></td><td><code>Set immutable in unpickling ring morphisms</code></td></tr></table>




---

archive/issue_comments_508413.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2018-09-27T21:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508413",
    "user": "https://github.com/roed314"
}
```


**Changing status** from new to needs_review.



---

archive/issue_comments_508414.json:
```json
{
    "body": "**Commit:** [94f6985f60c352044b4d99bf8fc15818c17c7281](https://github.com/sagemath/sagetrac-mirror/commit/94f6985f60c352044b4d99bf8fc15818c17c7281)",
    "created_at": "2018-09-27T21:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508414",
    "user": "https://github.com/roed314"
}
```


**Commit:** [94f6985f60c352044b4d99bf8fc15818c17c7281](https://github.com/sagemath/sagetrac-mirror/commit/94f6985f60c352044b4d99bf8fc15818c17c7281)



---

archive/issue_comments_508415.json:
```json
{
    "body": "**Author:** David Roe",
    "created_at": "2018-09-27T21:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508415",
    "user": "https://github.com/roed314"
}
```


**Author:** David Roe



---

archive/issue_comments_508416.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis is definitely a fix, but is it the correct fix? The `PolynomialSequence` does not seem to pickle immutability like I think it should:\n\n```\nsage: theta.__reduce__()[1][3]['__im_gens']\n[y, x]\nsage: S = theta.__reduce__()[1][3]['__im_gens']\nsage: type(S)\n<class 'sage.rings.polynomial.multi_polynomial_sequence.PolynomialSequence_generic'>\nsage: S.is_immutable()\nTrue\nsage: loads(dumps(S)).is_immutable()\nFalse\n```\nContrast:\n\n```\nsage: S.__reduce__()\n(<function PolynomialSequence at 0x7f62c7ef2c80>,\n (Multivariate Polynomial Ring in x, y over Rational Field, ((y, x),)))\nsage: Sequence([1,2,3,4]).__reduce__()\n(<function _reconstructor at 0x7f64198a5aa0>,\n (<class 'sage.structure.sequence.Sequence_generic'>,\n  <type 'sage.structure.sage_object.SageObject'>,\n  <sage.structure.sage_object.SageObject object at 0x7f62b02dc0b0>),\n {'_Sequence_generic__cr': False,\n  '_Sequence_generic__cr_str': False,\n  '_Sequence_generic__hash': None,\n  '_Sequence_generic__universe': Integer Ring,\n  '_is_immutable': False})\n```\nWhat are your thoughts about instead adjusting the pickling of `PolynomialSequence`?",
    "created_at": "2018-09-27T21:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508416",
    "user": "https://github.com/tscrim"
}
```


<a id='comment:3'></a>
This is definitely a fix, but is it the correct fix? The `PolynomialSequence` does not seem to pickle immutability like I think it should:

```
sage: theta.__reduce__()[1][3]['__im_gens']
[y, x]
sage: S = theta.__reduce__()[1][3]['__im_gens']
sage: type(S)
<class 'sage.rings.polynomial.multi_polynomial_sequence.PolynomialSequence_generic'>
sage: S.is_immutable()
True
sage: loads(dumps(S)).is_immutable()
False
```
Contrast:

```
sage: S.__reduce__()
(<function PolynomialSequence at 0x7f62c7ef2c80>,
 (Multivariate Polynomial Ring in x, y over Rational Field, ((y, x),)))
sage: Sequence([1,2,3,4]).__reduce__()
(<function _reconstructor at 0x7f64198a5aa0>,
 (<class 'sage.structure.sequence.Sequence_generic'>,
  <type 'sage.structure.sage_object.SageObject'>,
  <sage.structure.sage_object.SageObject object at 0x7f62b02dc0b0>),
 {'_Sequence_generic__cr': False,
  '_Sequence_generic__cr_str': False,
  '_Sequence_generic__hash': None,
  '_Sequence_generic__universe': Integer Ring,
  '_is_immutable': False})
```
What are your thoughts about instead adjusting the pickling of `PolynomialSequence`?



---

archive/issue_comments_508417.json:
```json
{
    "body": "**Changing branch** from \"[u/roed/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/pickling_morphisms_is_broken)\" to \"[u/caruso/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/pickling_morphisms_is_broken)\".",
    "created_at": "2018-10-01T08:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508417",
    "user": "https://github.com/xcaruso"
}
```


**Changing branch** from "[u/roed/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/roed/pickling_morphisms_is_broken)" to "[u/caruso/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/pickling_morphisms_is_broken)".



---

archive/issue_comments_508418.json:
```json
{
    "body": "<a id='comment:5'></a>\nI agree with you, Travis.\n\nI pushed a fix for the pickling of `PolynomialSequence`. I'm not sure I've done it correctly (in particular, this class redefines `__getattr__`, I don't know why); please review :-)\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dee878eed8fea9505e8c2ecfb907ebf6cbb78fb1\">dee878e</a></td><td><code>Revert \"Set immutable in unpickling ring morphisms\"</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e2931b6b109cd7fb492945c93e90be7cd68a30bc\">e2931b6</a></td><td><code>Fix pickling for PolynomialSequence_generic</code></td></tr></table>\n",
    "created_at": "2018-10-01T08:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508418",
    "user": "https://github.com/xcaruso"
}
```


<a id='comment:5'></a>
I agree with you, Travis.

I pushed a fix for the pickling of `PolynomialSequence`. I'm not sure I've done it correctly (in particular, this class redefines `__getattr__`, I don't know why); please review :-)

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dee878eed8fea9505e8c2ecfb907ebf6cbb78fb1">dee878e</a></td><td><code>Revert "Set immutable in unpickling ring morphisms"</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e2931b6b109cd7fb492945c93e90be7cd68a30bc">e2931b6</a></td><td><code>Fix pickling for PolynomialSequence_generic</code></td></tr></table>




---

archive/issue_comments_508419.json:
```json
{
    "body": "**Changing commit** from \"[94f6985f60c352044b4d99bf8fc15818c17c7281](https://github.com/sagemath/sagetrac-mirror/commit/94f6985f60c352044b4d99bf8fc15818c17c7281)\" to \"[e2931b6b109cd7fb492945c93e90be7cd68a30bc](https://github.com/sagemath/sagetrac-mirror/commit/e2931b6b109cd7fb492945c93e90be7cd68a30bc)\".",
    "created_at": "2018-10-01T08:39:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508419",
    "user": "https://github.com/xcaruso"
}
```


**Changing commit** from "[94f6985f60c352044b4d99bf8fc15818c17c7281](https://github.com/sagemath/sagetrac-mirror/commit/94f6985f60c352044b4d99bf8fc15818c17c7281)" to "[e2931b6b109cd7fb492945c93e90be7cd68a30bc](https://github.com/sagemath/sagetrac-mirror/commit/e2931b6b109cd7fb492945c93e90be7cd68a30bc)".



---

archive/issue_comments_508420.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0\">1ea91f7</a></td><td><code>Add a doctest</code></td></tr></table>\n",
    "created_at": "2018-10-01T08:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508420",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0">1ea91f7</a></td><td><code>Add a doctest</code></td></tr></table>




---

archive/issue_comments_508421.json:
```json
{
    "body": "**Changing commit** from \"[e2931b6b109cd7fb492945c93e90be7cd68a30bc](https://github.com/sagemath/sagetrac-mirror/commit/e2931b6b109cd7fb492945c93e90be7cd68a30bc)\" to \"[1ea91f7b6254f8791b4f0b488e32c002af7e99a0](https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0)\".",
    "created_at": "2018-10-01T08:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508421",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```


**Changing commit** from "[e2931b6b109cd7fb492945c93e90be7cd68a30bc](https://github.com/sagemath/sagetrac-mirror/commit/e2931b6b109cd7fb492945c93e90be7cd68a30bc)" to "[1ea91f7b6254f8791b4f0b488e32c002af7e99a0](https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0)".



---

archive/issue_comments_508422.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2018-10-01T10:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508422",
    "user": "https://github.com/tscrim"
}
```


**Reviewer:** Travis Scrimshaw



---

archive/issue_comments_508423.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2018-10-01T10:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508423",
    "user": "https://github.com/tscrim"
}
```


**Changing status** from needs_review to positive_review.



---

archive/issue_comments_508424.json:
```json
{
    "body": "<a id='comment:7'></a>\nYep, LGTM. Thanks.",
    "created_at": "2018-10-01T10:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508424",
    "user": "https://github.com/tscrim"
}
```


<a id='comment:7'></a>
Yep, LGTM. Thanks.



---

archive/issue_comments_508425.json:
```json
{
    "body": "**Changing author** from \"David Roe\" to \"David Roe, Xavier Caruso\".",
    "created_at": "2018-10-01T10:18:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508425",
    "user": "https://github.com/tscrim"
}
```


**Changing author** from "David Roe" to "David Roe, Xavier Caruso".



---

archive/issue_events_074465.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-10-03T21:56:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26354#event-74465"
}
```




---

archive/issue_comments_508426.json:
```json
{
    "body": "**Changing branch** from \"[u/caruso/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/pickling_morphisms_is_broken)\" to \"[1ea91f7b6254f8791b4f0b488e32c002af7e99a0](https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0)\".",
    "created_at": "2018-10-03T21:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508426",
    "user": "https://github.com/vbraun"
}
```


**Changing branch** from "[u/caruso/pickling_morphisms_is_broken](https://github.com/sagemath/sagetrac-mirror/tree/u/caruso/pickling_morphisms_is_broken)" to "[1ea91f7b6254f8791b4f0b488e32c002af7e99a0](https://github.com/sagemath/sagetrac-mirror/commit/1ea91f7b6254f8791b4f0b488e32c002af7e99a0)".



---

archive/issue_comments_508427.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2018-10-03T21:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26354#issuecomment-508427",
    "user": "https://github.com/vbraun"
}
```


**Resolution:** fixed
