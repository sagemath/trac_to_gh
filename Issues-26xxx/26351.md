# Issue 26351: build/pkgs/*/checksums.ini: Add upstream_url field

archive/issues_026114.json:
```json
{
    "body": "CC:  @embray @dimpase @vbraun @jhpalmieri @tscrim\n\nThis is to make testing tickets that include SPKG upgrades easier for developers and patchbots.\n\nTo add the `upstream_url` field, just edit `checksums.ini` or use the new option `--url` of `sage -package create`:\n\n```\n$ ./sage -package create --help\nusage: sage --package create [-h] [--version VERSION] [--tarball TARBALL]\n                             [--type TYPE] [--url URL]\n                             [package_name]\n\n[...]\n  --tarball TARBALL  Tarball filename pattern, e.g. Foo-VERSION.tar.bz2\n  --type TYPE        Package type\n  --url URL          Download URL pattern, e.g. http://example.org/Foo-\n                     VERSION.tar.bz2\n```\n\nThe default behavior of `sage -i` is not changed: Packages are only downloaded from the Sage mirrors.\n\nTo allow downloading from the upstream URL, use `sage -i --allow-upstream SPKG`.\n\nExample (for qepcad) at #28388.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26351\n\n",
    "closed_at": "2020-03-10T23:27:48Z",
    "created_at": "2018-09-26T23:54:02Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "build/pkgs/*/checksums.ini: Add upstream_url field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26351",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @embray @dimpase @vbraun @jhpalmieri @tscrim

This is to make testing tickets that include SPKG upgrades easier for developers and patchbots.

To add the `upstream_url` field, just edit `checksums.ini` or use the new option `--url` of `sage -package create`:

```
$ ./sage -package create --help
usage: sage --package create [-h] [--version VERSION] [--tarball TARBALL]
                             [--type TYPE] [--url URL]
                             [package_name]

[...]
  --tarball TARBALL  Tarball filename pattern, e.g. Foo-VERSION.tar.bz2
  --type TYPE        Package type
  --url URL          Download URL pattern, e.g. http://example.org/Foo-
                     VERSION.tar.bz2
```

The default behavior of `sage -i` is not changed: Packages are only downloaded from the Sage mirrors.

To allow downloading from the upstream URL, use `sage -i --allow-upstream SPKG`.

Example (for qepcad) at #28388.


Issue created by migration from https://trac.sagemath.org/ticket/26351





---

archive/issue_comments_367721.json:
```json
{
    "body": "That's a good idea.  It should still be synced to our mirrors primarily, but having a canonical \"original\" URL (even if it's just an attachment to a trac ticket) would provide the primary source for a tarball independent of the mirrors.",
    "created_at": "2018-09-27T08:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367721",
    "user": "https://github.com/embray"
}
```

That's a good idea.  It should still be synced to our mirrors primarily, but having a canonical "original" URL (even if it's just an attachment to a trac ticket) would provide the primary source for a tarball independent of the mirrors.



---

archive/issue_comments_367722.json:
```json
{
    "body": "I'll take a stab at this.  What I'm thinking is `sage-download-file` could try all mirrors first, but failing that try the `upstream-tarball-url` as a last resort.  This way, if that field is filled in, the download should still work even if the tarball is not on the mirrors yet (this will be great for people manually testing new SPKGs too, since it means they won't have to manually download the tarball into `upstream/`).\n\nThe `upstream-tarball-url` should also be optional, so that we don't have to go adding it for every package.  But it should be encouraged to add it when adding new SPGKs or updating existing ones.  Additionally, `sage --package fix-checksum` could test the URL to make sure it's still valid, and `sage-download-file` could grow a `--no-mirrors` option to skip the mirrors entirely if there is an `upstream-tarball-url` (useful if nothing else for testing).",
    "created_at": "2018-09-27T11:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367722",
    "user": "https://github.com/embray"
}
```

I'll take a stab at this.  What I'm thinking is `sage-download-file` could try all mirrors first, but failing that try the `upstream-tarball-url` as a last resort.  This way, if that field is filled in, the download should still work even if the tarball is not on the mirrors yet (this will be great for people manually testing new SPKGs too, since it means they won't have to manually download the tarball into `upstream/`).

The `upstream-tarball-url` should also be optional, so that we don't have to go adding it for every package.  But it should be encouraged to add it when adding new SPGKs or updating existing ones.  Additionally, `sage --package fix-checksum` could test the URL to make sure it's still valid, and `sage-download-file` could grow a `--no-mirrors` option to skip the mirrors entirely if there is an `upstream-tarball-url` (useful if nothing else for testing).



---

archive/issue_comments_367723.json:
```json
{
    "body": "Sounds good, thank you!",
    "created_at": "2018-09-27T17:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367723",
    "user": "https://github.com/mkoeppe"
}
```

Sounds good, thank you!



---

archive/issue_comments_367724.json:
```json
{
    "body": "Any news on this?",
    "created_at": "2019-04-29T21:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367724",
    "user": "https://github.com/mkoeppe"
}
```

Any news on this?



---

archive/issue_events_065548.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-02-09T16:08:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26351#event-65548"
}
```



---

archive/issue_comments_367725.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-11T02:59:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367725",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367726.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-02-11T02:59:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367726",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_367727.json:
```json
{
    "body": "Anyone interested in this ticket?",
    "created_at": "2020-03-03T02:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367727",
    "user": "https://github.com/mkoeppe"
}
```

Anyone interested in this ticket?



---

archive/issue_comments_367728.json:
```json
{
    "body": "Everything looks fine to me from what I understand, but I don't feel qualified enough to set this to a positive review.",
    "created_at": "2020-03-03T04:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367728",
    "user": "https://github.com/tscrim"
}
```

Everything looks fine to me from what I understand, but I don't feel qualified enough to set this to a positive review.



---

archive/issue_comments_367729.json:
```json
{
    "body": "What are the lines `maxDiff = None` for? And how are we supposed to test that this works?\n\nEdit: I mean, I see the commit message \"build/test: Set maxDiff=None to improve debugging of sage_bootstrap\", but can you expand on this?",
    "created_at": "2020-03-03T05:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367729",
    "user": "https://github.com/jhpalmieri"
}
```

What are the lines `maxDiff = None` for? And how are we supposed to test that this works?

Edit: I mean, I see the commit message "build/test: Set maxDiff=None to improve debugging of sage_bootstrap", but can you expand on this?



---

archive/issue_comments_367730.json:
```json
{
    "body": "Replying to [comment:13 jhpalmieri]:\n> What are the lines `maxDiff = None` for?\n\n\nhttps://docs.python.org/3/library/unittest.html#unittest.TestCase.maxDiff",
    "created_at": "2020-03-03T11:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367730",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:13 jhpalmieri]:
> What are the lines `maxDiff = None` for?


https://docs.python.org/3/library/unittest.html#unittest.TestCase.maxDiff



---

archive/issue_comments_367731.json:
```json
{
    "body": "Replying to [comment:13 jhpalmieri]:\n> What are the lines `maxDiff = None` for? And how are we supposed to test that this works?\n> \n> Edit: I mean, I see the commit message \"build/test: Set maxDiff=None to improve debugging of sage_bootstrap\", but can you expand on this?\n\n\nWithout this change, failed test assertions did not show enough useful information.\nNow, of course, nothing fails, so these lines have no effect on the operation of sage_bootstrap.\n\nIf you want to test that this ticket works, may I suggest picking a package that needs upgrading anyway, and use the new upstream_url mechanism to do the upgrade.",
    "created_at": "2020-03-06T02:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367731",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:13 jhpalmieri]:
> What are the lines `maxDiff = None` for? And how are we supposed to test that this works?
> 
> Edit: I mean, I see the commit message "build/test: Set maxDiff=None to improve debugging of sage_bootstrap", but can you expand on this?


Without this change, failed test assertions did not show enough useful information.
Now, of course, nothing fails, so these lines have no effect on the operation of sage_bootstrap.

If you want to test that this ticket works, may I suggest picking a package that needs upgrading anyway, and use the new upstream_url mechanism to do the upgrade.



---

archive/issue_comments_367732.json:
```json
{
    "body": "I have a package to upgrade, so I'll try doing it with this feature.",
    "created_at": "2020-03-06T12:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367732",
    "user": "https://github.com/embray"
}
```

I have a package to upgrade, so I'll try doing it with this feature.



---

archive/issue_comments_367733.json:
```json
{
    "body": "Sort of unrelated, but why does `tox.ini` have so many old Python 3.x versions?  The minimal version I've been able to get Sage working on is 3.6.",
    "created_at": "2020-03-06T12:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367733",
    "user": "https://github.com/embray"
}
```

Sort of unrelated, but why does `tox.ini` have so many old Python 3.x versions?  The minimal version I've been able to get Sage working on is 3.6.



---

archive/issue_comments_367734.json:
```json
{
    "body": "Can you please also apply the following patch:\n\n```\ndiff --git a/build/sage_bootstrap/cmdline.py b/build/sage_bootstrap/cmdline.py\nindex abb617dd65..3fa9de4104 100644\n--- a/build/sage_bootstrap/cmdline.py\n+++ b/build/sage_bootstrap/cmdline.py\n@@ -219,14 +219,14 @@ def make_parser():\n     parser_fix_checksum.add_argument(\n         'package_name', nargs='?', default=None, type=str,\n         help='Package name. Default: fix all packages.')\n-    \n+\n     parser_create = subparsers.add_parser(\n         'create', epilog=epilog_create,\n         formatter_class=argparse.RawDescriptionHelpFormatter,\n         help='Create or overwrite package.')\n     parser_create.add_argument(\n-        'package_name', nargs='?', default=None, type=str,\n-        help='Package name. Default: fix all packages.')\n+        'package_name', default=None, type=str,\n+        help='Package name.')\n     parser_create.add_argument(\n         '--version', type=str, default=None, help='Package version')\n     parser_create.add_argument(\n```\n\nrunning `sage -package create` doesn't work without a package name argument, so it shouldn't be optional (it looks like it was just incorrectly copied from the fix-checksum command).",
    "created_at": "2020-03-06T13:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367734",
    "user": "https://github.com/embray"
}
```

Can you please also apply the following patch:

```
diff --git a/build/sage_bootstrap/cmdline.py b/build/sage_bootstrap/cmdline.py
index abb617dd65..3fa9de4104 100644
--- a/build/sage_bootstrap/cmdline.py
+++ b/build/sage_bootstrap/cmdline.py
@@ -219,14 +219,14 @@ def make_parser():
     parser_fix_checksum.add_argument(
         'package_name', nargs='?', default=None, type=str,
         help='Package name. Default: fix all packages.')
-    
+
     parser_create = subparsers.add_parser(
         'create', epilog=epilog_create,
         formatter_class=argparse.RawDescriptionHelpFormatter,
         help='Create or overwrite package.')
     parser_create.add_argument(
-        'package_name', nargs='?', default=None, type=str,
-        help='Package name. Default: fix all packages.')
+        'package_name', default=None, type=str,
+        help='Package name.')
     parser_create.add_argument(
         '--version', type=str, default=None, help='Package version')
     parser_create.add_argument(
```

running `sage -package create` doesn't work without a package name argument, so it shouldn't be optional (it looks like it was just incorrectly copied from the fix-checksum command).



---

archive/issue_comments_367735.json:
```json
{
    "body": "Replying to [comment:17 embray]:\n> Sort of unrelated, but why does `tox.ini` have so many old Python 3.x versions?  The minimal version I've been able to get Sage working on is 3.6.\n\n\nNevermind, I misunderstood that these are the tests for the bootstrap scripts.",
    "created_at": "2020-03-06T13:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367735",
    "user": "https://github.com/embray"
}
```

Replying to [comment:17 embray]:
> Sort of unrelated, but why does `tox.ini` have so many old Python 3.x versions?  The minimal version I've been able to get Sage working on is 3.6.


Nevermind, I misunderstood that these are the tests for the bootstrap scripts.



---

archive/issue_comments_367736.json:
```json
{
    "body": "If you want to fix the issue above as part of this ticket please do; it wasn't clear to me whether or not this bug predates this ticket (it probably does).  Whether you decide to or not you can set this to positive_review afterwards.",
    "created_at": "2020-03-06T14:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367736",
    "user": "https://github.com/embray"
}
```

If you want to fix the issue above as part of this ticket please do; it wasn't clear to me whether or not this bug predates this ticket (it probably does).  Whether you decide to or not you can set this to positive_review afterwards.



---

archive/issue_comments_367737.json:
```json
{
    "body": "Thanks for reviewing.\nSeparate ticket please for the patch.",
    "created_at": "2020-03-06T15:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367737",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for reviewing.
Separate ticket please for the patch.



---

archive/issue_comments_367738.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-06T15:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367738",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367739.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> Separate ticket please for the patch.\n\nThat's #29286",
    "created_at": "2020-03-06T16:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367739",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:21 mkoeppe]:
> Separate ticket please for the patch.

That's #29286



---

archive/issue_comments_367740.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-03-08T22:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367740",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_367741.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2020-03-08T22:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367741",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_367742.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2020-03-08T22:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367742",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_367743.json:
```json
{
    "body": "Actually: `There is no merge to abort (MERGE_HEAD missing).`",
    "created_at": "2020-03-08T22:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367743",
    "user": "https://github.com/vbraun"
}
```

Actually: `There is no merge to abort (MERGE_HEAD missing).`



---

archive/issue_comments_367744.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2020-03-08T22:26:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367744",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_events_065549.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-03-10T23:27:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26351#event-65549"
}
```



---

archive/issue_comments_367745.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-03-10T23:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367745",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_367746.json:
```json
{
    "body": "I am trying to test #29444, and upstream_url does not seem to work\n(either by running make, or with ./sage -i)\nWhat am I doing wrong?",
    "created_at": "2020-04-03T00:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367746",
    "user": "https://github.com/dimpase"
}
```

I am trying to test #29444, and upstream_url does not seem to work
(either by running make, or with ./sage -i)
What am I doing wrong?



---

archive/issue_comments_367747.json:
```json
{
    "body": "I think you're supposed to do `make SAGE_SPKG=\"sage-spkg -o\" ...`",
    "created_at": "2020-04-03T01:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367747",
    "user": "https://github.com/jhpalmieri"
}
```

I think you're supposed to do `make SAGE_SPKG="sage-spkg -o" ...`



---

archive/issue_comments_367748.json:
```json
{
    "body": "Thanks. Is there any reason for this extra verbosity? After all, the checksums are supposed to identify the tarball well enough, so as long as they are not tampered with, downloading from `upstream_url` is safe.",
    "created_at": "2020-04-03T02:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367748",
    "user": "https://github.com/dimpase"
}
```

Thanks. Is there any reason for this extra verbosity? After all, the checksums are supposed to identify the tarball well enough, so as long as they are not tampered with, downloading from `upstream_url` is safe.



---

archive/issue_comments_367749.json:
```json
{
    "body": "#29392 proposes a nicer user interface to this feature. \nI didn't make it the default because it's a potentially controversial feature.",
    "created_at": "2020-04-03T10:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26351#issuecomment-367749",
    "user": "https://github.com/mkoeppe"
}
```

#29392 proposes a nicer user interface to this feature. 
I didn't make it the default because it's a potentially controversial feature.
