# Issue 26898: Hashes of some Algebraic Field elements hang indefinitely

archive/issues_026661.json:
```json
{
    "body": "The following code hangs on both Sage 7.5.1 and Sage 8.4:\n\n```\nR.<a> = QQ[]\nNF.<b> = NumberField(4*a^7 + 27)\nfor hom in NF.embeddings(QQbar):\n   print hash(hom(b))\n```\n\n\n\nKeywords: hash, algebraic field\n\nBranch/Commit: fc0e2e32fa6ac144a15e3673f6659bd686a023d8\n\nReviewer: Marc Mezzarobba\n\nAuthor: Brent Baccala\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26898\n\n",
    "closed_at": "2018-12-23T23:39:44Z",
    "created_at": "2018-12-14T21:45:47Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "Hashes of some Algebraic Field elements hang indefinitely",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26898",
    "user": "https://github.com/BrentBaccala"
}
```
The following code hangs on both Sage 7.5.1 and Sage 8.4:

```
R.<a> = QQ[]
NF.<b> = NumberField(4*a^7 + 27)
for hom in NF.embeddings(QQbar):
   print hash(hom(b))
```



Keywords: hash, algebraic field

Branch/Commit: fc0e2e32fa6ac144a15e3673f6659bd686a023d8

Reviewer: Marc Mezzarobba

Author: Brent Baccala

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26898





---

archive/issue_comments_516699.json:
```json
{
    "body": "<a id='comment:1'></a>\nHere's another test case that I constructed after drilling down through the code:\n\n```\nfrom sage.rings.qqbar import AlgebraicGenerator, ANRoot\n\nR.<y> = QQ[]\ngen = y^14 - 6*y^7 + 18\nNF.<a> = NumberField(gen)\n\nroot1 = ANRoot(gen, CIF(NF.embeddings(QQbar)[0](a)))\nroot2 = ANRoot(gen, CIF(NF.embeddings(QQbar)[1](a)))\n\nag1 = AlgebraicGenerator(NF, root1)\nag2 = AlgebraicGenerator(NF, root2)\n\nag1.union(ag2)\n\n```\n\nChanging `gen` around produces different answers.  `gen = y^2+18` produces the answer I'd expect from `union`: a number field defined by y<sup>2</sup> + 18.  `gen = y^3+18` produces a number field defined by a sixth degree polynomial; `gen = y^7 + 18` produces a number field defined by a 42<sup>nd</sup> degree polynomial.\n\nI guess the 14<sup>th</sup> degree polynomial leads to a calculation that takes excessively long, but I think it should be a very simple calculation if the two `AlgebraicGenerator`'s are from the same number field - it should just return that field, right?",
    "created_at": "2018-12-17T21:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516699",
    "user": "https://github.com/BrentBaccala"
}
```

<a id='comment:1'></a>
Here's another test case that I constructed after drilling down through the code:

```
from sage.rings.qqbar import AlgebraicGenerator, ANRoot

R.<y> = QQ[]
gen = y^14 - 6*y^7 + 18
NF.<a> = NumberField(gen)

root1 = ANRoot(gen, CIF(NF.embeddings(QQbar)[0](a)))
root2 = ANRoot(gen, CIF(NF.embeddings(QQbar)[1](a)))

ag1 = AlgebraicGenerator(NF, root1)
ag2 = AlgebraicGenerator(NF, root2)

ag1.union(ag2)

```

Changing `gen` around produces different answers.  `gen = y^2+18` produces the answer I'd expect from `union`: a number field defined by y<sup>2</sup> + 18.  `gen = y^3+18` produces a number field defined by a sixth degree polynomial; `gen = y^7 + 18` produces a number field defined by a 42<sup>nd</sup> degree polynomial.

I guess the 14<sup>th</sup> degree polynomial leads to a calculation that takes excessively long, but I think it should be a very simple calculation if the two `AlgebraicGenerator`'s are from the same number field - it should just return that field, right?



---

archive/issue_comments_516700.json:
```json
{
    "body": "<a id='comment:2'></a>\nNow that I've thought about it more, the number field might not be a splitting field, so it's more complicated than returning the same field.",
    "created_at": "2018-12-18T00:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516700",
    "user": "https://github.com/BrentBaccala"
}
```

<a id='comment:2'></a>
Now that I've thought about it more, the number field might not be a splitting field, so it's more complicated than returning the same field.



---

archive/issue_comments_516701.json:
```json
{
    "body": "Changing commit from \"\" to \"fc0e2e32fa6ac144a15e3673f6659bd686a023d8\"",
    "created_at": "2018-12-18T22:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516701",
    "user": "https://github.com/BrentBaccala"
}
```

Changing commit from "" to "fc0e2e32fa6ac144a15e3673f6659bd686a023d8"



---

archive/issue_comments_516702.json:
```json
{
    "body": "<a id='comment:3'></a>\nI found some comments in the code suggesting that when approximations to algebraic numbers are computed, an attempt is made to use 40 extra bits of precision, but it doesn't seem like that every actually got done.\n\nI made the obvious change to actually compute 40 extra bits, and it seems to have solved my problem.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|\n|[fc0e2e3](https://git.sagemath.org/sage.git/commit?id=fc0e2e32fa6ac144a15e3673f6659bd686a023d8)|`Trac #26898: actually use 40 bits of extra precision (like the comments say)`|",
    "created_at": "2018-12-18T22:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516702",
    "user": "https://github.com/BrentBaccala"
}
```

<a id='comment:3'></a>
I found some comments in the code suggesting that when approximations to algebraic numbers are computed, an attempt is made to use 40 extra bits of precision, but it doesn't seem like that every actually got done.

I made the obvious change to actually compute 40 extra bits, and it seems to have solved my problem.

---
New commits:
|                                                                                                                                          |                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
|[fc0e2e3](https://git.sagemath.org/sage.git/commit?id=fc0e2e32fa6ac144a15e3673f6659bd686a023d8)|`Trac #26898: actually use 40 bits of extra precision (like the comments say)`|



---

archive/issue_comments_516703.json:
```json
{
    "body": "Changing author from \"\" to \"Brent Baccala\"",
    "created_at": "2018-12-18T22:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516703",
    "user": "https://github.com/BrentBaccala"
}
```

Changing author from "" to "Brent Baccala"



---

archive/issue_comments_516704.json:
```json
{
    "body": "Changing branch from \"\" to \"public/26898\"",
    "created_at": "2018-12-18T22:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516704",
    "user": "https://github.com/BrentBaccala"
}
```

Changing branch from "" to "public/26898"



---

archive/issue_comments_516705.json:
```json
{
    "body": "<a id='comment:4'></a>\nShould the ticket be set to needs_review?",
    "created_at": "2018-12-19T08:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516705",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:4'></a>
Should the ticket be set to needs_review?



---

archive/issue_comments_516706.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [mmezzarobba](#comment%3A4):\n> Should the ticket be set to needs_review?\n\n\nYes, but I'm waiting for it to clear patchbot.",
    "created_at": "2018-12-19T18:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516706",
    "user": "https://github.com/BrentBaccala"
}
```

<a id='comment:5'></a>
Replying to [mmezzarobba](#comment%3A4):
> Should the ticket be set to needs_review?


Yes, but I'm waiting for it to clear patchbot.



---

archive/issue_comments_516707.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-19T19:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516707",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_516708.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [gh-BrentBaccala](#comment%3A5):\n> Replying to [mmezzarobba](#comment%3A4):\n> > Should the ticket be set to needs_review?\n\n> \n> Yes, but I'm waiting for it to clear patchbot.\n\n\nUnless you have your own patchbot with a special configuration, it (probably) won't even run the tests until the ticket needs_review.\n\nBut I've done it locally and all is well.",
    "created_at": "2018-12-19T19:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516708",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:6'></a>
Replying to [gh-BrentBaccala](#comment%3A5):
> Replying to [mmezzarobba](#comment%3A4):
> > Should the ticket be set to needs_review?

> 
> Yes, but I'm waiting for it to clear patchbot.


Unless you have your own patchbot with a special configuration, it (probably) won't even run the tests until the ticket needs_review.

But I've done it locally and all is well.



---

archive/issue_comments_516709.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Marc Mezzarobba\"",
    "created_at": "2018-12-19T19:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516709",
    "user": "https://github.com/mezzarobba"
}
```

Changing reviewer from "" to "Marc Mezzarobba"



---

archive/issue_comments_516710.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-19T19:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516710",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_066573.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:39:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26898#event-66573"
}
```



---

archive/issue_comments_516711.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-23T23:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516711",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_516712.json:
```json
{
    "body": "Changing branch from \"public/26898\" to \"fc0e2e32fa6ac144a15e3673f6659bd686a023d8\"",
    "created_at": "2018-12-23T23:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516712",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/26898" to "fc0e2e32fa6ac144a15e3673f6659bd686a023d8"



---

archive/issue_comments_516713.json:
```json
{
    "body": "<a id='comment:9'></a>\nThis tickets were closed as fixed after the Sage 8.5 release.",
    "created_at": "2018-12-28T14:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26898#issuecomment-516713",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
This tickets were closed as fixed after the Sage 8.5 release.



---

archive/issue_events_066574.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:06:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26898",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26898#event-66574"
}
```
