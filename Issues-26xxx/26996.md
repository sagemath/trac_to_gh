# Issue 26996: Copying package files: cannot overwrite non-directory

archive/issues_026759.json:
```json
{
    "body": "As reported at https://groups.google.com/d/msg/sage-devel/HHC-CmQ6X60/KCLUP0_aDQAJ\n\n```\n66509-real      31m50.729s \n66510-user      28m47.266s\n66511-sys       2m43.839s\n66512-Copying package files from temporary location /home/sverre/sage/local/var/tmp/sage/build/gfortran-7.2.0/inst to /home/sverre/sage/local\n66513-cp: cannot overwrite non-directory '/home/sverre/sage/local/./lib64' with directory '/home/sverre/sage/local/var/tmp/sage/build/gfortran-7.2.0/inst/home/sverre/sage/local/./lib64'\n66514-************************************************************************\n66515:Error copying files for gfortran-7.2.0.\n66516-************************************************************************\n66517-Please email sage-devel (http://groups.google.com/group/sage-devel)\n66518-explaining the problem and including the log file\n66519-  /home/sverre/sage/logs/pkgs/gfortran-7.2.0.log\n66520-Describe your computer, operating system, etc.\n66521-************************************************************************\n```\nPresumably `/home/sverre/sage/local/lib64` is a symlink, and overwriting it with an actual directory fails.\n\nSome informative background for anyone else wanting to report issues with copying over `lib64`:\n\nWhen installing Sage SPKGs all library files (at least on Linux, BSD, and OSX) should go under `$SAGE_LOCAL/lib`.  This is because, in order for executables and other libraries to be able to find them, we typically link with an RPATH set to `$SAGE_LOCAL/lib`.  Libraries installed in `$SAGE_LOCAL/lib64` thus won't be found.  This was worked around in the past by installing `lib64` is a symlink to `lib`.  This generally works but can be a bit misleading; it's better if SPKGs are properly configured to not install files into lib64 iin the first place.\n\nAn unintended consequence of #22509, where packages are first installed to a temporary location, and then copied from there into the `$SAGE_LOCAL` prefix, is that trying to overwrite a non-directory (i.e. the `lib64` symlink) with a real directory (a \"lib64\" that gets created in the temporary install location) will fail.  In general this is behavior we want to *keep*, because part of the point of the new install system from #22509 is that different SPKGs should not be overwriting things like in an unintended manner.  In this case it actively exposes cases where some packages are still trying to install files into lib64/, which are better to fix directly\n\n**Note: For the case of gfortran this is fixed by #27016.**\n\nCC:  @embray mafra @videlec @dimpase\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nBranch: e83e8317eba8a54a2c8e1676c2be8c8bd2ef2ef3\n\nCommit: e83e8317eba8a54a2c8e1676c2be8c8bd2ef2ef3\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26996\n\n",
    "closed_at": "2020-04-09T22:45:14Z",
    "created_at": "2019-01-02T11:18:28Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Copying package files: cannot overwrite non-directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26996",
    "user": "https://github.com/vbraun"
}
```
As reported at https://groups.google.com/d/msg/sage-devel/HHC-CmQ6X60/KCLUP0_aDQAJ

```
66509-real      31m50.729s 
66510-user      28m47.266s
66511-sys       2m43.839s
66512-Copying package files from temporary location /home/sverre/sage/local/var/tmp/sage/build/gfortran-7.2.0/inst to /home/sverre/sage/local
66513-cp: cannot overwrite non-directory '/home/sverre/sage/local/./lib64' with directory '/home/sverre/sage/local/var/tmp/sage/build/gfortran-7.2.0/inst/home/sverre/sage/local/./lib64'
66514-************************************************************************
66515:Error copying files for gfortran-7.2.0.
66516-************************************************************************
66517-Please email sage-devel (http://groups.google.com/group/sage-devel)
66518-explaining the problem and including the log file
66519-  /home/sverre/sage/logs/pkgs/gfortran-7.2.0.log
66520-Describe your computer, operating system, etc.
66521-************************************************************************
```
Presumably `/home/sverre/sage/local/lib64` is a symlink, and overwriting it with an actual directory fails.

Some informative background for anyone else wanting to report issues with copying over `lib64`:

When installing Sage SPKGs all library files (at least on Linux, BSD, and OSX) should go under `$SAGE_LOCAL/lib`.  This is because, in order for executables and other libraries to be able to find them, we typically link with an RPATH set to `$SAGE_LOCAL/lib`.  Libraries installed in `$SAGE_LOCAL/lib64` thus won't be found.  This was worked around in the past by installing `lib64` is a symlink to `lib`.  This generally works but can be a bit misleading; it's better if SPKGs are properly configured to not install files into lib64 iin the first place.

An unintended consequence of #22509, where packages are first installed to a temporary location, and then copied from there into the `$SAGE_LOCAL` prefix, is that trying to overwrite a non-directory (i.e. the `lib64` symlink) with a real directory (a "lib64" that gets created in the temporary install location) will fail.  In general this is behavior we want to *keep*, because part of the point of the new install system from #22509 is that different SPKGs should not be overwriting things like in an unintended manner.  In this case it actively exposes cases where some packages are still trying to install files into lib64/, which are better to fix directly

**Note: For the case of gfortran this is fixed by #27016.**

CC:  @embray mafra @videlec @dimpase

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Branch: e83e8317eba8a54a2c8e1676c2be8c8bd2ef2ef3

Commit: e83e8317eba8a54a2c8e1676c2be8c8bd2ef2ef3

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26996





---

archive/issue_comments_375918.json:
```json
{
    "body": "<a id='comment:1'></a>So? That's intentional.  Package installations shouldn't overwrite existing non-directories with directories.  There's no reason they should have a symlink named `$SAGE_LOCAL/lib64`.  The real question is why that's there.",
    "created_at": "2019-01-02T11:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375918",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>So? That's intentional.  Package installations shouldn't overwrite existing non-directories with directories.  There's no reason they should have a symlink named `$SAGE_LOCAL/lib64`.  The real question is why that's there.



---

archive/issue_comments_375919.json:
```json
{
    "body": "<a id='comment:2'></a>Afair its there because there is no easy way to convince gcc/gfortran to use /lib instead of /lib64",
    "created_at": "2019-01-02T12:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375919",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>Afair its there because there is no easy way to convince gcc/gfortran to use /lib instead of /lib64



---

archive/issue_comments_375920.json:
```json
{
    "body": "<a id='comment:3'></a>I see.  It seems Debian just patches it.  If we don't want to have a real lib64 we should do the same.",
    "created_at": "2019-01-02T13:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375920",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>I see.  It seems Debian just patches it.  If we don't want to have a real lib64 we should do the same.



---

archive/issue_comments_375921.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 embray]:\n> I see.  It seems Debian just patches it.  If we don't want to have a real lib64 we should do the same.\n\n\nI've spent more time understanding the gcc build system and the \"multilib\" settings, and now I understand Debian's patches better as well, which include patching many of the target config files under `gcc/config` to not use lib64.  I can see this on my own GCC on Debian by running\n\n```\n$ gcc -print-multi-os-directory\n../lib\n```\n\nThis path is appended to `${libdir}/` by the build system to specify the installation path for the target native libraries installed by gcc, so for example libstdc++.so would get installed to `${libdir}/../lib}`, or in other words just `lib/`.\n\nHowever, with the target fragments in the gcc source, the bootstrap gcc that is built during stage 1 one of the build process ends up with `../lib64` for this, and hence builds all its libraries to also go in lib64.\n\nHowever, I think I've figured out a bit of a hack to change the multilib settings without patching, in such a way that should work on any platform we care about.  I'll probably also propose an upstream patch to make this easier, because really it's pretty straightforward and otherwise supported by the build system.  It's just trickier than it should be to get the right flags specified in the right place.",
    "created_at": "2019-01-02T14:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375921",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Replying to [comment:3 embray]:
> I see.  It seems Debian just patches it.  If we don't want to have a real lib64 we should do the same.


I've spent more time understanding the gcc build system and the "multilib" settings, and now I understand Debian's patches better as well, which include patching many of the target config files under `gcc/config` to not use lib64.  I can see this on my own GCC on Debian by running

```
$ gcc -print-multi-os-directory
../lib
```

This path is appended to `${libdir}/` by the build system to specify the installation path for the target native libraries installed by gcc, so for example libstdc++.so would get installed to `${libdir}/../lib}`, or in other words just `lib/`.

However, with the target fragments in the gcc source, the bootstrap gcc that is built during stage 1 one of the build process ends up with `../lib64` for this, and hence builds all its libraries to also go in lib64.

However, I think I've figured out a bit of a hack to change the multilib settings without patching, in such a way that should work on any platform we care about.  I'll probably also propose an upstream patch to make this easier, because really it's pretty straightforward and otherwise supported by the build system.  It's just trickier than it should be to get the right flags specified in the right place.



---

archive/issue_comments_375922.json:
```json
{
    "body": "<a id='comment:5'></a>Since this is only really an issue with installing the gcc and gfortran SPKGs on Linux, the specific case reported in this ticket is fixed by #27016, since those packages will no longer create files in lib64.\n\nI opted for now to keep the symlink to lib64 just in case *something* needs it (though I can't find any specific case), and because having it will alert us in the future to packages trying to install files to lib64.",
    "created_at": "2019-01-04T11:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375922",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>Since this is only really an issue with installing the gcc and gfortran SPKGs on Linux, the specific case reported in this ticket is fixed by #27016, since those packages will no longer create files in lib64.

I opted for now to keep the symlink to lib64 just in case *something* needs it (though I can't find any specific case), and because having it will alert us in the future to packages trying to install files to lib64.



---

archive/issue_events_066985.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:15:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66985"
}
```



---

archive/issue_comments_375923.json:
```json
{
    "body": "<a id='comment:6'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375923",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_375924.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 embray]:\n> Since this is only really an issue with installing the gcc and gfortran SPKGs on Linux\n\n\nOn a different system, I'm also getting\n\n```\nCopying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/inst to /Users/jdemeyer/sage/local\ncp: cannot overwrite directory /Users/jdemeyer/sage/local/./lib/ecl with non-directory /Users/jdemeyer/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/inst/Users/jdemeyer/sage/local/./lib/ecl\n************************************************************************\nError copying files for ecl-16.1.2.p5.\n************************************************************************\n```",
    "created_at": "2019-02-04T11:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375924",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [comment:5 embray]:
> Since this is only really an issue with installing the gcc and gfortran SPKGs on Linux


On a different system, I'm also getting

```
Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/inst to /Users/jdemeyer/sage/local
cp: cannot overwrite directory /Users/jdemeyer/sage/local/./lib/ecl with non-directory /Users/jdemeyer/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/inst/Users/jdemeyer/sage/local/./lib/ecl
************************************************************************
Error copying files for ecl-16.1.2.p5.
************************************************************************
```



---

archive/issue_comments_375925.json:
```json
{
    "body": "<a id='comment:8'></a>It appears `lib/ecl` is a symlink to `lib/ecl-<version>`.  Is it possible the symlink was not removed for some reason?",
    "created_at": "2019-02-04T12:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375925",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>It appears `lib/ecl` is a symlink to `lib/ecl-<version>`.  Is it possible the symlink was not removed for some reason?



---

archive/issue_comments_375926.json:
```json
{
    "body": "<a id='comment:9'></a>In the `spkg-install` for ecl there's a line\n\n```\nrm -rf \"$SAGE_LOCAL/lib/ecl-\"*\n```\n\nbut no\n\n```\nrm -f \"$SAGE_LOCAL/lib/ecl\"\n```\n\nThis should also go in a `spkg-legacy-uninstall` script, but regardless, if you were updating from some older version, and it didn't delete the symlink, you would get this.",
    "created_at": "2019-02-04T12:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375926",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>In the `spkg-install` for ecl there's a line

```
rm -rf "$SAGE_LOCAL/lib/ecl-"*
```

but no

```
rm -f "$SAGE_LOCAL/lib/ecl"
```

This should also go in a `spkg-legacy-uninstall` script, but regardless, if you were updating from some older version, and it didn't delete the symlink, you would get this.



---

archive/issue_comments_375927.json:
```json
{
    "body": "<a id='comment:10'></a>Also with `brial` (when upgrading from an older version of Sage):\n\n```\nCopying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/brial-1.2.4/inst to /Users/jdemeyer/sage/local\ncp: symlink: libbrial_groebner.3.dylib: File exists\ncp: symlink: libbrial.3.dylib: File exists\n************************************************************************\nError copying files for brial-1.2.4.\n************************************************************************\n```",
    "created_at": "2019-02-04T15:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375927",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>Also with `brial` (when upgrading from an older version of Sage):

```
Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/brial-1.2.4/inst to /Users/jdemeyer/sage/local
cp: symlink: libbrial_groebner.3.dylib: File exists
cp: symlink: libbrial.3.dylib: File exists
************************************************************************
Error copying files for brial-1.2.4.
************************************************************************
```



---

archive/issue_comments_375928.json:
```json
{
    "body": "<a id='comment:11'></a>That's a little more strange.  Actually, now that I think about it, I did see some behavior like this a couple weeks ago, and I think I saw some evidence for a bug that could actually cause the `spkg-legacy-uninstall` scripts not to run, which in the case of brial it definitely should have.\n\nLet me confirm that and make a ticket if so...",
    "created_at": "2019-02-04T15:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375928",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>That's a little more strange.  Actually, now that I think about it, I did see some behavior like this a couple weeks ago, and I think I saw some evidence for a bug that could actually cause the `spkg-legacy-uninstall` scripts not to run, which in the case of brial it definitely should have.

Let me confirm that and make a ticket if so...



---

archive/issue_comments_375929.json:
```json
{
    "body": "<a id='comment:12'></a>And also\n\n```\nCopying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/gap-4.10.0/inst to /Users/jdemeyer/sage/local\ncp: cannot overwrite directory /Users/jdemeyer/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jdemeyer/sage/local/var/tmp/sage/build/gap-4.10.0/inst/Users/jdemeyer/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src\ncp: /Users/jdemeyer/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied\n************************************************************************\nError copying files for gap-4.10.0.\n************************************************************************\n```",
    "created_at": "2019-02-04T15:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375929",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>And also

```
Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/gap-4.10.0/inst to /Users/jdemeyer/sage/local
cp: cannot overwrite directory /Users/jdemeyer/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jdemeyer/sage/local/var/tmp/sage/build/gap-4.10.0/inst/Users/jdemeyer/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src
cp: /Users/jdemeyer/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
************************************************************************
Error copying files for gap-4.10.0.
************************************************************************
```



---

archive/issue_comments_375930.json:
```json
{
    "body": "<a id='comment:13'></a>That one is a known issue from #22626 [comment:423](https://trac.sagemath.org/ticket/22626#comment:432).  The upstream tarball actually contains a file that randomly has read-only permissions for no good reason.\n\nIt seems that still has not been fixed.  Not clear what the appropriate solution is.  Just chmod everything to `u+rw` when extracting a tarball?",
    "created_at": "2019-02-04T16:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375930",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>That one is a known issue from #22626 [comment:423](https://trac.sagemath.org/ticket/22626#comment:432).  The upstream tarball actually contains a file that randomly has read-only permissions for no good reason.

It seems that still has not been fixed.  Not clear what the appropriate solution is.  Just chmod everything to `u+rw` when extracting a tarball?



---

archive/issue_comments_375931.json:
```json
{
    "body": "<a id='comment:14'></a>\n```\n[gsl-2.5] Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/gsl-2.5/inst to /Users/jdemeyer/sage/local\n[gsl-2.5] cp: symlink: libgsl.23.dylib: File exists\n```",
    "created_at": "2019-02-04T16:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375931",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
```
[gsl-2.5] Copying package files from temporary location /Users/jdemeyer/sage/local/var/tmp/sage/build/gsl-2.5/inst to /Users/jdemeyer/sage/local
[gsl-2.5] cp: symlink: libgsl.23.dylib: File exists
```



---

archive/issue_comments_375932.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 embray]:\n> Just chmod everything to `u+rw` when extracting a tarball?\n\n\nI thought that we already fixed permissions when extracting?",
    "created_at": "2019-02-04T16:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375932",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Replying to [comment:13 embray]:
> Just chmod everything to `u+rw` when extracting a tarball?


I thought that we already fixed permissions when extracting?



---

archive/issue_comments_375933.json:
```json
{
    "body": "<a id='comment:16'></a>Any way this could be related to #27124?",
    "created_at": "2019-02-04T17:14:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375933",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>Any way this could be related to #27124?



---

archive/issue_comments_375934.json:
```json
{
    "body": "<a id='comment:17'></a>The situation is particularly bad on OS X because `cp` is not willing to overwrite existing symlinks for some reason. So basically any package which includes a library (i.e. many packages) potentially causes this problem.",
    "created_at": "2019-02-05T15:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375934",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>The situation is particularly bad on OS X because `cp` is not willing to overwrite existing symlinks for some reason. So basically any package which includes a library (i.e. many packages) potentially causes this problem.



---

archive/issue_comments_375935.json:
```json
{
    "body": "<a id='comment:18'></a>So I'll give up on writing `spkg-legacy-uninstall` scripts, it's not a scalable solution.",
    "created_at": "2019-02-05T15:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375935",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>So I'll give up on writing `spkg-legacy-uninstall` scripts, it's not a scalable solution.



---

archive/issue_comments_375936.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:15 jdemeyer]:\n> Replying to [comment:13 embray]:\n> > Just chmod everything to `u+rw` when extracting a tarball?\n\n> \n> I thought that we already fixed permissions when extracting?\n\n\nWe apply a umask but that's different.  And I think it has `0` in the user bits, so that means if a file happens to be read-only for some reason that will be preserved.",
    "created_at": "2019-02-05T15:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375936",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Replying to [comment:15 jdemeyer]:
> Replying to [comment:13 embray]:
> > Just chmod everything to `u+rw` when extracting a tarball?

> 
> I thought that we already fixed permissions when extracting?


We apply a umask but that's different.  And I think it has `0` in the user bits, so that means if a file happens to be read-only for some reason that will be preserved.



---

archive/issue_comments_375937.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:17 jdemeyer]:\n> The situation is particularly bad on OS X because `cp` is not willing to overwrite existing symlinks for some reason. So basically any package which includes a library (i.e. many packages) potentially causes this problem.\n\n\nTo be clear: Only if you're trying to upgrade some relatively old build.  It would be nice if this can always work, and I'm not saying this isn't a problem.  But sometimes it's okay to just require a `make distclean`.",
    "created_at": "2019-02-05T15:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375937",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>Replying to [comment:17 jdemeyer]:
> The situation is particularly bad on OS X because `cp` is not willing to overwrite existing symlinks for some reason. So basically any package which includes a library (i.e. many packages) potentially causes this problem.


To be clear: Only if you're trying to upgrade some relatively old build.  It would be nice if this can always work, and I'm not saying this isn't a problem.  But sometimes it's okay to just require a `make distclean`.



---

archive/issue_comments_375938.json:
```json
{
    "body": "<a id='comment:23'></a>I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. \n\ngap:\n\n```\nCopying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local\ncp: cannot overwrite directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src\ncp: /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied\n************************************************************************\nError copying files for gap-4.10.0.p0.\n```\n\necl:\n\n```\nCopying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/ecl-16.1.3.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local\ncp: symlink: ecl-16.1.3: File exists\n************************************************************************\nError copying files for ecl-16.1.3.p0.\n```\n\nI've also seen it with Python 2 and Python 3, with the symlinks in `local/lib/pkgconfig`.",
    "created_at": "2019-02-25T18:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375938",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'></a>I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. 

gap:

```
Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
cp: cannot overwrite directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src
cp: /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
************************************************************************
Error copying files for gap-4.10.0.p0.
```

ecl:

```
Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/ecl-16.1.3.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
cp: symlink: ecl-16.1.3: File exists
************************************************************************
Error copying files for ecl-16.1.3.p0.
```

I've also seen it with Python 2 and Python 3, with the symlinks in `local/lib/pkgconfig`.



---

archive/issue_comments_375939.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 jhpalmieri]:\n> I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. \n\n\nThe former is a problem with the GAP tarball.  I think we should just make a special case fix for that in the GAP spkg for now; see comment:13.\n\nI think the latter might be because of #27124 or possibly #27223.  In other words, it's likely that some previous bug meant the package could not be correctly uninstalled first.",
    "created_at": "2019-02-26T13:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375939",
    "user": "https://github.com/embray"
}
```

<a id='comment:24'></a>Replying to [comment:23 jhpalmieri]:
> I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. 


The former is a problem with the GAP tarball.  I think we should just make a special case fix for that in the GAP spkg for now; see comment:13.

I think the latter might be because of #27124 or possibly #27223.  In other words, it's likely that some previous bug meant the package could not be correctly uninstalled first.



---

archive/issue_comments_375940.json:
```json
{
    "body": "<a id='comment:25'></a>For GAP, and indeed in general, I would be tempted to do this:\n\n```diff\ndiff --git a/build/sage_bootstrap/uncompress/tar_file.py b/build/sage_bootstrap/uncompress/tar_file.py\nindex 57621527ac..cf707e78a3 100644\n--- a/build/sage_bootstrap/uncompress/tar_file.py\n+++ b/build/sage_bootstrap/uncompress/tar_file.py\n@@ -68,6 +68,7 @@ class SageBaseTarFile(tarfile.TarFile):\n         \"\"\"Apply ``self.umask`` instead of the permissions in the TarInfo.\"\"\"\n         tarinfo = copy.copy(tarinfo)\n         tarinfo.mode &= ~self.umask\n+        tarinfo.mode |= stat.S_IWUSR\n         tarinfo.mode &= ~(stat.S_ISUID | stat.S_ISGID)\n         return super(SageBaseTarFile, self).chmod(tarinfo, targetpath)\n\n```\nI can't tell whether that's a good idea.\n\nIt looks like Sage's version of `tar_file.py` helps if the permissions in the tarball are too lenient, but not if they're too strict, as in this case.",
    "created_at": "2019-02-26T18:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375940",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>For GAP, and indeed in general, I would be tempted to do this:

```diff
diff --git a/build/sage_bootstrap/uncompress/tar_file.py b/build/sage_bootstrap/uncompress/tar_file.py
index 57621527ac..cf707e78a3 100644
--- a/build/sage_bootstrap/uncompress/tar_file.py
+++ b/build/sage_bootstrap/uncompress/tar_file.py
@@ -68,6 +68,7 @@ class SageBaseTarFile(tarfile.TarFile):
         """Apply ``self.umask`` instead of the permissions in the TarInfo."""
         tarinfo = copy.copy(tarinfo)
         tarinfo.mode &= ~self.umask
+        tarinfo.mode |= stat.S_IWUSR
         tarinfo.mode &= ~(stat.S_ISUID | stat.S_ISGID)
         return super(SageBaseTarFile, self).chmod(tarinfo, targetpath)

```
I can't tell whether that's a good idea.

It looks like Sage's version of `tar_file.py` helps if the permissions in the tarball are too lenient, but not if they're too strict, as in this case.



---

archive/issue_comments_375941.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 jhpalmieri]:\n> For GAP, and indeed in general, I would be tempted to do this:\n> \n> ```\n> #!diff\n> diff --git a/build/sage_bootstrap/uncompress/tar_file.py b/build/sage_bootstrap/uncompress/tar_file.py\n> index 57621527ac..cf707e78a3 100644\n> --- a/build/sage_bootstrap/uncompress/tar_file.py\n> +++ b/build/sage_bootstrap/uncompress/tar_file.py\n> @@ -68,6 +68,7 @@ class SageBaseTarFile(tarfile.TarFile):\n>          \"\"\"Apply ``self.umask`` instead of the permissions in the TarInfo.\"\"\"\n>          tarinfo = copy.copy(tarinfo)\n>          tarinfo.mode &= ~self.umask\n> +        tarinfo.mode |= stat.S_IWUSR\n>          tarinfo.mode &= ~(stat.S_ISUID | stat.S_ISGID)\n>          return super(SageBaseTarFile, self).chmod(tarinfo, targetpath)\n> \n> ```\n> I can't tell whether that's a good idea.\n> \n> It looks like Sage's version of `tar_file.py` helps if the permissions in the tarball are too lenient, but not if they're too strict, as in this case.\n\n\nYeah, I wouldn't be opposed to that.  I don't think there's any good reason for a package to be *installing* read-only files.",
    "created_at": "2019-02-28T15:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375941",
    "user": "https://github.com/embray"
}
```

<a id='comment:26'></a>Replying to [comment:25 jhpalmieri]:
> For GAP, and indeed in general, I would be tempted to do this:
> 
> ```
> #!diff
> diff --git a/build/sage_bootstrap/uncompress/tar_file.py b/build/sage_bootstrap/uncompress/tar_file.py
> index 57621527ac..cf707e78a3 100644
> --- a/build/sage_bootstrap/uncompress/tar_file.py
> +++ b/build/sage_bootstrap/uncompress/tar_file.py
> @@ -68,6 +68,7 @@ class SageBaseTarFile(tarfile.TarFile):
>          """Apply ``self.umask`` instead of the permissions in the TarInfo."""
>          tarinfo = copy.copy(tarinfo)
>          tarinfo.mode &= ~self.umask
> +        tarinfo.mode |= stat.S_IWUSR
>          tarinfo.mode &= ~(stat.S_ISUID | stat.S_ISGID)
>          return super(SageBaseTarFile, self).chmod(tarinfo, targetpath)
> 
> ```
> I can't tell whether that's a good idea.
> 
> It looks like Sage's version of `tar_file.py` helps if the permissions in the tarball are too lenient, but not if they're too strict, as in this case.


Yeah, I wouldn't be opposed to that.  I don't think there's any good reason for a package to be *installing* read-only files.



---

archive/issue_comments_375942.json:
```json
{
    "body": "<a id='comment:27'></a>See #27388 for this permissions change.",
    "created_at": "2019-02-28T18:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375942",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>See #27388 for this permissions change.



---

archive/issue_comments_375943.json:
```json
{
    "body": "<a id='comment:28'></a>Another instance of this problem is `primecount` (on Linux), see also https://groups.google.com/d/msg/sage-devel/w6Os2s6_eGk/SyFxT7cJBgAJ for report on this",
    "created_at": "2019-03-13T22:59:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375943",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>Another instance of this problem is `primecount` (on Linux), see also https://groups.google.com/d/msg/sage-devel/w6Os2s6_eGk/SyFxT7cJBgAJ for report on this



---

archive/issue_comments_375944.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:28 dimpase]:\n> Another instance of this problem is `primecount` (on Linux), see also https://groups.google.com/d/msg/sage-devel/w6Os2s6_eGk/SyFxT7cJBgAJ for report on this\n\n\nSee #27485",
    "created_at": "2019-03-18T11:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375944",
    "user": "https://github.com/embray"
}
```

<a id='comment:29'></a>Replying to [comment:28 dimpase]:
> Another instance of this problem is `primecount` (on Linux), see also https://groups.google.com/d/msg/sage-devel/w6Os2s6_eGk/SyFxT7cJBgAJ for report on this


See #27485



---

archive/issue_comments_375945.json:
```json
{
    "body": "<a id='comment:30'></a>Tried to add some more explanation to this ticket.",
    "created_at": "2019-03-18T11:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375945",
    "user": "https://github.com/embray"
}
```

<a id='comment:30'></a>Tried to add some more explanation to this ticket.



---

archive/issue_comments_375946.json:
```json
{
    "body": "<a id='comment:31'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375946",
    "user": "https://github.com/embray"
}
```

<a id='comment:31'></a>Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_events_066986.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "milestone": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66986"
}
```



---

archive/issue_events_066987.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T10:56:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66987"
}
```



---

archive/issue_comments_375947.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:23 jhpalmieri]:\n> I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. \n> \n> gap:\n> \n> ```\n> Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local\n> cp: cannot overwrite directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src\n> cp: /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied\n> ************************************************************************\n> Error copying files for gap-4.10.0.p0.\n> ```\n> \n> ecl:\n> \n> ```\n> Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/ecl-16.1.3.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local\n> cp: symlink: ecl-16.1.3: File exists\n> ************************************************************************\n> Error copying files for ecl-16.1.3.p0.\n> ```\n> \n> I've also seen it with Python 2 and Python 3, with the symlinks in `local/lib/pkgconfig`.\n\n\nThis is now #27544.",
    "created_at": "2019-03-25T12:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375947",
    "user": "https://github.com/embray"
}
```

<a id='comment:32'></a>Replying to [comment:23 jhpalmieri]:
> I'm hitting this problem (or I think it's this problem) with the 8.7.beta4 -> 8.7.beta5 upgrade. 
> 
> gap:
> 
> ```
> Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
> cp: cannot overwrite directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src with non-directory /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/gap-4.10.0.p0/inst/Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/bin/x86_64-apple-darwin18.2.0-default64/src
> cp: /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/./share/gap/pkg/ctbllib/tst/docxpl.tst: Permission denied
> ************************************************************************
> Error copying files for gap-4.10.0.p0.
> ```
> 
> ecl:
> 
> ```
> Copying package files from temporary location /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local/var/tmp/sage/build/ecl-16.1.3.p0/inst to /Users/jpalmier/Desktop/Sage/git/patchbot/sage/local
> cp: symlink: ecl-16.1.3: File exists
> ************************************************************************
> Error copying files for ecl-16.1.3.p0.
> ```
> 
> I've also seen it with Python 2 and Python 3, with the symlinks in `local/lib/pkgconfig`.


This is now #27544.



---

archive/issue_comments_375948.json:
```json
{
    "body": "<a id='comment:33'></a>ISTM all *known* cases of this have been fixed.  In particular, fixing #27223 should fix many cases where this could crop up, since some files were not being properly uninstalled.\n\nIf it comes up again I would suggest opening a new ticket for that specific case.",
    "created_at": "2019-05-09T16:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375948",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'></a>ISTM all *known* cases of this have been fixed.  In particular, fixing #27223 should fix many cases where this could crop up, since some files were not being properly uninstalled.

If it comes up again I would suggest opening a new ticket for that specific case.



---

archive/issue_events_066988.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-09T16:04:28Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "milestone": "sage-8.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66988"
}
```



---

archive/issue_events_066989.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-09T16:04:28Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66989"
}
```



---

archive/issue_comments_375949.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2019-05-09T16:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375949",
    "user": "https://github.com/embray"
}
```

Resolution: worksforme



---

archive/issue_events_066990.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-05-09T16:04:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66990"
}
```



---

archive/issue_comments_375950.json:
```json
{
    "body": "<a id='comment:34'></a>I'm hitting the \"cannot overwrite non-directory\" from the original ticket description with gfortran (now 9.2.0) on `fedora-31-minimal` and `fedora-32-minimal` - see https://github.com/mkoeppe/sage/actions/runs/33491442",
    "created_at": "2020-01-31T21:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375950",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>I'm hitting the "cannot overwrite non-directory" from the original ticket description with gfortran (now 9.2.0) on `fedora-31-minimal` and `fedora-32-minimal` - see https://github.com/mkoeppe/sage/actions/runs/33491442



---

archive/issue_comments_375951.json:
```json
{
    "body": "Resolution changed from worksforme to ",
    "created_at": "2020-01-31T21:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375951",
    "user": "https://github.com/mkoeppe"
}
```

Resolution changed from worksforme to 



---

archive/issue_comments_375952.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2020-01-31T21:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375952",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from closed to new.



---

archive/issue_events_066991.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-31T21:15:16Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66991"
}
```



---

archive/issue_events_066992.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-31T21:15:16Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66992"
}
```



---

archive/issue_events_066993.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-01-31T21:15:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66993"
}
```



---

archive/issue_comments_375953.json:
```json
{
    "body": "<a id='comment:35'></a>The symbolic link `lib64->lib` is set in the `AC_CONFIG_COMMANDS mkdirs`.\n\nThe `gfortran` staging install creates the following:\n\n```\nls -l /sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib*\n/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib:\ntotal 48296\ndrwxr-xr-x 3 root root     4096 Jan 31 20:56 gcc\n-rw-r--r-- 1 root root   464650 Jan 31 20:56 libatomic.a\nlrwxrwxrwx 1 root root       18 Jan 31 20:56 libatomic.so -> libatomic.so.1.2.0\nlrwxrwxrwx 1 root root       18 Jan 31 20:56 libatomic.so.1 -> libatomic.so.1.2.0\n-rwxr-xr-x 1 root root   170064 Jan 31 20:56 libatomic.so.1.2.0\n-rw-r--r-- 1 root root      132 Jan 31 20:56 libgcc_s.so\n-rw-r--r-- 1 root root   872480 Jan 31 20:56 libgcc_s.so.1\n-rw-r--r-- 1 root root 28051754 Jan 31 20:56 libgfortran.a\nlrwxrwxrwx 1 root root       20 Jan 31 20:56 libgfortran.so -> libgfortran.so.5.0.0\nlrwxrwxrwx 1 root root       20 Jan 31 20:56 libgfortran.so.5 -> libgfortran.so.5.0.0\n-rwxr-xr-x 1 root root 11718472 Jan 31 20:56 libgfortran.so.5.0.0\n-rw-r--r-- 1 root root      269 Jan 31 20:56 libgfortran.spec\n-rw-r--r-- 1 root root  3239510 Jan 31 20:56 libgomp.a\nlrwxrwxrwx 1 root root       16 Jan 31 20:56 libgomp.so -> libgomp.so.1.0.0\nlrwxrwxrwx 1 root root       16 Jan 31 20:56 libgomp.so.1 -> libgomp.so.1.0.0\n-rwxr-xr-x 1 root root  1468416 Jan 31 20:56 libgomp.so.1.0.0\n-rw-r--r-- 1 root root      169 Jan 31 20:56 libgomp.spec\n-rw-r--r-- 1 root root  2055148 Jan 31 20:56 libquadmath.a\nlrwxrwxrwx 1 root root       20 Jan 31 20:56 libquadmath.so -> libquadmath.so.0.0.0\nlrwxrwxrwx 1 root root       20 Jan 31 20:56 libquadmath.so.0 -> libquadmath.so.0.0.0\n-rwxr-xr-x 1 root root  1224592 Jan 31 20:56 libquadmath.so.0.0.0\n-rw-r--r-- 1 root root   101410 Jan 31 20:56 libssp.a\nlrwxrwxrwx 1 root root       15 Jan 31 20:56 libssp.so -> libssp.so.0.0.0\nlrwxrwxrwx 1 root root       15 Jan 31 20:56 libssp.so.0 -> libssp.so.0.0.0\n-rwxr-xr-x 1 root root    51328 Jan 31 20:56 libssp.so.0.0.0\n-rw-r--r-- 1 root root     3222 Jan 31 20:56 libssp_nonshared.a\n\n/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib64:\ntotal 1196\n-rwxr-xr-x 1 root root     932 Jan 31 20:56 libcc1.la\nlrwxrwxrwx 1 root root      15 Jan 31 20:56 libcc1.so -> libcc1.so.0.0.0\nlrwxrwxrwx 1 root root      15 Jan 31 20:56 libcc1.so.0 -> libcc1.so.0.0.0\n-rwxr-xr-x 1 root root 1217840 Jan 31 20:56 libcc1.so.0.0.0\n\n/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/libexec:\ntotal 4\ndrwxr-xr-x 3 root root 4096 Jan 31 20:56 gcc\n```",
    "created_at": "2020-01-31T21:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375953",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>The symbolic link `lib64->lib` is set in the `AC_CONFIG_COMMANDS mkdirs`.

The `gfortran` staging install creates the following:

```
ls -l /sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib*
/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib:
total 48296
drwxr-xr-x 3 root root     4096 Jan 31 20:56 gcc
-rw-r--r-- 1 root root   464650 Jan 31 20:56 libatomic.a
lrwxrwxrwx 1 root root       18 Jan 31 20:56 libatomic.so -> libatomic.so.1.2.0
lrwxrwxrwx 1 root root       18 Jan 31 20:56 libatomic.so.1 -> libatomic.so.1.2.0
-rwxr-xr-x 1 root root   170064 Jan 31 20:56 libatomic.so.1.2.0
-rw-r--r-- 1 root root      132 Jan 31 20:56 libgcc_s.so
-rw-r--r-- 1 root root   872480 Jan 31 20:56 libgcc_s.so.1
-rw-r--r-- 1 root root 28051754 Jan 31 20:56 libgfortran.a
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libgfortran.so -> libgfortran.so.5.0.0
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libgfortran.so.5 -> libgfortran.so.5.0.0
-rwxr-xr-x 1 root root 11718472 Jan 31 20:56 libgfortran.so.5.0.0
-rw-r--r-- 1 root root      269 Jan 31 20:56 libgfortran.spec
-rw-r--r-- 1 root root  3239510 Jan 31 20:56 libgomp.a
lrwxrwxrwx 1 root root       16 Jan 31 20:56 libgomp.so -> libgomp.so.1.0.0
lrwxrwxrwx 1 root root       16 Jan 31 20:56 libgomp.so.1 -> libgomp.so.1.0.0
-rwxr-xr-x 1 root root  1468416 Jan 31 20:56 libgomp.so.1.0.0
-rw-r--r-- 1 root root      169 Jan 31 20:56 libgomp.spec
-rw-r--r-- 1 root root  2055148 Jan 31 20:56 libquadmath.a
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libquadmath.so -> libquadmath.so.0.0.0
lrwxrwxrwx 1 root root       20 Jan 31 20:56 libquadmath.so.0 -> libquadmath.so.0.0.0
-rwxr-xr-x 1 root root  1224592 Jan 31 20:56 libquadmath.so.0.0.0
-rw-r--r-- 1 root root   101410 Jan 31 20:56 libssp.a
lrwxrwxrwx 1 root root       15 Jan 31 20:56 libssp.so -> libssp.so.0.0.0
lrwxrwxrwx 1 root root       15 Jan 31 20:56 libssp.so.0 -> libssp.so.0.0.0
-rwxr-xr-x 1 root root    51328 Jan 31 20:56 libssp.so.0.0.0
-rw-r--r-- 1 root root     3222 Jan 31 20:56 libssp_nonshared.a

/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/lib64:
total 1196
-rwxr-xr-x 1 root root     932 Jan 31 20:56 libcc1.la
lrwxrwxrwx 1 root root      15 Jan 31 20:56 libcc1.so -> libcc1.so.0.0.0
lrwxrwxrwx 1 root root      15 Jan 31 20:56 libcc1.so.0 -> libcc1.so.0.0.0
-rwxr-xr-x 1 root root 1217840 Jan 31 20:56 libcc1.so.0.0.0

/sage/local/var/tmp/sage/build/gfortran-9.2.0/inst/sage/local/libexec:
total 4
drwxr-xr-x 3 root root 4096 Jan 31 20:56 gcc
```



---

archive/issue_comments_375954.json:
```json
{
    "body": "<a id='comment:36'></a>I'm fixing this for `gfortran` in #29089\nbut the faulty copying from staging to $SAGE_LOCAL should be cleaned up in #22509.",
    "created_at": "2020-01-31T21:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375954",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>I'm fixing this for `gfortran` in #29089
but the faulty copying from staging to $SAGE_LOCAL should be cleaned up in #22509.



---

archive/issue_comments_375955.json:
```json
{
    "body": "<a id='comment:37'></a>Showing up in `pillow` as well, as reported in https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/DY3l67DUAwAJ",
    "created_at": "2020-03-31T11:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375955",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Showing up in `pillow` as well, as reported in https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/DY3l67DUAwAJ



---

archive/issue_comments_375956.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-03-31T11:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375956",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_375957.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 mkoeppe]:\n> Showing up in `pillow` as well, as reported in https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/DY3l67DUAwAJ\n\n\nan unpleasant part of it is that the installation attempt happens from within distutils or setuptools, called from within pillow's `setup.py`.\n\nwould it be better to make `lib64/` a proper directory, install stuff there, and then do a kind of postinstall that would move/link/copy stuff over to `lib/` ?",
    "created_at": "2020-03-31T12:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375957",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'></a>Replying to [comment:37 mkoeppe]:
> Showing up in `pillow` as well, as reported in https://groups.google.com/d/msg/sage-release/kU5M1QVuQQY/DY3l67DUAwAJ


an unpleasant part of it is that the installation attempt happens from within distutils or setuptools, called from within pillow's `setup.py`.

would it be better to make `lib64/` a proper directory, install stuff there, and then do a kind of postinstall that would move/link/copy stuff over to `lib/` ?



---

archive/issue_comments_375958.json:
```json
{
    "body": "<a id='comment:39'></a>I will just move the fix that I have in the gfortran install script into sage-spkg.",
    "created_at": "2020-03-31T13:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375958",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>I will just move the fix that I have in the gfortran install script into sage-spkg.



---

archive/issue_comments_375959.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-31T14:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375959",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_375960.json:
```json
{
    "body": "<a id='comment:42'></a>New commits:",
    "created_at": "2020-03-31T14:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375960",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>New commits:



---

archive/issue_comments_375961.json:
```json
{
    "body": "<a id='comment:43'></a>A diffrent error now (`File exists`):\n\n```\nwriting manifest file 'src/Pillow.egg-info/SOURCES.txt'\nrunning install_lib\ncreating /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/pillow-5.3.0.p0/inst/home/scratch2/dimpase/sage/sage/local/lib64\nerror: could not create '/home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/pillow-5.3.0.p0/inst/home/scratch2/dimpase/sage/sage/local/lib64': File exists\n***************************************************************************************************************************************\nError building/installing Pillow\n\n```",
    "created_at": "2020-03-31T15:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375961",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'></a>A diffrent error now (`File exists`):

```
writing manifest file 'src/Pillow.egg-info/SOURCES.txt'
running install_lib
creating /home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/pillow-5.3.0.p0/inst/home/scratch2/dimpase/sage/sage/local/lib64
error: could not create '/home/scratch2/dimpase/sage/sage/local/var/tmp/sage/build/pillow-5.3.0.p0/inst/home/scratch2/dimpase/sage/sage/local/lib64': File exists
***************************************************************************************************************************************
Error building/installing Pillow

```



---

archive/issue_comments_375962.json:
```json
{
    "body": "<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-31T16:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375962",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375963.json:
```json
{
    "body": "<a id='comment:45'></a>Try with this version",
    "created_at": "2020-03-31T16:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375963",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>Try with this version



---

archive/issue_comments_375964.json:
```json
{
    "body": "<a id='comment:46'></a>pillow installs now. Moar testing underway",
    "created_at": "2020-03-31T16:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375964",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:46'></a>pillow installs now. Moar testing underway



---

archive/issue_comments_375965.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-04-01T02:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375965",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_375966.json:
```json
{
    "body": "<a id='comment:47'></a>lgtm",
    "created_at": "2020-04-01T02:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375966",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:47'></a>lgtm



---

archive/issue_comments_375967.json:
```json
{
    "body": "<a id='comment:48'></a>Thanks!",
    "created_at": "2020-04-01T02:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375967",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'></a>Thanks!



---

archive/issue_comments_375968.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-09T22:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26996#issuecomment-375968",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_066994.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-09T22:45:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26996",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26996#event-66994"
}
```
