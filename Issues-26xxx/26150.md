# Issue 26150: fraction field: fix conversion from symbolic ring

archive/issues_025913.json:
```json
{
    "body": "```\nsage: z = SR.var('z')\nsage: CyclotomicField(2)['z'].fraction_field()(2*(4*z + 5)/((z + 1)*(z - 1)^4))\n```\nraises an error but shouldn't. This issue is also mentioned on #24539.\n\nAFAICS it worked in earlier [SageMath](SageMath) versions, but probably due to #23664 (unchecked) it stopped working.\n\nCC:  @cheuberg @mezzarobba\n\nBranch/Commit: 1a3cc587543fd5d4636ab33685ab27d2e9767721\n\nReviewer: Marc Mezzarobba\n\nAuthor: Daniel Krenn\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26150\n\n",
    "closed_at": "2019-04-08T21:34:13Z",
    "created_at": "2018-08-28T11:14:46Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "fraction field: fix conversion from symbolic ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26150",
    "user": "https://github.com/dkrenn"
}
```
```
sage: z = SR.var('z')
sage: CyclotomicField(2)['z'].fraction_field()(2*(4*z + 5)/((z + 1)*(z - 1)^4))
```
raises an error but shouldn't. This issue is also mentioned on #24539.

AFAICS it worked in earlier [SageMath](SageMath) versions, but probably due to #23664 (unchecked) it stopped working.

CC:  @cheuberg @mezzarobba

Branch/Commit: 1a3cc587543fd5d4636ab33685ab27d2e9767721

Reviewer: Marc Mezzarobba

Author: Daniel Krenn

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26150





---

archive/issue_comments_389025.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2018-08-28T11:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389025",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_389026.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-28T11:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389026",
    "user": "https://github.com/dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_389027.json:
```json
{
    "body": "Description changed:\n```diff\n\n```\n",
    "created_at": "2018-08-28T11:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389027",
    "user": "https://github.com/dkrenn"
}
```

Description changed:
```diff

```




---

archive/issue_comments_389028.json:
```json
{
    "body": "<a id='comment:4'></a>Thanks for the fix! You can set the ticket to positive_review on my behalf if the patchbot is happy.",
    "created_at": "2018-08-28T11:58:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389028",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:4'></a>Thanks for the fix! You can set the ticket to positive_review on my behalf if the patchbot is happy.



---

archive/issue_comments_389029.json:
```json
{
    "body": "<a id='comment:5'></a>Unfortunately, there is one doctest failing:\n\n```\nFile \"src/sage/rings/function_field/function_field.py\", line 1602, in sage.rings.function_field.function_field.FunctionField_polymod.hom\nFailed example:\n    L.hom(r, base_morphism=phi)\nException raised:\n    Traceback (most recent call last):\n    ...\n    ValueError: invalid literal for int() with base 10: \"Error in dput(length(sage1)) : object 'sage1' not foun\"\n```\nI have no idea what is going on here.",
    "created_at": "2018-08-29T08:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389029",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:5'></a>Unfortunately, there is one doctest failing:

```
File "src/sage/rings/function_field/function_field.py", line 1602, in sage.rings.function_field.function_field.FunctionField_polymod.hom
Failed example:
    L.hom(r, base_morphism=phi)
Exception raised:
    Traceback (most recent call last):
    ...
    ValueError: invalid literal for int() with base 10: "Error in dput(length(sage1)) : object 'sage1' not foun"
```
I have no idea what is going on here.



---

archive/issue_comments_389030.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-08-29T08:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389030",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_389031.json:
```json
{
    "body": "<a id='comment:6'></a>Nitpick: `:trac:`#26150`` -> `:trac:`26150``",
    "created_at": "2018-08-29T08:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389031",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Nitpick: `:trac:`#26150`` -> `:trac:`26150``



---

archive/issue_comments_389032.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-29T08:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389032",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_389033.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 jdemeyer]:\n> Nitpick: `:trac:`#26150`` -> `:trac:`26150``\n\n\nThanks. Changed.",
    "created_at": "2018-08-29T08:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389033",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:8'></a>Replying to [comment:6 jdemeyer]:
> Nitpick: `:trac:`#26150`` -> `:trac:`26150``


Thanks. Changed.



---

archive/issue_comments_389034.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:5 dkrenn]:\n> Unfortunately, there is one doctest failing:\n> \n> ```\n> File \"src/sage/rings/function_field/function_field.py\", line 1602, in sage.rings.function_field.function_field.FunctionField_polymod.hom\n> Failed example:\n>     L.hom(r, base_morphism=phi)\n> Exception raised:\n>     Traceback (most recent call last):\n>     ...\n>     ValueError: invalid literal for int() with base 10: \"Error in dput(length(sage1)) : object 'sage1' not foun\"\n> ```\n\n\nFollow up at #26155.",
    "created_at": "2018-08-29T11:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389034",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:9'></a>Replying to [comment:5 dkrenn]:
> Unfortunately, there is one doctest failing:
> 
> ```
> File "src/sage/rings/function_field/function_field.py", line 1602, in sage.rings.function_field.function_field.FunctionField_polymod.hom
> Failed example:
>     L.hom(r, base_morphism=phi)
> Exception raised:
>     Traceback (most recent call last):
>     ...
>     ValueError: invalid literal for int() with base 10: "Error in dput(length(sage1)) : object 'sage1' not foun"
> ```


Follow up at #26155.



---

archive/issue_comments_389035.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-30T07:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389035",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_389036.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-30T07:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389036",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_389037.json:
```json
{
    "body": "<a id='comment:11'></a>This is now an alternative fix for the issue. Needs review again and let's see what the patchbot says :)",
    "created_at": "2018-08-30T07:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389037",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:11'></a>This is now an alternative fix for the issue. Needs review again and let's see what the patchbot says :)



---

archive/issue_comments_389038.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-08-30T12:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389038",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_389039.json:
```json
{
    "body": "<a id='comment:12'></a>Again some failing doctests... :(",
    "created_at": "2018-08-30T12:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389039",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:12'></a>Again some failing doctests... :(



---

archive/issue_comments_389040.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-30T14:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389040",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_389041.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-30T14:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389041",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_389042.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-30T14:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389042",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_389043.json:
```json
{
    "body": "<a id='comment:15'></a>There is some underlying problem with a recursive call when creating an element out of `int(1)`. This was somehow hidden before. I rewrote the element constructor a bit to adapt; also fixing an issue raised on #24539. The behavior is now more consistent with remaining [SageMath](SageMath).\n\nSo again, let us see what the patchbot says...",
    "created_at": "2018-08-30T14:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389043",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:15'></a>There is some underlying problem with a recursive call when creating an element out of `int(1)`. This was somehow hidden before. I rewrote the element constructor a bit to adapt; also fixing an issue raised on #24539. The behavior is now more consistent with remaining [SageMath](SageMath).

So again, let us see what the patchbot says...



---

archive/issue_comments_389044.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-15T10:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389044",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_389045.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-15T17:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389045",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_389046.json:
```json
{
    "body": "<a id='comment:18'></a>Finally, I've written a fix that solves the issues and with which the patchbot is happy as well. To be more accurate, I've took the liberty to slightly rewrite the element constructor so that it covers a broader spectrum of inputs for the conversion. Now it should also be \"correct\" in the sense what it does at which point ;)\n\nPlease Review (again)",
    "created_at": "2018-09-16T18:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389046",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:18'></a>Finally, I've written a fix that solves the issues and with which the patchbot is happy as well. To be more accurate, I've took the liberty to slightly rewrite the element constructor so that it covers a broader spectrum of inputs for the conversion. Now it should also be "correct" in the sense what it does at which point ;)

Please Review (again)



---

archive/issue_comments_389047.json:
```json
{
    "body": "<a id='comment:19'></a>`@`mmezzarobba: You already have reviewed this ticket, but a small change was done after that. I would appreciate a review of the changes :)",
    "created_at": "2019-03-27T20:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389047",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:19'></a>`@`mmezzarobba: You already have reviewed this ticket, but a small change was done after that. I would appreciate a review of the changes :)



---

archive/issue_comments_389048.json:
```json
{
    "body": "<a id='comment:20'></a>Thanks for the notice.\n\nI agree with most of the changes, but I'm not sure I like the unconditional conversions in `resolve_fractions()`. For which cases are they intended?",
    "created_at": "2019-04-03T08:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389048",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:20'></a>Thanks for the notice.

I agree with most of the changes, but I'm not sure I like the unconditional conversions in `resolve_fractions()`. For which cases are they intended?



---

archive/issue_comments_389049.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-03T12:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389049",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_389050.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 mmezzarobba]:\n> Thanks for the notice.\n> \n> I agree with most of the changes, but I'm not sure I like the unconditional conversions in `resolve_fractions()`. For which cases are they intended?\n\n\nAdded a doctest:\n|                                                                                                                                           |                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n|[1a3cc58](https://git.sagemath.org/sage.git/commit/?id=1a3cc587543fd5d4636ab33685ab27d2e9767721)|`Trac #26150: add another doctest`|\n```diff\n+            sage: T.<t> = ZZ[]\n+            sage: S.<s> = ZZ[]\n+            sage: S.fraction_field()(s/(s+1), (t-1)/(t+2))\n+            (s^2 + 2*s)/(s^2 - 1)\n```\nNote that there is a conversion between `S` and `T`, so this conversion should be used also in the fraction field, at least in the case nothing else (proper coercion) works.",
    "created_at": "2019-04-03T12:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389050",
    "user": "https://github.com/dkrenn"
}
```

<a id='comment:22'></a>Replying to [comment:20 mmezzarobba]:
> Thanks for the notice.
> 
> I agree with most of the changes, but I'm not sure I like the unconditional conversions in `resolve_fractions()`. For which cases are they intended?


Added a doctest:
|                                                                                                                                           |                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
|[1a3cc58](https://git.sagemath.org/sage.git/commit/?id=1a3cc587543fd5d4636ab33685ab27d2e9767721)|`Trac #26150: add another doctest`|
```diff
+            sage: T.<t> = ZZ[]
+            sage: S.<s> = ZZ[]
+            sage: S.fraction_field()(s/(s+1), (t-1)/(t+2))
+            (s^2 + 2*s)/(s^2 - 1)
```
Note that there is a conversion between `S` and `T`, so this conversion should be used also in the fraction field, at least in the case nothing else (proper coercion) works.



---

archive/issue_comments_389051.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-07T10:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389051",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_389052.json:
```json
{
    "body": "<a id='comment:23'></a>If you are really sure you want that, I won't oppose...",
    "created_at": "2019-04-07T10:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389052",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:23'></a>If you are really sure you want that, I won't oppose...



---

archive/issue_events_065194.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-04-08T21:34:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26150#event-65194"
}
```



---

archive/issue_comments_389053.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-08T21:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26150",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26150#issuecomment-389053",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
