# Issue 26457: Do not depend on a patched Python

archive/issues_026220.json:
```json
{
    "assignees": [],
    "body": "SageMath ships a patched Python which adds a warning if `.` is on the path and deemed insecure, see https://bugs.python.org/issue16202 and #13579.\n\nThis patch is not going to be part of Python anytime soon and afaik no distribution other than Sage-the-distribution is shipping this patch.\n\nFor packagers it is annoying to work around the doctests that expect this Python patch to be applied. Also it means that for Sage development we cannot swap out SageMath's Python with one coming from our (Linux) distribution. But long-term we want to be able to replace more SPKGs with distribution packages. (I know that embray is working on that.)\n\nI would like to discuss this issue here. From my point of view, we should not expect this patch to be applied in doctesting and in Sage in general. (Actually, I don't think we should apply this patch at all and just behave like vanilla Python does but that's probably too controversial.)\n\nI would like to hear some arguments here and come up with something that is going to make packagers happy because I believe that's really what we should be striving for. We might want a vote on sage-devel in the end but that remains to be seen.\n\nI hope I am not creating a duplicate with this ticket (I might have tried to do something like that before...)\n\nSee #25358 for a related ticket.\n\nCC:  @timokau @kiwifb @antonio-rojas @embray @slel @nthiery @jdemeyer @isuruf @sagetrac-pcpa @tobihan @infinity0 @SnarkBoojum @sagetrac-cschwan\n\nKeywords: **conda, archlinux, gentoo, debian, nix, python**\n\nComponent: **distribution**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26457_\n\n",
    "closed_at": "2021-02-26T13:59:30Z",
    "created_at": "2018-10-10T12:23:40Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20distribution",
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Do not depend on a patched Python",
    "type": "issue",
    "updated_at": "2021-02-26T13:59:30Z",
    "url": "https://github.com/sagemath/sage/issues/26457",
    "user": "https://github.com/saraedum"
}
```
SageMath ships a patched Python which adds a warning if `.` is on the path and deemed insecure, see https://bugs.python.org/issue16202 and #13579.

This patch is not going to be part of Python anytime soon and afaik no distribution other than Sage-the-distribution is shipping this patch.

For packagers it is annoying to work around the doctests that expect this Python patch to be applied. Also it means that for Sage development we cannot swap out SageMath's Python with one coming from our (Linux) distribution. But long-term we want to be able to replace more SPKGs with distribution packages. (I know that embray is working on that.)

I would like to discuss this issue here. From my point of view, we should not expect this patch to be applied in doctesting and in Sage in general. (Actually, I don't think we should apply this patch at all and just behave like vanilla Python does but that's probably too controversial.)

I would like to hear some arguments here and come up with something that is going to make packagers happy because I believe that's really what we should be striving for. We might want a vote on sage-devel in the end but that remains to be seen.

I hope I am not creating a duplicate with this ticket (I might have tried to do something like that before...)

See #25358 for a related ticket.

CC:  @timokau @kiwifb @antonio-rojas @embray @slel @nthiery @jdemeyer @isuruf @sagetrac-pcpa @tobihan @infinity0 @SnarkBoojum @sagetrac-cschwan

Keywords: **conda, archlinux, gentoo, debian, nix, python**

Component: **distribution**

_Issue created by migration from https://trac.sagemath.org/ticket/26457_





---

archive/issue_events_366183.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-10-10T12:23:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366183"
}
```



---

archive/issue_events_366184.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-10-10T12:23:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20distribution",
    "label_color": "000080",
    "label_name": "c: distribution",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366184"
}
```



---

archive/issue_events_366185.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-10-10T12:23:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366185"
}
```



---

archive/issue_events_366186.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-10-10T12:23:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366186"
}
```



---

archive/issue_events_366187.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-10-10T12:23:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "000080",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366187"
}
```



---

archive/issue_events_366188.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2018-10-10T12:24:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366188"
}
```



---

archive/issue_comments_407947.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nwe can simply tag these tests, and then in the unpatched python case they won't be run.",
    "created_at": "2018-10-10T12:36:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407947",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:4" align="right">comment:4</div>

we can simply tag these tests, and then in the unpatched python case they won't be run.



---

archive/issue_comments_407948.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nYour description sounds like a duplicate of #25358, but if I read the title correctly you want to go further and also remove all other patches? I agree with that in principle, but it will be hard.\n\nWe currently apply two patches to python that I added just for sage. One is a bug that has since been fixed upstream and will not be necessary once there is a new release: https://github.com/python/cpython/pull/6118\n\nThe other fixes [This is the Trac macro ** that was inherited from the migration called with arguments (https://bugs.python.org/issue27177)](https://trac.sagemath.org/wiki/WikiMacros#-macro), which was fixed but never backported. I have not found any way to work around this patch since we need `re` to work with sage integers but `re` is not (at least not easily) monkey-patchable.",
    "created_at": "2018-10-10T17:51:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407948",
    "user": "https://github.com/timokau"
}
```

<div id="comment:5" align="right">comment:5</div>

Your description sounds like a duplicate of #25358, but if I read the title correctly you want to go further and also remove all other patches? I agree with that in principle, but it will be hard.

We currently apply two patches to python that I added just for sage. One is a bug that has since been fixed upstream and will not be necessary once there is a new release: https://github.com/python/cpython/pull/6118

The other fixes [This is the Trac macro ** that was inherited from the migration called with arguments (https://bugs.python.org/issue27177)](https://trac.sagemath.org/wiki/WikiMacros#-macro), which was fixed but never backported. I have not found any way to work around this patch since we need `re` to work with sage integers but `re` is not (at least not easily) monkey-patchable.



---

archive/issue_comments_407949.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI fully agree about the safe-directory part of course.",
    "created_at": "2018-10-10T17:52:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407949",
    "user": "https://github.com/timokau"
}
```

<div id="comment:6" align="right">comment:6</div>

I fully agree about the safe-directory part of course.



---

archive/issue_comments_407950.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@timokau](#comment:6):\n> I fully agree about the safe-directory part of course.\n\nCould you clarify what you agree to? To drop the patches?",
    "created_at": "2018-10-10T18:41:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407950",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@timokau](#comment:6):
> I fully agree about the safe-directory part of course.

Could you clarify what you agree to? To drop the patches?



---

archive/issue_comments_407951.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@timokau](#comment:5):\n> Your description sounds like a duplicate of #25358, but if I read the title correctly you want to go further and also remove all other patches? I agree with that in principle, but it will be hard.\n\nYes, I should have been more clear about that. I want to do something about the patches that won't make it into upstream Python 2 because these will also never make it into the majority of distributions. I wasn't aware of the \"re\" one.",
    "created_at": "2018-10-10T18:55:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407951",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@timokau](#comment:5):
> Your description sounds like a duplicate of #25358, but if I read the title correctly you want to go further and also remove all other patches? I agree with that in principle, but it will be hard.

Yes, I should have been more clear about that. I want to do something about the patches that won't make it into upstream Python 2 because these will also never make it into the majority of distributions. I wasn't aware of the "re" one.



---

archive/issue_comments_407952.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@dimpase](#comment:4):\n> we can simply tag these tests, and then in the unpatched python case they won't be run.\n\nSo, something like `# optional: sage-the-distribution`. That would work for packagers I guess.\n\nI wonder whether that Python patch could not be monkey-patched in Sage somehow and then everybody would be happy? (We can of course add it for the doctesting as was done in #25358 but that does not solve the general problem of running Sage in an insecure location.)",
    "created_at": "2018-10-10T19:14:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407952",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@dimpase](#comment:4):
> we can simply tag these tests, and then in the unpatched python case they won't be run.

So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.

I wonder whether that Python patch could not be monkey-patched in Sage somehow and then everybody would be happy? (We can of course add it for the doctesting as was done in #25358 but that does not solve the general problem of running Sage in an insecure location.)



---

archive/issue_comments_407953.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@saraedum](#comment:7):\n> Replying to [@timokau](#comment:6):\n> > I fully agree about the safe-directory part of course.\n\n> Could you clarify what you agree to? To drop the patches?\n\nI'd be fine with dropping or keeping the patch, as long as the doctests don't depend on it.\n\n\nReplying to [@saraedum](#comment:8):\n> Replying to [@timokau](#comment:5):\n> > Your description sounds like a duplicate of #25358, but if I read the title correctly you want to go further and also remove all other patches? I agree with that in principle, but it will be hard.\n\n> Yes, I should have been more clear about that. I want to do something about the patches that won't make it into upstream Python 2 because these will also never make it into the majority of distributions. I wasn't aware of the \"re\" one.\n\nThe `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200\n\nOther than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.\n\nReplying to [@saraedum](#comment:9):\n> Replying to [@dimpase](#comment:4):\n> > we can simply tag these tests, and then in the unpatched python case they won't be run.\n\n> \n> So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.\n\nWe would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and \"fix\" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.",
    "created_at": "2018-10-10T20:34:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407953",
    "user": "https://github.com/timokau"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@saraedum](#comment:7):
> Replying to [@timokau](#comment:6):
> > I fully agree about the safe-directory part of course.

> Could you clarify what you agree to? To drop the patches?

I'd be fine with dropping or keeping the patch, as long as the doctests don't depend on it.


Replying to [@saraedum](#comment:8):
> Replying to [@timokau](#comment:5):
> > Your description sounds like a duplicate of #25358, but if I read the title correctly you want to go further and also remove all other patches? I agree with that in principle, but it will be hard.

> Yes, I should have been more clear about that. I want to do something about the patches that won't make it into upstream Python 2 because these will also never make it into the majority of distributions. I wasn't aware of the "re" one.

The `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200

Other than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.

Replying to [@saraedum](#comment:9):
> Replying to [@dimpase](#comment:4):
> > we can simply tag these tests, and then in the unpatched python case they won't be run.

> 
> So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.

We would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and "fix" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.



---

archive/issue_comments_407954.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@timokau](#comment:10):\n> Replying to [@saraedum](#comment:9):\n> > So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.\n\n> We would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and \"fix\" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.\n\nI agree. So could we change the underlying problem here? You demonstrated that we can check `sys.path` when doctesting on an unpatched Sage. Can't we do the same for normal invocations of Sage and then drop that patch to Python?",
    "created_at": "2018-10-10T20:39:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407954",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@timokau](#comment:10):
> Replying to [@saraedum](#comment:9):
> > So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.

> We would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and "fix" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.

I agree. So could we change the underlying problem here? You demonstrated that we can check `sys.path` when doctesting on an unpatched Sage. Can't we do the same for normal invocations of Sage and then drop that patch to Python?



---

archive/issue_comments_407955.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@timokau](#comment:10):\n> The `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200\n\nI didn't know about this stuff\u2026that's horrifying :)\n\n> Other than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.\n\nCould we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)",
    "created_at": "2018-10-10T20:49:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407955",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@timokau](#comment:10):
> The `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200

I didn't know about this stuff…that's horrifying :)

> Other than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.

Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)



---

archive/issue_comments_407956.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@saraedum](#comment:11):\n> Replying to [@timokau](#comment:10):\n> > Replying to [@saraedum](#comment:9):\n> > > So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.\n\n> \n> > We would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and \"fix\" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.\n\n> \n> I agree. So could we change the underlying problem here? You demonstrated that we can check `sys.path` when doctesting on an unpatched Sage. Can't we do the same for normal invocations of Sage and then drop that patch to Python?\n\nWe could just call the re-written `test_safe_directory` (with which Jeroen wasn't quite happy yet) at sage startup (before importing anything to avoid running in the security issue).",
    "created_at": "2018-10-10T20:59:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407956",
    "user": "https://github.com/timokau"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@saraedum](#comment:11):
> Replying to [@timokau](#comment:10):
> > Replying to [@saraedum](#comment:9):
> > > So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.

> 
> > We would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and "fix" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.

> 
> I agree. So could we change the underlying problem here? You demonstrated that we can check `sys.path` when doctesting on an unpatched Sage. Can't we do the same for normal invocations of Sage and then drop that patch to Python?

We could just call the re-written `test_safe_directory` (with which Jeroen wasn't quite happy yet) at sage startup (before importing anything to avoid running in the security issue).



---

archive/issue_comments_407957.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@saraedum](#comment:12):\n> Replying to [@timokau](#comment:10):\n> > The `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200\n\n> I didn't know about this stuff\u2026that's horrifying :)\n> \n> > Other than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.\n\n> \n> Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)\n\nBeing able use `re` and access matches seems pretty essential to me, just removing the doctests wouldn't solve the problem.",
    "created_at": "2018-10-10T21:05:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407957",
    "user": "https://github.com/timokau"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@saraedum](#comment:12):
> Replying to [@timokau](#comment:10):
> > The `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200

> I didn't know about this stuff…that's horrifying :)
> 
> > Other than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.

> 
> Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)

Being able use `re` and access matches seems pretty essential to me, just removing the doctests wouldn't solve the problem.



---

archive/issue_comments_407958.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@timokau](#comment:13):\n> Replying to [@saraedum](#comment:11):\n> > Replying to [@timokau](#comment:10):\n> > > Replying to [@saraedum](#comment:9):\n> > > > So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.\n\n> > \n> > > We would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and \"fix\" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.\n\n> > \n> > I agree. So could we change the underlying problem here? You demonstrated that we can check `sys.path` when doctesting on an unpatched Sage. Can't we do the same for normal invocations of Sage and then drop that patch to Python?\n\n> \n> We could just call the re-written `test_safe_directory` (with which Jeroen wasn't quite happy yet) at sage startup (before importing anything to avoid running in the security issue).\n\nThat sounds like a good plan to me. Let me have a look at this tomorrow.",
    "created_at": "2018-10-10T22:51:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407958",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@timokau](#comment:13):
> Replying to [@saraedum](#comment:11):
> > Replying to [@timokau](#comment:10):
> > > Replying to [@saraedum](#comment:9):
> > > > So, something like `# optional: sage-the-distribution`. That would work for packagers I guess.

> > 
> > > We would have to be very careful with that, too many differences could make sage-on-distro a second class citizen. Also it would probably be tempting to take the easy way out and "fix" problems by disabling tests on distro instead of fixing the underlying issue. On very limited cases like this it would probably be fine.

> > 
> > I agree. So could we change the underlying problem here? You demonstrated that we can check `sys.path` when doctesting on an unpatched Sage. Can't we do the same for normal invocations of Sage and then drop that patch to Python?

> 
> We could just call the re-written `test_safe_directory` (with which Jeroen wasn't quite happy yet) at sage startup (before importing anything to avoid running in the security issue).

That sounds like a good plan to me. Let me have a look at this tomorrow.



---

archive/issue_comments_407959.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@timokau](#comment:14):\n> Replying to [@saraedum](#comment:12):\n> > Replying to [@timokau](#comment:10):\n> > > The `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200\n\n> > I didn't know about this stuff\u2026that's horrifying :)\n> > \n> > > Other than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.\n\n> > \n> > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)\n\n> \n> Being able use `re` and access matches seems pretty essential to me, just removing the doctests wouldn't solve the problem.\n\nI don't think that I've ever used `re` in Sage. I think it's not really important in a math context. I think we could change the few doctests where we actually access a match with a Sage Integer to use named groups instead; and explain why that might be a better idea in the doctest. However, I have not had a look at these tests yet.",
    "created_at": "2018-10-10T22:56:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407959",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@timokau](#comment:14):
> Replying to [@saraedum](#comment:12):
> > Replying to [@timokau](#comment:10):
> > > The `re` one is hard. I think it is technically possible to monkey patch re, but it does require selling the soul of your firstborn since it is a builtin: https://gist.github.com/mahmoudimus/295200

> > I didn't know about this stuff…that's horrifying :)
> > 
> > > Other than that we could try to push upstream for a backport once again. Their reasoning is that the fix actually adds a feature instead of fixing a bug and only bugfixes are backported.

> > 
> > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)

> 
> Being able use `re` and access matches seems pretty essential to me, just removing the doctests wouldn't solve the problem.

I don't think that I've ever used `re` in Sage. I think it's not really important in a math context. I think we could change the few doctests where we actually access a match with a Sage Integer to use named groups instead; and explain why that might be a better idea in the doctest. However, I have not had a look at these tests yet.



---

archive/issue_comments_407960.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@saraedum](#comment:16):\n> I don't think that I've ever used `re` in Sage. \n\nOkay\n\n> I think it's not really important in a math context. \n\nFirst, I hope you're not just generalizing from your own experience: that is a dangerous thing to do. Second, it is used in the Sage library, for example for argument parsing or LaTeX stuff. And therefore, third, Sage is not just a math context; people use it for other things, such as developing Sage. When working on Sage development, I often have used `re`, and to be honest, until Sage was patched, it took me a long time to understand why `m = re.match(...)` seemed to work, but `m.group(0)` did not. I'm an experienced Sage user, but using `m.group(int(0))` was not obvious. If we just remove support for Sage integers in the `group` method, we will end up with some confused users.\n\nSo a strong -1 for removing this patch.",
    "created_at": "2018-10-10T23:24:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407960",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@saraedum](#comment:16):
> I don't think that I've ever used `re` in Sage. 

Okay

> I think it's not really important in a math context. 

First, I hope you're not just generalizing from your own experience: that is a dangerous thing to do. Second, it is used in the Sage library, for example for argument parsing or LaTeX stuff. And therefore, third, Sage is not just a math context; people use it for other things, such as developing Sage. When working on Sage development, I often have used `re`, and to be honest, until Sage was patched, it took me a long time to understand why `m = re.match(...)` seemed to work, but `m.group(0)` did not. I'm an experienced Sage user, but using `m.group(int(0))` was not obvious. If we just remove support for Sage integers in the `group` method, we will end up with some confused users.

So a strong -1 for removing this patch.



---

archive/issue_comments_407961.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@jhpalmieri](#comment:17):\n> [...]\n> So a strong -1 for removing this patch.\n\nI did not mean to remove this patch:\n> > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)\n\nI want to remove reliance on this patch from the Sage library so things work without it and change the doctests that rely on it/change them to #optional: python3.",
    "created_at": "2018-10-11T09:08:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407961",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@jhpalmieri](#comment:17):
> [...]
> So a strong -1 for removing this patch.

I did not mean to remove this patch:
> > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)

I want to remove reliance on this patch from the Sage library so things work without it and change the doctests that rely on it/change them to #optional: python3.



---

archive/issue_comments_407962.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@saraedum](#comment:18):\n> Replying to [@jhpalmieri](#comment:17):\n> > [...]\n> > So a strong -1 for removing this patch.\n\n> \n> I did not mean to remove this patch:\n> > > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)\n\n> \n> I want to remove reliance on this patch from the Sage library so things work without it and change the doctests that rely on it/change them to #optional: python3.\n\nThat is going in the direction of \"distribution of second class citizen\", with a feature (not a small one in my opinion) only working/tested on sage-the-distribution. I don't think removing a test for a valid use case is a good idea. At least I see value in that test for the nix package.",
    "created_at": "2018-10-12T18:12:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407962",
    "user": "https://github.com/timokau"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@saraedum](#comment:18):
> Replying to [@jhpalmieri](#comment:17):
> > [...]
> > So a strong -1 for removing this patch.

> 
> I did not mean to remove this patch:
> > > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)

> 
> I want to remove reliance on this patch from the Sage library so things work without it and change the doctests that rely on it/change them to #optional: python3.

That is going in the direction of "distribution of second class citizen", with a feature (not a small one in my opinion) only working/tested on sage-the-distribution. I don't think removing a test for a valid use case is a good idea. At least I see value in that test for the nix package.



---

archive/issue_comments_407963.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@timokau](#comment:19):\n> Replying to [@saraedum](#comment:18):\n> > Replying to [@jhpalmieri](#comment:17):\n> > > [...]\n> > > So a strong -1 for removing this patch.\n\n> > \n> > I did not mean to remove this patch:\n> > > > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)\n\n> > \n> > I want to remove reliance on this patch from the Sage library so things work without it and change the doctests that rely on it/change them to #optional: python3.\n\n> \n> That is going in the direction of \"distribution of second class citizen\", with a feature (not a small one in my opinion) only working/tested on sage-the-distribution. I don't think removing a test for a valid use case is a good idea. At least I see value in that test for the nix package.\n\nIn this case, I don't actually see this problem. We would be testing this for Python 3 at least which is where we are going to anyway. (We could of course add an additional test for `optional: sage-the-distribution`.)\n\nI might be wrong but I can't see that we could get the re patch into Debian or Conda (and I wouldn't even propose to try.) So, should Sage's documentation not be clear about the fact that this is a feature that may or may not work for you depending on how you are running Sage exactly? Doing a `optional: python3` therefore seems very reasonable to me.",
    "created_at": "2018-10-12T18:55:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407963",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@timokau](#comment:19):
> Replying to [@saraedum](#comment:18):
> > Replying to [@jhpalmieri](#comment:17):
> > > [...]
> > > So a strong -1 for removing this patch.

> > 
> > I did not mean to remove this patch:
> > > > Could we just change Sage and it's doctests to not to rely on this? (and keep the patch in the Sage-the-distribution.)

> > 
> > I want to remove reliance on this patch from the Sage library so things work without it and change the doctests that rely on it/change them to #optional: python3.

> 
> That is going in the direction of "distribution of second class citizen", with a feature (not a small one in my opinion) only working/tested on sage-the-distribution. I don't think removing a test for a valid use case is a good idea. At least I see value in that test for the nix package.

In this case, I don't actually see this problem. We would be testing this for Python 3 at least which is where we are going to anyway. (We could of course add an additional test for `optional: sage-the-distribution`.)

I might be wrong but I can't see that we could get the re patch into Debian or Conda (and I wouldn't even propose to try.) So, should Sage's documentation not be clear about the fact that this is a feature that may or may not work for you depending on how you are running Sage exactly? Doing a `optional: python3` therefore seems very reasonable to me.



---

archive/issue_comments_407964.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\n> In this case, I don't actually see this problem. We would be testing this for Python 3 at least which is where we are going to anyway. (We could of course add an additional test for `optional: sage-the-distribution`.)\n\nI think python3 is still going to take some time.\n\n> I might be wrong but I can't see that we could get the re patch into Debian or Conda (and I wouldn't even propose to try.) So, should Sage's documentation not be clear about the fact that this is a feature that may or may not work for you depending on how you are running Sage exactly? Doing a `optional: python3` therefore seems very reasonable to me.\n\nAre you sure? Its a very reasonable two line patch that has pretty much no backwards incompatibility problems and has been accepted for 3.x: https://bugs.python.org/file43084/re_match_index.patch\n\nHaving regex not work would be confusing for users.",
    "created_at": "2018-10-12T19:40:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407964",
    "user": "https://github.com/timokau"
}
```

<div id="comment:21" align="right">comment:21</div>

> In this case, I don't actually see this problem. We would be testing this for Python 3 at least which is where we are going to anyway. (We could of course add an additional test for `optional: sage-the-distribution`.)

I think python3 is still going to take some time.

> I might be wrong but I can't see that we could get the re patch into Debian or Conda (and I wouldn't even propose to try.) So, should Sage's documentation not be clear about the fact that this is a feature that may or may not work for you depending on how you are running Sage exactly? Doing a `optional: python3` therefore seems very reasonable to me.

Are you sure? Its a very reasonable two line patch that has pretty much no backwards incompatibility problems and has been accepted for 3.x: https://bugs.python.org/file43084/re_match_index.patch

Having regex not work would be confusing for users.



---

archive/issue_comments_407965.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nHaven't read all the discussion yet, but definitely +1.",
    "created_at": "2018-10-28T16:45:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407965",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">comment:22</div>

Haven't read all the discussion yet, but definitely +1.



---

archive/issue_events_366189.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T11:09:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366189"
}
```



---

archive/issue_events_366190.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-03-25T11:09:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/wishlist%20item",
    "label_color": "e81ff9",
    "label_name": "wishlist item",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366190"
}
```



---

archive/issue_comments_407966.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nWhere does this stand with Python 2 support dropped?",
    "created_at": "2020-09-11T01:42:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407966",
    "user": "https://github.com/slel"
}
```

<div id="comment:24" align="right">comment:24</div>

Where does this stand with Python 2 support dropped?



---

archive/issue_comments_407967.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nWell, I am using python 3.7 and 3.8 from the dsitro in sage-on-gentoo, without needing additional patches. Prior to the move to python3 I needed to provide a patched python 2.7 for sage-on-gentoo.\n\nNot anymore. \n\nI'd say it is obsolete.",
    "created_at": "2020-09-11T01:46:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407967",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:25" align="right">comment:25</div>

Well, I am using python 3.7 and 3.8 from the dsitro in sage-on-gentoo, without needing additional patches. Prior to the move to python3 I needed to provide a patched python 2.7 for sage-on-gentoo.

Not anymore. 

I'd say it is obsolete.



---

archive/issue_comments_407968.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nMost of the existing patches look like they're cygwin-related. Unless I'm misreading things, `linux_linking_issue_25229.patch` is the one exception, but I don't know what it's for. I guess it comes from https://bugs.python.org/issue25229. Looks like it might be merged soon?\n\n(And I know nothing about cygwin, so I don't know if those patches are still necessary.)",
    "created_at": "2020-09-11T02:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407968",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:26" align="right">comment:26</div>

Most of the existing patches look like they're cygwin-related. Unless I'm misreading things, `linux_linking_issue_25229.patch` is the one exception, but I don't know what it's for. I guess it comes from https://bugs.python.org/issue25229. Looks like it might be merged soon?

(And I know nothing about cygwin, so I don't know if those patches are still necessary.)



---

archive/issue_comments_407969.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jhpalmieri](#comment:26):\n> Most of the existing patches look like they're cygwin-related. Unless I'm misreading things, `linux_linking_issue_25229.patch` is the one exception, but I don't know what it's for. I guess it comes from https://bugs.python.org/issue25229. Looks like it might be merged soon?\n> \n> (And I know nothing about cygwin, so I don't know if those patches are still necessary.)\n\nI know nothing about cygwin either. I do remember pottering with a linking issue when using clang on linux in some cases. So, I am probably responsible for bringing that one in. Distros may very well already deal with that particular one.",
    "created_at": "2020-09-11T03:56:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407969",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jhpalmieri](#comment:26):
> Most of the existing patches look like they're cygwin-related. Unless I'm misreading things, `linux_linking_issue_25229.patch` is the one exception, but I don't know what it's for. I guess it comes from https://bugs.python.org/issue25229. Looks like it might be merged soon?
> 
> (And I know nothing about cygwin, so I don't know if those patches are still necessary.)

I know nothing about cygwin either. I do remember pottering with a linking issue when using clang on linux in some cases. So, I am probably responsible for bringing that one in. Distros may very well already deal with that particular one.



---

archive/issue_comments_407970.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI think this ticket can be closed as outdated.",
    "created_at": "2021-01-10T18:45:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26457#issuecomment-407970",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

I think this ticket can be closed as outdated.



---

archive/issue_events_366191.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-10T18:45:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366191"
}
```



---

archive/issue_events_366192.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-10T18:45:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366192"
}
```



---

archive/issue_events_366193.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-10T18:45:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366193"
}
```



---

archive/issue_events_366194.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-10T18:45:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/wishlist%20item",
    "label_color": "e81ff9",
    "label_name": "wishlist item",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366194"
}
```



---

archive/issue_events_366195.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-10T18:45:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "c6c6c6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366195"
}
```



---

archive/issue_events_366196.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-01-11T18:54:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366196"
}
```



---

archive/issue_events_366197.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-01-11T18:54:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366197"
}
```



---

archive/issue_events_366198.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-02-26T13:59:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366198"
}
```



---

archive/issue_events_366199.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-02-26T13:59:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26457",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26457#event-366199"
}
```
