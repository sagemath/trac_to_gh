# Issue 26931: Predictable sorting in simplicial_complex.py

archive/issues_026694.json:
```json
{
    "body": "#25932 introduced code of the form\n\n```\ntry:\n    vertices = tuple(sorted(vertex_set))\nexcept TypeError:\n    vertices = tuple(sorted(vertex_set, key=str))\n```\nThe problem here is that sorting is not predictable: adding a vertex or considering a face containing only sortable vertices could suddenly change the ordering.\n\nInstead, the sorting key should be explicitly given and the same key should always be used for the same simplicial complex.\n\nCC:  @jhpalmieri\n\nReviewer: John Palmieri\n\nAuthor: Jeroen Demeyer\n\nBranch: 154b61536b55faca6f507c688881570fdc5812f8\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26931\n\n",
    "closed_at": "2018-12-23T23:39:25Z",
    "created_at": "2018-12-21T12:50:24Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "Predictable sorting in simplicial_complex.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26931",
    "user": "https://github.com/jdemeyer"
}
```
#25932 introduced code of the form

```
try:
    vertices = tuple(sorted(vertex_set))
except TypeError:
    vertices = tuple(sorted(vertex_set, key=str))
```
The problem here is that sorting is not predictable: adding a vertex or considering a face containing only sortable vertices could suddenly change the ordering.

Instead, the sorting key should be explicitly given and the same key should always be used for the same simplicial complex.

CC:  @jhpalmieri

Reviewer: John Palmieri

Author: Jeroen Demeyer

Branch: 154b61536b55faca6f507c688881570fdc5812f8

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26931





---

archive/issue_comments_517527.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,11 @@\n+#25932 introduced code of the form\n \n+```\n+try:\n+    vertices = tuple(sorted(vertex_set))\n+except TypeError:\n+    vertices = tuple(sorted(vertex_set, key=str))\n+```\n+The problem here is that sorting is not predictable: adding a vertex or considering a subset of vertices could suddenly change the sorting.\n+\n+Instead, the sorting key should be explicitly given and the same key should always be used for the same simplicial complex.\n``````\n",
    "created_at": "2018-12-21T12:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517527",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,11 @@
+#25932 introduced code of the form
 
+```
+try:
+    vertices = tuple(sorted(vertex_set))
+except TypeError:
+    vertices = tuple(sorted(vertex_set, key=str))
+```
+The problem here is that sorting is not predictable: adding a vertex or considering a subset of vertices could suddenly change the sorting.
+
+Instead, the sorting key should be explicitly given and the same key should always be used for the same simplicial complex.
``````




---

archive/issue_comments_517528.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,6 +6,6 @@\n except TypeError:\n     vertices = tuple(sorted(vertex_set, key=str))\n ```\n-The problem here is that sorting is not predictable: adding a vertex or considering a subset of vertices could suddenly change the sorting.\n+The problem here is that sorting is not predictable: adding a vertex or considering a face containing only sortable vertices could suddenly change the ordering.\n \n Instead, the sorting key should be explicitly given and the same key should always be used for the same simplicial complex.\n``````\n",
    "created_at": "2018-12-21T13:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517528",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,6 +6,6 @@
 except TypeError:
     vertices = tuple(sorted(vertex_set, key=str))
 ```
-The problem here is that sorting is not predictable: adding a vertex or considering a subset of vertices could suddenly change the sorting.
+The problem here is that sorting is not predictable: adding a vertex or considering a face containing only sortable vertices could suddenly change the ordering.
 
 Instead, the sorting key should be explicitly given and the same key should always be used for the same simplicial complex.
``````




---

archive/issue_comments_517529.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jdemeyer/predictable_sorting_in_simplicial_complex_py\"",
    "created_at": "2018-12-21T13:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517529",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "" to "u/jdemeyer/predictable_sorting_in_simplicial_complex_py"



---

archive/issue_comments_517530.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2018-12-21T13:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517530",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_517531.json:
```json
{
    "body": "Changing commit from \"\" to \"0e6b70ad657f257bed7c97e4fbcd31c6f430f566\"",
    "created_at": "2018-12-21T13:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517531",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "" to "0e6b70ad657f257bed7c97e4fbcd31c6f430f566"



---

archive/issue_comments_517532.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-21T13:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517532",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_517533.json:
```json
{
    "body": "<a id='comment:5'></a>I feel like a need a style guide. Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type? I don't remember seeing that before.\n\nI think that the new doctest\n\n```\n+        The vertices can be sorted with a custom key::\n+\n+            sage: SimplicialComplex([10], sort_facets=str)\n+            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}\n```\nshould be at the class level so it appears in the reference manual.",
    "created_at": "2018-12-21T20:14:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517533",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>I feel like a need a style guide. Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type? I don't remember seeing that before.

I think that the new doctest

```
+        The vertices can be sorted with a custom key::
+
+            sage: SimplicialComplex([10], sort_facets=str)
+            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}
```
should be at the class level so it appears in the reference manual.



---

archive/issue_comments_517534.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [jhpalmieri](#comment%3A5):\n> I don't remember seeing that before.\n\n\nIt's implicit in a lot of Cython code. But you're right that maybe no Python code in Sage uses it so far.",
    "created_at": "2018-12-21T20:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517534",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Replying to [jhpalmieri](#comment%3A5):
> I don't remember seeing that before.


It's implicit in a lot of Cython code. But you're right that maybe no Python code in Sage uses it so far.



---

archive/issue_comments_517535.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [jhpalmieri](#comment%3A5):\n> Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type?\n\n\nIt's also generally not needed in Sage since we typically convert to a Sage `Integer`, not a Python `int`. However, `range()` requires an `int`.",
    "created_at": "2018-12-21T20:25:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517535",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>Replying to [jhpalmieri](#comment%3A5):
> Is `operator.index(a)` the way we should be checking whether `a` is an `int` or an `Integer` or other suitable type?


It's also generally not needed in Sage since we typically convert to a Sage `Integer`, not a Python `int`. However, `range()` requires an `int`.



---

archive/issue_comments_517536.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-22T15:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517536",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_517537.json:
```json
{
    "body": "Changing commit from \"0e6b70ad657f257bed7c97e4fbcd31c6f430f566\" to \"154b61536b55faca6f507c688881570fdc5812f8\"",
    "created_at": "2018-12-22T15:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517537",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0e6b70ad657f257bed7c97e4fbcd31c6f430f566" to "154b61536b55faca6f507c688881570fdc5812f8"



---

archive/issue_comments_517538.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [jhpalmieri](#comment%3A5):\n> I think that the new doctest\n> \n> ```\n> +        The vertices can be sorted with a custom key::\n> +\n> +            sage: SimplicialComplex([10], sort_facets=str)\n> +            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}\n> ```\n> should be at the class level so it appears in the reference manual. \n\n\nDone.",
    "created_at": "2018-12-22T15:47:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517538",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>Replying to [jhpalmieri](#comment%3A5):
> I think that the new doctest
> 
> ```
> +        The vertices can be sorted with a custom key::
> +
> +            sage: SimplicialComplex([10], sort_facets=str)
> +            Simplicial complex with 11 vertices and facets {(0, 1, 10, 2, 3, 4, 5, 6, 7, 8, 9)}
> ```
> should be at the class level so it appears in the reference manual. 


Done.



---

archive/issue_comments_517539.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-22T21:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517539",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_517540.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2018-12-22T21:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517540",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_517541.json:
```json
{
    "body": "<a id='comment:10'></a>Great, thanks.",
    "created_at": "2018-12-22T21:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517541",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>Great, thanks.



---

archive/issue_comments_517542.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-23T23:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517542",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_517543.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/predictable_sorting_in_simplicial_complex_py\" to \"154b61536b55faca6f507c688881570fdc5812f8\"",
    "created_at": "2018-12-23T23:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517543",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/predictable_sorting_in_simplicial_complex_py" to "154b61536b55faca6f507c688881570fdc5812f8"



---

archive/issue_events_066700.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:39:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26931#event-66700"
}
```



---

archive/issue_comments_517544.json:
```json
{
    "body": "Changing commit from \"154b61536b55faca6f507c688881570fdc5812f8\" to \"\"",
    "created_at": "2018-12-28T22:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517544",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "154b61536b55faca6f507c688881570fdc5812f8" to ""



---

archive/issue_comments_517545.json:
```json
{
    "body": "<a id='comment:12'></a>I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.",
    "created_at": "2018-12-28T22:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517545",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.



---

archive/issue_comments_517546.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [jhpalmieri](#comment%3A12):\n> I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.\n\n\nEven then, I still think that this ticket is an improvement. The changes to the code make sense, so it should just be a matter of specifying the appropriate sorting key.",
    "created_at": "2018-12-29T10:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517546",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>Replying to [jhpalmieri](#comment%3A12):
> I was too quick on the positive review. This causes a lot of Python 3 test failures: see #26966.


Even then, I still think that this ticket is an improvement. The changes to the code make sense, so it should just be a matter of specifying the appropriate sorting key.



---

archive/issue_comments_517547.json:
```json
{
    "body": "<a id='comment:14'></a>Okay, what is the appropriate sorting key? For example, if you take the disjoint union of two simplicial complexes which use different sorting keys, how do you sort the result?\n\nWe can put bandaids on this for now, and on one hand, with a few changes, I can decrease the number of failures quite a bit, so that it fixes not just the problems caused by this ticket but (combined with your changes) fixes other problems, too. On the other hand, the whole thing looks very fragile: someone could very easily construct simplicial complexes which break sorting, and once the sorting is lost, homology calculations are unreliable.\n\nSo I am not convinced that this ticket as it stands is an improvement. \n\nOne way to fix could be to create new classes for each construction, like `DisjointUnion`, which keeps track of the factors and sorts in each factor separately. I am very much tempted to roll back this ticket and leave it open as a future enhancement.\n\nHere are some methods which need attention:\n- product\n- join\n- disjoint_union\n- wedge\n- connected_sum\n- link\n- star\n- generated_subcomplex\n- alexander_dual\n- stellar_subdivision\n- n_skeleton\n- connected_component\n- fixed_complex\n- intersection\n- `_contractible_subcomplex`\n- `_enlarge_subcomplex`\n- `__copy__`\n\nand there are probably others",
    "created_at": "2018-12-29T19:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26931",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26931#issuecomment-517547",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:14'></a>Okay, what is the appropriate sorting key? For example, if you take the disjoint union of two simplicial complexes which use different sorting keys, how do you sort the result?

We can put bandaids on this for now, and on one hand, with a few changes, I can decrease the number of failures quite a bit, so that it fixes not just the problems caused by this ticket but (combined with your changes) fixes other problems, too. On the other hand, the whole thing looks very fragile: someone could very easily construct simplicial complexes which break sorting, and once the sorting is lost, homology calculations are unreliable.

So I am not convinced that this ticket as it stands is an improvement. 

One way to fix could be to create new classes for each construction, like `DisjointUnion`, which keeps track of the factors and sorts in each factor separately. I am very much tempted to roll back this ticket and leave it open as a future enhancement.

Here are some methods which need attention:
- product
- join
- disjoint_union
- wedge
- connected_sum
- link
- star
- generated_subcomplex
- alexander_dual
- stellar_subdivision
- n_skeleton
- connected_component
- fixed_complex
- intersection
- `_contractible_subcomplex`
- `_enlarge_subcomplex`
- `__copy__`

and there are probably others
