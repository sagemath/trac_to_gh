# Issue 26795: Some memory leaks

archive/issues_026558.json:
```json
{
    "body": "(Add more leaks here. But not the one that is taken care in #26794)\n\nFirst one, handled at #26796\n\n```\ndef bad8(n):\n    from sage.graphs.independent_sets import IndependentSets\n    G = Graph(2)\n    for i in range(n):\n        x = [0] in IndependentSets(G)\n        if i % 10000 == 0:\n            print get_memory_usage()\n\nbad8(100000)\n```\n\nSecond, in #26806: Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.\n\nThird: Also `dimension()` of posets seems to have a leak. Root cause might be something already corrected.\n\nMore in comments.\n\nCC:  @mkoeppe\n\nBranch/Commit: f786410df2a639ad1e95fc7c78e09b851c02d572\n\nReviewer: Jori M\u00e4ntysalo\n\nAuthor: Dima Pasechnik\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26795\n\n",
    "closed_at": "2018-12-07T12:10:30Z",
    "created_at": "2018-12-01T16:22:13Z",
    "labels": [
        "component: memleak",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Some memory leaks",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26795",
    "user": "https://github.com/jm58660"
}
```
(Add more leaks here. But not the one that is taken care in #26794)

First one, handled at #26796

```
def bad8(n):
    from sage.graphs.independent_sets import IndependentSets
    G = Graph(2)
    for i in range(n):
        x = [0] in IndependentSets(G)
        if i % 10000 == 0:
            print get_memory_usage()

bad8(100000)
```

Second, in #26806: Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.

Third: Also `dimension()` of posets seems to have a leak. Root cause might be something already corrected.

More in comments.

CC:  @mkoeppe

Branch/Commit: f786410df2a639ad1e95fc7c78e09b851c02d572

Reviewer: Jori Mäntysalo

Author: Dima Pasechnik

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26795





---

archive/issue_comments_514674.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,6 +12,8 @@\n bad8(100000)\n ```\n \n+Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/26795\n``````\n",
    "created_at": "2018-12-01T16:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514674",
    "user": "https://github.com/jm58660"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,6 +12,8 @@
 bad8(100000)
 ```
 
+Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/26795
``````




---

archive/issue_comments_514675.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,18 @@\n+(Add more leaks here. But not the one that is taken care in #26794)\n \n+```\n+def bad8(n):\n+    from sage.graphs.independent_sets import IndependentSets\n+    G = Graph(2)\n+    for i in range(n):\n+        x = [0] in IndependentSets(G)\n+        if i % 10000 == 0:\n+            print get_memory_usage()\n+\n+bad8(100000)\n+```\n+\n+Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-12-01T16:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514675",
    "user": "https://github.com/jm58660"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,18 @@
+(Add more leaks here. But not the one that is taken care in #26794)
 
+```
+def bad8(n):
+    from sage.graphs.independent_sets import IndependentSets
+    G = Graph(2)
+    for i in range(n):
+        x = [0] in IndependentSets(G)
+        if i % 10000 == 0:
+            print get_memory_usage()
+
+bad8(100000)
+```
+
+Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.
 
 Comment: 1
 
``````




---

archive/issue_comments_514676.json:
```json
{
    "body": "<a id='comment:3'></a>fixing the `IndependentSets` leak is more tricky: how can I deallocate the memory of a variable local to the generator?  (It has to be local, because one may want to have two iterators over the independent sets, see the doctest of the method.)",
    "created_at": "2018-12-01T19:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514676",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:3'></a>fixing the `IndependentSets` leak is more tricky: how can I deallocate the memory of a variable local to the generator?  (It has to be local, because one may want to have two iterators over the independent sets, see the doctest of the method.)



---

archive/issue_comments_514677.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 mantepse]:\n> fixing the `IndependentSets` leak is more tricky: how can I deallocate the memory of a variable local to the generator?  (It has to be local, because one may want to have two iterators over the independent sets, see the doctest of the method.)\n\n\nTrying to understand... So every call to `iter()` will create kind of \"implicit object\" by calling `__iter__()` that by design of `yield` statement will create a state for an iterator. But because it is \"implicit\", there can no explicit destructor? Then the iterator must add a back-reference to some class variable, I guess. Something like\n\n```\nclass Foo:\n    sometype refs\n    def __init__():\n        refs = []\n    def __iter__():\n        x = reserve_memory()\n        refs.append(x)\n        . . .\n    def __dealloc__():\n        for x in refs:\n            release_memory(x)\n```",
    "created_at": "2018-12-01T19:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514677",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:4'></a>Replying to [comment:3 mantepse]:
> fixing the `IndependentSets` leak is more tricky: how can I deallocate the memory of a variable local to the generator?  (It has to be local, because one may want to have two iterators over the independent sets, see the doctest of the method.)


Trying to understand... So every call to `iter()` will create kind of "implicit object" by calling `__iter__()` that by design of `yield` statement will create a state for an iterator. But because it is "implicit", there can no explicit destructor? Then the iterator must add a back-reference to some class variable, I guess. Something like

```
class Foo:
    sometype refs
    def __init__():
        refs = []
    def __iter__():
        x = reserve_memory()
        refs.append(x)
        . . .
    def __dealloc__():
        for x in refs:
            release_memory(x)
```



---

archive/issue_comments_514678.json:
```json
{
    "body": "<a id='comment:5'></a>It was actually quite easy, see #26796",
    "created_at": "2018-12-01T20:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514678",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:5'></a>It was actually quite easy, see #26796



---

archive/issue_comments_514679.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 mantepse]:\n> It was actually quite easy, see #26796\n\n\nAh, of course. `finally` is always called.",
    "created_at": "2018-12-01T20:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514679",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:6'></a>Replying to [comment:5 mantepse]:
> It was actually quite easy, see #26796


Ah, of course. `finally` is always called.



---

archive/issue_comments_514680.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,22 @@\n+(Add more leaks here. But not the one that is taken care in #26794)\n+\n+First one, handled at #26796\n+\n+```\n+def bad8(n):\n+    from sage.graphs.independent_sets import IndependentSets\n+    G = Graph(2)\n+    for i in range(n):\n+        x = [0] in IndependentSets(G)\n+        if i % 10000 == 0:\n+            print get_memory_usage()\n+\n+bad8(100000)\n+```\n+\n+Second: Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.\n+\n+Third: Also `dimension()` of posets seems to have a leak. Root cause might be something already corrected.\n \n \n Comment: 1\n``````\n",
    "created_at": "2018-12-01T20:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514680",
    "user": "https://github.com/jm58660"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,22 @@
+(Add more leaks here. But not the one that is taken care in #26794)
+
+First one, handled at #26796
+
+```
+def bad8(n):
+    from sage.graphs.independent_sets import IndependentSets
+    G = Graph(2)
+    for i in range(n):
+        x = [0] in IndependentSets(G)
+        if i % 10000 == 0:
+            print get_memory_usage()
+
+bad8(100000)
+```
+
+Second: Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.
+
+Third: Also `dimension()` of posets seems to have a leak. Root cause might be something already corrected.
 
 
 Comment: 1
``````




---

archive/issue_comments_514681.json:
```json
{
    "body": "<a id='comment:7'></a>`add_col()` in `src/sage/numerical/backends/glpk_backend.pyx` contains\n\n```\ncol_i = <int *> sig_malloc((len(indices)+1) * sizeof(int))\ncol_values = <double *> sig_malloc((len(indices)+1) * sizeof(double))\n```\n\nWhere are those freed?",
    "created_at": "2018-12-02T06:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514681",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:7'></a>`add_col()` in `src/sage/numerical/backends/glpk_backend.pyx` contains

```
col_i = <int *> sig_malloc((len(indices)+1) * sizeof(int))
col_values = <double *> sig_malloc((len(indices)+1) * sizeof(double))
```

Where are those freed?



---

archive/issue_comments_514682.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 jmantysalo]:\n> `add_col()` in `src/sage/numerical/backends/glpk_backend.pyx` contains\n> \n> \n> ```\n> col_i = <int *> sig_malloc((len(indices)+1) * sizeof(int))\n> col_values = <double *> sig_malloc((len(indices)+1) * sizeof(double))\n> ```\n> \n> Where are those freed?\n\n\nit appears they can (and must!) be freed at the end of this function, as glpk copies all that data, and not re-uses it later.",
    "created_at": "2018-12-02T10:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514682",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>Replying to [comment:7 jmantysalo]:
> `add_col()` in `src/sage/numerical/backends/glpk_backend.pyx` contains
> 
> 
> ```
> col_i = <int *> sig_malloc((len(indices)+1) * sizeof(int))
> col_values = <double *> sig_malloc((len(indices)+1) * sizeof(double))
> ```
> 
> Where are those freed?


it appears they can (and must!) be freed at the end of this function, as glpk copies all that data, and not re-uses it later.



---

archive/issue_comments_514683.json:
```json
{
    "body": "<a id='comment:9'></a>I tried running tests with the following patch, and it does not appear to break anything:\n\n```diff\ndiff --git a/src/sage/numerical/backends/glpk_backend.pyx b/src/sage/numerical/backends/glpk_backend.pyx\nindex 738365b608..6de416afdf 100644\n--- a/src/sage/numerical/backends/glpk_backend.pyx\n+++ b/src/sage/numerical/backends/glpk_backend.pyx\n@@ -831,6 +831,8 @@ cdef class GLPKBackend(GenericBackend):\n \n         glp_set_mat_col(self.lp, n, len(indices), col_i, col_values)\n         glp_set_col_bnds(self.lp, n, GLP_LO, 0,0)\n+        sig_free(col_i)\n+        sig_free(col_values)\n \n \n     cpdef int solve(self) except -1:\n```",
    "created_at": "2018-12-02T12:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514683",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>I tried running tests with the following patch, and it does not appear to break anything:

```diff
diff --git a/src/sage/numerical/backends/glpk_backend.pyx b/src/sage/numerical/backends/glpk_backend.pyx
index 738365b608..6de416afdf 100644
--- a/src/sage/numerical/backends/glpk_backend.pyx
+++ b/src/sage/numerical/backends/glpk_backend.pyx
@@ -831,6 +831,8 @@ cdef class GLPKBackend(GenericBackend):
 
         glp_set_mat_col(self.lp, n, len(indices), col_i, col_values)
         glp_set_col_bnds(self.lp, n, GLP_LO, 0,0)
+        sig_free(col_i)
+        sig_free(col_values)
 
 
     cpdef int solve(self) except -1:
```



---

archive/issue_comments_514684.json:
```json
{
    "body": "<a id='comment:10'></a>Perhaps mkoeppe can confirm whether this is a bug in GLPK backend.",
    "created_at": "2018-12-02T12:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514684",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>Perhaps mkoeppe can confirm whether this is a bug in GLPK backend.



---

archive/issue_comments_514685.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 dimpase]:\n\n> I tried running tests with the following patch, and it does not appear to break anything:\n\n\nIs this the one that is responsible for leak in `dimension()` of poset?",
    "created_at": "2018-12-02T13:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514685",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:11'></a>Replying to [comment:9 dimpase]:

> I tried running tests with the following patch, and it does not appear to break anything:


Is this the one that is responsible for leak in `dimension()` of poset?



---

archive/issue_comments_514686.json:
```json
{
    "body": "<a id='comment:12'></a>I think the poset thing is fixed by #26796.\n\nBut the patch I just posted is surely needed - you can see it fixes the following leak:\n\n```\nsage: def bad99(n):\n....:     from sage.numerical.backends.generic_backend import get_solver\n....:     for i in range(n):\n....:         p = get_solver(solver = \"GLPK\")\n....:         p.add_linear_constraints(5, 0, None)\n....:         p.add_col(range(5), range(5))\n....:         if i % 10000 == 0:\n....:             print get_memory_usage()\n....: \n....: bad99(100000)\n```",
    "created_at": "2018-12-02T15:52:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514686",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>I think the poset thing is fixed by #26796.

But the patch I just posted is surely needed - you can see it fixes the following leak:

```
sage: def bad99(n):
....:     from sage.numerical.backends.generic_backend import get_solver
....:     for i in range(n):
....:         p = get_solver(solver = "GLPK")
....:         p.add_linear_constraints(5, 0, None)
....:         p.add_col(range(5), range(5))
....:         if i % 10000 == 0:
....:             print get_memory_usage()
....: 
....: bad99(100000)
```



---

archive/issue_comments_514687.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-02T16:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514687",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_514688.json:
```json
{
    "body": "<a id='comment:13'></a>New commits:",
    "created_at": "2018-12-02T16:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514688",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>New commits:



---

archive/issue_comments_514689.json:
```json
{
    "body": "Changing author from \"\" to \"Dima Pasechnik\"",
    "created_at": "2018-12-02T16:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514689",
    "user": "https://github.com/dimpase"
}
```

Changing author from "" to "Dima Pasechnik"



---

archive/issue_comments_514690.json:
```json
{
    "body": "Changing commit from \"\" to \"3c5e849e04cb4f8e14f78da5af60159dcad67836\"",
    "created_at": "2018-12-02T16:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514690",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "" to "3c5e849e04cb4f8e14f78da5af60159dcad67836"



---

archive/issue_comments_514691.json:
```json
{
    "body": "Changing branch from \"\" to \"public/packages/glpkbackendmemleak\"",
    "created_at": "2018-12-02T16:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514691",
    "user": "https://github.com/dimpase"
}
```

Changing branch from "" to "public/packages/glpkbackendmemleak"



---

archive/issue_comments_514692.json:
```json
{
    "body": "<a id='comment:14'></a>a similar bug seems to be in `add_col` coin backend...",
    "created_at": "2018-12-02T16:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514692",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>a similar bug seems to be in `add_col` coin backend...



---

archive/issue_comments_514693.json:
```json
{
    "body": "<a id='comment:15'></a>Someone should check `src/sage/matroids/basis_matroid.pyx` and make a ticket for that if needed before closing this one, as otherwise we may forgot that.",
    "created_at": "2018-12-02T18:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514693",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:15'></a>Someone should check `src/sage/matroids/basis_matroid.pyx` and make a ticket for that if needed before closing this one, as otherwise we may forgot that.



---

archive/issue_comments_514694.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-12-02T18:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514694",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_514695.json:
```json
{
    "body": "Changing commit from \"3c5e849e04cb4f8e14f78da5af60159dcad67836\" to \"c407d99c3d3a8302f1f0519702935a4049406ceb\"",
    "created_at": "2018-12-02T23:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514695",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3c5e849e04cb4f8e14f78da5af60159dcad67836" to "c407d99c3d3a8302f1f0519702935a4049406ceb"



---

archive/issue_comments_514696.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-02T23:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514696",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_514697.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 jmantysalo]:\n> Someone should check `src/sage/matroids/basis_matroid.pyx` and make a ticket for that if needed before closing this one, as otherwise we may forgot that.\n\n\nCoin backend hopefully fixed too.\n\nPlease post the code showing the leak in basis_matroid",
    "created_at": "2018-12-02T23:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514697",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>Replying to [comment:15 jmantysalo]:
> Someone should check `src/sage/matroids/basis_matroid.pyx` and make a ticket for that if needed before closing this one, as otherwise we may forgot that.


Coin backend hopefully fixed too.

Please post the code showing the leak in basis_matroid



---

archive/issue_comments_514698.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 dimpase]:\n\n> Please post the code showing the leak in basis_matroid\n\n\n```\nfrom sage.matroids.advanced import *\nimport gc\n\ni = 0\nwhile True:\n    if i%1000==0: print get_memory_usage()\n    i += 1\n    M = BasisMatroid(matroids.named_matroids.NonFano())\n    N = BasisMatroid(matroids.named_matroids.Fano())\n    m = {e:e for e in M.groundset()}\n    M._is_relaxation(N, m)\n    N._is_relaxation(M, m)\n```",
    "created_at": "2018-12-03T07:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514698",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:18'></a>Replying to [comment:17 dimpase]:

> Please post the code showing the leak in basis_matroid


```
from sage.matroids.advanced import *
import gc

i = 0
while True:
    if i%1000==0: print get_memory_usage()
    i += 1
    M = BasisMatroid(matroids.named_matroids.NonFano())
    N = BasisMatroid(matroids.named_matroids.Fano())
    m = {e:e for e in M.groundset()}
    M._is_relaxation(N, m)
    N._is_relaxation(M, m)
```



---

archive/issue_comments_514699.json:
```json
{
    "body": "<a id='comment:19'></a>regarding Poset dimension. It seems it's already a problem in the beginning of the function:\n\n```python\nimport gc\nfrom sage.graphs.comparability import greedy_is_comparability as is_comparability\ni = 0                                                                            \nfor P in Posets(8):\n    if i % 1000 == 0:\n        gc.collect()\n        print get_memory_usage()\n    i += 1\n    _ = is_comparability(P._hasse_diagram.transitive_closure().to_undirected().complement())            \n```\n\nIf I remove the call to `is_comparability()` the problem is gone here.",
    "created_at": "2018-12-03T10:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514699",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>regarding Poset dimension. It seems it's already a problem in the beginning of the function:

```python
import gc
from sage.graphs.comparability import greedy_is_comparability as is_comparability
i = 0                                                                            
for P in Posets(8):
    if i % 1000 == 0:
        gc.collect()
        print get_memory_usage()
    i += 1
    _ = is_comparability(P._hasse_diagram.transitive_closure().to_undirected().complement())            
```

If I remove the call to `is_comparability()` the problem is gone here.



---

archive/issue_comments_514700.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 dimpase]:\n\n> If I remove the call to `is_comparability()` the problem is gone here.\n\n\nBut if I change the line to be only `is_comparability()`, then there is no problem. Uh, a hard one is this.",
    "created_at": "2018-12-03T11:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514700",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:20'></a>Replying to [comment:19 dimpase]:

> If I remove the call to `is_comparability()` the problem is gone here.


But if I change the line to be only `is_comparability()`, then there is no problem. Uh, a hard one is this.



---

archive/issue_comments_514701.json:
```json
{
    "body": "<a id='comment:21'></a>What's this:\n\n```\nimport gc\n\ni = 0\nGG = graphs()\n_ = next(GG); _ = next(GG); \nfor P in GG:\n    if i > 20000: break\n    if i % 1000 == 0:\n        _ = gc.collect()\n        print get_memory_usage(), P.order()\n    i += 1\n    _ = P.convexity_properties()\n```\n\n??? There is an explicit `__destruct__` in class `ConvexityProperties`.",
    "created_at": "2018-12-03T11:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514701",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:21'></a>What's this:

```
import gc

i = 0
GG = graphs()
_ = next(GG); _ = next(GG); 
for P in GG:
    if i > 20000: break
    if i % 1000 == 0:
        _ = gc.collect()
        print get_memory_usage(), P.order()
    i += 1
    _ = P.convexity_properties()
```

??? There is an explicit `__destruct__` in class `ConvexityProperties`.



---

archive/issue_comments_514702.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 jmantysalo]:\n> Replying to [comment:19 dimpase]:\n> \n> > If I remove the call to `is_comparability()` the problem is gone here.\n\n> \n> But if I change the line to be only `is_comparability()`, then there is no problem. Uh, a hard one is this.\n\n\nBy the way, (with `_ = ...` present) do you notice that it stabilises approximately half-way, stops growing? Feels like an internal cache somewhere fills in, and then it's full, so no extra growth...",
    "created_at": "2018-12-03T11:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514702",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>Replying to [comment:20 jmantysalo]:
> Replying to [comment:19 dimpase]:
> 
> > If I remove the call to `is_comparability()` the problem is gone here.

> 
> But if I change the line to be only `is_comparability()`, then there is no problem. Uh, a hard one is this.


By the way, (with `_ = ...` present) do you notice that it stabilises approximately half-way, stops growing? Feels like an internal cache somewhere fills in, and then it's full, so no extra growth...



---

archive/issue_comments_514703.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 dimpase]:\n\n> By the way, (with `_ = ...` present) do you notice that it stabilises approximately half-way, stops growing? Feels like an internal cache somewhere fills in, and then it's full, so no extra growth...\n\n\nYes, I have noticed that. And sometime the grow stalls for a while and then continues.\n\nI guess that Python runs malloc() at C-level with some kind of heuristics, \"the user will propably ask for more soon anyways\".",
    "created_at": "2018-12-03T11:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514703",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:23'></a>Replying to [comment:22 dimpase]:

> By the way, (with `_ = ...` present) do you notice that it stabilises approximately half-way, stops growing? Feels like an internal cache somewhere fills in, and then it's full, so no extra growth...


Yes, I have noticed that. And sometime the grow stalls for a while and then continues.

I guess that Python runs malloc() at C-level with some kind of heuristics, "the user will propably ask for more soon anyways".



---

archive/issue_comments_514704.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:21 jmantysalo]:\n> What's this:\n> \n> \n> ```\n> import gc\n> \n> i = 0\n> GG = graphs()\n> _ = next(GG); _ = next(GG); \n> for P in GG:\n>     if i > 20000: break\n>     if i % 1000 == 0:\n>         _ = gc.collect()\n>         print get_memory_usage(), P.order()\n>     i += 1\n>     _ = P.convexity_properties()\n> ```\n> \n> ??? There is an explicit `__destruct__` in class `ConvexityProperties`.\n\n\nI've noticed this one missing:\n\n```diff\ndiff --git a/src/sage/graphs/convexity_properties.pyx b/src/sage/graphs/convexity_properties.pyx\nindex 474eb0e4cf..6b66e77a39 100644\n--- a/src/sage/graphs/convexity_properties.pyx\n+++ b/src/sage/graphs/convexity_properties.pyx\n@@ -333,6 +333,7 @@ cdef class ConvexityProperties:\n                 if bitset_len(tmp) < self._n:\n                     bitset_add(bs, i)\n \n+        bitset_free(tmp)\n \n     cpdef hull_number(self, value_only=True, verbose=False):\n         r\"\"\"\n```\nbut it does not seem to matter here.",
    "created_at": "2018-12-03T12:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514704",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>Replying to [comment:21 jmantysalo]:
> What's this:
> 
> 
> ```
> import gc
> 
> i = 0
> GG = graphs()
> _ = next(GG); _ = next(GG); 
> for P in GG:
>     if i > 20000: break
>     if i % 1000 == 0:
>         _ = gc.collect()
>         print get_memory_usage(), P.order()
>     i += 1
>     _ = P.convexity_properties()
> ```
> 
> ??? There is an explicit `__destruct__` in class `ConvexityProperties`.


I've noticed this one missing:

```diff
diff --git a/src/sage/graphs/convexity_properties.pyx b/src/sage/graphs/convexity_properties.pyx
index 474eb0e4cf..6b66e77a39 100644
--- a/src/sage/graphs/convexity_properties.pyx
+++ b/src/sage/graphs/convexity_properties.pyx
@@ -333,6 +333,7 @@ cdef class ConvexityProperties:
                 if bitset_len(tmp) < self._n:
                     bitset_add(bs, i)
 
+        bitset_free(tmp)
 
     cpdef hull_number(self, value_only=True, verbose=False):
         r"""
```
but it does not seem to matter here.



---

archive/issue_comments_514705.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-03T12:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514705",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_514706.json:
```json
{
    "body": "Changing commit from \"c407d99c3d3a8302f1f0519702935a4049406ceb\" to \"c42c3bc27da534544dc62a953d5457d6c27532b5\"",
    "created_at": "2018-12-03T12:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514706",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c407d99c3d3a8302f1f0519702935a4049406ceb" to "c42c3bc27da534544dc62a953d5457d6c27532b5"



---

archive/issue_comments_514707.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:21 jmantysalo]:\n> What's this:\n> \n> \n> ```\n> import gc\n> \n> i = 0\n> GG = graphs()\n> _ = next(GG); _ = next(GG); \n> for P in GG:\n>     if i > 20000: break\n>     if i % 1000 == 0:\n>         _ = gc.collect()\n>         print get_memory_usage(), P.order()\n>     i += 1\n>     _ = P.convexity_properties()\n> ```\n> \n> ??? There is an explicit `__destruct__` in class `ConvexityProperties`.\n\n\nhowever, `__destruct__` is not called, as one can see by putting a `print()` there.",
    "created_at": "2018-12-03T15:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514707",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>Replying to [comment:21 jmantysalo]:
> What's this:
> 
> 
> ```
> import gc
> 
> i = 0
> GG = graphs()
> _ = next(GG); _ = next(GG); 
> for P in GG:
>     if i > 20000: break
>     if i % 1000 == 0:
>         _ = gc.collect()
>         print get_memory_usage(), P.order()
>     i += 1
>     _ = P.convexity_properties()
> ```
> 
> ??? There is an explicit `__destruct__` in class `ConvexityProperties`.


however, `__destruct__` is not called, as one can see by putting a `print()` there.



---

archive/issue_comments_514708.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-03T16:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514708",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_514709.json:
```json
{
    "body": "Changing commit from \"c42c3bc27da534544dc62a953d5457d6c27532b5\" to \"f786410df2a639ad1e95fc7c78e09b851c02d572\"",
    "created_at": "2018-12-03T16:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514709",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c42c3bc27da534544dc62a953d5457d6c27532b5" to "f786410df2a639ad1e95fc7c78e09b851c02d572"



---

archive/issue_comments_514710.json:
```json
{
    "body": "<a id='comment:28'></a>OK, the latest commit fixes `convexity_properties` leak.",
    "created_at": "2018-12-03T16:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514710",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>OK, the latest commit fixes `convexity_properties` leak.



---

archive/issue_comments_514711.json:
```json
{
    "body": "<a id='comment:29'></a>Should we now make another ticket about `_is_relaxation()` and try to review and close this one?",
    "created_at": "2018-12-03T19:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514711",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:29'></a>Should we now make another ticket about `_is_relaxation()` and try to review and close this one?



---

archive/issue_comments_514712.json:
```json
{
    "body": "<a id='comment:30'></a>As you like - you know more about leaks than me :-)",
    "created_at": "2018-12-03T19:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514712",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>As you like - you know more about leaks than me :-)



---

archive/issue_comments_514713.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+(Add more leaks here. But not the one that is taken care in #26794)\n \n+First one, handled at #26796\n+\n+```\n+def bad8(n):\n+    from sage.graphs.independent_sets import IndependentSets\n+    G = Graph(2)\n+    for i in range(n):\n+        x = [0] in IndependentSets(G)\n+        if i % 10000 == 0:\n+            print get_memory_usage()\n+\n+bad8(100000)\n+```\n+\n+Second, in #26806: Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.\n+\n+Third: Also `dimension()` of posets seems to have a leak. Root cause might be something already corrected.\n+\n+More in comments.\n \n Comment: 1\n \n``````\n",
    "created_at": "2018-12-03T19:50:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514713",
    "user": "https://github.com/jm58660"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,24 @@
+(Add more leaks here. But not the one that is taken care in #26794)
 
+First one, handled at #26796
+
+```
+def bad8(n):
+    from sage.graphs.independent_sets import IndependentSets
+    G = Graph(2)
+    for i in range(n):
+        x = [0] in IndependentSets(G)
+        if i % 10000 == 0:
+            print get_memory_usage()
+
+bad8(100000)
+```
+
+Second, in #26806: Propably `_is_relaxation()` in `src/sage/matroids/basis_matroid.pyx`, `bitset_init` for `bb_comp` and `b2`, but no corresponding `bitset_free`.
+
+Third: Also `dimension()` of posets seems to have a leak. Root cause might be something already corrected.
+
+More in comments.
 
 Comment: 1
 
``````




---

archive/issue_comments_514714.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 dimpase]:\n> As you like - you know more about leaks than me :-)\n\n\nOK, I made #26806. To confirm, is this now ready for review?",
    "created_at": "2018-12-03T19:50:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514714",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:31'></a>Replying to [comment:30 dimpase]:
> As you like - you know more about leaks than me :-)


OK, I made #26806. To confirm, is this now ready for review?



---

archive/issue_comments_514715.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-12-03T19:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514715",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_514716.json:
```json
{
    "body": "<a id='comment:32'></a>Thanks. Yes, please review!",
    "created_at": "2018-12-03T19:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514716",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>Thanks. Yes, please review!



---

archive/issue_comments_514717.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jori M\u00e4ntysalo\"",
    "created_at": "2018-12-04T07:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514717",
    "user": "https://github.com/jm58660"
}
```

Changing reviewer from "" to "Jori Mäntysalo"



---

archive/issue_comments_514718.json:
```json
{
    "body": "<a id='comment:33'></a>This is OK. Thanks for fixes.",
    "created_at": "2018-12-04T07:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514718",
    "user": "https://github.com/jm58660"
}
```

<a id='comment:33'></a>This is OK. Thanks for fixes.



---

archive/issue_comments_514719.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-04T07:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514719",
    "user": "https://github.com/jm58660"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_066332.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-07T12:10:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26795#event-66332"
}
```



---

archive/issue_comments_514720.json:
```json
{
    "body": "Changing branch from \"public/packages/glpkbackendmemleak\" to \"f786410df2a639ad1e95fc7c78e09b851c02d572\"",
    "created_at": "2018-12-07T12:10:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514720",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/packages/glpkbackendmemleak" to "f786410df2a639ad1e95fc7c78e09b851c02d572"



---

archive/issue_comments_514721.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-07T12:10:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26795#issuecomment-514721",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
