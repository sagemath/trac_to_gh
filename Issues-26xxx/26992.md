# Issue 26992: Fix new (lib) gap on py3

archive/issues_026755.json:
```json
{
    "assignees": [
        "https://github.com/embray"
    ],
    "body": "<div id=\"comment:0\"></div>\n\nThere are py3-specific bugs in the new lib gap, as of #22626.\nSome of them stem from error handler not being fully string/bytes clean.\n\n```\n3$ ./sage -tp src/sage/libs/gap/util.pyx\nRunning doctests with ID 2019-01-02-09-11-48-97f4ca0c.\nGit branch: HEAD\nUsing --optional=dochtml,memlimit,mpir,python2,sage\nDoctesting 1 file using 8 threads.\nsage -t --warn-long 46.7 src/sage/libs/gap/util.pyx\n**********************************************************************\nFile \"src/sage/libs/gap/util.pyx\", line 389, in sage.libs.gap.util.NULL\nFailed example:\n    libgap.eval('Complex Field with 53 bits of precision;')\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: libGAP: Error, Variable: 'Complex' must have a value\n    Syntax error: ; expected in stream:1\n    Complex Field with 53 bits of precision;;\n     ^^^^^^^^^^^^\n    Error, Variable: 'with' must have a value\n    Syntax error: ; expected in stream:1\n    Complex Field with 53 bits of precision;;\n     ^^^^^^^^^^^^^^^^^^^^\n    Error, Variable: 'bits' must have a value\n    Syntax error: ; expected in stream:1\n    Complex Field with 53 bits of precision;;\n     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    Error, Variable: 'precision' must have a value\nGot:\n    RuntimeError: Error, Variable: 'Complex' must have a value\n    <BLANKLINE>\n    The above exception was the direct cause of the following exception:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set\n    Exception ignored in: 'sage.libs.gap.util.error_handler'\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set\n    RuntimeError: Syntax error: ; expected in stream:1\n    Complex Field with 53 bits of precision;;\n     ^^^^^^^^^^^^^^^^^^^^\n    Error, Variable: 'bits' must have a value\n    <BLANKLINE>\n    The above exception was the direct cause of the following exception:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set\n    Exception ignored in: 'sage.libs.gap.util.error_handler'\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set\n    Traceback (most recent call last):\n      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.gap.util.NULL[4]>\", line 1, in <module>\n        libgap.eval('Complex Field with 53 bits of precision;')\n      File \"sage/libs/gap/libgap.pyx\", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)\n        elem = make_any_gap_element(self, gap_eval(gap_command))\n      File \"sage/libs/gap/util.pyx\", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)\n        raise ValueError('can only evaluate a single statement')\n    ValueError: can only evaluate a single statement\n**********************************************************************\nFile \"src/sage/libs/gap/util.pyx\", line 410, in sage.libs.gap.util.NULL\nFailed example:\n    libgap.eval('Complex Field with 53 bits of precision;')\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: libGAP: Error, Variable: 'Complex' must have a value\n    ...\n    Error, Variable: 'precision' must have a value\nGot:\n    RuntimeError: Error, Variable: 'Complex' must have a value\n    <BLANKLINE>\n    The above exception was the direct cause of the following exception:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set\n    Exception ignored in: 'sage.libs.gap.util.error_handler'\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set\n    RuntimeError: Syntax error: ; expected in stream:1\n    Complex Field with 53 bits of precision;;\n     ^^^^^^^^^^^^^^^^^^^^\n    Error, Variable: 'bits' must have a value\n    <BLANKLINE>\n    The above exception was the direct cause of the following exception:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set\n    Exception ignored in: 'sage.libs.gap.util.error_handler'\n    Traceback (most recent call last):\n      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set\n    Traceback (most recent call last):\n      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.gap.util.NULL[5]>\", line 1, in <module>\n        libgap.eval('Complex Field with 53 bits of precision;')\n      File \"sage/libs/gap/libgap.pyx\", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)\n        elem = make_any_gap_element(self, gap_eval(gap_command))\n      File \"sage/libs/gap/util.pyx\", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)\n        raise ValueError('can only evaluate a single statement')\n    ValueError: can only evaluate a single statement\n**********************************************************************\n1 item had failures:\n   2 of   8 in sage.libs.gap.util.NULL\n    [21 tests, 2 failures, 1.75 s]\n----------------------------------------------------------------------\nsage -t --warn-long 46.7 src/sage/libs/gap/util.pyx  # 2 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 1.8 seconds\n    cpu time: 1.8 seconds\n    cumulative wall time: 1.8 seconds\n```\n\nCC:  @fchapoton @embray @jdemeyer\n\nComponent: **python3**\n\nAuthor: **Erik Bray**\n\nBranch/Commit: **[`369fade`](https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f)**\n\nReviewer: **Dima Pasechnik**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26992_\n\n",
    "closed_at": "2019-02-06T10:39:19Z",
    "created_at": "2019-01-02T03:54:14Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix new (lib) gap on py3",
    "type": "issue",
    "updated_at": "2019-02-06T10:39:19Z",
    "url": "https://github.com/sagemath/sage/issues/26992",
    "user": "https://github.com/dimpase"
}
```
<div id="comment:0"></div>

There are py3-specific bugs in the new lib gap, as of #22626.
Some of them stem from error handler not being fully string/bytes clean.

```
3$ ./sage -tp src/sage/libs/gap/util.pyx
Running doctests with ID 2019-01-02-09-11-48-97f4ca0c.
Git branch: HEAD
Using --optional=dochtml,memlimit,mpir,python2,sage
Doctesting 1 file using 8 threads.
sage -t --warn-long 46.7 src/sage/libs/gap/util.pyx
**********************************************************************
File "src/sage/libs/gap/util.pyx", line 389, in sage.libs.gap.util.NULL
Failed example:
    libgap.eval('Complex Field with 53 bits of precision;')
Expected:
    Traceback (most recent call last):
    ...
    ValueError: libGAP: Error, Variable: 'Complex' must have a value
    Syntax error: ; expected in stream:1
    Complex Field with 53 bits of precision;;
     ^^^^^^^^^^^^
    Error, Variable: 'with' must have a value
    Syntax error: ; expected in stream:1
    Complex Field with 53 bits of precision;;
     ^^^^^^^^^^^^^^^^^^^^
    Error, Variable: 'bits' must have a value
    Syntax error: ; expected in stream:1
    Complex Field with 53 bits of precision;;
     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    Error, Variable: 'precision' must have a value
Got:
    RuntimeError: Error, Variable: 'Complex' must have a value
    <BLANKLINE>
    The above exception was the direct cause of the following exception:
    <BLANKLINE>
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set
    Exception ignored in: 'sage.libs.gap.util.error_handler'
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set
    RuntimeError: Syntax error: ; expected in stream:1
    Complex Field with 53 bits of precision;;
     ^^^^^^^^^^^^^^^^^^^^
    Error, Variable: 'bits' must have a value
    <BLANKLINE>
    The above exception was the direct cause of the following exception:
    <BLANKLINE>
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set
    Exception ignored in: 'sage.libs.gap.util.error_handler'
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set
    Traceback (most recent call last):
      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.gap.util.NULL[4]>", line 1, in <module>
        libgap.eval('Complex Field with 53 bits of precision;')
      File "sage/libs/gap/libgap.pyx", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)
        elem = make_any_gap_element(self, gap_eval(gap_command))
      File "sage/libs/gap/util.pyx", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)
        raise ValueError('can only evaluate a single statement')
    ValueError: can only evaluate a single statement
**********************************************************************
File "src/sage/libs/gap/util.pyx", line 410, in sage.libs.gap.util.NULL
Failed example:
    libgap.eval('Complex Field with 53 bits of precision;')
Expected:
    Traceback (most recent call last):
    ...
    ValueError: libGAP: Error, Variable: 'Complex' must have a value
    ...
    Error, Variable: 'precision' must have a value
Got:
    RuntimeError: Error, Variable: 'Complex' must have a value
    <BLANKLINE>
    The above exception was the direct cause of the following exception:
    <BLANKLINE>
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set
    Exception ignored in: 'sage.libs.gap.util.error_handler'
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set
    RuntimeError: Syntax error: ; expected in stream:1
    Complex Field with 53 bits of precision;;
     ^^^^^^^^^^^^^^^^^^^^
    Error, Variable: 'bits' must have a value
    <BLANKLINE>
    The above exception was the direct cause of the following exception:
    <BLANKLINE>
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set
    Exception ignored in: 'sage.libs.gap.util.error_handler'
    Traceback (most recent call last):
      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set
    Traceback (most recent call last):
      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.gap.util.NULL[5]>", line 1, in <module>
        libgap.eval('Complex Field with 53 bits of precision;')
      File "sage/libs/gap/libgap.pyx", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)
        elem = make_any_gap_element(self, gap_eval(gap_command))
      File "sage/libs/gap/util.pyx", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)
        raise ValueError('can only evaluate a single statement')
    ValueError: can only evaluate a single statement
**********************************************************************
1 item had failures:
   2 of   8 in sage.libs.gap.util.NULL
    [21 tests, 2 failures, 1.75 s]
----------------------------------------------------------------------
sage -t --warn-long 46.7 src/sage/libs/gap/util.pyx  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 1.8 seconds
    cpu time: 1.8 seconds
    cumulative wall time: 1.8 seconds
```

CC:  @fchapoton @embray @jdemeyer

Component: **python3**

Author: **Erik Bray**

Branch/Commit: **[`369fade`](https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f)**

Reviewer: **Dima Pasechnik**

_Issue created by migration from https://trac.sagemath.org/ticket/26992_





---

archive/issue_events_367918.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-01-02T03:54:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "milestone_number": null,
    "milestone_title": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367918"
}
```



---

archive/issue_events_367919.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-01-02T03:54:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "0000b0",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367919"
}
```



---

archive/issue_events_367920.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-01-02T03:54:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367920"
}
```



---

archive/issue_events_367921.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-01-02T03:54:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367921"
}
```



---

archive/issue_comments_416083.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,127 @@\n There are py3-specific bugs in the new lib gap, as of #22626.\n Some of them stem from error handler not being fully string/bytes clean.\n+\n+```\n+3$ ./sage -tp src/sage/libs/gap/util.pyx\n+Running doctests with ID 2019-01-02-09-11-48-97f4ca0c.\n+Git branch: HEAD\n+Using --optional=dochtml,memlimit,mpir,python2,sage\n+Doctesting 1 file using 8 threads.\n+sage -t --warn-long 46.7 src/sage/libs/gap/util.pyx\n+**********************************************************************\n+File \"src/sage/libs/gap/util.pyx\", line 389, in sage.libs.gap.util.NULL\n+Failed example:\n+    libgap.eval('Complex Field with 53 bits of precision;')\n+Expected:\n+    Traceback (most recent call last):\n+    ...\n+    ValueError: libGAP: Error, Variable: 'Complex' must have a value\n+    Syntax error: ; expected in stream:1\n+    Complex Field with 53 bits of precision;;\n+     ^^^^^^^^^^^^\n+    Error, Variable: 'with' must have a value\n+    Syntax error: ; expected in stream:1\n+    Complex Field with 53 bits of precision;;\n+     ^^^^^^^^^^^^^^^^^^^^\n+    Error, Variable: 'bits' must have a value\n+    Syntax error: ; expected in stream:1\n+    Complex Field with 53 bits of precision;;\n+     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+    Error, Variable: 'precision' must have a value\n+Got:\n+    RuntimeError: Error, Variable: 'Complex' must have a value\n+    <BLANKLINE>\n+    The above exception was the direct cause of the following exception:\n+    <BLANKLINE>\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set\n+    Exception ignored in: 'sage.libs.gap.util.error_handler'\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set\n+    RuntimeError: Syntax error: ; expected in stream:1\n+    Complex Field with 53 bits of precision;;\n+     ^^^^^^^^^^^^^^^^^^^^\n+    Error, Variable: 'bits' must have a value\n+    <BLANKLINE>\n+    The above exception was the direct cause of the following exception:\n+    <BLANKLINE>\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set\n+    Exception ignored in: 'sage.libs.gap.util.error_handler'\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set\n+    Traceback (most recent call last):\n+      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 671, in _run\n+        self.compile_and_execute(example, compiler, test.globs)\n+      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n+        exec(compiled, globs)\n+      File \"<doctest sage.libs.gap.util.NULL[4]>\", line 1, in <module>\n+        libgap.eval('Complex Field with 53 bits of precision;')\n+      File \"sage/libs/gap/libgap.pyx\", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)\n+        elem = make_any_gap_element(self, gap_eval(gap_command))\n+      File \"sage/libs/gap/util.pyx\", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)\n+        raise ValueError('can only evaluate a single statement')\n+    ValueError: can only evaluate a single statement\n+**********************************************************************\n+File \"src/sage/libs/gap/util.pyx\", line 410, in sage.libs.gap.util.NULL\n+Failed example:\n+    libgap.eval('Complex Field with 53 bits of precision;')\n+Expected:\n+    Traceback (most recent call last):\n+    ...\n+    ValueError: libGAP: Error, Variable: 'Complex' must have a value\n+    ...\n+    Error, Variable: 'precision' must have a value\n+Got:\n+    RuntimeError: Error, Variable: 'Complex' must have a value\n+    <BLANKLINE>\n+    The above exception was the direct cause of the following exception:\n+    <BLANKLINE>\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set\n+    Exception ignored in: 'sage.libs.gap.util.error_handler'\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set\n+    RuntimeError: Syntax error: ; expected in stream:1\n+    Complex Field with 53 bits of precision;;\n+     ^^^^^^^^^^^^^^^^^^^^\n+    Error, Variable: 'bits' must have a value\n+    <BLANKLINE>\n+    The above exception was the direct cause of the following exception:\n+    <BLANKLINE>\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set\n+    Exception ignored in: 'sage.libs.gap.util.error_handler'\n+    Traceback (most recent call last):\n+      File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\n+    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set\n+    Traceback (most recent call last):\n+      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 671, in _run\n+        self.compile_and_execute(example, compiler, test.globs)\n+      File \"/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n+        exec(compiled, globs)\n+      File \"<doctest sage.libs.gap.util.NULL[5]>\", line 1, in <module>\n+        libgap.eval('Complex Field with 53 bits of precision;')\n+      File \"sage/libs/gap/libgap.pyx\", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)\n+        elem = make_any_gap_element(self, gap_eval(gap_command))\n+      File \"sage/libs/gap/util.pyx\", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)\n+        raise ValueError('can only evaluate a single statement')\n+    ValueError: can only evaluate a single statement\n+**********************************************************************\n+1 item had failures:\n+   2 of   8 in sage.libs.gap.util.NULL\n+    [21 tests, 2 failures, 1.75 s]\n+----------------------------------------------------------------------\n+sage -t --warn-long 46.7 src/sage/libs/gap/util.pyx  # 2 doctests failed\n+----------------------------------------------------------------------\n+Total time for all tests: 1.8 seconds\n+    cpu time: 1.8 seconds\n+    cumulative wall time: 1.8 seconds\n+```\n``````\n",
    "created_at": "2019-01-02T09:15:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416083",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,127 @@
 There are py3-specific bugs in the new lib gap, as of #22626.
 Some of them stem from error handler not being fully string/bytes clean.
+
+```
+3$ ./sage -tp src/sage/libs/gap/util.pyx
+Running doctests with ID 2019-01-02-09-11-48-97f4ca0c.
+Git branch: HEAD
+Using --optional=dochtml,memlimit,mpir,python2,sage
+Doctesting 1 file using 8 threads.
+sage -t --warn-long 46.7 src/sage/libs/gap/util.pyx
+**********************************************************************
+File "src/sage/libs/gap/util.pyx", line 389, in sage.libs.gap.util.NULL
+Failed example:
+    libgap.eval('Complex Field with 53 bits of precision;')
+Expected:
+    Traceback (most recent call last):
+    ...
+    ValueError: libGAP: Error, Variable: 'Complex' must have a value
+    Syntax error: ; expected in stream:1
+    Complex Field with 53 bits of precision;;
+     ^^^^^^^^^^^^
+    Error, Variable: 'with' must have a value
+    Syntax error: ; expected in stream:1
+    Complex Field with 53 bits of precision;;
+     ^^^^^^^^^^^^^^^^^^^^
+    Error, Variable: 'bits' must have a value
+    Syntax error: ; expected in stream:1
+    Complex Field with 53 bits of precision;;
+     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
+    Error, Variable: 'precision' must have a value
+Got:
+    RuntimeError: Error, Variable: 'Complex' must have a value
+    <BLANKLINE>
+    The above exception was the direct cause of the following exception:
+    <BLANKLINE>
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set
+    Exception ignored in: 'sage.libs.gap.util.error_handler'
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cec5af8> returned a result with an error set
+    RuntimeError: Syntax error: ; expected in stream:1
+    Complex Field with 53 bits of precision;;
+     ^^^^^^^^^^^^^^^^^^^^
+    Error, Variable: 'bits' must have a value
+    <BLANKLINE>
+    The above exception was the direct cause of the following exception:
+    <BLANKLINE>
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set
+    Exception ignored in: 'sage.libs.gap.util.error_handler'
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cc76030> returned a result with an error set
+    Traceback (most recent call last):
+      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
+        self.compile_and_execute(example, compiler, test.globs)
+      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
+        exec(compiled, globs)
+      File "<doctest sage.libs.gap.util.NULL[4]>", line 1, in <module>
+        libgap.eval('Complex Field with 53 bits of precision;')
+      File "sage/libs/gap/libgap.pyx", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)
+        elem = make_any_gap_element(self, gap_eval(gap_command))
+      File "sage/libs/gap/util.pyx", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)
+        raise ValueError('can only evaluate a single statement')
+    ValueError: can only evaluate a single statement
+**********************************************************************
+File "src/sage/libs/gap/util.pyx", line 410, in sage.libs.gap.util.NULL
+Failed example:
+    libgap.eval('Complex Field with 53 bits of precision;')
+Expected:
+    Traceback (most recent call last):
+    ...
+    ValueError: libGAP: Error, Variable: 'Complex' must have a value
+    ...
+    Error, Variable: 'precision' must have a value
+Got:
+    RuntimeError: Error, Variable: 'Complex' must have a value
+    <BLANKLINE>
+    The above exception was the direct cause of the following exception:
+    <BLANKLINE>
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set
+    Exception ignored in: 'sage.libs.gap.util.error_handler'
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cec5bb0> returned a result with an error set
+    RuntimeError: Syntax error: ; expected in stream:1
+    Complex Field with 53 bits of precision;;
+     ^^^^^^^^^^^^^^^^^^^^
+    Error, Variable: 'bits' must have a value
+    <BLANKLINE>
+    The above exception was the direct cause of the following exception:
+    <BLANKLINE>
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set
+    Exception ignored in: 'sage.libs.gap.util.error_handler'
+    Traceback (most recent call last):
+      File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
+    SystemError: <built-in method replace of str object at 0x7fd29cc77030> returned a result with an error set
+    Traceback (most recent call last):
+      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
+        self.compile_and_execute(example, compiler, test.globs)
+      File "/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
+        exec(compiled, globs)
+      File "<doctest sage.libs.gap.util.NULL[5]>", line 1, in <module>
+        libgap.eval('Complex Field with 53 bits of precision;')
+      File "sage/libs/gap/libgap.pyx", line 410, in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)
+        elem = make_any_gap_element(self, gap_eval(gap_command))
+      File "sage/libs/gap/util.pyx", line 442, in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)
+        raise ValueError('can only evaluate a single statement')
+    ValueError: can only evaluate a single statement
+**********************************************************************
+1 item had failures:
+   2 of   8 in sage.libs.gap.util.NULL
+    [21 tests, 2 failures, 1.75 s]
+----------------------------------------------------------------------
+sage -t --warn-long 46.7 src/sage/libs/gap/util.pyx  # 2 doctests failed
+----------------------------------------------------------------------
+Total time for all tests: 1.8 seconds
+    cpu time: 1.8 seconds
+    cumulative wall time: 1.8 seconds
+```
``````




---

archive/issue_comments_416084.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nreducing the number of words in that string:\n\n```\nsage:  libgap.eval('Complex Field with;')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\nRuntimeError: Error, Variable: 'Complex' must have a value\n\nThe above exception was the direct cause of the following exception:\n\nSystemError                               Traceback (most recent call last)\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)()\n    508     if msg != NULL:\n    509         msg_py = char_to_str(msg)\n--> 510         msg_py = msg_py.replace('For debugging hints type ?Recovery from '\n    511                                 'NoMethodFound\\n', '').strip()\n    512     else:\n\nSystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set\nException ignored in: 'sage.libs.gap.util.error_handler'\nTraceback (most recent call last):\n  File \"sage/libs/gap/util.pyx\", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)\nSystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-1-b7d3bc318a36> in <module>()\n----> 1 libgap.eval('Complex Field with;')\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)()\n    440         if nresults > 1:  # to mimick the old libGAP\n    441             # TODO: Get rid of this restriction eventually?\n--> 442             raise ValueError('can only evaluate a single statement')\n    443 \n    444         # Get the result of the first statement\n\nValueError: can only evaluate a single statement\n```\nstill the same\n\n```\nsage:  libgap.eval('Complex Field;')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()\n    430         GAP_Enter()\n--> 431         result = GAP_EvalString(cmd)\n    432         # We can assume that the result object is a GAP PList (plain list)\n\nRuntimeError: Error, Variable: 'Complex' must have a value\n\nDuring handling of the above exception, another exception occurred:\n\nValueError                                Traceback (most recent call last)\n<ipython-input-2-124a0085564b> in <module>()\n----> 1 libgap.eval('Complex Field;')\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()\n    459         return ELM0_LIST(result, 2)\n    460     except RuntimeError as msg:\n--> 461         raise ValueError(f'libGAP: {msg}')\n    462     finally:\n    463         GAP_Leave()\n\nValueError: libGAP: Error, Variable: 'Complex' must have a value\n```\nthis is different, more sane - this is treated as a single statement, at least.\n\n```\nsage:  libgap.eval('Complex;')\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()\n    430         GAP_Enter()\n--> 431         result = GAP_EvalString(cmd)\n    432         # We can assume that the result object is a GAP PList (plain list)\n\nRuntimeError: Error, Variable: 'Complex' must have a value\n\nDuring handling of the above exception, another exception occurred:\n\nValueError                                Traceback (most recent call last)\n<ipython-input-4-4f8aa29a844d> in <module>()\n----> 1 libgap.eval('Complex;')\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()\n    459         return ELM0_LIST(result, 2)\n    460     except RuntimeError as msg:\n--> 461         raise ValueError(f'libGAP: {msg}')\n    462     finally:\n    463         GAP_Leave()\n\nValueError: libGAP: Error, Variable: 'Complex' must have a value\n```\nlooks OK.",
    "created_at": "2019-01-02T09:39:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416084",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:2" align="right">comment:2</div>

reducing the number of words in that string:

```
sage:  libgap.eval('Complex Field with;')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
RuntimeError: Error, Variable: 'Complex' must have a value

The above exception was the direct cause of the following exception:

SystemError                               Traceback (most recent call last)
/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)()
    508     if msg != NULL:
    509         msg_py = char_to_str(msg)
--> 510         msg_py = msg_py.replace('For debugging hints type ?Recovery from '
    511                                 'NoMethodFound\n', '').strip()
    512     else:

SystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set
Exception ignored in: 'sage.libs.gap.util.error_handler'
Traceback (most recent call last):
  File "sage/libs/gap/util.pyx", line 510, in sage.libs.gap.util.extract_libgap_errout (build/cythonized/sage/libs/gap/util.c:6662)
SystemError: <built-in method replace of str object at 0x7fe880330618> returned a result with an error set
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-1-b7d3bc318a36> in <module>()
----> 1 libgap.eval('Complex Field with;')

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6328)()
    440         if nresults > 1:  # to mimick the old libGAP
    441             # TODO: Get rid of this restriction eventually?
--> 442             raise ValueError('can only evaluate a single statement')
    443 
    444         # Get the result of the first statement

ValueError: can only evaluate a single statement
```
still the same

```
sage:  libgap.eval('Complex Field;')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()
    430         GAP_Enter()
--> 431         result = GAP_EvalString(cmd)
    432         # We can assume that the result object is a GAP PList (plain list)

RuntimeError: Error, Variable: 'Complex' must have a value

During handling of the above exception, another exception occurred:

ValueError                                Traceback (most recent call last)
<ipython-input-2-124a0085564b> in <module>()
----> 1 libgap.eval('Complex Field;')

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()
    459         return ELM0_LIST(result, 2)
    460     except RuntimeError as msg:
--> 461         raise ValueError(f'libGAP: {msg}')
    462     finally:
    463         GAP_Leave()

ValueError: libGAP: Error, Variable: 'Complex' must have a value
```
this is different, more sane - this is treated as a single statement, at least.

```
sage:  libgap.eval('Complex;')
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6295)()
    430         GAP_Enter()
--> 431         result = GAP_EvalString(cmd)
    432         # We can assume that the result object is a GAP PList (plain list)

RuntimeError: Error, Variable: 'Complex' must have a value

During handling of the above exception, another exception occurred:

ValueError                                Traceback (most recent call last)
<ipython-input-4-4f8aa29a844d> in <module>()
----> 1 libgap.eval('Complex;')

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sagepy3/local/lib/python3.6/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6432)()
    459         return ELM0_LIST(result, 2)
    460     except RuntimeError as msg:
--> 461         raise ValueError(f'libGAP: {msg}')
    462     finally:
    463         GAP_Leave()

ValueError: libGAP: Error, Variable: 'Complex' must have a value
```
looks OK.



---

archive/issue_comments_416085.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nAnd with python2 one gets the intended (roughly, what GAP reports):\n\n```\nsage:  libgap.eval('Complex Field with 53 bits of precision;')\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-1-8255f9147a12> in <module>()\n----> 1 libgap.eval('Complex Field with 53 bits of precision;')\n\n/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()\n    408             gap_command = str(gap_command._gap_init_())\n    409 \n--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))\n    411 \n    412         # If the element is NULL just return None instead\n\n/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6563)()\n    473         return ELM0_LIST(result, 2)\n    474     except RuntimeError as msg:\n--> 475         raise ValueError(f'libGAP: {msg}')\n    476     finally:\n    477         GAP_Leave()\n\nValueError: libGAP: Error, Variable: 'Complex' must have a value\nSyntax error: ; expected in stream:1\nComplex Field with 53 bits of precision;;\n ^^^^^^^^^^^^\nError, Variable: 'with' must have a value\nSyntax error: ; expected in stream:1\nComplex Field with 53 bits of precision;;\n ^^^^^^^^^^^^^^^^^^^^\nError, Variable: 'bits' must have a value\nSyntax error: ; expected in stream:1\nComplex Field with 53 bits of precision;;\n ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nError, Variable: 'precision' must have a value\n```",
    "created_at": "2019-01-02T09:48:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416085",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:3" align="right">comment:3</div>

And with python2 one gets the intended (roughly, what GAP reports):

```
sage:  libgap.eval('Complex Field with 53 bits of precision;')
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-1-8255f9147a12> in <module>()
----> 1 libgap.eval('Complex Field with 53 bits of precision;')

/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/libgap.pyx in sage.libs.gap.libgap.Gap.eval (build/cythonized/sage/libs/gap/libgap.c:4360)()
    408             gap_command = str(gap_command._gap_init_())
    409 
--> 410         elem = make_any_gap_element(self, gap_eval(gap_command))
    411 
    412         # If the element is NULL just return None instead

/home/dimpase/sage/local/lib/python2.7/site-packages/sage/libs/gap/util.pyx in sage.libs.gap.util.gap_eval (build/cythonized/sage/libs/gap/util.c:6563)()
    473         return ELM0_LIST(result, 2)
    474     except RuntimeError as msg:
--> 475         raise ValueError(f'libGAP: {msg}')
    476     finally:
    477         GAP_Leave()

ValueError: libGAP: Error, Variable: 'Complex' must have a value
Syntax error: ; expected in stream:1
Complex Field with 53 bits of precision;;
 ^^^^^^^^^^^^
Error, Variable: 'with' must have a value
Syntax error: ; expected in stream:1
Complex Field with 53 bits of precision;;
 ^^^^^^^^^^^^^^^^^^^^
Error, Variable: 'bits' must have a value
Syntax error: ; expected in stream:1
Complex Field with 53 bits of precision;;
 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Error, Variable: 'precision' must have a value
```



---

archive/issue_comments_416086.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThe error comes from the new-style-formatted string in\n\n```\n--> 475    raise ValueError(f'libGAP: {msg}')\n```\nAnd indeed, this looks very dangerous coding style, as `f'` formatting allows Python expressions inside, and so a carefully constructed GAP error message may do really fun things...",
    "created_at": "2019-01-02T10:02:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416086",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:4" align="right">comment:4</div>

The error comes from the new-style-formatted string in

```
--> 475    raise ValueError(f'libGAP: {msg}')
```
And indeed, this looks very dangerous coding style, as `f'` formatting allows Python expressions inside, and so a carefully constructed GAP error message may do really fun things...



---

archive/issue_comments_416087.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nNo, actually, it's merely GAP producing a string that needs extra sanitation (in Python3).\nSpecifically, if I do the following\n\n```\n--- a/src/sage/libs/gap/util.pyx\n+++ b/src/sage/libs/gap/util.pyx\n@@ -507,8 +507,8 @@ cdef object extract_libgap_errout():\n     msg = CSTR_STRING(r)\n     if msg != NULL:\n         msg_py = char_to_str(msg)\n-        msg_py = msg_py.replace('For debugging hints type ?Recovery from '\n-                                'NoMethodFound\\n', '').strip()\n+        #msg_py = msg_py.replace('For debugging hints type ?Recovery from '\n+        #                        'NoMethodFound\\n', '').strip()\n     else:\n         # Shouldn't happen but just in case...\n         msg_py = \"\"\n```\nthen all the tests on this file pass.\n\nSo, somehow, Python3 cannot correctly do search/replace/strip here, while Python2 can.\nAny idea what to do?",
    "created_at": "2019-01-02T10:28:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416087",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:5" align="right">comment:5</div>

No, actually, it's merely GAP producing a string that needs extra sanitation (in Python3).
Specifically, if I do the following

```
--- a/src/sage/libs/gap/util.pyx
+++ b/src/sage/libs/gap/util.pyx
@@ -507,8 +507,8 @@ cdef object extract_libgap_errout():
     msg = CSTR_STRING(r)
     if msg != NULL:
         msg_py = char_to_str(msg)
-        msg_py = msg_py.replace('For debugging hints type ?Recovery from '
-                                'NoMethodFound\n', '').strip()
+        #msg_py = msg_py.replace('For debugging hints type ?Recovery from '
+        #                        'NoMethodFound\n', '').strip()
     else:
         # Shouldn't happen but just in case...
         msg_py = ""
```
then all the tests on this file pass.

So, somehow, Python3 cannot correctly do search/replace/strip here, while Python2 can.
Any idea what to do?



---

archive/issue_events_367922.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-01-02T10:28:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367922"
}
```



---

archive/issue_events_367923.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-02T13:35:16Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "subject": "https://github.com/embray",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367923"
}
```



---

archive/issue_comments_416088.json:
```json
{
    "body": "Branch: **[u/embray/ticket-26992](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-26992)**",
    "created_at": "2019-01-02T13:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416088",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/ticket-26992](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-26992)**



---

archive/issue_comments_416089.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe main issue here (which I've encountered before in other contexts) is that in Python 3 a lot of the interpreter and core types and modules are much stricter about checking whether or not an exception is already pending before trying to go down various code paths (without this you can end up in strange situations where built-in methods get called even after an exception has been raised).\n\nIn this case, the code in the error handler which manipulates the exception message (using Python) could break if the error handler was entered recursively, so it had to be reorganized slightly to account for this possibility.\n\nI also added `with gil` to both the error handler callback and the gasman callback: Although this isn't strictly necessary at the moment (it seems we don't release the GIL when entering libgap code) this was my first suspicion, and it's a good thing to do anyways just in case.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a99bafacf54a25203bccb581fd7d8fd14ee34ee\"><code>3a99baf</code></a></td><td><code>rearrange this code so that PyErr_Fetch is called before extract_libgap_errout()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e5454ed538e4e750918733e7bf8b7ce462d9d2ba\"><code>e5454ed</code></a></td><td><code>ensure the GIL is held when entering these callback functions</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cbd12284c4403c52b01f2befae9436101ba6b2b4\"><code>cbd1228</code></a></td><td><code>trivial python3 test fix</code></td></tr></table>\n",
    "created_at": "2019-01-02T13:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416089",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

The main issue here (which I've encountered before in other contexts) is that in Python 3 a lot of the interpreter and core types and modules are much stricter about checking whether or not an exception is already pending before trying to go down various code paths (without this you can end up in strange situations where built-in methods get called even after an exception has been raised).

In this case, the code in the error handler which manipulates the exception message (using Python) could break if the error handler was entered recursively, so it had to be reorganized slightly to account for this possibility.

I also added `with gil` to both the error handler callback and the gasman callback: Although this isn't strictly necessary at the moment (it seems we don't release the GIL when entering libgap code) this was my first suspicion, and it's a good thing to do anyways just in case.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a99bafacf54a25203bccb581fd7d8fd14ee34ee"><code>3a99baf</code></a></td><td><code>rearrange this code so that PyErr_Fetch is called before extract_libgap_errout()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e5454ed538e4e750918733e7bf8b7ce462d9d2ba"><code>e5454ed</code></a></td><td><code>ensure the GIL is held when entering these callback functions</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cbd12284c4403c52b01f2befae9436101ba6b2b4"><code>cbd1228</code></a></td><td><code>trivial python3 test fix</code></td></tr></table>




---

archive/issue_events_367924.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-02T13:50:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367924"
}
```



---

archive/issue_events_367925.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-02T13:50:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367925"
}
```



---

archive/issue_comments_416090.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2019-01-02T13:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416090",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_comments_416091.json:
```json
{
    "body": "Commit: **[`cbd1228`](https://github.com/sagemath/sagetrac-mirror/commit/cbd12284c4403c52b01f2befae9436101ba6b2b4)**",
    "created_at": "2019-01-02T13:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416091",
    "user": "https://github.com/embray"
}
```

Commit: **[`cbd1228`](https://github.com/sagemath/sagetrac-mirror/commit/cbd12284c4403c52b01f2befae9436101ba6b2b4)**



---

archive/issue_comments_416092.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nlooks good to me - on py3 docbuilding (that was the place I saw this bug 1st) still breaks somewhere later, but this (a problem with `facade-sets` label) is another story for another ticket.",
    "created_at": "2019-01-03T15:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416092",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

looks good to me - on py3 docbuilding (that was the place I saw this bug 1st) still breaks somewhere later, but this (a problem with `facade-sets` label) is another story for another ticket.



---

archive/issue_comments_416093.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2019-01-03T15:11:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416093",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_events_367926.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-01-03T15:11:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367926"
}
```



---

archive/issue_events_367927.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2019-01-03T15:11:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367927"
}
```



---

archive/issue_events_367928.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:16:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "milestone_number": null,
    "milestone_title": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367928"
}
```



---

archive/issue_events_367929.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2019-01-15T18:16:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367929"
}
```



---

archive/issue_comments_416094.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nRetarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416094",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">comment:9</div>

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_events_367930.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-16T20:13:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367930"
}
```



---

archive/issue_events_367931.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-16T20:13:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367931"
}
```



---

archive/issue_comments_416095.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nMerge conflict",
    "created_at": "2019-01-16T20:13:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416095",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:10" align="right">comment:10</div>

Merge conflict



---

archive/issue_comments_416096.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nA mystery merge conflict.",
    "created_at": "2019-01-18T10:19:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416096",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">comment:11</div>

A mystery merge conflict.



---

archive/issue_comments_416097.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nWell, the pull request here is stalled..\n\nhttps://github.com/sagemath/git-trac-command/pull/30",
    "created_at": "2019-01-18T10:22:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416097",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:12" align="right">comment:12</div>

Well, the pull request here is stalled..

https://github.com/sagemath/git-trac-command/pull/30



---

archive/issue_comments_416098.json:
```json
{
    "body": "Changed branch from **[u/embray/ticket-26992](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-26992)** to **[public/ticket/26992](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26992)**",
    "created_at": "2019-01-28T10:44:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416098",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/embray/ticket-26992](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/ticket-26992)** to **[public/ticket/26992](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26992)**



---

archive/issue_events_367932.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-28T10:44:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367932"
}
```



---

archive/issue_events_367933.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-28T10:44:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367933"
}
```



---

archive/issue_comments_416099.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\ntrivial conflict fixed\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f\"><code>369fade</code></a></td><td><code>Merge branch 'u/embray/ticket-26992' in 8.7.b1</code></td></tr></table>\n",
    "created_at": "2019-01-28T10:44:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416099",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:13" align="right">comment:13</div>

trivial conflict fixed

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f"><code>369fade</code></a></td><td><code>Merge branch 'u/embray/ticket-26992' in 8.7.b1</code></td></tr></table>




---

archive/issue_comments_416100.json:
```json
{
    "body": "Changed commit from **[`cbd1228`](https://github.com/sagemath/sagetrac-mirror/commit/cbd12284c4403c52b01f2befae9436101ba6b2b4)** to **[`369fade`](https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f)**",
    "created_at": "2019-01-28T10:44:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416100",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[`cbd1228`](https://github.com/sagemath/sagetrac-mirror/commit/cbd12284c4403c52b01f2befae9436101ba6b2b4)** to **[`369fade`](https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f)**



---

archive/issue_comments_416101.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nFollow-up ticket: #27155",
    "created_at": "2019-01-28T10:56:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416101",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

Follow-up ticket: #27155



---

archive/issue_comments_416102.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nNote that this usage of `PyErr_Fetch()` is a memory leak: the objects which are returned by `PyErr_Fetch` should be deallocated explicitly (if you are dealing with `PyObject*` instead of `object`, Cython doesn't take care of refcounts). I'll fix that on #27155.",
    "created_at": "2019-01-28T11:02:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416102",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Note that this usage of `PyErr_Fetch()` is a memory leak: the objects which are returned by `PyErr_Fetch` should be deallocated explicitly (if you are dealing with `PyObject*` instead of `object`, Cython doesn't take care of refcounts). I'll fix that on #27155.



---

archive/issue_comments_416103.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nI'm getting a quite consistent error (with or without 27155)\n\n```\n**********************************************************************\nFile \"src/sage/groups/matrix_gps/coxeter_group.py\", line 421, in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite\nFailed example:\n    [l for l in range(2, 9) if\n     CoxeterGroup([[1,3,2,2,2], [3,1,3,3,2], [2,3,1,2,2],\n                   [2,3,2,1,l], [2,2,2,l,1]]).is_finite()]\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite[2]>\", line 3, in <module>\n        [Integer(2),Integer(3),Integer(2),Integer(1),l], [Integer(2),Integer(2),Integer(2),l,Integer(1)]]).is_finite()]\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3683)\n        return self.get_object()(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/root_system/coxeter_group.py\", line 132, in CoxeterGroup\n        return CoxeterMatrixGroup(data, base_ring, index_set)\n      File \"sage/misc/classcall_metaclass.pyx\", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1700)\n        return cls.classcall(cls, *args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py\", line 233, in __classcall_private__\n        data, base_ring, data.index_set())\n      File \"sage/misc/cachefunc.pyx\", line 1005, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6067)\n        w = self.f(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 497, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2150)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py\", line 303, in __init__\n        for i in range(n)]\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py\", line 284, in val\n        return E(2 * x) + ~E(2 * x)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/universal_cyclotomic_field.py\", line 1258, in gen\n        return self.element_class(self, libgap.E(n)**k)\n      File \"sage/libs/gap/element.pyx\", line 1062, in sage.libs.gap.element.GapElement.__pow__ (build/cythonized/sage/libs/gap/element.c:10893)\n        sig_on()\n    SystemError: calling remove_from_pari_stack() inside sig_on()\n**********************************************************************\n1 item had failures:\n   1 of   6 in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite\n    [136 tests, 1 failure, 4.76 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/groups/matrix_gps/coxeter_group.py  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2019-02-02T15:02:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416103",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:16" align="right">comment:16</div>

I'm getting a quite consistent error (with or without 27155)

```
**********************************************************************
File "src/sage/groups/matrix_gps/coxeter_group.py", line 421, in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite
Failed example:
    [l for l in range(2, 9) if
     CoxeterGroup([[1,3,2,2,2], [3,1,3,3,2], [2,3,1,2,2],
                   [2,3,2,1,l], [2,2,2,l,1]]).is_finite()]
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite[2]>", line 3, in <module>
        [Integer(2),Integer(3),Integer(2),Integer(1),l], [Integer(2),Integer(2),Integer(2),l,Integer(1)]]).is_finite()]
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3683)
        return self.get_object()(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/root_system/coxeter_group.py", line 132, in CoxeterGroup
        return CoxeterMatrixGroup(data, base_ring, index_set)
      File "sage/misc/classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1700)
        return cls.classcall(cls, *args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py", line 233, in __classcall_private__
        data, base_ring, data.index_set())
      File "sage/misc/cachefunc.pyx", line 1005, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6067)
        w = self.f(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 497, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2150)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py", line 303, in __init__
        for i in range(n)]
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/groups/matrix_gps/coxeter_group.py", line 284, in val
        return E(2 * x) + ~E(2 * x)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/universal_cyclotomic_field.py", line 1258, in gen
        return self.element_class(self, libgap.E(n)**k)
      File "sage/libs/gap/element.pyx", line 1062, in sage.libs.gap.element.GapElement.__pow__ (build/cythonized/sage/libs/gap/element.c:10893)
        sig_on()
    SystemError: calling remove_from_pari_stack() inside sig_on()
**********************************************************************
1 item had failures:
   1 of   6 in sage.groups.matrix_gps.coxeter_group.CoxeterMatrixGroup.is_finite
    [136 tests, 1 failure, 4.76 s]
----------------------------------------------------------------------
sage -t --long src/sage/groups/matrix_gps/coxeter_group.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_events_367934.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-02T15:02:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367934"
}
```



---

archive/issue_events_367935.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-02T15:02:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367935"
}
```



---

archive/issue_comments_416104.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nYes, this #27140. I was hoping to fix that error on top of #26992 and #27155.",
    "created_at": "2019-02-04T11:31:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416104",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Yes, this #27140. I was hoping to fix that error on top of #26992 and #27155.



---

archive/issue_events_367936.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-04T11:31:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367936"
}
```



---

archive/issue_events_367937.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-04T11:31:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367937"
}
```



---

archive/issue_events_367938.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-04T11:31:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367938"
}
```



---

archive/issue_events_367939.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-04T11:31:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367939"
}
```



---

archive/issue_comments_416105.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nTo the release manager: tickets #26992, #27155 and #27140 should be merged together to avoid test failures.",
    "created_at": "2019-02-05T15:18:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416105",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

To the release manager: tickets #26992, #27155 and #27140 should be merged together to avoid test failures.



---

archive/issue_events_367940.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-05T15:18:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367940"
}
```



---

archive/issue_events_367941.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2019-02-05T15:18:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367941"
}
```



---

archive/issue_events_367942.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-06T10:39:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367942"
}
```



---

archive/issue_events_367943.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "3e7302b9bedd7f6bbf5a43a89b74412f6521b373",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-02-06T10:39:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26992#event-367943"
}
```



---

archive/issue_comments_416106.json:
```json
{
    "body": "Changed branch from **[public/ticket/26992](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26992)** to **[`369fade`](https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f)**",
    "created_at": "2019-02-06T10:39:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26992",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26992#issuecomment-416106",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/ticket/26992](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26992)** to **[`369fade`](https://github.com/sagemath/sagetrac-mirror/commit/369fade0a5c2ce0f5a6452d5e07065fd038bf07f)**
