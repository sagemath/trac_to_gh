# Issue 26276: py3: misc fixes for sage.modules

archive/issues_026039.json:
```json
{
    "assignees": [],
    "body": "Uploading all remaining `sage.modules` fixes from my Python 3 branch.\n\nThis is a bit diverse but I think it's a small enough set of fixes to be grouped together.  Also fixes some Python 2 bugs that were sort of left as \"known failures\".\n\nBranch/Commit: **[7bf0631](https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Erik Bray**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26276_\n\n",
    "closed_at": "2018-11-07T11:27:23Z",
    "created_at": "2018-09-13T16:20:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20python3",
        "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: misc fixes for sage.modules",
    "type": "issue",
    "updated_at": "2018-11-07T11:27:23Z",
    "url": "https://github.com/sagemath/sage/issues/26276",
    "user": "https://github.com/embray"
}
```
Uploading all remaining `sage.modules` fixes from my Python 3 branch.

This is a bit diverse but I think it's a small enough set of fixes to be grouped together.  Also fixes some Python 2 bugs that were sort of left as "known failures".

Branch/Commit: **[7bf0631](https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043)**

Reviewer: **Travis Scrimshaw**

Author: **Erik Bray**

_Issue created by migration from https://trac.sagemath.org/ticket/26276_





---

archive/issue_events_344188.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-13T16:20:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344188"
}
```



---

archive/issue_events_344189.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-13T16:20:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20python3",
    "label_color": "000080",
    "label_name": "component: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344189"
}
```



---

archive/issue_events_344190.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-13T16:20:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344190"
}
```



---

archive/issue_events_344191.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-13T16:20:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344191"
}
```



---

archive/issue_events_344192.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-13T16:21:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344192"
}
```



---

archive/issue_comments_407957.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nWith these fixes I have all of `./sage -t --long src/sage/modules/` passing.",
    "created_at": "2018-09-13T16:23:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407957",
    "user": "https://github.com/embray"
}
```

<div id="comment:2" align="right">Comment 2</div>

With these fixes I have all of `./sage -t --long src/sage/modules/` passing.



---

archive/issue_comments_407958.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nthe branch is now red",
    "created_at": "2018-09-16T06:24:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407958",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:3" align="right">Comment 3</div>

the branch is now red



---

archive/issue_events_344193.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-09-16T06:24:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344193"
}
```



---

archive/issue_events_344194.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-09-16T06:24:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344194"
}
```



---

archive/issue_comments_407959.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/467602b29fff4f9583362d5b00504dbbcfe7cfcf\">467602b</a></td><td><code>py3: sort the output from symmetrized_coordinate_sums so that it is deterministic on Python 2 and 3</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/137c1df4633321237625138db2fff4c45828f3ac\">137c1df</a></td><td><code>py3: even this test class needs a `__hash__` in order for the tests to work right</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6e904c1e9c8a026049962e22bcf95658096ef169\">6e904c1</a></td><td><code>py3: some items/iteritems fixes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0be16059eac98fe2a6dbd84ae2194c68d83767a1\">0be1605</a></td><td><code>py3: fix pickling of TriangularModuleMorphism</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/119245da02899a6262b06ba5710f1ffcc5f2de3c\">119245d</a></td><td><code>py3: fix pickling of ModuleMorphismFromMatrix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0c0f535a51fd9d08c7d4f91194f70ff653daea72\">0c0f535</a></td><td><code>py3: add a necessary int() for the arguments to islice</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f553cfdba12836616e97da473a3890520398327b\">f553cfd</a></td><td><code>fix what we agreed is likely a typo in this test</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26dea608935e5736fc081cf2c0348ead64b6a7ff\">26dea60</a></td><td><code>py3: replace testing exact hash value with something else</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8766c3805a350202df10c872e7121aaf508ed840\">8766c38</a></td><td><code>misc whitespace and other delinting</code></td></tr></table>\n",
    "created_at": "2018-09-17T11:34:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407959",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4" align="right">Comment 4</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/467602b29fff4f9583362d5b00504dbbcfe7cfcf">467602b</a></td><td><code>py3: sort the output from symmetrized_coordinate_sums so that it is deterministic on Python 2 and 3</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/137c1df4633321237625138db2fff4c45828f3ac">137c1df</a></td><td><code>py3: even this test class needs a `__hash__` in order for the tests to work right</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6e904c1e9c8a026049962e22bcf95658096ef169">6e904c1</a></td><td><code>py3: some items/iteritems fixes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0be16059eac98fe2a6dbd84ae2194c68d83767a1">0be1605</a></td><td><code>py3: fix pickling of TriangularModuleMorphism</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/119245da02899a6262b06ba5710f1ffcc5f2de3c">119245d</a></td><td><code>py3: fix pickling of ModuleMorphismFromMatrix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0c0f535a51fd9d08c7d4f91194f70ff653daea72">0c0f535</a></td><td><code>py3: add a necessary int() for the arguments to islice</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f553cfdba12836616e97da473a3890520398327b">f553cfd</a></td><td><code>fix what we agreed is likely a typo in this test</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26dea608935e5736fc081cf2c0348ead64b6a7ff">26dea60</a></td><td><code>py3: replace testing exact hash value with something else</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8766c3805a350202df10c872e7121aaf508ed840">8766c38</a></td><td><code>misc whitespace and other delinting</code></td></tr></table>




---

archive/issue_comments_407960.json:
```json
{
    "body": "Changed commit from **[a6e4cad](https://github.com/sagemath/sagetrac-mirror/commit/a6e4cad8f6d2c965033fb1fea85c4c6eed49df1d)** to **[8766c38](https://github.com/sagemath/sagetrac-mirror/commit/8766c3805a350202df10c872e7121aaf508ed840)**",
    "created_at": "2018-09-17T11:34:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407960",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[a6e4cad](https://github.com/sagemath/sagetrac-mirror/commit/a6e4cad8f6d2c965033fb1fea85c4c6eed49df1d)** to **[8766c38](https://github.com/sagemath/sagetrac-mirror/commit/8766c3805a350202df10c872e7121aaf508ed840)**



---

archive/issue_events_344195.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-17T11:34:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344195"
}
```



---

archive/issue_events_344196.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-09-17T11:34:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344196"
}
```



---

archive/issue_comments_407961.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nTwo things from a very quick lookover:\n\nThe `iter` here seems pointless as the result is an iterator:\n\n```\nreturn iter(self._entries.iteritems())\n```\n\nIn Cython, you can still use `iteritems` on a `dict` in Python3 (from what Jeroen as said in the past). So this change should not be needed:\n\n```diff\n                 e = entries_dict\n                 entries_dict = {}\n                 try:\n-                    for k, x in e.iteritems():\n+                    for k, x in e.items():\n                         x = coefficient_ring(x)\n                         if x:\n                             entries_dict[k] = x\n```\n(unless `e` needs a typecast to `dict`).",
    "created_at": "2018-09-17T12:37:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407961",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:6" align="right">Comment 6</div>

Two things from a very quick lookover:

The `iter` here seems pointless as the result is an iterator:

```
return iter(self._entries.iteritems())
```

In Cython, you can still use `iteritems` on a `dict` in Python3 (from what Jeroen as said in the past). So this change should not be needed:

```diff
                 e = entries_dict
                 entries_dict = {}
                 try:
-                    for k, x in e.iteritems():
+                    for k, x in e.items():
                         x = coefficient_ring(x)
                         if x:
                             entries_dict[k] = x
```
(unless `e` needs a typecast to `dict`).



---

archive/issue_comments_407962.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nIt's not pointless.  On Python 3 it's needed.  The value returned by `self._entries.iteritems()` is technically not an iterator strangely enough.",
    "created_at": "2018-09-17T12:40:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407962",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">Comment 7</div>

It's not pointless.  On Python 3 it's needed.  The value returned by `self._entries.iteritems()` is technically not an iterator strangely enough.



---

archive/issue_comments_407963.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nThat is a bit strange, but okay, it will be what it has to be. I guess it shouldn't affect the timings of things. Although we probably want to leave a quick comment so someone less versed in Python3 doesn't have the same thought I had and remove the `iter`.\n\nI do think we should still revert the other change.",
    "created_at": "2018-09-17T22:00:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407963",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:8" align="right">Comment 8</div>

That is a bit strange, but okay, it will be what it has to be. I guess it shouldn't affect the timings of things. Although we probably want to leave a quick comment so someone less versed in Python3 doesn't have the same thought I had and remove the `iter`.

I do think we should still revert the other change.



---

archive/issue_comments_407964.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nIt's not that strange.  On Python 3, `dict.keys()`, `dict.values()`, and `dict.items()` return views:\n\n```python\n>>> d = {}\n>>> it = d.items()\n>>> it\ndict_items([])\n>>> d['a'] = 1\n>>> it\ndict_items([('a', 1)])\n>>> next(it)\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: 'dict_items' object is not an iterator\n>>> next(iter(it))\n('a', 1)\n```",
    "created_at": "2018-09-18T17:47:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407964",
    "user": "https://github.com/embray"
}
```

<div id="comment:9" align="right">Comment 9</div>

It's not that strange.  On Python 3, `dict.keys()`, `dict.values()`, and `dict.items()` return views:

```python
>>> d = {}
>>> it = d.items()
>>> it
dict_items([])
>>> d['a'] = 1
>>> it
dict_items([('a', 1)])
>>> next(it)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: 'dict_items' object is not an iterator
>>> next(iter(it))
('a', 1)
```



---

archive/issue_comments_407965.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nI guess on Python3, Cython just considers `iteritems` as a replacement for `items` and gives the view.\n\nNow feel free to call me paranoid, but I am a little worried about the extra indirection by defining the `_on_basis` method. Since that forms the key part of the code and can be called very frequently, it could have some significant impact:\n\n```\nsage: from sage.modules.with_basis.morphism import ModuleMorphismFromMatrix\n....: X = CombinatorialFreeModule(ZZ, [1,2]); X.rename(\"X\"); x = X.basis()\n....: Y = CombinatorialFreeModule(ZZ, [3,4]); Y.rename(\"Y\"); y = Y.basis()\n....: m = matrix([[1, 2], [3, 5]])\n....: phi = ModuleMorphismFromMatrix(matrix=m, domain=X, codomain=Y, side=\"right\")\n....: \nsage: %timeit phi(X.an_element())\nThe slowest run took 36.14 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 3.91 \u00b5s per loop\n```\nvs your branch\n\n```\nsage: %timeit phi(X.an_element())\nThe slowest run took 25.64 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 4.32 \u00b5s per loop\n```\nwhich is around a 10% slowdown. So I am not sure this is the best way forward as the pickling problem might be better addressed with a custom `__reduce__` method. How much of those changes are necessary for Python3?",
    "created_at": "2018-09-18T23:44:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407965",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:10" align="right">Comment 10</div>

I guess on Python3, Cython just considers `iteritems` as a replacement for `items` and gives the view.

Now feel free to call me paranoid, but I am a little worried about the extra indirection by defining the `_on_basis` method. Since that forms the key part of the code and can be called very frequently, it could have some significant impact:

```
sage: from sage.modules.with_basis.morphism import ModuleMorphismFromMatrix
....: X = CombinatorialFreeModule(ZZ, [1,2]); X.rename("X"); x = X.basis()
....: Y = CombinatorialFreeModule(ZZ, [3,4]); Y.rename("Y"); y = Y.basis()
....: m = matrix([[1, 2], [3, 5]])
....: phi = ModuleMorphismFromMatrix(matrix=m, domain=X, codomain=Y, side="right")
....: 
sage: %timeit phi(X.an_element())
The slowest run took 36.14 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 3.91 µs per loop
```
vs your branch

```
sage: %timeit phi(X.an_element())
The slowest run took 25.64 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 4.32 µs per loop
```
which is around a 10% slowdown. So I am not sure this is the best way forward as the pickling problem might be better addressed with a custom `__reduce__` method. How much of those changes are necessary for Python3?



---

archive/issue_comments_407966.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nCould we keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket then ?",
    "created_at": "2018-09-19T08:43:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407966",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:11" align="right">Comment 11</div>

Could we keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket then ?



---

archive/issue_comments_407967.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nI would move it to another ticket if it is not necessary for Python3.",
    "created_at": "2018-09-19T09:40:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407967",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">Comment 12</div>

I would move it to another ticket if it is not necessary for Python3.



---

archive/issue_comments_407968.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nI would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.\n\nI also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.",
    "created_at": "2018-09-19T10:26:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407968",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">Comment 13</div>

I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.

I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.



---

archive/issue_comments_407969.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nReplying to [@embray](#comment%3A13):\n> I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.\n\nYes, I think it should. These get used all over the place in things like the combinatorial Hopf algebra code. Although it may not have been done previously because of stuff with the category framework, multiple inheritance, concerns about increased debugging difficult, or just a previous lack of interest.\n\n> I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.\n\nI think that is a bad way to look at it. I would say it should be more like you are passing a function as input, which then gets called as part of the computation.",
    "created_at": "2018-09-19T11:08:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407969",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:14" align="right">Comment 14</div>

Replying to [@embray](#comment%3A13):
> I would suggest that if that code needs to perform on a level where even a method call is too much unacceptable overhead, that it be rewritten in Cython then.

Yes, I think it should. These get used all over the place in things like the combinatorial Hopf algebra code. Although it may not have been done previously because of stuff with the category framework, multiple inheritance, concerns about increased debugging difficult, or just a previous lack of interest.

> I also considered a custom `__reduce__` method, but I do feel that shoving a method of some object into an attribute of another object has a certain code smell to it.

I think that is a bad way to look at it. I would say it should be more like you are passing a function as input, which then gets called as part of the computation.



---

archive/issue_comments_407970.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nThat's fair, though I probably might have instead explicitly made a lambda that wraps the dict in a closure and calls its getitem.  But maybe that's a distinction without a difference (and that would still have a problem with pickling).\n\nI'll take another look at it.  I'm curious to see what happens as a first pass if I just redo some of that module in Cython.",
    "created_at": "2018-09-19T12:04:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407970",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">Comment 15</div>

That's fair, though I probably might have instead explicitly made a lambda that wraps the dict in a closure and calls its getitem.  But maybe that's a distinction without a difference (and that would still have a problem with pickling).

I'll take another look at it.  I'm curious to see what happens as a first pass if I just redo some of that module in Cython.



---

archive/issue_comments_407971.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nCan we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?",
    "created_at": "2018-10-23T12:51:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407971",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:16" align="right">Comment 16</div>

Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?



---

archive/issue_comments_407972.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nReplying to [@fchapoton](#comment%3A16):\n> Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?\n\nYes, I think that would be good (and in that ticket, I might also Cythonize it too).",
    "created_at": "2018-10-23T13:08:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407972",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:17" align="right">Comment 17</div>

Replying to [@fchapoton](#comment%3A16):
> Can we please start to move again here, and if necessary keep the changes in `src/sage/modules/with_basis/morphism.py` for another ticket ?

Yes, I think that would be good (and in that ticket, I might also Cythonize it too).



---

archive/issue_events_344197.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "milestone_number": null,
    "milestone_title": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344197"
}
```



---

archive/issue_events_344198.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T11:41:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344198"
}
```



---

archive/issue_comments_407973.json:
```json
{
    "body": "Changed commit from **[8766c38](https://github.com/sagemath/sagetrac-mirror/commit/8766c3805a350202df10c872e7121aaf508ed840)** to **[26e8aa9](https://github.com/sagemath/sagetrac-mirror/commit/26e8aa96a3164a729908e99027146587f69bf64f)**",
    "created_at": "2018-11-04T13:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407973",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[8766c38](https://github.com/sagemath/sagetrac-mirror/commit/8766c3805a350202df10c872e7121aaf508ed840)** to **[26e8aa9](https://github.com/sagemath/sagetrac-mirror/commit/26e8aa96a3164a729908e99027146587f69bf64f)**



---

archive/issue_comments_407974.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nhere is a branch without the changes in `src/sage/modules/with_basis/morphism.py`\n\nThe old branch is kept at u/embray/sage-modules/misc\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26e8aa96a3164a729908e99027146587f69bf64f\">26e8aa9</a></td><td><code>py3: sort the output from symmetrized_coordinate_sums so that it is deterministic on Python 2 and 3</code></td></tr></table>\n",
    "created_at": "2018-11-04T13:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407974",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:19" align="right">Comment 19</div>

here is a branch without the changes in `src/sage/modules/with_basis/morphism.py`

The old branch is kept at u/embray/sage-modules/misc

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26e8aa96a3164a729908e99027146587f69bf64f">26e8aa9</a></td><td><code>py3: sort the output from symmetrized_coordinate_sums so that it is deterministic on Python 2 and 3</code></td></tr></table>




---

archive/issue_comments_407975.json:
```json
{
    "body": "Changed branch from **[u/embray/sage-modules/misc](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/sage-modules/misc)** to **[public/ticket/26276](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26276)**",
    "created_at": "2018-11-04T13:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407975",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/embray/sage-modules/misc](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/sage-modules/misc)** to **[public/ticket/26276](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26276)**



---

archive/issue_comments_407976.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nOne last little thing:\n\n```diff\n-                    for k, x in e.iteritems():\n+                    for k, x in e.items():\n```\nSince `e` is a `dict` in a Cython file, I think it would be better to do\n\n```diff\n-                    for k, x in e.iteritems():\n+                    for k, x in (<dict> e).iteritems():\n```\nOnce changed (or if you don't think it is a good idea), then you can set a positive review.",
    "created_at": "2018-11-04T14:31:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407976",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:20" align="right">Comment 20</div>

One last little thing:

```diff
-                    for k, x in e.iteritems():
+                    for k, x in e.items():
```
Since `e` is a `dict` in a Cython file, I think it would be better to do

```diff
-                    for k, x in e.iteritems():
+                    for k, x in (<dict> e).iteritems():
```
Once changed (or if you don't think it is a good idea), then you can set a positive review.



---

archive/issue_comments_407977.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2018-11-04T14:31:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407977",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_407978.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043\">7bf0631</a></td><td><code>trac 26276 minor detail</code></td></tr></table>\n",
    "created_at": "2018-11-04T17:31:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407978",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21" align="right">Comment 21</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043">7bf0631</a></td><td><code>trac 26276 minor detail</code></td></tr></table>




---

archive/issue_comments_407979.json:
```json
{
    "body": "Changed commit from **[26e8aa9](https://github.com/sagemath/sagetrac-mirror/commit/26e8aa96a3164a729908e99027146587f69bf64f)** to **[7bf0631](https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043)**",
    "created_at": "2018-11-04T17:31:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407979",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[26e8aa9](https://github.com/sagemath/sagetrac-mirror/commit/26e8aa96a3164a729908e99027146587f69bf64f)** to **[7bf0631](https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043)**



---

archive/issue_events_344199.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-04T17:32:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344199"
}
```



---

archive/issue_events_344200.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-11-04T17:32:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344200"
}
```



---

archive/issue_comments_407980.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\ndone, thanks. Setting to positive",
    "created_at": "2018-11-04T17:32:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407980",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:22" align="right">Comment 22</div>

done, thanks. Setting to positive



---

archive/issue_comments_407981.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nReplying to [@tscrim](#comment%3A20):\n> Since `e` is a `dict` in a Cython file, I think it would be better to do\n> \n> ```diff\n> -                    for k, x in e.iteritems():\n> +                    for k, x in (<dict> e).iteritems():\n> ```\n> Once changed (or if you don't think it is a good idea), then you can set a positive review.\n\nWhy this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?",
    "created_at": "2018-11-06T10:31:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407981",
    "user": "https://github.com/embray"
}
```

<div id="comment:23" align="right">Comment 23</div>

Replying to [@tscrim](#comment%3A20):
> Since `e` is a `dict` in a Cython file, I think it would be better to do
> 
> ```diff
> -                    for k, x in e.iteritems():
> +                    for k, x in (<dict> e).iteritems():
> ```
> Once changed (or if you don't think it is a good idea), then you can set a positive review.

Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?



---

archive/issue_comments_407982.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nReplying to [@embray](#comment%3A23):\n> Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?\n\nBecause I missed it being defined. `>_<` Oh well, it doesn't really hurt anything by being there.",
    "created_at": "2018-11-06T12:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407982",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:24" align="right">Comment 24</div>

Replying to [@embray](#comment%3A23):
> Why this?  `e` is already declared `cdef dict` earlier in the method, so I'm not sure why you would want to add `<dict> e` here?

Because I missed it being defined. `>_<` Oh well, it doesn't really hurt anything by being there.



---

archive/issue_comments_407983.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nI agree.  It's redundant but let's just leave it.",
    "created_at": "2018-11-06T13:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407983",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">Comment 25</div>

I agree.  It's redundant but let's just leave it.



---

archive/issue_comments_407984.json:
```json
{
    "body": "Changed branch from **[public/ticket/26276](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26276)** to **[7bf0631](https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043)**",
    "created_at": "2018-11-07T11:27:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26276#issuecomment-407984",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/ticket/26276](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/26276)** to **[7bf0631](https://github.com/sagemath/sagetrac-mirror/commit/7bf063141e92715384c824ab69988e0260176043)**



---

archive/issue_events_344201.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-11-07T11:27:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344201"
}
```



---

archive/issue_events_344202.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "c2d296e2dbc2212c68b56b98351be03084ada590",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-11-07T11:27:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26276",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26276#event-344202"
}
```
