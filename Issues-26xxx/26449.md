# Issue 26449: Python 3 vs. Sphinx

archive/issues_026212.json:
```json
{
    "body": "With #25382 and #26423 (patched so that it actually applies), Sphinx can almost build the Sage documentation. There are two issues: Sphinx itself produces an error:\n\n```\n[dochtml] [reference] Exception occurred:\n[dochtml] [reference]   File \"/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.4.rc0/local/lib/python3.6/site-packages/sphinx/search/__init__.py\", line 174, in loads\n[dochtml] [reference]     if not data or not s.startswith(self.PREFIX) or not \\\n[dochtml] [reference] TypeError: startswith first arg must be bytes or a tuple of bytes, not str\n```\nWe can patch Sphinx to fix this, or maybe we are passing bad data to Sphinx.\n\n(Second issue moved to a separate ticket, #26522.)\n\n\nCC:  @embray @jdemeyer\n\nReviewer: Erik Bray\n\nAuthor: John Palmieri\n\nBranch: 8f429b2c9a03c82864f1957e3e72aeaf0d2b5cd8\n\nCommit: 8f429b2c9a03c82864f1957e3e72aeaf0d2b5cd8\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26449\n\n",
    "closed_at": "2018-10-29T22:46:34Z",
    "created_at": "2018-10-09T22:12:11Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Python 3 vs. Sphinx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26449",
    "user": "https://github.com/jhpalmieri"
}
```
With #25382 and #26423 (patched so that it actually applies), Sphinx can almost build the Sage documentation. There are two issues: Sphinx itself produces an error:

```
[dochtml] [reference] Exception occurred:
[dochtml] [reference]   File "/Users/jpalmier/Desktop/Sage/sage_builds/PYTHON3/sage-8.4.rc0/local/lib/python3.6/site-packages/sphinx/search/__init__.py", line 174, in loads
[dochtml] [reference]     if not data or not s.startswith(self.PREFIX) or not \
[dochtml] [reference] TypeError: startswith first arg must be bytes or a tuple of bytes, not str
```
We can patch Sphinx to fix this, or maybe we are passing bad data to Sphinx.

(Second issue moved to a separate ticket, #26522.)


CC:  @embray @jdemeyer

Reviewer: Erik Bray

Author: John Palmieri

Branch: 8f429b2c9a03c82864f1957e3e72aeaf0d2b5cd8

Commit: 8f429b2c9a03c82864f1957e3e72aeaf0d2b5cd8

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26449





---

archive/issue_comments_369025.json:
```json
{
    "body": "<a id='comment:2'></a>This branch fixes the problem that Sphinx complains about: in Sphinx's file `search/__init__.py`, it seems to assume that data the search index file is a string, not bytes. It looks like ordinary text to me, so let's open it using `'r'` instead of `'rb'`.\n\nThe second problem is distinct. I will move it to another ticket.\n\n---\nNew commits:",
    "created_at": "2018-10-21T18:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369025",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>This branch fixes the problem that Sphinx complains about: in Sphinx's file `search/__init__.py`, it seems to assume that data the search index file is a string, not bytes. It looks like ordinary text to me, so let's open it using `'r'` instead of `'rb'`.

The second problem is distinct. I will move it to another ticket.

---
New commits:



---

archive/issue_comments_369026.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-21T18:28:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369026",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_369027.json:
```json
{
    "body": "<a id='comment:3'></a>See #26522 for the second issue.",
    "created_at": "2018-10-21T18:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369027",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>See #26522 for the second issue.



---

archive/issue_comments_369028.json:
```json
{
    "body": "<a id='comment:5'></a>See also #26451 (I don't have time right now to work on that though)",
    "created_at": "2018-10-22T10:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369028",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>See also #26451 (I don't have time right now to work on that though)



---

archive/issue_comments_369029.json:
```json
{
    "body": "<a id='comment:6'></a>You could also remove the explicit `'r'` but whatever, it doesn't hurt either.",
    "created_at": "2018-10-28T13:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369029",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>You could also remove the explicit `'r'` but whatever, it doesn't hurt either.



---

archive/issue_comments_369030.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-28T13:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369030",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_065756.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-28T13:49:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "milestone": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26449#event-65756"
}
```



---

archive/issue_comments_369031.json:
```json
{
    "body": "<a id='comment:7'></a>Looks like it makes sense otherwise.",
    "created_at": "2018-10-28T13:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369031",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>Looks like it makes sense otherwise.



---

archive/issue_comments_369032.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-29T22:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26449#issuecomment-369032",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_065757.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-10-29T22:46:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26449",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26449#event-65757"
}
```
