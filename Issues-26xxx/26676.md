# Issue 26676: Fix var() method for cryptominisat and picosat, which breaks solve_sat for boolean polynomial systems

archive/issues_026439.json:
```json
{
    "assignees": [],
    "body": "When I used Sage7.2, I could easily solve my boolean equations with solve_sat commands, and it's results were verified by the papers and other tools, but when I upgraded my sage to version 8 (or later version) I found that the new solve_sat solver (especially when we use CryptoMiniSat as the SAT solver) doesn't work as correct as before. For example, when I solve a system of equations via solve_sat which used CryptoMiniSat as a SAT solver, I get different number of solutions in different version of [SageMath](../wiki/SageMath). I believe that there is something wrong in newer version of [SageMath](../wiki/SageMath) because my previous experiences shows that the older version's results were verified by the other tools and papers. I hope someone could solve this problem.\n\nSee also the following thread on sage-devel: https://groups.google.com/forum/?fromgroups#!topic/sage-devel/2EhgHzGgUnQ\n\n\nCC:  tmonteil\n\nKeywords: **solve_sat, CryptoMiniSat, picosat**\n\nBranch/Commit: **[c492724](https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b)**\n\nReviewer: **Fr\u00e9d\u00e9ric Chapoton**\n\nAuthor: **Thierry Monteil**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26676_\n\n",
    "closed_at": "2019-01-03T09:34:01Z",
    "created_at": "2018-11-10T18:47:41Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix var() method for cryptominisat and picosat, which breaks solve_sat for boolean polynomial systems",
    "type": "issue",
    "updated_at": "2019-01-03T09:34:01Z",
    "url": "https://github.com/sagemath/sage/issues/26676",
    "user": "https://github.com/hadipourh"
}
```
When I used Sage7.2, I could easily solve my boolean equations with solve_sat commands, and it's results were verified by the papers and other tools, but when I upgraded my sage to version 8 (or later version) I found that the new solve_sat solver (especially when we use CryptoMiniSat as the SAT solver) doesn't work as correct as before. For example, when I solve a system of equations via solve_sat which used CryptoMiniSat as a SAT solver, I get different number of solutions in different version of [SageMath](../wiki/SageMath). I believe that there is something wrong in newer version of [SageMath](../wiki/SageMath) because my previous experiences shows that the older version's results were verified by the other tools and papers. I hope someone could solve this problem.

See also the following thread on sage-devel: https://groups.google.com/forum/?fromgroups#!topic/sage-devel/2EhgHzGgUnQ


CC:  tmonteil

Keywords: **solve_sat, CryptoMiniSat, picosat**

Branch/Commit: **[c492724](https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b)**

Reviewer: **Frédéric Chapoton**

Author: **Thierry Monteil**

_Issue created by migration from https://trac.sagemath.org/ticket/26676_





---

archive/issue_events_348826.json:
```json
{
    "actor": "https://github.com/hadipourh",
    "created_at": "2018-11-10T18:47:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348826"
}
```



---

archive/issue_events_348827.json:
```json
{
    "actor": "https://github.com/hadipourh",
    "created_at": "2018-11-10T18:47:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348827"
}
```



---

archive/issue_comments_413839.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nCan you be more concrete exactly what the problem is?",
    "created_at": "2018-11-11T00:34:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413839",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'>Comment 1:</a>
Can you be more concrete exactly what the problem is?



---

archive/issue_events_348828.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-11-11T11:45:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348828"
}
```



---

archive/issue_comments_413840.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nAs suggested by Jeroen, you should provide explicit (if possible minimal) code so that we can understand the actual issue and work from something. There might indeed be an issue with boolean equations since it relied on a `learnt_clauses` method that does not exist anymore, and the code lacks of doctests.\n\nBy the way, a good way to hint some developer about an issue is to add her nickname in the CC field so that she could recieve an email. In the title, author field or keywords field, only the people who have a regular look at the timeline will notice.",
    "created_at": "2018-11-11T11:45:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413840",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<a id='comment:2'>Comment 2:</a>
As suggested by Jeroen, you should provide explicit (if possible minimal) code so that we can understand the actual issue and work from something. There might indeed be an issue with boolean equations since it relied on a `learnt_clauses` method that does not exist anymore, and the code lacks of doctests.

By the way, a good way to hint some developer about an issue is to add her nickname in the CC field so that she could recieve an email. In the title, author field or keywords field, only the people who have a regular look at the timeline will notice.



---

archive/issue_events_348829.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-11-11T11:45:42Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "title_is": "solve_sat doesn't work correctly after migration of CryptoMiniSat from version 2 to 5",
    "title_was": "solve_sat doesn't work correctly after Thierry Monteil changed the original CryptoMiniSat Solver",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348829"
}
```



---

archive/issue_events_348830.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-11-11T11:45:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20experimental",
    "label_color": "000080",
    "label_name": "component: packages: experimental",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348830"
}
```



---

archive/issue_comments_413841.json:
```json
{
    "body": "Changed author from **Thierry Monteil** to none",
    "created_at": "2018-11-11T11:45:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413841",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Changed author from **Thierry Monteil** to none



---

archive/issue_comments_413842.json:
```json
{
    "body": "Changed keywords from **solve_sat, Thierry Monteil, CryptoMiniSat** to **solve_sat, CryptoMiniSat**",
    "created_at": "2018-11-11T11:45:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413842",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Changed keywords from **solve_sat, Thierry Monteil, CryptoMiniSat** to **solve_sat, CryptoMiniSat**



---

archive/issue_events_348831.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-11-11T11:45:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348831"
}
```



---

archive/issue_events_348832.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-11-11T11:45:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348832"
}
```



---

archive/issue_events_348833.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-11-11T11:45:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348833"
}
```



---

archive/issue_comments_413843.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nReplying to [tmonteil](#comment%3A2):\n> As suggested by Jeroen, you should provide explicit (if possible minimal) code so that we can understand the actual issue and work from something. There might indeed be an issue with boolean equations since it relied on a `learnt_clauses` method that does not exist anymore, and the code lacks of doctests.\n> \n> By the way, a good way to hint some developer about an issue is to add her nickname in the CC field so that she could recieve an email. In the title, author field or keywords field, only the people who have a regular look at the timeline will notice.\n\nDear Monteli,\n\nRegarding to explicit code for understanding the actual issue: I'll upload a code that generate a system of boolean equations which shows the issue exactly. This system of equations is extracted from a stream cipher called Bivium-B and I've solved it several times in Sage 7.2, and I'm certain that it has a unique solution, but when I want to solve it via the newer versions of [SageMath](../wiki/SageMath) (after 8.0), solver returns False as the output, which means there is not any solutions!\nI'll upload the code as soon as possible.\n\nThanks in advance for your help",
    "created_at": "2018-11-11T18:58:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413843",
    "user": "https://github.com/hadipourh"
}
```

<a id='comment:3'>Comment 3:</a>
Replying to [tmonteil](#comment%3A2):
> As suggested by Jeroen, you should provide explicit (if possible minimal) code so that we can understand the actual issue and work from something. There might indeed be an issue with boolean equations since it relied on a `learnt_clauses` method that does not exist anymore, and the code lacks of doctests.
> 
> By the way, a good way to hint some developer about an issue is to add her nickname in the CC field so that she could recieve an email. In the title, author field or keywords field, only the people who have a regular look at the timeline will notice.

Dear Monteli,

Regarding to explicit code for understanding the actual issue: I'll upload a code that generate a system of boolean equations which shows the issue exactly. This system of equations is extracted from a stream cipher called Bivium-B and I've solved it several times in Sage 7.2, and I'm certain that it has a unique solution, but when I want to solve it via the newer versions of [SageMath](../wiki/SageMath) (after 8.0), solver returns False as the output, which means there is not any solutions!
I'll upload the code as soon as possible.

Thanks in advance for your help



---

archive/issue_comments_413844.json:
```json
{
    "body": "Attachment: **[ph1234.pdf.gz](https://github.com/sagemath/sage/files/ticket26676/ph1234.pdf.gz)**",
    "created_at": "2018-11-13T10:09:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413844",
    "user": "https://github.com/essayhaveusers"
}
```

Attachment: **[ph1234.pdf.gz](https://github.com/sagemath/sage/files/ticket26676/ph1234.pdf.gz)**



---

archive/issue_comments_413845.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nReplying to [@hadipourh](#comment%3A3):\n> Replying to [tmonteil](#comment%3A2):\n> > As suggested by Jeroen, you should provide explicit (if possible minimal) code so that we can understand the actual issue and work from something. There might indeed be an issue with boolean equations since it relied on a `learnt_clauses` method that does not exist anymore, and the code lacks of doctests.\n> > \n> > By the way, a good way to hint some developer about an issue is to add her nickname in the CC field so that she could recieve an email. In the title, author field or keywords field, only the people who have a regular look at the timeline will notice.\n\n> \n> Dear Monteli,\n> \\\\\n\n> Regarding to explicit code for understanding the actual issue: I'll upload a code that generate a system of boolean equations which shows the issue exactly. This system of equations is extracted from a stream cipher called Bivium-B and I've solved it several times in Sage 7.2, and I'm certain that it has a unique solution, but when I want to solve it via the newer versions of [SageMath](../wiki/SageMath) (after 8.0), solver returns False as the output, which means there is not any solutions!\n> I'll upload the code as soon as possible.\n> \n> Thanks in advance for your help\n\nDear Monteli, \\\\\nHere's the code which shows the issue. This script generates 441 cubic equations for the SBox of the AES cipher. The SBox is a bijective function from \nGF(2)<sup>8</sup> to GF(2)<sup>8</sup>. for example let (y0, y1, ..., y7) = S(x0, x1, ..., x7) and we have system of 441 equations like this: \\\\\nf1(x0, ..., x8, y0, ..., y7) = 0\\\\\n.\\\\\n.\\\\\n.\\\\\nf441(x0, ..., x8, y0, ..., y7) = 0\\\\\n\nwhich it's solutions must satisfy the (y0, y1, ..., y7) = S(x0, x1, ..., x7) relation. Since S is a bijective function from GF(2)<sup>8</sup> to GF(2)<sup>8</sup>, there are at least 256 solutions for the above system of equations. But when I used solve_sat to solve the above system of equations, it returned only 27 solutions which shows that the solve_sat can't find all solutions even the parameter \"n\" in solve_sat command is equal to \"infinity\"!\n\n\n## A Sage script which generates the cubic equations of the AES SBox and solves it via the solve_sat command:\n\n```\nfrom sage.rings.polynomial.multi_polynomial_sequence import PolynomialSequence\nfrom sage.sat.boolean_polynomials import solve as solve_sat\nsr = sage.crypto.mq.SR(1, 4, 4, 8, allow_zero_inversions = True)\nsb = sr.sbox()\neqs = sb.polynomials(degree = 3)\neqs = PolynomialSequence(eqs)\nvariables = map(str, eqs.variables())\nvariables = \",\".join(variables)\nR = BooleanPolynomialRing(16, variables)\neqs = map(R, eqs)\n%time sls_aes = solve_sat(eqs, n = infinity, s_verbosity = 8)\nprint(\"Number of solutions = %s\" % len(sls_aes))\n```\nWhen I executed the above code in my own laptop, I got the bellow solutions:\n\n```\nCPU times: user 6.49 s, sys: 10.3 s, total: 16.8 s\nWall time: 23.1 s\nNumber of solutions = 27\n```\n\nIn addition, I feel the run-time of solve_sat has been increased in comparison with previous versions.",
    "created_at": "2018-11-13T19:23:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413845",
    "user": "https://github.com/hadipourh"
}
```

<a id='comment:4'>Comment 4:</a>
Replying to [@hadipourh](#comment%3A3):
> Replying to [tmonteil](#comment%3A2):
> > As suggested by Jeroen, you should provide explicit (if possible minimal) code so that we can understand the actual issue and work from something. There might indeed be an issue with boolean equations since it relied on a `learnt_clauses` method that does not exist anymore, and the code lacks of doctests.
> > 
> > By the way, a good way to hint some developer about an issue is to add her nickname in the CC field so that she could recieve an email. In the title, author field or keywords field, only the people who have a regular look at the timeline will notice.

> 
> Dear Monteli,
> \\

> Regarding to explicit code for understanding the actual issue: I'll upload a code that generate a system of boolean equations which shows the issue exactly. This system of equations is extracted from a stream cipher called Bivium-B and I've solved it several times in Sage 7.2, and I'm certain that it has a unique solution, but when I want to solve it via the newer versions of [SageMath](../wiki/SageMath) (after 8.0), solver returns False as the output, which means there is not any solutions!
> I'll upload the code as soon as possible.
> 
> Thanks in advance for your help

Dear Monteli, \\
Here's the code which shows the issue. This script generates 441 cubic equations for the SBox of the AES cipher. The SBox is a bijective function from 
GF(2)<sup>8</sup> to GF(2)<sup>8</sup>. for example let (y0, y1, ..., y7) = S(x0, x1, ..., x7) and we have system of 441 equations like this: \\
f1(x0, ..., x8, y0, ..., y7) = 0\\
.\\
.\\
.\\
f441(x0, ..., x8, y0, ..., y7) = 0\\

which it's solutions must satisfy the (y0, y1, ..., y7) = S(x0, x1, ..., x7) relation. Since S is a bijective function from GF(2)<sup>8</sup> to GF(2)<sup>8</sup>, there are at least 256 solutions for the above system of equations. But when I used solve_sat to solve the above system of equations, it returned only 27 solutions which shows that the solve_sat can't find all solutions even the parameter "n" in solve_sat command is equal to "infinity"!


## A Sage script which generates the cubic equations of the AES SBox and solves it via the solve_sat command:

```
from sage.rings.polynomial.multi_polynomial_sequence import PolynomialSequence
from sage.sat.boolean_polynomials import solve as solve_sat
sr = sage.crypto.mq.SR(1, 4, 4, 8, allow_zero_inversions = True)
sb = sr.sbox()
eqs = sb.polynomials(degree = 3)
eqs = PolynomialSequence(eqs)
variables = map(str, eqs.variables())
variables = ",".join(variables)
R = BooleanPolynomialRing(16, variables)
eqs = map(R, eqs)
%time sls_aes = solve_sat(eqs, n = infinity, s_verbosity = 8)
print("Number of solutions = %s" % len(sls_aes))
```
When I executed the above code in my own laptop, I got the bellow solutions:

```
CPU times: user 6.49 s, sys: 10.3 s, total: 16.8 s
Wall time: 23.1 s
Number of solutions = 27
```

In addition, I feel the run-time of solve_sat has been increased in comparison with previous versions.



---

archive/issue_events_348834.json:
```json
{
    "actor": "https://github.com/hadipourh",
    "created_at": "2018-11-15T07:31:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348834"
}
```



---

archive/issue_events_348835.json:
```json
{
    "actor": "https://github.com/hadipourh",
    "created_at": "2018-11-15T07:31:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348835"
}
```



---

archive/issue_comments_413846.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nHi,\n\nI can add a small example which might help to fix the problem:\n\n```\nvarl = ['k{0}'.format(p) for p in range(29)]  # no solution\n\nB = BooleanPolynomialRing(names = varl)\nB.inject_variables(verbose=False)\n\nkeqs = [\n    k0 + k6 + 1,\n    k3 + k9 + 1,\n    k5*k18 + k6*k18 + k7*k16 + k7*k10,\n    k9*k17 + k8*k24 + k11*k17,\n    k1*k13 + k1*k15 + k2*k12 + k3*k15 + k4*k14,\n    k5*k18 + k6*k16 + k7*k18,\n    k3 + k26,\n    k0 + k19,\n    k9 + k28,\n    k11 + k20]\n\nfrom sage.sat.boolean_polynomials import solve as solve_sat\n\nkpsol = solve_sat(keqs, n=1)\n```\nThe Boolean equation system (ANF) definitly has a solution but `solve_sat()` returns `False`.\n\nThe interface to cryptominisat implemented in src/sage/sat/solvers/cryptominisat.py\nhas a bug in the enumeration of the CNF variables. This bug results in faulty ANF to CNF conversion and failures in the solver routine `sat.boolean_polynomials.solve()`.\n\nWhen using the ANF to CNF converter `CNFEncoder` with the solver `CryptoMiniSat` (which the function `sat.boolean_polynomials.solve()` does) with this example some of the variable indices are re-used for different monomials of the ANF which is a bug.\n\nThe variable indices used when converting the fifth equation (`k1*k13 + k1*k15 + k2*k12 + k3*k15 + k4*k14`) get re-used when converting equations with the monomials `k26` and `k28`.\n\nWhen using the `DIMACS` solver instead, the conversion to CNF works correctly, the resulting CNF file can be solved by a SAT solver.\n\nComparing the functions in src/sage/sat/solvers/cryptominisat.py and src/sage/sat/solvers/dimacs.py I see discrepancies, for example in the functions `var()` and `add_clause()`.\n\nThis bug is also present in the picosat binding, I think.\n\nAny ideas?\n\nRegards, J\u00f6rg.",
    "created_at": "2018-12-17T18:31:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413846",
    "user": "https://github.com/jvpeetz"
}
```

<a id='comment:6'>Comment 6:</a>
Hi,

I can add a small example which might help to fix the problem:

```
varl = ['k{0}'.format(p) for p in range(29)]  # no solution

B = BooleanPolynomialRing(names = varl)
B.inject_variables(verbose=False)

keqs = [
    k0 + k6 + 1,
    k3 + k9 + 1,
    k5*k18 + k6*k18 + k7*k16 + k7*k10,
    k9*k17 + k8*k24 + k11*k17,
    k1*k13 + k1*k15 + k2*k12 + k3*k15 + k4*k14,
    k5*k18 + k6*k16 + k7*k18,
    k3 + k26,
    k0 + k19,
    k9 + k28,
    k11 + k20]

from sage.sat.boolean_polynomials import solve as solve_sat

kpsol = solve_sat(keqs, n=1)
```
The Boolean equation system (ANF) definitly has a solution but `solve_sat()` returns `False`.

The interface to cryptominisat implemented in src/sage/sat/solvers/cryptominisat.py
has a bug in the enumeration of the CNF variables. This bug results in faulty ANF to CNF conversion and failures in the solver routine `sat.boolean_polynomials.solve()`.

When using the ANF to CNF converter `CNFEncoder` with the solver `CryptoMiniSat` (which the function `sat.boolean_polynomials.solve()` does) with this example some of the variable indices are re-used for different monomials of the ANF which is a bug.

The variable indices used when converting the fifth equation (`k1*k13 + k1*k15 + k2*k12 + k3*k15 + k4*k14`) get re-used when converting equations with the monomials `k26` and `k28`.

When using the `DIMACS` solver instead, the conversion to CNF works correctly, the resulting CNF file can be solved by a SAT solver.

Comparing the functions in src/sage/sat/solvers/cryptominisat.py and src/sage/sat/solvers/dimacs.py I see discrepancies, for example in the functions `var()` and `add_clause()`.

This bug is also present in the picosat binding, I think.

Any ideas?

Regards, Jörg.



---

archive/issue_comments_413847.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nA remedy for this bug is (at least for my little example) to change the `var()` function in `local/lib/python2.7/site-packages/sage/sat/solvers/cryptominisat.py` (source file is in `src/sage/sat/solvers/cryptominisat.py`) from\n\n```\n        return self._nvars + 1\n```\nto\n\n```\n        self._nvars += 1\n        return self._nvars\n```\nwhich corresponds to the code of the `DIMACS` solver. Removing the file `cryptominisat.pyc`, starting sage and importing `CryptoMiniSat` will use the modified version of `cryptominisat.py`.\nWith this modification the ANF to CNF converter `CNFEncoder` produces the same CNF with `CryptoMiniSat` as with `DIMACS` as solver. And my example can be solved by `sat.boolean_polynomials.solve()`.\n\nRegards,\nJ\u00f6rg.",
    "created_at": "2018-12-19T17:03:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413847",
    "user": "https://github.com/jvpeetz"
}
```

<a id='comment:7'>Comment 7:</a>
A remedy for this bug is (at least for my little example) to change the `var()` function in `local/lib/python2.7/site-packages/sage/sat/solvers/cryptominisat.py` (source file is in `src/sage/sat/solvers/cryptominisat.py`) from

```
        return self._nvars + 1
```
to

```
        self._nvars += 1
        return self._nvars
```
which corresponds to the code of the `DIMACS` solver. Removing the file `cryptominisat.pyc`, starting sage and importing `CryptoMiniSat` will use the modified version of `cryptominisat.py`.
With this modification the ANF to CNF converter `CNFEncoder` produces the same CNF with `CryptoMiniSat` as with `DIMACS` as solver. And my example can be solved by `sat.boolean_polynomials.solve()`.

Regards,
Jörg.



---

archive/issue_comments_413848.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nDear J\u00f6rg,\n\nI did as you said. It works for my example too. I think this modification solves the problem. I appreciate your time and efforts.\n\nSincerely, H. Hadipour",
    "created_at": "2018-12-20T19:43:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413848",
    "user": "https://github.com/hadipourh"
}
```

<a id='comment:8'>Comment 8:</a>
Dear Jörg,

I did as you said. It works for my example too. I think this modification solves the problem. I appreciate your time and efforts.

Sincerely, H. Hadipour



---

archive/issue_comments_413849.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nGreat ! Should i go ahead and upload a branch with the fix (and doctests to avoid further regressions), or do you want to fix it yourself ?",
    "created_at": "2018-12-20T19:50:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413849",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<a id='comment:9'>Comment 9:</a>
Great ! Should i go ahead and upload a branch with the fix (and doctests to avoid further regressions), or do you want to fix it yourself ?



---

archive/issue_comments_413850.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nHi Thierry,\n\nit's fine with me if you uploa\nd the fixes. As I mentioned this fix might also apply to the picosat binding.\n\nBy the way, thanks for making the newer version of [CryptoMiniSat](https://github.com/msoos/cryptominisat) available in [SageMath](../wiki/SageMath).\n\nRegards, J\u00f6rg.",
    "created_at": "2018-12-21T09:18:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413850",
    "user": "https://github.com/jvpeetz"
}
```

<a id='comment:10'>Comment 10:</a>
Hi Thierry,

it's fine with me if you uploa
d the fixes. As I mentioned this fix might also apply to the picosat binding.

By the way, thanks for making the newer version of [CryptoMiniSat](https://github.com/msoos/cryptominisat) available in [SageMath](../wiki/SageMath).

Regards, Jörg.



---

archive/issue_comments_413851.json:
```json
{
    "body": "Branch: **[u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers)**",
    "created_at": "2018-12-21T15:21:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413851",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Branch: **[u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers)**



---

archive/issue_comments_413852.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b\">c492724</a></td><td><code>#26676 : add doctests for solving boolean polynomial systems with picosat</code></td></tr></table>\n",
    "created_at": "2018-12-21T15:37:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413852",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:12'>Comment 12:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b">c492724</a></td><td><code>#26676 : add doctests for solving boolean polynomial systems with picosat</code></td></tr></table>




---

archive/issue_comments_413853.json:
```json
{
    "body": "Commit: **[c492724](https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b)**",
    "created_at": "2018-12-21T15:37:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413853",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[c492724](https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b)**



---

archive/issue_events_348836.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-12-21T15:43:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348836"
}
```



---

archive/issue_events_348837.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-12-21T15:43:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348837"
}
```



---

archive/issue_events_348838.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-12-21T15:43:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20experimental",
    "label_color": "000080",
    "label_name": "component: packages: experimental",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348838"
}
```



---

archive/issue_events_348839.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-12-21T15:43:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "component: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348839"
}
```



---

archive/issue_comments_413854.json:
```json
{
    "body": "Author: **Thierry Monteil**",
    "created_at": "2018-12-21T15:43:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413854",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Author: **Thierry Monteil**



---

archive/issue_comments_413855.json:
```json
{
    "body": "Changed keywords from **solve_sat, CryptoMiniSat** to **solve_sat, CryptoMiniSat, picosat**",
    "created_at": "2018-12-21T15:43:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413855",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Changed keywords from **solve_sat, CryptoMiniSat** to **solve_sat, CryptoMiniSat, picosat**



---

archive/issue_events_348840.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2018-12-21T15:43:43Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "title_is": "Fix var() method for cryptominisat and picosat, which breaks solve_sat for boolean polynomial systems",
    "title_was": "solve_sat doesn't work correctly after migration of CryptoMiniSat from version 2 to 5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348840"
}
```



---

archive/issue_comments_413856.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nI fixed the `var()` methods in `cryptominisat` and `picosat` and added the two examples you both provided as doctests to prevent future regressions with both solvers.",
    "created_at": "2018-12-21T15:43:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413856",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<a id='comment:13'>Comment 13:</a>
I fixed the `var()` methods in `cryptominisat` and `picosat` and added the two examples you both provided as doctests to prevent future regressions with both solvers.



---

archive/issue_comments_413857.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,4 @@\n When I used Sage7.2, I could easily solve my boolean equations with solve_sat commands, and it's results were verified by the papers and other tools, but when I upgraded my sage to version 8 (or later version) I found that the new solve_sat solver (especially when we use CryptoMiniSat as the SAT solver) doesn't work as correct as before. For example, when I solve a system of equations via solve_sat which used CryptoMiniSat as a SAT solver, I get different number of solutions in different version of [SageMath](../wiki/SageMath). I believe that there is something wrong in newer version of [SageMath](../wiki/SageMath) because my previous experiences shows that the older version's results were verified by the other tools and papers. I hope someone could solve this problem.\n+\n+See also the following thread on sage-devel: https://groups.google.com/forum/?fromgroups#!topic/sage-devel/2EhgHzGgUnQ\n+\n``````\n",
    "created_at": "2018-12-21T15:56:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413857",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,4 @@
 When I used Sage7.2, I could easily solve my boolean equations with solve_sat commands, and it's results were verified by the papers and other tools, but when I upgraded my sage to version 8 (or later version) I found that the new solve_sat solver (especially when we use CryptoMiniSat as the SAT solver) doesn't work as correct as before. For example, when I solve a system of equations via solve_sat which used CryptoMiniSat as a SAT solver, I get different number of solutions in different version of [SageMath](../wiki/SageMath). I believe that there is something wrong in newer version of [SageMath](../wiki/SageMath) because my previous experiences shows that the older version's results were verified by the other tools and papers. I hope someone could solve this problem.
+
+See also the following thread on sage-devel: https://groups.google.com/forum/?fromgroups#!topic/sage-devel/2EhgHzGgUnQ
+
``````




---

archive/issue_comments_413858.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nJust to state the obvious: if nobody review this ticket, it will never get merged.",
    "created_at": "2018-12-30T23:54:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413858",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<a id='comment:15'>Comment 15:</a>
Just to state the obvious: if nobody review this ticket, it will never get merged.



---

archive/issue_comments_413859.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nok",
    "created_at": "2018-12-31T10:02:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413859",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:16'>Comment 16:</a>
ok



---

archive/issue_events_348841.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-12-31T10:02:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348841"
}
```



---

archive/issue_events_348842.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2018-12-31T10:02:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348842"
}
```



---

archive/issue_comments_413860.json:
```json
{
    "body": "Reviewer: **Fr\u00e9d\u00e9ric Chapoton**",
    "created_at": "2018-12-31T10:02:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413860",
    "user": "https://github.com/fchapoton"
}
```

Reviewer: **Frédéric Chapoton**



---

archive/issue_events_348843.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-02T10:59:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "milestone_number": null,
    "milestone_title": "sage-8.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348843"
}
```



---

archive/issue_events_348844.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-01-02T10:59:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348844"
}
```



---

archive/issue_events_348845.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-03T09:34:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348845"
}
```



---

archive/issue_events_348846.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a4cf8a177c0ec4278aae71e844848f3582ac1a3e",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2019-01-03T09:34:01Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26676#event-348846"
}
```



---

archive/issue_comments_413861.json:
```json
{
    "body": "Changed branch from **[u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers)** to **[c492724](https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b)**",
    "created_at": "2019-01-03T09:34:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26676",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26676#issuecomment-413861",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers](https://github.com/sagemath/sagetrac-mirror/tree/u/tmonteil/fix_var_for_cryptominisat_and_picosat_solvers)** to **[c492724](https://github.com/sagemath/sagetrac-mirror/commit/c492724e2af4918c65360b82cded10f1f9d5877b)**
