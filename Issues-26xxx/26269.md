# Issue 26269: Implement lean_matrix.RationalMatrix using mpq

archive/issues_026032.json:
```json
{
    "body": "There are special `LeanMatrices` for matroids for `GF(k)` with `k = 2,3,4` and for matrices with entires `+-1` and `0`. However, `QQ` is a common realization field for matroids, so we should implement a custom subclass of `LeanMatrix` for working over `QQ` that directly manipulates an array of mpq values. This way Cython can optimize these code paths rather than falling back on the generic implementation.\n\nCC:  rudi stefan yomcat @jdemeyer\n\nKeywords: rational matrix\n\nBranch/Commit: bdb25457f281bd59ceaab5df9814e293197e7ae0\n\nReviewer: Fr\u00e9d\u00e9ric Chapoton\n\nAuthor: Travis Scrimshaw\n\nDependencies: #26237\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26269\n\n",
    "closed_at": "2021-07-18T22:53:44Z",
    "created_at": "2018-09-13T10:38:37Z",
    "labels": [
        "component: matroid theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Implement lean_matrix.RationalMatrix using mpq",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26269",
    "user": "https://github.com/tscrim"
}
```
There are special `LeanMatrices` for matroids for `GF(k)` with `k = 2,3,4` and for matrices with entires `+-1` and `0`. However, `QQ` is a common realization field for matroids, so we should implement a custom subclass of `LeanMatrix` for working over `QQ` that directly manipulates an array of mpq values. This way Cython can optimize these code paths rather than falling back on the generic implementation.

CC:  rudi stefan yomcat @jdemeyer

Keywords: rational matrix

Branch/Commit: bdb25457f281bd59ceaab5df9814e293197e7ae0

Reviewer: Frédéric Chapoton

Author: Travis Scrimshaw

Dependencies: #26237

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26269





---

archive/issue_comments_505181.json:
```json
{
    "body": "Changing commit from \"\" to \"4efe38c5bbcb026ab58882fe11430e4eeb6513cc\"",
    "created_at": "2018-09-14T01:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505181",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "" to "4efe38c5bbcb026ab58882fe11430e4eeb6513cc"



---

archive/issue_comments_505182.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2018-09-14T01:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505182",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_505183.json:
```json
{
    "body": "Changing branch from \"\" to \"public/matroids/implement_rational_matrix-26269\"",
    "created_at": "2018-09-14T01:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505183",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "" to "public/matroids/implement_rational_matrix-26269"



---

archive/issue_comments_505184.json:
```json
{
    "body": "Changing commit from \"4efe38c5bbcb026ab58882fe11430e4eeb6513cc\" to \"6f9701190cb06ecaec864bbb6b3a25c616105114\"",
    "created_at": "2018-09-14T02:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505184",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4efe38c5bbcb026ab58882fe11430e4eeb6513cc" to "6f9701190cb06ecaec864bbb6b3a25c616105114"



---

archive/issue_comments_505185.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-14T02:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505185",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_505186.json:
```json
{
    "body": "Changing commit from \"6f9701190cb06ecaec864bbb6b3a25c616105114\" to \"4abf2582cece74c51d334339a5092f7af469e71a\"",
    "created_at": "2018-09-14T03:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505186",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "6f9701190cb06ecaec864bbb6b3a25c616105114" to "4abf2582cece74c51d334339a5092f7af469e71a"



---

archive/issue_comments_505187.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-14T03:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505187",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_505188.json:
```json
{
    "body": "<a id='comment:4'></a>Okay, things seem to work now. I also fixed a bug with `IntegerMatrix.resize`.\n\nHere is my test case:\n\n```\nsage: W = WeylGroup(['F',4], prefix='s')\nsage: def test(W):\n....:     d = {}\n....:     for w in W:\n....:         I = w.inversion_arrangement()\n....:         M = I.matroid()\n....:         c = M.chordality()\n....:         if c in d:\n....:             d[c].append(w)\n....:         else:\n....:             d[c] = [w]\n....:     return d\nsage: %time d = test(W)\nCPU times: user 19.4 s, sys: 12 ms, total: 19.4 s\nWall time: 19.4 s\n```\nvs before\n\n```\nsage: %time d = test(W)\nCPU times: user 40.1 s, sys: 8 ms, total: 40.1 s\nWall time: 40.1 s\n```\n\nPerhaps Jeroen has some extra tricks for getting some more speed out, but I am happy with a ~2x speedup.",
    "created_at": "2018-09-14T03:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505188",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>Okay, things seem to work now. I also fixed a bug with `IntegerMatrix.resize`.

Here is my test case:

```
sage: W = WeylGroup(['F',4], prefix='s')
sage: def test(W):
....:     d = {}
....:     for w in W:
....:         I = w.inversion_arrangement()
....:         M = I.matroid()
....:         c = M.chordality()
....:         if c in d:
....:             d[c].append(w)
....:         else:
....:             d[c] = [w]
....:     return d
sage: %time d = test(W)
CPU times: user 19.4 s, sys: 12 ms, total: 19.4 s
Wall time: 19.4 s
```
vs before

```
sage: %time d = test(W)
CPU times: user 40.1 s, sys: 8 ms, total: 40.1 s
Wall time: 40.1 s
```

Perhaps Jeroen has some extra tricks for getting some more speed out, but I am happy with a ~2x speedup.



---

archive/issue_comments_505189.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-14T03:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505189",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_505190.json:
```json
{
    "body": "Changing commit from \"4abf2582cece74c51d334339a5092f7af469e71a\" to \"70fcd3c15a880fdfd809d51cdca36c7c15a476af\"",
    "created_at": "2018-09-14T03:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4abf2582cece74c51d334339a5092f7af469e71a" to "70fcd3c15a880fdfd809d51cdca36c7c15a476af"



---

archive/issue_comments_505191.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-14T03:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505191",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_505192.json:
```json
{
    "body": "<a id='comment:6'></a>Okay, I should have checked better. The change to `IntegerMatrix.resize()` did not fix the crash. So I reverted them. Here is the current state (which should be the same on vanilla 8.4.beta4):\n\n```\nsage: from sage.matroids.lean_matrix import IntegerMatrix\nsage: IM = IntegerMatrix(2, 2, matrix(2,2))\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>, (0, (2, 2, [0, 0, 0, 0])))\nsage: %%cython\n....: from sage.matroids.lean_matrix cimport IntegerMatrix\n....: def resize(R, k):\n....:     (<IntegerMatrix?> R).resize(k)\n....: \nsage: resize(IM, 3)\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>, (0, (3, 2, [0, 0, 0, 0, 32, 0])))\nsage: resize(IM, 5)\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>,\n (0, (5, 2, [90453552, 0, 81528480, 0, 32, 0, 944, 0, 2, 0])))\nsage: IM = IntegerMatrix(2, 2, matrix(2,2))  # Crash\n```\n\n```\nsage: resize(IM, 1)\nsage: IM.__reduce__()\n(<built-in function unpickle_integer_matrix>, (0, (1, 2, [0, 0])))\nsage: resize(IM, 3)\n*** Error in `/home/uqtscrim/sage-build/local/bin/python2': realloc(): invalid next size: 0x0000000004b42580 ***\n```\nHowever, this deserves to also be a separate ticket.",
    "created_at": "2018-09-14T03:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505192",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>Okay, I should have checked better. The change to `IntegerMatrix.resize()` did not fix the crash. So I reverted them. Here is the current state (which should be the same on vanilla 8.4.beta4):

```
sage: from sage.matroids.lean_matrix import IntegerMatrix
sage: IM = IntegerMatrix(2, 2, matrix(2,2))
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (2, 2, [0, 0, 0, 0])))
sage: %%cython
....: from sage.matroids.lean_matrix cimport IntegerMatrix
....: def resize(R, k):
....:     (<IntegerMatrix?> R).resize(k)
....: 
sage: resize(IM, 3)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (3, 2, [0, 0, 0, 0, 32, 0])))
sage: resize(IM, 5)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>,
 (0, (5, 2, [90453552, 0, 81528480, 0, 32, 0, 944, 0, 2, 0])))
sage: IM = IntegerMatrix(2, 2, matrix(2,2))  # Crash
```

```
sage: resize(IM, 1)
sage: IM.__reduce__()
(<built-in function unpickle_integer_matrix>, (0, (1, 2, [0, 0])))
sage: resize(IM, 3)
*** Error in `/home/uqtscrim/sage-build/local/bin/python2': realloc(): invalid next size: 0x0000000004b42580 ***
```
However, this deserves to also be a separate ticket.



---

archive/issue_comments_505193.json:
```json
{
    "body": "<a id='comment:7'></a>Wrong ticket (suppose to be #26237). Patchbot here has some errors that I need to fix.",
    "created_at": "2018-09-14T05:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505193",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Wrong ticket (suppose to be #26237). Patchbot here has some errors that I need to fix.



---

archive/issue_comments_505194.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-09-14T05:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505194",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_505195.json:
```json
{
    "body": "Changing commit from \"70fcd3c15a880fdfd809d51cdca36c7c15a476af\" to \"040b052276268ca9d95cc6901b5a13d21b7999c4\"",
    "created_at": "2018-09-14T22:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505195",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "70fcd3c15a880fdfd809d51cdca36c7c15a476af" to "040b052276268ca9d95cc6901b5a13d21b7999c4"



---

archive/issue_comments_505196.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-14T22:30:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_505197.json:
```json
{
    "body": "<a id='comment:10'></a>Okay, this one is now ready.",
    "created_at": "2018-09-14T22:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505197",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Okay, this one is now ready.



---

archive/issue_comments_505198.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-14T22:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505198",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_505199.json:
```json
{
    "body": "<a id='comment:11'></a>Now with green patchbot. :)",
    "created_at": "2018-09-15T05:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505199",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Now with green patchbot. :)



---

archive/issue_comments_505200.json:
```json
{
    "body": "Changing branch from \"public/matroids/implement_rational_matrix-26269\" to \"public/matroids/implement_mpq_rational_matrix-26269\"",
    "created_at": "2018-09-16T22:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505200",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "public/matroids/implement_rational_matrix-26269" to "public/matroids/implement_mpq_rational_matrix-26269"



---

archive/issue_comments_505201.json:
```json
{
    "body": "<a id='comment:12'></a>Rebased branch over last commit in #26237.\n\n---\nNew commits:",
    "created_at": "2018-09-16T22:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505201",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>Rebased branch over last commit in #26237.

---
New commits:



---

archive/issue_comments_505202.json:
```json
{
    "body": "Changing commit from \"040b052276268ca9d95cc6901b5a13d21b7999c4\" to \"bdb25457f281bd59ceaab5df9814e293197e7ae0\"",
    "created_at": "2018-09-16T22:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505202",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "040b052276268ca9d95cc6901b5a13d21b7999c4" to "bdb25457f281bd59ceaab5df9814e293197e7ae0"



---

archive/issue_comments_505203.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-08T06:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505203",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_505204.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Fr\u00e9d\u00e9ric Chapoton\"",
    "created_at": "2021-07-08T06:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505204",
    "user": "https://github.com/fchapoton"
}
```

Changing reviewer from "" to "Frédéric Chapoton"



---

archive/issue_comments_505205.json:
```json
{
    "body": "<a id='comment:13'></a>ok, let's move on",
    "created_at": "2021-07-08T06:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505205",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:13'></a>ok, let's move on



---

archive/issue_events_065390.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-08T14:21:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26269#event-65390"
}
```



---

archive/issue_events_065391.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-18T22:53:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26269#event-65391"
}
```



---

archive/issue_comments_505206.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-18T22:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505206",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_505207.json:
```json
{
    "body": "Changing branch from \"public/matroids/implement_mpq_rational_matrix-26269\" to \"bdb25457f281bd59ceaab5df9814e293197e7ae0\"",
    "created_at": "2021-07-18T22:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26269#issuecomment-505207",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/matroids/implement_mpq_rational_matrix-26269" to "bdb25457f281bd59ceaab5df9814e293197e7ae0"
