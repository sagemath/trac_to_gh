# Issue 26425: Conversion problem between Laurent polynomial ring and its field of fractions

archive/issues_026188.json:
```json
{
    "body": "CC:  @tscrim simonking\n\nKeywords: coercion, laurent plynomial, field of fraction, days100\n\nThe issue is explained by the following example:\n\n```\nsage: R.<t> = LaurentPolynomialRing(ZZ)\nsage: F = FractionField(R)\nsage: R(F(1/t))\nTraceback (most recent call last):\n...\nTypeError: fraction must have unit denominator\n```\nThere is a natural conversion back to the Laurent polynomials. Most likely the denominator is not being checked if it is a unit in `R`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26425\n\n",
    "closed_at": "2019-07-27T19:51:19Z",
    "created_at": "2018-10-07T09:23:14Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Conversion problem between Laurent polynomial ring and its field of fractions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26425",
    "user": "https://github.com/soehms"
}
```
CC:  @tscrim simonking

Keywords: coercion, laurent plynomial, field of fraction, days100

The issue is explained by the following example:

```
sage: R.<t> = LaurentPolynomialRing(ZZ)
sage: F = FractionField(R)
sage: R(F(1/t))
Traceback (most recent call last):
...
TypeError: fraction must have unit denominator
```
There is a natural conversion back to the Laurent polynomials. Most likely the denominator is not being checked if it is a unit in `R`.

Issue created by migration from https://trac.sagemath.org/ticket/26425





---

archive/issue_comments_368576.json:
```json
{
    "body": "This is not a coercion, but a conversion (as it does not have to be defined going back to `R`).",
    "created_at": "2018-10-07T10:22:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368576",
    "user": "https://github.com/tscrim"
}
```

This is not a coercion, but a conversion (as it does not have to be defined going back to `R`).



---

archive/issue_comments_368577.json:
```json
{
    "body": "Changing keywords from \"coercion, laurent plynomial, field of fraction\" to \"coercion, laurent plynomial, field of fraction, days100\".",
    "created_at": "2019-07-19T20:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368577",
    "user": "https://github.com/soehms"
}
```

Changing keywords from "coercion, laurent plynomial, field of fraction" to "coercion, laurent plynomial, field of fraction, days100".



---

archive/issue_events_065692.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2019-07-19T20:11:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26425#event-65692"
}
```



---

archive/issue_comments_368578.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-23T12:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368578",
    "user": "https://github.com/soehms"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_368579.json:
```json
{
    "body": "The check for being a unit is performed in the section map of the natural inclusion of a ring into its ring of fractions. Thus, since this ring is not the Laurent polynomial ring itself but the corresponding polynomial ring, that test fails.\n\nMy attempt for a fix is to implement the conversion in the `_element_constructor` of the Laurent polynomial ring!\n\n---\nNew commits:",
    "created_at": "2019-07-23T12:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368579",
    "user": "https://github.com/soehms"
}
```

The check for being a unit is performed in the section map of the natural inclusion of a ring into its ring of fractions. Thus, since this ring is not the Laurent polynomial ring itself but the corresponding polynomial ring, that test fails.

My attempt for a fix is to implement the conversion in the `_element_constructor` of the Laurent polynomial ring!

---
New commits:



---

archive/issue_comments_368580.json:
```json
{
    "body": "Note this:\n\n```\nsage: R.<t> = LaurentPolynomialRing(ZZ)\nsage: t.is_unit()\nTrue\n```\nSo, things SHOULD work, as the denominator of `1/t` is a unit. But:\n\n```\nsage: T = F(1/t)\nsage: T.denominator().parent()\nUnivariate Polynomial Ring in t over Integer Ring\nsage: R.fraction_field() is R.polynomial_ring().fraction_field()\nTrue\n```\nIsn't that a bug? EDIT: No, because mathematically the two fraction fields are isomorphic.\n\nActually I recall that a couple of years ago I tried to let `FractionField(R)` be the `LaurentSeriesRing`, which mathematically is correct. EDIT: ... correct in the same way as the current fraction field is correct.\n\nI think the following patch is not optimal:\n\n```diff\n+            P = x.parent()\n+            if P.ring() == self.polynomial_ring():\n+                d = self(x.denominator())\n+                if not d.is_unit():\n+                     raise TypeError(\"fraction must have unit denominator\")\n+                return self(x.numerator()) * d.inverse_of_unit()\n```\nI think we don't want to test that `P.ring() == self.polynomial_ring()`, but it is enough that `self.polynomial_ring().has_coerce_map_from(P.ring())`.\n\nOr even better: We are talking about conversion here. So, there is no need to test whether the denominator coerces into `self`. We could just do\n\n```diff\n+        elif isinstance(x, FractionFieldElement):\n+            # since the field of fraction of self is defined corresponding to the polynomial ring of self\n+            # the conversion of its elements back must be treated separately (:trac:`26425`).\n+            d = self(x.denominator())\n+            if not d.is_unit():\n+                 raise TypeError(\"fraction must have unit denominator\")\n+            return self(x.numerator()) * d.inverse_of_unit()\n```",
    "created_at": "2019-07-24T09:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368580",
    "user": "https://github.com/simon-king-jena"
}
```

Note this:

```
sage: R.<t> = LaurentPolynomialRing(ZZ)
sage: t.is_unit()
True
```
So, things SHOULD work, as the denominator of `1/t` is a unit. But:

```
sage: T = F(1/t)
sage: T.denominator().parent()
Univariate Polynomial Ring in t over Integer Ring
sage: R.fraction_field() is R.polynomial_ring().fraction_field()
True
```
Isn't that a bug? EDIT: No, because mathematically the two fraction fields are isomorphic.

Actually I recall that a couple of years ago I tried to let `FractionField(R)` be the `LaurentSeriesRing`, which mathematically is correct. EDIT: ... correct in the same way as the current fraction field is correct.

I think the following patch is not optimal:

```diff
+            P = x.parent()
+            if P.ring() == self.polynomial_ring():
+                d = self(x.denominator())
+                if not d.is_unit():
+                     raise TypeError("fraction must have unit denominator")
+                return self(x.numerator()) * d.inverse_of_unit()
```
I think we don't want to test that `P.ring() == self.polynomial_ring()`, but it is enough that `self.polynomial_ring().has_coerce_map_from(P.ring())`.

Or even better: We are talking about conversion here. So, there is no need to test whether the denominator coerces into `self`. We could just do

```diff
+        elif isinstance(x, FractionFieldElement):
+            # since the field of fraction of self is defined corresponding to the polynomial ring of self
+            # the conversion of its elements back must be treated separately (:trac:`26425`).
+            d = self(x.denominator())
+            if not d.is_unit():
+                 raise TypeError("fraction must have unit denominator")
+            return self(x.numerator()) * d.inverse_of_unit()
```



---

archive/issue_comments_368581.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-24T11:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368581",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368582.json:
```json
{
    "body": "Replying to [comment:8 SimonKing]:\n> Or even better: We are talking about conversion here. So, there is no need to test whether the denominator coerces into `self`. We could just do\n> \n> ```\n> #!diff\n> +        elif isinstance(x, FractionFieldElement):\n> +            # since the field of fraction of self is defined corresponding to the polynomial ring of self\n> +            # the conversion of its elements back must be treated separately (:trac:`26425`).\n> +            d = self(x.denominator())\n> +            if not d.is_unit():\n> +                 raise TypeError(\"fraction must have unit denominator\")\n> +            return self(x.numerator()) * d.inverse_of_unit()\n> ```\n\nAs we talked before, the check was just matter of caution. I agree to have that removed!",
    "created_at": "2019-07-24T11:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368582",
    "user": "https://github.com/soehms"
}
```

Replying to [comment:8 SimonKing]:
> Or even better: We are talking about conversion here. So, there is no need to test whether the denominator coerces into `self`. We could just do
> 
> ```
> #!diff
> +        elif isinstance(x, FractionFieldElement):
> +            # since the field of fraction of self is defined corresponding to the polynomial ring of self
> +            # the conversion of its elements back must be treated separately (:trac:`26425`).
> +            d = self(x.denominator())
> +            if not d.is_unit():
> +                 raise TypeError("fraction must have unit denominator")
> +            return self(x.numerator()) * d.inverse_of_unit()
> ```

As we talked before, the check was just matter of caution. I agree to have that removed!



---

archive/issue_comments_368583.json:
```json
{
    "body": "You need two `:` at the end of this line\n\n```\n+        Check that conversion back from fraction field does work (:trac:`26425`):\n```",
    "created_at": "2019-07-24T15:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368583",
    "user": "https://github.com/videlec"
}
```

You need two `:` at the end of this line

```
+        Check that conversion back from fraction field does work (:trac:`26425`):
```



---

archive/issue_comments_368584.json:
```json
{
    "body": "I fixed the missing `::`.\n\nAll but one tests pass. The failing test is\n\n```\nking@klap:~/Sage/git/sage$ ./sage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed\n\nRunning doctests with ID 2019-07-25-00-01-10-c2c7af32.\nGit branch: t/26425/conversion_problem_laurent_fraction_field_26425\nUsing --optional=build,ccache,dochtml,frobby,gap_packages,gdb,gfortran,meataxe,memlimit,mpir,p_group_cohomology,python2,sage\nDoctesting 1 file.\nsage -t --warn-long 47.6 src/doc/common/conf.py\n**********************************************************************\nFile \"src/doc/common/conf.py\", line 662, in doc.common.conf.call_intersphinx\nFailed example:\n    for line in open(thematic_index).readlines():  # optional - dochtml\n        if \"padics\" in line:\n            _ = sys.stdout.write(line)\nExpected:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage Reference Manual: p-Adics v...)\"><span>Introduction to the p-adics</span></a></li>\nGot:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage Reference Manual: p-Adics v8.6.rc1)\"><span>Introduction to the -adics</span></a></li>\n**********************************************************************\n1 item had failures:\n   1 of   4 in doc.common.conf.call_intersphinx\n    [3 tests, 1 failure, 0.01 s]\n----------------------------------------------------------------------\nsage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 0.1 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\nIs that related? Probably not. But before I give a positive review, I'd like to be sure that the error has not been introduced by this ticket.\n\nI added reviewer and author names. Please check for misspellings. \n\n---\nNew commits:",
    "created_at": "2019-07-24T22:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368584",
    "user": "https://github.com/simon-king-jena"
}
```

I fixed the missing `::`.

All but one tests pass. The failing test is

```
king@klap:~/Sage/git/sage$ ./sage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed

Running doctests with ID 2019-07-25-00-01-10-c2c7af32.
Git branch: t/26425/conversion_problem_laurent_fraction_field_26425
Using --optional=build,ccache,dochtml,frobby,gap_packages,gdb,gfortran,meataxe,memlimit,mpir,p_group_cohomology,python2,sage
Doctesting 1 file.
sage -t --warn-long 47.6 src/doc/common/conf.py
**********************************************************************
File "src/doc/common/conf.py", line 662, in doc.common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            _ = sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v8.6.rc1)"><span>Introduction to the -adics</span></a></li>
**********************************************************************
1 item had failures:
   1 of   4 in doc.common.conf.call_intersphinx
    [3 tests, 1 failure, 0.01 s]
----------------------------------------------------------------------
sage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```
Is that related? Probably not. But before I give a positive review, I'd like to be sure that the error has not been introduced by this ticket.

I added reviewer and author names. Please check for misspellings. 

---
New commits:



---

archive/issue_comments_368585.json:
```json
{
    "body": "Indeed:\n\n```\nking@klap:~/Sage/git/sage$ git checkout 8.9.beta3\nHEAD is now at a1e1a8f... Updated SageMath version to 8.9.beta3\nking@klap:~/Sage/git/sage$ ./sage -b\n...\nking@klap:~/Sage/git/sage$ ./sage -t --warn-long 47.6 src/doc/common/conf.py\nRunning doctests with ID 2019-07-25-00-12-53-64443448.\nGit branch: HEAD\nUsing --optional=build,ccache,dochtml,frobby,gap_packages,gdb,gfortran,meataxe,memlimit,mpir,p_group_cohomology,python2,sage\nDoctesting 1 file.\nsage -t --warn-long 47.6 src/doc/common/conf.py\n**********************************************************************\nFile \"src/doc/common/conf.py\", line 662, in doc.common.conf.call_intersphinx\nFailed example:\n    for line in open(thematic_index).readlines():  # optional - dochtml\n        if \"padics\" in line:\n            _ = sys.stdout.write(line)\nExpected:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage Reference Manual: p-Adics v...)\"><span>Introduction to the p-adics</span></a></li>\nGot:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage Reference Manual: p-Adics v8.6.rc1)\"><span>Introduction to the -adics</span></a></li>\n**********************************************************************\n1 item had failures:\n   1 of   4 in doc.common.conf.call_intersphinx\n    [3 tests, 1 failure, 0.01 s]\n----------------------------------------------------------------------\nsage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 0.1 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n\nSince this error has not been introduced by this ticket, I think I can give a positive review. Unless Vincent or someone else disagrees.",
    "created_at": "2019-07-24T22:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368585",
    "user": "https://github.com/simon-king-jena"
}
```

Indeed:

```
king@klap:~/Sage/git/sage$ git checkout 8.9.beta3
HEAD is now at a1e1a8f... Updated SageMath version to 8.9.beta3
king@klap:~/Sage/git/sage$ ./sage -b
...
king@klap:~/Sage/git/sage$ ./sage -t --warn-long 47.6 src/doc/common/conf.py
Running doctests with ID 2019-07-25-00-12-53-64443448.
Git branch: HEAD
Using --optional=build,ccache,dochtml,frobby,gap_packages,gdb,gfortran,meataxe,memlimit,mpir,p_group_cohomology,python2,sage
Doctesting 1 file.
sage -t --warn-long 47.6 src/doc/common/conf.py
**********************************************************************
File "src/doc/common/conf.py", line 662, in doc.common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            _ = sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v8.6.rc1)"><span>Introduction to the -adics</span></a></li>
**********************************************************************
1 item had failures:
   1 of   4 in doc.common.conf.call_intersphinx
    [3 tests, 1 failure, 0.01 s]
----------------------------------------------------------------------
sage -t --warn-long 47.6 src/doc/common/conf.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.1 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```

Since this error has not been introduced by this ticket, I think I can give a positive review. Unless Vincent or someone else disagrees.



---

archive/issue_comments_368586.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-24T22:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368586",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_368587.json:
```json
{
    "body": "Thanks a lot, Simon!",
    "created_at": "2019-07-25T09:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368587",
    "user": "https://github.com/soehms"
}
```

Thanks a lot, Simon!



---

archive/issue_events_065693.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-07-27T19:51:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26425#event-65693"
}
```



---

archive/issue_comments_368588.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-07-27T19:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26425",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26425#issuecomment-368588",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
