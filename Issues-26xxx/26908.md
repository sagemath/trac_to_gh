# Issue 26908: py3: Speed up deprecated_function_alias

archive/issues_026671.json:
```json
{
    "assignees": [],
    "body": "In profiling areas of slowdown during import, one culprit (of likely several) I found was `deprecated_function_alias`.\n\nThis was called 80 times during `import sage.all`, and profiling suggests that a pretty absurd amount time in this, particularly on the line\n\n```\nframe1 = inspect.getouterframes(inspect.currentframe())[1][0]\n```\n\nOn Python 2 kernprof gives:\n\n```\n   513        80        365.0      4.6      0.0      _check_trac_number(trac_number)\n   514        80    1400403.0  17505.0     99.7      frame1 = inspect.getouterframes(inspect.currentframe())[1][0]\n   515        80       2378.0     29.7      0.2      module_name = inspect.getmodulename(frame1.f_code.co_filename)\n   516        80         78.0      1.0      0.0      if module_name is None:\n   517                                                   module_name = '__main__'\n   518        80       1944.0     24.3      0.1      return DeprecatedFunctionAlias(trac_number, func, module_name)\n```\n\n(where times are in microseconds).  This shows we're spending at least 1.5 seconds in this function alone which is not great even for Python 2, and is something worth looking into.  But on Python 3 it's absurd:\n\n```\n   513        80        354.0      4.4      0.0      _check_trac_number(trac_number)\n   514        80   42581328.0 532266.6    100.0      frame1 = inspect.getouterframes(inspect.currentframe())[1][0]\n   515        80       3287.0     41.1      0.0      module_name = inspect.getmodulename(frame1.f_code.co_filename)\n   516        80         96.0      1.2      0.0      if module_name is None:\n   517                                                   module_name = '__main__'\n   518        80       2856.0     35.7      0.0      return DeprecatedFunctionAlias(trac_number, func, module_name)\n```\n\nCC:  @fchapoton @jdemeyer\n\nBranch: **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)**\n\nReviewer: **Simon King**\n\nAuthor: **Erik Bray**\n\nComponent: **python3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/26908_\n\n",
    "closed_at": "2018-12-23T23:41:15Z",
    "created_at": "2018-12-17T14:12:42Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20python3",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-8.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "py3: Speed up deprecated_function_alias",
    "type": "issue",
    "updated_at": "2018-12-28T13:53:00Z",
    "url": "https://github.com/sagemath/sage/issues/26908",
    "user": "https://github.com/embray"
}
```
In profiling areas of slowdown during import, one culprit (of likely several) I found was `deprecated_function_alias`.

This was called 80 times during `import sage.all`, and profiling suggests that a pretty absurd amount time in this, particularly on the line

```
frame1 = inspect.getouterframes(inspect.currentframe())[1][0]
```

On Python 2 kernprof gives:

```
   513        80        365.0      4.6      0.0      _check_trac_number(trac_number)
   514        80    1400403.0  17505.0     99.7      frame1 = inspect.getouterframes(inspect.currentframe())[1][0]
   515        80       2378.0     29.7      0.2      module_name = inspect.getmodulename(frame1.f_code.co_filename)
   516        80         78.0      1.0      0.0      if module_name is None:
   517                                                   module_name = '__main__'
   518        80       1944.0     24.3      0.1      return DeprecatedFunctionAlias(trac_number, func, module_name)
```

(where times are in microseconds).  This shows we're spending at least 1.5 seconds in this function alone which is not great even for Python 2, and is something worth looking into.  But on Python 3 it's absurd:

```
   513        80        354.0      4.4      0.0      _check_trac_number(trac_number)
   514        80   42581328.0 532266.6    100.0      frame1 = inspect.getouterframes(inspect.currentframe())[1][0]
   515        80       3287.0     41.1      0.0      module_name = inspect.getmodulename(frame1.f_code.co_filename)
   516        80         96.0      1.2      0.0      if module_name is None:
   517                                                   module_name = '__main__'
   518        80       2856.0     35.7      0.0      return DeprecatedFunctionAlias(trac_number, func, module_name)
```

CC:  @fchapoton @jdemeyer

Branch: **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)**

Reviewer: **Simon King**

Author: **Erik Bray**

Component: **python3**

_Issue created by migration from https://trac.sagemath.org/ticket/26908_





---

archive/issue_events_369678.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:12:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "milestone_number": null,
    "milestone_title": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369678"
}
```



---

archive/issue_events_369679.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:12:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20python3",
    "label_color": "000080",
    "label_name": "c: python3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369679"
}
```



---

archive/issue_events_369680.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:12:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369680"
}
```



---

archive/issue_events_369681.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:12:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369681"
}
```



---

archive/issue_comments_414650.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nMarvelous--just replacing `inspect.getouterframes(inspect.currentframe())[1][0]`, which was needlessly cumbersome, with `inspect.currentframe().f_back` speeds this up by about 10000x \ud83e\udd23",
    "created_at": "2018-12-17T14:33:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414650",
    "user": "https://github.com/embray"
}
```

<div id="comment:1" align="right">comment:1</div>

Marvelous--just replacing `inspect.getouterframes(inspect.currentframe())[1][0]`, which was needlessly cumbersome, with `inspect.currentframe().f_back` speeds this up by about 10000x ðŸ¤£



---

archive/issue_comments_414651.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2018-12-17T14:55:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414651",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_events_369682.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:55:59Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "milestone_number": null,
    "milestone_title": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369682"
}
```



---

archive/issue_events_369683.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:55:59Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369683"
}
```



---

archive/issue_events_369684.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:55:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369684"
}
```



---

archive/issue_events_369685.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:55:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369685"
}
```



---

archive/issue_comments_414652.json:
```json
{
    "body": "Commit: **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)**",
    "created_at": "2018-12-17T14:55:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414652",
    "user": "https://github.com/embray"
}
```

Commit: **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)**



---

archive/issue_comments_414653.json:
```json
{
    "body": "Branch: **[u/embray/python3/misc/deprecated-function-alias](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/misc/deprecated-function-alias)**",
    "created_at": "2018-12-17T14:55:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414653",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/python3/misc/deprecated-function-alias](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/misc/deprecated-function-alias)**



---

archive/issue_comments_414654.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/384311405318315449c7cc0835db33f3b816b283\"><code>3843114</code></a></td><td><code>py3: speed up deprecated_function_alias</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44\"><code>6131b10</code></a></td><td><code>misc minor cleanup</code></td></tr></table>\n",
    "created_at": "2018-12-17T14:55:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414654",
    "user": "https://github.com/embray"
}
```

<div id="comment:2"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/384311405318315449c7cc0835db33f3b816b283"><code>3843114</code></a></td><td><code>py3: speed up deprecated_function_alias</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44"><code>6131b10</code></a></td><td><code>misc minor cleanup</code></td></tr></table>




---

archive/issue_events_369686.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-17T14:55:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369686"
}
```



---

archive/issue_comments_414655.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nCan you explain the removal of\n\n```\n-    _check_trac_number(trac_number)\n```\n?",
    "created_at": "2018-12-17T16:46:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414655",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:3" align="right">comment:3</div>

Can you explain the removal of

```
-    _check_trac_number(trac_number)
```
?



---

archive/issue_comments_414656.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIt's redundant.",
    "created_at": "2018-12-17T16:49:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414656",
    "user": "https://github.com/embray"
}
```

<div id="comment:4" align="right">comment:4</div>

It's redundant.



---

archive/issue_comments_414657.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\ngreen bot. Ok for me.\n\nYour opinion, Jeroen ?",
    "created_at": "2018-12-17T18:22:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414657",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:5" align="right">comment:5</div>

green bot. Ok for me.

Your opinion, Jeroen ?



---

archive/issue_comments_414658.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nDo I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?\n\nYou said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?",
    "created_at": "2018-12-17T19:25:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414658",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

Do I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?

You said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?



---

archive/issue_comments_414659.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nReplying to [@simon-king-jena](#comment:6):\n> Do I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?\n\nThis has to do with figuring out where the `DeprecatedFunctionAlias` was defined, so it's has to happen at definition time.  The way it's used is not actually very important and I thought about trying to do away with it entirely.  But getting the previous stack frame (if one exists) is trivial to do, and the only problem with the existing code is that it was needlessly examining and constructing a data structure out of the entire stack.\n\n> You said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?\n\nIt's not that simple.  kernprof alone can't analyze Sage startup times--this was just for line-profiling `deprecated_function_alias` itself since I had narrowed that down as a culprit for some slow to import modules.",
    "created_at": "2018-12-18T10:51:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414659",
    "user": "https://github.com/embray"
}
```

<div id="comment:7" align="right">comment:7</div>

Replying to [@simon-king-jena](#comment:6):
> Do I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?

This has to do with figuring out where the `DeprecatedFunctionAlias` was defined, so it's has to happen at definition time.  The way it's used is not actually very important and I thought about trying to do away with it entirely.  But getting the previous stack frame (if one exists) is trivial to do, and the only problem with the existing code is that it was needlessly examining and constructing a data structure out of the entire stack.

> You said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?

It's not that simple.  kernprof alone can't analyze Sage startup times--this was just for line-profiling `deprecated_function_alias` itself since I had narrowed that down as a culprit for some slow to import modules.



---

archive/issue_comments_414660.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@embray](#comment:7):\n> Replying to [@simon-king-jena](#comment:6):\n> > Do I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?\n\n> \n> This has to do with figuring out where the `DeprecatedFunctionAlias` was defined,\n\nWhat do you mean by that? Do you mean you want to find out the module of the function that is being deprecated? Why isn't that module determined in the same way that the module is determined for, say, `CachedFunction`?\n\n> > You said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?\n\n> \n> It's not that simple.  kernprof alone can't analyze Sage startup times--this was just for line-profiling `deprecated_function_alias` itself since I had narrowed that down as a culprit for some slow to import modules.\n\nI see. Anyway, if I understand correctly what module is being determined (namely the one of the function that is being deprecated), I don't see why a stack frame is relevant at all.",
    "created_at": "2018-12-18T14:54:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414660",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@embray](#comment:7):
> Replying to [@simon-king-jena](#comment:6):
> > Do I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?

> 
> This has to do with figuring out where the `DeprecatedFunctionAlias` was defined,

What do you mean by that? Do you mean you want to find out the module of the function that is being deprecated? Why isn't that module determined in the same way that the module is determined for, say, `CachedFunction`?

> > You said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?

> 
> It's not that simple.  kernprof alone can't analyze Sage startup times--this was just for line-profiling `deprecated_function_alias` itself since I had narrowed that down as a culprit for some slow to import modules.

I see. Anyway, if I understand correctly what module is being determined (namely the one of the function that is being deprecated), I don't see why a stack frame is relevant at all.



---

archive/issue_comments_414661.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nFirst of all, I can confirm a speedup for py2 (I am not testing py3): `sage --startuptime` gives 1103.930ms without the ticket and 798.564ms with the ticket.\n\nOne of the slowest imports without the ticket was\n\n```\n   24.867     24.946         35  sage.rings.finite_rings.integer_mod\n```\nWith the ticket, importing integer_mod doesn't appear in the list of slowest imports at all -- and deprecated_function_alias only appears a single time in that module!\n\nSo, it is impressive.\n\nAnd I think meanwhile I understand the problem that is solved by inspecting the stack: I thought when you do `f = deprecated_function_alias(1234, g)` then `f.__module__` is supposed to be equal to `g.__module__` (which wouldn't involve stack inspection). But now I realise that `f.__module__` is supposed to be the module in which `deprecated_function_alias` is called, and that's of course something where inspecting the stack totally makes sense.",
    "created_at": "2018-12-18T22:32:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414661",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

First of all, I can confirm a speedup for py2 (I am not testing py3): `sage --startuptime` gives 1103.930ms without the ticket and 798.564ms with the ticket.

One of the slowest imports without the ticket was

```
   24.867     24.946         35  sage.rings.finite_rings.integer_mod
```
With the ticket, importing integer_mod doesn't appear in the list of slowest imports at all -- and deprecated_function_alias only appears a single time in that module!

So, it is impressive.

And I think meanwhile I understand the problem that is solved by inspecting the stack: I thought when you do `f = deprecated_function_alias(1234, g)` then `f.__module__` is supposed to be equal to `g.__module__` (which wouldn't involve stack inspection). But now I realise that `f.__module__` is supposed to be the module in which `deprecated_function_alias` is called, and that's of course something where inspecting the stack totally makes sense.



---

archive/issue_comments_414662.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nIt would in principle be possible to replace the call to `inspect.getmodulename(frame1.f_code.co_filename)` by something faster:\n\n```\nsage: import inspect\nsage: frame0 = inspect.currentframe()\nsage: frame1 = frame0.f_back\nsage: %timeit inspect.getmodulename(frame1.f_code.co_filename)\nThe slowest run took 4.96 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 6.06 \u00b5s per loop\nsage: cython('''\n....: import os\n....: cdef str slash = os.path.sep\n....: cdef str dot = os.path.extsep\n....: def extract(str name):\n....:     return name[name.rfind(slash)+1:name.rfind(dot)]\n....: ''')\nsage: extract(frame1.f_code.co_filename)\n'interactiveshell'\nsage: %timeit extract(frame1.f_code.co_filename)\nThe slowest run took 17.48 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 341 ns per loop\nsage: inspect.getmodulename(frame1.f_code.co_filename) == extract(frame1.f_code.co_filename)\nTrue\n```\nHowever, I am not sure if enough deprecated function aliases are created so that an improvement from 6\u00b5s to 341ns could be noticed in startup time. Also I am not sure if the above implementation of the name extraction is 100% correct.",
    "created_at": "2018-12-18T23:12:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414662",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">comment:10</div>

It would in principle be possible to replace the call to `inspect.getmodulename(frame1.f_code.co_filename)` by something faster:

```
sage: import inspect
sage: frame0 = inspect.currentframe()
sage: frame1 = frame0.f_back
sage: %timeit inspect.getmodulename(frame1.f_code.co_filename)
The slowest run took 4.96 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.06 Âµs per loop
sage: cython('''
....: import os
....: cdef str slash = os.path.sep
....: cdef str dot = os.path.extsep
....: def extract(str name):
....:     return name[name.rfind(slash)+1:name.rfind(dot)]
....: ''')
sage: extract(frame1.f_code.co_filename)
'interactiveshell'
sage: %timeit extract(frame1.f_code.co_filename)
The slowest run took 17.48 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 341 ns per loop
sage: inspect.getmodulename(frame1.f_code.co_filename) == extract(frame1.f_code.co_filename)
True
```
However, I am not sure if enough deprecated function aliases are created so that an improvement from 6Âµs to 341ns could be noticed in startup time. Also I am not sure if the above implementation of the name extraction is 100% correct.



---

archive/issue_comments_414663.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@simon-king-jena](#comment:9):\n> But now I realise that `f.__module__` is supposed to be the module in which `deprecated_function_alias` is called, and that's of course something where inspecting the stack totally makes sense.\n\nOn the other hand: Couldn't that simply be passed as a parameter? Granted, it would mean to change\n\n```\nking@klap:~/Sage/git/sage$ grep \"deprecated_function_alias(\" -R src/sage | wc -l\n123\n```\nplaces in the sage library. But a change from\n`deprecated_function_alias(1234, f)` to `deprecated_function_alias(1234, f, `__name__`)` could easily be done with a little script. And since `__name__` is the name of the module in which `deprecated_function_alias` is currently being executed, it would solve the problem without any slow introspection.\n\nSo, would adding `..., `__name__`)` in 123 places be acceptable?",
    "created_at": "2018-12-18T23:52:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414663",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@simon-king-jena](#comment:9):
> But now I realise that `f.__module__` is supposed to be the module in which `deprecated_function_alias` is called, and that's of course something where inspecting the stack totally makes sense.

On the other hand: Couldn't that simply be passed as a parameter? Granted, it would mean to change

```
king@klap:~/Sage/git/sage$ grep "deprecated_function_alias(" -R src/sage | wc -l
123
```
places in the sage library. But a change from
`deprecated_function_alias(1234, f)` to `deprecated_function_alias(1234, f, `__name__`)` could easily be done with a little script. And since `__name__` is the name of the module in which `deprecated_function_alias` is currently being executed, it would solve the problem without any slow introspection.

So, would adding `..., `__name__`)` in 123 places be acceptable?



---

archive/issue_comments_414664.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@simon-king-jena](#comment:11):\n> So, would adding `..., `__name__`)` in 123 places be acceptable?\n\nToo bad. Even if it was acceptable, it turns out that doing the change (I just did) only improves the startup time by 6ms or so.",
    "created_at": "2018-12-19T00:06:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414664",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@simon-king-jena](#comment:11):
> So, would adding `..., `__name__`)` in 123 places be acceptable?

Too bad. Even if it was acceptable, it turns out that doing the change (I just did) only improves the startup time by 6ms or so.



---

archive/issue_comments_414665.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThanks a lot, Simon, for taking the time to do an analysis in depth. Can we now set this to positive without further delay ?",
    "created_at": "2018-12-19T08:52:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414665",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:13" align="right">comment:13</div>

Thanks a lot, Simon, for taking the time to do an analysis in depth. Can we now set this to positive without further delay ?



---

archive/issue_comments_414666.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@fchapoton](#comment:13):\n> Thanks a lot, Simon, for taking the time to do an analysis in depth. Can we now set this to positive without further delay ?\n\nYes, of course!\n\nReplying to [@embray](#comment:7):\n> Replying to [@simon-king-jena](#comment:6):\n> > You said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?\n\n> \n> It's not that simple.  kernprof alone can't analyze Sage startup times--this was just for line-profiling `deprecated_function_alias` itself since I had narrowed that down as a culprit for some slow to import modules.\n\nI still would like to understand how you found out that `deprecated_function_alias` was responsible for slow startup time. `sage --startuptime <module_name>` only tells what modules are slow to import, but not why. I somehow feel challenged to try to improve startup time further...",
    "created_at": "2018-12-19T09:51:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414666",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@fchapoton](#comment:13):
> Thanks a lot, Simon, for taking the time to do an analysis in depth. Can we now set this to positive without further delay ?

Yes, of course!

Replying to [@embray](#comment:7):
> Replying to [@simon-king-jena](#comment:6):
> > You said the profiling of Sage startup was done with kernprof. How exactly, i.e., what command?

> 
> It's not that simple.  kernprof alone can't analyze Sage startup times--this was just for line-profiling `deprecated_function_alias` itself since I had narrowed that down as a culprit for some slow to import modules.

I still would like to understand how you found out that `deprecated_function_alias` was responsible for slow startup time. `sage --startuptime <module_name>` only tells what modules are slow to import, but not why. I somehow feel challenged to try to improve startup time further...



---

archive/issue_comments_414667.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@simon-king-jena](#comment:8):\n> Replying to [@embray](#comment:7):\n> > Replying to [@simon-king-jena](#comment:6):\n> > > Do I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?\n\n> > \n> > This has to do with figuring out where the `DeprecatedFunctionAlias` was defined,\n\n> \n> What do you mean by that? Do you mean you want to find out the module of the function that is being deprecated? Why isn't that module determined in the same way that the module is determined for, say, `CachedFunction`?\n\nI mean, I didn't write the code, so it's not about what I want.  But it's just determining what module the actual `DeprecatedFunctionAlias` was created in, and it uses this information to determine whether or not it's in the same module as the deprecated function.  It's not very important, but this is a normal (albeit CPython-specific) way to do this.",
    "created_at": "2018-12-19T10:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414667",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@simon-king-jena](#comment:8):
> Replying to [@embray](#comment:7):
> > Replying to [@simon-king-jena](#comment:6):
> > > Do I understand correctly: Much time is spent on inspecting stack frames, in order to find out module names? Is that necessary at all? Or *if* it is: Could it perhaps be made more lazily, so that stack frame inspection will only happen if a deprecated function actually is used?

> > 
> > This has to do with figuring out where the `DeprecatedFunctionAlias` was defined,

> 
> What do you mean by that? Do you mean you want to find out the module of the function that is being deprecated? Why isn't that module determined in the same way that the module is determined for, say, `CachedFunction`?

I mean, I didn't write the code, so it's not about what I want.  But it's just determining what module the actual `DeprecatedFunctionAlias` was created in, and it uses this information to determine whether or not it's in the same module as the deprecated function.  It's not very important, but this is a normal (albeit CPython-specific) way to do this.



---

archive/issue_comments_414668.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@simon-king-jena](#comment:14):\n> I still would like to understand how you found out that `deprecated_function_alias` was responsible for slow startup time. `sage --startuptime <module_name>` only tells what modules are slow to import, but not why. I somehow feel challenged to try to improve startup time further...\n\nPerhaps when I have more time I will write up something on this subject.  Profiling module-level code and import times in Python turns out to be surprisingly difficult, as most Python profiling tools are geared toward just profiling individual functions, and it's not always trivial to just wrap up the contents of a module in a function, especially with Cython.\n\nHowever, there's no good technical reason for this: Modules can be profiled just the same as functions, there just isn't good tooling for it.  I would like, when I have more time, to develop better tooling since it would be very helpful for large projects like Sage.\n\nAnother somewhat useful tool for this was added in Python 3.7: `python -X importtime` which prints a report of all time spent in module imports.  Prior to this there was a package called `import-profiler`, but it does not work as well in all cases, whereas the new feature included in Python is built right into the import system and works better overall.  In order to help with this I backported that feature to Python 3.6 and added a patch for it.  This might be worth including with Sage until we upgrade to Python 3.7, or at very least I can make my patch available somewhere.",
    "created_at": "2018-12-19T10:43:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414668",
    "user": "https://github.com/embray"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@simon-king-jena](#comment:14):
> I still would like to understand how you found out that `deprecated_function_alias` was responsible for slow startup time. `sage --startuptime <module_name>` only tells what modules are slow to import, but not why. I somehow feel challenged to try to improve startup time further...

Perhaps when I have more time I will write up something on this subject.  Profiling module-level code and import times in Python turns out to be surprisingly difficult, as most Python profiling tools are geared toward just profiling individual functions, and it's not always trivial to just wrap up the contents of a module in a function, especially with Cython.

However, there's no good technical reason for this: Modules can be profiled just the same as functions, there just isn't good tooling for it.  I would like, when I have more time, to develop better tooling since it would be very helpful for large projects like Sage.

Another somewhat useful tool for this was added in Python 3.7: `python -X importtime` which prints a report of all time spent in module imports.  Prior to this there was a package called `import-profiler`, but it does not work as well in all cases, whereas the new feature included in Python is built right into the import system and works better overall.  In order to help with this I backported that feature to Python 3.6 and added a patch for it.  This might be worth including with Sage until we upgrade to Python 3.7, or at very least I can make my patch available somewhere.



---

archive/issue_events_369687.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-19T10:44:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369687"
}
```



---

archive/issue_events_369688.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-19T10:44:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369688"
}
```



---

archive/issue_comments_414669.json:
```json
{
    "body": "Reviewer: **Simon King**",
    "created_at": "2018-12-19T10:44:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414669",
    "user": "https://github.com/embray"
}
```

Reviewer: **Simon King**



---

archive/issue_comments_414670.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nPer [comment:14](#comment:14)",
    "created_at": "2018-12-19T10:44:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414670",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

Per [comment:14](#comment:14)



---

archive/issue_comments_414671.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nI didn't even know about `sage --startuptime`.  Or rather, I did know about it at one time (I know I've used it before) but completely forgot about it.  It seems to work similarly to `import-profiler` (by replacing `__import__`).  The new import profiler baked into Python is still better in some ways, though I'm not wild about its output format, which could use improvement.  It would also be nice if it collected the raw data into an object that was available somewhere, perhaps either in the `sys` module or in `importlib`.  Perhaps I'll suggest that upstream...",
    "created_at": "2018-12-19T10:47:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414671",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">comment:18</div>

I didn't even know about `sage --startuptime`.  Or rather, I did know about it at one time (I know I've used it before) but completely forgot about it.  It seems to work similarly to `import-profiler` (by replacing `__import__`).  The new import profiler baked into Python is still better in some ways, though I'm not wild about its output format, which could use improvement.  It would also be nice if it collected the raw data into an object that was available somewhere, perhaps either in the `sys` module or in `importlib`.  Perhaps I'll suggest that upstream...



---

archive/issue_events_369689.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:41:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369689"
}
```



---

archive/issue_events_369690.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "711339392b8ae76210fc500b581e18926ac8878d",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2018-12-23T23:41:15Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369690"
}
```



---

archive/issue_comments_414672.json:
```json
{
    "body": "Changed branch from **[u/embray/python3/misc/deprecated-function-alias](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/misc/deprecated-function-alias)** to **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)**",
    "created_at": "2018-12-23T23:41:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414672",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/embray/python3/misc/deprecated-function-alias](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/python3/misc/deprecated-function-alias)** to **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)**



---

archive/issue_events_369691.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T13:53:00Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "milestone_number": null,
    "milestone_title": "sage-8.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369691"
}
```



---

archive/issue_events_369692.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T13:53:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "milestone_number": null,
    "milestone_title": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/26908#event-369692"
}
```



---

archive/issue_comments_414673.json:
```json
{
    "body": "Changed commit from **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)** to none",
    "created_at": "2018-12-28T13:53:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/26908",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/26908#issuecomment-414673",
    "user": "https://github.com/embray"
}
```

Changed commit from **[`6131b10`](https://github.com/sagemath/sagetrac-mirror/commit/6131b10e15eb12ee1cbc29cd68e3433829f30f44)** to none
