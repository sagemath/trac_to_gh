# Issue 26291: Create a pool for ETuple

archive/issues_026054.json:
```json
{
    "body": "Working on #26243, I found that one can get a substantial speed-up by implementing a pool for ETuple (so that memory allocation and deallocation occurs less often).\n\nI chose the component \"memleak\", because my first attempt at implementing a pool has a memory leak...\n\nCC:  @tscrim\n\nKeywords: pool ETuple\n\nAuthor: Simon King\n\nBranch: u/SimonKing/ETuple_pool\n\nStatus: needs_review\n\nDependencies: #26243\n\nCommit: cbdfab508898372ad87b0109ee74b7fbb2666ffa\n\nIssue created by migration from https://trac.sagemath.org/ticket/26291\n\n",
    "created_at": "2018-09-15T10:27:24Z",
    "labels": [
        "component: memleak"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-pending",
    "title": "Create a pool for ETuple",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26291",
    "user": "https://github.com/simon-king-jena"
}
```
Working on #26243, I found that one can get a substantial speed-up by implementing a pool for ETuple (so that memory allocation and deallocation occurs less often).

I chose the component "memleak", because my first attempt at implementing a pool has a memory leak...

CC:  @tscrim

Keywords: pool ETuple

Author: Simon King

Branch: u/SimonKing/ETuple_pool

Status: needs_review

Dependencies: #26243

Commit: cbdfab508898372ad87b0109ee74b7fbb2666ffa

Issue created by migration from https://trac.sagemath.org/ticket/26291





---

archive/issue_events_065424.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2018-09-15T10:37:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26291#event-65424"
}
```



---

archive/issue_comments_391351.json:
```json
{
    "body": "<a id='comment:2'></a>Ouch, I am so sorry! For some reasons, I got the timings wrong and though that the pool gives a speed-up. But it doesn't.\n\nPlease close this as invalid.\n\n---\nLast 10 new commits:",
    "created_at": "2018-09-15T10:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391351",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>Ouch, I am so sorry! For some reasons, I got the timings wrong and though that the pool gives a speed-up. But it doesn't.

Please close this as invalid.

---
Last 10 new commits:



---

archive/issue_comments_391352.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-15T10:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391352",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_391353.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-15T10:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391353",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_065425.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-11-08T16:17:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26291#event-65425"
}
```



---

archive/issue_events_065426.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-11-08T16:17:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "milestone": "sage-pending",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26291#event-65426"
}
```



---

archive/issue_comments_391354.json:
```json
{
    "body": "<a id='comment:4'></a>I'd be curious about revisiting this.  How were you timing this?  In principle it really should speed things up, at least if implemented correctly...",
    "created_at": "2018-11-08T16:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391354",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>I'd be curious about revisiting this.  How were you timing this?  In principle it really should speed things up, at least if implemented correctly...



---

archive/issue_comments_391355.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-11-08T16:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391355",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_391356.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 embray]:\n> I'd be curious about revisiting this.  How were you timing this?  In principle it really should speed things up, at least if implemented correctly...\n\n\nActually I do not clearly recall how I did that. My original motivation came from the computation of Hilbert series in cases in which Singular couldn't give an answer and other available packages in Sage sucked. So, I guess I was timing the Hilbert series computation (which in fact heavily uses ETuple).\n\nAnother possibility is to create polynomials in the generic implementation, i.e., NOT using libsingular but instead using `MPolynomial_polydict`, and test the time for arithmetic operations, as they rely on ETuple operations, too.",
    "created_at": "2018-11-08T20:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391356",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>Replying to [comment:4 embray]:
> I'd be curious about revisiting this.  How were you timing this?  In principle it really should speed things up, at least if implemented correctly...


Actually I do not clearly recall how I did that. My original motivation came from the computation of Hilbert series in cases in which Singular couldn't give an answer and other available packages in Sage sucked. So, I guess I was timing the Hilbert series computation (which in fact heavily uses ETuple).

Another possibility is to create polynomials in the generic implementation, i.e., NOT using libsingular but instead using `MPolynomial_polydict`, and test the time for arithmetic operations, as they rely on ETuple operations, too.



---

archive/issue_comments_391357.json:
```json
{
    "body": "<a id='comment:6'></a>I put your branch back on the ticket just for the sake of inspection.  Maybe this doesn't need to be high priority or anything, but I'm sure you are right that there are opportunity for gains here; the question is in the details.\n\n---\nNew commits:",
    "created_at": "2018-11-09T13:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391357",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>I put your branch back on the ticket just for the sake of inspection.  Maybe this doesn't need to be high priority or anything, but I'm sure you are right that there are opportunity for gains here; the question is in the details.

---
New commits:



---

archive/issue_comments_391358.json:
```json
{
    "body": "<a id='comment:7'></a>I forget *precisely* why this is, but I believe that in Cython code you lose most any advantage of using a custom `fast_tp_new` if you don't use `PY_NEW(ETuple)` to get a new instance, as it goes directly through `ETuple.tp_new`; otherwise Cython adds some kind of overhead to the call.",
    "created_at": "2018-11-09T13:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391358",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>I forget *precisely* why this is, but I believe that in Cython code you lose most any advantage of using a custom `fast_tp_new` if you don't use `PY_NEW(ETuple)` to get a new instance, as it goes directly through `ETuple.tp_new`; otherwise Cython adds some kind of overhead to the call.



---

archive/issue_comments_391359.json:
```json
{
    "body": "<a id='comment:8'></a>There is a merge conflict with the current \"develop\" branch. So, first I'll try to fix the merge conflict.",
    "created_at": "2018-12-04T08:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391359",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>There is a merge conflict with the current "develop" branch. So, first I'll try to fix the merge conflict.



---

archive/issue_comments_391360.json:
```json
{
    "body": "<a id='comment:9'></a>One rather silly conflicts is this:\n\nIn \"develop\"\n\n```\n# ****************************************************************************\n#       Copyright (C) 2005 William Stein <wstein@gmail.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 2 of the License, or\n# (at your option) any later version.\n#                  https://www.gnu.org/licenses/\n# ****************************************************************************\n```\nIn this branch:\n\n```\n#****************************************************************************\n#       Copyright (C) 2005 William Stein <wstein@gmail.com>\n#\n# This program is free software: you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation, either version 2 of the License, or\n# (at your option) any later version.\n#                  https://www.gnu.org/licenses/\n#****************************************************************************\n```\n\nWhat do people prefer? Having a blank space after `#` or not?",
    "created_at": "2018-12-04T09:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391360",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>One rather silly conflicts is this:

In "develop"

```
# ****************************************************************************
#       Copyright (C) 2005 William Stein <wstein@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#                  https://www.gnu.org/licenses/
# ****************************************************************************
```
In this branch:

```
#****************************************************************************
#       Copyright (C) 2005 William Stein <wstein@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#                  https://www.gnu.org/licenses/
#****************************************************************************
```

What do people prefer? Having a blank space after `#` or not?



---

archive/issue_comments_391361.json:
```json
{
    "body": "<a id='comment:10'></a>In several other places I find the preamble without space after `#`. So, I'll remove it from develop.",
    "created_at": "2018-12-04T09:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391361",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>In several other places I find the preamble without space after `#`. So, I'll remove it from develop.



---

archive/issue_comments_391362.json:
```json
{
    "body": "<a id='comment:11'></a>According to git blame, the blank space was introduced in #26279. Erik, would you be OK with removing the space?",
    "created_at": "2018-12-04T09:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391362",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>According to git blame, the blank space was introduced in #26279. Erik, would you be OK with removing the space?



---

archive/issue_comments_391363.json:
```json
{
    "body": "<a id='comment:12'></a>My guess is that it was probably done by Fr\u00e9d\u00e9ric to more strictly conform to PEP8. I would probably keep things as they are to avoid as many trivial changes as possible, but that is just my 2 cents.",
    "created_at": "2018-12-06T05:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391363",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>My guess is that it was probably done by Frédéric to more strictly conform to PEP8. I would probably keep things as they are to avoid as many trivial changes as possible, but that is just my 2 cents.



---

archive/issue_comments_391364.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-12-08T09:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391364",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_391365.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-12-08T09:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391365",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_391366.json:
```json
{
    "body": "<a id='comment:14'></a>I have rebased the old branch on top of the current develop branch. Also, I changed all remaining `for i from 0<=i<whatever` to `for i in range(whatever)`.\n\nHere are timings. For test, I am using this:\n\n```\nsage: from sage.rings.polynomial.polydict import ETuple\nsage: cython(\"\"\"\n....: from sage.rings.polynomial.polydict cimport ETuple\n....: from sage.all import get_memory_usage\n....: def test_new(ETuple T):\n....:     cdef int i\n....:     for i in range(10000):\n....:         T = T._new()\n....: def test_addmin(ETuple T):\n....:     cdef int i\n....:     for i in range(10000):\n....:         T = T.emin(T.eadd(T))\n....: \"\"\")\nsage: T = ETuple(range(20))\n```\nTiming with `develop`:\n\n```\nsage: %timeit test_new(T)\n1000 loops, best of 3: 299 \u00b5s per loop\nsage: %timeit test_addmin(T)\n100 loops, best of 3: 2.98 ms per loop\n```\nTiming with the branch from here:\n\n```\nsage: %timeit test_new(T)\n10000 loops, best of 3: 71.7 \u00b5s per loop\nsage: %timeit test_addmin(T)\n100 loops, best of 3: 2.96 ms per loop\n```\n\nSo, the time for creating new instance has indeed improved. However, it also becomes clear that the creation of a new tuple (which occurs both in `.eadd()` and `.emin()`) is negligible compared with what else is to be done.\n\nTherefore, I believe that having an ETuple pool is not a real improvement after all. But I let this up to the reviewer: If you think that the improvement isn't worth the effort, then review this as \"invalid/won't fix\". If you think \"why not?\", then we can of course keep working on it.",
    "created_at": "2018-12-08T09:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391366",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>I have rebased the old branch on top of the current develop branch. Also, I changed all remaining `for i from 0<=i<whatever` to `for i in range(whatever)`.

Here are timings. For test, I am using this:

```
sage: from sage.rings.polynomial.polydict import ETuple
sage: cython("""
....: from sage.rings.polynomial.polydict cimport ETuple
....: from sage.all import get_memory_usage
....: def test_new(ETuple T):
....:     cdef int i
....:     for i in range(10000):
....:         T = T._new()
....: def test_addmin(ETuple T):
....:     cdef int i
....:     for i in range(10000):
....:         T = T.emin(T.eadd(T))
....: """)
sage: T = ETuple(range(20))
```
Timing with `develop`:

```
sage: %timeit test_new(T)
1000 loops, best of 3: 299 µs per loop
sage: %timeit test_addmin(T)
100 loops, best of 3: 2.98 ms per loop
```
Timing with the branch from here:

```
sage: %timeit test_new(T)
10000 loops, best of 3: 71.7 µs per loop
sage: %timeit test_addmin(T)
100 loops, best of 3: 2.96 ms per loop
```

So, the time for creating new instance has indeed improved. However, it also becomes clear that the creation of a new tuple (which occurs both in `.eadd()` and `.emin()`) is negligible compared with what else is to be done.

Therefore, I believe that having an ETuple pool is not a real improvement after all. But I let this up to the reviewer: If you think that the improvement isn't worth the effort, then review this as "invalid/won't fix". If you think "why not?", then we can of course keep working on it.



---

archive/issue_comments_391367.json:
```json
{
    "body": "<a id='comment:15'></a>Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.",
    "created_at": "2018-12-09T19:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391367",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.



---

archive/issue_comments_391368.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:\n> Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.\n\n\nI guess that's because I am unaware of a ready-to-be-plugged-in Cython implementation.",
    "created_at": "2018-12-09T19:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391368",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>Replying to [comment:15 jdemeyer]:
> Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.


I guess that's because I am unaware of a ready-to-be-plugged-in Cython implementation.



---

archive/issue_comments_391369.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 jdemeyer]:\n> Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.\n\n\nActually I am not fully deallocating the tuple data in `tp_dealloc`! I only dealloc the tuple data if the pool is full and thus every data has to go to oblivion. But if an ETuple is parked in the pool, then the tuple data is in fact kept. If later the ETuple is revived, the tuple data is not allocated but reallocated during `__init__` (which typically should be faster than a full deallocation followed by an allocation).\n\nSo, I guess ``@`cython.freelist(1000)` won't be equivalent.",
    "created_at": "2018-12-09T22:31:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26291",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26291#issuecomment-391369",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:17'></a>Replying to [comment:15 jdemeyer]:
> Why not use Cython's freelist implementation? Especially since you're fully deallocating the tuple data in `tp_dealloc`.


Actually I am not fully deallocating the tuple data in `tp_dealloc`! I only dealloc the tuple data if the pool is full and thus every data has to go to oblivion. But if an ETuple is parked in the pool, then the tuple data is in fact kept. If later the ETuple is revived, the tuple data is not allocated but reallocated during `__init__` (which typically should be faster than a full deallocation followed by an allocation).

So, I guess ``@`cython.freelist(1000)` won't be equivalent.
