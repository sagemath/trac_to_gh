# Issue 26153: sage-spkg does not correctly overwrite existing directories

archive/issues_025916.json:
```json
{
    "body": "This line in `sage-spkg`\n\n```\n$SAGE_SUDO mv \"$PREFIX/$filename\" \"${SAGE_LOCAL%/}/$filename\"\n```\nmight move a file `$filename` (to be installed) into a *directory* `$filename` (if the latter was an existing directory).\n\nThis can occur in particular with symlinks to directories, since those can be interpreted both as file and as directory. This is partially responsible for #26152.\n\nCC:  @embray\n\nDependencies: #26011\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26153\n\n",
    "closed_at": "2018-10-08T09:49:06Z",
    "created_at": "2018-08-28T15:16:17Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "sage-spkg does not correctly overwrite existing directories",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26153",
    "user": "https://github.com/jdemeyer"
}
```
This line in `sage-spkg`

```
$SAGE_SUDO mv "$PREFIX/$filename" "${SAGE_LOCAL%/}/$filename"
```
might move a file `$filename` (to be installed) into a *directory* `$filename` (if the latter was an existing directory).

This can occur in particular with symlinks to directories, since those can be interpreted both as file and as directory. This is partially responsible for #26152.

CC:  @embray

Dependencies: #26011

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26153





---

archive/issue_comments_389091.json:
```json
{
    "body": "<a id='comment:1'></a>Note: This is probably fixed by #26011",
    "created_at": "2018-08-28T15:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389091",
    "user": "https://github.com/embray"
}
```

<a id='comment:1'></a>Note: This is probably fixed by #26011



---

archive/issue_comments_389092.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -5,7 +5,7 @@\n \\`\\`\\`\n might move a file \\`$filename\\` (to be installed) into a *directory* \\`$filename\\` (if the latter was an existing directory).\n \n-This is partially responsible for #26152.\n+This can occur in particular with symlinks to directories, since those can be interpreted both as file and as directory. This is partially responsible for #26152.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-08-28T15:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389092",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -5,7 +5,7 @@
 \`\`\`
 might move a file \`$filename\` (to be installed) into a *directory* \`$filename\` (if the latter was an existing directory).
 
-This is partially responsible for #26152.
+This can occur in particular with symlinks to directories, since those can be interpreted both as file and as directory. This is partially responsible for #26152.
 
 Comment: 1
 
```




---

archive/issue_comments_389093.json:
```json
{
    "body": "<a id='comment:3'></a>> if the latter was an existing directory\n\n\nOr, it seems, a symlink pointing to a directory.  That's the real problem.",
    "created_at": "2018-08-28T15:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389093",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>> if the latter was an existing directory


Or, it seems, a symlink pointing to a directory.  That's the real problem.



---

archive/issue_comments_389094.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,11 @@\n+This line in \\`sage-spkg\\`\n \n+\\`\\`\\`\n+$SAGE_SUDO mv \"$PREFIX/$filename\" \"${SAGE_LOCAL%/}/$filename\"\n+\\`\\`\\`\n+might move a file \\`$filename\\` (to be installed) into a *directory* \\`$filename\\` (if the latter was an existing directory).\n+\n+This is partially responsible for #26152.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-08-28T15:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389094",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,11 @@
+This line in \`sage-spkg\`
 
+\`\`\`
+$SAGE_SUDO mv "$PREFIX/$filename" "${SAGE_LOCAL%/}/$filename"
+\`\`\`
+might move a file \`$filename\` (to be installed) into a *directory* \`$filename\` (if the latter was an existing directory).
+
+This is partially responsible for #26152.
 
 Comment: 1
 
```




---

archive/issue_comments_389095.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,11 @@\n+This line in \\`sage-spkg\\`\n \n+\\`\\`\\`\n+$SAGE_SUDO mv \"$PREFIX/$filename\" \"${SAGE_LOCAL%/}/$filename\"\n+\\`\\`\\`\n+might move a file \\`$filename\\` (to be installed) into a *directory* \\`$filename\\` (if the latter was an existing directory).\n+\n+This can occur in particular with symlinks to directories, since those can be interpreted both as file and as directory. This is partially responsible for #26152.\n \n Comment: 1\n \n```\n",
    "created_at": "2018-08-28T15:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389095",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,11 @@
+This line in \`sage-spkg\`
 
+\`\`\`
+$SAGE_SUDO mv "$PREFIX/$filename" "${SAGE_LOCAL%/}/$filename"
+\`\`\`
+might move a file \`$filename\` (to be installed) into a *directory* \`$filename\` (if the latter was an existing directory).
+
+This can occur in particular with symlinks to directories, since those can be interpreted both as file and as directory. This is partially responsible for #26152.
 
 Comment: 1
 
```




---

archive/issue_comments_389096.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 embray]:\n> Or, it seems, a symlink pointing to a directory.  That's the real problem.\n\n\nYes, I clarified that in an edit of the description that you reverted.",
    "created_at": "2018-08-28T15:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389096",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [comment:3 embray]:
> Or, it seems, a symlink pointing to a directory.  That's the real problem.


Yes, I clarified that in an edit of the description that you reverted.



---

archive/issue_comments_389097.json:
```json
{
    "body": "<a id='comment:6'></a>It looks like we were just posting at the same time--sorry, I didn't notice the warning.",
    "created_at": "2018-08-28T15:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389097",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>It looks like we were just posting at the same time--sorry, I didn't notice the warning.



---

archive/issue_comments_389098.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-25T11:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389098",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_389099.json:
```json
{
    "body": "<a id='comment:8'></a>Do I understand it right that the branch on #26011 fixes this?",
    "created_at": "2018-09-25T11:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389099",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>Do I understand it right that the branch on #26011 fixes this?



---

archive/issue_comments_389100.json:
```json
{
    "body": "<a id='comment:9'></a>It would.  The problem here was that I was manually calling `mv` on each file one-by-one, which in its own right is a bit slow when you have lots of files to move.  But there are some unfortunate subtleties to `mv`, especially when symlinks are involved, that were not taken into account (see the problem Jeroen described in this ticket).  #26011 would replace N `mv` calls with a single `cp -r` of the entire directory tree, which AFAICT handles cases like symlinks well too.  \n\nIn #26011 Jeroen raised some valid concerns about that approach which I attempted to answer, but I admit I don't know what the best play is here (though most online resources I've scoured really do seem to suggest that using `cp` is the most robust approach in most cases, even if that means needless copying of data.  But I'm definitely up for other approaches if they can be suggested...",
    "created_at": "2018-09-25T13:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389100",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>It would.  The problem here was that I was manually calling `mv` on each file one-by-one, which in its own right is a bit slow when you have lots of files to move.  But there are some unfortunate subtleties to `mv`, especially when symlinks are involved, that were not taken into account (see the problem Jeroen described in this ticket).  #26011 would replace N `mv` calls with a single `cp -r` of the entire directory tree, which AFAICT handles cases like symlinks well too.  

In #26011 Jeroen raised some valid concerns about that approach which I attempted to answer, but I admit I don't know what the best play is here (though most online resources I've scoured really do seem to suggest that using `cp` is the most robust approach in most cases, even if that means needless copying of data.  But I'm definitely up for other approaches if they can be suggested...



---

archive/issue_comments_389101.json:
```json
{
    "body": "<a id='comment:10'></a>Duplicate?",
    "created_at": "2018-10-05T22:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389101",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>Duplicate?



---

archive/issue_events_065198.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-10-08T09:49:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26153#event-65198"
}
```



---

archive/issue_comments_389102.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-08T09:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389102",
    "user": "https://github.com/embray"
}
```

Resolution: fixed



---

archive/issue_comments_389103.json:
```json
{
    "body": "<a id='comment:11'></a>I wouldn't say it's a duplicate per se, but since #26011 has been accepted we should be able to call this fixed as well.  I'm still not sure if Jeroen will be satisfied with the solution to this (I'm not entirely either) but if we revisit the issue we should just make sure this case is preserved s well.",
    "created_at": "2018-10-08T09:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389103",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>I wouldn't say it's a duplicate per se, but since #26011 has been accepted we should be able to call this fixed as well.  I'm still not sure if Jeroen will be satisfied with the solution to this (I'm not entirely either) but if we revisit the issue we should just make sure this case is preserved s well.



---

archive/issue_comments_389104.json:
```json
{
    "body": "<a id='comment:12'></a>It's not really \"fixed\" by #26011 in the sense that the condition now becomes a hard error (after #26642), failing the installation. Ideally, it should *overwrite* any existing directories.\n\nThat being said, I think that you can only do so much with simple shell scripts. Anything more complicated should really be done in Python.",
    "created_at": "2018-11-05T13:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389104",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>It's not really "fixed" by #26011 in the sense that the condition now becomes a hard error (after #26642), failing the installation. Ideally, it should *overwrite* any existing directories.

That being said, I think that you can only do so much with simple shell scripts. Anything more complicated should really be done in Python.



---

archive/issue_comments_389105.json:
```json
{
    "body": "<a id='comment:13'></a>Yes, ideally sage-spkg should still be rewritten mostly if not entirely in Python.",
    "created_at": "2018-11-06T10:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26153#issuecomment-389105",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>Yes, ideally sage-spkg should still be rewritten mostly if not entirely in Python.
