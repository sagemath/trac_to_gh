# Issue 26342: Improve triconnectivity algorithm: avoid recursive calls

archive/issues_026105.json:
```json
{
    "body": "Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code by avoiding recursive calls.\n\nThis is a follow up to #25598. \n\n\n\nCC:  @meghanamreddy saiharsh @tscrim\n\nBranch/Commit: 2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f\n\nReviewer: Travis Scrimshaw\n\nAuthor: David Coudert\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/26342\n\n",
    "closed_at": "2018-09-27T17:41:17Z",
    "created_at": "2018-09-24T16:22:03Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Improve triconnectivity algorithm: avoid recursive calls",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26342",
    "user": "https://github.com/dcoudert"
}
```
Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code by avoiding recursive calls.

This is a follow up to #25598. 



CC:  @meghanamreddy saiharsh @tscrim

Branch/Commit: 2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f

Reviewer: Travis Scrimshaw

Author: David Coudert

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/26342





---

archive/issue_comments_506395.json:
```json
{
    "body": "<a id='comment:1'></a>\nIt remains to remove recursion in `__path_search`. Feel free to do it if you know how :P\n\n---\nNew commits:\n|                                                                                                                                          |                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|\n|[5dc9457](https://git.sagemath.org/sage.git/commit?id=5dc9457a76bade840649a6748a89e4ea235d377f)|`trac #26342: remove recursion in dfs1, dfs2 and path_finder`|",
    "created_at": "2018-09-24T16:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506395",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:1'></a>
It remains to remove recursion in `__path_search`. Feel free to do it if you know how :P

---
New commits:
|                                                                                                                                          |                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|
|[5dc9457](https://git.sagemath.org/sage.git/commit?id=5dc9457a76bade840649a6748a89e4ea235d377f)|`trac #26342: remove recursion in dfs1, dfs2 and path_finder`|



---

archive/issue_comments_506396.json:
```json
{
    "body": "Changing branch from \"\" to \"public/26342_remove_recursion_in_triconnectivity\"",
    "created_at": "2018-09-24T16:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506396",
    "user": "https://github.com/dcoudert"
}
```

Changing branch from "" to "public/26342_remove_recursion_in_triconnectivity"



---

archive/issue_comments_506397.json:
```json
{
    "body": "Changing commit from \"\" to \"5dc9457a76bade840649a6748a89e4ea235d377f\"",
    "created_at": "2018-09-24T16:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506397",
    "user": "https://github.com/dcoudert"
}
```

Changing commit from "" to "5dc9457a76bade840649a6748a89e4ea235d377f"



---

archive/issue_comments_506398.json:
```json
{
    "body": "Changing commit from \"5dc9457a76bade840649a6748a89e4ea235d377f\" to \"3b60c34080b0ef194deccef72459637974693241\"",
    "created_at": "2018-09-25T16:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506398",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5dc9457a76bade840649a6748a89e4ea235d377f" to "3b60c34080b0ef194deccef72459637974693241"



---

archive/issue_comments_506399.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[3b60c34](https://git.sagemath.org/sage.git/commit/?id=3b60c34080b0ef194deccef72459637974693241)|`trac #26342: remove recursion in path_search`|",
    "created_at": "2018-09-25T16:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506399",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[3b60c34](https://git.sagemath.org/sage.git/commit/?id=3b60c34080b0ef194deccef72459637974693241)|`trac #26342: remove recursion in path_search`|



---

archive/issue_comments_506400.json:
```json
{
    "body": "<a id='comment:3'></a>\nIt was quite frightening to modify `__path_search`, but I did it ! I tried the new version on quite large graphs and I'm confident on the results.\n\n```\nsage: G = graphs.RandomBarabasiAlbert(10000, 3)\nsage: G.order(), G.size()\n(10000, 29991)\nsage: %time T = G.spqr_tree()\nCPU times: user 2.13 s, sys: 68.9 ms, total: 2.2 s\nWall time: 2.2 s\nsage: T.vertices()\n[('R', Multi-graph on 10000 vertices)]\nsage: for u,v in G.edges(labels=False):  # long\n....:     G.add_path([u, G.add_vertex(), v])\n....:     \nsage: G.order(), G.size()\n(39991, 89973)\nsage: %time T = G.spqr_tree()\nCPU times: user 17.8 s, sys: 722 ms, total: 18.5 s\nWall time: 18.7 s\nsage: T\nSPQR-tree of : Graph on 59983 vertices\nsage: from collections import Counter\nsage: Counter(u[0] for u in T)\nCounter({'P': 29991, 'S': 29991, 'R': 1})\nsage: for u,v in G.edges(labels=False): # extremely long\n....:     G.add_path([u, G.add_vertex(), v])\n....:     \nsage: G.order(), G.size()\n(129964, 269919)\nsage: %time T = G.spqr_tree()\nCPU times: user 1min 1s, sys: 5.65 s, total: 1min 7s\nWall time: 1min 8s\nsage: Counter(u[0] for u in T)\nCounter({'S': 119964, 'P': 89973, 'R': 1})\n```",
    "created_at": "2018-09-25T16:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506400",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>
It was quite frightening to modify `__path_search`, but I did it ! I tried the new version on quite large graphs and I'm confident on the results.

```
sage: G = graphs.RandomBarabasiAlbert(10000, 3)
sage: G.order(), G.size()
(10000, 29991)
sage: %time T = G.spqr_tree()
CPU times: user 2.13 s, sys: 68.9 ms, total: 2.2 s
Wall time: 2.2 s
sage: T.vertices()
[('R', Multi-graph on 10000 vertices)]
sage: for u,v in G.edges(labels=False):  # long
....:     G.add_path([u, G.add_vertex(), v])
....:     
sage: G.order(), G.size()
(39991, 89973)
sage: %time T = G.spqr_tree()
CPU times: user 17.8 s, sys: 722 ms, total: 18.5 s
Wall time: 18.7 s
sage: T
SPQR-tree of : Graph on 59983 vertices
sage: from collections import Counter
sage: Counter(u[0] for u in T)
Counter({'P': 29991, 'S': 29991, 'R': 1})
sage: for u,v in G.edges(labels=False): # extremely long
....:     G.add_path([u, G.add_vertex(), v])
....:     
sage: G.order(), G.size()
(129964, 269919)
sage: %time T = G.spqr_tree()
CPU times: user 1min 1s, sys: 5.65 s, total: 1min 7s
Wall time: 1min 8s
sage: Counter(u[0] for u in T)
Counter({'S': 119964, 'P': 89973, 'R': 1})
```



---

archive/issue_comments_506401.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code to avoid recursive calls.\n+Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code by avoiding recursive calls.\n \n This is a follow up to #25598. \n \n``````\n",
    "created_at": "2018-09-25T16:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506401",
    "user": "https://github.com/dcoudert"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code to avoid recursive calls.
+Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code by avoiding recursive calls.
 
 This is a follow up to #25598. 
 
``````




---

archive/issue_comments_506402.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-25T16:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506402",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_506403.json:
```json
{
    "body": "Changing commit from \"3b60c34080b0ef194deccef72459637974693241\" to \"154bcdef24b6d8cd29defa9b463a7859ca20cea1\"",
    "created_at": "2018-09-25T23:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506403",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3b60c34080b0ef194deccef72459637974693241" to "154bcdef24b6d8cd29defa9b463a7859ca20cea1"



---

archive/issue_comments_506404.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[154bcde](https://git.sagemath.org/sage.git/commit/?id=154bcdef24b6d8cd29defa9b463a7859ca20cea1)|`Some trivial Cythonization and doc improvements.`|",
    "created_at": "2018-09-25T23:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506404",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[154bcde](https://git.sagemath.org/sage.git/commit/?id=154bcdef24b6d8cd29defa9b463a7859ca20cea1)|`Some trivial Cythonization and doc improvements.`|



---

archive/issue_comments_506405.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[2e0ddb3](https://git.sagemath.org/sage.git/commit/?id=2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f)|`Some trivial Cythonization and doc improvements.`|",
    "created_at": "2018-09-25T23:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506405",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[2e0ddb3](https://git.sagemath.org/sage.git/commit/?id=2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f)|`Some trivial Cythonization and doc improvements.`|



---

archive/issue_comments_506406.json:
```json
{
    "body": "Changing commit from \"154bcdef24b6d8cd29defa9b463a7859ca20cea1\" to \"2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f\"",
    "created_at": "2018-09-25T23:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506406",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "154bcdef24b6d8cd29defa9b463a7859ca20cea1" to "2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f"



---

archive/issue_comments_506407.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2018-09-25T23:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506407",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_506408.json:
```json
{
    "body": "<a id='comment:6'></a>\nI did some trivial Cythonization (declaring obvious variable types), and I also did a bunch of doc improvements/standardizations (although almost all of them you cannot see because they are private methods). It is not surprising that my little Cythonization will make for great speed improvements, it is more of setup for the bigger overhaul (which rightly should be on a separate ticket). If my changes are good, then you can set a positive review.\n\n8.4.beta6:\n\n```\nsage: G = graphs.JankoKharaghaniGraph(936)\nsage: (G.order(), G.size())\n(936, 175500)\nsage: %time T = G.spqr_tree()\nCPU times: user 6.22 s, sys: 96 ms, total: 6.32 s\nWall time: 6.3 s\n```\nYour branch:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 6.38 s, sys: 108 ms, total: 6.49 s\nWall time: 6.45 s\n```\nMy branch\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 6.27 s, sys: 124 ms, total: 6.4 s\nWall time: 6.34 s\n```",
    "created_at": "2018-09-25T23:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506408",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>
I did some trivial Cythonization (declaring obvious variable types), and I also did a bunch of doc improvements/standardizations (although almost all of them you cannot see because they are private methods). It is not surprising that my little Cythonization will make for great speed improvements, it is more of setup for the bigger overhaul (which rightly should be on a separate ticket). If my changes are good, then you can set a positive review.

8.4.beta6:

```
sage: G = graphs.JankoKharaghaniGraph(936)
sage: (G.order(), G.size())
(936, 175500)
sage: %time T = G.spqr_tree()
CPU times: user 6.22 s, sys: 96 ms, total: 6.32 s
Wall time: 6.3 s
```
Your branch:

```
sage: %time T = G.spqr_tree()
CPU times: user 6.38 s, sys: 108 ms, total: 6.49 s
Wall time: 6.45 s
```
My branch

```
sage: %time T = G.spqr_tree()
CPU times: user 6.27 s, sys: 124 ms, total: 6.4 s
Wall time: 6.34 s
```



---

archive/issue_comments_506409.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-26T04:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506409",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_506410.json:
```json
{
    "body": "<a id='comment:7'></a>\nThank you Travis for the improvements. I will to do more Cythonization (e.g., using arrays instead of lists, turn the doubly linked list to some C/C++ data structure, etc.) in other tickets. The number of methods without doctest should also be reduced (to 0), which is not obvious for some internal methods. One step at a time ;)",
    "created_at": "2018-09-26T04:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506410",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>
Thank you Travis for the improvements. I will to do more Cythonization (e.g., using arrays instead of lists, turn the doubly linked list to some C/C++ data structure, etc.) in other tickets. The number of methods without doctest should also be reduced (to 0), which is not obvious for some internal methods. One step at a time ;)



---

archive/issue_comments_506411.json:
```json
{
    "body": "<a id='comment:8'></a>\nFeel free to cc me and ask questions (I have done a fair bit of cythonization and picked up some tricks). For those helper methods, if you make them `cdef`, then you don't need to give them doctests. :)",
    "created_at": "2018-09-26T04:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506411",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
Feel free to cc me and ask questions (I have done a fair bit of cythonization and picked up some tricks). For those helper methods, if you make them `cdef`, then you don't need to give them doctests. :)



---

archive/issue_comments_506412.json:
```json
{
    "body": "<a id='comment:9'></a>\nNoted :P",
    "created_at": "2018-09-26T04:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506412",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:9'></a>
Noted :P



---

archive/issue_events_065529.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-27T17:41:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26342#event-65529"
}
```



---

archive/issue_comments_506413.json:
```json
{
    "body": "Changing branch from \"public/26342_remove_recursion_in_triconnectivity\" to \"2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f\"",
    "created_at": "2018-09-27T17:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506413",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/26342_remove_recursion_in_triconnectivity" to "2e0ddb3e8aa7532e3c82c468aba82c8e8cf11e8f"



---

archive/issue_comments_506414.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-27T17:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-506414",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
