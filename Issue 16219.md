# Issue 16219: Bug in descend_to method for elliptic curves

Issue created by migration from https://trac.sagemath.org/ticket/16456

Original creator: cremona

Original creation time: 2014-06-07 17:06:54

Keywords: elliptic curve base change

The function descend_to which was implemented in #9384 is incorrect.  The twisting parameter d in L* is only defined modulo (L*)^2 and one has to determine whether there is a representative which lies in K*, which the implementation does not do, so some "positive" results are missed.  I will post an example of this.  The heart of the problem being solved here is to determine whether (given that j(E) is in K of course) the twisting parameter in L*/(L*)^2 is in the image of K*/(K*)^2 or not, and the implementation ignores this.  (For j=0 or 1728 the principle is the same with squares replced by 6th or 4th powers respectively.)

I can see how to fix this for number fields (one can restrict from K*/(K*)^2 to a finite K(S,2) for an easily determined set S of primes) or for finite fields, but it may not be possible to have this implemented for arbitrary fields, which will cause a problem with the patching.


---

Comment by cremona created at 2014-06-07 18:51:45

Set assignee to cremona.


---

Comment by cremona created at 2014-06-13 13:58:59

Changing status from new to needs_review.


---

Comment by cremona created at 2014-06-13 13:58:59

Ready for review.  Note that there are two separate things here (which perhaps should have been in separate tickets):

Up till the last commit the changes are in in number fields (including QQ), not touching elliptic curves, implementing the function descend_mod_power for number field elements and enhancing the selmer_group with selmer_group_iterator for ease of use.  (Also correcting the documentation for selmer_group).

The last commit does what the ticket wanted, namely to re-implement the descend_to function for elliptic curves.  Apart from trivial cases this will only work over number fields.  It would work over any other field where descend_mod_power could be implemented such as finite fields, but note that in characteristics 2 and 3 the function would need to have a completely different implementation.
----
New commits:


---

Comment by git created at 2014-07-14 13:31:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2014-07-21 13:13:41

New commits:


---

Comment by pbruin created at 2014-07-22 09:45:16

I remember looking at the Selmer group code some time ago (and again just now) and getting the impression that the group _K_(_S_, _m_) returned by `selmer_group(S, m)` is the one fitting in a natural exact sequence (warning: unicode experiment ahead)

1 ⟶ O<sub>_K_,_S_</sub><sup>×</sup>/O<sub>_K_,_S_</sub><sup>×_m_</sup> ⟶ _K_(_S_, _m_) ⟶ Cl<sub>_K,S_</sub>[_m_] ⟶ 0.

(I.e., I think _K_(_S_, _m_) should be canonically isomorphic to the flat cohomology group H<sup>1</sup>(O<sub>_K_,_S_</sub>, *_μ*<sub>m</sub>_).  This can be replaced by étale cohomology if _S_ contains all places dividing _m_, and in that case I also think that the above H<sup>1</sup>, and _K_(_S_, _m_), should be isomorphic to H<sup>1</sup>(Gal(_K<sup>S</sup>_/_K_), *_μ*<sub>m</sub>_) with _K<sup>S</sup>_ the maximal extension of _K_ that is unramified outside _S_.)

Is the above exact sequence correct, and should it perhaps be mentioned in the documentation?  And is there a comparable exact sequence for the "true" Selmer group consisting of the elements giving unramified extensions of _K_?


---

Comment by cremona created at 2014-07-22 10:31:26

See http://trac.sagemath.org/ticket/16496 where you will find that exact sequence!

One thing which makes this sequence easier to deal with than one might expect is that the group in the middle is a direct product of the other two rather than some more complicated extension.


---

Comment by pbruin created at 2014-07-22 16:09:41

Replying to [comment:9 cremona]:
> See http://trac.sagemath.org/ticket/16496 where you will find that exact sequence!
Right!  I am sure I have seen that ticket before...
> One thing which makes this sequence easier to deal with than one might expect is that the group in the middle is a direct product of the other two rather than some more complicated extension.
That sounded surprising to me at first, but I tried to verify it and realised I had actually also done something very much like that before.


---

Comment by pbruin created at 2014-07-22 16:17:46

Here is a reviewer patch mostly consisting of documentation/formatting changes.  If you agree with my changes, you can set it to positive review.


---

Comment by pbruin created at 2014-07-23 20:13:23

While trying to find a clever cohomological argument for the splitting of the exact sequence from comment:8, I did not succeed but did find a bug in `selmer_group()`; see #16708.


---

Comment by git created at 2014-07-23 20:24:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-23 20:32:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by pbruin created at 2014-07-23 20:35:10

Actually both the original answer and my "corrected" one in the doctest changed by commit `bed05c5` are wrong; if I'm not mistaken, the correct answer is

```
sage: K = QuadraticField(-5)
sage: list(K.selmer_group_iterator((), 4))
[1, 4, -1, -4]
```



---

Comment by pbruin created at 2014-07-23 20:35:10

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2014-07-23 20:55:38

Replying to [comment:16 pbruin]:
> Actually both the original answer and my "corrected" one in the doctest changed by commit `bed05c5` are wrong; if I'm not mistaken, the correct answer is
> {{{
> sage: K = QuadraticField(-5)
> sage: list(K.selmer_group_iterator((), 4))
> [1, 4, -1, -4]
> }}}

That is certainly correct.  I will look at this and #16708 tomorrow.


---

Comment by cremona created at 2014-07-24 11:43:50

Between here and #16708 a doctest needed changing as I think Peter pointed out somewhere:

```
            sage: K.<a> = QuadraticField(-5)
            sage: list(K.selmer_group_iterator((), 4))
            [1, 2, 4, 8, -1, -2, -4, -8]
```

should be 

```
           sage: K.<a> = QuadraticField(-5)
           sage: list(K.selmer_group_iterator((), 4))
           [1, 4, 16, 64, -1, -4, -16, -64]
```

which I am changing and will commit & push.


---

Comment by cremona created at 2014-07-24 11:45:05

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2014-07-24 11:45:05

New commits:


---

Comment by cremona created at 2014-07-24 11:47:55

Peter, thanks for your tidying up of (and improving) the documentation.  I just fixed that one doctest which I think you already noticed was incorrect because of the bug fixed now at #16708.  That means that the branch name has gone back to mine (u/cremona/...), and I have set it back to "needs review".  Since I like your reviewer's changes, if you agree wit hthis last one then we can set it to "positive review".


---

Comment by pbruin created at 2014-07-24 11:56:32

Replying to [comment:18 cremona]:
> Between here and #16708 a doctest needed changing as I think Peter pointed out somewhere:
> {{{
>             sage: K.<a> = QuadraticField(-5)
>             sage: list(K.selmer_group_iterator((), 4))
>             [1, 2, 4, 8, -1, -2, -4, -8]
> }}}
> should be 
> {{{
>            sage: K.<a> = QuadraticField(-5)
>            sage: list(K.selmer_group_iterator((), 4))
>            [1, 4, 16, 64, -1, -4, -16, -64]
> }}}
> which I am changing and will commit & push.
That second answer was actually the wrong "correction" I pushed and then retracted.  It should be `[1, 4, -1, -4]` (as in comment:17); in fact 16 is a fourth power, hence represents the trivial element of the Selmer group.  The Selmer group is isomorphic to _C_<sub>2</sub> x _C_<sub>2</sub> (since both the units modulo 4-th powers and the 4-torsion in the class group are cyclic of order 2.)

I think the problem is the line

```
f = lambda o: m if o is Infinity else o.gcd(m)
```

where you will somehow need to take the orders of elements of the class group into account.


---

Comment by pbruin created at 2014-07-24 11:56:32

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2014-07-24 12:31:03

Sorry about that.  I'll work out how to correct it....


---

Comment by git created at 2014-07-24 13:27:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2014-07-24 13:32:34

...done.  I added an optional parameter "orders" to the selmer_group method, default False gives the old behavious, if True also outputs a list of the orders of the generators, which are all equal to m when m is prime, but not necesarily otherwise.  Added doctests for this.  Now the iterator uses this instead of the old formula, which was wrong.  I thought that this was simpler than trying to recover the orders from the list of generators, since it is information we have to hand when constructing the list of generators.

For consistency I did the same for the special versions over QQ, though the bug did not apply here.  At the same time I noticed that over QQ when -1 is a generator it was put last while over number fields the units are always first, so I changed that (and the associated doctests) too.

Note that this change will be superceded after #16496 when there is a proper class for these Selmer groups.  And also that the correctness of the current selmer_group function relies on the direct product fact alluded to in earlier comments!


---

Comment by cremona created at 2014-07-24 13:32:34

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2014-07-24 15:14:54

OK, everything looks good to me now!


---

Comment by pbruin created at 2014-07-24 15:14:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-07-25 05:05:41

Resolution: fixed
