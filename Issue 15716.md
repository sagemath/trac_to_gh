# Issue 15716: Large memory consumption by the basis of the ambient space

Issue created by migration from https://trac.sagemath.org/ticket/15953

Original creator: mmezzarobba

Original creation time: 2014-03-16 13:24:49

Thomas Feulner:

I am working on linear codes and I observed a high memory consumption when constructing codes of large length. I figured out that this problem already appears in the construction of vector spaces:


```
sage: F.<a> = GF(4)
sage: M = MatrixSpace(F, 8, 10000).random_element()
sage: V = VectorSpace(F, M.ncols())
sage: V.__dict__.keys()
['__reduce_ex__', '_element_class', '_gram_matrix', '_FreeModule_generic__rank', '_FreeModule_generic__is_sparse', '_FreeModule_generic__degree', '_FreeModule_generic__uses_ambient_inner_product']
sage: V.subspace(M)
Vector space of degree 10000 and dimension 8 over Finite Field in a of size 2^2
Basis matrix:
8 x 10000 dense matrix over Finite Field in a of size 2^2
sage: V.__dict__.keys()
['__reduce_ex__', '_element_class', '_gram_matrix', '_FreeModule_generic__rank', '_FreeModule_generic__is_sparse', '_FreeModule_generic__degree', '_FreeModule_ambient__basis', '_FreeModule_generic__uses_ambient_inner_product']
```


As you can see, the construction of the subspace adds a basis to V ==> sage stores 10000 dense vectors of length 10000!

Doing the same construction over other fields, say F=QQ, does not show this behavior. Is there any 
solution in sight for this? 

https://groups.google.com/forum/#!topic/sage-devel/ULcyJECqT4M/discussion

See also #13304.


---

Comment by sbrandhorst created at 2018-07-02 07:19:10

Changing status from new to needs_review.


---

Comment by sbrandhorst created at 2018-07-02 07:19:10


```
sage: F.<a> = GF(4)
sage: M = MatrixSpace(F, 8, 10000).random_element()
sage: V = VectorSpace(F, M.ncols())
sage: V.__dict__.keys()
['__reduce_ex__',
 '_FreeModule_generic__uses_ambient_inner_product',
 '_gram_matrix',
 'Element',
 '_FreeModule_generic__coordinate_ring',
 '_FreeModule_generic__rank',
 '_FreeModule_generic__degree',
 '_FreeModule_generic__is_sparse']
sage: V.subspace(M)
Vector space of degree 10000 and dimension 8 over Finite Field in a of size 2^2
Basis matrix:
8 x 10000 dense matrix over Finite Field in a of size 2^2
sage: V.__dict__.keys()
['__reduce_ex__',
 '_FreeModule_generic__uses_ambient_inner_product',
 '_gram_matrix',
 'element_class',
 'Element',
 '_FreeModule_generic__coordinate_ring',
 '_FreeModule_generic__rank',
 '_FreeModule_generic__degree',
 '_FreeModule_generic__is_sparse']
```

The issue seems to be fixed now.
Calling 

```
V.basis()
```

still takes ages but I guess that is to be expected.


---

Comment by vdelecroix created at 2018-09-02 01:06:40

would be nice to have a careful doctest for this...


---

Comment by sbrandhorst created at 2018-09-02 12:04:58

Indeed. I could check for the attribute `_FreeModule_ambient__basis`
after the creation of a submodule. Any other suggestion?


---

Comment by vdelecroix created at 2018-09-02 14:13:06

Replying to [comment:5 sbrandhorst]:
> Indeed. I could check for the attribute `_FreeModule_ambient__basis`
> after the creation of a submodule. Any other suggestion?

Indeed it is complicated to check. Your method would work today but if the way the basis is cached does change in the future we would not see it. Possible alternative:
- just compare the number of attributes,
- play with a vector space whose vector would have size ~500M so that the basis could not fit in memory (though patchbot are not run with memory limit).

I am not very much convinced by my propositions.


---

Comment by sbrandhorst created at 2018-09-02 17:52:03

We could in a second test check that calling ``basis()`` actually creates the attribute
`_FreeModule_ambient__basis`. Thus if the way to cache is changed, one would notice and could adapt the test?


---

Comment by vdelecroix created at 2018-09-02 18:18:51

I like it!


---

Comment by sbrandhorst created at 2018-11-20 11:02:25

New commits:


---

Comment by vdelecroix created at 2018-11-20 12:31:20

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-11-20 12:31:20


```diff
-trac`15953`
+trac:`15953`
```



---

Comment by git created at 2018-11-20 12:35:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2019-05-16 06:56:05

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2019-05-19 13:39:12

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2019-05-19 13:39:12

thx


---

Comment by chapoton created at 2019-05-25 17:11:06

Is this really an invalid ticket ? It does not look so to me!


---

Comment by vdelecroix created at 2019-05-25 17:12:55

Oups. Thanks Frederic!


---

Comment by vbraun created at 2019-05-28 21:07:57

Resolution: fixed
