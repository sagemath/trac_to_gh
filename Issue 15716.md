# Issue 15716: Large memory consumption by the basis of the ambient space

archive/issues_015716.json:
```json
{
    "body": "Thomas Feulner:\n\nI am working on linear codes and I observed a high memory consumption when constructing codes of large length. I figured out that this problem already appears in the construction of vector spaces:\n\n\n```\nsage: F.<a> = GF(4)\nsage: M = MatrixSpace(F, 8, 10000).random_element()\nsage: V = VectorSpace(F, M.ncols())\nsage: V.__dict__.keys()\n['__reduce_ex__', '_element_class', '_gram_matrix', '_FreeModule_generic__rank', '_FreeModule_generic__is_sparse', '_FreeModule_generic__degree', '_FreeModule_generic__uses_ambient_inner_product']\nsage: V.subspace(M)\nVector space of degree 10000 and dimension 8 over Finite Field in a of size 2^2\nBasis matrix:\n8 x 10000 dense matrix over Finite Field in a of size 2^2\nsage: V.__dict__.keys()\n['__reduce_ex__', '_element_class', '_gram_matrix', '_FreeModule_generic__rank', '_FreeModule_generic__is_sparse', '_FreeModule_generic__degree', '_FreeModule_ambient__basis', '_FreeModule_generic__uses_ambient_inner_product']\n```\n\n\nAs you can see, the construction of the subspace adds a basis to V ==> sage stores 10000 dense vectors of length 10000!\n\nDoing the same construction over other fields, say F=QQ, does not show this behavior. Is there any \nsolution in sight for this? \n\nhttps://groups.google.com/forum/#!topic/sage-devel/ULcyJECqT4M/discussion\n\nSee also #13304.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15953\n\n",
    "created_at": "2014-03-16T13:24:49Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Large memory consumption by the basis of the ambient space",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15716",
    "user": "https://github.com/mezzarobba"
}
```
Thomas Feulner:

I am working on linear codes and I observed a high memory consumption when constructing codes of large length. I figured out that this problem already appears in the construction of vector spaces:


```
sage: F.<a> = GF(4)
sage: M = MatrixSpace(F, 8, 10000).random_element()
sage: V = VectorSpace(F, M.ncols())
sage: V.__dict__.keys()
['__reduce_ex__', '_element_class', '_gram_matrix', '_FreeModule_generic__rank', '_FreeModule_generic__is_sparse', '_FreeModule_generic__degree', '_FreeModule_generic__uses_ambient_inner_product']
sage: V.subspace(M)
Vector space of degree 10000 and dimension 8 over Finite Field in a of size 2^2
Basis matrix:
8 x 10000 dense matrix over Finite Field in a of size 2^2
sage: V.__dict__.keys()
['__reduce_ex__', '_element_class', '_gram_matrix', '_FreeModule_generic__rank', '_FreeModule_generic__is_sparse', '_FreeModule_generic__degree', '_FreeModule_ambient__basis', '_FreeModule_generic__uses_ambient_inner_product']
```


As you can see, the construction of the subspace adds a basis to V ==> sage stores 10000 dense vectors of length 10000!

Doing the same construction over other fields, say F=QQ, does not show this behavior. Is there any 
solution in sight for this? 

https://groups.google.com/forum/#!topic/sage-devel/ULcyJECqT4M/discussion

See also #13304.

Issue created by migration from https://trac.sagemath.org/ticket/15953





---

archive/issue_comments_203184.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-02T07:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203184",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_203185.json:
```json
{
    "body": "\n```\nsage: F.<a> = GF(4)\nsage: M = MatrixSpace(F, 8, 10000).random_element()\nsage: V = VectorSpace(F, M.ncols())\nsage: V.__dict__.keys()\n['__reduce_ex__',\n '_FreeModule_generic__uses_ambient_inner_product',\n '_gram_matrix',\n 'Element',\n '_FreeModule_generic__coordinate_ring',\n '_FreeModule_generic__rank',\n '_FreeModule_generic__degree',\n '_FreeModule_generic__is_sparse']\nsage: V.subspace(M)\nVector space of degree 10000 and dimension 8 over Finite Field in a of size 2^2\nBasis matrix:\n8 x 10000 dense matrix over Finite Field in a of size 2^2\nsage: V.__dict__.keys()\n['__reduce_ex__',\n '_FreeModule_generic__uses_ambient_inner_product',\n '_gram_matrix',\n 'element_class',\n 'Element',\n '_FreeModule_generic__coordinate_ring',\n '_FreeModule_generic__rank',\n '_FreeModule_generic__degree',\n '_FreeModule_generic__is_sparse']\n```\n\nThe issue seems to be fixed now.\nCalling \n\n```\nV.basis()\n```\n\nstill takes ages but I guess that is to be expected.",
    "created_at": "2018-07-02T07:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203185",
    "user": "https://github.com/simonbrandhorst"
}
```


```
sage: F.<a> = GF(4)
sage: M = MatrixSpace(F, 8, 10000).random_element()
sage: V = VectorSpace(F, M.ncols())
sage: V.__dict__.keys()
['__reduce_ex__',
 '_FreeModule_generic__uses_ambient_inner_product',
 '_gram_matrix',
 'Element',
 '_FreeModule_generic__coordinate_ring',
 '_FreeModule_generic__rank',
 '_FreeModule_generic__degree',
 '_FreeModule_generic__is_sparse']
sage: V.subspace(M)
Vector space of degree 10000 and dimension 8 over Finite Field in a of size 2^2
Basis matrix:
8 x 10000 dense matrix over Finite Field in a of size 2^2
sage: V.__dict__.keys()
['__reduce_ex__',
 '_FreeModule_generic__uses_ambient_inner_product',
 '_gram_matrix',
 'element_class',
 'Element',
 '_FreeModule_generic__coordinate_ring',
 '_FreeModule_generic__rank',
 '_FreeModule_generic__degree',
 '_FreeModule_generic__is_sparse']
```

The issue seems to be fixed now.
Calling 

```
V.basis()
```

still takes ages but I guess that is to be expected.



---

archive/issue_comments_203186.json:
```json
{
    "body": "would be nice to have a careful doctest for this...",
    "created_at": "2018-09-02T01:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203186",
    "user": "https://github.com/videlec"
}
```

would be nice to have a careful doctest for this...



---

archive/issue_comments_203187.json:
```json
{
    "body": "Indeed. I could check for the attribute `_FreeModule_ambient__basis`\nafter the creation of a submodule. Any other suggestion?",
    "created_at": "2018-09-02T12:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203187",
    "user": "https://github.com/simonbrandhorst"
}
```

Indeed. I could check for the attribute `_FreeModule_ambient__basis`
after the creation of a submodule. Any other suggestion?



---

archive/issue_comments_203188.json:
```json
{
    "body": "Replying to [comment:5 sbrandhorst]:\n> Indeed. I could check for the attribute `_FreeModule_ambient__basis`\n> after the creation of a submodule. Any other suggestion?\n\nIndeed it is complicated to check. Your method would work today but if the way the basis is cached does change in the future we would not see it. Possible alternative:\n- just compare the number of attributes,\n- play with a vector space whose vector would have size ~500M so that the basis could not fit in memory (though patchbot are not run with memory limit).\n\nI am not very much convinced by my propositions.",
    "created_at": "2018-09-02T14:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203188",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:5 sbrandhorst]:
> Indeed. I could check for the attribute `_FreeModule_ambient__basis`
> after the creation of a submodule. Any other suggestion?

Indeed it is complicated to check. Your method would work today but if the way the basis is cached does change in the future we would not see it. Possible alternative:
- just compare the number of attributes,
- play with a vector space whose vector would have size ~500M so that the basis could not fit in memory (though patchbot are not run with memory limit).

I am not very much convinced by my propositions.



---

archive/issue_comments_203189.json:
```json
{
    "body": "We could in a second test check that calling ``basis()`` actually creates the attribute\n`_FreeModule_ambient__basis`. Thus if the way to cache is changed, one would notice and could adapt the test?",
    "created_at": "2018-09-02T17:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203189",
    "user": "https://github.com/simonbrandhorst"
}
```

We could in a second test check that calling ``basis()`` actually creates the attribute
`_FreeModule_ambient__basis`. Thus if the way to cache is changed, one would notice and could adapt the test?



---

archive/issue_comments_203190.json:
```json
{
    "body": "I like it!",
    "created_at": "2018-09-02T18:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203190",
    "user": "https://github.com/videlec"
}
```

I like it!



---

archive/issue_comments_203191.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-11-20T11:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203191",
    "user": "https://github.com/simonbrandhorst"
}
```

New commits:



---

archive/issue_comments_203192.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-11-20T12:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203192",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_203193.json:
```json
{
    "body": "\n```diff\n-trac`15953`\n+trac:`15953`\n```\n",
    "created_at": "2018-11-20T12:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203193",
    "user": "https://github.com/videlec"
}
```


```diff
-trac`15953`
+trac:`15953`
```




---

archive/issue_comments_203194.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-20T12:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203194",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_203195.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-05-16T06:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203195",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_203196.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-05-19T13:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203196",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_203197.json:
```json
{
    "body": "thx",
    "created_at": "2019-05-19T13:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203197",
    "user": "https://github.com/videlec"
}
```

thx



---

archive/issue_comments_203198.json:
```json
{
    "body": "Is this really an invalid ticket ? It does not look so to me!",
    "created_at": "2019-05-25T17:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203198",
    "user": "https://github.com/fchapoton"
}
```

Is this really an invalid ticket ? It does not look so to me!



---

archive/issue_comments_203199.json:
```json
{
    "body": "Oups. Thanks Frederic!",
    "created_at": "2019-05-25T17:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203199",
    "user": "https://github.com/videlec"
}
```

Oups. Thanks Frederic!



---

archive/issue_comments_203200.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-05-28T21:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15716",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15716#issuecomment-203200",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
