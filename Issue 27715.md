# Issue 27715: upgrade normaliz to 3.7.3

Issue created by migration from https://trac.sagemath.org/ticket/27952

Original creator: vdelecroix

Original creation time: 2019-06-08 17:48:03

CC:  mkoeppe jipilab isuruf winfried tscrim @kliem @laisrast slelievre

Tarballs

- Normaliz: https://github.com/Normaliz/Normaliz/releases/download/v3.7.3/normaliz-3.7.3.tar.gz
- PyNormaliz: ?


---

Comment by vdelecroix created at 2019-06-08 18:00:13

New commits:


---

Comment by vdelecroix created at 2019-06-08 18:21:38

Changing keywords from "" to "package upgrade".


---

Comment by git created at 2019-06-08 18:25:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2019-06-08 18:25:57

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-06-08 18:33:01

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2019-06-09 14:20:46

Self tests do not pass on my computer

```
$ python3 setup.py test
/opt/sage/sage-py3-gcc/local/lib/python3.7/distutils/dist.py:274: UserWarning: Unknown distribution option: 'long_description_content_type'
  warnings.warn(msg)
running test
Doctest must_be_matrices-39.txt
  2 tests
Doctest test_rational_cones.txt
  34 tests
Doctest segfault-45.txt
  3 tests
Doctest autom.txt
Doctest failures
```



---

Comment by vdelecroix created at 2019-06-09 14:21:45

And I confirm the segfault in a Python3 console

```
$ python3
Python 3.7.3 (default, May 26 2019, 12:00:16) 
[GCC 8.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from PyNormaliz import Cone, NmzCone, NmzResult
>>> V = [[-1, -1, 1], [-1, 0, 1], [-1, 1, 1], [0, -1, 1], [0, 0, 1], [0, 1, 1], [1, -1, 1], [1, 0, 1], [1, 1, 1]]
>>> cube2 = NmzCone(vertices=V)
>>> NmzResult(cube2,"Automorphisms") == [8, [[[], []], []], [[[0, 2, 1, 3], [1, 0, 3, 2]], [[0, 1, 2, 3]]], [[[1, 0, 3, 2], [0, 2, 1, 3]], [[0, 1, 2, 3]]]]
Erreur de segmentation (core dumped)
```



---

Comment by git created at 2019-06-09 15:29:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2019-06-10 08:25:37

segfault probably due to e-antic version. I am about to release 0.1.3


---

Comment by vdelecroix created at 2019-06-10 09:44:14

Most probably, the segfault is due to the fact that Normaliz was not built with nauty support

```
checking whether nauty headers and library are available... checking for densenauty in -lnauty... no
```



---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by git created at 2019-06-17 18:14:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2019-06-17 18:15:12

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2019-06-19 19:34:12

What's this business with nauty.a?  Shouldn't a shared library be built?


---

Comment by vdelecroix created at 2019-06-19 20:39:08

If you suceed in doing so, please go on. Nauty makefile is extremly basic.


---

Comment by vdelecroix created at 2019-06-19 21:57:40

Changing keywords from "package upgrade" to "package upgrade days101".


---

Comment by mkoeppe created at 2019-06-20 22:14:10

Debian seems to have an autotoolized build system for nauty.
https://sources.debian.org/patches/nauty/2.5r9+ds-1/


---

Comment by vdelecroix created at 2019-06-22 12:07:43

They also do not build shared library as far a I see.


---

Comment by mkoeppe created at 2019-06-24 22:48:52

Their "upstream autotoolization.patch " has  `lib_LTLIBRARIES = libnauty.la  ....`


---

Comment by vdelecroix created at 2019-06-25 06:13:46

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2019-06-25 06:13:46

Then you are welcome to port their patch to Sage and propose a patch to normaliz!


---

Comment by jipilab created at 2019-08-20 19:27:06

FWIW: Normaliz 3.7.4 is out and fixes an f-vector issue (that came up with algebraic polytopes). It might be worth to grab this version right away and not wait for another ticket. This newer version should not be a quantum step...


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-02-06 22:40:53

Also we need a version of e-antic that finds Debian's install name of arb, `flint-arb`.
This seems to be in e-antic master but not in the 0.x branch


---

Comment by mkoeppe created at 2020-02-06 22:44:34

(see https://github.com/mkoeppe/sage/runs/430688755?check_suite_focus=true, where Sage recognizes libflint-arb but the e-antic install fails.)


---

Comment by mkoeppe created at 2020-02-08 22:30:00

Replying to [comment:29 mkoeppe]:
> Also we need a version of e-antic that finds Debian's install name of arb, `flint-arb`.
> This seems to be in e-antic master but not in the 0.x branch
Fixed in merged pull request https://github.com/videlec/e-antic/pull/82; now we only need a new release!


---

Comment by mkoeppe created at 2020-02-10 03:41:45

Needs to be merged with #28799.


---

Comment by @kliem created at 2020-02-16 17:25:14

The challenge with upgrading Normaliz and PyNormaliz one basically has to rewrite `_cone_from_Vrepresentation_and_Hrepresentation` in `backend_normaliz.py` (and then pickling fails again), as initialization from precomputed data of normaliz cones works a bit different now.

I have mostly figured out how to do this, I think. So unless someone want to, I would like to take care of that part.
----
New commits:


---

Comment by mkoeppe created at 2020-02-16 17:45:00

Replying to [comment:38 gh-kliem]:
> The challenge with upgrading Normaliz and PyNormaliz one basically has to rewrite `_cone_from_Vrepresentation_and_Hrepresentation` in `backend_normaliz.py` (and then pickling fails again), as initialization from precomputed data of normaliz cones works a bit different now.
> 
> I have mostly figured out how to do this, I think. So unless someone want to, I would like to take care of that part.

Sounds good.


---

Comment by mkoeppe created at 2020-02-16 17:53:24

I assume you are referring to these kinds of errors:

```
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 675, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._cone_from_Vrepresentation_and_Hrepresentation
Failed example:
    cone = P._cone_from_Vrepresentation_and_Hrepresentation(P.vertices(),P.rays(),P.inequalities(),P.equations())   # optional - pynormaliz
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._cone_from_Vrepresentation_and_Hrepresentation[2]>", line 1, in <module>
        cone = P._cone_from_Vrepresentation_and_Hrepresentation(P.vertices(),P.rays(),P.inequalities(),P.equations())   # optional - pynormaliz
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 790, in _cone_from_Vrepresentation_and_Hrepresentation
        return self._cone_from_normaliz_data(data, verbose=verbose)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 414, in _cone_from_normaliz_data
        cone = PyNormaliz.NmzCone(**data)
    PyNormaliz_cpp.NormalizError: Some error in the normaliz input data detected: Input type not allowed with precomputed data
```



---

Comment by mkoeppe created at 2020-02-16 17:55:15

I will not make further changes at this point.
The branch needs the first part of commit 9dd22ef4f79228fdb9e0e012b98046349922d6fb (from #28799).


---

Comment by @kliem created at 2020-02-16 20:58:43

`@`Winfried: I'm having trouble with the new version of normaliz for the following reason:

When initializing a cone from precomputed data, it asks me to specify `generated_lattice`. However, sometimes we do not have access to this (e.g. when we want to change backends and have never done the computations in normaliz or when combinatorially obtaining the new double description is much cheaper).

How do I obtain `generated_lattice` from `extreme_rays` and `maximal_subspace`? (Or even as a cone property from any normaliz cone).

I'm puzzled for example how I could obtain the 2-dimensional permutahedron e.g.. The following doesn't seem to work:


```
sage: import PyNormaliz
sage: cone = PyNormaliz.NmzCone(
....:     dehomogenization=[[0, 0, 0, 1]],
....:     extreme_rays=[
....:         [1, 2, 3, 1], [1, 3, 2, 1], [2, 1, 3, 1],
....:         [2, 3, 1, 1], [3, 1, 2, 1], [3, 2, 1, 1]],
....:     generated_lattice=[[1, 0, -1, 0], [0, 1, -1, 0], [0, 0, 6, 1]],
....:     maximal_subspace=[],
....:     support_hyperplanes=[
....:         [-1, -1, 0, 5], [-1, 0, 0, 3], [0, -1, 0, 3],
....:         [0, 1, 0, -1], [1, 0, 0, -1], [1, 1, 0, -3]])
```


It initializes the empty cone for some reason. (At least Dimension of this thing is -1.)

How do I modify the generated lattice to make this work?


---

Comment by git created at 2020-02-17 06:36:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-02-17 12:50:20

As for the trouble with normaliz 3.8.4:

Winfried Bruns figured out the error, one needs to patch normaliz somehow like this


```
Add a missing dual in normaliz 3.8.4
diff --git a/source/libnormaliz/cone.cpp b/source/libnormaliz/cone.cpp
index 4e416a75e1..9ba2b2ba40 100644
--- a/source/libnormaliz/cone.cpp
+++ b/source/libnormaliz/cone.cpp
@@ -1034,7 +1034,7 @@ void Cone<Integer>::process_multi_input_inner(map<InputType, vector<vector<Integ
         setComputed(ConeProperty::SupportHyperplanes);

         size_t test_rank=BasisChangePointed.getRank();
-        if( test_rank != BasisChangePointed.to_sublattice(Generators).rank() ||
+        if( test_rank != BasisChangePointed.to_sublattice_dual(Generators).rank() ||
                 test_rank != BasisChangePointed.to_sublattice_dual(SupportHyperplanes).rank())
             throw BadInputException("Precomputed data do not define pointed cone modulo maximal subspace");
         create_convex_hull_data();
```


I couldn't figure out, how to apply this patch though. So I manually changed the tarball and then udpated the checksums. So my last commit is most likely not helpful.
----
New commits:


---

Comment by @kliem created at 2020-02-17 13:48:57

All tests passing for me.


---

Comment by mkoeppe created at 2020-02-17 15:17:32

I've put in the patch
----
New commits:


---

Comment by mkoeppe created at 2020-02-17 15:25:41

I get this (on macOS):

```
sage -t src/sage/geometry/polyhedron/backend_normaliz.py
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 1242, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.__setstate__
Failed example:
    P1.volume(measure='induced_lattice', engine='normaliz')  # optional - pynormaliz
Expected:
    96
Got:
    0
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 1251, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.__setstate__
Failed example:
    P2 == P # optional - pynormaliz
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   2 of  27 in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.__setstate__
    [317 tests, 2 failures, 2.46 s]
```



---

Comment by mkoeppe created at 2020-02-17 15:29:39

Vincent, could you make a new e-antic 0.x release?


---

Comment by @kliem created at 2020-02-17 15:43:16

This means you didn't apply the patch before installing normaliz (?)

Replying to [comment:50 mkoeppe]:
> I get this (on macOS):
> {{{
> sage -t src/sage/geometry/polyhedron/backend_normaliz.py
> **********************************************************************
> File "src/sage/geometry/polyhedron/backend_normaliz.py", line 1242, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.__setstate__
> Failed example:
>     P1.volume(measure='induced_lattice', engine='normaliz')  # optional - pynormaliz
> Expected:
>     96
> Got:
>     0
> **********************************************************************
> File "src/sage/geometry/polyhedron/backend_normaliz.py", line 1251, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.__setstate__
> Failed example:
>     P2 == P # optional - pynormaliz
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> 1 item had failures:
>    2 of  27 in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz.__setstate__
>     [317 tests, 2 failures, 2.46 s]
> }}}


---

Comment by mkoeppe created at 2020-02-17 15:48:44

The patch was applied in that build:

```
sage-logger -p 'sage-spkg   normaliz-3.8.4' '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/logs/pkgs/normaliz-3.8.4.log'
[normaliz-3.8.4] Found local metadata for normaliz-3.8.4
[normaliz-3.8.4] Using cached file /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/upstream/normaliz-3.8.4.tar.gz
[normaliz-3.8.4] normaliz-3.8.4
[normaliz-3.8.4] ====================================================
[normaliz-3.8.4] Setting up build directory for normaliz-3.8.4
[normaliz-3.8.4] Finished extraction
[normaliz-3.8.4] Applying patches from ../patches...
[normaliz-3.8.4] Applying ../patches/patch_test_rank.patch
[normaliz-3.8.4] patching file source/libnormaliz/cone.cpp
[normaliz-3.8.4] Hunk #1 succeeded at 1034 with fuzz 2.
```



---

Comment by @kliem created at 2020-02-17 16:11:39

This is the same issue that I had and why I said, I couldn't do a patch.

When I manually modified the tarball in upstream and updated the checksums it worked just fine.


---

Comment by mkoeppe created at 2020-02-17 16:16:54

Attach your modified tarball please


---

Attachment

Well your tarball has a different patch.


---

Comment by @kliem created at 2020-02-17 18:07:42

Sorry, my bad. I used an editor without line numbers, because it is not configured to delete trailing spaces.

This is Winfrieds mail:

An einer Stelle ein _dual vergessen. Ersetze Zeile 4287 in cone.cpp durch

vector<Integer> HelpDehom=BasisChangePointed.to_sublattice_dual(Dehomogenization);

Winfried


---

Comment by @kliem created at 2020-02-17 18:09:53

I guess when making the diff file for the patch, I got it wrong. That explains, why the patch was successfully applied but it still didn't work.


---

Comment by mkoeppe created at 2020-02-17 18:10:36

I'll push a fix in a second


---

Comment by git created at 2020-02-17 18:12:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-02-17 18:13:40

Replying to [comment:60 gh-kliem]:
> I guess when making the diff file for the patch, I got it wrong. That explains, why the patch was successfully applied but it still didn't work.
I recommend this procedure: https://doc.sagemath.org/html/en/developer/packaging.html#how-to-maintain-a-set-of-patches


---

Comment by git created at 2020-02-17 18:16:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-02-17 18:18:45

This fixes the doctest failures for me.


---

Comment by mkoeppe created at 2020-02-17 18:18:45

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-02-17 19:15:42

New commits:


---

Comment by @kliem created at 2020-02-18 07:58:31

How about


```diff
-sdh_make
+sdh_make CFLAGS=-fPIC
```


Doesn't that overwrite previously configured `CFLAGS`?


---

Comment by mkoeppe created at 2020-02-24 08:24:06

Replying to [comment:67 gh-kliem]:
> How about
> 
> {{{#!diff
> -sdh_make
> +sdh_make CFLAGS=-fPIC
> }}}
> 
> Doesn't that overwrite previously configured `CFLAGS`?

Good point. I have revised this.
----
New commits:


---

Comment by mkoeppe created at 2020-02-25 04:16:16

There are still build failures on various platforms:

`ubuntu-trusty`:

```
In file included from ./libnormaliz/list_operations.cpp:31:0,
                 from libnormaliz/cone_and_control.cpp:31:
./libnormaliz/matrix.h: In function 'libnormaliz::Matrix<Number> libnormaliz::LLL_red(const libnormaliz::Matrix<Number>&, libnormaliz::Matrix<Integer>&, libnormaliz::Matrix<Integer>&)':
./libnormaliz/matrix.h:647:30: error: call of overloaded 'isnan(__gnu_cxx::__alloc_traits<std::allocator<double> >::value_type&)' is ambiguous
             if (isnan(M[i][j])) {
 }}}

`ubuntu-{xenial,bionic}-standard`, `fedora-26-standard` etc.:
{{{
checking nauty/nauty.h presence... no
checking for nauty/nauty.h... no
configure: error: nauty is not available but was requested
}}}

`ubuntu-{eoan,focal}-standard`, `debian-sid-standard` etc.:
{{{
... renf_elem/.libs/cmp_fmpq.o renf_elem/.libs/floor_ceil.o renf_elem/.libs/gen.o renf_elem/.libs/get_cfrac.o renf_elem/.libs/get_str_pretty.o renf_elem/.libs/init.o renf_elem/.libs/print_pretty.o renf_elem/.libs/randtest.o renf_elem/.libs/set_evaluation.o renf_elem/.libs/set_fmpq_poly.o renf_elem/.libs/sgn.o renf_elem/.libs/get_d.o renf_elem/.libs/get_arb.o renf_elem/.libs/relative_condition_number_2exp.o   -L/sage/local/lib -larb -lflint-arb -lflint -lgmp  -fopenmp -g -O2 -Wl,-rpath -Wl,/sage/local/lib   -fopenmp -Wl,-soname -Wl,libeantic.so.0 -o .libs/libeantic.so.0.0.0
/usr/bin/ld: cannot find -larb
collect2: error: ld returned 1 exit status
make[3]: *** [Makefile:1899: libeantic.la] Error 1
}}}


---

Comment by mkoeppe created at 2020-02-25 04:16:16

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-02-25 04:55:07

`nauty`'s `spkg-configure.m4`only looks for the executables, not the library


---

Comment by mkoeppe created at 2020-02-25 17:55:54

Replying to [comment:70 mkoeppe]:
> There are still build failures on various platforms:
> 
> `ubuntu-trusty`:
> {{{
> In file included from ./libnormaliz/list_operations.cpp:31:0,
>                  from libnormaliz/cone_and_control.cpp:31:
> ./libnormaliz/matrix.h: In function 'libnormaliz::Matrix<Number> libnormaliz::LLL_red(const libnormaliz::Matrix<Number>&, libnormaliz::Matrix<Integer>&, libnormaliz::Matrix<Integer>&)':
> ./libnormaliz/matrix.h:647:30: error: call of overloaded 'isnan(__gnu_cxx::__alloc_traits<std::allocator<double> >::value_type&)' is ambiguous
>              if (isnan(M[i][j])) {
>  }}}

Winfried, do you know about this compile error related to `isnan`? This is with the ancient gcc on Ubuntu trusty.


---

Comment by mkoeppe created at 2020-02-25 19:04:30

Replying to [comment:70 mkoeppe]:
> There are still build failures on various platforms:
> `ubuntu-{eoan,focal}-standard`, `debian-sid-standard` etc.:
> {{{
> ... renf_elem/.libs/cmp_fmpq.o renf_elem/.libs/floor_ceil.o renf_elem/.libs/gen.o renf_elem/.libs/get_cfrac.o renf_elem/.libs/get_str_pretty.o renf_elem/.libs/init.o renf_elem/.libs/print_pretty.o renf_elem/.libs/randtest.o renf_elem/.libs/set_evaluation.o renf_elem/.libs/set_fmpq_poly.o renf_elem/.libs/sgn.o renf_elem/.libs/get_d.o renf_elem/.libs/get_arb.o renf_elem/.libs/relative_condition_number_2exp.o   -L/sage/local/lib -larb -lflint-arb -lflint -lgmp  -fopenmp -g -O2 -Wl,-rpath -Wl,/sage/local/lib   -fopenmp -Wl,-soname -Wl,libeantic.so.0 -o .libs/libeantic.so.0.0.0
> /usr/bin/ld: cannot find -larb
> collect2: error: ld returned 1 exit status
> make[3]: *** [Makefile:1899: libeantic.la] Error 1
> }}}

This will be fixed by https://github.com/videlec/e-antic/pull/85


---

Comment by mkoeppe created at 2020-02-25 19:19:40

Replying to [comment:71 mkoeppe]:
> `nauty`'s `spkg-configure.m4`only looks for the executables, not the library
Discussing this issue on #28958.


---

Comment by mkoeppe created at 2020-02-27 21:54:58

nauty header file location varies between distributions, https://github.com/Normaliz/Normaliz/issues/332


---

Comment by git created at 2020-03-18 19:23:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-03-19 00:22:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-19 00:23:17

Rebased on 9.1.beta8


---

Comment by mkoeppe created at 2020-04-18 16:52:05

Update of e-antic to 0.1.5 was done in #29380.


---

Comment by mkoeppe created at 2020-06-11 23:27:23

Update of e-antic to 0.1.6 was done in #29826; preparation for the FLINT upgrade in #29719.


---

Comment by git created at 2020-06-11 23:34:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-11 23:35:22

Rebased, new version, dropped the patch


---

Comment by git created at 2020-06-12 00:44:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-12 04:07:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-12 11:16:43

Error on various systems including `ubuntu-eoan` (https://github.com/mkoeppe/sage/runs/764195861)

```
  [normaliz-3.8.5]   checking whether e-antic headers and library are available... configure: error: e-antic is not available but was requested
  [normaliz-3.8.5]   ********************************************************************************
  [normaliz-3.8.5]   Error configuring normaliz-3.8.5
```

(From a run without the FLINT and e-antic updates)


---

Comment by mkoeppe created at 2020-06-12 11:52:03


```
configure:14201: checking whether e-antic headers and library are available
configure:14219: g++ -std=gnu++11 -std=gnu++14 -o conftest -g -O2      -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib      conftest.cpp  -leanticxx -leantic -larb -lflint >&5
/usr/bin/ld: cannot find -larb
collect2: error: ld returned 1 exit status
```

I guess this happens because on Debian, `arb` is installed as `libflint-arb`.

```
docker run -it docker.pkg.github.com/mkoeppe/sage/sage-docker-ubuntu-eoan-maximal-with-targets-optional:9.1.rc4-66657-ged0d5870bb
```



---

Comment by mkoeppe created at 2020-06-12 11:55:27

Replying to [comment:91 mkoeppe]:
> on Debian, `arb` is installed as `libflint-arb`.

(e-antic has fixed this already, but normaliz needs a fix for it too.)
https://github.com/Normaliz/Normaliz/blob/master/configure.ac#L314


---

Comment by mkoeppe created at 2020-06-14 20:28:10

Replying to [comment:92 mkoeppe]:
> Replying to [comment:91 mkoeppe]:
> > on Debian, `arb` is installed as `libflint-arb`.
> 
> (e-antic has fixed this already, but normaliz needs a fix for it too.)
> https://github.com/Normaliz/Normaliz/blob/master/configure.ac#L314

Winfried, if we could get a similar fix into Normaliz 3.8.6, that would be great


---

Comment by @kliem created at 2020-06-15 06:31:19

Are there any news regarding `figure out libnauty configure`?


---

Comment by mkoeppe created at 2020-06-15 06:47:04

Replying to [comment:94 gh-kliem]:
> Are there any news regarding `figure out libnauty configure`?
What is on this branch might already work, but it's also possible that I have forgotten about some of its subtleties.


---

Comment by Winfried created at 2020-06-15 13:45:13

I would not mind a pull request taking care both of the arb issue as well as the nauty issue.


---

Comment by git created at 2020-06-17 15:10:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-18 21:37:52

Also, why does `build/pkgs/normaliz/dependencies` include `singular`?


---

Comment by mkoeppe created at 2020-06-18 21:45:33

Replying to [comment:99 mkoeppe]:
> Also, why does `build/pkgs/normaliz/dependencies` include `singular`?
This seems to be just a leftover from when `normaliz.lib` was installed into the singular installation.  I'll remove it.


---

Comment by git created at 2020-06-18 21:46:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-23 05:00:20

Replying to [comment:93 mkoeppe]:
> Replying to [comment:92 mkoeppe]:
> > Replying to [comment:91 mkoeppe]:
> > > on Debian, `arb` is installed as `libflint-arb`.
> > 
> > (e-antic has fixed this already, but normaliz needs a fix for it too.)
> > https://github.com/Normaliz/Normaliz/blob/master/configure.ac#L314
> 
> Winfried, if we could get a similar fix into Normaliz 3.8.6, that would be great

This is now https://github.com/Normaliz/Normaliz/pull/339


---

Comment by Winfried created at 2020-06-25 08:26:57

For the sake of clarity: Normaliz 3.8.7 does not exist yet. I am not sure when it will be released and whether PyNormaliz 2.11 will be sufficient for it. 

But: if it would be helpful to have a version 3.8.7 of Normaliz with updated confiure.ac (arb and nauty), I can make it. But I think the nauty issue should be solved for it.


---

Comment by mkoeppe created at 2020-06-25 17:36:52

Yes, I'll look into the nauty business next


---

Comment by git created at 2020-06-27 19:53:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-27 20:14:30

Tests of normaliz`@`master against this branch run at https://github.com/mkoeppe/Normaliz/actions/runs/149952613


---

Comment by mkoeppe created at 2020-06-30 00:41:56

For example for `ubuntu-bionic-standard`:

```
  [normaliz-git]   checking whether nauty headers and library are available... checking nauty/nauty.h usability... no
  [normaliz-git]   checking nauty/nauty.h presence... no
  [normaliz-git]   checking for nauty/nauty.h... no
  [normaliz-git]   configure: error: nauty is not available but was requested
```



---

Comment by mkoeppe created at 2020-06-30 00:43:09

Also on `cygwin-standard` during `make check` of `e-antic`:

```
e_antic-0.1.7] renfxx/test/t-constructor.cpp: In function ‘void check_equal(renf_elem_class&, mp_limb_signed_t)’:
[e_antic-0.1.7] renfxx/test/t-constructor.cpp:29:11: error: ambiguous overload for ‘operator!=’ (operand types are ‘renf_elem_class’ and ‘mp_limb_signed_t’ {aka ‘long long int’})
[e_antic-0.1.7]    29 |     if (a != b)
[e_antic-0.1.7]       |         ~ ^~ ~
[e_antic-0.1.7]       |         |    |
[e_antic-0.1.7]       |         |    mp_limb_signed_t {aka long long int}
[e_antic-0.1.7]       |         renf_elem_class
```

(with g++ version... 9.3.0)


---

Comment by git created at 2020-06-30 02:44:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-30 03:41:18

New tests of normaliz`@`master against this branch run at https://github.com/mkoeppe/Normaliz/actions/runs/152252527


---

Comment by mkoeppe created at 2020-06-30 03:57:41

Another `e-antic` failure while building test programs on Debian:

```
bin/bash ./libtool  --tag=CC   --mode=link gcc -fopenmp -g -O2  -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib  -o poly_extra/test/t-fmpz_poly_scale_0_1_fmpq poly_extra/test/t-fmpz_poly_scale_0_1_fmpq.o libeanticxx.la libeantic.la -larb -lflint -lgmpxx -lgmp -lflint-arb -lflint -lgmp 
libtool: link: gcc -fopenmp -g -O2 -Wl,-rpath-link -Wl,/sage/local/lib -Wl,-rpath -Wl,/sage/local/lib -o poly_extra/test/.libs/t-evaluate poly_extra/test/t-evaluate.o  -L/sage/local/lib ./.libs/libeanticxx.so /sage/local/var/tmp/sage/build/e_antic-0.1.7/src/.libs/libeantic.so ./.libs/libeantic.so -larb -lgmpxx -lflint-arb -lflint -lgmp -fopenmp -Wl,-rpath -Wl,/sage/local/lib
/usr/bin/ld: cannot find -larb
collect2: error: ld returned 1 exit status
```

because it seems I forgot to change these lines of `Makefile.am` in https://github.com/videlec/e-antic/pull/85 :

```
# TODO: we currently build all tests with linked c++ libraries
LDADD = libeanticxx.la libeantic.la -larb -lflint -lgmpxx -lgmp
```



---

Comment by mkoeppe created at 2020-07-03 22:18:33

Replying to [comment:112 mkoeppe]:
> Another `e-antic` failure while building test programs on Debian:
> {{{
> bin/bash ./libtool  --tag=CC   --mode=link gcc -fopenmp -g -O2  -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib  -o poly_extra/test/t-fmpz_poly_scale_0_1_fmpq poly_extra/test/t-fmpz_poly_scale_0_1_fmpq.o libeanticxx.la libeantic.la -larb -lflint -lgmpxx -lgmp -lflint-arb -lflint -lgmp 
> libtool: link: gcc -fopenmp -g -O2 -Wl,-rpath-link -Wl,/sage/local/lib -Wl,-rpath -Wl,/sage/local/lib -o poly_extra/test/.libs/t-evaluate poly_extra/test/t-evaluate.o  -L/sage/local/lib ./.libs/libeanticxx.so /sage/local/var/tmp/sage/build/e_antic-0.1.7/src/.libs/libeantic.so ./.libs/libeantic.so -larb -lgmpxx -lflint-arb -lflint -lgmp -fopenmp -Wl,-rpath -Wl,/sage/local/lib
> /usr/bin/ld: cannot find -larb
> collect2: error: ld returned 1 exit status
> }}}
> because it seems I forgot to change these lines of `Makefile.am` in https://github.com/videlec/e-antic/pull/85 :
> {{{
> # TODO: we currently build all tests with linked c++ libraries
> LDADD = libeanticxx.la libeantic.la -larb -lflint -lgmpxx -lgmp
> }}}
> 

This is now https://github.com/videlec/e-antic/pull/105


---

Comment by git created at 2020-07-07 20:20:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-08 17:29:40

From https://github.com/Normaliz/Normaliz/pull/350#issuecomment-655507396:
On ubuntu-trusty with the `isnan` fix:

```
libtool: link: g++ -std=gnu++11  -fPIC -DPIC -shared -nostdlib /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/4.8/crtbeginS.o  libnormaliz/.libs/nmz_nauty.o libnormaliz/.libs/offload_handler.o libnormaliz/.libs/output.o libnormaliz/.libs/automorph.o libnormaliz/.libs/cone_dual_mode.o libnormaliz/.libs/cone_property.o libnormaliz/.libs/cone.o libnormaliz/.libs/descent.o libnormaliz/.libs/full_cone.o libnormaliz/.libs/general.o libnormaliz/.libs/HilbertSeries.o libnormaliz/.libs/matrix.o libnormaliz/.libs/nmz_integral.o libnormaliz/.libs/project_and_lift.o libnormaliz/.libs/reduction.o libnormaliz/.libs/simplex.o libnormaliz/.libs/sublattice_representation.o libnormaliz/.libs/input.o libnormaliz/.libs/collection.o   -L/sage/local/lib -leanticxx -leantic -larb -lflint -lmpfr -lnauty -lgmpxx -lgmp -L/sage/local/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/4.8 -L/usr/lib/gcc/x86_64-linux-gnu/4.8/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/4.8/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/4.8/../../.. -lstdc++ -lm -lc -lgcc_s /usr/lib/gcc/x86_64-linux-gnu/4.8/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/4.8/../../../x86_64-linux-gnu/crtn.o  -fopenmp -g -O2 -Wl,-rpath-link -Wl,/sage/local/lib -Wl,-rpath -Wl,/sage/local/lib   -fopenmp -Wl,-soname -Wl,libnormaliz.so.3 -o .libs/libnormaliz.so.3.8.6
/usr/bin/ld: /sage/local/lib/libnauty.a(naugraph.o): relocation R_X86_64_32S against `.rodata' can not be used when making a shared object; recompile with -fPIC
/sage/local/lib/libnauty.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
make[3]: *** [libnormaliz.la] Error 1
make[3]: Target `all' not remade because of errors.
```



---

Comment by git created at 2020-07-31 22:28:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-01 01:38:21

Tests run at https://github.com/mkoeppe/sage/actions/runs/190765555


---

Comment by mkoeppe created at 2020-08-01 23:54:19

The problem with `libnauty` on `ubuntu-trusty` still needs to be fixed (https://github.com/mkoeppe/sage/runs/934245080)

pynormaliz build error in `ubuntu-xenial`: 

```
  NormalizModule.cpp:13:40: fatal error: libnormaliz/map_operations.h: No such file or directory
  compilation terminated.
```



---

Comment by git created at 2020-08-02 00:24:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-02 00:25:23

Replying to [comment:123 mkoeppe]:
> pynormaliz build error in `ubuntu-xenial`: 
> {{{
>   NormalizModule.cpp:13:40: fatal error: libnormaliz/map_operations.h: No such file or directory
>   compilation terminated.
> }}}
> 
Actually tested with an old PyNormaliz by mistake


---

Comment by git created at 2020-08-02 05:14:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-02 05:54:52

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-02 05:54:52

Tests at https://github.com/mkoeppe/sage/actions/runs/191867544 (ci-#27952-#29766-#3360).


---

Comment by mkoeppe created at 2020-08-02 12:51:53

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-08-02 12:53:42

nauty needs more work, I'll do that on a separate ticket first.

Back to the previous commit, which "only" has failures on `ubuntu-trusty` and similar.


---

Comment by git created at 2020-08-02 12:54:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2020-08-03 11:05:04

let's spin libnauty off to a separate ticket indeed


---

Comment by mkoeppe created at 2020-08-03 19:16:41

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-08-03 19:16:41

(removing cc: as requested)

Yes, to make progress here, let's just merge the present version, which works well - except that the optional package `normaliz` will fail to build on the ancient platforms `ubuntu-trusty`, `debian-jessie` and the like.

Needs review.


---

Comment by git created at 2020-08-10 03:39:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-10 05:47:45

(push to wrong ticket)


---

Comment by git created at 2020-08-10 05:48:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2020-08-10 18:20:19

I'm happy with the ticket as it is and all tests in `geometry` pass for me.


---

Comment by dimpase created at 2020-08-10 20:33:34

is this a positive review?


---

Comment by @kliem created at 2020-08-10 20:42:43

No, not by itself. One thing missing is that I wrote pretty much the code in `backend_normaliz.py`. So somebody has to review that part.

Along with the fact that no one seems to disagree that the present state is an improvement (although not perfect), this would make a positive review IMO.


---

Comment by mkoeppe created at 2020-08-10 20:54:42

Is this condition tested by a doctest?

```
Matrix(ZZ, nmz_vertices + nmz_rays).rank() == Matrix(ZZ, nmz_rays).rank() + 1
```

Also, how come `nmz_lines` does not have to be used in this condition?


---

Comment by @kliem created at 2020-08-11 05:22:26

Replying to [comment:142 mkoeppe]:
> Is this condition tested by a doctest?
> {{{
> Matrix(ZZ, nmz_vertices + nmz_rays).rank() == Matrix(ZZ, nmz_rays).rank() + 1
> }}}
> Also, how come `nmz_lines` does not have to be used in this condition?

I have done a terrible job in commenting this (it took me a while to figure out, why I did this) and you are right, a doctest might make sense.

The question is simply: Is the far face a facet or not? If it is a facet, we need to add an inequality to the normaliz cone. The lines don't make a difference with regard to that question.


---

Comment by @kliem created at 2020-08-11 06:47:56

Last 10 new commits:


---

Comment by @kliem created at 2020-08-11 07:35:35


```
[normaliz-3.8.7] checking whether e-antic headers and library are available... configure: error: e-antic is not available but was requested
```


Tried it with "my" new patchbot. Doesn't work.

But this installation also had trouble without this ticket. Installed normaliz with no problems and then gave me this error

```
    PyNormaliz_cpp.NormalizInterfaceError: When parsing number_field: coefficient in matrix must be PyFloat, PyInt, PyLong, Sequence, must be able to be converted to a valid gmp input string
```



---

Comment by @kliem created at 2020-08-11 07:43:06

Failed installation of new normaliz


---

Attachment

Yes, there's still a typo in normaliz configure.ac...


---

Comment by mkoeppe created at 2020-08-15 22:29:55

https://github.com/Normaliz/Normaliz/pull/356


---

Comment by mkoeppe created at 2020-08-15 22:30:44

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2020-08-19 21:23:12

Apply the upstream fix as a patch here? Or wait for the next Normaliz release?


---

Comment by mkoeppe created at 2020-08-29 13:20:17

Replying to [comment:144 gh-kliem]:
> Replying to [comment:142 mkoeppe]:
> > Is this condition tested by a doctest?
> > {{{
> > Matrix(ZZ, nmz_vertices + nmz_rays).rank() == Matrix(ZZ, nmz_rays).rank() + 1
> > }}}
> ...
> The question is simply: Is the far face a facet or not? If it is a facet, we need to add an inequality to the normaliz cone. The lines don't make a difference with regard to that question.

Thanks for the explanation and adding the new comments and tests.

This is a positive review for your contributions on this ticket.
----
New commits:


---

Comment by mkoeppe created at 2020-08-29 13:20:59

Replying to [comment:147 gh-kliem]:
> {{{
> [normaliz-3.8.7] checking whether e-antic headers and library are available... configure: error: e-antic is not available but was requested
> }}}
> 
> Tried it with "my" new patchbot. Doesn't work.

Please check again with the new release.


---

Comment by mkoeppe created at 2020-08-29 13:30:03

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-08-30 15:07:36

Replying to [comment:156 mkoeppe]:
> Replying to [comment:147 gh-kliem]:
> > {{{
> > [normaliz-3.8.7] checking whether e-antic headers and library are available... configure: error: e-antic is not available but was requested
> > }}}
> > 
> > Tried it with "my" new patchbot. Doesn't work.
> 
> Please check again with the new release.

Seems to work well. At least all tests in the geometry folder passed.

This is great, because this is an improvement (see above). Before this ticket, `pynormaliz` is not working at all.


---

Comment by @kliem created at 2020-08-30 15:19:22

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-08-30 15:19:22

Replying to [comment:155 mkoeppe]:
> Replying to [comment:144 gh-kliem]:
> > Replying to [comment:142 mkoeppe]:
> > > Is this condition tested by a doctest?
> > > {{{
> > > Matrix(ZZ, nmz_vertices + nmz_rays).rank() == Matrix(ZZ, nmz_rays).rank() + 1
> > > }}}
> > ...
> > The question is simply: Is the far face a facet or not? If it is a facet, we need to add an inequality to the normaliz cone. The lines don't make a difference with regard to that question.
> 
> Thanks for the explanation and adding the new comments and tests.
> 
> This is a positive review for your contributions on this ticket.

Positive review on the other part.


---

Comment by vbraun created at 2020-08-30 23:08:36

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-08-30 23:08:36


```
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 871, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._test_far_facet_condition
Failed example:
    P = Polyhedron(vertices=[[1,0], [0,1]],
                   rays=[[1,1]], backend='normaliz')     # optional - pynormaliz
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 715, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1139, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._test_far_facet_condition[0]>", line 2, in <module>
        rays=[[Integer(1),Integer(1)]], backend='normaliz')     # optional - pynormaliz
      File "sage/misc/lazy_import.pyx", line 353, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3736)
        return self.get_object()(*args, **kwds)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/constructor.py", line 662, in Polyhedron
        return parent(Vrep, Hrep, convert=convert, verbose=verbose)
      File "sage/structure/parent.pyx", line 902, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9364)
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 180, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5154)
        raise
      File "sage/structure/coerce_maps.pyx", line 175, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5042)
        return C._element_constructor(x, *args, **kwds)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/parent.py", line 598, in _element_constructor_
        return self.element_class(self, Vrep, Hrep, **kwds)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 238, in __init__
        Polyhedron_base.__init__(self, parent, Vrep, Hrep, **kwds)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py", line 249, in __init__
        self._init_from_Vrepresentation(vertices, rays, lines, **kwds)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 565, in _init_from_Vrepresentation
        self._init_from_normaliz_data(data, normaliz_field=normaliz_field, verbose=verbose)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 387, in _init_from_normaliz_data
        cone = self._cone_from_normaliz_data(data, verbose)
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 419, in _cone_from_normaliz_data
        PythonModule("PyNormaliz", spkg="pynormaliz").require()
      File "/home/release/Sage/local/lib/python3.7/site-packages/sage/features/__init__.py", line 191, in require
        raise FeatureNotPresentError(self, presence.reason, presence.resolution)
    sage.features.FeatureNotPresentError: PyNormaliz is not available.
    Failed to import `PyNormaliz`.
    To install PyNormaliz you can try to run 'sage -i pynormaliz'.
**********************************************************************
```



---

Comment by git created at 2020-08-30 23:13:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-30 23:14:06

Changing status from needs_work to positive_review.


---

Comment by git created at 2020-08-30 23:19:15

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-08-30 23:19:15

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-08-30 23:19:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-09-06 21:51:51

Resolution: fixed


---

Comment by dimpase created at 2020-10-03 16:18:32

a bug in libnauty spkg-configure

the 1st two args of AC_SEARCH_LIBS are swapped.
