# Issue 15094: Do not try to create embedded number field morphisms for non-embedded number fields

archive/issues_015094.json:
```json
{
    "body": "CC:  jpflori\n\nThe attempt to create an embedded number field morphisms for non-embedded number fields currently fails (and should of course fail).\n\n```\nsage: L.<i> = NumberField(x^2 + 1)\nsage: K = NumberField(L(i/2+3).minpoly(), names=('i0',), embedding=L(i/2+3))\nsage: from sage.rings.number_field import number_field_morphisms\nsage: number_field_morphisms.EmbeddedNumberFieldMorphism(R, self)\nTraceback (most recent call last):\n...\nRuntimeError: maximum recursion depth exceeded in __instancecheck__\n```\n\nHowever, instead of running into an infinite recursion, a quick and simple `ValueError` (or perhaps `TypeError`) should be raised.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15331\n\n",
    "created_at": "2013-10-26T22:28:35Z",
    "labels": [
        "number fields",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Do not try to create embedded number field morphisms for non-embedded number fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15094",
    "user": "@simon-king-jena"
}
```
CC:  jpflori

The attempt to create an embedded number field morphisms for non-embedded number fields currently fails (and should of course fail).

```
sage: L.<i> = NumberField(x^2 + 1)
sage: K = NumberField(L(i/2+3).minpoly(), names=('i0',), embedding=L(i/2+3))
sage: from sage.rings.number_field import number_field_morphisms
sage: number_field_morphisms.EmbeddedNumberFieldMorphism(R, self)
Traceback (most recent call last):
...
RuntimeError: maximum recursion depth exceeded in __instancecheck__
```

However, instead of running into an infinite recursion, a quick and simple `ValueError` (or perhaps `TypeError`) should be raised.

Issue created by migration from https://trac.sagemath.org/ticket/15331





---

archive/issue_comments_193490.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-10-27T01:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193490",
    "user": "@simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_193491.json:
```json
{
    "body": "New commits:",
    "created_at": "2013-10-27T01:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193491",
    "user": "@simon-king-jena"
}
```

New commits:



---

archive/issue_comments_193492.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-12-19T15:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193492",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_193493.json:
```json
{
    "body": "Hi Simon,\n\nI'm trying to review this ticket, but there are a couple of things I don't understand:\n* why can't `EmbeddedNumberFieldMorphism` try using the algebraic closure by itself?\n* even if it really can't, is the giant `except` clause on line\u00a06194 of `number_field.py` necessary?\n* shouldn't\n  {{{\n  #!python\n              Lemb = Lemb.codomain() # number_field_morphisms.pyx:187\n              while Lemb.coerce_embedding() is not None:\n                  Lemb = Lemb.coerce_embedding().codomain()\n                  ambient_field = pushout(Kemb, Lemb)\n  }}}\n  read\n  {{{\n  #!python\n              Lemb = Lemb.codomain()\n              while Lemb.coerce_embedding() is not None:\n                  Lemb = Lemb.coerce_embedding().codomain()\n              ambient_field = pushout(Kemb, Lemb)\n  }}}\n  ?\n\nSorry if these are stupid questions, I'm still trying to learn how this all works!\n\nMy attempt at simplifying the code based on these remarks is at `u/mmezzarobba/embedded_NF_morphisms`.",
    "created_at": "2013-12-19T15:24:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193493",
    "user": "@mezzarobba"
}
```

Hi Simon,

I'm trying to review this ticket, but there are a couple of things I don't understand:
* why can't `EmbeddedNumberFieldMorphism` try using the algebraic closure by itself?
* even if it really can't, is the giant `except` clause on line 6194 of `number_field.py` necessary?
* shouldn't
  {{{
  #!python
              Lemb = Lemb.codomain() # number_field_morphisms.pyx:187
              while Lemb.coerce_embedding() is not None:
                  Lemb = Lemb.coerce_embedding().codomain()
                  ambient_field = pushout(Kemb, Lemb)
  }}}
  read
  {{{
  #!python
              Lemb = Lemb.codomain()
              while Lemb.coerce_embedding() is not None:
                  Lemb = Lemb.coerce_embedding().codomain()
              ambient_field = pushout(Kemb, Lemb)
  }}}
  ?

Sorry if these are stupid questions, I'm still trying to learn how this all works!

My attempt at simplifying the code based on these remarks is at `u/mmezzarobba/embedded_NF_morphisms`.



---

archive/issue_comments_193494.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> Hi Simon,\n> \n> I'm trying to review this ticket, but there are a couple of things I don't understand:\n> * why can't `EmbeddedNumberFieldMorphism` try using the algebraic closure by itself?\n> * even if it really can't, is the giant `except` clause on line\u00a06194 of `number_field.py` necessary?\n> * shouldn't\n>   {{{\n>   #!python\n>               Lemb = Lemb.codomain() # number_field_morphisms.pyx:187\n>               while Lemb.coerce_embedding() is not None:\n>                   Lemb = Lemb.coerce_embedding().codomain()\n>                   ambient_field = pushout(Kemb, Lemb)\n>   }}}\n>   read\n>   {{{\n>   #!python\n>               Lemb = Lemb.codomain()\n>               while Lemb.coerce_embedding() is not None:\n>                   Lemb = Lemb.coerce_embedding().codomain()\n>               ambient_field = pushout(Kemb, Lemb)\n>   }}}\n>   ?\n> \n> Sorry if these are stupid questions, I'm still trying to learn how this all works!\n> \n> My attempt at simplifying the code based on these remarks is at `u/mmezzarobba/embedded_NF_morphisms`.\n> \nAny remark on this Simon?\n\nIf you're too busy, I'll just have a look for myself and try to take some action to get this merged.",
    "created_at": "2014-02-27T13:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193494",
    "user": "jpflori"
}
```

Replying to [comment:3 mmezzarobba]:
> Hi Simon,
> 
> I'm trying to review this ticket, but there are a couple of things I don't understand:
> * why can't `EmbeddedNumberFieldMorphism` try using the algebraic closure by itself?
> * even if it really can't, is the giant `except` clause on line 6194 of `number_field.py` necessary?
> * shouldn't
>   {{{
>   #!python
>               Lemb = Lemb.codomain() # number_field_morphisms.pyx:187
>               while Lemb.coerce_embedding() is not None:
>                   Lemb = Lemb.coerce_embedding().codomain()
>                   ambient_field = pushout(Kemb, Lemb)
>   }}}
>   read
>   {{{
>   #!python
>               Lemb = Lemb.codomain()
>               while Lemb.coerce_embedding() is not None:
>                   Lemb = Lemb.coerce_embedding().codomain()
>               ambient_field = pushout(Kemb, Lemb)
>   }}}
>   ?
> 
> Sorry if these are stupid questions, I'm still trying to learn how this all works!
> 
> My attempt at simplifying the code based on these remarks is at `u/mmezzarobba/embedded_NF_morphisms`.
> 
Any remark on this Simon?

If you're too busy, I'll just have a look for myself and try to take some action to get this merged.



---

archive/issue_comments_193495.json:
```json
{
    "body": "Hi Jean-Pierre and Marc,\n\nReplying to [comment:6 jpflori]:\n> Replying to [comment:3 mmezzarobba]:\n> > Hi Simon,\n> > \n> > I'm trying to review this ticket, but there are a couple of things I don't understand:\n> > * why can't `EmbeddedNumberFieldMorphism` try using the algebraic closure by itself?\n> > * even if it really can't, is the giant `except` clause on line\u00a06194 of `number_field.py` necessary?\n\nSorry, I don't recall, and at the moment I am too much occupied with other things.\n\n> > * shouldn't\n> >   {{{\n> >   #!python\n> >               Lemb = Lemb.codomain() # number_field_morphisms.pyx:187\n> >               while Lemb.coerce_embedding() is not None:\n> >                   Lemb = Lemb.coerce_embedding().codomain()\n> >                   ambient_field = pushout(Kemb, Lemb)\n> >   }}}\n> >   read\n> >   {{{\n> >   #!python\n> >               Lemb = Lemb.codomain()\n> >               while Lemb.coerce_embedding() is not None:\n> >                   Lemb = Lemb.coerce_embedding().codomain()\n> >               ambient_field = pushout(Kemb, Lemb)\n> >   }}}\n\nYes, unless I wanted to see if the pushout exists in each step (catching the error if it does not exist).\n\n> > Sorry if these are stupid questions, I'm still trying to learn how this all works!\n\nSo do I (now) ;-)\n \n> > My attempt at simplifying the code based on these remarks is at `u/mmezzarobba/embedded_NF_morphisms`.\n> > \n> Any remark on this Simon?\n> \n> If you're too busy,\n\nSorry, I am.\n\nBest regards,\n\nSimon",
    "created_at": "2014-02-27T14:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193495",
    "user": "@simon-king-jena"
}
```

Hi Jean-Pierre and Marc,

Replying to [comment:6 jpflori]:
> Replying to [comment:3 mmezzarobba]:
> > Hi Simon,
> > 
> > I'm trying to review this ticket, but there are a couple of things I don't understand:
> > * why can't `EmbeddedNumberFieldMorphism` try using the algebraic closure by itself?
> > * even if it really can't, is the giant `except` clause on line 6194 of `number_field.py` necessary?

Sorry, I don't recall, and at the moment I am too much occupied with other things.

> > * shouldn't
> >   {{{
> >   #!python
> >               Lemb = Lemb.codomain() # number_field_morphisms.pyx:187
> >               while Lemb.coerce_embedding() is not None:
> >                   Lemb = Lemb.coerce_embedding().codomain()
> >                   ambient_field = pushout(Kemb, Lemb)
> >   }}}
> >   read
> >   {{{
> >   #!python
> >               Lemb = Lemb.codomain()
> >               while Lemb.coerce_embedding() is not None:
> >                   Lemb = Lemb.coerce_embedding().codomain()
> >               ambient_field = pushout(Kemb, Lemb)
> >   }}}

Yes, unless I wanted to see if the pushout exists in each step (catching the error if it does not exist).

> > Sorry if these are stupid questions, I'm still trying to learn how this all works!

So do I (now) ;-)
 
> > My attempt at simplifying the code based on these remarks is at `u/mmezzarobba/embedded_NF_morphisms`.
> > 
> Any remark on this Simon?
> 
> If you're too busy,

Sorry, I am.

Best regards,

Simon



---

archive/issue_comments_193496.json:
```json
{
    "body": "I'm ok with Marc changes.\n\nMy only concern is that it might be the case that previously catched errors are not anymore, only ValueError are.\nNot sure how it could break the coercion system as before such errors would just lead to returning nothing and now errors might be raised.",
    "created_at": "2014-03-05T21:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193496",
    "user": "jpflori"
}
```

I'm ok with Marc changes.

My only concern is that it might be the case that previously catched errors are not anymore, only ValueError are.
Not sure how it could break the coercion system as before such errors would just lead to returning nothing and now errors might be raised.



---

archive/issue_comments_193497.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2014-03-05T22:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193497",
    "user": "jpflori"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_193498.json:
```json
{
    "body": "I've just added some doc about which ambient field is tried by default.\n\nIf nobody feels concerned as I do about the uncatched errors (maybe the coercion framework already deals with them in a correct way, it just too late to try to remember about that), the let's get this merged.\n----\nNew commits:",
    "created_at": "2014-03-05T22:05:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193498",
    "user": "jpflori"
}
```

I've just added some doc about which ambient field is tried by default.

If nobody feels concerned as I do about the uncatched errors (maybe the coercion framework already deals with them in a correct way, it just too late to try to remember about that), the let's get this merged.
----
New commits:



---

archive/issue_comments_193499.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-05T22:09:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193499",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_193500.json:
```json
{
    "body": "Replying to [comment:9 jpflori]:\n> I've just added some doc about which ambient field is tried by default.\n\nHmm, `CDF` is actually tried *before* the algebraic closure of the pushout, contrary to what the description you wrote suggests. (That's what Simon's patch was doing, and I tried to leave the results of successful calls unchanged in mine.) I think we should either swap the corresponding items in the docstring, or try the algebraic closure first if this order makes more sense.\n\n> If nobody feels concerned as I do about the uncatched errors (maybe the coercion framework already deals with them in a correct way, it just too late to try to remember about that), the let's get this merged.\n\nSince no one seems to know in what scenarios these except clauses are supposed to be used (and the patches + tickets they come from do not make it clear to me), I thought we could remove them for now and add them back later, with tests triggering them, if necessary. But please feel free to change back the code to catch more exceptions if you disagree.",
    "created_at": "2014-03-07T09:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193500",
    "user": "@mezzarobba"
}
```

Replying to [comment:9 jpflori]:
> I've just added some doc about which ambient field is tried by default.

Hmm, `CDF` is actually tried *before* the algebraic closure of the pushout, contrary to what the description you wrote suggests. (That's what Simon's patch was doing, and I tried to leave the results of successful calls unchanged in mine.) I think we should either swap the corresponding items in the docstring, or try the algebraic closure first if this order makes more sense.

> If nobody feels concerned as I do about the uncatched errors (maybe the coercion framework already deals with them in a correct way, it just too late to try to remember about that), the let's get this merged.

Since no one seems to know in what scenarios these except clauses are supposed to be used (and the patches + tickets they come from do not make it clear to me), I thought we could remove them for now and add them back later, with tests triggering them, if necessary. But please feel free to change back the code to catch more exceptions if you disagree.



---

archive/issue_comments_193501.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-03-07T09:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193501",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_193502.json:
```json
{
    "body": "Replying to [comment:11 mmezzarobba]:\n> Replying to [comment:9 jpflori]:\n> > I've just added some doc about which ambient field is tried by default.\n> \n> Hmm, `CDF` is actually tried *before* the algebraic closure of the pushout, contrary to what the description you wrote suggests. (That's what Simon's patch was doing, and I tried to leave the results of successful calls unchanged in mine.) I think we should either swap the corresponding items in the docstring, or try the algebraic closure first if this order makes more sense.\n> \nOops, in fact, I took back the description with what I built on top of the original Simon branch, and there I tried CDF last.\nIt seemed to make more sense to me to test it after the algebraic closure which a priori is smaller.\nSo I'd be in favor of changing the current behavior and not the doc.\n\n> > If nobody feels concerned as I do about the uncatched errors (maybe the coercion framework already deals with them in a correct way, it just too late to try to remember about that), the let's get this merged.\n> \n> Since no one seems to know in what scenarios these except clauses are supposed to be used (and the patches + tickets they come from do not make it clear to me), I thought we could remove them for now and add them back later, with tests triggering them, if necessary. But please feel free to change back the code to catch more exceptions if you disagree.\nI agree with that plan.",
    "created_at": "2014-03-07T09:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193502",
    "user": "jpflori"
}
```

Replying to [comment:11 mmezzarobba]:
> Replying to [comment:9 jpflori]:
> > I've just added some doc about which ambient field is tried by default.
> 
> Hmm, `CDF` is actually tried *before* the algebraic closure of the pushout, contrary to what the description you wrote suggests. (That's what Simon's patch was doing, and I tried to leave the results of successful calls unchanged in mine.) I think we should either swap the corresponding items in the docstring, or try the algebraic closure first if this order makes more sense.
> 
Oops, in fact, I took back the description with what I built on top of the original Simon branch, and there I tried CDF last.
It seemed to make more sense to me to test it after the algebraic closure which a priori is smaller.
So I'd be in favor of changing the current behavior and not the doc.

> > If nobody feels concerned as I do about the uncatched errors (maybe the coercion framework already deals with them in a correct way, it just too late to try to remember about that), the let's get this merged.
> 
> Since no one seems to know in what scenarios these except clauses are supposed to be used (and the patches + tickets they come from do not make it clear to me), I thought we could remove them for now and add them back later, with tests triggering them, if necessary. But please feel free to change back the code to catch more exceptions if you disagree.
I agree with that plan.



---

archive/issue_comments_193503.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-12T15:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193503",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_193504.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-12T16:04:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193504",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_193505.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-03-12T16:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193505",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_193506.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-03-12T17:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193506",
    "user": "@mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_193507.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-03-21T17:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15094",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15094#issuecomment-193507",
    "user": "@vbraun"
}
```

Resolution: fixed
