# Issue 16731: Random failure in gaussian sampler

Issue created by migration from https://trac.sagemath.org/ticket/16968

Original creator: vbraun

Original creation time: 2014-09-11 15:23:42

CC:  malb saraedum

Reported on sage-devel with sage-6.4.beta3:

```
sage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx 
********************************************************************** 
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", 
line 262, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianDistributionIntegerSampler.__init__ 
Failed example: 
    min(l), max(l), abs(mean(l)-2.5) < 0.01 
Expected: 
    (-2, 7, True) 
Got: 
    (-2, 6, True) 
```

This happened also at http://trac.sagemath.org/ticket/15915#comment:54


---

Comment by vbraun created at 2014-09-11 15:23:52

Changing keywords from "" to "random_fail".


---

Comment by malb created at 2014-09-11 21:53:49

Changing status from new to needs_review.


---

Comment by malb created at 2014-09-11 21:53:49

The doctest is too strict (given the non-deterministic behaviour), so I made it more lenient.
----
New commits:


---

Comment by vbraun created at 2014-09-11 23:06:35

I guess the failure probability is a reasonably easy computation? Did you do it?


---

Comment by fbissey created at 2014-09-12 03:14:23

While we are at follow up from that ticket. SAGE_ROOT doesn't belong to module_list.py anymore. If you need it you are doing something wrong.

```
--- module_list.py.orig	2014-09-12 15:03:19.370250091 +1200
+++ module_list.py	2014-09-12 15:02:13.930114901 +1200
@@ -1998,10 +1998,9 @@
 
     Extension('sage.stats.distributions.discrete_gaussian_integer',
               sources = ['sage/stats/distributions/discrete_gaussian_integer.pyx', 'sage/stats/distributions/dgs_gauss_mp.c', 'sage/stats/distributions/dgs_gauss_dp.c', 'sage/stats/distributions/dgs_bern.c'],
-              depends = ['sage/stats/distributions/dgs_gauss.h', 'sage/stats/distributions/dgs_bern.h'],
+              depends = ['sage/stats/distributions/dgs_misc.h', 'sage/stats/distributions/dgs_gauss.h', 'sage/stats/distributions/dgs_bern.h'],
               libraries = ['gmp', 'mpfr'],
               extra_compile_args=["-std=c99", "-D_XOPEN_SOURCE=600"],
-              include_dirs = [SAGE_ROOT +"/src/sage/stats/distributions"],
           ),
 
     ################################
```

I can get a different ticket, I am just venting my frustration a bit at spending my time removing them.


---

Comment by git created at 2014-09-12 09:33:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-09-12 09:43:23

Replying to [comment:5 fbissey]:
> While we are at follow up from that ticket. SAGE_ROOT doesn't belong to module_list.py anymore. If you need it you are doing something wrong.
> {{{
> --- module_list.py.orig	2014-09-12 15:03:19.370250091 +1200
> +++ module_list.py	2014-09-12 15:02:13.930114901 +1200
> `@``@` -1998,10 +1998,9 `@``@`
>  
>      Extension('sage.stats.distributions.discrete_gaussian_integer',
>                sources = ['sage/stats/distributions/discrete_gaussian_integer.pyx', 'sage/stats/distributions/dgs_gauss_mp.c', 'sage/stats/distributions/dgs_gauss_dp.c', 'sage/stats/distributions/dgs_bern.c'],
> -              depends = ['sage/stats/distributions/dgs_gauss.h', 'sage/stats/distributions/dgs_bern.h'],
> +              depends = ['sage/stats/distributions/dgs_misc.h', 'sage/stats/distributions/dgs_gauss.h', 'sage/stats/distributions/dgs_bern.h'],
>                libraries = ['gmp', 'mpfr'],
>                extra_compile_args=["-std=c99", "-D_XOPEN_SOURCE=600"],
> -              include_dirs = [SAGE_ROOT +"/src/sage/stats/distributions"],
>            ),
>  
>      ################################
> }}}
> I can get a different ticket, I am just venting my frustration a bit at spending my time removing them.

Understood. This is now #16975


---

Comment by vbraun created at 2014-09-12 10:41:53

I also got the following from the buildbot right now:

```
sage -t --long src/sage/stats/distributions/discrete_gaussian_integer.pyx
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 262, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianDistributionIntegerSampler.__init__
Failed example:
    min(l), max(l), abs(mean(l)-2.5) < 0.01
Expected:
    (-2, 7, True)
Got:
    (-1, 7, True)
*********************************************************************
```

This is covered by the current branch, just putting it out for the record.


---

Comment by vbraun created at 2014-09-19 17:47:55

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2014-09-19 17:47:55

I got a new one:

```
sage -t --long --warn-long 61.7 src/sage/stats/distributions/discrete_gaussian_integer.pyx
**********************************************************************
File "src/sage/stats/distributions/discrete_gaussian_integer.pyx", line 256, in sage.stats.distributions.discrete_gaussian_integer.DiscreteGaussianDistributionIntegerSampler.__init__
Failed example:
    min(l)==2-2*1.0, max(l)==2+2*1.0, mean(l).n()
Expected:
    (True, True, 2.45...)
Got:
    (True, True, 2.46120071411133)
**********************************************************************
```

This is not fixed by the current branch...


---

Comment by git created at 2014-09-23 14:20:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-09-23 14:21:01

Changing status from needs_work to needs_review.


---

Comment by malb created at 2014-09-23 14:21:01

I committed a fix for this issue.


---

Comment by vbraun created at 2014-09-23 14:39:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-25 12:05:28

Resolution: fixed
