# Issue 10387: preparser does not correctly identify encoding lines

Issue created by migration from Trac.

Original creator: ddrake

Original creation time: 2010-12-07 23:45:56

Assignee: jason

Keywords: prepaser encoding

[PEP 263](http://www.python.org/dev/peps/pep-0263/) says that the encoding line for a Python file should match a certain regular expression in the first or second line, but the preparser seems to be looking for the precise string "# -*- coding: utf-8 -*-".

We should follow PEP 263 precisely. In particular, this will make it easy for SageTeX users to specify an encoding; because of TeX weirdness that I don't entirely understand, it is easiest to write the line "## -*- coding: utf-8 -*-" to the generated script.


---

Attachment


---

Comment by ddrake created at 2010-12-08 03:49:01

Changing status from new to needs_review.


---

Comment by ddrake created at 2010-12-08 03:51:07

Changing assignee from jason to ddrake.


---

Comment by ddrake created at 2010-12-08 03:51:07

Note that we aren't following PEP 263, since we default to UTF-8 and not ASCII. The patch now allows the encoding declaration to be in the first or second line, and makes the `handle_encoding_declaration()` much simpler and easier to understand.


---

Comment by ddrake created at 2010-12-08 04:12:21

Hmm, this doesn't fix the SageTeX issue: it looks like the preparser is still looking for "# -*- coding: utf-8 -*-". I'll work on an updated patch.


---

Comment by ddrake created at 2010-12-08 04:12:21

Changing status from needs_review to needs_work.


---

Comment by ddrake created at 2010-12-08 04:50:00

apply to scripts repo


---

Attachment

Apply both patches, although I suspect only the second is necessary to fix the immediate SageTeX problem. It seems like unnecessary code duplication to have two places where we look through a string and extract an encoding declaration, but at least both bits of code work properly now.


---

Comment by ddrake created at 2010-12-08 04:55:01

Changing status from needs_work to needs_review.


---

Comment by ddrake created at 2010-12-08 04:55:16

Changing keywords from "prepaser encoding" to "preparser encoding".


---

Comment by jdemeyer created at 2010-12-16 15:51:12

Concerning the default of UTF-8 instead of ASCII: that's perfectly fine since any valid ASCII text is also valid UTF-8.  If we default to UTF-8, there is also no reason to look for a UTF-8 byte order mark (BOM).


---

Comment by vbraun created at 2011-02-03 11:36:28

Irregardless of SageTeX, we should hand through the encoding. This patch works for me. Applies cleanly on Sage-4.6.2.alpha3.


---

Comment by vbraun created at 2011-02-03 11:36:28

Changing status from needs_review to positive_review.


---

Comment by maxim created at 2011-02-04 18:42:45

I confirmed that by installing the second patch (trac_10440_scripts_repo.patch), I can now process code comments containing utf-8 characters (â ô à é...) with sagetex correctly.

Thank you for looking into this, Dr. Drake!


---

Comment by jdemeyer created at 2011-02-07 08:14:15

Resolution: fixed
