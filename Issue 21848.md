# Issue 21848: Don't include gslcblas in gsl.pc

Issue created by migration from Trac.

Original creator: fbissey

Original creation time: 2016-12-21 01:41:18

CC:  strogdon mjo

We should patch the default gsl.pc so it doesn't include `gslcblas`. Two main reasons:
 * It is distro friendly. We have to remove it from the output of gsl.pc is `module_list.py`. In distro (Gentoo for example) can ship gsl.pc without gslcblas. The current setup will fail in if gslcblas cannot be removed.
 * If someone really want to use gslcblas (possibly an external one) the current setup may strip it completely. 


---

Comment by fbissey created at 2016-12-21 01:46:28

Not sure that will be included in 7.5. but it is a consequence of multiple things I have authored in the current release cycle including #20646 and #21625. It probably should have gone as QA in #20646 really and then I would done things slightly differently in #21625.
----
New commits:


---

Comment by fbissey created at 2016-12-21 03:33:58

Changing status from new to needs_review.


---

Comment by strogdon created at 2016-12-22 18:22:47

What should be the correct output of pkg-config? Here, with this branch


```
pkg-config --libs gsl
-L/64bitdev/storage/sage-git_develop/sage/local/lib -lgsl -lm -lcblas -lm
```


So it looks like its using `atlas` for `cblas`? I thought `openblas` was being used. Or is there a way to disable `atlas`?


---

Comment by fbissey created at 2016-12-22 19:06:13

This ticket shouldn't make a difference in the cblas used. Indeed it looks like ATLAS, and the one I recently changed at that. Is this a building from scratch or an incremental build from an install that already had ATLAS? Do you have libopenblas* in local/lib?

In any case that's a valid output if ATLAS was selected, check local/lib/pkgconfig/cblas.pc to confirm that's the cblas you have installed.


---

Comment by strogdon created at 2016-12-22 19:29:47

Replying to [comment:4 fbissey]:
> This ticket shouldn't make a difference in the cblas used. Indeed it looks like ATLAS, and the one I recently changed at that. Is this a building from scratch or an incremental build from an install that already had ATLAS? Do you have libopenblas* in local/lib?
> 
This was an incremental build. I do have `libopenblas` in /local/lib.
> In any case that's a valid output if ATLAS was selected, check local/lib/pkgconfig/cblas.pc to confirm that's the cblas you have installed.
Yes, `cblas.pc` is from ATLAS. So, do I have to build from scratch to get rid of ATLAS? This is a bit off-topic. This ticket looks OK and I believe to be necessary.


---

Comment by fbissey created at 2016-12-22 19:38:21


```
./configure --blas=openblas
make
```

I am afraid that will re-build all blas dependencies - or at least it should, if it doesn't that's a new ticket. `configure` will be re-run by `make` but with the configuration options from the previous run of configure (before running make).


---

Comment by strogdon created at 2016-12-22 19:50:34

Replying to [comment:6 fbissey]:
> 
> {{{
> ./configure --blas=openblas
> make
> }}}
> I am afraid that will re-build all blas dependencies - or at least it should, if it doesn't that's a new ticket. `configure` will be re-run by `make` but with the configuration options from the previous run of configure (before running make).
When I first noticed the ATLAS business that's what I tried, but I'm still left with cblas from atlas.


---

Comment by strogdon created at 2016-12-22 19:52:21

Actually, I tried

```
./configure --with-blas=openblas
make
```



---

Comment by strogdon created at 2016-12-22 19:57:32

Should this

```
# GNU Scientific Library
# Note we remove the built-in gslcblas
# The above cblas should already be in the list thanks to #20646
```

be modified in `src/module_list.py`?


---

Comment by fbissey created at 2016-12-22 21:46:09

Replying to [comment:9 strogdon]:
> Should this
> {{{
> # GNU Scientific Library
> # Note we remove the built-in gslcblas
> # The above cblas should already be in the list thanks to #20646
> }}}
> be modified in `src/module_list.py`?

Indeed I should make my comments appropriate.


---

Comment by strogdon created at 2016-12-22 22:34:25

Interesting, even after

```
./configure --with-blas=openblas
make
```

I still have atlas generated `.pc` files

```
grep ATLAS local/lib/pkgconfig/*

local/lib/pkgconfig/blas.pc:Description: blas for sage, set up by the ATLAS spkg.
local/lib/pkgconfig/cblas.pc:Description: cblas for sage, set up by the ATLAS spkg.
local/lib/pkgconfig/lapack.pc:Description: lapack for sage, set up by the ATLAS spkg.
```


And for example

```
pkg-config --libs fflas-ffpack
-L/64bitdev/storage/sage-git_develop/sage/local/lib -lfflas -lffpack -lcblas -lgivaro -lgmpxx -lgmp
```

which links to atlas cblas. I'm thinking things are not right or else I'm doing something really stupid.


---

Comment by fbissey created at 2016-12-22 22:38:12

Are the .pc files changed after `./sage -f openblas`?


---

Comment by strogdon created at 2016-12-22 22:51:17

Replying to [comment:12 fbissey]:
> Are the .pc files changed after `./sage -f openblas`?
Yes. So what's up? I had `openblas` installed.


---

Comment by fbissey created at 2016-12-22 23:52:03

I don't know. It looks like you may have installed ATLAS after openblas somehow. And now that the .pc file show openblas, all the blas dependencies have to be rebuilt - including gsl.


---

Comment by strogdon created at 2016-12-23 02:17:12

I'm wondering if since `atlas` is installed because it was used before `openblas`, then a newer atlas package will trigger a rebuild of atlas and thus produce the problem. If so, then maybe `atlas` and `openblas` should not be present together.


---

Comment by strogdon created at 2016-12-23 02:23:48

Changing status from needs_review to needs_work.


---

Comment by strogdon created at 2016-12-23 02:23:48

Things are good now

```
pkg-config --libs gsl
-L/64bitdev/storage/sage-git_develop/sage/local/lib -lgsl -lm -lopenblas -lm
```

Changing action for the updated comments.


---

Comment by strogdon created at 2016-12-23 03:01:14

When you test sage what do you see. Here

```
Using --optional=atlas,mpir,python2,sage
Doctesting entire Sage library.
```

Is the presence of `atlas` a problem if `openblas` is to be used? The test command was

```
./sage -tp 5 --all --long 2>&1 | tee -a ../test.log-7.4.rc0
```



---

Comment by fbissey created at 2016-12-23 06:38:07

Replying to [comment:17 strogdon]:
> When you test sage what do you see. Here
> {{{
> Using --optional=atlas,mpir,python2,sage
> Doctesting entire Sage library.
> }}}
> Is the presence of `atlas` a problem if `openblas` is to be used? The test command was
> {{{
> ./sage -tp 5 --all --long 2>&1 | tee -a ../test.log-7.4.rc0
> }}}

Not a real problem. It reflects the fact that atlas has been installed. The doctesting framework (a part removed from sage-on-gentoo) look at all the optionally installed packages and check they are up to date. This is enabled with `--all` (again not in sage-on-gentoo). In any case there are no atlas specific test in the sage library.


---

Comment by git created at 2016-12-23 09:38:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-12-23 09:38:40

Finally fixed.


---

Comment by fbissey created at 2016-12-23 09:38:40

Changing status from needs_work to needs_review.


---

Comment by strogdon created at 2016-12-23 15:39:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-01-21 16:34:56

Resolution: fixed
