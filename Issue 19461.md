# Issue 19461: install_name_tool: changing install names or rpaths can't be redone (libsigular)

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-12-13 10:48:38

CC:  jhpalmieri fbissey

Reported at https://groups.google.com/d/msg/sage-release/7TvrWAG7Rr0/taq2Yd7bAwAJ

```
error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/install_name_tool: changing install names or rpaths can't be redone for: /Users/palmieri/Desktop/Sage_stuff/sage_builds/clean/sage-6.10.rc0/local/lib/libsingular.dylib (for architecture x86_64) because larger updated load commands do not fit (the program must be relinked, and you may need to use -headerpad or -headerpad_max_install_names)
```



---

Comment by leif created at 2015-12-13 11:55:02

I'm actually surprised we didn't get such errors earlier...  (Ok, it was one of the reasons not to use `chrpath` and the like years ago.)


---

Comment by vbraun created at 2015-12-13 12:12:31

Off topic, but patchelf can grow rpaths just fine.


---

Comment by leif created at 2015-12-13 13:00:41

`patchmacho`? ;-)




May the error be a fallout of #18892?


---

Comment by leif created at 2015-12-13 13:04:50

Replying to [comment:4 leif]:
> May the error be a fallout of #18892?

I mean does it make sense to unconditionally replace `LD` by `CXX` if there's a problem on some 32-bit Ubuntu only?  (Otherwise `libtool` is used on Darwin.)


---

Comment by vbraun created at 2015-12-13 17:30:36

its not pretty but works:

```
osx:Sage vbraun$ grep install_name logs/pkgs/singular-3.1.7p1.p0.log
 g++  -dynamiclib -twolevel_namespace -weak_reference_mismatches weak -undefined dynamic_lookup -install_name /Users/vbraun/Sage/local/lib/libsingular.dylib -L/Users/vbraun/Sage/local/lib -lflint -lmpfr -lmpir -single_module -o libsingular.dylib \
```

----
New commits:


---

Comment by vbraun created at 2015-12-13 17:30:55

Changing status from new to needs_review.


---

Comment by leif created at 2015-12-13 18:06:47

Replying to [comment:7 vbraun]:
> its not pretty

Indeed.  I'd rather not use `CXX` for linking _on Darwin_ instead, but if we really switch to Singular 4.x *soon* anyway...




After all, I think #18892 caused this trouble, and now you're fixing a broken hack by adding another hack.  And the following does no longer apply (since #18892):

```sh
if [ "$UNAME" = "Darwin" ]; then
    # Singular needs $LD set to "libtool", not "ld" on Darwin.
    # If we unset it, Singular will figure it out correctly.
    unset LD
fi
```



---

Comment by vbraun created at 2015-12-13 18:33:53

I encourage you to improve how Singular is being built, but please on a separate ticket.


---

Comment by fbissey created at 2015-12-13 20:03:07

Looks good to me, although I would have added `-headerpad_max_install_name` in there. It is very hard to solve #18892 by doing anything else but using `CXX` as the linker - it is a valid from many 32bits recent install on any distro. It was first reported to me on Gentoo a few weeks before it was reported here. 

In a lot of case you don't want to use the linker directly and let the compiler do the magic for you. 

Furthermore, if you are going to add `LDFLAGS=-Wl,-rpath=.....` globally you don't want to use `ld` as your linker anywhere. `-Wl,` is a compiler instruction to pass its argument to `ld`. Anywhere `ld` is used directly you'll have to strip `-Wl,` from `LDFLAGS`.


---

Comment by fbissey created at 2015-12-13 20:03:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-12-13 20:04:41

There is no need to pad the header, we just set it on compilation to the correct value


---

Comment by fbissey created at 2015-12-13 20:22:46

Padding is useful if you are going to change things afterwards (for example when moving your install) because you cannot set it to a shorter path otherwise. But if your stuff for relocating sage on OS X doesn't rely on that, then it's ok.


---

Comment by leif created at 2015-12-13 20:40:58

Replying to [comment:11 fbissey]:
> It is very hard to solve #18892 by doing anything else but using `CXX` as the linker - it is a valid from many 32bits recent install on any distro. It was first reported to me on Gentoo a few weeks before it was reported here.

Well, on Linux.

> In a lot of case you don't want to use the linker directly and let the compiler do the magic for you.

Sure, but in this case (previously) libtool did the magic on Darwin, so if you change that, upstream's assumptions do no longer hold and it's not too surprising that such a change broke things elsewhere.

Hopefully we won't have to maintain Singular 3.x much longer.




> Furthermore, if you are going to add `LDFLAGS=-Wl,-rpath=.....` globally you don't want to use `ld` as your linker anywhere. `-Wl,` is a compiler instruction to pass its argument to `ld`. Anywhere `ld` is used directly you'll have to strip `-Wl,` from `LDFLAGS`.

... which would probably be easier with `-Xlinker` (by just dropping it), since you wouldn't have to replace commas by spaces... ;-)

You can by the way also set `LD_RUN_PATH`, which is used by the linker if no `-rpath` option is given.


---

Comment by fbissey created at 2015-12-13 20:54:02

`LD_RUN_PATH` is great with gnu `ld`, I don't know if OS X `ld` takes it as well. One major problem with `LD_RUN_PATH` is that it is not additive to any extra `-rpath` option you pass to `ld`. If any `-Wl,-rpath` or `-rpath` is set, `LD_RUN_PATH` is just discarded. 

Case in point: in hashdist Ondrej asked a few months ago if it was possible to enforce a `rpath`, I provided a patch for `gcc` that change the spec for linking to add `-Wl-rpath=...`, this is added each time `gcc`, `g++` or `gfortran` is used linking and  `LD_RUN_PATH` will never be used if you link with that compiler. This is also done by IBM in their "advance toolchain" for power hardware, no working `LD_RUN_PATH` for you there either.


---

Comment by vbraun created at 2015-12-13 20:59:56

I don't need padding for relocating Sage. There are also other hardcoded paths, so padding in rpaths alone wouldn't be enough.


---

Comment by vbraun created at 2015-12-14 23:52:10

Resolution: fixed
