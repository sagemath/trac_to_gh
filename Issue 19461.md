# Issue 19461: install_name_tool: changing install names or rpaths can't be redone (libsigular)

archive/issues_019461.json:
```json
{
    "body": "CC:  jhpalmieri fbissey\n\nReported at https://groups.google.com/d/msg/sage-release/7TvrWAG7Rr0/taq2Yd7bAwAJ\n\n```\nerror: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/install_name_tool: changing install names or rpaths can't be redone for: /Users/palmieri/Desktop/Sage_stuff/sage_builds/clean/sage-6.10.rc0/local/lib/libsingular.dylib (for architecture x86_64) because larger updated load commands do not fit (the program must be relinked, and you may need to use -headerpad or -headerpad_max_install_names)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19698\n\n",
    "created_at": "2015-12-13T10:48:38Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "title": "install_name_tool: changing install names or rpaths can't be redone (libsigular)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19461",
    "user": "vbraun"
}
```
CC:  jhpalmieri fbissey

Reported at https://groups.google.com/d/msg/sage-release/7TvrWAG7Rr0/taq2Yd7bAwAJ

```
error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/install_name_tool: changing install names or rpaths can't be redone for: /Users/palmieri/Desktop/Sage_stuff/sage_builds/clean/sage-6.10.rc0/local/lib/libsingular.dylib (for architecture x86_64) because larger updated load commands do not fit (the program must be relinked, and you may need to use -headerpad or -headerpad_max_install_names)
```


Issue created by migration from https://trac.sagemath.org/ticket/19698





---

archive/issue_comments_267502.json:
```json
{
    "body": "I'm actually surprised we didn't get such errors earlier...  (Ok, it was one of the reasons not to use `chrpath` and the like years ago.)",
    "created_at": "2015-12-13T11:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267502",
    "user": "leif"
}
```

I'm actually surprised we didn't get such errors earlier...  (Ok, it was one of the reasons not to use `chrpath` and the like years ago.)



---

archive/issue_comments_267503.json:
```json
{
    "body": "Off topic, but patchelf can grow rpaths just fine.",
    "created_at": "2015-12-13T12:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267503",
    "user": "vbraun"
}
```

Off topic, but patchelf can grow rpaths just fine.



---

archive/issue_comments_267504.json:
```json
{
    "body": "`patchmacho`? ;-)\n\n\n\n\nMay the error be a fallout of #18892?",
    "created_at": "2015-12-13T13:00:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267504",
    "user": "leif"
}
```

`patchmacho`? ;-)




May the error be a fallout of #18892?



---

archive/issue_comments_267505.json:
```json
{
    "body": "Replying to [comment:4 leif]:\n> May the error be a fallout of #18892?\n\nI mean does it make sense to unconditionally replace `LD` by `CXX` if there's a problem on some 32-bit Ubuntu only?  (Otherwise `libtool` is used on Darwin.)",
    "created_at": "2015-12-13T13:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267505",
    "user": "leif"
}
```

Replying to [comment:4 leif]:
> May the error be a fallout of #18892?

I mean does it make sense to unconditionally replace `LD` by `CXX` if there's a problem on some 32-bit Ubuntu only?  (Otherwise `libtool` is used on Darwin.)



---

archive/issue_comments_267506.json:
```json
{
    "body": "its not pretty but works:\n\n```\nosx:Sage vbraun$ grep install_name logs/pkgs/singular-3.1.7p1.p0.log\n g++  -dynamiclib -twolevel_namespace -weak_reference_mismatches weak -undefined dynamic_lookup -install_name /Users/vbraun/Sage/local/lib/libsingular.dylib -L/Users/vbraun/Sage/local/lib -lflint -lmpfr -lmpir -single_module -o libsingular.dylib \\\n```\n\n----\nNew commits:",
    "created_at": "2015-12-13T17:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267506",
    "user": "vbraun"
}
```

its not pretty but works:

```
osx:Sage vbraun$ grep install_name logs/pkgs/singular-3.1.7p1.p0.log
 g++  -dynamiclib -twolevel_namespace -weak_reference_mismatches weak -undefined dynamic_lookup -install_name /Users/vbraun/Sage/local/lib/libsingular.dylib -L/Users/vbraun/Sage/local/lib -lflint -lmpfr -lmpir -single_module -o libsingular.dylib \
```

----
New commits:



---

archive/issue_comments_267507.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-12-13T17:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267507",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_267508.json:
```json
{
    "body": "Replying to [comment:7 vbraun]:\n> its not pretty\n\nIndeed.  I'd rather not use `CXX` for linking *on Darwin* instead, but if we really switch to Singular 4.x **soon** anyway...\n\n\n\n\nAfter all, I think #18892 caused this trouble, and now you're fixing a broken hack by adding another hack.  And the following does no longer apply (since #18892):\n\n```sh\nif [ \"$UNAME\" = \"Darwin\" ]; then\n    # Singular needs $LD set to \"libtool\", not \"ld\" on Darwin.\n    # If we unset it, Singular will figure it out correctly.\n    unset LD\nfi\n```\n",
    "created_at": "2015-12-13T18:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267508",
    "user": "leif"
}
```

Replying to [comment:7 vbraun]:
> its not pretty

Indeed.  I'd rather not use `CXX` for linking *on Darwin* instead, but if we really switch to Singular 4.x **soon** anyway...




After all, I think #18892 caused this trouble, and now you're fixing a broken hack by adding another hack.  And the following does no longer apply (since #18892):

```sh
if [ "$UNAME" = "Darwin" ]; then
    # Singular needs $LD set to "libtool", not "ld" on Darwin.
    # If we unset it, Singular will figure it out correctly.
    unset LD
fi
```




---

archive/issue_comments_267509.json:
```json
{
    "body": "I encourage you to improve how Singular is being built, but please on a separate ticket.",
    "created_at": "2015-12-13T18:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267509",
    "user": "vbraun"
}
```

I encourage you to improve how Singular is being built, but please on a separate ticket.



---

archive/issue_comments_267510.json:
```json
{
    "body": "Looks good to me, although I would have added `-headerpad_max_install_name` in there. It is very hard to solve #18892 by doing anything else but using `CXX` as the linker - it is a valid from many 32bits recent install on any distro. It was first reported to me on Gentoo a few weeks before it was reported here. \n\nIn a lot of case you don't want to use the linker directly and let the compiler do the magic for you. \n\nFurthermore, if you are going to add `LDFLAGS=-Wl,-rpath=.....` globally you don't want to use `ld` as your linker anywhere. `-Wl,` is a compiler instruction to pass its argument to `ld`. Anywhere `ld` is used directly you'll have to strip `-Wl,` from `LDFLAGS`.",
    "created_at": "2015-12-13T20:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267510",
    "user": "fbissey"
}
```

Looks good to me, although I would have added `-headerpad_max_install_name` in there. It is very hard to solve #18892 by doing anything else but using `CXX` as the linker - it is a valid from many 32bits recent install on any distro. It was first reported to me on Gentoo a few weeks before it was reported here. 

In a lot of case you don't want to use the linker directly and let the compiler do the magic for you. 

Furthermore, if you are going to add `LDFLAGS=-Wl,-rpath=.....` globally you don't want to use `ld` as your linker anywhere. `-Wl,` is a compiler instruction to pass its argument to `ld`. Anywhere `ld` is used directly you'll have to strip `-Wl,` from `LDFLAGS`.



---

archive/issue_comments_267511.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-12-13T20:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267511",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_267512.json:
```json
{
    "body": "There is no need to pad the header, we just set it on compilation to the correct value",
    "created_at": "2015-12-13T20:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267512",
    "user": "vbraun"
}
```

There is no need to pad the header, we just set it on compilation to the correct value



---

archive/issue_comments_267513.json:
```json
{
    "body": "Padding is useful if you are going to change things afterwards (for example when moving your install) because you cannot set it to a shorter path otherwise. But if your stuff for relocating sage on OS X doesn't rely on that, then it's ok.",
    "created_at": "2015-12-13T20:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267513",
    "user": "fbissey"
}
```

Padding is useful if you are going to change things afterwards (for example when moving your install) because you cannot set it to a shorter path otherwise. But if your stuff for relocating sage on OS X doesn't rely on that, then it's ok.



---

archive/issue_comments_267514.json:
```json
{
    "body": "Replying to [comment:11 fbissey]:\n> It is very hard to solve #18892 by doing anything else but using `CXX` as the linker - it is a valid from many 32bits recent install on any distro. It was first reported to me on Gentoo a few weeks before it was reported here.\n\nWell, on Linux.\n\n> In a lot of case you don't want to use the linker directly and let the compiler do the magic for you.\n\nSure, but in this case (previously) libtool did the magic on Darwin, so if you change that, upstream's assumptions do no longer hold and it's not too surprising that such a change broke things elsewhere.\n\nHopefully we won't have to maintain Singular 3.x much longer.\n\n\n\n\n> Furthermore, if you are going to add `LDFLAGS=-Wl,-rpath=.....` globally you don't want to use `ld` as your linker anywhere. `-Wl,` is a compiler instruction to pass its argument to `ld`. Anywhere `ld` is used directly you'll have to strip `-Wl,` from `LDFLAGS`.\n\n... which would probably be easier with `-Xlinker` (by just dropping it), since you wouldn't have to replace commas by spaces... ;-)\n\nYou can by the way also set `LD_RUN_PATH`, which is used by the linker if no `-rpath` option is given.",
    "created_at": "2015-12-13T20:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267514",
    "user": "leif"
}
```

Replying to [comment:11 fbissey]:
> It is very hard to solve #18892 by doing anything else but using `CXX` as the linker - it is a valid from many 32bits recent install on any distro. It was first reported to me on Gentoo a few weeks before it was reported here.

Well, on Linux.

> In a lot of case you don't want to use the linker directly and let the compiler do the magic for you.

Sure, but in this case (previously) libtool did the magic on Darwin, so if you change that, upstream's assumptions do no longer hold and it's not too surprising that such a change broke things elsewhere.

Hopefully we won't have to maintain Singular 3.x much longer.




> Furthermore, if you are going to add `LDFLAGS=-Wl,-rpath=.....` globally you don't want to use `ld` as your linker anywhere. `-Wl,` is a compiler instruction to pass its argument to `ld`. Anywhere `ld` is used directly you'll have to strip `-Wl,` from `LDFLAGS`.

... which would probably be easier with `-Xlinker` (by just dropping it), since you wouldn't have to replace commas by spaces... ;-)

You can by the way also set `LD_RUN_PATH`, which is used by the linker if no `-rpath` option is given.



---

archive/issue_comments_267515.json:
```json
{
    "body": "`LD_RUN_PATH` is great with gnu `ld`, I don't know if OS X `ld` takes it as well. One major problem with `LD_RUN_PATH` is that it is not additive to any extra `-rpath` option you pass to `ld`. If any `-Wl,-rpath` or `-rpath` is set, `LD_RUN_PATH` is just discarded. \n\nCase in point: in hashdist Ondrej asked a few months ago if it was possible to enforce a `rpath`, I provided a patch for `gcc` that change the spec for linking to add `-Wl-rpath=...`, this is added each time `gcc`, `g++` or `gfortran` is used linking and  `LD_RUN_PATH` will never be used if you link with that compiler. This is also done by IBM in their \"advance toolchain\" for power hardware, no working `LD_RUN_PATH` for you there either.",
    "created_at": "2015-12-13T20:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267515",
    "user": "fbissey"
}
```

`LD_RUN_PATH` is great with gnu `ld`, I don't know if OS X `ld` takes it as well. One major problem with `LD_RUN_PATH` is that it is not additive to any extra `-rpath` option you pass to `ld`. If any `-Wl,-rpath` or `-rpath` is set, `LD_RUN_PATH` is just discarded. 

Case in point: in hashdist Ondrej asked a few months ago if it was possible to enforce a `rpath`, I provided a patch for `gcc` that change the spec for linking to add `-Wl-rpath=...`, this is added each time `gcc`, `g++` or `gfortran` is used linking and  `LD_RUN_PATH` will never be used if you link with that compiler. This is also done by IBM in their "advance toolchain" for power hardware, no working `LD_RUN_PATH` for you there either.



---

archive/issue_comments_267516.json:
```json
{
    "body": "I don't need padding for relocating Sage. There are also other hardcoded paths, so padding in rpaths alone wouldn't be enough.",
    "created_at": "2015-12-13T20:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267516",
    "user": "vbraun"
}
```

I don't need padding for relocating Sage. There are also other hardcoded paths, so padding in rpaths alone wouldn't be enough.



---

archive/issue_comments_267517.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-12-14T23:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19461#issuecomment-267517",
    "user": "vbraun"
}
```

Resolution: fixed
