# Issue 27000: Clean up various Cython cimports

archive/issues_027000.json:
```json
{
    "body": "CC:  tscrim\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27237\n\n",
    "created_at": "2019-02-08T15:49:10Z",
    "labels": [
        "cython",
        "trivial",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Clean up various Cython cimports",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27000",
    "user": "jdemeyer"
}
```
CC:  tscrim



Issue created by migration from https://trac.sagemath.org/ticket/27237





---

archive/issue_comments_380147.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-08T16:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380147",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_380148.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-02-08T16:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380148",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_380149.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-09T07:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380149",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_380150.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-10T21:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380150",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_380151.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-10T23:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380151",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_380152.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-02-11T09:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380152",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_380153.json:
```json
{
    "body": "Did anyone check if the changes to `permutation_cython.pyx` resulted in a slowdown? I have a memory of having it this way because it was the fastest way to create the output list.",
    "created_at": "2019-02-14T06:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380153",
    "user": "tscrim"
}
```

Did anyone check if the changes to `permutation_cython.pyx` resulted in a slowdown? I have a memory of having it this way because it was the fastest way to create the output list.



---

archive/issue_comments_380154.json:
```json
{
    "body": "I didn't specifically check this case, but I know that Cython generates reasonably efficient code for list comprehensions. Maybe there is room for improvement, but it can't be much. In any case, it should be fixed upstream in Cython and not by writing ugly C API code. Then every list comprehension benefits from it, not just these two in `permutation_cython.pyx`.",
    "created_at": "2019-02-14T08:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380154",
    "user": "jdemeyer"
}
```

I didn't specifically check this case, but I know that Cython generates reasonably efficient code for list comprehensions. Maybe there is room for improvement, but it can't be much. In any case, it should be fixed upstream in Cython and not by writing ugly C API code. Then every list comprehension benefits from it, not just these two in `permutation_cython.pyx`.



---

archive/issue_comments_380155.json:
```json
{
    "body": "Here are some timings on a simple example, using either a list comprehension or the C API calls:\n\n```\n%load_ext cython\n\n%%cython\nfrom cpython.object cimport PyObject\n\ncdef extern from \"Python.h\":\n    void Py_INCREF(PyObject *)\n    PyObject * PyInt_FromLong(long ival)\n    list PyList_New(Py_ssize_t size)\n    void PyList_SET_ITEM(list l, Py_ssize_t, PyObject *)\n\ndef listcomp1(long n):\n    cdef long i\n    return [i*i for i in range(n)]\n\ndef listcomp2(long n):\n    cdef long i\n    cdef list T = PyList_New(n)\n    for i in range(n):\n        PyList_SET_ITEM(T, i, PyInt_FromLong(i*i))\n    return T\n\n\n%timeit -r20 listcomp1(1)\n10000000 loops, best of 20: 109 ns per loop\n\n%timeit -r20 listcomp2(1)\n10000000 loops, best of 20: 100 ns per loop\n\n%timeit -r20 listcomp1(1000)\n100000 loops, best of 20: 10.7 \u00b5s per loop\n\n%timeit -r20 listcomp2(1000)\n100000 loops, best of 20: 7.7 \u00b5s per loop\n\n%timeit -r20 listcomp1(1000000)\n100 loops, best of 20: 13.3 ms per loop\n\n%timeit -r20 listcomp2(1000000)\n100 loops, best of 20: 15 ms per loop\n```\n",
    "created_at": "2019-02-14T18:28:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380155",
    "user": "jdemeyer"
}
```

Here are some timings on a simple example, using either a list comprehension or the C API calls:

```
%load_ext cython

%%cython
from cpython.object cimport PyObject

cdef extern from "Python.h":
    void Py_INCREF(PyObject *)
    PyObject * PyInt_FromLong(long ival)
    list PyList_New(Py_ssize_t size)
    void PyList_SET_ITEM(list l, Py_ssize_t, PyObject *)

def listcomp1(long n):
    cdef long i
    return [i*i for i in range(n)]

def listcomp2(long n):
    cdef long i
    cdef list T = PyList_New(n)
    for i in range(n):
        PyList_SET_ITEM(T, i, PyInt_FromLong(i*i))
    return T


%timeit -r20 listcomp1(1)
10000000 loops, best of 20: 109 ns per loop

%timeit -r20 listcomp2(1)
10000000 loops, best of 20: 100 ns per loop

%timeit -r20 listcomp1(1000)
100000 loops, best of 20: 10.7 µs per loop

%timeit -r20 listcomp2(1000)
100000 loops, best of 20: 7.7 µs per loop

%timeit -r20 listcomp1(1000000)
100 loops, best of 20: 13.3 ms per loop

%timeit -r20 listcomp2(1000000)
100 loops, best of 20: 15 ms per loop
```




---

archive/issue_comments_380156.json:
```json
{
    "body": "Thanks for running the tests (I was just going to do them this morning). The benefit to doing the `listcomp2` way in my mind was that it takes advantage of knowing the size of the list ahead of time. Maybe with the list comprehension, it can figure that out as well? It is interesting to me that there is a crossing point with the list sizes. For \"small\" lists, it seems the `listcomp2` is faster (which is the case this was used for as permutation groups of large `n` are usually too big for testing). Anyways, fair enough point that the Cython code should be improved instead of unrolling it here. The slowdown probably will not be so impactful on any actual experiments.",
    "created_at": "2019-02-14T19:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380156",
    "user": "tscrim"
}
```

Thanks for running the tests (I was just going to do them this morning). The benefit to doing the `listcomp2` way in my mind was that it takes advantage of knowing the size of the list ahead of time. Maybe with the list comprehension, it can figure that out as well? It is interesting to me that there is a crossing point with the list sizes. For "small" lists, it seems the `listcomp2` is faster (which is the case this was used for as permutation groups of large `n` are usually too big for testing). Anyways, fair enough point that the Cython code should be improved instead of unrolling it here. The slowdown probably will not be so impactful on any actual experiments.



---

archive/issue_comments_380157.json:
```json
{
    "body": "I opened a Cython issue: https://github.com/cython/cython/issues/2844",
    "created_at": "2019-02-15T08:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380157",
    "user": "jdemeyer"
}
```

I opened a Cython issue: https://github.com/cython/cython/issues/2844



---

archive/issue_comments_380158.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-15T13:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27000",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27000#issuecomment-380158",
    "user": "vbraun"
}
```

Resolution: fixed
