# Issue 10071: Bug in log gamma evaluation

archive/issues_010071.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @burcin @zimmermann6\n\nHowever `log_gamma` is numerically evaluated, it seems to be wrong (or on another branch?)\n\n```\nsage: log_gamma(i).n()\n-0.0219785471672303 - 0.168184318273662*I\nsage: log_gamma(pari(i))\n-0.650923199301856 - 1.87243664726243*I\n```\n\nAnd in Sage's Maxima:\n\n```\n(%i3) ev(log_gamma(%i),numer);\n(%o3)             - 1.872436647262428 %i - .6509231993018556\n```\n\nThe relevant bit of code is\n\n```\nsage: a = log_gamma(i)\nsage: a._convert(RealField(53).complex_field())\n-0.0219785471672303 - 0.168184318273662*I\n```\n\nBut I'm not sure if this problem is in Pynac or in RealField.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10072\n\n",
    "created_at": "2010-10-05T13:50:52Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.6.1",
    "title": "Bug in log gamma evaluation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10071",
    "user": "https://github.com/kcrisman"
}
```
Assignee: @aghitza

CC:  @burcin @zimmermann6

However `log_gamma` is numerically evaluated, it seems to be wrong (or on another branch?)

```
sage: log_gamma(i).n()
-0.0219785471672303 - 0.168184318273662*I
sage: log_gamma(pari(i))
-0.650923199301856 - 1.87243664726243*I
```

And in Sage's Maxima:

```
(%i3) ev(log_gamma(%i),numer);
(%o3)             - 1.872436647262428 %i - .6509231993018556
```

The relevant bit of code is

```
sage: a = log_gamma(i)
sage: a._convert(RealField(53).complex_field())
-0.0219785471672303 - 0.168184318273662*I
```

But I'm not sure if this problem is in Pynac or in RealField.

Issue created by migration from https://trac.sagemath.org/ticket/10072





---

archive/issue_comments_101416.json:
```json
{
    "body": "> But I'm not sure if this problem is in Pynac or in RealField. \n\nas it name says, RealField only deals with real values, not complex values.\n\nPaul",
    "created_at": "2010-10-05T14:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101416",
    "user": "https://github.com/zimmermann6"
}
```

> But I'm not sure if this problem is in Pynac or in RealField. 

as it name says, RealField only deals with real values, not complex values.

Paul



---

archive/issue_comments_101417.json:
```json
{
    "body": "Replying to [comment:1 zimmerma]:\n> > But I'm not sure if this problem is in Pynac or in RealField. \n> \n> as it name says, RealField only deals with real values, not complex values.\n\nOkay, fair enough - so change that to whatever `RealField.complex_field()` becomes, which I don't know.  Feel free to alter the description to wherever RealField goes under that - ComplexField, I guess.",
    "created_at": "2010-10-05T14:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101417",
    "user": "https://github.com/kcrisman"
}
```

Replying to [comment:1 zimmerma]:
> > But I'm not sure if this problem is in Pynac or in RealField. 
> 
> as it name says, RealField only deals with real values, not complex values.

Okay, fair enough - so change that to whatever `RealField.complex_field()` becomes, which I don't know.  Feel free to alter the description to wherever RealField goes under that - ComplexField, I guess.



---

archive/issue_comments_101418.json:
```json
{
    "body": "what is strange is that the precision is not taken into account:\n\n```\nsage: a=log_gamma(I)               \nsage: a._convert(ComplexField(53))\n-0.0219785471672303 - 0.168184318273662*I\nsage: a._convert(ComplexField(100))\n-0.0219785471672303 - 0.168184318273662*I\n```\n\nPaul",
    "created_at": "2010-10-05T14:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101418",
    "user": "https://github.com/zimmermann6"
}
```

what is strange is that the precision is not taken into account:

```
sage: a=log_gamma(I)               
sage: a._convert(ComplexField(53))
-0.0219785471672303 - 0.168184318273662*I
sage: a._convert(ComplexField(100))
-0.0219785471672303 - 0.168184318273662*I
```

Paul



---

archive/issue_comments_101419.json:
```json
{
    "body": "Which is why I think it's a bug in Pynac/GiNaC.  I am not sure how to check this, though, since `_convert` uses the mysterious attribute `_gobj` which is not accessible from the outside world.",
    "created_at": "2010-10-05T15:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101419",
    "user": "https://github.com/kcrisman"
}
```

Which is why I think it's a bug in Pynac/GiNaC.  I am not sure how to check this, though, since `_convert` uses the mysterious attribute `_gobj` which is not accessible from the outside world.



---

archive/issue_comments_101420.json:
```json
{
    "body": "Though the fact that `log_gamma` is not currently symbolic (#10075) could have something to do with this.  I'm sure Burcin will eventually weigh in, but I know he's probably pretty busy right now, since he worked hard on getting the new Pynac ready just before this.",
    "created_at": "2010-10-05T15:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101420",
    "user": "https://github.com/kcrisman"
}
```

Though the fact that `log_gamma` is not currently symbolic (#10075) could have something to do with this.  I'm sure Burcin will eventually weigh in, but I know he's probably pretty busy right now, since he worked hard on getting the new Pynac ready just before this.



---

archive/issue_comments_101421.json:
```json
{
    "body": "More mysterious (after MUCH trouble trying to get Ginac to compile on OS X - needed to install CLN, pkg-config, and readline!!!):\n\n```\nginsh - GiNaC Interactive Shell (ginac V1.5.8)\n  __,  _______  Copyright (C) 1999-2010 Johannes Gutenberg University Mainz,\n (__) *       | Germany.  This is free software with ABSOLUTELY NO WARRANTY.\n  ._) i N a C | You are welcome to redistribute it under certain conditions.\n<-------------' For details type `warranty;'.\n\nType ?? for a list of help topics.\n> lgamma(I);\n-0.65092319930185634056+4.41074865991715666*I\n```\n",
    "created_at": "2010-10-08T01:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101421",
    "user": "https://github.com/kcrisman"
}
```

More mysterious (after MUCH trouble trying to get Ginac to compile on OS X - needed to install CLN, pkg-config, and readline!!!):

```
ginsh - GiNaC Interactive Shell (ginac V1.5.8)
  __,  _______  Copyright (C) 1999-2010 Johannes Gutenberg University Mainz,
 (__) *       | Germany.  This is free software with ABSOLUTELY NO WARRANTY.
  ._) i N a C | You are welcome to redistribute it under certain conditions.
<-------------' For details type `warranty;'.

Type ?? for a list of help topics.
> lgamma(I);
-0.65092319930185634056+4.41074865991715666*I
```




---

archive/issue_comments_101422.json:
```json
{
    "body": "And even more perplexing is that `gamma(I)` is the same in all four systems.\n\n```\n(%i1) ev(gamma(%i),numer);\n(%o1)             - .4980156681183565 %i - .1549498283018101\nsage: gamma(i).n()\n-0.154949828301811 - 0.498015668118356*I\nsage: pari(i).gamma()\n-0.154949828301811 - 0.498015668118356*I\n> tgamma(I);\n-0.15494982830181068507-0.49801566811835604268*I\n```\n",
    "created_at": "2010-10-08T01:22:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101422",
    "user": "https://github.com/kcrisman"
}
```

And even more perplexing is that `gamma(I)` is the same in all four systems.

```
(%i1) ev(gamma(%i),numer);
(%o1)             - .4980156681183565 %i - .1549498283018101
sage: gamma(i).n()
-0.154949828301811 - 0.498015668118356*I
sage: pari(i).gamma()
-0.154949828301811 - 0.498015668118356*I
> tgamma(I);
-0.15494982830181068507-0.49801566811835604268*I
```




---

archive/issue_comments_101423.json:
```json
{
    "body": "I don't see how the wrong result is related (if any) to the correct one. The difference in the\nimaginary part is `1.70425232898877`, which is neither 2pi nor pi nor even pi/2.\n\nPaul",
    "created_at": "2010-10-08T16:39:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101423",
    "user": "https://github.com/zimmermann6"
}
```

I don't see how the wrong result is related (if any) to the correct one. The difference in the
imaginary part is `1.70425232898877`, which is neither 2pi nor pi nor even pi/2.

Paul



---

archive/issue_comments_101424.json:
```json
{
    "body": "Replying to [comment:8 zimmerma]:\n> I don't see how the wrong result is related (if any) to the correct one. The difference in the\n> imaginary part is `1.70425232898877`, which is neither 2pi nor pi nor even pi/2.\n\nCorrect.  My comment about the `2*pi` was in reference to the Ginac output, not the Sage output.  But I can't for the life of me figure out how Sage is actually doing `log_gamma(i).n()`, because the conversion to the complex field pretty clearly just converts it to a Ginac object and then numerically evaluates. \n\nAs to the precision, I think there must be something missing in our code, because the Ginac docs state\n\n```\nThe function evalf that was used above converts any number in GiNaC's expressions into floating point numbers. This can be done to arbitrary predefined accuracy:\n\n     > evalf(1/7);\n     0.14285714285714285714\n     > Digits=150;\n     150\n     > evalf(1/7);\n     0.1428571428571428571428571428571428571428571428571428571428571428571428\n     5714285714285714285714285714285714285\n```\n\nSo maybe we're not taking that into account, though I have no idea how I would do so.",
    "created_at": "2010-10-08T17:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101424",
    "user": "https://github.com/kcrisman"
}
```

Replying to [comment:8 zimmerma]:
> I don't see how the wrong result is related (if any) to the correct one. The difference in the
> imaginary part is `1.70425232898877`, which is neither 2pi nor pi nor even pi/2.

Correct.  My comment about the `2*pi` was in reference to the Ginac output, not the Sage output.  But I can't for the life of me figure out how Sage is actually doing `log_gamma(i).n()`, because the conversion to the complex field pretty clearly just converts it to a Ginac object and then numerically evaluates. 

As to the precision, I think there must be something missing in our code, because the Ginac docs state

```
The function evalf that was used above converts any number in GiNaC's expressions into floating point numbers. This can be done to arbitrary predefined accuracy:

     > evalf(1/7);
     0.14285714285714285714
     > Digits=150;
     150
     > evalf(1/7);
     0.1428571428571428571428571428571428571428571428571428571428571428571428
     5714285714285714285714285714285714285
```

So maybe we're not taking that into account, though I have no idea how I would do so.



---

archive/issue_comments_101425.json:
```json
{
    "body": "Changing status from new to needs_work.",
    "created_at": "2010-10-10T11:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101425",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from new to needs_work.



---

archive/issue_comments_101426.json:
```json
{
    "body": "I found the reason of the bug. In `symbolic/pynac.pyx`, function `py_lgamma`, it is\nwritten `CC(x).log().gamma()` instead of `CC(x).gamma().log()`:\n\n```\nsage: CC(I).log().gamma()\n-0.0219785471672303 - 0.168184318273662*I\nsage: CC(I).gamma().log()\n-0.650923199301856 - 1.87243664726243*I\n```\n\nIf somebody provides a patch, I will review it.\n\nPaul",
    "created_at": "2010-10-10T11:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101426",
    "user": "https://github.com/zimmermann6"
}
```

I found the reason of the bug. In `symbolic/pynac.pyx`, function `py_lgamma`, it is
written `CC(x).log().gamma()` instead of `CC(x).gamma().log()`:

```
sage: CC(I).log().gamma()
-0.0219785471672303 - 0.168184318273662*I
sage: CC(I).gamma().log()
-0.650923199301856 - 1.87243664726243*I
```

If somebody provides a patch, I will review it.

Paul



---

archive/issue_comments_101427.json:
```json
{
    "body": "Attachment [trac_10072-log_gamma.patch](tarball://root/attachments/some-uuid/ticket10072/trac_10072-log_gamma.patch) by fstan created at 2010-10-10 23:40:58",
    "created_at": "2010-10-10T23:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101427",
    "user": "https://trac.sagemath.org/admin/accounts/users/fstan"
}
```

Attachment [trac_10072-log_gamma.patch](tarball://root/attachments/some-uuid/ticket10072/trac_10072-log_gamma.patch) by fstan created at 2010-10-10 23:40:58



---

archive/issue_comments_101428.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-10-10T23:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101428",
    "user": "https://trac.sagemath.org/admin/accounts/users/fstan"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_101429.json:
```json
{
    "body": "This patch should fix the `py_lgamma` function using as a model the `py_log`\n\nFlavia",
    "created_at": "2010-10-10T23:48:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101429",
    "user": "https://trac.sagemath.org/admin/accounts/users/fstan"
}
```

This patch should fix the `py_lgamma` function using as a model the `py_log`

Flavia



---

archive/issue_comments_101430.json:
```json
{
    "body": "excellent work, Flavia! Not only it fixes the reported problem, but also now we can get arbitrary\nprecision values.\n\nPaul",
    "created_at": "2010-10-11T08:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101430",
    "user": "https://github.com/zimmermann6"
}
```

excellent work, Flavia! Not only it fixes the reported problem, but also now we can get arbitrary
precision values.

Paul



---

archive/issue_comments_101431.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-10-11T08:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101431",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_010194.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2010-11-01T10:14:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/10071#event-10194"
}
```



---

archive/issue_comments_101432.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-11-01T10:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10071",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10071#issuecomment-101432",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
