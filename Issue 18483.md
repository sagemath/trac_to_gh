# Issue 18483: Change diagram algebra basis set partitions from list to generator

Issue created by migration from https://trac.sagemath.org/ticket/18720

Original creator: ghseeli

Original creation time: 2015-06-17 17:22:40

CC:  alauve s.r.doty saliola

Keywords: days65, partition algebra, diagram algebra

Currently, when building a diagram algebra, the functions that create the set partitions representing the diagrams create a list of all the correct set partitions. However, this behavior causes the initialization of the algebras to be slow in larger cases. Furthermore, there are things one can do in these algebras without needing to know the whole basis since it is usually pretty easy to determine if an element is in the algebra. Thus, in order to avoid this computation except when necessary, I have made the set partition generating functions return iterators instead of lists.


---

Comment by tscrim created at 2015-06-19 06:24:37

Thank you for your work on cleaning up the diagram algebras. I know this isn't yet ready for review, but some comments:

You should try to avoid changing the behavior of any public functions. Instead I would create an iterator method (perhaps make it hidden?) and then the original function just calls `list(iterator_method)`.

You shouldn't use `CombinatorialClass` and `CombinatorialObject` but instead `Parent, UniqueRepresentation` and `ClonableArray` respectively as these are being deprecated. Also you should set the `Element = PartitionDiagram` in `PartitionDiagrams` (the order of which will need to be swapped in the file). If you put `PartitionDiagrams` in the category of `FiniteEnumeratedSets`, then you don't need to define a `list` and `cardinality` methods (maybe even `__contains__`, I forget offhand). The `PartitionDiagram` class will also need to have parent be passed as the first argument.

Let me know if you have any questions.


---

Comment by git created at 2015-06-19 18:44:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-06-19 18:48:00

Travis, thank you for your feedback! I still need to create documentation, but is this code closer to what you are looking for? Thank you for suggesting `Parent`, `UniqueRepresentation`, `ClonableArray`, and `FiniteEnumeratedSet.` They make things a lot easier.


---

Comment by tscrim created at 2015-06-19 19:57:03

It looks a lot better. Considering how you're going to be using them, I would instead make the iter methods return simple tuple of pairs (where each pair is a tuple) as you don't seem to need the full weight of a `SetPartition` object. This might require some other changes to the code, but I doubt it will be that much.

I would also make the `AbstractPartitionDiagram` class compare equals with `SetPartition` and lists/tuples/sets of lists/tuples/sets. This will make it easier on the user to interact with the basis elements. I would also just make one `AbstractPartitionDiagrams` class which takes a name (which gets used in the `_repr_`),  function, order, and category input as these other classes seem useless (but perhaps you have plans for them). You should also

```
        Element = AbstractPartitionDiagram  # Make this at the class level (so de-indent it one level)
        self.element_class = Element  # Remove this, done automatically by the category framework
```

I'd also change the `__iter__` to this:

```python
    def __iter__(self):
        for i in self.diagram_func(self.order):
            yield self.element_class(self, i)
```


On a closer look/second thought, the `*_diagram` methods are not imported into the public namespace, so it's okay to change the output to be iterators. Just make sure to change the documentation appropriately.

On an unrelated to this ticket note, you can get rid of those (IMO) annoying extra `[]` brackets in the element repr by passing `bracket=False` (I believe, maybe it was `bracket=None`) in the `CombinatorialFreeModule.__init__`.


---

Comment by ghseeli created at 2015-06-19 20:09:44

Okay, I will do those changes. I do have plans for the other classes, but I have not finished polishing up the methods. At the moment, really the only one I have special methods for is `BrauerDiagrams`, but I can imagine special methods applying to other types of diagrams. For instance, it is usually possible to determine if a diagram is a certain type of diagram without generating the entire list of those diagrams of order n. However, I assume the contains method of `FiniteEnumeratedSets` currently needs to create the entire list?

However, it may be possible to reduce the number of classes; I will think about the best way to logically do it while preserving the functionality I want to add.


---

Comment by tscrim created at 2015-06-19 20:18:48

Replying to [comment:7 ghseeli]:
> Okay, I will do those changes. I do have plans for the other classes, but I have not finished polishing up the methods. At the moment, really the only one I have special methods for is `BrauerDiagrams`, but I can imagine special methods applying to other types of diagrams. For instance, it is usually possible to determine if a diagram is a certain type of diagram without generating the entire list of those diagrams of order n. However, I assume the contains method of `FiniteEnumeratedSets` currently needs to create the entire list?

Yes, that is correct. So if you have a better solution using `__contains__`, this completely justifies having separate classes.

> However, it may be possible to reduce the number of classes; I will think about the best way to logically do it while preserving the functionality I want to add.

Don't worry too much about it. It's better that the code is readable and grouped into functionality (i.e., good OOP). It was just if they were going to be classes that passed data up to a base class, then I didn't see a reason to keeping them.


---

Comment by ghseeli created at 2015-06-19 21:10:51

I have a question about making the various other classes and objects evaluate as equal with the Diagram classes. Doing this allows the user to create algebra elements that can misbehave. For instance



```
sage: P = PartitionAlgebra(2,x)
sage: elm = P.basis()[((1,2),(-1,-2))]; elm
P[((1, 2), (-1, -2))]
sage: type(elm.support()[0])
<type 'tuple'>
sage: elm^2
Traceback (most recent call last)
...
AttributeError: 'tuple' object has no attribute 'compose'
```


This isn't insurmountable, but will I have to put a lot of coercion throughout all the diagram methods to make this exhibit the desired behavior?


---

Comment by tscrim created at 2015-06-19 21:16:44

You will need to make the basis indexing set iterate over elements of itself. You will also need to implement a compose method for those elements, but it should work. If you're still having issues, you can push what you currently have and I can make some fixes directly.


---

Comment by ghseeli created at 2015-06-19 21:41:52

I am sorry, I don't quite get what "make the basis indexing set iterate over elements of itself" means because I don't quite understand the structure of the `LazyFamily` in the context of `CombinatorialFreeModule` yet. My concern is: should users expect that calling for the support of an element return a uniform type? I will commit what I have so you can take a look.


---

Comment by git created at 2015-06-19 21:42:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-19 22:08:44

Replying to [comment:11 ghseeli]:
> I am sorry, I don't quite get what "make the basis indexing set iterate over elements of itself" means because I don't quite understand the structure of the `LazyFamily` in the context of `CombinatorialFreeModule` yet. My concern is: should users expect that calling for the support of an element return a uniform type? I will commit what I have so you can take a look.

You are correct, it should be a uniform type. What the `LazyFamily` does in `CombinatorialFreeModule.basis()` (in this case) is iterate over the `AbstractPartitionDiagrams` class and then makes that into an element of the CFM, but only when required. However from looking at it, it should be working properly.

Also I think `range(-len(tst)/2,len(tst)/2+1)` might give you trouble because it's doing python int division (where `1/2 == 0`). And `except TypeError, ValueError:` should be `except (TypeError, ValueError):`.


---

Comment by ghseeli created at 2015-06-19 23:07:22

Ah, I meant to say `if len(tst)%2 != 0 or tst != range(-len(tst)/2,len(tst)/2+1)` so that `len(tst)` is guaranteed to be divisible by 2. Does that work better? Thanks for catching the missing parenthesis on the except statement.


---

Comment by tscrim created at 2015-06-20 00:34:51

Yes, that does. You'll have to rebase over my recent changes. I made it so that we don't create the intermediary `SetPartition` objects, which gives a pretty good speedup (the time to run the tests went from over 7 seconds to just over 6 seconds). I also merged in #18707 to avoid any potential merge conflicts.
----
New commits:


---

Comment by ghseeli created at 2015-06-20 00:49:12

New commits:


---

Comment by git created at 2015-06-20 01:00:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-20 19:30:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-06-20 19:41:37

Travis, thank you for all your suggestions so far. They have provided good speedups and made things cleaner and easier to read. I still have one question, though, involving the how the equality between diagrams and iterables of iterables works. I think an example will be best.


```
sage: B = BrauerAlgebra(3,x)
sage: elm = B([[1,2],[-1,-2]]) #calls element_constructor
sage: elm2 = B.basis()[((1,2),(-1,-2),(3,-3))] #bypasses element_constructor
sage: elm == elm2
False
sage: elm*B.one() == elm2*B.one() #support converted into same type
True
sage: elm.support()[0] == elm2.support()[0] #AbstractPartitionDiagram.__eq__ called
True
sage: type(elm.support()[0]) #support was left as tuple by construction
<type 'tuple'>
```


So, while I personally never construct elements by calling `B.basis().__getitem__`, it seems that this is a totally valid method to create an element, but leads to some unpredictable or unclear behaviors. Do you know the best way to address this in the context of `CombinatorialFreeModule`?


---

Comment by git created at 2015-06-20 20:23:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-20 21:02:53

This actually seems to be a more general issue with CFM:

```
sage: s = SymmetricFunctions(QQ).s()
sage: s.basis()[(3,1,1)]
s(3, 1, 1)
sage: type(_.support()[0])
<type 'tuple'>
```

This is now #18750 (which can be considered independent of this ticket).


---

Comment by ghseeli created at 2015-06-20 21:08:00

Alright. Sounds good. One other question. Should the `__contains__` methods of the *Diagrams accept iterables of iterables? For instance should 


```
sage: ((1,2),(-1,-2)) in da.PartitionDiagrams(2)
```


return `True` of `False`?


---

Comment by tscrim created at 2015-06-20 21:10:07

In an ideal world, I would say anything that is valid as input for `SetPartition`. Although we don't necessary have to cover every case, just the "typical" ones (such as what you gave).


---

Comment by git created at 2015-06-20 21:33:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-20 21:54:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-20 22:15:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-20 22:43:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-22 18:51:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-22 19:13:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-30 04:05:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-06-30 04:06:28

Changing status from new to needs_review.


---

Comment by tscrim created at 2015-07-02 01:41:48

It looks like you'll have to rebase this against the latest `develop` branch.

You'll also need to make sure all methods have doctests and, more minor, to change `Returns` to `Return` and similar changes in the docstrings (of the methods you've changed). I'll continue my review at that point. Thanks.


---

Comment by tscrim created at 2015-07-02 01:41:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-07-04 00:48:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-07-04 01:15:44

Travis, do I need to provide doctests for double underscore methods in their documentation or in the documentation for the class as a whole?


---

Comment by git created at 2015-07-04 01:46:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-04 01:50:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-07-04 22:32:17

Replying to [comment:35 ghseeli]:
> Travis, do I need to provide doctests for double underscore methods in their documentation or in the documentation for the class as a whole?

You need to provide doctests for any method in that method, including double underscore methods (although they can be indirectly called if the method does not make sense as a standalone or needs a lot of extra preprocessing of data).


---

Comment by git created at 2015-07-06 00:22:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-06 00:34:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-07-06 00:37:55

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-07-06 03:50:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-23 03:49:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-08-11 17:38:35

Finally had time to finish my review changes...sorry it took so long. I changed the interface for getting compact representations to use a global option you can set via the Brauer algebra or diagrams (the parent). There might be some more documentation fixes that need to be done, but overall I'd be happy with this going into Sage as is. Please check my changes, and if you're happy with them, then you can set a positive review.
----
Last 10 new commits:


---

Comment by git created at 2015-08-11 17:40:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-08-11 17:41:16

PS/FYI - This is based off 6.9.beta0.


---

Comment by ghseeli created at 2015-08-16 20:24:52

Alright. It looks good to me. I did not know about this global options pattern, so thank you for doing that!


---

Comment by ghseeli created at 2015-08-16 20:24:59

Changing status from needs_review to positive_review.


---

Comment by ghseeli created at 2015-08-16 20:43:08

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-08-16 22:30:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-08-16 23:09:12

Changing status from needs_work to positive_review.


---

Comment by ghseeli created at 2015-08-16 23:10:13

Travis, do you know why the doctest passed without the correct listed output before my most recent commit? Is this expected behavior or some sort of issue with the file setup?


---

Comment by tscrim created at 2015-08-17 16:05:47

Tests in `GlobalOptions` aren't actually tested because the docstring is dynamically generated. You will also need to update `doctests/sources.py` file because of this. (I would do this myself, except I currently don't have a working version of Sage.)


---

Comment by tscrim created at 2015-08-17 16:05:47

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-08-18 20:04:45

Documentation doesn't build either


---

Comment by git created at 2015-08-23 20:18:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ghseeli created at 2015-08-23 20:20:05

Travis, it is not clear to me how I need to update doctests/sources.py Could you please be more specific? Feel free to email me if that is more appropriate. Thank you!


---

Comment by tscrim created at 2015-08-23 20:26:18

Just run the doctest on the file and copy/paste the correct output. However I can take care of it if you want me to.


---

Comment by tscrim created at 2015-08-24 22:46:53

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2015-08-24 22:46:53

I've fixed the failing doctest in `doctests/sources.py` (you needed to run `--long` with it, something which I didn't know had changed). I've also made some other documentation fixes, which I forgot needed to be done. I also cleaned up the code to make it python3 compliant and might result in a very marginal speedup. So if you're happy with my changes, then you can set this back to positive review.
----
New commits:


---

Comment by ghseeli created at 2015-08-25 01:07:36

Alright. It looks good to me! Thank you for all the work you have put in on this ticket, Travis!


---

Comment by ghseeli created at 2015-08-25 01:07:36

Changing status from needs_review to positive_review.


---

Comment by git created at 2015-08-25 17:31:10

Changing status from positive_review to needs_review.


---

Comment by git created at 2015-08-25 17:31:10

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by tscrim created at 2015-08-25 17:32:48

I allowed myself one last little trivial change, `[GL]` -> `[GL1996]`, so as to make it less likely that there is a collision in reference names.

Thank you for your work (and sorry it took so long to do the review). Now onto the next ticket.


---

Comment by tscrim created at 2015-08-25 17:32:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-08-26 00:40:32

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-08-26 00:40:32


```
sage -t --long src/sage/categories/magmatic_algebras.py
**********************************************************************
File "src/sage/categories/magmatic_algebras.py", line 139, in sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis.ParentMethods.algebra_generators
Failed example:
    P.algebra_generators()
Expected:
    Finite family {{{-1, 1}}: P[{{-1, 1}}], {{-1}, {1}}: P[{{-1}, {1}}]}
Got:
    Lazy family (Term map from Partition diagrams of order 1 to Partition Algebra of rank 1 with parameter x over Univariate Polynomial Ring in x over Integer Ring(i))_{i in Partition diagrams of order 1}
**********************************************************************
1 item had failures:
   1 of   6 in sage.categories.magmatic_algebras.MagmaticAlgebras.WithBasis.ParentMethods.algebra_generators
    [26 tests, 1 failure, 0.20 s]
```



---

Comment by git created at 2015-08-26 00:57:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-08-26 00:57:40

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-08-26 13:35:51

Resolution: fixed
