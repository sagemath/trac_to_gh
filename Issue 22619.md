# Issue 22619: libhomfly doesn't build on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/22856

Original creator: tscrim

Original creation time: 2017-04-22 01:57:54

CC:  embray jpflori gouezel mmarco

Keywords: libhomfly

Errors out with messages like this when trying to build the corresponding Cython file:

```
/home/Travis/sage/local/var/tmp/sage/build/libhomfly-1.0/src/lib/control.c:209:(.text+0x7a9): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `GC_malloc'
```



---

Comment by mmarco created at 2017-04-22 09:56:40

That seems to be rellated to boehm_gc. A version mismatch maybe?


---

Comment by tscrim created at 2017-04-22 13:21:21

I forgot to check if `boehm_gc` was installed. I will do that. Although IIRC, Cygwin can be more picky about linking order, and I saw a similar error coming from this.


---

Comment by embray created at 2017-04-24 11:02:00

Is this an optional package?  Definitely a blocker if you're using it but not in general.  I can probably fix this; linking problems are very common.


---

Comment by embray created at 2017-04-24 11:04:23

(Lazyweb question: Is there an easy way to just install *all* optional packages, and better still run tests that use them?  Or is it entirely piecemeal?)


---

Comment by mmarco created at 2017-04-24 11:06:44

Replying to [comment:3 embray]:
> Is this an optional package?  Definitely a blocker if you're using it but not in general.  I can probably fix this; linking problems are very common.


It is optional now, but has been for almost a year and I was planning to propose to promote it to standard after the one year period.


---

Comment by embray created at 2017-04-24 11:11:45

Okay--either way I do want all optional packages to work too of course.  It's just lower priority than getting the standard build fully working.  But now that it is we can start looking at more of the optional packages too.


---

Comment by embray created at 2017-04-24 11:21:57

So libhomfly did build for me (just ran `make libhomfly`).  Though it only built a static library, not shared, and I do have a warning:


```
[libhomfly-1.0] /bin/sh ../libtool  --tag=CC   --mode=link gcc  -g -O2 -lgc -export-symbols-regex '(c_)?homfly' -L/home/embray/src/sagemath/sage-cygwin/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-cygwin/local/lib  -o libhomfly.la -rpath /home/embray/src/sagemath/sage-cygwin/local/lib bound.lo control.lo dllink.lo homfly.lo knot.lo model.lo order.lo poly.lo
[libhomfly-1.0] libtool: warning: undefined symbols not allowed in x86_64-unknown-cygwin shared libraries; building static only
[libhomfly-1.0] libtool: link: ar cru .libs/libhomfly.a  bound.o control.o dllink.o homfly.o knot.o model.o order.o poly.o
[libhomfly-1.0] libtool: link: ranlib .libs/libhomfly.a
[libhomfly-1.0] libtool: link: ( cd ".libs" && rm -f "libhomfly.la" && ln -s "../libhomfly.la" "libhomfly.la" )
[libhomfly-1.0] make[3]: Leaving directory '/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/libhomfly-1.0/src/lib'
```


Which it was usually happens with my libtool if there are undefined symbols when linking a shared library (is it possible you have different default settings for libtool?)

I haven't investigated further yet, but I've found a lot of automake packages don't have the necessary bits to get DLLs building properly on Windows.  See for example #21957, and I think some others I've worked on.


---

Comment by embray created at 2017-04-24 11:34:48

Basically the same boilerplate that I described [here](https://trac.sagemath.org/ticket/15872#comment:5) should work here too; I will give it a try.


---

Attachment

The attached patch should fix it.  I will add a branch with a version of this patch that _only_ patches the generated files (and not the source files like configure.ac) so that applying the patch doesn't cause autotools invocation.

I also noted that even with this patch, a static library is created by default.  Unless we _specifically_ want a static version of libhomfly for some reason it would be good to disable this, just for disk space savings if nothing else.


---

Comment by embray created at 2017-04-24 12:35:30

New commits:


---

Comment by embray created at 2017-04-24 12:35:30

Changing keywords from "libhomfly" to "libhomfly cygwin".


---

Comment by embray created at 2017-04-24 12:35:30

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-04-24 14:18:29

I install libhomfly as part of my usual optional packages, so that is my interest.

The library built okay for me too, but the problem (for me) comes from when you try to run `sage -b` to build the necessary Cython bindings. Did you also try this too? I also didn't change any libtool settings, so I doubt that is the problem.

Miguel, would you merge this upstream (provided it builds on your systems too)?


---

Comment by embray created at 2017-04-24 14:21:37

The patch should probably fix it.  The reason linking failed for you was that libhomfly was only being built as a static library.


---

Comment by embray created at 2017-04-24 14:27:54

I re-ran `./sage -b` after installing libhomfly and successfully ran what appeared to be the most relevant tests:


```
$ ./sage -t --long src/sage/knots/ src/sage/libs/homfly.pyx
Running doctests with ID 2017-04-24-16-26-16-363ee458.
Git branch: u/embray/develop-cygwin
Using --optional=atlas,ccache,libhomfly,mpir,python2,sage
Doctesting 5 files.
sage -t --long --warn-long 177.9 src/sage/knots/all.py
    [0 tests, 0.00 s]
sage -t --long --warn-long 177.9 src/sage/knots/knot.py
    [42 tests, 14.08 s]
sage -t --long --warn-long 177.9 src/sage/knots/link.py
    [407 tests, 21.00 s]
sage -t --long --warn-long 177.9 src/sage/knots/__init__.py
    [0 tests, 0.00 s]
sage -t --long --warn-long 177.9 src/sage/libs/homfly.pyx
    [6 tests, 1.77 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 38.3 seconds
    cpu time: 28.2 seconds
    cumulative wall time: 36.9 seconds
```



---

Comment by tscrim created at 2017-04-24 14:30:43

Thanks. I'm building the `8.0.beta3` right now, and this is my next test afterwards.


---

Comment by mmarco created at 2017-04-24 18:58:40

I could apply the patch upstream and make a new release (so we would need to update the libhomfly version in Sage). But I don't have a windows machine to test it on.

Another option is to just apply Eric's patch in Sage's install script.

What option do you think would be better?


---

Comment by tscrim created at 2017-04-24 19:02:46

I think it would be better to make this a version bump of libhomfly. Erik has tested it on Cygwin, and I am in the process of testing it (since I've gone to beta3, I'm stuck at Python3). So if it works on Linux (which I can test) and/or OSX (which I would be surprised if it didn't), then version bump is definitely the way to go IMO.


---

Comment by embray created at 2017-04-25 07:45:08

Yes, an upstream fix would be best.


---

Comment by mmarco created at 2017-04-25 08:06:15

Can you please check that this tarball:

https://riemann.unizar.es/~mmarco/libhomfly-1.0r2.tar.gz

builds correctly and passes the `make check` test?


---

Comment by tscrim created at 2017-04-25 13:30:18

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-04-25 13:30:18

I've checked on Linux. I'm still fighting the 8.0.beta3 build on Cygwin, but since it built for Erik, I'm setting a positive review.
----
New commits:


---

Comment by tscrim created at 2017-04-25 13:30:43

Correction, once someone checks my changes, then it can be set to positive review.


---

Comment by tscrim created at 2017-04-25 13:30:43

Changing status from positive_review to needs_review.


---

Comment by mmarco created at 2017-04-26 06:58:53

Everything seems ok on Linux. If it solves the problem in cygwin, set it to positive review.


---

Comment by embray created at 2017-04-26 08:11:26

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-04-26 15:51:11

Now I can (finally, thanks to Erik) confirm this works on my cygwin as well.


---

Comment by vbraun created at 2017-04-28 23:55:00

Resolution: fixed
