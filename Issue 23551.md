# Issue 23551: cython doesn't install in debug build of Python 3

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-09-06 08:32:26

With `SAGE_PYTHON3=yes`, I ran


```
SAGE_DEBUG=yes ./sage -f python3
```


and now when I try to rebuild Cython on top of that with


```
SAGE_DEBUG=yes ./sage -f cython
```


I get


```
[cython-0.26] gcc version 4.8.4 (Ubuntu 4.8.4-2ubuntu1~14.04.3)
[cython-0.26] ****************************************************
[cython-0.26] Unable to find pgen, not compiling formal grammar.
[cython-0.26] Uninstalling Cython-0.26:
[cython-0.26]   Successfully uninstalled Cython-0.26
[cython-0.26] sys:1: ResourceWarning: unclosed file <_io.TextIOWrapper name='/home/embray/src/sagemath/sage/local/var/lock/pip3.lock' mode='w+' encoding='ANSI_X3.4-1968'>
[cython-0.26] Cannot uninstall requirement Cython, not installed
[cython-0.26] sys:1: ResourceWarning: unclosed file <_io.TextIOWrapper name='/home/embray/src/sagemath/sage/local/var/lock/pip3.lock' mode='w+' encoding='ANSI_X3.4-1968'>
[cython-0.26] Error installing Cython
```


Same if I try reinstalling Cython with `SAGE_DEBUG=no`.  Just to be sure I rebuild python3 without debug, and was able to install Cython again with no problem, so it really seems to be something about the specific combination of `SAGE_DEBUG=yes` and python3.




---

Comment by embray created at 2017-09-06 08:40:22

I think this is some bad combination of hacky code (that I wrote) IIRC in `sage-pip-install`, `pip-lock`, and Python 3 with debug flags and hence more chatty with `ResourceWarning`s.


---

Comment by embray created at 2017-09-06 08:47:02

#23397, which rewrote the pip-lock command, appears to fix this. The new `sage-flock` script doesn't have the resource leak (actually it sort of does but Python doesn't complain about it since that version of the script uses exec, anyways it doesn't matter). So if that gets merged we can close this ticket as fixed.


---

Comment by embray created at 2017-09-06 08:49:54

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-11-04 08:12:55

can we close this one now that #23397 is on the way ?


---

Comment by embray created at 2017-11-06 09:53:11

Yes, thank you for reminding me.


---

Comment by embray created at 2017-11-06 09:53:11

Resolution: worksforme
