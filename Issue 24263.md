# Issue 24263: Optimize Action.__call__

Issue created by migration from https://trac.sagemath.org/ticket/24500

Original creator: jdemeyer

Original creation time: 2018-01-09 14:54:23

CC:  vdelecroix tscrim

Work on #24247 shows that a significant amount of time is spent in `Action.__call__`. This should be optimized.


---

Comment by git created at 2018-01-30 13:53:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-30 13:57:01

Changing component from performance to coercion.


---

Comment by jdemeyer created at 2018-01-30 13:57:01

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-01-30 19:00:02

Do you have timings with this ticket (at least, my understanding of the description is the "after" does not include this ticket)?


---

Comment by jdemeyer created at 2018-01-30 19:04:20

Replying to [comment:9 tscrim]:
> Do you have timings with this ticket (at least, my understanding of the description is the "after" does not include this ticket)?

The "after" does include this ticket.


---

Comment by mmezzarobba created at 2018-01-31 15:49:44

Replying to [comment:10 jdemeyer]:
> The "after" does include this ticket.

Did you invert the “before” and “after” parts then?


---

Comment by jdemeyer created at 2018-01-31 15:57:44

Replying to [comment:12 mmezzarobba]:
> Did you invert the “before” and “after” parts then?

No, I did not...


---

Comment by tscrim created at 2018-02-08 21:08:50

On 8.2.beta4:

```
sage: k.<a> = GF(4, impl="ntl"); n = 2; timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 343 ns per loop
sage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 137 ns per loop
sage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7.62 µs per loop
sage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7 µs per loop
```

vs with #5574:

```
sage: k.<a> = GF(4, impl="ntl"); n = 2; timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 341 ns per loop
sage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 139 ns per loop
sage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7.71 µs per loop
sage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 8.75 µs per loop
```

vs with #24500:

```
sage: k.<a> = GF(4, impl="ntl"); n = 2; timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 356 ns per loop
sage: a = RDF(2); n = ZZ(2); timeit('a ^ n', number=100000, repeat=20)
100000 loops, best of 20: 141 ns per loop
sage: a = ZZ.ideal(2); n = ZZ(2); timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 7.53 µs per loop
sage: a = AA(8); n = 1/3; timeit('a ^ n', number=10000, repeat=20)
10000 loops, best of 20: 8.91 µs per loop
```


So I can explain why the first test is slower: there is an additional `if action._is_left` that is needed to be performed that previously was not there because powering could assume things in a specific order. The last one slowing down is due to #5574 (and some numerical noise). The middle two are almost identical (at least within the numerical noise I was getting), which is expected considering they perform the same number of checks in Cython.

However, I did get an improvement when something was calling `is_left()` in Python:

```
sage: from brial import BooleanMonomialMonoid
sage: P.<x,y,z> = BooleanPolynomialRing(3)
sage: M = BooleanMonomialMonoid(P)
sage: x = M(x); xy = M(x*y); z=M(z); n=2
sage: timeit('x * n', number=10000, repeat=20)
10000 loops, best of 20: 6.52 µs per loop
sage: timeit('n * x', number=10000, repeat=20)
10000 loops, best of 20: 6.43 µs per loop
```

vs with #24500

```
sage: timeit('n * x', number=10000, repeat=20)
10000 loops, best of 20: 6.14 µs per loop
sage: timeit('x * n', number=10000, repeat=20)
10000 loops, best of 20: 6.17 µs per loop
```


So my conclusion is this ticket does do a little bit of optimizing in certain cases and a regression in others. My current inclination is to give this ticket a positive review because it makes the action interface more clean by removing some of the implementation burden (i.e., deciding which input is which type). Do you agree with my assessment? Anyone else have any objections?


---

Comment by jdemeyer created at 2018-03-08 09:35:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-03-08 09:38:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-08 09:39:00

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-08 09:47:20

Many failing tests involving valuations...


---

Comment by jdemeyer created at 2018-03-08 09:47:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-03-08 10:02:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-08 10:02:34

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-04-06 08:04:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-04-06 09:48:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-04-06 09:50:00

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-04-06 12:34:39

Part of the slowdown in this ticket was caused by the second commit removing `Set_PythonType`. I'll drop that commit, then the regressions are gone for me.


---

Comment by git created at 2018-04-06 12:35:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-11-26 11:41:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-11-27 02:44:20

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-11-27 02:44:20

LGTM. Sorry I let this ticket fall off my radar.


---

Comment by vbraun created at 2018-11-29 08:13:34

Resolution: fixed
