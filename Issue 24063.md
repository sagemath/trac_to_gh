# Issue 24063: Computation of modular form Hecke matrices is very inefficient

archive/issues_024063.json:
```json
{
    "body": "In order to compute the matrix of T(p) on a modular forms space, we currently compute a q-expansion basis of the space (using modular symbols) up to high enough precision that T(p) can be read off from the q-expansions. If the space is at all large, then we will need huge numbers of q-expansion coefficients to do things this way: to compute T(p) on modular forms, this algorithm will trigger computation of T(r) on modular symbols for all primes r up to about p * (Sturm bound for the space), which is very, very slow. For instance, this computation takes a whole 21 seconds:\n\n```\nsage: C=CuspForms(105, 2)\nsage: time C.hecke_matrix(17)\nCPU times: user 21 s, sys: 327 ms, total: 21.3 s\nWall time: 21.3 s\n\n[ 1/3  2/3 -1/3   ...\n```\n\nIf you run this with `set_verbose(1)`, you see that along the way it computes Hecke matrices on `C.ambient().modular_symbols(sign=1)` for all primes up to 457!\n\nThis is trivially fixable by being more intelligent about how we compute Hecke matrices; the following code computes T(2003) in only about half a second:\n\n```\nsage: A = C.modular_symbols(sign=1)\nsage: time sage.modular.modform.cuspidal_submodule._convert_matrix_from_modsyms(A, A.hecke_matrix(2003))[0]\nCPU times: user 635 ms, sys: 16.5 ms, total: 652 ms\nWall time: 632 ms\n\n[  10/3    -28 -155/3  380/3 ...\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24300\n\n",
    "created_at": "2017-11-29T20:00:33Z",
    "labels": [
        "modular forms",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Computation of modular form Hecke matrices is very inefficient",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24063",
    "user": "davidloeffler"
}
```
In order to compute the matrix of T(p) on a modular forms space, we currently compute a q-expansion basis of the space (using modular symbols) up to high enough precision that T(p) can be read off from the q-expansions. If the space is at all large, then we will need huge numbers of q-expansion coefficients to do things this way: to compute T(p) on modular forms, this algorithm will trigger computation of T(r) on modular symbols for all primes r up to about p * (Sturm bound for the space), which is very, very slow. For instance, this computation takes a whole 21 seconds:

```
sage: C=CuspForms(105, 2)
sage: time C.hecke_matrix(17)
CPU times: user 21 s, sys: 327 ms, total: 21.3 s
Wall time: 21.3 s

[ 1/3  2/3 -1/3   ...
```

If you run this with `set_verbose(1)`, you see that along the way it computes Hecke matrices on `C.ambient().modular_symbols(sign=1)` for all primes up to 457!

This is trivially fixable by being more intelligent about how we compute Hecke matrices; the following code computes T(2003) in only about half a second:

```
sage: A = C.modular_symbols(sign=1)
sage: time sage.modular.modform.cuspidal_submodule._convert_matrix_from_modsyms(A, A.hecke_matrix(2003))[0]
CPU times: user 635 ms, sys: 16.5 ms, total: 652 ms
Wall time: 632 ms

[  10/3    -28 -155/3  380/3 ...
```


Issue created by migration from https://trac.sagemath.org/ticket/24300





---

archive/issue_comments_337237.json:
```json
{
    "body": "I've uploaded a branch which fixes both this and #21546.\n----\nNew commits:",
    "created_at": "2017-12-01T14:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337237",
    "user": "davidloeffler"
}
```

I've uploaded a branch which fixes both this and #21546.
----
New commits:



---

archive/issue_comments_337238.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-01T14:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337238",
    "user": "davidloeffler"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_337239.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-02T10:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337239",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337240.json:
```json
{
    "body": "I just pushed a one-byte docstring formatting change, to keep the patchbot ReST syntax checker happy",
    "created_at": "2017-12-02T10:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337240",
    "user": "davidloeffler"
}
```

I just pushed a one-byte docstring formatting change, to keep the patchbot ReST syntax checker happy



---

archive/issue_comments_337241.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-12-02T16:32:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337241",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_337242.json:
```json
{
    "body": "Unfortunately the branch I had previously uploaded had conflicts with other tickets that already have positive review. I've now hand-merged those into the ticket branch.",
    "created_at": "2017-12-02T16:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337242",
    "user": "davidloeffler"
}
```

Unfortunately the branch I had previously uploaded had conflicts with other tickets that already have positive review. I've now hand-merged those into the ticket branch.



---

archive/issue_comments_337243.json:
```json
{
    "body": "Despite my best efforts, my branch still wouldn't merge with 8.2.beta0 so here is yet another new branch. No change to the actual code, still needs review.\n----\nNew commits:",
    "created_at": "2017-12-14T13:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337243",
    "user": "davidloeffler"
}
```

Despite my best efforts, my branch still wouldn't merge with 8.2.beta0 so here is yet another new branch. No change to the actual code, still needs review.
----
New commits:



---

archive/issue_comments_337244.json:
```json
{
    "body": "For documentation and cross check purposes could you add\n\n```\nsage: ModularForms(17,4).hecke_matrix(2).charpoly()\nx^6 - 16*x^5 + 18*x^4 + 608*x^3 - 1371*x^2 - 4968*x + 7776\n```\n\nto the documentation of `hecke_polynomial`?",
    "created_at": "2017-12-21T16:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337244",
    "user": "vdelecroix"
}
```

For documentation and cross check purposes could you add

```
sage: ModularForms(17,4).hecke_matrix(2).charpoly()
x^6 - 16*x^5 + 18*x^4 + 608*x^3 - 1371*x^2 - 4968*x + 7776
```

to the documentation of `hecke_polynomial`?



---

archive/issue_comments_337245.json:
```json
{
    "body": "and similarly in the cuspidal submodule?",
    "created_at": "2017-12-21T16:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337245",
    "user": "vdelecroix"
}
```

and similarly in the cuspidal submodule?



---

archive/issue_comments_337246.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-12-21T18:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337246",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_337247.json:
```json
{
    "body": "Et voil\u00e0.",
    "created_at": "2017-12-21T18:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337247",
    "user": "davidloeffler"
}
```

Et voil√†.



---

archive/issue_comments_337248.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-12-22T07:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337248",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_337249.json:
```json
{
    "body": "Thanks for the review! Can you also mark #21546 as positive review, if you agree that this code fixes that bug as well?",
    "created_at": "2017-12-22T09:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337249",
    "user": "davidloeffler"
}
```

Thanks for the review! Can you also mark #21546 as positive review, if you agree that this code fixes that bug as well?



---

archive/issue_comments_337250.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-25T18:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24063",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24063#issuecomment-337250",
    "user": "vbraun"
}
```

Resolution: fixed
