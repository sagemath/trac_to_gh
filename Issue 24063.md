# Issue 24063: Computation of modular form Hecke matrices is very inefficient

Issue created by migration from https://trac.sagemath.org/ticket/24300

Original creator: davidloeffler

Original creation time: 2017-11-29 20:00:33

In order to compute the matrix of T(p) on a modular forms space, we currently compute a q-expansion basis of the space (using modular symbols) up to high enough precision that T(p) can be read off from the q-expansions. If the space is at all large, then we will need huge numbers of q-expansion coefficients to do things this way: to compute T(p) on modular forms, this algorithm will trigger computation of T(r) on modular symbols for all primes r up to about p * (Sturm bound for the space), which is very, very slow. For instance, this computation takes a whole 21 seconds:

```
sage: C=CuspForms(105, 2)
sage: time C.hecke_matrix(17)
CPU times: user 21 s, sys: 327 ms, total: 21.3 s
Wall time: 21.3 s

[ 1/3  2/3 -1/3   ...
```

If you run this with `set_verbose(1)`, you see that along the way it computes Hecke matrices on `C.ambient().modular_symbols(sign=1)` for all primes up to 457!

This is trivially fixable by being more intelligent about how we compute Hecke matrices; the following code computes T(2003) in only about half a second:

```
sage: A = C.modular_symbols(sign=1)
sage: time sage.modular.modform.cuspidal_submodule._convert_matrix_from_modsyms(A, A.hecke_matrix(2003))[0]
CPU times: user 635 ms, sys: 16.5 ms, total: 652 ms
Wall time: 632 ms

[  10/3    -28 -155/3  380/3 ...
```



---

Comment by davidloeffler created at 2017-12-01 14:00:39

I've uploaded a branch which fixes both this and #21546.
----
New commits:


---

Comment by davidloeffler created at 2017-12-01 14:00:50

Changing status from new to needs_review.


---

Comment by git created at 2017-12-02 10:42:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2017-12-02 10:44:06

I just pushed a one-byte docstring formatting change, to keep the patchbot ReST syntax checker happy


---

Comment by git created at 2017-12-02 16:32:10

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by davidloeffler created at 2017-12-02 16:35:09

Unfortunately the branch I had previously uploaded had conflicts with other tickets that already have positive review. I've now hand-merged those into the ticket branch.


---

Comment by davidloeffler created at 2017-12-14 13:36:33

Despite my best efforts, my branch still wouldn't merge with 8.2.beta0 so here is yet another new branch. No change to the actual code, still needs review.
----
New commits:


---

Comment by vdelecroix created at 2017-12-21 16:46:49

For documentation and cross check purposes could you add

```
sage: ModularForms(17,4).hecke_matrix(2).charpoly()
x^6 - 16*x^5 + 18*x^4 + 608*x^3 - 1371*x^2 - 4968*x + 7776
```

to the documentation of `hecke_polynomial`?


---

Comment by vdelecroix created at 2017-12-21 16:48:19

and similarly in the cuspidal submodule?


---

Comment by git created at 2017-12-21 18:35:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2017-12-21 18:36:46

Et voil√†.


---

Comment by vdelecroix created at 2017-12-22 07:18:50

Changing status from needs_review to positive_review.


---

Comment by davidloeffler created at 2017-12-22 09:36:09

Thanks for the review! Can you also mark #21546 as positive review, if you agree that this code fixes that bug as well?


---

Comment by vbraun created at 2017-12-25 18:21:44

Resolution: fixed
