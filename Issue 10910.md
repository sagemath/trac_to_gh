# Issue 10910: Update eclib to 201103??

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2011-03-23 04:44:36

Assignee: tbd

CC:  fbissey fschulze

Keywords: elliptic curves

eclib has changed a lot since the last upgrade, mostly in parts which do not affect Sage much, but there are exceptions, for example the handling of bounds in saturation for elliptic curves over Q (see #10840).

I plan to make a new version of the spkg and will post a link here when done.


---

Comment by cremona created at 2011-05-18 13:55:53

Changing priority from minor to major.


---

Comment by cremona created at 2011-05-18 13:55:53

Changing assignee from tbd to cremona.


---

Comment by cremona created at 2011-05-18 13:58:01

Changing status from new to needs_review.


---

Comment by cremona created at 2011-12-18 16:07:35

Working on this at Sage Days 35 (18 Dec 2011) -- will be ready for review soon.


---

Comment by cremona created at 2011-12-18 16:07:35

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2011-12-18 16:45:38

Ready for review.  Thanks to Simon King and Paul Zimmermann for help adding the ldconfig line to the spkg-install script, which was necessary after Giovanni Mascellani <mascellani`@`poisson.phc.unipi.it> added the SONAME lines to my Makefiles.


---

Comment by cremona created at 2011-12-18 16:45:38

Changing status from needs_work to needs_review.


---

Comment by fschulze created at 2011-12-19 11:09:45

I tested with sage-4.8.alpha4. The patche applies fine,
the new spkg builds and passes it's own testsuit,
all doctests pass


---

Comment by fschulze created at 2011-12-19 11:09:45

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-01-09 23:09:36

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-01-09 23:09:36

I'm afraid this needs to be rebased to #11354.


---

Comment by cremona created at 2012-01-10 10:12:25

Replying to [comment:10 jdemeyer]:
> I'm afraid this needs to be rebased to #11354.

OK, I will do that -- and at teh same time update the source since I have made some more changes since 2011-12-17.


---

Comment by cremona created at 2012-01-15 21:30:43

I have updated the new spkg which is now called eclib-20120115.spkg and is based on the actual latest existing spkg which has existed since #11354.  The patch to the Sage library did not need to change.  So the instructions remain the same, apart from the new spkg name.


---

Comment by cremona created at 2012-01-15 21:30:43

Changing status from needs_work to needs_review.


---

Comment by fschulze created at 2012-01-16 21:54:49

Looks fine. Tested with sage-4.8.alpha6. The patch still applies and new spkg builds and passes it's own testsuit. All (long) doctests pass.


---

Comment by fschulze created at 2012-01-16 21:54:49

Changing status from needs_review to positive_review.


---

Comment by fschulze created at 2012-01-16 21:56:57

Replying to [comment:13 fschulze]:
> Looks fine. Tested with sage-4.8.alpha6. The patch still applies and new spkg builds and passes it's own testsuit. All (long) doctests pass.

Also #11354 is taken into account in the new spkg.


---

Comment by cremona created at 2012-01-16 22:06:51

Replying to [comment:14 fschulze]:
> Replying to [comment:13 fschulze]:
> > Looks fine. Tested with sage-4.8.alpha6. The patch still applies and new spkg builds and passes it's own testsuit. All (long) doctests pass.
> 
> Also #11354 is taken into account in the new spkg.

Thanks for the quick re-review!


---

Comment by jdemeyer created at 2012-01-16 22:19:04

Made all files in the spkg world-readable.


---

Comment by jdemeyer created at 2012-01-17 08:16:01

What's `ldconfig` supposed to do?  The line in SPKG.txt

```
Add a line in spkg-install to run ldconfig
```

isn't very clear :-)

Anyway, the build fails on my Gentoo Linux system because I don't have `ldconfig`:

```
[...]
g++ -c -fPIC -g -O3 -DNEW_OP_ORDER -DUSE_PARI_FACTORING  -I../include -DNTL_ALL  -I/usr/local/src/sage-4.8.alpha6/local/include -I/usr/local/src/sage-4.8.alpha6/local/include -DMETHOD=2 -DUSE_XSPLIT  oftest.cc -o oftest_n.o
g++ -o oftest oftest_n.o symb_n.o moddata_n.o oldforms_n.o homspace_n.o newforms_n.o  cusp_n.o periods_n.o  -lcurvesntl -ljcntl -L../lib -lpari -L/usr/local/src/sage-4.8.alpha6/local/lib -L/usr/local/src/sage-4.8.alpha6/local/lib -lntl -lgmp -lpari  -lm
make[1]: Nothing to be done for `progs'.
make[1]: Leaving directory `/usr/local/src/sage-4.8.alpha6/spkg/build/eclib-20120115/src/g0n'
./spkg-install: line 64: ldconfig: command not found
Error copying over libraries
```



---

Comment by jdemeyer created at 2012-01-17 08:16:01

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-01-17 08:19:52

I just discovered that I *do* have `ldconfig` in `/sbin/ldconfig`.  But that directory (system binaries) makes me nervous, something that Sage probably shouldn't mess with.


---

Comment by fschulze created at 2012-01-17 09:00:14

I thought we can assume ldconfig is installed like we have to assume that ld is installed (grep ldconfig in install.log).

The '-n' flag in spkg-install tells ldconfig to ignore the libraries in /usr/lib/ etc. and only process '$SAGE_LOCAL"/lib/'. Maybe another flag would be needed to ignore /etc/ld.so.conf too, but this did't give an error for me.


---

Comment by fschulze created at 2012-01-17 09:10:44

Replying to [comment:19 fschulze]:
> The '-n' flag in spkg-install tells ldconfig to ignore the libraries in /usr/lib/ etc. and only process '$SAGE_LOCAL"/lib/'. Maybe another flag would be needed to ignore /etc/ld.so.conf too, but this did't give an error for me.
> 

-N is the flag for ldconfig to only create links to the correct shared libraries and not update /etc/ld.so.conf.


---

Comment by fschulze created at 2012-01-17 09:19:36

I looked at an install.log again.
  PATH="$PATH:/sbin" ldconfig -n $SAGE_LOCAL/local/lib
seems to be a common pattern that is used by pynac, libsqlite, mpir and many other packages that install shared libraries.


---

Comment by fschulze created at 2012-01-17 09:55:04

Replying to [comment:21 fschulze]:
> 
In the case of libraries using configure/autoconf the above line is a part of 'make install' and not in the spkg-install. As eclib doesn't use configure it makes sense to put it in the spkg-install. In eclib's Makefile it would be harder to automatically distinguish between Darwin, Cygwin, etc.


---

Comment by cremona created at 2012-01-17 10:26:28

Thanks for the helpful comments.  I should have explained better why I inserted the ldconfig line.  Simply, nothing worked without it; and the difference from previous versions of eclib is that the Makefiles now create shared libraries, after which it is essential to use ldconfig, or the binaries simply do not work.

I hope we can leave this as it is (or similar).  If not, I would just remove the shared libraries (which were an addition to eclib not put in by me).

If we can leave the ldconfig in, please return this to Positive Review!


---

Comment by fschulze created at 2012-01-17 10:56:31

I believe using ldconfig is ok. But one has to make sure that /sbin is in $PATH before calling ldconfig. Otherwise installing the package will fail on systems like Gentoo Linux where ldconfig is in /sbin and this directory is not in $PATH by default. Suse Linux systems also have such a configuration.


---

Comment by cremona created at 2012-01-17 13:48:26

Replying to [comment:24 fschulze]:
> I believe using ldconfig is ok. But one has to make sure that /sbin is in $PATH before calling ldconfig. Otherwise installing the package will fail on systems like Gentoo Linux where ldconfig is in /sbin and this directory is not in $PATH by default. Suse Linux systems also have such a configuration.
> 
OK, so that line needs to be changed to

```
PATH="$PATH:/sbin" ldconfig -n $SAGE_LOCAL/local/lib
```

as in other spkgs.  I'll make that change.


---

Comment by cremona created at 2012-01-17 14:34:27

Replying to [comment:25 cremona]:
> Replying to [comment:24 fschulze]:
> > I believe using ldconfig is ok. But one has to make sure that /sbin is in $PATH before calling ldconfig. Otherwise installing the package will fail on systems like Gentoo Linux where ldconfig is in /sbin and this directory is not in $PATH by default. Suse Linux systems also have such a configuration.
> > 
> OK, so that line needs to be changed to
> {{{
> PATH="$PATH:/sbin" ldconfig -n $SAGE_LOCAL/local/lib
> }}}
> as in other spkgs.  I'll make that change.

That should be $SAGE_LOCAL/lib  -- 30 minutes wasted tracking down why the ldconfig was having no effect!


---

Comment by cremona created at 2012-01-17 14:44:48

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2012-01-17 14:44:48

OK, I have (eventually) made that change to spkg-install and a new spkg (with suffix .p0) is available.  The line 

```
ldconfig -n $SAGE_LOCAL/lib
```

has been changed to

```
PATH="$PATH:/sbin" ldconfig -n $SAGE_LOCAL/lib
```



---

Comment by fschulze created at 2012-01-17 18:30:22

John, the new spkg in your ftp directory gives a 403 Forbidden error. Could you change the rights to this file?

Did you take into account the changes Jeroen did't to the eclib-20120115.spkg? His comment above was "Made all files in the spkg world-readable."

[http://boxen.math.washington.edu/home/jdemeyer/spkg/eclib-20120115.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/eclib-20120115.spkg)


---

Comment by jdemeyer created at 2012-01-18 11:13:33

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2012-01-18 12:55:06

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2012-01-18 12:55:06

Replying to [comment:29 jdemeyer]:
Sorry -- I have fixed the permissions now.


---

Comment by jdemeyer created at 2012-01-18 16:16:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-01-18 16:16:12

Small but important issue: you should edit the Changelog in SPKG.txt to mention the new spkg and this ticket number.


---

Comment by cremona created at 2012-01-18 16:40:22

Replying to [comment:31 jdemeyer]:
> Small but important issue: you should edit the Changelog in SPKG.txt to mention the new spkg and this ticket number.

OK, will do.  Can I still call it p0 or would that be p1?!


---

Comment by jdemeyer created at 2012-01-18 16:42:47

Replying to [comment:32 cremona]:
> Replying to [comment:31 jdemeyer]:
> > Small but important issue: you should edit the Changelog in SPKG.txt to mention the new spkg and this ticket number.
> 
> OK, will do.  Can I still call it p0 or would that be p1?!
I think p0 is fine.  But whatever you do, make sure the version number of the spkg and the version number in SPKG.txt match.


---

Comment by cremona created at 2012-01-18 16:46:11

Replying to [comment:32 cremona]:
> Replying to [comment:31 jdemeyer]:
> > Small but important issue: you should edit the Changelog in SPKG.txt to mention the new spkg and this ticket number.
> 
> OK, will do.  Can I still call it p0 or would that be p1?!

I have replaced the p0 spkg with a new one (still called p0) with the suggested additions to SPKG.txt.


---

Comment by cremona created at 2012-01-18 16:46:11

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-01-19 20:40:02

The permissions are bad again, you should do the following from the root directory of the spkg:

```
chmod ugo+rX -R .
```

and repack the spkg.


---

Comment by jdemeyer created at 2012-01-19 20:40:02

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2012-01-19 21:32:13

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2012-01-19 21:32:13

Replying to [comment:35 jdemeyer]:
> The permissions are bad again, you should do the following from the root directory of the spkg:
> {{{
> chmod ugo+rX -R .
> }}}
> and repack the spkg.

OK, I did that.  Funny, I don't remember permissions within the spkg  being a problem in the past.


---

Comment by jdemeyer created at 2012-01-20 22:59:06

All the technicalities I complained about seem fixed.  With the earlier positive_review, this gives an overall positive_review.


---

Comment by jdemeyer created at 2012-01-20 22:59:06

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-01-29 11:17:28

Resolution: fixed


---

Comment by jdemeyer created at 2012-01-31 20:14:43

Changing status from closed to new.


---

Comment by jdemeyer created at 2012-01-31 20:14:43

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2012-01-31 20:14:43

I found a race condition in the eclib installer:
at various places you have things like

```
chmod og+r *
```


The problem is that some temporary file might be caught by the "*" which is removed by the time `chmod` tries to access it.  It is hard to reproduce, but the following happened once:


```
cd qrank && make lib install
make[3]: Entering directory `/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/spkg/build/eclib-20120115.p0/src/qrank'
Makefile:81: warning: overriding commands for target `clean'
../Makefile:77: warning: ignoring old commands for target `clean'
Makefile:121: warning: overriding commands for target `veryclean'
../Makefile:86: warning: ignoring old commands for target `veryclean'
Makefile:125: warning: overriding commands for target `check'
../Makefile:98: warning: ignoring old commands for target `check'
g++ -c -fPIC -g -O3 -DNEW_OP_ORDER -DUSE_PARI_FACTORING -I../include -DNTL_ALL -I/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/local/include -I/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/local/include  mrank1.cc -o mrank1_n.o
[...]
g++ -c -fPIC -g -O3 -DNEW_OP_ORDER -DUSE_PARI_FACTORING -I../include -DNTL_ALL -I/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/local/include -I/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/local/include  ratpoint.cc -o ratpoint_n.o
g++ -o ratpoint version_n.o ratpoint_n.o mquartic_n.o mlocsol_n.o mglobsol_n.o \
	 qc_n.o  -L../lib -lcurvesntl -ljcntl -lpari -L/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/local/lib -L/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/local/lib -lntl -L../lib -lgmp  -lpari  -lpari -lm 
rm -f librankntl.a
ar r librankntl.a mrank1_n.o mrank2_n.o mequiv_n.o mquartic_n.o mlocsol_n.o mglobsol_n.o  qc_n.o sqfdiv_n.o desc2_n.o transform_n.o minim_n.o reduce_n.o bitspace_n.o GetOpt_n.o twoadic_n.o descent_n.o
ar: creating librankntl.a
chmod og+r *
ranlib librankntl.a
chmod: cannot access `stXXXXPjrrN2': No such file or directory
make[3]: *** [mwrank] Error 1
(cd ../include; rm -f mrank2.h mequiv.h mlocsol.h mglobsol.h msoluble.h mquartic.h mrank1.h qc.h sqfdiv.h version.h minim.h reduce.h transform.h desc2.h bitspace.h options.h GetOpt.h twoadic.h descent.h)
for f in mrank2.h mequiv.h mlocsol.h mglobsol.h msoluble.h mquartic.h mrank1.h qc.h sqfdiv.h version.h minim.h reduce.h transform.h desc2.h bitspace.h options.h GetOpt.h twoadic.h descent.h; \
	 do cp ${f} ../include; \
	done
chmod a+r ../include/*
rm -f ../lib/librankntl.a
cp librankntl.a ../lib
chmod a+rx ../lib/librankntl.a
make[3]: Target `install' not remade because of errors.
make[3]: Leaving directory `/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/spkg/build/eclib-20120115.p0/src/qrank'
make[2]: *** [all] Error 2
make[2]: Leaving directory `/home/buildbot/build/sage/rosemary-1/rosemary_full/build/sage-5.0.beta2/spkg/build/eclib-20120115.p0/src'
Error building eclib
```


I believe the easiest solution is to prepend a "-" to the make command which means: ignore errors.  Concretely: replace

```
chmod og+r *
```

by

```
-chmod og+r *
```

(of course, similarly for other "chmod" invocations)

Unrelated: why do you have "/bin/rm" at several places as opposed to simply "rm"?


---

Comment by jdemeyer created at 2012-01-31 22:57:52

Another problem: your `src/Makefile` seems to assume GNU ld:

```
# Used for creating a shared library on Linux/Unix
SO_OPTS = -fPIC --shared -Wl,--as-needed
```

It therefore breaks on `hawk (OpenSolaris 06.2009-32)`:

```
g++ -fPIC --shared -Wl,--as-needed -Wl,-soname,libjcntl.so.0 [...] -o libjcntl.so [...]
usage: ld [-3:6:abc:d:e:f:h:il:mo:p:rstu:z:B:CD:F:GI:L:M:N:P:Q:R:S:VW:Y:?] file(s)
[...]
collect2: ld returned 1 exit status
make[3]: *** [libjcntl.so] Error 1
make[3]: Target `install_so' not remade because of errors.
make[3]: Leaving directory `/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta2/spkg/build/eclib-20120115.p0/src/procs'
make[2]: *** [so] Error 2
make[2]: Leaving directory `/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.0.beta2/spkg/build/eclib-20120115.p0/src'
Error building eclib shared libraries
```



---

Comment by cremona created at 2012-02-01 11:25:00

Oh misery, I'm a mathematician and should never have got into software distribution.  All these Makefiles originated as my own files in my own directories on my own computers building my programs for me.

I can fix the chmod thing.  I can see no reason now why they are there anyway.

I think I put /bin/rm because I have rm aliassed to "rm -i" in my .bashrc.  Sometimes I put in rm -f instead, and sometimes /bin/rm -f.  So I am not consistent.  Tough.

As for the ld stuff: you call it "my" src/makefile but this file was created by some people who first made an spkg out of my code, so don't blame me.  I don't understand shared libraries and am not going to learn now, so if people want eclib to work on other systems they will have to supply their own fix.  One day I will retire, and then who will fix things?


---

Comment by cremona created at 2012-02-01 13:05:09

I made a new patch version (p1) of the spkg after changing all the Makefiles (uploaded upstream too) as follows:

    1. Every /bin/rm changed to plain rm
    2. Every chmod considered, and either deleted or made more specific (so there are still some chmod *.h but none just chmod *).  This should deal with the race problem.

I have not made any changes to ld commands or options.  When someone has worked out what needs doing, please don't patch the current src within the spkg but rather tell me what the changes are so that I can carry them out "upstream" on the *official release* version of eclib at http://code.google.com/p/eclib/


---

Comment by cremona created at 2012-02-01 13:05:09

Changing status from new to needs_review.


---

Comment by cremona created at 2012-02-10 21:18:12

Would it work to fix the Makefile so that the SO_OPTS variable is only set if the system type as returned by uname is Linux?

I am out my depth here and frustrated that this necessary upgrade is being blocked because of one system which no-one (who needs eclib) uses.


---

Comment by drkirkby created at 2012-02-10 21:47:43

Changing status from needs_review to needs_work.


---

Comment by drkirkby created at 2012-02-10 21:47:43

Replying to [comment:39 jdemeyer]:
> I found a race condition in the eclib installer:
> at various places you have things like
> {{{
> chmod og+r *
> }}}

As I found out to my cost once, that sort of thing can be very dangerous, as ".." (i.e. the parent directory) is included in '*' too. So:


```
$ chown -R drkirkby *
```


made all files owned by me, including those of the parent directory, and all its sub-directories.


---

Comment by jdemeyer created at 2012-02-10 21:53:40

Replying to [comment:44 drkirkby]:
> As I found out to my cost once, that sort of thing can be very dangerous, as ".." (i.e. the parent directory) is included in '*' too.
Really?  I guess it's shell-specific.  My bash under Linux doesn't include any file starting with ".", so it excludes "." and "..".


---

Comment by drkirkby created at 2012-02-10 22:02:44

Replying to [comment:45 jdemeyer]:
> Replying to [comment:44 drkirkby]:
> > As I found out to my cost once, that sort of thing can be very dangerous, as ".." (i.e. the parent directory) is included in '*' too.
> Really?  I guess it's shell-specific.  My bash under Linux doesn't include any file starting with ".", so it excludes "." and "..".

Maybe I'm mistaken. I know causing a major headache at uni with that command. A junior system admin was not very Unix literate, so I told him what to type. But I made a mistake, which meant his typing caused havoc, as I became the owner of everyone's files!

Dave


---

Comment by drkirkby created at 2012-02-10 22:03:06

Replying to [comment:43 cremona]:
> Would it work to fix the Makefile so that the SO_OPTS variable is only set if the system type as returned by uname is Linux?
> 
> I am out my depth here and frustrated that this necessary upgrade is being blocked because of one system which no-one (who needs eclib) uses.


Note Solaris can be built using both the GNU and Sun linkers, so one needs to ensure the right flags for each. The assumption in Sage is that the first linker in the path is the one used for the compiler. That's not really very good, but that's how it is. 

The GNU linker options -shared and -soname, would need to be changed if the Sun linker is used on Solaris to -G and -h respectively, but left unchanged if the GNU linker was used. 

The '--as-needed' option can possibly be omitted on Solaris. I'd be a bit careful of using it on any platform actually. This page

http://www.gentoo.org/proj/en/qa/asneeded.xml

suggests it can be problematic and is not supported on gentoo. 

Dave


---

Comment by jdemeyer created at 2012-02-11 09:35:59

We could also use #12367 for this: it's a new script I wrote which can be used to check whether the compiler (on linker in this case) supports certain flags.


---

Comment by vbraun created at 2012-02-11 18:37:15

The `--as-needed` is a bit of an ugly cop-out if you can't be bothered to figure out which libraries you actually need. Its never wrong to remove it, the worst case scenarios is that you'll end up linking to too many libraries. The correct solution is to only specify the libraries that you actually need, of course. So I'm in favor of simply dropping all `--as-needed` occurrences.


---

Comment by cremona created at 2012-02-11 20:09:37

Thanks for the various comments.  I will delete the --as-needed flags, make a new version of the spkg, and hope that will keep everyone happy for a while.


---

Comment by cremona created at 2012-02-24 15:18:36

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2012-02-24 15:18:36

The p2 spkg has the --as-needed flag deleted.  If this one builds on the systems where it failed before this deserves a postive review.


---

Comment by jdemeyer created at 2012-02-24 16:03:52

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-02-24 16:03:52

It still fails on OpenSolaris because there is no `ldconfig`, with the same error message as [http://trac.sagemath.org/sage_trac/ticket/10993#comment:17](http://trac.sagemath.org/sage_trac/ticket/10993#comment:17)

Possible solution: replace the relevant code by

```sh
if [ "$UNAME" = "Darwin" ]; then
    cp -p lib/*.dylib "$SAGE_LOCAL"/lib/
elif [ "$UNAME" = "CYGWIN" ]; then
    cp -p lib/*.dll "$SAGE_LOCAL"/lib/
else
    cp -p lib/*.so "$SAGE_LOCAL"/lib/
fi
if [ $? -ne 0 ]; then
    echo >&2 "Error copying over libraries"
    exit 1
fi

# On some systems (on Linux at least), we need to run ldconfig.
# This will fail gracefully if there is no ldconfig.
PATH="$PATH:/sbin" ldconfig -n "$SAGE_LOCAL/lib" 2>/dev/null
```



---

Comment by jdemeyer created at 2012-02-24 16:12:12

Never mind, my solution probably doesn't work.


---

Comment by jdemeyer created at 2012-02-24 16:13:21

Instead of re-inventing the wheel, I think we should use `libtool`.


---

Comment by cremona created at 2012-02-24 17:51:41

Replying to [comment:54 jdemeyer]:
> Instead of re-inventing the wheel, I think we should use `libtool`.

In that case I will wait until someone (else) volunteers to rewrite my makefiles using libtool, and until then Sage will have to make do with very old and buggy eclib for ever.


---

Comment by vbraun created at 2012-02-24 23:07:37

To lay the ground for an autotools build system I made a repo clone here:

http://code.google.com/r/vbraunname-eclib-autotools/source/list

Right now ./configure accepts --with-ntl=<path> and --with-pari=<path> and it can build procs/tconic tleg rcubic lcubic. You have to start with something :-)


---

Comment by cremona created at 2012-02-25 12:22:07

Replying to [comment:56 vbraun]:
> To lay the ground for an autotools build system I made a repo clone here:
> 
> http://code.google.com/r/vbraunname-eclib-autotools/source/list
> 
> Right now ./configure accepts --with-ntl=<path> and --with-pari=<path> and it can build procs/tconic tleg rcubic lcubic. You have to start with something :-)

Your help is much appreciated. Someone once wrote an autoconfigure script for mwrank (for when I used to distribute that, pre-sage, now part of eclib).  I never understood it properly and it was nightmare to ever change.  More recently William himself (I think) fixed it but I ditched it altogether soon after eclib became part of Sage (the mwrank distribution had its own entirely independent Makefile, and did not divide the code into 4 subdirectories as with eclib).  I am certain that there is lots of crud in those makefiles since they were not rewritten from scratch for the distribution but just slightly trimmed from prehistoric makefiles which had evolved over many years.  It would be a good thing (I suppose) to do that rewriting; but certainly not before the end of term.


---

Comment by vbraun created at 2012-02-25 20:46:21

The configure.ac and m4 files are definitely not easy to write, essentially they are a mash-up of various languages and you can easily produce unimaginable horrors if you don't follow the docs closely. On the plus side, the only parts that actually change as you develop the code further are the Makefile.am files. Whenever you add another source file you just have to tell automake which binary it is for, and all the rest is done automatically. And the Makefile.am is really easy to use and maintain, for example http://code.google.com/r/vbraunname-eclib-autotools/source/browse/procs/Makefile.am is much clearer than any hand-written makefile could ever be.

Is there a list of which make targets are particularly important?


---

Comment by cremona created at 2012-02-26 16:33:56

Replying to [comment:58 vbraun]:
> The configure.ac and m4 files are definitely not easy to write, essentially they are a mash-up of various languages and you can easily produce unimaginable horrors if you don't follow the docs closely. On the plus side, the only parts that actually change as you develop the code further are the Makefile.am files. Whenever you add another source file you just have to tell automake which binary it is for, and all the rest is done automatically. And the Makefile.am is really easy to use and maintain, for example http://code.google.com/r/vbraunname-eclib-autotools/source/browse/procs/Makefile.am is much clearer than any hand-written makefile could ever be.
> 
> Is there a list of which make targets are particularly important?

In each of the 4 subdirectories it's important to make the lib target since these 4 libs (+headers) are what's needed to use the package.  Each lib target has sub-targets headers & objs where the latter are the compiled .o files which are made into a lib file using ar and ranlib.

Secondly, in each of the four there are some targets which make runnable programs, either test programs (target test) or useful ones (target progs).  Some of the latter look a bit like test files and vice versa;  the test ones are also built with "make check" which runs them on prepared inputs and compares the output, just as with a doctest in Sage.  Some of these progs are installed by Sage into SAGE_ROOT/local/bin, and the most important of those is mwrank (under qrank).

Bear in mind that these makefiles are not just for Sage, but for other users of eclib  (including and possible restricted entirely to: me!) so any changes to what is compiled and where things are put will create difficulties for me (but not serious ones, if there is a good reason).

Looking at the new Makefile you started, you'll also need to handle make progs, check, lib at least.  And if you tell me what to do I can help...


---

Comment by cremona created at 2012-04-04 14:14:18

For those listening to this ticket:  I have just finished reconfiguring the build system for eclib to use autotools, including libtool, with invaluabe help from Volker.  I do not yet have a replacement spkg, but that will follow.  And it had better work on more systems than my old hand-written makefiles, or I have just wasted a whole lot of time!


---

Comment by cremona created at 2012-04-05 14:05:47

Progress report.  There's a new version of eclib at http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-2012-04-04.tar.gz which uses autotools throughout in a completely new build system.

I have note yet rewritten the spkg, but will do that after the holiday (i.e. not starting until April 10).


---

Comment by leif created at 2012-04-15 10:30:05

Replying to [comment:61 cremona]:
> Progress report.  There's a new version of eclib at http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-2012-04-04.tar.gz which uses autotools throughout in a completely new build system.
> 
> I have note yet rewritten the spkg, but will do that after the holiday (i.e. not starting until April 10).

Looking forward to the new spkg... :P


---

Comment by leif created at 2012-04-15 11:39:31

For the record: I get the same build error with the new upstream tarball (outside Sage) as with our "current" eclib spkg *with GCC 4.7.0 on Solaris* [SPARC, 32-bit]:

```
...
Making all in libsrc
make[1]: Entering directory `/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/tmp/eclib-2012-04-14/libsrc'
/bin/bash ../libtool --tag=CXX   --mode=compile g++ -DPACKAGE_NAME=\"eclib\" -DPACKAGE_TARNAME=\"eclib\" -DPACKAGE_VERSION=\"2012-04-14\" -DPACKAGE_STRING=\"eclib\ 2012-04-14\" -DPACKAGE_BUGREPORT=\"john.cremona`@`gmail.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"eclib\" -DVERSION=\"2012-04-14\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_ALLOCA_H=1 -DHAVE_ALLOCA=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_UNISTD_H=1 -DHAVE__BOOL=1 -DHAVE_STDBOOL_H=1 -Drestrict=__restrict -DHAVE_MEMMOVE=1 -DHAVE_MEMSET=1 -DHAVE_STRCHR=1 -I.   -O3 -g -DHONORS_CPPFLAGS -I/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/include  -I/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/include -DNTL_ALL -DUSE_PARI_FACTORING -DMETHOD=2 -DNEW_OP_ORDER -O3 -g -fno-strict-aliasing -DHONORS_CXXFLAGS -MT unimod.lo -MD -MP -MF .deps/unimod.Tpo -c -o unimod.lo unimod.cc
libtool: compile:  g++ -DPACKAGE_NAME=\"eclib\" -DPACKAGE_TARNAME=\"eclib\" -DPACKAGE_VERSION=\"2012-04-14\" "-DPACKAGE_STRING=\"eclib 2012-04-14\"" -DPACKAGE_BUGREPORT=\"john.cremona`@`gmail.com\" -DPACKAGE_URL=\"\" -DPACKAGE=\"eclib\" -DVERSION=\"2012-04-14\" -DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1 -DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1 -DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DLT_OBJDIR=\".libs/\" -DHAVE_ALLOCA_H=1 -DHAVE_ALLOCA=1 -DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_UNISTD_H=1 -DHAVE__BOOL=1 -DHAVE_STDBOOL_H=1 -Drestrict=__restrict -DHAVE_MEMMOVE=1 -DHAVE_MEMSET=1 -DHAVE_STRCHR=1 -I. -O3 -g -DHONORS_CPPFLAGS -I/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/include -I/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/local/include -DNTL_ALL -DUSE_PARI_FACTORING -DMETHOD=2 -DNEW_OP_ORDER -O3 -g -fno-strict-aliasing -DHONORS_CXXFLAGS -MT unimod.lo -MD -MP -MF .deps/unimod.Tpo -c unimod.cc  -fPIC -DPIC -o .libs/unimod.o
In file included from ./eclib/marith.h:27:0,
                 from unimod.cc:25:
./eclib/arith.h: In function 'int div(long int, long int)':
./eclib/arith.h:182:39: error: 'int div(long int, long int)' conflicts with previous using declaration 'std::ldiv_t std::div(long int, long int)'
make[1]: *** [unimod.lo] Error 1
make[1]: Leaving directory `/home/leif/Sage/release/build/mark2/sage-5.0.beta13-gcc-4.7.0/tmp/eclib-2012-04-14/libsrc'
make: *** [all-recursive] Error 1
```

(Cf. [comment:ticket:12751:21 my comment at #12751], the ticket which deals with GCC 4.7.0 issues.)


---

Comment by cremona created at 2012-04-15 13:37:30

Thanks for testing.  There's a newer version at the same place but updated name:  http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-2012-04-14.tar.gz  but it does not yet deal with the issue you found (conflict between my function called div and some system function).  I'll fix that, though I do not yet have gcc-4.7.0.

The delay in getting to make the spkg was reconfiguring my build so that the includes now end up in a separate eclib subdirectory of the installdir/include (e.g. $SAGE_LOCAL/include), but that is done now in the 2012-04-14 version.

Is the problem with that div function the only one on gcc-4.7?


---

Comment by leif created at 2012-04-15 13:49:31

Replying to [comment:65 cremona]:
> Thanks for testing.  There's a newer version at the same place but updated name:  http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-2012-04-14.tar.gz

I think I grabbed that (according to the directory name in the tarball); seems like you created a symbolic link from the -04-04 to the -04-14.

> Is the problem with that div function the only one on gcc-4.7?

It's rather a Solaris bug than related to GCC 4.7.0.  (I successfully built the "current" spkg in Sage with GCC 4.7.0, although not on Solaris.)  See also my recent comments at #12751.

But it's in general a bad idea to put functions with such commonly used names into the global namespace; don't know whether eclib (meanwhile) uses namespaces at all...


---

Comment by cremona created at 2012-04-15 13:57:23

Replying to [comment:66 leif]:
> Replying to [comment:65 cremona]:
> > Thanks for testing.  There's a newer version at the same place but updated name:  http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-2012-04-14.tar.gz
> 
> I think I grabbed that (according to the directory name in the tarball); seems like you created a symbolic link from the -04-04 to the -04-14.

I didn't, but the Warwick webserver has this way of error-correcting URLs.

> 
> > Is the problem with that div function the only one on gcc-4.7?
> 
> It's rather a Solaris bug than related to GCC 4.7.0.  (I successfully built the "current" spkg in Sage with GCC 4.7.0, although not on Solaris.)  See also my recent comments at #12751.

OK, I have read them now.

> 
> But it's in general a bad idea to put functions with such commonly used names into the global namespace; don't know whether eclib (meanwhile) uses namespaces at all...

I also ran into this with my restrict() functions which had to be renamed.  No, eclib does not yet have its own namespaces.  One day....  I already see that in the code I call my div() functions mostly as ::div() because of some similar clash, but have not before had a complaint about the function declaration.  I can see the point behind your "bad idea" comment, but I have been happily using my div(int,int) and div(long,long) functions for over 20 years, so I got there first!


---

Comment by leif created at 2012-04-15 14:35:43

Replying to [comment:67 cremona]:
> Replying to [comment:66 leif]:
> > > Is the problem with that div function the only one on gcc-4.7?

I just did a quick build on Ubuntu 10.04.4 LTS x86_64 with (my own build of) GCC 4.7.0, without setting any `CFLAGS` or `CXXFLAGS`; `make check` apparently passed without errors.

Only noticed that eclib's `configure` apparently doesn't yet check whether the NTL and PARI installations passed to it really work; I used the ones of some Sage 5.0.beta10 installation I also compiled with GCC 4.7.0, but accidentally passed `--with-*=$SAGE_ROOT` instead of `--with-*=$SAGE_ROOT/local` in the first place.  While `configure` succeeded with that, the compilation of course later failed, because `<NTL/foo>` couldn't be included.

There should IMHO also be a `--with-gmp=...` option.




> > But it's in general a bad idea to put functions with such commonly used names into the global namespace; don't know whether eclib (meanwhile) uses namespaces at all...
> 
> I also ran into this with my restrict() functions which had to be renamed.  No, eclib does not yet have its own namespaces.  One day....  I already see that in the code I call my div() functions mostly as ::div() because of some similar clash, but have not before had a complaint about the function declaration.  I can see the point behind your "bad idea" comment, but I have been happily using my div(int,int) and div(long,long) functions for over 20 years, so I got there first!

Yeah, C++ didn't have namespaces (but neither templates) in 1990... ;-)


---

Comment by cremona created at 2012-04-15 14:42:16

There's a new eclib-2012-04-15.tar.gz which fixes the problem with the div() function, could you check that?

It does not yet address the new points you raised.  I did have a check for NTL and pari but removed them for some reason;  I can put them back with a gmp check.  There must be a limit to how far we go to be nice the the user, though:  personally I think it is fine to have written down somewhere: "you need to have a working pari and NTL installation" and let the user make sure that they have that and configure properly.  But while I am working on this and have not forgotten how to do these things...


---

Comment by leif created at 2012-04-15 14:54:19

Replying to [comment:69 cremona]:
> There's a new eclib-2012-04-15.tar.gz which fixes the problem with the div() function, could you check that?

Sure; _later_<sup>TM</sup> though...


---

Comment by cremona created at 2012-04-15 15:10:34

Replying to [comment:69 cremona]:
> There's a new eclib-2012-04-15.tar.gz which fixes the problem with the div() function, could you check that?
> 
> It does not yet address the new points you raised.  I did have a check for NTL and pari but removed them for some reason;  I can put them back with a gmp check.  There must be a limit to how far we go to be nice the the user, though:  personally I think it is fine to have written down somewhere: "you need to have a working pari and NTL installation" and let the user make sure that they have that and configure properly.  But while I am working on this and have not forgotten how to do these things...

In fact I had not removed these checks -- configure.ac, which has code which is supposed to check that they work.  But it only does so if the user has *not* used the command-line options --with-pari= or --with-ntl=.  In other words, the user is trusted not to get it wrong when giving customised places for libraries.

I will change this if you tell me exactly how to change configure.ac.  Otherwise, the new tarball (timestamped 15-Apr-2012 16:07) deals with gmp the same way it deals with pari and NTL.


---

Comment by leif created at 2012-04-15 16:51:48

Replying to [comment:70 leif]:
> Replying to [comment:69 cremona]:
> > There's a new eclib-2012-04-15.tar.gz which fixes the problem with the div() function, could you check that?
> 
> Sure; _later_<sup>TM</sup> though...

Took ages to build (on a Sun Blade 2500), but `make check` passed without errors.

Thanks for fixing it.


---

Comment by cremona created at 2012-04-15 16:57:32

Replying to [comment:72 leif]:
> 
> Took ages to build (on a Sun Blade 2500), but `make check` passed without errors.
> 
> Thanks for fixing it.

And thanks for checking.  Watch this space for a new spkg...


---

Comment by leif created at 2012-04-15 17:28:08

Replying to [comment:73 cremona]:
> Replying to [comment:72 leif]:
> > 
> > Took ages to build (on a Sun Blade 2500), but `make check` passed without errors.
> > 
> > Thanks for fixing it.
> 
> And thanks for checking.  Watch this space for a new spkg...

FWIW, also builds with Clang 3.0 on Ubuntu 12.04 x86_64, but some tests fail (`tperiods` from the qcurves checks; further checks aren't performed after that, apparently, so maybe more could fail).


---

Comment by leif created at 2012-04-15 17:54:06

Replying to [comment:74 leif]:
> FWIW, also builds with Clang 3.0 on Ubuntu 12.04 x86_64, but some tests fail (`tperiods` from the qcurves checks; further checks aren't performed after that, apparently, so maybe more could fail).

Nope, all other tests pass.

Just in case you're curious:

```
./tperiods < ./in/tperiods.in > tperiods.testout 2>/dev/null && diff tperiods.testout ./out/tperiods.out
9,10c9,10
< Minimal model = [0,0,0,0,1024]
< Periods: [w_1,w_2] = [(-0.66248953135704373399263356236816451346445070182593,-0.38248850926429821872829854307720608964320723679024),(0.66248953135704373399263356236816451346445070182596,-0.38248850926429821872829854307720608964320723679024)]
---
> Minimal model = [0,0,1,0,0]
> Periods: [w_1,w_2] = [(-2.6499581254281749359705342494726580538578028073037,-1.529954037057192874913194172308824358572828947161),(2.6499581254281749359705342494726580538578028073038,-1.529954037057192874913194172308824358572828947161)]
12c12
< w_R = (1.3249790627140874679852671247363290269289014036519,0)	w_IR = (0.66248953135704373399263356236816451346445070182593,0.38248850926429821872829854307720608964320723679024)
---
> w_R = (5.2999162508563498719410684989453161077156056146076,0)	w_IR = (2.6499581254281749359705342494726580538578028073037,1.529954037057192874913194172308824358572828947161)
14c14
< Curve from periods: [0,0,0,0,1024]
---
> Curve from periods: [0,0,1,0,0]
16,17c16,17
< Minimal model = [0,0,0,-144,0]
< Periods: [w_1,w_2] = [(0.75692281740062357273586812833909789009873060415018,0),(0,0.75692281740062357273586812833909789009873060415018)]
---
> Minimal model = [0,0,0,-9,0]
> Periods: [w_1,w_2] = [(1.5138456348012471454717362566781957801974612083004,0),(0,1.5138456348012471454717362566781957801974612083004)]
19c19
< w_R = (0.75692281740062357273586812833909789009873060415018,0)	w_I = (0,0.75692281740062357273586812833909789009873060415018)
---
> w_R = (1.5138456348012471454717362566781957801974612083004,0)	w_I = (0,1.5138456348012471454717362566781957801974612083004)
21c21
< Curve from periods: [0,0,0,-144,0]
---
> Curve from periods: [0,0,0,-9,0]
23,24c23,24
< Minimal model = [0,0,0,144,0]
< Periods: [w_1,w_2] = [(-0.53522525701880779965857776292382257547647444795279,-0.53522525701880779965857776292382257547647444795279),(0.53522525701880779965857776292382257547647444795279,-0.53522525701880779965857776292382257547647444795279)]
---
> Minimal model = [0,0,0,9,0]
> Periods: [w_1,w_2] = [(-1.0704505140376155993171555258476451509529488959056,-1.0704505140376155993171555258476451509529488959056),(1.0704505140376155993171555258476451509529488959056,-1.0704505140376155993171555258476451509529488959056)]
26c26
< w_R = (1.0704505140376155993171555258476451509529488959056,0)	w_IR = (0.53522525701880779965857776292382257547647444795279,0.53522525701880779965857776292382257547647444795279)
---
> w_R = (2.1409010280752311986343110516952903019058977918112,0)	w_IR = (1.0704505140376155993171555258476451509529488959056,1.0704505140376155993171555258476451509529488959056)
28c28
< Curve from periods: [0,0,0,144,0]
---
> Curve from periods: [0,0,0,9,0]
make[1]: [check_qcurves] Error 1 (ignored)
```



---

Comment by cremona created at 2012-04-15 19:09:06

Thanks -- very curious, as that is a catastrophic difference.  It is going to be very hard for me to debug this: the new test output is simply wrong, this shows:

```
sage: EllipticCurve([0,0,0,0,1024]).minimal_model().ainvs()
(0, 0, 1, 0, 0)
sage: EllipticCurve([0,0,0,-144,0]).minimal_model().ainvs()   
(0, 0, 0, -9, 0)
```

But how can I begin to find out why the other compiler gets this wrong?  Any ideas?  Were there any compiler warnings at all?


---

Comment by jdemeyer created at 2012-04-16 08:47:41

Either there's a compiler bug or your code relies on some undefined behaviour.  One should try to compile with clang with `-O0`.


---

Comment by cremona created at 2012-04-16 10:27:11

Replying to [comment:77 jdemeyer]:
> Either there's a compiler bug or your code relies on some undefined behaviour.  One should try to compile with clang with `-O0`.

I found that one of our machines has clang and so I am compiling on that now.  I just prepended CXX=clang to the ./configure line, as I am not sure if more than that is needed.  I will report back.

Regarding your first comment,  I will not ask which possibility you are putting your money on....


---

Comment by cremona created at 2012-04-16 12:19:45

OK, fixed: the code now compiles without warning with clang and test pass (for me).  There were a few minor compiler warnings, which I dealt with (though only one was a real error and that was in some code no longer used).  

For the record, here's the issue which caused the check to fail.   In the file tests/tperiods.cc, I read in the coefficients of an elliptic curve and construct the curve from it with a flag set to say to construct the associated minimal model; and that was not being done.  The old line

```
Curvedata CD(Curvedata(ai,v),1);
```

first constructs an instance of type Curvedata from a vector of rationals called ai with an additional reference parameter v which is undefined on input but holds a bigint scaling factor on output, then passes that Curvedata object back to a different Curvedata constructor whose first argument is a Curvedata object and second argument is an int flag to indicate whether or not to convert to a minimal model.  I have replaced this with two lines

```
Curvedata CDin(ai,v); // v holds scaling factor
Curvedata CD(CDin,1); // 1 for minimise
```

where the temporary object CDin which I never use is now declared explicitly.  Something was clearly going wrong with the temporary object, but who knows what.  I would say that this is a compiler error, but do not wish to get into any arguments about it -- the code now works with clang and gcc, while before it only worked with clang.

There's a new tarball at http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-2012-04-16.tar.gz

One final comment:  building with clang took an *extremely* long time compared with gcc, so I really hope that I never have to use it again!


---

Comment by leif created at 2012-04-16 12:29:44

Replying to [comment:77 jdemeyer]:
> Either there's a compiler bug or your code relies on some undefined behaviour.  One should try to compile with clang with `-O0`.

Using `-O0` doesn't make any difference for me.


```sh
$ clang++ -v
Ubuntu clang version 3.0-6ubuntu1 (tags/RELEASE_30/final) (based on LLVM 3.0)
Target: x86_64-pc-linux-gnu
Thread model: posix
```

Ubuntu 12.04 x86_64 (Core i5-2430M)


---

Comment by leif created at 2012-04-16 12:37:00

Replying to [comment:80 leif]:
> Replying to [comment:77 jdemeyer]:
> > Either there's a compiler bug or your code relies on some undefined behaviour.  One should try to compile with clang with `-O0`.
> 
> Using `-O0` doesn't make any difference for me.
> 
> {{{
> #!sh
> $ clang++ -v
> Ubuntu clang version 3.0-6ubuntu1 (tags/RELEASE_30/final) (based on LLVM 3.0)
> Target: x86_64-pc-linux-gnu
> Thread model: posix
> }}}
> Ubuntu 12.04 x86_64 (Core i5-2430M)

Just to clarify:  I was referring to the old version of yesterday.


---

Comment by leif created at 2012-04-16 12:52:08

The new version (2012-04-16) passes all tests with Clang 3.0 and `-O3`.  (Compilation btw. took about 90 seconds, on a slow filesystem, with four jobs on a 2.4 GHz dual-core).


---

Comment by leif created at 2012-04-16 13:09:03

Replying to [comment:82 leif]:
> The new version (2012-04-16) passes all tests with Clang 3.0 and `-O3`.  (Compilation btw. took about 90 seconds, on a slow filesystem, with four jobs on a 2.4 GHz dual-core).

Same with FSF GCC 4.6.3 (while the compilation -- on the same machine -- took about 40 seconds longer; on the other hand, the test suite ran slightly faster).


---

Comment by cremona created at 2012-04-16 13:15:58

Replying to [comment:82 leif]:

> The new version (2012-04-16) passes all tests with Clang 3.0 and `-O3`.  (Compilation btw. took about 90 seconds, on a slow filesystem, with four jobs on a 2.4 GHz dual-core).

Excellent.

Re speed: mine's running 

```
jec`@`selmer%clang --version
clang version 3.0 (trunk 129441)
Target: x86_64-unknown-linux-gnu
Thread model: posix
```

and "time make -j10" gives

```
real	7m20.983s
user	55m43.301s
sys	0m39.662s
```

so something's not right...


---

Comment by cremona created at 2012-04-16 13:58:11

I tried replacing CXX=clang with CXX=clang before ./configure but that made no difference.

I downloaded and built and installed a new clang+llvm (so it is now clang 3.1) and tried again.  It is no faster but revealed a few more totally unimportant warnings which I have fixed;  somewhat tedious since 5 files were affected and recompiling ecah one took up to 2 minutes.  therse will get into the next tarball but it's not urgent.

It is a complete mystery to me how this supposedly brand new and very fast compiler does such a slow job on *my* code!


---

Comment by leif created at 2012-04-17 13:04:46

Replying to [comment:86 cremona]:

403 Forbidden


---

Comment by cremona created at 2012-04-17 13:06:43

Ready for review.  Note that I have fully tested this on linux but on no other system, so it will be a miracly if the spkg-install does not need further work.  As an opening gambit I have removed all the system-specific code in it, so we can see how good a job autotools does without further intervention.


---

Comment by cremona created at 2012-04-17 13:07:33

Apply to 5.0.beta13 after installing the spkg


---

Attachment


---

Comment by cremona created at 2012-04-17 13:08:03

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2012-04-17 13:11:38

Replying to [comment:88 leif]:
> Replying to [comment:86 cremona]:
> 
> 403 Forbidden

You didn't wait for me to set this to "needs review"!  Nice to know that someone cares, all the same.


---

Comment by leif created at 2012-04-17 13:18:03

`chmod -R +rX src/`


---

Comment by cremona created at 2012-04-17 13:28:03

Replying to [comment:92 leif]:
> `chmod -R +rX src/`

Done (I actually used a+rX) and spkg updated.


---

Comment by leif created at 2012-04-17 14:32:35

FWIW, patch also applies to Sage 5.0.beta10 (and presumably even older versions).

So far builds and some long tests pass on Ubuntu 10.04.4 x86_64 (beta10, GCC 4.7.0) as well as on Ubuntu 12.04 x86_64 (beta13, FSF GCC 4.6.3).


---

Comment by cremona created at 2012-04-17 14:39:19

Replying to [comment:94 leif]:
> FWIW, patch also applies to Sage 5.0.beta10 (and presumably even older versions).
> 
> So far builds and some long tests pass on Ubuntu 10.04.4 x86_64 (beta10, GCC 4.7.0) as well as on Ubuntu 12.04 x86_64 (beta13, FSF GCC 4.6.3).

Excellent, thanks.  Anybody out there with an Apple?


---

Comment by leif created at 2012-04-17 15:26:24

Replying to [comment:95 cremona]:
> Anybody out there with an Apple?

Not with a recent installation of Sage.  Currently building...




`spkg-install` and `spkg-check` certainly need some clean-up; I can do that (or am actually at it).


---

Comment by cremona created at 2012-04-17 16:05:55

Replying to [comment:96 leif]:
> Replying to [comment:95 cremona]:
> > Anybody out there with an Apple?
> 
> Not with a recent installation of Sage.  Currently building...
> 
> 

> 
> `spkg-install` and `spkg-check` certainly need some clean-up; I can do that (or am actually at it).

Obviously so for spkg-install, since I left in commented-out code which might be needed, but spkg-check could hardly be cleaner?


---

Comment by cremona created at 2012-04-17 16:09:47

By the way, I have made some changes to the source distribution so if your changes make a .p0 of the spkg then I'll add those in to make a .p1.


---

Comment by leif created at 2012-04-17 16:30:55

Replying to [comment:97 cremona]:
> Replying to [comment:96 leif]:
> > `spkg-install` and `spkg-check` certainly need some clean-up; I can do that (or am actually at it).
> 
> Obviously so for spkg-install, since I left in commented-out code which might be needed, but spkg-check could hardly be cleaner?

Well, perhaps not "cleaner", but I did

```patch
--- a/spkg-check
+++ b/spkg-check
`@``@` -1,5 +1,21 `@``@`
 #!/usr/bin/env bash
 
+if [ -z "$SAGE_LOCAL" ]; then
+    echo >&2 "Error: SAGE_LOCAL undefined - exiting..."
+    echo >&2 "Maybe run 'sage -sh'?"
+    exit 1
+fi
+
+# We don't have to set up any environment variables here since the
+# Makefiles already have them from 'configure'.  (Hopefully.)
+
 cd src
-make check
 
+echo
+echo "Now running eclib's test suite..."
+$MAKE check
+if [ $? -ne 0 ]; then
+    echo >&2 "Error: eclib's test suite failed to pass."
+    exit 1
+fi
+echo "eclib's test suite passed without errors."
```

I.e., use `$MAKE`, add the usual sanity check and some messages.


---

Comment by leif created at 2012-04-17 16:33:52

Replying to [comment:98 cremona]:
> By the way, I have made some changes to the source distribution so if your changes make a .p0 of the spkg then I'll add those in to make a .p1.

I actually made a p1 (but I can of course rename it to a p0); not yet sure whether we (still) need some DLL copying / renaming on Cygwin though.


---

Attachment

Preliminary changes to John's spkg (to get a p0).


---

Comment by leif created at 2012-04-17 16:59:21

Ok, preliminary p0 spkg is [here](http://boxen.math.washington.edu/home/leif/Sage/spkgs/eclib-20120417.p0.spkg), diff attached.

(I haven't committed the changes.)


---

Comment by leif created at 2012-04-17 17:06:36

P.S.: Your original spkg builds and passes its test suite on MacOS X 10.6.8 (with Apple's GCC 4.2.1); `ptestlong` with beta12 in progress...


---

Comment by jhpalmieri created at 2012-04-17 17:09:30

Regarding a line like

```
echo "Now running eclib's test suite..." 
```

in spkg-check: note that the sage-spkg script already does the following, if spkg-check exists:

```
echo "Running the test suite for $PKG_NAME..."
```

So I think the `echo` command in spkg-check is redundant.


---

Comment by leif created at 2012-04-17 17:26:37

Replying to [comment:103 jhpalmieri]:
> Regarding a line like
> {{{
> echo "Now running eclib's test suite..." 
> }}}
> in spkg-check: note that the sage-spkg script already does the following, if spkg-check exists:
> {{{
> echo "Running the test suite for $PKG_NAME..."
> }}}
> So I think the `echo` command in spkg-check is redundant.

Well, maybe `sage-spkg`'s message is redundant... ;-)

I do that in every `spkg-check`, since `sage-spkg`'s message isn't always appropriate (since it runs `spkg-check`, not the test suite; `spkg-check` might do other things before), one might miss it, and it uses the filename of the spkg rather than the package's name.


---

Comment by leif created at 2012-04-17 17:32:08

P.S.: `sage-spkg` also never prints whether running the test suite succeeded, which isn't always obvious from the package's messages.  (I therefore also always add a message to `spkg-check` that the test suite passed in case it did.)


---

Comment by leif created at 2012-04-17 17:58:04

Replying to [comment:102 leif]:
> P.S.: Your original spkg builds and passes its test suite on MacOS X 10.6.8 (with Apple's GCC 4.2.1)

My p0 also builds and passes the test suite on Solaris (SPARC, 32-bit, GCC 4.7.0).

Unfortunately beta13 (i.e., some spkgs) currently doesn't build on Solaris, so I couldn't run other tests yet.


---

Comment by leif created at 2012-04-17 18:20:18

Replying to [comment:102 leif]:
> P.S.: Your original spkg builds and passes its test suite on MacOS X 10.6.8 (with Apple's GCC 4.2.1); `ptestlong` with beta12 in progress...

... all tests passed.


---

Comment by leif created at 2012-04-17 21:15:08

Replying to [comment:107 leif]:
> Replying to [comment:102 leif]:
> > P.S.: Your original spkg builds and passes its test suite on MacOS X 10.6.8 (with Apple's GCC 4.2.1); `ptestlong` with beta12 in progress...
> 
> ... all tests passed.

Not that surprising, the spkg also builds, its test suite and `ptestlong` pass on MacOS X 10.6.8 with Sage 5.0.beta13 and GCC 4.6.3 from the GCC spkg.


---

Comment by cremona created at 2012-04-18 08:35:16

Thanks, I'll take your patch and add my own updates (to source code) and post a p1.


---

Comment by cremona created at 2012-04-18 09:22:30

The spkg eclib-20120417.p1.spkg contains Leif's improvements to spkg-install and spkg-check, a minor update of source code, and consequent changes to SPKG.txt.


---

Comment by leif created at 2012-04-18 15:17:10

Can anybody test this on Cygwin, or did we meanwhile drop Cygwin support?


---

Comment by leif created at 2012-04-18 16:07:02

W.r.t. your latest upstream changes:

```diff
--- eclib-20120417.p0/src/libsrc/moddata.cc	2012-04-17 11:07:17.000000000 +0200
+++ eclib-20120417.p1/src/libsrc/moddata.cc	2012-04-17 16:19:27.000000000 +0200
`@``@` -146,3 +146,15 `@``@`
  cout << "unitdivlist: " << unitdivlist << endl;
 }
 
+char* nf_filename(long n, char c)
+{
+  char* nf_dir = getenv("NF_DIR"); 
+  string nf_file;
+  if (nf_dir==NULL) 
+    nf_file = string("./newforms");
+  else
+    nf_file = string(nf_dir);
+  char* filename=new char[nf_file.length()+20];
+  sprintf(filename,"%s/%c%ld",nf_file.c_str(),c,n);
+  return filename;
+}
```


The `filename` string buffer might still overflow, since `/%c%ld` (including a terminating `\0`) can have up to 23 characters (1+1+20+1).  One usually allocates a few more bytes than needed, as `sprintf()` is said to need some "scratch space" in addition (at least some implementations may).

Otherwise positive review modulo testing on Cygwin (if needed).


---

Comment by cremona created at 2012-04-18 16:23:52

Replying to [comment:111 leif]:
> Can anybody test this on Cygwin, or did we meanwhile drop Cygwin support?

From sage-devel:

"No.  We are dropping the Cygwin requirement.  It would be nice, but it
is not a requirement.

William"


---

Comment by cremona created at 2012-04-18 16:30:16

Replying to [comment:112 leif]:
> W.r.t. your latest upstream changes:

> 
> The `filename` string buffer might still overflow, since `/%c%ld` (including a terminating `\0`) can have up to 23 characters (1+1+20+1).  One usually allocates a few more bytes than needed, as `sprintf()` is said to need some "scratch space" in addition (at least some implementations may).

You may be technically correct (based on `2^64-1` having 20 digits, but I know that n will never be anywhere near that big!  I doubt if I'll get to a 7-digit n in my lifetime with his code.  But still, I'll change 20 to 23 and repost.  The old code was much worse: I was relying on the entire path to the directory being a local filename of a few characters, but wilth all the testing I have been doing recently I was setting NF_DIR to be some much longer path and that caused segfaults...

> 
> Otherwise positive review modulo testing on Cygwin (if needed).

Good -- we have the official verdict from William saying that it is not necessary.  Just wait for p2...


---

Comment by vbraun created at 2012-04-18 16:47:09

Do yourself a favor and don't use C string manipulation! Compare with C++ stringstream:

```c++
#include <sstream>

using std::stringstream;

void f(int i) {
  stringstream ss;
  ss << "/home" << "user/" << "tmp_" << i << ".dat";
  std::string filename = ss.str();
  const char * c_filename = filename.c_str();
}
```



---

Comment by cremona created at 2012-04-18 16:50:03

Replying to [comment:115 vbraun]:
> Do yourself a favor and don't use C string manipulation! Compare with C++ stringstream:
> {{{#!c++
> #include <sstream>
> 
> using std::stringstream;
> 
> void f(int i) {
>   stringstream ss;
>   ss << "/home" << "user/" << "tmp_" << i << ".dat";
>   std::string filename = ss.str();
>   const char * c_filename = filename.c_str();
> }
> }}}

OK, I will do that -- but you were not quick enough to avoid my making a p2 with a simpler change.  The rest will have to wait a bit.  There are other places in the code where I still use some C strings unfortunately.


---

Comment by cremona created at 2012-04-18 16:51:09

The p2 contains some minor source code changes (but not what Volker suggested, yet) and updated SPKG.txt.


---

Comment by leif created at 2012-04-18 17:09:46

Replying to [comment:115 vbraun]:
> Do yourself a favor and don't use C string manipulation!

Yes, I was thinking of that, too.  But regarding that his code is nearly 25 years old... ;-)


---

Comment by cremona created at 2012-04-18 18:43:32

Replying to [comment:118 leif]:  
> Replying to [comment:115 vbraun]:
> > Do yourself a favor and don't use C string manipulation!
> 
> Yes, I was thinking of that, too.  But regarding that his code is nearly 25 years old... ;-)

I am still listening, you know.  Actuallly it was 1990 when I started the move from Algol68 to C++.


---

Comment by cremona created at 2012-04-19 13:33:51

I have been through all the cource code converting from char* strings to C++ strings where possible, including all filenames and elliptic curve codes (but excluding some low-level stuff where byte arrays are used as such).  The resulting tarball is now eclib-2012-04-19.tar.gz and as the dates has moved on, I renamed the resulting spkg too:  eclib-20120419.spkg.  There are no changes to the install scripts apart from updating SPKG.txt, and I re-checked on my own machine that it builds and all tests pass.


---

Comment by cremona created at 2012-04-21 11:08:26

Volker and Leif: thank you!

When changing from using char* to string for the so-called "Cremona letter codes" I noticed that my old function only catered for codes for numbers < 26*26,which had always been enough.  To day I saw that for conductor 235200, there are 754 classes, so the ocdes go up to 3 letters (cremona_letter_code(754)='bda'.  So your remarks have already been useful!

PS This ticket is still tagged "need review"


---

Comment by leif created at 2012-04-21 14:46:48

Replying to [comment:122 cremona]:
> Volker and Leif: thank you!
> 
> When changing from using char* to string for the so-called "Cremona letter codes" I noticed that my old function only catered for codes for numbers < 26*26,which had always been enough.  To day I saw that for conductor 235200, there are 754 classes, so the ocdes go up to 3 letters (cremona_letter_code(754)='bda'.  So your remarks have already been useful!
> 
> PS This ticket is still tagged "need review"

Thanks for the reminder.  I don't recall right now whether I've even looked at your latest spkg.

But I meanwhile managed to build all of Sage 5.0.beta13 (with a couple of replacement spkgs and some manual intervention) on Solaris SPARC (skynet machine mark2), unfortunately yet only with one of your new spkgs, some p0.

Don't know whether it's related -- with that I reproducibly get a timeout in `sage/schemes/elliptic_curves/ell_rational_field.py`; the last output (hopefully, since we still don't flush buffers) I see is [*EDITED*]:

```
...
1109 tests in 128 items.
1109 passed and 0 failed.
Test passed.
```


Need to investigate further, which will take some time...

----

*EDIT:* [Just reran the test while writing.]

Ooops, while Sage reports the process timed out and got killed, with `--verbose` I notice that it's still running (and actually performing more tests, finally succeeding -- see above), so I probably should have increased `SAGE_TIMEOUT_LONG` (to more than half an hour) ... :-)

So will only have to check your latest spkg...


---

Comment by cremona created at 2012-04-21 14:59:04

Please hang on a little while as I just found a bug in the new string handling.  (If you define a stringstream s and do s<<getenv("XXX"); and environment variable is not set, the string inside s is of size 0, BUT any further s<<... have no effect at all! You have to do s.clear() first.  This just wasted more than half an hour of my time...)

Watch this space.


---

Comment by leif created at 2012-04-21 15:12:40

Well, use something similar to

```c++
const char* nf_filename(long n, char c)
{
  char* nf_dir = getenv("NF_DIR");
  std::stringstream buf;

  buf << (nf_dir ? nf_dir : "./newforms/") << c << n;

  return buf.str().c_str();
}
```

(That was my version of the function which previously used `sprintf()`.)


---

Comment by vbraun created at 2012-04-21 15:22:27

If `stringstream` would dereference the null pointer your program would crash. The error is caught and stringstream sets its failure state:

```c++
int main(void) {
  std::stringstream ss;
  ss << "a";
  if (!ss) std::cerr << "error 1" << std::endl;
  ss << (char*)NULL;
  if (!ss) std::cerr << "error 2" << std::endl;
  return 0;
}
```

will print "error 2".


---

Comment by cremona created at 2012-04-21 15:33:08

Replying to [leif](http://trac.sagemath.org/sage_trac/ticket/10993#comment:125):

> 
> I prefer mine to Leif's:

```
> string nf_filename(long n, char c)
{
  stringstream s;
  s << getenv("NF_DIR");
  if (s.str().empty()) {s.clear(); s<<"./newforms";}
  s  << "/" << c << n;
  return s.str();
}

```

> as it is more C++-y (and I was trying to avoid having any char* in the code).
Thanks for the explanation, Volker.


---

Comment by cremona created at 2012-04-21 15:35:34

I have updated the spkg with my bugfix (name changed to today's date), after successfully building, but myfull test is still continuing.


---

Comment by vbraun created at 2012-04-21 15:46:07

I'm not sure that `empty()` has to return true if a previous operation failed. Its likely that it will be, but I suspect it might be an implementation detail that is not required by the specs.


---

Comment by leif created at 2012-04-21 16:29:35

You may also simply wrap `getenv()` with an additional (preferably `const char*`) default parameter, returned if the environment variable isn't set, just like Python's `os.environ.get("VAR_NAME", default_value)`.

(And the additional parameter might itself default to either `""` or `NULL`.  But if you provide a default parameter for your wrapper function, you won't be able to just overload `getenv()`.  So it would be best to add a `getenv()` function with an additional _non-optional_ parameter, then calling `getenv(NON_DEFINED_NAME)` would just return `NULL`, while `getenv(NON_DEFINED_NAME, DEFAULT_VALUE)` would return `DEFAULT_VALUE`, "transparently".)


---

Comment by cremona created at 2012-04-21 16:45:41

I am tempted to leave it as it is for now, apart from Volker's warning.  I was certainly confusing the NULL return value with the empty string, and it had that nasty effect on the stringstream.  It's amazing that there does not seem to be a proper C++ string version of getenv().  Please don't wait for yet another upstream code fix before making a decision on this.  This function is not used by code currently wrapped in Sage...


---

Comment by vbraun created at 2012-04-21 16:48:23

I agree that its not that big of a deal.


---

Comment by leif created at 2012-04-21 16:51:11

Replying to [comment:131 leif]:
> You may also simply wrap `getenv()` with an additional (preferably `const char*`) default parameter, returned if the environment variable isn't set, just like Python's `os.environ.get("VAR_NAME", default_value)`.
> 
> (And the additional parameter might itself default to either `""` or `NULL`.  But if you provide a default parameter for your wrapper function, you won't be able to just overload `getenv()`.  So it would be best to add a `getenv()` function with an additional _non-optional_ parameter, then calling `getenv(NON_DEFINED_NAME)` would just return `NULL`, while `getenv(NON_DEFINED_NAME, DEFAULT_VALUE)` would return `DEFAULT_VALUE`, "transparently".)

Like this:

```c++
#include <cstdlib>
#include <iostream>

using std::getenv;

const char *getenv(const char *var_name, const char *default_value)
{
  const char *val = getenv(var_name);

  return val ? val : default_value;
}

int main(void)
{
  std::cout << "getenv(\"FOO\"): " << getenv("FOO") << std::endl;
  std::cout.clear();
  std::cout << std::endl;
  std::cout << "getenv(\"FOO\", \"bar\"): " << getenv("FOO", "bar") << std::endl;
  return 0;
}
```

which yields

```
getenv("FOO"): 
getenv("FOO", "bar"): bar
```



---

Comment by leif created at 2012-04-21 16:58:34

Replying to [comment:132 cremona]:
> Please don't wait for yet another upstream code fix before making a decision on this.  This function is not used by code currently wrapped in Sage...

Just waiting for tests (actually of the April 19th spkg) on Solaris to finish...

(They passed on Linux x86_64.)


---

Comment by leif created at 2012-04-21 17:00:06

The link in the description was still referencing the 20120419 spkg.


---

Comment by cremona created at 2012-04-21 17:10:42

Replying to [comment:136 leif]:

> The link in the description was still referencing the 20120419 spkg.
> 
> That's funny, I'm sure I changed it.  The spkg works for me (builds and all long tests pass).


---

Comment by leif created at 2012-04-21 17:48:28

Replying to [comment:135 leif]:
> Just waiting for tests (actually of the April 19th spkg) on Solaris to finish...

Don't know whether that's a regression, but some tests take *really* long (as mentioned), at least on mark2:

```
$ time ./sage -t --long devel/sage/sage/interfaces/mwrank.py devel/sage/sage/libs/cremona/ devel/sage/sage/libs/mwrank/ devel/sage/sage/schemes/elliptic_curves/

sage -t --long "devel/sage/sage/interfaces/mwrank.py"       
         [25.8 s]
sage -t --long "devel/sage/sage/libs/cremona/all.py"        
         [1.2 s]
sage -t --long "devel/sage/sage/libs/cremona/newforms.pyx"  
         [22.4 s]
sage -t --long "devel/sage/sage/libs/cremona/__init__.py"   
         [1.2 s]
sage -t --long "devel/sage/sage/libs/cremona/defs.pxi"      
         [1.2 s]
sage -t --long "devel/sage/sage/libs/cremona/mat.pyx"       
         [21.5 s]
sage -t --long "devel/sage/sage/libs/cremona/constructor.py"
         [24.9 s]
sage -t --long "devel/sage/sage/libs/cremona/homspace.pyx"  
         [23.3 s]
sage -t --long "devel/sage/sage/libs/mwrank/all.py"         
         [21.1 s]
sage -t --long "devel/sage/sage/libs/mwrank/__init__.py"    
         [1.2 s]
sage -t --long "devel/sage/sage/libs/mwrank/interface.py"   
         [72.7 s]
sage -t --long "devel/sage/sage/libs/mwrank/mwrank.pyx"     
         [60.1 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/all.py"
         [25.0 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_local_data.py"
         [39.4 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
         [1581.5 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/monsky_washnitzer.py"
         [71.1 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/modular_parametrization.py"
         [17.4 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/__init__.py"
         [1.2 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_field.py"
         [26.3 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/padic_lseries.py"
         [164.0 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ec_database.py"
         [15.5 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_wp.py"
         [15.2 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_number_field.py"
         [164.4 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_finite_field.py"
         [149.4 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/weierstrass_morphism.py"
         [15.6 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/mod5family.py"
         [14.0 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/heegner.py"
         [370.1 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_point.py"
         [162.9 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_egros.py"
         [207.2 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_curve_isogeny.py"
         [818.7 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/cm.py"
         [49.8 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/kodaira_symbol.py"
         [13.9 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/padics.py"
         [109.7 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_tate_curve.py"
         [22.8 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/constructor.py"
         [205.1 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/lseries_ell.py"
         [34.1 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_generic.py"
         [118.1 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/period_lattice.py"
         [41.7 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/gal_reps.py"
         [269.3 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_modular_symbols.py"
         [125.5 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/sha_tate.py"
         [474.3 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/gp_simon.py"
         [19.5 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/BSD.py"
         [111.4 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/descent_two_isogeny.pyx"
         [24.1 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_torsion.py"
         [28.6 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/formal_group.py"
         [62.7 s]
sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_padic_field.py"
         [15.0 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 5862.3 seconds

real    97m45.421s
user    86m41.715s
sys     2m42.827s
```



---

Comment by leif created at 2012-04-21 18:02:58

Replying to [comment:138 leif]:
> Replying to [comment:135 leif]:
> > Just waiting for tests (actually of the April 19th spkg) on Solaris to finish...
> 
> Don't know whether that's a regression, but some tests take *really* long (as mentioned), at least on mark2 ...

beta13 + MPIR 2.4.0 + MPFR 3.1.0 with all upstream patches; all (relevant) packages compiled with GCC 4.7.0 with `-O3`.  mark2 is a Sun Blade 2500, 2x UltraSPARC III `@` 1280 MHz IIRC.  (I have to say that Mariah's two GMP-ECM background processes apparently don't get suspended, so the sysload is around 3, with Sage's tests run serially.)


---

Comment by cremona created at 2012-04-21 19:00:17

None of the changes to eclib would make a noticeable difference in the timings of any Sage doctests.  Many other changes in this testing version of Sage do have such an effect.

Unless you can prove me wrong ( by giving the timings on exactly the same Sage version without the new eclib)  ...


---

Comment by leif created at 2012-04-21 19:17:39

Replying to [comment:140 cremona]:
> None of the changes to eclib would make a noticeable difference in the timings of any Sage doctests.  Many other changes in this testing version of Sage do have such an effect.
> 
> Unless you can prove me wrong ( by giving the timings on exactly the same Sage version without the new eclib)  ...

Nope.  I see a slight slowdown for `ell_rational_field.py` on my Linux netbook as well (user 8m30.440s vs. 8m44.760s; haven't compared others), but one is beta11 compiled with GCC 4.6.3, while the other, slower one with your new spkg is beta10 compiled with GCC 4.7.0 (same flags, both with MPIR 2.4.0).  So also the compiler version might make a difference, or it's just "random noise".

Anyway, someone else would have to prove you wrong.., ;-)


---

Comment by leif created at 2012-04-21 20:40:02

Changing status from needs_review to positive_review.


---

Comment by leif created at 2012-04-21 20:40:02

Ok, latest spkg (20120421) looks clean, and also passes all relevant tests on Solaris SPARC (32-bit) as well as on Linux x86_64, so finally setting it to positive review, assuming Volker agrees.

(I guess John also prefers to [hopefully] get it into Sage 5.0 as is, rather than adding even more upstream changes which would again need review and testing.)


---

Comment by vbraun created at 2012-04-21 21:09:05

Sounds great!


---

Comment by cremona created at 2012-04-21 22:02:53

Replying to [comment:143 vbraun]:

> Sounds great!
> Thanks to both!


---

Comment by leif created at 2012-04-22 00:47:36

Just in case you're still listening, the new spkg also passes all [IMHO] relevant tests on Linux ppc64 (SLES 11, POWER7) with Sage 5.0.beta9 and #12829, GCC 4.6.3.

(And I haven't observed speed regressions; this time I've run the tests [in parallel] with the old and the new spkg with the same Sage installation, compiler and flags.)


---

Comment by Snark created at 2012-04-24 13:25:11

I checked that eclib-20120421.spkg compiles well on my ARM system running ubuntu. The patch applied with fuzz, and "sage -ba-force" was a success too.


---

Comment by cremona created at 2012-04-29 04:09:12

Replying to [comment:143 vbraun]:
> Sounds great!


---

Comment by leif created at 2012-04-29 11:41:34

Yet another upstream update?

Note that the link _target_ in the description is still `.../eclib-20120421.spkg`, perhaps just some copy-paste accident (cf. [http://trac.sagemath.org/sage_trac/ticket/10993?action=diff&version=149](http://trac.sagemath.org/sage_trac/ticket/10993?action=diff&version=149)).


---

Comment by cremona created at 2012-04-29 12:42:05

It's a tiny bug fix in something not used in Sage, and as the target has moved to 5.1 I thought I would change the spkg.  Sorry if that causes more work in testing.

I'm finding it very hard to edit trac tickets since the version was changed, especially on a netbook while travelling.  I only see one place on the ticket where the spkg name is given, in the Description, and I changed that.  If there's another one somewhere (why would there be two?) and you can change it to match, please do.


---

Comment by leif created at 2012-04-29 13:06:21

Replying to [comment:151 cremona]:
> It's a tiny bug fix in something not used in Sage, and as the target has moved to 5.1 I thought I would change the spkg.  Sorry if that causes more work in testing.
> 
> I'm finding it very hard to edit trac tickets since the version was changed, especially on a netbook while travelling.  I only see one place on the ticket where the spkg name is given, in the Description, and I changed that.  If there's another one somewhere (why would there be two?) and you can change it to match, please do.

No, but in the description we currently again have a link target different to its name:

```
*spkg*:  [//homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-20120428.spkg](http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-20120421.spkg)
```


It's sufficient to just use

```
*spkg*:  [http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-20120428.spkg](http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/progs/eclib-20120428.spkg)

```

(where the brackets are optional if you don't specify an [alternate] name for the link, but I always use them).

Made that change, although technically the new spkg would need new review.


---

Comment by jdemeyer created at 2012-05-06 12:13:44

Resolution: fixed
