# Issue 21615: Precision bug in computing sqrts mod p^e

Issue created by migration from Trac.

Original creator: robertwb

Original creation time: 2016-11-10 01:25:41

CC:  slelievre

When the valuation is non-trivial, we were not always performing the required number of p-adic lifting iterations.


---

Comment by robertwb created at 2016-11-10 01:28:17

Fix at https://github.com/sagemath/sage/pull/66


---

Comment by robertwb created at 2016-11-10 01:28:37

Changing type from PLEASE CHANGE to defect.


---

Comment by robertwb created at 2016-11-10 01:28:37

Changing status from new to needs_review.


---

Comment by robertwb created at 2016-11-14 22:07:44

Fix at https://github.com/sagemath/sage/commit/6b3e27e22606ad6306edc2f323a2cc0e4aa9ddab


---

Comment by slelievre created at 2016-11-15 15:50:03

Adding the fix from the pull request to the ticket description.


---

Comment by robertwb created at 2016-12-06 06:40:55

New commits:


---

Comment by vdelecroix created at 2016-12-24 07:49:09

The following

```
log(e - val//2)/log(2)
```

can easily be deduced from the number of digits of `e - val//2`. This would better be computed with

```
(e - val//2 - 1).nbits()
```


Concerning speed

```
sage: %timeit ceil(log(2**5)/log(2))
1 loop, best of 3: 36.9 ms per loop
sage: %timeit (2**5 - 1).nbits()
1000000 loops, best of 3: 1.19 Âµs per loop
```



---

Comment by vdelecroix created at 2016-12-24 07:49:09

Changing status from needs_review to needs_work.


---

Comment by robertwb created at 2016-12-27 10:07:50

Thanks for taking a look. 

I am using log and ceil from libc, not the symbolic ones, which changes the timing by quite a bit. Also, using nbits would mean that e must be an Integer, not (say) an int.


---

Comment by vdelecroix created at 2016-12-28 12:08:50

Ho I see!


---

Comment by vdelecroix created at 2016-12-28 12:08:50

Changing status from needs_work to positive_review.


---

Comment by vdelecroix created at 2016-12-28 12:14:34

See also the related #22104 for improvements of the case `p=2`


---

Comment by vbraun created at 2017-01-18 20:40:18

Resolution: fixed
