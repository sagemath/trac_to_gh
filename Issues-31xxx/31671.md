# Issue 31671: add gc.collect() to the memleak test from #31313

archive/issues_031434.json:
```json
{
    "body": "the memleak test added in #31313 does not use `gc.collect()`, which leads to random errors sometimes.\n\nCC:  @koffie @jhpalmieri @vbraun\n\nReviewer: John Palmieri\n\nAuthor: Dima Pasechnik\n\nBranch: 872e9ad6a413e3cf958d0b360cd705220710b050\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31671\n\n",
    "closed_at": "2021-04-17T21:57:17Z",
    "created_at": "2021-04-15T09:06:03Z",
    "labels": [
        "component: graph theory",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "add gc.collect() to the memleak test from #31313",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31671",
    "user": "https://github.com/dimpase"
}
```
the memleak test added in #31313 does not use `gc.collect()`, which leads to random errors sometimes.

CC:  @koffie @jhpalmieri @vbraun

Reviewer: John Palmieri

Author: Dima Pasechnik

Branch: 872e9ad6a413e3cf958d0b360cd705220710b050

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31671





---

archive/issue_comments_630040.json:
```json
{
    "body": "Changing author from \"\" to \"Dima Pasechnik\"",
    "created_at": "2021-04-15T09:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630040",
    "user": "https://github.com/dimpase"
}
```

Changing author from "" to "Dima Pasechnik"



---

archive/issue_comments_630041.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-15T09:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630041",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_630042.json:
```json
{
    "body": "Changing branch from \"\" to \"u/dimpase/graphs/add_gccollect_to_memleak_test\"",
    "created_at": "2021-04-15T09:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630042",
    "user": "https://github.com/dimpase"
}
```

Changing branch from "" to "u/dimpase/graphs/add_gccollect_to_memleak_test"



---

archive/issue_comments_630043.json:
```json
{
    "body": "<a id='comment:2'></a>\nNew commits:\n|                                                                                                                                          |                                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|\n|[872e9ad](https://git.sagemath.org/sage.git/commit?id=872e9ad6a413e3cf958d0b360cd705220710b050)|`gc.collect() to normalise get_memory_usage() output`|",
    "created_at": "2021-04-15T09:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630043",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>
New commits:
|                                                                                                                                          |                                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------|
|[872e9ad](https://git.sagemath.org/sage.git/commit?id=872e9ad6a413e3cf958d0b360cd705220710b050)|`gc.collect() to normalise get_memory_usage() output`|



---

archive/issue_comments_630044.json:
```json
{
    "body": "Changing commit from \"\" to \"872e9ad6a413e3cf958d0b360cd705220710b050\"",
    "created_at": "2021-04-15T09:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630044",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "" to "872e9ad6a413e3cf958d0b360cd705220710b050"



---

archive/issue_comments_630045.json:
```json
{
    "body": "<a id='comment:3'></a>\nPlease review!",
    "created_at": "2021-04-15T09:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630045",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
Please review!



---

archive/issue_comments_630046.json:
```json
{
    "body": "<a id='comment:4'></a>\nI still get the same occasional doctest failure:\n\n```\nsage [t/31671/graphs/add_gccollect_to_memleak_test] % ./sage -t src/sage/graphs/bipartite_graph.py\nRunning doctests with ID 2021-04-15-09-29-14-4df85c26.\nGit branch: t/31671/graphs/add_gccollect_to_memleak_test\nUsing --optional=build,dochtml,homebrew,pip,sage,sage_spkg\nDoctesting 1 file.\nsage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py\n**********************************************************************\nFile \"src/sage/graphs/bipartite_graph.py\", line 329, in sage.graphs.bipartite_graph.BipartiteGraph.__init__\nFailed example:\n    print(round(get_memory_usage() - start_mem))\nExpected:\n    0.0\nGot:\n    1.0\n**********************************************************************\n1 item had failures:\n   1 of  14 in sage.graphs.bipartite_graph.BipartiteGraph.__init__\n    [320 tests, 1 failure, 1.32 s]\n----------------------------------------------------------------------\nsage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 1.4 seconds\n    cpu time: 1.3 seconds\n    cumulative wall time: 1.3 seconds\n```",
    "created_at": "2021-04-15T16:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630046",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>
I still get the same occasional doctest failure:

```
sage [t/31671/graphs/add_gccollect_to_memleak_test] % ./sage -t src/sage/graphs/bipartite_graph.py
Running doctests with ID 2021-04-15-09-29-14-4df85c26.
Git branch: t/31671/graphs/add_gccollect_to_memleak_test
Using --optional=build,dochtml,homebrew,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py
**********************************************************************
File "src/sage/graphs/bipartite_graph.py", line 329, in sage.graphs.bipartite_graph.BipartiteGraph.__init__
Failed example:
    print(round(get_memory_usage() - start_mem))
Expected:
    0.0
Got:
    1.0
**********************************************************************
1 item had failures:
   1 of  14 in sage.graphs.bipartite_graph.BipartiteGraph.__init__
    [320 tests, 1 failure, 1.32 s]
----------------------------------------------------------------------
sage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1.4 seconds
    cpu time: 1.3 seconds
    cumulative wall time: 1.3 seconds
```



---

archive/issue_comments_630047.json:
```json
{
    "body": "<a id='comment:5'></a>\nwell, then there is a real platform-specific (macOS) bug.\nStill, this patch makes sense to get in now and here.",
    "created_at": "2021-04-15T16:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630047",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>
well, then there is a real platform-specific (macOS) bug.
Still, this patch makes sense to get in now and here.



---

archive/issue_comments_630048.json:
```json
{
    "body": "<a id='comment:6'></a>\nor should we tag it as a `# known bug` ?",
    "created_at": "2021-04-15T16:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630048",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>
or should we tag it as a `# known bug` ?



---

archive/issue_comments_630049.json:
```json
{
    "body": "<a id='comment:7'></a>\nI agree that the patch here can't hurt, and it could certainly help in some cases. We can merge this and separately can try to track down what's going on with OS X.",
    "created_at": "2021-04-15T16:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630049",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
I agree that the patch here can't hurt, and it could certainly help in some cases. We can merge this and separately can try to track down what's going on with OS X.



---

archive/issue_comments_630050.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-15T16:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630050",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_630051.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2021-04-15T16:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630051",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_630052.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-17T21:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630052",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_083498.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-04-17T21:57:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31671#event-83498"
}
```



---

archive/issue_comments_630053.json:
```json
{
    "body": "Changing branch from \"u/dimpase/graphs/add_gccollect_to_memleak_test\" to \"872e9ad6a413e3cf958d0b360cd705220710b050\"",
    "created_at": "2021-04-17T21:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630053",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/dimpase/graphs/add_gccollect_to_memleak_test" to "872e9ad6a413e3cf958d0b360cd705220710b050"



---

archive/issue_comments_630054.json:
```json
{
    "body": "Changing commit from \"872e9ad6a413e3cf958d0b360cd705220710b050\" to \"\"",
    "created_at": "2021-06-28T09:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630054",
    "user": "https://github.com/slel"
}
```

Changing commit from "872e9ad6a413e3cf958d0b360cd705220710b050" to ""



---

archive/issue_comments_630055.json:
```json
{
    "body": "<a id='comment:9'></a>\nDiscussed again:\n\n- [sage-release (Sage 9.4.beta2 thread)](https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/SlwZrUBuBgAJ)",
    "created_at": "2021-06-28T09:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630055",
    "user": "https://github.com/slel"
}
```

<a id='comment:9'></a>
Discussed again:

- [sage-release (Sage 9.4.beta2 thread)](https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/SlwZrUBuBgAJ)



---

archive/issue_comments_630056.json:
```json
{
    "body": "<a id='comment:10'></a>\nwell, there is a bug in bipartite_graph, no way around it...",
    "created_at": "2021-06-28T11:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31671",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31671#issuecomment-630056",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
well, there is a bug in bipartite_graph, no way around it...
