# Issue 31047: Conversion of symbolic functions with latex_name or nargs from maxima and sympy is broken

archive/issues_030810.json:
```json
{
    "assignees": [],
    "body": "When converting a `NewSymbolicFunction` to a maxima expression and back, sage sometimes returns the correct symbolic function and sometimes it creates a new function with the same name. This happens only when the function has additional information (i.e. a `latex_name` or `nargs`) attached to it. For example:\n\n```\nvar('phi')\nassume(phi >= 0)\nfunction('Cp', latex_name='C_+')\nCp(phi).simplify_full() # convert to maxima and back\n```\n\nreturns an expression with a new `Cp` function which is not equal to the original one and which doesn't have a latex name, but only if the `assume(phi >= 0)` happens before defining the function.\n\n\nThe issue is that the conversion functions hold a local copy of the symbol table which is not kept in sync with the actual symbol table that new functions are added to. If the conversion functions do not find the function by name in the local copy, `function_factory` is invoked which checks for both `name`, `latex_name` and `nargs` when looking for already registered functions. Since of course the maxima expression doesn't include the `latex_name`, it doesn't find the already registered function and creates a new one.\n\nI have implemented a fix which checks both the local and global copies of the symbol table, but I'm not sure this is the right way to fix things. First, it is not clear to me why the conversion functions have a local copy of the symbol table in the first place. Second, it makes no sense to me that `function_factory` looks for a matching `latex_name` when registering a new function. I see no use case for having to functions with the same `name` and different `latex_name` registered. After all, if I type in the name of the function in the sagemath prompt, I will only get the second definition which I typed in and thus I can't use the first definition anyway.\n\nSee also [#14608 comment:9](https://github.com/sagemath/sage/issues/14608#comment:9) and links therein for more discussion about this issue.\n\nCC:  @nbruin @egourgoulhon @rwst @DaveWitteMorris\n\nBranch: **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)**\n\nReviewer: **Eric Gourgoulhon**\n\nAuthor: **Marius Gerbershagen**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31047_\n\n",
    "closed_at": "2021-03-20T20:55:09Z",
    "created_at": "2020-12-13T18:00:16Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20symbolics",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Conversion of symbolic functions with latex_name or nargs from maxima and sympy is broken",
    "type": "issue",
    "updated_at": "2021-04-30T07:12:01Z",
    "url": "https://github.com/sagemath/sage/issues/31047",
    "user": "https://github.com/spaghettisalat"
}
```
When converting a `NewSymbolicFunction` to a maxima expression and back, sage sometimes returns the correct symbolic function and sometimes it creates a new function with the same name. This happens only when the function has additional information (i.e. a `latex_name` or `nargs`) attached to it. For example:

```
var('phi')
assume(phi >= 0)
function('Cp', latex_name='C_+')
Cp(phi).simplify_full() # convert to maxima and back
```

returns an expression with a new `Cp` function which is not equal to the original one and which doesn't have a latex name, but only if the `assume(phi >= 0)` happens before defining the function.


The issue is that the conversion functions hold a local copy of the symbol table which is not kept in sync with the actual symbol table that new functions are added to. If the conversion functions do not find the function by name in the local copy, `function_factory` is invoked which checks for both `name`, `latex_name` and `nargs` when looking for already registered functions. Since of course the maxima expression doesn't include the `latex_name`, it doesn't find the already registered function and creates a new one.

I have implemented a fix which checks both the local and global copies of the symbol table, but I'm not sure this is the right way to fix things. First, it is not clear to me why the conversion functions have a local copy of the symbol table in the first place. Second, it makes no sense to me that `function_factory` looks for a matching `latex_name` when registering a new function. I see no use case for having to functions with the same `name` and different `latex_name` registered. After all, if I type in the name of the function in the sagemath prompt, I will only get the second definition which I typed in and thus I can't use the first definition anyway.

See also [#14608 comment:9](https://github.com/sagemath/sage/issues/14608#comment:9) and links therein for more discussion about this issue.

CC:  @nbruin @egourgoulhon @rwst @DaveWitteMorris

Branch: **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)**

Reviewer: **Eric Gourgoulhon**

Author: **Marius Gerbershagen**

_Issue created by migration from https://trac.sagemath.org/ticket/31047_





---

archive/issue_events_409868.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2020-12-13T18:00:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409868"
}
```



---

archive/issue_events_409869.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2020-12-13T18:00:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "component: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409869"
}
```



---

archive/issue_events_409870.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2020-12-13T18:00:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409870"
}
```



---

archive/issue_events_409871.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2020-12-13T18:00:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409871"
}
```



---

archive/issue_comments_500522.json:
```json
{
    "body": "Commit: **[9d32f6a](https://github.com/sagemath/sagetrac-mirror/commit/9d32f6ad3b3b319b5f3a08b5b933d6fa0cb167ed)**",
    "created_at": "2020-12-13T18:01:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500522",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[9d32f6a](https://github.com/sagemath/sagetrac-mirror/commit/9d32f6ad3b3b319b5f3a08b5b933d6fa0cb167ed)**



---

archive/issue_comments_500523.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9d32f6ad3b3b319b5f3a08b5b933d6fa0cb167ed\">9d32f6a</a></td><td><code>calculus: fix conversion of symbol functions back from maxima</code></td></tr></table>\n",
    "created_at": "2020-12-13T18:01:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500523",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:1" align="right">Comment 1</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9d32f6ad3b3b319b5f3a08b5b933d6fa0cb167ed">9d32f6a</a></td><td><code>calculus: fix conversion of symbol functions back from maxima</code></td></tr></table>




---

archive/issue_events_409872.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2020-12-13T18:02:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409872"
}
```



---

archive/issue_comments_500524.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nThank you very much for taking care of this long standing issue!\n\nI've performed a few tests and the fix seems good to me. Let us wait for some other viewpoints before setting a positive review. Also it would be nice if the patchbot could run on this ticket branch.",
    "created_at": "2020-12-16T10:04:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500524",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:3" align="right">Comment 3</div>

Thank you very much for taking care of this long standing issue!

I've performed a few tests and the fix seems good to me. Let us wait for some other viewpoints before setting a positive review. Also it would be nice if the patchbot could run on this ticket branch.



---

archive/issue_comments_500525.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nAnother issue with symbolic functions is #27492. It might also be related to the way symbolic functions are stored in the symbol table.",
    "created_at": "2020-12-16T10:07:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500525",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:4" align="right">Comment 4</div>

Another issue with symbolic functions is #27492. It might also be related to the way symbolic functions are stored in the symbol table.



---

archive/issue_comments_500526.json:
```json
{
    "body": "Author: **Marius Gerbershagen**",
    "created_at": "2020-12-28T06:34:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500526",
    "user": "https://github.com/kliem"
}
```

Author: **Marius Gerbershagen**



---

archive/issue_events_409873.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2020-12-28T12:26:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409873"
}
```



---

archive/issue_events_409874.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2020-12-28T12:26:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409874"
}
```



---

archive/issue_comments_500527.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nI am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?",
    "created_at": "2020-12-28T12:26:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500527",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:6" align="right">Comment 6</div>

I am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?



---

archive/issue_comments_500528.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nI can comment on one question in the description: since it is possible to do the following:\n\n```\nsage: f1=sage.symbolic.function_factory.function('f',latex_name=\"\\phi\")\nsage: f2=sage.symbolic.function_factory.function('f',latex_name=\"\\psi\")\nsage: f1(x)-f2(x)\nf(x) - f(x)\nsage: latex(f1(x)-f2(x))\n\\phi\\left(x\\right) - \\psi\\left(x\\right)\n```\nI think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.\n\nYou're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.",
    "created_at": "2020-12-29T03:28:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500528",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:7" align="right">Comment 7</div>

I can comment on one question in the description: since it is possible to do the following:

```
sage: f1=sage.symbolic.function_factory.function('f',latex_name="\phi")
sage: f2=sage.symbolic.function_factory.function('f',latex_name="\psi")
sage: f1(x)-f2(x)
f(x) - f(x)
sage: latex(f1(x)-f2(x))
\phi\left(x\right) - \psi\left(x\right)
```
I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.

You're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.



---

archive/issue_comments_500529.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nReplying to [@nbruin](#comment%3A7):\n> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. \n\nIt should be forbidden, IMHO. As pointed out in the ticket description, I don't see any use case for such a feature. Since maxima has no concept of LaTeX name and maxima is currently heavily used for simplifications in Sage symbolic calculus, it would be safe to forbid to declare a function with an already existing name but a different LaTeX name. \n\n> You're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.\n\nWhat do you mean by \"other interfaces (particularly maxima)\", given that this ticket is about the maxima interface?",
    "created_at": "2020-12-29T15:50:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500529",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:8" align="right">Comment 8</div>

Replying to [@nbruin](#comment%3A7):
> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. 

It should be forbidden, IMHO. As pointed out in the ticket description, I don't see any use case for such a feature. Since maxima has no concept of LaTeX name and maxima is currently heavily used for simplifications in Sage symbolic calculus, it would be safe to forbid to declare a function with an already existing name but a different LaTeX name. 

> You're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.

What do you mean by "other interfaces (particularly maxima)", given that this ticket is about the maxima interface?



---

archive/issue_comments_500530.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@sagetrac-tmonteil](#comment%3A6):\n> I am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?\n\nHere is a doctest adapted from the ticket description:\n\n```\nsage: assume(x > 0)                                                        \nsage: Cp = function('Cp', latex_name=r'C_+') \nsage: s = Cp(x).simplify()                 \nsage: s - Cp(x)  # in Sage 9.2, returns Cp(x) - Cp(x)                                                             \n0\nsage: latex(s)  # in Sage 9.2, returns {\\rm Cp}\\left(x\\right)                                                                    \nC_+\\left(x\\right)\n```",
    "created_at": "2020-12-29T15:57:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500530",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@sagetrac-tmonteil](#comment%3A6):
> I am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?

Here is a doctest adapted from the ticket description:

```
sage: assume(x > 0)                                                        
sage: Cp = function('Cp', latex_name=r'C_+') 
sage: s = Cp(x).simplify()                 
sage: s - Cp(x)  # in Sage 9.2, returns Cp(x) - Cp(x)                                                             
0
sage: latex(s)  # in Sage 9.2, returns {\rm Cp}\left(x\right)                                                                    
C_+\left(x\right)
```



---

archive/issue_comments_500531.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nThe sympy interfaces suffers from exactly the same problem, for example in\n\n```\nvar('phi')\nfunction('Cp', latex_name='C_+')\nCp(phi)._sympy_()._sage_()\n```",
    "created_at": "2021-01-07T19:59:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500531",
    "user": "https://github.com/spaghettisalat"
}
```

<div id="comment:10" align="right">Comment 10</div>

The sympy interfaces suffers from exactly the same problem, for example in

```
var('phi')
function('Cp', latex_name='C_+')
Cp(phi)._sympy_()._sage_()
```



---

archive/issue_events_409875.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-01-07T19:59:08Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "title_is": "Conversion of symbolic functions with latex_name or nargs from maxima and sympy is broken",
    "title_was": "Conversion of symbolic functions from maxima is broken",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409875"
}
```



---

archive/issue_comments_500532.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nReplying to [@nbruin](#comment%3A7):\n\n> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.\n\nBut in basically all cases, sagemath already assumes that the print name can be treated as a unique identifier for the function. The documentation never mentions anything else. External interfaces rely on the assumption. The sagemath prompt treats the print name as a unique identifier: when I create two functions with the same print name and two different latex names and then type in the function name in the prompt, I get only one of the two functions.\n\nTherefore, the \"feature\" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.\n\nGiven that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.",
    "created_at": "2021-01-07T20:19:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500532",
    "user": "https://github.com/spaghettisalat"
}
```

<div id="comment:11" align="right">Comment 11</div>

Replying to [@nbruin](#comment%3A7):

> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.

But in basically all cases, sagemath already assumes that the print name can be treated as a unique identifier for the function. The documentation never mentions anything else. External interfaces rely on the assumption. The sagemath prompt treats the print name as a unique identifier: when I create two functions with the same print name and two different latex names and then type in the function name in the prompt, I get only one of the two functions.

Therefore, the "feature" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.

Given that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.



---

archive/issue_comments_500533.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nReplying to [@spaghettisalat](#comment%3A11):\n> \n> Therefore, the \"feature\" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.\n\n+1\n\n> \n> Given that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.\n\nYes, this seems the route to go.",
    "created_at": "2021-01-10T16:02:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500533",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:12" align="right">Comment 12</div>

Replying to [@spaghettisalat](#comment%3A11):
> 
> Therefore, the "feature" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.

+1

> 
> Given that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.

Yes, this seems the route to go.



---

archive/issue_comments_500534.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nIn any case, there is something weird about the way some kind of \"unique representation\" for functions (and variables) is handled (both with and without the branch):\n\n```\nsage: f = function('f', nargs=2)\nsage: f(1,2)\nf(1, 2)\nsage: g = function('f', nargs=1)\nsage: f(1,2)\nTypeError: Symbolic function f takes exactly 1 arguments (2 given)\nsage: f is g\nTrue\n```",
    "created_at": "2021-01-10T19:18:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500534",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:13" align="right">Comment 13</div>

In any case, there is something weird about the way some kind of "unique representation" for functions (and variables) is handled (both with and without the branch):

```
sage: f = function('f', nargs=2)
sage: f(1,2)
f(1, 2)
sage: g = function('f', nargs=1)
sage: f(1,2)
TypeError: Symbolic function f takes exactly 1 arguments (2 given)
sage: f is g
True
```



---

archive/issue_comments_500535.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6ffb8c50a549650490ad077d4c2c9a7dd508c334\">6ffb8c5</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4735f7f005e7be167430979cd38915b18e76d7e9\">4735f7f</a></td><td><code>add tests for Trac #31047</code></td></tr></table>\n",
    "created_at": "2021-01-31T21:26:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500535",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14" align="right">Comment 14</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6ffb8c50a549650490ad077d4c2c9a7dd508c334">6ffb8c5</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4735f7f005e7be167430979cd38915b18e76d7e9">4735f7f</a></td><td><code>add tests for Trac #31047</code></td></tr></table>




---

archive/issue_comments_500536.json:
```json
{
    "body": "Changed commit from **[9d32f6a](https://github.com/sagemath/sagetrac-mirror/commit/9d32f6ad3b3b319b5f3a08b5b933d6fa0cb167ed)** to **[4735f7f](https://github.com/sagemath/sagetrac-mirror/commit/4735f7f005e7be167430979cd38915b18e76d7e9)**",
    "created_at": "2021-01-31T21:26:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500536",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9d32f6a](https://github.com/sagemath/sagetrac-mirror/commit/9d32f6ad3b3b319b5f3a08b5b933d6fa0cb167ed)** to **[4735f7f](https://github.com/sagemath/sagetrac-mirror/commit/4735f7f005e7be167430979cd38915b18e76d7e9)**



---

archive/issue_comments_500537.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nI have implemented a basic fix to the specific problem reported on this ticket, i.e. only for the conversion of symbolic functions from maxima. The inconsistent behaviour of `function_factory` is untouched because I can't be bothered to wade through even more piles of spaghetti code to fix that too. The sympy interface is also still broken because for some weird reason the conversion functions between sympy and sage seem to be partially duplicated in both projects and I don't know where to implement the fix (in sage, sympy or both), although the fix itself would be very simple.",
    "created_at": "2021-01-31T21:34:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500537",
    "user": "https://github.com/spaghettisalat"
}
```

<div id="comment:15" align="right">Comment 15</div>

I have implemented a basic fix to the specific problem reported on this ticket, i.e. only for the conversion of symbolic functions from maxima. The inconsistent behaviour of `function_factory` is untouched because I can't be bothered to wade through even more piles of spaghetti code to fix that too. The sympy interface is also still broken because for some weird reason the conversion functions between sympy and sage seem to be partially duplicated in both projects and I don't know where to implement the fix (in sage, sympy or both), although the fix itself would be very simple.



---

archive/issue_events_409876.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-01-31T21:34:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409876"
}
```



---

archive/issue_events_409877.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-01-31T21:34:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409877"
}
```



---

archive/issue_events_409878.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-02T19:08:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409878"
}
```



---

archive/issue_events_409879.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-02T19:08:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409879"
}
```



---

archive/issue_comments_500538.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\npatchbot reports:\n\n```\nsage -t --long --warn-long 69.4 --random-seed=0 src/sage/functions/log.py  # 1 doctest failed\nsage -t --long --warn-long 69.4 --random-seed=0 src/sage/interfaces/sympy.py  # 2 doctests failed\n```",
    "created_at": "2021-02-02T19:08:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500538",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">Comment 16</div>

patchbot reports:

```
sage -t --long --warn-long 69.4 --random-seed=0 src/sage/functions/log.py  # 1 doctest failed
sage -t --long --warn-long 69.4 --random-seed=0 src/sage/interfaces/sympy.py  # 2 doctests failed
```



---

archive/issue_comments_500539.json:
```json
{
    "body": "Changed commit from **[4735f7f](https://github.com/sagemath/sagetrac-mirror/commit/4735f7f005e7be167430979cd38915b18e76d7e9)** to **[98ac37d](https://github.com/sagemath/sagetrac-mirror/commit/98ac37dfe44bffb960a789c9419f70b462d03d22)**",
    "created_at": "2021-02-06T22:00:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500539",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[4735f7f](https://github.com/sagemath/sagetrac-mirror/commit/4735f7f005e7be167430979cd38915b18e76d7e9)** to **[98ac37d](https://github.com/sagemath/sagetrac-mirror/commit/98ac37dfe44bffb960a789c9419f70b462d03d22)**



---

archive/issue_comments_500540.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/98ac37dfe44bffb960a789c9419f70b462d03d22\">98ac37d</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>\n",
    "created_at": "2021-02-06T22:00:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500540",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17" align="right">Comment 17</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/98ac37dfe44bffb960a789c9419f70b462d03d22">98ac37d</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>




---

archive/issue_events_409880.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-02-06T22:00:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409880"
}
```



---

archive/issue_events_409881.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-02-06T22:00:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409881"
}
```



---

archive/issue_comments_500541.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2d38314c433bc77f3b4f04a66d9429190da45d2c\">2d38314</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>\n",
    "created_at": "2021-02-07T18:18:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500541",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19" align="right">Comment 19</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2d38314c433bc77f3b4f04a66d9429190da45d2c">2d38314</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>




---

archive/issue_comments_500542.json:
```json
{
    "body": "Changed commit from **[98ac37d](https://github.com/sagemath/sagetrac-mirror/commit/98ac37dfe44bffb960a789c9419f70b462d03d22)** to **[2d38314](https://github.com/sagemath/sagetrac-mirror/commit/2d38314c433bc77f3b4f04a66d9429190da45d2c)**",
    "created_at": "2021-02-07T18:18:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500542",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[98ac37d](https://github.com/sagemath/sagetrac-mirror/commit/98ac37dfe44bffb960a789c9419f70b462d03d22)** to **[2d38314](https://github.com/sagemath/sagetrac-mirror/commit/2d38314c433bc77f3b4f04a66d9429190da45d2c)**



---

archive/issue_comments_500543.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bc62cdb00f6fe06b73b57dd9ba159f5353148c48\">bc62cdb</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26b48f2cc1ea689d08a3ed5c2ad7f5b3a5441c6e\">26b48f2</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/629c1d3d53366b234b1a45ba3cd8f7ad20a32f23\">629c1d3</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>\n",
    "created_at": "2021-02-07T21:34:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500543",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20" align="right">Comment 20</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bc62cdb00f6fe06b73b57dd9ba159f5353148c48">bc62cdb</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26b48f2cc1ea689d08a3ed5c2ad7f5b3a5441c6e">26b48f2</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/629c1d3d53366b234b1a45ba3cd8f7ad20a32f23">629c1d3</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>




---

archive/issue_comments_500544.json:
```json
{
    "body": "Changed commit from **[2d38314](https://github.com/sagemath/sagetrac-mirror/commit/2d38314c433bc77f3b4f04a66d9429190da45d2c)** to **[629c1d3](https://github.com/sagemath/sagetrac-mirror/commit/629c1d3d53366b234b1a45ba3cd8f7ad20a32f23)**",
    "created_at": "2021-02-07T21:34:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500544",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2d38314](https://github.com/sagemath/sagetrac-mirror/commit/2d38314c433bc77f3b4f04a66d9429190da45d2c)** to **[629c1d3](https://github.com/sagemath/sagetrac-mirror/commit/629c1d3d53366b234b1a45ba3cd8f7ad20a32f23)**



---

archive/issue_events_409882.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-14T16:54:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409882"
}
```



---

archive/issue_events_409883.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-14T16:54:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409883"
}
```



---

archive/issue_comments_500545.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nneeds rebase",
    "created_at": "2021-02-14T16:54:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500545",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:21" align="right">Comment 21</div>

needs rebase



---

archive/issue_comments_500546.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38aa89e0d5fd6f1dbf36b08d53f6ffb743f496ee\">38aa89e</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d6a1f0a449304706cfccd7fb03599b0cf9e5935a\">d6a1f0a</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/933bb5a749861d0e0d1c4f513bdb39d7d26b5db6\">933bb5a</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>\n",
    "created_at": "2021-02-14T20:05:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500546",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22" align="right">Comment 22</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38aa89e0d5fd6f1dbf36b08d53f6ffb743f496ee">38aa89e</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d6a1f0a449304706cfccd7fb03599b0cf9e5935a">d6a1f0a</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/933bb5a749861d0e0d1c4f513bdb39d7d26b5db6">933bb5a</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>




---

archive/issue_comments_500547.json:
```json
{
    "body": "Changed commit from **[629c1d3](https://github.com/sagemath/sagetrac-mirror/commit/629c1d3d53366b234b1a45ba3cd8f7ad20a32f23)** to **[933bb5a](https://github.com/sagemath/sagetrac-mirror/commit/933bb5a749861d0e0d1c4f513bdb39d7d26b5db6)**",
    "created_at": "2021-02-14T20:05:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500547",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[629c1d3](https://github.com/sagemath/sagetrac-mirror/commit/629c1d3d53366b234b1a45ba3cd8f7ad20a32f23)** to **[933bb5a](https://github.com/sagemath/sagetrac-mirror/commit/933bb5a749861d0e0d1c4f513bdb39d7d26b5db6)**



---

archive/issue_events_409884.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-02-14T20:05:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409884"
}
```



---

archive/issue_events_409885.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-02-14T20:05:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409885"
}
```



---

archive/issue_events_409886.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-09T00:25:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409886"
}
```



---

archive/issue_events_409887.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-09T00:25:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409887"
}
```



---

archive/issue_comments_500548.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nJust a superficial comment (because I don't know this part of the code very well): \nAll functions (including internal functions) need a docstring and tests to conform with our coding style.",
    "created_at": "2021-03-09T00:25:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500548",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">Comment 24</div>

Just a superficial comment (because I don't know this part of the code very well): 
All functions (including internal functions) need a docstring and tests to conform with our coding style.



---

archive/issue_comments_500549.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d3ee00d1d93997db69cebfc2e3e82c466da055bb\">d3ee00d</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/15ad274469a8cc3323d49ed0c1fd1f4cc6c66fd3\">15ad274</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2845ad24760072001715b246fd0096e87303ffb6\">2845ad2</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>\n",
    "created_at": "2021-03-12T18:35:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500549",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25" align="right">Comment 25</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d3ee00d1d93997db69cebfc2e3e82c466da055bb">d3ee00d</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/15ad274469a8cc3323d49ed0c1fd1f4cc6c66fd3">15ad274</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2845ad24760072001715b246fd0096e87303ffb6">2845ad2</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>




---

archive/issue_comments_500550.json:
```json
{
    "body": "Changed commit from **[933bb5a](https://github.com/sagemath/sagetrac-mirror/commit/933bb5a749861d0e0d1c4f513bdb39d7d26b5db6)** to **[2845ad2](https://github.com/sagemath/sagetrac-mirror/commit/2845ad24760072001715b246fd0096e87303ffb6)**",
    "created_at": "2021-03-12T18:35:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500550",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[933bb5a](https://github.com/sagemath/sagetrac-mirror/commit/933bb5a749861d0e0d1c4f513bdb39d7d26b5db6)** to **[2845ad2](https://github.com/sagemath/sagetrac-mirror/commit/2845ad24760072001715b246fd0096e87303ffb6)**



---

archive/issue_comments_500551.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\n> Just a superficial comment (because I don't know this part of the code very well): All functions (including internal functions) need a docstring and tests to conform with our coding style. \n\nEverything I added is already covered with tests, either the ones I added in this ticket or existing tests for other functionality that depends on the stuff I changed. Therefore I added only some docstrings. I hope that is finally enough to get this merged.\n\nIs there anybody more familiar with this part of sagemath who we could cc to review this?",
    "created_at": "2021-03-12T18:41:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500551",
    "user": "https://github.com/spaghettisalat"
}
```

<div id="comment:26" align="right">Comment 26</div>

> Just a superficial comment (because I don't know this part of the code very well): All functions (including internal functions) need a docstring and tests to conform with our coding style. 

Everything I added is already covered with tests, either the ones I added in this ticket or existing tests for other functionality that depends on the stuff I changed. Therefore I added only some docstrings. I hope that is finally enough to get this merged.

Is there anybody more familiar with this part of sagemath who we could cc to review this?



---

archive/issue_events_409888.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-03-12T18:41:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409888"
}
```



---

archive/issue_events_409889.json:
```json
{
    "actor": "https://github.com/spaghettisalat",
    "created_at": "2021-03-12T18:41:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409889"
}
```



---

archive/issue_comments_500552.json:
```json
{
    "body": "Reviewer: **Eric Gourgoulhon**",
    "created_at": "2021-03-13T16:28:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500552",
    "user": "https://github.com/egourgoulhon"
}
```

Reviewer: **Eric Gourgoulhon**



---

archive/issue_comments_500553.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nI've performed a few tests and everything seems OK. Thanks for the fix!\n\nRegarding :comment:24, the class `_Function_swap_harmonic` in `src/sage/functions/log.py` should have some (minimal) doctests, as well as the function `_sympysage_function_by_name` and the class `UndefSageHelper` in `src/sage/interfaces/sympy.py`. This will make the [coverage plugin](https://patchbot.sagemath.org/log/31047/Linux/1_SMP_Debian_4.19.171-2_(2021-01-30)/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-12%2020:29:55?plugin=coverage&diff=/log/0/Linux/1_SMP_Debian_4.19.171-2_%282021-01-30%29/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-09%2014%3A42%3A51&ticket=31047&base=9.3.beta8) of the patchbot happy. Once this is made, I think we can set the ticket to positive review.",
    "created_at": "2021-03-13T16:28:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500553",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:27" align="right">Comment 27</div>

I've performed a few tests and everything seems OK. Thanks for the fix!

Regarding :comment:24, the class `_Function_swap_harmonic` in `src/sage/functions/log.py` should have some (minimal) doctests, as well as the function `_sympysage_function_by_name` and the class `UndefSageHelper` in `src/sage/interfaces/sympy.py`. This will make the [coverage plugin](https://patchbot.sagemath.org/log/31047/Linux/1_SMP_Debian_4.19.171-2_(2021-01-30)/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-12%2020:29:55?plugin=coverage&diff=/log/0/Linux/1_SMP_Debian_4.19.171-2_%282021-01-30%29/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-09%2014%3A42%3A51&ticket=31047&base=9.3.beta8) of the patchbot happy. Once this is made, I think we can set the ticket to positive review.



---

archive/issue_comments_500554.json:
```json
{
    "body": "Changed commit from **[2845ad2](https://github.com/sagemath/sagetrac-mirror/commit/2845ad24760072001715b246fd0096e87303ffb6)** to **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)**",
    "created_at": "2021-03-19T21:00:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500554",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[2845ad2](https://github.com/sagemath/sagetrac-mirror/commit/2845ad24760072001715b246fd0096e87303ffb6)** to **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)**



---

archive/issue_comments_500555.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">Comment 28</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f68e82f49ba5b0ff53b79222b469150baed9859d\">f68e82f</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/607c365d377d763e896b1d497464d9f44a7b48f9\">607c365</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393\">be11386</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>\n",
    "created_at": "2021-03-19T21:00:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500555",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:28" align="right">Comment 28</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f68e82f49ba5b0ff53b79222b469150baed9859d">f68e82f</a></td><td><code>sage.calculus.calculus: simplify handling of variables and symbolic functions during parsing</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/607c365d377d763e896b1d497464d9f44a7b48f9">607c365</a></td><td><code>add tests for Trac #31047</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393">be11386</a></td><td><code>sympy interface: fix conversion of symbolic functions from sympy</code></td></tr></table>




---

archive/issue_comments_500556.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nI have copied some of the tests to the new helper functions created in the new commits.\n\n(Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)",
    "created_at": "2021-03-19T21:08:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500556",
    "user": "https://github.com/spaghettisalat"
}
```

<div id="comment:29" align="right">Comment 29</div>

I have copied some of the tests to the new helper functions created in the new commits.

(Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)



---

archive/issue_comments_500557.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nReplying to [@spaghettisalat](#comment%3A29):\n> just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.\n\nHard to disagree with this, but we don't have a better way.",
    "created_at": "2021-03-19T21:26:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500557",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">Comment 30</div>

Replying to [@spaghettisalat](#comment%3A29):
> just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.

Hard to disagree with this, but we don't have a better way.



---

archive/issue_events_409890.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-20T09:26:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409890"
}
```



---

archive/issue_events_409891.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2021-03-20T09:26:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409891"
}
```



---

archive/issue_comments_500558.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nReplying to [@spaghettisalat](#comment%3A29):\n> I have copied some of the tests to the new helper functions created in the new commits.\n> \n\nOK, this provides only indirect doctests, but let's move on in order to have the fix merged in 9.3!\n\n> (Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)\n\nBeside testing, another virtue of doctests is to illustrate quickly the use of the function; this is useful even for helper functions, i.e. for functions that only developers are supposed to take a look at.",
    "created_at": "2021-03-20T09:26:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500558",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:31" align="right">Comment 31</div>

Replying to [@spaghettisalat](#comment%3A29):
> I have copied some of the tests to the new helper functions created in the new commits.
> 

OK, this provides only indirect doctests, but let's move on in order to have the fix merged in 9.3!

> (Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)

Beside testing, another virtue of doctests is to illustrate quickly the use of the function; this is useful even for helper functions, i.e. for functions that only developers are supposed to take a look at.



---

archive/issue_events_409892.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-20T20:55:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409892"
}
```



---

archive/issue_events_409893.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4c24441cf3c353fc59f44379ef0387f79d1113c3",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-03-20T20:55:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31047#event-409893"
}
```



---

archive/issue_comments_500559.json:
```json
{
    "body": "Changed branch from **[public/bug_convert_symbolic_function_from_maxima](https://github.com/sagemath/sagetrac-mirror/tree/public/bug_convert_symbolic_function_from_maxima)** to **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)**",
    "created_at": "2021-03-20T20:55:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500559",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/bug_convert_symbolic_function_from_maxima](https://github.com/sagemath/sagetrac-mirror/tree/public/bug_convert_symbolic_function_from_maxima)** to **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)**



---

archive/issue_comments_500560.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">Comment 33</div>\n\nThis ticket causes an issue with conversions in the Mathematica interface, see #31756. Do you have an idea that might solve this?",
    "created_at": "2021-04-30T07:04:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500560",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:33" align="right">Comment 33</div>

This ticket causes an issue with conversions in the Mathematica interface, see #31756. Do you have an idea that might solve this?



---

archive/issue_comments_500561.json:
```json
{
    "body": "Changed commit from **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)** to none",
    "created_at": "2021-04-30T07:04:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500561",
    "user": "https://github.com/mwageringel"
}
```

Changed commit from **[be11386](https://github.com/sagemath/sagetrac-mirror/commit/be11386f2d333a4185d8543adda8e5ec0759c393)** to none



---

archive/issue_comments_500562.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">Comment 34</div>\n\nAn unrelated comment on this change:\n\n```diff\n-def symbolic_expression_from_string(s, syms=None, accept_sequence=False):\n+def symbolic_expression_from_string(s, syms={}, accept_sequence=False):\n```\nUsually it is best to avoid using `{}` as default value, since it is mutable, so the value that is used as default for all calls to the function can change.\n\nThe way it is used in this particular case does not seem to make a problem, though, as the value is not mutated inside the function.",
    "created_at": "2021-04-30T07:12:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31047",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31047#issuecomment-500562",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:34" align="right">Comment 34</div>

An unrelated comment on this change:

```diff
-def symbolic_expression_from_string(s, syms=None, accept_sequence=False):
+def symbolic_expression_from_string(s, syms={}, accept_sequence=False):
```
Usually it is best to avoid using `{}` as default value, since it is mutable, so the value that is used as default for all calls to the function can change.

The way it is used in this particular case does not seem to make a problem, though, as the value is not mutated inside the function.
