# Issue 31289: Mark documentation builder as parallel_read_safe

archive/issues_031052.json:
```json
{
    "body": "According to https://www.sphinx-doc.org/en/master/extdev/index.html#extension-metadata one should specify `parallel_read_safe` if the builder is able to read source files in parallel.\n\n> `'parallel_read_safe'`: a boolean that specifies if parallel reading of source files can be used when the extension is loaded. It defaults to `False`, i.e. you have to explicitly specify your extension to be parallel-read-safe after checking that it is.\n\n\nThis is done in this ticket. I didn't have any problem with it, but I'm also not completely sure the builders are indeed able to read source files in parallel.\n\nCC:  @dimpase @jhpalmieri @seblabbe @slel\n\nBranch/Commit: 927c9342bc8011f6bcc0d81b9997d6a0d82c3d48\n\nReviewer: Dima Pasechnik, John Palmieri\n\nAuthor: Tobias Diez\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31289\n\n",
    "closed_at": "2021-03-14T15:03:23Z",
    "created_at": "2021-01-25T11:40:17Z",
    "labels": [
        "component: documentation",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Mark documentation builder as parallel_read_safe",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31289",
    "user": "https://github.com/tobiasdiez"
}
```
According to https://www.sphinx-doc.org/en/master/extdev/index.html#extension-metadata one should specify `parallel_read_safe` if the builder is able to read source files in parallel.

> `'parallel_read_safe'`: a boolean that specifies if parallel reading of source files can be used when the extension is loaded. It defaults to `False`, i.e. you have to explicitly specify your extension to be parallel-read-safe after checking that it is.


This is done in this ticket. I didn't have any problem with it, but I'm also not completely sure the builders are indeed able to read source files in parallel.

CC:  @dimpase @jhpalmieri @seblabbe @slel

Branch/Commit: 927c9342bc8011f6bcc0d81b9997d6a0d82c3d48

Reviewer: Dima Pasechnik, John Palmieri

Author: Tobias Diez

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31289





---

archive/issue_comments_443006.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-25T11:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443006",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_443007.json:
```json
{
    "body": "<a id='comment:2'></a>Is there a reason for doing this? It didn't speed up docbuilding for me. Why change from the default setting?",
    "created_at": "2021-01-25T22:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443007",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:2'></a>Is there a reason for doing this? It didn't speed up docbuilding for me. Why change from the default setting?



---

archive/issue_comments_443008.json:
```json
{
    "body": "<a id='comment:3'></a>You have to run `sphinx-build -jNUM` for this to be activated. This ticket is a first step to use this during sage's docbuild. My aim was actually to already implement this as part of this ticket, but I don't have the time right now.",
    "created_at": "2021-01-25T22:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443008",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:3'></a>You have to run `sphinx-build -jNUM` for this to be activated. This ticket is a first step to use this during sage's docbuild. My aim was actually to already implement this as part of this ticket, but I don't have the time right now.



---

archive/issue_comments_443009.json:
```json
{
    "body": "<a id='comment:4'></a>We have our homemade parallel docbuilding already. Are you hoping to replace that? I tried adding \"-j6\" to the sphinx-build command with this change:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py\nindex b07e9c100c..71973f683b 100644\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -121,7 +121,7 @@ def builder_helper(type):\n         else:\n             options += ' -D multidoc_first_pass=1'\n \n-        build_command = '-b %s -d %s %s %s %s'%(type, self._doctrees_dir(),\n+        build_command = '-j6 -b %s -d %s %s %s %s'%(type, self._doctrees_dir(),\n                                                   options, self.dir,\n                                                   output_dir)\n         logger.debug(build_command)\n```\nbut it didn't speed things up.",
    "created_at": "2021-01-25T22:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443009",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>We have our homemade parallel docbuilding already. Are you hoping to replace that? I tried adding "-j6" to the sphinx-build command with this change:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index b07e9c100c..71973f683b 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -121,7 +121,7 @@ def builder_helper(type):
         else:
             options += ' -D multidoc_first_pass=1'
 
-        build_command = '-b %s -d %s %s %s %s'%(type, self._doctrees_dir(),
+        build_command = '-j6 -b %s -d %s %s %s %s'%(type, self._doctrees_dir(),
                                                   options, self.dir,
                                                   output_dir)
         logger.debug(build_command)
```
but it didn't speed things up.



---

archive/issue_comments_443010.json:
```json
{
    "body": "<a id='comment:5'></a>This may also be related: when I run `./sage --docbuild all html` (as opposed to `make doc`), I see\n\n   For security reason, parallel mode is disabled on macOS and python3.8 and above. For more details, please read https://github.com/sphinx-doc/sphinx/issues/6803.",
    "created_at": "2021-01-25T22:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443010",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>This may also be related: when I run `./sage --docbuild all html` (as opposed to `make doc`), I see

   For security reason, parallel mode is disabled on macOS and python3.8 and above. For more details, please read https://github.com/sphinx-doc/sphinx/issues/6803.



---

archive/issue_comments_443011.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jhpalmieri]:\n> This may also be related: when I run `./sage --docbuild all html` (as opposed to `make doc`), I see\n> \n>    For security reason, parallel mode is disabled on macOS and python3.8 and above. For more details, please read https://github.com/sphinx-doc/sphinx/issues/6803.\n\n\nOn second thought, this may not be related, although `./sage --docbuild ...` is much slower on my Mac than `make doc` is, probably because of this issue.",
    "created_at": "2021-01-25T22:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443011",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>Replying to [comment:5 jhpalmieri]:
> This may also be related: when I run `./sage --docbuild all html` (as opposed to `make doc`), I see
> 
>    For security reason, parallel mode is disabled on macOS and python3.8 and above. For more details, please read https://github.com/sphinx-doc/sphinx/issues/6803.


On second thought, this may not be related, although `./sage --docbuild ...` is much slower on my Mac than `make doc` is, probably because of this issue.



---

archive/issue_comments_443012.json:
```json
{
    "body": "<a id='comment:7'></a>> We have our homemade parallel docbuilding already. Are you hoping to replace that?\n\n\nThat was my initial path. I had some problems with the current code, and thought maybe it's simpler to use sphinx built-in parallel mechanism anyway. But then the problems disappeared again, and I moved on to work on other things. That's why this ticket is only a very minimal step in this direction. But I guess it doesn't hurt to have it, although currently it does not change anything.",
    "created_at": "2021-01-28T16:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443012",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>> We have our homemade parallel docbuilding already. Are you hoping to replace that?


That was my initial path. I had some problems with the current code, and thought maybe it's simpler to use sphinx built-in parallel mechanism anyway. But then the problems disappeared again, and I moved on to work on other things. That's why this ticket is only a very minimal step in this direction. But I guess it doesn't hurt to have it, although currently it does not change anything.



---

archive/issue_comments_443013.json:
```json
{
    "body": "<a id='comment:8'></a>I think we should at some point replace our custom docbuilder with what's provided by Sphinxn -- as it's a hack no current Sage dev fully understands, and is thus very hard to maintain. \n\nIt would be great to have a ticket where the task to do this replacement is set out in steps.",
    "created_at": "2021-01-29T13:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443013",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>I think we should at some point replace our custom docbuilder with what's provided by Sphinxn -- as it's a hack no current Sage dev fully understands, and is thus very hard to maintain. 

It would be great to have a ticket where the task to do this replacement is set out in steps.



---

archive/issue_comments_443014.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-29T13:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443014",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_443015.json:
```json
{
    "body": "<a id='comment:10'></a>Thanks!",
    "created_at": "2021-01-29T16:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443015",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:10'></a>Thanks!



---

archive/issue_comments_443016.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-14T15:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31289#issuecomment-443016",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081849.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-14T15:03:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31289",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31289#event-81849"
}
```
