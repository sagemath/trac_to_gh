# Issue 31216: tox.ini (local): Add environment variables to skip system package installs and other steps, add mechanism for a local interactive shell

archive/issues_030979.json:
```json
{
    "body": "(from #31064)\n\nWe add the following to the `local-...` environments:\n\n- an environment variable that can be passed to tox to skip system package installs, directly reusing a previously set up system\n\n```\nSKIP_SYSTEM_PKG_INSTALL=yes tox -e local-homebrew-macos-standard -- config.status\nSKIP_SYSTEM_PKG_INSTALL=yes tox -e local-homebrew-macos-standard -- config.status\n```\n  This can save time and also give developers more control for experiments with system packages.\n\n- a target that gives an interactive shell in the tox environment:\n\n```\ntox -e local-homebrew-macos-standard -- bash\ntox -e local-direct -- bash\nSKIP_SYSTEM_PKG_INSTALL=yes SKIP_BOOTSTRAP=1 SKIP_CONFIGURE=1 tox -e local-homebrew-macos-standard -- bash\n```\n\n\nCC:  @tobiasdiez @kliem @dimpase\n\nReviewer: Tobias Diez\n\nAuthor: Matthias Koeppe\n\nBranch: 2d84b5ab5ac0741e872fb5a15539c2bbf935fe86\n\nDependencies: #30944\n\nCommit: 2d84b5ab5ac0741e872fb5a15539c2bbf935fe86\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31216\n\n",
    "closed_at": "2021-01-31T20:53:33Z",
    "created_at": "2021-01-09T19:19:23Z",
    "labels": [
        "component: porting"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "tox.ini (local): Add environment variables to skip system package installs and other steps, add mechanism for a local interactive shell",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31216",
    "user": "https://github.com/mkoeppe"
}
```
(from #31064)

We add the following to the `local-...` environments:

- an environment variable that can be passed to tox to skip system package installs, directly reusing a previously set up system

```
SKIP_SYSTEM_PKG_INSTALL=yes tox -e local-homebrew-macos-standard -- config.status
SKIP_SYSTEM_PKG_INSTALL=yes tox -e local-homebrew-macos-standard -- config.status
```
  This can save time and also give developers more control for experiments with system packages.

- a target that gives an interactive shell in the tox environment:

```
tox -e local-homebrew-macos-standard -- bash
tox -e local-direct -- bash
SKIP_SYSTEM_PKG_INSTALL=yes SKIP_BOOTSTRAP=1 SKIP_CONFIGURE=1 tox -e local-homebrew-macos-standard -- bash
```


CC:  @tobiasdiez @kliem @dimpase

Reviewer: Tobias Diez

Author: Matthias Koeppe

Branch: 2d84b5ab5ac0741e872fb5a15539c2bbf935fe86

Dependencies: #30944

Commit: 2d84b5ab5ac0741e872fb5a15539c2bbf935fe86

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31216





---

archive/issue_comments_441884.json:
```json
{
    "body": "<a id='comment:3'></a>Last 10 new commits:",
    "created_at": "2021-01-09T21:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441884",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Last 10 new commits:



---

archive/issue_comments_441885.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-10T00:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441885",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441886.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-10T00:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441886",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_441887.json:
```json
{
    "body": "<a id='comment:8'></a>On a first glance this looks good. Thanks! Could you please also add documentation for these tox commands / switches. Also I was wondering if one could add a `tox -e local-homebrew-macos-standard -- install-system-packages` that only installs the system packages?",
    "created_at": "2021-01-10T12:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441887",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:8'></a>On a first glance this looks good. Thanks! Could you please also add documentation for these tox commands / switches. Also I was wondering if one could add a `tox -e local-homebrew-macos-standard -- install-system-packages` that only installs the system packages?



---

archive/issue_comments_441888.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-10T21:07:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441888",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441889.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-11T04:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441890.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:8 gh-tobiasdiez]:\n> Could you please also add documentation for these tox commands / switches. \n\n\nDone\n\n> Also I was wondering if one could add a `tox -e local-homebrew-macos-standard -- install-system-packages` that only installs the system packages?\n\n\nI have instead added more `SKIP_...` options.",
    "created_at": "2021-01-11T04:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441890",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Replying to [comment:8 gh-tobiasdiez]:
> Could you please also add documentation for these tox commands / switches. 


Done

> Also I was wondering if one could add a `tox -e local-homebrew-macos-standard -- install-system-packages` that only installs the system packages?


I have instead added more `SKIP_...` options.



---

archive/issue_comments_441891.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 mkoeppe]:\n> I have instead added more `SKIP_...` options.\n> \n\n\nThanks! Would it also make sense to add one to skip `make`? (I remember you once told me how to do this, I think, it was via `config.status` or something - but maybe the version using skip is closer in spirit anyway).\n\nI'll review this once #30944 is merged in develop.",
    "created_at": "2021-01-11T15:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441891",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:13'></a>Replying to [comment:12 mkoeppe]:
> I have instead added more `SKIP_...` options.
> 


Thanks! Would it also make sense to add one to skip `make`? (I remember you once told me how to do this, I think, it was via `config.status` or something - but maybe the version using skip is closer in spirit anyway).

I'll review this once #30944 is merged in develop.



---

archive/issue_comments_441892.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 gh-tobiasdiez]:\n> Would it also make sense to add one to skip `make`? \n\n\nYou can just pass a make target that does nothing - such as `Makefile`",
    "created_at": "2021-01-11T19:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441892",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Replying to [comment:13 gh-tobiasdiez]:
> Would it also make sense to add one to skip `make`? 


You can just pass a make target that does nothing - such as `Makefile`



---

archive/issue_comments_441893.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-12T12:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441893",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_441894.json:
```json
{
    "body": "<a id='comment:15'></a>> local-sudo-standard run-test: commands[1] | bash -c 'case \"\" in 1|y*|Y*);; *) eval $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo update) ;;'/usr/bin/bash: -c: line 1: syntax error: unexpected end of file\n\n\nI think there is a \"esac\" missing at the end of these two lines:\n\n```\n\n+    local-{root,sudo}:    bash -c 'case \"{env:SKIP_SYSTEM_PKG_INSTALL:}\" in 1|y*|Y*);; *) eval $(build/bin/sage-print-system-package-command {env:SYSTEM} {env:__SUDO:} update) ;;'\n+    local-{root,sudo}:    bash -c 'case \"{env:SKIP_SYSTEM_PKG_INSTALL:}\" in 1|y*|Y*);; *) PACKAGES=$(build/bin/sage-get-system-packages {env:SYSTEM} $(PATH=build/bin:$PATH build/bin/sage-package list {env:SAGE_PACKAGE_LIST_ARGS}) _bootstrap); eval $(build/bin/sage-print-system-package-command {env:SYSTEM} {env:__SUDO:} --yes --no-install-recommends install $PACKAGES) || [ \"$IGNORE_MISSING_SYSTEM_PACKAGES\" = yes ] && echo \"(ignoring errors)\" ;;'\n\n```",
    "created_at": "2021-01-12T12:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441894",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:15'></a>> local-sudo-standard run-test: commands[1] | bash -c 'case "" in 1|y*|Y*);; *) eval $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo update) ;;'/usr/bin/bash: -c: line 1: syntax error: unexpected end of file


I think there is a "esac" missing at the end of these two lines:

```

+    local-{root,sudo}:    bash -c 'case "{env:SKIP_SYSTEM_PKG_INSTALL:}" in 1|y*|Y*);; *) eval $(build/bin/sage-print-system-package-command {env:SYSTEM} {env:__SUDO:} update) ;;'
+    local-{root,sudo}:    bash -c 'case "{env:SKIP_SYSTEM_PKG_INSTALL:}" in 1|y*|Y*);; *) PACKAGES=$(build/bin/sage-get-system-packages {env:SYSTEM} $(PATH=build/bin:$PATH build/bin/sage-package list {env:SAGE_PACKAGE_LIST_ARGS}) _bootstrap); eval $(build/bin/sage-print-system-package-command {env:SYSTEM} {env:__SUDO:} --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ;;'

```



---

archive/issue_comments_441895.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 mkoeppe]:\n> Replying to [comment:13 gh-tobiasdiez]:\n> > Would it also make sense to add one to skip `make`? \n\n> \n> You can just pass a make target that does nothing - such as `Makefile` \n> \n\n\n\n`tox -e local-sudo-standard Makefile` with `SKIP_BOOTSTRAP: yes` and `SKIP_CONFIGURE: yes` still runs `bootstrap` and `base-toolchain` in the `make` command, which then fails since `configure` was not called before.",
    "created_at": "2021-01-12T13:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441895",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:16'></a>Replying to [comment:14 mkoeppe]:
> Replying to [comment:13 gh-tobiasdiez]:
> > Would it also make sense to add one to skip `make`? 

> 
> You can just pass a make target that does nothing - such as `Makefile` 
> 



`tox -e local-sudo-standard Makefile` with `SKIP_BOOTSTRAP: yes` and `SKIP_CONFIGURE: yes` still runs `bootstrap` and `base-toolchain` in the `make` command, which then fails since `configure` was not called before.



---

archive/issue_comments_441896.json:
```json
{
    "body": "<a id='comment:17'></a>Ah, of course. Make that `configure.ac` instead of `Makefile`...",
    "created_at": "2021-01-12T18:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441896",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Ah, of course. Make that `configure.ac` instead of `Makefile`...



---

archive/issue_comments_441897.json:
```json
{
    "body": "<a id='comment:18'></a>That worked, thanks! Apart from the missing \"esac\" mentioned above, this looks good to me.",
    "created_at": "2021-01-18T17:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441897",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:18'></a>That worked, thanks! Apart from the missing "esac" mentioned above, this looks good to me.



---

archive/issue_comments_441898.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-18T19:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441898",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_441899.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-18T19:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441899",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_441900.json:
```json
{
    "body": "<a id='comment:21'></a>Is the prefix `[mkoeppe`@`sage sage]$` really needed / what's its purpose?\nhttps://github.com/sagemath/sagetrac-mirror/compare/u/mkoeppe/tox__improve_local_sudo_ubuntu_standard...u/mkoeppe/tox_ini__local___add_environment_variables_to_skip_system_package_installs__mechanism_for_a_local_interactive_shell#diff-c13a55474e037a35696cfba4768b81295c0383f1940052c5fcbef0737387f165R610\n\nOtherwise the changes look good to me.",
    "created_at": "2021-01-19T15:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441900",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:21'></a>Is the prefix `[mkoeppe`@`sage sage]$` really needed / what's its purpose?
https://github.com/sagemath/sagetrac-mirror/compare/u/mkoeppe/tox__improve_local_sudo_ubuntu_standard...u/mkoeppe/tox_ini__local___add_environment_variables_to_skip_system_package_installs__mechanism_for_a_local_interactive_shell#diff-c13a55474e037a35696cfba4768b81295c0383f1940052c5fcbef0737387f165R610

Otherwise the changes look good to me.



---

archive/issue_comments_441901.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:21 gh-tobiasdiez]:\n> Is the prefix `[mkoeppe`@`sage sage]$` really needed / what's its purpose?\n\n\nIt's a typical shell prompt on posix systems. The second `sage` indicates the current directory. This is consistent with other parts of the Sage developer guide, for example https://doc.sagemath.org/html/en/developer/doctesting.html",
    "created_at": "2021-01-19T19:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441901",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Replying to [comment:21 gh-tobiasdiez]:
> Is the prefix `[mkoeppe`@`sage sage]$` really needed / what's its purpose?


It's a typical shell prompt on posix systems. The second `sage` indicates the current directory. This is consistent with other parts of the Sage developer guide, for example https://doc.sagemath.org/html/en/developer/doctesting.html



---

archive/issue_comments_441902.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-19T21:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441902",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_441903.json:
```json
{
    "body": "<a id='comment:23'></a>Thanks, then it looks good to me!",
    "created_at": "2021-01-19T21:18:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441903",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:23'></a>Thanks, then it looks good to me!



---

archive/issue_comments_441904.json:
```json
{
    "body": "<a id='comment:24'></a>Thanks!",
    "created_at": "2021-01-19T21:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441904",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Thanks!



---

archive/issue_events_081594.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:53:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31216#event-81594"
}
```



---

archive/issue_comments_441905.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-31T20:53:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31216#issuecomment-441905",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
