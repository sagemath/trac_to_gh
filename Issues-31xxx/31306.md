# Issue 31306: sage.repl: Replace use of SAGE_EXTCODE by importlib.resources

archive/issues_031069.json:
```json
{
    "body": "We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) \n- `git grep 'SAGE_EXTCODE' src/sage`\n- `git grep '__file__' src/sage`\n\nThis will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)\n\nIn this ticket, we take care of `sage.repl`, moving data needed by its doctests from `SAGE_EXTCODE` (= `src/sage/ext_data`) into the package directory. (Thus, we avoid a dependency on support for resources in namespace packages brought by Python 3.10(?) or the backport package `importlib-resources`, see https://github.com/python/importlib_resources/pull/196)\n\nFollow-up tickets will deal with other parts of the library. In the end, the directory `src/sage/ext_data` will be eliminated.\n\nReferences:\n- https://docs.python.org/3/library/importlib.html#module-importlib.resources\n- https://importlib-resources.readthedocs.io/en/latest/migration.html\n- https://importlib-resources.readthedocs.io/en/latest/using.html\n\n\n\nCC:  @tobiasdiez @fchapoton @kiwifb @dimpase @soehms @tscrim\n\nBranch/Commit: d925cd2f322cf8230a6e9f86bef03ce020fc12bf\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31306\n\n",
    "closed_at": "2022-01-31T23:31:37Z",
    "created_at": "2021-01-30T18:16:23Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "sage.repl: Replace use of SAGE_EXTCODE by importlib.resources",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31306",
    "user": "https://github.com/mkoeppe"
}
```
We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) 
- `git grep 'SAGE_EXTCODE' src/sage`
- `git grep '__file__' src/sage`

This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)

In this ticket, we take care of `sage.repl`, moving data needed by its doctests from `SAGE_EXTCODE` (= `src/sage/ext_data`) into the package directory. (Thus, we avoid a dependency on support for resources in namespace packages brought by Python 3.10(?) or the backport package `importlib-resources`, see https://github.com/python/importlib_resources/pull/196)

Follow-up tickets will deal with other parts of the library. In the end, the directory `src/sage/ext_data` will be eliminated.

References:
- https://docs.python.org/3/library/importlib.html#module-importlib.resources
- https://importlib-resources.readthedocs.io/en/latest/migration.html
- https://importlib-resources.readthedocs.io/en/latest/using.html



CC:  @tobiasdiez @fchapoton @kiwifb @dimpase @soehms @tscrim

Branch/Commit: d925cd2f322cf8230a6e9f86bef03ce020fc12bf

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31306





---

archive/issue_events_081930.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31306#event-81930"
}
```



---

archive/issue_comments_473548.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,15 +1,16 @@\n-We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources`. \n+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) \n - `git grep 'SAGE_EXTCODE' src/sage`\n - `git grep '__file__' src/sage`\n \n This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)\n \n-(requires python 3.7 (hence the dependency on #30551) or add the backport package `importlib_resources` if we want to support 3.6 - but that does not support resources within native namespace packages)\n-\n References:\n - https://docs.python.org/3/library/importlib.html#module-importlib.resources\n - https://importlib-resources.readthedocs.io/en/latest/migration.html\n - https://importlib-resources.readthedocs.io/en/latest/using.html\n+\n+\n+\n \n Dependencies: #30551\n \n``````\n",
    "created_at": "2021-12-06T02:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473548",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,15 +1,16 @@
-We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources`. 
+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) 
 - `git grep 'SAGE_EXTCODE' src/sage`
 - `git grep '__file__' src/sage`
 
 This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)
 
-(requires python 3.7 (hence the dependency on #30551) or add the backport package `importlib_resources` if we want to support 3.6 - but that does not support resources within native namespace packages)
-
 References:
 - https://docs.python.org/3/library/importlib.html#module-importlib.resources
 - https://importlib-resources.readthedocs.io/en/latest/migration.html
 - https://importlib-resources.readthedocs.io/en/latest/using.html
+
+
+
 
 Dependencies: #30551
 
``````




---

archive/issue_comments_473549.json:
```json
{
    "body": "<a id='comment:4'></a>Last 10 new commits:",
    "created_at": "2021-12-06T03:31:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473549",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>Last 10 new commits:



---

archive/issue_comments_473550.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-06T03:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473550",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_473551.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-06T03:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473551",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_473552.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,17 @@\n+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) \n+- `git grep 'SAGE_EXTCODE' src/sage`\n+- `git grep '__file__' src/sage`\n+\n+This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)\n+\n+In this ticket, we take care of `sage.repl`. Follow-up tickets will deal with other parts of the library.\n+\n+References:\n+- https://docs.python.org/3/library/importlib.html#module-importlib.resources\n+- https://importlib-resources.readthedocs.io/en/latest/migration.html\n+- https://importlib-resources.readthedocs.io/en/latest/using.html\n+\n+\n \n \n Dependencies: #30551\n``````\n",
    "created_at": "2021-12-06T17:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473552",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,17 @@
+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) 
+- `git grep 'SAGE_EXTCODE' src/sage`
+- `git grep '__file__' src/sage`
+
+This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)
+
+In this ticket, we take care of `sage.repl`. Follow-up tickets will deal with other parts of the library.
+
+References:
+- https://docs.python.org/3/library/importlib.html#module-importlib.resources
+- https://importlib-resources.readthedocs.io/en/latest/migration.html
+- https://importlib-resources.readthedocs.io/en/latest/using.html
+
+
 
 
 Dependencies: #30551
``````




---

archive/issue_comments_473553.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-12T18:16:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_473554.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,17 @@\n+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) \n+- `git grep 'SAGE_EXTCODE' src/sage`\n+- `git grep '__file__' src/sage`\n+\n+This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)\n+\n+In this ticket, we take care of `sage.repl`. Follow-up tickets will deal with other parts of the library.\n+\n+References:\n+- https://docs.python.org/3/library/importlib.html#module-importlib.resources\n+- https://importlib-resources.readthedocs.io/en/latest/migration.html\n+- https://importlib-resources.readthedocs.io/en/latest/using.html\n+- https://github.com/python/importlib_resources/pull/196 - Add support for resources in namespace packages\n+\n \n \n Dependencies: #30551\n``````\n",
    "created_at": "2021-12-17T03:36:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473554",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,17 @@
+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) 
+- `git grep 'SAGE_EXTCODE' src/sage`
+- `git grep '__file__' src/sage`
+
+This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)
+
+In this ticket, we take care of `sage.repl`. Follow-up tickets will deal with other parts of the library.
+
+References:
+- https://docs.python.org/3/library/importlib.html#module-importlib.resources
+- https://importlib-resources.readthedocs.io/en/latest/migration.html
+- https://importlib-resources.readthedocs.io/en/latest/using.html
+- https://github.com/python/importlib_resources/pull/196 - Add support for resources in namespace packages
+
 
 
 Dependencies: #30551
``````




---

archive/issue_comments_473555.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) \n+- `git grep 'SAGE_EXTCODE' src/sage`\n+- `git grep '__file__' src/sage`\n+\n+This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)\n+\n+In this ticket, we take care of `sage.repl`, moving data needed by its doctests from `SAGE_EXTCODE` (= `src/sage/ext_data`) into the package directory. (Thus, we avoid a dependency on support for resources in namespace packages brought by Python 3.10(?) or the backport package `importlib-resources`, see https://github.com/python/importlib_resources/pull/196)\n+\n+Follow-up tickets will deal with other parts of the library. In the end, the directory `src/sage/ext_data` will be eliminated.\n+\n+References:\n+- https://docs.python.org/3/library/importlib.html#module-importlib.resources\n+- https://importlib-resources.readthedocs.io/en/latest/migration.html\n+- https://importlib-resources.readthedocs.io/en/latest/using.html\n+\n \n \n Dependencies: #30551\n``````\n",
    "created_at": "2021-12-17T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473555",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,18 @@
+We eliminate direct reading of files from the package directories of sagelib by using `importlib.resources` (available since python 3.7) 
+- `git grep 'SAGE_EXTCODE' src/sage`
+- `git grep '__file__' src/sage`
+
+This will help make sagelib `zip_safe` (https://setuptools.readthedocs.io/en/latest/userguide/miscellaneous.html#setting-the-zip-safe-flag)
+
+In this ticket, we take care of `sage.repl`, moving data needed by its doctests from `SAGE_EXTCODE` (= `src/sage/ext_data`) into the package directory. (Thus, we avoid a dependency on support for resources in namespace packages brought by Python 3.10(?) or the backport package `importlib-resources`, see https://github.com/python/importlib_resources/pull/196)
+
+Follow-up tickets will deal with other parts of the library. In the end, the directory `src/sage/ext_data` will be eliminated.
+
+References:
+- https://docs.python.org/3/library/importlib.html#module-importlib.resources
+- https://importlib-resources.readthedocs.io/en/latest/migration.html
+- https://importlib-resources.readthedocs.io/en/latest/using.html
+
 
 
 Dependencies: #30551
``````




---

archive/issue_comments_473556.json:
```json
{
    "body": "<a id='comment:13'></a>The testsuite failures are unrelated",
    "created_at": "2021-12-17T16:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473556",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>The testsuite failures are unrelated



---

archive/issue_comments_473557.json:
```json
{
    "body": "<a id='comment:14'></a>lgtm",
    "created_at": "2021-12-18T00:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473557",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>lgtm



---

archive/issue_comments_473558.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-18T00:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473558",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_473559.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks!",
    "created_at": "2021-12-18T00:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473559",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Thanks!



---

archive/issue_comments_473560.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-12-23T21:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473560",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_473561.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-12-23T21:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473561",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_473562.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-23T21:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473562",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_473563.json:
```json
{
    "body": "<a id='comment:17'></a>trivial merge",
    "created_at": "2021-12-23T21:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473563",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>trivial merge



---

archive/issue_events_081931.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31306#event-81931"
}
```



---

archive/issue_events_081932.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31306#event-81932"
}
```



---

archive/issue_comments_473564.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-01-23T01:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473564",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_473565.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2022-01-23T01:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473565",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_473566.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-23T01:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473566",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_473567.json:
```json
{
    "body": "<a id='comment:21'></a>OK, Volker has started merging stuff for 9.6 including this. And I get \n\n```\n$ sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2022-01-31-20-37-00-111581fe.\nUsing --optional=pip,sage\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file.\nsage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 248, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputSceneWavefront.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[15]>\", line 1, in <module>\n        backend.validate(dm.types.OutputSceneWavefront.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py\", line 354, in example\n        scene_obj = OutputBuffer.from_file(filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example_wavefront_scene.obj'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 249, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputSceneCanvas3d.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[16]>\", line 1, in <module>\n        backend.validate(dm.types.OutputSceneCanvas3d.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py\", line 161, in example\n        return cls(OutputBuffer.from_file(filename))\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.canvas3d'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 250, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoOgg.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[17]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoOgg.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.ogv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 251, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoWebM.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[18]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoWebM.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.webm'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 252, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoMp4.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[19]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoMp4.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mp4'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 253, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoFlash.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[20]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoFlash.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.flv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 254, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoMatroska.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[21]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoMatroska.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mkv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 255, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoAvi.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[22]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoAvi.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.avi'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 256, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoWmv.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[23]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoWmv.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.wmv'\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py\", line 257, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate\nFailed example:\n    backend.validate(dm.types.OutputVideoQuicktime.example())\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[24]>\", line 1, in <module>\n        backend.validate(dm.types.OutputVideoQuicktime.example())\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py\", line 75, in example\n        return cls(OutputBuffer.from_file(filename),\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 114, in from_file\n        buf._chmod_readonly(buf._filename)\n      File \"/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py\", line 146, in _chmod_readonly\n        os.chmod(filename, mode)\n    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mov'\n**********************************************************************\n```\nAnd it comes down to that block https://github.com/sagemath/sage/blob/develop/src/sage/repl/rich_output/buffer.py#L139 - `chmod` is not done if the file is in the `SAGE_EXTCODE` folder but executed otherwise. Of course all those files have been moved out of `SAGE_EXTCODE`.",
    "created_at": "2022-01-31T08:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473567",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:21'></a>OK, Volker has started merging stuff for 9.6 including this. And I get 

```
$ sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py
too many failed tests, not using stored timings
Running doctests with ID 2022-01-31-20-37-00-111581fe.
Using --optional=pip,sage
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file.
sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 248, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputSceneWavefront.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[15]>", line 1, in <module>
        backend.validate(dm.types.OutputSceneWavefront.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py", line 354, in example
        scene_obj = OutputBuffer.from_file(filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example_wavefront_scene.obj'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 249, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputSceneCanvas3d.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[16]>", line 1, in <module>
        backend.validate(dm.types.OutputSceneCanvas3d.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py", line 161, in example
        return cls(OutputBuffer.from_file(filename))
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.canvas3d'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 250, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoOgg.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[17]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoOgg.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.ogv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 251, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoWebM.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[18]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoWebM.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.webm'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 252, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoMp4.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[19]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoMp4.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mp4'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 253, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoFlash.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[20]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoFlash.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.flv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 254, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoMatroska.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[21]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoMatroska.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mkv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 255, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoAvi.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[22]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoAvi.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.avi'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 256, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoWmv.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[23]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoWmv.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.wmv'
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/backend_doctest.py", line 257, in sage.repl.rich_output.backend_doctest.BackendDoctest.validate
Failed example:
    backend.validate(dm.types.OutputVideoQuicktime.example())
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.rich_output.backend_doctest.BackendDoctest.validate[24]>", line 1, in <module>
        backend.validate(dm.types.OutputVideoQuicktime.example())
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py", line 75, in example
        return cls(OutputBuffer.from_file(filename),
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 114, in from_file
        buf._chmod_readonly(buf._filename)
      File "/usr/lib/python3.10/site-packages/sage/repl/rich_output/buffer.py", line 146, in _chmod_readonly
        os.chmod(filename, mode)
    PermissionError: [Errno 1] Operation not permitted: '/usr/lib/python3.10/site-packages/sage/repl/rich_output/example.mov'
**********************************************************************
```
And it comes down to that block https://github.com/sagemath/sage/blob/develop/src/sage/repl/rich_output/buffer.py#L139 - `chmod` is not done if the file is in the `SAGE_EXTCODE` folder but executed otherwise. Of course all those files have been moved out of `SAGE_EXTCODE`.



---

archive/issue_comments_473568.json:
```json
{
    "body": "<a id='comment:22'></a>I also have\n\n```\nsage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py  # 25 doctests failed\nsage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py  # 14 doctests failed\n```\nbecause of the same thing. I guess it doesn't fail on user space build because you can safely `chmod` anything.",
    "created_at": "2022-01-31T08:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473568",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:22'></a>I also have

```
sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_graphics3d.py  # 25 doctests failed
sage -t --long --random-seed=241985268132368173591124256826068888319 /usr/lib/python3.10/site-packages/sage/repl/rich_output/output_video.py  # 14 doctests failed
```
because of the same thing. I guess it doesn't fail on user space build because you can safely `chmod` anything.



---

archive/issue_comments_473569.json:
```json
{
    "body": "<a id='comment:23'></a>Follow up at #33256.",
    "created_at": "2022-01-31T09:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473569",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:23'></a>Follow up at #33256.



---

archive/issue_comments_473570.json:
```json
{
    "body": "<a id='comment:24'></a>Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...",
    "created_at": "2022-01-31T12:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473570",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...



---

archive/issue_comments_473571.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 dimpase]:\n> Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...\n\n\nIs it the `python3.10` or the `/usr/lib/` that makes you go \"wow\"? I can do the `python3.9` flavor too if you want. I have been doctesting system installed sage and reporting from those tests for the last 10 years so I may be a bit blaz\u00e9 about it.",
    "created_at": "2022-01-31T18:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473571",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:25'></a>Replying to [comment:24 dimpase]:
> Wow, doctesting of `/usr/lib/python3.10/site-packages/sage/`...


Is it the `python3.10` or the `/usr/lib/` that makes you go "wow"? I can do the `python3.9` flavor too if you want. I have been doctesting system installed sage and reporting from those tests for the last 10 years so I may be a bit blazé about it.



---

archive/issue_comments_473572.json:
```json
{
    "body": "<a id='comment:26'></a>it's about /usr/lib",
    "created_at": "2022-01-31T21:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473572",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>it's about /usr/lib



---

archive/issue_comments_473573.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-31T23:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31306#issuecomment-473573",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081933.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-31T23:31:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31306",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31306#event-81933"
}
```
