# Issue 31236: Fix hashing of permutation group elements

archive/issues_030999.json:
```json
{
    "assignees": [],
    "body": "As noticed on [this sage-devel thread](https://groups.google.com/g/sage-devel/c/0Ca0m94lfOE) the hash function of `PermutationGroupElement` does not behave coherently with respect to the natural inclusions `SymmetricGroup(n) c SymmetricGroup(n+1)`.\n\nWe design a hash function:\n- whose value on the identity is 1\n- which does only depend on the support (ie ignores fixed points so that the hash is consistent with permutation restriction)\n- which is independent of the domain ordering\n\nBranch/Commit: **[u/vdelecroix/31236](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/31236) @ [e2e4d1d](https://github.com/sagemath/sagetrac-mirror/commit/e2e4d1d7fdcf87355af69f46e8d90e7e1e69a552)**\n\nReviewer: **Dima Pasechnik, \u200bDavid Roe**\n\nAuthor: **Vincent Delecroix**\n\nComponent: **group theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31236_\n\n",
    "created_at": "2021-01-14T12:01:07Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20group%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix hashing of permutation group elements",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/31236",
    "user": "https://github.com/videlec"
}
```
As noticed on [this sage-devel thread](https://groups.google.com/g/sage-devel/c/0Ca0m94lfOE) the hash function of `PermutationGroupElement` does not behave coherently with respect to the natural inclusions `SymmetricGroup(n) c SymmetricGroup(n+1)`.

We design a hash function:
- whose value on the identity is 1
- which does only depend on the support (ie ignores fixed points so that the hash is consistent with permutation restriction)
- which is independent of the domain ordering

Branch/Commit: **[u/vdelecroix/31236](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/31236) @ [e2e4d1d](https://github.com/sagemath/sagetrac-mirror/commit/e2e4d1d7fdcf87355af69f46e8d90e7e1e69a552)**

Reviewer: **Dima Pasechnik, â€‹David Roe**

Author: **Vincent Delecroix**

Component: **group theory**

_Issue created by migration from https://trac.sagemath.org/ticket/31236_





---

archive/issue_events_430492.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-14T12:01:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430492"
}
```



---

archive/issue_events_430493.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-14T12:01:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430493"
}
```



---

archive/issue_events_430494.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-14T12:01:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430494"
}
```



---

archive/issue_comments_500597.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-As noticed on [this sage-devel thread](https://groups.google.com/g/sage-devel/c/0Ca0m94lfOE) the hash function of `PermutationGroupElement` do not behave coherently with respect to the natural inclusions `SymmetricGroup(n) c SymmetricGroup(n+1)`.\n+As noticed on [this sage-devel thread](https://groups.google.com/g/sage-devel/c/0Ca0m94lfOE) the hash function of `PermutationGroupElement` does not behave coherently with respect to the natural inclusions `SymmetricGroup(n) c SymmetricGroup(n+1)`.\n \n We design a hash function:\n - whose value on the identity is 1\n``````\n",
    "created_at": "2021-01-14T12:01:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500597",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-As noticed on [this sage-devel thread](https://groups.google.com/g/sage-devel/c/0Ca0m94lfOE) the hash function of `PermutationGroupElement` do not behave coherently with respect to the natural inclusions `SymmetricGroup(n) c SymmetricGroup(n+1)`.
+As noticed on [this sage-devel thread](https://groups.google.com/g/sage-devel/c/0Ca0m94lfOE) the hash function of `PermutationGroupElement` does not behave coherently with respect to the natural inclusions `SymmetricGroup(n) c SymmetricGroup(n+1)`.
 
 We design a hash function:
 - whose value on the identity is 1
``````




---

archive/issue_comments_500598.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nGAP has a function `LargestMovedPoint()` for permutations, so instead of using `self.n`, where `n` is the degree of the permutation group, one can use this value to iterate over while computing the hash.\n\nWhile this does not ignore all the fixed points, this is still OK in terms of the consistency.",
    "created_at": "2021-01-14T12:24:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500598",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:2" align="right">comment:2</div>

GAP has a function `LargestMovedPoint()` for permutations, so instead of using `self.n`, where `n` is the degree of the permutation group, one can use this value to iterate over while computing the hash.

While this does not ignore all the fixed points, this is still OK in terms of the consistency.



---

archive/issue_events_430495.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-14T12:25:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20group%20theory",
    "label_color": "0000ff",
    "label_name": "c: group theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430495"
}
```



---

archive/issue_comments_500599.json:
```json
{
    "body": "Commit: **[462fdb1](https://github.com/sagemath/sagetrac-mirror/commit/462fdb1f2b903204041b6fc304ce2099aceae062)**",
    "created_at": "2021-01-14T12:41:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500599",
    "user": "https://github.com/videlec"
}
```

Commit: **[462fdb1](https://github.com/sagemath/sagetrac-mirror/commit/462fdb1f2b903204041b6fc304ce2099aceae062)**



---

archive/issue_comments_500600.json:
```json
{
    "body": "Branch: **[u/vdelecroix/31236](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/31236)**",
    "created_at": "2021-01-14T12:41:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500600",
    "user": "https://github.com/videlec"
}
```

Branch: **[u/vdelecroix/31236](https://github.com/sagemath/sagetrac-mirror/tree/u/vdelecroix/31236)**



---

archive/issue_comments_500601.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/462fdb1f2b903204041b6fc304ce2099aceae062\">462fdb1</a></td><td><code>31236: fix hash function of permutations</code></td></tr></table>\n",
    "created_at": "2021-01-14T12:41:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500601",
    "user": "https://github.com/videlec"
}
```

<div id="comment:4"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/462fdb1f2b903204041b6fc304ce2099aceae062">462fdb1</a></td><td><code>31236: fix hash function of permutations</code></td></tr></table>




---

archive/issue_events_430496.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-14T12:41:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430496"
}
```



---

archive/issue_comments_500602.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWhat is `145623773L` doing there? \n\nAre you replacing something which looks to me as a perfect hash function (i.e. no collisions) with something that might have collisions?",
    "created_at": "2021-01-14T13:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500602",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:5" align="right">comment:5</div>

What is `145623773L` doing there? 

Are you replacing something which looks to me as a perfect hash function (i.e. no collisions) with something that might have collisions?



---

archive/issue_comments_500603.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nIf you find a collision, I pay you a beer.",
    "created_at": "2021-01-14T13:40:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500603",
    "user": "https://github.com/videlec"
}
```

<div id="comment:6" align="right">comment:6</div>

If you find a collision, I pay you a beer.



---

archive/issue_comments_500604.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI asked a theory question.",
    "created_at": "2021-01-14T15:35:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500604",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">comment:7</div>

I asked a theory question.



---

archive/issue_comments_500605.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\n`145623773L` is an offset to ensure bit shuffling. See https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function (though I might not have used the best constants).",
    "created_at": "2021-01-14T16:25:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500605",
    "user": "https://github.com/videlec"
}
```

<div id="comment:8" align="right">comment:8</div>

`145623773L` is an offset to ensure bit shuffling. See https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function (though I might not have used the best constants).



---

archive/issue_comments_500606.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nthanks. please add this info in the docs.",
    "created_at": "2021-01-14T16:42:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500606",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">comment:9</div>

thanks. please add this info in the docs.



---

archive/issue_comments_500607.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ba9d62d7cdd8cf81f3e06d1399af8b0cb9d57bc4\">ba9d62d</a></td><td><code>31326: reference for algorithm</code></td></tr></table>\n",
    "created_at": "2021-01-14T16:47:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500607",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:10"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ba9d62d7cdd8cf81f3e06d1399af8b0cb9d57bc4">ba9d62d</a></td><td><code>31326: reference for algorithm</code></td></tr></table>




---

archive/issue_comments_500608.json:
```json
{
    "body": "Changed commit from **[462fdb1](https://github.com/sagemath/sagetrac-mirror/commit/462fdb1f2b903204041b6fc304ce2099aceae062)** to **[ba9d62d](https://github.com/sagemath/sagetrac-mirror/commit/ba9d62d7cdd8cf81f3e06d1399af8b0cb9d57bc4)**",
    "created_at": "2021-01-14T16:47:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500608",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[462fdb1](https://github.com/sagemath/sagetrac-mirror/commit/462fdb1f2b903204041b6fc304ce2099aceae062)** to **[ba9d62d](https://github.com/sagemath/sagetrac-mirror/commit/ba9d62d7cdd8cf81f3e06d1399af8b0cb9d57bc4)**



---

archive/issue_comments_500609.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\ndone",
    "created_at": "2021-01-14T16:47:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500609",
    "user": "https://github.com/videlec"
}
```

<div id="comment:11" align="right">comment:11</div>

done



---

archive/issue_comments_500610.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-01-16T22:09:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500610",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_500611.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nOK, looks good, thanks.",
    "created_at": "2021-01-16T22:09:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500611",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:12" align="right">comment:12</div>

OK, looks good, thanks.



---

archive/issue_events_430497.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-16T22:09:33Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430497"
}
```



---

archive/issue_events_430498.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-16T22:09:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430498"
}
```



---

archive/issue_events_430499.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-17T07:06:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430499"
}
```



---

archive/issue_events_430500.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-17T07:06:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430500"
}
```



---

archive/issue_comments_500612.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\n\n```\nsage: S1 = SymmetricGroup(FiniteEnumeratedSet([1,2,3]))\nsage: S2 = SymmetricGroup(FiniteEnumeratedSet([2,1,3]))\nsage: S1(\"(1,3,2)\") == S2(\"(1,3,2)\")\nTrue\nsage: hash(S1(\"(1,3,2)\")) == hash(S2(\"(1,3,2)\"))\nFalse\n```",
    "created_at": "2021-01-17T07:06:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500612",
    "user": "https://github.com/videlec"
}
```

<div id="comment:13" align="right">comment:13</div>


```
sage: S1 = SymmetricGroup(FiniteEnumeratedSet([1,2,3]))
sage: S2 = SymmetricGroup(FiniteEnumeratedSet([2,1,3]))
sage: S1("(1,3,2)") == S2("(1,3,2)")
True
sage: hash(S1("(1,3,2)")) == hash(S2("(1,3,2)"))
False
```



---

archive/issue_comments_500613.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3e2994829b5c1ce4ad74c1400015339498240c18\">3e29948</a></td><td><code>31326: change algorithm for consistency</code></td></tr></table>\n",
    "created_at": "2021-01-17T09:34:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500613",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3e2994829b5c1ce4ad74c1400015339498240c18">3e29948</a></td><td><code>31326: change algorithm for consistency</code></td></tr></table>




---

archive/issue_comments_500614.json:
```json
{
    "body": "Changed commit from **[ba9d62d](https://github.com/sagemath/sagetrac-mirror/commit/ba9d62d7cdd8cf81f3e06d1399af8b0cb9d57bc4)** to **[3e29948](https://github.com/sagemath/sagetrac-mirror/commit/3e2994829b5c1ce4ad74c1400015339498240c18)**",
    "created_at": "2021-01-17T09:34:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500614",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[ba9d62d](https://github.com/sagemath/sagetrac-mirror/commit/ba9d62d7cdd8cf81f3e06d1399af8b0cb9d57bc4)** to **[3e29948](https://github.com/sagemath/sagetrac-mirror/commit/3e2994829b5c1ce4ad74c1400015339498240c18)**



---

archive/issue_comments_500615.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nConsistent hashing with more tests.",
    "created_at": "2021-01-17T09:35:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500615",
    "user": "https://github.com/videlec"
}
```

<div id="comment:15" align="right">comment:15</div>

Consistent hashing with more tests.



---

archive/issue_events_430501.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-17T09:35:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430501"
}
```



---

archive/issue_events_430502.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2021-01-17T09:35:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430502"
}
```



---

archive/issue_comments_500616.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,5 @@\n \n We design a hash function:\n - whose value on the identity is 1\n-- which does only depend on the support (ie ignores fixed points)\n+- which does only depend on the support (ie ignores fixed points so that the hash is consistent with permutation restriction)\n+- which is independent of the domain ordering\n``````\n",
    "created_at": "2021-01-17T09:36:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500616",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,5 @@
 
 We design a hash function:
 - whose value on the identity is 1
-- which does only depend on the support (ie ignores fixed points)
+- which does only depend on the support (ie ignores fixed points so that the hash is consistent with permutation restriction)
+- which is independent of the domain ordering
``````




---

archive/issue_comments_500617.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nCan't one do hashing based on the position in the lexicographically ordered set of all permutations?\n\nhttps://en.wikipedia.org/wiki/Factorial_number_system",
    "created_at": "2021-01-18T00:24:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500617",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

Can't one do hashing based on the position in the lexicographically ordered set of all permutations?

https://en.wikipedia.org/wiki/Factorial_number_system



---

archive/issue_comments_500618.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nSee [comment:13](#comment:13) for why this will not work.",
    "created_at": "2021-01-18T10:46:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500618",
    "user": "https://github.com/videlec"
}
```

<div id="comment:18" align="right">comment:18</div>

See [comment:13](#comment:13) for why this will not work.



---

archive/issue_comments_500619.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@videlec](#comment:18):\n> See [comment:13](#comment:13) for why this will not work.\n\nThis seems to be an entirely different issue - one can 1st canonise the permutation to the standard\ndomain [1..n], and only then compute hash.\n\n\n---\n\nHaving said this, it's in general a quite bad idea to ignore the nature of the group the element comes from, as it affects the performance of algorithms quite badly. Every permutation group G has a base, a minimal size set B  s.t. g_1(B)\\=g_2(B) as soon as g_1\\=g_2, and for transitive permutation groups this is in general the quickest test, and |B| is usually very small compared to the degree (it's even possible to quantify what \"usually\" means here - e.g. for primitive groups \nthis is governed by [O'Nan-Scott theorem](https://en.wikipedia.org/wiki/O%27Nan%E2%80%93Scott_theorem)).",
    "created_at": "2021-01-18T16:55:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500619",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@videlec](#comment:18):
> See [comment:13](#comment:13) for why this will not work.

This seems to be an entirely different issue - one can 1st canonise the permutation to the standard
domain [1..n], and only then compute hash.


---

Having said this, it's in general a quite bad idea to ignore the nature of the group the element comes from, as it affects the performance of algorithms quite badly. Every permutation group G has a base, a minimal size set B  s.t. g_1(B)\=g_2(B) as soon as g_1\=g_2, and for transitive permutation groups this is in general the quickest test, and |B| is usually very small compared to the degree (it's even possible to quantify what "usually" means here - e.g. for primitive groups 
this is governed by [O'Nan-Scott theorem](https://en.wikipedia.org/wiki/O%27Nan%E2%80%93Scott_theorem)).



---

archive/issue_comments_500620.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@dimpase](#comment:19):\n> Replying to [@videlec](#comment:18):\n> > See [comment:13](#comment:13) for why this will not work.\n\n> This seems to be an entirely different issue - one can 1st canonise the permutation to the standard\n> domain [1..n], and only then compute hash.\n\n \nHow do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?\n\n> ---\n> \n> Having said this, it's in general a quite bad idea to ignore the nature of the group the element comes from, as it affects the performance of algorithms quite badly. Every permutation group G has a base, a minimal size set B  s.t. g_1(B)\\=g_2(B) as soon as g_1\\=g_2, and for transitive permutation groups this is in general the quickest test, and |B| is usually very small compared to the degree (it's even possible to quantify what \"usually\" means here - e.g. for primitive groups \n> this is governed by [O'Nan-Scott theorem](https://en.wikipedia.org/wiki/O%27Nan%E2%80%93Scott_theorem)).\n\nWhy is this relevent for hashing?",
    "created_at": "2021-01-18T17:03:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500620",
    "user": "https://github.com/videlec"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@dimpase](#comment:19):
> Replying to [@videlec](#comment:18):
> > See [comment:13](#comment:13) for why this will not work.

> This seems to be an entirely different issue - one can 1st canonise the permutation to the standard
> domain [1..n], and only then compute hash.

 
How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?

> ---
> 
> Having said this, it's in general a quite bad idea to ignore the nature of the group the element comes from, as it affects the performance of algorithms quite badly. Every permutation group G has a base, a minimal size set B  s.t. g_1(B)\=g_2(B) as soon as g_1\=g_2, and for transitive permutation groups this is in general the quickest test, and |B| is usually very small compared to the degree (it's even possible to quantify what "usually" means here - e.g. for primitive groups 
> this is governed by [O'Nan-Scott theorem](https://en.wikipedia.org/wiki/O%27Nan%E2%80%93Scott_theorem)).

Why is this relevent for hashing?



---

archive/issue_comments_500621.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@videlec](#comment:20):\n> Replying to [@dimpase](#comment:19):\n> > Replying to [@videlec](#comment:18):\n> > > See [comment:13](#comment:13) for why this will not work.\n\n> > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard\n> > domain [1..n], and only then compute hash.\n\n>  \n> How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?\n\nBy their positions in the list, i.e. as `[1,2,3]`, why not?\n\n\n> \n> > \n> > ---\n> > \n> > Having said this, it's in general a quite bad idea to ignore the nature of the group the element comes from, as it affects the performance of algorithms quite badly. Every permutation group G has a base, a minimal size set B  s.t. g_1(B)\\=g_2(B) as soon as g_1\\=g_2, and for transitive permutation groups this is in general the quickest test, and |B| is usually very small compared to the degree (it's even possible to quantify what \"usually\" means here - e.g. for primitive groups \n> > this is governed by [O'Nan-Scott theorem](https://en.wikipedia.org/wiki/O%27Nan%E2%80%93Scott_theorem)).\n\n> \n> Why is this relevent for hashing?\n\nI am inclined to say that one should not hash permutation group elements ignoring their parent group. A workaround, to hash `Permutation(g)` rather than `g` itself, should work, though - although it does not, due to the usual sloppiness of `Permutation`.",
    "created_at": "2021-01-18T17:19:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500621",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@videlec](#comment:20):
> Replying to [@dimpase](#comment:19):
> > Replying to [@videlec](#comment:18):
> > > See [comment:13](#comment:13) for why this will not work.

> > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard
> > domain [1..n], and only then compute hash.

>  
> How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?

By their positions in the list, i.e. as `[1,2,3]`, why not?


> 
> > 
> > ---
> > 
> > Having said this, it's in general a quite bad idea to ignore the nature of the group the element comes from, as it affects the performance of algorithms quite badly. Every permutation group G has a base, a minimal size set B  s.t. g_1(B)\=g_2(B) as soon as g_1\=g_2, and for transitive permutation groups this is in general the quickest test, and |B| is usually very small compared to the degree (it's even possible to quantify what "usually" means here - e.g. for primitive groups 
> > this is governed by [O'Nan-Scott theorem](https://en.wikipedia.org/wiki/O%27Nan%E2%80%93Scott_theorem)).

> 
> Why is this relevent for hashing?

I am inclined to say that one should not hash permutation group elements ignoring their parent group. A workaround, to hash `Permutation(g)` rather than `g` itself, should work, though - although it does not, due to the usual sloppiness of `Permutation`.



---

archive/issue_comments_500622.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@dimpase](#comment:21):\n> Replying to [@videlec](#comment:20):\n> > Replying to [@dimpase](#comment:19):\n> > > Replying to [@videlec](#comment:18):\n> > > > See [comment:13](#comment:13) for why this will not work.\n\n> > > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard\n> > > domain [1..n], and only then compute hash.\n\n> >\n> > How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?\n\n> By their positions in the list, i.e. as `[1,2,3]`, why not?\n\nBecause it won't work. If you do that with `[pi, 'a', Partition([3,2,1])]` and then `[Partition([3,2,1]), 'a', pi]` for the same permutation, let say the transposition `('a', pi)`, you will obtain two different permutations on `[1,2,3]` with different hashes.\n\nYou could also have read [comment:13](#comment:13): the order of the elements in the domain should not matter.",
    "created_at": "2021-01-18T17:30:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500622",
    "user": "https://github.com/videlec"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@dimpase](#comment:21):
> Replying to [@videlec](#comment:20):
> > Replying to [@dimpase](#comment:19):
> > > Replying to [@videlec](#comment:18):
> > > > See [comment:13](#comment:13) for why this will not work.

> > > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard
> > > domain [1..n], and only then compute hash.

> >
> > How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?

> By their positions in the list, i.e. as `[1,2,3]`, why not?

Because it won't work. If you do that with `[pi, 'a', Partition([3,2,1])]` and then `[Partition([3,2,1]), 'a', pi]` for the same permutation, let say the transposition `('a', pi)`, you will obtain two different permutations on `[1,2,3]` with different hashes.

You could also have read [comment:13](#comment:13): the order of the elements in the domain should not matter.



---

archive/issue_comments_500623.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nIf you think you have a better way of implementing a hash function, please provide an alternative branch. As far as I tested my branch does solve the issue.",
    "created_at": "2021-01-18T17:31:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500623",
    "user": "https://github.com/videlec"
}
```

<div id="comment:23" align="right">comment:23</div>

If you think you have a better way of implementing a hash function, please provide an alternative branch. As far as I tested my branch does solve the issue.



---

archive/issue_comments_500624.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThere is no issue IMHO.\nIt's an over-zealous wish to mimic Python numeric tower to the point where it does not make sense any more.",
    "created_at": "2021-01-18T18:48:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500624",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:24" align="right">comment:24</div>

There is no issue IMHO.
It's an over-zealous wish to mimic Python numeric tower to the point where it does not make sense any more.



---

archive/issue_comments_500625.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@videlec](#comment:22):\n> Replying to [@dimpase](#comment:21):\n> > Replying to [@videlec](#comment:20):\n> > > Replying to [@dimpase](#comment:19):\n> > > > Replying to [@videlec](#comment:18):\n> > > > > See [comment:13](#comment:13) for why this will not work.\n\n> > > > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard\n> > > > domain [1..n], and only then compute hash.\n\n> > >\n> > > How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?\n\n> > By their positions in the list, i.e. as `[1,2,3]`, why not?\n\n> \n> Because it won't work. If you do that with `[pi, 'a', Partition([3,2,1])]` and then `[Partition([3,2,1]), 'a', pi]` for the same permutation, let say the transposition `('a', pi)`, you will obtain two different permutations on `[1,2,3]` with different hashes.\n> \n> You could also have read [comment:13](#comment:13): the order of the elements in the domain should not matter.\n\nAnd this only reinforces my suspision that hashing permutations of different domains should return different answers.\nAs you just demonstrated, there is no canonical way to identify the transposition `('a',pi)` with `(1,2)`, why would the hashes be the same?",
    "created_at": "2021-01-18T18:51:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500625",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@videlec](#comment:22):
> Replying to [@dimpase](#comment:21):
> > Replying to [@videlec](#comment:20):
> > > Replying to [@dimpase](#comment:19):
> > > > Replying to [@videlec](#comment:18):
> > > > > See [comment:13](#comment:13) for why this will not work.

> > > > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard
> > > > domain [1..n], and only then compute hash.

> > >
> > > How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?

> > By their positions in the list, i.e. as `[1,2,3]`, why not?

> 
> Because it won't work. If you do that with `[pi, 'a', Partition([3,2,1])]` and then `[Partition([3,2,1]), 'a', pi]` for the same permutation, let say the transposition `('a', pi)`, you will obtain two different permutations on `[1,2,3]` with different hashes.
> 
> You could also have read [comment:13](#comment:13): the order of the elements in the domain should not matter.

And this only reinforces my suspision that hashing permutations of different domains should return different answers.
As you just demonstrated, there is no canonical way to identify the transposition `('a',pi)` with `(1,2)`, why would the hashes be the same?



---

archive/issue_comments_500626.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@dimpase](#comment:25):\n> Replying to [@videlec](#comment:22):\n> > Replying to [@dimpase](#comment:21):\n> > > Replying to [@videlec](#comment:20):\n> > > > Replying to [@dimpase](#comment:19):\n> > > > > Replying to [@videlec](#comment:18):\n> > > > > > See [comment:13](#comment:13) for why this will not work.\n\n> > > > > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard\n> > > > > domain [1..n], and only then compute hash.\n\n> > > >\n> > > > How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?\n\n> > > By their positions in the list, i.e. as `[1,2,3]`, why not?\n\n> > \n> > Because it won't work. If you do that with `[pi, 'a', Partition([3,2,1])]` and then `[Partition([3,2,1]), 'a', pi]` for the same permutation, let say the transposition `('a', pi)`, you will obtain two different permutations on `[1,2,3]` with different hashes.\n> > \n> > You could also have read [comment:13](#comment:13): the order of the elements in the domain should not matter.\n\n> \n> And this only reinforces my suspision that hashing permutations of different domains should return different answers.\n\nThere is a canonical map from the domain `{1,2}` to the domain `{1,2,3}`. Hence the transposition `(1,2)` on both sets should just be equal. It is trivial to implement a compatible hash function. This is what this ticket is about.\n\n> As you just demonstrated, there is no canonical way to identify the transposition `('a',pi)` with `(1,2)`, why would the hashes be the same?\n\nThe hashes are different.",
    "created_at": "2021-01-18T18:57:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500626",
    "user": "https://github.com/videlec"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@dimpase](#comment:25):
> Replying to [@videlec](#comment:22):
> > Replying to [@dimpase](#comment:21):
> > > Replying to [@videlec](#comment:20):
> > > > Replying to [@dimpase](#comment:19):
> > > > > Replying to [@videlec](#comment:18):
> > > > > > See [comment:13](#comment:13) for why this will not work.

> > > > > This seems to be an entirely different issue - one can 1st canonise the permutation to the standard
> > > > > domain [1..n], and only then compute hash.

> > > >
> > > > How do you canonise `[pi, 'a', Partition([3,2,1])]` to `[1, 2, 3]`?

> > > By their positions in the list, i.e. as `[1,2,3]`, why not?

> > 
> > Because it won't work. If you do that with `[pi, 'a', Partition([3,2,1])]` and then `[Partition([3,2,1]), 'a', pi]` for the same permutation, let say the transposition `('a', pi)`, you will obtain two different permutations on `[1,2,3]` with different hashes.
> > 
> > You could also have read [comment:13](#comment:13): the order of the elements in the domain should not matter.

> 
> And this only reinforces my suspision that hashing permutations of different domains should return different answers.

There is a canonical map from the domain `{1,2}` to the domain `{1,2,3}`. Hence the transposition `(1,2)` on both sets should just be equal. It is trivial to implement a compatible hash function. This is what this ticket is about.

> As you just demonstrated, there is no canonical way to identify the transposition `('a',pi)` with `(1,2)`, why would the hashes be the same?

The hashes are different.



---

archive/issue_comments_500627.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nIt seems like you have incompatible goals for a hash function.\n\n* It should be as fast as possible to compute for elements of a fixed permutation group.  Dima's suggestion about the base is an interesting idea for a way to compute hashes by only considering a few elements.  But it's clearly not going to be consistent across subgroup relations (including `S_n c S_{n+1}` considered here), and it requires a precomputation for each permutation group (the base).\n* It should depend only on the permutation, not the group.  Yes, there are other parts of Sage where hashing and equality testing are incompatible\n\n```\nsage: mod(1,3) == -2                                                                                                                                                                                                                         \nTrue\nsage: hash(mod(1,3)) == hash(-2)                                                                                                                                                                                                             \nFalse\n```\nbut this compatibility is still a desirable feature of a hash function.\n\nVincent's solution seems like a pretty good way to achieve the second goal.  Dima, if you'd like to argue that we should drop compatibility of hash functions across different permutation groups in the interest of speed, I think that discussion should be taken back to the sage-devel thread.\n\nI wonder if it's reasonable to have a \"hash mode\" option for parents where a user can indicate that they want hashes to be as fast as possible, dropping compatibility across parents.  Maybe this could disable implicit coercions and require explicit conversions?",
    "created_at": "2021-01-19T22:03:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500627",
    "user": "https://github.com/roed314"
}
```

<div id="comment:27" align="right">comment:27</div>

It seems like you have incompatible goals for a hash function.

* It should be as fast as possible to compute for elements of a fixed permutation group.  Dima's suggestion about the base is an interesting idea for a way to compute hashes by only considering a few elements.  But it's clearly not going to be consistent across subgroup relations (including `S_n c S_{n+1}` considered here), and it requires a precomputation for each permutation group (the base).
* It should depend only on the permutation, not the group.  Yes, there are other parts of Sage where hashing and equality testing are incompatible

```
sage: mod(1,3) == -2                                                                                                                                                                                                                         
True
sage: hash(mod(1,3)) == hash(-2)                                                                                                                                                                                                             
False
```
but this compatibility is still a desirable feature of a hash function.

Vincent's solution seems like a pretty good way to achieve the second goal.  Dima, if you'd like to argue that we should drop compatibility of hash functions across different permutation groups in the interest of speed, I think that discussion should be taken back to the sage-devel thread.

I wonder if it's reasonable to have a "hash mode" option for parents where a user can indicate that they want hashes to be as fast as possible, dropping compatibility across parents.  Maybe this could disable implicit coercions and require explicit conversions?



---

archive/issue_comments_500628.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@roed314](#comment:27):\n> It seems like you have incompatible goals for a hash function.\n> \n> <SNIP>\n\n>\n\nThanks for your input. The branch I provided is a bit slower than the previous code in case the domain is the standard one, ie `{1, 2, ..., n}`\n\n```\nsage: S = SymmetricGroup(10)\nsage: %timeit -r5 for s in S: h = hash(s)\n1.02 s \u00b1 24.2 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each) # old version\n1.32 s \u00b1 11.3 ms per loop (mean \u00b1 std. dev. of 5 runs, 1 loop each) # new version\n```\nThe time difference is plausibly due to the extra call `P._has_natural_domain()` which is here repeated 10 factorial times. I do not have any idea to improve the timing without Cythonizing the parent.\n\nAs expected the code is significatively slower in case the domain is non standard\n\n```\nsage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])\nsage: %timeit -r5 for s in S: h = hash(s)\n109 ms \u00b1 511 \u00b5s per loop (mean \u00b1 std. dev. of 5 runs, 10 loops each) # old version\n3.56 s \u00b1 4.19 ms per loop (mean \u00b1 std. dev. of 5 runs, 1 loop each) # new version\n```\nIf the latter is a problem, it is possible to store the hashes of elements in the domain in a C array inside the parent. Should I do that?",
    "created_at": "2021-01-19T22:24:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500628",
    "user": "https://github.com/videlec"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@roed314](#comment:27):
> It seems like you have incompatible goals for a hash function.
> 
> <SNIP>

>

Thanks for your input. The branch I provided is a bit slower than the previous code in case the domain is the standard one, ie `{1, 2, ..., n}`

```
sage: S = SymmetricGroup(10)
sage: %timeit -r5 for s in S: h = hash(s)
1.02 s Â± 24.2 ms per loop (mean Â± std. dev. of 7 runs, 1 loop each) # old version
1.32 s Â± 11.3 ms per loop (mean Â± std. dev. of 5 runs, 1 loop each) # new version
```
The time difference is plausibly due to the extra call `P._has_natural_domain()` which is here repeated 10 factorial times. I do not have any idea to improve the timing without Cythonizing the parent.

As expected the code is significatively slower in case the domain is non standard

```
sage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])
sage: %timeit -r5 for s in S: h = hash(s)
109 ms Â± 511 Âµs per loop (mean Â± std. dev. of 5 runs, 10 loops each) # old version
3.56 s Â± 4.19 ms per loop (mean Â± std. dev. of 5 runs, 1 loop each) # new version
```
If the latter is a problem, it is possible to store the hashes of elements in the domain in a C array inside the parent. Should I do that?



---

archive/issue_comments_500629.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nPermutationGroupElement hashes have to be compatible w.r.t. to subgroups of this group (and, by the way, using images of the base - which gets computed as soon as almost any kind of nontrivial computation has to be done - to compute the hash is obviously good here), but I fail to understand why this would be desirable for groups with different domains, and to me domains (1,2,3) and (2,1,3) are different, as different as (1,2,3) and (7,8,9).",
    "created_at": "2021-01-19T22:57:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500629",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:29" align="right">comment:29</div>

PermutationGroupElement hashes have to be compatible w.r.t. to subgroups of this group (and, by the way, using images of the base - which gets computed as soon as almost any kind of nontrivial computation has to be done - to compute the hash is obviously good here), but I fail to understand why this would be desirable for groups with different domains, and to me domains (1,2,3) and (2,1,3) are different, as different as (1,2,3) and (7,8,9).



---

archive/issue_comments_500630.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@videlec](#comment:28):\n> \n> Thanks for your input. The branch I provided is a bit slower than the previous code in case the domain is the standard one, ie `{1, 2, ..., n}`\n> \n> ```\n> sage: S = SymmetricGroup(10)\n> sage: %timeit -r5 for s in S: h = hash(s)\n> 1.02 s \u00b1 24.2 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each) # old version\n> 1.32 s \u00b1 11.3 ms per loop (mean \u00b1 std. dev. of 5 runs, 1 loop each) # new version\n> ```\n> The time difference is plausibly due to the extra call `P._has_natural_domain()` which is here repeated 10 factorial times. I do not have any idea to improve the timing without Cythonizing the parent.\n\nSince `_has_natural_domain` is cached, it would surprise me a bit if this was the bottleneck.  Maybe try running your code again with that just set to `True`?  I would suspect that the inside of the for loop is just more complicated, yielding a 30% slowdown.  Obviously we'd prefer not to have a slowdown, but I think 30% is acceptable in order to fix the bug.\n\n> As expected the code is significatively slower in case the domain is non standard\n> \n> ```\n> sage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])\n> sage: %timeit -r5 for s in S: h = hash(s)\n> 109 ms \u00b1 511 \u00b5s per loop (mean \u00b1 std. dev. of 5 runs, 10 loops each) # old version\n> 3.56 s \u00b1 4.19 ms per loop (mean \u00b1 std. dev. of 5 runs, 1 loop each) # new version\n> ```\n> If the latter is a problem, it is possible to store the hashes of elements in the domain in a C array inside the parent. Should I do that?\n\nSince the parent isn't Cythonized, where would that array go?  I think speeding up this case would be worthwhile, and recording the domain's hashes seems like a good way to do it.\n\nThe speed comparison I was thinking about, though, wasn't either of these.  Instead, I think Dima was suggesting that we can make a much faster hash function than the current one in the case where `n` is large.  I think speeding things up for large `n` is worthwhile, but there are plenty of cases where Sage is pretty bad.  I think the hash code is fine in comparison:\n\n```\nsage: S = SymmetricGroup(2000)\nsage: %timeit a = S.random_element()\n639 ms \u00b1 15.3 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n\nsage: S = SymmetricGroup(10^8)\nsage: %time hash(a)                                                                                                                                                                                                                          \nCPU times: user 120 ms, sys: 350 \u00b5s, total: 120 ms\nWall time: 120 ms\n```",
    "created_at": "2021-01-19T23:04:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500630",
    "user": "https://github.com/roed314"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@videlec](#comment:28):
> 
> Thanks for your input. The branch I provided is a bit slower than the previous code in case the domain is the standard one, ie `{1, 2, ..., n}`
> 
> ```
> sage: S = SymmetricGroup(10)
> sage: %timeit -r5 for s in S: h = hash(s)
> 1.02 s Â± 24.2 ms per loop (mean Â± std. dev. of 7 runs, 1 loop each) # old version
> 1.32 s Â± 11.3 ms per loop (mean Â± std. dev. of 5 runs, 1 loop each) # new version
> ```
> The time difference is plausibly due to the extra call `P._has_natural_domain()` which is here repeated 10 factorial times. I do not have any idea to improve the timing without Cythonizing the parent.

Since `_has_natural_domain` is cached, it would surprise me a bit if this was the bottleneck.  Maybe try running your code again with that just set to `True`?  I would suspect that the inside of the for loop is just more complicated, yielding a 30% slowdown.  Obviously we'd prefer not to have a slowdown, but I think 30% is acceptable in order to fix the bug.

> As expected the code is significatively slower in case the domain is non standard
> 
> ```
> sage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])
> sage: %timeit -r5 for s in S: h = hash(s)
> 109 ms Â± 511 Âµs per loop (mean Â± std. dev. of 5 runs, 10 loops each) # old version
> 3.56 s Â± 4.19 ms per loop (mean Â± std. dev. of 5 runs, 1 loop each) # new version
> ```
> If the latter is a problem, it is possible to store the hashes of elements in the domain in a C array inside the parent. Should I do that?

Since the parent isn't Cythonized, where would that array go?  I think speeding up this case would be worthwhile, and recording the domain's hashes seems like a good way to do it.

The speed comparison I was thinking about, though, wasn't either of these.  Instead, I think Dima was suggesting that we can make a much faster hash function than the current one in the case where `n` is large.  I think speeding things up for large `n` is worthwhile, but there are plenty of cases where Sage is pretty bad.  I think the hash code is fine in comparison:

```
sage: S = SymmetricGroup(2000)
sage: %timeit a = S.random_element()
639 ms Â± 15.3 ms per loop (mean Â± std. dev. of 7 runs, 1 loop each)

sage: S = SymmetricGroup(10^8)
sage: %time hash(a)                                                                                                                                                                                                                          
CPU times: user 120 ms, sys: 350 Âµs, total: 120 ms
Wall time: 120 ms
```



---

archive/issue_comments_500631.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@dimpase](#comment:29):\n> PermutationGroupElement hashes have to be compatible w.r.t. to subgroups of this group (and, by the way, using images of the base - which gets computed as soon as almost any kind of nontrivial computation has to be done - to compute the hash is obviously good here), but I fail to understand why this would be desirable for groups with different domains, and to me domains (1,2,3) and (2,1,3) are different, as different as (1,2,3) and (7,8,9).\n\nI agree that they are different, but Sage currently allows equality testing between them:\n\n```\nsage: S = SymmetricGroup([1,2,3])                                                                                                                                                                                                            \nsage: T = SymmetricGroup([2,3,1])                                                                                                                                                                                                            \nsage: S('(2,1)')                                                                                                                                                                                                                             \n(1,2)\nsage: T('(2,1)')                                                                                                                                                                                                                             \n(2,1)\nsage: T('(2,1)') == S('(2,1)')                                                                                                                                                                                                               \nTrue\n```\nI wouldn't object to prohibiting a coercion map between these parents (as you say, the domains are different since permutations are all about the ordering of domain, not just the labels), but I'd say that should also be discussed more broadly.",
    "created_at": "2021-01-19T23:11:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500631",
    "user": "https://github.com/roed314"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@dimpase](#comment:29):
> PermutationGroupElement hashes have to be compatible w.r.t. to subgroups of this group (and, by the way, using images of the base - which gets computed as soon as almost any kind of nontrivial computation has to be done - to compute the hash is obviously good here), but I fail to understand why this would be desirable for groups with different domains, and to me domains (1,2,3) and (2,1,3) are different, as different as (1,2,3) and (7,8,9).

I agree that they are different, but Sage currently allows equality testing between them:

```
sage: S = SymmetricGroup([1,2,3])                                                                                                                                                                                                            
sage: T = SymmetricGroup([2,3,1])                                                                                                                                                                                                            
sage: S('(2,1)')                                                                                                                                                                                                                             
(1,2)
sage: T('(2,1)')                                                                                                                                                                                                                             
(2,1)
sage: T('(2,1)') == S('(2,1)')                                                                                                                                                                                                               
True
```
I wouldn't object to prohibiting a coercion map between these parents (as you say, the domains are different since permutations are all about the ordering of domain, not just the labels), but I'd say that should also be discussed more broadly.



---

archive/issue_comments_500632.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@roed314](#comment:30):\n> Replying to [@videlec](#comment:28):\n> > \n> > Thanks for your input. The branch I provided is a bit slower than the previous code in case the domain is the standard one, ie `{1, 2, ..., n}`\n> > \n> > ```\n> > sage: S = SymmetricGroup(10)\n> > sage: %timeit -r5 for s in S: h = hash(s)\n> > 1.02 s \u00b1 24.2 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each) # old version\n> > 1.32 s \u00b1 11.3 ms per loop (mean \u00b1 std. dev. of 5 runs, 1 loop each) # new version\n> > ```\n> > The time difference is plausibly due to the extra call `P._has_natural_domain()` which is here repeated 10 factorial times. I do not have any idea to improve the timing without Cythonizing the parent.\n\n> \n> Since `_has_natural_domain` is cached, it would surprise me a bit if this was the bottleneck.  Maybe try running your code again with that just set to `True`?\n\n```\nsage: %timeit -r5 for s in S: h = hash(s) # new code without _has_natural_domain call\n1.09 s \u00b1 18.3 ms per loop (mean \u00b1 std. dev. of 5 runs, 1 loop each)\n```",
    "created_at": "2021-01-20T08:16:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500632",
    "user": "https://github.com/videlec"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@roed314](#comment:30):
> Replying to [@videlec](#comment:28):
> > 
> > Thanks for your input. The branch I provided is a bit slower than the previous code in case the domain is the standard one, ie `{1, 2, ..., n}`
> > 
> > ```
> > sage: S = SymmetricGroup(10)
> > sage: %timeit -r5 for s in S: h = hash(s)
> > 1.02 s Â± 24.2 ms per loop (mean Â± std. dev. of 7 runs, 1 loop each) # old version
> > 1.32 s Â± 11.3 ms per loop (mean Â± std. dev. of 5 runs, 1 loop each) # new version
> > ```
> > The time difference is plausibly due to the extra call `P._has_natural_domain()` which is here repeated 10 factorial times. I do not have any idea to improve the timing without Cythonizing the parent.

> 
> Since `_has_natural_domain` is cached, it would surprise me a bit if this was the bottleneck.  Maybe try running your code again with that just set to `True`?

```
sage: %timeit -r5 for s in S: h = hash(s) # new code without _has_natural_domain call
1.09 s Â± 18.3 ms per loop (mean Â± std. dev. of 5 runs, 1 loop each)
```



---

archive/issue_comments_500633.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI guess I was wrong.  I also don't see an easy way to make this faster.",
    "created_at": "2021-01-20T12:07:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500633",
    "user": "https://github.com/roed314"
}
```

<div id="comment:33" align="right">comment:33</div>

I guess I was wrong.  I also don't see an easy way to make this faster.



---

archive/issue_comments_500634.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [@roed314](#comment:30):\n> Replying to [@videlec](#comment:28):\n> > As expected the code is significatively slower in case the domain is non standard\n> > \n> > ```\n> > sage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])\n> > sage: %timeit -r5 for s in S: h = hash(s)\n> > 109 ms \u00b1 511 \u00b5s per loop (mean \u00b1 std. dev. of 5 runs, 10 loops each) # old version\n> > 3.56 s \u00b1 4.19 ms per loop (mean \u00b1 std. dev. of 5 runs, 1 loop each) # new version\n> > ```\n> > If the latter is a problem, it is possible to store the hashes of elements in the domain in a C array inside the parent. Should I do that?\n\n> \n> Since the parent isn't Cythonized, where would that array go?  I think speeding up this case would be worthwhile, and recording the domain's hashes seems like a good way to do it.\n\nThere is the [Python array object](https://docs.python.org/3/library/array.html) that can store whatever C data you want. We will still suffer from the attribute access to the Python parent. But it will not be a factor x30 as it is currently",
    "created_at": "2021-01-20T13:53:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500634",
    "user": "https://github.com/videlec"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [@roed314](#comment:30):
> Replying to [@videlec](#comment:28):
> > As expected the code is significatively slower in case the domain is non standard
> > 
> > ```
> > sage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])
> > sage: %timeit -r5 for s in S: h = hash(s)
> > 109 ms Â± 511 Âµs per loop (mean Â± std. dev. of 5 runs, 10 loops each) # old version
> > 3.56 s Â± 4.19 ms per loop (mean Â± std. dev. of 5 runs, 1 loop each) # new version
> > ```
> > If the latter is a problem, it is possible to store the hashes of elements in the domain in a C array inside the parent. Should I do that?

> 
> Since the parent isn't Cythonized, where would that array go?  I think speeding up this case would be worthwhile, and recording the domain's hashes seems like a good way to do it.

There is the [Python array object](https://docs.python.org/3/library/array.html) that can store whatever C data you want. We will still suffer from the attribute access to the Python parent. But it will not be a factor x30 as it is currently



---

archive/issue_comments_500635.json:
```json
{
    "body": "Changed commit from **[3e29948](https://github.com/sagemath/sagetrac-mirror/commit/3e2994829b5c1ce4ad74c1400015339498240c18)** to **[e2e4d1d](https://github.com/sagemath/sagetrac-mirror/commit/e2e4d1d7fdcf87355af69f46e8d90e7e1e69a552)**",
    "created_at": "2021-01-20T14:22:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500635",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[3e29948](https://github.com/sagemath/sagetrac-mirror/commit/3e2994829b5c1ce4ad74c1400015339498240c18)** to **[e2e4d1d](https://github.com/sagemath/sagetrac-mirror/commit/e2e4d1d7fdcf87355af69f46e8d90e7e1e69a552)**



---

archive/issue_comments_500636.json:
```json
{
    "body": "<div id=\"comment:35\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e2e4d1d7fdcf87355af69f46e8d90e7e1e69a552\">e2e4d1d</a></td><td><code>31236: use a hash array for non standard domains</code></td></tr></table>\n",
    "created_at": "2021-01-20T14:22:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500636",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:35"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e2e4d1d7fdcf87355af69f46e8d90e7e1e69a552">e2e4d1d</a></td><td><code>31236: use a hash array for non standard domains</code></td></tr></table>




---

archive/issue_comments_500637.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nBetter now\n\n```\nsage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])\nsage: %timeit -r5 for s in S: h = hash(s)\n159 ms \u00b1 1.17 ms per loop (mean \u00b1 std. dev. of 5 runs, 10 loops each)\n```\nComputing a single hash of an element triggers the creation of an array in the parent\n\n```\nsage: S._domain_hash_array\narray('l', [-5034579376873000338, 5819885834672024805, -1342306816048582247, 4154873981948319473, -9080196639829811986, 3487762170233258304, -4059262801740968994, -1410151844174446032, -7454342532774124322])\n```\nThis solution is not ideal as the hash array could be made available on the domain itself and not on the symmetric group. It could end up with many duplications of this array (ie when constructing subgroups).",
    "created_at": "2021-01-20T14:25:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500637",
    "user": "https://github.com/videlec"
}
```

<div id="comment:36" align="right">comment:36</div>

Better now

```
sage: S = SymmetricGroup(['a','b','c','d','e','f','g','h','i'])
sage: %timeit -r5 for s in S: h = hash(s)
159 ms Â± 1.17 ms per loop (mean Â± std. dev. of 5 runs, 10 loops each)
```
Computing a single hash of an element triggers the creation of an array in the parent

```
sage: S._domain_hash_array
array('l', [-5034579376873000338, 5819885834672024805, -1342306816048582247, 4154873981948319473, -9080196639829811986, 3487762170233258304, -4059262801740968994, -1410151844174446032, -7454342532774124322])
```
This solution is not ideal as the hash array could be made available on the domain itself and not on the symmetric group. It could end up with many duplications of this array (ie when constructing subgroups).



---

archive/issue_comments_500638.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nSee #31269",
    "created_at": "2021-01-20T14:58:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500638",
    "user": "https://github.com/videlec"
}
```

<div id="comment:37" align="right">comment:37</div>

See #31269



---

archive/issue_comments_500639.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nping",
    "created_at": "2021-01-29T07:49:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500639",
    "user": "https://github.com/videlec"
}
```

<div id="comment:38" align="right">comment:38</div>

ping



---

archive/issue_comments_500640.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nI'm happy giving this ticket positive review.  Since Dima originally reviewed it, I'll give him a couple days to respond with an objection and suggestions for how he'd like to proceed.",
    "created_at": "2021-02-08T08:36:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500640",
    "user": "https://github.com/roed314"
}
```

<div id="comment:39" align="right">comment:39</div>

I'm happy giving this ticket positive review.  Since Dima originally reviewed it, I'll give him a couple days to respond with an objection and suggestions for how he'd like to proceed.



---

archive/issue_comments_500641.json:
```json
{
    "body": "Changed reviewer from **Dima Pasechnik** to **Dima Pasechnik, \u200bDavid Roe**",
    "created_at": "2021-02-08T08:48:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500641",
    "user": "https://github.com/videlec"
}
```

Changed reviewer from **Dima Pasechnik** to **Dima Pasechnik, â€‹David Roe**



---

archive/issue_comments_500642.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nMy objection is only on the level of documentation. Where the hell these huge constants come from, and why? It's totally unclear.",
    "created_at": "2021-02-08T10:06:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500642",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:41" align="right">comment:41</div>

My objection is only on the level of documentation. Where the hell these huge constants come from, and why? It's totally unclear.



---

archive/issue_comments_500643.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nAs their names indicate `mult1`, `mult2` are multipliers (for bit shuffling) and `mask1`, `mask2` are masks so that the hasing of the pair `(i, j)` is non commutative (ie different from the hash of `(j, i)`). These numbers are not big, they are 64 bit integers.",
    "created_at": "2021-02-08T12:09:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500643",
    "user": "https://github.com/videlec"
}
```

<div id="comment:42" align="right">comment:42</div>

As their names indicate `mult1`, `mult2` are multipliers (for bit shuffling) and `mask1`, `mask2` are masks so that the hasing of the pair `(i, j)` is non commutative (ie different from the hash of `(j, i)`). These numbers are not big, they are 64 bit integers.



---

archive/issue_comments_500644.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nping",
    "created_at": "2021-02-17T15:28:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500644",
    "user": "https://github.com/videlec"
}
```

<div id="comment:43" align="right">comment:43</div>

ping



---

archive/issue_comments_500645.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nSorry, I've been busy.  This looks good to me.",
    "created_at": "2021-03-04T19:26:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500645",
    "user": "https://github.com/roed314"
}
```

<div id="comment:44" align="right">comment:44</div>

Sorry, I've been busy.  This looks good to me.



---

archive/issue_events_430503.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2021-03-04T19:26:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430503"
}
```



---

archive/issue_events_430504.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2021-03-04T19:26:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430504"
}
```



---

archive/issue_events_430505.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-08T23:53:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430505"
}
```



---

archive/issue_events_430506.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-08T23:53:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430506"
}
```



---

archive/issue_comments_500646.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nI got this on Ubuntu 18.04 32 bit\n\n```\n**********************************************************************\nFile \"src/sage/groups/perm_gps/permgroup_element.pyx\", line 1485, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__\nFailed example:\n    for n in range(1, 10):\n       G = SymmetricGroup(n)\n       assert hash(G.one()) == 1\n       assert len(set(map(hash, G))) == factorial(n)\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__[3]>\", line 4, in <module>\n        assert len(set(map(hash, G))) == factorial(n)\n    AssertionError\n**********************************************************************\nFile \"src/sage/groups/perm_gps/permgroup_element.pyx\", line 1493, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__\nFailed example:\n    assert len(set(map(hash, A))) == A.cardinality()\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__[7]>\", line 1, in <module>\n        assert len(set(map(hash, A))) == A.cardinality()\n    AssertionError\n**********************************************************************\n1 item had failures:\n   2 of  35 in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__\n    [426 tests, 2 failures, 3.64 s]\n\n```\nas a general bit of advice, consider using `assert condition, message` so you learn whats wrong from tracebacks...",
    "created_at": "2021-03-08T23:53:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500646",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:45" align="right">comment:45</div>

I got this on Ubuntu 18.04 32 bit

```
**********************************************************************
File "src/sage/groups/perm_gps/permgroup_element.pyx", line 1485, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__
Failed example:
    for n in range(1, 10):
       G = SymmetricGroup(n)
       assert hash(G.one()) == 1
       assert len(set(map(hash, G))) == factorial(n)
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__[3]>", line 4, in <module>
        assert len(set(map(hash, G))) == factorial(n)
    AssertionError
**********************************************************************
File "src/sage/groups/perm_gps/permgroup_element.pyx", line 1493, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__
Failed example:
    assert len(set(map(hash, A))) == A.cardinality()
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__[7]>", line 1, in <module>
        assert len(set(map(hash, A))) == A.cardinality()
    AssertionError
**********************************************************************
1 item had failures:
   2 of  35 in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__hash__
    [426 tests, 2 failures, 3.64 s]

```
as a general bit of advice, consider using `assert condition, message` so you learn whats wrong from tracebacks...



---

archive/issue_events_430507.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-02T20:21:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430507"
}
```



---

archive/issue_events_430508.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-02T20:21:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430508"
}
```



---

archive/issue_comments_500647.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nMoving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage",
    "created_at": "2021-04-02T20:21:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500647",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:46" align="right">comment:46</div>

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage



---

archive/issue_events_430509.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430509"
}
```



---

archive/issue_events_430510.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430510"
}
```



---

archive/issue_comments_500648.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31236#issuecomment-500648",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:47" align="right">comment:47</div>

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_430511.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430511"
}
```



---

archive/issue_events_430512.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430512"
}
```



---

archive/issue_events_430513.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430513"
}
```



---

archive/issue_events_430514.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430514"
}
```



---

archive/issue_events_430515.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430515"
}
```



---

archive/issue_events_430516.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31236",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31236#event-430516"
}
```
