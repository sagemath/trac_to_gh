# Issue 31180: Add snappy as a pip package

archive/issues_030943.json:
```json
{
    "assignees": [],
    "body": "Following the instructions from #31176.\n\n(see also https://snappy.math.uic.edu/installing.html#sagemath)\n\nDepends on #31132\n\nCC:  @NathanDunfield @culler @dimpase @videlec @slel\n\nBranch/Commit: **[fb5366d](https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584)**\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Nathan Dunfield**\n\nAuthor: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31180_\n\n",
    "closed_at": "2021-03-07T17:05:59Z",
    "created_at": "2021-01-04T18:30:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Add snappy as a pip package",
    "type": "issue",
    "updated_at": "2021-03-07T17:05:59Z",
    "url": "https://github.com/sagemath/sage/issues/31180",
    "user": "https://github.com/mkoeppe"
}
```
Following the instructions from #31176.

(see also https://snappy.math.uic.edu/installing.html#sagemath)

Depends on #31132

CC:  @NathanDunfield @culler @dimpase @videlec @slel

Branch/Commit: **[fb5366d](https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584)**

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **Nathan Dunfield**

Author: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/31180_





---

archive/issue_events_411564.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-04T18:30:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411564"
}
```



---

archive/issue_events_411565.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-04T18:30:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "component: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411565"
}
```



---

archive/issue_events_411566.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-04T18:30:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411566"
}
```



---

archive/issue_events_411567.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-04T18:30:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411567"
}
```



---

archive/issue_comments_502579.json:
```json
{
    "body": "Branch: **[u/mkoeppe/add_snappy_as_a_pip_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/add_snappy_as_a_pip_package)**",
    "created_at": "2021-01-04T18:36:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502579",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/add_snappy_as_a_pip_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/add_snappy_as_a_pip_package)**



---

archive/issue_comments_502580.json:
```json
{
    "body": "Commit: **[46f7b0e](https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb)**",
    "created_at": "2021-01-04T18:38:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502580",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[46f7b0e](https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb)**



---

archive/issue_comments_502581.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb\">46f7b0e</a></td><td><code>build/pkgs/snappy: New pip package</code></td></tr></table>\n",
    "created_at": "2021-01-04T18:38:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502581",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2" align="right">Comment 2</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb">46f7b0e</a></td><td><code>build/pkgs/snappy: New pip package</code></td></tr></table>




---

archive/issue_comments_502582.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2021-01-04T18:45:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502582",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_502583.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb\">46f7b0e</a></td><td><code>build/pkgs/snappy: New pip package</code></td></tr></table>\n",
    "created_at": "2021-01-04T18:45:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502583",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">Comment 3</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb">46f7b0e</a></td><td><code>build/pkgs/snappy: New pip package</code></td></tr></table>




---

archive/issue_comments_502584.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nUnfortunately `--no-deps` is not valid syntax in `requirements.txt` files",
    "created_at": "2021-01-04T18:46:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502584",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">Comment 4</div>

Unfortunately `--no-deps` is not valid syntax in `requirements.txt` files



---

archive/issue_comments_502585.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nThe full list of outside dependencies for `snappy` are:\n\n```\npypng\ndecorator\nfuture\nipython\ncypari|cypari2\n```\nso just using `snappy spherogram plink FXrays pypng` should do the trick (note I forgot about `pypng` in my post on #31176).  But maybe include `decorator` and `future` just in case those aren't part of some future version of Sage.",
    "created_at": "2021-01-04T18:49:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502585",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:5" align="right">Comment 5</div>

The full list of outside dependencies for `snappy` are:

```
pypng
decorator
future
ipython
cypari|cypari2
```
so just using `snappy spherogram plink FXrays pypng` should do the trick (note I forgot about `pypng` in my post on #31176).  But maybe include `decorator` and `future` just in case those aren't part of some future version of Sage.



---

archive/issue_comments_502586.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,3 @@\n Following the instructions from #31176.\n \n+(see also https://snappy.math.uic.edu/installing.html#sagemath)\n``````\n",
    "created_at": "2021-01-04T18:50:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502586",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,3 @@
 Following the instructions from #31176.
 
+(see also https://snappy.math.uic.edu/installing.html#sagemath)
``````




---

archive/issue_comments_502587.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nHmm, I see what you mean by `--no-deps`.  I guess one can only give that flag to `pip` but not embed it in `requirements.txt`.",
    "created_at": "2021-01-04T19:00:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502587",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:7" align="right">Comment 7</div>

Hmm, I see what you mean by `--no-deps`.  I guess one can only give that flag to `pip` but not embed it in `requirements.txt`.



---

archive/issue_comments_502588.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nLooking at snappy's `setup.py`, I see that you are already trying to conditionalize away the issue with `cypari`.\n\n```\n install_requires = ['plink>=2.3.1', 'spherogram>=1.8.3', 'FXrays>=1.3',\n                    'pypng', 'decorator', 'future', 'snappy_manifolds>=1.1.1']\ntry:\n    import sage\nexcept ImportError:\n    install_requires.append('cypari>=2.2')\n    install_requires.append('ipython>=0.13')\n    if sys.version_info < (3, 4):\n        install_requires.append('ipython<6.0')\n    if sys.platform == 'win32':\n        install_requires.append('pyreadline>=2.0')\n```\nUnfortunately I think the presence of wheels for `snappy` on PyPI will circumvent it.",
    "created_at": "2021-01-04T19:02:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502588",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8" align="right">Comment 8</div>

Looking at snappy's `setup.py`, I see that you are already trying to conditionalize away the issue with `cypari`.

```
 install_requires = ['plink>=2.3.1', 'spherogram>=1.8.3', 'FXrays>=1.3',
                    'pypng', 'decorator', 'future', 'snappy_manifolds>=1.1.1']
try:
    import sage
except ImportError:
    install_requires.append('cypari>=2.2')
    install_requires.append('ipython>=0.13')
    if sys.version_info < (3, 4):
        install_requires.append('ipython<6.0')
    if sys.platform == 'win32':
        install_requires.append('pyreadline>=2.0')
```
Unfortunately I think the presence of wheels for `snappy` on PyPI will circumvent it.



---

archive/issue_comments_502589.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nWould making the cypari dependency an `extras_require` in `snappy` be an acceptable way forward for you?",
    "created_at": "2021-01-04T19:06:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502589",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">Comment 9</div>

Would making the cypari dependency an `extras_require` in `snappy` be an acceptable way forward for you?



---

archive/issue_comments_502590.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nYeah, with binary wheels the `install_requires` are baked in and our tests in `setup.py` are of no help.\n\nI don't think `extras_require` helps here as `cypari*` is a core dependency for `snappy` and so is in no sense optional.",
    "created_at": "2021-01-05T01:21:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502590",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:10" align="right">Comment 10</div>

Yeah, with binary wheels the `install_requires` are baked in and our tests in `setup.py` are of no help.

I don't think `extras_require` helps here as `cypari*` is a core dependency for `snappy` and so is in no sense optional.



---

archive/issue_comments_502591.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nIt's inelegant, but I suspect that, in light of `pip`'s limitations, the best thing is simply to make `requirements.txt` be the single line `snappy`.  If wheels are available, this will result in a completely unused `cypari` package, but this will not interfere with anything and just wastes 30M (on linux, unpacked), which is small in context `snappy` (165 M), much less Sage itself (2G+).  (If instead `pip` ends up building from source, then there is no issue at all because of our `setup.py`.)\n\nThis also has the advantage it makes it less likely that this Sage pip package will need updating.\n\nThis argument is especially compelling if we throw in the optional database `snappy_15_knots` into this Sage pip package, as that is another 110M uncompressed.",
    "created_at": "2021-01-05T02:18:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502591",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:11" align="right">Comment 11</div>

It's inelegant, but I suspect that, in light of `pip`'s limitations, the best thing is simply to make `requirements.txt` be the single line `snappy`.  If wheels are available, this will result in a completely unused `cypari` package, but this will not interfere with anything and just wastes 30M (on linux, unpacked), which is small in context `snappy` (165 M), much less Sage itself (2G+).  (If instead `pip` ends up building from source, then there is no issue at all because of our `setup.py`.)

This also has the advantage it makes it less likely that this Sage pip package will need updating.

This argument is especially compelling if we throw in the optional database `snappy_15_knots` into this Sage pip package, as that is another 110M uncompressed.



---

archive/issue_comments_502592.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nI am not sure. It does not seem like a very robust solution. \n\nJust as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.\n\n```\nBuilding wheels for collected packages: cypari\n  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye\n  Building wheel for cypari (setup.py) ...   Destination directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye\n  Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"'; __file__='\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' bdist_wheel -d /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye\n  running bdist_wheel\n  running build\n  running build_py\n  creating build\n  creating build/lib.macosx-10.15-x86_64-3.9\n  creating build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/version.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/memory.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/__init__.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/test.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/py3tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  copying cypari/py2tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari\n  running build_ext\n  error: [Errno 2] No such file or directory: 'cypari/_pari_py3.c' -> 'cypari/_pari.c'\nerror\n  ERROR: Failed building wheel for cypari\n...\nInstalling collected packages: cypari\n  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr\n    Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"'; __file__='\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari\n    running install\n    running build\n    running build_py\n    running build_ext\n    Building gmp ...\n    rm -f gp-dyn\n    /Library/Developer/CommandLineTools/usr/bin/ld  -o gp-dyn -L\"/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/build/pari_src/Odarwin-x86_64\" -search_paths_first -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib  emacs.o gp.o gp_rl.o texmacs.o whatnow.o plotX.o  -lreadline -lpari -L/usr/X11R6/lib -lX11\n    ld: unknown option: -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib\n    make: *** [gp-dyn] Error 1\n    ***Failed to build PARI library***\n    Running setup.py install for cypari ... error\nERROR: Command errored out with exit status 1: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"'; __file__='\"'\"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'\"'\"';f=getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__);code=f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari Check the logs for full command output.\nException information:\nTraceback (most recent call last):\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/req/req_install.py\", line 838, in install\n    success = install_legacy(\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/operations/install/legacy.py\", line 86, in install\n    raise LegacyInstallFailure\npip._internal.operations.install.legacy.LegacyInstallFailure\n```",
    "created_at": "2021-01-05T17:27:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502592",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">Comment 12</div>

I am not sure. It does not seem like a very robust solution. 

Just as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.

```
Building wheels for collected packages: cypari
  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye
  Building wheel for cypari (setup.py) ...   Destination directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye
  Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"'; __file__='"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' bdist_wheel -d /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-wheel-8xuqmqye
  running bdist_wheel
  running build
  running build_py
  creating build
  creating build/lib.macosx-10.15-x86_64-3.9
  creating build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/version.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/memory.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/__init__.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/test.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/py3tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  copying cypari/py2tests.py -> build/lib.macosx-10.15-x86_64-3.9/cypari
  running build_ext
  error: [Errno 2] No such file or directory: 'cypari/_pari_py3.c' -> 'cypari/_pari.c'
error
  ERROR: Failed building wheel for cypari
...
Installing collected packages: cypari
  Created temporary directory: /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr
    Running command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"'; __file__='"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari
    running install
    running build
    running build_py
    running build_ext
    Building gmp ...
    rm -f gp-dyn
    /Library/Developer/CommandLineTools/usr/bin/ld  -o gp-dyn -L"/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/build/pari_src/Odarwin-x86_64" -search_paths_first -L/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib  emacs.o gp.o gp_rl.o texmacs.o whatnow.o plotX.o  -lreadline -lpari -L/usr/X11R6/lib -lX11
    ld: unknown option: -Wl,-rpath,/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib
    make: *** [gp-dyn] Error 1
    ***Failed to build PARI library***
    Running setup.py install for cypari ... error
ERROR: Command errored out with exit status 1: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/bin/python3 -u -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"'; __file__='"'"'/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-install-sbgfgcz3/cypari/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' install --record /private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-record-5v39xxkr/install-record.txt --single-version-externally-managed --compile --install-headers /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include/site/python3.9/cypari Check the logs for full command output.
Exception information:
Traceback (most recent call last):
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/req/req_install.py", line 838, in install
    success = install_legacy(
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/pip/_internal/operations/install/legacy.py", line 86, in install
    raise LegacyInstallFailure
pip._internal.operations.install.legacy.LegacyInstallFailure
```



---

archive/issue_comments_502593.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nAlso `./sage -pip install -v -v snappy` on the same system gives:\n\n```\n  ...\n  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c kernel/kernel_code/Dirichlet.c -o build/temp.macosx-10.15-x86_64-3.9/kernel/kernel_code/Dirichlet.o\n  kernel/kernel_code/Dirichlet.c:83:10: warning: non-portable path to file '\"dirichlet.h\"'; specified path differs in case from file name on disk [-Wnonportable-include-path]\n  #include \"Dirichlet.h\"\n           ^~~~~~~~~~~~~\n           \"dirichlet.h\"\n  kernel/kernel_code/Dirichlet.c:118:91: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?\n  static void         array_to_matrix_pair_list(O31Matrix generators[], int num_generators, MatrixPairList *gen_list);\n                                                                                            ^~~~~~~~~~~~~~\n                                                                                            MatrixParity\n  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here\n  } MatrixParity;\n    ^\n  kernel/kernel_code/Dirichlet.c:119:52: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?\n  static Boolean      is_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);\n                                                     ^~~~~~~~~~~~~~\n                                                     MatrixParity\n  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here\n  } MatrixParity;\n    ^\n  kernel/kernel_code/Dirichlet.c:120:56: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?\n  static void         insert_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);\n                                                         ^~~~~~~~~~~~~~\n                                                         MatrixParity\n```",
    "created_at": "2021-01-05T17:33:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502593",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">Comment 13</div>

Also `./sage -pip install -v -v snappy` on the same system gives:

```
  ...
  gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/include -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type -I/usr/local/include -I/usr/local/opt/openssl@1.1/include -I/usr/local/opt/sqlite/include -I/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/include -I/usr/local/Cellar/python@3.9/3.9.1_1/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c kernel/kernel_code/Dirichlet.c -o build/temp.macosx-10.15-x86_64-3.9/kernel/kernel_code/Dirichlet.o
  kernel/kernel_code/Dirichlet.c:83:10: warning: non-portable path to file '"dirichlet.h"'; specified path differs in case from file name on disk [-Wnonportable-include-path]
  #include "Dirichlet.h"
           ^~~~~~~~~~~~~
           "dirichlet.h"
  kernel/kernel_code/Dirichlet.c:118:91: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?
  static void         array_to_matrix_pair_list(O31Matrix generators[], int num_generators, MatrixPairList *gen_list);
                                                                                            ^~~~~~~~~~~~~~
                                                                                            MatrixParity
  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here
  } MatrixParity;
    ^
  kernel/kernel_code/Dirichlet.c:119:52: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?
  static Boolean      is_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);
                                                     ^~~~~~~~~~~~~~
                                                     MatrixParity
  kernel/headers/SnapPea.h:100:3: note: 'MatrixParity' declared here
  } MatrixParity;
    ^
  kernel/kernel_code/Dirichlet.c:120:56: error: unknown type name 'MatrixPairList'; did you mean 'MatrixParity'?
  static void         insert_matrix_on_list(O31Matrix m, MatrixPairList *gen_list);
                                                         ^~~~~~~~~~~~~~
                                                         MatrixParity
```



---

archive/issue_comments_502594.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nReplying to [@mkoeppe](#comment%3A12):\n> I am not sure. It does not seem like a very robust solution. \n\nNot that it means much, but we haven't had any reports of problems with `sage -pip install snappy` as our default install instructions.\n\nI agree it would be preferable just to pass the `--no-deps` flag to `pip`, but my understanding is that this is not possible in the context of a \"sage pip package\"?\n\n> Just as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.\n\nOuch, that's a bug on our part, it seems we broke the sdist tarball in 2.4.0, on all platforms, no less: we moved some files around and forgot to update `MANIFEST.in`.  We'll release 2.4.1 to fix this shortly.",
    "created_at": "2021-01-05T23:23:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502594",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:14" align="right">Comment 14</div>

Replying to [@mkoeppe](#comment%3A12):
> I am not sure. It does not seem like a very robust solution. 

Not that it means much, but we haven't had any reports of problems with `sage -pip install snappy` as our default install instructions.

I agree it would be preferable just to pass the `--no-deps` flag to `pip`, but my understanding is that this is not possible in the context of a "sage pip package"?

> Just as a data point: I seem to be having trouble installing `cypari` into Sage here on macOS using python 3.9, for which no prebuilt wheel is available.

Ouch, that's a bug on our part, it seems we broke the sdist tarball in 2.4.0, on all platforms, no less: we moved some files around and forgot to update `MANIFEST.in`.  We'll release 2.4.1 to fix this shortly.



---

archive/issue_comments_502595.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nReplying to [@mkoeppe](#comment%3A13):\n> Also `./sage -pip install -v -v snappy` on the same system gives:\n\nMarc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.",
    "created_at": "2021-01-06T16:24:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502595",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:15" align="right">Comment 15</div>

Replying to [@mkoeppe](#comment%3A13):
> Also `./sage -pip install -v -v snappy` on the same system gives:

Marc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.



---

archive/issue_comments_502596.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nReplying to [@NathanDunfield](#comment%3A15):\n> Replying to [@mkoeppe](#comment%3A13):\n> > Also `./sage -pip install -v -v snappy` on the same system gives:\n\n> \n> Marc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.\n\nI think it's actually coming from `/usr/local/include/` on my system (from homebrew's arb). \n\nThe question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)",
    "created_at": "2021-01-06T18:20:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502596",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">Comment 16</div>

Replying to [@NathanDunfield](#comment%3A15):
> Replying to [@mkoeppe](#comment%3A13):
> > Also `./sage -pip install -v -v snappy` on the same system gives:

> 
> Marc Culler points out the likely cause of this: there is a `dirichlet.h` in `$SAGELOCAL/include` that is part of `arb` as well as a `Dirichlet.h` that's part of SnapPy.  Since macOS file system default to case-insensitive, there's a name collision which triggers the `nonportable-include-path` warning.

I think it's actually coming from `/usr/local/include/` on my system (from homebrew's arb). 

The question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)



---

archive/issue_comments_502597.json:
```json
{
    "body": "Changed commit from **[46f7b0e](https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb)** to **[5a76fdc](https://github.com/sagemath/sagetrac-mirror/commit/5a76fdc85fce746601f3893ca2ab54cdb7604e18)**",
    "created_at": "2021-01-06T19:23:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502597",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[46f7b0e](https://github.com/sagemath/sagetrac-mirror/commit/46f7b0e46732c647d2889486117e281e2713c3cb)** to **[5a76fdc](https://github.com/sagemath/sagetrac-mirror/commit/5a76fdc85fce746601f3893ca2ab54cdb7604e18)**



---

archive/issue_comments_502598.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5a76fdc85fce746601f3893ca2ab54cdb7604e18\">5a76fdc</a></td><td><code>build/pkgs/snappy: Update dependencies, requirements.txt, add comments</code></td></tr></table>\n",
    "created_at": "2021-01-06T19:23:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502598",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17" align="right">Comment 17</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5a76fdc85fce746601f3893ca2ab54cdb7604e18">5a76fdc</a></td><td><code>build/pkgs/snappy: Update dependencies, requirements.txt, add comments</code></td></tr></table>




---

archive/issue_comments_502599.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f2ca439b97ba78c01e22305ac769e13ba819b463\">f2ca439</a></td><td><code>No future</code></td></tr></table>\n",
    "created_at": "2021-01-06T19:29:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502599",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18" align="right">Comment 18</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f2ca439b97ba78c01e22305ac769e13ba819b463">f2ca439</a></td><td><code>No future</code></td></tr></table>




---

archive/issue_comments_502600.json:
```json
{
    "body": "Changed commit from **[5a76fdc](https://github.com/sagemath/sagetrac-mirror/commit/5a76fdc85fce746601f3893ca2ab54cdb7604e18)** to **[f2ca439](https://github.com/sagemath/sagetrac-mirror/commit/f2ca439b97ba78c01e22305ac769e13ba819b463)**",
    "created_at": "2021-01-06T19:29:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502600",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5a76fdc](https://github.com/sagemath/sagetrac-mirror/commit/5a76fdc85fce746601f3893ca2ab54cdb7604e18)** to **[f2ca439](https://github.com/sagemath/sagetrac-mirror/commit/f2ca439b97ba78c01e22305ac769e13ba819b463)**



---

archive/issue_comments_502601.json:
```json
{
    "body": "Changed commit from **[f2ca439](https://github.com/sagemath/sagetrac-mirror/commit/f2ca439b97ba78c01e22305ac769e13ba819b463)** to **[c8583bb](https://github.com/sagemath/sagetrac-mirror/commit/c8583bb376165f2c96751ed6a4e2eea046aa17de)**",
    "created_at": "2021-01-06T19:31:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502601",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[f2ca439](https://github.com/sagemath/sagetrac-mirror/commit/f2ca439b97ba78c01e22305ac769e13ba819b463)** to **[c8583bb](https://github.com/sagemath/sagetrac-mirror/commit/c8583bb376165f2c96751ed6a4e2eea046aa17de)**



---

archive/issue_comments_502602.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c8583bb376165f2c96751ed6a4e2eea046aa17de\">c8583bb</a></td><td><code>build/pkgs/snappy/requirements.txt: Avoid cypari 2.4.0</code></td></tr></table>\n",
    "created_at": "2021-01-06T19:31:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502602",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19" align="right">Comment 19</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c8583bb376165f2c96751ed6a4e2eea046aa17de">c8583bb</a></td><td><code>build/pkgs/snappy/requirements.txt: Avoid cypari 2.4.0</code></td></tr></table>




---

archive/issue_comments_502603.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nReplying to [@mkoeppe](#comment%3A16):\n> The question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)\n\nOn my macOS 10.15 box, with Python in /Frameworks from Python.org, I get:\n\n```\ngcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -arch x86_64 -g \n   -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type \n   -I/Library/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c \n   kernel/addl_code/get_gluing_equations.c -o build/temp.macosx-10.9-x86_64-3.9/kernel/addl_code/get_gluing_equations.o\n```\nIn particular, the includes start with the SnapPy specific ones and then the location of `Python.h` as desired.  Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.",
    "created_at": "2021-01-07T02:45:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502603",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:20" align="right">Comment 20</div>

Replying to [@mkoeppe](#comment%3A16):
> The question is where the first `-I/usr/local/include` on the gcc command line is coming from. This is causing the wrong file to be picked up. (The rest of the order of the includes looks fine.)

On my macOS 10.15 box, with Python in /Frameworks from Python.org, I get:

```
gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -arch x86_64 -g 
   -Ikernel/headers -Ikernel/unix_kit -Ikernel/addl_code -Ikernel/real_type 
   -I/Library/Frameworks/Python.framework/Versions/3.9/include/python3.9 -c 
   kernel/addl_code/get_gluing_equations.c -o build/temp.macosx-10.9-x86_64-3.9/kernel/addl_code/get_gluing_equations.o
```
In particular, the includes start with the SnapPy specific ones and then the location of `Python.h` as desired.  Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.



---

archive/issue_comments_502604.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nReplying to [@NathanDunfield](#comment%3A20):\n> Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.\n\nAssuming you're using homebrew's Python, the above seems quite likely as there I get:\n\n```\n$ /usr/local/Cellar/python@3.9/3.9.0_1/bin/python3\n>>> import sysconfig\n>>> sysconfig.get_config_var('CFLAGS')\n'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall \n-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include \n-I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'",
    "created_at": "2021-01-07T02:52:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502604",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:21" align="right">Comment 21</div>

Replying to [@NathanDunfield](#comment%3A20):
> Maybe your first `-I /usr/local/include` is somehow coming from `CFLAGS`, or from the `CFLAGS` that were set when Python itself was built?  I believe `setuptools` uses as least some of the latter.

Assuming you're using homebrew's Python, the above seems quite likely as there I get:

```
$ /usr/local/Cellar/python@3.9/3.9.0_1/bin/python3
>>> import sysconfig
>>> sysconfig.get_config_var('CFLAGS')
'-Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall 
-isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/usr/include 
-I/Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers'



---

archive/issue_comments_502605.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nYes, my python3 is (Sage's venv over) homebrew python3.9 -- so this (the `CFLAGS` from `sysconfig`, not the environment) is how the `-I/usr/local/include` is entering on my system. \n\nThis is rather unfortunate and may also be the cause of the issues reported in #31132.",
    "created_at": "2021-01-07T03:22:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502605",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">Comment 22</div>

Yes, my python3 is (Sage's venv over) homebrew python3.9 -- so this (the `CFLAGS` from `sysconfig`, not the environment) is how the `-I/usr/local/include` is entering on my system. 

This is rather unfortunate and may also be the cause of the issues reported in #31132.



---

archive/issue_comments_502606.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nI have opened https://github.com/3-manifolds/SnapPy/issues/21 and\ncommented on https://github.com/fredrik-johansson/arb/issues/239 - where the issue of arb header names was already brought up as causing problems.",
    "created_at": "2021-01-07T09:44:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502606",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:23" align="right">Comment 23</div>

I have opened https://github.com/3-manifolds/SnapPy/issues/21 and
commented on https://github.com/fredrik-johansson/arb/issues/239 - where the issue of arb header names was already brought up as causing problems.



---

archive/issue_comments_502607.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2021-01-07T09:44:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502607",
    "user": "https://github.com/dimpase"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_502608.json:
```json
{
    "body": "Dependencies: **#31132**",
    "created_at": "2021-01-09T00:36:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502608",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#31132**



---

archive/issue_comments_502609.json:
```json
{
    "body": "Changed commit from **[c8583bb](https://github.com/sagemath/sagetrac-mirror/commit/c8583bb376165f2c96751ed6a4e2eea046aa17de)** to **[fb5366d](https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584)**",
    "created_at": "2021-01-09T00:53:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502609",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c8583bb](https://github.com/sagemath/sagetrac-mirror/commit/c8583bb376165f2c96751ed6a4e2eea046aa17de)** to **[fb5366d](https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584)**



---

archive/issue_comments_502610.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532\">2c60025</a></td><td><code>m4/sage_check_python_for_venv.m4: Warn if python3 is misconfigured like it is currently in homebrew</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293\">ee679bd</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Do not check sysconfig CPPFLAGS so that /usr/bin/python3 is accepted on macOS; reject broken homebrew python3 unless requested explicitly with configgure --with-python=...</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584\">fb5366d</a></td><td><code>Merge branch 't/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3' into t/31180/add_snappy_as_a_pip_package</code></td></tr></table>\n",
    "created_at": "2021-01-09T00:53:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502610",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:26" align="right">Comment 26</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c6002555d21e242ab5d1e25e4d1f3851e246532">2c60025</a></td><td><code>m4/sage_check_python_for_venv.m4: Warn if python3 is misconfigured like it is currently in homebrew</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ee679bd57302d8e422e76b422d73f83ab87a4293">ee679bd</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Do not check sysconfig CPPFLAGS so that /usr/bin/python3 is accepted on macOS; reject broken homebrew python3 unless requested explicitly with configgure --with-python=...</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584">fb5366d</a></td><td><code>Merge branch 't/31132/homebrew__unused_packages__singular__pari_______in__usr_local_leak_into_build_when_using_homebrew_s_python3' into t/31180/add_snappy_as_a_pip_package</code></td></tr></table>




---

archive/issue_comments_502611.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nWith the fix from #31132 (rejecting broken homebrew python3) and rejecting the broken cypari 2.4.0 via `requirements.txt`, this now seems to work well here on macOS.",
    "created_at": "2021-01-09T01:30:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502611",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:27" align="right">Comment 27</div>

With the fix from #31132 (rejecting broken homebrew python3) and rejecting the broken cypari 2.4.0 via `requirements.txt`, this now seems to work well here on macOS.



---

archive/issue_events_411568.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-09T01:30:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411568"
}
```



---

archive/issue_comments_502612.json:
```json
{
    "body": "Reviewer: **https://github.com/mkoeppe/sage/actions/runs/473272399, https://github.com/mkoeppe/sage/actions/runs/473272391, ...**",
    "created_at": "2021-01-09T01:36:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502612",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **https://github.com/mkoeppe/sage/actions/runs/473272399, https://github.com/mkoeppe/sage/actions/runs/473272391, ...**



---

archive/issue_comments_502613.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nWaiting for review",
    "created_at": "2021-01-26T20:56:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502613",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">Comment 30</div>

Waiting for review



---

archive/issue_events_411569.json:
```json
{
    "actor": "https://github.com/NathanDunfield",
    "created_at": "2021-01-27T04:12:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411569"
}
```



---

archive/issue_events_411570.json:
```json
{
    "actor": "https://github.com/NathanDunfield",
    "created_at": "2021-01-27T04:12:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411570"
}
```



---

archive/issue_comments_502614.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nTried it out, `sage -i snappy` installs working `snappy` as expected, setting positive review.",
    "created_at": "2021-01-27T04:12:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502614",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:31" align="right">Comment 31</div>

Tried it out, `sage -i snappy` installs working `snappy` as expected, setting positive review.



---

archive/issue_comments_502615.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">Comment 32</div>\n\nI am very glad that we will have better support for snappy in Sage!",
    "created_at": "2021-01-27T12:57:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502615",
    "user": "https://github.com/videlec"
}
```

<div id="comment:32" align="right">Comment 32</div>

I am very glad that we will have better support for snappy in Sage!



---

archive/issue_comments_502616.json:
```json
{
    "body": "Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/473272399, https://github.com/mkoeppe/sage/actions/runs/473272391, ...** to **Nathan Dunfield**",
    "created_at": "2021-01-29T03:38:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502616",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/473272399, https://github.com/mkoeppe/sage/actions/runs/473272391, ...** to **Nathan Dunfield**



---

archive/issue_comments_502617.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">Comment 34</div>\n\nThis probably makes #20739 obsolete.",
    "created_at": "2021-03-07T03:06:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502617",
    "user": "https://github.com/slel"
}
```

<div id="comment:34" align="right">Comment 34</div>

This probably makes #20739 obsolete.



---

archive/issue_events_411571.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-07T17:05:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411571"
}
```



---

archive/issue_events_411572.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "7dfb05af9e7938c4c96e597ebe0cf11b78e4658b",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-03-07T17:05:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31180#event-411572"
}
```



---

archive/issue_comments_502618.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/add_snappy_as_a_pip_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/add_snappy_as_a_pip_package)** to **[fb5366d](https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584)**",
    "created_at": "2021-03-07T17:05:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31180",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31180#issuecomment-502618",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/add_snappy_as_a_pip_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/add_snappy_as_a_pip_package)** to **[fb5366d](https://github.com/sagemath/sagetrac-mirror/commit/fb5366d691b94f97d3ca5afc2673142ee91b5584)**
