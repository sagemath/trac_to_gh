# Issue 31600: threejs does not handle transparency correctly

archive/issues_031363.json:
```json
{
    "body": "Here is an example to reproduce it yourself:\n\n```\ntheta,z=var('theta,z')\ncb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue')\ncr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red')\ncv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green')\np = cb + cr + cv\n```\n\nCompare\n\n```\np.show(aspect_ratio=1)\n```\n\nwith\n\n```\np.show(viewer='jmol', aspect_ratio=1)\n```\n\nAs you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.\n\n![]( threejs.good.transparency.png)\n![]( threejs.no.transparency.png)\n![]( threejs.wrong.transparency.png)\n\n\nCC:  @egourgoulhon @jcamp0x2a @paulmasson @slel @guenterrote\n\nBranch/Commit: 515bcf400723d186740db76a21d1613c1cf1ddf7\n\nReviewer: Matthias Koeppe\n\nAuthor: Joshua Campbell\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31600\n\n",
    "closed_at": "2021-04-26T21:59:12Z",
    "created_at": "2021-04-03T11:42:03Z",
    "labels": [
        "component: graphics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "threejs does not handle transparency correctly",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31600",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
Here is an example to reproduce it yourself:

```
theta,z=var('theta,z')
cb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue')
cr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red')
cv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green')
p = cb + cr + cv
```

Compare

```
p.show(aspect_ratio=1)
```

with

```
p.show(viewer='jmol', aspect_ratio=1)
```

As you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.

![]( threejs.good.transparency.png)
![]( threejs.no.transparency.png)
![]( threejs.wrong.transparency.png)


CC:  @egourgoulhon @jcamp0x2a @paulmasson @slel @guenterrote

Branch/Commit: 515bcf400723d186740db76a21d1613c1cf1ddf7

Reviewer: Matthias Koeppe

Author: Joshua Campbell

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31600





---

archive/issue_comments_478991.json:
```json
{
    "body": "Attachment [threejs.good.transparency.png](tarball://root/attachments/some-uuid/ticket31600/threejs.good.transparency.png) by tmonteil created at 2021-04-03 11:52:50",
    "created_at": "2021-04-03T11:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478991",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Attachment [threejs.good.transparency.png](tarball://root/attachments/some-uuid/ticket31600/threejs.good.transparency.png) by tmonteil created at 2021-04-03 11:52:50



---

archive/issue_comments_478992.json:
```json
{
    "body": "Attachment [threejs.no.transparency.png](tarball://root/attachments/some-uuid/ticket31600/threejs.no.transparency.png) by tmonteil created at 2021-04-03 11:53:02",
    "created_at": "2021-04-03T11:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478992",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Attachment [threejs.no.transparency.png](tarball://root/attachments/some-uuid/ticket31600/threejs.no.transparency.png) by tmonteil created at 2021-04-03 11:53:02



---

archive/issue_comments_478993.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -20,7 +20,12 @@\n p.show(viewer='jmol', aspect_ratio=1)\n \\`\\`\\`\n \n-As you can see, with \\`threejs\\`, when you rotate the picture, on some angles, the transparency is ok, but sometimes, there is no transparency at all, and sometimes, there is a wrong transparency, see the attached pictures.\n+As you can see, with \\`threejs\\`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.\n+\n+![]( threejs.good.transparency.png)\n+![]( threejs.no.transparency.png)\n+![]( threejs.wrong.transparency.png)\n+\n \n Priority: major\n \n```\n",
    "created_at": "2021-04-03T11:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478993",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Description changed:
```diff
--- 
+++ 
@@ -20,7 +20,12 @@
 p.show(viewer='jmol', aspect_ratio=1)
 \`\`\`
 
-As you can see, with \`threejs\`, when you rotate the picture, on some angles, the transparency is ok, but sometimes, there is no transparency at all, and sometimes, there is a wrong transparency, see the attached pictures.
+As you can see, with \`threejs\`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.
+
+![]( threejs.good.transparency.png)
+![]( threejs.no.transparency.png)
+![]( threejs.wrong.transparency.png)
+
 
 Priority: major
 
```




---

archive/issue_comments_478994.json:
```json
{
    "body": "<a id='comment:1'></a>Attachment [threejs.wrong.transparency.png](tarball://root/attachments/some-uuid/ticket31600/threejs.wrong.transparency.png) by tmonteil created at 2021-04-03 11:55:52",
    "created_at": "2021-04-03T11:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478994",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:1'></a>Attachment [threejs.wrong.transparency.png](tarball://root/attachments/some-uuid/ticket31600/threejs.wrong.transparency.png) by tmonteil created at 2021-04-03 11:55:52



---

archive/issue_comments_478995.json:
```json
{
    "body": "<a id='comment:2'></a>I've used the `render_order` option in the past to help with nested transparent surfaces. So you'd make sure your cylinders are rendered innermost to outermost (green then red then blue):\n\n```python\ntheta,z=var('theta,z')\ncb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue', render_order=-1)\ncr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red', render_order=-2)\ncv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green', render_order=-3)\np = cb + cr + cv\nshow(p, viewer='threejs')\n```\n\nYou'll still see issues with self-transparency due to the order in which the faces of each cylinder are drawn. Also, adjusting the render order can conflict with the text sprites, so I try to use negative values.\n\n---\n\nI don't know of a way to automatically set the render order or that it'd even be possible for some arbitrary set of transparent surfaces.\n\nBut for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?\n\nI've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.\n\n---\nNew commits:",
    "created_at": "2021-04-03T17:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478995",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:2'></a>I've used the `render_order` option in the past to help with nested transparent surfaces. So you'd make sure your cylinders are rendered innermost to outermost (green then red then blue):

```python
theta,z=var('theta,z')
cb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue', render_order=-1)
cr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red', render_order=-2)
cv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green', render_order=-3)
p = cb + cr + cv
show(p, viewer='threejs')
```

You'll still see issues with self-transparency due to the order in which the faces of each cylinder are drawn. Also, adjusting the render order can conflict with the text sprites, so I try to use negative values.

---

I don't know of a way to automatically set the render order or that it'd even be possible for some arbitrary set of transparent surfaces.

But for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?

I've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.

---
New commits:



---

archive/issue_comments_478996.json:
```json
{
    "body": "Attachment [noDepthWrite.html](tarball://root/attachments/some-uuid/ticket31600/noDepthWrite.html) by @jcamp0x2a created at 2021-04-03 17:05:05\n\nExample with depth write of text and transparent surfaces disabled",
    "created_at": "2021-04-03T17:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478996",
    "user": "https://github.com/jcamp0x2a"
}
```

Attachment [noDepthWrite.html](tarball://root/attachments/some-uuid/ticket31600/noDepthWrite.html) by @jcamp0x2a created at 2021-04-03 17:05:05

Example with depth write of text and transparent surfaces disabled



---

archive/issue_comments_478997.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 gh-jcamp0x2a]:\n\n> But for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?\n\n\nIt might be for performance reasons. On such a small scene the difference might not be\nnoticeable. (By the way, I noticed that on my little desktop, the noDepthWrite.html example ignites the cooling fan one second after I start rotating the scene, when viewing with the Chromium browser. But the situation is the same with the \"normal\" sage graphics output for this scene).\n\nIt is known that, in principle, a depth buffer cannot handle multiple transparent surfaces correctly unless they come in a consistent order (front-to-back or back-to-front).\n\nIs there some documentation on what threejs does when setting depthWrite: false\n\nMaybe the behaviour should be controllable by an option by the user.\n\n\n> I've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.\n\n\nThe example looks good!",
    "created_at": "2021-04-04T05:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478997",
    "user": "https://github.com/guenterrote"
}
```

<a id='comment:3'></a>Replying to [comment:2 gh-jcamp0x2a]:

> But for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?


It might be for performance reasons. On such a small scene the difference might not be
noticeable. (By the way, I noticed that on my little desktop, the noDepthWrite.html example ignites the cooling fan one second after I start rotating the scene, when viewing with the Chromium browser. But the situation is the same with the "normal" sage graphics output for this scene).

It is known that, in principle, a depth buffer cannot handle multiple transparent surfaces correctly unless they come in a consistent order (front-to-back or back-to-front).

Is there some documentation on what threejs does when setting depthWrite: false

Maybe the behaviour should be controllable by an option by the user.


> I've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.


The example looks good!



---

archive/issue_comments_478998.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 guenterrote]:\n> Is there some documentation on what threejs does when setting depthWrite: false\n\n>\n\nThe [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:\n\n- [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)\n- [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)\n- [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)\n \n> Maybe the behaviour should be controllable by an option by the user.\n> \n\n\nWould want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)",
    "created_at": "2021-04-04T19:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478998",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:4'></a>Replying to [comment:3 guenterrote]:
> Is there some documentation on what threejs does when setting depthWrite: false

>

The [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:

- [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)
- [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)
- [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)
 
> Maybe the behaviour should be controllable by an option by the user.
> 


Would want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)



---

archive/issue_comments_478999.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 gh-jcamp0x2a]:\n> Replying to [comment:3 guenterrote]:\n> > Is there some documentation on what threejs does when setting depthWrite: false\n\n> >\n> \n> The [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:\n> \n> - [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)\n> - [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)\n> - [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)\n>  \n> > Maybe the behaviour should be controllable by an option by the user.\n> > \n\n> \n> Would want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)\n\nJoshua, why don\u2019t you ask these questions in the Three.js forum: https://discourse.threejs.org/",
    "created_at": "2021-04-04T19:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-478999",
    "user": "https://github.com/paulmasson"
}
```

<a id='comment:5'></a>Replying to [comment:4 gh-jcamp0x2a]:
> Replying to [comment:3 guenterrote]:
> > Is there some documentation on what threejs does when setting depthWrite: false

> >
> 
> The [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:
> 
> - [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)
> - [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)
> - [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)
>  
> > Maybe the behaviour should be controllable by an option by the user.
> > 

> 
> Would want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)

Joshua, why don’t you ask these questions in the Three.js forum: https://discourse.threejs.org/



---

archive/issue_comments_479000.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 paulmasson]:\n> Joshua, why don\u2019t you ask these questions in the Three.js forum: https://discourse.threejs.org/\n\n\nHi Paul! Thanks for the link to the forum. I'll try to keep it in mind as an additional resource for questions in the future.\n\nIt looks like something similar to this issue been discussed there quite a bit already. I found [ThreeJS and the transparent problem](https://discourse.threejs.org/t/threejs-and-the-transparent-problem/11553/18) to be an interesting read. The rule of thumb indeed seems to be to disable depth write for transparent objects. I also found [GLTFLoader: Use depthWrite=false for transparent materials](https://github.com/mrdoob/three.js/pull/18235) which seems to support that and makes up my lack of imagination with some links to cases where you'd want the depth-write to remain enabled.\n\nThere's also a few interesting techniques mentioned in there like screendoor transparency and \"Weighted Blended Order-Independent Transparency\" that I didn't know about and will have to read up on now. :)",
    "created_at": "2021-04-04T20:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479000",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:6'></a>Replying to [comment:5 paulmasson]:
> Joshua, why don’t you ask these questions in the Three.js forum: https://discourse.threejs.org/


Hi Paul! Thanks for the link to the forum. I'll try to keep it in mind as an additional resource for questions in the future.

It looks like something similar to this issue been discussed there quite a bit already. I found [ThreeJS and the transparent problem](https://discourse.threejs.org/t/threejs-and-the-transparent-problem/11553/18) to be an interesting read. The rule of thumb indeed seems to be to disable depth write for transparent objects. I also found [GLTFLoader: Use depthWrite=false for transparent materials](https://github.com/mrdoob/three.js/pull/18235) which seems to support that and makes up my lack of imagination with some links to cases where you'd want the depth-write to remain enabled.

There's also a few interesting techniques mentioned in there like screendoor transparency and "Weighted Blended Order-Independent Transparency" that I didn't know about and will have to read up on now. :)



---

archive/issue_comments_479001.json:
```json
{
    "body": "<a id='comment:7'></a>I checked those references, and I must correct myself. This has no effect on performance. (I thought the use of the framebuffer is completely abandoned when setting depthWrite:false.)\n\nThe effect of `depthWrite:false` is that the order of the transparent surfaces is ignored: A blue transparent surface in front of a red transparent surface will tint the objects behind them in the same way as in the opposite order. The difference would probably only be noticeable if the transparent surfaces have some shinyness of their own.\n\nFor example, the top of the cylinders gives no visual clue whether you can see \"into the pipe\" from above or whether you look \"up\" to the pipe from below. (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)\n\nAnother case is when you have two transparent surfaces (plane) that intersect. Then you probably would like to see the difference, which one is in front and in particular where they intersect and change the order. But `depthWrite:true` also does not resolve such a case correctly.\n\nI would advocate to switch to disabling depth-write by default.",
    "created_at": "2021-04-05T20:45:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479001",
    "user": "https://github.com/guenterrote"
}
```

<a id='comment:7'></a>I checked those references, and I must correct myself. This has no effect on performance. (I thought the use of the framebuffer is completely abandoned when setting depthWrite:false.)

The effect of `depthWrite:false` is that the order of the transparent surfaces is ignored: A blue transparent surface in front of a red transparent surface will tint the objects behind them in the same way as in the opposite order. The difference would probably only be noticeable if the transparent surfaces have some shinyness of their own.

For example, the top of the cylinders gives no visual clue whether you can see "into the pipe" from above or whether you look "up" to the pipe from below. (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)

Another case is when you have two transparent surfaces (plane) that intersect. Then you probably would like to see the difference, which one is in front and in particular where they intersect and change the order. But `depthWrite:true` also does not resolve such a case correctly.

I would advocate to switch to disabling depth-write by default.



---

archive/issue_comments_479002.json:
```json
{
    "body": "<a id='comment:8'></a>Here is an example where `depthWrite:false` would eliminate a visual distinction:\n\n```\nsage: var(\"u v\")                                                                                                        \nsage: red1 = parametric_plot3d([u,v,0.1-u-v],(u,0,2),(v,0,2),alpha=0.6, color='red',render_order=1)                     \nsage: green= parametric_plot3d([u,v,0.2-u-v],(u,1,3),(v,1,3),alpha=0.6, color='green',render_order=2)                  \nsage: red2 = parametric_plot3d([u,v,0.3-u-v],(u,0,2),(v,2.2,4.2),alpha=0.6, color='red',render_order=3)                 \nsage: (red1+green+red2).show()                                                                                          \n```\nBut surprise when looking from behind!\n(Why did I find no documentation on the `render_order` option?)",
    "created_at": "2021-04-05T20:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479002",
    "user": "https://github.com/guenterrote"
}
```

<a id='comment:8'></a>Here is an example where `depthWrite:false` would eliminate a visual distinction:

```
sage: var("u v")                                                                                                        
sage: red1 = parametric_plot3d([u,v,0.1-u-v],(u,0,2),(v,0,2),alpha=0.6, color='red',render_order=1)                     
sage: green= parametric_plot3d([u,v,0.2-u-v],(u,1,3),(v,1,3),alpha=0.6, color='green',render_order=2)                  
sage: red2 = parametric_plot3d([u,v,0.3-u-v],(u,0,2),(v,2.2,4.2),alpha=0.6, color='red',render_order=3)                 
sage: (red1+green+red2).show()                                                                                          
```
But surprise when looking from behind!
(Why did I find no documentation on the `render_order` option?)



---

archive/issue_comments_479003.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 guenterrote]:\n> (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)\n> \n\n\nRay-tracing is the future :)",
    "created_at": "2021-04-06T00:33:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479003",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:9'></a>Replying to [comment:7 guenterrote]:
> (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)
> 


Ray-tracing is the future :)



---

archive/issue_comments_479004.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 guenterrote]:\n> (Why did I find no documentation on the `render_order` option?)\n\n\nIt's listed in the reference manual for the Three.js viewer: https://doc.sagemath.org/html/en/reference/plot3d/threejs.html\n\nCool example :)",
    "created_at": "2021-04-06T00:35:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479004",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:10'></a>Replying to [comment:8 guenterrote]:
> (Why did I find no documentation on the `render_order` option?)


It's listed in the reference manual for the Three.js viewer: https://doc.sagemath.org/html/en/reference/plot3d/threejs.html

Cool example :)



---

archive/issue_comments_479005.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-08T20:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479005",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_479006.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-08T21:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479006",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479007.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-08T21:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479007",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_479008.json:
```json
{
    "body": "<a id='comment:13'></a>I've added an option and documentation for controlling whether to do the depth-write for surfaces.",
    "created_at": "2021-04-08T21:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479008",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:13'></a>I've added an option and documentation for controlling whether to do the depth-write for surfaces.



---

archive/issue_comments_479009.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-04-15T06:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479009",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_479010.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-15T06:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479010",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479011.json:
```json
{
    "body": "<a id='comment:15'></a>Just ran into this problem myself. This fixes it.",
    "created_at": "2021-04-15T06:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479011",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Just ran into this problem myself. This fixes it.



---

archive/issue_events_083113.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T06:25:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31600#event-83113"
}
```



---

archive/issue_comments_479012.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-04-18T16:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479012",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_479013.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-26T21:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-479013",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_083114.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-04-26T21:59:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31600#event-83114"
}
```
