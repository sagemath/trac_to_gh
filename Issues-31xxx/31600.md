# Issue 31600: threejs does not handle transparency correctly

archive/issues_031363.json:
```json
{
    "assignees": [],
    "body": "Here is an example to reproduce it yourself:\n\n```\ntheta,z=var('theta,z')\ncb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue')\ncr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red')\ncv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green')\np = cb + cr + cv\n```\n\nCompare\n\n```\np.show(aspect_ratio=1)\n```\n\nwith\n\n```\np.show(viewer='jmol', aspect_ratio=1)\n```\n\nAs you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.\n\n![](https://github.com/sagemath/sage/files/ticket31600/afaa1139002dabd45b781ffe5ce508cc.png)\n![](https://github.com/sagemath/sage/files/ticket31600/39e35d6a6ae0ed61373859e4e93d3660.png)\n![](https://github.com/sagemath/sage/files/ticket31600/1b82f4c0c21568037b22245f96d15c00.png)\n\n\nCC:  @egourgoulhon @jcamp0x2a @paulmasson @slel @guenterrote\n\nBranch/Commit: **[`515bcf4`](https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7)**\n\nReviewer: **Matthias Koeppe**\n\nAuthor: **Joshua Campbell**\n\nComponent: **graphics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31600_\n\n",
    "closed_at": "2021-04-26T21:59:12Z",
    "created_at": "2021-04-03T11:42:03Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20graphics",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "threejs does not handle transparency correctly",
    "type": "issue",
    "updated_at": "2021-04-26T21:59:12Z",
    "url": "https://github.com/sagemath/sage/issues/31600",
    "user": "https://github.com/sagetrac-tmonteil"
}
```
Here is an example to reproduce it yourself:

```
theta,z=var('theta,z')
cb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue')
cr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red')
cv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green')
p = cb + cr + cv
```

Compare

```
p.show(aspect_ratio=1)
```

with

```
p.show(viewer='jmol', aspect_ratio=1)
```

As you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.

![](https://github.com/sagemath/sage/files/ticket31600/afaa1139002dabd45b781ffe5ce508cc.png)
![](https://github.com/sagemath/sage/files/ticket31600/39e35d6a6ae0ed61373859e4e93d3660.png)
![](https://github.com/sagemath/sage/files/ticket31600/1b82f4c0c21568037b22245f96d15c00.png)


CC:  @egourgoulhon @jcamp0x2a @paulmasson @slel @guenterrote

Branch/Commit: **[`515bcf4`](https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7)**

Reviewer: **Matthias Koeppe**

Author: **Joshua Campbell**

Component: **graphics**

_Issue created by migration from https://trac.sagemath.org/ticket/31600_





---

archive/issue_events_432672.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2021-04-03T11:42:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432672"
}
```



---

archive/issue_events_432673.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2021-04-03T11:42:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20graphics",
    "label_color": "0000ff",
    "label_name": "c: graphics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432673"
}
```



---

archive/issue_events_432674.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2021-04-03T11:42:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432674"
}
```



---

archive/issue_events_432675.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2021-04-03T11:42:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432675"
}
```



---

archive/issue_comments_508257.json:
```json
{
    "body": "Attachment: **[threejs.good.transparency.png](https://github.com/sagemath/sage/files/ticket31600/threejs.good.transparency.png)**",
    "created_at": "2021-04-03T11:52:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508257",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Attachment: **[threejs.good.transparency.png](https://github.com/sagemath/sage/files/ticket31600/threejs.good.transparency.png)**



---

archive/issue_comments_508258.json:
```json
{
    "body": "Attachment: **[threejs.no.transparency.png](https://github.com/sagemath/sage/files/ticket31600/threejs.no.transparency.png)**",
    "created_at": "2021-04-03T11:53:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508258",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Attachment: **[threejs.no.transparency.png](https://github.com/sagemath/sage/files/ticket31600/threejs.no.transparency.png)**



---

archive/issue_comments_508259.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,6 +20,9 @@\n p.show(viewer='jmol', aspect_ratio=1)\n ```\n \n-As you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is ok, but sometimes, there is no transparency at all, and sometimes, there is a wrong transparency, see the attached pictures.\n+As you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.\n \n+![](https://github.com/sagemath/sage/files/ticket31600/afaa1139002dabd45b781ffe5ce508cc.png)\n+![](https://github.com/sagemath/sage/files/ticket31600/39e35d6a6ae0ed61373859e4e93d3660.png)\n+![](https://github.com/sagemath/sage/files/ticket31600/1b82f4c0c21568037b22245f96d15c00.png)\n \n``````\n",
    "created_at": "2021-04-03T11:55:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508259",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,6 +20,9 @@
 p.show(viewer='jmol', aspect_ratio=1)
 ```
 
-As you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is ok, but sometimes, there is no transparency at all, and sometimes, there is a wrong transparency, see the attached pictures.
+As you can see, with `threejs`, when you rotate the picture, on some angles, the transparency is correct, but sometimes there is no transparency at all, and sometimes there is a wrong transparency, see the attached pictures.
 
+![](https://github.com/sagemath/sage/files/ticket31600/afaa1139002dabd45b781ffe5ce508cc.png)
+![](https://github.com/sagemath/sage/files/ticket31600/39e35d6a6ae0ed61373859e4e93d3660.png)
+![](https://github.com/sagemath/sage/files/ticket31600/1b82f4c0c21568037b22245f96d15c00.png)
 
``````




---

archive/issue_comments_508260.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nAttachment: **[threejs.wrong.transparency.png](https://github.com/sagemath/sage/files/ticket31600/threejs.wrong.transparency.png)**",
    "created_at": "2021-04-03T11:55:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508260",
    "user": "https://github.com/sagetrac-tmonteil"
}
```

<div id="comment:1" align="right">comment:1</div>

Attachment: **[threejs.wrong.transparency.png](https://github.com/sagemath/sage/files/ticket31600/threejs.wrong.transparency.png)**



---

archive/issue_comments_508261.json:
```json
{
    "body": "Commit: **[`f52b0ad`](https://github.com/sagemath/sagetrac-mirror/commit/f52b0ad9946e9b1d47ec76fffe65717bd76ca524)**",
    "created_at": "2021-04-03T17:04:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508261",
    "user": "https://github.com/jcamp0x2a"
}
```

Commit: **[`f52b0ad`](https://github.com/sagemath/sagetrac-mirror/commit/f52b0ad9946e9b1d47ec76fffe65717bd76ca524)**



---

archive/issue_comments_508262.json:
```json
{
    "body": "Branch: **[u/gh-jcamp0x2a/31600-transparency](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/31600-transparency)**",
    "created_at": "2021-04-03T17:04:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508262",
    "user": "https://github.com/jcamp0x2a"
}
```

Branch: **[u/gh-jcamp0x2a/31600-transparency](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/31600-transparency)**



---

archive/issue_comments_508263.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nI've used the `render_order` option in the past to help with nested transparent surfaces. So you'd make sure your cylinders are rendered innermost to outermost (green then red then blue):\n\n```python\ntheta,z=var('theta,z')\ncb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue', render_order=-1)\ncr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red', render_order=-2)\ncv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green', render_order=-3)\np = cb + cr + cv\nshow(p, viewer='threejs')\n```\n\nYou'll still see issues with self-transparency due to the order in which the faces of each cylinder are drawn. Also, adjusting the render order can conflict with the text sprites, so I try to use negative values.\n\n---\n\nI don't know of a way to automatically set the render order or that it'd even be possible for some arbitrary set of transparent surfaces.\n\nBut for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?\n\nI've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f52b0ad9946e9b1d47ec76fffe65717bd76ca524\"><code>f52b0ad</code></a></td><td><code>Disable depth-buffer write for text and transparent surfaces</code></td></tr></table>\n",
    "created_at": "2021-04-03T17:04:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508263",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:2" align="right">comment:2</div>

I've used the `render_order` option in the past to help with nested transparent surfaces. So you'd make sure your cylinders are rendered innermost to outermost (green then red then blue):

```python
theta,z=var('theta,z')
cb = cylindrical_plot3d(2,(theta,0,2*pi),(z,-5,5), alpha=0.3, color='blue', render_order=-1)
cr = cylindrical_plot3d(1,(theta,0,2*pi),(z,-7,7), alpha=0.3, color='red', render_order=-2)
cv = cylindrical_plot3d(0.5,(theta,0,2*pi),(z,-10,10), alpha=0.5, color='green', render_order=-3)
p = cb + cr + cv
show(p, viewer='threejs')
```

You'll still see issues with self-transparency due to the order in which the faces of each cylinder are drawn. Also, adjusting the render order can conflict with the text sprites, so I try to use negative values.

---

I don't know of a way to automatically set the render order or that it'd even be possible for some arbitrary set of transparent surfaces.

But for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?

I've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f52b0ad9946e9b1d47ec76fffe65717bd76ca524"><code>f52b0ad</code></a></td><td><code>Disable depth-buffer write for text and transparent surfaces</code></td></tr></table>




---

archive/issue_comments_508264.json:
```json
{
    "body": "Attachment: **[noDepthWrite.html.gz](https://github.com/sagemath/sage/files/ticket31600/noDepthWrite.html.gz)**\n\nExample with depth write of text and transparent surfaces disabled",
    "created_at": "2021-04-03T17:05:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508264",
    "user": "https://github.com/jcamp0x2a"
}
```

Attachment: **[noDepthWrite.html.gz](https://github.com/sagemath/sage/files/ticket31600/noDepthWrite.html.gz)**

Example with depth write of text and transparent surfaces disabled



---

archive/issue_comments_508265.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@jcamp0x2a](#comment%3A2):\n\n> But for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?\n\nIt might be for performance reasons. On such a small scene the difference might not be\nnoticeable. (By the way, I noticed that on my little desktop, the noDepthWrite.html example ignites the cooling fan one second after I start rotating the scene, when viewing with the Chromium browser. But the situation is the same with the \"normal\" sage graphics output for this scene).\n\nIt is known that, in principle, a depth buffer cannot handle multiple transparent surfaces correctly unless they come in a consistent order (front-to-back or back-to-front).\n\nIs there some documentation on what threejs does when setting depthWrite: false\n\nMaybe the behaviour should be controllable by an option by the user.\n\n\n> I've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.\n\nThe example looks good!",
    "created_at": "2021-04-04T05:01:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508265",
    "user": "https://github.com/guenterrote"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@jcamp0x2a](#comment%3A2):

> But for the self-transparency and text sprite problems I mentioned, perhaps it would be better to just disable writing to the depth-buffer entirely for transparent surfaces and text? I'm trying to think through whether this might result in other graphical glitches itself, since it seems so straight-forward that why wouldn't Three.js do this automatically when you make a material transparent?

It might be for performance reasons. On such a small scene the difference might not be
noticeable. (By the way, I noticed that on my little desktop, the noDepthWrite.html example ignites the cooling fan one second after I start rotating the scene, when viewing with the Chromium browser. But the situation is the same with the "normal" sage graphics output for this scene).

It is known that, in principle, a depth buffer cannot handle multiple transparent surfaces correctly unless they come in a consistent order (front-to-back or back-to-front).

Is there some documentation on what threejs does when setting depthWrite: false

Maybe the behaviour should be controllable by an option by the user.


> I've pushed a commit with this change and will attach an example with the same cylinders plus an intersecting opaque surface for comparison.

The example looks good!



---

archive/issue_comments_508266.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@guenterrote](#comment%3A3):\n> Is there some documentation on what threejs does when setting depthWrite: false\n\n>\n\nThe [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:\n\n- [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)\n- [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)\n- [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)\n \n> Maybe the behaviour should be controllable by an option by the user.\n> \n\nWould want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)",
    "created_at": "2021-04-04T19:44:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508266",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@guenterrote](#comment%3A3):
> Is there some documentation on what threejs does when setting depthWrite: false

>

The [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:

- [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)
- [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)
- [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)
 
> Maybe the behaviour should be controllable by an option by the user.
> 

Would want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)



---

archive/issue_comments_508267.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@jcamp0x2a](#comment%3A4):\n> Replying to [@guenterrote](#comment%3A3):\n> > Is there some documentation on what threejs does when setting depthWrite: false\n\n> >\n\n> \n> The [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:\n> \n> - [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)\n> - [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)\n> - [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)\n>  \n> > Maybe the behaviour should be controllable by an option by the user.\n> > \n\n> \n> Would want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)\n\nJoshua, why don\u2019t you ask these questions in the Three.js forum: https://discourse.threejs.org/",
    "created_at": "2021-04-04T19:52:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508267",
    "user": "https://github.com/paulmasson"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@jcamp0x2a](#comment%3A4):
> Replying to [@guenterrote](#comment%3A3):
> > Is there some documentation on what threejs does when setting depthWrite: false

> >

> 
> The [doc](https://threejs.org/docs/index.html#api/en/materials/Material.depthWrite) for it is basic, but it looks like it's only ever passed along as-is to WebGL's [glDepthMask](https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/depthMask) prior to rendering each object. A bit of the call stack in three.js:
> 
> - [DepthBuffer.setMask](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L95)
> - [WebGLState.setMaterial](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/webgl/WebGLState.js#L659)
> - [WebGLRenderer.renderObject](https://github.com/mrdoob/three.js/blob/e48fc94dfeaecfcbfa977ba67549e6108b370cbf/src/renderers/WebGLRenderer.js#L1319)
>  
> > Maybe the behaviour should be controllable by an option by the user.
> > 

> 
> Would want to default to disabling depth write I assume? So the user can toggle on the depth write only if they're having performance problems with lots of transparent surfaces. I'm still struggling to come up a non-performance reason for turning it on, though I have a limited imagination ;)

Joshua, why don’t you ask these questions in the Three.js forum: https://discourse.threejs.org/



---

archive/issue_comments_508268.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@paulmasson](#comment%3A5):\n> Joshua, why don\u2019t you ask these questions in the Three.js forum: https://discourse.threejs.org/\n\nHi Paul! Thanks for the link to the forum. I'll try to keep it in mind as an additional resource for questions in the future.\n\nIt looks like something similar to this issue been discussed there quite a bit already. I found [ThreeJS and the transparent problem](https://discourse.threejs.org/t/threejs-and-the-transparent-problem/11553/18) to be an interesting read. The rule of thumb indeed seems to be to disable depth write for transparent objects. I also found [GLTFLoader: Use depthWrite=false for transparent materials](https://github.com/mrdoob/three.js/pull/18235) which seems to support that and makes up my lack of imagination with some links to cases where you'd want the depth-write to remain enabled.\n\nThere's also a few interesting techniques mentioned in there like screendoor transparency and \"Weighted Blended Order-Independent Transparency\" that I didn't know about and will have to read up on now. :)",
    "created_at": "2021-04-04T20:50:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508268",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@paulmasson](#comment%3A5):
> Joshua, why don’t you ask these questions in the Three.js forum: https://discourse.threejs.org/

Hi Paul! Thanks for the link to the forum. I'll try to keep it in mind as an additional resource for questions in the future.

It looks like something similar to this issue been discussed there quite a bit already. I found [ThreeJS and the transparent problem](https://discourse.threejs.org/t/threejs-and-the-transparent-problem/11553/18) to be an interesting read. The rule of thumb indeed seems to be to disable depth write for transparent objects. I also found [GLTFLoader: Use depthWrite=false for transparent materials](https://github.com/mrdoob/three.js/pull/18235) which seems to support that and makes up my lack of imagination with some links to cases where you'd want the depth-write to remain enabled.

There's also a few interesting techniques mentioned in there like screendoor transparency and "Weighted Blended Order-Independent Transparency" that I didn't know about and will have to read up on now. :)



---

archive/issue_comments_508269.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI checked those references, and I must correct myself. This has no effect on performance. (I thought the use of the framebuffer is completely abandoned when setting depthWrite:false.)\n\nThe effect of `depthWrite:false` is that the order of the transparent surfaces is ignored: A blue transparent surface in front of a red transparent surface will tint the objects behind them in the same way as in the opposite order. The difference would probably only be noticeable if the transparent surfaces have some shinyness of their own.\n\nFor example, the top of the cylinders gives no visual clue whether you can see \"into the pipe\" from above or whether you look \"up\" to the pipe from below. (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)\n\nAnother case is when you have two transparent surfaces (plane) that intersect. Then you probably would like to see the difference, which one is in front and in particular where they intersect and change the order. But `depthWrite:true` also does not resolve such a case correctly.\n\nI would advocate to switch to disabling depth-write by default.",
    "created_at": "2021-04-05T20:45:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508269",
    "user": "https://github.com/guenterrote"
}
```

<div id="comment:7" align="right">comment:7</div>

I checked those references, and I must correct myself. This has no effect on performance. (I thought the use of the framebuffer is completely abandoned when setting depthWrite:false.)

The effect of `depthWrite:false` is that the order of the transparent surfaces is ignored: A blue transparent surface in front of a red transparent surface will tint the objects behind them in the same way as in the opposite order. The difference would probably only be noticeable if the transparent surfaces have some shinyness of their own.

For example, the top of the cylinders gives no visual clue whether you can see "into the pipe" from above or whether you look "up" to the pipe from below. (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)

Another case is when you have two transparent surfaces (plane) that intersect. Then you probably would like to see the difference, which one is in front and in particular where they intersect and change the order. But `depthWrite:true` also does not resolve such a case correctly.

I would advocate to switch to disabling depth-write by default.



---

archive/issue_comments_508270.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nHere is an example where `depthWrite:false` would eliminate a visual distinction:\n\n```\nsage: var(\"u v\")                                                                                                        \nsage: red1 = parametric_plot3d([u,v,0.1-u-v],(u,0,2),(v,0,2),alpha=0.6, color='red',render_order=1)                     \nsage: green= parametric_plot3d([u,v,0.2-u-v],(u,1,3),(v,1,3),alpha=0.6, color='green',render_order=2)                  \nsage: red2 = parametric_plot3d([u,v,0.3-u-v],(u,0,2),(v,2.2,4.2),alpha=0.6, color='red',render_order=3)                 \nsage: (red1+green+red2).show()                                                                                          \n```\nBut surprise when looking from behind!\n(Why did I find no documentation on the `render_order` option?)",
    "created_at": "2021-04-05T20:54:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508270",
    "user": "https://github.com/guenterrote"
}
```

<div id="comment:8" align="right">comment:8</div>

Here is an example where `depthWrite:false` would eliminate a visual distinction:

```
sage: var("u v")                                                                                                        
sage: red1 = parametric_plot3d([u,v,0.1-u-v],(u,0,2),(v,0,2),alpha=0.6, color='red',render_order=1)                     
sage: green= parametric_plot3d([u,v,0.2-u-v],(u,1,3),(v,1,3),alpha=0.6, color='green',render_order=2)                  
sage: red2 = parametric_plot3d([u,v,0.3-u-v],(u,0,2),(v,2.2,4.2),alpha=0.6, color='red',render_order=3)                 
sage: (red1+green+red2).show()                                                                                          
```
But surprise when looking from behind!
(Why did I find no documentation on the `render_order` option?)



---

archive/issue_comments_508271.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@guenterrote](#comment%3A7):\n> (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)\n> \n\nRay-tracing is the future :)",
    "created_at": "2021-04-06T00:33:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508271",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@guenterrote](#comment%3A7):
> (If you view it with tachyon, it really looks much better. Look at the transition between the green and red cylinder in the upper half and in the lower half)
> 

Ray-tracing is the future :)



---

archive/issue_comments_508272.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@guenterrote](#comment%3A8):\n> (Why did I find no documentation on the `render_order` option?)\n\nIt's listed in the reference manual for the Three.js viewer: https://doc.sagemath.org/html/en/reference/plot3d/threejs.html\n\nCool example :)",
    "created_at": "2021-04-06T00:35:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508272",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@guenterrote](#comment%3A8):
> (Why did I find no documentation on the `render_order` option?)

It's listed in the reference manual for the Three.js viewer: https://doc.sagemath.org/html/en/reference/plot3d/threejs.html

Cool example :)



---

archive/issue_comments_508273.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7f2eafe85c52c2f42d0704d8401ffc4d3d1434ff\"><code>7f2eafe</code></a></td><td><code>Disable depth-buffer write for text and transparent surfaces</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ec7cc0c3543267cd37ad6cf8505fcf30f2889d51\"><code>ec7cc0c</code></a></td><td><code>Add option to disable depth-buffer write for surfaces</code></td></tr></table>\n",
    "created_at": "2021-04-08T20:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508273",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7f2eafe85c52c2f42d0704d8401ffc4d3d1434ff"><code>7f2eafe</code></a></td><td><code>Disable depth-buffer write for text and transparent surfaces</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ec7cc0c3543267cd37ad6cf8505fcf30f2889d51"><code>ec7cc0c</code></a></td><td><code>Add option to disable depth-buffer write for surfaces</code></td></tr></table>




---

archive/issue_comments_508274.json:
```json
{
    "body": "Changed commit from **[`f52b0ad`](https://github.com/sagemath/sagetrac-mirror/commit/f52b0ad9946e9b1d47ec76fffe65717bd76ca524)** to **[`ec7cc0c`](https://github.com/sagemath/sagetrac-mirror/commit/ec7cc0c3543267cd37ad6cf8505fcf30f2889d51)**",
    "created_at": "2021-04-08T20:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508274",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f52b0ad`](https://github.com/sagemath/sagetrac-mirror/commit/f52b0ad9946e9b1d47ec76fffe65717bd76ca524)** to **[`ec7cc0c`](https://github.com/sagemath/sagetrac-mirror/commit/ec7cc0c3543267cd37ad6cf8505fcf30f2889d51)**



---

archive/issue_comments_508275.json:
```json
{
    "body": "Changed commit from **[`ec7cc0c`](https://github.com/sagemath/sagetrac-mirror/commit/ec7cc0c3543267cd37ad6cf8505fcf30f2889d51)** to **[`515bcf4`](https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7)**",
    "created_at": "2021-04-08T21:02:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508275",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`ec7cc0c`](https://github.com/sagemath/sagetrac-mirror/commit/ec7cc0c3543267cd37ad6cf8505fcf30f2889d51)** to **[`515bcf4`](https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7)**



---

archive/issue_comments_508276.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7\"><code>515bcf4</code></a></td><td><code>Update three.js viewer doc with depth_write option</code></td></tr></table>\n",
    "created_at": "2021-04-08T21:02:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508276",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7"><code>515bcf4</code></a></td><td><code>Update three.js viewer doc with depth_write option</code></td></tr></table>




---

archive/issue_comments_508277.json:
```json
{
    "body": "Author: **Joshua Campbell**",
    "created_at": "2021-04-08T21:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508277",
    "user": "https://github.com/jcamp0x2a"
}
```

Author: **Joshua Campbell**



---

archive/issue_events_432676.json:
```json
{
    "actor": "https://github.com/jcamp0x2a",
    "created_at": "2021-04-08T21:03:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432676"
}
```



---

archive/issue_comments_508278.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nI've added an option and documentation for controlling whether to do the depth-write for surfaces.",
    "created_at": "2021-04-08T21:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508278",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:13" align="right">comment:13</div>

I've added an option and documentation for controlling whether to do the depth-write for surfaces.



---

archive/issue_events_432677.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T06:21:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432677"
}
```



---

archive/issue_events_432678.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T06:21:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432678"
}
```



---

archive/issue_events_432679.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T06:25:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432679"
}
```



---

archive/issue_events_432680.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T06:25:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432680"
}
```



---

archive/issue_comments_508279.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nJust ran into this problem myself. This fixes it.",
    "created_at": "2021-04-15T06:25:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508279",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

Just ran into this problem myself. This fixes it.



---

archive/issue_comments_508280.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2021-04-15T06:25:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508280",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_events_432681.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T06:25:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432681"
}
```



---

archive/issue_events_432682.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T06:25:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432682"
}
```



---

archive/issue_events_432683.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-18T16:13:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432683"
}
```



---

archive/issue_events_432684.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-18T16:13:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432684"
}
```



---

archive/issue_events_432685.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-04-26T21:59:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432685"
}
```



---

archive/issue_events_432686.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "69db9b24f3b35b2d1e5f50788157f58e9bd8fdcb",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-04-26T21:59:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31600#event-432686"
}
```



---

archive/issue_comments_508281.json:
```json
{
    "body": "Changed branch from **[u/gh-jcamp0x2a/31600-transparency](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/31600-transparency)** to **[`515bcf4`](https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7)**",
    "created_at": "2021-04-26T21:59:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31600#issuecomment-508281",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/gh-jcamp0x2a/31600-transparency](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/31600-transparency)** to **[`515bcf4`](https://github.com/sagemath/sagetrac-mirror/commit/515bcf400723d186740db76a21d1613c1cf1ddf7)**
