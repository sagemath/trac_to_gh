# Issue 31632: tab-completion of cached_method in extension class crashes SageMath

archive/issues_031395.json:
```json
{
    "body": "Tab completion on the prefix of a `cached_method` of an extension class not in Sage source code provokes of crash. See https://gitlab.com/videlec/sage_tab_completion_bug to reproduce.\n\nThe bug was confirmed reproducibly on\n\n- archlinux sage 9.3.rc2\n- online cocalc with sage 9.2 \n\nThe bug is not present on\n\n- docker sage 8.8 and 9.1.rc2\n\n## Workaround\n\nCompile your Cython code with\n\n```\nimport Cython.Compiler.Options\nCython.Compiler.Options.embed_pos_in_docstring = True\n```\n\n## Tasks\n\n- #31643: about tab-completion accessing attributes\n- fix sage inspection module\n\nIssue created by migration from https://trac.sagemath.org/ticket/31632\n\n",
    "created_at": "2021-04-09T14:50:56Z",
    "labels": [
        "component: misc",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "tab-completion of cached_method in extension class crashes SageMath",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31632",
    "user": "https://github.com/videlec"
}
```
Tab completion on the prefix of a `cached_method` of an extension class not in Sage source code provokes of crash. See https://gitlab.com/videlec/sage_tab_completion_bug to reproduce.

The bug was confirmed reproducibly on

- archlinux sage 9.3.rc2
- online cocalc with sage 9.2 

The bug is not present on

- docker sage 8.8 and 9.1.rc2

## Workaround

Compile your Cython code with

```
import Cython.Compiler.Options
Cython.Compiler.Options.embed_pos_in_docstring = True
```

## Tasks

- #31643: about tab-completion accessing attributes
- fix sage inspection module

Issue created by migration from https://trac.sagemath.org/ticket/31632





---

archive/issue_comments_448583.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2021-04-09T15:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448583",
    "user": "https://github.com/videlec"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_448584.json:
```json
{
    "body": "<a id='comment:2'></a>This is already in 9.2 (reproduced following the instructions in the gitlab fork)\n\n```\n$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.2, Release Date: 2020-10-24                     \u2502\n\u2502 Create a \"Sage Worksheet\" file for the notebook interface.         \u2502\n\u2502 Enhanced for CoCalc.                                               \u2502\n\u2502 Using Python 3.8.5. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: sage: import example_cython \n....: sage: a = example_cython.A() \n....:                                                                                                                                                                                 \nsage: a.one                                                                                                                                                                           \n<built-in method one of example_cython.A object at 0x7ff9bdaceb60>\nsage: a.t                                                                                                                                                                             \n---------------------------------------------------------------------------\n---------------------------------------------------------------------------\nKeyError                 Python 3.8.5: /ext/sage/sage-9.2/local/bin/python3\n                                                   Fri Apr  9 15:07:38 2021\nA problem occurred executing Python code.  Here is the sequence of function\ncalls leading up to the error, with the most recent (innermost) call last.\n/ext/sage/sage-9.2/local/lib/python3.8/site-packages/jedi/cache.py in wrapper(self=<Completion: two>, *args=(), **kwargs={})\n    108         try:\n--> 109             return dct[key]\n        dct = {}\n        key = ((), frozenset())\n    110         except KeyError:\n\nKeyError: ((), frozenset())\n\nDuring handling of the above exception, another exception occurred:\n\n---------------------------------------------------------------------------\nKeyError                 Python 3.8.5: /ext/sage/sage-9.2/local/bin/python3\n                                                   Fri Apr  9 15:07:38 2021\nA problem occurred executing Python code.  Here is the sequence of function\ncalls leading up to the error, with the most recent (innermost) call last.\n/ext/sage/sage-9.2/local/lib/python3.8/site-packages/jedi/cache.py in wrapper(self=<CompiledValue: <sage.misc.cachefunc.CachedMethodCallerNoArgs obje..>, *args=(), **kwargs={})\n    108         try:\n--> 109             return dct[key]\n        dct = {}\n        key = ((), frozenset())\n    110         except KeyError:\n\nKeyError: ((), frozenset())\n...\n```",
    "created_at": "2021-04-09T15:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448584",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>This is already in 9.2 (reproduced following the instructions in the gitlab fork)

```
$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2, Release Date: 2020-10-24                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.8.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: sage: import example_cython 
....: sage: a = example_cython.A() 
....:                                                                                                                                                                                 
sage: a.one                                                                                                                                                                           
<built-in method one of example_cython.A object at 0x7ff9bdaceb60>
sage: a.t                                                                                                                                                                             
---------------------------------------------------------------------------
---------------------------------------------------------------------------
KeyError                 Python 3.8.5: /ext/sage/sage-9.2/local/bin/python3
                                                   Fri Apr  9 15:07:38 2021
A problem occurred executing Python code.  Here is the sequence of function
calls leading up to the error, with the most recent (innermost) call last.
/ext/sage/sage-9.2/local/lib/python3.8/site-packages/jedi/cache.py in wrapper(self=<Completion: two>, *args=(), **kwargs={})
    108         try:
--> 109             return dct[key]
        dct = {}
        key = ((), frozenset())
    110         except KeyError:

KeyError: ((), frozenset())

During handling of the above exception, another exception occurred:

---------------------------------------------------------------------------
KeyError                 Python 3.8.5: /ext/sage/sage-9.2/local/bin/python3
                                                   Fri Apr  9 15:07:38 2021
A problem occurred executing Python code.  Here is the sequence of function
calls leading up to the error, with the most recent (innermost) call last.
/ext/sage/sage-9.2/local/lib/python3.8/site-packages/jedi/cache.py in wrapper(self=<CompiledValue: <sage.misc.cachefunc.CachedMethodCallerNoArgs obje..>, *args=(), **kwargs={})
    108         try:
--> 109             return dct[key]
        dct = {}
        key = ((), frozenset())
    110         except KeyError:

KeyError: ((), frozenset())
...
```



---

archive/issue_comments_448585.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:2 dimpase]:\n> This is already in 9.2 (reproduced following the instructions in the gitlab fork)\n\n\nThanks for testing. I believe that it is a Python3 thing (in particular quite old).",
    "created_at": "2021-04-09T15:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448585",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>Replying to [comment:2 dimpase]:
> This is already in 9.2 (reproduced following the instructions in the gitlab fork)


Thanks for testing. I believe that it is a Python3 thing (in particular quite old).



---

archive/issue_comments_448586.json:
```json
{
    "body": "<a id='comment:8'></a>On conda (with sage 9.2) I get the error but no crash\n\n```\nTraceback (most recent call last):\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py\", line 110, in wrapper\n    return dct[key]\nKeyError: ((), frozenset())\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py\", line 110, in wrapper\n    return dct[key]\nKeyError: (('py__doc__',), frozenset())\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py\", line 2378, in sage_getsourcelines\n    return inspect.getsourcelines(obj)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 955, in getsourcelines\n    lines, lnum = findsource(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 768, in findsource\n    file = getsourcefile(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 684, in getsourcefile\n    filename = getfile(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 666, in getfile\n    type(object).__name__))\nTypeError: module, class, method, function, traceback, frame, or code object was expected, got method_descriptor\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py\", line 2378, in sage_getsourcelines\n    return inspect.getsourcelines(obj)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 955, in getsourcelines\n    lines, lnum = findsource(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 768, in findsource\n    file = getsourcefile(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 684, in getsourcefile\n    filename = getfile(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 653, in getfile\n    raise TypeError('{!r} is a built-in class'.format(object))\nTypeError: <class 'method_descriptor'> is a built-in class\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/terminal/ptutils.py\", line 115, in get_completions\n    yield from self._get_completions(body, offset, cursor_position, self.ipy_completer)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/terminal/ptutils.py\", line 131, in _get_completions\n    for c in completions:\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py\", line 438, in _deduplicate_completions\n    completions = list(completions)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py\", line 1827, in completions\n    for c in self._completions(text, offset, _timeout=self.jedi_compute_type_timeout/1000):\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py\", line 1884, in _completions\n    signature = _make_signature(jm)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py\", line 993, in _make_signature\n    signatures = completion.get_signatures()\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/api/classes.py\", line 576, in get_signatures\n    for s in self._get_signatures()\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/api/classes.py\", line 565, in _get_signatures\n    return [sig for name in names for sig in name.infer().get_signatures()]\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/api/classes.py\", line 565, in <listcomp>\n    return [sig for name in names for sig in name.infer().get_signatures()]\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/base_value.py\", line 512, in get_signatures\n    return [sig for c in self._set for sig in c.get_signatures()]\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/base_value.py\", line 512, in <listcomp>\n    return [sig for c in self._set for sig in c.get_signatures()]\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/value.py\", line 138, in get_signatures\n    _, return_string = self._parse_function_doc()\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py\", line 112, in wrapper\n    result = method(self, *args, **kwargs)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/value.py\", line 146, in _parse_function_doc\n    doc = self.py__doc__()\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/value.py\", line 116, in py__doc__\n    return self.access_handle.py__doc__()\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/subprocess/__init__.py\", line 386, in _workaround\n    return self._cached_results(name, *args, **kwargs)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py\", line 112, in wrapper\n    result = method(self, *args, **kwargs)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/subprocess/__init__.py\", line 390, in _cached_results\n    return self._subprocess.get_compiled_method_return(self.id, name, *args, **kwargs)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/subprocess/functions.py\", line 27, in get_compiled_method_return\n    return getattr(handle.access, attribute)(*args, **kwargs)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/access.py\", line 189, in py__doc__\n    return inspect.getdoc(self._obj) or ''\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 601, in getdoc\n    doc = object.__doc__\n  File \"sage/docs/instancedoc.pyx\", line 211, in sage.docs.instancedoc.InstanceDocDescriptor.__get__ (build/cythonized/sage/docs/instancedoc.c:1800)\n    return self.instancedoc(obj)\n  File \"sage/misc/cachefunc.pyx\", line 877, in sage.misc.cachefunc.CachedFunction._instancedoc_ (build/cythonized/sage/misc/cachefunc.c:5026)\n    sourcelines = sage_getsourcelines(f)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py\", line 2397, in sage_getsourcelines\n    return sage_getsourcelines(obj.__class__)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py\", line 2395, in sage_getsourcelines\n    return sage_getsourcelines(B)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py\", line 2398, in sage_getsourcelines\n    raise err\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py\", line 2378, in sage_getsourcelines\n    return inspect.getsourcelines(obj)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 955, in getsourcelines\n    lines, lnum = findsource(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 768, in findsource\n    file = getsourcefile(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 684, in getsourcefile\n    filename = getfile(object)\n  File \"/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py\", line 653, in getfile\n    raise TypeError('{!r} is a built-in class'.format(object))\nTypeError: <class 'object'> is a built-in class\n```",
    "created_at": "2021-04-09T15:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448586",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>On conda (with sage 9.2) I get the error but no crash

```
Traceback (most recent call last):
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py", line 110, in wrapper
    return dct[key]
KeyError: ((), frozenset())

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py", line 110, in wrapper
    return dct[key]
KeyError: (('py__doc__',), frozenset())

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py", line 2378, in sage_getsourcelines
    return inspect.getsourcelines(obj)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 955, in getsourcelines
    lines, lnum = findsource(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 768, in findsource
    file = getsourcefile(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 684, in getsourcefile
    filename = getfile(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 666, in getfile
    type(object).__name__))
TypeError: module, class, method, function, traceback, frame, or code object was expected, got method_descriptor

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py", line 2378, in sage_getsourcelines
    return inspect.getsourcelines(obj)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 955, in getsourcelines
    lines, lnum = findsource(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 768, in findsource
    file = getsourcefile(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 684, in getsourcefile
    filename = getfile(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 653, in getfile
    raise TypeError('{!r} is a built-in class'.format(object))
TypeError: <class 'method_descriptor'> is a built-in class

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/terminal/ptutils.py", line 115, in get_completions
    yield from self._get_completions(body, offset, cursor_position, self.ipy_completer)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/terminal/ptutils.py", line 131, in _get_completions
    for c in completions:
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py", line 438, in _deduplicate_completions
    completions = list(completions)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py", line 1827, in completions
    for c in self._completions(text, offset, _timeout=self.jedi_compute_type_timeout/1000):
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py", line 1884, in _completions
    signature = _make_signature(jm)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/IPython/core/completer.py", line 993, in _make_signature
    signatures = completion.get_signatures()
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/api/classes.py", line 576, in get_signatures
    for s in self._get_signatures()
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/api/classes.py", line 565, in _get_signatures
    return [sig for name in names for sig in name.infer().get_signatures()]
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/api/classes.py", line 565, in <listcomp>
    return [sig for name in names for sig in name.infer().get_signatures()]
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/base_value.py", line 512, in get_signatures
    return [sig for c in self._set for sig in c.get_signatures()]
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/base_value.py", line 512, in <listcomp>
    return [sig for c in self._set for sig in c.get_signatures()]
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/value.py", line 138, in get_signatures
    _, return_string = self._parse_function_doc()
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py", line 112, in wrapper
    result = method(self, *args, **kwargs)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/value.py", line 146, in _parse_function_doc
    doc = self.py__doc__()
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/value.py", line 116, in py__doc__
    return self.access_handle.py__doc__()
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/subprocess/__init__.py", line 386, in _workaround
    return self._cached_results(name, *args, **kwargs)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/cache.py", line 112, in wrapper
    result = method(self, *args, **kwargs)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/subprocess/__init__.py", line 390, in _cached_results
    return self._subprocess.get_compiled_method_return(self.id, name, *args, **kwargs)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/subprocess/functions.py", line 27, in get_compiled_method_return
    return getattr(handle.access, attribute)(*args, **kwargs)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/jedi/inference/compiled/access.py", line 189, in py__doc__
    return inspect.getdoc(self._obj) or ''
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 601, in getdoc
    doc = object.__doc__
  File "sage/docs/instancedoc.pyx", line 211, in sage.docs.instancedoc.InstanceDocDescriptor.__get__ (build/cythonized/sage/docs/instancedoc.c:1800)
    return self.instancedoc(obj)
  File "sage/misc/cachefunc.pyx", line 877, in sage.misc.cachefunc.CachedFunction._instancedoc_ (build/cythonized/sage/misc/cachefunc.c:5026)
    sourcelines = sage_getsourcelines(f)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py", line 2397, in sage_getsourcelines
    return sage_getsourcelines(obj.__class__)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py", line 2395, in sage_getsourcelines
    return sage_getsourcelines(B)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py", line 2398, in sage_getsourcelines
    raise err
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/site-packages/sage/misc/sageinspect.py", line 2378, in sage_getsourcelines
    return inspect.getsourcelines(obj)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 955, in getsourcelines
    lines, lnum = findsource(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 768, in findsource
    file = getsourcefile(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 684, in getsourcefile
    filename = getfile(object)
  File "/home/vincent/miniconda3/envs/flatsurvey/lib/python3.7/inspect.py", line 653, in getfile
    raise TypeError('{!r} is a built-in class'.format(object))
TypeError: <class 'object'> is a built-in class
```



---

archive/issue_comments_448587.json:
```json
{
    "body": "<a id='comment:11'></a>I have also had problems with `cached_method` in Cython code, in the past. As far as I recall, it is necessary to define a public `__cached_methods` attribute for them to work. I have quickly checked it on your example though and it did not seem to resolve the issue, so this may be a different problem.",
    "created_at": "2021-04-09T21:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448587",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:11'></a>I have also had problems with `cached_method` in Cython code, in the past. As far as I recall, it is necessary to define a public `__cached_methods` attribute for them to work. I have quickly checked it on your example though and it did not seem to resolve the issue, so this may be a different problem.



---

archive/issue_comments_448588.json:
```json
{
    "body": "<a id='comment:12'></a>You should in addition inherit from `SageObject`, when using `cached_method` (or at least try), but this also did not resolve the issue.",
    "created_at": "2021-04-10T07:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448588",
    "user": "https://github.com/kliem"
}
```

<a id='comment:12'></a>You should in addition inherit from `SageObject`, when using `cached_method` (or at least try), but this also did not resolve the issue.



---

archive/issue_comments_448589.json:
```json
{
    "body": "<a id='comment:13'></a>Indeed this seems to have appeared at some point recent.\n\nOn debian buster I can't reproduce it with sage 9.1, at least not the hard crash. The underlying problem to fetch `a.two.__doc__` is way older, but hasn't lead to a hard crash.\n\nThis seems to be related #31480 (which was a blocker, because as you noted hard crashes are annoying and it had a super easy fix). This tab completion hard crash also appeared with some ipython upgrade or so that happened recently.",
    "created_at": "2021-04-10T08:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448589",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>Indeed this seems to have appeared at some point recent.

On debian buster I can't reproduce it with sage 9.1, at least not the hard crash. The underlying problem to fetch `a.two.__doc__` is way older, but hasn't lead to a hard crash.

This seems to be related #31480 (which was a blocker, because as you noted hard crashes are annoying and it had a super easy fix). This tab completion hard crash also appeared with some ipython upgrade or so that happened recently.



---

archive/issue_comments_448590.json:
```json
{
    "body": "<a id='comment:14'></a>I think the mentioned workaround is also a possible solution. You cannot just cythonize a file and then except it to work completely nice with sage. It should be clear that you need to run a special cythonize function that enables the proper defaults for sage (e.g. cython aliases etc).\n\nHowever, I can't find such a function and I think sage should provide a customized `cythonize_for_sage` that sets the proper arguments (also we usually assume `cdivison=True` etc, I don't know if this is respected in your case either).\n\nOr at least provide the cythonize arguments somewhere...\n\nAm I making any sense? Anyway, I think this is out of scope for sage 9.3",
    "created_at": "2021-04-10T10:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448590",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'></a>I think the mentioned workaround is also a possible solution. You cannot just cythonize a file and then except it to work completely nice with sage. It should be clear that you need to run a special cythonize function that enables the proper defaults for sage (e.g. cython aliases etc).

However, I can't find such a function and I think sage should provide a customized `cythonize_for_sage` that sets the proper arguments (also we usually assume `cdivison=True` etc, I don't know if this is respected in your case either).

Or at least provide the cythonize arguments somewhere...

Am I making any sense? Anyway, I think this is out of scope for sage 9.3



---

archive/issue_comments_448591.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 gh-kliem]:\n> I think the mentioned workaround is also a possible solution. You cannot just cythonize a file and then except it to work completely nice with sage. It should be clear that you need to run a special cythonize function that enables the proper defaults for sage (e.g. cython aliases etc).\n> \n> However, I can't find such a function and I think sage should provide a customized `cythonize_for_sage` that sets the proper arguments (also we usually assume `cdivison=True` etc, I don't know if this is respected in your case either).\n> \n> Or at least provide the cythonize arguments somewhere...\n> \n> Am I making any sense? Anyway, I think this is out of scope for sage 9.3\n\n\nI see at least three problems:\n\n- Access to the documentation should not trigger the access the source code. The `CachedFunction._instancedoc_` makes a call to `sage_getsourcelines` if the line in the source code is not available. This is exactly what the workaround in the ticket description provides.\n\n- Accessing the documentation/source should never result in a crash\n\n- Why on earth tab-completion have anything to do with access to the documentation?\n\nI believe there is work to be done on different fronts: the `sageinspect` module, the `CachedFunction._instancedoc_` and understand how the tab-completion works.",
    "created_at": "2021-04-10T11:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448591",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:14 gh-kliem]:
> I think the mentioned workaround is also a possible solution. You cannot just cythonize a file and then except it to work completely nice with sage. It should be clear that you need to run a special cythonize function that enables the proper defaults for sage (e.g. cython aliases etc).
> 
> However, I can't find such a function and I think sage should provide a customized `cythonize_for_sage` that sets the proper arguments (also we usually assume `cdivison=True` etc, I don't know if this is respected in your case either).
> 
> Or at least provide the cythonize arguments somewhere...
> 
> Am I making any sense? Anyway, I think this is out of scope for sage 9.3


I see at least three problems:

- Access to the documentation should not trigger the access the source code. The `CachedFunction._instancedoc_` makes a call to `sage_getsourcelines` if the line in the source code is not available. This is exactly what the workaround in the ticket description provides.

- Accessing the documentation/source should never result in a crash

- Why on earth tab-completion have anything to do with access to the documentation?

I believe there is work to be done on different fronts: the `sageinspect` module, the `CachedFunction._instancedoc_` and understand how the tab-completion works.



---

archive/issue_comments_448592.json:
```json
{
    "body": "<a id='comment:16'></a>Ok, yes, I agree with you.\n\n- Sage crashing is very unfortunate behavior and it definitely shouldn't happen because some trivial python error occurs.\n- #31480 only fixed the symptoms. The point above applies there as well. But also tab completion should not even trigger loading lazy imports (unless your actually tab completing within the lazy imported thing and then of course it needs to grep the signature via the `inspect` module and maybe this needs to access source or something like this).\n\nTo verify that tab completion is doing too much one can do the following:\n\nStart sage fresh\n\n```\nsage: type(polytopes._object)\n<class 'NoneType'>\n```\nHit tab after `pol`. `polytopes` isn't even your first guess, but it's on the list. Now repeat:\n\n```\nsage: type(polytopes._object)\n<class 'sage.geometry.polyhedron.library.Polytopes'>\n```\nSo tab completion does not work well with lazy imports at all.",
    "created_at": "2021-04-10T18:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448592",
    "user": "https://github.com/kliem"
}
```

<a id='comment:16'></a>Ok, yes, I agree with you.

- Sage crashing is very unfortunate behavior and it definitely shouldn't happen because some trivial python error occurs.
- #31480 only fixed the symptoms. The point above applies there as well. But also tab completion should not even trigger loading lazy imports (unless your actually tab completing within the lazy imported thing and then of course it needs to grep the signature via the `inspect` module and maybe this needs to access source or something like this).

To verify that tab completion is doing too much one can do the following:

Start sage fresh

```
sage: type(polytopes._object)
<class 'NoneType'>
```
Hit tab after `pol`. `polytopes` isn't even your first guess, but it's on the list. Now repeat:

```
sage: type(polytopes._object)
<class 'sage.geometry.polyhedron.library.Polytopes'>
```
So tab completion does not work well with lazy imports at all.



---

archive/issue_comments_448593.json:
```json
{
    "body": "<a id='comment:17'></a>Certainly unrelated: On my machine, when I do a copy/paste of a sage prompt line I also get a bunch of white spaces in the buffer. The same happened in your examples from [comment:16] (I removed the spaces manually). This behavior was not there before.",
    "created_at": "2021-04-10T18:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448593",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>Certainly unrelated: On my machine, when I do a copy/paste of a sage prompt line I also get a bunch of white spaces in the buffer. The same happened in your examples from [comment:16] (I removed the spaces manually). This behavior was not there before.



---

archive/issue_comments_448594.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 gh-kliem]:\n> To verify that tab completion is doing too much one can do the following:\n> \n> Start sage fresh\n> \n> ```\n> sage: type(polytopes._object)\n> <class 'NoneType'>\n> ```\n> Hit tab after `pol`. `polytopes` isn't even your first guess, but it's on the list. Now repeat:\n> \n> ```\n> sage: type(polytopes._object)\n> <class 'sage.geometry.polyhedron.library.Polytopes'>\n> ```\n> So tab completion does not work well with lazy imports at all.\n\n\nFor me it is even stranger: before the tab and and after the first I still get `None`. Only on the second run it gets lazily imported.",
    "created_at": "2021-04-10T19:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448594",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>Replying to [comment:16 gh-kliem]:
> To verify that tab completion is doing too much one can do the following:
> 
> Start sage fresh
> 
> ```
> sage: type(polytopes._object)
> <class 'NoneType'>
> ```
> Hit tab after `pol`. `polytopes` isn't even your first guess, but it's on the list. Now repeat:
> 
> ```
> sage: type(polytopes._object)
> <class 'sage.geometry.polyhedron.library.Polytopes'>
> ```
> So tab completion does not work well with lazy imports at all.


For me it is even stranger: before the tab and and after the first I still get `None`. Only on the second run it gets lazily imported.



---

archive/issue_comments_448595.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 vdelecroix]:\n> Replying to [comment:16 gh-kliem]:\n> > To verify that tab completion is doing too much one can do the following:\n> > \n> > Start sage fresh\n> > \n> > ```\n> > sage: type(polytopes._object)\n> > <class 'NoneType'>\n> > ```\n> > Hit tab after `pol`. `polytopes` isn't even your first guess, but it's on the list. Now repeat:\n> > \n> > ```\n> > sage: type(polytopes._object)\n> > <class 'sage.geometry.polyhedron.library.Polytopes'>\n> > ```\n> > So tab completion does not work well with lazy imports at all.\n\n> \n> For me it is even stranger: before the tab and and after the first I still get `None`. Only on the second run it gets lazily imported.\n\n\nYes, you are right. I got this wrong. If you tab complete `p` twice, then everythings neatly lazy imported that starts with a `p` is being imported.",
    "created_at": "2021-04-10T19:05:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448595",
    "user": "https://github.com/kliem"
}
```

<a id='comment:19'></a>Replying to [comment:18 vdelecroix]:
> Replying to [comment:16 gh-kliem]:
> > To verify that tab completion is doing too much one can do the following:
> > 
> > Start sage fresh
> > 
> > ```
> > sage: type(polytopes._object)
> > <class 'NoneType'>
> > ```
> > Hit tab after `pol`. `polytopes` isn't even your first guess, but it's on the list. Now repeat:
> > 
> > ```
> > sage: type(polytopes._object)
> > <class 'sage.geometry.polyhedron.library.Polytopes'>
> > ```
> > So tab completion does not work well with lazy imports at all.

> 
> For me it is even stranger: before the tab and and after the first I still get `None`. Only on the second run it gets lazily imported.


Yes, you are right. I got this wrong. If you tab complete `p` twice, then everythings neatly lazy imported that starts with a `p` is being imported.



---

archive/issue_comments_448596.json:
```json
{
    "body": "<a id='comment:20'></a>Note that tab completion runs in a separate thread, which previously caused trouble in #22704",
    "created_at": "2021-04-10T19:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448596",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Note that tab completion runs in a separate thread, which previously caused trouble in #22704



---

archive/issue_comments_448597.json:
```json
{
    "body": "<a id='comment:21'></a>Not reproducible with\n\n```\nfrom IPython import get_ipython\n\nip = get_ipython()\nc = ip.Completer\nip.ex(\"from sage.all import *\")\nfor _ in range(4):\n    print(c.all_completions(\"pol\"))\n    print(ip.ex('type(polytopes._object)'))\n```\nwhich prints four times\n\n```\n['polar_plot', 'polygen', 'polygens', 'polygon', 'polygon2d', 'polygon3d', 'polygon_spline', 'polygonal_number', 'polygons3d', 'polylog', 'polymake', 'polytopes']\nNone\n```",
    "created_at": "2021-04-10T19:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448597",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>Not reproducible with

```
from IPython import get_ipython

ip = get_ipython()
c = ip.Completer
ip.ex("from sage.all import *")
for _ in range(4):
    print(c.all_completions("pol"))
    print(ip.ex('type(polytopes._object)'))
```
which prints four times

```
['polar_plot', 'polygen', 'polygens', 'polygon', 'polygon2d', 'polygon3d', 'polygon_spline', 'polygonal_number', 'polygons3d', 'polylog', 'polymake', 'polytopes']
None
```



---

archive/issue_comments_448598.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 mkoeppe]:\n> Note that tab completion runs in a separate thread, which previously caused trouble in #22704\n\n\nAh, this probably explains, why it takes two times, until you see the effect.\n\nYou do this effect immediatly in memory usage. Tab completion of `h` takes something around 70 MB of memory. How stupid is that.\n\nAlso tab completion of `l` gives:\n\n```\nsage: l// Giac share root-directory:/home/jonathan/Applications/sage/local/share/giac/\n// Giac share root-directory:/home/jonathan/Applications/sage/local/share/giac/\nHelp file /home/jonathan/Applications/sage/local/share/giac/doc/fr/aide_cas not found\nAdded 0 synonyms\n```\n\nAnd tab completion twice `s` has sage crash hard again. The essense of it being\n\n```\nAttributeError: module 'sage.coding.linear_code' has no attribute 'self_orthogonal_binary_codes'\n```\nbecause it is incorrectly lazily imported in `src/sage/coding/all.py`. Implying three things for me:\n- Again, sage should not crash hard because of such a silly thing.\n- We should have a doctest somewhere that unrolls all lazy imports, just to make sure that they actually work. Apparently this is not being tested.\n- Of course it should be fixed in `src/sage/coding/all.py`.",
    "created_at": "2021-04-10T19:24:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448598",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>Replying to [comment:20 mkoeppe]:
> Note that tab completion runs in a separate thread, which previously caused trouble in #22704


Ah, this probably explains, why it takes two times, until you see the effect.

You do this effect immediatly in memory usage. Tab completion of `h` takes something around 70 MB of memory. How stupid is that.

Also tab completion of `l` gives:

```
sage: l// Giac share root-directory:/home/jonathan/Applications/sage/local/share/giac/
// Giac share root-directory:/home/jonathan/Applications/sage/local/share/giac/
Help file /home/jonathan/Applications/sage/local/share/giac/doc/fr/aide_cas not found
Added 0 synonyms
```

And tab completion twice `s` has sage crash hard again. The essense of it being

```
AttributeError: module 'sage.coding.linear_code' has no attribute 'self_orthogonal_binary_codes'
```
because it is incorrectly lazily imported in `src/sage/coding/all.py`. Implying three things for me:
- Again, sage should not crash hard because of such a silly thing.
- We should have a doctest somewhere that unrolls all lazy imports, just to make sure that they actually work. Apparently this is not being tested.
- Of course it should be fixed in `src/sage/coding/all.py`.



---

archive/issue_comments_448599.json:
```json
{
    "body": "<a id='comment:23'></a>In the first place, tab completion should not trigger the lazy imports... Why is it doing so?",
    "created_at": "2021-04-10T19:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448599",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>In the first place, tab completion should not trigger the lazy imports... Why is it doing so?



---

archive/issue_comments_448600.json:
```json
{
    "body": "<a id='comment:24'></a>I mentioned this above and agree. I don't know. For the moment (and all I'll do today), I just remarked that this is clearly wrong.\n\nIf you autocomplete within a lazy imported thing as in `polytopes.cube(int` (because you are too lazy to type the argument `intervals`), you need to fetch the signature, which will probably trigger an import. However, just an import of that one class is justified. Otherwise it should not trigger any import (it only needs the names after all).",
    "created_at": "2021-04-10T19:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448600",
    "user": "https://github.com/kliem"
}
```

<a id='comment:24'></a>I mentioned this above and agree. I don't know. For the moment (and all I'll do today), I just remarked that this is clearly wrong.

If you autocomplete within a lazy imported thing as in `polytopes.cube(int` (because you are too lazy to type the argument `intervals`), you need to fetch the signature, which will probably trigger an import. However, just an import of that one class is justified. Otherwise it should not trigger any import (it only needs the names after all).



---

archive/issue_comments_448601.json:
```json
{
    "body": "<a id='comment:25'></a>Concerning lazy imports, I think I got it. Since some recent Python3 versions, objects could be wrapped and in such case the object implements `__wrapped__` (this is for example the case with some decorators in functools). Ipython tries to be smart with this with respect to tab completion and hence check for `__wrapped__`. Doing this on a `lazy_import` will trigger the import.",
    "created_at": "2021-04-10T19:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448601",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>Concerning lazy imports, I think I got it. Since some recent Python3 versions, objects could be wrapped and in such case the object implements `__wrapped__` (this is for example the case with some decorators in functools). Ipython tries to be smart with this with respect to tab completion and hence check for `__wrapped__`. Doing this on a `lazy_import` will trigger the import.



---

archive/issue_comments_448602.json:
```json
{
    "body": "<a id='comment:26'></a>Nope. That could not explain...",
    "created_at": "2021-04-10T19:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448602",
    "user": "https://github.com/videlec"
}
```

<a id='comment:26'></a>Nope. That could not explain...



---

archive/issue_comments_448603.json:
```json
{
    "body": "<a id='comment:27'></a>With\n\n```diff\ndiff --git a/src/sage/misc/lazy_import.pyx b/src/sage/misc/lazy_import.pyx\nindex 336567e22c..49abc0b849 100644\n--- a/src/sage/misc/lazy_import.pyx\n+++ b/src/sage/misc/lazy_import.pyx\n@@ -325,6 +325,7 @@ cdef class LazyImport(object):\n             sage: my_integer.sqrt is Integer.sqrt\n             True\n         \"\"\"\n+        print('getattr(attr={}) of self={}'.format(attr, self))\n         return getattr(self.get_object(), attr)\n \n     # We need to wrap all the slot methods, as they are not forwarded\n```\nyou can have a look at what is asked to your `lazy_import` objects.\n\nHere is what I got (up to desynchronization)\n\n```\ngetattr(attr=Algebras) of self=<class 'sage.categories.groups.Groups'>\ngetattr(attr=Finite) of self=<class 'sage.categories.groups.Groups'>\ngetattr(attr=Finite) of self=<class 'sage.categories.groups.Groups'>\nsage: pol<TAB>\ngetattr(attr=__module__) of self=<built-in function polygon_spline>\ngetattr(attr=__module__) of self=<built-in function polygon_spline>\ngetattr(attr=__module__) of self=<built-in function polygon_spline>\ngetattr(attr=__dict__) of self=<built-in function polygon_spline>\ngetattr(attr=__wrapped__) of self=<built-in function polygon_spline>\ngetattr(attr=__signature__) of self=<built-in function polygon_spline>\ngetattr(attr=_partialmethod) of self=<built-in function polygon_spline>\ngetattr(attr=__name__) of self=<built-in function polygon_spline>\ngetattr(attr=__code__) of self=<built-in function polygon_spline>\ngetattr(attr=__defaults__) of self=<built-in function polygon_spline>\ngetattr(attr=__kwdefaults__) of self=<built-in function polygon_spline>\ngetattr(attr=__annotations__) of self=<built-in function polygon_spline>\ngetattr(attr=__text_signature__) of self=<built-in function polygon_spline>\ngetattr(attr=__module__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__module__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__module__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__dict__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__wrapped__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__signature__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=_partialmethod) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__name__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__code__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__defaults__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__kwdefaults__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__annotations__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\ngetattr(attr=__text_signature__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>\n```\n\nThe three `getattr(attr=XXX) of self=<class 'sage.categories.groups.Groups'>` are definitely unrelated but worth looking at since they should not be there! I thought that resolution of lazy import was forbidden on startup.",
    "created_at": "2021-04-10T19:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448603",
    "user": "https://github.com/videlec"
}
```

<a id='comment:27'></a>With

```diff
diff --git a/src/sage/misc/lazy_import.pyx b/src/sage/misc/lazy_import.pyx
index 336567e22c..49abc0b849 100644
--- a/src/sage/misc/lazy_import.pyx
+++ b/src/sage/misc/lazy_import.pyx
@@ -325,6 +325,7 @@ cdef class LazyImport(object):
             sage: my_integer.sqrt is Integer.sqrt
             True
         """
+        print('getattr(attr={}) of self={}'.format(attr, self))
         return getattr(self.get_object(), attr)
 
     # We need to wrap all the slot methods, as they are not forwarded
```
you can have a look at what is asked to your `lazy_import` objects.

Here is what I got (up to desynchronization)

```
getattr(attr=Algebras) of self=<class 'sage.categories.groups.Groups'>
getattr(attr=Finite) of self=<class 'sage.categories.groups.Groups'>
getattr(attr=Finite) of self=<class 'sage.categories.groups.Groups'>
sage: pol<TAB>
getattr(attr=__module__) of self=<built-in function polygon_spline>
getattr(attr=__module__) of self=<built-in function polygon_spline>
getattr(attr=__module__) of self=<built-in function polygon_spline>
getattr(attr=__dict__) of self=<built-in function polygon_spline>
getattr(attr=__wrapped__) of self=<built-in function polygon_spline>
getattr(attr=__signature__) of self=<built-in function polygon_spline>
getattr(attr=_partialmethod) of self=<built-in function polygon_spline>
getattr(attr=__name__) of self=<built-in function polygon_spline>
getattr(attr=__code__) of self=<built-in function polygon_spline>
getattr(attr=__defaults__) of self=<built-in function polygon_spline>
getattr(attr=__kwdefaults__) of self=<built-in function polygon_spline>
getattr(attr=__annotations__) of self=<built-in function polygon_spline>
getattr(attr=__text_signature__) of self=<built-in function polygon_spline>
getattr(attr=__module__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__module__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__module__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__dict__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__wrapped__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__signature__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=_partialmethod) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__name__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__code__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__defaults__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__kwdefaults__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__annotations__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
getattr(attr=__text_signature__) of self=<sage.geometry.polyhedron.library.Polytopes object at 0x7f21a0b12e20>
```

The three `getattr(attr=XXX) of self=<class 'sage.categories.groups.Groups'>` are definitely unrelated but worth looking at since they should not be there! I thought that resolution of lazy import was forbidden on startup.



---

archive/issue_comments_448604.json:
```json
{
    "body": "<a id='comment:28'></a>All right, it has to do with extension class. My [comment:25] was looking in the good direction: IPython does call stuff on the object *in some cases*.\n\n```\nsage: cython(\"\"\"\n....: cdef class A(object):\n....:     def __getattr__(self, key):\n....:         print('getattr(key={})'.format(key))\n....:         raise AttributeError\n....: \"\"\")\nsage: a = A()\nsage: my_custom_name = A()\nsage: from IPython import get_ipython                                                                                                                                                          \nsage: ip = get_ipython()                                                                                                                                                                       \nsage: ip.Completer.all_completions(\"my_custo\")                                                                                                                                                 \ngetattr(key=__module__)\ngetattr(key=__module__)\n['my_custom_name']\n```",
    "created_at": "2021-04-10T19:59:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448604",
    "user": "https://github.com/videlec"
}
```

<a id='comment:28'></a>All right, it has to do with extension class. My [comment:25] was looking in the good direction: IPython does call stuff on the object *in some cases*.

```
sage: cython("""
....: cdef class A(object):
....:     def __getattr__(self, key):
....:         print('getattr(key={})'.format(key))
....:         raise AttributeError
....: """)
sage: a = A()
sage: my_custom_name = A()
sage: from IPython import get_ipython                                                                                                                                                          
sage: ip = get_ipython()                                                                                                                                                                       
sage: ip.Completer.all_completions("my_custo")                                                                                                                                                 
getattr(key=__module__)
getattr(key=__module__)
['my_custom_name']
```



---

archive/issue_comments_448605.json:
```json
{
    "body": "<a id='comment:29'></a>Tab completion is now #31643",
    "created_at": "2021-04-10T20:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31632#issuecomment-448605",
    "user": "https://github.com/videlec"
}
```

<a id='comment:29'></a>Tab completion is now #31643



---

archive/issue_events_083286.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-18T16:17:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83286"
}
```



---

archive/issue_events_083287.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83287"
}
```



---

archive/issue_events_083288.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83288"
}
```



---

archive/issue_events_083289.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83289"
}
```



---

archive/issue_events_083290.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83290"
}
```



---

archive/issue_events_083291.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83291"
}
```



---

archive/issue_events_083292.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83292"
}
```



---

archive/issue_events_083293.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83293"
}
```



---

archive/issue_events_083294.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31632",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31632#event-83294"
}
```
