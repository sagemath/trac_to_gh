# Issue 31007: Bad numerical matrix inversion with Ubuntu 18.04, gcc 7.5, and a Xeon Skylake-W processor

archive/issues_030770.json:
```json
{
    "body": "I built Sage 9.2 from source on Ubuntu 18.04 with gcc 7.5 in a Docker container running on an iMac Pro with a Xeon W-2150B processor (Skylake-W).  Inversion of CDF matrices gives bad answers, which I traced down to scipy and finally to OpenBLAS 0.3.9. Attached is a simple script that takes an 18 x 18 matrix of complex numbers, \"inverts\" it, multiplies by the original, and compares to the identity.  The expected behavior is:\n\n```\nsage -python inverse_prob.py\n6e-15 # or similar \n```\n\nbut on the system in question I get a wildly wrong answer:\n\n```\n28.453890763868475\n```\n\nThe OpenBLAS library was built with Haswell as the target, as its file name is:\n\n```\nlibopenblas_haswellp-r0.3.9.so\n```\n\nCopying a version OpenBLAS built on Sandy Bridge hardware fixes the problem.  On the same physical hardware with the Xeon W-2150B processor, the problem does **not** manifest itself in:\n\na) macOS 10.15, Python 3.8, scipy 1.5.2 \n\nb) Debian Sid, with official [SageMath](SageMath) 9.2 package.\n\nc) Ubuntu 18.04 and 20.04, with the python3-scipy package.\n\nd) Latest Anaconda Docker image.\n\nThe failing Docker image in question has been posted as `computop/sage:9.2a1`.\n\nPossibly related to #27961.\n\n\nCC:  @jhpalmieri @vbraun @mkoeppe @embray\n\nBranch: [u/mkoeppe/bad_numerical_matrix_inversion_with_ubuntu_18_04__gcc_7_5__and_a_xeon_skylake_w_processor](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/bad_numerical_matrix_inversion_with_ubuntu_18_04__gcc_7_5__and_a_xeon_skylake_w_processor)\n\nCommit: [2cc103fd1844218319ec5d4310785a8a87c2f06c](https://github.com/sagemath/sagetrac-mirror/commit/2cc103fd1844218319ec5d4310785a8a87c2f06c)\n\nReviewer: Nathan Dunfield, Markus Wageringel\n\nResolution: duplicate\n\nIssue created by migration from https://trac.sagemath.org/ticket/31007\n\n",
    "closed_at": "2021-03-08T13:34:39Z",
    "created_at": "2020-12-04T19:00:08Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Bad numerical matrix inversion with Ubuntu 18.04, gcc 7.5, and a Xeon Skylake-W processor",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31007",
    "user": "https://github.com/NathanDunfield"
}
```
I built Sage 9.2 from source on Ubuntu 18.04 with gcc 7.5 in a Docker container running on an iMac Pro with a Xeon W-2150B processor (Skylake-W).  Inversion of CDF matrices gives bad answers, which I traced down to scipy and finally to OpenBLAS 0.3.9. Attached is a simple script that takes an 18 x 18 matrix of complex numbers, "inverts" it, multiplies by the original, and compares to the identity.  The expected behavior is:

```
sage -python inverse_prob.py
6e-15 # or similar 
```

but on the system in question I get a wildly wrong answer:

```
28.453890763868475
```

The OpenBLAS library was built with Haswell as the target, as its file name is:

```
libopenblas_haswellp-r0.3.9.so
```

Copying a version OpenBLAS built on Sandy Bridge hardware fixes the problem.  On the same physical hardware with the Xeon W-2150B processor, the problem does **not** manifest itself in:

a) macOS 10.15, Python 3.8, scipy 1.5.2 

b) Debian Sid, with official [SageMath](SageMath) 9.2 package.

c) Ubuntu 18.04 and 20.04, with the python3-scipy package.

d) Latest Anaconda Docker image.

The failing Docker image in question has been posted as `computop/sage:9.2a1`.

Possibly related to #27961.


CC:  @jhpalmieri @vbraun @mkoeppe @embray

Branch: [u/mkoeppe/bad_numerical_matrix_inversion_with_ubuntu_18_04__gcc_7_5__and_a_xeon_skylake_w_processor](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/bad_numerical_matrix_inversion_with_ubuntu_18_04__gcc_7_5__and_a_xeon_skylake_w_processor)

Commit: [2cc103fd1844218319ec5d4310785a8a87c2f06c](https://github.com/sagemath/sagetrac-mirror/commit/2cc103fd1844218319ec5d4310785a8a87c2f06c)

Reviewer: Nathan Dunfield, Markus Wageringel

Resolution: duplicate

Issue created by migration from https://trac.sagemath.org/ticket/31007





---

archive/issue_comments_615796.json:
```json
{
    "body": "Attachment [inverse_prob.py](tarball://root/attachments/some-uuid/ticket31007/inverse_prob.py) by @NathanDunfield created at 2020-12-04 19:00:30",
    "created_at": "2020-12-04T19:00:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615796",
    "user": "https://github.com/NathanDunfield"
}
```

Attachment [inverse_prob.py](tarball://root/attachments/some-uuid/ticket31007/inverse_prob.py) by @NathanDunfield created at 2020-12-04 19:00:30



---

archive/issue_comments_615797.json:
```json
{
    "body": "<a id='comment:3'></a>\nI have confirmed that this issue is fixed in the upstream repo:\n\n```\ngit clone https://github.com/xianyi/OpenBLAS/\ncd OpenBLAS\nmake NO_AVX512=1  # Sage already adds this option, see #27961\nmake PREFIX=/sage/local install\n```\nHowever, the problem is present even in the most recent official release of 0.3.12.",
    "created_at": "2020-12-05T01:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615797",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:3'></a>
I have confirmed that this issue is fixed in the upstream repo:

```
git clone https://github.com/xianyi/OpenBLAS/
cd OpenBLAS
make NO_AVX512=1  # Sage already adds this option, see #27961
make PREFIX=/sage/local install
```
However, the problem is present even in the most recent official release of 0.3.12.



---

archive/issue_comments_615798.json:
```json
{
    "body": "<a id='comment:4'></a>\nIs there a particular commit that we can apply as a patch?",
    "created_at": "2020-12-05T18:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615798",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Is there a particular commit that we can apply as a patch?



---

archive/issue_comments_615799.json:
```json
{
    "body": "Attachment [avx2.patch](tarball://root/attachments/some-uuid/ticket31007/avx2.patch) by @NathanDunfield created at 2020-12-05 22:07:09",
    "created_at": "2020-12-05T22:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615799",
    "user": "https://github.com/NathanDunfield"
}
```

Attachment [avx2.patch](tarball://root/attachments/some-uuid/ticket31007/avx2.patch) by @NathanDunfield created at 2020-12-05 22:07:09



---

archive/issue_comments_615800.json:
```json
{
    "body": "<a id='comment:5'></a>\nBy bisecting, I determined that it is the commit [fix avx2 detection](https://github.com/xianyi/OpenBLAS/commit/aa21cb52179b) which fixes the problem.  It is possible to apply this as a patch to our current OpenBLAS 0.3.9, see attachment, and this does resolve the issue on my system.\n\nThe underlying issue seems to be [this](https://github.com/xianyi/OpenBLAS/issues/2957), where OpenBLAS is incorrectly identifying my processor as lacking AVX2, even though it has it.  I don't exactly understand how this causes the observed behavior; if I add NO_AVX2=1 the `make` args the everything works fine (this is equivalent to compiling for Sandy Bridge).  However, clearly applying the patch would be an improvement.",
    "created_at": "2020-12-05T22:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615800",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:5'></a>
By bisecting, I determined that it is the commit [fix avx2 detection](https://github.com/xianyi/OpenBLAS/commit/aa21cb52179b) which fixes the problem.  It is possible to apply this as a patch to our current OpenBLAS 0.3.9, see attachment, and this does resolve the issue on my system.

The underlying issue seems to be [this](https://github.com/xianyi/OpenBLAS/issues/2957), where OpenBLAS is incorrectly identifying my processor as lacking AVX2, even though it has it.  I don't exactly understand how this causes the observed behavior; if I add NO_AVX2=1 the `make` args the everything works fine (this is equivalent to compiling for Sandy Bridge).  However, clearly applying the patch would be an improvement.



---

archive/issue_comments_615801.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/bad_numerical_matrix_inversion_with_ubuntu_18_04__gcc_7_5__and_a_xeon_skylake_w_processor\"",
    "created_at": "2020-12-06T00:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615801",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/bad_numerical_matrix_inversion_with_ubuntu_18_04__gcc_7_5__and_a_xeon_skylake_w_processor"



---

archive/issue_comments_615802.json:
```json
{
    "body": "Changing commit from \"\" to \"2cc103fd1844218319ec5d4310785a8a87c2f06c\"",
    "created_at": "2020-12-06T00:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615802",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "2cc103fd1844218319ec5d4310785a8a87c2f06c"



---

archive/issue_comments_615803.json:
```json
{
    "body": "<a id='comment:7'></a>\nNew commits:\n|                                                                                                                                          |                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|\n|[2cc103f](https://github.com/sagemath/sagetrac-mirror/commit/2cc103fd1844218319ec5d4310785a8a87c2f06c)|`build/pkgs/openblas/patches: Add avx2.patch`|",
    "created_at": "2020-12-06T00:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615803",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
New commits:
|                                                                                                                                          |                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|
|[2cc103f](https://github.com/sagemath/sagetrac-mirror/commit/2cc103fd1844218319ec5d4310785a8a87c2f06c)|`build/pkgs/openblas/patches: Add avx2.patch`|



---

archive/issue_comments_615804.json:
```json
{
    "body": "Changing author from \"\" to \"Nathan Dunfield\"",
    "created_at": "2020-12-06T00:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615804",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Nathan Dunfield"



---

archive/issue_comments_615805.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-06T00:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615805",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_615806.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis does not seem to be relevant anymore, as the fix is included in Openblas 0.3.13, which is contained in Sage since 9.3.beta6.",
    "created_at": "2021-02-17T20:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615806",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:8'></a>
This does not seem to be relevant anymore, as the fix is included in Openblas 0.3.13, which is contained in Sage since 9.3.beta6.



---

archive/issue_comments_615807.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [gh-mwageringel](#comment%3A8):\n> This does not seem to be relevant anymore, as the fix is included in Openblas 0.3.13, which is contained in Sage since 9.3.beta6.\n\n\nYes, I agree this was fixed by #29913 (Upgrade OpenBLAS to 0.3.13).  What is the correct way to close this ticket in this situation?",
    "created_at": "2021-02-17T20:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615807",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:9'></a>
Replying to [gh-mwageringel](#comment%3A8):
> This does not seem to be relevant anymore, as the fix is included in Openblas 0.3.13, which is contained in Sage since 9.3.beta6.


Yes, I agree this was fixed by #29913 (Upgrade OpenBLAS to 0.3.13).  What is the correct way to close this ticket in this situation?



---

archive/issue_comments_615808.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-18T20:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615808",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_091226.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2021-02-18T20:14:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31007#event-91226"
}
```



---

archive/issue_comments_615809.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [dunfield](#comment%3A9):\n> What is the correct way to close this ticket in this situation?\n\n\nThanks for the confirmation. We can set the milestone to duplicate and give a positive review.",
    "created_at": "2021-02-18T20:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615809",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:10'></a>
Replying to [dunfield](#comment%3A9):
> What is the correct way to close this ticket in this situation?


Thanks for the confirmation. We can set the milestone to duplicate and give a positive review.



---

archive/issue_comments_615810.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Nathan Dunfield, Markus Wageringel\"",
    "created_at": "2021-02-18T20:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615810",
    "user": "https://github.com/mwageringel"
}
```

Changing reviewer from "" to "Nathan Dunfield, Markus Wageringel"



---

archive/issue_comments_615811.json:
```json
{
    "body": "Changing author from \"Nathan Dunfield\" to \"\"",
    "created_at": "2021-02-18T20:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615811",
    "user": "https://github.com/mwageringel"
}
```

Changing author from "Nathan Dunfield" to ""



---

archive/issue_comments_615812.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2021-03-08T13:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31007#issuecomment-615812",
    "user": "https://github.com/fchapoton"
}
```

Resolution: duplicate



---

archive/issue_events_091227.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2021-03-08T13:34:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31007",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31007#event-91227"
}
```
