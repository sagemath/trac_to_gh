# Issue 31650: improve LazyImport

archive/issues_031413.json:
```json
{
    "body": "The `LazyImport` objects suffer several problems\n\n1. `copy` and `deepcopy` are broken\n\n```\nsage: from sage.misc.lazy_import import LazyImport\nsage: sage.all.foo = [1, 2]\nsage: lazy_foo = LazyImport('sage.all', 'foo')\nsage: a = copy(lazy_foo)\nsage: a\n[1, 2]\nsage: a[0] = 18\nsage: lazy_foo\n[18, 2]\n```\n\n2. Most doctests use `lazy_import` rather than `LazyImport`. The former modifies the namespace so that the name actually points to the object afterwards. Compare\n\n```\nsage: lazy_import('sage.rings.all', 'ZZ', 'lazy_ZZ')\nsage: type(lazy_ZZ)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: _ = lazy_ZZ(3)\nsage: type(lazy_ZZ)\n<class 'sage.rings.integer_ring.IntegerRing_class'>\n```\n    with\n\n```\nsage: from sage.misc.lazy_import import LazyImport\nsage: lazy_ZZ = LazyImport('sage.rings.all', 'ZZ')\nsage: _ = lazy_ZZ(3)\nsage: type(lazy_ZZ)\n<class 'sage.misc.lazy_import.LazyImport'>\n```\n    In the former version, any code that uses more than once the lazy object actually uses it only once.\n\n3. It is not checked that lazy imported module resolves correctly... and it is not the case\n\n```\nsage: LinearCodeFromVectorSpace._get_object()\nTraceback (most recent call last):\n...\nAttributeError: module 'sage.coding.linear_code' has no attribute 'LinearCodeFromVectorSpace'\n```\n\nFollow-up: #31656\n\nCC:  @kliem\n\nReviewer: Travis Scrimshaw\n\nAuthor: Vincent Delecroix\n\nBranch: 99ad00758cd9b37574c9b0cfa01d607b8c5de217\n\nDependencies: #31648\n\nCommit: 99ad00758cd9b37574c9b0cfa01d607b8c5de217\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31650\n\n",
    "closed_at": "2021-06-06T13:18:12Z",
    "created_at": "2021-04-11T11:23:25Z",
    "labels": [
        "component: misc"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "improve LazyImport",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31650",
    "user": "https://github.com/videlec"
}
```
The `LazyImport` objects suffer several problems

1. `copy` and `deepcopy` are broken

```
sage: from sage.misc.lazy_import import LazyImport
sage: sage.all.foo = [1, 2]
sage: lazy_foo = LazyImport('sage.all', 'foo')
sage: a = copy(lazy_foo)
sage: a
[1, 2]
sage: a[0] = 18
sage: lazy_foo
[18, 2]
```

2. Most doctests use `lazy_import` rather than `LazyImport`. The former modifies the namespace so that the name actually points to the object afterwards. Compare

```
sage: lazy_import('sage.rings.all', 'ZZ', 'lazy_ZZ')
sage: type(lazy_ZZ)
<class 'sage.misc.lazy_import.LazyImport'>
sage: _ = lazy_ZZ(3)
sage: type(lazy_ZZ)
<class 'sage.rings.integer_ring.IntegerRing_class'>
```
    with

```
sage: from sage.misc.lazy_import import LazyImport
sage: lazy_ZZ = LazyImport('sage.rings.all', 'ZZ')
sage: _ = lazy_ZZ(3)
sage: type(lazy_ZZ)
<class 'sage.misc.lazy_import.LazyImport'>
```
    In the former version, any code that uses more than once the lazy object actually uses it only once.

3. It is not checked that lazy imported module resolves correctly... and it is not the case

```
sage: LinearCodeFromVectorSpace._get_object()
Traceback (most recent call last):
...
AttributeError: module 'sage.coding.linear_code' has no attribute 'LinearCodeFromVectorSpace'
```

Follow-up: #31656

CC:  @kliem

Reviewer: Travis Scrimshaw

Author: Vincent Delecroix

Branch: 99ad00758cd9b37574c9b0cfa01d607b8c5de217

Dependencies: #31648

Commit: 99ad00758cd9b37574c9b0cfa01d607b8c5de217

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31650





---

archive/issue_comments_448763.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2021-04-11T12:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448763",
    "user": "https://github.com/videlec"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_448764.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448764",
    "user": "https://github.com/videlec"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_448765.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448765",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_448766.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448766",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_448767.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to misc.",
    "created_at": "2021-04-11T19:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448767",
    "user": "https://github.com/videlec"
}
```

Changing component from PLEASE CHANGE to misc.



---

archive/issue_comments_448768.json:
```json
{
    "body": "<a id='comment:7'></a>See also: #22793, #20626",
    "created_at": "2021-04-11T22:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448768",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>See also: #22793, #20626



---

archive/issue_events_083373.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-15T02:16:37Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31650#event-83373"
}
```



---

archive/issue_comments_448769.json:
```json
{
    "body": "<a id='comment:9'></a>I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.\n\nAlso, I don't understand what point 2 is trying to make.",
    "created_at": "2021-04-16T00:07:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448769",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.

Also, I don't understand what point 2 is trying to make.



---

archive/issue_comments_448770.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 tscrim]:\n> I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.\n\n\nThey don't need to. It is just more condensed.\n\nWhat do you mean by traceback? I don't understand your point.\n\n> Also, I don't understand what point 2 is trying to make.\n\n\nThat the following doctest was not testing `LazyImport`\n\n```\nsage: lazy_import('sage.all', 'foo')\nsage: type(foo)\n<type 'sage.misc.lazy_import.LazyImport'>\nsage: del foo[1]  # still lazy\nsage: print(foo)  # not lazy anymore\n```\nI agree that this was not a problem in the doctests.",
    "created_at": "2021-04-16T06:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448770",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>Replying to [comment:9 tscrim]:
> I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.


They don't need to. It is just more condensed.

What do you mean by traceback? I don't understand your point.

> Also, I don't understand what point 2 is trying to make.


That the following doctest was not testing `LazyImport`

```
sage: lazy_import('sage.all', 'foo')
sage: type(foo)
<type 'sage.misc.lazy_import.LazyImport'>
sage: del foo[1]  # still lazy
sage: print(foo)  # not lazy anymore
```
I agree that this was not a problem in the doctests.



---

archive/issue_comments_448771.json:
```json
{
    "body": "<a id='comment:11'></a>See also #16522 for improvements of the use of lazy_import rather than improving the tool itself.",
    "created_at": "2021-04-18T07:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448771",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:11'></a>See also #16522 for improvements of the use of lazy_import rather than improving the tool itself.



---

archive/issue_comments_448772.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 vdelecroix]:\n> Replying to [comment:9 tscrim]:\n> > I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.\n\n> \n> They don't need to. It is just more condensed.\n\n\nHowever, they output too much when they do fail (see below), they obscure (very) slightly that the test should be `True`, and the `assert` tests could (in principle) be disabled as they are meant for serious errors during debugging.\n\n> What do you mean by traceback? I don't understand your point.\n\n\nYou get something like this:\n\n```\nFile \"partition.py\", line 7, in sage.combinat.partition\nFailed example:\n    assert False\nException raised:\n    Traceback (most recent call last):\n      File \"/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.partition[0]>\", line 1, in <module>\n        assert False\n    AssertionError\n```\nwhich is a lot of noise for something that is not `True`.\n(I just add this to the start of `partition.py`:\n\n```\nEXAMPLES::\n\n    sage: assert False\n```\n\nBecause of these points, I think they should follow the standard doctest practice of checking against output.\n\n> > Also, I don't understand what point 2 is trying to make.\n\n> \n> That the following doctest was not testing `LazyImport`\n> \n> ```\n> sage: lazy_import('sage.all', 'foo')\n> sage: type(foo)\n> <type 'sage.misc.lazy_import.LazyImport'>\n> sage: del foo[1]  # still lazy\n> sage: print(foo)  # not lazy anymore\n> ```\n> I agree that this was not a problem in the doctests.\n\n\nI see. Thank you for the explanation.",
    "created_at": "2021-04-19T00:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448772",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>Replying to [comment:10 vdelecroix]:
> Replying to [comment:9 tscrim]:
> > I don't see why all those doctests need to be `assert`. If they fail, they just give a longer traceback with no meaningful information.

> 
> They don't need to. It is just more condensed.


However, they output too much when they do fail (see below), they obscure (very) slightly that the test should be `True`, and the `assert` tests could (in principle) be disabled as they are meant for serious errors during debugging.

> What do you mean by traceback? I don't understand your point.


You get something like this:

```
File "partition.py", line 7, in sage.combinat.partition
Failed example:
    assert False
Exception raised:
    Traceback (most recent call last):
      File "/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/uqtscrim/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.partition[0]>", line 1, in <module>
        assert False
    AssertionError
```
which is a lot of noise for something that is not `True`.
(I just add this to the start of `partition.py`:

```
EXAMPLES::

    sage: assert False
```

Because of these points, I think they should follow the standard doctest practice of checking against output.

> > Also, I don't understand what point 2 is trying to make.

> 
> That the following doctest was not testing `LazyImport`
> 
> ```
> sage: lazy_import('sage.all', 'foo')
> sage: type(foo)
> <type 'sage.misc.lazy_import.LazyImport'>
> sage: del foo[1]  # still lazy
> sage: print(foo)  # not lazy anymore
> ```
> I agree that this was not a problem in the doctests.


I see. Thank you for the explanation.



---

archive/issue_comments_448773.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-04-19T00:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448773",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_448774.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-20T18:34:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448774",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448775.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-20T18:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448775",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_448776.json:
```json
{
    "body": "<a id='comment:15'></a>Thank you. LGTM.",
    "created_at": "2021-04-21T06:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448776",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>Thank you. LGTM.



---

archive/issue_comments_448777.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-21T06:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448777",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_083374.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-06T13:18:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31650#event-83374"
}
```



---

archive/issue_comments_448778.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-06T13:18:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31650",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31650#issuecomment-448778",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
