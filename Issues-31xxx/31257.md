# Issue 31257: quo_rem gives wrong answers for LaurentPolynomial_mpair

archive/issues_031020.json:
```json
{
    "body": "The method `quo_rem` of `LaurentPolynomial_mpair` gives wrong answers:\n\n```\nsage: R.<x,y> = LaurentPolynomialRing(QQ)\nsage: q, r = (1/x).quo_rem(y) ; q, r\n(0, 1)\nsage: q*y + r == 1/x\nFalse\n```\n\nAs remarked [on sage-devel](https://groups.google.com/g/sage-devel/c/PhXn1WEShwA) it is not clear which should be the preferred answer in this case: both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.\n\nCC:  @davewittemorris\n\nKeywords: Laurent polynomials\n\nBranch/Commit: 0b0db6d985ebdb77690a20610626f0aa26efd36e\n\nReviewer: Salvatore Stella\n\nAuthor: Dave Morris\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31257\n\n",
    "closed_at": "2021-01-31T20:53:22Z",
    "created_at": "2021-01-17T21:02:35Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "quo_rem gives wrong answers for LaurentPolynomial_mpair",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31257",
    "user": "https://github.com/etn40ff"
}
```
The method `quo_rem` of `LaurentPolynomial_mpair` gives wrong answers:

```
sage: R.<x,y> = LaurentPolynomialRing(QQ)
sage: q, r = (1/x).quo_rem(y) ; q, r
(0, 1)
sage: q*y + r == 1/x
False
```

As remarked [on sage-devel](https://groups.google.com/g/sage-devel/c/PhXn1WEShwA) it is not clear which should be the preferred answer in this case: both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.

CC:  @davewittemorris

Keywords: Laurent polynomials

Branch/Commit: 0b0db6d985ebdb77690a20610626f0aa26efd36e

Reviewer: Salvatore Stella

Author: Dave Morris

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31257





---

archive/issue_comments_620649.json:
```json
{
    "body": "<a id='comment:1'></a>\n> {{{\n> sage: q, r = (1/x).quo_rem(y) ; q, r\n> }}}\n> Both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.\n\n\nI would go for `(0, 1/x)`.",
    "created_at": "2021-01-18T13:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620649",
    "user": "https://github.com/slel"
}
```

<a id='comment:1'></a>
> {{{
> sage: q, r = (1/x).quo_rem(y) ; q, r
> }}}
> Both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.


I would go for `(0, 1/x)`.



---

archive/issue_comments_620650.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,10 +2,10 @@\n \n ```\n sage: R.<x,y> = LaurentPolynomialRing(QQ)\n-sage: q,r = (1/x).quo_rem(y) ; q,r\n+sage: q, r = (1/x).quo_rem(y) ; q, r\n (0, 1)\n sage: q*y + r == 1/x\n False\n ```\n \n-As remarked on sage-devel it is not clear which should be the preferred answer in this case: both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.\n+As remarked [on sage-devel](https://groups.google.com/g/sage-devel/c/PhXn1WEShwA) it is not clear which should be the preferred answer in this case: both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.\n``````\n",
    "created_at": "2021-01-18T13:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620650",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,10 +2,10 @@
 
 ```
 sage: R.<x,y> = LaurentPolynomialRing(QQ)
-sage: q,r = (1/x).quo_rem(y) ; q,r
+sage: q, r = (1/x).quo_rem(y) ; q, r
 (0, 1)
 sage: q*y + r == 1/x
 False
 ```
 
-As remarked on sage-devel it is not clear which should be the preferred answer in this case: both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.
+As remarked [on sage-devel](https://groups.google.com/g/sage-devel/c/PhXn1WEShwA) it is not clear which should be the preferred answer in this case: both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.
``````




---

archive/issue_comments_620651.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [slelievre](#comment%3A1):\n> > {{{\n> > sage: q, r = (1/x).quo_rem(y) ; q, r\n> > }}}\n> > Both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.\n\n> \n> I would go for `(0, 1/x)`.\n\nIntegers and polynomials seem to adopt the other option:\n\n```\nsage: 10.quo_rem(-1)\n(-10, 0)\nsage: R.<x,y> = PolynomialRing(ZZ)\nsage: (x+1).quo_rem(-1)\n(-x - 1, 0)\n```",
    "created_at": "2021-01-18T14:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620651",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:2'></a>
Replying to [slelievre](#comment%3A1):
> > {{{
> > sage: q, r = (1/x).quo_rem(y) ; q, r
> > }}}
> > Both `(0, 1/x)` and `(1/(x*y), 0)` are correct because `y` is a unit.

> 
> I would go for `(0, 1/x)`.

Integers and polynomials seem to adopt the other option:

```
sage: 10.quo_rem(-1)
(-10, 0)
sage: R.<x,y> = PolynomialRing(ZZ)
sage: (x+1).quo_rem(-1)
(-x - 1, 0)
```



---

archive/issue_comments_620652.json:
```json
{
    "body": "Changing branch from \"\" to \"public/31257\"",
    "created_at": "2021-01-19T05:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620652",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "" to "public/31257"



---

archive/issue_comments_620653.json:
```json
{
    "body": "Changing author from \"\" to \"Dave Morris\"",
    "created_at": "2021-01-19T05:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620653",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing author from "" to "Dave Morris"



---

archive/issue_comments_620654.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe PR fixes two bugs.\n\nA Laurent polynomial is stored as a pair: a polynomial, and a tuple of offsets for the exponents. The `quo_rem` method divides these two multivariable polynomials, but did not apply the appropriate offset to the remainder (although it did apply the correct offset to the quotient). This means that the remainder was usually wrong (not just in corner cases). Indeed, one of the doctests was incorrect:\n\n```\nsage: R.<s, t> = LaurentPolynomialRing(QQ)\nsage: (s^-2-t^2).quo_rem(s-t)\n(s + t, -s^4 + 1)\n```\nThis is mathematically wrong, because the remainder should be `s^-2 - s^2`.\n\nThe other bug is less serious.  It was caused by the non-uniqueness of the representation of a Laurent polynomial. For example, `x^2` could be represented as `x^2` with an offset of `0` in the exponent, or as the constant `1` with an offset of `2` in the exponent of `x`. Changing the representation will often change the result of `quo_rem`, so it could easily happen that `g == g_1`, but `f.quo_rem(g)` is not equal to `f.quo_rem(g1)`. To fix this, I applied the `normalize` method in order to put `self` and `right` into standard form before applying the polynomial division. This should make the output of `quo_rem` unique.\n\nA question, because I am not a cython expert (or python expert). The `quo_rem` method should not change `self`, so, instead of `self.normalize()`, I wrote\n\n```\ncdef LaurentPolynomial_mpair selfl = <LaurentPolynomial_mpair> self\nselfl._normalize()\n```\nIs it true that this will normalize a copy of `self`, and leave `self` unchanged?\n\n---\nNew commits:\n|                                                                                                                                          |                        |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[0debcaa](https://github.com/sagemath/sagetrac-mirror/commit/0debcaa736356a18b6e6d76fb591147968e6d760)|`trac 31257 fix quo_rem`|",
    "created_at": "2021-01-19T05:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620654",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:4'></a>
The PR fixes two bugs.

A Laurent polynomial is stored as a pair: a polynomial, and a tuple of offsets for the exponents. The `quo_rem` method divides these two multivariable polynomials, but did not apply the appropriate offset to the remainder (although it did apply the correct offset to the quotient). This means that the remainder was usually wrong (not just in corner cases). Indeed, one of the doctests was incorrect:

```
sage: R.<s, t> = LaurentPolynomialRing(QQ)
sage: (s^-2-t^2).quo_rem(s-t)
(s + t, -s^4 + 1)
```
This is mathematically wrong, because the remainder should be `s^-2 - s^2`.

The other bug is less serious.  It was caused by the non-uniqueness of the representation of a Laurent polynomial. For example, `x^2` could be represented as `x^2` with an offset of `0` in the exponent, or as the constant `1` with an offset of `2` in the exponent of `x`. Changing the representation will often change the result of `quo_rem`, so it could easily happen that `g == g_1`, but `f.quo_rem(g)` is not equal to `f.quo_rem(g1)`. To fix this, I applied the `normalize` method in order to put `self` and `right` into standard form before applying the polynomial division. This should make the output of `quo_rem` unique.

A question, because I am not a cython expert (or python expert). The `quo_rem` method should not change `self`, so, instead of `self.normalize()`, I wrote

```
cdef LaurentPolynomial_mpair selfl = <LaurentPolynomial_mpair> self
selfl._normalize()
```
Is it true that this will normalize a copy of `self`, and leave `self` unchanged?

---
New commits:
|                                                                                                                                          |                        |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[0debcaa](https://github.com/sagemath/sagetrac-mirror/commit/0debcaa736356a18b6e6d76fb591147968e6d760)|`trac 31257 fix quo_rem`|



---

archive/issue_comments_620655.json:
```json
{
    "body": "Changing commit from \"\" to \"0debcaa736356a18b6e6d76fb591147968e6d760\"",
    "created_at": "2021-01-19T05:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620655",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "" to "0debcaa736356a18b6e6d76fb591147968e6d760"



---

archive/issue_comments_620656.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-19T05:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620656",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_620657.json:
```json
{
    "body": "<a id='comment:5'></a>\nLGTM\n\nIn my understanding you are right: this should leave `self` unchanged. I am not sure this is the fastest solution though.",
    "created_at": "2021-01-19T16:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620657",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:5'></a>
LGTM

In my understanding you are right: this should leave `self` unchanged. I am not sure this is the fastest solution though.



---

archive/issue_comments_620658.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-19T16:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620658",
    "user": "https://github.com/etn40ff"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_620659.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Salvatore Stella\"",
    "created_at": "2021-01-19T16:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620659",
    "user": "https://github.com/etn40ff"
}
```

Changing reviewer from "" to "Salvatore Stella"



---

archive/issue_comments_620660.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-01-20T00:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_620661.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n|                                                                                                                                           |                      |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------|\n|[0b0db6d](https://github.com/sagemath/sagetrac-mirror/commit/0b0db6d985ebdb77690a20610626f0aa26efd36e)|`make copies of input`|",
    "created_at": "2021-01-20T00:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620661",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
|                                                                                                                                           |                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------|
|[0b0db6d](https://github.com/sagemath/sagetrac-mirror/commit/0b0db6d985ebdb77690a20610626f0aa26efd36e)|`make copies of input`|



---

archive/issue_comments_620662.json:
```json
{
    "body": "Changing commit from \"0debcaa736356a18b6e6d76fb591147968e6d760\" to \"0b0db6d985ebdb77690a20610626f0aa26efd36e\"",
    "created_at": "2021-01-20T00:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620662",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0debcaa736356a18b6e6d76fb591147968e6d760" to "0b0db6d985ebdb77690a20610626f0aa26efd36e"



---

archive/issue_comments_620663.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe code is now more in line with what happens in other places in the same file. \n\nTalking of which, the univariate version of quo_rem does not normalize self before performing computations. Is this normalization required to get consistent answers?",
    "created_at": "2021-01-20T17:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620663",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:7'></a>
The code is now more in line with what happens in other places in the same file. 

Talking of which, the univariate version of quo_rem does not normalize self before performing computations. Is this normalization required to get consistent answers?



---

archive/issue_comments_620664.json:
```json
{
    "body": "<a id='comment:8'></a>\nIn the univariate case, Laurent polynomials are always stored in normalized form: \"A Laurent series is a pair `(u(t), n)`, where either `u = 0` (to some precision) or `u` is a unit.\" The requirement that u is a unit means that the constant term is not 0, which is what it means to be normalized in the univariate case. Since the input is already normalized, there is no need to normalize it again. \n\nBut multivariate Laurent polynomials are not automatically normalized when they are created (or at other times).",
    "created_at": "2021-01-20T19:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620664",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:8'></a>
In the univariate case, Laurent polynomials are always stored in normalized form: "A Laurent series is a pair `(u(t), n)`, where either `u = 0` (to some precision) or `u` is a unit." The requirement that u is a unit means that the constant term is not 0, which is what it means to be normalized in the univariate case. Since the input is already normalized, there is no need to normalize it again. 

But multivariate Laurent polynomials are not automatically normalized when they are created (or at other times).



---

archive/issue_comments_620665.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-20T19:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620665",
    "user": "https://github.com/etn40ff"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_620666.json:
```json
{
    "body": "<a id='comment:9'></a>\nThen I am fine with the fix.",
    "created_at": "2021-01-20T19:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620666",
    "user": "https://github.com/etn40ff"
}
```

<a id='comment:9'></a>
Then I am fine with the fix.



---

archive/issue_comments_620667.json:
```json
{
    "body": "<a id='comment:10'></a>\nThanks for the review!  \n\nFor some reason, my explanation about the commit in[comment:6](#comment%3A6) did not get uploaded, so I will paraphrase it now, for the record:\n\nMy original commit did change `self`. (Casting a pointer does not make a copy.) So it is necessary to explicitly make a copy of `self` and `right`.",
    "created_at": "2021-01-20T19:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620667",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:10'></a>
Thanks for the review!  

For some reason, my explanation about the commit in[comment:6](#comment%3A6) did not get uploaded, so I will paraphrase it now, for the record:

My original commit did change `self`. (Casting a pointer does not make a copy.) So it is necessary to explicitly make a copy of `self` and `right`.



---

archive/issue_comments_620668.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-31T20:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620668",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_092037.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:53:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31257#event-92037"
}
```



---

archive/issue_comments_620669.json:
```json
{
    "body": "Changing branch from \"public/31257\" to \"0b0db6d985ebdb77690a20610626f0aa26efd36e\"",
    "created_at": "2021-01-31T20:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31257",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31257#issuecomment-620669",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/31257" to "0b0db6d985ebdb77690a20610626f0aa26efd36e"
