# Issue 31924: sage -t: Do not run pytest on individual Python files unless they match the pytest file pattern

archive/issues_031687.json:
```json
{
    "assignees": [],
    "body": "`sage -t` is broken since #31003/#31103 because\n- pytest is configured to look for methods prefixed with test_ and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.\n- pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors.\n\n```\n$ ./sage -t  src/sage/databases/*.py \ntoo many failed tests, not using stored timings\nRunning doctests with ID 2021-06-07-11-04-14-3c1f8784.\nUsing --optional=4ti2,bliss,build,database_knotinfo,dochtml,e_antic,homebrew,jupymake,latte_int,lidia,lrslib,normaliz,pip,sage,sage_spkg\nDoctesting 16 files.\nsage -t --random-seed=0 src/sage/databases/__init__.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=0 src/sage/databases/all.py\n    [5 tests, 0.10 s]\nsage -t --random-seed=0 src/sage/databases/conway.py\n    [42 tests, 0.10 s]\nsage -t --random-seed=0 src/sage/databases/cremona.py\n    [133 tests, 0.31 s]\nsage -t --random-seed=0 src/sage/databases/cunningham_tables.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=0 src/sage/databases/db_class_polynomials.py\n    [7 tests, 0.01 s]\nsage -t --random-seed=0 src/sage/databases/db_modular_polynomials.py\n    [13 tests, 0.01 s]\nsage -t --random-seed=0 src/sage/databases/findstat.py\n    [122 tests, 0.25 s]\nsage -t --random-seed=0 src/sage/databases/jones.py\n    [8 tests, 0.05 s]\nsage -t --random-seed=0 src/sage/databases/knotinfo_db.py\n    [97 tests, 1.80 s]\nsage -t --random-seed=0 src/sage/databases/odlyzko.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=0 src/sage/databases/oeis.py\n    [134 tests, 0.91 s]\nsage -t --random-seed=0 src/sage/databases/sloane.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=0 src/sage/databases/sql_db.py\n    [293 tests, 0.27 s]\nsage -t --random-seed=0 src/sage/databases/stein_watkins.py\n    [12 tests, 0.01 s]\nsage -t --random-seed=0 src/sage/databases/symbolic_data.py\n    [0 tests, 0.00 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 4.6 seconds\n    cpu time: 3.9 seconds\n    cumulative wall time: 3.8 seconds\n============================================================================== test session starts ===============================================================================\nplatform darwin -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\ncollected 0 items / 7 errors                                                                                                                                                     \n\n===================================================================================== ERRORS =====================================================================================\n_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nsrc/sage/databases/all.py:51: in <module>\n    from .sql_db import SQLQuery, SQLDatabase\nE   ImportError: attempted relative import with no known parent package\n_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nsrc/sage/databases/all.py:51: in <module>\n    from .sql_db import SQLQuery, SQLDatabase\nE   ImportError: attempted relative import with no known parent package\n___________________________________________________________________ ERROR collecting sage/databases/cremona.py ___________________________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/cremona.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nsrc/sage/databases/cremona.py:52: in <module>\n    from .sql_db import SQLDatabase, verify_column\nE   ImportError: attempted relative import with no known parent package\n____________________________________________________________ ERROR collecting sage/databases/db_class_polynomials.py _____________________________________________________________\nImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/db_class_polynomials.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nsrc/sage/databases/db_class_polynomials.py:14: in <module>\n    from .db_modular_polynomials import _dbz_to_integers\nE   ImportError: attempted relative import with no known parent package\n__________________________________________________________________ ERROR collecting sage/databases/findstat.py ___________________________________________________________________\nsrc/sage/databases/findstat.py:329: in <module>\n    class FindStat(UniqueRepresentation, SageObject):\nsage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n    ???\nE   KeyError: 'findstat'\n_________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _________________________________________________________________\nsrc/sage/databases/knotinfo_db.py:330: in <module>\n    class KnotInfoDataBase(SageObject, UniqueRepresentation):\nsage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n    ???\nE   KeyError: 'knotinfo_db'\n____________________________________________________________________ ERROR collecting sage/databases/oeis.py _____________________________________________________________________\nsrc/sage/databases/oeis.py:651: in <module>\n    class OEISSequence(SageObject, UniqueRepresentation):\nsage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n    ???\nE   KeyError: 'oeis'\n============================================================================ short test summary info =============================================================================\nERROR src/sage/databases/all.py\nERROR src/sage/databases/all.py\nERROR src/sage/databases/cremona.py\nERROR src/sage/databases/db_class_polynomials.py\nERROR src/sage/databases/findstat.py - KeyError: 'findstat'\nERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'\nERROR src/sage/databases/oeis.py - KeyError: 'oeis'\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n```\n\nRelated report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:\n\n```\n=============================================================== ERRORS\n================================================================\n_________________________________________ ERROR collecting\nsage/structure/sage_object_test.py\n_________________________________________\nImportError while importing test module\n'/home/john/sage/src/sage/structure/sage_object_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nsrc/sage/structure/sage_object_test.py:3: in <module>\nfrom .sage_object import SageObject\nE ImportError: attempted relative import with no known parent package\n======================================================= short test\nsummary info =======================================================\nERROR src/sage/structure/sage_object_test.py\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error\nduring collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n```\n\n\nIn this ticket, we fix it by passing names of regular files to `pytest` only if they match the pytest pattern (ending with `_test.py`).\n\n(The dependency #32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)\n\nExample:\n\n```\n$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py \ntoo many failed tests, not using stored timings\nRunning doctests with ID 2022-03-22-11-30-32-fd280468.\nUsing --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 27 files using 8 threads.\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx\n    [52 tests, 0.08 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx\n    [87 tests, 0.14 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx\n    [193 tests, 0.17 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx\n    [221 tests, 0.25 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py\n    [45 tests, 0.05 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx\n    [37 tests, 0.07 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx\n    [25 tests, 0.05 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx\n    [24 tests, 0.03 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py\n    [0 tests, 0.00 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx\n    [96 tests, 0.59 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx\n    [266 tests, 3.09 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx\n    [592 tests, 3.08 s]\nsage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx\n    [3070 tests, 31.83 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 32.6 seconds\n    cpu time: 39.3 seconds\n    cumulative wall time: 39.4 seconds\nFeatures detected for doctesting: sage.rings.number_field\n============================================================================================================ test session starts ============================================================================================================\nplatform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\ncollected 32 items                                                                                                                                                                                                                          \n\nsrc/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]\nsrc/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]\nsrc/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]\nsrc/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]\nsrc/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]\nsrc/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]\n\n=======================================================================================\n```\n\nCC:  @tobiasdiez @soehms @JohnCremona @dimpase @saraedum @isuruf @tscrim\n\nBranch/Commit: **[1214e0c](https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda)**\n\nReviewer: **Sebastian Oehms**\n\nAuthor: **Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31924_\n\n",
    "closed_at": "2022-04-02T10:53:35Z",
    "created_at": "2021-06-07T18:08:02Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.6",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage -t: Do not run pytest on individual Python files unless they match the pytest file pattern",
    "type": "issue",
    "updated_at": "2022-04-02T10:53:35Z",
    "url": "https://github.com/sagemath/sage/issues/31924",
    "user": "https://github.com/mkoeppe"
}
```
`sage -t` is broken since #31003/#31103 because
- pytest is configured to look for methods prefixed with test_ and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.
- pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors.

```
$ ./sage -t  src/sage/databases/*.py 
too many failed tests, not using stored timings
Running doctests with ID 2021-06-07-11-04-14-3c1f8784.
Using --optional=4ti2,bliss,build,database_knotinfo,dochtml,e_antic,homebrew,jupymake,latte_int,lidia,lrslib,normaliz,pip,sage,sage_spkg
Doctesting 16 files.
sage -t --random-seed=0 src/sage/databases/__init__.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/all.py
    [5 tests, 0.10 s]
sage -t --random-seed=0 src/sage/databases/conway.py
    [42 tests, 0.10 s]
sage -t --random-seed=0 src/sage/databases/cremona.py
    [133 tests, 0.31 s]
sage -t --random-seed=0 src/sage/databases/cunningham_tables.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/db_class_polynomials.py
    [7 tests, 0.01 s]
sage -t --random-seed=0 src/sage/databases/db_modular_polynomials.py
    [13 tests, 0.01 s]
sage -t --random-seed=0 src/sage/databases/findstat.py
    [122 tests, 0.25 s]
sage -t --random-seed=0 src/sage/databases/jones.py
    [8 tests, 0.05 s]
sage -t --random-seed=0 src/sage/databases/knotinfo_db.py
    [97 tests, 1.80 s]
sage -t --random-seed=0 src/sage/databases/odlyzko.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/oeis.py
    [134 tests, 0.91 s]
sage -t --random-seed=0 src/sage/databases/sloane.py
    [0 tests, 0.00 s]
sage -t --random-seed=0 src/sage/databases/sql_db.py
    [293 tests, 0.27 s]
sage -t --random-seed=0 src/sage/databases/stein_watkins.py
    [12 tests, 0.01 s]
sage -t --random-seed=0 src/sage/databases/symbolic_data.py
    [0 tests, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 4.6 seconds
    cpu time: 3.9 seconds
    cumulative wall time: 3.8 seconds
============================================================================== test session starts ===============================================================================
platform darwin -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
collected 0 items / 7 errors                                                                                                                                                     

===================================================================================== ERRORS =====================================================================================
_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/all.py:51: in <module>
    from .sql_db import SQLQuery, SQLDatabase
E   ImportError: attempted relative import with no known parent package
_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/all.py:51: in <module>
    from .sql_db import SQLQuery, SQLDatabase
E   ImportError: attempted relative import with no known parent package
___________________________________________________________________ ERROR collecting sage/databases/cremona.py ___________________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/cremona.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/cremona.py:52: in <module>
    from .sql_db import SQLDatabase, verify_column
E   ImportError: attempted relative import with no known parent package
____________________________________________________________ ERROR collecting sage/databases/db_class_polynomials.py _____________________________________________________________
ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/db_class_polynomials.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/databases/db_class_polynomials.py:14: in <module>
    from .db_modular_polynomials import _dbz_to_integers
E   ImportError: attempted relative import with no known parent package
__________________________________________________________________ ERROR collecting sage/databases/findstat.py ___________________________________________________________________
src/sage/databases/findstat.py:329: in <module>
    class FindStat(UniqueRepresentation, SageObject):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
    ???
E   KeyError: 'findstat'
_________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _________________________________________________________________
src/sage/databases/knotinfo_db.py:330: in <module>
    class KnotInfoDataBase(SageObject, UniqueRepresentation):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
    ???
E   KeyError: 'knotinfo_db'
____________________________________________________________________ ERROR collecting sage/databases/oeis.py _____________________________________________________________________
src/sage/databases/oeis.py:651: in <module>
    class OEISSequence(SageObject, UniqueRepresentation):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
    ???
E   KeyError: 'oeis'
============================================================================ short test summary info =============================================================================
ERROR src/sage/databases/all.py
ERROR src/sage/databases/all.py
ERROR src/sage/databases/cremona.py
ERROR src/sage/databases/db_class_polynomials.py
ERROR src/sage/databases/findstat.py - KeyError: 'findstat'
ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'
ERROR src/sage/databases/oeis.py - KeyError: 'oeis'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
```

Related report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:

```
=============================================================== ERRORS
================================================================
_________________________________________ ERROR collecting
sage/structure/sage_object_test.py
_________________________________________
ImportError while importing test module
'/home/john/sage/src/sage/structure/sage_object_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/structure/sage_object_test.py:3: in <module>
from .sage_object import SageObject
E ImportError: attempted relative import with no known parent package
======================================================= short test
summary info =======================================================
ERROR src/sage/structure/sage_object_test.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error
during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
```


In this ticket, we fix it by passing names of regular files to `pytest` only if they match the pytest pattern (ending with `_test.py`).

(The dependency #32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)

Example:

```
$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py 
too many failed tests, not using stored timings
Running doctests with ID 2022-03-22-11-30-32-fd280468.
Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Sorting sources by runtime so that slower doctests are run first....
Doctesting 27 files using 8 threads.
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx
    [52 tests, 0.08 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx
    [87 tests, 0.14 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx
    [193 tests, 0.17 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx
    [221 tests, 0.25 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py
    [45 tests, 0.05 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx
    [37 tests, 0.07 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx
    [25 tests, 0.05 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx
    [24 tests, 0.03 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py
    [0 tests, 0.00 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx
    [96 tests, 0.59 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx
    [266 tests, 3.09 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx
    [592 tests, 3.08 s]
sage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx
    [3070 tests, 31.83 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 32.6 seconds
    cpu time: 39.3 seconds
    cumulative wall time: 39.4 seconds
Features detected for doctesting: sage.rings.number_field
============================================================================================================ test session starts ============================================================================================================
platform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
collected 32 items                                                                                                                                                                                                                          

src/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]
src/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]
src/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]
src/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]
src/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]
src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]

=======================================================================================
```

CC:  @tobiasdiez @soehms @JohnCremona @dimpase @saraedum @isuruf @tscrim

Branch/Commit: **[1214e0c](https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda)**

Reviewer: **Sebastian Oehms**

Author: **Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/31924_





---

archive/issue_events_421924.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-07T18:08:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421924"
}
```



---

archive/issue_events_421925.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-07T18:08:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421925"
}
```



---

archive/issue_events_421926.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-07T18:08:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421926"
}
```



---

archive/issue_events_421927.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-07T18:08:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421927"
}
```



---

archive/issue_comments_516496.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-pytest is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:\n+pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:\n \n ```\n $ ./sage -t  src/sage/databases/*.py \n@@ -106,3 +106,27 @@\n ERROR src/sage/databases/oeis.py - KeyError: 'oeis'\n !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n ```\n+\n+Related report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:\n+\n+```\n+=============================================================== ERRORS\n+================================================================\n+_________________________________________ ERROR collecting\n+sage/structure/sage_object_test.py\n+_________________________________________\n+ImportError while importing test module\n+'/home/john/sage/src/sage/structure/sage_object_test.py'.\n+Hint: make sure your test modules/packages have valid Python names.\n+Traceback:\n+src/sage/structure/sage_object_test.py:3: in <module>\n+from .sage_object import SageObject\n+E ImportError: attempted relative import with no known parent package\n+======================================================= short test\n+summary info =======================================================\n+ERROR src/sage/structure/sage_object_test.py\n+!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error\n+during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n+```\n+\n+\n``````\n",
    "created_at": "2021-06-18T17:40:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516496",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-pytest is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:
+pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:
 
 ```
 $ ./sage -t  src/sage/databases/*.py 
@@ -106,3 +106,27 @@
 ERROR src/sage/databases/oeis.py - KeyError: 'oeis'
 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 ```
+
+Related report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:
+
+```
+=============================================================== ERRORS
+================================================================
+_________________________________________ ERROR collecting
+sage/structure/sage_object_test.py
+_________________________________________
+ImportError while importing test module
+'/home/john/sage/src/sage/structure/sage_object_test.py'.
+Hint: make sure your test modules/packages have valid Python names.
+Traceback:
+src/sage/structure/sage_object_test.py:3: in <module>
+from .sage_object import SageObject
+E ImportError: attempted relative import with no known parent package
+======================================================= short test
+summary info =======================================================
+ERROR src/sage/structure/sage_object_test.py
+!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error
+during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
+```
+
+
``````




---

archive/issue_events_421928.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-19T20:10:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421928"
}
```



---

archive/issue_events_421929.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-19T20:10:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421929"
}
```



---

archive/issue_comments_516497.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nIt seems that there is no way to tell `pytest` to ignore non matching files from the argument list on throwing these error messages.\n\nSo, is there anything standing against just doing it like this?\n\n```diff\ndiff --git a/src/bin/sage-runtests b/src/bin/sage-runtests\nindex 16d3295..e852853 100755\n--- a/src/bin/sage-runtests\n+++ b/src/bin/sage-runtests\n@@ -143,15 +143,16 @@ if __name__ == \"__main__\":\n     DC = DocTestController(options, args)\n     err = DC.run()\n\n-    try:\n-        exit_code_pytest = 0\n-        import pytest\n-        pytest_options = [\"--import-mode\", \"importlib\"]\n-        if options.verbose:\n-            pytest_options.append(\"-v\")\n-        exit_code_pytest = pytest.main(pytest_options + args)\n-    except ModuleNotFoundError:\n-        print(\"Pytest is not installed, skip checking tests that rely on it.\")\n+    exit_code_pytest = 0\n+    if not args:\n+        try:\n+            import pytest\n+            pytest_options = [\"--import-mode\", \"importlib\"]\n+            if options.verbose:\n+                pytest_options.append(\"-v\")\n+            exit_code_pytest = pytest.main(pytest_options + args)\n+        except ModuleNotFoundError:\n+            print(\"Pytest is not installed, skip checking tests that rely on it.\")\n```",
    "created_at": "2021-07-02T16:40:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516497",
    "user": "https://github.com/soehms"
}
```

<div id="comment:3" align="right">Comment 3</div>

It seems that there is no way to tell `pytest` to ignore non matching files from the argument list on throwing these error messages.

So, is there anything standing against just doing it like this?

```diff
diff --git a/src/bin/sage-runtests b/src/bin/sage-runtests
index 16d3295..e852853 100755
--- a/src/bin/sage-runtests
+++ b/src/bin/sage-runtests
@@ -143,15 +143,16 @@ if __name__ == "__main__":
     DC = DocTestController(options, args)
     err = DC.run()

-    try:
-        exit_code_pytest = 0
-        import pytest
-        pytest_options = ["--import-mode", "importlib"]
-        if options.verbose:
-            pytest_options.append("-v")
-        exit_code_pytest = pytest.main(pytest_options + args)
-    except ModuleNotFoundError:
-        print("Pytest is not installed, skip checking tests that rely on it.")
+    exit_code_pytest = 0
+    if not args:
+        try:
+            import pytest
+            pytest_options = ["--import-mode", "importlib"]
+            if options.verbose:
+                pytest_options.append("-v")
+            exit_code_pytest = pytest.main(pytest_options + args)
+        except ModuleNotFoundError:
+            print("Pytest is not installed, skip checking tests that rely on it.")
```



---

archive/issue_comments_516498.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nDirectory arguments work fine, it's just regular file arguments that cause the trouble.",
    "created_at": "2021-07-02T16:48:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516498",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">Comment 4</div>

Directory arguments work fine, it's just regular file arguments that cause the trouble.



---

archive/issue_comments_516499.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nReplying to [@mkoeppe](#comment%3A4):\n> Directory arguments work fine, it's just regular file arguments that cause the trouble.\n\nI see! I will have a look at it next week!",
    "created_at": "2021-07-03T10:36:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516499",
    "user": "https://github.com/soehms"
}
```

<div id="comment:5" align="right">Comment 5</div>

Replying to [@mkoeppe](#comment%3A4):
> Directory arguments work fine, it's just regular file arguments that cause the trouble.

I see! I will have a look at it next week!



---

archive/issue_comments_516500.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nI think the problem is that in `pytest.main(pytest_options + args)` the argument `-t  src/sage/databases/*.py` is appended, but the correct format for pytest to only test a single file would be without the `-t`, i.e. `pytest src/sage/databases/*.py` should work.",
    "created_at": "2021-07-04T12:51:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516500",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:6" align="right">Comment 6</div>

I think the problem is that in `pytest.main(pytest_options + args)` the argument `-t  src/sage/databases/*.py` is appended, but the correct format for pytest to only test a single file would be without the `-t`, i.e. `pytest src/sage/databases/*.py` should work.



---

archive/issue_comments_516501.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nReplying to [@tobiasdiez](#comment%3A6):\n> I think the problem is that in `pytest.main(pytest_options + args)` the argument `-t  src/sage/databases/*.py` is appended, but the correct format for pytest to only test a single file would be without the `-t`, i.e. `pytest src/sage/databases/*.py` should work.\n\nI cannot verify this on my environment:\n\n\n```bash\n~/devel/sage$ ./local/bin/pytest src/sage/databases/knotinfo_db.py\n======================================================================================================================================== test session starts ========================================================================================================================================\nplatform linux -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\nrootdir: /home/sebastian/devel/sage/src, configfile: tox.ini\ncollected 0 items / 1 error\n\n============================================================================================================================================== ERRORS ===============================================================================================================================================\n__________________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py ___________________________________________________________________________________________________________________________\nImportError while importing test module '/home/sebastian/devel/sage/src/sage/databases/knotinfo_db.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\nlocal/lib/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\nsrc/sage/databases/knotinfo_db.py:31: in <module>\n    from sage.structure.sage_object import SageObject\nsrc/sage/structure/__init__.py:2: in <module>\n    import sage.structure.element\nE   ModuleNotFoundError: No module named 'sage.structure.element'\n====================================================================================================================================== short test summary info ======================================================================================================================================\nERROR src/sage/databases/knotinfo_db.py\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n========================================================================================================================================= 1 error in 0.29s ==========================================================================================================================================\n```",
    "created_at": "2021-07-06T10:36:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516501",
    "user": "https://github.com/soehms"
}
```

<div id="comment:7" align="right">Comment 7</div>

Replying to [@tobiasdiez](#comment%3A6):
> I think the problem is that in `pytest.main(pytest_options + args)` the argument `-t  src/sage/databases/*.py` is appended, but the correct format for pytest to only test a single file would be without the `-t`, i.e. `pytest src/sage/databases/*.py` should work.

I cannot verify this on my environment:


```bash
~/devel/sage$ ./local/bin/pytest src/sage/databases/knotinfo_db.py
======================================================================================================================================== test session starts ========================================================================================================================================
platform linux -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /home/sebastian/devel/sage/src, configfile: tox.ini
collected 0 items / 1 error

============================================================================================================================================== ERRORS ===============================================================================================================================================
__________________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py ___________________________________________________________________________________________________________________________
ImportError while importing test module '/home/sebastian/devel/sage/src/sage/databases/knotinfo_db.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
local/lib/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
src/sage/databases/knotinfo_db.py:31: in <module>
    from sage.structure.sage_object import SageObject
src/sage/structure/__init__.py:2: in <module>
    import sage.structure.element
E   ModuleNotFoundError: No module named 'sage.structure.element'
====================================================================================================================================== short test summary info ======================================================================================================================================
ERROR src/sage/databases/knotinfo_db.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
========================================================================================================================================= 1 error in 0.29s ==========================================================================================================================================
```



---

archive/issue_comments_516502.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nOkay, then I misread the exception message. Thanks for the investigation.\n\nSo the problem is that pytest doesn't find the compiled cython modules. I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in. Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest-dev/pytest/issues/2421#issuecomment-403724503",
    "created_at": "2021-07-06T10:52:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516502",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:8" align="right">Comment 8</div>

Okay, then I misread the exception message. Thanks for the investigation.

So the problem is that pytest doesn't find the compiled cython modules. I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in. Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest-dev/pytest/issues/2421#issuecomment-403724503



---

archive/issue_comments_516503.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@tobiasdiez](#comment%3A8):\n\n> So the problem is that pytest doesn't find the compiled cython modules.\n\nWhy does it find them for directory arguments?\n\n> I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in.\n\nHow can we achieve one of these options?\n\n> Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest- dev/pytest/issues/2421#issuecomment-403724503\n\nI don't think that it is worth to do that (citation from the comment: *And do not forget to remove this before publishing to PyPI*).",
    "created_at": "2021-07-07T08:38:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516503",
    "user": "https://github.com/soehms"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@tobiasdiez](#comment%3A8):

> So the problem is that pytest doesn't find the compiled cython modules.

Why does it find them for directory arguments?

> I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in.

How can we achieve one of these options?

> Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest- dev/pytest/issues/2421#issuecomment-403724503

I don't think that it is worth to do that (citation from the comment: *And do not forget to remove this before publishing to PyPI*).



---

archive/issue_comments_516504.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nReplying to [@soehms](#comment%3A9):\n> Replying to [@tobiasdiez](#comment%3A8):\n> \n> > So the problem is that pytest doesn't find the compiled cython modules.\n\n> \n> Why does it find them for directory arguments?\n\nGood question. I have no idea. Maybe the directory argument is in a wrong format so that pytest actually doesn't try to load any test files? \n\n> \n> > I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in.\n\n> \n> How can we achieve one of these options?\n\nThe editable install is possible since #31377 and should just work. I'm not familiar enough with the \"usual\" sage build to be able to recommend a solution that works with it. In the end, you need to specify the sage install directory as part of the PYTHON_PATH so that pytest is able to find the compiled cython modules. Maybe @mkoeppe has an idea.",
    "created_at": "2021-07-07T11:22:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516504",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:10" align="right">Comment 10</div>

Replying to [@soehms](#comment%3A9):
> Replying to [@tobiasdiez](#comment%3A8):
> 
> > So the problem is that pytest doesn't find the compiled cython modules.

> 
> Why does it find them for directory arguments?

Good question. I have no idea. Maybe the directory argument is in a wrong format so that pytest actually doesn't try to load any test files? 

> 
> > I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in.

> 
> How can we achieve one of these options?

The editable install is possible since #31377 and should just work. I'm not familiar enough with the "usual" sage build to be able to recommend a solution that works with it. In the end, you need to specify the sage install directory as part of the PYTHON_PATH so that pytest is able to find the compiled cython modules. Maybe @mkoeppe has an idea.



---

archive/issue_comments_516505.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nReplying to [@soehms](#comment%3A9):\n> Replying to [@tobiasdiez](#comment%3A8):\n> \n> > So the problem is that pytest doesn't find the compiled cython modules.\n\n> \n> Why does it find them for directory arguments?\n\nI don't think it does. What is happening, if I'm not mistaken, is simply that pytest, as configured in `src/tox.ini`, only runs for Python files matching the pattern `*_test.py`; modified with the exclusions declared in `src/conftest.py`. When you pass the names of individual Python files to it, the pattern matching is overridden.\n\nHence my suggestion of a workaround -- filter out Python file name arguments before passing them to pytest when invoked via `sage -t`.",
    "created_at": "2021-07-07T19:46:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516505",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">Comment 11</div>

Replying to [@soehms](#comment%3A9):
> Replying to [@tobiasdiez](#comment%3A8):
> 
> > So the problem is that pytest doesn't find the compiled cython modules.

> 
> Why does it find them for directory arguments?

I don't think it does. What is happening, if I'm not mistaken, is simply that pytest, as configured in `src/tox.ini`, only runs for Python files matching the pattern `*_test.py`; modified with the exclusions declared in `src/conftest.py`. When you pass the names of individual Python files to it, the pattern matching is overridden.

Hence my suggestion of a workaround -- filter out Python file name arguments before passing them to pytest when invoked via `sage -t`.



---

archive/issue_comments_516506.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nYes, that would work as a workaround. However, the underlying problem is still that pytest cannot find cython modules and I think this should be fixed as well (since otherwise you cannot have a pytest test file that has similar imports as knotinfo_db.py)",
    "created_at": "2021-07-07T21:02:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516506",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:12" align="right">Comment 12</div>

Yes, that would work as a workaround. However, the underlying problem is still that pytest cannot find cython modules and I think this should be fixed as well (since otherwise you cannot have a pytest test file that has similar imports as knotinfo_db.py)



---

archive/issue_comments_516507.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nReplying to [@tobiasdiez](#comment%3A12):\n> the underlying problem is still that pytest cannot find cython modules and I think this should be fixed as well (since otherwise you cannot have a pytest test file that has similar imports as knotinfo_db.py)\n\nYes, I agree, but that would be another ticket, as this is not \"critical\" for Sage 9.4.",
    "created_at": "2021-07-07T21:34:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516507",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">Comment 13</div>

Replying to [@tobiasdiez](#comment%3A12):
> the underlying problem is still that pytest cannot find cython modules and I think this should be fixed as well (since otherwise you cannot have a pytest test file that has similar imports as knotinfo_db.py)

Yes, I agree, but that would be another ticket, as this is not "critical" for Sage 9.4.



---

archive/issue_comments_516508.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nReplying to [@tobiasdiez](#comment%3A10):\n> The editable install is possible since #31377 and should just work. I'm not familiar enough with the \"usual\" sage build to be able to recommend a solution that works with it. In the end, you need to specify the sage install directory as part of the PYTHON_PATH so that pytest is able to find the compiled cython modules. Maybe @mkoeppe has an idea.\n\nAfter building Sage with `./configure --enable-editable` the issue still shows. What could I have done wrong?",
    "created_at": "2021-07-08T07:40:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516508",
    "user": "https://github.com/soehms"
}
```

<div id="comment:14" align="right">Comment 14</div>

Replying to [@tobiasdiez](#comment%3A10):
> The editable install is possible since #31377 and should just work. I'm not familiar enough with the "usual" sage build to be able to recommend a solution that works with it. In the end, you need to specify the sage install directory as part of the PYTHON_PATH so that pytest is able to find the compiled cython modules. Maybe @mkoeppe has an idea.

After building Sage with `./configure --enable-editable` the issue still shows. What could I have done wrong?



---

archive/issue_comments_516509.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nReplying to [@mkoeppe](#comment%3A11):\n> Replying to [@soehms](#comment%3A9):\n> > Replying to [@tobiasdiez](#comment%3A8):\n> > \n> > > So the problem is that pytest doesn't find the compiled cython modules.\n\n> > \n> > Why does it find them for directory arguments?\n\n> \n> I don't think it does. What is happening, if I'm not mistaken, is simply that pytest, as configured in `src/tox.ini`, only runs for Python files matching the pattern `*_test.py`; modified with the exclusions declared in `src/conftest.py`. When you pass the names of individual Python files to it, the pattern matching is overridden.\n> \n\nFirst, I thought the same. But, the following output made me doubt: `collected 0 items / 1 error`.\n\n\n\n> Hence my suggestion of a workaround -- filter out Python file name arguments before passing them to pytest when invoked via `sage -t`.\n> \n\n>\n\nPassing an empty argument list, causes an error, as well:\n\n```\n:~/devel/sage$ sage -t --new\nRunning doctests with ID 2021-07-08-09-15-06-93fe9beb.\nGit branch: develop\nUsing --optional=build,debian,dochtml,pip,sage,sage_spkg\nDoctesting files changed since last git commit\nNo files to doctest\n======================================================================================================================================== test session starts ========================================================================================================================================\nplatform linux -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\nrootdir: /home/sebastian/devel/sage\ncollected 0 items / 1 error\n\n============================================================================================================================================== ERRORS ===============================================================================================================================================\n___________________________________________________________________________________________________________________________________ ERROR collecting test session ___________________________________________________________________________________________________________________________________\nlocal/lib/python3.9/site-packages/IPython/conftest.py:9: in <module>\n    from .testing import tools\nE   ImportError: attempted relative import with no known parent package\n====================================================================================================================================== short test summary info ======================================================================================================================================\nERROR  - ImportError: attempted relative import with no known parent package\n```\n\nThe same output shows with `./local/bin/pytest --import-mode importlib`",
    "created_at": "2021-07-08T07:43:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516509",
    "user": "https://github.com/soehms"
}
```

<div id="comment:15" align="right">Comment 15</div>

Replying to [@mkoeppe](#comment%3A11):
> Replying to [@soehms](#comment%3A9):
> > Replying to [@tobiasdiez](#comment%3A8):
> > 
> > > So the problem is that pytest doesn't find the compiled cython modules.

> > 
> > Why does it find them for directory arguments?

> 
> I don't think it does. What is happening, if I'm not mistaken, is simply that pytest, as configured in `src/tox.ini`, only runs for Python files matching the pattern `*_test.py`; modified with the exclusions declared in `src/conftest.py`. When you pass the names of individual Python files to it, the pattern matching is overridden.
> 

First, I thought the same. But, the following output made me doubt: `collected 0 items / 1 error`.



> Hence my suggestion of a workaround -- filter out Python file name arguments before passing them to pytest when invoked via `sage -t`.
> 

>

Passing an empty argument list, causes an error, as well:

```
:~/devel/sage$ sage -t --new
Running doctests with ID 2021-07-08-09-15-06-93fe9beb.
Git branch: develop
Using --optional=build,debian,dochtml,pip,sage,sage_spkg
Doctesting files changed since last git commit
No files to doctest
======================================================================================================================================== test session starts ========================================================================================================================================
platform linux -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /home/sebastian/devel/sage
collected 0 items / 1 error

============================================================================================================================================== ERRORS ===============================================================================================================================================
___________________________________________________________________________________________________________________________________ ERROR collecting test session ___________________________________________________________________________________________________________________________________
local/lib/python3.9/site-packages/IPython/conftest.py:9: in <module>
    from .testing import tools
E   ImportError: attempted relative import with no known parent package
====================================================================================================================================== short test summary info ======================================================================================================================================
ERROR  - ImportError: attempted relative import with no known parent package
```

The same output shows with `./local/bin/pytest --import-mode importlib`



---

archive/issue_comments_516510.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nReplying to [@soehms](#comment%3A15):\n> Passing an empty argument list, causes an error, as well\n\nOK then, that's another case in which `sage -t` should not invoke pytest.",
    "created_at": "2021-07-08T14:25:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516510",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">Comment 16</div>

Replying to [@soehms](#comment%3A15):
> Passing an empty argument list, causes an error, as well

OK then, that's another case in which `sage -t` should not invoke pytest.



---

archive/issue_comments_516511.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nI would implement the workaround suggested in comment 11. But at the moment I'm sticking at the following question: What is the best way to share the pattern `*_test.py` between `src/tox.ini` and `sage-runtests`?",
    "created_at": "2021-07-12T08:22:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516511",
    "user": "https://github.com/soehms"
}
```

<div id="comment:17" align="right">Comment 17</div>

I would implement the workaround suggested in comment 11. But at the moment I'm sticking at the following question: What is the best way to share the pattern `*_test.py` between `src/tox.ini` and `sage-runtests`?



---

archive/issue_events_421930.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-11T22:19:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421930"
}
```



---

archive/issue_events_421931.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-11T22:19:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421931"
}
```



---

archive/issue_comments_516512.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nThinking about this again, I was wondering what is the desired behavior of the `-t <files>` argument?\nThe following seems reasonable to me:\n\n- If `<files>` is a folder, then test all \"testable\" files in that folder. Here \"testable\" takes e.g. the file extension (py, rst) into account; and also the pre-defined filter for pytest (`_test.py` ending).\n- If `<files>` is a path to a file (or a glob), then test exactly those files without taking the above \"testable\" criteria into account. One might argue that one should also intersect with \"testable\" but I guess its better to trust the user that he knows why he wants exactly these files to be tested.\n\nThis also seems to be the default behavior of `pytest` (i.e. run `pytest <files>` with either a folder or a fixed path). It also seems to be that sage-runtests is behaving exactly like this, so I don't know if the test discovery should really be changed.\n\nAccording to this point of view, the reported error is not really a problem with the pytest test discovery but more so an issue with loading these files as modules. If the import would work, pytest would try to find pytest tests in these files, which don't exist, so it would simply not collect anything.",
    "created_at": "2021-11-02T18:20:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516512",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:21" align="right">Comment 21</div>

Thinking about this again, I was wondering what is the desired behavior of the `-t <files>` argument?
The following seems reasonable to me:

- If `<files>` is a folder, then test all "testable" files in that folder. Here "testable" takes e.g. the file extension (py, rst) into account; and also the pre-defined filter for pytest (`_test.py` ending).
- If `<files>` is a path to a file (or a glob), then test exactly those files without taking the above "testable" criteria into account. One might argue that one should also intersect with "testable" but I guess its better to trust the user that he knows why he wants exactly these files to be tested.

This also seems to be the default behavior of `pytest` (i.e. run `pytest <files>` with either a folder or a fixed path). It also seems to be that sage-runtests is behaving exactly like this, so I don't know if the test discovery should really be changed.

According to this point of view, the reported error is not really a problem with the pytest test discovery but more so an issue with loading these files as modules. If the import would work, pytest would try to find pytest tests in these files, which don't exist, so it would simply not collect anything.



---

archive/issue_comments_516513.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nReplying to [@tobiasdiez](#comment%3A21):\n> According to this point of view, the reported error is not really a problem with the pytest test discovery but more so an issue with loading these files as modules. If the import would work, pytest would try to find pytest tests in these files, which don't exist, so it would simply not collect anything.\n\nTo you mean to replace relative import statements by absolute ones all over the source code? Would this solve the problem?\n\nBTW: Did you note that the `pytest` call in `sage-runtests` is broken since 9.5.beta3 (see [this comment](https://groups.google.com/g/sage-release/c/yd4qumrBbm0/m/oHEyfKSJAQAJ) in the according release management thread):\n\n```sage\nTraceback (most recent call last):\n  File \"/home/sebastian/devel/sage/src/bin/sage-runtests\", line 159, in <module>\n    exit_code_pytest = pytest.main(pytest_options + args)\nTypeError: can only concatenate list (not \"Namespace\") to list\n```\n\nProbably this is due to #32332.",
    "created_at": "2021-11-04T19:15:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516513",
    "user": "https://github.com/soehms"
}
```

<div id="comment:22" align="right">Comment 22</div>

Replying to [@tobiasdiez](#comment%3A21):
> According to this point of view, the reported error is not really a problem with the pytest test discovery but more so an issue with loading these files as modules. If the import would work, pytest would try to find pytest tests in these files, which don't exist, so it would simply not collect anything.

To you mean to replace relative import statements by absolute ones all over the source code? Would this solve the problem?

BTW: Did you note that the `pytest` call in `sage-runtests` is broken since 9.5.beta3 (see [this comment](https://groups.google.com/g/sage-release/c/yd4qumrBbm0/m/oHEyfKSJAQAJ) in the according release management thread):

```sage
Traceback (most recent call last):
  File "/home/sebastian/devel/sage/src/bin/sage-runtests", line 159, in <module>
    exit_code_pytest = pytest.main(pytest_options + args)
TypeError: can only concatenate list (not "Namespace") to list
```

Probably this is due to #32332.



---

archive/issue_comments_516514.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nI don't have much experience with relative imports and namespace imports. But yes, converting relative imports to absolute ones should fix the issue.",
    "created_at": "2021-11-17T21:32:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516514",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:23" align="right">Comment 23</div>

I don't have much experience with relative imports and namespace imports. But yes, converting relative imports to absolute ones should fix the issue.



---

archive/issue_comments_516515.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nI get a doctest failure in `src/sage/tests/cmdline.py` that seems to be related.\n\n```\nsage -t --random-seed=156938138878576468116341825690522372403 src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 325, in sage.tests.cmdline.test_executable\nFailed example:\n    ret\nExpected:\n    0\nGot:\n    4\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 330, in sage.tests.cmdline.test_executable\nFailed example:\n    ret\nExpected:\n    0\nGot:\n    5\n**********************************************************************\n1 item had failures:\n   2 of 221 in sage.tests.cmdline.test_executable\n    [220 tests, 2 failures, 48.13 s]\n----------------------------------------------------------------------\n```\n\nThe second failure gets fixed after #32892 but not the first one.\n\nHere's a standalone example of the issue:\n\n```\n$ cat my_script.sage                                             \n# -*- coding: utf-8 -*-\n'''This is a test file.\nAnd I am its doctest'''\ndef my_add(a):\n    '''\n    Add 2 to a.\n\n        EXAMPLES::\n\n            sage: my_add(2)\n            4\n        '''\n    return a + 2\n$ ./sage -t my_script.sage ; echo $?                             \nRunning doctests with ID 2021-11-22-16-48-40-b731cf3e.\nGit branch: develop\nUsing --optional=build,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg,void\nDoctesting 1 file.\nsage -t --warn-long 36.1 --random-seed=215445574591070240478383051094230654766 my_script.sage\n    [1 test, 0.00 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.0 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n============================================================================ test session starts =============================================================================\nplatform linux -- Python 3.9.7, pytest-6.2.5, py-1.10.0, pluggy-1.0.0\nrootdir: /usr/lib/sage-9.5.beta7\ncollected 0 items                                                                                                                                                            \n\n=========================================================================== no tests ran in 0.00s ============================================================================\nERROR: not found: /usr/lib/sage-9.5.beta7/my_script.sage\n(no name '/usr/lib/sage-9.5.beta7/my_script.sage' in any of [])\n\n4\n```\n\nWhat I think is going on: pytest is called by\n\n```\nexit_code_pytest = pytest.main(pytest_options + args.filenames)\n```\nwhere `args.filenames = ['my_script.sage']`. But pytest is skipping `my_script.sage` since it doesn't match patterns `*.py`, `*.txt` or `*.rst` (or something like that). That's the reason for the \"ERROR: not found\" in there, and the error code is 4 (pytest command line usage error).\n\nI don't know what's a proper way to fix this. Maybe filter out the list of files in `args.filenames` so that only the files that pytest likes get through (not `*.sage`, anyway). Warning: when `args.filenames` is not empty but it becomes empty after filtering, the call to pytest must be skipped otherwise pytest just tests everything recursively, which is not what we want.",
    "created_at": "2021-11-22T17:03:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516515",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:24" align="right">Comment 24</div>

I get a doctest failure in `src/sage/tests/cmdline.py` that seems to be related.

```
sage -t --random-seed=156938138878576468116341825690522372403 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 325, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    4
**********************************************************************
File "src/sage/tests/cmdline.py", line 330, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    5
**********************************************************************
1 item had failures:
   2 of 221 in sage.tests.cmdline.test_executable
    [220 tests, 2 failures, 48.13 s]
----------------------------------------------------------------------
```

The second failure gets fixed after #32892 but not the first one.

Here's a standalone example of the issue:

```
$ cat my_script.sage                                             
# -*- coding: utf-8 -*-
'''This is a test file.
And I am its doctest'''
def my_add(a):
    '''
    Add 2 to a.

        EXAMPLES::

            sage: my_add(2)
            4
        '''
    return a + 2
$ ./sage -t my_script.sage ; echo $?                             
Running doctests with ID 2021-11-22-16-48-40-b731cf3e.
Git branch: develop
Using --optional=build,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg,void
Doctesting 1 file.
sage -t --warn-long 36.1 --random-seed=215445574591070240478383051094230654766 my_script.sage
    [1 test, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
============================================================================ test session starts =============================================================================
platform linux -- Python 3.9.7, pytest-6.2.5, py-1.10.0, pluggy-1.0.0
rootdir: /usr/lib/sage-9.5.beta7
collected 0 items                                                                                                                                                            

=========================================================================== no tests ran in 0.00s ============================================================================
ERROR: not found: /usr/lib/sage-9.5.beta7/my_script.sage
(no name '/usr/lib/sage-9.5.beta7/my_script.sage' in any of [])

4
```

What I think is going on: pytest is called by

```
exit_code_pytest = pytest.main(pytest_options + args.filenames)
```
where `args.filenames = ['my_script.sage']`. But pytest is skipping `my_script.sage` since it doesn't match patterns `*.py`, `*.txt` or `*.rst` (or something like that). That's the reason for the "ERROR: not found" in there, and the error code is 4 (pytest command line usage error).

I don't know what's a proper way to fix this. Maybe filter out the list of files in `args.filenames` so that only the files that pytest likes get through (not `*.sage`, anyway). Warning: when `args.filenames` is not empty but it becomes empty after filtering, the call to pytest must be skipped otherwise pytest just tests everything recursively, which is not what we want.



---

archive/issue_comments_516516.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nReplying to [@tobiasdiez](#comment%3A23):\n> I don't have much experience with relative imports and namespace imports. But yes, converting relative imports to absolute ones should fix the issue.\n\nSounds like we should make a script that replaces all relative import statements by an absolute one (all over the source tree). Are we sure that there are no such import statement being intentional (by whatever reason)?",
    "created_at": "2021-11-30T17:01:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516516",
    "user": "https://github.com/soehms"
}
```

<div id="comment:25" align="right">Comment 25</div>

Replying to [@tobiasdiez](#comment%3A23):
> I don't have much experience with relative imports and namespace imports. But yes, converting relative imports to absolute ones should fix the issue.

Sounds like we should make a script that replaces all relative import statements by an absolute one (all over the source tree). Are we sure that there are no such import statement being intentional (by whatever reason)?



---

archive/issue_comments_516517.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nReplying to [@tornaria](#comment%3A24):\n> I don't know what's a proper way to fix this. Maybe filter out the list of files in `args.filenames` so that only the files that pytest likes get through (not `*.sage`, anyway). Warning: when `args.filenames` is not empty but it becomes empty after filtering, the call to pytest must be skipped otherwise pytest just tests everything recursively, which is not what we want.\n\nWhat is the difference to the suggestion made in [comment:11](#comment%3A11) ff? Do you have a hint to the question I asked in [comment:17](#comment%3A17) ?",
    "created_at": "2021-11-30T17:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516517",
    "user": "https://github.com/soehms"
}
```

<div id="comment:26" align="right">Comment 26</div>

Replying to [@tornaria](#comment%3A24):
> I don't know what's a proper way to fix this. Maybe filter out the list of files in `args.filenames` so that only the files that pytest likes get through (not `*.sage`, anyway). Warning: when `args.filenames` is not empty but it becomes empty after filtering, the call to pytest must be skipped otherwise pytest just tests everything recursively, which is not what we want.

What is the difference to the suggestion made in [comment:11](#comment%3A11) ff? Do you have a hint to the question I asked in [comment:17](#comment%3A17) ?



---

archive/issue_comments_516518.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nReplying to [@soehms](#comment%3A26):\n> What is the difference to the suggestion made in [comment:11](#comment%3A11) ff?\n\nI don't see any difference.\n\n\n> Do you have a hint to the question I asked in [comment:17](#comment%3A17) ?\n\nNo idea.\n\nI only installed pytest because of this message at the end of testing: \"Pytest is not installed, skip checking tests that rely on it.\" I've since learned that I shouldn't. Maybe it's better to remove this warning until this is fixed? AFAICT there are very few tests (if any) that require pytest.",
    "created_at": "2021-11-30T17:29:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516518",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:27" align="right">Comment 27</div>

Replying to [@soehms](#comment%3A26):
> What is the difference to the suggestion made in [comment:11](#comment%3A11) ff?

I don't see any difference.


> Do you have a hint to the question I asked in [comment:17](#comment%3A17) ?

No idea.

I only installed pytest because of this message at the end of testing: "Pytest is not installed, skip checking tests that rely on it." I've since learned that I shouldn't. Maybe it's better to remove this warning until this is fixed? AFAICT there are very few tests (if any) that require pytest.



---

archive/issue_comments_516519.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">Comment 28</div>\n\nReplying to [@tobiasdiez](#comment%3A8):\n> Okay, then I misread the exception message. Thanks for the investigation.\n> \n> So the problem is that pytest doesn't find the compiled cython modules. I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in. Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest-dev/pytest/issues/2421#issuecomment-403724503\n\nthere is `pytest-cython` which allows one to run `pytest` on cython files, like\n`pytest --doctest-cython ...` - I found out about it while working on #25009, which led to\nhttps://github.com/dimpase/primecountpy\n(to be moved to https://github.com/sagemath/primecountpy later).",
    "created_at": "2021-11-30T20:12:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516519",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:28" align="right">Comment 28</div>

Replying to [@tobiasdiez](#comment%3A8):
> Okay, then I misread the exception message. Thanks for the investigation.
> 
> So the problem is that pytest doesn't find the compiled cython modules. I think the common advice is to use the editable install. Another solution that might work is to install and run pytest from the same virtual environment where sage is installed in. Finally, there are some hacks to add the sage path in `sys.path` as outlined here: https://github.com/pytest-dev/pytest/issues/2421#issuecomment-403724503

there is `pytest-cython` which allows one to run `pytest` on cython files, like
`pytest --doctest-cython ...` - I found out about it while working on #25009, which led to
https://github.com/dimpase/primecountpy
(to be moved to https://github.com/sagemath/primecountpy later).



---

archive/issue_comments_516520.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nbump to 9.6",
    "created_at": "2022-01-29T08:58:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516520",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:29" align="right">Comment 29</div>

bump to 9.6



---

archive/issue_events_421932.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2022-01-29T08:58:50Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421932"
}
```



---

archive/issue_events_421933.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2022-01-29T08:58:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421933"
}
```



---

archive/issue_comments_516521.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nThis issue should be fixed by #32975.",
    "created_at": "2022-02-01T18:18:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516521",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:30" align="right">Comment 30</div>

This issue should be fixed by #32975.



---

archive/issue_comments_516522.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\n... which is stalled in \"needs_work\".",
    "created_at": "2022-03-19T17:19:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516522",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:31" align="right">Comment 31</div>

... which is stalled in "needs_work".



---

archive/issue_comments_516523.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">Comment 32</div>\n\nReplying to [@tobiasdiez](#comment%3A30):\n> This issue should be fixed by #32975.\n\nThat ticket seems completely unrelated to the issue here.",
    "created_at": "2022-03-19T18:26:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516523",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:32" align="right">Comment 32</div>

Replying to [@tobiasdiez](#comment%3A30):
> This issue should be fixed by #32975.

That ticket seems completely unrelated to the issue here.



---

archive/issue_comments_516524.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">Comment 33</div>\n\nI don't exactly remember why #32975 fixes this issue, but for me the command from the ticket description works on top of that ticket. I think the problem was the `collect_ignore` patterns in the test config that has been removed in #32975.",
    "created_at": "2022-03-20T12:34:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516524",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:33" align="right">Comment 33</div>

I don't exactly remember why #32975 fixes this issue, but for me the command from the ticket description works on top of that ticket. I think the problem was the `collect_ignore` patterns in the test config that has been removed in #32975.



---

archive/issue_comments_516525.json:
```json
{
    "body": "Dependencies: **#32975**",
    "created_at": "2022-03-20T18:40:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516525",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#32975**



---

archive/issue_comments_516526.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">Comment 35</div>\n\nWith #32975, the failures in the ticket description are fixed.",
    "created_at": "2022-03-20T18:48:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516526",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:35" align="right">Comment 35</div>

With #32975, the failures in the ticket description are fixed.



---

archive/issue_comments_516527.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">Comment 36</div>\n\nHowever, related to [comment:24](#comment%3A24):\n\n```\n$ ./sage -tp src/sage/tests/cmdline.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2022-03-20-11-46-21-1dc8fb11.\nUsing --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg,texttable\nFeatures to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\nDoctesting 1 file using 8 threads.\nsage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 312, in sage.tests.cmdline.test_executable\nFailed example:\n    ret\nExpected:\n    0\nGot:\n    4\n**********************************************************************\n1 item had failures:\n   1 of 218 in sage.tests.cmdline.test_executable\n    [217 tests, 1 failure, 67.30 s]\n----------------------------------------------------------------------\nsage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 67.4 seconds\n    cpu time: 0.3 seconds\n    cumulative wall time: 67.3 seconds\nFeatures detected for doctesting: pandoc\n=================================================================================== test session starts ===================================================================================\nplatform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0\nrootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\ncollected 1 item                                                                                                                                                                          \n\nsrc/sage/tests/cmdline.py E                                                                                                                                                         [100%]\n\n========================================================================================= ERRORS ==========================================================================================\n____________________________________________________________________________ ERROR at setup of test_executable ____________________________________________________________________________\nfile /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py, line 61\n  def test_executable(args, input=\"\", timeout=100.0, pydebug_ignore_warnings=False, **kwds):\nE       fixture 'args' not found\n>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py:61\n================================================================================= short test summary info =================================================================================\nERROR src/sage/tests/cmdline.py::test_executable\n==================================================================================== 1 error in 0.01s =====================================================================================\n```",
    "created_at": "2022-03-20T18:49:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516527",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">Comment 36</div>

However, related to [comment:24](#comment%3A24):

```
$ ./sage -tp src/sage/tests/cmdline.py
too many failed tests, not using stored timings
Running doctests with ID 2022-03-20-11-46-21-1dc8fb11.
Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg,texttable
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 1 file using 8 threads.
sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 312, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    4
**********************************************************************
1 item had failures:
   1 of 218 in sage.tests.cmdline.test_executable
    [217 tests, 1 failure, 67.30 s]
----------------------------------------------------------------------
sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 67.4 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 67.3 seconds
Features detected for doctesting: pandoc
=================================================================================== test session starts ===================================================================================
platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
collected 1 item                                                                                                                                                                          

src/sage/tests/cmdline.py E                                                                                                                                                         [100%]

========================================================================================= ERRORS ==========================================================================================
____________________________________________________________________________ ERROR at setup of test_executable ____________________________________________________________________________
file /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py, line 61
  def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False, **kwds):
E       fixture 'args' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py:61
================================================================================= short test summary info =================================================================================
ERROR src/sage/tests/cmdline.py::test_executable
==================================================================================== 1 error in 0.01s =====================================================================================
```



---

archive/issue_comments_516528.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">Comment 37</div>\n\nNot sure how to approach fixing the error that pytesting `tests/cmdline.py` is not working.\nWhat is happening here is the following:\n- The `-t` argument overwrites pytests check that test files have to end on `_test.py` (this is expected behavior and is needed if you want to run pytests specified in a custom test file)\n- Pytest is then searching for test methods in `cmdline.py` and finds `test_executable` as, by default, pytest will consider any function prefixed with test as a test.\n\nWould it be okay to rename `test_executable` to say `run_executable` so that it is no longer discovered by pytest?",
    "created_at": "2022-03-20T19:01:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516528",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:37" align="right">Comment 37</div>

Not sure how to approach fixing the error that pytesting `tests/cmdline.py` is not working.
What is happening here is the following:
- The `-t` argument overwrites pytests check that test files have to end on `_test.py` (this is expected behavior and is needed if you want to run pytests specified in a custom test file)
- Pytest is then searching for test methods in `cmdline.py` and finds `test_executable` as, by default, pytest will consider any function prefixed with test as a test.

Would it be okay to rename `test_executable` to say `run_executable` so that it is no longer discovered by pytest?



---

archive/issue_comments_516529.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">Comment 38</div>\n\n`$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.",
    "created_at": "2022-03-20T19:04:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516529",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">Comment 38</div>

`$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.



---

archive/issue_comments_516530.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">Comment 39</div>\n\nI think this really needs the change that the ticket title says: \"sage -t: Do not run pytest on individual files\"\n(... unless they match the pytest file pattern...)",
    "created_at": "2022-03-20T19:06:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516530",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:39" align="right">Comment 39</div>

I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files"
(... unless they match the pytest file pattern...)



---

archive/issue_events_421934.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-20T19:10:56Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "title_is": "sage -t: Do not run pytest on individual Python files unless they match the pytest file pattern",
    "title_was": "sage -t: Do not run pytest on individual files",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421934"
}
```



---

archive/issue_comments_516531.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">Comment 41</div>\n\nReplying to [@mkoeppe](#comment%3A38):\n> `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.\n\nYeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.\n\n> I think this really needs the change that the ticket title says: \"sage -t: Do not run pytest on individual files\" (... unless they match the pytest file pattern...) \n\nI'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.",
    "created_at": "2022-03-20T19:37:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516531",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:41" align="right">Comment 41</div>

Replying to [@mkoeppe](#comment%3A38):
> `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.

Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.

> I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 

I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.



---

archive/issue_comments_516532.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">Comment 42</div>\n\nReplying to [@tobiasdiez](#comment%3A41):\n> Replying to [@mkoeppe](#comment%3A38):\n> > `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.\n\n> \n> Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.\n\nIf skipping is done with the pytest decorators, we would somehow have to have a version of this decorator that becomes a no-op if pytest is not installed.",
    "created_at": "2022-03-20T20:09:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516532",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:42" align="right">Comment 42</div>

Replying to [@tobiasdiez](#comment%3A41):
> Replying to [@mkoeppe](#comment%3A38):
> > `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.

> 
> Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.

If skipping is done with the pytest decorators, we would somehow have to have a version of this decorator that becomes a no-op if pytest is not installed.



---

archive/issue_comments_516533.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">Comment 43</div>\n\nReplying to [@tobiasdiez](#comment%3A41):\n> Replying to [@mkoeppe](#comment%3A38):\n> > `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.\n\n> \n> Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.\n\nI think it's fine to rename them if they are only used by doctests in the same module.\nThen we might argue that it was not really intended to be in the public interface and should have been named `_test...`.",
    "created_at": "2022-03-20T20:13:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516533",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:43" align="right">Comment 43</div>

Replying to [@tobiasdiez](#comment%3A41):
> Replying to [@mkoeppe](#comment%3A38):
> > `$ git grep '^def test' src/sage` reveals lots of files that would need changing. I think we need a better solution than that.

> 
> Yeah, there are quite a few but also not sooo super many (around 60 hits). One could also skip these methods, https://docs.pytest.org/en/6.2.x/skipping.html#skip.

I think it's fine to rename them if they are only used by doctests in the same module.
Then we might argue that it was not really intended to be in the public interface and should have been named `_test...`.



---

archive/issue_comments_516534.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">Comment 45</div>\n\nReplying to [@tobiasdiez](#comment%3A41):\n> > I think this really needs the change that the ticket title says: \"sage -t: Do not run pytest on individual files\" (... unless they match the pytest file pattern...) \n\n> \n> I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.\n\nThat's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as \"critical\" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.",
    "created_at": "2022-03-21T23:29:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516534",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:45" align="right">Comment 45</div>

Replying to [@tobiasdiez](#comment%3A41):
> > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 

> 
> I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.

That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.



---

archive/issue_comments_516535.json:
```json
{
    "body": "Branch: **[u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern)**",
    "created_at": "2022-03-21T23:41:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516535",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern)**



---

archive/issue_comments_516536.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2022-03-21T23:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516536",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_516537.json:
```json
{
    "body": "Commit: **[16c1b69](https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d)**",
    "created_at": "2022-03-21T23:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516537",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[16c1b69](https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d)**



---

archive/issue_comments_516538.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">Comment 47</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5851f010757ba0ed077cdc0e14449a93f697865b\">5851f01</a></td><td><code>Improve doctest interaction with pytest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e7177158b7a24826a449d61cd79266a58298fca7\">e717715</a></td><td><code>Merge remote-tracking branch 'origin/develop' into public/tests/doctests_pytest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9c5d5a9af0c0c217b480dea16048758796548186\">9c5d5a9</a></td><td><code>Fix docs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0c7bf1711fbb4647072d225980f9fe011d419306\">0c7bf17</a></td><td><code>Add documentation for test:pytest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/01f376c26194faa54a219a4f0ed562ba525f19de\">01f376c</a></td><td><code>Use endswith to test for pytest files</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/54e93141ee348389a30e00736c076541b93e07eb\">54e9314</a></td><td><code>Merge #32975</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d\">16c1b69</a></td><td><code>src/bin/sage-runtests: Do not run pytest on individual Python files unless they match the pytest file pattern</code></td></tr></table>\n",
    "created_at": "2022-03-21T23:41:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516538",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:47" align="right">Comment 47</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5851f010757ba0ed077cdc0e14449a93f697865b">5851f01</a></td><td><code>Improve doctest interaction with pytest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e7177158b7a24826a449d61cd79266a58298fca7">e717715</a></td><td><code>Merge remote-tracking branch 'origin/develop' into public/tests/doctests_pytest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9c5d5a9af0c0c217b480dea16048758796548186">9c5d5a9</a></td><td><code>Fix docs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0c7bf1711fbb4647072d225980f9fe011d419306">0c7bf17</a></td><td><code>Add documentation for test:pytest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/01f376c26194faa54a219a4f0ed562ba525f19de">01f376c</a></td><td><code>Use endswith to test for pytest files</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/54e93141ee348389a30e00736c076541b93e07eb">54e9314</a></td><td><code>Merge #32975</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d">16c1b69</a></td><td><code>src/bin/sage-runtests: Do not run pytest on individual Python files unless they match the pytest file pattern</code></td></tr></table>




---

archive/issue_events_421935.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-21T23:41:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421935"
}
```



---

archive/issue_comments_516539.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">Comment 48</div>\n\nReplying to [@mkoeppe](#comment%3A45):\n> Replying to [@tobiasdiez](#comment%3A41):\n> > The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.\n\n> \n> That's fine to keep in mind for the long term.\n\nI've opened #33546 so that we don't forget.",
    "created_at": "2022-03-21T23:57:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516539",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:48" align="right">Comment 48</div>

Replying to [@mkoeppe](#comment%3A45):
> Replying to [@tobiasdiez](#comment%3A41):
> > The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.

> 
> That's fine to keep in mind for the long term.

I've opened #33546 so that we don't forget.



---

archive/issue_comments_516540.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">Comment 49</div>\n\nLooks good to me, I will test and report back.\n\nI assume I only have to test the last commit ([16c1b69](https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d)) since the other commits have been tested (and indeed already merged) as part of #32975.",
    "created_at": "2022-03-22T00:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516540",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:49" align="right">Comment 49</div>

Looks good to me, I will test and report back.

I assume I only have to test the last commit ([16c1b69](https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d)) since the other commits have been tested (and indeed already merged) as part of #32975.



---

archive/issue_comments_516541.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">Comment 50</div>\n\nYes",
    "created_at": "2022-03-22T00:22:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516541",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:50" align="right">Comment 50</div>

Yes



---

archive/issue_comments_516542.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">Comment 51</div>\n\nMmmmm... why this:\n\n```python\n        filenames = [f for f in args.filenames\n                     if f.endswith(\"_test.py\") or not f.endswith(\".py\")]\n```\ninstead of just\n\n```python\n        filenames = [f for f in args.filenames if f.endswith(\"_test.py\")]\n```\n\nWe only want to run pytest on `*_test.py`files, right? What am I missing?",
    "created_at": "2022-03-22T00:29:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516542",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:51" align="right">Comment 51</div>

Mmmmm... why this:

```python
        filenames = [f for f in args.filenames
                     if f.endswith("_test.py") or not f.endswith(".py")]
```
instead of just

```python
        filenames = [f for f in args.filenames if f.endswith("_test.py")]
```

We only want to run pytest on `*_test.py`files, right? What am I missing?



---

archive/issue_comments_516543.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">Comment 52</div>\n\nWe also want to run it on directory names.",
    "created_at": "2022-03-22T00:31:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516543",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:52" align="right">Comment 52</div>

We also want to run it on directory names.



---

archive/issue_comments_516544.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">Comment 53</div>\n\nReplying to [@mkoeppe](#comment%3A52):\n> We also want to run it on directory names.\n\nSure, but not on `*.pyx`, `*.pxd`, `*.rst`, etc.",
    "created_at": "2022-03-22T01:44:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516544",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:53" align="right">Comment 53</div>

Replying to [@mkoeppe](#comment%3A52):
> We also want to run it on directory names.

Sure, but not on `*.pyx`, `*.pxd`, `*.rst`, etc.



---

archive/issue_comments_516545.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">Comment 54</div>\n\nYes, I have a better version in a second",
    "created_at": "2022-03-22T01:44:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516545",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:54" align="right">Comment 54</div>

Yes, I have a better version in a second



---

archive/issue_comments_516546.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">Comment 55</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/119a89a686c247376b11aed4dcc253822287fa58\">119a89a</a></td><td><code>src/bin/sage-runtests: Do not run pytest on *.pyx, *.pxd, *.rst, etc.</code></td></tr></table>\n",
    "created_at": "2022-03-22T01:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516546",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:55" align="right">Comment 55</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/119a89a686c247376b11aed4dcc253822287fa58">119a89a</a></td><td><code>src/bin/sage-runtests: Do not run pytest on *.pyx, *.pxd, *.rst, etc.</code></td></tr></table>




---

archive/issue_comments_516547.json:
```json
{
    "body": "Changed commit from **[16c1b69](https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d)** to **[119a89a](https://github.com/sagemath/sagetrac-mirror/commit/119a89a686c247376b11aed4dcc253822287fa58)**",
    "created_at": "2022-03-22T01:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516547",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[16c1b69](https://github.com/sagemath/sagetrac-mirror/commit/16c1b69fb9960c361119039bde5bc99fd892ca5d)** to **[119a89a](https://github.com/sagemath/sagetrac-mirror/commit/119a89a686c247376b11aed4dcc253822287fa58)**



---

archive/issue_comments_516548.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">Comment 56</div>\n\nI was thinking something like this (untested):\n\n```\nfilenames = [src.path for src in DC.sources if src.path.endswith(\"_test.py\")]\n```\n\nDo you see any drawback?",
    "created_at": "2022-03-22T02:21:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516548",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:56" align="right">Comment 56</div>

I was thinking something like this (untested):

```
filenames = [src.path for src in DC.sources if src.path.endswith("_test.py")]
```

Do you see any drawback?



---

archive/issue_comments_516549.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">Comment 57</div>\n\nI prefer the version in which pytest is in charge of the discovery within directories.",
    "created_at": "2022-03-22T02:33:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516549",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:57" align="right">Comment 57</div>

I prefer the version in which pytest is in charge of the discovery within directories.



---

archive/issue_events_421936.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-22T07:59:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421936"
}
```



---

archive/issue_events_421937.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-22T07:59:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421937"
}
```



---

archive/issue_comments_516550.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,132 +1,51 @@\n-pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:\n+pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test methods, which are then executed. However, sage's code base contains some methods in its codebase that match this pattern without being pytests.\n+\n+This leads to problems like\n \n ```\n-$ ./sage -t  src/sage/databases/*.py \n+$ ./sage -tp src/sage/tests/cmdline.py\n too many failed tests, not using stored timings\n-Running doctests with ID 2021-06-07-11-04-14-3c1f8784.\n-Using --optional=4ti2,bliss,build,database_knotinfo,dochtml,e_antic,homebrew,jupymake,latte_int,lidia,lrslib,normaliz,pip,sage,sage_spkg\n-Doctesting 16 files.\n-sage -t --random-seed=0 src/sage/databases/__init__.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=0 src/sage/databases/all.py\n-    [5 tests, 0.10 s]\n-sage -t --random-seed=0 src/sage/databases/conway.py\n-    [42 tests, 0.10 s]\n-sage -t --random-seed=0 src/sage/databases/cremona.py\n-    [133 tests, 0.31 s]\n-sage -t --random-seed=0 src/sage/databases/cunningham_tables.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=0 src/sage/databases/db_class_polynomials.py\n-    [7 tests, 0.01 s]\n-sage -t --random-seed=0 src/sage/databases/db_modular_polynomials.py\n-    [13 tests, 0.01 s]\n-sage -t --random-seed=0 src/sage/databases/findstat.py\n-    [122 tests, 0.25 s]\n-sage -t --random-seed=0 src/sage/databases/jones.py\n-    [8 tests, 0.05 s]\n-sage -t --random-seed=0 src/sage/databases/knotinfo_db.py\n-    [97 tests, 1.80 s]\n-sage -t --random-seed=0 src/sage/databases/odlyzko.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=0 src/sage/databases/oeis.py\n-    [134 tests, 0.91 s]\n-sage -t --random-seed=0 src/sage/databases/sloane.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=0 src/sage/databases/sql_db.py\n-    [293 tests, 0.27 s]\n-sage -t --random-seed=0 src/sage/databases/stein_watkins.py\n-    [12 tests, 0.01 s]\n-sage -t --random-seed=0 src/sage/databases/symbolic_data.py\n-    [0 tests, 0.00 s]\n+Running doctests with ID 2022-03-20-11-46-21-1dc8fb11.\n+Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg,texttable\n+Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\n+Doctesting 1 file using 8 threads.\n+sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py\n+**********************************************************************\n+File \"src/sage/tests/cmdline.py\", line 312, in sage.tests.cmdline.test_executable\n+Failed example:\n+    ret\n+Expected:\n+    0\n+Got:\n+    4\n+**********************************************************************\n+1 item had failures:\n+   1 of 218 in sage.tests.cmdline.test_executable\n+    [217 tests, 1 failure, 67.30 s]\n ----------------------------------------------------------------------\n-All tests passed!\n+sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py  # 1 doctest failed\n ----------------------------------------------------------------------\n-Total time for all tests: 4.6 seconds\n-    cpu time: 3.9 seconds\n-    cumulative wall time: 3.8 seconds\n-============================================================================== test session starts ===============================================================================\n-platform darwin -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\n+Total time for all tests: 67.4 seconds\n+    cpu time: 0.3 seconds\n+    cumulative wall time: 67.3 seconds\n+Features detected for doctesting: pandoc\n+=================================================================================== test session starts ===================================================================================\n+platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0\n rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\n-collected 0 items / 7 errors                                                                                                                                                     \n+collected 1 item                                                                                                                                                                          \n \n-===================================================================================== ERRORS =====================================================================================\n-_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________\n-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.\n-Hint: make sure your test modules/packages have valid Python names.\n-Traceback:\n-src/sage/databases/all.py:51: in <module>\n-    from .sql_db import SQLQuery, SQLDatabase\n-E   ImportError: attempted relative import with no known parent package\n-_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________\n-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.\n-Hint: make sure your test modules/packages have valid Python names.\n-Traceback:\n-src/sage/databases/all.py:51: in <module>\n-    from .sql_db import SQLQuery, SQLDatabase\n-E   ImportError: attempted relative import with no known parent package\n-___________________________________________________________________ ERROR collecting sage/databases/cremona.py ___________________________________________________________________\n-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/cremona.py'.\n-Hint: make sure your test modules/packages have valid Python names.\n-Traceback:\n-src/sage/databases/cremona.py:52: in <module>\n-    from .sql_db import SQLDatabase, verify_column\n-E   ImportError: attempted relative import with no known parent package\n-____________________________________________________________ ERROR collecting sage/databases/db_class_polynomials.py _____________________________________________________________\n-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/db_class_polynomials.py'.\n-Hint: make sure your test modules/packages have valid Python names.\n-Traceback:\n-src/sage/databases/db_class_polynomials.py:14: in <module>\n-    from .db_modular_polynomials import _dbz_to_integers\n-E   ImportError: attempted relative import with no known parent package\n-__________________________________________________________________ ERROR collecting sage/databases/findstat.py ___________________________________________________________________\n-src/sage/databases/findstat.py:329: in <module>\n-    class FindStat(UniqueRepresentation, SageObject):\n-sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n-    ???\n-E   KeyError: 'findstat'\n-_________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _________________________________________________________________\n-src/sage/databases/knotinfo_db.py:330: in <module>\n-    class KnotInfoDataBase(SageObject, UniqueRepresentation):\n-sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n-    ???\n-E   KeyError: 'knotinfo_db'\n-____________________________________________________________________ ERROR collecting sage/databases/oeis.py _____________________________________________________________________\n-src/sage/databases/oeis.py:651: in <module>\n-    class OEISSequence(SageObject, UniqueRepresentation):\n-sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n-    ???\n-E   KeyError: 'oeis'\n-============================================================================ short test summary info =============================================================================\n-ERROR src/sage/databases/all.py\n-ERROR src/sage/databases/all.py\n-ERROR src/sage/databases/cremona.py\n-ERROR src/sage/databases/db_class_polynomials.py\n-ERROR src/sage/databases/findstat.py - KeyError: 'findstat'\n-ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'\n-ERROR src/sage/databases/oeis.py - KeyError: 'oeis'\n-!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n+src/sage/tests/cmdline.py E                                                                                                                                                         [100%]\n+\n+========================================================================================= ERRORS ==========================================================================================\n+____________________________________________________________________________ ERROR at setup of test_executable ____________________________________________________________________________\n+file /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py, line 61\n+  def test_executable(args, input=\"\", timeout=100.0, pydebug_ignore_warnings=False, **kwds):\n+E       fixture 'args' not found\n+>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory\n+>       use 'pytest --fixtures [testpath]' for help on them.\n+\n+/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py:61\n+================================================================================= short test summary info =================================================================================\n+ERROR src/sage/tests/cmdline.py::test_executable\n+==================================================================================== 1 error in 0.01s =====================================================================================\n ```\n-\n-Related report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:\n-\n-```\n-=============================================================== ERRORS\n-================================================================\n-_________________________________________ ERROR collecting\n-sage/structure/sage_object_test.py\n-_________________________________________\n-ImportError while importing test module\n-'/home/john/sage/src/sage/structure/sage_object_test.py'.\n-Hint: make sure your test modules/packages have valid Python names.\n-Traceback:\n-src/sage/structure/sage_object_test.py:3: in <module>\n-from .sage_object import SageObject\n-E ImportError: attempted relative import with no known parent package\n-======================================================= short test\n-summary info =======================================================\n-ERROR src/sage/structure/sage_object_test.py\n-!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error\n-during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n-```\n-\n-\n``````\n",
    "created_at": "2022-03-22T07:59:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516550",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,132 +1,51 @@
-pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:
+pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test methods, which are then executed. However, sage's code base contains some methods in its codebase that match this pattern without being pytests.
+
+This leads to problems like
 
 ```
-$ ./sage -t  src/sage/databases/*.py 
+$ ./sage -tp src/sage/tests/cmdline.py
 too many failed tests, not using stored timings
-Running doctests with ID 2021-06-07-11-04-14-3c1f8784.
-Using --optional=4ti2,bliss,build,database_knotinfo,dochtml,e_antic,homebrew,jupymake,latte_int,lidia,lrslib,normaliz,pip,sage,sage_spkg
-Doctesting 16 files.
-sage -t --random-seed=0 src/sage/databases/__init__.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=0 src/sage/databases/all.py
-    [5 tests, 0.10 s]
-sage -t --random-seed=0 src/sage/databases/conway.py
-    [42 tests, 0.10 s]
-sage -t --random-seed=0 src/sage/databases/cremona.py
-    [133 tests, 0.31 s]
-sage -t --random-seed=0 src/sage/databases/cunningham_tables.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=0 src/sage/databases/db_class_polynomials.py
-    [7 tests, 0.01 s]
-sage -t --random-seed=0 src/sage/databases/db_modular_polynomials.py
-    [13 tests, 0.01 s]
-sage -t --random-seed=0 src/sage/databases/findstat.py
-    [122 tests, 0.25 s]
-sage -t --random-seed=0 src/sage/databases/jones.py
-    [8 tests, 0.05 s]
-sage -t --random-seed=0 src/sage/databases/knotinfo_db.py
-    [97 tests, 1.80 s]
-sage -t --random-seed=0 src/sage/databases/odlyzko.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=0 src/sage/databases/oeis.py
-    [134 tests, 0.91 s]
-sage -t --random-seed=0 src/sage/databases/sloane.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=0 src/sage/databases/sql_db.py
-    [293 tests, 0.27 s]
-sage -t --random-seed=0 src/sage/databases/stein_watkins.py
-    [12 tests, 0.01 s]
-sage -t --random-seed=0 src/sage/databases/symbolic_data.py
-    [0 tests, 0.00 s]
+Running doctests with ID 2022-03-20-11-46-21-1dc8fb11.
+Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg,texttable
+Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
+Doctesting 1 file using 8 threads.
+sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py
+**********************************************************************
+File "src/sage/tests/cmdline.py", line 312, in sage.tests.cmdline.test_executable
+Failed example:
+    ret
+Expected:
+    0
+Got:
+    4
+**********************************************************************
+1 item had failures:
+   1 of 218 in sage.tests.cmdline.test_executable
+    [217 tests, 1 failure, 67.30 s]
 ----------------------------------------------------------------------
-All tests passed!
+sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py  # 1 doctest failed
 ----------------------------------------------------------------------
-Total time for all tests: 4.6 seconds
-    cpu time: 3.9 seconds
-    cumulative wall time: 3.8 seconds
-============================================================================== test session starts ===============================================================================
-platform darwin -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
+Total time for all tests: 67.4 seconds
+    cpu time: 0.3 seconds
+    cumulative wall time: 67.3 seconds
+Features detected for doctesting: pandoc
+=================================================================================== test session starts ===================================================================================
+platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
 rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
-collected 0 items / 7 errors                                                                                                                                                     
+collected 1 item                                                                                                                                                                          
 
-===================================================================================== ERRORS =====================================================================================
-_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
-Hint: make sure your test modules/packages have valid Python names.
-Traceback:
-src/sage/databases/all.py:51: in <module>
-    from .sql_db import SQLQuery, SQLDatabase
-E   ImportError: attempted relative import with no known parent package
-_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
-Hint: make sure your test modules/packages have valid Python names.
-Traceback:
-src/sage/databases/all.py:51: in <module>
-    from .sql_db import SQLQuery, SQLDatabase
-E   ImportError: attempted relative import with no known parent package
-___________________________________________________________________ ERROR collecting sage/databases/cremona.py ___________________________________________________________________
-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/cremona.py'.
-Hint: make sure your test modules/packages have valid Python names.
-Traceback:
-src/sage/databases/cremona.py:52: in <module>
-    from .sql_db import SQLDatabase, verify_column
-E   ImportError: attempted relative import with no known parent package
-____________________________________________________________ ERROR collecting sage/databases/db_class_polynomials.py _____________________________________________________________
-ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/db_class_polynomials.py'.
-Hint: make sure your test modules/packages have valid Python names.
-Traceback:
-src/sage/databases/db_class_polynomials.py:14: in <module>
-    from .db_modular_polynomials import _dbz_to_integers
-E   ImportError: attempted relative import with no known parent package
-__________________________________________________________________ ERROR collecting sage/databases/findstat.py ___________________________________________________________________
-src/sage/databases/findstat.py:329: in <module>
-    class FindStat(UniqueRepresentation, SageObject):
-sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
-    ???
-E   KeyError: 'findstat'
-_________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _________________________________________________________________
-src/sage/databases/knotinfo_db.py:330: in <module>
-    class KnotInfoDataBase(SageObject, UniqueRepresentation):
-sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
-    ???
-E   KeyError: 'knotinfo_db'
-____________________________________________________________________ ERROR collecting sage/databases/oeis.py _____________________________________________________________________
-src/sage/databases/oeis.py:651: in <module>
-    class OEISSequence(SageObject, UniqueRepresentation):
-sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
-    ???
-E   KeyError: 'oeis'
-============================================================================ short test summary info =============================================================================
-ERROR src/sage/databases/all.py
-ERROR src/sage/databases/all.py
-ERROR src/sage/databases/cremona.py
-ERROR src/sage/databases/db_class_polynomials.py
-ERROR src/sage/databases/findstat.py - KeyError: 'findstat'
-ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'
-ERROR src/sage/databases/oeis.py - KeyError: 'oeis'
-!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
+src/sage/tests/cmdline.py E                                                                                                                                                         [100%]
+
+========================================================================================= ERRORS ==========================================================================================
+____________________________________________________________________________ ERROR at setup of test_executable ____________________________________________________________________________
+file /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py, line 61
+  def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False, **kwds):
+E       fixture 'args' not found
+>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
+>       use 'pytest --fixtures [testpath]' for help on them.
+
+/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py:61
+================================================================================= short test summary info =================================================================================
+ERROR src/sage/tests/cmdline.py::test_executable
+==================================================================================== 1 error in 0.01s =====================================================================================
 ```
-
-Related report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:
-
-```
-=============================================================== ERRORS
-================================================================
-_________________________________________ ERROR collecting
-sage/structure/sage_object_test.py
-_________________________________________
-ImportError while importing test module
-'/home/john/sage/src/sage/structure/sage_object_test.py'.
-Hint: make sure your test modules/packages have valid Python names.
-Traceback:
-src/sage/structure/sage_object_test.py:3: in <module>
-from .sage_object import SageObject
-E ImportError: attempted relative import with no known parent package
-======================================================= short test
-summary info =======================================================
-ERROR src/sage/structure/sage_object_test.py
-!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error
-during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
-```
-
-
``````




---

archive/issue_events_421938.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-22T07:59:15Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "title_is": "Exclude non-pytest test methods from pytest test discovery",
    "title_was": "sage -t: Do not run pytest on individual Python files unless they match the pytest file pattern",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421938"
}
```



---

archive/issue_comments_516551.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">Comment 58</div>\n\nReplying to [@mkoeppe](#comment%3A45):\n> Replying to [@tobiasdiez](#comment%3A41):\n> > > I think this really needs the change that the ticket title says: \"sage -t: Do not run pytest on individual files\" (... unless they match the pytest file pattern...) \n\n> > \n> > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.\n\n> \n> That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as \"critical\" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.\n\nThe point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. So let's please directly implement a proper solution: say what you proposed in [comment:41](#comment%3A41) or by converting them to proper pytests.",
    "created_at": "2022-03-22T07:59:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516551",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:58" align="right">Comment 58</div>

Replying to [@mkoeppe](#comment%3A45):
> Replying to [@tobiasdiez](#comment%3A41):
> > > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 

> > 
> > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.

> 
> That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.

The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. So let's please directly implement a proper solution: say what you proposed in [comment:41](#comment%3A41) or by converting them to proper pytests.



---

archive/issue_comments_516552.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">Comment 59</div>\n\nReplying to [@tobiasdiez](#comment%3A58):\n> Replying to [@mkoeppe](#comment%3A45):\n> > Replying to [@tobiasdiez](#comment%3A41):\n> > > > I think this really needs the change that the ticket title says: \"sage -t: Do not run pytest on individual files\" (... unless they match the pytest file pattern...) \n\n> > > \n> > > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.\n\n> > \n> > That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as \"critical\" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.\n\n> \n> The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. \n\nIf/when you work on it as part of #33546, the whole `sage-runtest` script will be replaced anyway.",
    "created_at": "2022-03-22T16:19:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516552",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:59" align="right">Comment 59</div>

Replying to [@tobiasdiez](#comment%3A58):
> Replying to [@mkoeppe](#comment%3A45):
> > Replying to [@tobiasdiez](#comment%3A41):
> > > > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 

> > > 
> > > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.

> > 
> > That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.

> 
> The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. 

If/when you work on it as part of #33546, the whole `sage-runtest` script will be replaced anyway.



---

archive/issue_events_421939.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T16:20:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421939"
}
```



---

archive/issue_events_421940.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T16:20:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421940"
}
```



---

archive/issue_events_421941.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T16:28:51Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "title_is": "sage -t: Do not run pytest on individual Python files unless they match the pytest file pattern",
    "title_was": "Exclude non-pytest test methods from pytest test discovery",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421941"
}
```



---

archive/issue_comments_516553.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">Comment 62</div>\n\nI've opened #33549 \"Rename test_... functions to avoid the naming scheme reserved by pytest\" for this work. This has no urgency. \n\nThe present ticket solves the critical annoyance in time for the Sage 9.6 release.",
    "created_at": "2022-03-22T16:33:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516553",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:62" align="right">Comment 62</div>

I've opened #33549 "Rename test_... functions to avoid the naming scheme reserved by pytest" for this work. This has no urgency. 

The present ticket solves the critical annoyance in time for the Sage 9.6 release.



---

archive/issue_comments_516554.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">Comment 63</div>\n\nReplying to [@mkoeppe](#comment%3A60):\n\nWhy don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? \n\nFurther, there is a typo in the comment (wrong ticket number).",
    "created_at": "2022-03-22T16:55:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516554",
    "user": "https://github.com/soehms"
}
```

<div id="comment:63" align="right">Comment 63</div>

Replying to [@mkoeppe](#comment%3A60):

Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? 

Further, there is a typo in the comment (wrong ticket number).



---

archive/issue_comments_516555.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">Comment 64</div>\n\nReplying to [@mkoeppe](#comment%3A62):\n> I've opened #33549 \"Rename test_... functions to avoid the naming scheme reserved by pytest\" for this work. This has no urgency. \n> \n> The present ticket solves the critical annoyance in time for the Sage 9.6 release.\n\nBut that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.\n\nSince this issue is almost one year old, I don't see why you now create the impression that it is very urgent and needs a hot-fix instead of a proper fix.",
    "created_at": "2022-03-22T18:11:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516555",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:64" align="right">Comment 64</div>

Replying to [@mkoeppe](#comment%3A62):
> I've opened #33549 "Rename test_... functions to avoid the naming scheme reserved by pytest" for this work. This has no urgency. 
> 
> The present ticket solves the critical annoyance in time for the Sage 9.6 release.

But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.

Since this issue is almost one year old, I don't see why you now create the impression that it is very urgent and needs a hot-fix instead of a proper fix.



---

archive/issue_comments_516556.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">Comment 65</div>\n\nReplying to [@tobiasdiez](#comment%3A64):\n> > The present ticket solves the critical annoyance in time for the Sage 9.6 release.\n\n> \n> But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.\n\nNo, it does not reduce coverage. All tests still run.",
    "created_at": "2022-03-22T18:14:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516556",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:65" align="right">Comment 65</div>

Replying to [@tobiasdiez](#comment%3A64):
> > The present ticket solves the critical annoyance in time for the Sage 9.6 release.

> 
> But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.

No, it does not reduce coverage. All tests still run.



---

archive/issue_comments_516557.json:
```json
{
    "body": "Changed commit from **[119a89a](https://github.com/sagemath/sagetrac-mirror/commit/119a89a686c247376b11aed4dcc253822287fa58)** to **[5e95c77](https://github.com/sagemath/sagetrac-mirror/commit/5e95c776153232ad7e9d67975e3ec68768b0ba05)**",
    "created_at": "2022-03-22T18:26:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516557",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[119a89a](https://github.com/sagemath/sagetrac-mirror/commit/119a89a686c247376b11aed4dcc253822287fa58)** to **[5e95c77](https://github.com/sagemath/sagetrac-mirror/commit/5e95c776153232ad7e9d67975e3ec68768b0ba05)**



---

archive/issue_comments_516558.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">Comment 66</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e95c776153232ad7e9d67975e3ec68768b0ba05\">5e95c77</a></td><td><code>src/bin/sage-runtests: Use os.path.isfile, fix ticket number in comment</code></td></tr></table>\n",
    "created_at": "2022-03-22T18:26:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516558",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:66" align="right">Comment 66</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e95c776153232ad7e9d67975e3ec68768b0ba05">5e95c77</a></td><td><code>src/bin/sage-runtests: Use os.path.isfile, fix ticket number in comment</code></td></tr></table>




---

archive/issue_comments_516559.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">Comment 67</div>\n\nReplying to [@soehms](#comment%3A63):\n> Replying to [@mkoeppe](#comment%3A60):\n> \n> Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? \n\nGood suggestion, done.\n\n> Further, there is a typo in the comment (wrong ticket number).\n\nFixed, thanks.",
    "created_at": "2022-03-22T18:27:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516559",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:67" align="right">Comment 67</div>

Replying to [@soehms](#comment%3A63):
> Replying to [@mkoeppe](#comment%3A60):
> 
> Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? 

Good suggestion, done.

> Further, there is a typo in the comment (wrong ticket number).

Fixed, thanks.



---

archive/issue_comments_516560.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test methods, which are then executed. However, sage's code base contains some methods in its codebase that match this pattern without being pytests.\n+pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.\n \n This leads to problems like\n \n@@ -49,3 +49,94 @@\n ERROR src/sage/tests/cmdline.py::test_executable\n ==================================================================================== 1 error in 0.01s =====================================================================================\n ```\n+\n+We fix it in this ticket by passing names of regular files to pytest only if they match the pytest pattern (ending with `_test.py`). \n+\n+(#32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)\n+\n+Example:\n+\n+```\n+$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py \n+too many failed tests, not using stored timings\n+Running doctests with ID 2022-03-22-11-30-32-fd280468.\n+Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg\n+Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\n+Sorting sources by runtime so that slower doctests are run first....\n+Doctesting 27 files using 8 threads.\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx\n+    [52 tests, 0.08 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx\n+    [87 tests, 0.14 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx\n+    [193 tests, 0.17 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx\n+    [221 tests, 0.25 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py\n+    [45 tests, 0.05 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx\n+    [37 tests, 0.07 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx\n+    [25 tests, 0.05 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx\n+    [24 tests, 0.03 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx\n+    [96 tests, 0.59 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx\n+    [266 tests, 3.09 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx\n+    [592 tests, 3.08 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx\n+    [3070 tests, 31.83 s]\n+----------------------------------------------------------------------\n+All tests passed!\n+----------------------------------------------------------------------\n+Total time for all tests: 32.6 seconds\n+    cpu time: 39.3 seconds\n+    cumulative wall time: 39.4 seconds\n+Features detected for doctesting: sage.rings.number_field\n+============================================================================================================ test session starts ============================================================================================================\n+platform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0\n+rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\n+collected 32 items                                                                                                                                                                                                                          \n+\n+src/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]\n+src/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]\n+src/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]\n+src/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]\n+src/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]\n+src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]\n+\n+======================================================================================================= 32 passed in 66.55s (0:01:06) =======================================================================================================\n+```\n+\n``````\n",
    "created_at": "2022-03-22T18:36:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516560",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test methods, which are then executed. However, sage's code base contains some methods in its codebase that match this pattern without being pytests.
+pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.
 
 This leads to problems like
 
@@ -49,3 +49,94 @@
 ERROR src/sage/tests/cmdline.py::test_executable
 ==================================================================================== 1 error in 0.01s =====================================================================================
 ```
+
+We fix it in this ticket by passing names of regular files to pytest only if they match the pytest pattern (ending with `_test.py`). 
+
+(#32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)
+
+Example:
+
+```
+$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py 
+too many failed tests, not using stored timings
+Running doctests with ID 2022-03-22-11-30-32-fd280468.
+Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg
+Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
+Sorting sources by runtime so that slower doctests are run first....
+Doctesting 27 files using 8 threads.
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx
+    [52 tests, 0.08 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx
+    [87 tests, 0.14 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx
+    [193 tests, 0.17 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx
+    [221 tests, 0.25 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py
+    [45 tests, 0.05 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx
+    [37 tests, 0.07 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx
+    [25 tests, 0.05 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx
+    [24 tests, 0.03 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx
+    [96 tests, 0.59 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx
+    [266 tests, 3.09 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx
+    [592 tests, 3.08 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx
+    [3070 tests, 31.83 s]
+----------------------------------------------------------------------
+All tests passed!
+----------------------------------------------------------------------
+Total time for all tests: 32.6 seconds
+    cpu time: 39.3 seconds
+    cumulative wall time: 39.4 seconds
+Features detected for doctesting: sage.rings.number_field
+============================================================================================================ test session starts ============================================================================================================
+platform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0
+rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
+collected 32 items                                                                                                                                                                                                                          
+
+src/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]
+src/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]
+src/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]
+src/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]
+src/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]
+src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]
+
+======================================================================================================= 32 passed in 66.55s (0:01:06) =======================================================================================================
+```
+
``````




---

archive/issue_comments_516561.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">Comment 69</div>\n\nReplying to [@tobiasdiez](#comment%3A64):\n> Replying to [@mkoeppe](#comment%3A62):\n> > The present ticket solves the critical annoyance in time for the Sage 9.6 release.\n\n> \n> I don't see why you now create the impression that it is very urgent\n\nWe are trying to make a release here, Tobias.",
    "created_at": "2022-03-22T18:40:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516561",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:69" align="right">Comment 69</div>

Replying to [@tobiasdiez](#comment%3A64):
> Replying to [@mkoeppe](#comment%3A62):
> > The present ticket solves the critical annoyance in time for the Sage 9.6 release.

> 
> I don't see why you now create the impression that it is very urgent

We are trying to make a release here, Tobias.



---

archive/issue_comments_516562.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">Comment 70</div>\n\nReplying to [@mkoeppe](#comment%3A65):\n> Replying to [@tobiasdiez](#comment%3A64):\n> > > The present ticket solves the critical annoyance in time for the Sage 9.6 release.\n\n> > \n> > But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.\n\n> \n> No, it does not reduce coverage. All tests still run.\n> \n\nMy point is that running pytest on these files is not a problem in itself (as described in more detail above in [comment:21](#comment%3A21)). I agree however that it leads to problems, namely that some methods are discovered as tests although they are not proper pytests. But it's this latter issue that should be addressed.\n\nIn other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.",
    "created_at": "2022-03-22T19:23:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516562",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:70" align="right">Comment 70</div>

Replying to [@mkoeppe](#comment%3A65):
> Replying to [@tobiasdiez](#comment%3A64):
> > > The present ticket solves the critical annoyance in time for the Sage 9.6 release.

> > 
> > But that's the actually issue. Not running pytest on these files only hides the error, while the underlying problem still persists.

> 
> No, it does not reduce coverage. All tests still run.
> 

My point is that running pytest on these files is not a problem in itself (as described in more detail above in [comment:21](#comment%3A21)). I agree however that it leads to problems, namely that some methods are discovered as tests although they are not proper pytests. But it's this latter issue that should be addressed.

In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.



---

archive/issue_comments_516563.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">Comment 71</div>\n\nReplying to [@tobiasdiez](#comment%3A70):\n> In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.\n\nYes, but that's not the issue here.",
    "created_at": "2022-03-22T20:10:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516563",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:71" align="right">Comment 71</div>

Replying to [@tobiasdiez](#comment%3A70):
> In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.

Yes, but that's not the issue here.



---

archive/issue_comments_516564.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.\n+`sage -t` is broken since #31003 because pytest is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.\n \n This leads to problems like\n \n``````\n",
    "created_at": "2022-03-22T20:25:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516564",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-pytest (#31003) is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.
+`sage -t` is broken since #31003 because pytest is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.
 
 This leads to problems like
 
``````




---

archive/issue_comments_516565.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">Comment 73</div>\n\nClarified this in the beginning of the ticket description. That `sage -t` works without noise is critical. Our use of `pytest` is still in development; that's important work but not critical for the release.",
    "created_at": "2022-03-22T20:26:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516565",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:73" align="right">Comment 73</div>

Clarified this in the beginning of the ticket description. That `sage -t` works without noise is critical. Our use of `pytest` is still in development; that's important work but not critical for the release.



---

archive/issue_events_421942.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-22T21:37:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421942"
}
```



---

archive/issue_events_421943.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-22T21:37:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421943"
}
```



---

archive/issue_comments_516566.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">Comment 74</div>\n\nReplying to [@mkoeppe](#comment%3A59):\n> Replying to [@tobiasdiez](#comment%3A58):\n> > Replying to [@mkoeppe](#comment%3A45):\n> > > Replying to [@tobiasdiez](#comment%3A41):\n> > > > > I think this really needs the change that the ticket title says: \"sage -t: Do not run pytest on individual files\" (... unless they match the pytest file pattern...) \n\n> > > > \n> > > > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.\n\n> > > \n> > > That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as \"critical\" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.\n\n> > \n> > The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. \n\n> \n> If/when you work on it as part of #33546, the whole `sage-runtest` script will be replaced anyway.\n\nI've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest (if somefile is not ending on `_test.py`). Thus working and reviewing on tickets that go into the direction of #33546 (such as #33550) is made harder.\n\nThus, please make it at least possible to disable the added filename check.",
    "created_at": "2022-03-22T21:37:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516566",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:74" align="right">Comment 74</div>

Replying to [@mkoeppe](#comment%3A59):
> Replying to [@tobiasdiez](#comment%3A58):
> > Replying to [@mkoeppe](#comment%3A45):
> > > Replying to [@tobiasdiez](#comment%3A41):
> > > > > I think this really needs the change that the ticket title says: "sage -t: Do not run pytest on individual files" (... unless they match the pytest file pattern...) 

> > > > 
> > > > I'm not a big fan of this. The longterm goal is to use pytest also for the doctests (replacing sages custom doctest runner) and for this doctests and pytests should be treated in the same way.

> > > 
> > > That's fine to keep in mind for the long term. But we really need to restore a non-broken doctesting facility. I marked this as "critical" 9 months ago and we released 9.4 and 9.5 with it. It's overdue to fix it.

> > 
> > The point is that for this goal skipping the non-pytest files has to be reverted and the underlying issue has to be fixed anyway. 

> 
> If/when you work on it as part of #33546, the whole `sage-runtest` script will be replaced anyway.

I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest (if somefile is not ending on `_test.py`). Thus working and reviewing on tickets that go into the direction of #33546 (such as #33550) is made harder.

Thus, please make it at least possible to disable the added filename check.



---

archive/issue_comments_516567.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">Comment 75</div>\n\nReplying to [@mkoeppe](#comment%3A71):\n> Replying to [@tobiasdiez](#comment%3A70):\n> > In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.\n\n> \n> Yes, but that's not the issue here. \n\nSo if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?",
    "created_at": "2022-03-22T21:38:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516567",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:75" align="right">Comment 75</div>

Replying to [@mkoeppe](#comment%3A71):
> Replying to [@tobiasdiez](#comment%3A70):
> > In other words, running `pytest src/sage/tests/cmdline.py` with this ticket still leads to the same issue as described in the ticket description.

> 
> Yes, but that's not the issue here. 

So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?



---

archive/issue_comments_516568.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">Comment 76</div>\n\nReplying to [@tobiasdiez](#comment%3A75):\n> So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?\n\nHm?",
    "created_at": "2022-03-22T21:42:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516568",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:76" align="right">Comment 76</div>

Replying to [@tobiasdiez](#comment%3A75):
> So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?

Hm?



---

archive/issue_comments_516569.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">Comment 77</div>\n\nReplying to [@tobiasdiez](#comment%3A74):\n> I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest \n\nThen just test it with pytest, no?",
    "created_at": "2022-03-22T21:43:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516569",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:77" align="right">Comment 77</div>

Replying to [@tobiasdiez](#comment%3A74):
> I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest 

Then just test it with pytest, no?



---

archive/issue_comments_516570.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">Comment 78</div>\n\nIn #33550, you can just update the pattern to allow your new format `_test.sage` too.",
    "created_at": "2022-03-22T21:44:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516570",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:78" align="right">Comment 78</div>

In #33550, you can just update the pattern to allow your new format `_test.sage` too.



---

archive/issue_events_421944.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T21:44:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421944"
}
```



---

archive/issue_events_421945.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-22T21:44:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421945"
}
```



---

archive/issue_comments_516571.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">Comment 80</div>\n\nReplying to [@mkoeppe](#comment%3A76):\n> Replying to [@tobiasdiez](#comment%3A75):\n> > So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?\n\n> \n> Hm?\n\nThat's the negation of your statement that the failure of `pytest src/sage/tests/cmdline.py` is not the issue.",
    "created_at": "2022-03-22T21:44:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516571",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:80" align="right">Comment 80</div>

Replying to [@mkoeppe](#comment%3A76):
> Replying to [@tobiasdiez](#comment%3A75):
> > So if `pytest src/sage/tests/cmdline.py` would pass, then `sage -t src/sage/tests/cmdline.py` would still fail?

> 
> Hm?

That's the negation of your statement that the failure of `pytest src/sage/tests/cmdline.py` is not the issue.



---

archive/issue_comments_516572.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">Comment 81</div>\n\nKindly don't negate my statements, thanks ;)",
    "created_at": "2022-03-22T21:45:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516572",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:81" align="right">Comment 81</div>

Kindly don't negate my statements, thanks ;)



---

archive/issue_comments_516573.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">Comment 82</div>\n\nReplying to [@mkoeppe](#comment%3A81):\n> Kindly don't negate my statements, thanks ;)\n\nThat was only to show that it was not a true statement.",
    "created_at": "2022-03-22T21:47:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516573",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:82" align="right">Comment 82</div>

Replying to [@mkoeppe](#comment%3A81):
> Kindly don't negate my statements, thanks ;)

That was only to show that it was not a true statement.



---

archive/issue_comments_516574.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">Comment 83</div>\n\nReplying to [@mkoeppe](#comment%3A77):\n> Replying to [@tobiasdiez](#comment%3A74):\n> > I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest \n\n> \n> Then just test it with pytest, no?\n> \n\nIn principle yes, but pytest needs to be invoked with all the sage env setup and the correct arguments (which will probably include the sage-env dependent `rootdir` argument to fix #33550).",
    "created_at": "2022-03-22T21:49:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516574",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:83" align="right">Comment 83</div>

Replying to [@mkoeppe](#comment%3A77):
> Replying to [@tobiasdiez](#comment%3A74):
> > I've just realized that with the changes in this ticket it is now impossible to use `sage -t somefile` to test if `somefile` works correctly with pytest 

> 
> Then just test it with pytest, no?
> 

In principle yes, but pytest needs to be invoked with all the sage env setup and the correct arguments (which will probably include the sage-env dependent `rootdir` argument to fix #33550).



---

archive/issue_comments_516575.json:
```json
{
    "body": "<div id=\"comment:84\" align=\"right\">Comment 84</div>\n\nYou mean `./sage -sh -c pytest`?",
    "created_at": "2022-03-22T22:36:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516575",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:84" align="right">Comment 84</div>

You mean `./sage -sh -c pytest`?



---

archive/issue_comments_516576.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">Comment 85</div>\n\nNo, sage-runtests also sets cmdline args for pytest.",
    "created_at": "2022-03-22T22:53:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516576",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:85" align="right">Comment 85</div>

No, sage-runtests also sets cmdline args for pytest.



---

archive/issue_comments_516577.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">Comment 86</div>\n\nAnyway, as I said in [comment:78](#comment%3A78), when you work on tickets that make a wider range of files work with pytest, you can adjust the condition added in the file.",
    "created_at": "2022-03-22T22:59:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516577",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:86" align="right">Comment 86</div>

Anyway, as I said in [comment:78](#comment%3A78), when you work on tickets that make a wider range of files work with pytest, you can adjust the condition added in the file.



---

archive/issue_comments_516578.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">Comment 87</div>\n\nSo let's please get this in. There is no open issue.",
    "created_at": "2022-03-22T22:59:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516578",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:87" align="right">Comment 87</div>

So let's please get this in. There is no open issue.



---

archive/issue_comments_516579.json:
```json
{
    "body": "<div id=\"comment:88\" align=\"right\">Comment 88</div>\n\nCan you please explain me how one is now supposed to discover issues with pytest? It is already an optional package and with the changes of this ticket it is essentially disabled on most of sages code base.",
    "created_at": "2022-03-22T23:15:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516579",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:88" align="right">Comment 88</div>

Can you please explain me how one is now supposed to discover issues with pytest? It is already an optional package and with the changes of this ticket it is essentially disabled on most of sages code base.



---

archive/issue_comments_516580.json:
```json
{
    "body": "<div id=\"comment:89\" align=\"right\">Comment 89</div>\n\nReplying to [@tobiasdiez](#comment%3A88):\n> Can you please explain me how one is now supposed to discover issues with pytest? It is already an optional package and with the changes of this ticket it is essentially disabled on most of sages code base.\n\nAs you see in the example shown in the ticket description, `./sage -t` continues to run pytest on the files named `*_test.py`, which contain pytest tests.\n\nThere are no pytest tests in any other files, so there is no need to run pytest on them. \nIf/when you work on a ticket that changes that, as I said in [comment:78](#comment%3A78), you adjust the test in that ticket.",
    "created_at": "2022-03-22T23:23:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516580",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:89" align="right">Comment 89</div>

Replying to [@tobiasdiez](#comment%3A88):
> Can you please explain me how one is now supposed to discover issues with pytest? It is already an optional package and with the changes of this ticket it is essentially disabled on most of sages code base.

As you see in the example shown in the ticket description, `./sage -t` continues to run pytest on the files named `*_test.py`, which contain pytest tests.

There are no pytest tests in any other files, so there is no need to run pytest on them. 
If/when you work on a ticket that changes that, as I said in [comment:78](#comment%3A78), you adjust the test in that ticket.



---

archive/issue_comments_516581.json:
```json
{
    "body": "<div id=\"comment:90\" align=\"right\">Comment 90</div>\n\nFor example, if/when you work on #33549, you can expand from testing all `*_test.py` to testing all `*.py`.",
    "created_at": "2022-03-22T23:25:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516581",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:90" align="right">Comment 90</div>

For example, if/when you work on #33549, you can expand from testing all `*_test.py` to testing all `*.py`.



---

archive/issue_comments_516582.json:
```json
{
    "body": "Reviewer: **Sebastian Oehms**",
    "created_at": "2022-03-23T07:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516582",
    "user": "https://github.com/soehms"
}
```

Reviewer: **Sebastian Oehms**



---

archive/issue_comments_516583.json:
```json
{
    "body": "<div id=\"comment:91\" align=\"right\">Comment 91</div>\n\nReplying to [@mkoeppe](#comment%3A67):\n> Replying to [@soehms](#comment%3A63):\n> > Replying to [@mkoeppe](#comment%3A60):\n> > \n> > Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? \n\n> \n> Good suggestion, done.\n> \n> > Further, there is a typo in the comment (wrong ticket number).\n\n> \n> Fixed, thanks.\n\nThanks, as well. LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.",
    "created_at": "2022-03-23T07:20:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516583",
    "user": "https://github.com/soehms"
}
```

<div id="comment:91" align="right">Comment 91</div>

Replying to [@mkoeppe](#comment%3A67):
> Replying to [@soehms](#comment%3A63):
> > Replying to [@mkoeppe](#comment%3A60):
> > 
> > Why don't you use `os.path.isfile(f)` instead of `os.path.splitext(f)[1]`? 

> 
> Good suggestion, done.
> 
> > Further, there is a typo in the comment (wrong ticket number).

> 
> Fixed, thanks.

Thanks, as well. LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.



---

archive/issue_comments_516584.json:
```json
{
    "body": "<div id=\"comment:92\" align=\"right\">Comment 92</div>\n\nReplying to [@mkoeppe](#comment%3A90):\n> For example, if/when you work on #33549, you can expand from testing all `*_test.py` to testing all `*.py`.\n\nOkay, since #33549 is now ready for review and we both seem to agree that this is the right approach, this ticket here is no longer needed.\n\nMoreover, the approach taken in #33549 to fix pytest in conftest instead of sage-runtests has also the advantage that running `./sage -sh -c pytest` directly (as you advocate above) also works now.",
    "created_at": "2022-03-23T12:54:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516584",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:92" align="right">Comment 92</div>

Replying to [@mkoeppe](#comment%3A90):
> For example, if/when you work on #33549, you can expand from testing all `*_test.py` to testing all `*.py`.

Okay, since #33549 is now ready for review and we both seem to agree that this is the right approach, this ticket here is no longer needed.

Moreover, the approach taken in #33549 to fix pytest in conftest instead of sage-runtests has also the advantage that running `./sage -sh -c pytest` directly (as you advocate above) also works now.



---

archive/issue_events_421946.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-23T12:54:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421946"
}
```



---

archive/issue_events_421947.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-23T12:54:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421947"
}
```



---

archive/issue_events_421948.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-03-23T12:54:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421948"
}
```



---

archive/issue_comments_516585.json:
```json
{
    "body": "<div id=\"comment:93\" align=\"right\">Comment 93</div>\n\n#33549 is a big change and will likely take a while to review.",
    "created_at": "2022-03-23T17:12:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516585",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:93" align="right">Comment 93</div>

#33549 is a big change and will likely take a while to review.



---

archive/issue_events_421949.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-23T17:12:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421949"
}
```



---

archive/issue_comments_516586.json:
```json
{
    "body": "<div id=\"comment:94\" align=\"right\">Comment 94</div>\n\nI'm sorry. I don't really follow what's going on here, and I can't really follow your fast pace.\n\nIs there an IRC channel or similar where these topics are discussed? I don't think this ticket format is good, besides it leaves a lot of useless circumstantial comments that later make it very difficult to understand what happened (let me mention that I also find unhelpful that commits are not squashed and rebased when the fixes change, I know this is a matter of taste and I know the perils of rebasing, but still...)\n\nI guess the last proposal is ok, although I fail to see what's the problem with using the work already done by DC in scanning the files.\n\nIf I understood correctly, the goal is to replace the doctest runner by pytest. If so, wouldn't it make more sense to write a different version of `sage-runtests` which is guided by pytest instead of the DC, instead of having `sage-runtests` do two passes on the files, one guided by DC and one guided by pytest?\n\nIf, at some point, you want \"pytest file.py\" to run the pytest tests and also the sage doctests, then the current structure of `sage-runtests` seems not ok as the sage doctests would be run twice (once by the DC and then again by pytest).\n\nIt seems to me it makes much more sense to have two \"drivers\" for running tests. One driver is the current sage-runtests (using DC) and the other driver is a new one using pytest. With this split you can work on developing the pytest driver without breaking the current `sage -t`. When the new pytest driver is well tested and working, and it's a complete replacement for the current DC driver, then `sage -t` can be switched to the new driver. They can probably coexist for some time to ease the transition. Your current strategy seems to be at odds with this.\n\nSome questions about pytest (since I'm not really familiar with it):\na. Is pytest expected to have a long life? I understand python has changed test frameworks in the past. Is there a reasonable certainty that this won't happen again (I'm not implying it will -- I'm just asking if you've made this risk analysis).\nb. Is there a way that you can make \"pytest ARGUMENTS\" work, i.e. have some configuration for pytest so the correct sage environment, etc. is loaded? If you don't have a plan on how this is supposed to work, then replacing `sage -t` by `pytest` won't really work...\nc. If not, could you implement a `sage -pytest` or something like that that will run pytest with the needed environment, arguments, etc.?",
    "created_at": "2022-03-23T23:52:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516586",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:94" align="right">Comment 94</div>

I'm sorry. I don't really follow what's going on here, and I can't really follow your fast pace.

Is there an IRC channel or similar where these topics are discussed? I don't think this ticket format is good, besides it leaves a lot of useless circumstantial comments that later make it very difficult to understand what happened (let me mention that I also find unhelpful that commits are not squashed and rebased when the fixes change, I know this is a matter of taste and I know the perils of rebasing, but still...)

I guess the last proposal is ok, although I fail to see what's the problem with using the work already done by DC in scanning the files.

If I understood correctly, the goal is to replace the doctest runner by pytest. If so, wouldn't it make more sense to write a different version of `sage-runtests` which is guided by pytest instead of the DC, instead of having `sage-runtests` do two passes on the files, one guided by DC and one guided by pytest?

If, at some point, you want "pytest file.py" to run the pytest tests and also the sage doctests, then the current structure of `sage-runtests` seems not ok as the sage doctests would be run twice (once by the DC and then again by pytest).

It seems to me it makes much more sense to have two "drivers" for running tests. One driver is the current sage-runtests (using DC) and the other driver is a new one using pytest. With this split you can work on developing the pytest driver without breaking the current `sage -t`. When the new pytest driver is well tested and working, and it's a complete replacement for the current DC driver, then `sage -t` can be switched to the new driver. They can probably coexist for some time to ease the transition. Your current strategy seems to be at odds with this.

Some questions about pytest (since I'm not really familiar with it):
a. Is pytest expected to have a long life? I understand python has changed test frameworks in the past. Is there a reasonable certainty that this won't happen again (I'm not implying it will -- I'm just asking if you've made this risk analysis).
b. Is there a way that you can make "pytest ARGUMENTS" work, i.e. have some configuration for pytest so the correct sage environment, etc. is loaded? If you don't have a plan on how this is supposed to work, then replacing `sage -t` by `pytest` won't really work...
c. If not, could you implement a `sage -pytest` or something like that that will run pytest with the needed environment, arguments, etc.?



---

archive/issue_comments_516587.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,142 +1,132 @@\n-`sage -t` is broken since #31003 because pytest is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.\n-\n-This leads to problems like\n+pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:\n \n ```\n-$ ./sage -tp src/sage/tests/cmdline.py\n+$ ./sage -t  src/sage/databases/*.py \n too many failed tests, not using stored timings\n-Running doctests with ID 2022-03-20-11-46-21-1dc8fb11.\n-Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg,texttable\n-Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\n-Doctesting 1 file using 8 threads.\n-sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py\n-**********************************************************************\n-File \"src/sage/tests/cmdline.py\", line 312, in sage.tests.cmdline.test_executable\n-Failed example:\n-    ret\n-Expected:\n-    0\n-Got:\n-    4\n-**********************************************************************\n-1 item had failures:\n-   1 of 218 in sage.tests.cmdline.test_executable\n-    [217 tests, 1 failure, 67.30 s]\n-----------------------------------------------------------------------\n-sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py  # 1 doctest failed\n-----------------------------------------------------------------------\n-Total time for all tests: 67.4 seconds\n-    cpu time: 0.3 seconds\n-    cumulative wall time: 67.3 seconds\n-Features detected for doctesting: pandoc\n-=================================================================================== test session starts ===================================================================================\n-platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0\n-rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\n-collected 1 item                                                                                                                                                                          \n-\n-src/sage/tests/cmdline.py E                                                                                                                                                         [100%]\n-\n-========================================================================================= ERRORS ==========================================================================================\n-____________________________________________________________________________ ERROR at setup of test_executable ____________________________________________________________________________\n-file /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py, line 61\n-  def test_executable(args, input=\"\", timeout=100.0, pydebug_ignore_warnings=False, **kwds):\n-E       fixture 'args' not found\n->       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory\n->       use 'pytest --fixtures [testpath]' for help on them.\n-\n-/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py:61\n-================================================================================= short test summary info =================================================================================\n-ERROR src/sage/tests/cmdline.py::test_executable\n-==================================================================================== 1 error in 0.01s =====================================================================================\n-```\n-\n-We fix it in this ticket by passing names of regular files to pytest only if they match the pytest pattern (ending with `_test.py`). \n-\n-(#32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)\n-\n-Example:\n-\n-```\n-$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py \n-too many failed tests, not using stored timings\n-Running doctests with ID 2022-03-22-11-30-32-fd280468.\n-Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg\n-Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\n-Sorting sources by runtime so that slower doctests are run first....\n-Doctesting 27 files using 8 threads.\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd\n+Running doctests with ID 2021-06-07-11-04-14-3c1f8784.\n+Using --optional=4ti2,bliss,build,database_knotinfo,dochtml,e_antic,homebrew,jupymake,latte_int,lidia,lrslib,normaliz,pip,sage,sage_spkg\n+Doctesting 16 files.\n+sage -t --random-seed=0 src/sage/databases/__init__.py\n     [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd\n+sage -t --random-seed=0 src/sage/databases/all.py\n+    [5 tests, 0.10 s]\n+sage -t --random-seed=0 src/sage/databases/conway.py\n+    [42 tests, 0.10 s]\n+sage -t --random-seed=0 src/sage/databases/cremona.py\n+    [133 tests, 0.31 s]\n+sage -t --random-seed=0 src/sage/databases/cunningham_tables.py\n     [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd\n+sage -t --random-seed=0 src/sage/databases/db_class_polynomials.py\n+    [7 tests, 0.01 s]\n+sage -t --random-seed=0 src/sage/databases/db_modular_polynomials.py\n+    [13 tests, 0.01 s]\n+sage -t --random-seed=0 src/sage/databases/findstat.py\n+    [122 tests, 0.25 s]\n+sage -t --random-seed=0 src/sage/databases/jones.py\n+    [8 tests, 0.05 s]\n+sage -t --random-seed=0 src/sage/databases/knotinfo_db.py\n+    [97 tests, 1.80 s]\n+sage -t --random-seed=0 src/sage/databases/odlyzko.py\n     [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd\n+sage -t --random-seed=0 src/sage/databases/oeis.py\n+    [134 tests, 0.91 s]\n+sage -t --random-seed=0 src/sage/databases/sloane.py\n     [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd\n+sage -t --random-seed=0 src/sage/databases/sql_db.py\n+    [293 tests, 0.27 s]\n+sage -t --random-seed=0 src/sage/databases/stein_watkins.py\n+    [12 tests, 0.01 s]\n+sage -t --random-seed=0 src/sage/databases/symbolic_data.py\n     [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx\n-    [52 tests, 0.08 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx\n-    [87 tests, 0.14 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx\n-    [193 tests, 0.17 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx\n-    [221 tests, 0.25 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py\n-    [45 tests, 0.05 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx\n-    [37 tests, 0.07 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx\n-    [25 tests, 0.05 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx\n-    [24 tests, 0.03 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py\n-    [0 tests, 0.00 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx\n-    [96 tests, 0.59 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx\n-    [266 tests, 3.09 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx\n-    [592 tests, 3.08 s]\n-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx\n-    [3070 tests, 31.83 s]\n ----------------------------------------------------------------------\n All tests passed!\n ----------------------------------------------------------------------\n-Total time for all tests: 32.6 seconds\n-    cpu time: 39.3 seconds\n-    cumulative wall time: 39.4 seconds\n-Features detected for doctesting: sage.rings.number_field\n-============================================================================================================ test session starts ============================================================================================================\n-platform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0\n+Total time for all tests: 4.6 seconds\n+    cpu time: 3.9 seconds\n+    cumulative wall time: 3.8 seconds\n+============================================================================== test session starts ===============================================================================\n+platform darwin -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\n rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\n-collected 32 items                                                                                                                                                                                                                          \n+collected 0 items / 7 errors                                                                                                                                                     \n \n-src/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]\n-src/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]\n-src/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]\n-src/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]\n-src/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]\n-src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]\n-\n-======================================================================================================= 32 passed in 66.55s (0:01:06) =======================================================================================================\n+===================================================================================== ERRORS =====================================================================================\n+_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________\n+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.\n+Hint: make sure your test modules/packages have valid Python names.\n+Traceback:\n+src/sage/databases/all.py:51: in <module>\n+    from .sql_db import SQLQuery, SQLDatabase\n+E   ImportError: attempted relative import with no known parent package\n+_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________\n+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.\n+Hint: make sure your test modules/packages have valid Python names.\n+Traceback:\n+src/sage/databases/all.py:51: in <module>\n+    from .sql_db import SQLQuery, SQLDatabase\n+E   ImportError: attempted relative import with no known parent package\n+___________________________________________________________________ ERROR collecting sage/databases/cremona.py ___________________________________________________________________\n+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/cremona.py'.\n+Hint: make sure your test modules/packages have valid Python names.\n+Traceback:\n+src/sage/databases/cremona.py:52: in <module>\n+    from .sql_db import SQLDatabase, verify_column\n+E   ImportError: attempted relative import with no known parent package\n+____________________________________________________________ ERROR collecting sage/databases/db_class_polynomials.py _____________________________________________________________\n+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/db_class_polynomials.py'.\n+Hint: make sure your test modules/packages have valid Python names.\n+Traceback:\n+src/sage/databases/db_class_polynomials.py:14: in <module>\n+    from .db_modular_polynomials import _dbz_to_integers\n+E   ImportError: attempted relative import with no known parent package\n+__________________________________________________________________ ERROR collecting sage/databases/findstat.py ___________________________________________________________________\n+src/sage/databases/findstat.py:329: in <module>\n+    class FindStat(UniqueRepresentation, SageObject):\n+sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n+    ???\n+E   KeyError: 'findstat'\n+_________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _________________________________________________________________\n+src/sage/databases/knotinfo_db.py:330: in <module>\n+    class KnotInfoDataBase(SageObject, UniqueRepresentation):\n+sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n+    ???\n+E   KeyError: 'knotinfo_db'\n+____________________________________________________________________ ERROR collecting sage/databases/oeis.py _____________________________________________________________________\n+src/sage/databases/oeis.py:651: in <module>\n+    class OEISSequence(SageObject, UniqueRepresentation):\n+sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__\n+    ???\n+E   KeyError: 'oeis'\n+============================================================================ short test summary info =============================================================================\n+ERROR src/sage/databases/all.py\n+ERROR src/sage/databases/all.py\n+ERROR src/sage/databases/cremona.py\n+ERROR src/sage/databases/db_class_polynomials.py\n+ERROR src/sage/databases/findstat.py - KeyError: 'findstat'\n+ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'\n+ERROR src/sage/databases/oeis.py - KeyError: 'oeis'\n+!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n ```\n \n+Related report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:\n+\n+```\n+=============================================================== ERRORS\n+================================================================\n+_________________________________________ ERROR collecting\n+sage/structure/sage_object_test.py\n+_________________________________________\n+ImportError while importing test module\n+'/home/john/sage/src/sage/structure/sage_object_test.py'.\n+Hint: make sure your test modules/packages have valid Python names.\n+Traceback:\n+src/sage/structure/sage_object_test.py:3: in <module>\n+from .sage_object import SageObject\n+E ImportError: attempted relative import with no known parent package\n+======================================================= short test\n+summary info =======================================================\n+ERROR src/sage/structure/sage_object_test.py\n+!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error\n+during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n+```\n+\n+\n``````\n",
    "created_at": "2022-03-23T23:52:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516587",
    "user": "https://github.com/tornaria"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,142 +1,132 @@
-`sage -t` is broken since #31003 because pytest is configured to look for methods prefixed with `test_` and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.
-
-This leads to problems like
+pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:
 
 ```
-$ ./sage -tp src/sage/tests/cmdline.py
+$ ./sage -t  src/sage/databases/*.py 
 too many failed tests, not using stored timings
-Running doctests with ID 2022-03-20-11-46-21-1dc8fb11.
-Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg,texttable
-Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
-Doctesting 1 file using 8 threads.
-sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py
-**********************************************************************
-File "src/sage/tests/cmdline.py", line 312, in sage.tests.cmdline.test_executable
-Failed example:
-    ret
-Expected:
-    0
-Got:
-    4
-**********************************************************************
-1 item had failures:
-   1 of 218 in sage.tests.cmdline.test_executable
-    [217 tests, 1 failure, 67.30 s]
-----------------------------------------------------------------------
-sage -t --random-seed=23402257756506608859254049173870803147 src/sage/tests/cmdline.py  # 1 doctest failed
-----------------------------------------------------------------------
-Total time for all tests: 67.4 seconds
-    cpu time: 0.3 seconds
-    cumulative wall time: 67.3 seconds
-Features detected for doctesting: pandoc
-=================================================================================== test session starts ===================================================================================
-platform darwin -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
-rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
-collected 1 item                                                                                                                                                                          
-
-src/sage/tests/cmdline.py E                                                                                                                                                         [100%]
-
-========================================================================================= ERRORS ==========================================================================================
-____________________________________________________________________________ ERROR at setup of test_executable ____________________________________________________________________________
-file /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py, line 61
-  def test_executable(args, input="", timeout=100.0, pydebug_ignore_warnings=False, **kwds):
-E       fixture 'args' not found
->       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory
->       use 'pytest --fixtures [testpath]' for help on them.
-
-/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tests/cmdline.py:61
-================================================================================= short test summary info =================================================================================
-ERROR src/sage/tests/cmdline.py::test_executable
-==================================================================================== 1 error in 0.01s =====================================================================================
-```
-
-We fix it in this ticket by passing names of regular files to pytest only if they match the pytest pattern (ending with `_test.py`). 
-
-(#32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)
-
-Example:
-
-```
-$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py 
-too many failed tests, not using stored timings
-Running doctests with ID 2022-03-22-11-30-32-fd280468.
-Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg
-Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
-Sorting sources by runtime so that slower doctests are run first....
-Doctesting 27 files using 8 threads.
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd
+Running doctests with ID 2021-06-07-11-04-14-3c1f8784.
+Using --optional=4ti2,bliss,build,database_knotinfo,dochtml,e_antic,homebrew,jupymake,latte_int,lidia,lrslib,normaliz,pip,sage,sage_spkg
+Doctesting 16 files.
+sage -t --random-seed=0 src/sage/databases/__init__.py
     [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd
+sage -t --random-seed=0 src/sage/databases/all.py
+    [5 tests, 0.10 s]
+sage -t --random-seed=0 src/sage/databases/conway.py
+    [42 tests, 0.10 s]
+sage -t --random-seed=0 src/sage/databases/cremona.py
+    [133 tests, 0.31 s]
+sage -t --random-seed=0 src/sage/databases/cunningham_tables.py
     [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd
+sage -t --random-seed=0 src/sage/databases/db_class_polynomials.py
+    [7 tests, 0.01 s]
+sage -t --random-seed=0 src/sage/databases/db_modular_polynomials.py
+    [13 tests, 0.01 s]
+sage -t --random-seed=0 src/sage/databases/findstat.py
+    [122 tests, 0.25 s]
+sage -t --random-seed=0 src/sage/databases/jones.py
+    [8 tests, 0.05 s]
+sage -t --random-seed=0 src/sage/databases/knotinfo_db.py
+    [97 tests, 1.80 s]
+sage -t --random-seed=0 src/sage/databases/odlyzko.py
     [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd
+sage -t --random-seed=0 src/sage/databases/oeis.py
+    [134 tests, 0.91 s]
+sage -t --random-seed=0 src/sage/databases/sloane.py
     [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd
+sage -t --random-seed=0 src/sage/databases/sql_db.py
+    [293 tests, 0.27 s]
+sage -t --random-seed=0 src/sage/databases/stein_watkins.py
+    [12 tests, 0.01 s]
+sage -t --random-seed=0 src/sage/databases/symbolic_data.py
     [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx
-    [52 tests, 0.08 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx
-    [87 tests, 0.14 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx
-    [193 tests, 0.17 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx
-    [221 tests, 0.25 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py
-    [45 tests, 0.05 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx
-    [37 tests, 0.07 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx
-    [25 tests, 0.05 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx
-    [24 tests, 0.03 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py
-    [0 tests, 0.00 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx
-    [96 tests, 0.59 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx
-    [266 tests, 3.09 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx
-    [592 tests, 3.08 s]
-sage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx
-    [3070 tests, 31.83 s]
 ----------------------------------------------------------------------
 All tests passed!
 ----------------------------------------------------------------------
-Total time for all tests: 32.6 seconds
-    cpu time: 39.3 seconds
-    cumulative wall time: 39.4 seconds
-Features detected for doctesting: sage.rings.number_field
-============================================================================================================ test session starts ============================================================================================================
-platform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0
+Total time for all tests: 4.6 seconds
+    cpu time: 3.9 seconds
+    cumulative wall time: 3.8 seconds
+============================================================================== test session starts ===============================================================================
+platform darwin -- Python 3.9.5, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
 rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
-collected 32 items                                                                                                                                                                                                                          
+collected 0 items / 7 errors                                                                                                                                                     
 
-src/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]
-src/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]
-src/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]
-src/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]
-src/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]
-src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]
-
-======================================================================================================= 32 passed in 66.55s (0:01:06) =======================================================================================================
+===================================================================================== ERRORS =====================================================================================
+_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
+Hint: make sure your test modules/packages have valid Python names.
+Traceback:
+src/sage/databases/all.py:51: in <module>
+    from .sql_db import SQLQuery, SQLDatabase
+E   ImportError: attempted relative import with no known parent package
+_____________________________________________________________________ ERROR collecting sage/databases/all.py _____________________________________________________________________
+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/all.py'.
+Hint: make sure your test modules/packages have valid Python names.
+Traceback:
+src/sage/databases/all.py:51: in <module>
+    from .sql_db import SQLQuery, SQLDatabase
+E   ImportError: attempted relative import with no known parent package
+___________________________________________________________________ ERROR collecting sage/databases/cremona.py ___________________________________________________________________
+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/cremona.py'.
+Hint: make sure your test modules/packages have valid Python names.
+Traceback:
+src/sage/databases/cremona.py:52: in <module>
+    from .sql_db import SQLDatabase, verify_column
+E   ImportError: attempted relative import with no known parent package
+____________________________________________________________ ERROR collecting sage/databases/db_class_polynomials.py _____________________________________________________________
+ImportError while importing test module '/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/databases/db_class_polynomials.py'.
+Hint: make sure your test modules/packages have valid Python names.
+Traceback:
+src/sage/databases/db_class_polynomials.py:14: in <module>
+    from .db_modular_polynomials import _dbz_to_integers
+E   ImportError: attempted relative import with no known parent package
+__________________________________________________________________ ERROR collecting sage/databases/findstat.py ___________________________________________________________________
+src/sage/databases/findstat.py:329: in <module>
+    class FindStat(UniqueRepresentation, SageObject):
+sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
+    ???
+E   KeyError: 'findstat'
+_________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _________________________________________________________________
+src/sage/databases/knotinfo_db.py:330: in <module>
+    class KnotInfoDataBase(SageObject, UniqueRepresentation):
+sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
+    ???
+E   KeyError: 'knotinfo_db'
+____________________________________________________________________ ERROR collecting sage/databases/oeis.py _____________________________________________________________________
+src/sage/databases/oeis.py:651: in <module>
+    class OEISSequence(SageObject, UniqueRepresentation):
+sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__
+    ???
+E   KeyError: 'oeis'
+============================================================================ short test summary info =============================================================================
+ERROR src/sage/databases/all.py
+ERROR src/sage/databases/all.py
+ERROR src/sage/databases/cremona.py
+ERROR src/sage/databases/db_class_polynomials.py
+ERROR src/sage/databases/findstat.py - KeyError: 'findstat'
+ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'
+ERROR src/sage/databases/oeis.py - KeyError: 'oeis'
+!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 7 errors during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 ```
 
+Related report in https://groups.google.com/g/sage-devel/c/SE_A2Jw5Kko/m/KQpA9GbjBQAJ:
+
+```
+=============================================================== ERRORS
+================================================================
+_________________________________________ ERROR collecting
+sage/structure/sage_object_test.py
+_________________________________________
+ImportError while importing test module
+'/home/john/sage/src/sage/structure/sage_object_test.py'.
+Hint: make sure your test modules/packages have valid Python names.
+Traceback:
+src/sage/structure/sage_object_test.py:3: in <module>
+from .sage_object import SageObject
+E ImportError: attempted relative import with no known parent package
+======================================================= short test
+summary info =======================================================
+ERROR src/sage/structure/sage_object_test.py
+!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error
+during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
+```
+
+
``````




---

archive/issue_comments_516588.json:
```json
{
    "body": "<div id=\"comment:95\" align=\"right\">Comment 95</div>\n\nThe present ticket is a bugfix ticket that removes an annoyance with the existing implementation. My goal is to get it in for the Sage 9.6 release.\n\nLarger discussions of `sage -t` vs. `pytest` should best be taken to a ticket with a larger scope. \n\nMeta-ticket #28936 (Adopt mainstream Python testing/linting infrastructure: tox, pytest, ...) would be suitable.",
    "created_at": "2022-03-24T00:04:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516588",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:95" align="right">Comment 95</div>

The present ticket is a bugfix ticket that removes an annoyance with the existing implementation. My goal is to get it in for the Sage 9.6 release.

Larger discussions of `sage -t` vs. `pytest` should best be taken to a ticket with a larger scope. 

Meta-ticket #28936 (Adopt mainstream Python testing/linting infrastructure: tox, pytest, ...) would be suitable.



---

archive/issue_comments_516589.json:
```json
{
    "body": "<div id=\"comment:96\" align=\"right\">Comment 96</div>\n\nWith [comment:94](#comment%3A94) you nuked the ticket description, I assume by accident?",
    "created_at": "2022-03-24T00:05:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516589",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:96" align="right">Comment 96</div>

With [comment:94](#comment%3A94) you nuked the ticket description, I assume by accident?



---

archive/issue_comments_516590.json:
```json
{
    "body": "<div id=\"comment:97\" align=\"right\">Comment 97</div>\n\nSorry to interfere for a minute. I am testing the ticket right now :) but my intervention is cosmetic. I was reading the commit and this bit grabbed my attention\n\n```\n# 31914: Do not run pytest on individual Python files unless\n```\nSurely you meant \"31924\".",
    "created_at": "2022-03-24T01:13:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516590",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:97" align="right">Comment 97</div>

Sorry to interfere for a minute. I am testing the ticket right now :) but my intervention is cosmetic. I was reading the commit and this bit grabbed my attention

```
# 31914: Do not run pytest on individual Python files unless
```
Surely you meant "31924".



---

archive/issue_comments_516591.json:
```json
{
    "body": "<div id=\"comment:98\" align=\"right\">Comment 98</div>\n\nThat was already fixed in a later commit.",
    "created_at": "2022-03-24T03:23:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516591",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:98" align="right">Comment 98</div>

That was already fixed in a later commit.



---

archive/issue_comments_516592.json:
```json
{
    "body": "<div id=\"comment:99\" align=\"right\">Comment 99</div>\n\nReplying to [@mkoeppe](#comment%3A96):\n> With [comment:94](#comment%3A94) you nuked the ticket description, I assume by accident?\n\nOops, I'm sorry.\n\nHere's what I got:\n\n```\n$ ./sagelib -tp 8 --long --all\n...\nTotal time for all tests: 1554.2 seconds\n    cpu time: 10883.7 seconds\n    cumulative wall time: 12084.8 seconds\nFeatures detected for doctesting: graphviz,imagemagick,nauty,palp,pandoc,pdftocairo,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sphinx\n============================= test session starts ==============================\nplatform linux -- Python 3.10.3, pytest-6.2.5, py-1.10.0, pluggy-0.13.1\nrootdir: /opt/sage/sage-git/develop/pkgs/sagemath-standard\nplugins: anyio-3.5.0, xonsh-0.11.0\ncollected 39 items / 3 errors / 36 selected\n\n==================================== ERRORS ====================================\n_ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py __\npkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py:72: in <module>\n    class TestParent2(Parent, metaclass=NestedClassMetaclass):\nsage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)\n    ???\nE   KeyError: 'nested_class_test'\n_ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py __\npkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py:72: in <module>\n    class TestParent2(Parent, metaclass=NestedClassMetaclass):\nsage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)\n    ???\nE   KeyError: 'test_nested_class'\n_ ERROR collecting build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py _\nImportError while importing test module '/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py'.\nHint: make sure your test modules/packages have valid Python names.\nTraceback:\npkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py:3: in <module>\n    from .sage_object import SageObject\nE   ImportError: attempted relative import with no known parent package\n=============================== warnings summary ===============================\n.:0\n  :0: PytestCollectionWarning: cannot collect test class 'TestOutputPlainText' because it has a __init__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/backend_test.py)\n\n.:0\n  :0: PytestCollectionWarning: cannot collect test class 'TestObject' because it has a __new__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/backend_test.py)\n\n.:0\n  :0: PytestCollectionWarning: cannot collect test class 'TestOutputPlainText' because it has a __init__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/test_backend.py)\n\n.:0\n  :0: PytestCollectionWarning: cannot collect test class 'TestObject' because it has a __new__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/test_backend.py)\n\n.:0\n  :0: PytestCollectionWarning: cannot collect 'test_factory' because it is not a function.\n\n-- Docs: https://docs.pytest.org/en/stable/warnings.html\n=========================== short test summary info ============================\nERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py\nERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py\nERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py\n!!!!!!!!!!!!!!!!!!! Interrupted: 3 errors during collection !!!!!!!!!!!!!!!!!!!!\n======================== 5 warnings, 3 errors in 3.93s =========================\n```\nI didn't merge #32975 here, so that may explain these.",
    "created_at": "2022-03-24T09:53:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516592",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:99" align="right">Comment 99</div>

Replying to [@mkoeppe](#comment%3A96):
> With [comment:94](#comment%3A94) you nuked the ticket description, I assume by accident?

Oops, I'm sorry.

Here's what I got:

```
$ ./sagelib -tp 8 --long --all
...
Total time for all tests: 1554.2 seconds
    cpu time: 10883.7 seconds
    cumulative wall time: 12084.8 seconds
Features detected for doctesting: graphviz,imagemagick,nauty,palp,pandoc,pdftocairo,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sphinx
============================= test session starts ==============================
platform linux -- Python 3.10.3, pytest-6.2.5, py-1.10.0, pluggy-0.13.1
rootdir: /opt/sage/sage-git/develop/pkgs/sagemath-standard
plugins: anyio-3.5.0, xonsh-0.11.0
collected 39 items / 3 errors / 36 selected

==================================== ERRORS ====================================
_ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py __
pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py:72: in <module>
    class TestParent2(Parent, metaclass=NestedClassMetaclass):
sage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)
    ???
E   KeyError: 'nested_class_test'
_ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py __
pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py:72: in <module>
    class TestParent2(Parent, metaclass=NestedClassMetaclass):
sage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)
    ???
E   KeyError: 'test_nested_class'
_ ERROR collecting build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py _
ImportError while importing test module '/opt/sage/sage-git/develop/pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py:3: in <module>
    from .sage_object import SageObject
E   ImportError: attempted relative import with no known parent package
=============================== warnings summary ===============================
.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestOutputPlainText' because it has a __init__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/backend_test.py)

.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestObject' because it has a __new__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/backend_test.py)

.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestOutputPlainText' because it has a __init__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/test_backend.py)

.:0
  :0: PytestCollectionWarning: cannot collect test class 'TestObject' because it has a __new__ constructor (from: build/lib.linux-x86_64-3.10/sage/repl/rich_output/test_backend.py)

.:0
  :0: PytestCollectionWarning: cannot collect 'test_factory' because it is not a function.

-- Docs: https://docs.pytest.org/en/stable/warnings.html
=========================== short test summary info ============================
ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py
ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py
ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py
!!!!!!!!!!!!!!!!!!! Interrupted: 3 errors during collection !!!!!!!!!!!!!!!!!!!!
======================== 5 warnings, 3 errors in 3.93s =========================
```
I didn't merge #32975 here, so that may explain these.



---

archive/issue_comments_516593.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">Comment 0</div>\n\nI just had a \"clean\" run in sage-on-gentoo\n\n```\n----------------------------------------------------------------------\nsage -t --long --random-seed=295201559119209171390947016895682587809 sage/env.py  # 2 doctests failed [failed in baseline]\nsage -t --long --random-seed=295201559119209171390947016895682587809 sage/interfaces/gap_workspace.py  # 2 doctests failed [failed in baseline]\nsage -t --long --random-seed=295201559119209171390947016895682587809 sage/plot/plot3d/tachyon.py  # 1 doctest failed [failed in baseline]\nsage -t --long --random-seed=295201559119209171390947016895682587809 sage/tests/startup.py  # 1 doctest failed [failed in baseline]\nsage -t --long --random-seed=295201559119209171390947016895682587809 sage_docbuild/__init__.py  # 2 doctests failed [failed in baseline]\nsage -t --long --random-seed=295201559119209171390947016895682587809 sage_setup/clean.py  # 4 doctests failed [failed in baseline]\nsage -t --long --random-seed=295201559119209171390947016895682587809 sage_setup/find.py  # 8 doctests failed [failed in baseline]\n----------------------------------------------------------------------\nTotal time for all tests: 1515.1 seconds\n    cpu time: 9139.7 seconds\n    cumulative wall time: 11476.1 seconds\nFeatures detected for doctesting: 4ti2,dvipng,imagemagick,nauty,palp,pdftocairo,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sagemath_doc_html,sphinx\n======================================================================================= test session starts =======================================================================================\nplatform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0\nrootdir: /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src, configfile: tox.ini\nplugins: hypothesis-6.38.0\ncollected 36 items\n\nsage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                [ 61%]\nsage/manifolds/differentiable/examples/symplectic_space_test.py ....                                                                                                                        [ 72%]\nsage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                           [ 77%]\nsage/numerical/backends/glpk_backend_test.py ..                                                                                                                                             [ 83%]\nsage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                       [ 88%]\nsage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                    [ 94%]\nsage/numerical/backends/ppl_backend_test.py ..                                                                                                                                              [100%]\n\n======================================================================================= 36 passed in 42.71s =======================================================================================\n```\nYou'll notice that my `sage/tests/cmdline.py` issue disappeared after applying this ticket [including the commits I missed earlier].\n\nIntensive testing, installed and in source, in the last couple of days revealed many pitfalls and things to ponder. I need to do a write up.",
    "created_at": "2022-03-24T10:02:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516593",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:0" align="right">Comment 0</div>

I just had a "clean" run in sage-on-gentoo

```
----------------------------------------------------------------------
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/env.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/interfaces/gap_workspace.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/plot/plot3d/tachyon.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage/tests/startup.py  # 1 doctest failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage_docbuild/__init__.py  # 2 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage_setup/clean.py  # 4 doctests failed [failed in baseline]
sage -t --long --random-seed=295201559119209171390947016895682587809 sage_setup/find.py  # 8 doctests failed [failed in baseline]
----------------------------------------------------------------------
Total time for all tests: 1515.1 seconds
    cpu time: 9139.7 seconds
    cumulative wall time: 11476.1 seconds
Features detected for doctesting: 4ti2,dvipng,imagemagick,nauty,palp,pdftocairo,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sagemath_doc_html,sphinx
======================================================================================= test session starts =======================================================================================
platform linux -- Python 3.10.2, pytest-7.0.1, pluggy-1.0.0
rootdir: /var/tmp/portage/sci-mathematics/sage-9999/work/sage-9999/src, configfile: tox.ini
plugins: hypothesis-6.38.0
collected 36 items

sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                [ 61%]
sage/manifolds/differentiable/examples/symplectic_space_test.py ....                                                                                                                        [ 72%]
sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                           [ 77%]
sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                             [ 83%]
sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                       [ 88%]
sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                    [ 94%]
sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                              [100%]

======================================================================================= 36 passed in 42.71s =======================================================================================
```
You'll notice that my `sage/tests/cmdline.py` issue disappeared after applying this ticket [including the commits I missed earlier].

Intensive testing, installed and in source, in the last couple of days revealed many pitfalls and things to ponder. I need to do a write up.



---

archive/issue_comments_516594.json:
```json
{
    "body": "<div id=\"comment:101\" align=\"right\">Comment 101</div>\n\nReplying to [@mkoeppe](#comment%3A93):\n> #33549 is a big change and will likely take a while to review.\n\nCan we please return to a friendly and constructive discussion. Thanks! There is already enough war going on in the world, that I don't need another one in my freetime.\n\nMy points of criticism of this ticket are:\n- It is not fixing the underlying issue with pytest, but it's hiding it.\n- It removes the feature that you can have pytests in arbitrary python files and run `sage -t file.py` on it to run them. This is important as `sage -t` is supposed to be a thin wrapper around `pytest` (plus, of course, running the actual doctests) and `pytest file.py` behaves that way. We can of course discuss to change the role pytest should play in `sage -t` but that should be better done in a more relaxed environment without time pressure and should take into account the future plans to e.g. make pytest a standard package.\n- It excludes all python files from the pytest discovery, although most of them don't have any issues.\n- It currently excludes the problematic files only at the level of `sage -t` and not `pytest` (that is, all exclusions should be in conftest and not sage-runtests).\n- With #33549 and #32975 there are proper fixes for the issues reported so far.\n- I don't understand why there is time pressure to fix this now in an adhoc manner. The ticket has been open for almost a year and my [comment:30](#comment%3A30) saying that most reported issues should be fixed with #32975 didn't get attention for almost two months. Moreover, it's a problem with an optional package so people can easily opt-out. And finally, there is nothing really broken. `sage -t` still works and runs all doctests just fine, there is only a bunch of additional noise at the end that devs can ignore.",
    "created_at": "2022-03-24T12:36:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516594",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:101" align="right">Comment 101</div>

Replying to [@mkoeppe](#comment%3A93):
> #33549 is a big change and will likely take a while to review.

Can we please return to a friendly and constructive discussion. Thanks! There is already enough war going on in the world, that I don't need another one in my freetime.

My points of criticism of this ticket are:
- It is not fixing the underlying issue with pytest, but it's hiding it.
- It removes the feature that you can have pytests in arbitrary python files and run `sage -t file.py` on it to run them. This is important as `sage -t` is supposed to be a thin wrapper around `pytest` (plus, of course, running the actual doctests) and `pytest file.py` behaves that way. We can of course discuss to change the role pytest should play in `sage -t` but that should be better done in a more relaxed environment without time pressure and should take into account the future plans to e.g. make pytest a standard package.
- It excludes all python files from the pytest discovery, although most of them don't have any issues.
- It currently excludes the problematic files only at the level of `sage -t` and not `pytest` (that is, all exclusions should be in conftest and not sage-runtests).
- With #33549 and #32975 there are proper fixes for the issues reported so far.
- I don't understand why there is time pressure to fix this now in an adhoc manner. The ticket has been open for almost a year and my [comment:30](#comment%3A30) saying that most reported issues should be fixed with #32975 didn't get attention for almost two months. Moreover, it's a problem with an optional package so people can easily opt-out. And finally, there is nothing really broken. `sage -t` still works and runs all doctests just fine, there is only a bunch of additional noise at the end that devs can ignore.



---

archive/issue_comments_516595.json:
```json
{
    "body": "<div id=\"comment:102\" align=\"right\">Comment 102</div>\n\nReplying to [@tornaria](#comment%3A94):\n> If I understood correctly, the goal is to replace the doctest runner by pytest. If so, wouldn't it make more sense to write a different version of `sage-runtests` which is guided by pytest instead of the DC, instead of having `sage-runtests` do two passes on the files, one guided by DC and one guided by pytest?\n\nYes that's the longterm goal. However, we had to start somewhere and it seemed the easiest to first gain some experience with pytest by integrating it in the existing `sage -t` run, and add some pytests (the most extensive ones being for the symplectic forms so far). But yes, this design probably needs changes in the future and I'm very open for discussing different approaches.\n\n> It seems to me it makes much more sense to have two \"drivers\" for running tests. One driver is the current sage-runtests (using DC) and the other driver is a new one using pytest.\n\nI like the idea. \n\n> Some questions about pytest (since I'm not really familiar with it):\n> a. Is pytest expected to have a long life? I understand python has changed test frameworks in the past. Is there a reasonable certainty that this won't happen again (I'm not implying it will -- I'm just asking if you've made this risk analysis).\n\n\npytest has been around for over 10 years and is widely used (e.g. in scipy).\n\n> b. Is there a way that you can make \"pytest ARGUMENTS\" work, i.e. have some configuration for pytest so the correct sage environment, etc. is loaded? If you don't have a plan on how this is supposed to work, then replacing `sage -t` by `pytest` won't really work...\n\nRunning `pytest` already works in principle. Currently the only problem is that some modules still need an initalized sage-env (e.g. environment variables) instead of using the one provided by sage-conf. But there is work in this direction, mainly driven by the needs for the modulaization effort.\n\n> c. If not, could you implement a `sage -pytest` or something like that that will run pytest with the needed environment, arguments, etc.?\n\nYes, one could implement something like this. Say, \n\n- `sage -t` uses the current doctest driver for sage doctests and pytest for actual pytests.\n- `sage -pytest` (or maybe directly `pytest`) uses pytest for both.\n\nI think that could be good design indeed. But as Mathias says, maybe its better to discuss this somewhere else.",
    "created_at": "2022-03-24T12:48:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516595",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:102" align="right">Comment 102</div>

Replying to [@tornaria](#comment%3A94):
> If I understood correctly, the goal is to replace the doctest runner by pytest. If so, wouldn't it make more sense to write a different version of `sage-runtests` which is guided by pytest instead of the DC, instead of having `sage-runtests` do two passes on the files, one guided by DC and one guided by pytest?

Yes that's the longterm goal. However, we had to start somewhere and it seemed the easiest to first gain some experience with pytest by integrating it in the existing `sage -t` run, and add some pytests (the most extensive ones being for the symplectic forms so far). But yes, this design probably needs changes in the future and I'm very open for discussing different approaches.

> It seems to me it makes much more sense to have two "drivers" for running tests. One driver is the current sage-runtests (using DC) and the other driver is a new one using pytest.

I like the idea. 

> Some questions about pytest (since I'm not really familiar with it):
> a. Is pytest expected to have a long life? I understand python has changed test frameworks in the past. Is there a reasonable certainty that this won't happen again (I'm not implying it will -- I'm just asking if you've made this risk analysis).


pytest has been around for over 10 years and is widely used (e.g. in scipy).

> b. Is there a way that you can make "pytest ARGUMENTS" work, i.e. have some configuration for pytest so the correct sage environment, etc. is loaded? If you don't have a plan on how this is supposed to work, then replacing `sage -t` by `pytest` won't really work...

Running `pytest` already works in principle. Currently the only problem is that some modules still need an initalized sage-env (e.g. environment variables) instead of using the one provided by sage-conf. But there is work in this direction, mainly driven by the needs for the modulaization effort.

> c. If not, could you implement a `sage -pytest` or something like that that will run pytest with the needed environment, arguments, etc.?

Yes, one could implement something like this. Say, 

- `sage -t` uses the current doctest driver for sage doctests and pytest for actual pytests.
- `sage -pytest` (or maybe directly `pytest`) uses pytest for both.

I think that could be good design indeed. But as Mathias says, maybe its better to discuss this somewhere else.



---

archive/issue_comments_516596.json:
```json
{
    "body": "<div id=\"comment:103\" align=\"right\">Comment 103</div>\n\nReplying to [@tornaria](#comment%3A99):\n> Replying to [@mkoeppe](#comment%3A96):\n> > With [comment:94](#comment%3A94) you nuked the ticket description, I assume by accident?\n\n> Oops, I'm sorry.\n\nNo worries, I've restored it now.",
    "created_at": "2022-03-24T15:21:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516596",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:103" align="right">Comment 103</div>

Replying to [@tornaria](#comment%3A99):
> Replying to [@mkoeppe](#comment%3A96):
> > With [comment:94](#comment%3A94) you nuked the ticket description, I assume by accident?

> Oops, I'm sorry.

No worries, I've restored it now.



---

archive/issue_comments_516597.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n-pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:\n+`sage -t` is broken since #31003 because\n+- pytest is configured to look for methods prefixed with test_ and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.\n+- pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors.\n \n ```\n $ ./sage -t  src/sage/databases/*.py \n@@ -130,3 +132,92 @@\n ```\n \n \n+In this ticket, we fix it by passing names of regular files to `pytest` only if they match the pytest pattern (ending with `_test.py`).\n+\n+(The dependency #32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)\n+\n+Example:\n+\n+```\n+$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py \n+too many failed tests, not using stored timings\n+Running doctests with ID 2022-03-22-11-30-32-fd280468.\n+Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg\n+Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib\n+Sorting sources by runtime so that slower doctests are run first....\n+Doctesting 27 files using 8 threads.\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx\n+    [52 tests, 0.08 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx\n+    [87 tests, 0.14 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx\n+    [193 tests, 0.17 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx\n+    [221 tests, 0.25 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py\n+    [45 tests, 0.05 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx\n+    [37 tests, 0.07 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx\n+    [25 tests, 0.05 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx\n+    [24 tests, 0.03 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py\n+    [0 tests, 0.00 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx\n+    [96 tests, 0.59 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx\n+    [266 tests, 3.09 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx\n+    [592 tests, 3.08 s]\n+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx\n+    [3070 tests, 31.83 s]\n+----------------------------------------------------------------------\n+All tests passed!\n+----------------------------------------------------------------------\n+Total time for all tests: 32.6 seconds\n+    cpu time: 39.3 seconds\n+    cumulative wall time: 39.4 seconds\n+Features detected for doctesting: sage.rings.number_field\n+============================================================================================================ test session starts ============================================================================================================\n+platform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0\n+rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini\n+collected 32 items                                                                                                                                                                                                                          \n+\n+src/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]\n+src/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]\n+src/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]\n+src/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]\n+src/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]\n+src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]\n+\n+=======================================================================================\n+```\n``````\n",
    "created_at": "2022-03-24T15:21:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516597",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
-pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors:
+`sage -t` is broken since #31003 because
+- pytest is configured to look for methods prefixed with test_ and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.
+- pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors.
 
 ```
 $ ./sage -t  src/sage/databases/*.py 
@@ -130,3 +132,92 @@
 ```
 
 
+In this ticket, we fix it by passing names of regular files to `pytest` only if they match the pytest pattern (ending with `_test.py`).
+
+(The dependency #32975 renamed the files in the Sage sources that used this naming scheme but were not pytest files.)
+
+Example:
+
+```
+$ ./sage -tp src/sage/numerical/backends src/sage/symbolic/expression.pyx src/sage/manifolds/differentiable/symplectic_form_test.py 
+too many failed tests, not using stored timings
+Running doctests with ID 2022-03-22-11-30-32-fd280468.
+Using --optional=4ti2,buckygen,ccache,cryptominisat,debugpy,e_antic,gap_packages,homebrew,igraph,jupymake,latte_int,libsemigroups,lidia,lrslib,meataxe,normaliz,pip,polytopes_db_4d,pynormaliz,sage,sage_spkg
+Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
+Sorting sources by runtime so that slower doctests are run first....
+Doctesting 27 files using 8 threads.
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_sdp_backend.pyx
+    [52 tests, 0.08 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/matrix_sdp_backend.pyx
+    [87 tests, 0.14 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_graph_backend.pyx
+    [193 tests, 0.17 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend.pyx
+    [221 tests, 0.25 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/logging_backend.py
+    [45 tests, 0.05 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pxd
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_sdp_backend.pyx
+    [37 tests, 0.07 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/manifolds/differentiable/symplectic_form_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend.pyx
+    [25 tests, 0.05 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend.pyx
+    [24 tests, 0.03 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/cvxopt_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/ppl_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/__init__.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_exact_backend_test.py
+    [0 tests, 0.00 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/generic_backend.pyx
+    [96 tests, 0.59 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/interactivelp_backend.pyx
+    [266 tests, 3.09 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/numerical/backends/glpk_backend.pyx
+    [592 tests, 3.08 s]
+sage -t --random-seed=156872034187085869352407545599456758260 src/sage/symbolic/expression.pyx
+    [3070 tests, 31.83 s]
+----------------------------------------------------------------------
+All tests passed!
+----------------------------------------------------------------------
+Total time for all tests: 32.6 seconds
+    cpu time: 39.3 seconds
+    cumulative wall time: 39.4 seconds
+Features detected for doctesting: sage.rings.number_field
+============================================================================================================ test session starts ============================================================================================================
+platform darwin -- Python 3.7.8, pytest-7.1.1, pluggy-1.0.0
+rootdir: /Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src, configfile: tox.ini
+collected 32 items                                                                                                                                                                                                                          
+
+src/sage/numerical/backends/cvxopt_backend_test.py ..                                                                                                                                                                                 [  6%]
+src/sage/numerical/backends/glpk_backend_test.py ..                                                                                                                                                                                   [ 12%]
+src/sage/numerical/backends/glpk_exact_backend_test.py ..                                                                                                                                                                             [ 18%]
+src/sage/numerical/backends/interactivelp_backend_test.py ..                                                                                                                                                                          [ 25%]
+src/sage/numerical/backends/ppl_backend_test.py ..                                                                                                                                                                                    [ 31%]
+src/sage/manifolds/differentiable/symplectic_form_test.py ......................                                                                                                                                                      [100%]
+
+=======================================================================================
+```
``````




---

archive/issue_comments_516598.json:
```json
{
    "body": "<div id=\"comment:104\" align=\"right\">Comment 104</div>\n\nReplying to [@tornaria](#comment%3A99):\n> Here's what I got:\n> \n> ```\n> $ ./sagelib -tp 8 --long --all\n> [...]\n> _ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py __\n> pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py:72: in <module>\n>     class TestParent2(Parent, metaclass=NestedClassMetaclass):\n> sage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)\n>     ???\n> E   KeyError: 'nested_class_test'\n> _ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py __\n> pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py:72: in <module>\n> [...]\n> -- Docs: https://docs.pytest.org/en/stable/warnings.html\n> =========================== short test summary info ============================\n> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py\n> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py\n> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py\n> !!!!!!!!!!!!!!!!!!! Interrupted: 3 errors during collection !!!!!!!!!!!!!!!!!!!!\n> ======================== 5 warnings, 3 errors in 3.93s =========================\n> ```\n> I didn't merge #32975 here, so that may explain these.\n\nI think the problem in this test is actually your nonstandard setup in which `conftest.py` is not found. \n\nThis is #33521 (doctesting with pytest fails on system install of sage), see in particular [#33521 comment:8](https://github.com/sagemath/sage/issues/33521#comment:8)",
    "created_at": "2022-03-24T15:26:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516598",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:104" align="right">Comment 104</div>

Replying to [@tornaria](#comment%3A99):
> Here's what I got:
> 
> ```
> $ ./sagelib -tp 8 --long --all
> [...]
> _ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py __
> pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py:72: in <module>
>     class TestParent2(Parent, metaclass=NestedClassMetaclass):
> sage/misc/nested_class.pyx:292: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2384)
>     ???
> E   KeyError: 'nested_class_test'
> _ ERROR collecting build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py __
> pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py:72: in <module>
> [...]
> -- Docs: https://docs.pytest.org/en/stable/warnings.html
> =========================== short test summary info ============================
> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/nested_class_test.py
> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/misc/test_nested_class.py
> ERROR pkgs/sagemath-standard/build/lib.linux-x86_64-3.10/sage/structure/sage_object_test.py
> !!!!!!!!!!!!!!!!!!! Interrupted: 3 errors during collection !!!!!!!!!!!!!!!!!!!!
> ======================== 5 warnings, 3 errors in 3.93s =========================
> ```
> I didn't merge #32975 here, so that may explain these.

I think the problem in this test is actually your nonstandard setup in which `conftest.py` is not found. 

This is #33521 (doctesting with pytest fails on system install of sage), see in particular [#33521 comment:8](https://github.com/sagemath/sage/issues/33521#comment:8)



---

archive/issue_comments_516599.json:
```json
{
    "body": "Changed dependencies from **#32975** to **#32975, #33549**",
    "created_at": "2022-03-25T18:17:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516599",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#32975** to **#32975, #33549**



---

archive/issue_comments_516600.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-`sage -t` is broken since #31003 because\n+`sage -t` is broken since #31003/#31103 because\n - pytest is configured to look for methods prefixed with test_ and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.\n - pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors.\n \n``````\n",
    "created_at": "2022-03-25T18:22:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516600",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-`sage -t` is broken since #31003 because
+`sage -t` is broken since #31003/#31103 because
 - pytest is configured to look for methods prefixed with test_ and treats them as pytest test functions/methods, which are then executed. However, sage's code base contains some functions in its codebase that match this pattern without being pytests.
 - pytest (#31003) is configured to only discover `*_test.py` files; but if one uses `sage -t` with file arguments, this will override it and lead to many errors.
 
``````




---

archive/issue_comments_516601.json:
```json
{
    "body": "Changed commit from **[5e95c77](https://github.com/sagemath/sagetrac-mirror/commit/5e95c776153232ad7e9d67975e3ec68768b0ba05)** to **[3839de6](https://github.com/sagemath/sagetrac-mirror/commit/3839de6874abe8c1e884a5cf26efc6882945797e)**",
    "created_at": "2022-03-25T18:22:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516601",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5e95c77](https://github.com/sagemath/sagetrac-mirror/commit/5e95c776153232ad7e9d67975e3ec68768b0ba05)** to **[3839de6](https://github.com/sagemath/sagetrac-mirror/commit/3839de6874abe8c1e884a5cf26efc6882945797e)**



---

archive/issue_comments_516602.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3dc0f63ecd2c28e5b052e37a0c1c9a384bff0519\">3dc0f63</a></td><td><code>Cleanup cmdline</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/321bd9d61707378d9bda9184fd2dfd23997f6f02\">321bd9d</a></td><td><code>Revert changes in test_class_pickling</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/db1d5057631df267cd0ce385b15d4e206aef2e6d\">db1d505</a></td><td><code>Fix tests in sageinspect</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a09d5ec39cfb6457165e3b86d1afbee27b326fce\">a09d5ec</a></td><td><code>Fix test_long</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7060ea12bc95374388037768cb8a3fcc12ac51ea\">7060ea1</a></td><td><code>Fix imports in modular decomposition</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dec7b7bde0d64721bb1138ebe50a24304bf42ecf\">dec7b7b</a></td><td><code>Fix doctest in rings</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1b7da1bdc63dc9caa270dd11a7f89e0745c8e1ae\">1b7da1b</a></td><td><code>Merge remote-tracking branch 'trac/public/tests/doctests_pytest' into public/tests/pytest_wrong_test_methods</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3cab51db41dbc2374bef98658d5e0fa90ab37246\">3cab51d</a></td><td><code>Fix spelling</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e6312ec2b0b453a3a0f6f9a88546e0e913f16a24\">e6312ec</a></td><td><code>Add docs to newly added pytest hook</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3839de6874abe8c1e884a5cf26efc6882945797e\">3839de6</a></td><td><code>Merge #33549</code></td></tr></table>\n",
    "created_at": "2022-03-25T18:22:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516602",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7" align="right">Comment 7</div>

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3dc0f63ecd2c28e5b052e37a0c1c9a384bff0519">3dc0f63</a></td><td><code>Cleanup cmdline</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/321bd9d61707378d9bda9184fd2dfd23997f6f02">321bd9d</a></td><td><code>Revert changes in test_class_pickling</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/db1d5057631df267cd0ce385b15d4e206aef2e6d">db1d505</a></td><td><code>Fix tests in sageinspect</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a09d5ec39cfb6457165e3b86d1afbee27b326fce">a09d5ec</a></td><td><code>Fix test_long</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7060ea12bc95374388037768cb8a3fcc12ac51ea">7060ea1</a></td><td><code>Fix imports in modular decomposition</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dec7b7bde0d64721bb1138ebe50a24304bf42ecf">dec7b7b</a></td><td><code>Fix doctest in rings</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1b7da1bdc63dc9caa270dd11a7f89e0745c8e1ae">1b7da1b</a></td><td><code>Merge remote-tracking branch 'trac/public/tests/doctests_pytest' into public/tests/pytest_wrong_test_methods</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3cab51db41dbc2374bef98658d5e0fa90ab37246">3cab51d</a></td><td><code>Fix spelling</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e6312ec2b0b453a3a0f6f9a88546e0e913f16a24">e6312ec</a></td><td><code>Add docs to newly added pytest hook</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3839de6874abe8c1e884a5cf26efc6882945797e">3839de6</a></td><td><code>Merge #33549</code></td></tr></table>




---

archive/issue_comments_516603.json:
```json
{
    "body": "Changed commit from **[3839de6](https://github.com/sagemath/sagetrac-mirror/commit/3839de6874abe8c1e884a5cf26efc6882945797e)** to **[8139e09](https://github.com/sagemath/sagetrac-mirror/commit/8139e09da93aeb9d3f2358d634596eeea2e0c7f5)**",
    "created_at": "2022-03-26T18:16:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516603",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[3839de6](https://github.com/sagemath/sagetrac-mirror/commit/3839de6874abe8c1e884a5cf26efc6882945797e)** to **[8139e09](https://github.com/sagemath/sagetrac-mirror/commit/8139e09da93aeb9d3f2358d634596eeea2e0c7f5)**



---

archive/issue_comments_516604.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6768bd22e6784a0f062778bde3efecced73ce8b6\">6768bd2</a></td><td><code>src/sage/tests/cmdline.py: Restore dropped line in doctest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8139e09da93aeb9d3f2358d634596eeea2e0c7f5\">8139e09</a></td><td><code>Merge #33549</code></td></tr></table>\n",
    "created_at": "2022-03-26T18:16:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516604",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8" align="right">Comment 8</div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6768bd22e6784a0f062778bde3efecced73ce8b6">6768bd2</a></td><td><code>src/sage/tests/cmdline.py: Restore dropped line in doctest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8139e09da93aeb9d3f2358d634596eeea2e0c7f5">8139e09</a></td><td><code>Merge #33549</code></td></tr></table>




---

archive/issue_comments_516605.json:
```json
{
    "body": "<div id=\"comment:109\" align=\"right\">Comment 109</div>\n\nReplying to [@tobiasdiez](#comment%3A101):\n> My points of criticism of this ticket are:\n\nThanks for the summary - most of them have been asked and answered.\n\n> - It is not fixing the underlying issue with pytest, but it's hiding it.\n\nAnswered in [comment:73](#comment%3A73)\n\n> - It removes the feature that you can have pytests in arbitrary python files and run `sage -t file.py` on it to run them. This is important as `sage -t` is supposed to be a thin wrapper around `pytest` [...]\n\nNo, this was never the stated design goal. The motivation for having `sage -t` invoke `pytest`, implemented in #31103, is that the test coverage of running `sage -t` is not reduced by migrating tests to pytest.\n\nA \"thin wrapper around pytest\" would have pytest's actual interface (passing command line options etc.) and could be `sage -pytest` as suggested in [comment:94](#comment%3A94) or `sage -tox -e pytest`.\n\n> - It excludes all python files from the pytest discovery, although most of them don't have any issues.\n\nThat's how #31103 should have originally implemented it.\n\n> - It currently excludes the problematic files only at the level of `sage -t` and not `pytest` (that is, all exclusions should be in conftest and not sage-runtests).\n\nAnswered in [comment:73](#comment%3A73)\n\n> - With #33549 and #32975 there are proper fixes for the issues reported so far.\n\n#33549 is now a dependency of the present ticket.\n\nThere's still more to be addressed in #33550, #33560, and #33561 in order to fix everything that is fixed by the present ticket.\n\n> - I don't understand why there is time pressure to fix this now in an adhoc manner. [...]\n\nAnswered in [comment:45](#comment%3A45), [comment:69](#comment%3A69).",
    "created_at": "2022-03-26T18:34:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516605",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:109" align="right">Comment 109</div>

Replying to [@tobiasdiez](#comment%3A101):
> My points of criticism of this ticket are:

Thanks for the summary - most of them have been asked and answered.

> - It is not fixing the underlying issue with pytest, but it's hiding it.

Answered in [comment:73](#comment%3A73)

> - It removes the feature that you can have pytests in arbitrary python files and run `sage -t file.py` on it to run them. This is important as `sage -t` is supposed to be a thin wrapper around `pytest` [...]

No, this was never the stated design goal. The motivation for having `sage -t` invoke `pytest`, implemented in #31103, is that the test coverage of running `sage -t` is not reduced by migrating tests to pytest.

A "thin wrapper around pytest" would have pytest's actual interface (passing command line options etc.) and could be `sage -pytest` as suggested in [comment:94](#comment%3A94) or `sage -tox -e pytest`.

> - It excludes all python files from the pytest discovery, although most of them don't have any issues.

That's how #31103 should have originally implemented it.

> - It currently excludes the problematic files only at the level of `sage -t` and not `pytest` (that is, all exclusions should be in conftest and not sage-runtests).

Answered in [comment:73](#comment%3A73)

> - With #33549 and #32975 there are proper fixes for the issues reported so far.

#33549 is now a dependency of the present ticket.

There's still more to be addressed in #33550, #33560, and #33561 in order to fix everything that is fixed by the present ticket.

> - I don't understand why there is time pressure to fix this now in an adhoc manner. [...]

Answered in [comment:45](#comment%3A45), [comment:69](#comment%3A69).



---

archive/issue_comments_516606.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">Comment 0</div>\n\nReady for review.",
    "created_at": "2022-03-26T18:34:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516606",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:0" align="right">Comment 0</div>

Ready for review.



---

archive/issue_comments_516607.json:
```json
{
    "body": "<div id=\"comment:111\" align=\"right\">Comment 111</div>\n\nReplying to [@mkoeppe](#comment%3A109):\n> A \"thin wrapper around pytest\" would have pytest's actual interface (passing command line options etc.) and could be `sage -pytest` as suggested in [comment:94](#comment%3A94) \n\nI've opened #33572 for this one.",
    "created_at": "2022-03-26T19:07:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516607",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:111" align="right">Comment 111</div>

Replying to [@mkoeppe](#comment%3A109):
> A "thin wrapper around pytest" would have pytest's actual interface (passing command line options etc.) and could be `sage -pytest` as suggested in [comment:94](#comment%3A94) 

I've opened #33572 for this one.



---

archive/issue_comments_516608.json:
```json
{
    "body": "<div id=\"comment:112\" align=\"right\">Comment 112</div>\n\nReplying to [@soehms](#comment%3A91):\n> LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.\n\nThere's no fundamental discussion happening here. It's not a question of \"either-or\", but a strategy of fixing now what can be fixed to get a high quality release 9.6, and doing the larger fixes when they are ready. In [comment:78](#comment%3A78), [comment:89](#comment%3A89), [comment:90](#comment%3A90), etc. I have already explained how to adjust the change in this ticket when this work is done.",
    "created_at": "2022-03-26T19:21:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516608",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:112" align="right">Comment 112</div>

Replying to [@soehms](#comment%3A91):
> LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.

There's no fundamental discussion happening here. It's not a question of "either-or", but a strategy of fixing now what can be fixed to get a high quality release 9.6, and doing the larger fixes when they are ready. In [comment:78](#comment%3A78), [comment:89](#comment%3A89), [comment:90](#comment%3A90), etc. I have already explained how to adjust the change in this ticket when this work is done.



---

archive/issue_events_421950.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-03-27T10:25:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421950"
}
```



---

archive/issue_events_421951.json:
```json
{
    "actor": "https://github.com/soehms",
    "created_at": "2022-03-27T10:25:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421951"
}
```



---

archive/issue_comments_516609.json:
```json
{
    "body": "<div id=\"comment:113\" align=\"right\">Comment 113</div>\n\nReplying to [@mkoeppe](#comment%3A112):\n> Replying to [@soehms](#comment%3A91):\n> > LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.\n\n> \n> There's no fundamental discussion happening here. It's not a question of \"either-or\", but a strategy of fixing now what can be fixed to get a high quality release 9.6, and doing the larger fixes when they are ready. In [comment:78](#comment%3A78), [comment:89](#comment%3A89), [comment:90](#comment%3A90), etc. I have already explained how to adjust the change in this ticket when this work is done.\n\nI've seen that the discussion was about strategy. But obviously the strategy was not clarified completely and thus the discussion was not finished at that point. By your comment [comment 109](https://github.com/sagemath/sage/issues/31924#comment:109) and the new ticket #33572 the situation is improved, now.\n\nThe difficulty with this ticket is that it shades out a couple of issues Tobias is currently working on. I can understand that this was annoying. For example the bug treated in #33550 will not show any more in the way as it did before if this ticket is released.\n\nThus, we should work throughout all of these issues and find new test cases for them, now. Probably, the best way to do this is to use #33572.",
    "created_at": "2022-03-27T10:25:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516609",
    "user": "https://github.com/soehms"
}
```

<div id="comment:113" align="right">Comment 113</div>

Replying to [@mkoeppe](#comment%3A112):
> Replying to [@soehms](#comment%3A91):
> > LGTM. From my point of view this can get a positive review depending on how the fundamental discussion comes to an end.

> 
> There's no fundamental discussion happening here. It's not a question of "either-or", but a strategy of fixing now what can be fixed to get a high quality release 9.6, and doing the larger fixes when they are ready. In [comment:78](#comment%3A78), [comment:89](#comment%3A89), [comment:90](#comment%3A90), etc. I have already explained how to adjust the change in this ticket when this work is done.

I've seen that the discussion was about strategy. But obviously the strategy was not clarified completely and thus the discussion was not finished at that point. By your comment [comment 109](https://github.com/sagemath/sage/issues/31924#comment:109) and the new ticket #33572 the situation is improved, now.

The difficulty with this ticket is that it shades out a couple of issues Tobias is currently working on. I can understand that this was annoying. For example the bug treated in #33550 will not show any more in the way as it did before if this ticket is released.

Thus, we should work throughout all of these issues and find new test cases for them, now. Probably, the best way to do this is to use #33572.



---

archive/issue_comments_516610.json:
```json
{
    "body": "<div id=\"comment:114\" align=\"right\">Comment 114</div>\n\nReplying to [@mkoeppe](#comment%3A109):\n> > - With #33549 and #32975 there are proper fixes for the issues reported so far.\n\n> \n> #33549 is now a dependency of the present ticket.\n> \n> There's still more to be addressed in #33550, #33560, and #33561 in order to fix everything that is fixed by the present ticket.\n\nAll of which are ready for review.",
    "created_at": "2022-03-27T12:23:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516610",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:114" align="right">Comment 114</div>

Replying to [@mkoeppe](#comment%3A109):
> > - With #33549 and #32975 there are proper fixes for the issues reported so far.

> 
> #33549 is now a dependency of the present ticket.
> 
> There's still more to be addressed in #33550, #33560, and #33561 in order to fix everything that is fixed by the present ticket.

All of which are ready for review.



---

archive/issue_comments_516611.json:
```json
{
    "body": "<div id=\"comment:115\" align=\"right\">Comment 115</div>\n\nReplying to [@soehms](#comment%3A113):\n> The difficulty with this ticket is that it shades out a couple of issues Tobias is currently working on. I can understand that this was annoying. For example the bug treated in #33550 will not show any more in the way as it did before if this ticket is released.\n> \n> Thus, we should work throughout all of these issues and find new test cases for them, now. Probably, the best way to do this is to use #33572.\n\nI agree #33572 would be a good way to test. But as the discussion there shows running `pytest somefile.py` still needs a lot of work until it works because `sage.all` is not imported. On the other hand, `sage -t` takes care of this.\n\nI hope #33550, #33560, and #33561 get reviewed before this ticket here is merged, since otherwise the reviewers have to revert the changes manually before running `sage -t`.",
    "created_at": "2022-03-27T12:28:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516611",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:115" align="right">Comment 115</div>

Replying to [@soehms](#comment%3A113):
> The difficulty with this ticket is that it shades out a couple of issues Tobias is currently working on. I can understand that this was annoying. For example the bug treated in #33550 will not show any more in the way as it did before if this ticket is released.
> 
> Thus, we should work throughout all of these issues and find new test cases for them, now. Probably, the best way to do this is to use #33572.

I agree #33572 would be a good way to test. But as the discussion there shows running `pytest somefile.py` still needs a lot of work until it works because `sage.all` is not imported. On the other hand, `sage -t` takes care of this.

I hope #33550, #33560, and #33561 get reviewed before this ticket here is merged, since otherwise the reviewers have to revert the changes manually before running `sage -t`.



---

archive/issue_comments_516612.json:
```json
{
    "body": "<div id=\"comment:116\" align=\"right\">Comment 116</div>\n\nMay I suggest adding some switches to `sage-runtests`:\n- `--skip-doctest`: if given, the `DocTestController` run would be skipped\n- `--skip-pytest`: if given, the pytest run would be skipped\n\nAnd maybe:\n- `--pytest-all`: if given, the filename filter implemented in this ticket would not be applied, so pytest would be run for all the given arguments\n\nI think it would be quite useful (a) if I happen to have pytest installed and for some reason (maybe something is broken, perhaps because a bug in my system pytest, whatever) I prefer to skip pytest (b) if I want to actually test pytest (maybe I'm working on the pytest code) I may want to run pytest on different arguments without having to wait for doctest (c) want to run pytest on some file not matching the pattern.\n\nAll of these are easy to acomplish by trivial patching of `sage-runtests` but it's much more convenient to be able to get these different behaviours with an unchanged script.",
    "created_at": "2022-03-27T15:08:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516612",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:116" align="right">Comment 116</div>

May I suggest adding some switches to `sage-runtests`:
- `--skip-doctest`: if given, the `DocTestController` run would be skipped
- `--skip-pytest`: if given, the pytest run would be skipped

And maybe:
- `--pytest-all`: if given, the filename filter implemented in this ticket would not be applied, so pytest would be run for all the given arguments

I think it would be quite useful (a) if I happen to have pytest installed and for some reason (maybe something is broken, perhaps because a bug in my system pytest, whatever) I prefer to skip pytest (b) if I want to actually test pytest (maybe I'm working on the pytest code) I may want to run pytest on different arguments without having to wait for doctest (c) want to run pytest on some file not matching the pattern.

All of these are easy to acomplish by trivial patching of `sage-runtests` but it's much more convenient to be able to get these different behaviours with an unchanged script.



---

archive/issue_comments_516613.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nThanks for the review.",
    "created_at": "2022-03-27T15:08:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516613",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">Comment 7</div>

Thanks for the review.



---

archive/issue_comments_516614.json:
```json
{
    "body": "<div id=\"comment:118\" align=\"right\">Comment 118</div>\n\nReplying to [@tornaria](#comment%3A116):\n> May I suggest adding some switches to `sage-runtests`\n\nSeparate ticket",
    "created_at": "2022-03-27T15:09:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516614",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:118" align="right">Comment 118</div>

Replying to [@tornaria](#comment%3A116):
> May I suggest adding some switches to `sage-runtests`

Separate ticket



---

archive/issue_comments_516615.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nThis is on Apple Silicon M1 Macs with Homebrew up to date, both macOS 11.6.5 (Big Sur) with Xcode 13.2.1 and macOS 12.3 (Monterey) with Xcode 13.3.\n\nSageMath 9.6.beta6 together with this ticket #31924 and nothing else:\nafter `make` and `make pytest`, `make ptestlong` gives\n\n```\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 311, in sage.tests.cmdline._test_executable\nFailed example:\n    (out, err, ret) = test_executable([\"sage\", \"-t\", script])\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/sagemath/SageMath/Git/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/sagemath/SageMath/Git/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tests.cmdline._test_executable[107]>\", line 1, in <module>\n        (out, err, ret) = test_executable([\"sage\", \"-t\", script])\n    NameError: name 'test_executable' is not defined\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 314, in sage.tests.cmdline._test_executable\nFailed example:\n    out.find(\"All tests passed!\") >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n```\nAm I doing something wrong?\n\nBTW, I am at a loss with all the tickets mentioned here. Some would not merge with this one.",
    "created_at": "2022-03-27T21:14:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516615",
    "user": "https://github.com/GMS103"
}
```

<div id="comment:9" align="right">Comment 9</div>

This is on Apple Silicon M1 Macs with Homebrew up to date, both macOS 11.6.5 (Big Sur) with Xcode 13.2.1 and macOS 12.3 (Monterey) with Xcode 13.3.

SageMath 9.6.beta6 together with this ticket #31924 and nothing else:
after `make` and `make pytest`, `make ptestlong` gives

```
**********************************************************************
File "src/sage/tests/cmdline.py", line 311, in sage.tests.cmdline._test_executable
Failed example:
    (out, err, ret) = test_executable(["sage", "-t", script])
Exception raised:
    Traceback (most recent call last):
      File "/Users/sagemath/SageMath/Git/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/sagemath/SageMath/Git/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.cmdline._test_executable[107]>", line 1, in <module>
        (out, err, ret) = test_executable(["sage", "-t", script])
    NameError: name 'test_executable' is not defined
**********************************************************************
File "src/sage/tests/cmdline.py", line 314, in sage.tests.cmdline._test_executable
Failed example:
    out.find("All tests passed!") >= 0
Expected:
    True
Got:
    False
**********************************************************************
```
Am I doing something wrong?

BTW, I am at a loss with all the tickets mentioned here. Some would not merge with this one.



---

archive/issue_comments_516616.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">Comment 0</div>\n\nThat's fixed in the latest version of #33549 - I haven't merged that here.",
    "created_at": "2022-03-27T23:04:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516616",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:0" align="right">Comment 0</div>

That's fixed in the latest version of #33549 - I haven't merged that here.



---

archive/issue_comments_516617.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nFWIW, positive review for [SageMath](../wiki/SageMath) 9.6.beta6 plus #31924 and #33549 plus `make pytest` on Apple Silicon M1 Macs with Homebrew up to date, both macOS 11.6.5 (Big Sur) with Xcode 13.2.1 and macOS 12.3 (Monterey) with Xcode 13.3.",
    "created_at": "2022-03-28T01:02:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516617",
    "user": "https://github.com/GMS103"
}
```

<div id="comment:1" align="right">Comment 1</div>

FWIW, positive review for [SageMath](../wiki/SageMath) 9.6.beta6 plus #31924 and #33549 plus `make pytest` on Apple Silicon M1 Macs with Homebrew up to date, both macOS 11.6.5 (Big Sur) with Xcode 13.2.1 and macOS 12.3 (Monterey) with Xcode 13.3.



---

archive/issue_comments_516618.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nSorry for the lack of attention!",
    "created_at": "2022-03-28T05:58:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516618",
    "user": "https://github.com/soehms"
}
```

<div id="comment:2" align="right">Comment 2</div>

Sorry for the lack of attention!



---

archive/issue_events_421952.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2022-03-30T00:45:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421952"
}
```



---

archive/issue_events_421953.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2022-03-30T00:45:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421953"
}
```



---

archive/issue_comments_516619.json:
```json
{
    "body": "Changed commit from **[8139e09](https://github.com/sagemath/sagetrac-mirror/commit/8139e09da93aeb9d3f2358d634596eeea2e0c7f5)** to **[1214e0c](https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda)**",
    "created_at": "2022-03-30T00:45:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516619",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[8139e09](https://github.com/sagemath/sagetrac-mirror/commit/8139e09da93aeb9d3f2358d634596eeea2e0c7f5)** to **[1214e0c](https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda)**



---

archive/issue_comments_516620.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1414bc80e8ecdbd7917fc5fdfca17c43550b97ab\">1414bc8</a></td><td><code>src/bin/sage-runtests: Do not run pytest on individual Python files unless they match the pytest file pattern</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/89c7a8e82086fdfe8bf412e648a0c7684d3fcebc\">89c7a8e</a></td><td><code>src/bin/sage-runtests: Do not run pytest on *.pyx, *.pxd, *.rst, etc.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda\">1214e0c</a></td><td><code>src/bin/sage-runtests: Use os.path.isfile, fix ticket number in comment</code></td></tr></table>\n",
    "created_at": "2022-03-30T00:45:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516620",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3" align="right">Comment 3</div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1414bc80e8ecdbd7917fc5fdfca17c43550b97ab">1414bc8</a></td><td><code>src/bin/sage-runtests: Do not run pytest on individual Python files unless they match the pytest file pattern</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/89c7a8e82086fdfe8bf412e648a0c7684d3fcebc">89c7a8e</a></td><td><code>src/bin/sage-runtests: Do not run pytest on *.pyx, *.pxd, *.rst, etc.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda">1214e0c</a></td><td><code>src/bin/sage-runtests: Use os.path.isfile, fix ticket number in comment</code></td></tr></table>




---

archive/issue_comments_516621.json:
```json
{
    "body": "Changed dependencies from **#32975, #33549** to none",
    "created_at": "2022-03-30T00:46:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516621",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#32975, #33549** to none



---

archive/issue_comments_516622.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nRebased on 9.6.beta6, away from #33549",
    "created_at": "2022-03-30T00:46:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516622",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">Comment 4</div>

Rebased on 9.6.beta6, away from #33549



---

archive/issue_events_421954.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-30T00:46:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421954"
}
```



---

archive/issue_events_421955.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-30T00:46:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421955"
}
```



---

archive/issue_comments_516623.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern)** to **[1214e0c](https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda)**",
    "created_at": "2022-04-02T10:53:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31924#issuecomment-516623",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage__t__do_not_run_pytest_on_individual_python_files_unless_they_match_the_pytest_file_pattern)** to **[1214e0c](https://github.com/sagemath/sagetrac-mirror/commit/1214e0c2f2aa9838bd3019cbfe8b38f042e79dda)**



---

archive/issue_events_421956.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-04-02T10:53:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421956"
}
```



---

archive/issue_events_421957.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "e39a3a2736bdcbbe6fed362ee6705c4ddb7e8263",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-04-02T10:53:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31924",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31924#event-421957"
}
```
