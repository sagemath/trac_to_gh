# Issue 31034: Fix sage -package download --allow-upstream, add option --on-error=warn, add filtering to sage -package upload

archive/issues_030797.json:
```json
{
    "body": "After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using\n\n```\n./sage -package download --allow-upstream --on-error=warn :all:\n```\nfollowed by \n\n```\n./sage -package upload :all:\n```\n... if someone is able to set up the necessary credentials for the workflow.\n\nWe also add a mechanism to exclude non-distributable tarballs:  If a tarball name includes the pattern `do-not-distribute`, `sage -package upload` now skips it and logs a message.  We change the name of the tarball of `scipoptsuite` accordingly - this is our only non-distributable tarball.\n\n\n\nCC:  @vbraun @kliem @tobiasdiez @dimpase @jplab @slel @seblabbe\n\nBranch/Commit: 274db614ef204d682e15cebdf76c0df648c7c7e5\n\nReviewer: Jonathan Kliem, Volker Braun\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31034\n\n",
    "closed_at": "2020-12-27T23:25:48Z",
    "created_at": "2020-12-10T00:41:22Z",
    "labels": [
        "component: distribution",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Fix sage -package download --allow-upstream, add option --on-error=warn, add filtering to sage -package upload",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31034",
    "user": "https://github.com/mkoeppe"
}
```
After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using

```
./sage -package download --allow-upstream --on-error=warn :all:
```
followed by 

```
./sage -package upload :all:
```
... if someone is able to set up the necessary credentials for the workflow.

We also add a mechanism to exclude non-distributable tarballs:  If a tarball name includes the pattern `do-not-distribute`, `sage -package upload` now skips it and logs a message.  We change the name of the tarball of `scipoptsuite` accordingly - this is our only non-distributable tarball.



CC:  @vbraun @kliem @tobiasdiez @dimpase @jplab @slel @seblabbe

Branch/Commit: 274db614ef204d682e15cebdf76c0df648c7c7e5

Reviewer: Jonathan Kliem, Volker Braun

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31034





---

archive/issue_comments_469700.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -10,6 +10,10 @@\n \\`\\`\\`\n ... if someone is able to set up the necessary credentials for the workflow.\n \n+(We may want to use a mechanism to exclude non-distributable tarballs -- in case an upgrade ticket for \\`scipoptsuite\\` adds \\`upstream_url\\`. For example we could include a pattern such as \\`-do-not-distribute\\` as part of the tarball name for such packages.)\n+\n+\n+\n Comment: 1\n \n Summary: GH Actions workflow to sync upstream packages to the Sage server\n```\n",
    "created_at": "2020-12-10T03:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469700",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -10,6 +10,10 @@
 \`\`\`
 ... if someone is able to set up the necessary credentials for the workflow.
 
+(We may want to use a mechanism to exclude non-distributable tarballs -- in case an upgrade ticket for \`scipoptsuite\` adds \`upstream_url\`. For example we could include a pattern such as \`-do-not-distribute\` as part of the tarball name for such packages.)
+
+
+
 Comment: 1
 
 Summary: GH Actions workflow to sync upstream packages to the Sage server
```




---

archive/issue_comments_469701.json:
```json
{
    "body": "<a id='comment:2'></a>it might be more reasonable to do this with a special GH action.\nThen it can be run on e.g. Volker's repo by him, e.g. while making a beta.",
    "created_at": "2020-12-10T13:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469701",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>it might be more reasonable to do this with a special GH action.
Then it can be run on e.g. Volker's repo by him, e.g. while making a beta.



---

archive/issue_comments_469702.json:
```json
{
    "body": "<a id='comment:3'></a>I tried to put it into my release management script but it doesn't actually try to download from the `upstream_url`:\n\n```\n$ cat build/pkgs/pynormaliz/checksums.ini \ntarball=PyNormaliz-VERSION.tar.gz\nsha1=c01c7a734deeb09e1dd236fb53575b152b99657b\nmd5=6ff9ccc61592190fdb88fe08a50e062c\ncksum=3111232777\nupstream_url=https://pypi.io/packages/source/p/pynormaliz/PyNormaliz-VERSION.tar.gz\n\n$ ./sage -package download --allow-upstream pynormaliz\n[...]\nhttp://sagepad.org/spkg/upstream/pynormaliz/PyNormaliz-2.13.tar.gz\n[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\nERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/pynormaliz/PyNormaliz-2.13.tar.gz'\nTraceback (most recent call last):\n  File \"/home/release/Sage/build/bin/sage-package\", line 42, in <module>\n    run()\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py\", line 339, in run\n    app.download_cls(args.package_name, args.allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 177, in download_cls\n    pc.apply(self.download)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py\", line 71, in apply\n    function(package_name, *args, **kwds)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 167, in download\n    package.tarball.download(allow_upstream=allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/tarball.py\", line 177, in download\n    raise FileNotMirroredError('tarball does not exist on mirror network')\nsage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network\n```\nIs there anything that I'm doing wrong?",
    "created_at": "2020-12-20T11:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469702",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>I tried to put it into my release management script but it doesn't actually try to download from the `upstream_url`:

```
$ cat build/pkgs/pynormaliz/checksums.ini 
tarball=PyNormaliz-VERSION.tar.gz
sha1=c01c7a734deeb09e1dd236fb53575b152b99657b
md5=6ff9ccc61592190fdb88fe08a50e062c
cksum=3111232777
upstream_url=https://pypi.io/packages/source/p/pynormaliz/PyNormaliz-VERSION.tar.gz

$ ./sage -package download --allow-upstream pynormaliz
[...]
http://sagepad.org/spkg/upstream/pynormaliz/PyNormaliz-2.13.tar.gz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/pynormaliz/PyNormaliz-2.13.tar.gz'
Traceback (most recent call last):
  File "/home/release/Sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py", line 339, in run
    app.download_cls(args.package_name, args.allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 177, in download_cls
    pc.apply(self.download)
  File "/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py", line 71, in apply
    function(package_name, *args, **kwds)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 167, in download
    package.tarball.download(allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/tarball.py", line 177, in download
    raise FileNotMirroredError('tarball does not exist on mirror network')
sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
```
Is there anything that I'm doing wrong?



---

archive/issue_comments_469703.json:
```json
{
    "body": "<a id='comment:4'></a>./configure must be run with\n`--enable-download-from-upstream-url`",
    "created_at": "2020-12-20T12:24:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469703",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>./configure must be run with
`--enable-download-from-upstream-url`



---

archive/issue_comments_469704.json:
```json
{
    "body": "<a id='comment:5'></a>Is the `--allow-upstream` actually doing anything or is only the configure switch relevant?",
    "created_at": "2020-12-20T14:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469704",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>Is the `--allow-upstream` actually doing anything or is only the configure switch relevant?



---

archive/issue_comments_469705.json:
```json
{
    "body": "<a id='comment:6'></a>`./sage -package` does NOT respect the configure switch, it only handles `--allow-upstream`... which, however, was indeed broken",
    "created_at": "2020-12-20T19:38:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469705",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>`./sage -package` does NOT respect the configure switch, it only handles `--allow-upstream`... which, however, was indeed broken



---

archive/issue_comments_469706.json:
```json
{
    "body": "<a id='comment:8'></a>New commits:",
    "created_at": "2020-12-20T19:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469706",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>New commits:



---

archive/issue_comments_469707.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-20T19:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469707",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_469708.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,17 @@\n+After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using\n+\n+\\`\\`\\`\n+./sage -package download --allow-upstream :all:\n+\\`\\`\\`\n+followed by \n+\n+\\`\\`\\`\n+./sage -package upload :all:\n+\\`\\`\\`\n+... if someone is able to set up the necessary credentials for the workflow.\n+\n+(We may want to use a mechanism to exclude non-distributable tarballs -- in case an upgrade ticket for \\`scipoptsuite\\` adds \\`upstream_url\\`. For example we could include a pattern such as \\`-do-not-distribute\\` as part of the tarball name for such packages.)\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-12-22T16:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469708",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,17 @@
+After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using
+
+\`\`\`
+./sage -package download --allow-upstream :all:
+\`\`\`
+followed by 
+
+\`\`\`
+./sage -package upload :all:
+\`\`\`
+... if someone is able to set up the necessary credentials for the workflow.
+
+(We may want to use a mechanism to exclude non-distributable tarballs -- in case an upgrade ticket for \`scipoptsuite\` adds \`upstream_url\`. For example we could include a pattern such as \`-do-not-distribute\` as part of the tarball name for such packages.)
+
 
 
 Comment: 1
```




---

archive/issue_comments_469709.json:
```json
{
    "body": "<a id='comment:11'></a>Why did you update pynormaliz to 7.77?",
    "created_at": "2020-12-22T16:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469709",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Why did you update pynormaliz to 7.77?



---

archive/issue_comments_469710.json:
```json
{
    "body": "<a id='comment:12'></a>Sorry...",
    "created_at": "2020-12-22T16:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469710",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Sorry...



---

archive/issue_comments_469711.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-12-22T16:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469711",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_469712.json:
```json
{
    "body": "<a id='comment:14'></a>This ticket looks like a left over from somewhere else.\n\nI mean, why was `download_with_args` defined but never used?",
    "created_at": "2020-12-22T16:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469712",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'></a>This ticket looks like a left over from somewhere else.

I mean, why was `download_with_args` defined but never used?



---

archive/issue_comments_469713.json:
```json
{
    "body": "<a id='comment:15'></a>Probably I messed it up in a merge.",
    "created_at": "2020-12-22T16:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469713",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Probably I messed it up in a merge.



---

archive/issue_comments_469714.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-22T16:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469714",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469715.json:
```json
{
    "body": "<a id='comment:16'></a>LGTM.",
    "created_at": "2020-12-22T16:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469715",
    "user": "https://github.com/kliem"
}
```

<a id='comment:16'></a>LGTM.



---

archive/issue_comments_469716.json:
```json
{
    "body": "<a id='comment:17'></a>Btw, pynormaliz still isn't on the mirrors, this is how I tested it. It was convenient for this purpose, but isn't otherwise.",
    "created_at": "2020-12-22T16:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469716",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'></a>Btw, pynormaliz still isn't on the mirrors, this is how I tested it. It was convenient for this purpose, but isn't otherwise.



---

archive/issue_comments_469717.json:
```json
{
    "body": "<a id='comment:18'></a>Thank you!",
    "created_at": "2020-12-22T16:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469717",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>Thank you!



---

archive/issue_comments_469718.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 gh-kliem]:\n> Btw, pynormaliz still isn't on the mirrors, this is how I tested it.\n> It was convenient for this purpose, but isn't otherwise.\n\n\nFixed now. Thanks Volker!",
    "created_at": "2020-12-23T13:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469718",
    "user": "https://github.com/slel"
}
```

<a id='comment:19'></a>Replying to [comment:17 gh-kliem]:
> Btw, pynormaliz still isn't on the mirrors, this is how I tested it.
> It was convenient for this purpose, but isn't otherwise.


Fixed now. Thanks Volker!



---

archive/issue_comments_469719.json:
```json
{
    "body": "<a id='comment:20'></a>To run this unattended we also need to ignore tarballs that we are not allowed to distribute for licensing reasons:\n\n```\n$ echo sage -package download --allow-upstream :all:\n[...]\nhttp://sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1.tgz\n[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\nERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1.tgz'\nTraceback (most recent call last):\n  File \"/home/release/Sage/build/bin/sage-package\", line 42, in <module>\n    run()\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py\", line 339, in run\n    app.download_cls(args.package_name, args.allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 177, in download_cls\n    pc.apply(download_with_args)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py\", line 71, in apply\n    function(package_name, *args, **kwds)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 176, in download_with_args\n    return self.download(package, allow_upstream=allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 167, in download\n    package.tarball.download(allow_upstream=allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/tarball.py\", line 177, in download\n    raise FileNotMirroredError('tarball does not exist on mirror network')\nsage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network\n```",
    "created_at": "2020-12-23T15:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469719",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:20'></a>To run this unattended we also need to ignore tarballs that we are not allowed to distribute for licensing reasons:

```
$ echo sage -package download --allow-upstream :all:
[...]
http://sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1.tgz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1.tgz'
Traceback (most recent call last):
  File "/home/release/Sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py", line 339, in run
    app.download_cls(args.package_name, args.allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 177, in download_cls
    pc.apply(download_with_args)
  File "/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py", line 71, in apply
    function(package_name, *args, **kwds)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 176, in download_with_args
    return self.download(package, allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 167, in download
    package.tarball.download(allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/tarball.py", line 177, in download
    raise FileNotMirroredError('tarball does not exist on mirror network')
sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
```



---

archive/issue_comments_469720.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-12-23T15:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469720",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_469721.json:
```json
{
    "body": "<a id='comment:22'></a>I think this ticket is fine. It fixes\n\n```\n./sage -package download --allow-upstream :all:\n```\nas claimed.\n\n```\n./sage -package upload :all:\n```\nneeds work yet, which is a seperate issue, I would say.\n\nOf course, both things can be taken care of in this ticket. But one might as well open a seperate ticket.",
    "created_at": "2020-12-23T15:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469721",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>I think this ticket is fine. It fixes

```
./sage -package download --allow-upstream :all:
```
as claimed.

```
./sage -package upload :all:
```
needs work yet, which is a seperate issue, I would say.

Of course, both things can be taken care of in this ticket. But one might as well open a seperate ticket.



---

archive/issue_comments_469722.json:
```json
{
    "body": "<a id='comment:24'></a>`needs_work` is just shorthand for \"Could you please prepare the mechanism to exclude non-distributable tarballs as you suggested on the ticket description\". I'm working on it.",
    "created_at": "2020-12-23T17:52:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469722",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>`needs_work` is just shorthand for "Could you please prepare the mechanism to exclude non-distributable tarballs as you suggested on the ticket description". I'm working on it.



---

archive/issue_comments_469723.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-23T18:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469723",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469724.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-23T18:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469724",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_469725.json:
```json
{
    "body": "<a id='comment:26'></a>Here's a version with this new feature",
    "created_at": "2020-12-23T18:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469725",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>Here's a version with this new feature



---

archive/issue_comments_469726.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,17 @@\n+After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using\n+\n+\\`\\`\\`\n+./sage -package download --allow-upstream :all:\n+\\`\\`\\`\n+followed by \n+\n+\\`\\`\\`\n+./sage -package upload :all:\n+\\`\\`\\`\n+... if someone is able to set up the necessary credentials for the workflow.\n+\n+We also add a mechanism to exclude non-distributable tarballs:  If a tarball name includes the pattern \\`do-not-distribute\\`, \\`sage -package upload\\` now skips it and logs a message.  We change the name of the tarball of \\`scipoptsuite\\` accordingly - this is our only non-distributable tarball.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-12-23T18:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469726",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,17 @@
+After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using
+
+\`\`\`
+./sage -package download --allow-upstream :all:
+\`\`\`
+followed by 
+
+\`\`\`
+./sage -package upload :all:
+\`\`\`
+... if someone is able to set up the necessary credentials for the workflow.
+
+We also add a mechanism to exclude non-distributable tarballs:  If a tarball name includes the pattern \`do-not-distribute\`, \`sage -package upload\` now skips it and logs a message.  We change the name of the tarball of \`scipoptsuite\` accordingly - this is our only non-distributable tarball.
+
 
 
 Comment: 1
```




---

archive/issue_comments_469727.json:
```json
{
    "body": "<a id='comment:27'></a>There is at least an info section missing here https://doc.sagemath.org/html/en/developer/packaging.html, so that people are warned when adding new packages.\n\nHowever, I would prefer it the other way around, even though it is annoying: Have a small sentence in SPKG.rst that we may redistribute. This would be more fool-proof.",
    "created_at": "2020-12-23T18:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469727",
    "user": "https://github.com/kliem"
}
```

<a id='comment:27'></a>There is at least an info section missing here https://doc.sagemath.org/html/en/developer/packaging.html, so that people are warned when adding new packages.

However, I would prefer it the other way around, even though it is annoying: Have a small sentence in SPKG.rst that we may redistribute. This would be more fool-proof.



---

archive/issue_comments_469728.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 gh-kliem]:\n> There is at least an info section missing here https://doc.sagemath.org/html/en/developer/packaging.html, so that people are warned when adding new packages.\n\n\nGood idea.\n\n> However, I would prefer it the other way around, even though it is annoying: Have a small sentence in SPKG.rst that we may redistribute. This would be more fool-proof.\n\n\nI disagree. We make free software here; the non-distributable case is an exception for rare cases.\n\nIt does not have to be foolproof. We have the review process that so far seems to have successfully stopped people from adding proprietary packages.\n\nIf you are interested in adding structured license info to `build/pkgs/`... see #21571.",
    "created_at": "2020-12-23T19:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469728",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>Replying to [comment:27 gh-kliem]:
> There is at least an info section missing here https://doc.sagemath.org/html/en/developer/packaging.html, so that people are warned when adding new packages.


Good idea.

> However, I would prefer it the other way around, even though it is annoying: Have a small sentence in SPKG.rst that we may redistribute. This would be more fool-proof.


I disagree. We make free software here; the non-distributable case is an exception for rare cases.

It does not have to be foolproof. We have the review process that so far seems to have successfully stopped people from adding proprietary packages.

If you are interested in adding structured license info to `build/pkgs/`... see #21571.



---

archive/issue_comments_469729.json:
```json
{
    "body": "<a id='comment:29'></a>Fine.",
    "created_at": "2020-12-23T19:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469729",
    "user": "https://github.com/kliem"
}
```

<a id='comment:29'></a>Fine.



---

archive/issue_comments_469730.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-23T19:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469730",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469731.json:
```json
{
    "body": "<a id='comment:31'></a>Ok, seems fine.\n\nHave you tested that this actually works and skips scipoptsuite?",
    "created_at": "2020-12-23T20:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469731",
    "user": "https://github.com/kliem"
}
```

<a id='comment:31'></a>Ok, seems fine.

Have you tested that this actually works and skips scipoptsuite?



---

archive/issue_comments_469732.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-23T20:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469732",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469733.json:
```json
{
    "body": "<a id='comment:32'></a>Never mind, I tested it with a dummy file and it works fine.",
    "created_at": "2020-12-23T20:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469733",
    "user": "https://github.com/kliem"
}
```

<a id='comment:32'></a>Never mind, I tested it with a dummy file and it works fine.



---

archive/issue_comments_469734.json:
```json
{
    "body": "<a id='comment:33'></a>Thanks!",
    "created_at": "2020-12-23T20:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469734",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>Thanks!



---

archive/issue_comments_469735.json:
```json
{
    "body": "<a id='comment:34'></a>Downloading still fails tho:\n\n```\n$ sage -package download --allow-upstream :all:\n[...]\nhttp://sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1-do-not-distribute.tgz\n[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\nERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1-do-not-distribute.tgz'\nTraceback (most recent call last):\n  File \"/home/release/Sage/build/bin/sage-package\", line 42, in <module>\n    run()\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py\", line 339, in run\n    app.download_cls(args.package_name, args.allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 177, in download_cls\n    pc.apply(download_with_args)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py\", line 71, in apply\n    function(package_name, *args, **kwds)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 176, in download_with_args\n    return self.download(package, allow_upstream=allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/app.py\", line 167, in download\n    package.tarball.download(allow_upstream=allow_upstream)\n  File \"/home/release/Sage/build/bin/../sage_bootstrap/tarball.py\", line 180, in download\n    raise FileNotMirroredError('tarball does not exist on mirror network')\nsage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network\n```",
    "created_at": "2020-12-25T15:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469735",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:34'></a>Downloading still fails tho:

```
$ sage -package download --allow-upstream :all:
[...]
http://sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1-do-not-distribute.tgz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1-do-not-distribute.tgz'
Traceback (most recent call last):
  File "/home/release/Sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py", line 339, in run
    app.download_cls(args.package_name, args.allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 177, in download_cls
    pc.apply(download_with_args)
  File "/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py", line 71, in apply
    function(package_name, *args, **kwds)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 176, in download_with_args
    return self.download(package, allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 167, in download
    package.tarball.download(allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/tarball.py", line 180, in download
    raise FileNotMirroredError('tarball does not exist on mirror network')
sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
```



---

archive/issue_comments_469736.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-12-25T15:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469736",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_469737.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-25T19:01:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469737",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469738.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-25T19:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469738",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_469739.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,17 @@\n+After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using\n+\n+\\`\\`\\`\n+./sage -package download --allow-upstream --on-error=warn :all:\n+\\`\\`\\`\n+followed by \n+\n+\\`\\`\\`\n+./sage -package upload :all:\n+\\`\\`\\`\n+... if someone is able to set up the necessary credentials for the workflow.\n+\n+We also add a mechanism to exclude non-distributable tarballs:  If a tarball name includes the pattern \\`do-not-distribute\\`, \\`sage -package upload\\` now skips it and logs a message.  We change the name of the tarball of \\`scipoptsuite\\` accordingly - this is our only non-distributable tarball.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-12-25T19:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469739",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,17 @@
+After the fix from this ticket, we should be able to automate syncing upstream packages to the Sage server by using
+
+\`\`\`
+./sage -package download --allow-upstream --on-error=warn :all:
+\`\`\`
+followed by 
+
+\`\`\`
+./sage -package upload :all:
+\`\`\`
+... if someone is able to set up the necessary credentials for the workflow.
+
+We also add a mechanism to exclude non-distributable tarballs:  If a tarball name includes the pattern \`do-not-distribute\`, \`sage -package upload\` now skips it and logs a message.  We change the name of the tarball of \`scipoptsuite\` accordingly - this is our only non-distributable tarball.
+
 
 
 Comment: 1
```




---

archive/issue_comments_469740.json:
```json
{
    "body": "<a id='comment:37'></a>Here you go",
    "created_at": "2020-12-25T19:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469740",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Here you go



---

archive/issue_comments_469741.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-27T00:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469741",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469742.json:
```json
{
    "body": "<a id='comment:39'></a>Thanks.",
    "created_at": "2020-12-27T03:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469742",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Thanks.



---

archive/issue_comments_469743.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-27T23:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31034#issuecomment-469743",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081048.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-27T23:25:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31034",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31034#event-81048"
}
```
