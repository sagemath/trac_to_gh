# Issue 31625: Memory leak for IntegralLattice

archive/issues_031388.json:
```json
{
    "body": "Computing the discriminant group of an integral lattice causes \nboth to persist in memory.\n\n```\nsage: L = IntegralLattice(\"A2\") \nsage: for k in range(1,500): \n....:     G = L.twist(k) \nsage: gc.collect() \nsage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       \n1058\n3\nsage: L = IntegralLattice(\"A2\") \nsage: for k in range(1,500): \n....:     G = L.twist(k) \n....:     D = G.discriminant_group() \nsage: gc.collect() \nsage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       \n1284\n501\n```\nCreating thousands of lattices and computing their discriminant groups is actually a common use case. Serious computations are impossible with this kind of memory leak.\n\n\nCC:  @tscrim @nbruin @jdemeyer @slel\n\nBranch/Commit: bd6c256acc5a5e99f0fa2ad1111613b5c49bd0fd\n\nReviewer: Travis Scrimshaw\n\nAuthor: Simon Brandhorst\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31625\n\n",
    "closed_at": "2021-04-26T21:59:05Z",
    "created_at": "2021-04-08T19:51:12Z",
    "labels": [
        "component: memleak",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Memory leak for IntegralLattice",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31625",
    "user": "https://github.com/simonbrandhorst"
}
```
Computing the discriminant group of an integral lattice causes 
both to persist in memory.

```
sage: L = IntegralLattice("A2") 
sage: for k in range(1,500): 
....:     G = L.twist(k) 
sage: gc.collect() 
sage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       
1058
3
sage: L = IntegralLattice("A2") 
sage: for k in range(1,500): 
....:     G = L.twist(k) 
....:     D = G.discriminant_group() 
sage: gc.collect() 
sage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       
1284
501
```
Creating thousands of lattices and computing their discriminant groups is actually a common use case. Serious computations are impossible with this kind of memory leak.


CC:  @tscrim @nbruin @jdemeyer @slel

Branch/Commit: bd6c256acc5a5e99f0fa2ad1111613b5c49bd0fd

Reviewer: Travis Scrimshaw

Author: Simon Brandhorst

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31625





---

archive/issue_comments_479279.json:
```json
{
    "body": "<a id='comment:1'></a>`L.discriminant_group()` is cached. Removing the cache is a possible fix to the leak. However it seems very natural for a lattice to remember its discriminant group. And is basically the only reasonable way to create such things. \nOn the other hand the discriminant group knows about its lattice covering lattice (it has to). \n\nAnother option to fix the leak is to remove `CachedRepresentation` from the discriminant group. \n\nNot sure how to proceed here.  And there are other instances of this kind of memory leak.",
    "created_at": "2021-04-08T19:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479279",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:1'></a>`L.discriminant_group()` is cached. Removing the cache is a possible fix to the leak. However it seems very natural for a lattice to remember its discriminant group. And is basically the only reasonable way to create such things. 
On the other hand the discriminant group knows about its lattice covering lattice (it has to). 

Another option to fix the leak is to remove `CachedRepresentation` from the discriminant group. 

Not sure how to proceed here.  And there are other instances of this kind of memory leak.



---

archive/issue_comments_479280.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,22 +3,23 @@\n \n ```\n sage: L = IntegralLattice(\"A2\") \n-....: for k in range(1,500): \n+sage: for k in range(1,500): \n ....:     G = L.twist(k) \n-....: gc.collect() \n-....: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       \n+sage: gc.collect() \n+sage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       \n 1058\n 3\n sage: L = IntegralLattice(\"A2\") \n-....: for k in range(1,500): \n+sage: for k in range(1,500): \n ....:     G = L.twist(k) \n ....:     D = G.discriminant_group() \n-....: gc.collect() \n-....: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       \n+sage: gc.collect() \n+sage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       \n 1284\n 501\n ```\n Creating thousands of lattices and computing their discriminant groups is actually a common use case. Serious computations are impossible with this kind of memory leak.\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2021-04-08T23:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479280",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,22 +3,23 @@
 
 ```
 sage: L = IntegralLattice("A2") 
-....: for k in range(1,500): 
+sage: for k in range(1,500): 
 ....:     G = L.twist(k) 
-....: gc.collect() 
-....: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       
+sage: gc.collect() 
+sage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       
 1058
 3
 sage: L = IntegralLattice("A2") 
-....: for k in range(1,500): 
+sage: for k in range(1,500): 
 ....:     G = L.twist(k) 
 ....:     D = G.discriminant_group() 
-....: gc.collect() 
-....: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       
+sage: gc.collect() 
+sage: len([a for a in gc.get_objects() if type(a)==type(L)])                                                                                                                                       
 1284
 501
 ```
 Creating thousands of lattices and computing their discriminant groups is actually a common use case. Serious computations are impossible with this kind of memory leak.
+
 
 Comment: 1
 
``````




---

archive/issue_comments_479281.json:
```json
{
    "body": "<a id='comment:3'></a>I would probably remove the ``@`cached_method` from `discriminant_group()`. I don't see immediately why there would be a need to cache that. It doesn't seem like something you call frequently from different parts of the code. You could just tweak `maximal_overlattice()` in order to avoid repeated calls (which I would argue is better coding style anyways). (Similarly, you don't cache the `orthogonal_group()`.)",
    "created_at": "2021-04-09T00:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479281",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>I would probably remove the ``@`cached_method` from `discriminant_group()`. I don't see immediately why there would be a need to cache that. It doesn't seem like something you call frequently from different parts of the code. You could just tweak `maximal_overlattice()` in order to avoid repeated calls (which I would argue is better coding style anyways). (Similarly, you don't cache the `orthogonal_group()`.)



---

archive/issue_comments_479282.json:
```json
{
    "body": "<a id='comment:4'></a>`discriminant_group()` is something that is called quite frequently by the user. Creating \nit is not too expensive so okay. \n\nBut computing generators for the `orthogonal_group()` is very expensive. \nSo I think here unique representation does not help a lot. Storing it on its domain seems better.",
    "created_at": "2021-04-09T07:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479282",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:4'></a>`discriminant_group()` is something that is called quite frequently by the user. Creating 
it is not too expensive so okay. 

But computing generators for the `orthogonal_group()` is very expensive. 
So I think here unique representation does not help a lot. Storing it on its domain seems better.



---

archive/issue_comments_479283.json:
```json
{
    "body": "<a id='comment:5'></a>I guess I can let the unique representation machinery do the caching and only store the generators on the orthogonal group. So that is fine. \nFinal question how best to doctest that a memory leak is fixed?",
    "created_at": "2021-04-10T07:39:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479283",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:5'></a>I guess I can let the unique representation machinery do the caching and only store the generators on the orthogonal group. So that is fine. 
Final question how best to doctest that a memory leak is fixed?



---

archive/issue_comments_479284.json:
```json
{
    "body": "<a id='comment:6'></a>You could use the test in the ticket description, but it doesn't necessarily need a doctest IMO.",
    "created_at": "2021-04-10T08:27:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479284",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>You could use the test in the ticket description, but it doesn't necessarily need a doctest IMO.



---

archive/issue_comments_479285.json:
```json
{
    "body": "<a id='comment:8'></a>New commits:",
    "created_at": "2021-04-10T10:53:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479285",
    "user": "https://github.com/simonbrandhorst"
}
```

<a id='comment:8'></a>New commits:



---

archive/issue_comments_479286.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-10T10:53:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479286",
    "user": "https://github.com/simonbrandhorst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_479287.json:
```json
{
    "body": "<a id='comment:9'></a>Your `\"\"\"` is not aligned properly (see the diff) and your added doctests need to be indented.\n\n(I am slightly squeamish about adding such a doctest for the memory leak, but not enough to not include it.)",
    "created_at": "2021-04-10T22:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479287",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Your `"""` is not aligned properly (see the diff) and your added doctests need to be indented.

(I am slightly squeamish about adding such a doctest for the memory leak, but not enough to not include it.)



---

archive/issue_comments_479288.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-13T10:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479288",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_479289.json:
```json
{
    "body": "<a id='comment:11'></a>Thank you. LGTM.",
    "created_at": "2021-04-14T00:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479289",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Thank you. LGTM.



---

archive/issue_comments_479290.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-14T00:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479290",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_479291.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-04-18T16:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479291",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_events_083254.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-04-26T21:59:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31625#event-83254"
}
```



---

archive/issue_comments_479292.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-26T21:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31625",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31625#issuecomment-479292",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
