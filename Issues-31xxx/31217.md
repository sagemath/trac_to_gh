# Issue 31217: make subsemigroup work for MatrixSpace

archive/issues_030980.json:
```json
{
    "assignees": [],
    "body": "`subsemigroup` does not work for matrices; and even when the command does not fail, the answer could be wrong.\n\nLet's try the subsemigroup generated by `A`, where\n\n```\nsage: M = MatrixSpace(ZZ, 2)\nsage: A = matrix([[0, 1], [0, 0]])\nsage: A * A\n[0 0]\n[0 0]\n```\nNote that `A * A == 0` so the subsemigroup consists of `A` and `0`.\n\n(1) First obvious attempt fails (this is how I expected it to work):\n\n```\nsage: M.subsemigroup([A])\n...\nTypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()\n```\nThis error message is not helpful: after digging around a while, I figured out that the input gets converted to a `Family`, so after trying to specify a `Family` instead, I realized that the real problem is that `A` is not immutable.\n\n(2) Second attempt fails:\n\n```\nsage: M.subsemigroup([M(A)])\n...\nTypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()\n```\nI thought this work work because I explicitly converted `A` to an element of `M`. It turns out that `M(A)` is not immutable, which seems like another issue that should be corrected.\n\n```\nsage: M(A).is_immutable()\nFalse\n```\n\n(3) Third attempt: first create `A` as an immutable matrix.\n\n```\nsage: M = MatrixSpace(ZZ, 2)\nsage: A = matrix([[0, 1], [0, 0]], immutable=True)\nsage: S = M.subsemigroup([A]); S\nA subsemigroup of (Full MatrixSpace of 2 by 2 dense matrices over Integer Ring) with 1 generators\n```\nHere, the command does not fail, but the result is wrong:\n\n```\nsage: S.list()     # fails first time, but not the second time...\n...\nTypeError: mutable matrices are unhashable\nsage: S.list()\n[[0 1]\n [0 0]]\nsage: [A, A*A]     # this is what the answer should be\n[\n[0 1]  [0 0]\n[0 0], [0 0]\n]\n```\n\n\nCC:  @fchapoton @zabrocki @anneschilling\n\nKeywords: **semigroups, matrices**\n\nComponent: **algebra**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31217_\n\n",
    "created_at": "2021-01-09T20:56:57Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20algebra",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "make subsemigroup work for MatrixSpace",
    "type": "issue",
    "updated_at": "2023-01-08T09:53:49Z",
    "url": "https://github.com/sagemath/sage/issues/31217",
    "user": "https://github.com/saliola"
}
```
`subsemigroup` does not work for matrices; and even when the command does not fail, the answer could be wrong.

Let's try the subsemigroup generated by `A`, where

```
sage: M = MatrixSpace(ZZ, 2)
sage: A = matrix([[0, 1], [0, 0]])
sage: A * A
[0 0]
[0 0]
```
Note that `A * A == 0` so the subsemigroup consists of `A` and `0`.

(1) First obvious attempt fails (this is how I expected it to work):

```
sage: M.subsemigroup([A])
...
TypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()
```
This error message is not helpful: after digging around a while, I figured out that the input gets converted to a `Family`, so after trying to specify a `Family` instead, I realized that the real problem is that `A` is not immutable.

(2) Second attempt fails:

```
sage: M.subsemigroup([M(A)])
...
TypeError: <class 'sage.sets.family.TrivialFamily_with_category'> is not hashable and does not implement _cache_key()
```
I thought this work work because I explicitly converted `A` to an element of `M`. It turns out that `M(A)` is not immutable, which seems like another issue that should be corrected.

```
sage: M(A).is_immutable()
False
```

(3) Third attempt: first create `A` as an immutable matrix.

```
sage: M = MatrixSpace(ZZ, 2)
sage: A = matrix([[0, 1], [0, 0]], immutable=True)
sage: S = M.subsemigroup([A]); S
A subsemigroup of (Full MatrixSpace of 2 by 2 dense matrices over Integer Ring) with 1 generators
```
Here, the command does not fail, but the result is wrong:

```
sage: S.list()     # fails first time, but not the second time...
...
TypeError: mutable matrices are unhashable
sage: S.list()
[[0 1]
 [0 0]]
sage: [A, A*A]     # this is what the answer should be
[
[0 1]  [0 0]
[0 0], [0 0]
]
```


CC:  @fchapoton @zabrocki @anneschilling

Keywords: **semigroups, matrices**

Component: **algebra**

_Issue created by migration from https://trac.sagemath.org/ticket/31217_





---

archive/issue_events_430257.json:
```json
{
    "actor": "https://github.com/saliola",
    "created_at": "2021-01-09T20:56:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430257"
}
```



---

archive/issue_events_430258.json:
```json
{
    "actor": "https://github.com/saliola",
    "created_at": "2021-01-09T20:56:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20algebra",
    "label_color": "0000ff",
    "label_name": "c: algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430258"
}
```



---

archive/issue_events_430259.json:
```json
{
    "actor": "https://github.com/saliola",
    "created_at": "2021-01-09T20:56:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430259"
}
```



---

archive/issue_events_430260.json:
```json
{
    "actor": "https://github.com/saliola",
    "created_at": "2021-01-09T20:56:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430260"
}
```



---

archive/issue_comments_500261.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31217#issuecomment-500261",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_430261.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430261"
}
```



---

archive/issue_events_430262.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430262"
}
```



---

archive/issue_events_430263.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430263"
}
```



---

archive/issue_events_430264.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:43:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430264"
}
```



---

archive/issue_events_430265.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430265"
}
```



---

archive/issue_events_430266.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430266"
}
```



---

archive/issue_events_430267.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430267"
}
```



---

archive/issue_events_430268.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430268"
}
```



---

archive/issue_events_430269.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430269"
}
```



---

archive/issue_events_430270.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31217",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31217#event-430270"
}
```
