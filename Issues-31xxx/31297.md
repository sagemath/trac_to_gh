# Issue 31297: Add gappy as a standard package and use for sage's libgap interface

archive/issues_031060.json:
```json
{
    "assignees": [],
    "body": "**Update:** The successor to this ticket is #31404 which offers a different approach by using gappy directly in Sage rather than providing Sage-specific wrappers.  I think it is overall a better approach for now.\n\nPackage tarball: see `checksums.ini`; use `./configure --enable-download-from-upstream-url` to test.\n\n[gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n\nIt is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).\n\nOne particular improvement is the help system for GAP functions--as before it is possible to extract documentation (when it exists) from the GAP docs, but this is faster now (previously the pexpect interface was still required) and can usually extract *only* the documentation for the queried function (previously it would also append the entire rest of the documentation chapter). It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.\n\nThis ticket is to attempt to convert `sage.libs.gap` to a wrapper around gappy (rather than replace it entirely).  The main reason a wrapper is still needed, is in order to participate in Sage's coercion model.\n\nThe GAP interpreter wrapper class `sage.libs.gap.libgap.Gap` is a `Parent`, and its elements are instances of `GapElement` and subclasses thereof which are subclasses of `Element`.\n\nThis presents a challenge which makes wrapping gappy less straightforward than one would hope: Because the classes `gappy.Gap` and `gappy.GapObj` (its equivalent of `GapElement`) are cdef classes, as well as `Parent` and `Element`, it is not possible to use multiple inheritance like\n\n```\nclass GapElement(GapObj, Element):\n    ...\n```\n\nbecause their base structs are incompatible.  The current workaround to this is that `GapElement` is a wrapper for a `GapObj` (which in turn wraps C-level GAP `Obj` pointers).  This creates a bit of unfortunate overhead, albeit not much; by using `cdef` and `cpdef` methods, Cython can make the call to wrapped objects reasonably fast in many cases.\n\n## TODO\n\n* Rework the `sage.libs.gap.assigned_names` and `sage.libs.gap.all_documented_functions` modules.\n\n* Fix more uses within sage of the deprecated `Gap.function_factory` method.\n\n* Fix more tests; all test are passing in `sage.libs.gap` as well as all in `sage.groups.perm_gps`, but some tests elsewhere are failing.\n\n* There are miscellaneous other functions in `sage.libs.gap` that can probably be deprecated or removed.\n\n### Food for thought...\n\nThere are some other possible workarounds to this issue I would like to explore in the future.\n\nThe first is to change how gappy works: Rather than `Gap` and `GapObj` being `cdef` classes, they could be pure-Python wrappers around some `cdef` classes.  This would again create some overhead, but hopefully not too much.  Then they can participate in multiple inheritance with Sage's `Parent` and `Element` classes.\n\nThe other two, which would be much more disruptive, but also possibly useful for other packages that would like to integrate with Sage without explicitly depending on it, and have been discussed before:\n\n1) Create a relatively Sage \"base\" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.  See #29865 for an in-progress viable prototype of this.\n\n2) A similar but subtly different option is to make classes like `SageObject`, `Parent`, and `Element` into Abstract Base Classes.  Classes in other packages can then be registered as psuedo-subclasses of these ABCs without directly subclassing them, so long as they implement the necessary interfaces.  This option is appealing to me since it means classes from other packages can more easily interface with Sage without requiring any additional dependencies.  However, it is potentially more disruptive: There isn't a way to ensure that classes which register to an ABC to provide the same C-level interface (C methods and attributes).  So Cython-level code that types variables as `Parent` or `Element` won't work here, and would have to provide a separate (typically slower) code path for handle ABC pseudo-subclasses.  Fortunately there is not a ton of code like this in Sage, but there is some, especially in code related to the coercion model, unsurprisingly.\n\n\n\nCC:  @tscrim @dimpase @videlec\n\nKeywords: **gap libgap gappy**\n\nBranch/Commit: **[u/embray/gappy](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/gappy) @ [82e7e56](https://github.com/sagemath/sagetrac-mirror/commit/82e7e56cdea9b8d24a3465f9661189288f54cc26)**\n\nWork Issues: **release gappy 0.1.0 final and update spkg version before merging**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Erik Bray**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31297_\n\n",
    "closed_at": "2021-03-29T08:14:58Z",
    "created_at": "2021-01-27T13:27:43Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/wontfix"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Add gappy as a standard package and use for sage's libgap interface",
    "type": "issue",
    "updated_at": "2021-03-29T08:14:58Z",
    "url": "https://github.com/sagemath/sage/issues/31297",
    "user": "https://github.com/embray"
}
```
**Update:** The successor to this ticket is #31404 which offers a different approach by using gappy directly in Sage rather than providing Sage-specific wrappers.  I think it is overall a better approach for now.

Package tarball: see `checksums.ini`; use `./configure --enable-download-from-upstream-url` to test.

[gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).

It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).

One particular improvement is the help system for GAP functions--as before it is possible to extract documentation (when it exists) from the GAP docs, but this is faster now (previously the pexpect interface was still required) and can usually extract *only* the documentation for the queried function (previously it would also append the entire rest of the documentation chapter). It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.

This ticket is to attempt to convert `sage.libs.gap` to a wrapper around gappy (rather than replace it entirely).  The main reason a wrapper is still needed, is in order to participate in Sage's coercion model.

The GAP interpreter wrapper class `sage.libs.gap.libgap.Gap` is a `Parent`, and its elements are instances of `GapElement` and subclasses thereof which are subclasses of `Element`.

This presents a challenge which makes wrapping gappy less straightforward than one would hope: Because the classes `gappy.Gap` and `gappy.GapObj` (its equivalent of `GapElement`) are cdef classes, as well as `Parent` and `Element`, it is not possible to use multiple inheritance like

```
class GapElement(GapObj, Element):
    ...
```

because their base structs are incompatible.  The current workaround to this is that `GapElement` is a wrapper for a `GapObj` (which in turn wraps C-level GAP `Obj` pointers).  This creates a bit of unfortunate overhead, albeit not much; by using `cdef` and `cpdef` methods, Cython can make the call to wrapped objects reasonably fast in many cases.

## TODO

* Rework the `sage.libs.gap.assigned_names` and `sage.libs.gap.all_documented_functions` modules.

* Fix more uses within sage of the deprecated `Gap.function_factory` method.

* Fix more tests; all test are passing in `sage.libs.gap` as well as all in `sage.groups.perm_gps`, but some tests elsewhere are failing.

* There are miscellaneous other functions in `sage.libs.gap` that can probably be deprecated or removed.

### Food for thought...

There are some other possible workarounds to this issue I would like to explore in the future.

The first is to change how gappy works: Rather than `Gap` and `GapObj` being `cdef` classes, they could be pure-Python wrappers around some `cdef` classes.  This would again create some overhead, but hopefully not too much.  Then they can participate in multiple inheritance with Sage's `Parent` and `Element` classes.

The other two, which would be much more disruptive, but also possibly useful for other packages that would like to integrate with Sage without explicitly depending on it, and have been discussed before:

1) Create a relatively Sage "base" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.  See #29865 for an in-progress viable prototype of this.

2) A similar but subtly different option is to make classes like `SageObject`, `Parent`, and `Element` into Abstract Base Classes.  Classes in other packages can then be registered as psuedo-subclasses of these ABCs without directly subclassing them, so long as they implement the necessary interfaces.  This option is appealing to me since it means classes from other packages can more easily interface with Sage without requiring any additional dependencies.  However, it is potentially more disruptive: There isn't a way to ensure that classes which register to an ABC to provide the same C-level interface (C methods and attributes).  So Cython-level code that types variables as `Parent` or `Element` won't work here, and would have to provide a separate (typically slower) code path for handle ABC pseudo-subclasses.  Fortunately there is not a ton of code like this in Sage, but there is some, especially in code related to the coercion model, unsurprisingly.



CC:  @tscrim @dimpase @videlec

Keywords: **gap libgap gappy**

Branch/Commit: **[u/embray/gappy](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/gappy) @ [82e7e56](https://github.com/sagemath/sagetrac-mirror/commit/82e7e56cdea9b8d24a3465f9661189288f54cc26)**

Work Issues: **release gappy 0.1.0 final and update spkg version before merging**

Reviewer: **Dima Pasechnik**

Author: **Erik Bray**

_Issue created by migration from https://trac.sagemath.org/ticket/31297_





---

archive/issue_events_413129.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-01-27T13:27:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413129"
}
```



---

archive/issue_events_413130.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-01-27T13:27:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "component: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413130"
}
```



---

archive/issue_events_413131.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-01-27T13:27:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413131"
}
```



---

archive/issue_events_413132.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-01-27T13:27:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413132"
}
```



---

archive/issue_comments_504702.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-[gappy](https://github.com/embray/gappy) is a new Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n+[gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n \n It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).  It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.\n \n``````\n",
    "created_at": "2021-01-27T13:28:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504702",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-[gappy](https://github.com/embray/gappy) is a new Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).
+[gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).
 
 It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).  It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.
 
``````




---

archive/issue_comments_504703.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce1a235e093aa42c0cab6a0e9a5e80e7fc92ee84\">ce1a235</a></td><td><code>Add gappy as a standard SPKG and dependency of sagelib.</code></td></tr></table>\n",
    "created_at": "2021-01-27T13:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504703",
    "user": "https://github.com/embray"
}
```

<div id="comment:2" align="right">Comment 2</div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce1a235e093aa42c0cab6a0e9a5e80e7fc92ee84">ce1a235</a></td><td><code>Add gappy as a standard SPKG and dependency of sagelib.</code></td></tr></table>




---

archive/issue_comments_504704.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n+**Package tarball:** https://files.pythonhosted.org/packages/b4/1a/78bda94109c877c632dc385b2c2d899e08389bfad89d32b92df0c6636d21/gappy-system-0.1.0a0.tar.gz\n+\n [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n \n It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).  It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.\n``````\n",
    "created_at": "2021-01-27T13:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504704",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
+**Package tarball:** https://files.pythonhosted.org/packages/b4/1a/78bda94109c877c632dc385b2c2d899e08389bfad89d32b92df0c6636d21/gappy-system-0.1.0a0.tar.gz
+
 [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).
 
 It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).  It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.
``````




---

archive/issue_comments_504705.json:
```json
{
    "body": "Branch: **[u/embray/gappy](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/gappy)**",
    "created_at": "2021-01-27T13:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504705",
    "user": "https://github.com/embray"
}
```

Branch: **[u/embray/gappy](https://github.com/sagemath/sagetrac-mirror/tree/u/embray/gappy)**



---

archive/issue_comments_504706.json:
```json
{
    "body": "Author: **Erik Bray**",
    "created_at": "2021-01-27T13:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504706",
    "user": "https://github.com/embray"
}
```

Author: **Erik Bray**



---

archive/issue_comments_504707.json:
```json
{
    "body": "Commit: **[ce1a235](https://github.com/sagemath/sagetrac-mirror/commit/ce1a235e093aa42c0cab6a0e9a5e80e7fc92ee84)**",
    "created_at": "2021-01-27T13:57:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504707",
    "user": "https://github.com/embray"
}
```

Commit: **[ce1a235](https://github.com/sagemath/sagetrac-mirror/commit/ce1a235e093aa42c0cab6a0e9a5e80e7fc92ee84)**



---

archive/issue_comments_504708.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,7 +2,9 @@\n \n [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n \n-It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).  It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.\n+It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).\n+\n+One particular improvement is the help system for GAP functions--as before it is possible to extract documentation (when it exists) from the GAP docs, but this is faster now (previously the pexpect interface was still required) and can usually extract *only* the documentation for the queried function (previously it would also append the entire rest of the documentation chapter). It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.\n \n This ticket is to attempt to convert `sage.libs.gap` to a wrapper around gappy (rather than replace it entirely).  The main reason a wrapper is still needed, is in order to participate in Sage's coercion model.\n \n``````\n",
    "created_at": "2021-01-27T14:09:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504708",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,7 +2,9 @@
 
 [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).
 
-It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).  It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.
+It is the result of extracting Sage's `sage.libs.gap` package into a standalone package without a dependency on Sage, so it still bears some of the legacy of that package (which will continue to be cleaned up and improved on).
+
+One particular improvement is the help system for GAP functions--as before it is possible to extract documentation (when it exists) from the GAP docs, but this is faster now (previously the pexpect interface was still required) and can usually extract *only* the documentation for the queried function (previously it would also append the entire rest of the documentation chapter). It may also introduce some minor performance improvements in some areas, but it will be interesting to test this with some non-trivial examples.
 
 This ticket is to attempt to convert `sage.libs.gap` to a wrapper around gappy (rather than replace it entirely).  The main reason a wrapper is still needed, is in order to participate in Sage's coercion model.
 
``````




---

archive/issue_comments_504709.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -19,6 +19,13 @@\n \n because their base structs are incompatible.  The current workaround to this is that `GapElement` is a wrapper for a `GapObj` (which in turn wraps C-level GAP `Obj` pointers).  This creates a bit of unfortunate overhead, albeit not much; by using `cdef` and `cpdef` methods, Cython can make the call to wrapped objects reasonably fast in many cases.\n \n+## TODO\n+\n+* Rework the `sage.libs.gap.assigned_names` and `sage.libs.gap.all_documented_functions` modules.\n+\n+* Fix more uses within sage of the deprecated `Gap.function_factory` method.\n+\n+* Fix more tests; all test are passing in `sage.libs.gap` as well as all in `sage.groups.perm_gps`, but some tests elsewhere are failing.\n \n ### Food for thought...\n \n``````\n",
    "created_at": "2021-01-27T14:15:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504709",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -19,6 +19,13 @@
 
 because their base structs are incompatible.  The current workaround to this is that `GapElement` is a wrapper for a `GapObj` (which in turn wraps C-level GAP `Obj` pointers).  This creates a bit of unfortunate overhead, albeit not much; by using `cdef` and `cpdef` methods, Cython can make the call to wrapped objects reasonably fast in many cases.
 
+## TODO
+
+* Rework the `sage.libs.gap.assigned_names` and `sage.libs.gap.all_documented_functions` modules.
+
+* Fix more uses within sage of the deprecated `Gap.function_factory` method.
+
+* Fix more tests; all test are passing in `sage.libs.gap` as well as all in `sage.groups.perm_gps`, but some tests elsewhere are failing.
 
 ### Food for thought...
 
``````




---

archive/issue_comments_504710.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -27,6 +27,8 @@\n \n * Fix more tests; all test are passing in `sage.libs.gap` as well as all in `sage.groups.perm_gps`, but some tests elsewhere are failing.\n \n+* There are miscellaneous other functions in `sage.libs.gap` that can probably be deprecated or removed.\n+\n ### Food for thought...\n \n There are some other possible workarounds to this issue I would like to explore in the future.\n``````\n",
    "created_at": "2021-01-27T14:59:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504710",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -27,6 +27,8 @@
 
 * Fix more tests; all test are passing in `sage.libs.gap` as well as all in `sage.groups.perm_gps`, but some tests elsewhere are failing.
 
+* There are miscellaneous other functions in `sage.libs.gap` that can probably be deprecated or removed.
+
 ### Food for thought...
 
 There are some other possible workarounds to this issue I would like to explore in the future.
``````




---

archive/issue_comments_504711.json:
```json
{
    "body": "Changed commit from **[ce1a235](https://github.com/sagemath/sagetrac-mirror/commit/ce1a235e093aa42c0cab6a0e9a5e80e7fc92ee84)** to **[a8aab2a](https://github.com/sagemath/sagetrac-mirror/commit/a8aab2adfe417087af7f1ad5393ca7a61e242613)**",
    "created_at": "2021-01-27T15:32:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504711",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[ce1a235](https://github.com/sagemath/sagetrac-mirror/commit/ce1a235e093aa42c0cab6a0e9a5e80e7fc92ee84)** to **[a8aab2a](https://github.com/sagemath/sagetrac-mirror/commit/a8aab2adfe417087af7f1ad5393ca7a61e242613)**



---

archive/issue_comments_504712.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a8aab2adfe417087af7f1ad5393ca7a61e242613\">a8aab2a</a></td><td><code>Initial work to convert sage.libs.gap to use gappy.</code></td></tr></table>\n",
    "created_at": "2021-01-27T15:32:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504712",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6" align="right">Comment 6</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a8aab2adfe417087af7f1ad5393ca7a61e242613">a8aab2a</a></td><td><code>Initial work to convert sage.libs.gap to use gappy.</code></td></tr></table>




---

archive/issue_comments_504713.json:
```json
{
    "body": "Replying to [ticket:31297 embray]:\n> 1) Create a relatively Sage \"base\" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.\n\nSee #29865 for this",
    "created_at": "2021-01-29T03:42:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504713",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:31297 embray]:
> 1) Create a relatively Sage "base" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.

See #29865 for this



---

archive/issue_comments_504714.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/45b175e43621795f890204a9cdfb30b524f961fa\">45b175e</a></td><td><code>Don't use the string evaluation construction for libgap permutation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/197290f339ef5da0dbce0eb6afde85ad65dabd6a\">197290f</a></td><td><code>Fix miscellaneous tests that broke due to different group iteration</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9f621e96ff870e7fba2fc1177d82a08aca6ce52f\">9f621e9</a></td><td><code>Update gappy to v0.1.0a1 with some fixes for matrices and gap_function.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/483931628b3a4ce7ffe9e15fb28de20b5362a757\">4839316</a></td><td><code>Miscellaneous updates to not use deprecated interfaces, particularly</code></td></tr></table>\n",
    "created_at": "2021-02-03T13:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504714",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8" align="right">Comment 8</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/45b175e43621795f890204a9cdfb30b524f961fa">45b175e</a></td><td><code>Don't use the string evaluation construction for libgap permutation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/197290f339ef5da0dbce0eb6afde85ad65dabd6a">197290f</a></td><td><code>Fix miscellaneous tests that broke due to different group iteration</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9f621e96ff870e7fba2fc1177d82a08aca6ce52f">9f621e9</a></td><td><code>Update gappy to v0.1.0a1 with some fixes for matrices and gap_function.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/483931628b3a4ce7ffe9e15fb28de20b5362a757">4839316</a></td><td><code>Miscellaneous updates to not use deprecated interfaces, particularly</code></td></tr></table>




---

archive/issue_comments_504715.json:
```json
{
    "body": "Changed commit from **[a8aab2a](https://github.com/sagemath/sagetrac-mirror/commit/a8aab2adfe417087af7f1ad5393ca7a61e242613)** to **[4839316](https://github.com/sagemath/sagetrac-mirror/commit/483931628b3a4ce7ffe9e15fb28de20b5362a757)**",
    "created_at": "2021-02-03T13:35:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504715",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[a8aab2a](https://github.com/sagemath/sagetrac-mirror/commit/a8aab2adfe417087af7f1ad5393ca7a61e242613)** to **[4839316](https://github.com/sagemath/sagetrac-mirror/commit/483931628b3a4ce7ffe9e15fb28de20b5362a757)**



---

archive/issue_comments_504716.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-**Package tarball:** https://files.pythonhosted.org/packages/b4/1a/78bda94109c877c632dc385b2c2d899e08389bfad89d32b92df0c6636d21/gappy-system-0.1.0a0.tar.gz\n+**Package tarball:** https://files.pythonhosted.org/packages/9f/86/3571d73c84bf64081413b57d908e516a86ffeb8fcda766919b814220adad/gappy-system-0.1.0a1.tar.gz\n \n [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n \n``````\n",
    "created_at": "2021-02-03T13:36:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504716",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-**Package tarball:** https://files.pythonhosted.org/packages/b4/1a/78bda94109c877c632dc385b2c2d899e08389bfad89d32b92df0c6636d21/gappy-system-0.1.0a0.tar.gz
+**Package tarball:** https://files.pythonhosted.org/packages/9f/86/3571d73c84bf64081413b57d908e516a86ffeb8fcda766919b814220adad/gappy-system-0.1.0a1.tar.gz
 
 [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).
 
``````




---

archive/issue_comments_504717.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nReplying to [@mkoeppe](#comment%3A7):\n> See #29865 for this\n\nThanks for pointing it out.  I thought I remembered there being a ticket for that.  I didn't realize you already had a prototype in the works.",
    "created_at": "2021-02-03T13:37:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504717",
    "user": "https://github.com/embray"
}
```

<div id="comment:10" align="right">Comment 10</div>

Replying to [@mkoeppe](#comment%3A7):
> See #29865 for this

Thanks for pointing it out.  I thought I remembered there being a ticket for that.  I didn't realize you already had a prototype in the works.



---

archive/issue_events_413133.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-02-03T13:39:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413133"
}
```



---

archive/issue_comments_504718.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nTravis, I'm curious about your take on this, especially on the impact to permutation groups, since this partly reverts #25609, which I see you worked on.  AFAICT this makes some minor performance improvements in construction of permutation groups from Sage -> GAP, but might be a little slower for going from GAP -> Sage.",
    "created_at": "2021-02-03T13:39:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504718",
    "user": "https://github.com/embray"
}
```

<div id="comment:11" align="right">Comment 11</div>

Travis, I'm curious about your take on this, especially on the impact to permutation groups, since this partly reverts #25609, which I see you worked on.  AFAICT this makes some minor performance improvements in construction of permutation groups from Sage -> GAP, but might be a little slower for going from GAP -> Sage.



---

archive/issue_comments_504719.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -37,7 +37,7 @@\n \n The other two, which would be much more disruptive, but also possibly useful for other packages that would like to integrate with Sage without explicitly depending on it, and have been discussed before:\n \n-1) Create a relatively Sage \"base\" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.\n+1) Create a relatively Sage \"base\" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.  See #29865 for an in-progress viable prototype of this.\n \n 2) A similar but subtly different option is to make classes like `SageObject`, `Parent`, and `Element` into Abstract Base Classes.  Classes in other packages can then be registered as psuedo-subclasses of these ABCs without directly subclassing them, so long as they implement the necessary interfaces.  This option is appealing to me since it means classes from other packages can more easily interface with Sage without requiring any additional dependencies.  However, it is potentially more disruptive: There isn't a way to ensure that classes which register to an ABC to provide the same C-level interface (C methods and attributes).  So Cython-level code that types variables as `Parent` or `Element` won't work here, and would have to provide a separate (typically slower) code path for handle ABC pseudo-subclasses.  Fortunately there is not a ton of code like this in Sage, but there is some, especially in code related to the coercion model, unsurprisingly.\n \n``````\n",
    "created_at": "2021-02-03T14:02:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504719",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -37,7 +37,7 @@
 
 The other two, which would be much more disruptive, but also possibly useful for other packages that would like to integrate with Sage without explicitly depending on it, and have been discussed before:
 
-1) Create a relatively Sage "base" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.
+1) Create a relatively Sage "base" package with little to no mathematical functionality but that provides base classes for some of Sage's structural classes such as `SageObject`, `Parent`, and `Element` (maybe also `CategoryObject`?).  These base classes need not replicate the full functionality found in Sage, but just enough to provide some bootstrapping.  If the package is relatively small and easily pip-installable, packages like gappy can use it as a dependency without requiring all of Sage.  See #29865 for an in-progress viable prototype of this.
 
 2) A similar but subtly different option is to make classes like `SageObject`, `Parent`, and `Element` into Abstract Base Classes.  Classes in other packages can then be registered as psuedo-subclasses of these ABCs without directly subclassing them, so long as they implement the necessary interfaces.  This option is appealing to me since it means classes from other packages can more easily interface with Sage without requiring any additional dependencies.  However, it is potentially more disruptive: There isn't a way to ensure that classes which register to an ABC to provide the same C-level interface (C methods and attributes).  So Cython-level code that types variables as `Parent` or `Element` won't work here, and would have to provide a separate (typically slower) code path for handle ABC pseudo-subclasses.  Fortunately there is not a ton of code like this in Sage, but there is some, especially in code related to the coercion model, unsurprisingly.
 
``````




---

archive/issue_comments_504720.json:
```json
{
    "body": "Work Issues: **release gappy 0.1.0 final and update spkg version before merging**",
    "created_at": "2021-02-03T14:03:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504720",
    "user": "https://github.com/embray"
}
```

Work Issues: **release gappy 0.1.0 final and update spkg version before merging**



---

archive/issue_comments_504721.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nBig +1 on this work (but I know too little about GAP to review)",
    "created_at": "2021-02-03T18:12:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504721",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">Comment 14</div>

Big +1 on this work (but I know too little about GAP to review)



---

archive/issue_comments_504722.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-**Package tarball:** https://files.pythonhosted.org/packages/9f/86/3571d73c84bf64081413b57d908e516a86ffeb8fcda766919b814220adad/gappy-system-0.1.0a1.tar.gz\n+Package tarball: see `checksums.ini`; use `./configure --enable-download-from-upstream-url` to test.\n \n [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n \n``````\n",
    "created_at": "2021-02-03T18:12:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504722",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-**Package tarball:** https://files.pythonhosted.org/packages/9f/86/3571d73c84bf64081413b57d908e516a86ffeb8fcda766919b814220adad/gappy-system-0.1.0a1.tar.gz
+Package tarball: see `checksums.ini`; use `./configure --enable-download-from-upstream-url` to test.
 
 [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).
 
``````




---

archive/issue_comments_504723.json:
```json
{
    "body": "Changed commit from **[4839316](https://github.com/sagemath/sagetrac-mirror/commit/483931628b3a4ce7ffe9e15fb28de20b5362a757)** to **[baa0f61](https://github.com/sagemath/sagetrac-mirror/commit/baa0f61f86120ca2bb53e6d3a039f69239a1d0ac)**",
    "created_at": "2021-02-03T20:11:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504723",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[4839316](https://github.com/sagemath/sagetrac-mirror/commit/483931628b3a4ce7ffe9e15fb28de20b5362a757)** to **[baa0f61](https://github.com/sagemath/sagetrac-mirror/commit/baa0f61f86120ca2bb53e6d3a039f69239a1d0ac)**



---

archive/issue_comments_504724.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/baa0f61f86120ca2bb53e6d3a039f69239a1d0ac\">baa0f61</a></td><td><code>Update gappy to v0.1.0a2 which adds MacOS and Cygwin fixes.</code></td></tr></table>\n",
    "created_at": "2021-02-03T20:11:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504724",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15" align="right">Comment 15</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/baa0f61f86120ca2bb53e6d3a039f69239a1d0ac">baa0f61</a></td><td><code>Update gappy to v0.1.0a2 which adds MacOS and Cygwin fixes.</code></td></tr></table>




---

archive/issue_comments_504725.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nA quick remark on `install-requires`: For prerelease versions, it's best to use the exact version; version ranges may not work (see\n[#30913 comment:81](https://github.com/sagemath/sage/issues/30913#comment:81)), \nso it should be `gappy ==0.1.0a0`",
    "created_at": "2021-02-03T21:08:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504725",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">Comment 16</div>

A quick remark on `install-requires`: For prerelease versions, it's best to use the exact version; version ranges may not work (see
[#30913 comment:81](https://github.com/sagemath/sage/issues/30913#comment:81)), 
so it should be `gappy ==0.1.0a0`



---

archive/issue_comments_504726.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\n`gappy` is an excellent news!\n\nI would like to bring the attention to cypari2 that played the role of gappy at the time the PARI/GP interface in Sage became an independent Cython module. In particular, if any design decision has to be made, it would be weird if they would be different for both interfaces.\n\nFirst of all, two things that seem different from the rough description of the ticket\n- there is no extra layer between cypari2 and Sage. Sage deals with `cypari2.gen.Gen` objects directly.\n- cypari2 is completely agnostic to Sage and its coercion system\n\nThere was no need for coercion because the most basic possible happen : in any mixture, everything is converted to a cypari2 Gen object. Here with integers\n\n```\nsage: type(1 + pari(1))\n<class 'cypari2.gen.Gen'>\nsage: type(pari(1) + 1)\n<class 'cypari2.gen.Gen'>\n```\nHere with matrices\n\n```\nsage: type(pari(\"[1, 2; 3, 4]\") + matrix(2, [1,1,1,1]))\n<class 'cypari2.gen.Gen'>\nsage: type(matrix(2, [1,1,1,1]) + pari(\"[1, 2; 3, 4]\"))\n<class 'cypari2.gen.Gen'>\n```\nI do not see the difference here with the GAP interface. In what sort of construction the interaction with categories/coercion has to be handled? I would like a more concrete description if possible.\n\nOn a related note, cypari2 introduced the standardized name `__pari__` for the method that would provide a conversion of any object to its cypari2 equivalent. That way, any Python library could make interaction with cypari2.\n\nFor the cypari2 -> Sage conversion, there is `sage.libs.pari.convert_sage.gen_to_sage` which is a partial but efficient converter. It introduced a slowdown in conversions PARI/GP -> Sage because the `sage` method on `cypari2.gen.Gen` (which was kept) became\n\n```python\ncdef class Gen:\n    def sage(self, locals=None):\n        r\"\"\"\n        Return the closest SageMath equivalent of the given PARI object.\n\n        INPUT:\n\n        - ``locals`` -- optional dictionary used in fallback cases that\n          involve ``sage_eval``\n\n        See :func:`~sage.libs.pari.convert_sage.gen_to_sage` for more information.\n        \"\"\"\n        from sage.libs.pari.convert_sage import gen_to_sage\n        return gen_to_sage(self, locals)\n```",
    "created_at": "2021-02-03T21:40:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504726",
    "user": "https://github.com/videlec"
}
```

<div id="comment:17" align="right">Comment 17</div>

`gappy` is an excellent news!

I would like to bring the attention to cypari2 that played the role of gappy at the time the PARI/GP interface in Sage became an independent Cython module. In particular, if any design decision has to be made, it would be weird if they would be different for both interfaces.

First of all, two things that seem different from the rough description of the ticket
- there is no extra layer between cypari2 and Sage. Sage deals with `cypari2.gen.Gen` objects directly.
- cypari2 is completely agnostic to Sage and its coercion system

There was no need for coercion because the most basic possible happen : in any mixture, everything is converted to a cypari2 Gen object. Here with integers

```
sage: type(1 + pari(1))
<class 'cypari2.gen.Gen'>
sage: type(pari(1) + 1)
<class 'cypari2.gen.Gen'>
```
Here with matrices

```
sage: type(pari("[1, 2; 3, 4]") + matrix(2, [1,1,1,1]))
<class 'cypari2.gen.Gen'>
sage: type(matrix(2, [1,1,1,1]) + pari("[1, 2; 3, 4]"))
<class 'cypari2.gen.Gen'>
```
I do not see the difference here with the GAP interface. In what sort of construction the interaction with categories/coercion has to be handled? I would like a more concrete description if possible.

On a related note, cypari2 introduced the standardized name `__pari__` for the method that would provide a conversion of any object to its cypari2 equivalent. That way, any Python library could make interaction with cypari2.

For the cypari2 -> Sage conversion, there is `sage.libs.pari.convert_sage.gen_to_sage` which is a partial but efficient converter. It introduced a slowdown in conversions PARI/GP -> Sage because the `sage` method on `cypari2.gen.Gen` (which was kept) became

```python
cdef class Gen:
    def sage(self, locals=None):
        r"""
        Return the closest SageMath equivalent of the given PARI object.

        INPUT:

        - ``locals`` -- optional dictionary used in fallback cases that
          involve ``sage_eval``

        See :func:`~sage.libs.pari.convert_sage.gen_to_sage` for more information.
        """
        from sage.libs.pari.convert_sage import gen_to_sage
        return gen_to_sage(self, locals)
```



---

archive/issue_comments_504727.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nReplying to [@embray](#comment%3A11):\n> Travis, I'm curious about your take on this, especially on the impact to permutation groups, since this partly reverts #25609, which I see you worked on.  AFAICT this makes some minor performance improvements in construction of permutation groups from Sage -> GAP, but might be a little slower for going from GAP -> Sage.\n\nA good stress test would be iterating through the E<sub>7</sub> Weyl group:\n\n```\nsage: W = CoxeterGroup('E7', implementation='permutation')\nsage: W.cardinality()                                                                                                     \n2903040\nsage: %time for w in W.iteration('depth', False): pass                                                                    \nCPU times: user 1.05 s, sys: 391 \u00b5s, total: 1.05 s\nWall time: 1.05 s\n```\nIf you are more brave, do E<sub>8</sub> (which has 696729600 elements), but that will take many minutes to complete. D<sub>9</sub> is perhaps a better intermediate example:\n\n```\nsage: W = CoxeterGroup('D9', implementation='permutation')                                                                \nsage: W.cardinality()                                                                                                     \n92897280\nsage: %time for w in W.iteration('depth', False): pass                                                                    \nCPU times: user 34.4 s, sys: 0 ns, total: 34.4 s\nWall time: 34.4 s\n```\n\nAs long as the slowdown is relatively small, then I think this is a good way forward as it makes maintenance easier. Plus it will benefit the broader community.",
    "created_at": "2021-02-04T05:14:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504727",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18" align="right">Comment 18</div>

Replying to [@embray](#comment%3A11):
> Travis, I'm curious about your take on this, especially on the impact to permutation groups, since this partly reverts #25609, which I see you worked on.  AFAICT this makes some minor performance improvements in construction of permutation groups from Sage -> GAP, but might be a little slower for going from GAP -> Sage.

A good stress test would be iterating through the E<sub>7</sub> Weyl group:

```
sage: W = CoxeterGroup('E7', implementation='permutation')
sage: W.cardinality()                                                                                                     
2903040
sage: %time for w in W.iteration('depth', False): pass                                                                    
CPU times: user 1.05 s, sys: 391 s, total: 1.05 s
Wall time: 1.05 s
```
If you are more brave, do E<sub>8</sub> (which has 696729600 elements), but that will take many minutes to complete. D<sub>9</sub> is perhaps a better intermediate example:

```
sage: W = CoxeterGroup('D9', implementation='permutation')                                                                
sage: W.cardinality()                                                                                                     
92897280
sage: %time for w in W.iteration('depth', False): pass                                                                    
CPU times: user 34.4 s, sys: 0 ns, total: 34.4 s
Wall time: 34.4 s
```

As long as the slowdown is relatively small, then I think this is a good way forward as it makes maintenance easier. Plus it will benefit the broader community.



---

archive/issue_comments_504728.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nReplying to [@tscrim](#comment%3A18):\n> Replying to [@embray](#comment%3A11):\n> > Travis, I'm curious about your take on this, especially on the impact to permutation groups, since this partly reverts #25609, which I see you worked on.  AFAICT this makes some minor performance improvements in construction of permutation groups from Sage -> GAP, but might be a little slower for going from GAP -> Sage.\n\n> \n> A good stress test would be iterating through the E<sub>7</sub> Weyl group:\n\nI got,\n\nbefore:\n\n```\nsage: W = CoxeterGroup('E7', implementation='permutation')                                                                                                                                       \nsage: W.cardinality()                                                                                                                                                                            \n2903040\nsage: %time for w in W.iteration('depth', False): pass                                                                                                                                           \nCPU times: user 1.27 s, sys: 518 \u00b5s, total: 1.27 s\nWall time: 1.27 s\nsage: W = CoxeterGroup('D9', implementation='permutation')                                                                                                                                       \nsage: W.cardinality()                                                                                                                                                                            \n92897280\nsage: %time for w in W.iteration('depth', False): pass                                                                                                                                           \nCPU times: user 42.7 s, sys: 40.9 ms, total: 42.7 s\nWall time: 42.8 s\n```\n\nafter:\n\n```\nsage: W = CoxeterGroup('E7', implementation='permutation')                                                                                                                                       \nsage: W.cardinality()                                                                                                                                                                            \n2903040\nsage: %time for w in W.iteration('depth', False): pass                                                                                                                                           \nCPU times: user 1.26 s, sys: 0 ns, total: 1.26 s\nWall time: 1.27 s\nsage: %timeit for w in W.iteration('depth', False): pass                                                                                                                                         \n1.23 s \u00b1 64.9 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: W = CoxeterGroup('D9', implementation='permutation')                                                                                                                                       \nsage: W.cardinality()                                                                                                                                                                            \n92897280\nsage: %time for w in W.iteration('depth', False): pass                                                                                                                                           \nCPU times: user 44.7 s, sys: 3.91 ms, total: 44.7 s\nWall time: 44.7 s\nsage: %timeit for w in W.iteration('depth', False): pass                                                                                                                                         \n42.7 s \u00b1 1.24 s per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\nso at least for this case no better but no worse.",
    "created_at": "2021-02-04T11:50:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504728",
    "user": "https://github.com/embray"
}
```

<div id="comment:19" align="right">Comment 19</div>

Replying to [@tscrim](#comment%3A18):
> Replying to [@embray](#comment%3A11):
> > Travis, I'm curious about your take on this, especially on the impact to permutation groups, since this partly reverts #25609, which I see you worked on.  AFAICT this makes some minor performance improvements in construction of permutation groups from Sage -> GAP, but might be a little slower for going from GAP -> Sage.

> 
> A good stress test would be iterating through the E<sub>7</sub> Weyl group:

I got,

before:

```
sage: W = CoxeterGroup('E7', implementation='permutation')                                                                                                                                       
sage: W.cardinality()                                                                                                                                                                            
2903040
sage: %time for w in W.iteration('depth', False): pass                                                                                                                                           
CPU times: user 1.27 s, sys: 518 s, total: 1.27 s
Wall time: 1.27 s
sage: W = CoxeterGroup('D9', implementation='permutation')                                                                                                                                       
sage: W.cardinality()                                                                                                                                                                            
92897280
sage: %time for w in W.iteration('depth', False): pass                                                                                                                                           
CPU times: user 42.7 s, sys: 40.9 ms, total: 42.7 s
Wall time: 42.8 s
```

after:

```
sage: W = CoxeterGroup('E7', implementation='permutation')                                                                                                                                       
sage: W.cardinality()                                                                                                                                                                            
2903040
sage: %time for w in W.iteration('depth', False): pass                                                                                                                                           
CPU times: user 1.26 s, sys: 0 ns, total: 1.26 s
Wall time: 1.27 s
sage: %timeit for w in W.iteration('depth', False): pass                                                                                                                                         
1.23 s  64.9 ms per loop (mean  std. dev. of 7 runs, 1 loop each)
sage: W = CoxeterGroup('D9', implementation='permutation')                                                                                                                                       
sage: W.cardinality()                                                                                                                                                                            
92897280
sage: %time for w in W.iteration('depth', False): pass                                                                                                                                           
CPU times: user 44.7 s, sys: 3.91 ms, total: 44.7 s
Wall time: 44.7 s
sage: %timeit for w in W.iteration('depth', False): pass                                                                                                                                         
42.7 s  1.24 s per loop (mean  std. dev. of 7 runs, 1 loop each)
```

so at least for this case no better but no worse.



---

archive/issue_comments_504729.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1\">a07f20e</a></td><td><code>Fixes needed for gappy v0.1.0a2 which did away with the libgap_soname</code></td></tr></table>\n",
    "created_at": "2021-02-04T11:54:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504729",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20" align="right">Comment 20</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1">a07f20e</a></td><td><code>Fixes needed for gappy v0.1.0a2 which did away with the libgap_soname</code></td></tr></table>




---

archive/issue_comments_504730.json:
```json
{
    "body": "Changed commit from **[baa0f61](https://github.com/sagemath/sagetrac-mirror/commit/baa0f61f86120ca2bb53e6d3a039f69239a1d0ac)** to **[a07f20e](https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1)**",
    "created_at": "2021-02-04T11:54:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504730",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[baa0f61](https://github.com/sagemath/sagetrac-mirror/commit/baa0f61f86120ca2bb53e6d3a039f69239a1d0ac)** to **[a07f20e](https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1)**



---

archive/issue_comments_504731.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nReplying to [@videlec](#comment%3A17):\n> `gappy` is an excellent news!\n> \n> I would like to bring the attention to cypari2 that played the role of gappy at the time the PARI/GP interface in Sage became an independent Cython module. In particular, if any design decision has to be made, it would be weird if they would be different for both interfaces.\n\nThanks for your comments Vincent.  Yes, this is definitely intended in the same vein as cypari2.\n\n> First of all, two things that seem different from the rough description of the ticket\n> - there is no extra layer between cypari2 and Sage. Sage deals with `cypari2.gen.Gen` objects directly.\n> - cypari2 is completely agnostic to Sage and its coercion system\n\nI think this is what I would prefer as well.\n\n> There was no need for coercion because the most basic possible happen : in any mixture, everything is converted to a cypari2 Gen object. Here with integers\n> \n> ```\n> sage: type(1 + pari(1))\n> <class 'cypari2.gen.Gen'>\n> sage: type(pari(1) + 1)\n> <class 'cypari2.gen.Gen'>\n> ```\n> Here with matrices\n> \n> ```\n> sage: type(pari(\"[1, 2; 3, 4]\") + matrix(2, [1,1,1,1]))\n> <class 'cypari2.gen.Gen'>\n> sage: type(matrix(2, [1,1,1,1]) + pari(\"[1, 2; 3, 4]\"))\n> <class 'cypari2.gen.Gen'>\n> ```\n\nHere's the same examples using gappy directly.  The integers work:\n\n```\nsage: from gappy import gap                                                                                                                                                                      \nsage: type(1 + gap(1))                                                                                                                                                                           \n<class 'gappy.gapobj.GapInteger'>\nsage: type(gap(1) + 1)                                                                                                                                                                           \n<class 'gappy.gapobj.GapInteger'>\n```\n\nbut the matrices do not for some reason; I think because gappy uses a `_gap_` magic method (similarly to `__pari__`, but this conflicts with Sage's existing `_gap_` magic method for using the GAP pexpect interface).  I get:\n\n```\nsage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))\nAttributeError                            Traceback (most recent call last)\n<ipython-input-4-6fdcc2d39852> in <module>\n----> 1 type(gap([[Integer(1), Integer(2)], [Integer(3), Integer(4)]]) + matrix(Integer(2), [Integer(1), Integer(1), Integer(1), Integer(1)]))\n\ngappy/gapobj.pyx in gappy.gapobj.GapObj.__add__()\n\ngappy/gapobj.pyx in gappy.gapobj.GapObj.parent()\n\ngappy/core.pyx in gappy.core.Gap.__call__()\n\n~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:6225)()\n    714             import sage.interfaces.gap\n    715             G = sage.interfaces.gap.gap\n--> 716         return self._interface_(G)\n    717 \n    718     def _gap_init_(self):\n\n~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5480)()\n    678             except (KeyError, ValueError):\n    679                 pass\n--> 680         nm = I.name()\n    681         init_func = getattr(self, '_%s_init_' % nm, None)\n    682         if init_func is not None:\n\ngappy/core.pyx in gappy.core.Gap.__getattr__()\n\nAttributeError: no GAP global variable bound to 'name'\n```\n\nHowever, if I do this:\n\n```\nsage: gap = libgap.gap  # This is the gappy.Gap instance wrapped by Sage's interface                                                                                                                                                                    \nsage: gap\n<Gap(gap_root='/home/embray/src/sagemath/sage/local/share/gap')>\nsage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))                                                                                                                                      \n<class 'gappy.gapobj.GapList'>\nsage: gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1])                                                                                                                                            \n[ [ 2, 3 ], [ 4, 5 ] ]\nsage: type(matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]]))                                                                                                                                      \n<class 'gappy.gapobj.GapList'>\nsage: matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]])                                                                                                                                            \n[ [ 2, 3 ], [ 4, 5 ] ]\n```\n\nIt has the necessary converters registered to handle `SageObject`s correctly.\n\nSo it looks like gappy and cypari2 are indeed mostly similar in this case.\n\n> I do not see the difference here with the GAP interface. In what sort of construction the interaction with categories/coercion has to be handled? I would like a more concrete description if possible.\n\nHonestly, I do not know.  I don't even understand the coercion system well-enough to say.  It's just because the old `sage.libs.gap` did use it, so I tried, for now, to keep the same interface for a couple reasons:\n\n* Backwards compatibility--I didn't want to break the existing API too much, especially if someone is writing code that explicitly checks for Sage `GapElement`s.  I do not know if anyone is actually doing this.\n\n* Consistency--the other Sage interfaces to other languages use the Parent/Element model so I just tried to keep that consistent.  Maybe it is not really necessary or useful though.  If someone can confirm for me that it isn't then we can use gappy more-or-less directly and do a way with a lot of extra complexity.\n\n> On a related note, cypari2 introduced the standardized name `__pari__` for the method that would provide a conversion of any object to its cypari2 equivalent. That way, any Python library could make interaction with cypari2.\n> \n> For the cypari2 -> Sage conversion, there is `sage.libs.pari.convert_sage.gen_to_sage` which is a partial but efficient converter. It introduced a slowdown in conversions PARI/GP -> Sage because the `sage` method on `cypari2.gen.Gen` (which was kept) became\n\nThis is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1\">a07f20e</a></td><td><code>Fixes needed for gappy v0.1.0a2 which did away with the libgap_soname</code></td></tr></table>\n",
    "created_at": "2021-02-04T12:09:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504731",
    "user": "https://github.com/embray"
}
```

<div id="comment:21" align="right">Comment 21</div>

Replying to [@videlec](#comment%3A17):
> `gappy` is an excellent news!
> 
> I would like to bring the attention to cypari2 that played the role of gappy at the time the PARI/GP interface in Sage became an independent Cython module. In particular, if any design decision has to be made, it would be weird if they would be different for both interfaces.

Thanks for your comments Vincent.  Yes, this is definitely intended in the same vein as cypari2.

> First of all, two things that seem different from the rough description of the ticket
> - there is no extra layer between cypari2 and Sage. Sage deals with `cypari2.gen.Gen` objects directly.
> - cypari2 is completely agnostic to Sage and its coercion system

I think this is what I would prefer as well.

> There was no need for coercion because the most basic possible happen : in any mixture, everything is converted to a cypari2 Gen object. Here with integers
> 
> ```
> sage: type(1 + pari(1))
> <class 'cypari2.gen.Gen'>
> sage: type(pari(1) + 1)
> <class 'cypari2.gen.Gen'>
> ```
> Here with matrices
> 
> ```
> sage: type(pari("[1, 2; 3, 4]") + matrix(2, [1,1,1,1]))
> <class 'cypari2.gen.Gen'>
> sage: type(matrix(2, [1,1,1,1]) + pari("[1, 2; 3, 4]"))
> <class 'cypari2.gen.Gen'>
> ```

Here's the same examples using gappy directly.  The integers work:

```
sage: from gappy import gap                                                                                                                                                                      
sage: type(1 + gap(1))                                                                                                                                                                           
<class 'gappy.gapobj.GapInteger'>
sage: type(gap(1) + 1)                                                                                                                                                                           
<class 'gappy.gapobj.GapInteger'>
```

but the matrices do not for some reason; I think because gappy uses a `_gap_` magic method (similarly to `__pari__`, but this conflicts with Sage's existing `_gap_` magic method for using the GAP pexpect interface).  I get:

```
sage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))
AttributeError                            Traceback (most recent call last)
<ipython-input-4-6fdcc2d39852> in <module>
----> 1 type(gap([[Integer(1), Integer(2)], [Integer(3), Integer(4)]]) + matrix(Integer(2), [Integer(1), Integer(1), Integer(1), Integer(1)]))

gappy/gapobj.pyx in gappy.gapobj.GapObj.__add__()

gappy/gapobj.pyx in gappy.gapobj.GapObj.parent()

gappy/core.pyx in gappy.core.Gap.__call__()

~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:6225)()
    714             import sage.interfaces.gap
    715             G = sage.interfaces.gap.gap
--> 716         return self._interface_(G)
    717 
    718     def _gap_init_(self):

~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5480)()
    678             except (KeyError, ValueError):
    679                 pass
--> 680         nm = I.name()
    681         init_func = getattr(self, '_%s_init_' % nm, None)
    682         if init_func is not None:

gappy/core.pyx in gappy.core.Gap.__getattr__()

AttributeError: no GAP global variable bound to 'name'
```

However, if I do this:

```
sage: gap = libgap.gap  # This is the gappy.Gap instance wrapped by Sage's interface                                                                                                                                                                    
sage: gap
<Gap(gap_root='/home/embray/src/sagemath/sage/local/share/gap')>
sage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))                                                                                                                                      
<class 'gappy.gapobj.GapList'>
sage: gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1])                                                                                                                                            
[ [ 2, 3 ], [ 4, 5 ] ]
sage: type(matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]]))                                                                                                                                      
<class 'gappy.gapobj.GapList'>
sage: matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]])                                                                                                                                            
[ [ 2, 3 ], [ 4, 5 ] ]
```

It has the necessary converters registered to handle `SageObject`s correctly.

So it looks like gappy and cypari2 are indeed mostly similar in this case.

> I do not see the difference here with the GAP interface. In what sort of construction the interaction with categories/coercion has to be handled? I would like a more concrete description if possible.

Honestly, I do not know.  I don't even understand the coercion system well-enough to say.  It's just because the old `sage.libs.gap` did use it, so I tried, for now, to keep the same interface for a couple reasons:

* Backwards compatibility--I didn't want to break the existing API too much, especially if someone is writing code that explicitly checks for Sage `GapElement`s.  I do not know if anyone is actually doing this.

* Consistency--the other Sage interfaces to other languages use the Parent/Element model so I just tried to keep that consistent.  Maybe it is not really necessary or useful though.  If someone can confirm for me that it isn't then we can use gappy more-or-less directly and do a way with a lot of extra complexity.

> On a related note, cypari2 introduced the standardized name `__pari__` for the method that would provide a conversion of any object to its cypari2 equivalent. That way, any Python library could make interaction with cypari2.
> 
> For the cypari2 -> Sage conversion, there is `sage.libs.pari.convert_sage.gen_to_sage` which is a partial but efficient converter. It introduced a slowdown in conversions PARI/GP -> Sage because the `sage` method on `cypari2.gen.Gen` (which was kept) became

This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1">a07f20e</a></td><td><code>Fixes needed for gappy v0.1.0a2 which did away with the libgap_soname</code></td></tr></table>




---

archive/issue_comments_504732.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nReplying to [@embray](#comment%3A21):\n> This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.\n\n\nAnother possibility is that just as user classes can have a `_gap_` method to convert to GAP-compatible representations, gappy could add a system for registering \"GAP -> <whatever>\" converters.  They could have `.sage()` methods tacked on to them without having to make subclasses.",
    "created_at": "2021-02-04T12:13:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504732",
    "user": "https://github.com/embray"
}
```

<div id="comment:22" align="right">Comment 22</div>

Replying to [@embray](#comment%3A21):
> This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.


Another possibility is that just as user classes can have a `_gap_` method to convert to GAP-compatible representations, gappy could add a system for registering "GAP -> <whatever>" converters.  They could have `.sage()` methods tacked on to them without having to make subclasses.



---

archive/issue_comments_504733.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nReplying to [@embray](#comment%3A21):\n> Replying to [@videlec](#comment%3A17):\n> > `gappy` is an excellent news!\n> > \n> > I would like to bring the attention to cypari2 that played the role of gappy at the time the PARI/GP interface in Sage became an independent Cython module. In particular, if any design decision has to be made, it would be weird if they would be different for both interfaces.\n\n> \n> Thanks for your comments Vincent.  Yes, this is definitely intended in the same vein as cypari2.\n> \n> > First of all, two things that seem different from the rough description of the ticket\n> > - there is no extra layer between cypari2 and Sage. Sage deals with `cypari2.gen.Gen` objects directly.\n> > - cypari2 is completely agnostic to Sage and its coercion system\n\n> \n> I think this is what I would prefer as well.\n\nCould we try to make the direct interface work as well? I mean as far as binary operators are concerned, it should be fine to mix gappy elements with SageMath elements. If an intermediate layer is needed it could also be introduced. I think gappy is a good occasion to clean the design of the gap interface.\n\n> > There was no need for coercion because the most basic possible happen : in any mixture, everything is converted to a cypari2 Gen object. Here with integers\n> > \n> > ```\n> > sage: type(1 + pari(1))\n> > <class 'cypari2.gen.Gen'>\n> > sage: type(pari(1) + 1)\n> > <class 'cypari2.gen.Gen'>\n> > ```\n> > Here with matrices\n> > \n> > ```\n> > sage: type(pari(\"[1, 2; 3, 4]\") + matrix(2, [1,1,1,1]))\n> > <class 'cypari2.gen.Gen'>\n> > sage: type(matrix(2, [1,1,1,1]) + pari(\"[1, 2; 3, 4]\"))\n> > <class 'cypari2.gen.Gen'>\n> > ```\n\n> \n> Here's the same examples using gappy directly.  The integers work:\n> \n> ```\n> sage: from gappy import gap\n> sage: type(1 + gap(1))\n> <class 'gappy.gapobj.GapInteger'>\n> sage: type(gap(1) + 1)\n> <class 'gappy.gapobj.GapInteger'>\n> ```\n> \n> but the matrices do not for some reason; I think because gappy uses a `_gap_` magic method (similarly to `__pari__`, but this conflicts with Sage's existing `_gap_` magic method for using the GAP pexpect interface).  I get:\n> \n> ```\n> sage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))\n> AttributeError                            Traceback (most recent call last)\n> <ipython-input-4-6fdcc2d39852> in <module>\n> ----> 1 type(gap([[Integer(1), Integer(2)], [Integer(3), Integer(4)]]) + matrix(Integer(2), [Integer(1), Integer(1), Integer(1), Integer(1)]))\n> \n> gappy/gapobj.pyx in gappy.gapobj.GapObj.__add__()\n> \n> gappy/gapobj.pyx in gappy.gapobj.GapObj.parent()\n> \n> gappy/core.pyx in gappy.core.Gap.__call__()\n> \n> ~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:6225)()\n>     714             import sage.interfaces.gap\n>     715             G = sage.interfaces.gap.gap\n> --> 716         return self._interface_(G)\n>     717 \n>     718     def _gap_init_(self):\n> \n> ~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5480)()\n>     678             except (KeyError, ValueError):\n>     679                 pass\n> --> 680         nm = I.name()\n>     681         init_func = getattr(self, '_%s_init_' % nm, None)\n>     682         if init_func is not None:\n> \n> gappy/core.pyx in gappy.core.Gap.__getattr__()\n> \n> AttributeError: no GAP global variable bound to 'name'\n> ```\n> \n> However, if I do this:\n> \n> ```\n> sage: gap = libgap.gap  # This is the gappy.Gap instance wrapped by Sage's interface                                                                                                                                                                    \n> sage: gap\n> <Gap(gap_root='/home/embray/src/sagemath/sage/local/share/gap')>\n> sage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))                                                                                                                                      \n> <class 'gappy.gapobj.GapList'>\n> sage: gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1])                                                                                                                                            \n> [ [ 2, 3 ], [ 4, 5 ] ]\n> sage: type(matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]]))                                                                                                                                      \n> <class 'gappy.gapobj.GapList'>\n> sage: matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]])                                                                                                                                            \n> [ [ 2, 3 ], [ 4, 5 ] ]\n> ```\n> \n> It has the necessary converters registered to handle `SageObject`s correctly.\n> \n> So it looks like gappy and cypari2 are indeed mostly similar in this case.\n> \n> > I do not see the difference here with the GAP interface. In what sort of construction the interaction with categories/coercion has to be handled? I would like a more concrete description if possible.\n\n> \n> Honestly, I do not know.  I don't even understand the coercion system well-enough to say.  It's just because the old `sage.libs.gap` did use it, so I tried, for now, to keep the same interface for a couple reasons:\n> \n> * Backwards compatibility--I didn't want to break the existing API too much, especially if someone is writing code that explicitly checks for Sage `GapElement`s.  I do not know if anyone is actually doing this.\n> \n> * Consistency--the other Sage interfaces to other languages use the Parent/Element model so I just tried to keep that consistent.  Maybe it is not really necessary or useful though.  If someone can confirm for me that it isn't then we can use gappy more-or-less directly and do a way with a lot of extra complexity.\n\nhmm. PARI/GP is a counterexemple to that.\n\nOne construction I can imagine where the layer could be relevant is if you want to use some gap objects as coefficients of a matrix. To do that, you would use\n\n```\nsage: MatrixSpace(GapBaseRing(), 3, 3)\n```\nwhere `GapBaseRing()` would be a GapObj modelling a ring of numbers. Then if `GapBaseRing()` is not recognized as a proper ring from SageMath such construction would be impossible. I am not sure it is currently used anywhere.\n\n> > On a related note, cypari2 introduced the standardized name `__pari__` for the method that would provide a conversion of any object to its cypari2 equivalent. That way, any Python library could make interaction with cypari2.\n\nActually one could use `__gap__` (double underscore) for the gappy objects and keep the single underscore `_gap_/_libgap_` for the one with coercion layer. The double score convention is more Pythonic and, I think, prefered outside of [SageMath](../wiki/SageMath). Moreover, I believe the simple underscore could be as generic as\n\n```\nfile: src/sage/structure/element.pyx\n\ncdef class Element(SageObject):\n    def _gap_(self):\n        from sage.libs.gap.wrapper import GappyWrapperWithCoercion\n        return GappyWrapperWithCoercion(self.__gap__())\n```\n\n> > For the cypari2 -> Sage conversion, there is `sage.libs.pari.convert_sage.gen_to_sage` which is a partial but efficient converter. It introduced a slowdown in conversions PARI/GP -> Sage because the `sage` method on `cypari2.gen.Gen` (which was kept) became\n\n> \n> This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.",
    "created_at": "2021-02-04T15:59:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504733",
    "user": "https://github.com/videlec"
}
```

<div id="comment:23" align="right">Comment 23</div>

Replying to [@embray](#comment%3A21):
> Replying to [@videlec](#comment%3A17):
> > `gappy` is an excellent news!
> > 
> > I would like to bring the attention to cypari2 that played the role of gappy at the time the PARI/GP interface in Sage became an independent Cython module. In particular, if any design decision has to be made, it would be weird if they would be different for both interfaces.

> 
> Thanks for your comments Vincent.  Yes, this is definitely intended in the same vein as cypari2.
> 
> > First of all, two things that seem different from the rough description of the ticket
> > - there is no extra layer between cypari2 and Sage. Sage deals with `cypari2.gen.Gen` objects directly.
> > - cypari2 is completely agnostic to Sage and its coercion system

> 
> I think this is what I would prefer as well.

Could we try to make the direct interface work as well? I mean as far as binary operators are concerned, it should be fine to mix gappy elements with SageMath elements. If an intermediate layer is needed it could also be introduced. I think gappy is a good occasion to clean the design of the gap interface.

> > There was no need for coercion because the most basic possible happen : in any mixture, everything is converted to a cypari2 Gen object. Here with integers
> > 
> > ```
> > sage: type(1 + pari(1))
> > <class 'cypari2.gen.Gen'>
> > sage: type(pari(1) + 1)
> > <class 'cypari2.gen.Gen'>
> > ```
> > Here with matrices
> > 
> > ```
> > sage: type(pari("[1, 2; 3, 4]") + matrix(2, [1,1,1,1]))
> > <class 'cypari2.gen.Gen'>
> > sage: type(matrix(2, [1,1,1,1]) + pari("[1, 2; 3, 4]"))
> > <class 'cypari2.gen.Gen'>
> > ```

> 
> Here's the same examples using gappy directly.  The integers work:
> 
> ```
> sage: from gappy import gap
> sage: type(1 + gap(1))
> <class 'gappy.gapobj.GapInteger'>
> sage: type(gap(1) + 1)
> <class 'gappy.gapobj.GapInteger'>
> ```
> 
> but the matrices do not for some reason; I think because gappy uses a `_gap_` magic method (similarly to `__pari__`, but this conflicts with Sage's existing `_gap_` magic method for using the GAP pexpect interface).  I get:
> 
> ```
> sage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))
> AttributeError                            Traceback (most recent call last)
> <ipython-input-4-6fdcc2d39852> in <module>
> ----> 1 type(gap([[Integer(1), Integer(2)], [Integer(3), Integer(4)]]) + matrix(Integer(2), [Integer(1), Integer(1), Integer(1), Integer(1)]))
> 
> gappy/gapobj.pyx in gappy.gapobj.GapObj.__add__()
> 
> gappy/gapobj.pyx in gappy.gapobj.GapObj.parent()
> 
> gappy/core.pyx in gappy.core.Gap.__call__()
> 
> ~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._gap_ (build/cythonized/sage/structure/sage_object.c:6225)()
>     714             import sage.interfaces.gap
>     715             G = sage.interfaces.gap.gap
> --> 716         return self._interface_(G)
>     717 
>     718     def _gap_init_(self):
> 
> ~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/sage_object.pyx in sage.structure.sage_object.SageObject._interface_ (build/cythonized/sage/structure/sage_object.c:5480)()
>     678             except (KeyError, ValueError):
>     679                 pass
> --> 680         nm = I.name()
>     681         init_func = getattr(self, '_%s_init_' % nm, None)
>     682         if init_func is not None:
> 
> gappy/core.pyx in gappy.core.Gap.__getattr__()
> 
> AttributeError: no GAP global variable bound to 'name'
> ```
> 
> However, if I do this:
> 
> ```
> sage: gap = libgap.gap  # This is the gappy.Gap instance wrapped by Sage's interface                                                                                                                                                                    
> sage: gap
> <Gap(gap_root='/home/embray/src/sagemath/sage/local/share/gap')>
> sage: type(gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1]))                                                                                                                                      
> <class 'gappy.gapobj.GapList'>
> sage: gap([[1, 2], [3, 4]]) + matrix(2, [1, 1, 1, 1])                                                                                                                                            
> [ [ 2, 3 ], [ 4, 5 ] ]
> sage: type(matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]]))                                                                                                                                      
> <class 'gappy.gapobj.GapList'>
> sage: matrix(2, [1, 1, 1, 1]) + gap([[1, 2], [3, 4]])                                                                                                                                            
> [ [ 2, 3 ], [ 4, 5 ] ]
> ```
> 
> It has the necessary converters registered to handle `SageObject`s correctly.
> 
> So it looks like gappy and cypari2 are indeed mostly similar in this case.
> 
> > I do not see the difference here with the GAP interface. In what sort of construction the interaction with categories/coercion has to be handled? I would like a more concrete description if possible.

> 
> Honestly, I do not know.  I don't even understand the coercion system well-enough to say.  It's just because the old `sage.libs.gap` did use it, so I tried, for now, to keep the same interface for a couple reasons:
> 
> * Backwards compatibility--I didn't want to break the existing API too much, especially if someone is writing code that explicitly checks for Sage `GapElement`s.  I do not know if anyone is actually doing this.
> 
> * Consistency--the other Sage interfaces to other languages use the Parent/Element model so I just tried to keep that consistent.  Maybe it is not really necessary or useful though.  If someone can confirm for me that it isn't then we can use gappy more-or-less directly and do a way with a lot of extra complexity.

hmm. PARI/GP is a counterexemple to that.

One construction I can imagine where the layer could be relevant is if you want to use some gap objects as coefficients of a matrix. To do that, you would use

```
sage: MatrixSpace(GapBaseRing(), 3, 3)
```
where `GapBaseRing()` would be a GapObj modelling a ring of numbers. Then if `GapBaseRing()` is not recognized as a proper ring from SageMath such construction would be impossible. I am not sure it is currently used anywhere.

> > On a related note, cypari2 introduced the standardized name `__pari__` for the method that would provide a conversion of any object to its cypari2 equivalent. That way, any Python library could make interaction with cypari2.

Actually one could use `__gap__` (double underscore) for the gappy objects and keep the single underscore `_gap_/_libgap_` for the one with coercion layer. The double score convention is more Pythonic and, I think, prefered outside of [SageMath](../wiki/SageMath). Moreover, I believe the simple underscore could be as generic as

```
file: src/sage/structure/element.pyx

cdef class Element(SageObject):
    def _gap_(self):
        from sage.libs.gap.wrapper import GappyWrapperWithCoercion
        return GappyWrapperWithCoercion(self.__gap__())
```

> > For the cypari2 -> Sage conversion, there is `sage.libs.pari.convert_sage.gen_to_sage` which is a partial but efficient converter. It introduced a slowdown in conversions PARI/GP -> Sage because the `sage` method on `cypari2.gen.Gen` (which was kept) became

> 
> This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.



---

archive/issue_comments_504734.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nReplying to [@embray](#comment%3A22):\n> Replying to [@embray](#comment%3A21):\n> > This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.\n\n> \n> \n> Another possibility is that just as user classes can have a `_gap_` method to convert to GAP-compatible representations, gappy could add a system for registering \"GAP -> <whatever>\" converters.  They could have `.sage()` methods tacked on to them without having to make subclasses.\n\nHaving something flexible (ie runtime registration) looks like a better deal. Still what would be the main converter call? Whatever system could argue for having `GapObj.my_super_system_conversion()` in gappy. Or you wanted the `GapObj.my_super_system_conversion()` to be created at runtime?",
    "created_at": "2021-02-04T16:14:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504734",
    "user": "https://github.com/videlec"
}
```

<div id="comment:24" align="right">Comment 24</div>

Replying to [@embray](#comment%3A22):
> Replying to [@embray](#comment%3A21):
> > This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.

> 
> 
> Another possibility is that just as user classes can have a `_gap_` method to convert to GAP-compatible representations, gappy could add a system for registering "GAP -> <whatever>" converters.  They could have `.sage()` methods tacked on to them without having to make subclasses.

Having something flexible (ie runtime registration) looks like a better deal. Still what would be the main converter call? Whatever system could argue for having `GapObj.my_super_system_conversion()` in gappy. Or you wanted the `GapObj.my_super_system_conversion()` to be created at runtime?



---

archive/issue_comments_504735.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nReplying to [@videlec](#comment%3A23):\n> Actually one could use `__gap__` (double underscore) for the gappy objects and keep the single underscore `_gap_/_libgap_` for the one with coercion layer. The double score convention is more Pythonic and, I think, prefered outside of [SageMath](../wiki/SageMath).\n\nI was explicitly avoiding this for gappy since the Python documentation [discourages](https://docs.python.org/3/reference/lexical_analysis.html#reserved-classes-of-identifiers) use of custom dunder methods.  I believe we had some bikeshedding about this with `__pari__` as well, though I don't actually recall what side I fell on at that time.\n\nOn the other hand, it would be nice and consistent with `__pari__`, and it seems pretty unlikely that Python will use the name `__gap__` for anything any time soon (though stranger things have happened).  Numpy also has a long history of using custom dunder methods, though it prefixes most of them with `__numpy_`.\n\nWill respond to the rest of the comment later.",
    "created_at": "2021-02-04T16:23:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504735",
    "user": "https://github.com/embray"
}
```

<div id="comment:25" align="right">Comment 25</div>

Replying to [@videlec](#comment%3A23):
> Actually one could use `__gap__` (double underscore) for the gappy objects and keep the single underscore `_gap_/_libgap_` for the one with coercion layer. The double score convention is more Pythonic and, I think, prefered outside of [SageMath](../wiki/SageMath).

I was explicitly avoiding this for gappy since the Python documentation [discourages](https://docs.python.org/3/reference/lexical_analysis.html#reserved-classes-of-identifiers) use of custom dunder methods.  I believe we had some bikeshedding about this with `__pari__` as well, though I don't actually recall what side I fell on at that time.

On the other hand, it would be nice and consistent with `__pari__`, and it seems pretty unlikely that Python will use the name `__gap__` for anything any time soon (though stranger things have happened).  Numpy also has a long history of using custom dunder methods, though it prefixes most of them with `__numpy_`.

Will respond to the rest of the comment later.



---

archive/issue_comments_504736.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nReplying to [@videlec](#comment%3A24):\n> Replying to [@embray](#comment%3A22):\n> > Replying to [@embray](#comment%3A21):\n> > > This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.\n\n> > \n> > \n> > Another possibility is that just as user classes can have a `_gap_` method to convert to GAP-compatible representations, gappy could add a system for registering \"GAP -> <whatever>\" converters.  They could have `.sage()` methods tacked on to them without having to make subclasses.\n\n> \n> Having something flexible (ie runtime registration) looks like a better deal. Still what would be the main converter call? Whatever system could argue for having `GapObj.my_super_system_conversion()` in gappy. Or you wanted the `GapObj.my_super_system_conversion()` to be created at runtime?\n\n\nThe new version I just pushed shows some examples of how it works: https://gappy.readthedocs.io/en/latest/api.html#gappy.gapobj.GapObj.convert_to\n\nSee in particular the example of\n\n```\n@GapList.convert_to('numpy')\n```\n\nwhich registers a converter from `GapList` to Numpy arrays.  Same could be done for `GapFoo.convert_to('sage')`.",
    "created_at": "2021-02-04T17:50:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504736",
    "user": "https://github.com/embray"
}
```

<div id="comment:26" align="right">Comment 26</div>

Replying to [@videlec](#comment%3A24):
> Replying to [@embray](#comment%3A22):
> > Replying to [@embray](#comment%3A21):
> > > This is one area where I think it's still useful to have wrapper classes in Sage; which is just to add a `.sage()` methods to gappy `GapObj`s.  But if they don't have to be `Element` subclasses, then they can simply subclass `GapObj` rather than wrap them.

> > 
> > 
> > Another possibility is that just as user classes can have a `_gap_` method to convert to GAP-compatible representations, gappy could add a system for registering "GAP -> <whatever>" converters.  They could have `.sage()` methods tacked on to them without having to make subclasses.

> 
> Having something flexible (ie runtime registration) looks like a better deal. Still what would be the main converter call? Whatever system could argue for having `GapObj.my_super_system_conversion()` in gappy. Or you wanted the `GapObj.my_super_system_conversion()` to be created at runtime?


The new version I just pushed shows some examples of how it works: https://gappy.readthedocs.io/en/latest/api.html#gappy.gapobj.GapObj.convert_to

See in particular the example of

```
@GapList.convert_to('numpy')
```

which registers a converter from `GapList` to Numpy arrays.  Same could be done for `GapFoo.convert_to('sage')`.



---

archive/issue_comments_504737.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nOne simple example which no longer works without the coercion model is:\n\n```\nsage: from gappy import gap                                                                                                                                                                      \nsage: one = gap(1)                                                                                                                                                                               \nsage: type(one)                                                                                                                                                                                  \n<class 'gappy.gapobj.GapInteger'>\nsage: Integer(one)                                                                                                                                                                               \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-4-1860a9d72d2d> in <module>\n----> 1 Integer(one)\n\n~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:7078)()\n    745                     return\n    746 \n--> 747                 raise TypeError(\"unable to coerce %s to an integer\" % type(x))\n    748 \n    749     def __reduce__(self):\n\nTypeError: unable to coerce <class 'gappy.gapobj.GapInteger'> to an integer\n```\n\nI'm sure this has an easy solution but I don't know what the best approach would be.",
    "created_at": "2021-02-04T19:18:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504737",
    "user": "https://github.com/embray"
}
```

<div id="comment:27" align="right">Comment 27</div>

One simple example which no longer works without the coercion model is:

```
sage: from gappy import gap                                                                                                                                                                      
sage: one = gap(1)                                                                                                                                                                               
sage: type(one)                                                                                                                                                                                  
<class 'gappy.gapobj.GapInteger'>
sage: Integer(one)                                                                                                                                                                               
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-4-1860a9d72d2d> in <module>
----> 1 Integer(one)

~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:7078)()
    745                     return
    746 
--> 747                 raise TypeError("unable to coerce %s to an integer" % type(x))
    748 
    749     def __reduce__(self):

TypeError: unable to coerce <class 'gappy.gapobj.GapInteger'> to an integer
```

I'm sure this has an easy solution but I don't know what the best approach would be.



---

archive/issue_comments_504738.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">Comment 28</div>\n\nReplying to [@embray](#comment%3A27):\n> One simple example which no longer works without the coercion model is:\n> \n> ```\n> sage: from gappy import gap                                                                                                                                                                      \n> sage: one = gap(1)                                                                                                                                                                               \n> sage: type(one)                                                                                                                                                                                  \n> <class 'gappy.gapobj.GapInteger'>\n> sage: Integer(one)                                                                                                                                                                               \n> ---------------------------------------------------------------------------\n> TypeError                                 Traceback (most recent call last)\n> <ipython-input-4-1860a9d72d2d> in <module>\n> ----> 1 Integer(one)\n> \n> ~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:7078)()\n>     745                     return\n>     746 \n> --> 747                 raise TypeError(\"unable to coerce %s to an integer\" % type(x))\n>     748 \n>     749     def __reduce__(self):\n> \n> TypeError: unable to coerce <class 'gappy.gapobj.GapInteger'> to an integer\n> ```\n> \n> I'm sure this has an easy solution but I don't know what the best approach would be.\n\nInteger constructor has a special case for cypari2\n\n```\nfile: src/sage/rings/integer.pyx\ncdef class Integer(Element):\n    def __init__(self, x):\n        ...\n        elif isinstance(x, pari_gen):\n            set_from_pari_gen(self, x)\n```\nThis is the general approach taken by cypari2. Though, maybe it is not desirable to clutter the sage element constructors.",
    "created_at": "2021-02-05T07:36:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504738",
    "user": "https://github.com/videlec"
}
```

<div id="comment:28" align="right">Comment 28</div>

Replying to [@embray](#comment%3A27):
> One simple example which no longer works without the coercion model is:
> 
> ```
> sage: from gappy import gap                                                                                                                                                                      
> sage: one = gap(1)                                                                                                                                                                               
> sage: type(one)                                                                                                                                                                                  
> <class 'gappy.gapobj.GapInteger'>
> sage: Integer(one)                                                                                                                                                                               
> ---------------------------------------------------------------------------
> TypeError                                 Traceback (most recent call last)
> <ipython-input-4-1860a9d72d2d> in <module>
> ----> 1 Integer(one)
> 
> ~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:7078)()
>     745                     return
>     746 
> --> 747                 raise TypeError("unable to coerce %s to an integer" % type(x))
>     748 
>     749     def __reduce__(self):
> 
> TypeError: unable to coerce <class 'gappy.gapobj.GapInteger'> to an integer
> ```
> 
> I'm sure this has an easy solution but I don't know what the best approach would be.

Integer constructor has a special case for cypari2

```
file: src/sage/rings/integer.pyx
cdef class Integer(Element):
    def __init__(self, x):
        ...
        elif isinstance(x, pari_gen):
            set_from_pari_gen(self, x)
```
This is the general approach taken by cypari2. Though, maybe it is not desirable to clutter the sage element constructors.



---

archive/issue_comments_504739.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nMaybe just as there is `__pari__` and `__gap__` we should develop a standard for a `__sage__` magic method that Sage can call on objects from other libraries in order to get their equivalent representation as a Sage type.\n\nFor now I could add a special case in the Integer constructor but I agree it's not ideal.  I noticed it's also the case in the permutation element \n\n```\ncdef class PermutationGroupElement(MultiplicativeGroupElement):\n    ...\n    def __init__(self, g, parent, check=True):\n        ...\n        elif isinstance(g, GapElement):\n            if isinstance(g, GapElement_Permutation):\n                self._set_libgap(g.obj)\n            elif isinstance(g, GapElement_String):\n                self._set_string(g.sage())\n            elif isinstance(g, GapElement_List):\n                self._set_list_images(g.sage(), convert)\n            else:\n                raise ValueError(\"invalid data to initialize a permutation\")\n        ...\n```\n\nSo, nothing very \"magic\" going on...",
    "created_at": "2021-02-05T11:35:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504739",
    "user": "https://github.com/embray"
}
```

<div id="comment:29" align="right">Comment 29</div>

Maybe just as there is `__pari__` and `__gap__` we should develop a standard for a `__sage__` magic method that Sage can call on objects from other libraries in order to get their equivalent representation as a Sage type.

For now I could add a special case in the Integer constructor but I agree it's not ideal.  I noticed it's also the case in the permutation element 

```
cdef class PermutationGroupElement(MultiplicativeGroupElement):
    ...
    def __init__(self, g, parent, check=True):
        ...
        elif isinstance(g, GapElement):
            if isinstance(g, GapElement_Permutation):
                self._set_libgap(g.obj)
            elif isinstance(g, GapElement_String):
                self._set_string(g.sage())
            elif isinstance(g, GapElement_List):
                self._set_list_images(g.sage(), convert)
            else:
                raise ValueError("invalid data to initialize a permutation")
        ...
```

So, nothing very "magic" going on...



---

archive/issue_comments_504740.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nJust for the record, another idea I considered is providing an interface to gappy to allow it to replace the base class for objects returned by it, sort of like how Sage Parents have an Element attribute, it would be possible to subclass `gappy.Gap` and provide a different base class.  This would also have a mechanism for instantiating the correct subclass of the base class (e.g. `GapPermutation` or `GapElement_Permutation`).\n\nHowever, I don't know that this has much of a use case outside of Sage.  For now I'm working on a more disruptive approach inspired by the cypari2 conversion to just use gappy more directly and do away with `GapElement`.",
    "created_at": "2021-02-05T15:29:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504740",
    "user": "https://github.com/embray"
}
```

<div id="comment:30" align="right">Comment 30</div>

Just for the record, another idea I considered is providing an interface to gappy to allow it to replace the base class for objects returned by it, sort of like how Sage Parents have an Element attribute, it would be possible to subclass `gappy.Gap` and provide a different base class.  This would also have a mechanism for instantiating the correct subclass of the base class (e.g. `GapPermutation` or `GapElement_Permutation`).

However, I don't know that this has much of a use case outside of Sage.  For now I'm working on a more disruptive approach inspired by the cypari2 conversion to just use gappy more directly and do away with `GapElement`.



---

archive/issue_comments_504741.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c9160c10e033565c1e2b538cb55f89f4c518ae72\">c9160c1</a></td><td><code>Further rework of 45b175e43621795f890204a9cdfb30b524f961fa which</code></td></tr></table>\n",
    "created_at": "2021-02-05T16:52:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504741",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:31" align="right">Comment 31</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c9160c10e033565c1e2b538cb55f89f4c518ae72">c9160c1</a></td><td><code>Further rework of 45b175e43621795f890204a9cdfb30b524f961fa which</code></td></tr></table>




---

archive/issue_comments_504742.json:
```json
{
    "body": "Changed commit from **[a07f20e](https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1)** to **[c9160c1](https://github.com/sagemath/sagetrac-mirror/commit/c9160c10e033565c1e2b538cb55f89f4c518ae72)**",
    "created_at": "2021-02-05T16:52:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504742",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[a07f20e](https://github.com/sagemath/sagetrac-mirror/commit/a07f20ecee90d82914116e45b31e58b93d0e3ca1)** to **[c9160c1](https://github.com/sagemath/sagetrac-mirror/commit/c9160c10e033565c1e2b538cb55f89f4c518ae72)**



---

archive/issue_comments_504743.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">Comment 32</div>\n\nReplying to [@embray](#comment%3A29):\n> For now I could add a special case in the Integer constructor but I agree it's not ideal. \n\nJust a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.",
    "created_at": "2021-02-05T18:54:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504743",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">Comment 32</div>

Replying to [@embray](#comment%3A29):
> For now I could add a special case in the Integer constructor but I agree it's not ideal. 

Just a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.



---

archive/issue_comments_504744.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">Comment 33</div>\n\nReplying to [@mkoeppe](#comment%3A32):\n> Replying to [@embray](#comment%3A29):\n> > For now I could add a special case in the Integer constructor but I agree it's not ideal. \n\n> \n> Just a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.\n\nGood point. The remark applies equally to gappy and cypari2 (and possibly other libraries).\n\nIn the same vein that Erik proposed in [comment:26] we could introduce a way to register conversions to Sage so that `ZZ(my_cypari2_object)` (construction from the parent) works. One would then drop the support for `Integer(my_cypari2_object)` (construction from the element class). There will be some time penalty in doing this. But fast conversion functions would remain available in `sage.libs.pari`.\n\nOn the other hand, `Integer` does implement a `__pari__` method for conversion to cypari2. That should be changed at the same time.",
    "created_at": "2021-02-06T10:40:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504744",
    "user": "https://github.com/videlec"
}
```

<div id="comment:33" align="right">Comment 33</div>

Replying to [@mkoeppe](#comment%3A32):
> Replying to [@embray](#comment%3A29):
> > For now I could add a special case in the Integer constructor but I agree it's not ideal. 

> 
> Just a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.

Good point. The remark applies equally to gappy and cypari2 (and possibly other libraries).

In the same vein that Erik proposed in [comment:26] we could introduce a way to register conversions to Sage so that `ZZ(my_cypari2_object)` (construction from the parent) works. One would then drop the support for `Integer(my_cypari2_object)` (construction from the element class). There will be some time penalty in doing this. But fast conversion functions would remain available in `sage.libs.pari`.

On the other hand, `Integer` does implement a `__pari__` method for conversion to cypari2. That should be changed at the same time.



---

archive/issue_comments_504745.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">Comment 34</div>\n\nReplying to [@videlec](#comment%3A33):\n> Replying to [@mkoeppe](#comment%3A32):\n> > Replying to [@embray](#comment%3A29):\n> > > For now I could add a special case in the Integer constructor but I agree it's not ideal. \n\n> > \n> > Just a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.\n\n> \n> Good point. The remark applies equally to gappy and cypari2 (and possibly other libraries).\n> \n> In the same vein that Erik proposed in [comment:26] we could introduce a way to register conversions to Sage so that `ZZ(my_cypari2_object)` (construction from the parent) works. One would then drop the support for `Integer(my_cypari2_object)` (construction from the element class). There will be some time penalty in doing this. But fast conversion functions would remain available in `sage.libs.pari`.\n> \n> On the other hand, `Integer` does implement a `__pari__` method for conversion to cypari2. That should be changed at the same time.\n\nBeyond conversions, many methods of `Integer` depend exlicitely on `__pari__`\n- `perfect_power`\n- `is_prime_power`\n- `is_prime`\n- `next_probable_prime`\n- `next_prime`\n- `previous_prime`\n- etc\nGiven that, I don't see how we could make `Integer` independent of cypari2 without removing most of it functionalities.",
    "created_at": "2021-02-06T10:46:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504745",
    "user": "https://github.com/videlec"
}
```

<div id="comment:34" align="right">Comment 34</div>

Replying to [@videlec](#comment%3A33):
> Replying to [@mkoeppe](#comment%3A32):
> > Replying to [@embray](#comment%3A29):
> > > For now I could add a special case in the Integer constructor but I agree it's not ideal. 

> > 
> > Just a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.

> 
> Good point. The remark applies equally to gappy and cypari2 (and possibly other libraries).
> 
> In the same vein that Erik proposed in [comment:26] we could introduce a way to register conversions to Sage so that `ZZ(my_cypari2_object)` (construction from the parent) works. One would then drop the support for `Integer(my_cypari2_object)` (construction from the element class). There will be some time penalty in doing this. But fast conversion functions would remain available in `sage.libs.pari`.
> 
> On the other hand, `Integer` does implement a `__pari__` method for conversion to cypari2. That should be changed at the same time.

Beyond conversions, many methods of `Integer` depend exlicitely on `__pari__`
- `perfect_power`
- `is_prime_power`
- `is_prime`
- `next_probable_prime`
- `next_prime`
- `previous_prime`
- etc
Given that, I don't see how we could make `Integer` independent of cypari2 without removing most of it functionalities.



---

archive/issue_comments_504746.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">Comment 35</div>\n\nThese are just Python methods, not `cdef`'s, right?\nI think they can just be patched into the class in the same way that https://pypi.org/project/recursive-monkey-patch/ does\n\nCrucial for the modularization is really just that the compiled Cython module no longer has such compile-time dependencies.",
    "created_at": "2021-02-06T17:34:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504746",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:35" align="right">Comment 35</div>

These are just Python methods, not `cdef`'s, right?
I think they can just be patched into the class in the same way that https://pypi.org/project/recursive-monkey-patch/ does

Crucial for the modularization is really just that the compiled Cython module no longer has such compile-time dependencies.



---

archive/issue_comments_504747.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">Comment 36</div>\n\nReplying to [@mkoeppe](#comment%3A35):\n> These are just Python methods, not `cdef`'s, right?\n> I think they can just be patched into the class in the same way that https://pypi.org/project/recursive-monkey-patch/ does\n> \n> Crucial for the modularization is really just that the compiled Cython module no longer has such compile-time dependencies.\n> \n\nNot really. `Integer` is an extension class, hence not extensible by any mean.",
    "created_at": "2021-02-06T18:03:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504747",
    "user": "https://github.com/videlec"
}
```

<div id="comment:36" align="right">Comment 36</div>

Replying to [@mkoeppe](#comment%3A35):
> These are just Python methods, not `cdef`'s, right?
> I think they can just be patched into the class in the same way that https://pypi.org/project/recursive-monkey-patch/ does
> 
> Crucial for the modularization is really just that the compiled Cython module no longer has such compile-time dependencies.
> 

Not really. `Integer` is an extension class, hence not extensible by any mean.



---

archive/issue_comments_504748.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">Comment 37</div>\n\nThanks, you are right, of course.",
    "created_at": "2021-02-06T18:15:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504748",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:37" align="right">Comment 37</div>

Thanks, you are right, of course.



---

archive/issue_comments_504749.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">Comment 38</div>\n\nOn the other hand `Element.__getattribute__` already dispatches fairly dynamically via `getattr_from_category`, so...",
    "created_at": "2021-02-06T18:21:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504749",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">Comment 38</div>

On the other hand `Element.__getattribute__` already dispatches fairly dynamically via `getattr_from_category`, so...



---

archive/issue_comments_504750.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">Comment 39</div>\n\nReplying to [@mkoeppe](#comment%3A38):\n> On the other hand `Element.__getattribute__` already dispatches fairly dynamically via `getattr_from_category`, so...\n\nThe problem with that is it is relatively slow IIRC. It might be better to have a Python subclass of `Integer` that can be monkey patched.",
    "created_at": "2021-02-07T22:33:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504750",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:39" align="right">Comment 39</div>

Replying to [@mkoeppe](#comment%3A38):
> On the other hand `Element.__getattribute__` already dispatches fairly dynamically via `getattr_from_category`, so...

The problem with that is it is relatively slow IIRC. It might be better to have a Python subclass of `Integer` that can be monkey patched.



---

archive/issue_comments_504751.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">Comment 40</div>\n\nReplying to [@mkoeppe](#comment%3A32):\n> Replying to [@embray](#comment%3A29):\n> > For now I could add a special case in the Integer constructor but I agree it's not ideal. \n\n> \n> Just a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.\n\nI wonder if a minimal Integer base type wouldn't also be helpful here.  Again all we need are base classes that have the same struct layout, and maybe a minimum of methods defined.",
    "created_at": "2021-02-08T09:41:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504751",
    "user": "https://github.com/embray"
}
```

<div id="comment:40" align="right">Comment 40</div>

Replying to [@mkoeppe](#comment%3A32):
> Replying to [@embray](#comment%3A29):
> > For now I could add a special case in the Integer constructor but I agree it's not ideal. 

> 
> Just a quick note that the compile-time dependency of `sage.rings.integer` on various libraries will be a major obstacle to modularization (#29705), see #30022.  This will become relevant later (perhaps in the Sage 9.5 cycle according to current plans), but it won't block immediate development, so I have no objections.

I wonder if a minimal Integer base type wouldn't also be helpful here.  Again all we need are base classes that have the same struct layout, and maybe a minimum of methods defined.



---

archive/issue_comments_504752.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">Comment 41</div>\n\nReplying to [@videlec](#comment%3A36):\n> Replying to [@mkoeppe](#comment%3A35):\n> > These are just Python methods, not `cdef`'s, right?\n> > I think they can just be patched into the class in the same way that https://pypi.org/project/recursive-monkey-patch/ does\n> > \n> > Crucial for the modularization is really just that the compiled Cython module no longer has such compile-time dependencies.\n> > \n\n> \n> Not really. `Integer` is an extension class, hence not extensible by any mean.\n\nNo, but a plain Python subclass of it is.",
    "created_at": "2021-02-08T09:43:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504752",
    "user": "https://github.com/embray"
}
```

<div id="comment:41" align="right">Comment 41</div>

Replying to [@videlec](#comment%3A36):
> Replying to [@mkoeppe](#comment%3A35):
> > These are just Python methods, not `cdef`'s, right?
> > I think they can just be patched into the class in the same way that https://pypi.org/project/recursive-monkey-patch/ does
> > 
> > Crucial for the modularization is really just that the compiled Cython module no longer has such compile-time dependencies.
> > 

> 
> Not really. `Integer` is an extension class, hence not extensible by any mean.

No, but a plain Python subclass of it is.



---

archive/issue_comments_504753.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">Comment 42</div>\n\nAnother important example that doesn't work without coercion support which did before is evaluation of polynomials on GAP objects:\n\n```\nsage: from gappy import gap\nsage: R.<x> = PolynomialRing(ZZ)                                                                                                                                                                 \nsage: x = R.gen()                                                                                                                                                                                \nsage: x(gap(1))                                                                                                                                                                               \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-20-815f7921111e> in <module>\n----> 1 x(libgap(Integer(1)))\n\n~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_integer_dense_flint.pyx in sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint.__call__ (build/cythonized/sage/rings/polynomial/polynomial_integer_dense_flint.cpp:7957)()\n    463                 return acb_z\n    464 \n--> 465         return Polynomial.__call__(self, *x, **kwds)\n    466 \n    467     cpdef Integer content(self):\n\n~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.__call__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:9488)()\n    775         # polynomial's base ring (e.g., for evaluations at integers).\n    776         if not have_same_parent(a, cst):\n--> 777             cst, aa = coercion_model.canonical_coercion(cst, a)\n    778             # Use fast multiplication actions like matrix \u00d7 scalar.\n    779             # If there is no action, replace a by an element of the\n\n~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.canonical_coercion (build/cythonized/sage/structure/coerce.c:13758)()\n   1393                 self._record_exception()\n   1394 \n-> 1395         raise TypeError(\"no common canonical parent for objects with parents: '%s' and '%s'\"%(xp, yp))\n   1396 \n   1397 \n\nTypeError: no common canonical parent for objects with parents: 'Integer Ring' and '<class 'gappy.gapobj.GapInteger'>'\n```\n\nThis doesn't work with PARI gens either unless you convert the polynomial to PARI explicitly first.",
    "created_at": "2021-02-08T10:04:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504753",
    "user": "https://github.com/embray"
}
```

<div id="comment:42" align="right">Comment 42</div>

Another important example that doesn't work without coercion support which did before is evaluation of polynomials on GAP objects:

```
sage: from gappy import gap
sage: R.<x> = PolynomialRing(ZZ)                                                                                                                                                                 
sage: x = R.gen()                                                                                                                                                                                
sage: x(gap(1))                                                                                                                                                                               
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-20-815f7921111e> in <module>
----> 1 x(libgap(Integer(1)))

~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_integer_dense_flint.pyx in sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint.__call__ (build/cythonized/sage/rings/polynomial/polynomial_integer_dense_flint.cpp:7957)()
    463                 return acb_z
    464 
--> 465         return Polynomial.__call__(self, *x, **kwds)
    466 
    467     cpdef Integer content(self):

~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.__call__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:9488)()
    775         # polynomial's base ring (e.g., for evaluations at integers).
    776         if not have_same_parent(a, cst):
--> 777             cst, aa = coercion_model.canonical_coercion(cst, a)
    778             # Use fast multiplication actions like matrix  scalar.
    779             # If there is no action, replace a by an element of the

~/src/sagemath/sage/local/lib/python3.6/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.canonical_coercion (build/cythonized/sage/structure/coerce.c:13758)()
   1393                 self._record_exception()
   1394 
-> 1395         raise TypeError("no common canonical parent for objects with parents: '%s' and '%s'"%(xp, yp))
   1396 
   1397 

TypeError: no common canonical parent for objects with parents: 'Integer Ring' and '<class 'gappy.gapobj.GapInteger'>'
```

This doesn't work with PARI gens either unless you convert the polynomial to PARI explicitly first.



---

archive/issue_comments_504754.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">Comment 43</div>\n\nTIL: The coercion model does in fact already support a `_sage_` magic method, though it wasn't so easy for me to find: https://doc.sagemath.org/html/en/reference/coercion/sage/structure/coerce.html?highlight=_sage_#sage.structure.coerce.CoercionModel.canonical_coercion\n\nAdding this to `GapObj` makes it work:\n\n```\nsage: one = libgap(1)                                                                                                                                                                            \nsage: one._sage_()                                                                                                                                                                               \n1\nsage: R.<x> = PolynomialRing(ZZ)                                                                                                                                                                 \nsage: x = R.gen()                                                                                                                                                                                \nsage: x(one)                                                                                                                                                                                     \n1\nsage: a, b = coercion_model.canonical_coercion(one, x)                                                                                                                                           \nsage: type(a)                                                                                                                                                                                    \n<class 'sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint'>\nsage: type(b)                                                                                                                                                                                    \n<class 'sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint'>\n```\n\nI wonder why pari_gen doesn't support this too.",
    "created_at": "2021-02-08T11:01:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504754",
    "user": "https://github.com/embray"
}
```

<div id="comment:43" align="right">Comment 43</div>

TIL: The coercion model does in fact already support a `_sage_` magic method, though it wasn't so easy for me to find: https://doc.sagemath.org/html/en/reference/coercion/sage/structure/coerce.html?highlight=_sage_#sage.structure.coerce.CoercionModel.canonical_coercion

Adding this to `GapObj` makes it work:

```
sage: one = libgap(1)                                                                                                                                                                            
sage: one._sage_()                                                                                                                                                                               
1
sage: R.<x> = PolynomialRing(ZZ)                                                                                                                                                                 
sage: x = R.gen()                                                                                                                                                                                
sage: x(one)                                                                                                                                                                                     
1
sage: a, b = coercion_model.canonical_coercion(one, x)                                                                                                                                           
sage: type(a)                                                                                                                                                                                    
<class 'sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint'>
sage: type(b)                                                                                                                                                                                    
<class 'sage.rings.polynomial.polynomial_integer_dense_flint.Polynomial_integer_dense_flint'>
```

I wonder why pari_gen doesn't support this too.



---

archive/issue_comments_504755.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">Comment 44</div>\n\nHrm, the problem with the above example though is that with `GapElement` the result of evaluating a polynomial on a `GapElement` is another `GapElement`, whereas here it just converts it to the appropriate Sage type and evaluates the polynomial on that.",
    "created_at": "2021-02-08T12:04:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504755",
    "user": "https://github.com/embray"
}
```

<div id="comment:44" align="right">Comment 44</div>

Hrm, the problem with the above example though is that with `GapElement` the result of evaluating a polynomial on a `GapElement` is another `GapElement`, whereas here it just converts it to the appropriate Sage type and evaluates the polynomial on that.



---

archive/issue_comments_504756.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">Comment 45</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ae791e6a1335d065d28448a80d072c26c257747\">0ae791e</a></td><td><code>Update gappy to v0.1.3a3 with the requisite changes needed to adapt to</code></td></tr></table>\n",
    "created_at": "2021-02-15T18:29:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504756",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:45" align="right">Comment 45</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ae791e6a1335d065d28448a80d072c26c257747">0ae791e</a></td><td><code>Update gappy to v0.1.3a3 with the requisite changes needed to adapt to</code></td></tr></table>




---

archive/issue_comments_504757.json:
```json
{
    "body": "Changed commit from **[c9160c1](https://github.com/sagemath/sagetrac-mirror/commit/c9160c10e033565c1e2b538cb55f89f4c518ae72)** to **[0ae791e](https://github.com/sagemath/sagetrac-mirror/commit/0ae791e6a1335d065d28448a80d072c26c257747)**",
    "created_at": "2021-02-15T18:29:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504757",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[c9160c1](https://github.com/sagemath/sagetrac-mirror/commit/c9160c10e033565c1e2b538cb55f89f4c518ae72)** to **[0ae791e](https://github.com/sagemath/sagetrac-mirror/commit/0ae791e6a1335d065d28448a80d072c26c257747)**



---

archive/issue_comments_504758.json:
```json
{
    "body": "Changed commit from **[0ae791e](https://github.com/sagemath/sagetrac-mirror/commit/0ae791e6a1335d065d28448a80d072c26c257747)** to **[82e7e56](https://github.com/sagemath/sagetrac-mirror/commit/82e7e56cdea9b8d24a3465f9661189288f54cc26)**",
    "created_at": "2021-02-16T12:01:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504758",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[0ae791e](https://github.com/sagemath/sagetrac-mirror/commit/0ae791e6a1335d065d28448a80d072c26c257747)** to **[82e7e56](https://github.com/sagemath/sagetrac-mirror/commit/82e7e56cdea9b8d24a3465f9661189288f54cc26)**



---

archive/issue_comments_504759.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">Comment 46</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/82e7e56cdea9b8d24a3465f9661189288f54cc26\">82e7e56</a></td><td><code>A few minor test fixes:</code></td></tr></table>\n",
    "created_at": "2021-02-16T12:01:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504759",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:46" align="right">Comment 46</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/82e7e56cdea9b8d24a3465f9661189288f54cc26">82e7e56</a></td><td><code>A few minor test fixes:</code></td></tr></table>




---

archive/issue_comments_504760.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n+**Update:** The successor to this ticket is #31404 which offers a different approach by using gappy directly in Sage rather than providing Sage-specific wrappers.  I think it is overall a better approach for now.\n+\n Package tarball: see `checksums.ini`; use `./configure --enable-download-from-upstream-url` to test.\n \n [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public \"libgap\" API (to the extent possible).\n``````\n",
    "created_at": "2021-03-02T13:15:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504760",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
+**Update:** The successor to this ticket is #31404 which offers a different approach by using gappy directly in Sage rather than providing Sage-specific wrappers.  I think it is overall a better approach for now.
+
 Package tarball: see `checksums.ini`; use `./configure --enable-download-from-upstream-url` to test.
 
 [gappy](https://github.com/embray/gappy) is a new !Python/Cython package providing a Python interface to GAP using its public "libgap" API (to the extent possible).
``````




---

archive/issue_events_413134.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-02T16:09:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413134"
}
```



---

archive/issue_events_413135.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-02T16:09:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413135"
}
```



---

archive/issue_events_413136.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-02T16:09:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413136"
}
```



---

archive/issue_events_413137.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-03-24T10:49:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413137"
}
```



---

archive/issue_events_413138.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-03-24T10:49:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413138"
}
```



---

archive/issue_comments_504761.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-03-24T10:49:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504761",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_504762.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">Comment 49</div>\n\nlet's do this the other way: #31404",
    "created_at": "2021-03-24T10:49:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31297#issuecomment-504762",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:49" align="right">Comment 49</div>

let's do this the other way: #31404



---

archive/issue_events_413139.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-03-29T08:14:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413139"
}
```



---

archive/issue_events_413140.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-03-29T08:14:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413140"
}
```



---

archive/issue_events_413141.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-03-29T08:14:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31297",
    "label": "https://github.com/sagemath/sage/labels/wontfix",
    "label_color": "a6a6a6",
    "label_name": "wontfix",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31297#event-413141"
}
```
