# Issue 31944: Minimal Periodic/Preperiodic Scheme

archive/issues_031707.json:
```json
{
    "body": "Currently, attempting to use periodic points or preperiodic points to compute the scheme defining the minimal periodic or preperiodic points throws a Not Implemented error. We implement this functionality.\n\nWe also add a formal parameter to the periodic and preperiodic functions to facilitate the computation of the formal periodic or formal preperiodic points.\n\nCC:  @bhutz\n\nKeywords: gsoc2021\n\nReviewer: Ben Hutz\n\nAuthor: Alexander Galarraga\n\nBranch: 6f2857f21394f0c242f9180f57f45ac565b618ed\n\nDependencies: #31954, #31906, #32166\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31944\n\n",
    "closed_at": "2021-07-25T18:51:50Z",
    "created_at": "2021-06-09T18:38:26Z",
    "labels": [
        "component: dynamics",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Minimal Periodic/Preperiodic Scheme",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31944",
    "user": "https://github.com/EnderWannabe"
}
```
Currently, attempting to use periodic points or preperiodic points to compute the scheme defining the minimal periodic or preperiodic points throws a Not Implemented error. We implement this functionality.

We also add a formal parameter to the periodic and preperiodic functions to facilitate the computation of the formal periodic or formal preperiodic points.

CC:  @bhutz

Keywords: gsoc2021

Reviewer: Ben Hutz

Author: Alexander Galarraga

Branch: 6f2857f21394f0c242f9180f57f45ac565b618ed

Dependencies: #31954, #31906, #32166

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31944





---

archive/issue_comments_483632.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-11T18:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483632",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483633.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-15T17:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483633",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483634.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-15T17:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483634",
    "user": "https://github.com/EnderWannabe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_483635.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-06-22T18:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483635",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_483636.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-24T14:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483636",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_483637.json:
```json
{
    "body": "<a id='comment:7'></a>All my versions of sage are compiling, so this is a code review only without functionality testing. It looks like there will be issues with subschemes.\n\n- formal and dimension 1 are missing the subscheme equations in X\n\n- f_deformed: this is now defined over projective space rather than the subscheme. So the X you eventually get does not include the defining equations of the subscheme. \n\n- This line is perhaps worth a comment\n\n```\nIdeal = f_deformed.preperiodic_points(m, n, return_scheme=True).defining_ideal()\n```\nthat minimal=True and Formal=False does in fact get the formal periodic points for the deformed map (since all (relevant) multiplicities are 1).\n\n- Don't capitalize the variable Ideal\n\n\n- The same comments about subscheme issues for periodic points version.\n\n\n- 31906 is included by not listed as a dependency. This doesn't really seem to be a dependency.",
    "created_at": "2021-06-24T14:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483637",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:7'></a>All my versions of sage are compiling, so this is a code review only without functionality testing. It looks like there will be issues with subschemes.

- formal and dimension 1 are missing the subscheme equations in X

- f_deformed: this is now defined over projective space rather than the subscheme. So the X you eventually get does not include the defining equations of the subscheme. 

- This line is perhaps worth a comment

```
Ideal = f_deformed.preperiodic_points(m, n, return_scheme=True).defining_ideal()
```
that minimal=True and Formal=False does in fact get the formal periodic points for the deformed map (since all (relevant) multiplicities are 1).

- Don't capitalize the variable Ideal


- The same comments about subscheme issues for periodic points version.


- 31906 is included by not listed as a dependency. This doesn't really seem to be a dependency.



---

archive/issue_comments_483638.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-24T16:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483638",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483639.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-24T16:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483639",
    "user": "https://github.com/EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_483640.json:
```json
{
    "body": "<a id='comment:10'></a>I feel like I'm starting to repeat the same errors over and over again, so here is what I have so far.\n\n- A non-minimal point appears\n\n```\nP.<x,y,z>=ProjectiveSpace(QQ,2)\nf=DynamicalSystem([x^2-z^2,y^2-21/16*z^2,z^2])\nfor Q in f.preperiodic_points(1,2,minimal=True,formal=False):\n    print(Q, Q.is_preperiodic(f,return_period=True))\n```\n\n- line 4221: perhaps add the same comment as on 3897 as this looks redundant at first glance\n\n```\nR = f.base_ring()\n```\n\n- KeyError\n\n```\nP.<x,y>=ProjectiveSpace(QQ,1)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-1*y^2,y^2],domain=X)\nF.periodic_points(2,formal=True)\n```\n\n- This is wrong:\n\n```\nP.<x,y>=ProjectiveSpace(QQ,1)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-3/4*y^2,y^2],domain=X)\nF.periodic_points(2,minimal=True,formal=False,return_scheme=True)\n```\n\nAlso wrong\n\n```\nP.<x,y,z>=ProjectiveSpace(QQ,2)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2+3/4*y^2,y^2,z^2],X)\nF.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()\n```\n\nAlso wrong:\n\n```\nP.<x,y,z>=ProjectiveSpace(GF(3),2)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)\nF.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()\n```\n\n- TypeError\n\n```\nP.<x,y,z>=ProjectiveSpace(GF(3),2)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],X)\nF.periodic_points(1,minimal=True,formal=True,return_scheme=True).rational_points()\n```\n\n- This gives a TypeError, perhaps catch the good fields and give a more informative error message\n\n```\nP.<x,y,z>=ProjectiveSpace(RR,2)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)\nF.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()\n```\n\n- Shouldn't this work?\n\n```\nR.<c>=QQ[]\nP.<x,y,z>=ProjectiveSpace(FractionField(R),2)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)\nF.periodic_points(2,minimal=True,formal=False,return_scheme=True)\n```\n\n- Why is there no 'c' in this?\n\n```\nR.<c>=QQ[]\nP.<x,y,z>=ProjectiveSpace(FractionField(R),2)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-c*y^2,y^2,z^2],domain=X)\nF.periodic_points(2,minimal=False,formal=False,return_scheme=True)\n```\n\nBut there is here\n\n```\nR.<c>=QQ[]\nP.<x,y,z>=ProjectiveSpace(FractionField(R),2)\nX=P.subscheme([x-y])\nF=DynamicalSystem([x^2-c*y^2,y^2,z^2])\nF.periodic_points(2,minimal=False,formal=False,return_scheme=True)\n```",
    "created_at": "2021-06-25T18:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483640",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:10'></a>I feel like I'm starting to repeat the same errors over and over again, so here is what I have so far.

- A non-minimal point appears

```
P.<x,y,z>=ProjectiveSpace(QQ,2)
f=DynamicalSystem([x^2-z^2,y^2-21/16*z^2,z^2])
for Q in f.preperiodic_points(1,2,minimal=True,formal=False):
    print(Q, Q.is_preperiodic(f,return_period=True))
```

- line 4221: perhaps add the same comment as on 3897 as this looks redundant at first glance

```
R = f.base_ring()
```

- KeyError

```
P.<x,y>=ProjectiveSpace(QQ,1)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-1*y^2,y^2],domain=X)
F.periodic_points(2,formal=True)
```

- This is wrong:

```
P.<x,y>=ProjectiveSpace(QQ,1)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-3/4*y^2,y^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True)
```

Also wrong

```
P.<x,y,z>=ProjectiveSpace(QQ,2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2+3/4*y^2,y^2,z^2],X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()
```

Also wrong:

```
P.<x,y,z>=ProjectiveSpace(GF(3),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()
```

- TypeError

```
P.<x,y,z>=ProjectiveSpace(GF(3),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],X)
F.periodic_points(1,minimal=True,formal=True,return_scheme=True).rational_points()
```

- This gives a TypeError, perhaps catch the good fields and give a more informative error message

```
P.<x,y,z>=ProjectiveSpace(RR,2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True).rational_points()
```

- Shouldn't this work?

```
R.<c>=QQ[]
P.<x,y,z>=ProjectiveSpace(FractionField(R),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=True,formal=False,return_scheme=True)
```

- Why is there no 'c' in this?

```
R.<c>=QQ[]
P.<x,y,z>=ProjectiveSpace(FractionField(R),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-c*y^2,y^2,z^2],domain=X)
F.periodic_points(2,minimal=False,formal=False,return_scheme=True)
```

But there is here

```
R.<c>=QQ[]
P.<x,y,z>=ProjectiveSpace(FractionField(R),2)
X=P.subscheme([x-y])
F=DynamicalSystem([x^2-c*y^2,y^2,z^2])
F.periodic_points(2,minimal=False,formal=False,return_scheme=True)
```



---

archive/issue_comments_483641.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-25T18:20:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483641",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_483642.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-25T21:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483643.json:
```json
{
    "body": "<a id='comment:12'></a>Subschemes were very broken, I think because the nth iterate calculated for the subscheme might be very different. I pushed a fix that forgets about the subscheme, then adds the equations back in later. Hopefully that works better.\n\nFunction fields aren't implemented, as I don't think there is a flatening morphism for function fields. I added a nice error message.",
    "created_at": "2021-06-25T21:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483643",
    "user": "https://github.com/EnderWannabe"
}
```

<a id='comment:12'></a>Subschemes were very broken, I think because the nth iterate calculated for the subscheme might be very different. I pushed a fix that forgets about the subscheme, then adds the equations back in later. Hopefully that works better.

Function fields aren't implemented, as I don't think there is a flatening morphism for function fields. I added a nice error message.



---

archive/issue_comments_483644.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-25T21:55:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483644",
    "user": "https://github.com/EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_483645.json:
```json
{
    "body": "<a id='comment:14'></a>You fixed most of the subscheme issues, but my first three comments are unaddressed.\n\nSome additional comments on the new code:\n\n- add `domain=PS` to be clear line 3906\n\n```\nf = DynamicalSystem(f.defining_polynomials())\n```\n\n- I don't understand why dom.defining_polynomials() is on this (3911-3912)\n\n```\nif formal and N == 2 and dom == PS:\n    X = PS.subscheme([f.dynatomic_polynomial([m,n])] + list(dom.defining_polynomials()))\n```\n\n- Why are you using\n\n```\nlist(X.defining_ideal().gens()\n```\nrather than\n\n```\nlist(X.defining_polynomials())\n```",
    "created_at": "2021-06-28T20:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483645",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:14'></a>You fixed most of the subscheme issues, but my first three comments are unaddressed.

Some additional comments on the new code:

- add `domain=PS` to be clear line 3906

```
f = DynamicalSystem(f.defining_polynomials())
```

- I don't understand why dom.defining_polynomials() is on this (3911-3912)

```
if formal and N == 2 and dom == PS:
    X = PS.subscheme([f.dynatomic_polynomial([m,n])] + list(dom.defining_polynomials()))
```

- Why are you using

```
list(X.defining_ideal().gens()
```
rather than

```
list(X.defining_polynomials())
```



---

archive/issue_comments_483646.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-29T16:17:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483646",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483647.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 bhutz]:\n> You fixed most of the subscheme issues, but my first three comments are unaddressed.\n\n\nLatest push should address those, as well as the latest comments.",
    "created_at": "2021-06-29T16:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483647",
    "user": "https://github.com/EnderWannabe"
}
```

<a id='comment:16'></a>Replying to [comment:14 bhutz]:
> You fixed most of the subscheme issues, but my first three comments are unaddressed.


Latest push should address those, as well as the latest comments.



---

archive/issue_comments_483648.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-06T17:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483648",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483649.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-06T22:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483649",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483650.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-09T16:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483650",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483651.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-09T16:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483651",
    "user": "https://github.com/EnderWannabe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_483652.json:
```json
{
    "body": "<a id='comment:20'></a>Minimal seems to be broken for preperiodic points:\n\n```\nP.<x,y,z> = ProjectiveSpace(QQ, 2)\nf = DynamicalSystem_projective([x^2 - y^2, 2*(x^2 - y^2), y^2 - z^2])\nK = f.preperiodic_points(1, 1, minimal=True, return_scheme=True)\nK(P(0,0,1))\n(0: 0: 1)\n```\n\nBut (0:0:1) is a periodic point of period 1 (so it shouldn't be minimal of preperiod (1,1), right?). I'm not sure how to fix this, since\n\n```\nK2 = f.preperiodic_points(0, 1, minimal=False, return_scheme=True)\nideal = K.defining_ideal()\nideal2 = K2.defining_ideal()\nideal.saturation(ideal2)[0] == ideal\nTrue\n```\n\nSaturation of ideals isn't removing the periodic point.",
    "created_at": "2021-07-09T16:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483652",
    "user": "https://github.com/EnderWannabe"
}
```

<a id='comment:20'></a>Minimal seems to be broken for preperiodic points:

```
P.<x,y,z> = ProjectiveSpace(QQ, 2)
f = DynamicalSystem_projective([x^2 - y^2, 2*(x^2 - y^2), y^2 - z^2])
K = f.preperiodic_points(1, 1, minimal=True, return_scheme=True)
K(P(0,0,1))
(0: 0: 1)
```

But (0:0:1) is a periodic point of period 1 (so it shouldn't be minimal of preperiod (1,1), right?). I'm not sure how to fix this, since

```
K2 = f.preperiodic_points(0, 1, minimal=False, return_scheme=True)
ideal = K.defining_ideal()
ideal2 = K2.defining_ideal()
ideal.saturation(ideal2)[0] == ideal
True
```

Saturation of ideals isn't removing the periodic point.



---

archive/issue_comments_483653.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-07-09T19:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_483654.json:
```json
{
    "body": "<a id='comment:22'></a>The example:\n\n```\nP.<x,y,z> = ProjectiveSpace(QQ, 2)\nf = DynamicalSystem_projective([x^2 - y^2, 2*(x^2 - y^2), y^2 - z^2])\n```\nis not a morphism, so the theorem for the algorithm don't apply (because the variety of preperiodic points is not simply a finite union of points).\n\nDo you have an example that is failing which is a morphism?",
    "created_at": "2021-07-12T19:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483654",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:22'></a>The example:

```
P.<x,y,z> = ProjectiveSpace(QQ, 2)
f = DynamicalSystem_projective([x^2 - y^2, 2*(x^2 - y^2), y^2 - z^2])
```
is not a morphism, so the theorem for the algorithm don't apply (because the variety of preperiodic points is not simply a finite union of points).

Do you have an example that is failing which is a morphism?



---

archive/issue_comments_483655.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-12T19:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483655",
    "user": "https://github.com/EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_483656.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 bhutz]:\n> Do you have an example that is failing which is a morphism?\n\n\nNone that I can find. Good catch, thanks for pointing that out. This should be ready for review now.",
    "created_at": "2021-07-12T19:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483656",
    "user": "https://github.com/EnderWannabe"
}
```

<a id='comment:23'></a>Replying to [comment:22 bhutz]:
> Do you have an example that is failing which is a morphism?


None that I can find. Good catch, thanks for pointing that out. This should be ready for review now.



---

archive/issue_comments_483657.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-12T19:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483658.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-13T14:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483658",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_483659.json:
```json
{
    "body": "<a id='comment:25'></a>This looks good to me now.",
    "created_at": "2021-07-13T14:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483659",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:25'></a>This looks good to me now.



---

archive/issue_comments_483660.json:
```json
{
    "body": "<a id='comment:26'></a>Second thought. Since the non-morphism case is giving wrong answers, it should be error checked. It does give right answers if minimal=False, formal=False and return_scheme=True",
    "created_at": "2021-07-13T15:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483660",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:26'></a>Second thought. Since the non-morphism case is giving wrong answers, it should be error checked. It does give right answers if minimal=False, formal=False and return_scheme=True



---

archive/issue_comments_483661.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-07-13T15:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483661",
    "user": "https://github.com/bhutz"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_483662.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-13T16:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483662",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483663.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-13T16:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483663",
    "user": "https://github.com/EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_483664.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:26 bhutz]:\n> Second thought. Since the non-morphism case is giving wrong answers, it should be error checked. It does give right answers if minimal=False, formal=False and return_scheme=True\n\n\nAdded",
    "created_at": "2021-07-13T16:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483664",
    "user": "https://github.com/EnderWannabe"
}
```

<a id='comment:28'></a>Replying to [comment:26 bhutz]:
> Second thought. Since the non-morphism case is giving wrong answers, it should be error checked. It does give right answers if minimal=False, formal=False and return_scheme=True


Added



---

archive/issue_comments_483665.json:
```json
{
    "body": "<a id='comment:29'></a>The non-morphism check is missed in this case\n\n```\nP.<x,y,z>=ProjectiveSpace(QQ,2)\nF=DynamicalSystem([x^2-y^2,z^2-y^2,x^2-z^2])\nF.preperiodic_points(0,2,minimal=False,formal=True,return_scheme=True)\n```\n\nAlso, found another weird case giving back the wrong answers\n\nHere are the periods. It's not necessarily wrong that there are lower periods as there are many high multiplicity points here.\n\n```\nK=QQ\nP.<x,y,z>=ProjectiveSpace(QQ,2)\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)\nfor Q in F.preperiodic_points(2,1,minimal=False,formal=True,return_scheme=False):\n    print(Q,F._is_preperiodic(Q,return_period=True))\n```\n\nChecking the multiplicities, we see that nothing is being subtracted out despite there being (1,1) points.\n\n```\nP.<x,y,z>=ProjectiveSpace(K,2)\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)\nfor Q in F.preperiodic_points(2,1,minimal=False,formal=True,return_scheme=True).rational_points():\n    print(Q,Q.multiplicity())\n\n\nP.<x,y,z>=ProjectiveSpace(K,2)\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)\nfor Q in F.preperiodic_points(2,1,minimal=False,formal=False,return_scheme=True).rational_points():\n    print(Q,Q.multiplicity())\n\nP.<x,y,z>=ProjectiveSpace(K,2)\nF=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)\nfor Q in F.preperiodic_points(1,1,minimal=False,formal=False,return_scheme=True).rational_points():\n    print(Q,Q.multiplicity())\n```\n\n\n- Perhaps there is just something weird when minimal=False and formal=True?",
    "created_at": "2021-07-14T16:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483665",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:29'></a>The non-morphism check is missed in this case

```
P.<x,y,z>=ProjectiveSpace(QQ,2)
F=DynamicalSystem([x^2-y^2,z^2-y^2,x^2-z^2])
F.preperiodic_points(0,2,minimal=False,formal=True,return_scheme=True)
```

Also, found another weird case giving back the wrong answers

Here are the periods. It's not necessarily wrong that there are lower periods as there are many high multiplicity points here.

```
K=QQ
P.<x,y,z>=ProjectiveSpace(QQ,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(2,1,minimal=False,formal=True,return_scheme=False):
    print(Q,F._is_preperiodic(Q,return_period=True))
```

Checking the multiplicities, we see that nothing is being subtracted out despite there being (1,1) points.

```
P.<x,y,z>=ProjectiveSpace(K,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(2,1,minimal=False,formal=True,return_scheme=True).rational_points():
    print(Q,Q.multiplicity())


P.<x,y,z>=ProjectiveSpace(K,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(2,1,minimal=False,formal=False,return_scheme=True).rational_points():
    print(Q,Q.multiplicity())

P.<x,y,z>=ProjectiveSpace(K,2)
F=DynamicalSystem([x^2-2*y^2,y^2,z^2],domain=P)
for Q in F.preperiodic_points(1,1,minimal=False,formal=False,return_scheme=True).rational_points():
    print(Q,Q.multiplicity())
```


- Perhaps there is just something weird when minimal=False and formal=True?



---

archive/issue_comments_483666.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-14T16:13:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483666",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_483667.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-14T16:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483667",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483668.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:29 bhutz]:\n> Also, found another weird case giving back the wrong answers\n\n\nI updated the logic around minimal and formal, adding a check for if (m,n) != (0,1). But, I coded it as m != 0 and n != 1, so minimal and formal were being ignored when n = 1 or when m = 0.\n\nChanged to m != 0 or n != 1.\n\nI think the example you gave should work now, however, it hasn't finished running yet. It may never will, since it is actually doing the computations to find the formal scheme now",
    "created_at": "2021-07-14T16:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483668",
    "user": "https://github.com/EnderWannabe"
}
```

<a id='comment:31'></a>Replying to [comment:29 bhutz]:
> Also, found another weird case giving back the wrong answers


I updated the logic around minimal and formal, adding a check for if (m,n) != (0,1). But, I coded it as m != 0 and n != 1, so minimal and formal were being ignored when n = 1 or when m = 0.

Changed to m != 0 or n != 1.

I think the example you gave should work now, however, it hasn't finished running yet. It may never will, since it is actually doing the computations to find the formal scheme now



---

archive/issue_comments_483669.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-14T16:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483669",
    "user": "https://github.com/EnderWannabe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_483670.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-14T18:29:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483670",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483671.json:
```json
{
    "body": "<a id='comment:34'></a>Yes, the formal=True is running now. The original example is not finishing, but I ran a shorter one with the same type of properties to check.",
    "created_at": "2021-07-15T15:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483671",
    "user": "https://github.com/bhutz"
}
```

<a id='comment:34'></a>Yes, the formal=True is running now. The original example is not finishing, but I ran a shorter one with the same type of properties to check.



---

archive/issue_comments_483672.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-15T15:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483672",
    "user": "https://github.com/bhutz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_084421.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-25T18:51:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31944#event-84421"
}
```



---

archive/issue_comments_483673.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-25T18:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483673",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_483674.json:
```json
{
    "body": "<a id='comment:36'></a>This is creating random failures, I've created #32322",
    "created_at": "2021-08-01T08:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31944#issuecomment-483674",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:36'></a>This is creating random failures, I've created #32322
