# Issue 31344: homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals / multiprocessing

archive/issues_031107.json:
```json
{
    "body": "(from #31335, reported in https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4)\n\n**CC:**  @jhpalmieri @zlscherr @kiwifb @kliem\n\n**Branch/Commit:** [b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)\n\n**Reviewer:** John Palmieri\n\n**Author:** Matthias Koeppe, John Palmieri\n\nIssue created by migration from https://trac.sagemath.org/ticket/31344\n\n",
    "closed_at": "2021-03-01T00:24:21Z",
    "created_at": "2021-02-05T06:35:18Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "title": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals / multiprocessing",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/31344",
    "user": "https://github.com/mkoeppe"
}
```
(from #31335, reported in https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4)

**CC:**  @jhpalmieri @zlscherr @kiwifb @kliem

**Branch/Commit:** [b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)

**Reviewer:** John Palmieri

**Author:** Matthias Koeppe, John Palmieri

Issue created by migration from https://trac.sagemath.org/ticket/31344





---

archive/issue_comments_505335.json:
```json
{
    "body": "<a id='comment:1'></a>\nBisecting `src/doc/en/reference/misc/index.rst` (running `./sage -docbuild --keep-going all html`) reveals that the crash is coming from `sage.misc.cython`",
    "created_at": "2021-02-05T07:15:39Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505335",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
Bisecting `src/doc/en/reference/misc/index.rst` (running `./sage -docbuild --keep-going all html`) reveals that the crash is coming from `sage.misc.cython`



---

archive/issue_comments_505336.json:
```json
{
    "body": "<a id='comment:2'></a>\nFor some reason, this line: `cblas_pc = pkgconfig.parse(get_cblas_pc_module_name())`\nseems to cause the trouble.",
    "created_at": "2021-02-05T08:44:15Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505336",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
For some reason, this line: `cblas_pc = pkgconfig.parse(get_cblas_pc_module_name())`
seems to cause the trouble.



---

archive/issue_comments_505337.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)",
    "created_at": "2021-02-05T09:10:10Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505337",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)



---

archive/issue_comments_505338.json:
```json
{
    "body": "<a id='comment:4'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0\">80720d7</a></td><td><code>src/sage/misc/cython.py: Do not run pkgconfig at import time</code></td></tr></table>\n",
    "created_at": "2021-02-05T09:10:33Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505338",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0">80720d7</a></td><td><code>src/sage/misc/cython.py: Do not run pkgconfig at import time</code></td></tr></table>




---

archive/issue_comments_505339.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2021-02-05T09:10:33Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505339",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_505340.json:
```json
{
    "body": "**Commit:** [80720d7bcc0b1de4b92984fa62d52dad5855b9b0](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)",
    "created_at": "2021-02-05T09:10:33Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505340",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [80720d7bcc0b1de4b92984fa62d52dad5855b9b0](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)



---

archive/issue_events_281028.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-05T09:10:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281028"
}
```



---

archive/issue_comments_505341.json:
```json
{
    "body": "<a id='comment:5'></a>\nEasiest to test on #31335, which merges this branch",
    "created_at": "2021-02-05T09:12:22Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505341",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Easiest to test on #31335, which merges this branch



---

archive/issue_comments_505342.json:
```json
{
    "body": "<a id='comment:6'></a>\nWith #31335, I still see a failure during docbuilding when using homebrew's Python with Big Sur. The failure now appears when building `thematic_tutorials` instead of the reference manual.\n\n```\n------------------------------------------------------------------------\n0   signals.cpython-39-darwin.so        0x00000001047e2542 print_backtrace + 66\n1   signals.cpython-39-darwin.so        0x00000001047e6167 sigdie + 39\n2   signals.cpython-39-darwin.so        0x00000001047e606a cysigs_signal_handler + 282\n3   libsystem_platform.dylib            0x00007fff20486d7d _sigtramp + 29\n4   Python                              0x00000001029edcf1 _PyArg_ParseTuple_SizeT + 158\n5   libtcl8.6.dylib                     0x000000034143972e AtForkPrepare + 38\n6   libsystem_pthread.dylib             0x00007fff204421a3 _pthread_atfork_prepare_handlers + 90\n7   libSystem.B.dylib                   0x00007fff2a645934 libSystem_atfork_prepare + 11\n8   libsystem_c.dylib                   0x00007fff20325b1b fork + 12\n9   _posixsubprocess.cpython-39-darwin. 0x00000001030d77f3 subprocess_fork_exec + 860\n10  Python                              0x000000010291c2da cfunction_call + 90\n11  Python                              0x00000001028d1b56 _PyObject_MakeTpCall + 129\n12  Python                              0x00000001029ca625 call_function + 278\n13  Python                              0x00000001029c7e86 _PyEval_EvalFrameDefault + 45416\n14  Python                              0x00000001029bbbd6 _PyEval_EvalCode + 403\n...\n272 Python                              0x00000001028d2774 _PyFunction_Vectorcall + 376\n273 Python                              0x0000000102a3ade0 pymain_run_module + 212\n274 Python                              0x0000000102a3a8aa pymain_run_python + 433\n275 Python                              0x0000000102a3a6bd Py_RunMain + 23\n276 Python                              0x0000000102a3b9da pymain_main + 35\n277 Python                              0x0000000102a3bcb0 Py_BytesMain + 42\n278 libdyld.dylib                       0x00007fff2045d621 start + 1\n------------------------------------------------------------------------\nUnhandled SIGILL: An illegal instruction occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n```",
    "created_at": "2021-02-05T19:57:36Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505342",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>
With #31335, I still see a failure during docbuilding when using homebrew's Python with Big Sur. The failure now appears when building `thematic_tutorials` instead of the reference manual.

```
------------------------------------------------------------------------
0   signals.cpython-39-darwin.so        0x00000001047e2542 print_backtrace + 66
1   signals.cpython-39-darwin.so        0x00000001047e6167 sigdie + 39
2   signals.cpython-39-darwin.so        0x00000001047e606a cysigs_signal_handler + 282
3   libsystem_platform.dylib            0x00007fff20486d7d _sigtramp + 29
4   Python                              0x00000001029edcf1 _PyArg_ParseTuple_SizeT + 158
5   libtcl8.6.dylib                     0x000000034143972e AtForkPrepare + 38
6   libsystem_pthread.dylib             0x00007fff204421a3 _pthread_atfork_prepare_handlers + 90
7   libSystem.B.dylib                   0x00007fff2a645934 libSystem_atfork_prepare + 11
8   libsystem_c.dylib                   0x00007fff20325b1b fork + 12
9   _posixsubprocess.cpython-39-darwin. 0x00000001030d77f3 subprocess_fork_exec + 860
10  Python                              0x000000010291c2da cfunction_call + 90
11  Python                              0x00000001028d1b56 _PyObject_MakeTpCall + 129
12  Python                              0x00000001029ca625 call_function + 278
13  Python                              0x00000001029c7e86 _PyEval_EvalFrameDefault + 45416
14  Python                              0x00000001029bbbd6 _PyEval_EvalCode + 403
...
272 Python                              0x00000001028d2774 _PyFunction_Vectorcall + 376
273 Python                              0x0000000102a3ade0 pymain_run_module + 212
274 Python                              0x0000000102a3a8aa pymain_run_python + 433
275 Python                              0x0000000102a3a6bd Py_RunMain + 23
276 Python                              0x0000000102a3b9da pymain_main + 35
277 Python                              0x0000000102a3bcb0 Py_BytesMain + 42
278 libdyld.dylib                       0x00007fff2045d621 start + 1
------------------------------------------------------------------------
Unhandled SIGILL: An illegal instruction occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
```



---

archive/issue_comments_505343.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks for testing! I'll try a clean rebuild of the documentation and see if I can reproduce it on Catalina as well. \n\nFor reference, the trick for bisecting was to use\n\n```\nmake build && ./sage -docbuild --keep-going all html ; ./sage -docbuild all html\n```\nthe first `--keep-going` was necessary so that `WARNING: document isn't included in any toctree` does not stop the whole process.",
    "created_at": "2021-02-05T20:11:35Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505343",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
Thanks for testing! I'll try a clean rebuild of the documentation and see if I can reproduce it on Catalina as well. 

For reference, the trick for bisecting was to use

```
make build && ./sage -docbuild --keep-going all html ; ./sage -docbuild all html
```
the first `--keep-going` was necessary so that `WARNING: document isn't included in any toctree` does not stop the whole process.



---

archive/issue_comments_505344.json:
```json
{
    "body": "<a id='comment:8'></a>\nOK, I can reproduce it",
    "created_at": "2021-02-05T20:25:18Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505344",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
OK, I can reproduce it



---

archive/issue_comments_505345.json:
```json
{
    "body": "<a id='comment:9'></a>\nreducing `thematic_tutorials/index.rst` to the following still reproduces the crash:\n\n```\n.. Sage documentation master file, created by sphinx-quickstart on Thu\n.. Aug 21 20:15:55 2008. You can adapt this file completely to your\n.. liking, but it should at least contain the root `toctree` directive.\n\n.. _thematic-tutorials:\n\nWelcome to the Sage Thematic Tutorials!\n=======================================\n\n\n* `Tutorial: Symbolics and Plotting (PREP) <../prep/Symbolics-and-Basic-Plotting.html>`_\n```",
    "created_at": "2021-02-05T20:43:19Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505345",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
reducing `thematic_tutorials/index.rst` to the following still reproduces the crash:

```
.. Sage documentation master file, created by sphinx-quickstart on Thu
.. Aug 21 20:15:55 2008. You can adapt this file completely to your
.. liking, but it should at least contain the root `toctree` directive.

.. _thematic-tutorials:

Welcome to the Sage Thematic Tutorials!
=======================================


* `Tutorial: Symbolics and Plotting (PREP) <../prep/Symbolics-and-Basic-Plotting.html>`_
```



---

archive/issue_comments_505346.json:
```json
{
    "body": "<a id='comment:10'></a>\nThat's in an incremental docbuild - so something bad must have been saved in the inventory.",
    "created_at": "2021-02-05T20:49:09Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505346",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
That's in an incremental docbuild - so something bad must have been saved in the inventory.



---

archive/issue_comments_505347.json:
```json
{
    "body": "<a id='comment:11'></a>\nWhen I saw the original problem, I only saw it on the second pass through the ref manual build, which is consistent with seeing problems based on something in the inventory.",
    "created_at": "2021-02-05T22:43:04Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505347",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>
When I saw the original problem, I only saw it on the second pass through the ref manual build, which is consistent with seeing problems based on something in the inventory.



---

archive/issue_comments_505348.json:
```json
{
    "body": "<a id='comment:12'></a>\nDoes anyone know why \n\n```\n./sage --docbuild all html\n```\n\nfails at thematic_tutorial but\n\n```\n./sage --docbuild thematic_tutorial html\n```\n\nworks?",
    "created_at": "2021-02-05T23:29:38Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505348",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:12'></a>
Does anyone know why 

```
./sage --docbuild all html
```

fails at thematic_tutorial but

```
./sage --docbuild thematic_tutorial html
```

works?



---

archive/issue_comments_505349.json:
```json
{
    "body": "<a id='comment:13'></a>\nIn fact, after\n\n```\n./sage -docbuild --keep-going all html\n```\n\nfailed, I tried building thematic_tutorial by itself.  That worked, and then make doc says it was successful.",
    "created_at": "2021-02-05T23:39:05Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505349",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:13'></a>
In fact, after

```
./sage -docbuild --keep-going all html
```

failed, I tried building thematic_tutorial by itself.  That worked, and then make doc says it was successful.



---

archive/issue_comments_505350.json:
```json
{
    "body": "<a id='comment:14'></a>\nI think the bug is triggered by the parallelization code in `sage_setup.docbuild.AllBuilder`.",
    "created_at": "2021-02-05T23:57:24Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505350",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
I think the bug is triggered by the parallelization code in `sage_setup.docbuild.AllBuilder`.



---

archive/issue_comments_505351.json:
```json
{
    "body": "<a id='comment:15'></a>\nWe previously had trouble with this code (`build_many` - from #28356, #27514, #27490) in #30351, #28483, ...",
    "created_at": "2021-02-06T00:19:32Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505351",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
We previously had trouble with this code (`build_many` - from #28356, #27514, #27490) in #30351, #28483, ...



---

archive/issue_comments_505352.json:
```json
{
    "body": "<a id='comment:16'></a>\nsee also #31289",
    "created_at": "2021-02-06T00:30:14Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505352",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
see also #31289



---

archive/issue_comments_505353.json:
```json
{
    "body": "<a id='comment:17'></a>\nIn any case, I think this ticket is an improvement by itself, as it removes some accidental globals from the module `sage.misc.cython` and reduced its load time.",
    "created_at": "2021-02-06T02:32:01Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505353",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
In any case, I think this ticket is an improvement by itself, as it removes some accidental globals from the module `sage.misc.cython` and reduced its load time.



---

archive/issue_events_281029.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-06T02:32:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "rename": {
        "from": "homebrew: docbuild crashes, libtcl AtForkPrepare",
        "to": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281029"
}
```



---

archive/issue_comments_505354.json:
```json
{
    "body": "<a id='comment:19'></a>\nWith this change, the documentation builds for me (but of course it is missing a plot):\n\n```diff\ndiff --git a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst\nindex 9faa9f2375..bc77d72e68 100644\n--- a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst\n+++ b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst\n@@ -94,7 +94,6 @@ Vector fields can be plotted::\n     E = EuclideanSpace(3)\n     x, y, z = E.default_chart()[:]\n     v = E.vector_field(-y, x, sin(x*y*z), name='v')\n-    sphinx_plot(v.plot(max_range=1.5, scale=0.5))\n \n For customizing the plot, see the list of options in the documentation of\n :meth:`~sage.manifolds.differentiable.vectorfield.VectorField.plot`.\n```",
    "created_at": "2021-02-06T04:48:00Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505354",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>
With this change, the documentation builds for me (but of course it is missing a plot):

```diff
diff --git a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst
index 9faa9f2375..bc77d72e68 100644
--- a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst
+++ b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst
@@ -94,7 +94,6 @@ Vector fields can be plotted::
     E = EuclideanSpace(3)
     x, y, z = E.default_chart()[:]
     v = E.vector_field(-y, x, sin(x*y*z), name='v')
-    sphinx_plot(v.plot(max_range=1.5, scale=0.5))
 
 For customizing the plot, see the list of options in the documentation of
 :meth:`~sage.manifolds.differentiable.vectorfield.VectorField.plot`.
```



---

archive/issue_comments_505355.json:
```json
{
    "body": "<a id='comment:20'></a>\nThis does not seem to help on my machine",
    "created_at": "2021-02-06T07:20:33Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505355",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
This does not seem to help on my machine



---

archive/issue_comments_505356.json:
```json
{
    "body": "<a id='comment:21'></a>\nSorry, it turns out that it doesn't consistently help on mine, either. I think this should stop the non-reference manual docs from being built in parallel:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py\nindex b07e9c100c..1d4139555e 100644\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -286,13 +286,15 @@ class DocBuilder(object):\n \n from .utils import build_many as _build_many\n \n-def build_many(target, args):\n+def build_many(target, args, processes=None):\n     \"\"\"\n     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the\n     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.\n     \"\"\"\n+    if processes is None:\n+        processes = NUM_THREADS\n     try:\n-        _build_many(target, args, processes=NUM_THREADS)\n+        _build_many(target, args, processes=processes)\n     except BaseException as exc:\n         if ABORT_ON_ERROR:\n             raise\n@@ -349,7 +351,7 @@ class AllBuilder(object):\n \n         # build the other documents in parallel\n         L = [(doc, name, kwds) + args for doc in others]\n-        build_many(build_other_doc, L)\n+        build_many(build_other_doc, L, 1)\n         logger.warning(\"Elapsed time: %.1f seconds.\"%(time.time()-start))\n         logger.warning(\"Done building the documentation!\")\n```",
    "created_at": "2021-02-07T01:17:15Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505356",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>
Sorry, it turns out that it doesn't consistently help on mine, either. I think this should stop the non-reference manual docs from being built in parallel:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index b07e9c100c..1d4139555e 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -286,13 +286,15 @@ class DocBuilder(object):
 
 from .utils import build_many as _build_many
 
-def build_many(target, args):
+def build_many(target, args, processes=None):
     """
     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the
     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.
     """
+    if processes is None:
+        processes = NUM_THREADS
     try:
-        _build_many(target, args, processes=NUM_THREADS)
+        _build_many(target, args, processes=processes)
     except BaseException as exc:
         if ABORT_ON_ERROR:
             raise
@@ -349,7 +351,7 @@ class AllBuilder(object):
 
         # build the other documents in parallel
         L = [(doc, name, kwds) + args for doc in others]
-        build_many(build_other_doc, L)
+        build_many(build_other_doc, L, 1)
         logger.warning("Elapsed time: %.1f seconds."%(time.time()-start))
         logger.warning("Done building the documentation!")
```



---

archive/issue_comments_505357.json:
```json
{
    "body": "<a id='comment:22'></a>\n#31289 doesn't seem to help, by the way.",
    "created_at": "2021-02-07T03:00:42Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505357",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>
#31289 doesn't seem to help, by the way.



---

archive/issue_comments_505358.json:
```json
{
    "body": "<a id='comment:23'></a>\nPerhaps conditionalize this change on macOS?",
    "created_at": "2021-02-07T17:37:34Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505358",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
Perhaps conditionalize this change on macOS?



---

archive/issue_comments_505359.json:
```json
{
    "body": "<a id='comment:24'></a>\nI've pushed this change to the branch of #31335, but it does not actually fix the problem for me. I'll try next if replacing the `build_many` by a `for` loop helps.",
    "created_at": "2021-02-07T19:06:10Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505359",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
I've pushed this change to the branch of #31335, but it does not actually fix the problem for me. I'll try next if replacing the `build_many` by a `for` loop helps.



---

archive/issue_comments_505360.json:
```json
{
    "body": "<a id='comment:25'></a>\n(retracted)",
    "created_at": "2021-02-07T19:06:41Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505360",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
(retracted)



---

archive/issue_events_281030.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-07T19:24:12Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "rename": {
        "from": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals",
        "to": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals / multiprocessing"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281030"
}
```



---

archive/issue_comments_505361.json:
```json
{
    "body": "<a id='comment:27'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/515f89934e3b6d5daaa9a54684a4fb374289b978\">515f899</a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/804ebd7689fe8423e901e8ecf38dd62a7a9b8789\">804ebd7</a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a\">b4ceee5</a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr></table>\n",
    "created_at": "2021-02-07T19:25:25Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505361",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/515f89934e3b6d5daaa9a54684a4fb374289b978">515f899</a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/804ebd7689fe8423e901e8ecf38dd62a7a9b8789">804ebd7</a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a">b4ceee5</a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr></table>




---

archive/issue_comments_505362.json:
```json
{
    "body": "**Changing commit** from \"[80720d7bcc0b1de4b92984fa62d52dad5855b9b0](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)\" to \"[b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)\".",
    "created_at": "2021-02-07T19:25:25Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505362",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[80720d7bcc0b1de4b92984fa62d52dad5855b9b0](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)" to "[b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)".



---

archive/issue_comments_505363.json:
```json
{
    "body": "<a id='comment:28'></a>\nThis fixes the problem on my machine. Please test on Big Sur",
    "created_at": "2021-02-07T19:26:25Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505363",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
This fixes the problem on my machine. Please test on Big Sur



---

archive/issue_events_281031.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-07T19:27:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281031"
}
```



---

archive/issue_events_281032.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-07T19:27:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281032"
}
```



---

archive/issue_comments_505364.json:
```json
{
    "body": "**Changing author** from \"Matthias Koeppe\" to \"Matthias Koeppe, John Palmieri\".",
    "created_at": "2021-02-07T19:27:42Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505364",
    "user": "https://github.com/mkoeppe"
}
```

**Changing author** from "Matthias Koeppe" to "Matthias Koeppe, John Palmieri".



---

archive/issue_comments_505365.json:
```json
{
    "body": "<a id='comment:31'></a>\nWorked for me on Big Sur",
    "created_at": "2021-02-08T00:03:41Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505365",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:31'></a>
Worked for me on Big Sur



---

archive/issue_comments_505366.json:
```json
{
    "body": "**Reviewer:** John Palmieri",
    "created_at": "2021-02-08T03:14:06Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505366",
    "user": "https://github.com/jhpalmieri"
}
```

**Reviewer:** John Palmieri



---

archive/issue_events_281033.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-02-08T03:14:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281033"
}
```



---

archive/issue_events_281034.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-02-08T03:14:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281034"
}
```



---

archive/issue_comments_505367.json:
```json
{
    "body": "<a id='comment:32'></a>\nThis works for me, too. It would be nice to know that the actual problem is beyond \"some murky issue with parallel docbuilding on OS X,\" but it's good enough to merge. `@`gh-zlscherr, feel free to add your real name to the reviewers field (and also to the [wiki page](https://trac.sagemath.org/wiki), if you want).",
    "created_at": "2021-02-08T03:14:06Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505367",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:32'></a>
This works for me, too. It would be nice to know that the actual problem is beyond "some murky issue with parallel docbuilding on OS X," but it's good enough to merge. `@`gh-zlscherr, feel free to add your real name to the reviewers field (and also to the [wiki page](https://trac.sagemath.org/wiki), if you want).



---

archive/issue_comments_505368.json:
```json
{
    "body": "<a id='comment:33'></a>\nThanks!",
    "created_at": "2021-02-08T04:19:23Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505368",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>
Thanks!



---

archive/issue_comments_505369.json:
```json
{
    "body": "<a id='comment:34'></a>\nthis fixed the docbuild crash on my Big Sur bix too",
    "created_at": "2021-02-08T12:03:36Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505369",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>
this fixed the docbuild crash on my Big Sur bix too



---

archive/issue_comments_505370.json:
```json
{
    "body": "<a id='comment:35'></a>\nOn macOS 10.14.6: dochtml builds with this, while it does not with 9.3.beta7 or #31419.",
    "created_at": "2021-02-21T08:10:47Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505370",
    "user": "https://github.com/slel"
}
```

<a id='comment:35'></a>
On macOS 10.14.6: dochtml builds with this, while it does not with 9.3.beta7 or #31419.



---

archive/issue_events_281035.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-01T00:24:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281035"
}
```



---

archive/issue_events_281036.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "f2fea77292f0aebcabdbe69dfa0c9ae97a713c3e",
    "created_at": "2021-03-01T00:24:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-281036"
}
```



---

archive/issue_comments_505371.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)\" to \"[b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)\".",
    "created_at": "2021-03-01T00:24:21Z",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-505371",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)" to "[b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)".
