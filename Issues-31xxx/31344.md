# Issue 31344: homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals / multiprocessing

archive/issues_031107.json:
```json
{
    "assignees": [],
    "body": "(from #31335, reported in https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4)\n\nCC:  @jhpalmieri @zlscherr @kiwifb @kliem\n\nBranch/Commit: **[`b4ceee5`](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)**\n\nReviewer: **John Palmieri**\n\nAuthor: **Matthias Koeppe, John Palmieri**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31344_\n\n",
    "closed_at": "2021-03-01T00:24:21Z",
    "created_at": "2021-02-05T06:35:18Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals / multiprocessing",
    "type": "issue",
    "updated_at": "2021-03-01T00:24:21Z",
    "url": "https://github.com/sagemath/sage/issues/31344",
    "user": "https://github.com/mkoeppe"
}
```
(from #31335, reported in https://groups.google.com/g/sage-devel/c/9EMs9h2i_H4)

CC:  @jhpalmieri @zlscherr @kiwifb @kliem

Branch/Commit: **[`b4ceee5`](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)**

Reviewer: **John Palmieri**

Author: **Matthias Koeppe, John Palmieri**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/31344_





---

archive/issue_events_434166.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-05T06:35:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434166"
}
```



---

archive/issue_events_434167.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-05T06:35:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434167"
}
```



---

archive/issue_events_434168.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-05T06:35:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434168"
}
```



---

archive/issue_events_434169.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-05T06:35:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434169"
}
```



---

archive/issue_comments_502501.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nBisecting `src/doc/en/reference/misc/index.rst` (running `./sage -docbuild --keep-going all html`) reveals that the crash is coming from `sage.misc.cython`",
    "created_at": "2021-02-05T07:15:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502501",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>

Bisecting `src/doc/en/reference/misc/index.rst` (running `./sage -docbuild --keep-going all html`) reveals that the crash is coming from `sage.misc.cython`



---

archive/issue_comments_502502.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nFor some reason, this line: `cblas_pc = pkgconfig.parse(get_cblas_pc_module_name())`\nseems to cause the trouble.",
    "created_at": "2021-02-05T08:44:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502502",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:2" align="right">comment:2</div>

For some reason, this line: `cblas_pc = pkgconfig.parse(get_cblas_pc_module_name())`
seems to cause the trouble.



---

archive/issue_comments_502503.json:
```json
{
    "body": "Branch: **[u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)**",
    "created_at": "2021-02-05T09:10:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502503",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)**



---

archive/issue_comments_502504.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0\"><code>80720d7</code></a></td><td><code>src/sage/misc/cython.py: Do not run pkgconfig at import time</code></td></tr></table>\n",
    "created_at": "2021-02-05T09:10:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502504",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0"><code>80720d7</code></a></td><td><code>src/sage/misc/cython.py: Do not run pkgconfig at import time</code></td></tr></table>




---

archive/issue_comments_502505.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2021-02-05T09:10:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502505",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_502506.json:
```json
{
    "body": "Commit: **[`80720d7`](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)**",
    "created_at": "2021-02-05T09:10:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502506",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`80720d7`](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)**



---

archive/issue_events_434170.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-05T09:10:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434170"
}
```



---

archive/issue_comments_502507.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nEasiest to test on #31335, which merges this branch",
    "created_at": "2021-02-05T09:12:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502507",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">comment:5</div>

Easiest to test on #31335, which merges this branch



---

archive/issue_comments_502508.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nWith #31335, I still see a failure during docbuilding when using homebrew's Python with Big Sur. The failure now appears when building `thematic_tutorials` instead of the reference manual.\n\n```\n------------------------------------------------------------------------\n0   signals.cpython-39-darwin.so        0x00000001047e2542 print_backtrace + 66\n1   signals.cpython-39-darwin.so        0x00000001047e6167 sigdie + 39\n2   signals.cpython-39-darwin.so        0x00000001047e606a cysigs_signal_handler + 282\n3   libsystem_platform.dylib            0x00007fff20486d7d _sigtramp + 29\n4   Python                              0x00000001029edcf1 _PyArg_ParseTuple_SizeT + 158\n5   libtcl8.6.dylib                     0x000000034143972e AtForkPrepare + 38\n6   libsystem_pthread.dylib             0x00007fff204421a3 _pthread_atfork_prepare_handlers + 90\n7   libSystem.B.dylib                   0x00007fff2a645934 libSystem_atfork_prepare + 11\n8   libsystem_c.dylib                   0x00007fff20325b1b fork + 12\n9   _posixsubprocess.cpython-39-darwin. 0x00000001030d77f3 subprocess_fork_exec + 860\n10  Python                              0x000000010291c2da cfunction_call + 90\n11  Python                              0x00000001028d1b56 _PyObject_MakeTpCall + 129\n12  Python                              0x00000001029ca625 call_function + 278\n13  Python                              0x00000001029c7e86 _PyEval_EvalFrameDefault + 45416\n14  Python                              0x00000001029bbbd6 _PyEval_EvalCode + 403\n...\n272 Python                              0x00000001028d2774 _PyFunction_Vectorcall + 376\n273 Python                              0x0000000102a3ade0 pymain_run_module + 212\n274 Python                              0x0000000102a3a8aa pymain_run_python + 433\n275 Python                              0x0000000102a3a6bd Py_RunMain + 23\n276 Python                              0x0000000102a3b9da pymain_main + 35\n277 Python                              0x0000000102a3bcb0 Py_BytesMain + 42\n278 libdyld.dylib                       0x00007fff2045d621 start + 1\n------------------------------------------------------------------------\nUnhandled SIGILL: An illegal instruction occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n```",
    "created_at": "2021-02-05T19:57:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502508",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:6" align="right">comment:6</div>

With #31335, I still see a failure during docbuilding when using homebrew's Python with Big Sur. The failure now appears when building `thematic_tutorials` instead of the reference manual.

```
------------------------------------------------------------------------
0   signals.cpython-39-darwin.so        0x00000001047e2542 print_backtrace + 66
1   signals.cpython-39-darwin.so        0x00000001047e6167 sigdie + 39
2   signals.cpython-39-darwin.so        0x00000001047e606a cysigs_signal_handler + 282
3   libsystem_platform.dylib            0x00007fff20486d7d _sigtramp + 29
4   Python                              0x00000001029edcf1 _PyArg_ParseTuple_SizeT + 158
5   libtcl8.6.dylib                     0x000000034143972e AtForkPrepare + 38
6   libsystem_pthread.dylib             0x00007fff204421a3 _pthread_atfork_prepare_handlers + 90
7   libSystem.B.dylib                   0x00007fff2a645934 libSystem_atfork_prepare + 11
8   libsystem_c.dylib                   0x00007fff20325b1b fork + 12
9   _posixsubprocess.cpython-39-darwin. 0x00000001030d77f3 subprocess_fork_exec + 860
10  Python                              0x000000010291c2da cfunction_call + 90
11  Python                              0x00000001028d1b56 _PyObject_MakeTpCall + 129
12  Python                              0x00000001029ca625 call_function + 278
13  Python                              0x00000001029c7e86 _PyEval_EvalFrameDefault + 45416
14  Python                              0x00000001029bbbd6 _PyEval_EvalCode + 403
...
272 Python                              0x00000001028d2774 _PyFunction_Vectorcall + 376
273 Python                              0x0000000102a3ade0 pymain_run_module + 212
274 Python                              0x0000000102a3a8aa pymain_run_python + 433
275 Python                              0x0000000102a3a6bd Py_RunMain + 23
276 Python                              0x0000000102a3b9da pymain_main + 35
277 Python                              0x0000000102a3bcb0 Py_BytesMain + 42
278 libdyld.dylib                       0x00007fff2045d621 start + 1
------------------------------------------------------------------------
Unhandled SIGILL: An illegal instruction occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
```



---

archive/issue_comments_502509.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThanks for testing! I'll try a clean rebuild of the documentation and see if I can reproduce it on Catalina as well. \n\nFor reference, the trick for bisecting was to use\n\n```\nmake build && ./sage -docbuild --keep-going all html ; ./sage -docbuild all html\n```\nthe first `--keep-going` was necessary so that `WARNING: document isn't included in any toctree` does not stop the whole process.",
    "created_at": "2021-02-05T20:11:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502509",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

Thanks for testing! I'll try a clean rebuild of the documentation and see if I can reproduce it on Catalina as well. 

For reference, the trick for bisecting was to use

```
make build && ./sage -docbuild --keep-going all html ; ./sage -docbuild all html
```
the first `--keep-going` was necessary so that `WARNING: document isn't included in any toctree` does not stop the whole process.



---

archive/issue_comments_502510.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nOK, I can reproduce it",
    "created_at": "2021-02-05T20:25:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502510",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8" align="right">comment:8</div>

OK, I can reproduce it



---

archive/issue_comments_502511.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nreducing `thematic_tutorials/index.rst` to the following still reproduces the crash:\n\n```\n.. Sage documentation master file, created by sphinx-quickstart on Thu\n.. Aug 21 20:15:55 2008. You can adapt this file completely to your\n.. liking, but it should at least contain the root `toctree` directive.\n\n.. _thematic-tutorials:\n\nWelcome to the Sage Thematic Tutorials!\n=======================================\n\n\n* `Tutorial: Symbolics and Plotting (PREP) <../prep/Symbolics-and-Basic-Plotting.html>`_\n```",
    "created_at": "2021-02-05T20:43:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502511",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

reducing `thematic_tutorials/index.rst` to the following still reproduces the crash:

```
.. Sage documentation master file, created by sphinx-quickstart on Thu
.. Aug 21 20:15:55 2008. You can adapt this file completely to your
.. liking, but it should at least contain the root `toctree` directive.

.. _thematic-tutorials:

Welcome to the Sage Thematic Tutorials!
=======================================


* `Tutorial: Symbolics and Plotting (PREP) <../prep/Symbolics-and-Basic-Plotting.html>`_
```



---

archive/issue_comments_502512.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThat's in an incremental docbuild - so something bad must have been saved in the inventory.",
    "created_at": "2021-02-05T20:49:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502512",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:10" align="right">comment:10</div>

That's in an incremental docbuild - so something bad must have been saved in the inventory.



---

archive/issue_comments_502513.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWhen I saw the original problem, I only saw it on the second pass through the ref manual build, which is consistent with seeing problems based on something in the inventory.",
    "created_at": "2021-02-05T22:43:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502513",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:11" align="right">comment:11</div>

When I saw the original problem, I only saw it on the second pass through the ref manual build, which is consistent with seeing problems based on something in the inventory.



---

archive/issue_comments_502514.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nDoes anyone know why \n\n```\n./sage --docbuild all html\n```\n\nfails at thematic_tutorial but\n\n```\n./sage --docbuild thematic_tutorial html\n```\n\nworks?",
    "created_at": "2021-02-05T23:29:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502514",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:12" align="right">comment:12</div>

Does anyone know why 

```
./sage --docbuild all html
```

fails at thematic_tutorial but

```
./sage --docbuild thematic_tutorial html
```

works?



---

archive/issue_comments_502515.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIn fact, after\n\n```\n./sage -docbuild --keep-going all html\n```\n\nfailed, I tried building thematic_tutorial by itself.  That worked, and then make doc says it was successful.",
    "created_at": "2021-02-05T23:39:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502515",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:13" align="right">comment:13</div>

In fact, after

```
./sage -docbuild --keep-going all html
```

failed, I tried building thematic_tutorial by itself.  That worked, and then make doc says it was successful.



---

archive/issue_comments_502516.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI think the bug is triggered by the parallelization code in `sage_setup.docbuild.AllBuilder`.",
    "created_at": "2021-02-05T23:57:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502516",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

I think the bug is triggered by the parallelization code in `sage_setup.docbuild.AllBuilder`.



---

archive/issue_comments_502517.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nWe previously had trouble with this code (`build_many` - from #28356, #27514, #27490) in #30351, #28483, ...",
    "created_at": "2021-02-06T00:19:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502517",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

We previously had trouble with this code (`build_many` - from #28356, #27514, #27490) in #30351, #28483, ...



---

archive/issue_comments_502518.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nsee also #31289",
    "created_at": "2021-02-06T00:30:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502518",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

see also #31289



---

archive/issue_comments_502519.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nIn any case, I think this ticket is an improvement by itself, as it removes some accidental globals from the module `sage.misc.cython` and reduced its load time.",
    "created_at": "2021-02-06T02:32:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502519",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:17" align="right">comment:17</div>

In any case, I think this ticket is an improvement by itself, as it removes some accidental globals from the module `sage.misc.cython` and reduced its load time.



---

archive/issue_events_434171.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-06T02:32:24Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "title_is": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals",
    "title_was": "homebrew: docbuild crashes, libtcl AtForkPrepare",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434171"
}
```



---

archive/issue_comments_502520.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nWith this change, the documentation builds for me (but of course it is missing a plot):\n\n```diff\ndiff --git a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst\nindex 9faa9f2375..bc77d72e68 100644\n--- a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst\n+++ b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst\n@@ -94,7 +94,6 @@ Vector fields can be plotted::\n     E = EuclideanSpace(3)\n     x, y, z = E.default_chart()[:]\n     v = E.vector_field(-y, x, sin(x*y*z), name='v')\n-    sphinx_plot(v.plot(max_range=1.5, scale=0.5))\n \n For customizing the plot, see the list of options in the documentation of\n :meth:`~sage.manifolds.differentiable.vectorfield.VectorField.plot`.\n```",
    "created_at": "2021-02-06T04:48:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502520",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:19" align="right">comment:19</div>

With this change, the documentation builds for me (but of course it is missing a plot):

```diff
diff --git a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst
index 9faa9f2375..bc77d72e68 100644
--- a/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst
+++ b/src/doc/en/thematic_tutorials/vector_calculus/vector_calc_cartesian.rst
@@ -94,7 +94,6 @@ Vector fields can be plotted::
     E = EuclideanSpace(3)
     x, y, z = E.default_chart()[:]
     v = E.vector_field(-y, x, sin(x*y*z), name='v')
-    sphinx_plot(v.plot(max_range=1.5, scale=0.5))
 
 For customizing the plot, see the list of options in the documentation of
 :meth:`~sage.manifolds.differentiable.vectorfield.VectorField.plot`.
```



---

archive/issue_comments_502521.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThis does not seem to help on my machine",
    "created_at": "2021-02-06T07:20:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502521",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

This does not seem to help on my machine



---

archive/issue_comments_502522.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nSorry, it turns out that it doesn't consistently help on mine, either. I think this should stop the non-reference manual docs from being built in parallel:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py\nindex b07e9c100c..1d4139555e 100644\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -286,13 +286,15 @@ class DocBuilder(object):\n \n from .utils import build_many as _build_many\n \n-def build_many(target, args):\n+def build_many(target, args, processes=None):\n     \"\"\"\n     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the\n     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.\n     \"\"\"\n+    if processes is None:\n+        processes = NUM_THREADS\n     try:\n-        _build_many(target, args, processes=NUM_THREADS)\n+        _build_many(target, args, processes=processes)\n     except BaseException as exc:\n         if ABORT_ON_ERROR:\n             raise\n@@ -349,7 +351,7 @@ class AllBuilder(object):\n \n         # build the other documents in parallel\n         L = [(doc, name, kwds) + args for doc in others]\n-        build_many(build_other_doc, L)\n+        build_many(build_other_doc, L, 1)\n         logger.warning(\"Elapsed time: %.1f seconds.\"%(time.time()-start))\n         logger.warning(\"Done building the documentation!\")\n```",
    "created_at": "2021-02-07T01:17:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502522",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

Sorry, it turns out that it doesn't consistently help on mine, either. I think this should stop the non-reference manual docs from being built in parallel:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index b07e9c100c..1d4139555e 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -286,13 +286,15 @@ class DocBuilder(object):
 
 from .utils import build_many as _build_many
 
-def build_many(target, args):
+def build_many(target, args, processes=None):
     """
     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the
     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.
     """
+    if processes is None:
+        processes = NUM_THREADS
     try:
-        _build_many(target, args, processes=NUM_THREADS)
+        _build_many(target, args, processes=processes)
     except BaseException as exc:
         if ABORT_ON_ERROR:
             raise
@@ -349,7 +351,7 @@ class AllBuilder(object):
 
         # build the other documents in parallel
         L = [(doc, name, kwds) + args for doc in others]
-        build_many(build_other_doc, L)
+        build_many(build_other_doc, L, 1)
         logger.warning("Elapsed time: %.1f seconds."%(time.time()-start))
         logger.warning("Done building the documentation!")
```



---

archive/issue_comments_502523.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\n#31289 doesn't seem to help, by the way.",
    "created_at": "2021-02-07T03:00:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502523",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

#31289 doesn't seem to help, by the way.



---

archive/issue_comments_502524.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nPerhaps conditionalize this change on macOS?",
    "created_at": "2021-02-07T17:37:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502524",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Perhaps conditionalize this change on macOS?



---

archive/issue_comments_502525.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI've pushed this change to the branch of #31335, but it does not actually fix the problem for me. I'll try next if replacing the `build_many` by a `for` loop helps.",
    "created_at": "2021-02-07T19:06:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502525",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

I've pushed this change to the branch of #31335, but it does not actually fix the problem for me. I'll try next if replacing the `build_many` by a `for` loop helps.



---

archive/issue_comments_502526.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\n(retracted)",
    "created_at": "2021-02-07T19:06:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502526",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

(retracted)



---

archive/issue_events_434172.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-07T19:24:12Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "title_is": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals / multiprocessing",
    "title_was": "homebrew: docbuild crashes, libtcl AtForkPrepare - from sage.misc.cython globals",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434172"
}
```



---

archive/issue_comments_502527.json:
```json
{
    "body": "<div id=\"comment:27\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/515f89934e3b6d5daaa9a54684a4fb374289b978\"><code>515f899</code></a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/804ebd7689fe8423e901e8ecf38dd62a7a9b8789\"><code>804ebd7</code></a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a\"><code>b4ceee5</code></a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr></table>\n",
    "created_at": "2021-02-07T19:25:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502527",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:27"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/515f89934e3b6d5daaa9a54684a4fb374289b978"><code>515f899</code></a></td><td><code>sage_setup.docbuild.AllBuilder: stop the non-reference manual docs from being built in parallel</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/804ebd7689fe8423e901e8ecf38dd62a7a9b8789"><code>804ebd7</code></a></td><td><code>sage_setup.dpcbuild.AllBuilder: Restrict workaround to macOS</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a"><code>b4ceee5</code></a></td><td><code>sage_setup.docbuild: In the workaround, do not go through build_many to build serially</code></td></tr></table>




---

archive/issue_comments_502528.json:
```json
{
    "body": "Changed commit from **[`80720d7`](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)** to **[`b4ceee5`](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)**",
    "created_at": "2021-02-07T19:25:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502528",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`80720d7`](https://github.com/sagemath/sagetrac-mirror/commit/80720d7bcc0b1de4b92984fa62d52dad5855b9b0)** to **[`b4ceee5`](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)**



---

archive/issue_comments_502529.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nThis fixes the problem on my machine. Please test on Big Sur",
    "created_at": "2021-02-07T19:26:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502529",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

This fixes the problem on my machine. Please test on Big Sur



---

archive/issue_events_434173.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-07T19:27:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434173"
}
```



---

archive/issue_events_434174.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-07T19:27:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434174"
}
```



---

archive/issue_comments_502530.json:
```json
{
    "body": "Changed author from **Matthias Koeppe** to **Matthias Koeppe, John Palmieri**",
    "created_at": "2021-02-07T19:27:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502530",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Matthias Koeppe** to **Matthias Koeppe, John Palmieri**



---

archive/issue_comments_502531.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nWorked for me on Big Sur",
    "created_at": "2021-02-08T00:03:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502531",
    "user": "https://github.com/zlscherr"
}
```

<div id="comment:31" align="right">comment:31</div>

Worked for me on Big Sur



---

archive/issue_comments_502532.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2021-02-08T03:14:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502532",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_events_434175.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-02-08T03:14:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434175"
}
```



---

archive/issue_events_434176.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-02-08T03:14:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434176"
}
```



---

archive/issue_comments_502533.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nThis works for me, too. It would be nice to know that the actual problem is beyond \"some murky issue with parallel docbuilding on OS X,\" but it's good enough to merge. @zlscherr, feel free to add your real name to the reviewers field (and also to the [wiki page](https://trac.sagemath.org/wiki), if you want).",
    "created_at": "2021-02-08T03:14:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502533",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:32" align="right">comment:32</div>

This works for me, too. It would be nice to know that the actual problem is beyond "some murky issue with parallel docbuilding on OS X," but it's good enough to merge. @zlscherr, feel free to add your real name to the reviewers field (and also to the [wiki page](https://trac.sagemath.org/wiki), if you want).



---

archive/issue_comments_502534.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nThanks!",
    "created_at": "2021-02-08T04:19:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502534",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:33" align="right">comment:33</div>

Thanks!



---

archive/issue_comments_502535.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nthis fixed the docbuild crash on my Big Sur bix too",
    "created_at": "2021-02-08T12:03:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502535",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:34" align="right">comment:34</div>

this fixed the docbuild crash on my Big Sur bix too



---

archive/issue_comments_502536.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nOn macOS 10.14.6: dochtml builds with this, while it does not with 9.3.beta7 or #31419.",
    "created_at": "2021-02-21T08:10:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502536",
    "user": "https://github.com/slel"
}
```

<div id="comment:35" align="right">comment:35</div>

On macOS 10.14.6: dochtml builds with this, while it does not with 9.3.beta7 or #31419.



---

archive/issue_events_434177.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-01T00:24:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434177"
}
```



---

archive/issue_events_434178.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "f2fea77292f0aebcabdbe69dfa0c9ae97a713c3e",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-03-01T00:24:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31344#event-434178"
}
```



---

archive/issue_comments_502537.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)** to **[`b4ceee5`](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)**",
    "created_at": "2021-03-01T00:24:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31344",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31344#issuecomment-502537",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/homebrew__docbuild_crashes__libtcl_atforkprepare)** to **[`b4ceee5`](https://github.com/sagemath/sagetrac-mirror/commit/b4ceee5dae4caa7dac7a6fe7ca29538aca2d381a)**
