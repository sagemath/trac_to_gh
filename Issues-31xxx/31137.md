# Issue 31137: Fix subs failure involving integer-valued rational exponents

archive/issues_030900.json:
```json
{
    "assignees": [],
    "body": "From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):\n`subs` fails with a memory error (or doesn't return) on some expressions.\n\nThe following works fine:\n\n```\nsage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\nsage: a = I*R^2*f^3*k*q*A*u\nsage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q\nsage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3\nsage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2\nsage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f\nsage: expr = a / ((b + c + d + e)*n)\nsage: R1 = (expr.real()^2 + expr.imag()^2).factor()\nsage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()\nsage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()\nsage: all((R1 == R2, R1 == R3, R2 == R3))\nTrue\n```\n\nThese expressions have the same string representation:\n\n```\nsage: [len(str(ex)) for ex in (R1, R2, R3)]\n[734, 734, 734]\nsage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n```\n\nSubstituting `f = 2*beta` in `R1` `R2` `R3` works:\n\n```\nsage: R1s = R1.subs(f = 2*beta)\nsage: R2s = R2.subs(f = 2*beta)\nsage: R3s = R3.subs(f = 2*beta)\n```\n\nHowever, the following **never return**:\n\n```\nsage: bool(R3s == R1s)  # hangs\n```\n\n```\nsage: len(str(R1s))\n520\nsage: len(str(R2s))\n520\nsage: len(str(R3s))  # hangs\n```\n\nAttempting to interrupt the last call can result in a Sage crash;\nthe original poster reports a \"Memory Error\" exception.\n\nAs a comparison, substituting in `R3` via SymPy works:\n\n```\nsage: import sympy\nsage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\nTrue\n```\nbut seems to fail via Mathematica somehow:\n\n```\nsage: mma = mathematica\nsage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))\nFalse\n```\n\nPriority set to critical, because it affects a very basic feature of Sage.\n\n---\n\nRESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.\n\nDepends on #30786\nDepends on #30446\n\nCC:  @slel\n\nKeywords: **factor**\n\nBranch/Commit: **[c2b45c0](https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9)**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Dave Morris**\n\nComponent: **symbolics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/31137_\n\n",
    "closed_at": "2021-03-09T00:00:32Z",
    "created_at": "2020-12-30T07:40:02Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
        "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix subs failure involving integer-valued rational exponents",
    "type": "issue",
    "updated_at": "2021-03-09T00:00:32Z",
    "url": "https://github.com/sagemath/sage/issues/31137",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):
`subs` fails with a memory error (or doesn't return) on some expressions.

The following works fine:

```
sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
sage: a = I*R^2*f^3*k*q*A*u
sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q
sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3
sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2
sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f
sage: expr = a / ((b + c + d + e)*n)
sage: R1 = (expr.real()^2 + expr.imag()^2).factor()
sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()
sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()
sage: all((R1 == R2, R1 == R3, R2 == R3))
True
```

These expressions have the same string representation:

```
sage: [len(str(ex)) for ex in (R1, R2, R3)]
[734, 734, 734]
sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
```

Substituting `f = 2*beta` in `R1` `R2` `R3` works:

```
sage: R1s = R1.subs(f = 2*beta)
sage: R2s = R2.subs(f = 2*beta)
sage: R3s = R3.subs(f = 2*beta)
```

However, the following **never return**:

```
sage: bool(R3s == R1s)  # hangs
```

```
sage: len(str(R1s))
520
sage: len(str(R2s))
520
sage: len(str(R3s))  # hangs
```

Attempting to interrupt the last call can result in a Sage crash;
the original poster reports a "Memory Error" exception.

As a comparison, substituting in `R3` via SymPy works:

```
sage: import sympy
sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
True
```
but seems to fail via Mathematica somehow:

```
sage: mma = mathematica
sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))
False
```

Priority set to critical, because it affects a very basic feature of Sage.

---

RESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.

Depends on #30786
Depends on #30446

CC:  @slel

Keywords: **factor**

Branch/Commit: **[c2b45c0](https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9)**

Reviewer: **Dima Pasechnik**

Author: **Dave Morris**

Component: **symbolics**

_Issue created by migration from https://trac.sagemath.org/ticket/31137_





---

archive/issue_events_429329.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-12-30T07:40:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429329"
}
```



---

archive/issue_events_429330.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-12-30T07:40:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "c: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429330"
}
```



---

archive/issue_events_429331.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-12-30T07:40:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429331"
}
```



---

archive/issue_events_429332.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-12-30T07:40:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429332"
}
```



---

archive/issue_comments_499091.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nSeems to have a lot to do with `factor`.\n\nI also got a crash when interrupting the computation:\n\n```\nKeyboardInterrupt:\nException ignored in: 'sage.libs.pynac.pynac.py_repr'\nTraceback (most recent call last):\n  File \"sage/rings/integer.pyx\", line 1013, in sage.rings.integer.Integer.__repr__ (build/cythonized/sage/rings/integer.\nc:8427)\n  File \"sage/rings/integer.pyx\", line 1134, in sage.rings.integer.Integer.str (build/cythonized/sage/rings/integer.c:901\n1)\nKeyboardInterrupt:\n------------------------------------------------------------------------\n...\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\nSegmentation fault\n```",
    "created_at": "2020-12-31T13:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499091",
    "user": "https://github.com/slel"
}
```

<div id="comment:1" align="right">comment:1</div>

Seems to have a lot to do with `factor`.

I also got a crash when interrupting the computation:

```
KeyboardInterrupt:
Exception ignored in: 'sage.libs.pynac.pynac.py_repr'
Traceback (most recent call last):
  File "sage/rings/integer.pyx", line 1013, in sage.rings.integer.Integer.__repr__ (build/cythonized/sage/rings/integer.
c:8427)
  File "sage/rings/integer.pyx", line 1134, in sage.rings.integer.Integer.str (build/cythonized/sage/rings/integer.c:901
1)
KeyboardInterrupt:
------------------------------------------------------------------------
...
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```



---

archive/issue_comments_499092.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,45 +1,62 @@\n-Reported in this `ask.sagemath` [question](https://ask.sagemath.org/question/54986/expression-substitution-fails-why/) : `subs` fails with `Memoy error` (or doesn't return) on some expressions :\n+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):\n+`subs` fails with a memory error (or doesn't return) on some expressions.\n+\n+The following works fine:\n \n ```\n-    sage: var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n-    (A, L, G, R, f, k, n, q, u, beta, gamma)\n-    sage: expr_complex = (I*R^2*f^3*k*q*A*u/ ((2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q + (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3 + 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2+ (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f)*n))\n-    sage: R1=(expr_complex.real()^2+expr_complex.imag()^2).factor()\n-    sage: R2=(sqrt(expr_complex.real()^2+expr_complex.imag()^2)^2).factor()\n-    sage: bool(R1==R2)\n-    True\n-    sage: R3=((sqrt(expr_complex.real()^2+expr_complex.imag()^2).factor())^2).factor()\n-    sage: bool(R1==R3)\n-    True\n-    sage: bool(R2==R3)\n-    True\n+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n+sage: a = I*R^2*f^3*k*q*A*u\n+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q\n+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3\n+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2\n+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f\n+sage: expr = a / ((b + c + d + e)*n)\n+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()\n+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()\n+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()\n+sage: all((R1 == R2, R1 == R3, R2 == R3))\n+True\n ```\n \n-So far, so good. But, whereas :\n+These expressions have the same string representation:\n \n ```\n-    sage: import sympy\n-    sage: bool(sympy.sympify(R3).subs(f,2*beta)._sage_()==R1.subs(f=2*beta))\n-    True\n+sage: [len(str(ex)) for ex in (R1, R2, R3)]\n+[734, 734, 734]\n+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n ```\n \n-works, `mathematica` seems to fail somehow (more troubling) : :\n+Substituting `f = 2*beta` in `R1` and `R3` works:\n \n ```\n-    sage: bool(mathematica.Replace(R3,mathematica.Rule(f,2*beta)).sage()==R1.subs(f=2*beta))\n-    False\n+sage: R1s = R1.subs(f = 2*beta)\n+sage: R3s = R3.subs(f = 2*beta)\n ```\n \n-And (case in point), \n+However, the following **never returns**:\n \n ```\n-    sage: bool(R3.subs(f=2*beta)==R1.subs(f=2*beta))\n+sage: bool(R3s == R1s)\n ```\n \n-**never returns.**\n+Attempting to interrupt the last call can result in a Sage crash;\n+the original poster reports a \"Memory Error\" exception.\n \n-(A previous attempt to interrupt the last call resulted in a Sage crash, which I was unable to reproduce ; the original poster reports a \"Memory Error\" exception, which I couldn't reproduce either).\n+As a comparison, SymPy can do it:\n+\n+```\n+sage: import sympy\n+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\n+True\n+```\n+and Mathematica seems to fail somehow:\n+\n+```\n+sage: mma = mathematica\n+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))\n+False\n+```\n \n Possibly related : #30378\n \n-Priority set to `critical`, because it affects a very basic feature of `Sage`.\n+Priority set to critical, because it affects a very basic feature of Sage.\n``````\n",
    "created_at": "2020-12-31T13:50:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499092",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,45 +1,62 @@
-Reported in this `ask.sagemath` [question](https://ask.sagemath.org/question/54986/expression-substitution-fails-why/) : `subs` fails with `Memoy error` (or doesn't return) on some expressions :
+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):
+`subs` fails with a memory error (or doesn't return) on some expressions.
+
+The following works fine:
 
 ```
-    sage: var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
-    (A, L, G, R, f, k, n, q, u, beta, gamma)
-    sage: expr_complex = (I*R^2*f^3*k*q*A*u/ ((2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q + (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3 + 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2+ (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f)*n))
-    sage: R1=(expr_complex.real()^2+expr_complex.imag()^2).factor()
-    sage: R2=(sqrt(expr_complex.real()^2+expr_complex.imag()^2)^2).factor()
-    sage: bool(R1==R2)
-    True
-    sage: R3=((sqrt(expr_complex.real()^2+expr_complex.imag()^2).factor())^2).factor()
-    sage: bool(R1==R3)
-    True
-    sage: bool(R2==R3)
-    True
+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
+sage: a = I*R^2*f^3*k*q*A*u
+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q
+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3
+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2
+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f
+sage: expr = a / ((b + c + d + e)*n)
+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()
+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()
+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()
+sage: all((R1 == R2, R1 == R3, R2 == R3))
+True
 ```
 
-So far, so good. But, whereas :
+These expressions have the same string representation:
 
 ```
-    sage: import sympy
-    sage: bool(sympy.sympify(R3).subs(f,2*beta)._sage_()==R1.subs(f=2*beta))
-    True
+sage: [len(str(ex)) for ex in (R1, R2, R3)]
+[734, 734, 734]
+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
 ```
 
-works, `mathematica` seems to fail somehow (more troubling) : :
+Substituting `f = 2*beta` in `R1` and `R3` works:
 
 ```
-    sage: bool(mathematica.Replace(R3,mathematica.Rule(f,2*beta)).sage()==R1.subs(f=2*beta))
-    False
+sage: R1s = R1.subs(f = 2*beta)
+sage: R3s = R3.subs(f = 2*beta)
 ```
 
-And (case in point), 
+However, the following **never returns**:
 
 ```
-    sage: bool(R3.subs(f=2*beta)==R1.subs(f=2*beta))
+sage: bool(R3s == R1s)
 ```
 
-**never returns.**
+Attempting to interrupt the last call can result in a Sage crash;
+the original poster reports a "Memory Error" exception.
 
-(A previous attempt to interrupt the last call resulted in a Sage crash, which I was unable to reproduce ; the original poster reports a "Memory Error" exception, which I couldn't reproduce either).
+As a comparison, SymPy can do it:
+
+```
+sage: import sympy
+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
+True
+```
+and Mathematica seems to fail somehow:
+
+```
+sage: mma = mathematica
+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))
+False
+```
 
 Possibly related : #30378
 
-Priority set to `critical`, because it affects a very basic feature of `Sage`.
+Priority set to critical, because it affects a very basic feature of Sage.
``````




---

archive/issue_comments_499093.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -26,30 +26,39 @@\n sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n ```\n \n-Substituting `f = 2*beta` in `R1` and `R3` works:\n+Substituting `f = 2*beta` in `R1` `R2` `R3` works:\n \n ```\n sage: R1s = R1.subs(f = 2*beta)\n+sage: R2s = R2.subs(f = 2*beta)\n sage: R3s = R3.subs(f = 2*beta)\n ```\n \n-However, the following **never returns**:\n+However, the following **never return**:\n \n ```\n-sage: bool(R3s == R1s)\n+sage: bool(R3s == R1s)  # hangs\n+```\n+\n+```\n+sage: len(str(R1s))\n+520\n+sage: len(str(R2s))\n+520\n+sage: len(str(R3s))  # hangs\n ```\n \n Attempting to interrupt the last call can result in a Sage crash;\n the original poster reports a \"Memory Error\" exception.\n \n-As a comparison, SymPy can do it:\n+As a comparison, substituting in `R3` via SymPy works:\n \n ```\n sage: import sympy\n sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\n True\n ```\n-and Mathematica seems to fail somehow:\n+but seems to fail via Mathematica somehow:\n \n ```\n sage: mma = mathematica\n``````\n",
    "created_at": "2020-12-31T14:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499093",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -26,30 +26,39 @@
 sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
 ```
 
-Substituting `f = 2*beta` in `R1` and `R3` works:
+Substituting `f = 2*beta` in `R1` `R2` `R3` works:
 
 ```
 sage: R1s = R1.subs(f = 2*beta)
+sage: R2s = R2.subs(f = 2*beta)
 sage: R3s = R3.subs(f = 2*beta)
 ```
 
-However, the following **never returns**:
+However, the following **never return**:
 
 ```
-sage: bool(R3s == R1s)
+sage: bool(R3s == R1s)  # hangs
+```
+
+```
+sage: len(str(R1s))
+520
+sage: len(str(R2s))
+520
+sage: len(str(R3s))  # hangs
 ```
 
 Attempting to interrupt the last call can result in a Sage crash;
 the original poster reports a "Memory Error" exception.
 
-As a comparison, SymPy can do it:
+As a comparison, substituting in `R3` via SymPy works:
 
 ```
 sage: import sympy
 sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
 True
 ```
-and Mathematica seems to fail somehow:
+but seems to fail via Mathematica somehow:
 
 ```
 sage: mma = mathematica
``````




---

archive/issue_comments_499094.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nSeems expressions resulting from `factor` behave strangely.\nNot sure what role `subs` plays here.",
    "created_at": "2020-12-31T14:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499094",
    "user": "https://github.com/slel"
}
```

<div id="comment:2" align="right">comment:2</div>

Seems expressions resulting from `factor` behave strangely.
Not sure what role `subs` plays here.



---

archive/issue_comments_499095.json:
```json
{
    "body": "Changed keywords from none to **factor**",
    "created_at": "2020-12-31T14:04:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499095",
    "user": "https://github.com/slel"
}
```

Changed keywords from none to **factor**



---

archive/issue_comments_499096.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nWhat seemed to be hanging was just taking a long time.\nStill, the result is surprising.\n\n```\nsage: len(str(R3s))  # long time -- 1,292,914,505\n1292914505\n```",
    "created_at": "2020-12-31T14:11:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499096",
    "user": "https://github.com/slel"
}
```

<div id="comment:3" align="right">comment:3</div>

What seemed to be hanging was just taking a long time.
Still, the result is surprising.

```
sage: len(str(R3s))  # long time -- 1,292,914,505
1292914505
```



---

archive/issue_comments_499097.json:
```json
{
    "body": "Branch: **[public/31137](https://github.com/sagemath/sagetrac-mirror/tree/public/31137)**",
    "created_at": "2021-01-12T02:20:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499097",
    "user": "https://github.com/DaveWitteMorris"
}
```

Branch: **[public/31137](https://github.com/sagemath/sagetrac-mirror/tree/public/31137)**



---

archive/issue_events_429333.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-01-12T02:25:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429333"
}
```



---

archive/issue_events_429334.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-01-12T02:25:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429334"
}
```



---

archive/issue_comments_499098.json:
```json
{
    "body": "Dependencies: **#30786**",
    "created_at": "2021-01-12T02:25:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499098",
    "user": "https://github.com/DaveWitteMorris"
}
```

Dependencies: **#30786**



---

archive/issue_comments_499099.json:
```json
{
    "body": "Author: **Dave Morris**",
    "created_at": "2021-01-12T02:25:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499099",
    "user": "https://github.com/DaveWitteMorris"
}
```

Author: **Dave Morris**



---

archive/issue_comments_499100.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nThe problem in this ticket seems to be solved by the patch to pynac in #30446. The PR just adds a doctest. It is based on #30786 in order to avoid a merge conflict.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dc073dfa9224efb61dc01d49ef60a9c7fa0dc568\">dc073df</a></td><td><code>fixes for trac #30446</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4a5d0536a91fd3ef538c3430e3b668c75272225d\">4a5d053</a></td><td><code>doctests for trac 28620, 30304, 30786</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5da750a7fca49b55bd131585f0c620490611834b\">5da750a</a></td><td><code>doctest for trac 31137</code></td></tr></table>\n",
    "created_at": "2021-01-12T02:25:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499100",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:5" align="right">comment:5</div>

The problem in this ticket seems to be solved by the patch to pynac in #30446. The PR just adds a doctest. It is based on #30786 in order to avoid a merge conflict.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dc073dfa9224efb61dc01d49ef60a9c7fa0dc568">dc073df</a></td><td><code>fixes for trac #30446</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4a5d0536a91fd3ef538c3430e3b668c75272225d">4a5d053</a></td><td><code>doctests for trac 28620, 30304, 30786</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5da750a7fca49b55bd131585f0c620490611834b">5da750a</a></td><td><code>doctest for trac 31137</code></td></tr></table>




---

archive/issue_events_429335.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-01-12T02:25:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429335"
}
```



---

archive/issue_comments_499101.json:
```json
{
    "body": "Commit: **[5da750a](https://github.com/sagemath/sagetrac-mirror/commit/5da750a7fca49b55bd131585f0c620490611834b)**",
    "created_at": "2021-01-12T02:25:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499101",
    "user": "https://github.com/DaveWitteMorris"
}
```

Commit: **[5da750a](https://github.com/sagemath/sagetrac-mirror/commit/5da750a7fca49b55bd131585f0c620490611834b)**



---

archive/issue_events_429336.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-24T19:57:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429336"
}
```



---

archive/issue_events_429337.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-24T19:57:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429337"
}
```



---

archive/issue_comments_499102.json:
```json
{
    "body": "Changed dependencies from **#30786** to **#30786, #30446**",
    "created_at": "2021-01-24T19:57:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499102",
    "user": "https://github.com/dimpase"
}
```

Changed dependencies from **#30786** to **#30786, #30446**



---

archive/issue_comments_499103.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nonly the patch for expression.pyx is needed here, with the rest in #30446",
    "created_at": "2021-01-24T19:57:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499103",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:6" align="right">comment:6</div>

only the patch for expression.pyx is needed here, with the rest in #30446



---

archive/issue_comments_499104.json:
```json
{
    "body": "Changed commit from **[5da750a](https://github.com/sagemath/sagetrac-mirror/commit/5da750a7fca49b55bd131585f0c620490611834b)** to **[c2b45c0](https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9)**",
    "created_at": "2021-01-24T22:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499104",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5da750a](https://github.com/sagemath/sagetrac-mirror/commit/5da750a7fca49b55bd131585f0c620490611834b)** to **[c2b45c0](https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9)**



---

archive/issue_comments_499105.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f74f66c31a358b3ff5dd2381ce4b7c1f5899858d\">f74f66c</a></td><td><code>sage --package update-latest: Accept package classes :standard:, :optional: etc., restrict to normal Python packages</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/182b3d22106e206a95d9ffbf2104f5c2a32dd3b5\">182b3d2</a></td><td><code>sage -package fix-checksum: Handle package classes, ignore non-normal packages</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a57cf605cfab70a449b8a86ca2ac87f7f7d9a07\">9a57cf6</a></td><td><code>pynac update</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/563940e8554fe96a16fdf669c03f895aacf27b3c\">563940e</a></td><td><code>doctest from #30446</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/51def3cc9203861a11404019d68ed90937d9f017\">51def3c</a></td><td><code>sane version name</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4834dc8a7ab300c57921986e847972030b0547ca\">4834dc8</a></td><td><code>remove upstreamed patch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/214712de4fd44f9e703cfffc7cccced7b5757a12\">214712d</a></td><td><code>tarball update</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6ee3113a288a36519ed1a4b0adbd19250404874b\">6ee3113</a></td><td><code>doctests for trac 28620, 30304, 30786</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6161215aef860deffaffd0227c1cd0f71af7a033\">6161215</a></td><td><code>fixes for trac #30446</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9\">c2b45c0</a></td><td><code>doctest for trac 31137</code></td></tr></table>\n",
    "created_at": "2021-01-24T22:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499105",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f74f66c31a358b3ff5dd2381ce4b7c1f5899858d">f74f66c</a></td><td><code>sage --package update-latest: Accept package classes :standard:, :optional: etc., restrict to normal Python packages</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/182b3d22106e206a95d9ffbf2104f5c2a32dd3b5">182b3d2</a></td><td><code>sage -package fix-checksum: Handle package classes, ignore non-normal packages</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a57cf605cfab70a449b8a86ca2ac87f7f7d9a07">9a57cf6</a></td><td><code>pynac update</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/563940e8554fe96a16fdf669c03f895aacf27b3c">563940e</a></td><td><code>doctest from #30446</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/51def3cc9203861a11404019d68ed90937d9f017">51def3c</a></td><td><code>sane version name</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4834dc8a7ab300c57921986e847972030b0547ca">4834dc8</a></td><td><code>remove upstreamed patch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/214712de4fd44f9e703cfffc7cccced7b5757a12">214712d</a></td><td><code>tarball update</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6ee3113a288a36519ed1a4b0adbd19250404874b">6ee3113</a></td><td><code>doctests for trac 28620, 30304, 30786</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6161215aef860deffaffd0227c1cd0f71af7a033">6161215</a></td><td><code>fixes for trac #30446</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9">c2b45c0</a></td><td><code>doctest for trac 31137</code></td></tr></table>




---

archive/issue_events_429338.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-24T22:24:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429338"
}
```



---

archive/issue_events_429339.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-24T22:24:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429339"
}
```



---

archive/issue_comments_499106.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nLGTM",
    "created_at": "2021-01-24T22:24:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499106",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

LGTM



---

archive/issue_comments_499107.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-01-24T22:24:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499107",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_499108.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nCan we improve the ticket summary and ticket description?",
    "created_at": "2021-01-25T08:26:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499108",
    "user": "https://github.com/slel"
}
```

<div id="comment:9" align="right">comment:9</div>

Can we improve the ticket summary and ticket description?



---

archive/issue_comments_499109.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nit just adds an extra doctest, which used to fail before #30446",
    "created_at": "2021-01-25T09:57:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499109",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:10" align="right">comment:10</div>

it just adds an extra doctest, which used to fail before #30446



---

archive/issue_comments_499110.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -66,6 +66,8 @@\n False\n ```\n \n-Possibly related : #30378\n+Priority set to critical, because it affects a very basic feature of Sage.\n \n-Priority set to critical, because it affects a very basic feature of Sage.\n+===================\n+\n+RESOLUTION: The problem was solved by the patch to pynac in #30446. This means that the problem was due to a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. The pull request of this ticket just adds a doctest to ensure that the problem is not allowed to return.\n``````\n",
    "created_at": "2021-01-25T18:39:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499110",
    "user": "https://github.com/DaveWitteMorris"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -66,6 +66,8 @@
 False
 ```
 
-Possibly related : #30378
+Priority set to critical, because it affects a very basic feature of Sage.
 
-Priority set to critical, because it affects a very basic feature of Sage.
+===================
+
+RESOLUTION: The problem was solved by the patch to pynac in #30446. This means that the problem was due to a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. The pull request of this ticket just adds a doctest to ensure that the problem is not allowed to return.
``````




---

archive/issue_events_429340.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-01-25T20:07:56Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "title_is": "Fix subs failure involving integer-valued rational exponents",
    "title_was": "subs fails in obscure circumstances",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429340"
}
```



---

archive/issue_comments_499111.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThanks for the explanation.",
    "created_at": "2021-01-25T20:07:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499111",
    "user": "https://github.com/slel"
}
```

<div id="comment:12" align="right">comment:12</div>

Thanks for the explanation.



---

archive/issue_comments_499112.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -68,6 +68,6 @@\n \n Priority set to critical, because it affects a very basic feature of Sage.\n \n-===================\n+---\n \n-RESOLUTION: The problem was solved by the patch to pynac in #30446. This means that the problem was due to a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. The pull request of this ticket just adds a doctest to ensure that the problem is not allowed to return.\n+RESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.\n``````\n",
    "created_at": "2021-01-25T20:07:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499112",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -68,6 +68,6 @@
 
 Priority set to critical, because it affects a very basic feature of Sage.
 
-===================
+---
 
-RESOLUTION: The problem was solved by the patch to pynac in #30446. This means that the problem was due to a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. The pull request of this ticket just adds a doctest to ensure that the problem is not allowed to return.
+RESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.
``````




---

archive/issue_events_429341.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-09T00:00:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429341"
}
```



---

archive/issue_events_429342.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "b4d5f03f683ffc4a33147b99cacb380b03ac9a89",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-03-09T00:00:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/31137#event-429342"
}
```



---

archive/issue_comments_499113.json:
```json
{
    "body": "Changed branch from **[public/31137](https://github.com/sagemath/sagetrac-mirror/tree/public/31137)** to **[c2b45c0](https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9)**",
    "created_at": "2021-03-09T00:00:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/31137#issuecomment-499113",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/31137](https://github.com/sagemath/sagetrac-mirror/tree/public/31137)** to **[c2b45c0](https://github.com/sagemath/sagetrac-mirror/commit/c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9)**
