# Issue 31137: Fix subs failure involving integer-valued rational exponents

archive/issues_030900.json:
```json
{
    "body": "From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):\n`subs` fails with a memory error (or doesn't return) on some expressions.\n\nThe following works fine:\n\n```\nsage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\nsage: a = I*R^2*f^3*k*q*A*u\nsage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q\nsage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3\nsage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2\nsage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f\nsage: expr = a / ((b + c + d + e)*n)\nsage: R1 = (expr.real()^2 + expr.imag()^2).factor()\nsage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()\nsage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()\nsage: all((R1 == R2, R1 == R3, R2 == R3))\nTrue\n```\n\nThese expressions have the same string representation:\n\n```\nsage: [len(str(ex)) for ex in (R1, R2, R3)]\n[734, 734, 734]\nsage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n```\n\nSubstituting `f = 2*beta` in `R1` `R2` `R3` works:\n\n```\nsage: R1s = R1.subs(f = 2*beta)\nsage: R2s = R2.subs(f = 2*beta)\nsage: R3s = R3.subs(f = 2*beta)\n```\n\nHowever, the following **never return**:\n\n```\nsage: bool(R3s == R1s)  # hangs\n```\n\n```\nsage: len(str(R1s))\n520\nsage: len(str(R2s))\n520\nsage: len(str(R3s))  # hangs\n```\n\nAttempting to interrupt the last call can result in a Sage crash;\nthe original poster reports a \"Memory Error\" exception.\n\nAs a comparison, substituting in `R3` via SymPy works:\n\n```\nsage: import sympy\nsage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\nTrue\n```\nbut seems to fail via Mathematica somehow:\n\n```\nsage: mma = mathematica\nsage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))\nFalse\n```\n\nPriority set to critical, because it affects a very basic feature of Sage.\n\n---\n\nRESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.\n\nCC:  @slel\n\nKeywords: factor\n\nBranch/Commit: c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9\n\nReviewer: Dima Pasechnik\n\nAuthor: Dave Morris\n\nDependencies: #30786, #30446\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31137\n\n",
    "closed_at": "2021-03-09T00:00:32Z",
    "created_at": "2020-12-30T07:40:02Z",
    "labels": [
        "component: symbolics",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Fix subs failure involving integer-valued rational exponents",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31137",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):
`subs` fails with a memory error (or doesn't return) on some expressions.

The following works fine:

```
sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
sage: a = I*R^2*f^3*k*q*A*u
sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q
sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3
sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2
sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f
sage: expr = a / ((b + c + d + e)*n)
sage: R1 = (expr.real()^2 + expr.imag()^2).factor()
sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()
sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()
sage: all((R1 == R2, R1 == R3, R2 == R3))
True
```

These expressions have the same string representation:

```
sage: [len(str(ex)) for ex in (R1, R2, R3)]
[734, 734, 734]
sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
```

Substituting `f = 2*beta` in `R1` `R2` `R3` works:

```
sage: R1s = R1.subs(f = 2*beta)
sage: R2s = R2.subs(f = 2*beta)
sage: R3s = R3.subs(f = 2*beta)
```

However, the following **never return**:

```
sage: bool(R3s == R1s)  # hangs
```

```
sage: len(str(R1s))
520
sage: len(str(R2s))
520
sage: len(str(R3s))  # hangs
```

Attempting to interrupt the last call can result in a Sage crash;
the original poster reports a "Memory Error" exception.

As a comparison, substituting in `R3` via SymPy works:

```
sage: import sympy
sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
True
```
but seems to fail via Mathematica somehow:

```
sage: mma = mathematica
sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))
False
```

Priority set to critical, because it affects a very basic feature of Sage.

---

RESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.

CC:  @slel

Keywords: factor

Branch/Commit: c2b45c0b3181ff8803e116e4c92ecf4c4bd748d9

Reviewer: Dima Pasechnik

Author: Dave Morris

Dependencies: #30786, #30446

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31137





---

archive/issue_comments_471126.json:
```json
{
    "body": "<a id='comment:1'></a>Seems to have a lot to do with `factor`.\n\nI also got a crash when interrupting the computation:\n\n```\nKeyboardInterrupt:\nException ignored in: 'sage.libs.pynac.pynac.py_repr'\nTraceback (most recent call last):\n  File \"sage/rings/integer.pyx\", line 1013, in sage.rings.integer.Integer.__repr__ (build/cythonized/sage/rings/integer.\nc:8427)\n  File \"sage/rings/integer.pyx\", line 1134, in sage.rings.integer.Integer.str (build/cythonized/sage/rings/integer.c:901\n1)\nKeyboardInterrupt:\n------------------------------------------------------------------------\n...\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\nSegmentation fault\n```",
    "created_at": "2020-12-31T13:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471126",
    "user": "https://github.com/slel"
}
```

<a id='comment:1'></a>Seems to have a lot to do with `factor`.

I also got a crash when interrupting the computation:

```
KeyboardInterrupt:
Exception ignored in: 'sage.libs.pynac.pynac.py_repr'
Traceback (most recent call last):
  File "sage/rings/integer.pyx", line 1013, in sage.rings.integer.Integer.__repr__ (build/cythonized/sage/rings/integer.
c:8427)
  File "sage/rings/integer.pyx", line 1134, in sage.rings.integer.Integer.str (build/cythonized/sage/rings/integer.c:901
1)
KeyboardInterrupt:
------------------------------------------------------------------------
...
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
Segmentation fault
```



---

archive/issue_comments_471127.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,48 +1,65 @@\n-Reported in this `ask.sagemath` [question](https://ask.sagemath.org/question/54986/expression-substitution-fails-why/) : `subs` fails with `Memoy error` (or doesn't return) on some expressions :\n+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):\n+`subs` fails with a memory error (or doesn't return) on some expressions.\n+\n+The following works fine:\n \n ```\n-    sage: var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n-    (A, L, G, R, f, k, n, q, u, beta, gamma)\n-    sage: expr_complex = (I*R^2*f^3*k*q*A*u/ ((2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q + (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3 + 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2+ (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f)*n))\n-    sage: R1=(expr_complex.real()^2+expr_complex.imag()^2).factor()\n-    sage: R2=(sqrt(expr_complex.real()^2+expr_complex.imag()^2)^2).factor()\n-    sage: bool(R1==R2)\n-    True\n-    sage: R3=((sqrt(expr_complex.real()^2+expr_complex.imag()^2).factor())^2).factor()\n-    sage: bool(R1==R3)\n-    True\n-    sage: bool(R2==R3)\n-    True\n+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n+sage: a = I*R^2*f^3*k*q*A*u\n+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q\n+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3\n+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2\n+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f\n+sage: expr = a / ((b + c + d + e)*n)\n+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()\n+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()\n+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()\n+sage: all((R1 == R2, R1 == R3, R2 == R3))\n+True\n ```\n \n-So far, so good. But, whereas :\n+These expressions have the same string representation:\n \n ```\n-    sage: import sympy\n-    sage: bool(sympy.sympify(R3).subs(f,2*beta)._sage_()==R1.subs(f=2*beta))\n-    True\n+sage: [len(str(ex)) for ex in (R1, R2, R3)]\n+[734, 734, 734]\n+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n ```\n \n-works, `mathematica` seems to fail somehow (more troubling) : :\n+Substituting `f = 2*beta` in `R1` and `R3` works:\n \n ```\n-    sage: bool(mathematica.Replace(R3,mathematica.Rule(f,2*beta)).sage()==R1.subs(f=2*beta))\n-    False\n+sage: R1s = R1.subs(f = 2*beta)\n+sage: R3s = R3.subs(f = 2*beta)\n ```\n \n-And (case in point), \n+However, the following **never returns**:\n \n ```\n-    sage: bool(R3.subs(f=2*beta)==R1.subs(f=2*beta))\n+sage: bool(R3s == R1s)\n ```\n \n-**never returns.**\n+Attempting to interrupt the last call can result in a Sage crash;\n+the original poster reports a \"Memory Error\" exception.\n \n-(A previous attempt to interrupt the last call resulted in a Sage crash, which I was unable to reproduce ; the original poster reports a \"Memory Error\" exception, which I couldn't reproduce either).\n+As a comparison, SymPy can do it:\n+\n+```\n+sage: import sympy\n+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\n+True\n+```\n+and Mathematica seems to fail somehow:\n+\n+```\n+sage: mma = mathematica\n+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))\n+False\n+```\n \n Possibly related : #30378\n \n-Priority set to `critical`, because it affects a very basic feature of `Sage`.\n+Priority set to critical, because it affects a very basic feature of Sage.\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-12-31T13:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471127",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,48 +1,65 @@
-Reported in this `ask.sagemath` [question](https://ask.sagemath.org/question/54986/expression-substitution-fails-why/) : `subs` fails with `Memoy error` (or doesn't return) on some expressions :
+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):
+`subs` fails with a memory error (or doesn't return) on some expressions.
+
+The following works fine:
 
 ```
-    sage: var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
-    (A, L, G, R, f, k, n, q, u, beta, gamma)
-    sage: expr_complex = (I*R^2*f^3*k*q*A*u/ ((2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q + (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3 + 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2+ (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f)*n))
-    sage: R1=(expr_complex.real()^2+expr_complex.imag()^2).factor()
-    sage: R2=(sqrt(expr_complex.real()^2+expr_complex.imag()^2)^2).factor()
-    sage: bool(R1==R2)
-    True
-    sage: R3=((sqrt(expr_complex.real()^2+expr_complex.imag()^2).factor())^2).factor()
-    sage: bool(R1==R3)
-    True
-    sage: bool(R2==R3)
-    True
+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
+sage: a = I*R^2*f^3*k*q*A*u
+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q
+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3
+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2
+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f
+sage: expr = a / ((b + c + d + e)*n)
+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()
+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()
+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()
+sage: all((R1 == R2, R1 == R3, R2 == R3))
+True
 ```
 
-So far, so good. But, whereas :
+These expressions have the same string representation:
 
 ```
-    sage: import sympy
-    sage: bool(sympy.sympify(R3).subs(f,2*beta)._sage_()==R1.subs(f=2*beta))
-    True
+sage: [len(str(ex)) for ex in (R1, R2, R3)]
+[734, 734, 734]
+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
 ```
 
-works, `mathematica` seems to fail somehow (more troubling) : :
+Substituting `f = 2*beta` in `R1` and `R3` works:
 
 ```
-    sage: bool(mathematica.Replace(R3,mathematica.Rule(f,2*beta)).sage()==R1.subs(f=2*beta))
-    False
+sage: R1s = R1.subs(f = 2*beta)
+sage: R3s = R3.subs(f = 2*beta)
 ```
 
-And (case in point), 
+However, the following **never returns**:
 
 ```
-    sage: bool(R3.subs(f=2*beta)==R1.subs(f=2*beta))
+sage: bool(R3s == R1s)
 ```
 
-**never returns.**
+Attempting to interrupt the last call can result in a Sage crash;
+the original poster reports a "Memory Error" exception.
 
-(A previous attempt to interrupt the last call resulted in a Sage crash, which I was unable to reproduce ; the original poster reports a "Memory Error" exception, which I couldn't reproduce either).
+As a comparison, SymPy can do it:
+
+```
+sage: import sympy
+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
+True
+```
+and Mathematica seems to fail somehow:
+
+```
+sage: mma = mathematica
+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))
+False
+```
 
 Possibly related : #30378
 
-Priority set to `critical`, because it affects a very basic feature of `Sage`.
+Priority set to critical, because it affects a very basic feature of Sage.
 
 Comment: 1
 
``````




---

archive/issue_comments_471128.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,74 @@\n+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):\n+`subs` fails with a memory error (or doesn't return) on some expressions.\n \n+The following works fine:\n+\n+```\n+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n+sage: a = I*R^2*f^3*k*q*A*u\n+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q\n+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3\n+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2\n+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f\n+sage: expr = a / ((b + c + d + e)*n)\n+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()\n+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()\n+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()\n+sage: all((R1 == R2, R1 == R3, R2 == R3))\n+True\n+```\n+\n+These expressions have the same string representation:\n+\n+```\n+sage: [len(str(ex)) for ex in (R1, R2, R3)]\n+[734, 734, 734]\n+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n+```\n+\n+Substituting `f = 2*beta` in `R1` `R2` `R3` works:\n+\n+```\n+sage: R1s = R1.subs(f = 2*beta)\n+sage: R2s = R2.subs(f = 2*beta)\n+sage: R3s = R3.subs(f = 2*beta)\n+```\n+\n+However, the following **never return**:\n+\n+```\n+sage: bool(R3s == R1s)  # hangs\n+```\n+\n+```\n+sage: len(str(R1s))\n+520\n+sage: len(str(R2s))\n+520\n+sage: len(str(R3s))  # hangs\n+```\n+\n+Attempting to interrupt the last call can result in a Sage crash;\n+the original poster reports a \"Memory Error\" exception.\n+\n+As a comparison, substituting in `R3` via SymPy works:\n+\n+```\n+sage: import sympy\n+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\n+True\n+```\n+but seems to fail via Mathematica somehow:\n+\n+```\n+sage: mma = mathematica\n+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))\n+False\n+```\n+\n+Possibly related : #30378\n+\n+Priority set to critical, because it affects a very basic feature of Sage.\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-12-31T14:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471128",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,74 @@
+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):
+`subs` fails with a memory error (or doesn't return) on some expressions.
 
+The following works fine:
+
+```
+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
+sage: a = I*R^2*f^3*k*q*A*u
+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q
+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3
+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2
+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f
+sage: expr = a / ((b + c + d + e)*n)
+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()
+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()
+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()
+sage: all((R1 == R2, R1 == R3, R2 == R3))
+True
+```
+
+These expressions have the same string representation:
+
+```
+sage: [len(str(ex)) for ex in (R1, R2, R3)]
+[734, 734, 734]
+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
+```
+
+Substituting `f = 2*beta` in `R1` `R2` `R3` works:
+
+```
+sage: R1s = R1.subs(f = 2*beta)
+sage: R2s = R2.subs(f = 2*beta)
+sage: R3s = R3.subs(f = 2*beta)
+```
+
+However, the following **never return**:
+
+```
+sage: bool(R3s == R1s)  # hangs
+```
+
+```
+sage: len(str(R1s))
+520
+sage: len(str(R2s))
+520
+sage: len(str(R3s))  # hangs
+```
+
+Attempting to interrupt the last call can result in a Sage crash;
+the original poster reports a "Memory Error" exception.
+
+As a comparison, substituting in `R3` via SymPy works:
+
+```
+sage: import sympy
+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
+True
+```
+but seems to fail via Mathematica somehow:
+
+```
+sage: mma = mathematica
+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))
+False
+```
+
+Possibly related : #30378
+
+Priority set to critical, because it affects a very basic feature of Sage.
 
 Comment: 1
 
``````




---

archive/issue_comments_471129.json:
```json
{
    "body": "<a id='comment:2'></a>Seems expressions resulting from `factor` behave strangely.\nNot sure what role `subs` plays here.",
    "created_at": "2020-12-31T14:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471129",
    "user": "https://github.com/slel"
}
```

<a id='comment:2'></a>Seems expressions resulting from `factor` behave strangely.
Not sure what role `subs` plays here.



---

archive/issue_comments_471130.json:
```json
{
    "body": "Changing keywords from \"\" to \"factor\".",
    "created_at": "2020-12-31T14:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471130",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "factor".



---

archive/issue_comments_471131.json:
```json
{
    "body": "<a id='comment:3'></a>What seemed to be hanging was just taking a long time.\nStill, the result is surprising.\n\n```\nsage: len(str(R3s))  # long time -- 1,292,914,505\n1292914505\n```",
    "created_at": "2020-12-31T14:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471131",
    "user": "https://github.com/slel"
}
```

<a id='comment:3'></a>What seemed to be hanging was just taking a long time.
Still, the result is surprising.

```
sage: len(str(R3s))  # long time -- 1,292,914,505
1292914505
```



---

archive/issue_comments_471132.json:
```json
{
    "body": "Changing priority from critical to minor.",
    "created_at": "2021-01-12T02:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471132",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing priority from critical to minor.



---

archive/issue_comments_471133.json:
```json
{
    "body": "<a id='comment:5'></a>The problem in this ticket seems to be solved by the patch to pynac in #30446. The PR just adds a doctest. It is based on #30786 in order to avoid a merge conflict.\n\n---\nNew commits:",
    "created_at": "2021-01-12T02:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471133",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:5'></a>The problem in this ticket seems to be solved by the patch to pynac in #30446. The PR just adds a doctest. It is based on #30786 in order to avoid a merge conflict.

---
New commits:



---

archive/issue_comments_471134.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-12T02:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471134",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471135.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-24T19:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471135",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_471136.json:
```json
{
    "body": "<a id='comment:6'></a>only the patch for expression.pyx is needed here, with the rest in #30446",
    "created_at": "2021-01-24T19:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471136",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'></a>only the patch for expression.pyx is needed here, with the rest in #30446



---

archive/issue_comments_471137.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-01-24T22:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471137",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_471138.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-01-24T22:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471138",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_471139.json:
```json
{
    "body": "<a id='comment:8'></a>LGTM",
    "created_at": "2021-01-24T22:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471139",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>LGTM



---

archive/issue_comments_471140.json:
```json
{
    "body": "<a id='comment:9'></a>Can we improve the ticket summary and ticket description?",
    "created_at": "2021-01-25T08:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471140",
    "user": "https://github.com/slel"
}
```

<a id='comment:9'></a>Can we improve the ticket summary and ticket description?



---

archive/issue_comments_471141.json:
```json
{
    "body": "<a id='comment:10'></a>it just adds an extra doctest, which used to fail before #30446",
    "created_at": "2021-01-25T09:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471141",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>it just adds an extra doctest, which used to fail before #30446



---

archive/issue_comments_471142.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,76 @@\n+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):\n+`subs` fails with a memory error (or doesn't return) on some expressions.\n \n+The following works fine:\n+\n+```\n+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n+sage: a = I*R^2*f^3*k*q*A*u\n+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q\n+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3\n+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2\n+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f\n+sage: expr = a / ((b + c + d + e)*n)\n+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()\n+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()\n+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()\n+sage: all((R1 == R2, R1 == R3, R2 == R3))\n+True\n+```\n+\n+These expressions have the same string representation:\n+\n+```\n+sage: [len(str(ex)) for ex in (R1, R2, R3)]\n+[734, 734, 734]\n+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n+```\n+\n+Substituting `f = 2*beta` in `R1` `R2` `R3` works:\n+\n+```\n+sage: R1s = R1.subs(f = 2*beta)\n+sage: R2s = R2.subs(f = 2*beta)\n+sage: R3s = R3.subs(f = 2*beta)\n+```\n+\n+However, the following **never return**:\n+\n+```\n+sage: bool(R3s == R1s)  # hangs\n+```\n+\n+```\n+sage: len(str(R1s))\n+520\n+sage: len(str(R2s))\n+520\n+sage: len(str(R3s))  # hangs\n+```\n+\n+Attempting to interrupt the last call can result in a Sage crash;\n+the original poster reports a \"Memory Error\" exception.\n+\n+As a comparison, substituting in `R3` via SymPy works:\n+\n+```\n+sage: import sympy\n+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\n+True\n+```\n+but seems to fail via Mathematica somehow:\n+\n+```\n+sage: mma = mathematica\n+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))\n+False\n+```\n+\n+Priority set to critical, because it affects a very basic feature of Sage.\n+\n+===================\n+\n+RESOLUTION: The problem was solved by the patch to pynac in #30446. This means that the problem was due to a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. The pull request of this ticket just adds a doctest to ensure that the problem is not allowed to return.\n \n Comment: 1\n \n``````\n",
    "created_at": "2021-01-25T18:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471142",
    "user": "https://github.com/DaveWitteMorris"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,76 @@
+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):
+`subs` fails with a memory error (or doesn't return) on some expressions.
 
+The following works fine:
+
+```
+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
+sage: a = I*R^2*f^3*k*q*A*u
+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q
+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3
+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2
+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f
+sage: expr = a / ((b + c + d + e)*n)
+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()
+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()
+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()
+sage: all((R1 == R2, R1 == R3, R2 == R3))
+True
+```
+
+These expressions have the same string representation:
+
+```
+sage: [len(str(ex)) for ex in (R1, R2, R3)]
+[734, 734, 734]
+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
+```
+
+Substituting `f = 2*beta` in `R1` `R2` `R3` works:
+
+```
+sage: R1s = R1.subs(f = 2*beta)
+sage: R2s = R2.subs(f = 2*beta)
+sage: R3s = R3.subs(f = 2*beta)
+```
+
+However, the following **never return**:
+
+```
+sage: bool(R3s == R1s)  # hangs
+```
+
+```
+sage: len(str(R1s))
+520
+sage: len(str(R2s))
+520
+sage: len(str(R3s))  # hangs
+```
+
+Attempting to interrupt the last call can result in a Sage crash;
+the original poster reports a "Memory Error" exception.
+
+As a comparison, substituting in `R3` via SymPy works:
+
+```
+sage: import sympy
+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
+True
+```
+but seems to fail via Mathematica somehow:
+
+```
+sage: mma = mathematica
+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))
+False
+```
+
+Priority set to critical, because it affects a very basic feature of Sage.
+
+===================
+
+RESOLUTION: The problem was solved by the patch to pynac in #30446. This means that the problem was due to a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. The pull request of this ticket just adds a doctest to ensure that the problem is not allowed to return.
 
 Comment: 1
 
``````




---

archive/issue_comments_471143.json:
```json
{
    "body": "<a id='comment:12'></a>Thanks for the explanation.",
    "created_at": "2021-01-25T20:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471143",
    "user": "https://github.com/slel"
}
```

<a id='comment:12'></a>Thanks for the explanation.



---

archive/issue_comments_471144.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,76 @@\n+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):\n+`subs` fails with a memory error (or doesn't return) on some expressions.\n \n+The following works fine:\n+\n+```\n+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain=\"positive\")\n+sage: a = I*R^2*f^3*k*q*A*u\n+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q\n+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3\n+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2\n+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f\n+sage: expr = a / ((b + c + d + e)*n)\n+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()\n+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()\n+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()\n+sage: all((R1 == R2, R1 == R3, R2 == R3))\n+True\n+```\n+\n+These expressions have the same string representation:\n+\n+```\n+sage: [len(str(ex)) for ex in (R1, R2, R3)]\n+[734, 734, 734]\n+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))\n+```\n+\n+Substituting `f = 2*beta` in `R1` `R2` `R3` works:\n+\n+```\n+sage: R1s = R1.subs(f = 2*beta)\n+sage: R2s = R2.subs(f = 2*beta)\n+sage: R3s = R3.subs(f = 2*beta)\n+```\n+\n+However, the following **never return**:\n+\n+```\n+sage: bool(R3s == R1s)  # hangs\n+```\n+\n+```\n+sage: len(str(R1s))\n+520\n+sage: len(str(R2s))\n+520\n+sage: len(str(R3s))  # hangs\n+```\n+\n+Attempting to interrupt the last call can result in a Sage crash;\n+the original poster reports a \"Memory Error\" exception.\n+\n+As a comparison, substituting in `R3` via SymPy works:\n+\n+```\n+sage: import sympy\n+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))\n+True\n+```\n+but seems to fail via Mathematica somehow:\n+\n+```\n+sage: mma = mathematica\n+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))\n+False\n+```\n+\n+Priority set to critical, because it affects a very basic feature of Sage.\n+\n+---\n+\n+RESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.\n \n Comment: 1\n \n``````\n",
    "created_at": "2021-01-25T20:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471144",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,76 @@
+From [Ask Sage question 54986](https://ask.sagemath.org/question/54986):
+`subs` fails with a memory error (or doesn't return) on some expressions.
 
+The following works fine:
+
+```
+sage: _ = var('A, L, G, R, f, k, n, q, u, beta, gamma', domain="positive")
+sage: a = I*R^2*f^3*k*q*A*u
+sage: b = 2*pi*L*R^2*G*f^4*k^2*q - 2*pi*L*R^2*G*f^4*q - 2*pi*L*R^2*beta^2*G*q
+sage: c = (2*I*pi*L*R^2*beta*gamma*q + 2*I*pi*L*R*(beta + q))*G*f^3
+sage: d = 2*(pi*(beta^2 + 1)*L*R^2*q + pi*L*R*beta*gamma*q + pi*L*beta)*G*f^2
+sage: e = (-2*I*pi*L*R^2*beta*gamma*q - 2*I*pi*(beta^2*q + beta)*L*R)*G*f
+sage: expr = a / ((b + c + d + e)*n)
+sage: R1 = (expr.real()^2 + expr.imag()^2).factor()
+sage: R2 = (sqrt(expr.real()^2 + expr.imag()^2)^2).factor()
+sage: R3 = ((sqrt(expr.real()^2 + expr.imag()^2).factor())^2).factor()
+sage: all((R1 == R2, R1 == R3, R2 == R3))
+True
+```
+
+These expressions have the same string representation:
+
+```
+sage: [len(str(ex)) for ex in (R1, R2, R3)]
+[734, 734, 734]
+sage: all((str(R1) == str(R2), str(R1) == str(R3), str(R2) == str(R3)))
+```
+
+Substituting `f = 2*beta` in `R1` `R2` `R3` works:
+
+```
+sage: R1s = R1.subs(f = 2*beta)
+sage: R2s = R2.subs(f = 2*beta)
+sage: R3s = R3.subs(f = 2*beta)
+```
+
+However, the following **never return**:
+
+```
+sage: bool(R3s == R1s)  # hangs
+```
+
+```
+sage: len(str(R1s))
+520
+sage: len(str(R2s))
+520
+sage: len(str(R3s))  # hangs
+```
+
+Attempting to interrupt the last call can result in a Sage crash;
+the original poster reports a "Memory Error" exception.
+
+As a comparison, substituting in `R3` via SymPy works:
+
+```
+sage: import sympy
+sage: bool(sympy.sympify(R3).subs(f, 2*beta)._sage_() == R1.subs(f = 2*beta))
+True
+```
+but seems to fail via Mathematica somehow:
+
+```
+sage: mma = mathematica
+sage: bool(mma.Replace(R3, mma.Rule(f, 2*beta)).sage() == R1.subs(f = 2*beta))
+False
+```
+
+Priority set to critical, because it affects a very basic feature of Sage.
+
+---
+
+RESOLUTION: solved by the patch to pynac in #30446. There was a bug in evaluating an expression (perhaps `sqrt(expr.real())^2`) that has a rational exponent (such as `2/2`) that simplifies to an integer. This ticket just adds a doctest to ensure that the problem is not allowed to return.
 
 Comment: 1
 
``````




---

archive/issue_comments_471145.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-09T00:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31137#issuecomment-471145",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081360.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-09T00:00:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31137",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31137#event-81360"
}
```
