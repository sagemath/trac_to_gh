# Issue 31208: Use popcnt and tzcnt to speed up bitsets on Intel and AMD

archive/issues_030971.json:
```json
{
    "body": "Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available. (Those are the instructions that do not require overalignment.)\n\nComparison is performed on an Intel i7 with both instructions available (cpu flags `popcnt` and `bmi1`).\n\nTests are run with #31197, as this provides an easy use case for a bitset iterator.\n\nBefore:\n\n```                                                           \nsage: set_random_seed(0)\nsage: B = Bitset([randint(0,1000000) for _ in range(100000)])\nsage: %timeit len(B)\n15.2 \u00b5s \u00b1 8.99 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n\nsage: set_random_seed(0)\nsage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]\nsage: G = Graph(edges, sparse=False, loops=True) \nsage: %timeit _ = G.copy(sparse=False)\n2.62 ms \u00b1 2.75 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: H = G.copy(sparse=False)\nsage: %timeit H == G\n2.45 ms \u00b1 2.06 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\nAfter:\n\n```\nsage: set_random_seed(0)\nsage: B = Bitset([randint(0,1000000) for _ in range(100000)])\nsage: %timeit len(B)\n5.87 \u00b5s \u00b1 7.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n\nsage: set_random_seed(0)\nsage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]\nsage: G = Graph(edges, sparse=False, loops=True)\nsage: %timeit _ = G.copy(sparse=False)\n2.32 ms \u00b1 6.73 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: H = G.copy(sparse=False)\nsage: %timeit H == G\n2.04 ms \u00b1 2.38 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\nCC:  @tscrim @dcoudert @hivert @slel\n\nBranch/Commit: 9c6edc1300aef994b0f125757c2c4040036b9a7a\n\nReviewer: David Coudert\n\nAuthor: Jonathan Kliem\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/31208\n\n",
    "closed_at": "2021-01-24T10:37:31Z",
    "created_at": "2021-01-08T10:37:29Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Use popcnt and tzcnt to speed up bitsets on Intel and AMD",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31208",
    "user": "https://github.com/kliem"
}
```
Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available. (Those are the instructions that do not require overalignment.)

Comparison is performed on an Intel i7 with both instructions available (cpu flags `popcnt` and `bmi1`).

Tests are run with #31197, as this provides an easy use case for a bitset iterator.

Before:

```                                                           
sage: set_random_seed(0)
sage: B = Bitset([randint(0,1000000) for _ in range(100000)])
sage: %timeit len(B)
15.2 µs ± 8.99 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

sage: set_random_seed(0)
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]
sage: G = Graph(edges, sparse=False, loops=True) 
sage: %timeit _ = G.copy(sparse=False)
2.62 ms ± 2.75 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: H = G.copy(sparse=False)
sage: %timeit H == G
2.45 ms ± 2.06 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```

After:

```
sage: set_random_seed(0)
sage: B = Bitset([randint(0,1000000) for _ in range(100000)])
sage: %timeit len(B)
5.87 µs ± 7.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)

sage: set_random_seed(0)
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]
sage: G = Graph(edges, sparse=False, loops=True)
sage: %timeit _ = G.copy(sparse=False)
2.32 ms ± 6.73 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: H = G.copy(sparse=False)
sage: %timeit H == G
2.04 ms ± 2.38 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```

CC:  @tscrim @dcoudert @hivert @slel

Branch/Commit: 9c6edc1300aef994b0f125757c2c4040036b9a7a

Reviewer: David Coudert

Author: Jonathan Kliem

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/31208





---

archive/issue_comments_471989.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available.\n+Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available. (Those are the instructions that do not require overalignment.)\n \n Comparison is performed on an Intel i7 with both instructions available (cpu flags `popcnt` and `bmi1`).\n \n``````\n",
    "created_at": "2021-01-08T10:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471989",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available.
+Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available. (Those are the instructions that do not require overalignment.)
 
 Comparison is performed on an Intel i7 with both instructions available (cpu flags `popcnt` and `bmi1`).
 
``````




---

archive/issue_comments_471990.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2021-01-08T10:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471990",
    "user": "https://github.com/kliem"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_471991.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,44 @@\n+Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available. (Those are the instructions that do not require overalignment.)\n \n+Comparison is performed on an Intel i7 with both instructions available (cpu flags `popcnt` and `bmi1`).\n+\n+Tests are run with #31197, as this provides an easy use case for a bitset iterator.\n+\n+Before:\n+\n+```                                                           \n+sage: set_random_seed(0)\n+sage: B = Bitset([randint(0,1000000) for _ in range(100000)])\n+sage: %timeit len(B)\n+15.2 \u00b5s \u00b1 8.99 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+\n+sage: set_random_seed(0)\n+sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]\n+sage: G = Graph(edges, sparse=False, loops=True) \n+sage: %timeit _ = G.copy(sparse=False)\n+2.62 ms \u00b1 2.75 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+sage: H = G.copy(sparse=False)\n+sage: %timeit H == G\n+2.45 ms \u00b1 2.06 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+```\n+\n+After:\n+\n+```\n+sage: set_random_seed(0)\n+sage: B = Bitset([randint(0,1000000) for _ in range(100000)])\n+sage: %timeit len(B)\n+5.87 \u00b5s \u00b1 7.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+\n+sage: set_random_seed(0)\n+sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]\n+sage: G = Graph(edges, sparse=False, loops=True)\n+sage: %timeit _ = G.copy(sparse=False)\n+2.32 ms \u00b1 6.73 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+sage: H = G.copy(sparse=False)\n+sage: %timeit H == G\n+2.04 ms \u00b1 2.38 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+```\n \n Comment: 1\n \n``````\n",
    "created_at": "2021-01-08T10:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471991",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,44 @@
+Sage is compiled with `-march=native` by default with #27122. We make use of this and use it to obtain faster length and a faster iterator for bitsets, when the instructions are available. (Those are the instructions that do not require overalignment.)
 
+Comparison is performed on an Intel i7 with both instructions available (cpu flags `popcnt` and `bmi1`).
+
+Tests are run with #31197, as this provides an easy use case for a bitset iterator.
+
+Before:
+
+```                                                           
+sage: set_random_seed(0)
+sage: B = Bitset([randint(0,1000000) for _ in range(100000)])
+sage: %timeit len(B)
+15.2 µs ± 8.99 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+
+sage: set_random_seed(0)
+sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]
+sage: G = Graph(edges, sparse=False, loops=True) 
+sage: %timeit _ = G.copy(sparse=False)
+2.62 ms ± 2.75 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+sage: H = G.copy(sparse=False)
+sage: %timeit H == G
+2.45 ms ± 2.06 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+```
+
+After:
+
+```
+sage: set_random_seed(0)
+sage: B = Bitset([randint(0,1000000) for _ in range(100000)])
+sage: %timeit len(B)
+5.87 µs ± 7.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+
+sage: set_random_seed(0)
+sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]
+sage: G = Graph(edges, sparse=False, loops=True)
+sage: %timeit _ = G.copy(sparse=False)
+2.32 ms ± 6.73 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+sage: H = G.copy(sparse=False)
+sage: %timeit H == G
+2.04 ms ± 2.38 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+```
 
 Comment: 1
 
``````




---

archive/issue_comments_471992.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-08T10:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471992",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471993.json:
```json
{
    "body": "<a id='comment:5'></a>Works well on my macOS laptop with similar speed up than reported (although my laptop is slower). It seems also ok on a desktop with fedora 32, but I have doctests errors due to cplex (problems with threads) and so it's not easy to know if all tests pass. Nonetheless, I also observe a significant speed up.\n\nBefore setting this ticket to positive review, it would be better to have a second opinion.",
    "created_at": "2021-01-08T19:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471993",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:5'></a>Works well on my macOS laptop with similar speed up than reported (although my laptop is slower). It seems also ok on a desktop with fedora 32, but I have doctests errors due to cplex (problems with threads) and so it's not easy to know if all tests pass. Nonetheless, I also observe a significant speed up.

Before setting this ticket to positive review, it would be better to have a second opinion.



---

archive/issue_comments_471994.json:
```json
{
    "body": "<a id='comment:6'></a>The timings are from my office computer, which is pretty fast. I think the ratio is about the same on my laptop.\n\nWe should also definitely wait for a few patchbots. It took my a number of attempts to figure out most of the problems (tested popcount on an earlier branch of #26887 and then on #27103, in particular it doens't seem to work on 32-bit, which is why it is excluded now).",
    "created_at": "2021-01-08T19:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471994",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>The timings are from my office computer, which is pretty fast. I think the ratio is about the same on my laptop.

We should also definitely wait for a few patchbots. It took my a number of attempts to figure out most of the problems (tested popcount on an earlier branch of #26887 and then on #27103, in particular it doens't seem to work on 32-bit, which is why it is excluded now).



---

archive/issue_comments_471995.json:
```json
{
    "body": "<a id='comment:7'></a>I though `mpn_cnt` was using intrinsic whenever available. Apparently it's not the case.",
    "created_at": "2021-01-08T19:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471995",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>I though `mpn_cnt` was using intrinsic whenever available. Apparently it's not the case.



---

archive/issue_comments_471996.json:
```json
{
    "body": "<a id='comment:8'></a>I don't know why the patchbot is not testing this ticket...",
    "created_at": "2021-01-15T00:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471996",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:8'></a>I don't know why the patchbot is not testing this ticket...



---

archive/issue_comments_471997.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 dcoudert]:\n> I don't know why the patchbot is not testing this ticket...\n\n\nI think because there was no author filled in.",
    "created_at": "2021-01-15T02:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471997",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>Replying to [comment:8 dcoudert]:
> I don't know why the patchbot is not testing this ticket...


I think because there was no author filled in.



---

archive/issue_comments_471998.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-15T09:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471998",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_471999.json:
```json
{
    "body": "<a id='comment:10'></a>For me, this is working well on macOS 10.15.7 and fedora 32.",
    "created_at": "2021-01-15T09:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-471999",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:10'></a>For me, this is working well on macOS 10.15.7 and fedora 32.



---

archive/issue_comments_472000.json:
```json
{
    "body": "<a id='comment:11'></a>Thank you.",
    "created_at": "2021-01-15T09:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-472000",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Thank you.



---

archive/issue_comments_472001.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-24T10:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31208#issuecomment-472001",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_081569.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-24T10:37:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31208",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31208#event-81569"
}
```
